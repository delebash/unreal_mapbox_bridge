var gm=Object.defineProperty;var Hd=Object.getOwnPropertySymbols;var _m=Object.prototype.hasOwnProperty,ym=Object.prototype.propertyIsEnumerable;var Wd=(h,l,p)=>l in h?gm(h,l,{enumerable:!0,configurable:!0,writable:!0,value:p}):h[l]=p,Yc=(h,l)=>{for(var p in l||(l={}))_m.call(l,p)&&Wd(h,p,l[p]);if(Hd)for(var p of Hd(l))ym.call(l,p)&&Wd(h,p,l[p]);return h};import{g as commonjsGlobal,h as getAugmentedNamespace,i as commonjsRequire,j as ref,r as resolveComponent,o as openBlock,k as createElementBlock,l as createVNode,w as withCtx,m as createBaseVNode,n as resolveDirective,t as toDisplayString,p as withDirectives,F as Fragment,q as createTextVNode,c as createBlock,d as defineComponent,u as unref,s as createCommentVNode,v as useQuasar,N as Notify,x as vShow}from"./vendor.0af61b56.js";import{_ as _export_sfc}from"./index.d457f111.js";class Store{constructor(l="unreal-mapbox",p="keyval"){this.storeName=p,this._dbp=new Promise((m,w)=>{const T=indexedDB.open(l,1);T.onerror=()=>w(T.error),T.onsuccess=()=>m(T.result),T.onupgradeneeded=()=>{T.result.createObjectStore(p)}})}_withIDBStore(l,p){return this._dbp.then(m=>new Promise((w,T)=>{const A=m.transaction(this.storeName,l);A.oncomplete=()=>w(),A.onabort=A.onerror=()=>T(A.error),p(A.objectStore(this.storeName))}))}}let store;function getDefaultStore(){return store||(store=new Store),store}function get(h,l=getDefaultStore()){let p;return l._withIDBStore("readonly",m=>{p=m.get(h)}).then(()=>p.result)}function set(h,l,p=getDefaultStore()){return p._withIDBStore("readwrite",m=>{m.put(l,h)})}function del(h,l=getDefaultStore()){return l._withIDBStore("readwrite",p=>{p.delete(h)})}function clear(h=getDefaultStore()){return h._withIDBStore("readwrite",l=>{l.clear()})}function keys(h=getDefaultStore()){const l=[];return h._withIDBStore("readonly",p=>{(p.openKeyCursor||p.openCursor).call(p).onsuccess=function(){!this.result||(l.push(this.result.key),this.result.continue())}}).then(()=>l)}var idbKeyval={keys,clear,del,set,get};const bitMethods={getBit(h){return this.data[getSlot(h)]&1<<getShift(h)?1:0},setBit(h){this.data[getSlot(h)]|=1<<getShift(h)},clearBit(h){this.data[getSlot(h)]&=~(1<<getShift(h))},toggleBit(h){this.data[getSlot(h)]^=1<<getShift(h)},getBitXY(h,l){return h>=this.width||l>=this.height?0:this.getBit(l*this.width+h)},setBitXY(h,l){this.setBit(l*this.width+h)},clearBitXY(h,l){this.clearBit(l*this.width+h)},toggleBitXY(h,l){this.toggleBit(l*this.width+h)}};function getSlot(h){return h>>3}function getShift(h){return 7-(h&7)}function setBitMethods(h){for(const l in bitMethods)h.prototype[l]=bitMethods[l]}function checkProcessable(h,l={}){let{bitDepth:p,alpha:m,colorModel:w,components:T,channels:A}=l;if(typeof h!="string"||h.length===0)throw new TypeError("processName must be a string");if(p&&(Array.isArray(p)||(p=[p]),!p.includes(this.bitDepth)))throw new TypeError(`The process: ${h} can only be applied if bit depth is in: ${p}`);if(m&&(Array.isArray(m)||(m=[m]),!m.includes(this.alpha)))throw new TypeError(`The process: ${h} can only be applied if alpha is in: ${m}`);if(w&&(Array.isArray(w)||(w=[w]),!w.includes(this.colorModel)))throw new TypeError(`The process: ${h} can only be applied if color model is in: ${w}`);if(T&&(Array.isArray(T)||(T=[T]),!T.includes(this.components))){let y=`The process: ${h} can only be applied if the number of components is in: ${T}`;throw T.length===1&&T[0]===1?new TypeError(`${y}.\rYou should transform your image using "image.grey()" before applying the algorithm.`):new TypeError(y)}if(A&&(Array.isArray(A)||(A=[A]),!A.includes(this.channels)))throw new TypeError(`The process: ${h} can only be applied if the number of channels is in: ${A}`)}function createBlob(h,l){h=h||[],l=l||{},typeof l=="string"&&(l={type:l});try{return new Blob(h,l)}catch(T){if(T.name!=="TypeError")throw T;for(var p=typeof BlobBuilder!="undefined"?BlobBuilder:typeof MSBlobBuilder!="undefined"?MSBlobBuilder:typeof MozBlobBuilder!="undefined"?MozBlobBuilder:WebKitBlobBuilder,m=new p,w=0;w<h.length;w+=1)m.append(h[w]);return m.getBlob(l.type)}}function dataURLToBlob(h){var l=h.match(/data:([^;]+)/)[1],p=h.replace(/^[^,]+,/,""),m=binaryStringToArrayBuffer(atob(p));return createBlob([m],{type:l})}function canvasToBlob(h,l,p){return typeof h.toBlob=="function"?new Promise(function(m){h.toBlob(m,l,p)}):Promise.resolve(dataURLToBlob(h.toDataURL(l,p)))}function binaryStringToArrayBuffer(h){for(var l=h.length,p=new ArrayBuffer(l),m=new Uint8Array(p),w=-1;++w<l;)m[w]=h.charCodeAt(w);return p}var utf8$1={exports:{}};/*! https://mths.be/utf8js v2.1.2 by @mathias */(function(h,l){(function(p){var m=l,w=h&&h.exports==m&&h,T=typeof commonjsGlobal=="object"&&commonjsGlobal;(T.global===T||T.window===T)&&(p=T);var A=String.fromCharCode;function y(ge){for(var ue=[],Se=0,le=ge.length,pe,Le;Se<le;)pe=ge.charCodeAt(Se++),pe>=55296&&pe<=56319&&Se<le?(Le=ge.charCodeAt(Se++),(Le&64512)==56320?ue.push(((pe&1023)<<10)+(Le&1023)+65536):(ue.push(pe),Se--)):ue.push(pe);return ue}function B(ge){for(var ue=ge.length,Se=-1,le,pe="";++Se<ue;)le=ge[Se],le>65535&&(le-=65536,pe+=A(le>>>10&1023|55296),le=56320|le&1023),pe+=A(le);return pe}function D(ge){if(ge>=55296&&ge<=57343)throw Error("Lone surrogate U+"+ge.toString(16).toUpperCase()+" is not a scalar value")}function O(ge,ue){return A(ge>>ue&63|128)}function N(ge){if((ge&4294967168)==0)return A(ge);var ue="";return(ge&4294965248)==0?ue=A(ge>>6&31|192):(ge&4294901760)==0?(D(ge),ue=A(ge>>12&15|224),ue+=O(ge,6)):(ge&4292870144)==0&&(ue=A(ge>>18&7|240),ue+=O(ge,12),ue+=O(ge,6)),ue+=A(ge&63|128),ue}function j(ge){for(var ue=y(ge),Se=ue.length,le=-1,pe,Le="";++le<Se;)pe=ue[le],Le+=N(pe);return Le}function G(){if(Q>=oe)throw Error("Invalid byte index");var ge=te[Q]&255;if(Q++,(ge&192)==128)return ge&63;throw Error("Invalid continuation byte")}function H(){var ge,ue,Se,le,pe;if(Q>oe)throw Error("Invalid byte index");if(Q==oe)return!1;if(ge=te[Q]&255,Q++,(ge&128)==0)return ge;if((ge&224)==192){if(ue=G(),pe=(ge&31)<<6|ue,pe>=128)return pe;throw Error("Invalid continuation byte")}if((ge&240)==224){if(ue=G(),Se=G(),pe=(ge&15)<<12|ue<<6|Se,pe>=2048)return D(pe),pe;throw Error("Invalid continuation byte")}if((ge&248)==240&&(ue=G(),Se=G(),le=G(),pe=(ge&7)<<18|ue<<12|Se<<6|le,pe>=65536&&pe<=1114111))return pe;throw Error("Invalid UTF-8 detected")}var te,oe,Q;function _e(ge){te=y(ge),oe=te.length,Q=0;for(var ue=[],Se;(Se=H())!==!1;)ue.push(Se);return B(ue)}var se={version:"2.1.2",encode:j,decode:_e};if(m&&!m.nodeType)if(w)w.exports=se;else{var he={},me=he.hasOwnProperty;for(var Re in se)me.call(se,Re)&&(m[Re]=se[Re])}else p.utf8=se})(commonjsGlobal)})(utf8$1,utf8$1.exports);const utf8=utf8$1.exports,defaultByteLength$3=1024*8,charArray$1=[];class IOBuffer$6{constructor(l,p){p=p||{};var m=!1;l===void 0&&(l=defaultByteLength$3),typeof l=="number"?l=new ArrayBuffer(l):(m=!0,this._lastWrittenByte=l.byteLength);const w=p.offset?p.offset>>>0:0;let T=l.byteLength-w,A=w;l.buffer&&(l.byteLength!==l.buffer.byteLength&&(A=l.byteOffset+w),l=l.buffer),m?this._lastWrittenByte=T:this._lastWrittenByte=0,this.buffer=l,this.length=T,this.byteLength=T,this.byteOffset=A,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,A,T),this._mark=0,this._marks=[]}available(l){return l===void 0&&(l=1),this.offset+l<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(l){return l===void 0&&(l=1),this.offset+=l,this}seek(l){return this.offset=l,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const l=this._marks.pop();if(l===void 0)throw new Error("Mark stack empty");return this.seek(l),this}rewind(){return this.offset=0,this}ensureAvailable(l){if(l===void 0&&(l=1),!this.available(l)){const m=(this.offset+l)*2,w=new Uint8Array(m);w.set(new Uint8Array(this.buffer)),this.buffer=w.buffer,this.length=this.byteLength=m,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(l){l===void 0&&(l=1);for(var p=new Uint8Array(l),m=0;m<l;m++)p[m]=this.readByte();return p}readInt16(){var l=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,l}readUint16(){var l=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,l}readInt32(){var l=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,l}readUint32(){var l=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,l}readFloat32(){var l=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,l}readFloat64(){var l=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,l}readChar(){return String.fromCharCode(this.readInt8())}readChars(l){l===void 0&&(l=1),charArray$1.length=l;for(var p=0;p<l;p++)charArray$1[p]=this.readChar();return charArray$1.join("")}readUtf8(l){l===void 0&&(l=1);const p=this.readChars(l);return utf8.decode(p)}writeBoolean(l){return this.writeUint8(l?255:0),this}writeInt8(l){return this.ensureAvailable(1),this._data.setInt8(this.offset++,l),this._updateLastWrittenByte(),this}writeUint8(l){return this.ensureAvailable(1),this._data.setUint8(this.offset++,l),this._updateLastWrittenByte(),this}writeByte(l){return this.writeUint8(l)}writeBytes(l){this.ensureAvailable(l.length);for(var p=0;p<l.length;p++)this._data.setUint8(this.offset++,l[p]);return this._updateLastWrittenByte(),this}writeInt16(l){return this.ensureAvailable(2),this._data.setInt16(this.offset,l,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(l){return this.ensureAvailable(2),this._data.setUint16(this.offset,l,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(l){return this.ensureAvailable(4),this._data.setInt32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(l){return this.ensureAvailable(4),this._data.setUint32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(l){return this.ensureAvailable(4),this._data.setFloat32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(l){return this.ensureAvailable(8),this._data.setFloat64(this.offset,l,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(l){return this.writeUint8(l.charCodeAt(0))}writeChars(l){for(var p=0;p<l.length;p++)this.writeUint8(l.charCodeAt(p));return this}writeUtf8(l){const p=utf8.encode(l);return this.writeChars(p)}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}getBuffer(){return typeof Buffer!="undefined"?Buffer.from(this.toArray()):this.toArray()}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}}var IOBuffer_1$1=IOBuffer$6,constants$7={BITMAPV5HEADER:{LogicalColorSpace:{LCS_CALIBRATED_RGB:0,LCS_sRGB:1934772034,LCS_WINDOWS_COLOR_SPACE:1466527264},Compression:{BI_RGB:0,BI_RLE8:1,BI_RLE4:2,BI_BITFIELDS:3,BI_JPEG:4,BI_PNG:5,BI_CMYK:11,BI_CMYKRLE8:12,BI_CMYKRLE4:13},GamutMappingIntent:{LCS_GM_ABS_COLORIMETRIC:8,LCS_GM_BUSINESS:1,LCS_GM_GRAPHICS:2,LCS_GM_IMAGES:4}}};const IOBuffer$5=IOBuffer_1$1,constants$6=constants$7,tableLeft=[];for(var i$5=0;i$5<=8;i$5++)tableLeft.push(255<<i$5);var encode$5=function(h){if(h.bitDepth!==1)throw new Error("Only bitDepth of 1 is supported");if(!h.height||!h.width)throw new Error("ImageData width and height are required");if(h.components!==1)throw new Error("Only 1 component is supported");if(h.channels!==1)throw new Error("Only 1 channel is supported");var l=new IOBuffer$5;l.skip(14),writeBitmapV5Header(l,h),writeColorTable(l,h);const p=l.offset;return writePixelArray(l,h),l.rewind(),writeBitmapFileHeader(l,p),l.getBuffer()};function writePixelArray(h,l){const p=Math.floor((l.bitDepth*l.width+31)/32)*4,m=Math.ceil(l.bitDepth*l.width/8),w=p-m,T=l.bitDepth*l.width%8,A=T===0?0:8-T,y=p*l.height;var B,D;const O=new IOBuffer$5(l.data);let N=0,j=0,G=8;h.mark(),D=O.readUint8();for(var H=l.height-1;H>=0;H--){const oe=H===0;h.reset(),h.skip(H*p);for(var te=0;te<m;te++){const Q=te===m-1;j<=A&&Q?(h.writeByte(D<<j),(A===0||A===j)&&!oe&&(B=D,D=O.readByte())):j===0?(B=D,D=O.readUint8(),h.writeByte(B)):(B=D,D=O.readUint8(),h.writeByte(B<<j&tableLeft[j]|D>>G)),Q?(N+=T||8,h.skip(w),j=N%8,G=8-j):N+=8}}p>m&&(h.reset(),h.skip(y-1),h.writeUint8(0))}function writeColorTable(h,l){l.bitDepth>8||h.writeUint32(0).writeUint32(16777215)}function writeBitmapFileHeader(h,l){h.writeChars("BM"),h.writeInt32(h._lastWrittenByte),h.writeUint16(0),h.writeUint16(0),h.writeUint32(l)}function writeBitmapV5Header(h,l){h.writeUint32(124).writeInt32(l.width).writeInt32(l.height).writeUint16(1).writeUint16(l.bitDepth).writeUint32(constants$6.BITMAPV5HEADER.Compression.BI_RGB).writeUint32(l.width*l.height*l.bitDepth).writeInt32(0).writeInt32(0).writeUint32(Math.pow(2,l.bitDepth)).writeUint32(Math.pow(2,l.bitDepth)).writeUint32(4278190080).writeUint32(16711680).writeUint32(65280).writeUint32(255).writeUint32(constants$6.BITMAPV5HEADER.LogicalColorSpace.LCS_sRGB).skip(36).skip(12).writeUint32(constants$6.BITMAPV5HEADER.GamutMappingIntent.LCS_GM_IMAGES).skip(12)}var encode$4=encode$5;(function(h){if(h.TextEncoder&&h.TextDecoder)return!1;function l(m="utf-8"){if(m!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${m}') is invalid.`)}Object.defineProperty(l.prototype,"encoding",{value:"utf-8"}),l.prototype.encode=function(m,w={stream:!1}){if(w.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let T=0;const A=m.length;let y=0,B=Math.max(32,A+(A>>1)+7),D=new Uint8Array(B>>3<<3);for(;T<A;){let O=m.charCodeAt(T++);if(O>=55296&&O<=56319){if(T<A){const N=m.charCodeAt(T);(N&64512)==56320&&(++T,O=((O&1023)<<10)+(N&1023)+65536)}if(O>=55296&&O<=56319)continue}if(y+4>D.length){B+=8,B*=1+T/m.length*2,B=B>>3<<3;const N=new Uint8Array(B);N.set(D),D=N}if((O&4294967168)==0){D[y++]=O;continue}else if((O&4294965248)==0)D[y++]=O>>6&31|192;else if((O&4294901760)==0)D[y++]=O>>12&15|224,D[y++]=O>>6&63|128;else if((O&4292870144)==0)D[y++]=O>>18&7|240,D[y++]=O>>12&63|128,D[y++]=O>>6&63|128;else continue;D[y++]=O&63|128}return D.slice(0,y)};function p(m="utf-8",w={fatal:!1}){if(m!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${m}') is invalid.`);if(w.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(p.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(p.prototype,"fatal",{value:!1}),Object.defineProperty(p.prototype,"ignoreBOM",{value:!1}),p.prototype.decode=function(m,w={stream:!1}){if(w.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const T=new Uint8Array(m);let A=0;const y=T.length,B=[];for(;A<y;){const D=T[A++];if(D===0)break;if((D&128)==0)B.push(D);else if((D&224)==192){const O=T[A++]&63;B.push((D&31)<<6|O)}else if((D&240)==224){const O=T[A++]&63,N=T[A++]&63;B.push((D&31)<<12|O<<6|N)}else if((D&248)==240){const O=T[A++]&63,N=T[A++]&63,j=T[A++]&63;let G=(D&7)<<18|O<<12|N<<6|j;G>65535&&(G-=65536,B.push(G>>>10&1023|55296),G=56320|G&1023),B.push(G)}}return String.fromCharCode.apply(null,B)},h.TextEncoder=l,h.TextDecoder=p})(typeof window!="undefined"?window:typeof self!="undefined"?self:globalThis);const decoder$2=new TextDecoder("utf-8");function decode$6(h){return decoder$2.decode(h)}const encoder$2=new TextEncoder;function encode$3(h){return encoder$2.encode(h)}const defaultByteLength$2=1024*8;class IOBuffer$4{constructor(l=defaultByteLength$2,p={}){let m=!1;typeof l=="number"?l=new ArrayBuffer(l):(m=!0,this.lastWrittenByte=l.byteLength);const w=p.offset?p.offset>>>0:0,T=l.byteLength-w;let A=w;(ArrayBuffer.isView(l)||l instanceof IOBuffer$4)&&(l.byteLength!==l.buffer.byteLength&&(A=l.byteOffset+w),l=l.buffer),m?this.lastWrittenByte=T:this.lastWrittenByte=0,this.buffer=l,this.length=T,this.byteLength=T,this.byteOffset=A,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,A,T),this._mark=0,this._marks=[]}available(l=1){return this.offset+l<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(l=1){return this.offset+=l,this}seek(l){return this.offset=l,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const l=this._marks.pop();if(l===void 0)throw new Error("Mark stack empty");return this.seek(l),this}rewind(){return this.offset=0,this}ensureAvailable(l=1){if(!this.available(l)){const m=(this.offset+l)*2,w=new Uint8Array(m);w.set(new Uint8Array(this.buffer)),this.buffer=w.buffer,this.length=this.byteLength=m,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(l=1){const p=new Uint8Array(l);for(let m=0;m<l;m++)p[m]=this.readByte();return p}readInt16(){const l=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,l}readUint16(){const l=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,l}readInt32(){const l=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,l}readUint32(){const l=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,l}readFloat32(){const l=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,l}readFloat64(){const l=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,l}readBigInt64(){const l=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,l}readBigUint64(){const l=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,l}readChar(){return String.fromCharCode(this.readInt8())}readChars(l=1){let p="";for(let m=0;m<l;m++)p+=this.readChar();return p}readUtf8(l=1){return decode$6(this.readBytes(l))}writeBoolean(l){return this.writeUint8(l?255:0),this}writeInt8(l){return this.ensureAvailable(1),this._data.setInt8(this.offset++,l),this._updateLastWrittenByte(),this}writeUint8(l){return this.ensureAvailable(1),this._data.setUint8(this.offset++,l),this._updateLastWrittenByte(),this}writeByte(l){return this.writeUint8(l)}writeBytes(l){this.ensureAvailable(l.length);for(let p=0;p<l.length;p++)this._data.setUint8(this.offset++,l[p]);return this._updateLastWrittenByte(),this}writeInt16(l){return this.ensureAvailable(2),this._data.setInt16(this.offset,l,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(l){return this.ensureAvailable(2),this._data.setUint16(this.offset,l,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(l){return this.ensureAvailable(4),this._data.setInt32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(l){return this.ensureAvailable(4),this._data.setUint32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(l){return this.ensureAvailable(4),this._data.setFloat32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(l){return this.ensureAvailable(8),this._data.setFloat64(this.offset,l,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(l){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,l,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(l){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,l,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(l){return this.writeUint8(l.charCodeAt(0))}writeChars(l){for(let p=0;p<l.length;p++)this.writeUint8(l.charCodeAt(p));return this}writeUtf8(l){return this.writeBytes(encode$3(l))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}/*! pako 2.0.4 https://github.com/nodeca/pako @license (MIT AND Zlib) */const Z_FIXED$1=4,Z_BINARY=0,Z_TEXT=1,Z_UNKNOWN$1=2;function zero$1(h){let l=h.length;for(;--l>=0;)h[l]=0}const STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,MIN_MATCH$1=3,MAX_MATCH$1=258,LENGTH_CODES$1=29,LITERALS$1=256,L_CODES$1=LITERALS$1+1+LENGTH_CODES$1,D_CODES$1=30,BL_CODES$1=19,HEAP_SIZE$1=2*L_CODES$1+1,MAX_BITS$1=15,Buf_size=16,MAX_BL_BITS=7,END_BLOCK=256,REP_3_6=16,REPZ_3_10=17,REPZ_11_138=18,extra_lbits=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),extra_dbits=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),extra_blbits=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),bl_order=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),DIST_CODE_LEN=512,static_ltree=new Array((L_CODES$1+2)*2);zero$1(static_ltree);const static_dtree=new Array(D_CODES$1*2);zero$1(static_dtree);const _dist_code=new Array(DIST_CODE_LEN);zero$1(_dist_code);const _length_code=new Array(MAX_MATCH$1-MIN_MATCH$1+1);zero$1(_length_code);const base_length=new Array(LENGTH_CODES$1);zero$1(base_length);const base_dist=new Array(D_CODES$1);zero$1(base_dist);function StaticTreeDesc(h,l,p,m,w){this.static_tree=h,this.extra_bits=l,this.extra_base=p,this.elems=m,this.max_length=w,this.has_stree=h&&h.length}let static_l_desc,static_d_desc,static_bl_desc;function TreeDesc(h,l){this.dyn_tree=h,this.max_code=0,this.stat_desc=l}const d_code=h=>h<256?_dist_code[h]:_dist_code[256+(h>>>7)],put_short=(h,l)=>{h.pending_buf[h.pending++]=l&255,h.pending_buf[h.pending++]=l>>>8&255},send_bits=(h,l,p)=>{h.bi_valid>Buf_size-p?(h.bi_buf|=l<<h.bi_valid&65535,put_short(h,h.bi_buf),h.bi_buf=l>>Buf_size-h.bi_valid,h.bi_valid+=p-Buf_size):(h.bi_buf|=l<<h.bi_valid&65535,h.bi_valid+=p)},send_code=(h,l,p)=>{send_bits(h,p[l*2],p[l*2+1])},bi_reverse=(h,l)=>{let p=0;do p|=h&1,h>>>=1,p<<=1;while(--l>0);return p>>>1},bi_flush=h=>{h.bi_valid===16?(put_short(h,h.bi_buf),h.bi_buf=0,h.bi_valid=0):h.bi_valid>=8&&(h.pending_buf[h.pending++]=h.bi_buf&255,h.bi_buf>>=8,h.bi_valid-=8)},gen_bitlen=(h,l)=>{const p=l.dyn_tree,m=l.max_code,w=l.stat_desc.static_tree,T=l.stat_desc.has_stree,A=l.stat_desc.extra_bits,y=l.stat_desc.extra_base,B=l.stat_desc.max_length;let D,O,N,j,G,H,te=0;for(j=0;j<=MAX_BITS$1;j++)h.bl_count[j]=0;for(p[h.heap[h.heap_max]*2+1]=0,D=h.heap_max+1;D<HEAP_SIZE$1;D++)O=h.heap[D],j=p[p[O*2+1]*2+1]+1,j>B&&(j=B,te++),p[O*2+1]=j,!(O>m)&&(h.bl_count[j]++,G=0,O>=y&&(G=A[O-y]),H=p[O*2],h.opt_len+=H*(j+G),T&&(h.static_len+=H*(w[O*2+1]+G)));if(te!==0){do{for(j=B-1;h.bl_count[j]===0;)j--;h.bl_count[j]--,h.bl_count[j+1]+=2,h.bl_count[B]--,te-=2}while(te>0);for(j=B;j!==0;j--)for(O=h.bl_count[j];O!==0;)N=h.heap[--D],!(N>m)&&(p[N*2+1]!==j&&(h.opt_len+=(j-p[N*2+1])*p[N*2],p[N*2+1]=j),O--)}},gen_codes=(h,l,p)=>{const m=new Array(MAX_BITS$1+1);let w=0,T,A;for(T=1;T<=MAX_BITS$1;T++)m[T]=w=w+p[T-1]<<1;for(A=0;A<=l;A++){let y=h[A*2+1];y!==0&&(h[A*2]=bi_reverse(m[y]++,y))}},tr_static_init=()=>{let h,l,p,m,w;const T=new Array(MAX_BITS$1+1);for(p=0,m=0;m<LENGTH_CODES$1-1;m++)for(base_length[m]=p,h=0;h<1<<extra_lbits[m];h++)_length_code[p++]=m;for(_length_code[p-1]=m,w=0,m=0;m<16;m++)for(base_dist[m]=w,h=0;h<1<<extra_dbits[m];h++)_dist_code[w++]=m;for(w>>=7;m<D_CODES$1;m++)for(base_dist[m]=w<<7,h=0;h<1<<extra_dbits[m]-7;h++)_dist_code[256+w++]=m;for(l=0;l<=MAX_BITS$1;l++)T[l]=0;for(h=0;h<=143;)static_ltree[h*2+1]=8,h++,T[8]++;for(;h<=255;)static_ltree[h*2+1]=9,h++,T[9]++;for(;h<=279;)static_ltree[h*2+1]=7,h++,T[7]++;for(;h<=287;)static_ltree[h*2+1]=8,h++,T[8]++;for(gen_codes(static_ltree,L_CODES$1+1,T),h=0;h<D_CODES$1;h++)static_dtree[h*2+1]=5,static_dtree[h*2]=bi_reverse(h,5);static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS$1+1,L_CODES$1,MAX_BITS$1),static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES$1,MAX_BITS$1),static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES$1,MAX_BL_BITS)},init_block=h=>{let l;for(l=0;l<L_CODES$1;l++)h.dyn_ltree[l*2]=0;for(l=0;l<D_CODES$1;l++)h.dyn_dtree[l*2]=0;for(l=0;l<BL_CODES$1;l++)h.bl_tree[l*2]=0;h.dyn_ltree[END_BLOCK*2]=1,h.opt_len=h.static_len=0,h.last_lit=h.matches=0},bi_windup=h=>{h.bi_valid>8?put_short(h,h.bi_buf):h.bi_valid>0&&(h.pending_buf[h.pending++]=h.bi_buf),h.bi_buf=0,h.bi_valid=0},copy_block=(h,l,p,m)=>{bi_windup(h),m&&(put_short(h,p),put_short(h,~p)),h.pending_buf.set(h.window.subarray(l,l+p),h.pending),h.pending+=p},smaller=(h,l,p,m)=>{const w=l*2,T=p*2;return h[w]<h[T]||h[w]===h[T]&&m[l]<=m[p]},pqdownheap=(h,l,p)=>{const m=h.heap[p];let w=p<<1;for(;w<=h.heap_len&&(w<h.heap_len&&smaller(l,h.heap[w+1],h.heap[w],h.depth)&&w++,!smaller(l,m,h.heap[w],h.depth));)h.heap[p]=h.heap[w],p=w,w<<=1;h.heap[p]=m},compress_block=(h,l,p)=>{let m,w,T=0,A,y;if(h.last_lit!==0)do m=h.pending_buf[h.d_buf+T*2]<<8|h.pending_buf[h.d_buf+T*2+1],w=h.pending_buf[h.l_buf+T],T++,m===0?send_code(h,w,l):(A=_length_code[w],send_code(h,A+LITERALS$1+1,l),y=extra_lbits[A],y!==0&&(w-=base_length[A],send_bits(h,w,y)),m--,A=d_code(m),send_code(h,A,p),y=extra_dbits[A],y!==0&&(m-=base_dist[A],send_bits(h,m,y)));while(T<h.last_lit);send_code(h,END_BLOCK,l)},build_tree=(h,l)=>{const p=l.dyn_tree,m=l.stat_desc.static_tree,w=l.stat_desc.has_stree,T=l.stat_desc.elems;let A,y,B=-1,D;for(h.heap_len=0,h.heap_max=HEAP_SIZE$1,A=0;A<T;A++)p[A*2]!==0?(h.heap[++h.heap_len]=B=A,h.depth[A]=0):p[A*2+1]=0;for(;h.heap_len<2;)D=h.heap[++h.heap_len]=B<2?++B:0,p[D*2]=1,h.depth[D]=0,h.opt_len--,w&&(h.static_len-=m[D*2+1]);for(l.max_code=B,A=h.heap_len>>1;A>=1;A--)pqdownheap(h,p,A);D=T;do A=h.heap[1],h.heap[1]=h.heap[h.heap_len--],pqdownheap(h,p,1),y=h.heap[1],h.heap[--h.heap_max]=A,h.heap[--h.heap_max]=y,p[D*2]=p[A*2]+p[y*2],h.depth[D]=(h.depth[A]>=h.depth[y]?h.depth[A]:h.depth[y])+1,p[A*2+1]=p[y*2+1]=D,h.heap[1]=D++,pqdownheap(h,p,1);while(h.heap_len>=2);h.heap[--h.heap_max]=h.heap[1],gen_bitlen(h,l),gen_codes(p,B,h.bl_count)},scan_tree=(h,l,p)=>{let m,w=-1,T,A=l[0*2+1],y=0,B=7,D=4;for(A===0&&(B=138,D=3),l[(p+1)*2+1]=65535,m=0;m<=p;m++)T=A,A=l[(m+1)*2+1],!(++y<B&&T===A)&&(y<D?h.bl_tree[T*2]+=y:T!==0?(T!==w&&h.bl_tree[T*2]++,h.bl_tree[REP_3_6*2]++):y<=10?h.bl_tree[REPZ_3_10*2]++:h.bl_tree[REPZ_11_138*2]++,y=0,w=T,A===0?(B=138,D=3):T===A?(B=6,D=3):(B=7,D=4))},send_tree=(h,l,p)=>{let m,w=-1,T,A=l[0*2+1],y=0,B=7,D=4;for(A===0&&(B=138,D=3),m=0;m<=p;m++)if(T=A,A=l[(m+1)*2+1],!(++y<B&&T===A)){if(y<D)do send_code(h,T,h.bl_tree);while(--y!=0);else T!==0?(T!==w&&(send_code(h,T,h.bl_tree),y--),send_code(h,REP_3_6,h.bl_tree),send_bits(h,y-3,2)):y<=10?(send_code(h,REPZ_3_10,h.bl_tree),send_bits(h,y-3,3)):(send_code(h,REPZ_11_138,h.bl_tree),send_bits(h,y-11,7));y=0,w=T,A===0?(B=138,D=3):T===A?(B=6,D=3):(B=7,D=4)}},build_bl_tree=h=>{let l;for(scan_tree(h,h.dyn_ltree,h.l_desc.max_code),scan_tree(h,h.dyn_dtree,h.d_desc.max_code),build_tree(h,h.bl_desc),l=BL_CODES$1-1;l>=3&&h.bl_tree[bl_order[l]*2+1]===0;l--);return h.opt_len+=3*(l+1)+5+5+4,l},send_all_trees=(h,l,p,m)=>{let w;for(send_bits(h,l-257,5),send_bits(h,p-1,5),send_bits(h,m-4,4),w=0;w<m;w++)send_bits(h,h.bl_tree[bl_order[w]*2+1],3);send_tree(h,h.dyn_ltree,l-1),send_tree(h,h.dyn_dtree,p-1)},detect_data_type=h=>{let l=4093624447,p;for(p=0;p<=31;p++,l>>>=1)if(l&1&&h.dyn_ltree[p*2]!==0)return Z_BINARY;if(h.dyn_ltree[9*2]!==0||h.dyn_ltree[10*2]!==0||h.dyn_ltree[13*2]!==0)return Z_TEXT;for(p=32;p<LITERALS$1;p++)if(h.dyn_ltree[p*2]!==0)return Z_TEXT;return Z_BINARY};let static_init_done=!1;const _tr_init$1=h=>{static_init_done||(tr_static_init(),static_init_done=!0),h.l_desc=new TreeDesc(h.dyn_ltree,static_l_desc),h.d_desc=new TreeDesc(h.dyn_dtree,static_d_desc),h.bl_desc=new TreeDesc(h.bl_tree,static_bl_desc),h.bi_buf=0,h.bi_valid=0,init_block(h)},_tr_stored_block$1=(h,l,p,m)=>{send_bits(h,(STORED_BLOCK<<1)+(m?1:0),3),copy_block(h,l,p,!0)},_tr_align$1=h=>{send_bits(h,STATIC_TREES<<1,3),send_code(h,END_BLOCK,static_ltree),bi_flush(h)},_tr_flush_block$1=(h,l,p,m)=>{let w,T,A=0;h.level>0?(h.strm.data_type===Z_UNKNOWN$1&&(h.strm.data_type=detect_data_type(h)),build_tree(h,h.l_desc),build_tree(h,h.d_desc),A=build_bl_tree(h),w=h.opt_len+3+7>>>3,T=h.static_len+3+7>>>3,T<=w&&(w=T)):w=T=p+5,p+4<=w&&l!==-1?_tr_stored_block$1(h,l,p,m):h.strategy===Z_FIXED$1||T===w?(send_bits(h,(STATIC_TREES<<1)+(m?1:0),3),compress_block(h,static_ltree,static_dtree)):(send_bits(h,(DYN_TREES<<1)+(m?1:0),3),send_all_trees(h,h.l_desc.max_code+1,h.d_desc.max_code+1,A+1),compress_block(h,h.dyn_ltree,h.dyn_dtree)),init_block(h),m&&bi_windup(h)},_tr_tally$1=(h,l,p)=>(h.pending_buf[h.d_buf+h.last_lit*2]=l>>>8&255,h.pending_buf[h.d_buf+h.last_lit*2+1]=l&255,h.pending_buf[h.l_buf+h.last_lit]=p&255,h.last_lit++,l===0?h.dyn_ltree[p*2]++:(h.matches++,l--,h.dyn_ltree[(_length_code[p]+LITERALS$1+1)*2]++,h.dyn_dtree[d_code(l)*2]++),h.last_lit===h.lit_bufsize-1);var _tr_init_1=_tr_init$1,_tr_stored_block_1=_tr_stored_block$1,_tr_flush_block_1=_tr_flush_block$1,_tr_tally_1=_tr_tally$1,_tr_align_1=_tr_align$1,trees={_tr_init:_tr_init_1,_tr_stored_block:_tr_stored_block_1,_tr_flush_block:_tr_flush_block_1,_tr_tally:_tr_tally_1,_tr_align:_tr_align_1};const adler32=(h,l,p,m)=>{let w=h&65535|0,T=h>>>16&65535|0,A=0;for(;p!==0;){A=p>2e3?2e3:p,p-=A;do w=w+l[m++]|0,T=T+w|0;while(--A);w%=65521,T%=65521}return w|T<<16|0};var adler32_1=adler32;const makeTable=()=>{let h,l=[];for(var p=0;p<256;p++){h=p;for(var m=0;m<8;m++)h=h&1?3988292384^h>>>1:h>>>1;l[p]=h}return l},crcTable$1=new Uint32Array(makeTable()),crc32=(h,l,p,m)=>{const w=crcTable$1,T=m+p;h^=-1;for(let A=m;A<T;A++)h=h>>>8^w[(h^l[A])&255];return h^-1};var crc32_1=crc32,messages={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},constants$2$1={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init,_tr_stored_block,_tr_flush_block,_tr_tally,_tr_align}=trees,{Z_NO_FLUSH:Z_NO_FLUSH$2,Z_PARTIAL_FLUSH,Z_FULL_FLUSH:Z_FULL_FLUSH$1,Z_FINISH:Z_FINISH$3,Z_BLOCK:Z_BLOCK$1,Z_OK:Z_OK$3,Z_STREAM_END:Z_STREAM_END$3,Z_STREAM_ERROR:Z_STREAM_ERROR$2,Z_DATA_ERROR:Z_DATA_ERROR$2,Z_BUF_ERROR:Z_BUF_ERROR$1,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$1,Z_FILTERED,Z_HUFFMAN_ONLY,Z_RLE,Z_FIXED,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY$1,Z_UNKNOWN,Z_DEFLATED:Z_DEFLATED$2}=constants$2$1,MAX_MEM_LEVEL=9,MAX_WBITS$1=15,DEF_MEM_LEVEL=8,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,MIN_MATCH=3,MAX_MATCH=258,MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1,PRESET_DICT=32,INIT_STATE=42,EXTRA_STATE=69,NAME_STATE=73,COMMENT_STATE=91,HCRC_STATE=103,BUSY_STATE=113,FINISH_STATE=666,BS_NEED_MORE=1,BS_BLOCK_DONE=2,BS_FINISH_STARTED=3,BS_FINISH_DONE=4,OS_CODE=3,err=(h,l)=>(h.msg=messages[l],l),rank=h=>(h<<1)-(h>4?9:0),zero=h=>{let l=h.length;for(;--l>=0;)h[l]=0};let HASH_ZLIB=(h,l,p)=>(l<<h.hash_shift^p)&h.hash_mask,HASH=HASH_ZLIB;const flush_pending=h=>{const l=h.state;let p=l.pending;p>h.avail_out&&(p=h.avail_out),p!==0&&(h.output.set(l.pending_buf.subarray(l.pending_out,l.pending_out+p),h.next_out),h.next_out+=p,l.pending_out+=p,h.total_out+=p,h.avail_out-=p,l.pending-=p,l.pending===0&&(l.pending_out=0))},flush_block_only=(h,l)=>{_tr_flush_block(h,h.block_start>=0?h.block_start:-1,h.strstart-h.block_start,l),h.block_start=h.strstart,flush_pending(h.strm)},put_byte=(h,l)=>{h.pending_buf[h.pending++]=l},putShortMSB=(h,l)=>{h.pending_buf[h.pending++]=l>>>8&255,h.pending_buf[h.pending++]=l&255},read_buf=(h,l,p,m)=>{let w=h.avail_in;return w>m&&(w=m),w===0?0:(h.avail_in-=w,l.set(h.input.subarray(h.next_in,h.next_in+w),p),h.state.wrap===1?h.adler=adler32_1(h.adler,l,w,p):h.state.wrap===2&&(h.adler=crc32_1(h.adler,l,w,p)),h.next_in+=w,h.total_in+=w,w)},longest_match=(h,l)=>{let p=h.max_chain_length,m=h.strstart,w,T,A=h.prev_length,y=h.nice_match;const B=h.strstart>h.w_size-MIN_LOOKAHEAD?h.strstart-(h.w_size-MIN_LOOKAHEAD):0,D=h.window,O=h.w_mask,N=h.prev,j=h.strstart+MAX_MATCH;let G=D[m+A-1],H=D[m+A];h.prev_length>=h.good_match&&(p>>=2),y>h.lookahead&&(y=h.lookahead);do if(w=l,!(D[w+A]!==H||D[w+A-1]!==G||D[w]!==D[m]||D[++w]!==D[m+1])){m+=2,w++;do;while(D[++m]===D[++w]&&D[++m]===D[++w]&&D[++m]===D[++w]&&D[++m]===D[++w]&&D[++m]===D[++w]&&D[++m]===D[++w]&&D[++m]===D[++w]&&D[++m]===D[++w]&&m<j);if(T=MAX_MATCH-(j-m),m=j-MAX_MATCH,T>A){if(h.match_start=l,A=T,T>=y)break;G=D[m+A-1],H=D[m+A]}}while((l=N[l&O])>B&&--p!=0);return A<=h.lookahead?A:h.lookahead},fill_window=h=>{const l=h.w_size;let p,m,w,T,A;do{if(T=h.window_size-h.lookahead-h.strstart,h.strstart>=l+(l-MIN_LOOKAHEAD)){h.window.set(h.window.subarray(l,l+l),0),h.match_start-=l,h.strstart-=l,h.block_start-=l,m=h.hash_size,p=m;do w=h.head[--p],h.head[p]=w>=l?w-l:0;while(--m);m=l,p=m;do w=h.prev[--p],h.prev[p]=w>=l?w-l:0;while(--m);T+=l}if(h.strm.avail_in===0)break;if(m=read_buf(h.strm,h.window,h.strstart+h.lookahead,T),h.lookahead+=m,h.lookahead+h.insert>=MIN_MATCH)for(A=h.strstart-h.insert,h.ins_h=h.window[A],h.ins_h=HASH(h,h.ins_h,h.window[A+1]);h.insert&&(h.ins_h=HASH(h,h.ins_h,h.window[A+MIN_MATCH-1]),h.prev[A&h.w_mask]=h.head[h.ins_h],h.head[h.ins_h]=A,A++,h.insert--,!(h.lookahead+h.insert<MIN_MATCH)););}while(h.lookahead<MIN_LOOKAHEAD&&h.strm.avail_in!==0)},deflate_stored=(h,l)=>{let p=65535;for(p>h.pending_buf_size-5&&(p=h.pending_buf_size-5);;){if(h.lookahead<=1){if(fill_window(h),h.lookahead===0&&l===Z_NO_FLUSH$2)return BS_NEED_MORE;if(h.lookahead===0)break}h.strstart+=h.lookahead,h.lookahead=0;const m=h.block_start+p;if((h.strstart===0||h.strstart>=m)&&(h.lookahead=h.strstart-m,h.strstart=m,flush_block_only(h,!1),h.strm.avail_out===0)||h.strstart-h.block_start>=h.w_size-MIN_LOOKAHEAD&&(flush_block_only(h,!1),h.strm.avail_out===0))return BS_NEED_MORE}return h.insert=0,l===Z_FINISH$3?(flush_block_only(h,!0),h.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):(h.strstart>h.block_start&&(flush_block_only(h,!1),h.strm.avail_out===0),BS_NEED_MORE)},deflate_fast=(h,l)=>{let p,m;for(;;){if(h.lookahead<MIN_LOOKAHEAD){if(fill_window(h),h.lookahead<MIN_LOOKAHEAD&&l===Z_NO_FLUSH$2)return BS_NEED_MORE;if(h.lookahead===0)break}if(p=0,h.lookahead>=MIN_MATCH&&(h.ins_h=HASH(h,h.ins_h,h.window[h.strstart+MIN_MATCH-1]),p=h.prev[h.strstart&h.w_mask]=h.head[h.ins_h],h.head[h.ins_h]=h.strstart),p!==0&&h.strstart-p<=h.w_size-MIN_LOOKAHEAD&&(h.match_length=longest_match(h,p)),h.match_length>=MIN_MATCH)if(m=_tr_tally(h,h.strstart-h.match_start,h.match_length-MIN_MATCH),h.lookahead-=h.match_length,h.match_length<=h.max_lazy_match&&h.lookahead>=MIN_MATCH){h.match_length--;do h.strstart++,h.ins_h=HASH(h,h.ins_h,h.window[h.strstart+MIN_MATCH-1]),p=h.prev[h.strstart&h.w_mask]=h.head[h.ins_h],h.head[h.ins_h]=h.strstart;while(--h.match_length!=0);h.strstart++}else h.strstart+=h.match_length,h.match_length=0,h.ins_h=h.window[h.strstart],h.ins_h=HASH(h,h.ins_h,h.window[h.strstart+1]);else m=_tr_tally(h,0,h.window[h.strstart]),h.lookahead--,h.strstart++;if(m&&(flush_block_only(h,!1),h.strm.avail_out===0))return BS_NEED_MORE}return h.insert=h.strstart<MIN_MATCH-1?h.strstart:MIN_MATCH-1,l===Z_FINISH$3?(flush_block_only(h,!0),h.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):h.last_lit&&(flush_block_only(h,!1),h.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_slow=(h,l)=>{let p,m,w;for(;;){if(h.lookahead<MIN_LOOKAHEAD){if(fill_window(h),h.lookahead<MIN_LOOKAHEAD&&l===Z_NO_FLUSH$2)return BS_NEED_MORE;if(h.lookahead===0)break}if(p=0,h.lookahead>=MIN_MATCH&&(h.ins_h=HASH(h,h.ins_h,h.window[h.strstart+MIN_MATCH-1]),p=h.prev[h.strstart&h.w_mask]=h.head[h.ins_h],h.head[h.ins_h]=h.strstart),h.prev_length=h.match_length,h.prev_match=h.match_start,h.match_length=MIN_MATCH-1,p!==0&&h.prev_length<h.max_lazy_match&&h.strstart-p<=h.w_size-MIN_LOOKAHEAD&&(h.match_length=longest_match(h,p),h.match_length<=5&&(h.strategy===Z_FILTERED||h.match_length===MIN_MATCH&&h.strstart-h.match_start>4096)&&(h.match_length=MIN_MATCH-1)),h.prev_length>=MIN_MATCH&&h.match_length<=h.prev_length){w=h.strstart+h.lookahead-MIN_MATCH,m=_tr_tally(h,h.strstart-1-h.prev_match,h.prev_length-MIN_MATCH),h.lookahead-=h.prev_length-1,h.prev_length-=2;do++h.strstart<=w&&(h.ins_h=HASH(h,h.ins_h,h.window[h.strstart+MIN_MATCH-1]),p=h.prev[h.strstart&h.w_mask]=h.head[h.ins_h],h.head[h.ins_h]=h.strstart);while(--h.prev_length!=0);if(h.match_available=0,h.match_length=MIN_MATCH-1,h.strstart++,m&&(flush_block_only(h,!1),h.strm.avail_out===0))return BS_NEED_MORE}else if(h.match_available){if(m=_tr_tally(h,0,h.window[h.strstart-1]),m&&flush_block_only(h,!1),h.strstart++,h.lookahead--,h.strm.avail_out===0)return BS_NEED_MORE}else h.match_available=1,h.strstart++,h.lookahead--}return h.match_available&&(m=_tr_tally(h,0,h.window[h.strstart-1]),h.match_available=0),h.insert=h.strstart<MIN_MATCH-1?h.strstart:MIN_MATCH-1,l===Z_FINISH$3?(flush_block_only(h,!0),h.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):h.last_lit&&(flush_block_only(h,!1),h.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_rle=(h,l)=>{let p,m,w,T;const A=h.window;for(;;){if(h.lookahead<=MAX_MATCH){if(fill_window(h),h.lookahead<=MAX_MATCH&&l===Z_NO_FLUSH$2)return BS_NEED_MORE;if(h.lookahead===0)break}if(h.match_length=0,h.lookahead>=MIN_MATCH&&h.strstart>0&&(w=h.strstart-1,m=A[w],m===A[++w]&&m===A[++w]&&m===A[++w])){T=h.strstart+MAX_MATCH;do;while(m===A[++w]&&m===A[++w]&&m===A[++w]&&m===A[++w]&&m===A[++w]&&m===A[++w]&&m===A[++w]&&m===A[++w]&&w<T);h.match_length=MAX_MATCH-(T-w),h.match_length>h.lookahead&&(h.match_length=h.lookahead)}if(h.match_length>=MIN_MATCH?(p=_tr_tally(h,1,h.match_length-MIN_MATCH),h.lookahead-=h.match_length,h.strstart+=h.match_length,h.match_length=0):(p=_tr_tally(h,0,h.window[h.strstart]),h.lookahead--,h.strstart++),p&&(flush_block_only(h,!1),h.strm.avail_out===0))return BS_NEED_MORE}return h.insert=0,l===Z_FINISH$3?(flush_block_only(h,!0),h.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):h.last_lit&&(flush_block_only(h,!1),h.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_huff=(h,l)=>{let p;for(;;){if(h.lookahead===0&&(fill_window(h),h.lookahead===0)){if(l===Z_NO_FLUSH$2)return BS_NEED_MORE;break}if(h.match_length=0,p=_tr_tally(h,0,h.window[h.strstart]),h.lookahead--,h.strstart++,p&&(flush_block_only(h,!1),h.strm.avail_out===0))return BS_NEED_MORE}return h.insert=0,l===Z_FINISH$3?(flush_block_only(h,!0),h.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):h.last_lit&&(flush_block_only(h,!1),h.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE};function Config(h,l,p,m,w){this.good_length=h,this.max_lazy=l,this.nice_length=p,this.max_chain=m,this.func=w}const configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],lm_init=h=>{h.window_size=2*h.w_size,zero(h.head),h.max_lazy_match=configuration_table[h.level].max_lazy,h.good_match=configuration_table[h.level].good_length,h.nice_match=configuration_table[h.level].nice_length,h.max_chain_length=configuration_table[h.level].max_chain,h.strstart=0,h.block_start=0,h.lookahead=0,h.insert=0,h.match_length=h.prev_length=MIN_MATCH-1,h.match_available=0,h.ins_h=0};function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Z_DEFLATED$2,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(HEAP_SIZE*2),this.dyn_dtree=new Uint16Array((2*D_CODES+1)*2),this.bl_tree=new Uint16Array((2*BL_CODES+1)*2),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(MAX_BITS+1),this.heap=new Uint16Array(2*L_CODES+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*L_CODES+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const deflateResetKeep=h=>{if(!h||!h.state)return err(h,Z_STREAM_ERROR$2);h.total_in=h.total_out=0,h.data_type=Z_UNKNOWN;const l=h.state;return l.pending=0,l.pending_out=0,l.wrap<0&&(l.wrap=-l.wrap),l.status=l.wrap?INIT_STATE:BUSY_STATE,h.adler=l.wrap===2?0:1,l.last_flush=Z_NO_FLUSH$2,_tr_init(l),Z_OK$3},deflateReset=h=>{const l=deflateResetKeep(h);return l===Z_OK$3&&lm_init(h.state),l},deflateSetHeader=(h,l)=>!h||!h.state||h.state.wrap!==2?Z_STREAM_ERROR$2:(h.state.gzhead=l,Z_OK$3),deflateInit2=(h,l,p,m,w,T)=>{if(!h)return Z_STREAM_ERROR$2;let A=1;if(l===Z_DEFAULT_COMPRESSION$1&&(l=6),m<0?(A=0,m=-m):m>15&&(A=2,m-=16),w<1||w>MAX_MEM_LEVEL||p!==Z_DEFLATED$2||m<8||m>15||l<0||l>9||T<0||T>Z_FIXED)return err(h,Z_STREAM_ERROR$2);m===8&&(m=9);const y=new DeflateState;return h.state=y,y.strm=h,y.wrap=A,y.gzhead=null,y.w_bits=m,y.w_size=1<<y.w_bits,y.w_mask=y.w_size-1,y.hash_bits=w+7,y.hash_size=1<<y.hash_bits,y.hash_mask=y.hash_size-1,y.hash_shift=~~((y.hash_bits+MIN_MATCH-1)/MIN_MATCH),y.window=new Uint8Array(y.w_size*2),y.head=new Uint16Array(y.hash_size),y.prev=new Uint16Array(y.w_size),y.lit_bufsize=1<<w+6,y.pending_buf_size=y.lit_bufsize*4,y.pending_buf=new Uint8Array(y.pending_buf_size),y.d_buf=1*y.lit_bufsize,y.l_buf=(1+2)*y.lit_bufsize,y.level=l,y.strategy=T,y.method=p,deflateReset(h)},deflateInit=(h,l)=>deflateInit2(h,l,Z_DEFLATED$2,MAX_WBITS$1,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY$1),deflate$2=(h,l)=>{let p,m;if(!h||!h.state||l>Z_BLOCK$1||l<0)return h?err(h,Z_STREAM_ERROR$2):Z_STREAM_ERROR$2;const w=h.state;if(!h.output||!h.input&&h.avail_in!==0||w.status===FINISH_STATE&&l!==Z_FINISH$3)return err(h,h.avail_out===0?Z_BUF_ERROR$1:Z_STREAM_ERROR$2);w.strm=h;const T=w.last_flush;if(w.last_flush=l,w.status===INIT_STATE)if(w.wrap===2)h.adler=0,put_byte(w,31),put_byte(w,139),put_byte(w,8),w.gzhead?(put_byte(w,(w.gzhead.text?1:0)+(w.gzhead.hcrc?2:0)+(w.gzhead.extra?4:0)+(w.gzhead.name?8:0)+(w.gzhead.comment?16:0)),put_byte(w,w.gzhead.time&255),put_byte(w,w.gzhead.time>>8&255),put_byte(w,w.gzhead.time>>16&255),put_byte(w,w.gzhead.time>>24&255),put_byte(w,w.level===9?2:w.strategy>=Z_HUFFMAN_ONLY||w.level<2?4:0),put_byte(w,w.gzhead.os&255),w.gzhead.extra&&w.gzhead.extra.length&&(put_byte(w,w.gzhead.extra.length&255),put_byte(w,w.gzhead.extra.length>>8&255)),w.gzhead.hcrc&&(h.adler=crc32_1(h.adler,w.pending_buf,w.pending,0)),w.gzindex=0,w.status=EXTRA_STATE):(put_byte(w,0),put_byte(w,0),put_byte(w,0),put_byte(w,0),put_byte(w,0),put_byte(w,w.level===9?2:w.strategy>=Z_HUFFMAN_ONLY||w.level<2?4:0),put_byte(w,OS_CODE),w.status=BUSY_STATE);else{let A=Z_DEFLATED$2+(w.w_bits-8<<4)<<8,y=-1;w.strategy>=Z_HUFFMAN_ONLY||w.level<2?y=0:w.level<6?y=1:w.level===6?y=2:y=3,A|=y<<6,w.strstart!==0&&(A|=PRESET_DICT),A+=31-A%31,w.status=BUSY_STATE,putShortMSB(w,A),w.strstart!==0&&(putShortMSB(w,h.adler>>>16),putShortMSB(w,h.adler&65535)),h.adler=1}if(w.status===EXTRA_STATE)if(w.gzhead.extra){for(p=w.pending;w.gzindex<(w.gzhead.extra.length&65535)&&!(w.pending===w.pending_buf_size&&(w.gzhead.hcrc&&w.pending>p&&(h.adler=crc32_1(h.adler,w.pending_buf,w.pending-p,p)),flush_pending(h),p=w.pending,w.pending===w.pending_buf_size));)put_byte(w,w.gzhead.extra[w.gzindex]&255),w.gzindex++;w.gzhead.hcrc&&w.pending>p&&(h.adler=crc32_1(h.adler,w.pending_buf,w.pending-p,p)),w.gzindex===w.gzhead.extra.length&&(w.gzindex=0,w.status=NAME_STATE)}else w.status=NAME_STATE;if(w.status===NAME_STATE)if(w.gzhead.name){p=w.pending;do{if(w.pending===w.pending_buf_size&&(w.gzhead.hcrc&&w.pending>p&&(h.adler=crc32_1(h.adler,w.pending_buf,w.pending-p,p)),flush_pending(h),p=w.pending,w.pending===w.pending_buf_size)){m=1;break}w.gzindex<w.gzhead.name.length?m=w.gzhead.name.charCodeAt(w.gzindex++)&255:m=0,put_byte(w,m)}while(m!==0);w.gzhead.hcrc&&w.pending>p&&(h.adler=crc32_1(h.adler,w.pending_buf,w.pending-p,p)),m===0&&(w.gzindex=0,w.status=COMMENT_STATE)}else w.status=COMMENT_STATE;if(w.status===COMMENT_STATE)if(w.gzhead.comment){p=w.pending;do{if(w.pending===w.pending_buf_size&&(w.gzhead.hcrc&&w.pending>p&&(h.adler=crc32_1(h.adler,w.pending_buf,w.pending-p,p)),flush_pending(h),p=w.pending,w.pending===w.pending_buf_size)){m=1;break}w.gzindex<w.gzhead.comment.length?m=w.gzhead.comment.charCodeAt(w.gzindex++)&255:m=0,put_byte(w,m)}while(m!==0);w.gzhead.hcrc&&w.pending>p&&(h.adler=crc32_1(h.adler,w.pending_buf,w.pending-p,p)),m===0&&(w.status=HCRC_STATE)}else w.status=HCRC_STATE;if(w.status===HCRC_STATE&&(w.gzhead.hcrc?(w.pending+2>w.pending_buf_size&&flush_pending(h),w.pending+2<=w.pending_buf_size&&(put_byte(w,h.adler&255),put_byte(w,h.adler>>8&255),h.adler=0,w.status=BUSY_STATE)):w.status=BUSY_STATE),w.pending!==0){if(flush_pending(h),h.avail_out===0)return w.last_flush=-1,Z_OK$3}else if(h.avail_in===0&&rank(l)<=rank(T)&&l!==Z_FINISH$3)return err(h,Z_BUF_ERROR$1);if(w.status===FINISH_STATE&&h.avail_in!==0)return err(h,Z_BUF_ERROR$1);if(h.avail_in!==0||w.lookahead!==0||l!==Z_NO_FLUSH$2&&w.status!==FINISH_STATE){let A=w.strategy===Z_HUFFMAN_ONLY?deflate_huff(w,l):w.strategy===Z_RLE?deflate_rle(w,l):configuration_table[w.level].func(w,l);if((A===BS_FINISH_STARTED||A===BS_FINISH_DONE)&&(w.status=FINISH_STATE),A===BS_NEED_MORE||A===BS_FINISH_STARTED)return h.avail_out===0&&(w.last_flush=-1),Z_OK$3;if(A===BS_BLOCK_DONE&&(l===Z_PARTIAL_FLUSH?_tr_align(w):l!==Z_BLOCK$1&&(_tr_stored_block(w,0,0,!1),l===Z_FULL_FLUSH$1&&(zero(w.head),w.lookahead===0&&(w.strstart=0,w.block_start=0,w.insert=0))),flush_pending(h),h.avail_out===0))return w.last_flush=-1,Z_OK$3}return l!==Z_FINISH$3?Z_OK$3:w.wrap<=0?Z_STREAM_END$3:(w.wrap===2?(put_byte(w,h.adler&255),put_byte(w,h.adler>>8&255),put_byte(w,h.adler>>16&255),put_byte(w,h.adler>>24&255),put_byte(w,h.total_in&255),put_byte(w,h.total_in>>8&255),put_byte(w,h.total_in>>16&255),put_byte(w,h.total_in>>24&255)):(putShortMSB(w,h.adler>>>16),putShortMSB(w,h.adler&65535)),flush_pending(h),w.wrap>0&&(w.wrap=-w.wrap),w.pending!==0?Z_OK$3:Z_STREAM_END$3)},deflateEnd=h=>{if(!h||!h.state)return Z_STREAM_ERROR$2;const l=h.state.status;return l!==INIT_STATE&&l!==EXTRA_STATE&&l!==NAME_STATE&&l!==COMMENT_STATE&&l!==HCRC_STATE&&l!==BUSY_STATE&&l!==FINISH_STATE?err(h,Z_STREAM_ERROR$2):(h.state=null,l===BUSY_STATE?err(h,Z_DATA_ERROR$2):Z_OK$3)},deflateSetDictionary=(h,l)=>{let p=l.length;if(!h||!h.state)return Z_STREAM_ERROR$2;const m=h.state,w=m.wrap;if(w===2||w===1&&m.status!==INIT_STATE||m.lookahead)return Z_STREAM_ERROR$2;if(w===1&&(h.adler=adler32_1(h.adler,l,p,0)),m.wrap=0,p>=m.w_size){w===0&&(zero(m.head),m.strstart=0,m.block_start=0,m.insert=0);let B=new Uint8Array(m.w_size);B.set(l.subarray(p-m.w_size,p),0),l=B,p=m.w_size}const T=h.avail_in,A=h.next_in,y=h.input;for(h.avail_in=p,h.next_in=0,h.input=l,fill_window(m);m.lookahead>=MIN_MATCH;){let B=m.strstart,D=m.lookahead-(MIN_MATCH-1);do m.ins_h=HASH(m,m.ins_h,m.window[B+MIN_MATCH-1]),m.prev[B&m.w_mask]=m.head[m.ins_h],m.head[m.ins_h]=B,B++;while(--D);m.strstart=B,m.lookahead=MIN_MATCH-1,fill_window(m)}return m.strstart+=m.lookahead,m.block_start=m.strstart,m.insert=m.lookahead,m.lookahead=0,m.match_length=m.prev_length=MIN_MATCH-1,m.match_available=0,h.next_in=A,h.input=y,h.avail_in=T,m.wrap=w,Z_OK$3};var deflateInit_1=deflateInit,deflateInit2_1=deflateInit2,deflateReset_1=deflateReset,deflateResetKeep_1=deflateResetKeep,deflateSetHeader_1=deflateSetHeader,deflate_2$1=deflate$2,deflateEnd_1=deflateEnd,deflateSetDictionary_1=deflateSetDictionary,deflateInfo="pako deflate (from Nodeca project)",deflate_1$2={deflateInit:deflateInit_1,deflateInit2:deflateInit2_1,deflateReset:deflateReset_1,deflateResetKeep:deflateResetKeep_1,deflateSetHeader:deflateSetHeader_1,deflate:deflate_2$1,deflateEnd:deflateEnd_1,deflateSetDictionary:deflateSetDictionary_1,deflateInfo};const _has=(h,l)=>Object.prototype.hasOwnProperty.call(h,l);var assign=function(h){const l=Array.prototype.slice.call(arguments,1);for(;l.length;){const p=l.shift();if(!!p){if(typeof p!="object")throw new TypeError(p+"must be non-object");for(const m in p)_has(p,m)&&(h[m]=p[m])}}return h},flattenChunks=h=>{let l=0;for(let m=0,w=h.length;m<w;m++)l+=h[m].length;const p=new Uint8Array(l);for(let m=0,w=0,T=h.length;m<T;m++){let A=h[m];p.set(A,w),w+=A.length}return p},common={assign,flattenChunks};let STR_APPLY_UIA_OK=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{STR_APPLY_UIA_OK=!1}const _utf8len=new Uint8Array(256);for(let h=0;h<256;h++)_utf8len[h]=h>=252?6:h>=248?5:h>=240?4:h>=224?3:h>=192?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=h=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(h);let l,p,m,w,T,A=h.length,y=0;for(w=0;w<A;w++)p=h.charCodeAt(w),(p&64512)==55296&&w+1<A&&(m=h.charCodeAt(w+1),(m&64512)==56320&&(p=65536+(p-55296<<10)+(m-56320),w++)),y+=p<128?1:p<2048?2:p<65536?3:4;for(l=new Uint8Array(y),T=0,w=0;T<y;w++)p=h.charCodeAt(w),(p&64512)==55296&&w+1<A&&(m=h.charCodeAt(w+1),(m&64512)==56320&&(p=65536+(p-55296<<10)+(m-56320),w++)),p<128?l[T++]=p:p<2048?(l[T++]=192|p>>>6,l[T++]=128|p&63):p<65536?(l[T++]=224|p>>>12,l[T++]=128|p>>>6&63,l[T++]=128|p&63):(l[T++]=240|p>>>18,l[T++]=128|p>>>12&63,l[T++]=128|p>>>6&63,l[T++]=128|p&63);return l};const buf2binstring=(h,l)=>{if(l<65534&&h.subarray&&STR_APPLY_UIA_OK)return String.fromCharCode.apply(null,h.length===l?h:h.subarray(0,l));let p="";for(let m=0;m<l;m++)p+=String.fromCharCode(h[m]);return p};var buf2string=(h,l)=>{const p=l||h.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(h.subarray(0,l));let m,w;const T=new Array(p*2);for(w=0,m=0;m<p;){let A=h[m++];if(A<128){T[w++]=A;continue}let y=_utf8len[A];if(y>4){T[w++]=65533,m+=y-1;continue}for(A&=y===2?31:y===3?15:7;y>1&&m<p;)A=A<<6|h[m++]&63,y--;if(y>1){T[w++]=65533;continue}A<65536?T[w++]=A:(A-=65536,T[w++]=55296|A>>10&1023,T[w++]=56320|A&1023)}return buf2binstring(T,w)},utf8border=(h,l)=>{l=l||h.length,l>h.length&&(l=h.length);let p=l-1;for(;p>=0&&(h[p]&192)==128;)p--;return p<0||p===0?l:p+_utf8len[h[p]]>l?p:l},strings={string2buf,buf2string,utf8border};function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var zstream=ZStream;const toString$1$1=Object.prototype.toString,{Z_NO_FLUSH:Z_NO_FLUSH$1,Z_SYNC_FLUSH,Z_FULL_FLUSH,Z_FINISH:Z_FINISH$2,Z_OK:Z_OK$2,Z_STREAM_END:Z_STREAM_END$2,Z_DEFAULT_COMPRESSION,Z_DEFAULT_STRATEGY,Z_DEFLATED:Z_DEFLATED$1}=constants$2$1;function Deflate$1(h){this.options=common.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED$1,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY},h||{});let l=this.options;l.raw&&l.windowBits>0?l.windowBits=-l.windowBits:l.gzip&&l.windowBits>0&&l.windowBits<16&&(l.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let p=deflate_1$2.deflateInit2(this.strm,l.level,l.method,l.windowBits,l.memLevel,l.strategy);if(p!==Z_OK$2)throw new Error(messages[p]);if(l.header&&deflate_1$2.deflateSetHeader(this.strm,l.header),l.dictionary){let m;if(typeof l.dictionary=="string"?m=strings.string2buf(l.dictionary):toString$1$1.call(l.dictionary)==="[object ArrayBuffer]"?m=new Uint8Array(l.dictionary):m=l.dictionary,p=deflate_1$2.deflateSetDictionary(this.strm,m),p!==Z_OK$2)throw new Error(messages[p]);this._dict_set=!0}}Deflate$1.prototype.push=function(h,l){const p=this.strm,m=this.options.chunkSize;let w,T;if(this.ended)return!1;for(l===~~l?T=l:T=l===!0?Z_FINISH$2:Z_NO_FLUSH$1,typeof h=="string"?p.input=strings.string2buf(h):toString$1$1.call(h)==="[object ArrayBuffer]"?p.input=new Uint8Array(h):p.input=h,p.next_in=0,p.avail_in=p.input.length;;){if(p.avail_out===0&&(p.output=new Uint8Array(m),p.next_out=0,p.avail_out=m),(T===Z_SYNC_FLUSH||T===Z_FULL_FLUSH)&&p.avail_out<=6){this.onData(p.output.subarray(0,p.next_out)),p.avail_out=0;continue}if(w=deflate_1$2.deflate(p,T),w===Z_STREAM_END$2)return p.next_out>0&&this.onData(p.output.subarray(0,p.next_out)),w=deflate_1$2.deflateEnd(this.strm),this.onEnd(w),this.ended=!0,w===Z_OK$2;if(p.avail_out===0){this.onData(p.output);continue}if(T>0&&p.next_out>0){this.onData(p.output.subarray(0,p.next_out)),p.avail_out=0;continue}if(p.avail_in===0)break}return!0};Deflate$1.prototype.onData=function(h){this.chunks.push(h)};Deflate$1.prototype.onEnd=function(h){h===Z_OK$2&&(this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=h,this.msg=this.strm.msg};function deflate$1(h,l){const p=new Deflate$1(l);if(p.push(h,!0),p.err)throw p.msg||messages[p.err];return p.result}function deflateRaw$1(h,l){return l=l||{},l.raw=!0,deflate$1(h,l)}function gzip$1(h,l){return l=l||{},l.gzip=!0,deflate$1(h,l)}var Deflate_1$1=Deflate$1,deflate_2=deflate$1,deflateRaw_1$1=deflateRaw$1,gzip_1$1=gzip$1,constants$1$1=constants$2$1,deflate_1$1={Deflate:Deflate_1$1,deflate:deflate_2,deflateRaw:deflateRaw_1$1,gzip:gzip_1$1,constants:constants$1$1};const BAD$1=30,TYPE$1=12;var inffast=function(l,p){let m,w,T,A,y,B,D,O,N,j,G,H,te,oe,Q,_e,se,he,me,Re,ge,ue,Se,le;const pe=l.state;m=l.next_in,Se=l.input,w=m+(l.avail_in-5),T=l.next_out,le=l.output,A=T-(p-l.avail_out),y=T+(l.avail_out-257),B=pe.dmax,D=pe.wsize,O=pe.whave,N=pe.wnext,j=pe.window,G=pe.hold,H=pe.bits,te=pe.lencode,oe=pe.distcode,Q=(1<<pe.lenbits)-1,_e=(1<<pe.distbits)-1;e:do{H<15&&(G+=Se[m++]<<H,H+=8,G+=Se[m++]<<H,H+=8),se=te[G&Q];t:for(;;){if(he=se>>>24,G>>>=he,H-=he,he=se>>>16&255,he===0)le[T++]=se&65535;else if(he&16){me=se&65535,he&=15,he&&(H<he&&(G+=Se[m++]<<H,H+=8),me+=G&(1<<he)-1,G>>>=he,H-=he),H<15&&(G+=Se[m++]<<H,H+=8,G+=Se[m++]<<H,H+=8),se=oe[G&_e];i:for(;;){if(he=se>>>24,G>>>=he,H-=he,he=se>>>16&255,he&16){if(Re=se&65535,he&=15,H<he&&(G+=Se[m++]<<H,H+=8,H<he&&(G+=Se[m++]<<H,H+=8)),Re+=G&(1<<he)-1,Re>B){l.msg="invalid distance too far back",pe.mode=BAD$1;break e}if(G>>>=he,H-=he,he=T-A,Re>he){if(he=Re-he,he>O&&pe.sane){l.msg="invalid distance too far back",pe.mode=BAD$1;break e}if(ge=0,ue=j,N===0){if(ge+=D-he,he<me){me-=he;do le[T++]=j[ge++];while(--he);ge=T-Re,ue=le}}else if(N<he){if(ge+=D+N-he,he-=N,he<me){me-=he;do le[T++]=j[ge++];while(--he);if(ge=0,N<me){he=N,me-=he;do le[T++]=j[ge++];while(--he);ge=T-Re,ue=le}}}else if(ge+=N-he,he<me){me-=he;do le[T++]=j[ge++];while(--he);ge=T-Re,ue=le}for(;me>2;)le[T++]=ue[ge++],le[T++]=ue[ge++],le[T++]=ue[ge++],me-=3;me&&(le[T++]=ue[ge++],me>1&&(le[T++]=ue[ge++]))}else{ge=T-Re;do le[T++]=le[ge++],le[T++]=le[ge++],le[T++]=le[ge++],me-=3;while(me>2);me&&(le[T++]=le[ge++],me>1&&(le[T++]=le[ge++]))}}else if((he&64)==0){se=oe[(se&65535)+(G&(1<<he)-1)];continue i}else{l.msg="invalid distance code",pe.mode=BAD$1;break e}break}}else if((he&64)==0){se=te[(se&65535)+(G&(1<<he)-1)];continue t}else if(he&32){pe.mode=TYPE$1;break e}else{l.msg="invalid literal/length code",pe.mode=BAD$1;break e}break}}while(m<w&&T<y);me=H>>3,m-=me,H-=me<<3,G&=(1<<H)-1,l.next_in=m,l.next_out=T,l.avail_in=m<w?5+(w-m):5-(m-w),l.avail_out=T<y?257+(y-T):257-(T-y),pe.hold=G,pe.bits=H};const MAXBITS=15,ENOUGH_LENS$1=852,ENOUGH_DISTS$1=592,CODES$1=0,LENS$1=1,DISTS$1=2,lbase=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),lext=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),dbase=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),dext=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),inflate_table=(h,l,p,m,w,T,A,y)=>{const B=y.bits;let D=0,O=0,N=0,j=0,G=0,H=0,te=0,oe=0,Q=0,_e=0,se,he,me,Re,ge,ue=null,Se=0,le;const pe=new Uint16Array(MAXBITS+1),Le=new Uint16Array(MAXBITS+1);let Ze=null,lt=0,ct,$t,Nt;for(D=0;D<=MAXBITS;D++)pe[D]=0;for(O=0;O<m;O++)pe[l[p+O]]++;for(G=B,j=MAXBITS;j>=1&&pe[j]===0;j--);if(G>j&&(G=j),j===0)return w[T++]=1<<24|64<<16|0,w[T++]=1<<24|64<<16|0,y.bits=1,0;for(N=1;N<j&&pe[N]===0;N++);for(G<N&&(G=N),oe=1,D=1;D<=MAXBITS;D++)if(oe<<=1,oe-=pe[D],oe<0)return-1;if(oe>0&&(h===CODES$1||j!==1))return-1;for(Le[1]=0,D=1;D<MAXBITS;D++)Le[D+1]=Le[D]+pe[D];for(O=0;O<m;O++)l[p+O]!==0&&(A[Le[l[p+O]]++]=O);if(h===CODES$1?(ue=Ze=A,le=19):h===LENS$1?(ue=lbase,Se-=257,Ze=lext,lt-=257,le=256):(ue=dbase,Ze=dext,le=-1),_e=0,O=0,D=N,ge=T,H=G,te=0,me=-1,Q=1<<G,Re=Q-1,h===LENS$1&&Q>ENOUGH_LENS$1||h===DISTS$1&&Q>ENOUGH_DISTS$1)return 1;for(;;){ct=D-te,A[O]<le?($t=0,Nt=A[O]):A[O]>le?($t=Ze[lt+A[O]],Nt=ue[Se+A[O]]):($t=32+64,Nt=0),se=1<<D-te,he=1<<H,N=he;do he-=se,w[ge+(_e>>te)+he]=ct<<24|$t<<16|Nt|0;while(he!==0);for(se=1<<D-1;_e&se;)se>>=1;if(se!==0?(_e&=se-1,_e+=se):_e=0,O++,--pe[D]==0){if(D===j)break;D=l[p+A[O]]}if(D>G&&(_e&Re)!==me){for(te===0&&(te=G),ge+=N,H=D-te,oe=1<<H;H+te<j&&(oe-=pe[H+te],!(oe<=0));)H++,oe<<=1;if(Q+=1<<H,h===LENS$1&&Q>ENOUGH_LENS$1||h===DISTS$1&&Q>ENOUGH_DISTS$1)return 1;me=_e&Re,w[me]=G<<24|H<<16|ge-T|0}}return _e!==0&&(w[ge+_e]=D-te<<24|64<<16|0),y.bits=G,0};var inftrees=inflate_table;const CODES=0,LENS=1,DISTS=2,{Z_FINISH:Z_FINISH$1,Z_BLOCK,Z_TREES,Z_OK:Z_OK$1,Z_STREAM_END:Z_STREAM_END$1,Z_NEED_DICT:Z_NEED_DICT$1,Z_STREAM_ERROR:Z_STREAM_ERROR$1,Z_DATA_ERROR:Z_DATA_ERROR$1,Z_MEM_ERROR:Z_MEM_ERROR$1,Z_BUF_ERROR,Z_DEFLATED}=constants$2$1,HEAD=1,FLAGS=2,TIME=3,OS=4,EXLEN=5,EXTRA=6,NAME=7,COMMENT=8,HCRC=9,DICTID=10,DICT=11,TYPE=12,TYPEDO=13,STORED=14,COPY_=15,COPY=16,TABLE=17,LENLENS=18,CODELENS=19,LEN_=20,LEN=21,LENEXT=22,DIST=23,DISTEXT=24,MATCH=25,LIT=26,CHECK=27,LENGTH=28,DONE=29,BAD=30,MEM=31,SYNC=32,ENOUGH_LENS=852,ENOUGH_DISTS=592,MAX_WBITS=15,DEF_WBITS=MAX_WBITS,zswap32=h=>(h>>>24&255)+(h>>>8&65280)+((h&65280)<<8)+((h&255)<<24);function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const inflateResetKeep=h=>{if(!h||!h.state)return Z_STREAM_ERROR$1;const l=h.state;return h.total_in=h.total_out=l.total=0,h.msg="",l.wrap&&(h.adler=l.wrap&1),l.mode=HEAD,l.last=0,l.havedict=0,l.dmax=32768,l.head=null,l.hold=0,l.bits=0,l.lencode=l.lendyn=new Int32Array(ENOUGH_LENS),l.distcode=l.distdyn=new Int32Array(ENOUGH_DISTS),l.sane=1,l.back=-1,Z_OK$1},inflateReset=h=>{if(!h||!h.state)return Z_STREAM_ERROR$1;const l=h.state;return l.wsize=0,l.whave=0,l.wnext=0,inflateResetKeep(h)},inflateReset2=(h,l)=>{let p;if(!h||!h.state)return Z_STREAM_ERROR$1;const m=h.state;return l<0?(p=0,l=-l):(p=(l>>4)+1,l<48&&(l&=15)),l&&(l<8||l>15)?Z_STREAM_ERROR$1:(m.window!==null&&m.wbits!==l&&(m.window=null),m.wrap=p,m.wbits=l,inflateReset(h))},inflateInit2=(h,l)=>{if(!h)return Z_STREAM_ERROR$1;const p=new InflateState;h.state=p,p.window=null;const m=inflateReset2(h,l);return m!==Z_OK$1&&(h.state=null),m},inflateInit=h=>inflateInit2(h,DEF_WBITS);let virgin=!0,lenfix,distfix;const fixedtables=h=>{if(virgin){lenfix=new Int32Array(512),distfix=new Int32Array(32);let l=0;for(;l<144;)h.lens[l++]=8;for(;l<256;)h.lens[l++]=9;for(;l<280;)h.lens[l++]=7;for(;l<288;)h.lens[l++]=8;for(inftrees(LENS,h.lens,0,288,lenfix,0,h.work,{bits:9}),l=0;l<32;)h.lens[l++]=5;inftrees(DISTS,h.lens,0,32,distfix,0,h.work,{bits:5}),virgin=!1}h.lencode=lenfix,h.lenbits=9,h.distcode=distfix,h.distbits=5},updatewindow=(h,l,p,m)=>{let w;const T=h.state;return T.window===null&&(T.wsize=1<<T.wbits,T.wnext=0,T.whave=0,T.window=new Uint8Array(T.wsize)),m>=T.wsize?(T.window.set(l.subarray(p-T.wsize,p),0),T.wnext=0,T.whave=T.wsize):(w=T.wsize-T.wnext,w>m&&(w=m),T.window.set(l.subarray(p-m,p-m+w),T.wnext),m-=w,m?(T.window.set(l.subarray(p-m,p),0),T.wnext=m,T.whave=T.wsize):(T.wnext+=w,T.wnext===T.wsize&&(T.wnext=0),T.whave<T.wsize&&(T.whave+=w))),0},inflate$2=(h,l)=>{let p,m,w,T,A,y,B,D,O,N,j,G,H,te,oe=0,Q,_e,se,he,me,Re,ge,ue;const Se=new Uint8Array(4);let le,pe;const Le=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!h||!h.state||!h.output||!h.input&&h.avail_in!==0)return Z_STREAM_ERROR$1;p=h.state,p.mode===TYPE&&(p.mode=TYPEDO),A=h.next_out,w=h.output,B=h.avail_out,T=h.next_in,m=h.input,y=h.avail_in,D=p.hold,O=p.bits,N=y,j=B,ue=Z_OK$1;e:for(;;)switch(p.mode){case HEAD:if(p.wrap===0){p.mode=TYPEDO;break}for(;O<16;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if(p.wrap&2&&D===35615){p.check=0,Se[0]=D&255,Se[1]=D>>>8&255,p.check=crc32_1(p.check,Se,2,0),D=0,O=0,p.mode=FLAGS;break}if(p.flags=0,p.head&&(p.head.done=!1),!(p.wrap&1)||(((D&255)<<8)+(D>>8))%31){h.msg="incorrect header check",p.mode=BAD;break}if((D&15)!==Z_DEFLATED){h.msg="unknown compression method",p.mode=BAD;break}if(D>>>=4,O-=4,ge=(D&15)+8,p.wbits===0)p.wbits=ge;else if(ge>p.wbits){h.msg="invalid window size",p.mode=BAD;break}p.dmax=1<<p.wbits,h.adler=p.check=1,p.mode=D&512?DICTID:TYPE,D=0,O=0;break;case FLAGS:for(;O<16;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if(p.flags=D,(p.flags&255)!==Z_DEFLATED){h.msg="unknown compression method",p.mode=BAD;break}if(p.flags&57344){h.msg="unknown header flags set",p.mode=BAD;break}p.head&&(p.head.text=D>>8&1),p.flags&512&&(Se[0]=D&255,Se[1]=D>>>8&255,p.check=crc32_1(p.check,Se,2,0)),D=0,O=0,p.mode=TIME;case TIME:for(;O<32;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}p.head&&(p.head.time=D),p.flags&512&&(Se[0]=D&255,Se[1]=D>>>8&255,Se[2]=D>>>16&255,Se[3]=D>>>24&255,p.check=crc32_1(p.check,Se,4,0)),D=0,O=0,p.mode=OS;case OS:for(;O<16;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}p.head&&(p.head.xflags=D&255,p.head.os=D>>8),p.flags&512&&(Se[0]=D&255,Se[1]=D>>>8&255,p.check=crc32_1(p.check,Se,2,0)),D=0,O=0,p.mode=EXLEN;case EXLEN:if(p.flags&1024){for(;O<16;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}p.length=D,p.head&&(p.head.extra_len=D),p.flags&512&&(Se[0]=D&255,Se[1]=D>>>8&255,p.check=crc32_1(p.check,Se,2,0)),D=0,O=0}else p.head&&(p.head.extra=null);p.mode=EXTRA;case EXTRA:if(p.flags&1024&&(G=p.length,G>y&&(G=y),G&&(p.head&&(ge=p.head.extra_len-p.length,p.head.extra||(p.head.extra=new Uint8Array(p.head.extra_len)),p.head.extra.set(m.subarray(T,T+G),ge)),p.flags&512&&(p.check=crc32_1(p.check,m,G,T)),y-=G,T+=G,p.length-=G),p.length))break e;p.length=0,p.mode=NAME;case NAME:if(p.flags&2048){if(y===0)break e;G=0;do ge=m[T+G++],p.head&&ge&&p.length<65536&&(p.head.name+=String.fromCharCode(ge));while(ge&&G<y);if(p.flags&512&&(p.check=crc32_1(p.check,m,G,T)),y-=G,T+=G,ge)break e}else p.head&&(p.head.name=null);p.length=0,p.mode=COMMENT;case COMMENT:if(p.flags&4096){if(y===0)break e;G=0;do ge=m[T+G++],p.head&&ge&&p.length<65536&&(p.head.comment+=String.fromCharCode(ge));while(ge&&G<y);if(p.flags&512&&(p.check=crc32_1(p.check,m,G,T)),y-=G,T+=G,ge)break e}else p.head&&(p.head.comment=null);p.mode=HCRC;case HCRC:if(p.flags&512){for(;O<16;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if(D!==(p.check&65535)){h.msg="header crc mismatch",p.mode=BAD;break}D=0,O=0}p.head&&(p.head.hcrc=p.flags>>9&1,p.head.done=!0),h.adler=p.check=0,p.mode=TYPE;break;case DICTID:for(;O<32;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}h.adler=p.check=zswap32(D),D=0,O=0,p.mode=DICT;case DICT:if(p.havedict===0)return h.next_out=A,h.avail_out=B,h.next_in=T,h.avail_in=y,p.hold=D,p.bits=O,Z_NEED_DICT$1;h.adler=p.check=1,p.mode=TYPE;case TYPE:if(l===Z_BLOCK||l===Z_TREES)break e;case TYPEDO:if(p.last){D>>>=O&7,O-=O&7,p.mode=CHECK;break}for(;O<3;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}switch(p.last=D&1,D>>>=1,O-=1,D&3){case 0:p.mode=STORED;break;case 1:if(fixedtables(p),p.mode=LEN_,l===Z_TREES){D>>>=2,O-=2;break e}break;case 2:p.mode=TABLE;break;case 3:h.msg="invalid block type",p.mode=BAD}D>>>=2,O-=2;break;case STORED:for(D>>>=O&7,O-=O&7;O<32;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if((D&65535)!=(D>>>16^65535)){h.msg="invalid stored block lengths",p.mode=BAD;break}if(p.length=D&65535,D=0,O=0,p.mode=COPY_,l===Z_TREES)break e;case COPY_:p.mode=COPY;case COPY:if(G=p.length,G){if(G>y&&(G=y),G>B&&(G=B),G===0)break e;w.set(m.subarray(T,T+G),A),y-=G,T+=G,B-=G,A+=G,p.length-=G;break}p.mode=TYPE;break;case TABLE:for(;O<14;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if(p.nlen=(D&31)+257,D>>>=5,O-=5,p.ndist=(D&31)+1,D>>>=5,O-=5,p.ncode=(D&15)+4,D>>>=4,O-=4,p.nlen>286||p.ndist>30){h.msg="too many length or distance symbols",p.mode=BAD;break}p.have=0,p.mode=LENLENS;case LENLENS:for(;p.have<p.ncode;){for(;O<3;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}p.lens[Le[p.have++]]=D&7,D>>>=3,O-=3}for(;p.have<19;)p.lens[Le[p.have++]]=0;if(p.lencode=p.lendyn,p.lenbits=7,le={bits:p.lenbits},ue=inftrees(CODES,p.lens,0,19,p.lencode,0,p.work,le),p.lenbits=le.bits,ue){h.msg="invalid code lengths set",p.mode=BAD;break}p.have=0,p.mode=CODELENS;case CODELENS:for(;p.have<p.nlen+p.ndist;){for(;oe=p.lencode[D&(1<<p.lenbits)-1],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(Q<=O);){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if(se<16)D>>>=Q,O-=Q,p.lens[p.have++]=se;else{if(se===16){for(pe=Q+2;O<pe;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if(D>>>=Q,O-=Q,p.have===0){h.msg="invalid bit length repeat",p.mode=BAD;break}ge=p.lens[p.have-1],G=3+(D&3),D>>>=2,O-=2}else if(se===17){for(pe=Q+3;O<pe;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}D>>>=Q,O-=Q,ge=0,G=3+(D&7),D>>>=3,O-=3}else{for(pe=Q+7;O<pe;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}D>>>=Q,O-=Q,ge=0,G=11+(D&127),D>>>=7,O-=7}if(p.have+G>p.nlen+p.ndist){h.msg="invalid bit length repeat",p.mode=BAD;break}for(;G--;)p.lens[p.have++]=ge}}if(p.mode===BAD)break;if(p.lens[256]===0){h.msg="invalid code -- missing end-of-block",p.mode=BAD;break}if(p.lenbits=9,le={bits:p.lenbits},ue=inftrees(LENS,p.lens,0,p.nlen,p.lencode,0,p.work,le),p.lenbits=le.bits,ue){h.msg="invalid literal/lengths set",p.mode=BAD;break}if(p.distbits=6,p.distcode=p.distdyn,le={bits:p.distbits},ue=inftrees(DISTS,p.lens,p.nlen,p.ndist,p.distcode,0,p.work,le),p.distbits=le.bits,ue){h.msg="invalid distances set",p.mode=BAD;break}if(p.mode=LEN_,l===Z_TREES)break e;case LEN_:p.mode=LEN;case LEN:if(y>=6&&B>=258){h.next_out=A,h.avail_out=B,h.next_in=T,h.avail_in=y,p.hold=D,p.bits=O,inffast(h,j),A=h.next_out,w=h.output,B=h.avail_out,T=h.next_in,m=h.input,y=h.avail_in,D=p.hold,O=p.bits,p.mode===TYPE&&(p.back=-1);break}for(p.back=0;oe=p.lencode[D&(1<<p.lenbits)-1],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(Q<=O);){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if(_e&&(_e&240)==0){for(he=Q,me=_e,Re=se;oe=p.lencode[Re+((D&(1<<he+me)-1)>>he)],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(he+Q<=O);){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}D>>>=he,O-=he,p.back+=he}if(D>>>=Q,O-=Q,p.back+=Q,p.length=se,_e===0){p.mode=LIT;break}if(_e&32){p.back=-1,p.mode=TYPE;break}if(_e&64){h.msg="invalid literal/length code",p.mode=BAD;break}p.extra=_e&15,p.mode=LENEXT;case LENEXT:if(p.extra){for(pe=p.extra;O<pe;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}p.length+=D&(1<<p.extra)-1,D>>>=p.extra,O-=p.extra,p.back+=p.extra}p.was=p.length,p.mode=DIST;case DIST:for(;oe=p.distcode[D&(1<<p.distbits)-1],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(Q<=O);){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if((_e&240)==0){for(he=Q,me=_e,Re=se;oe=p.distcode[Re+((D&(1<<he+me)-1)>>he)],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(he+Q<=O);){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}D>>>=he,O-=he,p.back+=he}if(D>>>=Q,O-=Q,p.back+=Q,_e&64){h.msg="invalid distance code",p.mode=BAD;break}p.offset=se,p.extra=_e&15,p.mode=DISTEXT;case DISTEXT:if(p.extra){for(pe=p.extra;O<pe;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}p.offset+=D&(1<<p.extra)-1,D>>>=p.extra,O-=p.extra,p.back+=p.extra}if(p.offset>p.dmax){h.msg="invalid distance too far back",p.mode=BAD;break}p.mode=MATCH;case MATCH:if(B===0)break e;if(G=j-B,p.offset>G){if(G=p.offset-G,G>p.whave&&p.sane){h.msg="invalid distance too far back",p.mode=BAD;break}G>p.wnext?(G-=p.wnext,H=p.wsize-G):H=p.wnext-G,G>p.length&&(G=p.length),te=p.window}else te=w,H=A-p.offset,G=p.length;G>B&&(G=B),B-=G,p.length-=G;do w[A++]=te[H++];while(--G);p.length===0&&(p.mode=LEN);break;case LIT:if(B===0)break e;w[A++]=p.length,B--,p.mode=LEN;break;case CHECK:if(p.wrap){for(;O<32;){if(y===0)break e;y--,D|=m[T++]<<O,O+=8}if(j-=B,h.total_out+=j,p.total+=j,j&&(h.adler=p.check=p.flags?crc32_1(p.check,w,j,A-j):adler32_1(p.check,w,j,A-j)),j=B,(p.flags?D:zswap32(D))!==p.check){h.msg="incorrect data check",p.mode=BAD;break}D=0,O=0}p.mode=LENGTH;case LENGTH:if(p.wrap&&p.flags){for(;O<32;){if(y===0)break e;y--,D+=m[T++]<<O,O+=8}if(D!==(p.total&4294967295)){h.msg="incorrect length check",p.mode=BAD;break}D=0,O=0}p.mode=DONE;case DONE:ue=Z_STREAM_END$1;break e;case BAD:ue=Z_DATA_ERROR$1;break e;case MEM:return Z_MEM_ERROR$1;case SYNC:default:return Z_STREAM_ERROR$1}return h.next_out=A,h.avail_out=B,h.next_in=T,h.avail_in=y,p.hold=D,p.bits=O,(p.wsize||j!==h.avail_out&&p.mode<BAD&&(p.mode<CHECK||l!==Z_FINISH$1))&&updatewindow(h,h.output,h.next_out,j-h.avail_out),N-=h.avail_in,j-=h.avail_out,h.total_in+=N,h.total_out+=j,p.total+=j,p.wrap&&j&&(h.adler=p.check=p.flags?crc32_1(p.check,w,j,h.next_out-j):adler32_1(p.check,w,j,h.next_out-j)),h.data_type=p.bits+(p.last?64:0)+(p.mode===TYPE?128:0)+(p.mode===LEN_||p.mode===COPY_?256:0),(N===0&&j===0||l===Z_FINISH$1)&&ue===Z_OK$1&&(ue=Z_BUF_ERROR),ue},inflateEnd=h=>{if(!h||!h.state)return Z_STREAM_ERROR$1;let l=h.state;return l.window&&(l.window=null),h.state=null,Z_OK$1},inflateGetHeader=(h,l)=>{if(!h||!h.state)return Z_STREAM_ERROR$1;const p=h.state;return(p.wrap&2)==0?Z_STREAM_ERROR$1:(p.head=l,l.done=!1,Z_OK$1)},inflateSetDictionary=(h,l)=>{const p=l.length;let m,w,T;return!h||!h.state||(m=h.state,m.wrap!==0&&m.mode!==DICT)?Z_STREAM_ERROR$1:m.mode===DICT&&(w=1,w=adler32_1(w,l,p,0),w!==m.check)?Z_DATA_ERROR$1:(T=updatewindow(h,l,p,p),T?(m.mode=MEM,Z_MEM_ERROR$1):(m.havedict=1,Z_OK$1))};var inflateReset_1=inflateReset,inflateReset2_1=inflateReset2,inflateResetKeep_1=inflateResetKeep,inflateInit_1=inflateInit,inflateInit2_1=inflateInit2,inflate_2$1=inflate$2,inflateEnd_1=inflateEnd,inflateGetHeader_1=inflateGetHeader,inflateSetDictionary_1=inflateSetDictionary,inflateInfo="pako inflate (from Nodeca project)",inflate_1$2={inflateReset:inflateReset_1,inflateReset2:inflateReset2_1,inflateResetKeep:inflateResetKeep_1,inflateInit:inflateInit_1,inflateInit2:inflateInit2_1,inflate:inflate_2$1,inflateEnd:inflateEnd_1,inflateGetHeader:inflateGetHeader_1,inflateSetDictionary:inflateSetDictionary_1,inflateInfo};function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var gzheader=GZheader;const toString$3=Object.prototype.toString,{Z_NO_FLUSH,Z_FINISH,Z_OK,Z_STREAM_END,Z_NEED_DICT,Z_STREAM_ERROR,Z_DATA_ERROR,Z_MEM_ERROR}=constants$2$1;function Inflate$1(h){this.options=common.assign({chunkSize:1024*64,windowBits:15,to:""},h||{});const l=this.options;l.raw&&l.windowBits>=0&&l.windowBits<16&&(l.windowBits=-l.windowBits,l.windowBits===0&&(l.windowBits=-15)),l.windowBits>=0&&l.windowBits<16&&!(h&&h.windowBits)&&(l.windowBits+=32),l.windowBits>15&&l.windowBits<48&&(l.windowBits&15)==0&&(l.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let p=inflate_1$2.inflateInit2(this.strm,l.windowBits);if(p!==Z_OK)throw new Error(messages[p]);if(this.header=new gzheader,inflate_1$2.inflateGetHeader(this.strm,this.header),l.dictionary&&(typeof l.dictionary=="string"?l.dictionary=strings.string2buf(l.dictionary):toString$3.call(l.dictionary)==="[object ArrayBuffer]"&&(l.dictionary=new Uint8Array(l.dictionary)),l.raw&&(p=inflate_1$2.inflateSetDictionary(this.strm,l.dictionary),p!==Z_OK)))throw new Error(messages[p])}Inflate$1.prototype.push=function(h,l){const p=this.strm,m=this.options.chunkSize,w=this.options.dictionary;let T,A,y;if(this.ended)return!1;for(l===~~l?A=l:A=l===!0?Z_FINISH:Z_NO_FLUSH,toString$3.call(h)==="[object ArrayBuffer]"?p.input=new Uint8Array(h):p.input=h,p.next_in=0,p.avail_in=p.input.length;;){for(p.avail_out===0&&(p.output=new Uint8Array(m),p.next_out=0,p.avail_out=m),T=inflate_1$2.inflate(p,A),T===Z_NEED_DICT&&w&&(T=inflate_1$2.inflateSetDictionary(p,w),T===Z_OK?T=inflate_1$2.inflate(p,A):T===Z_DATA_ERROR&&(T=Z_NEED_DICT));p.avail_in>0&&T===Z_STREAM_END&&p.state.wrap>0&&h[p.next_in]!==0;)inflate_1$2.inflateReset(p),T=inflate_1$2.inflate(p,A);switch(T){case Z_STREAM_ERROR:case Z_DATA_ERROR:case Z_NEED_DICT:case Z_MEM_ERROR:return this.onEnd(T),this.ended=!0,!1}if(y=p.avail_out,p.next_out&&(p.avail_out===0||T===Z_STREAM_END))if(this.options.to==="string"){let B=strings.utf8border(p.output,p.next_out),D=p.next_out-B,O=strings.buf2string(p.output,B);p.next_out=D,p.avail_out=m-D,D&&p.output.set(p.output.subarray(B,B+D),0),this.onData(O)}else this.onData(p.output.length===p.next_out?p.output:p.output.subarray(0,p.next_out));if(!(T===Z_OK&&y===0)){if(T===Z_STREAM_END)return T=inflate_1$2.inflateEnd(this.strm),this.onEnd(T),this.ended=!0,!0;if(p.avail_in===0)break}}return!0};Inflate$1.prototype.onData=function(h){this.chunks.push(h)};Inflate$1.prototype.onEnd=function(h){h===Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=h,this.msg=this.strm.msg};function inflate$1(h,l){const p=new Inflate$1(l);if(p.push(h),p.err)throw p.msg||messages[p.err];return p.result}function inflateRaw$1(h,l){return l=l||{},l.raw=!0,inflate$1(h,l)}var Inflate_1$1=Inflate$1,inflate_2=inflate$1,inflateRaw_1$1=inflateRaw$1,ungzip$1=inflate$1,constants$5=constants$2$1,inflate_1$1={Inflate:Inflate_1$1,inflate:inflate_2,inflateRaw:inflateRaw_1$1,ungzip:ungzip$1,constants:constants$5};const{Deflate,deflate,deflateRaw,gzip}=deflate_1$1,{Inflate,inflate,inflateRaw,ungzip}=inflate_1$1;var deflate_1=deflate,Inflate_1=Inflate,inflate_1=inflate;const pngSignature=[137,80,78,71,13,10,26,10],crcTable=[];for(let h=0;h<256;h++){let l=h;for(let p=0;p<8;p++)l&1?l=3988292384^l>>>1:l=l>>>1;crcTable[h]=l}const initialCrc=4294967295;function updateCrc(h,l,p){let m=h;for(let w=0;w<p;w++)m=crcTable[(m^l[w])&255]^m>>>8;return m}function crc(h,l){return(updateCrc(initialCrc,h,l)^initialCrc)>>>0}var ColorType;(function(h){h[h.UNKNOWN=-1]="UNKNOWN",h[h.GREYSCALE=0]="GREYSCALE",h[h.TRUECOLOUR=2]="TRUECOLOUR",h[h.INDEXED_COLOUR=3]="INDEXED_COLOUR",h[h.GREYSCALE_ALPHA=4]="GREYSCALE_ALPHA",h[h.TRUECOLOUR_ALPHA=6]="TRUECOLOUR_ALPHA"})(ColorType||(ColorType={}));var CompressionMethod;(function(h){h[h.UNKNOWN=-1]="UNKNOWN",h[h.DEFLATE=0]="DEFLATE"})(CompressionMethod||(CompressionMethod={}));var FilterMethod;(function(h){h[h.UNKNOWN=-1]="UNKNOWN",h[h.ADAPTIVE=0]="ADAPTIVE"})(FilterMethod||(FilterMethod={}));var InterlaceMethod;(function(h){h[h.UNKNOWN=-1]="UNKNOWN",h[h.NO_INTERLACE=0]="NO_INTERLACE",h[h.ADAM7=1]="ADAM7"})(InterlaceMethod||(InterlaceMethod={}));const empty=new Uint8Array(0),NULL="\0",uint16=new Uint16Array([255]),uint8=new Uint8Array(uint16.buffer),osIsLittleEndian=uint8[0]===255;class PngDecoder extends IOBuffer$4{constructor(l,p={}){super(l);const{checkCrc:m=!1}=p;this._checkCrc=m,this._inflator=new Inflate_1,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._end=!1,this._hasPalette=!1,this._palette=[],this._compressionMethod=CompressionMethod.UNKNOWN,this._filterMethod=FilterMethod.UNKNOWN,this._interlaceMethod=InterlaceMethod.UNKNOWN,this._colorType=-1,this.setBigEndian()}decode(){for(this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(let l=0;l<pngSignature.length;l++)if(this.readUint8()!==pngSignature[l])throw new Error(`wrong PNG signature. Byte at ${l} should be ${pngSignature[l]}.`)}decodeChunk(){const l=this.readUint32(),p=this.readChars(4),m=this.offset;switch(p){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(l);break;case"IDAT":this.decodeIDAT(l);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(l);break;case"iCCP":this.decodeiCCP(l);break;case"tEXt":this.decodetEXt(l);break;case"pHYs":this.decodepHYs();break;default:this.skip(l);break}if(this.offset-m!==l)throw new Error(`Length mismatch while decoding chunk ${p}`);if(this._checkCrc){const w=this.readUint32(),T=l+4,A=crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-T-4,T),T);if(A!==w)throw new Error(`CRC mismatch for chunk ${p}. Expected ${w}, found ${A}`)}else this.skip(4)}decodeIHDR(){const l=this._png;l.width=this.readUint32(),l.height=this.readUint32(),l.depth=checkBitDepth(this.readUint8());const p=this.readUint8();this._colorType=p;let m;switch(p){case ColorType.GREYSCALE:m=1;break;case ColorType.TRUECOLOUR:m=3;break;case ColorType.INDEXED_COLOUR:m=1;break;case ColorType.GREYSCALE_ALPHA:m=2;break;case ColorType.TRUECOLOUR_ALPHA:m=4;break;default:throw new Error(`Unknown color type: ${p}`)}if(this._png.channels=m,this._compressionMethod=this.readUint8(),this._compressionMethod!==CompressionMethod.DEFLATE)throw new Error(`Unsupported compression method: ${this._compressionMethod}`);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodePLTE(l){if(l%3!=0)throw new RangeError(`PLTE field length must be a multiple of 3. Got ${l}`);const p=l/3;this._hasPalette=!0;const m=[];this._palette=m;for(let w=0;w<p;w++)m.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(l){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,l)),this.skip(l)}decodetRNS(l){if(this._colorType===3){if(l>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${l} vs ${this._palette.length})`);let p=0;for(;p<l;p++){const m=this.readByte();this._palette[p].push(m)}for(;p<this._palette.length;p++)this._palette[p].push(255)}}decodeiCCP(l){let p="",m;for(;(m=this.readChar())!==NULL;)p+=m;const w=this.readUint8();if(w!==CompressionMethod.DEFLATE)throw new Error(`Unsupported iCCP compression method: ${w}`);const T=this.readBytes(l-p.length-2);this._png.iccEmbeddedProfile={name:p,profile:inflate_1(T)}}decodetEXt(l){let p="",m;for(;(m=this.readChar())!==NULL;)p+=m;this._png.text[p]=this.readChars(l-p.length-1)}decodepHYs(){const l=this.readUint32(),p=this.readUint32(),m=this.readByte();this._png.resolution={x:l,y:p,unit:m}}decodeImage(){if(this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);const l=this._inflator.result;if(this._filterMethod!==FilterMethod.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod===InterlaceMethod.NO_INTERLACE)this.decodeInterlaceNull(l);else throw new Error(`Interlace method ${this._interlaceMethod} not supported`)}decodeInterlaceNull(l){const p=this._png.height,m=this._png.channels*this._png.depth/8,w=this._png.width*m,T=new Uint8Array(this._png.height*w);let A=empty,y=0,B,D;for(let O=0;O<p;O++){switch(B=l.subarray(y+1,y+1+w),D=T.subarray(O*w,(O+1)*w),l[y]){case 0:unfilterNone(B,D,w);break;case 1:unfilterSub(B,D,w,m);break;case 2:unfilterUp(B,D,A,w);break;case 3:unfilterAverage(B,D,A,w,m);break;case 4:unfilterPaeth(B,D,A,w,m);break;default:throw new Error(`Unsupported filter: ${l[y]}`)}A=D,y+=w+1}if(this._hasPalette&&(this._png.palette=this._palette),this._png.depth===16){const O=new Uint16Array(T.buffer);if(osIsLittleEndian)for(let N=0;N<O.length;N++)O[N]=swap16(O[N]);this._png.data=O}else this._png.data=T}}function unfilterNone(h,l,p){for(let m=0;m<p;m++)l[m]=h[m]}function unfilterSub(h,l,p,m){let w=0;for(;w<m;w++)l[w]=h[w];for(;w<p;w++)l[w]=h[w]+l[w-m]&255}function unfilterUp(h,l,p,m){let w=0;if(p.length===0)for(;w<m;w++)l[w]=h[w];else for(;w<m;w++)l[w]=h[w]+p[w]&255}function unfilterAverage(h,l,p,m,w){let T=0;if(p.length===0){for(;T<w;T++)l[T]=h[T];for(;T<m;T++)l[T]=h[T]+(l[T-w]>>1)&255}else{for(;T<w;T++)l[T]=h[T]+(p[T]>>1)&255;for(;T<m;T++)l[T]=h[T]+(l[T-w]+p[T]>>1)&255}}function unfilterPaeth(h,l,p,m,w){let T=0;if(p.length===0){for(;T<w;T++)l[T]=h[T];for(;T<m;T++)l[T]=h[T]+l[T-w]&255}else{for(;T<w;T++)l[T]=h[T]+p[T]&255;for(;T<m;T++)l[T]=h[T]+paethPredictor(l[T-w],p[T],p[T-w])&255}}function paethPredictor(h,l,p){const m=h+l-p,w=Math.abs(m-h),T=Math.abs(m-l),A=Math.abs(m-p);return w<=T&&w<=A?h:T<=A?l:p}function swap16(h){return(h&255)<<8|h>>8&255}function checkBitDepth(h){if(h!==1&&h!==2&&h!==4&&h!==8&&h!==16)throw new Error(`invalid bit depth: ${h}`);return h}const defaultZlibOptions={level:3};class PngEncoder extends IOBuffer$4{constructor(l,p={}){super();this._colorType=ColorType.UNKNOWN,this._zlibOptions=Object.assign({},defaultZlibOptions,p.zlib),this._png=this._checkData(l),this.setBigEndian()}encode(){return this.encodeSignature(),this.encodeIHDR(),this.encodeData(),this.encodeIEND(),this.toArray()}encodeSignature(){this.writeBytes(pngSignature)}encodeIHDR(){this.writeUint32(13),this.writeChars("IHDR"),this.writeUint32(this._png.width),this.writeUint32(this._png.height),this.writeByte(this._png.depth),this.writeByte(this._colorType),this.writeByte(CompressionMethod.DEFLATE),this.writeByte(FilterMethod.ADAPTIVE),this.writeByte(InterlaceMethod.NO_INTERLACE),this.writeCrc(17)}encodeIEND(){this.writeUint32(0),this.writeChars("IEND"),this.writeCrc(4)}encodeIDAT(l){this.writeUint32(l.length),this.writeChars("IDAT"),this.writeBytes(l),this.writeCrc(l.length+4)}encodeData(){const{width:l,height:p,channels:m,depth:w,data:T}=this._png,A=m*l,y=new IOBuffer$4().setBigEndian();let B=0;for(let N=0;N<p;N++)if(y.writeByte(0),w===8)B=writeDataBytes(T,y,A,B);else if(w===16)B=writeDataUint16(T,y,A,B);else throw new Error("unreachable");const D=y.toArray(),O=deflate_1(D,this._zlibOptions);this.encodeIDAT(O)}_checkData(l){const{colorType:p,channels:m,depth:w}=getColorType(l),T={width:checkInteger(l.width,"width"),height:checkInteger(l.height,"height"),channels:m,data:l.data,depth:w,text:{}};this._colorType=p;const A=T.width*T.height*m;if(T.data.length!==A)throw new RangeError(`wrong data size. Found ${T.data.length}, expected ${A}`);return T}writeCrc(l){this.writeUint32(crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-l,l),l))}}function checkInteger(h,l){if(Number.isInteger(h)&&h>0)return h;throw new TypeError(`${l} must be a positive integer`)}function getColorType(h){const{channels:l=4,depth:p=8}=h;if(l!==4&&l!==3&&l!==2&&l!==1)throw new RangeError(`unsupported number of channels: ${l}`);if(p!==8&&p!==16)throw new RangeError(`unsupported bit depth: ${p}`);const m={channels:l,depth:p,colorType:ColorType.UNKNOWN};switch(l){case 4:m.colorType=ColorType.TRUECOLOUR_ALPHA;break;case 3:m.colorType=ColorType.TRUECOLOUR;break;case 1:m.colorType=ColorType.GREYSCALE;break;case 2:m.colorType=ColorType.GREYSCALE_ALPHA;break;default:throw new Error("unsupported number of channels")}return m}function writeDataBytes(h,l,p,m){for(let w=0;w<p;w++)l.writeByte(h[m++]);return m}function writeDataUint16(h,l,p,m){for(let w=0;w<p;w++)l.writeUint16(h[m++]);return m}var ResolutionUnitSpecifier;(function(h){h[h.UNKNOWN=0]="UNKNOWN",h[h.METRE=1]="METRE"})(ResolutionUnitSpecifier||(ResolutionUnitSpecifier={}));function decodePng(h,l){return new PngDecoder(h,l).decode()}function encodePng$1(h,l){return new PngEncoder(h,l).encode()}var encoder$1={exports:{}};(function(h){function l(m){var w=Math.floor,T=new Array(64),A=new Array(64),y=new Array(64),B=new Array(64),D,O,N,j,G=new Array(65535),H=new Array(65535),te=new Array(64),oe=new Array(64),Q=[],_e=0,se=7,he=new Array(64),me=new Array(64),Re=new Array(64),ge=new Array(256),ue=new Array(2048),Se,le=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],pe=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],Le=[0,1,2,3,4,5,6,7,8,9,10,11],Ze=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],lt=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],ct=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],$t=[0,1,2,3,4,5,6,7,8,9,10,11],Nt=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],St=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function Gt(He){for(var jt=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],Kt=0;Kt<64;Kt++){var Yt=w((jt[Kt]*He+50)/100);Yt<1?Yt=1:Yt>255&&(Yt=255),T[le[Kt]]=Yt}for(var ii=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],xt=0;xt<64;xt++){var Mi=w((ii[xt]*He+50)/100);Mi<1?Mi=1:Mi>255&&(Mi=255),A[le[xt]]=Mi}for(var ei=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],Vt=0,Zt=0;Zt<8;Zt++)for(var Et=0;Et<8;Et++)y[Vt]=1/(T[le[Vt]]*ei[Zt]*ei[Et]*8),B[Vt]=1/(A[le[Vt]]*ei[Zt]*ei[Et]*8),Vt++}function Dt(He,jt){for(var Kt=0,Yt=0,ii=new Array,xt=1;xt<=16;xt++){for(var Mi=1;Mi<=He[xt];Mi++)ii[jt[Yt]]=[],ii[jt[Yt]][0]=Kt,ii[jt[Yt]][1]=xt,Yt++,Kt++;Kt*=2}return ii}function Ut(){D=Dt(pe,Le),O=Dt(ct,$t),N=Dt(Ze,lt),j=Dt(Nt,St)}function Xt(){for(var He=1,jt=2,Kt=1;Kt<=15;Kt++){for(var Yt=He;Yt<jt;Yt++)H[32767+Yt]=Kt,G[32767+Yt]=[],G[32767+Yt][1]=Kt,G[32767+Yt][0]=Yt;for(var ii=-(jt-1);ii<=-He;ii++)H[32767+ii]=Kt,G[32767+ii]=[],G[32767+ii][1]=Kt,G[32767+ii][0]=jt-1+ii;He<<=1,jt<<=1}}function ft(){for(var He=0;He<256;He++)ue[He]=19595*He,ue[He+256>>0]=38470*He,ue[He+512>>0]=7471*He+32768,ue[He+768>>0]=-11059*He,ue[He+1024>>0]=-21709*He,ue[He+1280>>0]=32768*He+8421375,ue[He+1536>>0]=-27439*He,ue[He+1792>>0]=-5329*He}function wt(He){for(var jt=He[0],Kt=He[1]-1;Kt>=0;)jt&1<<Kt&&(_e|=1<<se),Kt--,se--,se<0&&(_e==255?(bt(255),bt(0)):bt(_e),se=7,_e=0)}function bt(He){Q.push(He)}function zt(He){bt(He>>8&255),bt(He&255)}function qt(He,jt){var Kt,Yt,ii,xt,Mi,ei,Vt,Zt,Et=0,ti,_i=8,vi=64;for(ti=0;ti<_i;++ti){Kt=He[Et],Yt=He[Et+1],ii=He[Et+2],xt=He[Et+3],Mi=He[Et+4],ei=He[Et+5],Vt=He[Et+6],Zt=He[Et+7];var Ht=Kt+Zt,ci=Kt-Zt,Di=Yt+Vt,$i=Yt-Vt,Oi=ii+ei,pr=ii-ei,vr=xt+Mi,Jr=xt-Mi,Ji=Ht+vr,_r=Ht-vr,zr=Di+Oi,br=Di-Oi;He[Et]=Ji+zr,He[Et+4]=Ji-zr;var yr=(br+_r)*.707106781;He[Et+2]=_r+yr,He[Et+6]=_r-yr,Ji=Jr+pr,zr=pr+$i,br=$i+ci;var Fr=(Ji-br)*.382683433,Ur=.5411961*Ji+Fr,we=1.306562965*br+Fr,Xe=zr*.707106781,ae=ci+Xe,K=ci-Xe;He[Et+5]=K+Ur,He[Et+3]=K-Ur,He[Et+1]=ae+we,He[Et+7]=ae-we,Et+=8}for(Et=0,ti=0;ti<_i;++ti){Kt=He[Et],Yt=He[Et+8],ii=He[Et+16],xt=He[Et+24],Mi=He[Et+32],ei=He[Et+40],Vt=He[Et+48],Zt=He[Et+56];var re=Kt+Zt,de=Kt-Zt,Ae=Yt+Vt,Be=Yt-Vt,Ne=ii+ei,Ue=ii-ei,Fe=xt+Mi,je=xt-Mi,tt=re+Fe,pt=re-Fe,st=Ae+Ne,Rt=Ae-Ne;He[Et]=tt+st,He[Et+32]=tt-st;var gt=(Rt+pt)*.707106781;He[Et+16]=pt+gt,He[Et+48]=pt-gt,tt=je+Ue,st=Ue+Be,Rt=Be+de;var Ve=(tt-Rt)*.382683433,Qe=.5411961*tt+Ve,gi=1.306562965*Rt+Ve,Ai=st*.707106781,ri=de+Ai,wi=de-Ai;He[Et+40]=wi+Qe,He[Et+24]=wi-Qe,He[Et+8]=ri+gi,He[Et+56]=ri-gi,Et++}var Ei;for(ti=0;ti<vi;++ti)Ei=He[ti]*jt[ti],te[ti]=Ei>0?Ei+.5|0:Ei-.5|0;return te}function ui(){zt(65504),zt(16),bt(74),bt(70),bt(73),bt(70),bt(0),bt(1),bt(1),bt(0),zt(1),zt(1),bt(0),bt(0)}function Ct(He){if(!!He){zt(65505),He[0]===69&&He[1]===120&&He[2]===105&&He[3]===102?zt(He.length+2):(zt(He.length+5+2),bt(69),bt(120),bt(105),bt(102),bt(0));for(var jt=0;jt<He.length;jt++)bt(He[jt])}}function di(He,jt){zt(65472),zt(17),bt(8),zt(jt),zt(He),bt(3),bt(1),bt(17),bt(0),bt(2),bt(17),bt(1),bt(3),bt(17),bt(1)}function mi(){zt(65499),zt(132),bt(0);for(var He=0;He<64;He++)bt(T[He]);bt(1);for(var jt=0;jt<64;jt++)bt(A[jt])}function Ti(){zt(65476),zt(418),bt(0);for(var He=0;He<16;He++)bt(pe[He+1]);for(var jt=0;jt<=11;jt++)bt(Le[jt]);bt(16);for(var Kt=0;Kt<16;Kt++)bt(Ze[Kt+1]);for(var Yt=0;Yt<=161;Yt++)bt(lt[Yt]);bt(1);for(var ii=0;ii<16;ii++)bt(ct[ii+1]);for(var xt=0;xt<=11;xt++)bt($t[xt]);bt(17);for(var Mi=0;Mi<16;Mi++)bt(Nt[Mi+1]);for(var ei=0;ei<=161;ei++)bt(St[ei])}function hi(){zt(65498),zt(12),bt(3),bt(1),bt(0),bt(2),bt(17),bt(3),bt(17),bt(0),bt(63),bt(0)}function Pt(He,jt,Kt,Yt,ii){for(var xt=ii[0],Mi=ii[240],ei,Vt=16,Zt=63,Et=64,ti=qt(He,jt),_i=0;_i<Et;++_i)oe[le[_i]]=ti[_i];var vi=oe[0]-Kt;Kt=oe[0],vi==0?wt(Yt[0]):(ei=32767+vi,wt(Yt[H[ei]]),wt(G[ei]));for(var Ht=63;Ht>0&&oe[Ht]==0;Ht--);if(Ht==0)return wt(xt),Kt;for(var ci=1,Di;ci<=Ht;){for(var $i=ci;oe[ci]==0&&ci<=Ht;++ci);var Oi=ci-$i;if(Oi>=Vt){Di=Oi>>4;for(var pr=1;pr<=Di;++pr)wt(Mi);Oi=Oi&15}ei=32767+oe[ci],wt(ii[(Oi<<4)+H[ei]]),wt(G[ei]),ci++}return Ht!=Zt&&wt(xt),Kt}function Tt(){for(var He=String.fromCharCode,jt=0;jt<256;jt++)ge[jt]=He(jt)}this.encode=function(He,jt){new Date().getTime(),jt&&Lt(jt),Q=new Array,_e=0,se=7,zt(65496),ui(),Ct(He.exifBuffer),mi(),di(He.width,He.height),Ti(),hi();var Kt=0,Yt=0,ii=0;_e=0,se=7,this.encode.displayName="_encode_";for(var xt=He.data,Mi=He.width,ei=He.height,Vt=Mi*4,Zt,Et=0,ti,_i,vi,Ht,ci,Di,$i,Oi;Et<ei;){for(Zt=0;Zt<Vt;){for(Ht=Vt*Et+Zt,ci=Ht,Di=-1,$i=0,Oi=0;Oi<64;Oi++)$i=Oi>>3,Di=(Oi&7)*4,ci=Ht+$i*Vt+Di,Et+$i>=ei&&(ci-=Vt*(Et+1+$i-ei)),Zt+Di>=Vt&&(ci-=Zt+Di-Vt+4),ti=xt[ci++],_i=xt[ci++],vi=xt[ci++],he[Oi]=(ue[ti]+ue[_i+256>>0]+ue[vi+512>>0]>>16)-128,me[Oi]=(ue[ti+768>>0]+ue[_i+1024>>0]+ue[vi+1280>>0]>>16)-128,Re[Oi]=(ue[ti+1280>>0]+ue[_i+1536>>0]+ue[vi+1792>>0]>>16)-128;Kt=Pt(he,y,Kt,D,N),Yt=Pt(me,B,Yt,O,j),ii=Pt(Re,B,ii,O,j),Zt+=32}Et+=8}if(se>=0){var pr=[];pr[1]=se+1,pr[0]=(1<<se+1)-1,wt(pr)}return zt(65497),Buffer.from(Q)};function Lt(He){if(He<=0&&(He=1),He>100&&(He=100),Se!=He){var jt=0;He<50?jt=Math.floor(5e3/He):jt=Math.floor(200-He*2),Gt(jt),Se=He}}function Jt(){var He=new Date().getTime();m||(m=50),Tt(),Ut(),Xt(),ft(),Lt(m),new Date().getTime()-He}Jt()}h.exports=p;function p(m,w){typeof w=="undefined"&&(w=50);var T=new l(w),A=T.encode(m,w);return{data:A,width:m.width,height:m.height}}})(encoder$1);var decoder$1={exports:{}};(function(h){var l=function(){var w=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),T=4017,A=799,y=3406,B=2276,D=1567,O=3784,N=5793,j=2896;function G(){}function H(me,Re){for(var ge=0,ue=[],Se,le,pe=16;pe>0&&!me[pe-1];)pe--;ue.push({children:[],index:0});var Le=ue[0],Ze;for(Se=0;Se<pe;Se++){for(le=0;le<me[Se];le++){for(Le=ue.pop(),Le.children[Le.index]=Re[ge];Le.index>0;){if(ue.length===0)throw new Error("Could not recreate Huffman Table");Le=ue.pop()}for(Le.index++,ue.push(Le);ue.length<=Se;)ue.push(Ze={children:[],index:0}),Le.children[Le.index]=Ze.children,Le=Ze;ge++}Se+1<pe&&(ue.push(Ze={children:[],index:0}),Le.children[Le.index]=Ze.children,Le=Ze)}return ue[0].children}function te(me,Re,ge,ue,Se,le,pe,Le,Ze,lt){ge.precision,ge.samplesPerLine,ge.scanLines;var ct=ge.mcusPerLine,$t=ge.progressive;ge.maxH,ge.maxV;var Nt=Re,St=0,Gt=0;function Dt(){if(Gt>0)return Gt--,St>>Gt&1;if(St=me[Re++],St==255){var Vt=me[Re++];if(Vt)throw new Error("unexpected marker: "+(St<<8|Vt).toString(16))}return Gt=7,St>>>7}function Ut(Vt){for(var Zt=Vt,Et;(Et=Dt())!==null;){if(Zt=Zt[Et],typeof Zt=="number")return Zt;if(typeof Zt!="object")throw new Error("invalid huffman sequence")}return null}function Xt(Vt){for(var Zt=0;Vt>0;){var Et=Dt();if(Et===null)return;Zt=Zt<<1|Et,Vt--}return Zt}function ft(Vt){var Zt=Xt(Vt);return Zt>=1<<Vt-1?Zt:Zt+(-1<<Vt)+1}function wt(Vt,Zt){var Et=Ut(Vt.huffmanTableDC),ti=Et===0?0:ft(Et);Zt[0]=Vt.pred+=ti;for(var _i=1;_i<64;){var vi=Ut(Vt.huffmanTableAC),Ht=vi&15,ci=vi>>4;if(Ht===0){if(ci<15)break;_i+=16;continue}_i+=ci;var Di=w[_i];Zt[Di]=ft(Ht),_i++}}function bt(Vt,Zt){var Et=Ut(Vt.huffmanTableDC),ti=Et===0?0:ft(Et)<<Ze;Zt[0]=Vt.pred+=ti}function zt(Vt,Zt){Zt[0]|=Dt()<<Ze}var qt=0;function ui(Vt,Zt){if(qt>0){qt--;return}for(var Et=le,ti=pe;Et<=ti;){var _i=Ut(Vt.huffmanTableAC),vi=_i&15,Ht=_i>>4;if(vi===0){if(Ht<15){qt=Xt(Ht)+(1<<Ht)-1;break}Et+=16;continue}Et+=Ht;var ci=w[Et];Zt[ci]=ft(vi)*(1<<Ze),Et++}}var Ct=0,di;function mi(Vt,Zt){for(var Et=le,ti=pe,_i=0;Et<=ti;){var vi=w[Et],Ht=Zt[vi]<0?-1:1;switch(Ct){case 0:var ci=Ut(Vt.huffmanTableAC),Di=ci&15,_i=ci>>4;if(Di===0)_i<15?(qt=Xt(_i)+(1<<_i),Ct=4):(_i=16,Ct=1);else{if(Di!==1)throw new Error("invalid ACn encoding");di=ft(Di),Ct=_i?2:3}continue;case 1:case 2:Zt[vi]?Zt[vi]+=(Dt()<<Ze)*Ht:(_i--,_i===0&&(Ct=Ct==2?3:0));break;case 3:Zt[vi]?Zt[vi]+=(Dt()<<Ze)*Ht:(Zt[vi]=di<<Ze,Ct=0);break;case 4:Zt[vi]&&(Zt[vi]+=(Dt()<<Ze)*Ht);break}Et++}Ct===4&&(qt--,qt===0&&(Ct=0))}function Ti(Vt,Zt,Et,ti,_i){var vi=Et/ct|0,Ht=Et%ct,ci=vi*Vt.v+ti,Di=Ht*Vt.h+_i;Vt.blocks[ci]===void 0&&lt.tolerantDecoding||Zt(Vt,Vt.blocks[ci][Di])}function hi(Vt,Zt,Et){var ti=Et/Vt.blocksPerLine|0,_i=Et%Vt.blocksPerLine;Vt.blocks[ti]===void 0&&lt.tolerantDecoding||Zt(Vt,Vt.blocks[ti][_i])}var Pt=ue.length,Tt,Lt,Jt,He,jt,Kt;$t?le===0?Kt=Le===0?bt:zt:Kt=Le===0?ui:mi:Kt=wt;var Yt=0,ii,xt;Pt==1?xt=ue[0].blocksPerLine*ue[0].blocksPerColumn:xt=ct*ge.mcusPerColumn,Se||(Se=xt);for(var Mi,ei;Yt<xt;){for(Lt=0;Lt<Pt;Lt++)ue[Lt].pred=0;if(qt=0,Pt==1)for(Tt=ue[0],jt=0;jt<Se;jt++)hi(Tt,Kt,Yt),Yt++;else for(jt=0;jt<Se;jt++){for(Lt=0;Lt<Pt;Lt++)for(Tt=ue[Lt],Mi=Tt.h,ei=Tt.v,Jt=0;Jt<ei;Jt++)for(He=0;He<Mi;He++)Ti(Tt,Kt,Yt,Jt,He);if(Yt++,Yt===xt)break}if(Yt===xt)do{if(me[Re]===255&&me[Re+1]!==0)break;Re+=1}while(Re<me.length-2);if(Gt=0,ii=me[Re]<<8|me[Re+1],ii<65280)throw new Error("marker was not found");if(ii>=65488&&ii<=65495)Re+=2;else break}return Re-Nt}function oe(me,Re){var ge=[],ue=Re.blocksPerLine,Se=Re.blocksPerColumn,le=ue<<3,pe=new Int32Array(64),Le=new Uint8Array(64);function Ze(Xt,ft,wt){var bt=Re.quantizationTable,zt,qt,ui,Ct,di,mi,Ti,hi,Pt,Tt=wt,Lt;for(Lt=0;Lt<64;Lt++)Tt[Lt]=Xt[Lt]*bt[Lt];for(Lt=0;Lt<8;++Lt){var Jt=8*Lt;if(Tt[1+Jt]==0&&Tt[2+Jt]==0&&Tt[3+Jt]==0&&Tt[4+Jt]==0&&Tt[5+Jt]==0&&Tt[6+Jt]==0&&Tt[7+Jt]==0){Pt=N*Tt[0+Jt]+512>>10,Tt[0+Jt]=Pt,Tt[1+Jt]=Pt,Tt[2+Jt]=Pt,Tt[3+Jt]=Pt,Tt[4+Jt]=Pt,Tt[5+Jt]=Pt,Tt[6+Jt]=Pt,Tt[7+Jt]=Pt;continue}zt=N*Tt[0+Jt]+128>>8,qt=N*Tt[4+Jt]+128>>8,ui=Tt[2+Jt],Ct=Tt[6+Jt],di=j*(Tt[1+Jt]-Tt[7+Jt])+128>>8,hi=j*(Tt[1+Jt]+Tt[7+Jt])+128>>8,mi=Tt[3+Jt]<<4,Ti=Tt[5+Jt]<<4,Pt=zt-qt+1>>1,zt=zt+qt+1>>1,qt=Pt,Pt=ui*O+Ct*D+128>>8,ui=ui*D-Ct*O+128>>8,Ct=Pt,Pt=di-Ti+1>>1,di=di+Ti+1>>1,Ti=Pt,Pt=hi+mi+1>>1,mi=hi-mi+1>>1,hi=Pt,Pt=zt-Ct+1>>1,zt=zt+Ct+1>>1,Ct=Pt,Pt=qt-ui+1>>1,qt=qt+ui+1>>1,ui=Pt,Pt=di*B+hi*y+2048>>12,di=di*y-hi*B+2048>>12,hi=Pt,Pt=mi*A+Ti*T+2048>>12,mi=mi*T-Ti*A+2048>>12,Ti=Pt,Tt[0+Jt]=zt+hi,Tt[7+Jt]=zt-hi,Tt[1+Jt]=qt+Ti,Tt[6+Jt]=qt-Ti,Tt[2+Jt]=ui+mi,Tt[5+Jt]=ui-mi,Tt[3+Jt]=Ct+di,Tt[4+Jt]=Ct-di}for(Lt=0;Lt<8;++Lt){var He=Lt;if(Tt[1*8+He]==0&&Tt[2*8+He]==0&&Tt[3*8+He]==0&&Tt[4*8+He]==0&&Tt[5*8+He]==0&&Tt[6*8+He]==0&&Tt[7*8+He]==0){Pt=N*wt[Lt+0]+8192>>14,Tt[0*8+He]=Pt,Tt[1*8+He]=Pt,Tt[2*8+He]=Pt,Tt[3*8+He]=Pt,Tt[4*8+He]=Pt,Tt[5*8+He]=Pt,Tt[6*8+He]=Pt,Tt[7*8+He]=Pt;continue}zt=N*Tt[0*8+He]+2048>>12,qt=N*Tt[4*8+He]+2048>>12,ui=Tt[2*8+He],Ct=Tt[6*8+He],di=j*(Tt[1*8+He]-Tt[7*8+He])+2048>>12,hi=j*(Tt[1*8+He]+Tt[7*8+He])+2048>>12,mi=Tt[3*8+He],Ti=Tt[5*8+He],Pt=zt-qt+1>>1,zt=zt+qt+1>>1,qt=Pt,Pt=ui*O+Ct*D+2048>>12,ui=ui*D-Ct*O+2048>>12,Ct=Pt,Pt=di-Ti+1>>1,di=di+Ti+1>>1,Ti=Pt,Pt=hi+mi+1>>1,mi=hi-mi+1>>1,hi=Pt,Pt=zt-Ct+1>>1,zt=zt+Ct+1>>1,Ct=Pt,Pt=qt-ui+1>>1,qt=qt+ui+1>>1,ui=Pt,Pt=di*B+hi*y+2048>>12,di=di*y-hi*B+2048>>12,hi=Pt,Pt=mi*A+Ti*T+2048>>12,mi=mi*T-Ti*A+2048>>12,Ti=Pt,Tt[0*8+He]=zt+hi,Tt[7*8+He]=zt-hi,Tt[1*8+He]=qt+Ti,Tt[6*8+He]=qt-Ti,Tt[2*8+He]=ui+mi,Tt[5*8+He]=ui-mi,Tt[3*8+He]=Ct+di,Tt[4*8+He]=Ct-di}for(Lt=0;Lt<64;++Lt){var jt=128+(Tt[Lt]+8>>4);ft[Lt]=jt<0?0:jt>255?255:jt}}he(le*Se*8);for(var lt,ct,$t=0;$t<Se;$t++){var Nt=$t<<3;for(lt=0;lt<8;lt++)ge.push(new Uint8Array(le));for(var St=0;St<ue;St++){Ze(Re.blocks[$t][St],Le,pe);var Gt=0,Dt=St<<3;for(ct=0;ct<8;ct++){var Ut=ge[Nt+ct];for(lt=0;lt<8;lt++)Ut[Dt+lt]=Le[Gt++]}}}return ge}function Q(me){return me<0?0:me>255?255:me}G.prototype={load:function(Re){var ge=new XMLHttpRequest;ge.open("GET",Re,!0),ge.responseType="arraybuffer",ge.onload=function(){var ue=new Uint8Array(ge.response||ge.mozResponseArrayBuffer);this.parse(ue),this.onload&&this.onload()}.bind(this),ge.send(null)},parse:function(Re){var ge=this.opts.maxResolutionInMP*1e3*1e3,ue=0;Re.length;function Se(){var Ht=Re[ue]<<8|Re[ue+1];return ue+=2,Ht}function le(){var Ht=Se(),ci=Re.subarray(ue,ue+Ht-2);return ue+=ci.length,ci}function pe(Ht){var ci=0,Di=0,$i,Oi;for(Oi in Ht.components)Ht.components.hasOwnProperty(Oi)&&($i=Ht.components[Oi],ci<$i.h&&(ci=$i.h),Di<$i.v&&(Di=$i.v));var pr=Math.ceil(Ht.samplesPerLine/8/ci),vr=Math.ceil(Ht.scanLines/8/Di);for(Oi in Ht.components)if(Ht.components.hasOwnProperty(Oi)){$i=Ht.components[Oi];var Jr=Math.ceil(Math.ceil(Ht.samplesPerLine/8)*$i.h/ci),Ji=Math.ceil(Math.ceil(Ht.scanLines/8)*$i.v/Di),_r=pr*$i.h,zr=vr*$i.v,br=zr*_r,yr=[];he(br*256);for(var Fr=0;Fr<zr;Fr++){for(var Ur=[],we=0;we<_r;we++)Ur.push(new Int32Array(64));yr.push(Ur)}$i.blocksPerLine=Jr,$i.blocksPerColumn=Ji,$i.blocks=yr}Ht.maxH=ci,Ht.maxV=Di,Ht.mcusPerLine=pr,Ht.mcusPerColumn=vr}var Le=null,Ze=null,lt,ct,$t=[],Nt=[],St=[],Gt=[],Dt=Se(),Ut=-1;if(this.comments=[],Dt!=65496)throw new Error("SOI not found");for(Dt=Se();Dt!=65497;){var Xt,ft;switch(Dt){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var wt=le();if(Dt===65534){var bt=String.fromCharCode.apply(null,wt);this.comments.push(bt)}Dt===65504&&wt[0]===74&&wt[1]===70&&wt[2]===73&&wt[3]===70&&wt[4]===0&&(Le={version:{major:wt[5],minor:wt[6]},densityUnits:wt[7],xDensity:wt[8]<<8|wt[9],yDensity:wt[10]<<8|wt[11],thumbWidth:wt[12],thumbHeight:wt[13],thumbData:wt.subarray(14,14+3*wt[12]*wt[13])}),Dt===65505&&wt[0]===69&&wt[1]===120&&wt[2]===105&&wt[3]===102&&wt[4]===0&&(this.exifBuffer=wt.subarray(5,wt.length)),Dt===65518&&wt[0]===65&&wt[1]===100&&wt[2]===111&&wt[3]===98&&wt[4]===101&&wt[5]===0&&(Ze={version:wt[6],flags0:wt[7]<<8|wt[8],flags1:wt[9]<<8|wt[10],transformCode:wt[11]});break;case 65499:for(var zt=Se(),qt=zt+ue-2;ue<qt;){var ui=Re[ue++];he(64*4);var Ct=new Int32Array(64);if(ui>>4==0)for(ft=0;ft<64;ft++){var di=w[ft];Ct[di]=Re[ue++]}else if(ui>>4==1)for(ft=0;ft<64;ft++){var di=w[ft];Ct[di]=Se()}else throw new Error("DQT: invalid table spec");$t[ui&15]=Ct}break;case 65472:case 65473:case 65474:Se(),lt={},lt.extended=Dt===65473,lt.progressive=Dt===65474,lt.precision=Re[ue++],lt.scanLines=Se(),lt.samplesPerLine=Se(),lt.components={},lt.componentsOrder=[];var mi=lt.scanLines*lt.samplesPerLine;if(mi>ge){var Ti=Math.ceil((mi-ge)/1e6);throw new Error(`maxResolutionInMP limit exceeded by ${Ti}MP`)}var hi=Re[ue++],Pt;for(Xt=0;Xt<hi;Xt++){Pt=Re[ue];var Tt=Re[ue+1]>>4,Lt=Re[ue+1]&15,Jt=Re[ue+2];lt.componentsOrder.push(Pt),lt.components[Pt]={h:Tt,v:Lt,quantizationIdx:Jt},ue+=3}pe(lt),Nt.push(lt);break;case 65476:var He=Se();for(Xt=2;Xt<He;){var jt=Re[ue++],Kt=new Uint8Array(16),Yt=0;for(ft=0;ft<16;ft++,ue++)Yt+=Kt[ft]=Re[ue];he(16+Yt);var ii=new Uint8Array(Yt);for(ft=0;ft<Yt;ft++,ue++)ii[ft]=Re[ue];Xt+=17+Yt,(jt>>4==0?Gt:St)[jt&15]=H(Kt,ii)}break;case 65501:Se(),ct=Se();break;case 65500:Se(),Se();break;case 65498:Se();var xt=Re[ue++],Mi=[],ei;for(Xt=0;Xt<xt;Xt++){ei=lt.components[Re[ue++]];var Vt=Re[ue++];ei.huffmanTableDC=Gt[Vt>>4],ei.huffmanTableAC=St[Vt&15],Mi.push(ei)}var Zt=Re[ue++],Et=Re[ue++],ti=Re[ue++],_i=te(Re,ue,lt,Mi,ct,Zt,Et,ti>>4,ti&15,this.opts);ue+=_i;break;case 65535:Re[ue]!==255&&ue--;break;default:if(Re[ue-3]==255&&Re[ue-2]>=192&&Re[ue-2]<=254){ue-=3;break}else if(Dt===224||Dt==225){if(Ut!==-1)throw new Error(`first unknown JPEG marker at offset ${Ut.toString(16)}, second unknown JPEG marker ${Dt.toString(16)} at offset ${(ue-1).toString(16)}`);Ut=ue-1;const Ht=Se();if(Re[ue+Ht-2]===255){ue+=Ht-2;break}}throw new Error("unknown JPEG marker "+Dt.toString(16))}Dt=Se()}if(Nt.length!=1)throw new Error("only single frame JPEGs supported");for(var Xt=0;Xt<Nt.length;Xt++){var vi=Nt[Xt].components;for(var ft in vi)vi[ft].quantizationTable=$t[vi[ft].quantizationIdx],delete vi[ft].quantizationIdx}this.width=lt.samplesPerLine,this.height=lt.scanLines,this.jfif=Le,this.adobe=Ze,this.components=[];for(var Xt=0;Xt<lt.componentsOrder.length;Xt++){var ei=lt.components[lt.componentsOrder[Xt]];this.components.push({lines:oe(lt,ei),scaleX:ei.h/lt.maxH,scaleY:ei.v/lt.maxV})}},getData:function(Re,ge){var ue=this.width/Re,Se=this.height/ge,le,pe,Le,Ze,lt,ct,$t,Nt,St,Gt,Dt=0,Ut,Xt,ft,wt,bt,zt,qt,ui,Ct,di,mi,Ti=Re*ge*this.components.length;he(Ti);var hi=new Uint8Array(Ti);switch(this.components.length){case 1:for(le=this.components[0],Gt=0;Gt<ge;Gt++)for(lt=le.lines[0|Gt*le.scaleY*Se],St=0;St<Re;St++)Ut=lt[0|St*le.scaleX*ue],hi[Dt++]=Ut;break;case 2:for(le=this.components[0],pe=this.components[1],Gt=0;Gt<ge;Gt++)for(lt=le.lines[0|Gt*le.scaleY*Se],ct=pe.lines[0|Gt*pe.scaleY*Se],St=0;St<Re;St++)Ut=lt[0|St*le.scaleX*ue],hi[Dt++]=Ut,Ut=ct[0|St*pe.scaleX*ue],hi[Dt++]=Ut;break;case 3:for(mi=!0,this.adobe&&this.adobe.transformCode?mi=!0:typeof this.opts.colorTransform!="undefined"&&(mi=!!this.opts.colorTransform),le=this.components[0],pe=this.components[1],Le=this.components[2],Gt=0;Gt<ge;Gt++)for(lt=le.lines[0|Gt*le.scaleY*Se],ct=pe.lines[0|Gt*pe.scaleY*Se],$t=Le.lines[0|Gt*Le.scaleY*Se],St=0;St<Re;St++)mi?(Ut=lt[0|St*le.scaleX*ue],Xt=ct[0|St*pe.scaleX*ue],ft=$t[0|St*Le.scaleX*ue],ui=Q(Ut+1.402*(ft-128)),Ct=Q(Ut-.3441363*(Xt-128)-.71413636*(ft-128)),di=Q(Ut+1.772*(Xt-128))):(ui=lt[0|St*le.scaleX*ue],Ct=ct[0|St*pe.scaleX*ue],di=$t[0|St*Le.scaleX*ue]),hi[Dt++]=ui,hi[Dt++]=Ct,hi[Dt++]=di;break;case 4:if(!this.adobe)throw new Error("Unsupported color mode (4 components)");for(mi=!1,this.adobe&&this.adobe.transformCode?mi=!0:typeof this.opts.colorTransform!="undefined"&&(mi=!!this.opts.colorTransform),le=this.components[0],pe=this.components[1],Le=this.components[2],Ze=this.components[3],Gt=0;Gt<ge;Gt++)for(lt=le.lines[0|Gt*le.scaleY*Se],ct=pe.lines[0|Gt*pe.scaleY*Se],$t=Le.lines[0|Gt*Le.scaleY*Se],Nt=Ze.lines[0|Gt*Ze.scaleY*Se],St=0;St<Re;St++)mi?(Ut=lt[0|St*le.scaleX*ue],Xt=ct[0|St*pe.scaleX*ue],ft=$t[0|St*Le.scaleX*ue],wt=Nt[0|St*Ze.scaleX*ue],bt=255-Q(Ut+1.402*(ft-128)),zt=255-Q(Ut-.3441363*(Xt-128)-.71413636*(ft-128)),qt=255-Q(Ut+1.772*(Xt-128))):(bt=lt[0|St*le.scaleX*ue],zt=ct[0|St*pe.scaleX*ue],qt=$t[0|St*Le.scaleX*ue],wt=Nt[0|St*Ze.scaleX*ue]),hi[Dt++]=255-bt,hi[Dt++]=255-zt,hi[Dt++]=255-qt,hi[Dt++]=255-wt;break;default:throw new Error("Unsupported color mode")}return hi},copyToImageData:function(Re,ge){var ue=Re.width,Se=Re.height,le=Re.data,pe=this.getData(ue,Se),Le=0,Ze=0,lt,ct,$t,Nt,St,Gt,Dt,Ut,Xt;switch(this.components.length){case 1:for(ct=0;ct<Se;ct++)for(lt=0;lt<ue;lt++)$t=pe[Le++],le[Ze++]=$t,le[Ze++]=$t,le[Ze++]=$t,ge&&(le[Ze++]=255);break;case 3:for(ct=0;ct<Se;ct++)for(lt=0;lt<ue;lt++)Dt=pe[Le++],Ut=pe[Le++],Xt=pe[Le++],le[Ze++]=Dt,le[Ze++]=Ut,le[Ze++]=Xt,ge&&(le[Ze++]=255);break;case 4:for(ct=0;ct<Se;ct++)for(lt=0;lt<ue;lt++)St=pe[Le++],Gt=pe[Le++],$t=pe[Le++],Nt=pe[Le++],Dt=255-Q(St*(1-Nt/255)+Nt),Ut=255-Q(Gt*(1-Nt/255)+Nt),Xt=255-Q($t*(1-Nt/255)+Nt),le[Ze++]=Dt,le[Ze++]=Ut,le[Ze++]=Xt,ge&&(le[Ze++]=255);break;default:throw new Error("Unsupported color mode")}}};var _e=0,se=0;function he(me=0){var Re=_e+me;if(Re>se){var ge=Math.ceil((Re-se)/1024/1024);throw new Error(`maxMemoryUsageInMB limit exceeded by at least ${ge}MB`)}_e=Re}return G.resetMaxMemoryUsage=function(me){_e=0,se=me},G.getBytesAllocated=function(){return _e},G.requestMemoryAllocation=he,G}();h.exports=p;function p(m,w={}){var T={colorTransform:void 0,useTArray:!1,formatAsRGBA:!0,tolerantDecoding:!0,maxResolutionInMP:100,maxMemoryUsageInMB:512},A=Yc(Yc({},T),w),y=new Uint8Array(m),B=new l;B.opts=A,l.resetMaxMemoryUsage(A.maxMemoryUsageInMB*1024*1024),B.parse(y);var D=A.formatAsRGBA?4:3,O=B.width*B.height*D;try{l.requestMemoryAllocation(O);var N={width:B.width,height:B.height,exifBuffer:B.exifBuffer,data:A.useTArray?new Uint8Array(O):Buffer.alloc(O)};B.comments.length>0&&(N.comments=B.comments)}catch(j){throw j instanceof RangeError?new Error("Could not allocate enough memory for the image. Required: "+O):j}return B.copyToImageData(N,A.formatAsRGBA),N}})(decoder$1);var encode$2=encoder$1.exports,decode$5=decoder$1.exports,jpegJs={encode:encode$2,decode:decode$5};let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=new Uint8Array(256);for(let h=0;h<chars.length;h++)lookup[chars.charCodeAt(h)]=h;function encode$1(h){let l,p=h.length,m="";for(l=0;l<p;l+=3)m+=chars[h[l]>>2],m+=chars[(h[l]&3)<<4|h[l+1]>>4],m+=chars[(h[l+1]&15)<<2|h[l+2]>>6],m+=chars[h[l+2]&63];return p%3==2?m=`${m.substring(0,m.length-1)}=`:p%3==1&&(m=`${m.substring(0,m.length-2)}==`),m}function decode$4(h){let l=h.length*.75,p=h.length,m=0,w,T,A,y;h[h.length-1]==="="&&(l--,h[h.length-2]==="="&&l--);const B=new Uint8Array(l);for(let D=0;D<p;D+=4)w=lookup[h.charCodeAt(D)],T=lookup[h.charCodeAt(D+1)],A=lookup[h.charCodeAt(D+2)],y=lookup[h.charCodeAt(D+3)],B[m++]=w<<2|T>>4,B[m++]=(T&15)<<4|A>>2,B[m++]=(A&3)<<6|y&63;return B}function toBase64URL(h,l){const p=encode$1(h);return`data:${l};base64,${p}`}const ImageData=self.ImageData,DOMImage=self.Image;function createCanvas(h,l){let p=self.document.createElement("canvas");return p.width=h,p.height=l,p}function fetchBinary(h,{withCredentials:l=!1}={}){return new Promise(function(p,m){let w=new self.XMLHttpRequest;w.open("GET",h,!0),w.responseType="arraybuffer",w.withCredentials=l,w.onload=function(T){this.status!==200?m(T):p(this.response)},w.onerror=m,w.send()})}function createWriteStream(){throw new Error("createWriteStream does not exist in the browser")}function writeFile(){throw new Error("writeFile does not exist in the browser")}function getType(h){return h.includes("/")||(h=`image/${h}`),h}function encodeJpeg(h,l={}){const p={width:h.width,height:h.height,data:h.getRGBAData()};return jpegJs.encode(p,l.quality).data}function encodePng(h,l){const p={width:h.width,height:h.height,channels:h.channels,depth:h.bitDepth,data:h.data};return(p.depth===1||p.depth===32)&&(p.depth=8,p.channels=4,p.data=h.getRGBAData()),encodePng$1(p,l)}const exportMethods={save(h,l={}){const{useCanvas:p=!1,encoder:m=void 0}=l;let{format:w}=l;if(!w){const T=/\.(?<format>[a-zA-Z]+)$/.exec(h);T&&(w=T.groups.format.toLowerCase())}if(!w)throw new Error("file format not provided");return new Promise((T,A)=>{let y,B;switch(w.toLowerCase()){case"png":{p?y=this.getCanvas().pngStream():B=encodePng(this,m);break}case"jpg":case"jpeg":p?y=this.getCanvas().jpegStream():B=encodeJpeg(this,m);break;case"bmp":B=encode$4(this,m);break;default:throw new RangeError(`invalid output format: ${w}`)}if(y){let D=createWriteStream();D.on("finish",T),D.on("error",A),y.pipe(D)}else B&&writeFile()})},toDataURL(h="image/png",l={}){typeof h=="object"&&(l=h,h="image/png");const{useCanvas:p=!1,encoder:m=void 0}=l;h=getType(h);function w(T,A){const y=T(A,m);return toBase64URL(y,h)}return h==="image/bmp"?w(encode$4,this):h==="image/png"&&!p?w(encodePng,this):h==="image/jpeg"&&!p?w(encodeJpeg,this):this.getCanvas().toDataURL(h)},toBuffer(h={}){const{format:l="png",encoder:p=void 0}=h;switch(l.toLowerCase()){case"png":return encodePng(this,p);case"jpeg":case"jpg":return encodeJpeg(this,p);case"bmp":return encode$4(this,p);default:throw new RangeError(`invalid output format: ${l}`)}},toBase64(h="image/png",l={}){if(l.async)return this.toDataURL(h,l).then(function(p){return p.substring(p.indexOf(",")+1)});{const p=this.toDataURL(h,l);return p.substring(p.indexOf(",")+1)}},toBlob(h="image/png",l=.8){return canvasToBlob(this.getCanvas(),h,l)},getCanvas(){const h=new ImageData(this.getRGBAData({clamped:!0}),this.width,this.height);let l=createCanvas(this.width,this.height);return l.getContext("2d").putImageData(h,0,0),l}};function setExportMethods(h){for(const l in exportMethods)h.prototype[l]=exportMethods[l]}var hasOwn$1={exports:{}};const name="has-own",version="1.0.1",description="A safer .hasOwnProperty() - hasOwn(name, obj)",main="index.js",scripts={test:"make test"},author="Aaron Heckmann <aaron.heckmann+github@gmail.com>",license="MIT",repository={type:"git",url:"git://github.com/aheckmann/has-own.git"},homepage="https://github.com/aheckmann/has-own/",devDependencies={mocha:"^6.2.2"};var require$$0$2={name,version,description,main,scripts,author,license,repository,homepage,devDependencies};(function(h,l){var p=Object.prototype.hasOwnProperty;h.exports=l=function(w,T){return p.call(T,w)},l.version=require$$0$2.version})(hasOwn$1,hasOwn$1.exports);var hasOwn=hasOwn$1.exports;let computedPropertyDescriptor$1={configurable:!0,enumerable:!1,get:void 0};function extendMethod(h,l,p={}){let{inPlace:m=!1,returnThis:w=!0,partialArgs:T=[]}=p;return m?Image$1.prototype[h]=function(...A){this.computed=null;let y=l.apply(this,[...T,...A]);return w?this:y}:Image$1.prototype[h]=function(...A){return l.apply(this,[...T,...A])},Image$1}function extendProperty(h,l,p={}){let{partialArgs:m=[]}=p;return computedPropertyDescriptor$1.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(h,this.computed))return this.computed[h];let w=l.apply(this,m);return this.computed[h]=w,w},Object.defineProperty(Image$1.prototype,h,computedPropertyDescriptor$1),Image$1}const GREY$1="GREY",RGB$1="RGB",HSL="HSL",HSV="HSV",CMYK$1="CMYK";var ColorModel=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",GREY:GREY$1,RGB:RGB$1,HSL,HSV,CMYK:CMYK$1});function getRGBAData(h={}){const{clamped:l}=h;this.checkProcessable("getRGBAData",{components:[1,3],bitDepth:[1,8,16,32]});const p=this.width*this.height*4;let m=l?new Uint8ClampedArray(p):new Uint8Array(p);return this.bitDepth===1?fillDataFromBinary(this,m):this.bitDepth===32?(this.checkProcessable("getRGBAData",{alpha:0}),this.components===1?fillDataFromGrey32(this,m):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB32(this,m))):this.components===1?fillDataFromGrey(this,m):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB(this,m)),this.alpha===1?(this.checkProcessable("getRGBAData",{bitDepth:[8,16]}),copyAlpha(this,m)):fillAlpha(this,m),m}function fillDataFromBinary(h,l){for(let p=0;p<h.size;p++){const m=h.getBit(p);l[p*4]=m*255,l[p*4+1]=m*255,l[p*4+2]=m*255}}function fillDataFromGrey32(h,l){const p=h.min[0],w=h.max[0]-p;for(let T=0;T<h.size;T++){const A=Math.floor(255*(h.data[T]-p)/w);l[T*4]=A,l[T*4+1]=A,l[T*4+2]=A}}function fillDataFromRGB32(h,l){const p=Math.min(...h.min),w=Math.max(...h.max)-p;for(let T=0;T<h.size;T++){const A=Math.floor(255*(h.data[T*3]-p)/w),y=Math.floor(255*(h.data[T*3+1]-p)/w),B=Math.floor(255*(h.data[T*3+2]-p)/w);l[T*4]=A,l[T*4+1]=y,l[T*4+2]=B}}function fillDataFromGrey(h,l){for(let p=0;p<h.size;p++)l[p*4]=h.data[p*h.channels]>>>h.bitDepth-8,l[p*4+1]=h.data[p*h.channels]>>>h.bitDepth-8,l[p*4+2]=h.data[p*h.channels]>>>h.bitDepth-8}function fillDataFromRGB(h,l){for(let p=0;p<h.size;p++)l[p*4]=h.data[p*h.channels]>>>h.bitDepth-8,l[p*4+1]=h.data[p*h.channels+1]>>>h.bitDepth-8,l[p*4+2]=h.data[p*h.channels+2]>>>h.bitDepth-8}function copyAlpha(h,l){for(let p=0;p<h.size;p++)l[p*4+3]=h.data[p*h.channels+h.components]>>h.bitDepth-8}function fillAlpha(h,l){for(let p=0;p<h.size;p++)l[p*4+3]=255}const BINARY="BINARY",GREY="GREY",GREYA="GREYA",RGB="RGB",RGBA="RGBA",CMYK="CMYK",CMYKA="CMYKA",kinds={};kinds[BINARY]={components:1,alpha:0,bitDepth:1,colorModel:GREY$1};kinds[GREYA]={components:1,alpha:1,bitDepth:8,colorModel:GREY$1};kinds[GREY]={components:1,alpha:0,bitDepth:8,colorModel:GREY$1};kinds[RGBA]={components:3,alpha:1,bitDepth:8,colorModel:RGB$1};kinds[RGB]={components:3,alpha:0,bitDepth:8,colorModel:RGB$1};kinds[CMYK]={components:4,alpha:0,bitDepth:8,colorModel:CMYK$1};kinds[CMYKA]={components:4,alpha:1,bitDepth:8,colorModel:CMYK$1};function getKind(h){const l=kinds[h];if(!l)throw new RangeError(`invalid image kind: ${h}`);return l}const validBitDepth=[1,8,16,32];function verifyKindDefinition(h){const{components:l,alpha:p,bitDepth:m,colorModel:w}=h;if(!Number.isInteger(l)||l<=0)throw new RangeError(`invalid components: ${l}. Must be a positive integer`);if(p!==0&&p!==1&&typeof p!="boolean")throw new TypeError(`invalid alpha: ${p}: must be a boolean, 0 or 1`);if(!validBitDepth.includes(m))throw new RangeError(`invalid bitDepth: ${m}. Must be one of ${validBitDepth.join(", ")}`);if(!ColorModel[w])throw new RangeError(`invalid colorModel: ${w}. Must be one of ${Object.keys(ColorModel).join(", ")}`)}function getTheoreticalPixelArraySize(h,l,p){let m=l*h;return p===1&&(m=Math.ceil(m/8)),m}function createPixelArray(h,l,p,m,w,T){const A=m*h;let y;switch(w){case 1:y=new Uint8Array(Math.ceil(A/8));break;case 8:y=new Uint8Array(A);break;case 16:y=new Uint16Array(A);break;case 32:y=new Float32Array(A);break;default:throw new Error(`Cannot create pixel array for bit depth ${w}`)}if(p)for(let B=l;B<y.length;B+=m)y[B]=T;return y}const defaultByteLength$1=1024*8,charArray=[];class IOBuffer$3{constructor(l,p){p=p||{},l===void 0&&(l=defaultByteLength$1),typeof l=="number"&&(l=new ArrayBuffer(l));let m=l.byteLength;const w=p.offset?p.offset>>>0:0;l.buffer&&(m=l.byteLength-w,l.byteLength!==l.buffer.byteLength?l=l.buffer.slice(l.byteOffset+w,l.byteOffset+l.byteLength):w?l=l.buffer.slice(w):l=l.buffer),this.buffer=l,this.length=m,this.byteLength=m,this.byteOffset=0,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer),this._increment=m||defaultByteLength$1,this._mark=0}available(l){return l===void 0&&(l=1),this.offset+l<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){this.littleEndian=!0}isBigEndian(){return!this.littleEndian}setBigEndian(){this.littleEndian=!1}skip(l){l===void 0&&(l=1),this.offset+=l}seek(l){this.offset=l}mark(){this._mark=this.offset}reset(){this.offset=this._mark}rewind(){this.offset=0}ensureAvailable(l){if(l===void 0&&(l=1),!this.available(l)){const p=this._increment+this._increment;this._increment=p;const m=this.length+p,w=new Uint8Array(m);w.set(new Uint8Array(this.buffer)),this.buffer=w.buffer,this.length=m,this._data=new DataView(this.buffer)}}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(l){l===void 0&&(l=1);for(var p=new Uint8Array(l),m=0;m<l;m++)p[m]=this.readByte();return p}readInt16(){var l=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,l}readUint16(){var l=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,l}readInt32(){var l=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,l}readUint32(){var l=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,l}readFloat32(){var l=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,l}readFloat64(){var l=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,l}readChar(){return String.fromCharCode(this.readInt8())}readChars(l){l===void 0&&(l=1),charArray.length=l;for(var p=0;p<l;p++)charArray[p]=this.readChar();return charArray.join("")}writeBoolean(l){this.writeUint8(l?255:0)}writeInt8(l){this.ensureAvailable(1),this._data.setInt8(this.offset++,l)}writeUint8(l){this.ensureAvailable(1),this._data.setUint8(this.offset++,l)}writeByte(l){this.writeUint8(l)}writeBytes(l){this.ensureAvailable(l.length);for(var p=0;p<l.length;p++)this._data.setUint8(this.offset++,l[p])}writeInt16(l){this.ensureAvailable(2),this._data.setInt16(this.offset,l,this.littleEndian),this.offset+=2}writeUint16(l){this.ensureAvailable(2),this._data.setUint16(this.offset,l,this.littleEndian),this.offset+=2}writeInt32(l){this.ensureAvailable(4),this._data.setInt32(this.offset,l,this.littleEndian),this.offset+=4}writeUint32(l){this.ensureAvailable(4),this._data.setUint32(this.offset,l,this.littleEndian),this.offset+=4}writeFloat32(l){this.ensureAvailable(4),this._data.setFloat32(this.offset,l,this.littleEndian),this.offset+=4}writeFloat64(l){this.ensureAvailable(8),this._data.setFloat64(this.offset,l,this.littleEndian),this.offset+=8}writeChar(l){this.writeUint8(l.charCodeAt(0))}writeChars(l){for(var p=0;p<l.length;p++)this.writeUint8(l.charCodeAt(p))}toArray(){return new Uint8Array(this.buffer,0,this.offset)}}var IOBuffer_1=IOBuffer$3,src$4={};const tagsById$5={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName$5={};for(var i$4 in tagsById$5)tagsByName$5[tagsById$5[i$4]]=i$4;var standard$1={tagsById:tagsById$5,tagsByName:tagsByName$5};const tagsById$4={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$4={};for(var i$3 in tagsById$4)tagsByName$4[tagsById$4[i$3]]=i$3;var exif$1={tagsById:tagsById$4,tagsByName:tagsByName$4};const tagsById$3={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$3={};for(var i$2 in tagsById$3)tagsByName$3[tagsById$3[i$2]]=i$2;var gps$1={tagsById:tagsById$3,tagsByName:tagsByName$3};const tags$1={standard:standard$1,exif:exif$1,gps:gps$1};class IFD$2{constructor(l){if(!l)throw new Error("missing kind");this.data=null,this.fields=new Map,this.kind=l,this._map=null}get(l){if(typeof l=="number")return this.fields.get(l);if(typeof l=="string")return this.fields.get(tags$1[this.kind].tagsByName[l]);throw new Error("expected a number or string")}get map(){if(!this._map){this._map={};const p=tags$1[this.kind].tagsById;for(var l of this.fields.keys())p[l]&&(this._map[p[l]]=this.fields.get(l))}return this._map}}var ifd=IFD$2;const Ifd=ifd,dateTimeRegex$1=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd$1 extends Ifd{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){var l=new Date,p=dateTimeRegex$1.exec(this.dateTime);return l.setFullYear(p[1],p[2]-1,p[3]),l.setHours(p[4],p[5],p[6]),l}get newSubfileType(){return this.get(254)}get imageWidth(){return this.get(256)}get imageLength(){return this.get(257)}get bitsPerSample(){return this.get(258)}get compression(){return this.get(259)||1}get type(){return this.get(262)}get fillOrder(){return this.get(266)||1}get documentName(){return this.get(269)}get imageDescription(){return this.get(270)}get stripOffsets(){return alwaysArray$1(this.get(273))}get orientation(){return this.get(274)}get samplesPerPixel(){return this.get(277)}get rowsPerStrip(){return this.get(278)}get stripByteCounts(){return alwaysArray$1(this.get(279))}get minSampleValue(){return this.get(280)||0}get maxSampleValue(){return this.get(281)||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get(282)}get yResolution(){return this.get(283)}get planarConfiguration(){return this.get(284)||1}get resolutionUnit(){return this.get(296)||2}get dateTime(){return this.get(306)}get predictor(){return this.get(317)||1}get sampleFormat(){return this.get(339)||1}get sMinSampleValue(){return this.get(340)||this.minSampleValue}get sMaxSampleValue(){return this.get(341)||this.maxSampleValue}}function alwaysArray$1(h){return typeof h=="number"?[h]:h}var tiffIfd=TiffIfd$1,ifdValue={},types$1=new Map([[1,[1,readByte$1]],[2,[1,readASCII$1]],[3,[2,readShort$1]],[4,[4,readLong$1]],[5,[8,readRational$1]],[6,[1,readSByte$1]],[7,[1,readByte$1]],[8,[2,readSShort$1]],[9,[4,readSLong$1]],[10,[8,readSRational$1]],[11,[4,readFloat$1]],[12,[8,readDouble$1]]]);ifdValue.getByteLength=function(h,l){return types$1.get(h)[0]*l};ifdValue.readData=function(h,l,p){return types$1.get(l)[1](h,p)};function readByte$1(h,l){if(l===1)return h.readUint8();for(var p=new Uint8Array(l),m=0;m<l;m++)p[m]=h.readUint8();return p}function readASCII$1(h,l){for(var p=[],m="",w=0;w<l;w++){var T=String.fromCharCode(h.readUint8());T==="\0"?(p.push(m),m=""):m+=T}return p.length===1?p[0]:p}function readShort$1(h,l){if(l===1)return h.readUint16();for(var p=new Uint16Array(l),m=0;m<l;m++)p[m]=h.readUint16();return p}function readLong$1(h,l){if(l===1)return h.readUint32();for(var p=new Uint32Array(l),m=0;m<l;m++)p[m]=h.readUint32();return p}function readRational$1(h,l){if(l===1)return h.readUint32()/h.readUint32();for(var p=new Array(l),m=0;m<l;m++)p[m]=h.readUint32()/h.readUint32();return p}function readSByte$1(h,l){if(l===1)return h.readInt8();for(var p=new Int8Array(l),m=0;m<l;m++)p[m]=h.readInt8();return p}function readSShort$1(h,l){if(l===1)return h.readInt16();for(var p=new Int16Array(l),m=0;m<l;m++)p[m]=h.readInt16();return p}function readSLong$1(h,l){if(l===1)return h.readInt32();for(var p=new Int32Array(l),m=0;m<l;m++)p[m]=h.readInt32();return p}function readSRational$1(h,l){if(l===1)return h.readInt32()/h.readInt32();for(var p=new Array(l),m=0;m<l;m++)p[m]=h.readInt32()/h.readInt32();return p}function readFloat$1(h,l){if(l===1)return h.readFloat32();for(var p=new Float32Array(l),m=0;m<l;m++)p[m]=h.readFloat32();return p}function readDouble$1(h,l){if(l===1)return h.readFloat64();for(var p=new Float64Array(l),m=0;m<l;m++)p[m]=h.readFloat64();return p}const IOBuffer$2=IOBuffer_1,IFD$1=ifd,TiffIFD=tiffIfd,IFDValue=ifdValue,defaultOptions$d={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder$2 extends IOBuffer$2{constructor(l,p){super(l,p);this._nextIFD=0}decode(l){l=Object.assign({},defaultOptions$d,l);const p=[];for(this.decodeHeader();this._nextIFD;)if(p.push(this.decodeIFD(l)),l.onlyFirst)return p[0];return p}decodeHeader(){let l=this.readUint16();if(l===18761)this.setLittleEndian();else if(l===19789)this.setBigEndian();else throw new Error("invalid byte order: 0x"+l.toString(16));if(l=this.readUint16(),l!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(l){this.seek(this._nextIFD);var p;l.kind?p=new IFD$1(l.kind):p=new TiffIFD;const m=this.readUint16();for(var w=0;w<m;w++)this.decodeIFDEntry(p);return l.ignoreImageData||this.decodeImageData(p),this._nextIFD=this.readUint32(),p}decodeIFDEntry(l){const p=this.offset,m=this.readUint16(),w=this.readUint16(),T=this.readUint32();if(w<1||w>12){this.skip(4);return}IFDValue.getByteLength(w,T)>4&&this.seek(this.readUint32());const y=IFDValue.readData(this,w,T);if(l.fields.set(m,y),m===34665||m===34853){let B=this.offset,D;m===34665?D="exif":m===34853&&(D="gps"),this._nextIFD=y,l[D]=this.decodeIFD({kind:D,ignoreImageData:!0}),this.offset=B}this.seek(p),this.skip(12)}decodeImageData(l){const p=l.orientation;switch(p&&p!==1&&unsupported$1("orientation",p),l.type){case 1:case 2:this.readStripData(l);break;default:unsupported$1("image type",l.type);break}}readStripData(l){const p=l.width,m=l.height,w=validateBitDepth(l.bitsPerSample),T=l.sampleFormat;let A=p*m;const y=getDataArray$1(A,1,w,T),B=l.compression,O=l.rowsPerStrip*p,N=l.stripOffsets,j=l.stripByteCounts;for(var G=0,H=0;H<N.length;H++){var te=this.getStripData(B,N[H],j[H]),oe=A>O?O:A;A-=oe,w===8?G=fill8bit$1(y,te,G,oe):w===16?G=fill16bit$1(y,te,G,oe,this.isLittleEndian()):w===32&&T===3?G=fillFloat32$1(y,te,G,oe,this.isLittleEndian()):unsupported$1("bitDepth",w)}l.data=y}getStripData(l,p,m){switch(l){case 1:return new DataView(this.buffer,p,m);case 2:case 32773:return unsupported$1("Compression",l);default:throw new Error("invalid compression: "+l)}}}var tiffDecoder=TIFFDecoder$2;function getDataArray$1(h,l,p,m){return p===8?new Uint8Array(h*l):p===16?new Uint16Array(h*l):p===32&&m===3?new Float32Array(h*l):unsupported$1("bit depth / sample format",p+" / "+m)}function fill8bit$1(h,l,p,m){for(var w=0;w<m;w++)h[p++]=l.getUint8(w);return p}function fill16bit$1(h,l,p,m,w){for(var T=0;T<m*2;T+=2)h[p++]=l.getUint16(T,w);return p}function fillFloat32$1(h,l,p,m,w){for(var T=0;T<m*4;T+=4)h[p++]=l.getFloat32(T,w);return p}function unsupported$1(h,l){throw new Error("Unsupported "+h+": "+l)}function validateBitDepth(h){if(h.length){const p=h;h=p[0];for(var l=0;l<p.length;l++)p[l]!==h&&unsupported$1("bit depth",p)}return h}const TIFFDecoder$1=tiffDecoder;var decode$3=function(l,p){return new TIFFDecoder$1(l,p).decode(p)};src$4.decode=decode$3;const IOBuffer$1=IOBuffer_1,tiff=src$4;function decode$2(h){const l=new IOBuffer$1(h),p={};if(l.setBigEndian(),l.readUint16()!==65496)throw new Error("SOI marker not found. Not a valid JPEG file");if(l.readUint16()===65505){l.readUint16();const T=l.readBytes(6);if(T[0]===69&&T[1]===120&&T[2]===105&&T[3]===102&&T[4]===0&&T[5]===0){const A=tiff.decode(l,{onlyFirst:!0,ignoreImageData:!0,offset:l.offset});p.exif=A}}return p}var decode_1=decode$2,decode$1=decode_1,imageType$2={exports:{}},fileType$1={exports:{}};(function(module){const toBytes=h=>[...h].map(l=>l.charCodeAt(0)),xpiZipFilename=toBytes("META-INF/mozilla.rsa"),oxmlContentTypes=toBytes("[Content_Types].xml"),oxmlRels=toBytes("_rels/.rels");function readUInt64LE(h,l=0){let p=h[l],m=1,w=0;for(;++w<8;)m*=256,p+=h[l+w]*m;return p}const fileType=h=>{if(!(h instanceof Uint8Array||h instanceof ArrayBuffer||Buffer.isBuffer(h)))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`Buffer\` or \`ArrayBuffer\`, got \`${typeof h}\``);const l=h instanceof Uint8Array?h:new Uint8Array(h);if(!(l&&l.length>1))return null;const p=(w,T)=>{T=Object.assign({offset:0},T);for(let A=0;A<w.length;A++)if(T.mask){if(w[A]!==(T.mask[A]&l[A+T.offset]))return!1}else if(w[A]!==l[A+T.offset])return!1;return!0},m=(w,T)=>p(toBytes(w),T);if(p([255,216,255]))return{ext:"jpg",mime:"image/jpeg"};if(p([137,80,78,71,13,10,26,10]))return{ext:"png",mime:"image/png"};if(p([71,73,70]))return{ext:"gif",mime:"image/gif"};if(p([87,69,66,80],{offset:8}))return{ext:"webp",mime:"image/webp"};if(p([70,76,73,70]))return{ext:"flif",mime:"image/flif"};if((p([73,73,42,0])||p([77,77,0,42]))&&p([67,82],{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(p([73,73,42,0])||p([77,77,0,42]))return{ext:"tif",mime:"image/tiff"};if(p([66,77]))return{ext:"bmp",mime:"image/bmp"};if(p([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(p([56,66,80,83]))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(p([80,75,3,4])){if(p([109,105,109,101,116,121,112,101,97,112,112,108,105,99,97,116,105,111,110,47,101,112,117,98,43,122,105,112],{offset:30}))return{ext:"epub",mime:"application/epub+zip"};if(p(xpiZipFilename,{offset:30}))return{ext:"xpi",mime:"application/x-xpinstall"};if(m("mimetypeapplication/vnd.oasis.opendocument.text",{offset:30}))return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};if(m("mimetypeapplication/vnd.oasis.opendocument.spreadsheet",{offset:30}))return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};if(m("mimetypeapplication/vnd.oasis.opendocument.presentation",{offset:30}))return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};const w=(B,D=0)=>B.findIndex((O,N,j)=>N>=D&&j[N]===80&&j[N+1]===75&&j[N+2]===3&&j[N+3]===4);let T=0,A=!1,y=null;do{const B=T+30;if(A||(A=p(oxmlContentTypes,{offset:B})||p(oxmlRels,{offset:B})),y||(m("word/",{offset:B})?y={ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}:m("ppt/",{offset:B})?y={ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}:m("xl/",{offset:B})&&(y={ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),A&&y)return y;T=w(l,B)}while(T>=0);if(y)return y}if(p([80,75])&&(l[2]===3||l[2]===5||l[2]===7)&&(l[3]===4||l[3]===6||l[3]===8))return{ext:"zip",mime:"application/zip"};if(p([117,115,116,97,114],{offset:257}))return{ext:"tar",mime:"application/x-tar"};if(p([82,97,114,33,26,7])&&(l[6]===0||l[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(p([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(p([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(p([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(p([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(p([51,103,112,53])||p([0,0,0])&&p([102,116,121,112],{offset:4})&&(p([109,112,52,49],{offset:8})||p([109,112,52,50],{offset:8})||p([105,115,111,109],{offset:8})||p([105,115,111,50],{offset:8})||p([109,109,112,52],{offset:8})||p([77,52,86],{offset:8})||p([100,97,115,104],{offset:8})))return{ext:"mp4",mime:"video/mp4"};if(p([77,84,104,100]))return{ext:"mid",mime:"audio/midi"};if(p([26,69,223,163])){const w=l.subarray(4,4+4096),T=w.findIndex((A,y,B)=>B[y]===66&&B[y+1]===130);if(T!==-1){const A=T+3,y=B=>[...B].every((D,O)=>w[A+O]===D.charCodeAt(0));if(y("matroska"))return{ext:"mkv",mime:"video/x-matroska"};if(y("webm"))return{ext:"webm",mime:"video/webm"}}}if(p([0,0,0,20,102,116,121,112,113,116,32,32])||p([102,114,101,101],{offset:4})||p([102,116,121,112,113,116,32,32],{offset:4})||p([109,100,97,116],{offset:4})||p([109,111,111,118],{offset:4})||p([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(p([82,73,70,70])){if(p([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(p([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/vnd.wave"};if(p([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(p([48,38,178,117,142,102,207,17,166,217])){let w=30;do{const T=readUInt64LE(l,w+16);if(p([145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101],{offset:w})){if(p([64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43],{offset:w+24}))return{ext:"wma",mime:"audio/x-ms-wma"};if(p([192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43],{offset:w+24}))return{ext:"wmv",mime:"video/x-ms-asf"};break}w+=T}while(w+24<=l.length);return{ext:"asf",mime:"application/vnd.ms-asf"}}if(p([0,0,1,186])||p([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(p([102,116,121,112,51,103],{offset:4}))return{ext:"3gp",mime:"video/3gpp"};for(let w=0;w<2&&w<l.length-16;w++){if(p([73,68,51],{offset:w})||p([255,226],{offset:w,mask:[255,226]}))return{ext:"mp3",mime:"audio/mpeg"};if(p([255,228],{offset:w,mask:[255,228]}))return{ext:"mp2",mime:"audio/mpeg"};if(p([255,248],{offset:w,mask:[255,252]}))return{ext:"mp2",mime:"audio/mpeg"};if(p([255,240],{offset:w,mask:[255,252]}))return{ext:"mp4",mime:"audio/mpeg"}}if(p([102,116,121,112,77,52,65],{offset:4}))return{ext:"m4a",mime:"audio/mp4"};if(p([79,112,117,115,72,101,97,100],{offset:28}))return{ext:"opus",mime:"audio/opus"};if(p([79,103,103,83]))return p([128,116,104,101,111,114,97],{offset:28})?{ext:"ogv",mime:"video/ogg"}:p([1,118,105,100,101,111,0],{offset:28})?{ext:"ogm",mime:"video/ogg"}:p([127,70,76,65,67],{offset:28})?{ext:"oga",mime:"audio/ogg"}:p([83,112,101,101,120,32,32],{offset:28})?{ext:"spx",mime:"audio/ogg"}:p([1,118,111,114,98,105,115],{offset:28})?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"};if(p([102,76,97,67]))return{ext:"flac",mime:"audio/x-flac"};if(p([77,65,67,32]))return{ext:"ape",mime:"audio/ape"};if(p([119,118,112,107]))return{ext:"wv",mime:"audio/wavpack"};if(p([35,33,65,77,82,10]))return{ext:"amr",mime:"audio/amr"};if(p([37,80,68,70]))return{ext:"pdf",mime:"application/pdf"};if(p([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if((l[0]===67||l[0]===70)&&p([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(p([123,92,114,116,102]))return{ext:"rtf",mime:"application/rtf"};if(p([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(p([119,79,70,70])&&(p([0,1,0,0],{offset:4})||p([79,84,84,79],{offset:4})))return{ext:"woff",mime:"font/woff"};if(p([119,79,70,50])&&(p([0,1,0,0],{offset:4})||p([79,84,84,79],{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(p([76,80],{offset:34})&&(p([0,0,1],{offset:8})||p([1,0,2],{offset:8})||p([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(p([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(p([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(p([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(p([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(p([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(p([37,33]))return{ext:"ps",mime:"application/postscript"};if(p([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(p([83,81,76,105]))return{ext:"sqlite",mime:"application/x-sqlite3"};if(p([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(p([67,114,50,52]))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(p([77,83,67,70])||p([73,83,99,40]))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(p([33,60,97,114,99,104,62,10,100,101,98,105,97,110,45,98,105,110,97,114,121]))return{ext:"deb",mime:"application/x-deb"};if(p([33,60,97,114,99,104,62]))return{ext:"ar",mime:"application/x-unix-archive"};if(p([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(p([31,160])||p([31,157]))return{ext:"Z",mime:"application/x-compress"};if(p([76,90,73,80]))return{ext:"lz",mime:"application/x-lzip"};if(p([208,207,17,224,161,177,26,225]))return{ext:"msi",mime:"application/x-msi"};if(p([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(p([71],{offset:4})&&(p([71],{offset:192})||p([71],{offset:196})))return{ext:"mts",mime:"video/mp2t"};if(p([66,76,69,78,68,69,82]))return{ext:"blend",mime:"application/x-blender"};if(p([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(p([0,0,0,12,106,80,32,32,13,10,135,10])){if(p([106,112,50,32],{offset:20}))return{ext:"jp2",mime:"image/jp2"};if(p([106,112,120,32],{offset:20}))return{ext:"jpx",mime:"image/jpx"};if(p([106,112,109,32],{offset:20}))return{ext:"jpm",mime:"image/jpm"};if(p([109,106,112,50],{offset:20}))return{ext:"mj2",mime:"image/mj2"}}if(p([70,79,82,77]))return{ext:"aif",mime:"audio/aiff"};if(m("<?xml "))return{ext:"xml",mime:"application/xml"};if(p([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(p([102,116,121,112],{offset:4})){if(p([109,105,102,49],{offset:8}))return{ext:"heic",mime:"image/heif"};if(p([109,115,102,49],{offset:8}))return{ext:"heic",mime:"image/heif-sequence"};if(p([104,101,105,99],{offset:8})||p([104,101,105,120],{offset:8}))return{ext:"heic",mime:"image/heic"};if(p([104,101,118,99],{offset:8})||p([104,101,118,120],{offset:8}))return{ext:"heic",mime:"image/heic-sequence"}}return p([171,75,84,88,32,49,49,187,13,10,26,10])?{ext:"ktx",mime:"image/ktx"}:p([68,73,67,77],{offset:128})?{ext:"dcm",mime:"application/dicom"}:p([77,80,43])?{ext:"mpc",mime:"audio/x-musepack"}:p([77,80,67,75])?{ext:"mpc",mime:"audio/x-musepack"}:p([66,69,71,73,78,58])?{ext:"ics",mime:"text/calendar"}:p([103,108,84,70,2,0,0,0])?{ext:"glb",mime:"model/gltf-binary"}:p([212,195,178,161])||p([161,178,195,212])?{ext:"pcap",mime:"application/vnd.tcpdump.pcap"}:null};module.exports=fileType,module.exports.default=fileType,Object.defineProperty(fileType,"minimumBytes",{value:4100}),module.exports.stream=readableStream=>new Promise((resolve,reject)=>{const stream=eval("require")("stream");readableStream.once("readable",()=>{const h=new stream.PassThrough,l=readableStream.read(module.exports.minimumBytes)||readableStream.read();try{h.fileType=fileType(l)}catch(p){reject(p)}readableStream.unshift(l),stream.pipeline?resolve(stream.pipeline(readableStream,h,()=>{})):resolve(readableStream.pipe(h))})})})(fileType$1);const fileType=fileType$1.exports,imageExts=new Set(["jpg","png","gif","webp","flif","cr2","tif","bmp","jxr","psd","ico","bpg","jp2","jpm","jpx","heic","cur","dcm"]),imageType=h=>{const l=fileType(h);return imageExts.has(l&&l.ext)?l:null};imageType$2.exports=imageType;imageType$2.exports.default=imageType;Object.defineProperty(imageType,"minimumBytes",{value:fileType.minimumBytes});var imageType$1=imageType$2.exports;(function(h){if(h.TextEncoder&&h.TextDecoder)return!1;function l(m="utf-8"){if(m!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${m}') is invalid.`)}Object.defineProperty(l.prototype,"encoding",{value:"utf-8"}),l.prototype.encode=function(m,w={stream:!1}){if(w.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let T=0;const A=m.length;let y=0,B=Math.max(32,A+(A>>1)+7),D=new Uint8Array(B>>3<<3);for(;T<A;){let O=m.charCodeAt(T++);if(O>=55296&&O<=56319){if(T<A){const N=m.charCodeAt(T);(N&64512)==56320&&(++T,O=((O&1023)<<10)+(N&1023)+65536)}if(O>=55296&&O<=56319)continue}if(y+4>D.length){B+=8,B*=1+T/m.length*2,B=B>>3<<3;const N=new Uint8Array(B);N.set(D),D=N}if((O&4294967168)==0){D[y++]=O;continue}else if((O&4294965248)==0)D[y++]=O>>6&31|192;else if((O&4294901760)==0)D[y++]=O>>12&15|224,D[y++]=O>>6&63|128;else if((O&4292870144)==0)D[y++]=O>>18&7|240,D[y++]=O>>12&63|128,D[y++]=O>>6&63|128;else continue;D[y++]=O&63|128}return D.slice(0,y)};function p(m="utf-8",w={fatal:!1}){if(m!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${m}') is invalid.`);if(w.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(p.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(p.prototype,"fatal",{value:!1}),Object.defineProperty(p.prototype,"ignoreBOM",{value:!1}),p.prototype.decode=function(m,w={stream:!1}){if(w.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const T=new Uint8Array(m);let A=0;const y=T.length,B=[];for(;A<y;){const D=T[A++];if(D===0)break;if((D&128)==0)B.push(D);else if((D&224)==192){const O=T[A++]&63;B.push((D&31)<<6|O)}else if((D&240)==224){const O=T[A++]&63,N=T[A++]&63;B.push((D&31)<<12|O<<6|N)}else if((D&248)==240){const O=T[A++]&63,N=T[A++]&63,j=T[A++]&63;let G=(D&7)<<18|O<<12|N<<6|j;G>65535&&(G-=65536,B.push(G>>>10&1023|55296),G=56320|G&1023),B.push(G)}}return String.fromCharCode.apply(null,B)},h.TextEncoder=l,h.TextDecoder=p})(typeof window!="undefined"?window:typeof self!="undefined"?self:globalThis);const decoder=new TextDecoder("utf-8");function decode(h){return decoder.decode(h)}const encoder=new TextEncoder;function encode(h){return encoder.encode(h)}const defaultByteLength=1024*8;class IOBuffer{constructor(l=defaultByteLength,p={}){let m=!1;typeof l=="number"?l=new ArrayBuffer(l):(m=!0,this.lastWrittenByte=l.byteLength);const w=p.offset?p.offset>>>0:0,T=l.byteLength-w;let A=w;(ArrayBuffer.isView(l)||l instanceof IOBuffer)&&(l.byteLength!==l.buffer.byteLength&&(A=l.byteOffset+w),l=l.buffer),m?this.lastWrittenByte=T:this.lastWrittenByte=0,this.buffer=l,this.length=T,this.byteLength=T,this.byteOffset=A,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,A,T),this._mark=0,this._marks=[]}available(l=1){return this.offset+l<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(l=1){return this.offset+=l,this}seek(l){return this.offset=l,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const l=this._marks.pop();if(l===void 0)throw new Error("Mark stack empty");return this.seek(l),this}rewind(){return this.offset=0,this}ensureAvailable(l=1){if(!this.available(l)){const m=(this.offset+l)*2,w=new Uint8Array(m);w.set(new Uint8Array(this.buffer)),this.buffer=w.buffer,this.length=this.byteLength=m,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(l=1){const p=new Uint8Array(l);for(let m=0;m<l;m++)p[m]=this.readByte();return p}readInt16(){const l=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,l}readUint16(){const l=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,l}readInt32(){const l=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,l}readUint32(){const l=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,l}readFloat32(){const l=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,l}readFloat64(){const l=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,l}readBigInt64(){const l=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,l}readBigUint64(){const l=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,l}readChar(){return String.fromCharCode(this.readInt8())}readChars(l=1){let p="";for(let m=0;m<l;m++)p+=this.readChar();return p}readUtf8(l=1){return decode(this.readBytes(l))}writeBoolean(l){return this.writeUint8(l?255:0),this}writeInt8(l){return this.ensureAvailable(1),this._data.setInt8(this.offset++,l),this._updateLastWrittenByte(),this}writeUint8(l){return this.ensureAvailable(1),this._data.setUint8(this.offset++,l),this._updateLastWrittenByte(),this}writeByte(l){return this.writeUint8(l)}writeBytes(l){this.ensureAvailable(l.length);for(let p=0;p<l.length;p++)this._data.setUint8(this.offset++,l[p]);return this._updateLastWrittenByte(),this}writeInt16(l){return this.ensureAvailable(2),this._data.setInt16(this.offset,l,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(l){return this.ensureAvailable(2),this._data.setUint16(this.offset,l,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(l){return this.ensureAvailable(4),this._data.setInt32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(l){return this.ensureAvailable(4),this._data.setUint32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(l){return this.ensureAvailable(4),this._data.setFloat32(this.offset,l,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(l){return this.ensureAvailable(8),this._data.setFloat64(this.offset,l,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(l){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,l,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(l){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,l,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(l){return this.writeUint8(l.charCodeAt(0))}writeChars(l){for(let p=0;p<l.length;p++)this.writeUint8(l.charCodeAt(p));return this}writeUtf8(l){return this.writeBytes(encode(l))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}function guessStripByteCounts(h){if(h.compression!==1)throw new Error("missing mandatory StripByteCounts field in compressed image");const l=h.rowsPerStrip*h.width*h.samplesPerPixel*(h.bitsPerSample/8);return new Array(h.stripOffsets.length).fill(l)}function applyHorizontalDifferencing8Bit(h,l,p){let m=0;for(;m<h.length;){for(let w=p;w<l*p;w+=p)for(let T=0;T<p;T++)h[m+w+T]=h[m+w+T]+h[m+w-(p-T)]&255;m+=l*p}}function applyHorizontalDifferencing16Bit(h,l,p){let m=0;for(;m<h.length;){for(let w=p;w<l*p;w+=p)for(let T=0;T<p;T++)h[m+w+T]=h[m+w+T]+h[m+w-(p-T)]&65535;m+=l*p}}const tagsById$2={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$2={};for(let h in tagsById$2)tagsByName$2[tagsById$2[h]]=Number(h);var exif=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",tagsById:tagsById$2,tagsByName:tagsByName$2});const tagsById$1={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$1={};for(let h in tagsById$1)tagsByName$1[tagsById$1[h]]=Number(h);var gps=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",tagsById:tagsById$1,tagsByName:tagsByName$1});const tagsById={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName={};for(let h in tagsById)tagsByName[tagsById[h]]=Number(h);var standard=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",tagsById,tagsByName});const tags={standard,exif,gps};class IFD{constructor(l){if(!l)throw new Error("missing kind");this.data=new Uint8Array,this.fields=new Map,this.kind=l,this._hasMap=!1,this._map={}}get(l){if(typeof l=="number")return this.fields.get(l);if(typeof l=="string")return this.fields.get(tags[this.kind].tagsByName[l]);throw new Error("expected a number or string")}get map(){if(!this._hasMap){const l=tags[this.kind].tagsById;for(let p of this.fields.keys())l[p]&&(this._map[l[p]]=this.fields.get(p));this._hasMap=!0}return this._map}}let types=new Map([[1,[1,readByte]],[2,[1,readASCII]],[3,[2,readShort]],[4,[4,readLong]],[5,[8,readRational]],[6,[1,readSByte]],[7,[1,readByte]],[8,[2,readSShort]],[9,[4,readSLong]],[10,[8,readSRational]],[11,[4,readFloat]],[12,[8,readDouble]]]);function getByteLength(h,l){const p=types.get(h);if(!p)throw new Error(`type not found: ${h}`);return p[0]*l}function readData(h,l,p){const m=types.get(l);if(!m)throw new Error(`type not found: ${l}`);return m[1](h,p)}function readByte(h,l){if(l===1)return h.readUint8();let p=new Uint8Array(l);for(let m=0;m<l;m++)p[m]=h.readUint8();return p}function readASCII(h,l){let p=[],m="";for(let w=0;w<l;w++){let T=String.fromCharCode(h.readUint8());T==="\0"?(p.push(m),m=""):m+=T}return p.length===1?p[0]:p}function readShort(h,l){if(l===1)return h.readUint16();let p=new Uint16Array(l);for(let m=0;m<l;m++)p[m]=h.readUint16();return p}function readLong(h,l){if(l===1)return h.readUint32();let p=new Uint32Array(l);for(let m=0;m<l;m++)p[m]=h.readUint32();return p}function readRational(h,l){if(l===1)return h.readUint32()/h.readUint32();let p=new Array(l);for(let m=0;m<l;m++)p[m]=h.readUint32()/h.readUint32();return p}function readSByte(h,l){if(l===1)return h.readInt8();let p=new Int8Array(l);for(let m=0;m<l;m++)p[m]=h.readInt8();return p}function readSShort(h,l){if(l===1)return h.readInt16();let p=new Int16Array(l);for(let m=0;m<l;m++)p[m]=h.readInt16();return p}function readSLong(h,l){if(l===1)return h.readInt32();let p=new Int32Array(l);for(let m=0;m<l;m++)p[m]=h.readInt32();return p}function readSRational(h,l){if(l===1)return h.readInt32()/h.readInt32();let p=new Array(l);for(let m=0;m<l;m++)p[m]=h.readInt32()/h.readInt32();return p}function readFloat(h,l){if(l===1)return h.readFloat32();let p=new Float32Array(l);for(let m=0;m<l;m++)p[m]=h.readFloat32();return p}function readDouble(h,l){if(l===1)return h.readFloat64();let p=new Float64Array(l);for(let m=0;m<l;m++)p[m]=h.readFloat64();return p}const CLEAR_CODE=256,EOI_CODE=257,TABLE_START=258,MIN_BIT_LENGTH=9;let stringTable=[];function initializeStringTable(){if(stringTable.length===0){for(let l=0;l<256;l++)stringTable.push([l]);const h=[];for(let l=256;l<4096;l++)stringTable.push(h)}}const andTable=[511,1023,2047,4095],bitJumps=[0,0,0,0,0,0,0,0,0,511,1023,2047,4095];class LzwDecoder{constructor(l){this.nextData=0,this.nextBits=0,this.bytePointer=0,this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH,this.stripArray=new Uint8Array(l.buffer,l.byteOffset,l.byteLength),this.outData=new IOBuffer(l.byteLength),this.initializeTable()}decode(){let l=0,p=0;for(;(l=this.getNextCode())!==EOI_CODE;)if(l===CLEAR_CODE){if(this.initializeTable(),l=this.getNextCode(),l===EOI_CODE)break;this.writeString(this.stringFromCode(l)),p=l}else if(this.isInTable(l))this.writeString(this.stringFromCode(l)),this.addStringToTable(this.stringFromCode(p).concat(this.stringFromCode(l)[0])),p=l;else{const w=this.stringFromCode(p).concat(this.stringFromCode(p)[0]);this.writeString(w),this.addStringToTable(w),p=l}const m=this.outData.toArray();return new DataView(m.buffer,m.byteOffset,m.byteLength)}initializeTable(){initializeStringTable(),this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH}writeString(l){this.outData.writeBytes(l)}stringFromCode(l){return stringTable[l]}isInTable(l){return l<this.tableLength}addStringToTable(l){if(stringTable[this.tableLength++]=l,stringTable.length>4096)throw stringTable=[],new Error("LZW decoding error. Please open an issue at https://github.com/image-js/tiff/issues/new/choose (include a test image).");this.tableLength===bitJumps[this.currentBitLength]&&this.currentBitLength++}getNextCode(){this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8,this.nextBits<this.currentBitLength&&(this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8);const l=this.nextData>>this.nextBits-this.currentBitLength&andTable[this.currentBitLength-9];return this.nextBits-=this.currentBitLength,this.bytePointer>this.stripArray.length?257:l}}function decompressLzw(h){return new LzwDecoder(h).decode()}const dateTimeRegex=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd extends IFD{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){let l=new Date,p=dateTimeRegex.exec(this.dateTime);if(p===null)throw new Error(`invalid dateTime: ${this.dateTime}`);return l.setFullYear(Number(p[1]),Number(p[2])-1,Number(p[3])),l.setHours(Number(p[4]),Number(p[5]),Number(p[6])),l}get newSubfileType(){return this.get("NewSubfileType")}get imageWidth(){return this.get("ImageWidth")}get imageLength(){return this.get("ImageLength")}get bitsPerSample(){const l=this.get("BitsPerSample");return l&&typeof l!="number"?l[0]:l}get alpha(){const l=this.extraSamples;return l?l[0]!==0:!1}get associatedAlpha(){const l=this.extraSamples;return l?l[0]===1:!1}get extraSamples(){return alwaysArray(this.get("ExtraSamples"))}get compression(){return this.get("Compression")||1}get type(){return this.get("PhotometricInterpretation")}get fillOrder(){return this.get("FillOrder")||1}get documentName(){return this.get("DocumentName")}get imageDescription(){return this.get("ImageDescription")}get stripOffsets(){return alwaysArray(this.get("StripOffsets"))}get orientation(){return this.get("Orientation")}get samplesPerPixel(){return this.get("SamplesPerPixel")||1}get rowsPerStrip(){return this.get("RowsPerStrip")}get stripByteCounts(){return alwaysArray(this.get("StripByteCounts"))}get minSampleValue(){return this.get("MinSampleValue")||0}get maxSampleValue(){return this.get("MaxSampleValue")||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get("XResolution")}get yResolution(){return this.get("YResolution")}get planarConfiguration(){return this.get("PlanarConfiguration")||1}get resolutionUnit(){return this.get("ResolutionUnit")||2}get dateTime(){return this.get("DateTime")}get predictor(){return this.get("Predictor")||1}get sampleFormat(){return this.get("SampleFormat")||1}get sMinSampleValue(){return this.get("SMinSampleValue")||this.minSampleValue}get sMaxSampleValue(){return this.get("SMaxSampleValue")||this.maxSampleValue}get palette(){const l=2**this.bitsPerSample,p=this.get("ColorMap");if(!p)return;if(p.length!==3*l)throw new Error(`ColorMap size must be ${l}`);const m=[];for(let w=0;w<l;w++)m.push([p[w],p[w+l],p[w+2*l]]);return m}}function alwaysArray(h){return typeof h=="number"?[h]:h}function decompressZlib(h){const l=new Uint8Array(h.buffer,h.byteOffset,h.byteLength),p=inflate_1(l);return new DataView(p.buffer,p.byteOffset,p.byteLength)}const defaultOptions$c={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder extends IOBuffer{constructor(l){super(l);this._nextIFD=0}get isMultiPage(){let l=0;for(this.decodeHeader();this._nextIFD;)if(l++,this.decodeIFD({ignoreImageData:!0},!0),l===2)return!0;if(l===1)return!1;throw unsupported("ifdCount",l)}get pageCount(){let l=0;for(this.decodeHeader();this._nextIFD;)l++,this.decodeIFD({ignoreImageData:!0},!0);if(l>0)return l;throw unsupported("ifdCount",l)}decode(l={}){l=Object.assign({},defaultOptions$c,l);const p=[];for(this.decodeHeader();this._nextIFD;)if(p.push(this.decodeIFD(l,!0)),l.onlyFirst)return[p[0]];return p}decodeHeader(){const l=this.readUint16();if(l===18761)this.setLittleEndian();else if(l===19789)this.setBigEndian();else throw new Error(`invalid byte order: 0x${l.toString(16)}`);if(this.readUint16()!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(l,p){this.seek(this._nextIFD);let m;if(p)m=new TiffIfd;else{if(!l.kind)throw new Error("kind is missing");m=new IFD(l.kind)}const w=this.readUint16();for(let T=0;T<w;T++)this.decodeIFDEntry(m);if(!l.ignoreImageData){if(!(m instanceof TiffIfd))throw new Error("must be a tiff ifd");this.decodeImageData(m)}return this._nextIFD=this.readUint32(),m}decodeIFDEntry(l){const p=this.offset,m=this.readUint16(),w=this.readUint16(),T=this.readUint32();if(w<1||w>12){this.skip(4);return}getByteLength(w,T)>4&&this.seek(this.readUint32());const y=readData(this,w,T);if(l.fields.set(m,y),m===34665||m===34853){let B=this.offset,D="exif";m===34665?D="exif":m===34853&&(D="gps"),this._nextIFD=y,l[D]=this.decodeIFD({kind:D,ignoreImageData:!0},!1),this.offset=B}this.seek(p),this.skip(12)}decodeImageData(l){const p=l.orientation;if(p&&p!==1)throw unsupported("orientation",p);switch(l.type){case 0:case 1:case 2:case 3:this.readStripData(l);break;default:throw unsupported("image type",l.type)}if(this.applyPredictor(l),this.convertAlpha(l),l.type===0){const m=l.bitsPerSample,w=Math.pow(2,m)-1;for(let T=0;T<l.data.length;T++)l.data[T]=w-l.data[T]}}readStripData(l){const p=l.width,m=l.height,w=l.bitsPerSample,T=l.sampleFormat,A=p*m*l.samplesPerPixel,y=getDataArray(A,w,T),D=l.rowsPerStrip*p*l.samplesPerPixel,O=l.stripOffsets,N=l.stripByteCounts||guessStripByteCounts(l);let j=A,G=0;for(let H=0;H<O.length;H++){let te=new DataView(this.buffer,this.byteOffset+O[H],N[H]),oe=j>D?D:j;j-=oe;let Q=te;switch(l.compression){case 1:break;case 5:{Q=decompressLzw(te);break}case 8:{Q=decompressZlib(te);break}case 2:throw unsupported("Compression","CCITT Group 3");case 32773:throw unsupported("Compression","PackBits");default:throw unsupported("Compression",l.compression)}G=this.fillUncompressed(w,T,y,Q,G,oe)}l.data=y}fillUncompressed(l,p,m,w,T,A){if(l===8)return fill8bit(m,w,T,A);if(l===16)return fill16bit(m,w,T,A,this.isLittleEndian());if(l===32&&p===3)return fillFloat32(m,w,T,A,this.isLittleEndian());throw unsupported("bitDepth",l)}applyPredictor(l){const p=l.bitsPerSample;switch(l.predictor){case 1:break;case 2:{if(p===8)applyHorizontalDifferencing8Bit(l.data,l.width,l.components);else if(p===16)applyHorizontalDifferencing16Bit(l.data,l.width,l.components);else throw new Error(`Horizontal differencing is only supported for images with a bit depth of ${p}`);break}default:throw new Error(`invalid predictor: ${l.predictor}`)}}convertAlpha(l){if(l.alpha&&l.associatedAlpha){const{data:p,components:m,maxSampleValue:w}=l;for(let T=0;T<p.length;T+=m){const A=p[T+m-1];for(let y=0;y<m-1;y++)p[T+y]=Math.round(p[T+y]*w/A)}}}}function getDataArray(h,l,p){if(l===8)return new Uint8Array(h);if(l===16)return new Uint16Array(h);if(l===32&&p===3)return new Float32Array(h);throw unsupported("bit depth / sample format",`${l} / ${p}`)}function fill8bit(h,l,p,m){for(let w=0;w<m;w++)h[p++]=l.getUint8(w);return p}function fill16bit(h,l,p,m,w){for(let T=0;T<m*2;T+=2)h[p++]=l.getUint16(T,w);return p}function fillFloat32(h,l,p,m,w){for(let T=0;T<m*4;T+=4)h[p++]=l.getFloat32(T,w);return p}function unsupported(h,l){return new Error(`Unsupported ${h}: ${l}`)}function decodeTIFF(h,l){return new TIFFDecoder(h).decode(l)}function matchAndCrop(h={}){let{algorithm:l="matchToPrevious",ignoreBorder:p=[0,0]}=h;this.checkProcessable("matchAndCrop",{bitDepth:[8,16]});let m=l==="matchToPrevious",w=this[0],T=[];T[0]={position:[0,0],image:this[0]};let A=[0,0];for(let j=1;j<this.length;j++){let G=w.getBestMatch(this[j],{border:p});T[j]={position:[G[0]+A[0],G[1]+A[1]],image:this[j]},m&&(A[0]+=G[0],A[1]+=G[1],w=this[j])}let y=0,B=0,D=0,O=0;for(let j=0;j<T.length;j++){let G=T[j];G.position[0]>y&&(y=G.position[0]),G.position[0]<B&&(B=G.position[0]),G.position[1]>D&&(D=G.position[1]),G.position[1]<O&&(O=G.position[1])}B=0-B,O=0-O;for(let j=0;j<T.length;j++){let G=T[j];G.crop=G.image.crop({x:y-G.position[0],y:D-G.position[1],width:w.width-B-y,height:w.height-O-D})}let N=[];for(let j=0;j<T.length;j++)N[j]=T[j].crop;return new Stack(N)}function min$2(){this.checkProcessable("min",{bitDepth:[8,16]});let h=this[0].min;for(let l=1;l<this.length;l++)for(let p=0;p<h.length;p++)h[p]=Math.min(h[p],this[l].min[p]);return h}function max$2(){this.checkProcessable("min",{bitDepth:[8,16]});let h=this[0].max;for(let l=1;l<this.length;l++)for(let p=0;p<h.length;p++)h[p]=Math.max(h[p],this[l].max[p]);return h}function median$2(h){let l=h.reduce((A,y)=>A+y);if(l===0)throw new Error("unreachable");let p=0,m=0,w=l/2,T;for(;;){if(h[p]>0){if(T!==void 0)return(T+p)/2;if(m+=h[p],m>w)return p;m===w&&(T=p)}p++}}function mean$2(h){let l=0,p=0;for(let m=0;m<h.length;m++)l+=h[m],p+=h[m]*m;return l===0?0:p/l}function median$1(){this.checkProcessable("median",{bitDepth:[8,16]});let h=this.getHistograms({maxSlots:this[0].maxValue+1}),l=new Array(h.length);for(let p=0;p<h.length;p++){let m=h[p];l[p]=median$2(m)}return l}function histogram(h){this.checkProcessable("min",{bitDepth:[8,16]});let l=this[0].getHistogram(h);for(let p=1;p<this.length;p++){let m=this[p].getHistogram(h);for(let w=0;w<l.length;w++)l[w]+=m[w]}return l}function histograms(h){this.checkProcessable("min",{bitDepth:[8,16]});let l=this[0].getHistograms(h),p=l[0].length;for(let m=1;m<this.length;m++){let w=this[m].getHistograms(h);for(let T=0;T<l.length;T++)for(let A=0;A<p;A++)l[T][A]+=w[T][A]}return l}function averageImage(){this.checkProcessable("averageImage",{bitDepth:[8,16]});let h=new Uint32Array(this[0].data.length);for(let m=0;m<this.length;m++){let w=this[m];for(let T=0;T<this[0].data.length;T++)h[T]+=w.data[T]}let l=Image$1.createFrom(this[0]),p=l.data;for(let m=0;m<this[0].data.length;m++)p[m]=h[m]/this.length;return l}function maxImage(){this.checkProcessable("max",{bitDepth:[8,16]});let h=Image$1.createFrom(this[0]);h.data.fill(0);for(const l of this)for(let p=0;p<h.data.length;p++)h.data[p]=Math.max(l.data[p],h.data[p]);return h}function minImage(){this.checkProcessable("max",{bitDepth:[8,16]});let h=Image$1.createFrom(this[0]);h.data.fill(h.maxValue);for(const l of this)for(let p=0;p<h.data.length;p++)h.data[p]=Math.min(l.data[p],h.data[p]);return h}function extend$5(h){h.extendMethod("matchAndCrop",matchAndCrop),h.extendMethod("getMin",min$2),h.extendMethod("getMax",max$2),h.extendMethod("getMedian",median$1),h.extendMethod("getHistogram",histogram),h.extendMethod("getHistograms",histograms),h.extendMethod("getAverage",averageImage),h.extendMethod("getAverageImage",averageImage),h.extendMethod("getMaxImage",maxImage),h.extendMethod("getMinImage",minImage)}let computedPropertyDescriptor={configurable:!0,enumerable:!1,get:void 0};class Stack extends Array{constructor(l){if(Array.isArray(l)){super(l.length);for(let p=0;p<l.length;p++)this[p]=l[p]}else typeof l=="number"?super(l):super();this.computed=null}static load(l){return Promise.all(l.map(Image$1.load)).then(p=>new Stack(p))}static extendMethod(l,p,m={}){let{inPlace:w=!1,returnThis:T=!0,partialArgs:A=[]}=m;return w?Stack.prototype[l]=function(...y){this.computed=null;let B=p.apply(this,[...A,...y]);return T?this:B}:Stack.prototype[l]=function(...y){return p.apply(this,[...A,...y])},Stack}static extendProperty(l,p,m={}){let{partialArgs:w=[]}=m;return computedPropertyDescriptor.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(l,this.computed))return this.computed[l];let T=p.apply(this,w);return this.computed[l]=T,T},Object.defineProperty(Stack.prototype,l,computedPropertyDescriptor),Stack}checkProcessable(l,p={}){if(typeof l!="string")throw new TypeError("checkProcessable requires as first parameter the processName (a string)");if(this.size===0)throw new TypeError(`The process: ${l} can not be applied on an empty stack`);this[0].checkProcessable(l,p);for(let m=1;m<this.length;m++){if((p.sameSize===void 0||p.sameSize)&&this[0].width!==this[m].width)throw new TypeError(`The process: ${l} can not be applied if width is not identical in all images`);if((p.sameSize===void 0||p.sameSize)&&this[0].height!==this[m].height)throw new TypeError(`The process: ${l} can not be applied if height is not identical in all images`);if((p.sameAlpha===void 0||p.sameAlpha)&&this[0].alpha!==this[m].alpha)throw new TypeError(`The process: ${l} can not be applied if alpha is not identical in all images`);if((p.sameBitDepth===void 0||p.sameBitDepth)&&this[0].bitDepth!==this[m].bitDepth)throw new TypeError(`The process: ${l} can not be applied if bitDepth is not identical in all images`);if((p.sameColorModel===void 0||p.sameColorModel)&&this[0].colorModel!==this[m].colorModel)throw new TypeError(`The process: ${l} can not be applied if colorModel is not identical in all images`);if((p.sameNumberChannels===void 0||p.sameNumberChannels)&&this[0].channels!==this[m].channels)throw new TypeError(`The process: ${l} can not be applied if channels is not identical in all images`)}}}Array[Symbol.species]||(Stack.prototype.map=function(h,l){if(typeof h!="function")throw new TypeError(`${h} is not a function`);let p=new Stack(this.length);for(let m=0;m<this.length;m++)p[m]=h.call(l,this[m],m,this);return p});extend$5(Stack);const isDataURL=/^data:[a-z]+\/(?:[a-z]+);base64,/;function load(h,l){if(typeof h=="string")return loadURL(h,l);if(h instanceof ArrayBuffer)return Promise.resolve(loadBinary(new Uint8Array(h)));if(h.buffer)return Promise.resolve(loadBinary(h));throw new Error('argument to "load" must be a string or buffer.')}function loadBinary(h,l){const p=imageType$1(h);if(p)switch(p.mime){case"image/png":return loadPNG(h);case"image/jpeg":return loadJPEG(h);case"image/tiff":return loadTIFF(h);default:return loadGeneric(m(p.mime))}return loadGeneric(m("application/octet-stream"));function m(w){return l||toBase64URL(h,w)}}function loadURL(h,l){const p=h.slice(0,64).match(isDataURL);let m;return p!==null?m=Promise.resolve(decode$4(h.slice(p[0].length))):m=fetchBinary(h,l),m.then(w=>{const T=new Uint8Array(w);return loadBinary(T,p?h:void 0)})}function loadPNG(h){const l=decodePng(h);let p=l.channels,m,w=0;return p===2||p===4?(m=p-1,w=1):m=p,l.palette?loadPNGFromPalette(l):new Image$1(l.width,l.height,l.data,{components:m,alpha:w,bitDepth:l.depth})}function loadPNGFromPalette(h){const l=h.width*h.height,p=h.palette[0].length,m=new Uint8Array(l*p),w=8/h.depth,T=h.depth<8?w:1,A=parseInt("1".repeat(h.depth),2),y=p===4;let B=0;for(let D=0;D<l;D++){const O=Math.floor(D/T);let N=h.data[O];h.depth<8&&(N=N>>>h.depth*(w-1-D%w)&A);const j=h.palette[N];m[B++]=j[0],m[B++]=j[1],m[B++]=j[2],y&&(m[B++]=j[3])}return new Image$1(h.width,h.height,m,{components:3,alpha:y,bitDepth:8})}function loadJPEG(h){const l=decode$1(h);let p;l.exif&&(p=getMetadata(l.exif));const m=jpegJs.decode(h,{useTArray:!0,maxMemoryUsageInMB:1024});let w=new Image$1(m.width,m.height,m.data,{meta:p});if(p&&p.tiff.tags.Orientation){const T=p.tiff.tags.Orientation;T>2&&(w=w.rotate({3:180,4:180,5:90,6:90,7:270,8:270}[T])),[2,4,5,7].includes(T)&&(w=w.flipX())}return w}function loadTIFF(h){let l=decodeTIFF(h);return l.length===1?getImageFromIFD(l[0]):new Stack(l.map(getImageFromIFD))}function getMetadata(h){const l={tiff:{fields:h.fields,tags:h.map}};return h.exif&&(l.exif=h.exif),h.gps&&(l.gps=h.gps),l}function getImageFromIFD(h){if(h.type===3){const l=new Uint16Array(3*h.width*h.height),p=h.palette;let m=0;for(let w=0;w<h.data.length;w++){const T=h.data[w],A=p[T];l[m++]=A[0],l[m++]=A[1],l[m++]=A[2]}return new Image$1(h.width,h.height,l,{components:3,alpha:h.alpha,colorModel:RGB$1,bitDepth:16,meta:getMetadata(h)})}else return new Image$1(h.width,h.height,h.data,{components:h.type===2?3:1,alpha:h.alpha,colorModel:h.type===2?RGB$1:GREY$1,bitDepth:h.bitsPerSample.length?h.bitsPerSample[0]:h.bitsPerSample,meta:getMetadata(h)})}function loadGeneric(h,l){return l=l||{},new Promise(function(p,m){let w=new DOMImage;w.onload=function(){let T=w.width,A=w.height,B=createCanvas(T,A).getContext("2d");B.drawImage(w,0,0,T,A);let D=B.getImageData(0,0,T,A).data;p(new Image$1(T,A,D,l))},w.onerror=function(){m(new Error(`Could not load ${h}`))},w.src=h})}const valueMethods={getValueXY(h,l,p){return this.data[(l*this.width+h)*this.channels+p]},setValueXY(h,l,p,m){return this.data[(l*this.width+h)*this.channels+p]=m,this.computed=null,this},getValue(h,l){return this.data[h*this.channels+l]},setValue(h,l,p){return this.data[h*this.channels+l]=p,this.computed=null,this},getPixelXY(h,l){return this.getPixel(l*this.width+h)},setPixelXY(h,l,p){return this.setPixel(l*this.width+h,p)},getPixel(h){const l=new Array(this.channels),p=h*this.channels;for(let m=0;m<this.channels;m++)l[m]=this.data[p+m];return l},setPixel(h,l){const p=h*this.channels;for(let m=0;m<l.length;m++)this.data[p+m]=l[m];return this.computed=null,this}};function setValueMethods(h){for(const l in valueMethods)h.prototype[l]=valueMethods[l]}function getImageParameters(h){return{width:h.width,height:h.height,components:h.components,alpha:h.alpha,colorModel:h.colorModel,bitDepth:h.bitDepth}}function getOutputImage(h,l,p,m={}){const{out:w}=l;if(w===void 0)return m.copy?h.clone():Image$1.createFrom(h,p);{if(!Image$1.isImage(w))throw new TypeError("out must be an Image object");const T=Object.assign(getImageParameters(h),p);for(const A in T)if(w[A]!==T[A])throw new RangeError(`cannot use out. Its ${A} must be "${T[A]}" (found "${w[A]}")`);return w}}function getOutputImageOrInPlace(h,l,p){if(l.inPlace!==void 0&&typeof l.inPlace!="boolean")throw new TypeError("inPlace option must be a boolean");if(l.inPlace){if(l.out!==void 0)throw new TypeError("out option must not be set if inPlace option is true");return h}return getOutputImage(h,l,null,p)}function abs(h={}){this.checkProcessable("abs",{bitDepth:[32]});const l=getOutputImageOrInPlace(this,h);return absolute(this,l),l}function absolute(h,l){for(let p=0;p<h.data.length;p++)l.data[p]=Math.abs(h.data[p])}function copyAlphaChannel(h,l){if(h.alpha===1&&l.alpha===1)for(let p=0;p<h.size;p++)l.data[p*l.channels+l.components]=h.data[p*h.channels+h.components]}function invert(h={}){this.checkProcessable("invert",{bitDepth:[1,8,16]});const l=getOutputImageOrInPlace(this,h);return this.bitDepth===1?invertBinary(this,l):(invertColor(this,l),this!==l&&copyAlphaChannel(this,l)),l}function invertBinary(h,l){for(let p=0;p<h.data.length;p++)l.data[p]=~h.data[p]}function invertColor(h,l){for(let p=0;p<h.data.length;p+=h.channels)for(let m=0;m<h.components;m++)l.data[p+m]=h.maxValue-h.data[p+m]}function flipX(){this.checkProcessable("flipX",{bitDepth:[8,16]});for(let h=0;h<this.height;h++){let l=h*this.width*this.channels;for(let p=0;p<Math.floor(this.width/2);p++){let m=p*this.channels+l,w=(this.width-p-1)*this.channels+l;for(let T=0;T<this.channels;T++){let A=this.data[m+T];this.data[m+T]=this.data[w+T],this.data[w+T]=A}}}return this}function flipY(){this.checkProcessable("flipY",{bitDepth:[8,16]});for(let h=0;h<Math.floor(this.height/2);h++)for(let l=0;l<this.width;l++){let p=l*this.channels+h*this.width*this.channels,m=l*this.channels+(this.height-1-h)*this.channels*this.width;for(let w=0;w<this.channels;w++){let T=this.data[p+w];this.data[p+w]=this.data[m+w],this.data[m+w]=T}}return this}function blurFilter(h={}){const{radius:l=1}=h;if(l<1)throw new Error("radius must be greater than 1");const p=2*l+1,m=new Array(p);for(let w=0;w<p;w++){m[w]=new Array(p);for(let T=0;T<p;T++)m[w][T]=1/(p*p)}return this.convolution(m)}var medianQuickselect_min={exports:{}};(function(h){(function(){function l(w){for(var T=0,A=w.length-1,y=void 0,B=void 0,D=void 0,O=m(T,A);;){if(A<=T)return w[O];if(A==T+1)return w[T]>w[A]&&p(w,T,A),w[O];for(y=m(T,A),w[y]>w[A]&&p(w,y,A),w[T]>w[A]&&p(w,T,A),w[y]>w[T]&&p(w,y,T),p(w,y,T+1),B=T+1,D=A;;){do B++;while(w[T]>w[B]);do D--;while(w[D]>w[T]);if(D<B)break;p(w,B,D)}p(w,T,D),D<=O&&(T=B),D>=O&&(A=D-1)}}var p=function(T,A,y){var B;return B=[T[y],T[A]],T[A]=B[0],T[y]=B[1],B},m=function(T,A){return~~((T+A)/2)};h.exports?h.exports=l:window.median=l})()})(medianQuickselect_min);var quickSelectMedian=medianQuickselect_min.exports;function validateArrayOfChannels(h,l={}){let{channels:p,allowAlpha:m,defaultAlpha:w}=l;return typeof m!="boolean"&&(m=!0),typeof p=="undefined"?allChannels(h,w):validateChannels(h,p,m)}function allChannels(h,l){let p=l?h.channels:h.components,m=new Array(p);for(let w=0;w<p;w++)m[w]=w;return m}function validateChannels(h,l,p){Array.isArray(l)||(l=[l]);for(let m=0;m<l.length;m++)l[m]=validateChannel(h,l[m],p);return l}function validateChannel(h,l,p=!0){if(l===void 0)throw new RangeError(`validateChannel : the channel has to be >=0 and <${h.channels}`);if(typeof l=="string"){switch(h.colorModel){case GREY$1:break;case RGB$1:if("rgb".includes(l))switch(l){case"r":l=0;break;case"g":l=1;break;case"b":l=2;break}break;case HSL:if("hsl".includes(l))switch(l){case"h":l=0;break;case"s":l=1;break;case"l":l=2;break}break;case HSV:if("hsv".includes(l))switch(l){case"h":l=0;break;case"s":l=1;break;case"v":l=2;break}break;case CMYK$1:if("cmyk".includes(l))switch(l){case"c":l=0;break;case"m":l=1;break;case"y":l=2;break;case"k":l=3;break}break;default:throw new Error(`Unexpected color model: ${h.colorModel}`)}if(l==="a"){if(!h.alpha)throw new Error("validateChannel : the image does not contain alpha channel");l=h.components}if(typeof l=="string")throw new Error(`validateChannel : undefined channel: ${l}`)}if(l>=h.channels)throw new RangeError(`validateChannel : the channel has to be >=0 and <${h.channels}`);if(!p&&l>=h.components)throw new RangeError("validateChannel : alpha channel may not be selected");return l}function medianFilter(h={}){let{radius:l=1,border:p="copy",channels:m}=h;if(this.checkProcessable("medianFilter",{bitDepth:[8,16]}),l<1)throw new Error("radius must be greater than 0");m=validateArrayOfChannels(this,m);let w=l,T=l,A=Image$1.createFrom(this),y=(w*2+1)*(T*2+1),B=new Array(y);for(let D=0;D<m.length;D++){let O=m[D];for(let N=T;N<this.height-T;N++)for(let j=w;j<this.width-w;j++){let G=0;for(let te=-T;te<=T;te++)for(let oe=-w;oe<=w;oe++){let Q=((N+te)*this.width+j+oe)*this.channels+O;B[G++]=this.data[Q]}let H=(N*this.width+j)*this.channels+O;A.data[H]=quickSelectMedian(B)}}if(this.alpha&&!m.includes(this.channels))for(let D=this.components;D<this.data.length;D=D+this.channels)A.data[D]=this.data[D];return A.setBorder({size:[w,T],algorithm:p}),A}function gaussianFilter(h={}){let{radius:l=1,sigma:p,channels:m,border:w="copy"}=h;this.checkProcessable("gaussian",{bitDepth:[8,16]});const T=getKernel(l,p);return this.convolution([T,T],{border:w,channels:m,algorithm:"separable"})}function getKernel(h,l){const p=h*2+1,m=new Array(p),w=l||((p-1)*.5-1)*.3+.8,T=-.5/(w*w);let A=0;for(let y=0;y<p;y++){const B=y-h,D=Math.exp(T*B*B);m[y]=D,A+=D}for(let y=0;y<p;y++)m[y]/=A;return m}const SOBEL_X=[[-1,0,1],[-2,0,2],[-1,0,1]],SOBEL_Y=[[-1,-2,-1],[0,0,0],[1,2,1]],SCHARR_X=[[3,0,-3],[10,0,-10],[3,0,-3]],SCHARR_Y=[[3,10,3],[0,0,0],[-3,-10,-3]];var src$3={},fftlib={};(function(h){(function(){var l;l=h;var p={release:"0.3.0",date:"2013-03"};l.toString=function(){return"version "+p.release+", released "+p.date};for(var m=0,w=null,T=null,A={init:function(D){if(D!==0&&(D&D-1)==0)m=D,A._initArray(),A._makeBitReversalTable(),A._makeCosSinTable();else throw new Error("init: radix-2 required")},fft1d:function(D,O){A.fft(D,O,1)},ifft1d:function(D,O){var N=1/m;A.fft(D,O,-1);for(var j=0;j<m;j++)D[j]*=N,O[j]*=N},bt1d:function(D,O){A.fft(D,O,-1)},fft2d:function(D,O){for(var N=[],j=[],G=0,H=0;H<m;H++){G=H*m;for(var te=0;te<m;te++)N[te]=D[te+G],j[te]=O[te+G];A.fft1d(N,j);for(var oe=0;oe<m;oe++)D[oe+G]=N[oe],O[oe+G]=j[oe]}for(var Q=0;Q<m;Q++){for(var _e=0;_e<m;_e++)G=Q+_e*m,N[_e]=D[G],j[_e]=O[G];A.fft1d(N,j);for(var se=0;se<m;se++)G=Q+se*m,D[G]=N[se],O[G]=j[se]}},ifft2d:function(D,O){for(var N=[],j=[],G=0,H=0;H<m;H++){G=H*m;for(var te=0;te<m;te++)N[te]=D[te+G],j[te]=O[te+G];A.ifft1d(N,j);for(var oe=0;oe<m;oe++)D[oe+G]=N[oe],O[oe+G]=j[oe]}for(var Q=0;Q<m;Q++){for(var _e=0;_e<m;_e++)G=Q+_e*m,N[_e]=D[G],j[_e]=O[G];A.ifft1d(N,j);for(var se=0;se<m;se++)G=Q+se*m,D[G]=N[se],O[G]=j[se]}},fft:function(D,O,N){for(var j,G,H,te,oe,Q,_e,se,he,me=m>>2,Re=0;Re<m;Re++)te=w[Re],Re<te&&(oe=D[Re],D[Re]=D[te],D[te]=oe,oe=O[Re],O[Re]=O[te],O[te]=oe);for(var ge=1;ge<m;ge<<=1){G=0,j=m/(ge<<1);for(var ue=0;ue<ge;ue++){Q=T[G+me],_e=N*T[G];for(var Se=ue;Se<m;Se+=ge<<1)H=Se+ge,se=Q*D[H]+_e*O[H],he=Q*O[H]-_e*D[H],D[H]=D[Se]-se,D[Se]+=se,O[H]=O[Se]-he,O[Se]+=he;G+=j}}},_initArray:function(){typeof Uint32Array!="undefined"?w=new Uint32Array(m):w=[],typeof Float64Array!="undefined"?T=new Float64Array(m*1.25):T=[]},_paddingZero:function(){},_makeBitReversalTable:function(){var D=0,O=0,N=0;for(w[0]=0;++D<m;){for(N=m>>1;N<=O;)O-=N,N>>=1;O+=N,w[D]=O}},_makeCosSinTable:function(){var D=m>>1,O=m>>2,N=m>>3,j=D+O,G=Math.sin(Math.PI/m),H=2*G*G,te=Math.sqrt(H*(2-H)),oe=T[O]=1,Q=T[0]=0;G=2*H;for(var _e=1;_e<N;_e++)oe-=H,H+=G*oe,Q+=te,te-=G*Q,T[_e]=Q,T[O-_e]=oe;N!==0&&(T[N]=Math.sqrt(.5));for(var se=0;se<O;se++)T[D-se]=T[se];for(var he=0;he<j;he++)T[he+D]=-T[he]}},y=["init","fft1d","ifft1d","fft2d","ifft2d"],B=0;B<y.length;B++)l[y[B]]=A[y[B]];return l.bt=A.bt1d,l.fft=A.fft1d,l.ifft=A.ifft1d,l}).call(commonjsGlobal)})(fftlib);var FFT=fftlib,FFTUtils$1={DEBUG:!1,ifft2DArray:function(h,l,p){var m=new Array(l*p),w=l/2,T=(p-1)*2;FFT.init(w);for(var A={re:new Array(w),im:new Array(w)},y=0;y<p;y++){for(var B=w-1;B>=0;B--)A.re[B]=h[B*2*p+y],A.im[B]=h[(B*2+1)*p+y];FFT.bt(A.re,A.im);for(var B=w-1;B>=0;B--)m[B*2*p+y]=A.re[B],m[(B*2+1)*p+y]=A.im[B]}var D=new Array(w*T);FFT.init(T);for(var O={re:new Array(T),im:new Array(T)},N=T*w,B=0;B<l;B+=2){O.re[0]=m[B*p],O.im[0]=m[(B+1)*p];for(var y=1;y<p;y++)O.re[y]=m[B*p+y],O.im[y]=m[(B+1)*p+y],O.re[T-y]=m[B*p+y],O.im[T-y]=-m[(B+1)*p+y];FFT.bt(O.re,O.im);for(var j=B/2*T,y=T-1;y>=0;y--)D[j+y]=O.re[y]/N}return D},fft2DArray:function(h,l,p,m){Object.assign({},{inplace:!0});var w=p/2+1,T=l*2,A=new Array(T*w);FFT.init(p);for(var y={re:new Array(p),im:new Array(p)},B={re:new Array(p),im:new Array(p)},D={re:new Array(p),im:new Array(p)},O,N,j,G,H,te=0;te<l/2;te++){O=te*2*p,y.re=h.slice(O,O+p),O=(te*2+1)*p,y.im=h.slice(O,O+p),FFT.fft1d(y.re,y.im),this.reconstructTwoRealFFT(y,B,D),N=te*4*w,j=(te*4+1)*w,G=(te*4+2)*w,H=(te*4+3)*w;for(var oe=w-1;oe>=0;oe--)A[N+oe]=B.re[oe],A[j+oe]=B.im[oe],A[G+oe]=D.re[oe],A[H+oe]=D.im[oe]}B=null,D=null;var Q=new Array(T*w);FFT.init(l);for(var _e={re:new Array(l),im:new Array(l)},se=w-1;se>=0;se--){for(var te=l-1;te>=0;te--)_e.re[te]=A[te*2*w+se],_e.im[te]=A[(te*2+1)*w+se],isNaN(_e.re[te])&&(_e.re[te]=0),isNaN(_e.im[te])&&(_e.im[te]=0);FFT.fft1d(_e.re,_e.im);for(var te=l-1;te>=0;te--)Q[te*2*w+se]=_e.re[te],Q[(te*2+1)*w+se]=_e.im[te]}return Q},reconstructTwoRealFFT:function(h,l,p){var m=h.re.length;l.re[0]=h.re[0],l.im[0]=0,p.re[0]=h.im[0],p.im[0]=0;for(var w,T,A,y,B,D=m/2;D>0;D--)B=m-D,w=.5*(h.re[D]-h.re[B]),T=.5*(h.re[D]+h.re[B]),A=.5*(h.im[D]-h.im[B]),y=.5*(h.im[D]+h.im[B]),l.re[D]=T,l.im[D]=A,l.re[B]=T,l.im[B]=-A,p.re[D]=y,p.im[D]=-w,p.re[B]=y,p.im[B]=w},convolute2DI:function(h,l,p,m){for(var w,T,A=0;A<p/2;A++)for(var y=0;y<m;y++)w=h[A*2*m+y]*l[A*2*m+y]-h[(A*2+1)*m+y]*l[(A*2+1)*m+y],T=h[A*2*m+y]*l[(A*2+1)*m+y]+h[(A*2+1)*m+y]*l[A*2*m+y],h[A*2*m+y]=w,h[(A*2+1)*m+y]=T},convolute:function(h,l,p,m,w){for(var T=new Array(m*p),A=0;A<p*m;A++)T[A]=h[A];T=this.fft2DArray(T,p,m);for(var y=l.length,B=l[0].length,D=new Array(m*p),A=0;A<m*p;A++)D[A]=0;for(var O,N,j=Math.floor((y-1)/2),G=Math.floor((B-1)/2),H=0;H<y;H++){O=(H-j+p)%p;for(var te=0;te<B;te++)N=(te-G+m)%m,D[O*m+N]=l[H][te]}D=this.fft2DArray(D,p,m);var oe=p*2,Q=m/2+1;return this.convolute2DI(T,D,oe,Q),this.ifft2DArray(T,oe,Q)},toRadix2:function(h,l,p){var m,w,T,A,y=p,B=l;if(!(p!==0&&(p&p-1)==0)){for(y=0;p>>++y!=0;);y=1<<y}if(!(l!==0&&(l&l-1)==0)){for(B=0;l>>++B!=0;);B=1<<B}if(B==l&&y==p)return{data:h,rows:l,cols:p};var D=new Array(B*y),O=Math.floor((B-l)/2)-l,N=Math.floor((y-p)/2)-p;for(m=0;m<B;m++)for(T=m*y,A=(m-O)%l*p,w=0;w<y;w++)D[T+w]=h[A+(w-N)%p];return{data:D,rows:B,cols:y}},crop:function(h,l,p,m,w,T){if(l==m&&p==w)return h;Object.assign({},T);var A=new Array(w*m),y=Math.floor((l-m)/2),B=Math.floor((p-w)/2),D,O,N,j;for(N=0;N<m;N++)for(D=N*w,O=(N+y)*p,j=0;j<w;j++)A[D+j]=h[O+(j+B)];return A}},FFTUtils_1=FFTUtils$1;src$3.FFTUtils=FFTUtils_1;src$3.FFT=fftlib;var FFTUtils=src$3.FFTUtils;function convolutionFFT(h,l,p){var m=matrix2Array(h),w=m.data,T=Object.assign({normalize:!1,divisor:1,rows:m.rows,cols:m.cols},p),A,y;if(T.rows&&T.cols)A=T.rows,y=T.cols;else throw new Error("Invalid number of rows or columns "+A+" "+y);var B=T.divisor,D,O,N=l.length,j=l[0].length;if(T.normalize)for(B=0,D=0;D<N;D++)for(O=0;O<j;O++)B+=l[D][O];if(B===0)throw new RangeError("convolution: The divisor is equal to zero");var G=FFTUtils.toRadix2(w,A,y),H=FFTUtils.convolute(G.data,l,G.rows,G.cols);if(H=FFTUtils.crop(H,G.rows,G.cols,A,y),B!=0&&B!=1)for(D=0;D<H.length;D++)H[D]/=B;return H}function convolutionDirect(h,l,p){var m=matrix2Array(h),w=m.data,T=Object.assign({normalize:!1,divisor:1,rows:m.rows,cols:m.cols},p),A,y;if(T.rows&&T.cols)A=T.rows,y=T.cols;else throw new Error("Invalid number of rows or columns "+A+" "+y);var B=T.divisor,D=l.length,O=l[0].length,N,j,G,H,te,oe,Q,_e,se;if(T.normalize)for(B=0,N=0;N<D;N++)for(j=0;j<O;j++)B+=l[N][j];if(B===0)throw new RangeError("convolution: The divisor is equal to zero");var he=new Array(A*y),me=Math.floor(D/2),Re=Math.floor(O/2);for(H=0;H<A;H++)for(G=0;G<y;G++){for(oe=0,j=0;j<D;j++)for(N=0;N<O;N++)Q=l[D-j-1][O-N-1],_e=(H+j-me+A)%A,se=(G+N-Re+y)%y,te=_e*y+se,oe+=w[te]*Q;te=H*y+G,he[te]=oe/B}return he}function LoG(h,l,p){var m=1e3;p&&p.factor&&(m=p.factor);var w=new Array(l),T,A,y,B;m*=-1;var D=(l-1)/2,O=2*h*h;for(T=0;T<l;T++)for(w[T]=new Array(l),B=(T-D)*(T-D),A=0;A<l;A++)y=-((A-D)*(A-D)+B)/O,w[T][A]=Math.round(m*(1+y)*Math.exp(y));return w}function matrix2Array(h){var l=h,p,m;if(typeof h[0]!="number"){p=h.length,m=h[0].length,l=new Array(p*m);for(var w=0;w<p;w++)for(var T=0;T<m;T++)l[w*m+T]=h[w][T]}else{var A=Math.sqrt(h.length);Number.isInteger(A)&&(p=A,m=A)}return{data:l,rows:p,cols:m}}var src$2={fft:convolutionFFT,direct:convolutionDirect,kernelFactory:{LoG},matrix2Array},_isFinite=Number.isFinite||function(h){return!(typeof h!="number"||h!==h||h===1/0||h===-1/0)},isFinite$1=_isFinite,isInteger=Number.isInteger||function(h){return typeof h=="number"&&isFinite$1(h)&&Math.floor(h)===h};function validateKernel(h){let l,p;if(Array.isArray(h))if(Array.isArray(h[0])){if((h.length&1)==0||(h[0].length&1)==0)throw new RangeError("validateKernel: Kernel rows and columns should be odd numbers");l=Math.floor(h.length/2),p=Math.floor(h[0].length/2)}else{let m=Math.sqrt(h.length);if(isInteger(m))p=l=Math.floor(Math.sqrt(h.length)/2);else throw new RangeError("validateKernel: Kernel array should be a square");let w=new Array(m);for(let T=0;T<m;T++){w[T]=new Array(m);for(let A=0;A<m;A++)w[T][A]=h[T*m+A]}h=w}else throw new Error(`validateKernel: Invalid Kernel: ${h}`);return{kernel:h,kWidth:p,kHeight:l}}function clamp(h,l){return Math.round(Math.min(Math.max(h,0),l.maxValue))}function directConvolution(h,l,p){if(p===void 0){const T=h.length+l.length-1;p=new Array(T)}fill(p);for(var m=0;m<h.length;m++)for(var w=0;w<l.length;w++)p[m+w]+=h[m]*l[w];return p}function fill(h){for(var l=0;l<h.length;l++)h[l]=0}function convolutionSeparable(h,l,p,m){const w=new Array(h.length);let T,A,y,B;B=l[1],y=(B.length-1)/2,A=new Array(p+B.length-1),T=new Array(p);for(let D=0;D<m;D++){for(let O=0;O<p;O++)T[O]=h[D*p+O];directConvolution(T,B,A);for(let O=0;O<p;O++)w[D*p+O]=A[y+O]}B=l[0],y=(B.length-1)/2,A=new Array(m+B.length-1),T=new Array(m);for(let D=0;D<p;D++){for(let O=0;O<m;O++)T[O]=w[O*p+D];directConvolution(T,B,A);for(let O=0;O<m;O++)w[O*p+D]=A[y+O]}return w}const toString$2=Object.prototype.toString;function isAnyArray(h){return toString$2.call(h).endsWith("Array]")}function max$1(h){var l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(h))throw new TypeError("input must be an array");if(h.length===0)throw new TypeError("input must not be empty");var p=l.fromIndex,m=p===void 0?0:p,w=l.toIndex,T=w===void 0?h.length:w;if(m<0||m>=h.length||!Number.isInteger(m))throw new Error("fromIndex must be a positive integer smaller than length");if(T<=m||T>h.length||!Number.isInteger(T))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var A=h[m],y=m+1;y<T;y++)h[y]>A&&(A=h[y]);return A}function min$1(h){var l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(h))throw new TypeError("input must be an array");if(h.length===0)throw new TypeError("input must not be empty");var p=l.fromIndex,m=p===void 0?0:p,w=l.toIndex,T=w===void 0?h.length:w;if(m<0||m>=h.length||!Number.isInteger(m))throw new Error("fromIndex must be a positive integer smaller than length");if(T<=m||T>h.length||!Number.isInteger(T))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var A=h[m],y=m+1;y<T;y++)h[y]<A&&(A=h[y]);return A}function rescale(h){var l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(isAnyArray(h)){if(h.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var p;if(l.output!==void 0){if(!isAnyArray(l.output))throw new TypeError("output option must be an array if specified");p=l.output}else p=new Array(h.length);var m=min$1(h),w=max$1(h);if(m===w)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var T=l.min,A=T===void 0?l.autoMinMax?m:0:T,y=l.max,B=y===void 0?l.autoMinMax?w:1:y;if(A>=B)throw new RangeError("min option must be smaller than max option");for(var D=(B-A)/(w-m),O=0;O<h.length;O++)p[O]=(h[O]-m)*D+A;return p}const indent=" ".repeat(2),indentData=" ".repeat(4);function inspectMatrix(){return inspectMatrixWithOptions(this)}function inspectMatrixWithOptions(h,l={}){const{maxRows:p=15,maxColumns:m=10,maxNumSize:w=8}=l;return`${h.constructor.name} {
${indent}[
${indentData}${inspectData(h,p,m,w)}
${indent}]
${indent}rows: ${h.rows}
${indent}columns: ${h.columns}
}`}function inspectData(h,l,p,m){const{rows:w,columns:T}=h,A=Math.min(w,l),y=Math.min(T,p),B=[];for(let D=0;D<A;D++){let O=[];for(let N=0;N<y;N++)O.push(formatNumber(h.get(D,N),m));B.push(`${O.join(" ")}`)}return y!==T&&(B[B.length-1]+=` ... ${T-p} more columns`),A!==w&&B.push(`... ${w-l} more rows`),B.join(`
${indentData}`)}function formatNumber(h,l){const p=String(h);if(p.length<=l)return p.padEnd(l," ");const m=h.toPrecision(l-2);if(m.length<=l)return m;const w=h.toExponential(l-2),T=w.indexOf("e"),A=w.slice(T);return w.slice(0,l-A.length)+A}function installMathOperations(h,l){h.prototype.add=function(m){return typeof m=="number"?this.addS(m):this.addM(m)},h.prototype.addS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)+m);return this},h.prototype.addM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)+m.get(w,T));return this},h.add=function(m,w){return new l(m).add(w)},h.prototype.sub=function(m){return typeof m=="number"?this.subS(m):this.subM(m)},h.prototype.subS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)-m);return this},h.prototype.subM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)-m.get(w,T));return this},h.sub=function(m,w){return new l(m).sub(w)},h.prototype.subtract=h.prototype.sub,h.prototype.subtractS=h.prototype.subS,h.prototype.subtractM=h.prototype.subM,h.subtract=h.sub,h.prototype.mul=function(m){return typeof m=="number"?this.mulS(m):this.mulM(m)},h.prototype.mulS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)*m);return this},h.prototype.mulM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)*m.get(w,T));return this},h.mul=function(m,w){return new l(m).mul(w)},h.prototype.multiply=h.prototype.mul,h.prototype.multiplyS=h.prototype.mulS,h.prototype.multiplyM=h.prototype.mulM,h.multiply=h.mul,h.prototype.div=function(m){return typeof m=="number"?this.divS(m):this.divM(m)},h.prototype.divS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)/m);return this},h.prototype.divM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)/m.get(w,T));return this},h.div=function(m,w){return new l(m).div(w)},h.prototype.divide=h.prototype.div,h.prototype.divideS=h.prototype.divS,h.prototype.divideM=h.prototype.divM,h.divide=h.div,h.prototype.mod=function(m){return typeof m=="number"?this.modS(m):this.modM(m)},h.prototype.modS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)%m);return this},h.prototype.modM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)%m.get(w,T));return this},h.mod=function(m,w){return new l(m).mod(w)},h.prototype.modulus=h.prototype.mod,h.prototype.modulusS=h.prototype.modS,h.prototype.modulusM=h.prototype.modM,h.modulus=h.mod,h.prototype.and=function(m){return typeof m=="number"?this.andS(m):this.andM(m)},h.prototype.andS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)&m);return this},h.prototype.andM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)&m.get(w,T));return this},h.and=function(m,w){return new l(m).and(w)},h.prototype.or=function(m){return typeof m=="number"?this.orS(m):this.orM(m)},h.prototype.orS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)|m);return this},h.prototype.orM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)|m.get(w,T));return this},h.or=function(m,w){return new l(m).or(w)},h.prototype.xor=function(m){return typeof m=="number"?this.xorS(m):this.xorM(m)},h.prototype.xorS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)^m);return this},h.prototype.xorM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)^m.get(w,T));return this},h.xor=function(m,w){return new l(m).xor(w)},h.prototype.leftShift=function(m){return typeof m=="number"?this.leftShiftS(m):this.leftShiftM(m)},h.prototype.leftShiftS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)<<m);return this},h.prototype.leftShiftM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)<<m.get(w,T));return this},h.leftShift=function(m,w){return new l(m).leftShift(w)},h.prototype.signPropagatingRightShift=function(m){return typeof m=="number"?this.signPropagatingRightShiftS(m):this.signPropagatingRightShiftM(m)},h.prototype.signPropagatingRightShiftS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)>>m);return this},h.prototype.signPropagatingRightShiftM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)>>m.get(w,T));return this},h.signPropagatingRightShift=function(m,w){return new l(m).signPropagatingRightShift(w)},h.prototype.rightShift=function(m){return typeof m=="number"?this.rightShiftS(m):this.rightShiftM(m)},h.prototype.rightShiftS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)>>>m);return this},h.prototype.rightShiftM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)>>>m.get(w,T));return this},h.rightShift=function(m,w){return new l(m).rightShift(w)},h.prototype.zeroFillRightShift=h.prototype.rightShift,h.prototype.zeroFillRightShiftS=h.prototype.rightShiftS,h.prototype.zeroFillRightShiftM=h.prototype.rightShiftM,h.zeroFillRightShift=h.rightShift,h.prototype.not=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,~this.get(m,w));return this},h.not=function(m){return new l(m).not()},h.prototype.abs=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.abs(this.get(m,w)));return this},h.abs=function(m){return new l(m).abs()},h.prototype.acos=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.acos(this.get(m,w)));return this},h.acos=function(m){return new l(m).acos()},h.prototype.acosh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.acosh(this.get(m,w)));return this},h.acosh=function(m){return new l(m).acosh()},h.prototype.asin=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.asin(this.get(m,w)));return this},h.asin=function(m){return new l(m).asin()},h.prototype.asinh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.asinh(this.get(m,w)));return this},h.asinh=function(m){return new l(m).asinh()},h.prototype.atan=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.atan(this.get(m,w)));return this},h.atan=function(m){return new l(m).atan()},h.prototype.atanh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.atanh(this.get(m,w)));return this},h.atanh=function(m){return new l(m).atanh()},h.prototype.cbrt=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.cbrt(this.get(m,w)));return this},h.cbrt=function(m){return new l(m).cbrt()},h.prototype.ceil=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.ceil(this.get(m,w)));return this},h.ceil=function(m){return new l(m).ceil()},h.prototype.clz32=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.clz32(this.get(m,w)));return this},h.clz32=function(m){return new l(m).clz32()},h.prototype.cos=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.cos(this.get(m,w)));return this},h.cos=function(m){return new l(m).cos()},h.prototype.cosh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.cosh(this.get(m,w)));return this},h.cosh=function(m){return new l(m).cosh()},h.prototype.exp=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.exp(this.get(m,w)));return this},h.exp=function(m){return new l(m).exp()},h.prototype.expm1=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.expm1(this.get(m,w)));return this},h.expm1=function(m){return new l(m).expm1()},h.prototype.floor=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.floor(this.get(m,w)));return this},h.floor=function(m){return new l(m).floor()},h.prototype.fround=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.fround(this.get(m,w)));return this},h.fround=function(m){return new l(m).fround()},h.prototype.log=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.log(this.get(m,w)));return this},h.log=function(m){return new l(m).log()},h.prototype.log1p=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.log1p(this.get(m,w)));return this},h.log1p=function(m){return new l(m).log1p()},h.prototype.log10=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.log10(this.get(m,w)));return this},h.log10=function(m){return new l(m).log10()},h.prototype.log2=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.log2(this.get(m,w)));return this},h.log2=function(m){return new l(m).log2()},h.prototype.round=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.round(this.get(m,w)));return this},h.round=function(m){return new l(m).round()},h.prototype.sign=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.sign(this.get(m,w)));return this},h.sign=function(m){return new l(m).sign()},h.prototype.sin=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.sin(this.get(m,w)));return this},h.sin=function(m){return new l(m).sin()},h.prototype.sinh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.sinh(this.get(m,w)));return this},h.sinh=function(m){return new l(m).sinh()},h.prototype.sqrt=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.sqrt(this.get(m,w)));return this},h.sqrt=function(m){return new l(m).sqrt()},h.prototype.tan=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.tan(this.get(m,w)));return this},h.tan=function(m){return new l(m).tan()},h.prototype.tanh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.tanh(this.get(m,w)));return this},h.tanh=function(m){return new l(m).tanh()},h.prototype.trunc=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.trunc(this.get(m,w)));return this},h.trunc=function(m){return new l(m).trunc()},h.pow=function(m,w){return new l(m).pow(w)},h.prototype.pow=function(m){return typeof m=="number"?this.powS(m):this.powM(m)},h.prototype.powS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,Math.pow(this.get(w,T),m));return this},h.prototype.powM=function(m){if(m=l.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,Math.pow(this.get(w,T),m.get(w,T)));return this}}function checkRowIndex(h,l,p){let m=p?h.rows:h.rows-1;if(l<0||l>m)throw new RangeError("Row index out of range")}function checkColumnIndex(h,l,p){let m=p?h.columns:h.columns-1;if(l<0||l>m)throw new RangeError("Column index out of range")}function checkRowVector(h,l){if(l.to1DArray&&(l=l.to1DArray()),l.length!==h.columns)throw new RangeError("vector size must be the same as the number of columns");return l}function checkColumnVector(h,l){if(l.to1DArray&&(l=l.to1DArray()),l.length!==h.rows)throw new RangeError("vector size must be the same as the number of rows");return l}function checkIndices(h,l,p){return{row:checkRowIndices(h,l),column:checkColumnIndices(h,p)}}function checkRowIndices(h,l){if(typeof l!="object")throw new TypeError("unexpected type for row indices");if(l.some(m=>m<0||m>=h.rows))throw new RangeError("row indices are out of range");return Array.isArray(l)||(l=Array.from(l)),l}function checkColumnIndices(h,l){if(typeof l!="object")throw new TypeError("unexpected type for column indices");if(l.some(m=>m<0||m>=h.columns))throw new RangeError("column indices are out of range");return Array.isArray(l)||(l=Array.from(l)),l}function checkRange(h,l,p,m,w){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(checkNumber("startRow",l),checkNumber("endRow",p),checkNumber("startColumn",m),checkNumber("endColumn",w),l>p||m>w||l<0||l>=h.rows||p<0||p>=h.rows||m<0||m>=h.columns||w<0||w>=h.columns)throw new RangeError("Submatrix indices are out of range")}function newArray$1(h,l=0){let p=[];for(let m=0;m<h;m++)p.push(l);return p}function checkNumber(h,l){if(typeof l!="number")throw new TypeError(`${h} must be a number`)}function checkNonEmpty(h){if(h.isEmpty())throw new Error("Empty matrix has no elements to index")}function sumByRow(h){let l=newArray$1(h.rows);for(let p=0;p<h.rows;++p)for(let m=0;m<h.columns;++m)l[p]+=h.get(p,m);return l}function sumByColumn(h){let l=newArray$1(h.columns);for(let p=0;p<h.rows;++p)for(let m=0;m<h.columns;++m)l[m]+=h.get(p,m);return l}function sumAll(h){let l=0;for(let p=0;p<h.rows;p++)for(let m=0;m<h.columns;m++)l+=h.get(p,m);return l}function productByRow(h){let l=newArray$1(h.rows,1);for(let p=0;p<h.rows;++p)for(let m=0;m<h.columns;++m)l[p]*=h.get(p,m);return l}function productByColumn(h){let l=newArray$1(h.columns,1);for(let p=0;p<h.rows;++p)for(let m=0;m<h.columns;++m)l[m]*=h.get(p,m);return l}function productAll(h){let l=1;for(let p=0;p<h.rows;p++)for(let m=0;m<h.columns;m++)l*=h.get(p,m);return l}function varianceByRow(h,l,p){const m=h.rows,w=h.columns,T=[];for(let A=0;A<m;A++){let y=0,B=0,D=0;for(let O=0;O<w;O++)D=h.get(A,O)-p[A],y+=D,B+=D*D;l?T.push((B-y*y/w)/(w-1)):T.push((B-y*y/w)/w)}return T}function varianceByColumn(h,l,p){const m=h.rows,w=h.columns,T=[];for(let A=0;A<w;A++){let y=0,B=0,D=0;for(let O=0;O<m;O++)D=h.get(O,A)-p[A],y+=D,B+=D*D;l?T.push((B-y*y/m)/(m-1)):T.push((B-y*y/m)/m)}return T}function varianceAll(h,l,p){const m=h.rows,w=h.columns,T=m*w;let A=0,y=0,B=0;for(let D=0;D<m;D++)for(let O=0;O<w;O++)B=h.get(D,O)-p,A+=B,y+=B*B;return l?(y-A*A/T)/(T-1):(y-A*A/T)/T}function centerByRow(h,l){for(let p=0;p<h.rows;p++)for(let m=0;m<h.columns;m++)h.set(p,m,h.get(p,m)-l[p])}function centerByColumn(h,l){for(let p=0;p<h.rows;p++)for(let m=0;m<h.columns;m++)h.set(p,m,h.get(p,m)-l[m])}function centerAll(h,l){for(let p=0;p<h.rows;p++)for(let m=0;m<h.columns;m++)h.set(p,m,h.get(p,m)-l)}function getScaleByRow(h){const l=[];for(let p=0;p<h.rows;p++){let m=0;for(let w=0;w<h.columns;w++)m+=Math.pow(h.get(p,w),2)/(h.columns-1);l.push(Math.sqrt(m))}return l}function scaleByRow(h,l){for(let p=0;p<h.rows;p++)for(let m=0;m<h.columns;m++)h.set(p,m,h.get(p,m)/l[p])}function getScaleByColumn(h){const l=[];for(let p=0;p<h.columns;p++){let m=0;for(let w=0;w<h.rows;w++)m+=Math.pow(h.get(w,p),2)/(h.rows-1);l.push(Math.sqrt(m))}return l}function scaleByColumn(h,l){for(let p=0;p<h.rows;p++)for(let m=0;m<h.columns;m++)h.set(p,m,h.get(p,m)/l[m])}function getScaleAll(h){const l=h.size-1;let p=0;for(let m=0;m<h.columns;m++)for(let w=0;w<h.rows;w++)p+=Math.pow(h.get(w,m),2)/l;return Math.sqrt(p)}function scaleAll(h,l){for(let p=0;p<h.rows;p++)for(let m=0;m<h.columns;m++)h.set(p,m,h.get(p,m)/l)}class AbstractMatrix{static from1DArray(l,p,m){if(l*p!==m.length)throw new RangeError("data length does not match given dimensions");let T=new Matrix$2(l,p);for(let A=0;A<l;A++)for(let y=0;y<p;y++)T.set(A,y,m[A*p+y]);return T}static rowVector(l){let p=new Matrix$2(1,l.length);for(let m=0;m<l.length;m++)p.set(0,m,l[m]);return p}static columnVector(l){let p=new Matrix$2(l.length,1);for(let m=0;m<l.length;m++)p.set(m,0,l[m]);return p}static zeros(l,p){return new Matrix$2(l,p)}static ones(l,p){return new Matrix$2(l,p).fill(1)}static rand(l,p,m={}){if(typeof m!="object")throw new TypeError("options must be an object");const{random:w=Math.random}=m;let T=new Matrix$2(l,p);for(let A=0;A<l;A++)for(let y=0;y<p;y++)T.set(A,y,w());return T}static randInt(l,p,m={}){if(typeof m!="object")throw new TypeError("options must be an object");const{min:w=0,max:T=1e3,random:A=Math.random}=m;if(!Number.isInteger(w))throw new TypeError("min must be an integer");if(!Number.isInteger(T))throw new TypeError("max must be an integer");if(w>=T)throw new RangeError("min must be smaller than max");let y=T-w,B=new Matrix$2(l,p);for(let D=0;D<l;D++)for(let O=0;O<p;O++){let N=w+Math.round(A()*y);B.set(D,O,N)}return B}static eye(l,p,m){p===void 0&&(p=l),m===void 0&&(m=1);let w=Math.min(l,p),T=this.zeros(l,p);for(let A=0;A<w;A++)T.set(A,A,m);return T}static diag(l,p,m){let w=l.length;p===void 0&&(p=w),m===void 0&&(m=p);let T=Math.min(w,p,m),A=this.zeros(p,m);for(let y=0;y<T;y++)A.set(y,y,l[y]);return A}static min(l,p){l=this.checkMatrix(l),p=this.checkMatrix(p);let m=l.rows,w=l.columns,T=new Matrix$2(m,w);for(let A=0;A<m;A++)for(let y=0;y<w;y++)T.set(A,y,Math.min(l.get(A,y),p.get(A,y)));return T}static max(l,p){l=this.checkMatrix(l),p=this.checkMatrix(p);let m=l.rows,w=l.columns,T=new this(m,w);for(let A=0;A<m;A++)for(let y=0;y<w;y++)T.set(A,y,Math.max(l.get(A,y),p.get(A,y)));return T}static checkMatrix(l){return AbstractMatrix.isMatrix(l)?l:new Matrix$2(l)}static isMatrix(l){return l!=null&&l.klass==="Matrix"}get size(){return this.rows*this.columns}apply(l){if(typeof l!="function")throw new TypeError("callback must be a function");for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)l.call(this,p,m);return this}to1DArray(){let l=[];for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)l.push(this.get(p,m));return l}to2DArray(){let l=[];for(let p=0;p<this.rows;p++){l.push([]);for(let m=0;m<this.columns;m++)l[p].push(this.get(p,m))}return l}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let l=0;l<this.rows;l++)for(let p=0;p<=l;p++)if(this.get(l,p)!==this.get(p,l))return!1;return!0}return!1}isEchelonForm(){let l=0,p=0,m=-1,w=!0,T=!1;for(;l<this.rows&&w;){for(p=0,T=!1;p<this.columns&&T===!1;)this.get(l,p)===0?p++:this.get(l,p)===1&&p>m?(T=!0,m=p):(w=!1,T=!0);l++}return w}isReducedEchelonForm(){let l=0,p=0,m=-1,w=!0,T=!1;for(;l<this.rows&&w;){for(p=0,T=!1;p<this.columns&&T===!1;)this.get(l,p)===0?p++:this.get(l,p)===1&&p>m?(T=!0,m=p):(w=!1,T=!0);for(let A=p+1;A<this.rows;A++)this.get(l,A)!==0&&(w=!1);l++}return w}echelonForm(){let l=this.clone(),p=0,m=0;for(;p<l.rows&&m<l.columns;){let w=p;for(let T=p;T<l.rows;T++)l.get(T,m)>l.get(w,m)&&(w=T);if(l.get(w,m)===0)m++;else{l.swapRows(p,w);let T=l.get(p,m);for(let A=m;A<l.columns;A++)l.set(p,A,l.get(p,A)/T);for(let A=p+1;A<l.rows;A++){let y=l.get(A,m)/l.get(p,m);l.set(A,m,0);for(let B=m+1;B<l.columns;B++)l.set(A,B,l.get(A,B)-l.get(p,B)*y)}p++,m++}}return l}reducedEchelonForm(){let l=this.echelonForm(),p=l.columns,m=l.rows,w=m-1;for(;w>=0;)if(l.maxRow(w)===0)w--;else{let T=0,A=!1;for(;T<m&&A===!1;)l.get(w,T)===1?A=!0:T++;for(let y=0;y<w;y++){let B=l.get(y,T);for(let D=T;D<p;D++){let O=l.get(y,D)-B*l.get(w,D);l.set(y,D,O)}}w--}return l}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(l={}){if(typeof l!="object")throw new TypeError("options must be an object");const{rows:p=1,columns:m=1}=l;if(!Number.isInteger(p)||p<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(m)||m<=0)throw new TypeError("columns must be a positive integer");let w=new Matrix$2(this.rows*p,this.columns*m);for(let T=0;T<p;T++)for(let A=0;A<m;A++)w.setSubMatrix(this,this.rows*T,this.columns*A);return w}fill(l){for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,l);return this}neg(){return this.mulS(-1)}getRow(l){checkRowIndex(this,l);let p=[];for(let m=0;m<this.columns;m++)p.push(this.get(l,m));return p}getRowVector(l){return Matrix$2.rowVector(this.getRow(l))}setRow(l,p){checkRowIndex(this,l),p=checkRowVector(this,p);for(let m=0;m<this.columns;m++)this.set(l,m,p[m]);return this}swapRows(l,p){checkRowIndex(this,l),checkRowIndex(this,p);for(let m=0;m<this.columns;m++){let w=this.get(l,m);this.set(l,m,this.get(p,m)),this.set(p,m,w)}return this}getColumn(l){checkColumnIndex(this,l);let p=[];for(let m=0;m<this.rows;m++)p.push(this.get(m,l));return p}getColumnVector(l){return Matrix$2.columnVector(this.getColumn(l))}setColumn(l,p){checkColumnIndex(this,l),p=checkColumnVector(this,p);for(let m=0;m<this.rows;m++)this.set(m,l,p[m]);return this}swapColumns(l,p){checkColumnIndex(this,l),checkColumnIndex(this,p);for(let m=0;m<this.rows;m++){let w=this.get(m,l);this.set(m,l,this.get(m,p)),this.set(m,p,w)}return this}addRowVector(l){l=checkRowVector(this,l);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)+l[m]);return this}subRowVector(l){l=checkRowVector(this,l);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)-l[m]);return this}mulRowVector(l){l=checkRowVector(this,l);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)*l[m]);return this}divRowVector(l){l=checkRowVector(this,l);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)/l[m]);return this}addColumnVector(l){l=checkColumnVector(this,l);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)+l[p]);return this}subColumnVector(l){l=checkColumnVector(this,l);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)-l[p]);return this}mulColumnVector(l){l=checkColumnVector(this,l);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)*l[p]);return this}divColumnVector(l){l=checkColumnVector(this,l);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)/l[p]);return this}mulRow(l,p){checkRowIndex(this,l);for(let m=0;m<this.columns;m++)this.set(l,m,this.get(l,m)*p);return this}mulColumn(l,p){checkColumnIndex(this,l);for(let m=0;m<this.rows;m++)this.set(m,l,this.get(m,l)*p);return this}max(){if(this.isEmpty())return NaN;let l=this.get(0,0);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.get(p,m)>l&&(l=this.get(p,m));return l}maxIndex(){checkNonEmpty(this);let l=this.get(0,0),p=[0,0];for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.get(m,w)>l&&(l=this.get(m,w),p[0]=m,p[1]=w);return p}min(){if(this.isEmpty())return NaN;let l=this.get(0,0);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.get(p,m)<l&&(l=this.get(p,m));return l}minIndex(){checkNonEmpty(this);let l=this.get(0,0),p=[0,0];for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.get(m,w)<l&&(l=this.get(m,w),p[0]=m,p[1]=w);return p}maxRow(l){if(checkRowIndex(this,l),this.isEmpty())return NaN;let p=this.get(l,0);for(let m=1;m<this.columns;m++)this.get(l,m)>p&&(p=this.get(l,m));return p}maxRowIndex(l){checkRowIndex(this,l),checkNonEmpty(this);let p=this.get(l,0),m=[l,0];for(let w=1;w<this.columns;w++)this.get(l,w)>p&&(p=this.get(l,w),m[1]=w);return m}minRow(l){if(checkRowIndex(this,l),this.isEmpty())return NaN;let p=this.get(l,0);for(let m=1;m<this.columns;m++)this.get(l,m)<p&&(p=this.get(l,m));return p}minRowIndex(l){checkRowIndex(this,l),checkNonEmpty(this);let p=this.get(l,0),m=[l,0];for(let w=1;w<this.columns;w++)this.get(l,w)<p&&(p=this.get(l,w),m[1]=w);return m}maxColumn(l){if(checkColumnIndex(this,l),this.isEmpty())return NaN;let p=this.get(0,l);for(let m=1;m<this.rows;m++)this.get(m,l)>p&&(p=this.get(m,l));return p}maxColumnIndex(l){checkColumnIndex(this,l),checkNonEmpty(this);let p=this.get(0,l),m=[0,l];for(let w=1;w<this.rows;w++)this.get(w,l)>p&&(p=this.get(w,l),m[0]=w);return m}minColumn(l){if(checkColumnIndex(this,l),this.isEmpty())return NaN;let p=this.get(0,l);for(let m=1;m<this.rows;m++)this.get(m,l)<p&&(p=this.get(m,l));return p}minColumnIndex(l){checkColumnIndex(this,l),checkNonEmpty(this);let p=this.get(0,l),m=[0,l];for(let w=1;w<this.rows;w++)this.get(w,l)<p&&(p=this.get(w,l),m[0]=w);return m}diag(){let l=Math.min(this.rows,this.columns),p=[];for(let m=0;m<l;m++)p.push(this.get(m,m));return p}norm(l="frobenius"){let p=0;if(l==="max")return this.max();if(l==="frobenius"){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)p=p+this.get(m,w)*this.get(m,w);return Math.sqrt(p)}else throw new RangeError(`unknown norm type: ${l}`)}cumulativeSum(){let l=0;for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)l+=this.get(p,m),this.set(p,m,l);return this}dot(l){AbstractMatrix.isMatrix(l)&&(l=l.to1DArray());let p=this.to1DArray();if(p.length!==l.length)throw new RangeError("vectors do not have the same size");let m=0;for(let w=0;w<p.length;w++)m+=p[w]*l[w];return m}mmul(l){l=Matrix$2.checkMatrix(l);let p=this.rows,m=this.columns,w=l.columns,T=new Matrix$2(p,w),A=new Float64Array(m);for(let y=0;y<w;y++){for(let B=0;B<m;B++)A[B]=l.get(B,y);for(let B=0;B<p;B++){let D=0;for(let O=0;O<m;O++)D+=this.get(B,O)*A[O];T.set(B,y,D)}}return T}strassen2x2(l){l=Matrix$2.checkMatrix(l);let p=new Matrix$2(2,2);const m=this.get(0,0),w=l.get(0,0),T=this.get(0,1),A=l.get(0,1),y=this.get(1,0),B=l.get(1,0),D=this.get(1,1),O=l.get(1,1),N=(m+D)*(w+O),j=(y+D)*w,G=m*(A-O),H=D*(B-w),te=(m+T)*O,oe=(y-m)*(w+A),Q=(T-D)*(B+O),_e=N+H-te+Q,se=G+te,he=j+H,me=N-j+G+oe;return p.set(0,0,_e),p.set(0,1,se),p.set(1,0,he),p.set(1,1,me),p}strassen3x3(l){l=Matrix$2.checkMatrix(l);let p=new Matrix$2(3,3);const m=this.get(0,0),w=this.get(0,1),T=this.get(0,2),A=this.get(1,0),y=this.get(1,1),B=this.get(1,2),D=this.get(2,0),O=this.get(2,1),N=this.get(2,2),j=l.get(0,0),G=l.get(0,1),H=l.get(0,2),te=l.get(1,0),oe=l.get(1,1),Q=l.get(1,2),_e=l.get(2,0),se=l.get(2,1),he=l.get(2,2),me=(m+w+T-A-y-O-N)*oe,Re=(m-A)*(-G+oe),ge=y*(-j+G+te-oe-Q-_e+he),ue=(-m+A+y)*(j-G+oe),Se=(A+y)*(-j+G),le=m*j,pe=(-m+D+O)*(j-H+Q),Le=(-m+D)*(H-Q),Ze=(D+O)*(-j+H),lt=(m+w+T-y-B-D-O)*Q,ct=O*(-j+H+te-oe-Q-_e+se),$t=(-T+O+N)*(oe+_e-se),Nt=(T-N)*(oe-se),St=T*_e,Gt=(O+N)*(-_e+se),Dt=(-T+y+B)*(Q+_e-he),Ut=(T-B)*(Q-he),Xt=(y+B)*(-_e+he),ft=w*te,wt=B*se,bt=A*H,zt=D*G,qt=N*he,ui=le+St+ft,Ct=me+ue+Se+le+$t+St+Gt,di=le+pe+Ze+lt+St+Dt+Xt,mi=Re+ge+ue+le+St+Dt+Ut,Ti=Re+ue+Se+le+wt,hi=St+Dt+Ut+Xt+bt,Pt=le+pe+Le+ct+$t+Nt+St,Tt=$t+Nt+St+Gt+zt,Lt=le+pe+Le+Ze+qt;return p.set(0,0,ui),p.set(0,1,Ct),p.set(0,2,di),p.set(1,0,mi),p.set(1,1,Ti),p.set(1,2,hi),p.set(2,0,Pt),p.set(2,1,Tt),p.set(2,2,Lt),p}mmulStrassen(l){l=Matrix$2.checkMatrix(l);let p=this.clone(),m=p.rows,w=p.columns,T=l.rows,A=l.columns;w!==T&&console.warn(`Multiplying ${m} x ${w} and ${T} x ${A} matrix: dimensions do not match.`);function y(N,j,G){let H=N.rows,te=N.columns;if(H===j&&te===G)return N;{let oe=AbstractMatrix.zeros(j,G);return oe=oe.setSubMatrix(N,0,0),oe}}let B=Math.max(m,T),D=Math.max(w,A);p=y(p,B,D),l=y(l,B,D);function O(N,j,G,H){if(G<=512||H<=512)return N.mmul(j);G%2==1&&H%2==1?(N=y(N,G+1,H+1),j=y(j,G+1,H+1)):G%2==1?(N=y(N,G+1,H),j=y(j,G+1,H)):H%2==1&&(N=y(N,G,H+1),j=y(j,G,H+1));let te=parseInt(N.rows/2,10),oe=parseInt(N.columns/2,10),Q=N.subMatrix(0,te-1,0,oe-1),_e=j.subMatrix(0,te-1,0,oe-1),se=N.subMatrix(0,te-1,oe,N.columns-1),he=j.subMatrix(0,te-1,oe,j.columns-1),me=N.subMatrix(te,N.rows-1,0,oe-1),Re=j.subMatrix(te,j.rows-1,0,oe-1),ge=N.subMatrix(te,N.rows-1,oe,N.columns-1),ue=j.subMatrix(te,j.rows-1,oe,j.columns-1),Se=O(AbstractMatrix.add(Q,ge),AbstractMatrix.add(_e,ue),te,oe),le=O(AbstractMatrix.add(me,ge),_e,te,oe),pe=O(Q,AbstractMatrix.sub(he,ue),te,oe),Le=O(ge,AbstractMatrix.sub(Re,_e),te,oe),Ze=O(AbstractMatrix.add(Q,se),ue,te,oe),lt=O(AbstractMatrix.sub(me,Q),AbstractMatrix.add(_e,he),te,oe),ct=O(AbstractMatrix.sub(se,ge),AbstractMatrix.add(Re,ue),te,oe),$t=AbstractMatrix.add(Se,Le);$t.sub(Ze),$t.add(ct);let Nt=AbstractMatrix.add(pe,Ze),St=AbstractMatrix.add(le,Le),Gt=AbstractMatrix.sub(Se,le);Gt.add(pe),Gt.add(lt);let Dt=AbstractMatrix.zeros(2*$t.rows,2*$t.columns);return Dt=Dt.setSubMatrix($t,0,0),Dt=Dt.setSubMatrix(Nt,$t.rows,0),Dt=Dt.setSubMatrix(St,0,$t.columns),Dt=Dt.setSubMatrix(Gt,$t.rows,$t.columns),Dt.subMatrix(0,G-1,0,H-1)}return O(p,l,B,D)}scaleRows(l={}){if(typeof l!="object")throw new TypeError("options must be an object");const{min:p=0,max:m=1}=l;if(!Number.isFinite(p))throw new TypeError("min must be a number");if(!Number.isFinite(m))throw new TypeError("max must be a number");if(p>=m)throw new RangeError("min must be smaller than max");let w=new Matrix$2(this.rows,this.columns);for(let T=0;T<this.rows;T++){const A=this.getRow(T);A.length>0&&rescale(A,{min:p,max:m,output:A}),w.setRow(T,A)}return w}scaleColumns(l={}){if(typeof l!="object")throw new TypeError("options must be an object");const{min:p=0,max:m=1}=l;if(!Number.isFinite(p))throw new TypeError("min must be a number");if(!Number.isFinite(m))throw new TypeError("max must be a number");if(p>=m)throw new RangeError("min must be smaller than max");let w=new Matrix$2(this.rows,this.columns);for(let T=0;T<this.columns;T++){const A=this.getColumn(T);A.length&&rescale(A,{min:p,max:m,output:A}),w.setColumn(T,A)}return w}flipRows(){const l=Math.ceil(this.columns/2);for(let p=0;p<this.rows;p++)for(let m=0;m<l;m++){let w=this.get(p,m),T=this.get(p,this.columns-1-m);this.set(p,m,T),this.set(p,this.columns-1-m,w)}return this}flipColumns(){const l=Math.ceil(this.rows/2);for(let p=0;p<this.columns;p++)for(let m=0;m<l;m++){let w=this.get(m,p),T=this.get(this.rows-1-m,p);this.set(m,p,T),this.set(this.rows-1-m,p,w)}return this}kroneckerProduct(l){l=Matrix$2.checkMatrix(l);let p=this.rows,m=this.columns,w=l.rows,T=l.columns,A=new Matrix$2(p*w,m*T);for(let y=0;y<p;y++)for(let B=0;B<m;B++)for(let D=0;D<w;D++)for(let O=0;O<T;O++)A.set(w*y+D,T*B+O,this.get(y,B)*l.get(D,O));return A}kroneckerSum(l){if(l=Matrix$2.checkMatrix(l),!this.isSquare()||!l.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let p=this.rows,m=l.rows,w=this.kroneckerProduct(Matrix$2.eye(m,m)),T=Matrix$2.eye(p,p).kroneckerProduct(l);return w.add(T)}transpose(){let l=new Matrix$2(this.columns,this.rows);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)l.set(m,p,this.get(p,m));return l}sortRows(l=compareNumbers){for(let p=0;p<this.rows;p++)this.setRow(p,this.getRow(p).sort(l));return this}sortColumns(l=compareNumbers){for(let p=0;p<this.columns;p++)this.setColumn(p,this.getColumn(p).sort(l));return this}subMatrix(l,p,m,w){checkRange(this,l,p,m,w);let T=new Matrix$2(p-l+1,w-m+1);for(let A=l;A<=p;A++)for(let y=m;y<=w;y++)T.set(A-l,y-m,this.get(A,y));return T}subMatrixRow(l,p,m){if(p===void 0&&(p=0),m===void 0&&(m=this.columns-1),p>m||p<0||p>=this.columns||m<0||m>=this.columns)throw new RangeError("Argument out of range");let w=new Matrix$2(l.length,m-p+1);for(let T=0;T<l.length;T++)for(let A=p;A<=m;A++){if(l[T]<0||l[T]>=this.rows)throw new RangeError(`Row index out of range: ${l[T]}`);w.set(T,A-p,this.get(l[T],A))}return w}subMatrixColumn(l,p,m){if(p===void 0&&(p=0),m===void 0&&(m=this.rows-1),p>m||p<0||p>=this.rows||m<0||m>=this.rows)throw new RangeError("Argument out of range");let w=new Matrix$2(m-p+1,l.length);for(let T=0;T<l.length;T++)for(let A=p;A<=m;A++){if(l[T]<0||l[T]>=this.columns)throw new RangeError(`Column index out of range: ${l[T]}`);w.set(A-p,T,this.get(A,l[T]))}return w}setSubMatrix(l,p,m){if(l=Matrix$2.checkMatrix(l),l.isEmpty())return this;let w=p+l.rows-1,T=m+l.columns-1;checkRange(this,p,w,m,T);for(let A=0;A<l.rows;A++)for(let y=0;y<l.columns;y++)this.set(p+A,m+y,l.get(A,y));return this}selection(l,p){let m=checkIndices(this,l,p),w=new Matrix$2(l.length,p.length);for(let T=0;T<m.row.length;T++){let A=m.row[T];for(let y=0;y<m.column.length;y++){let B=m.column[y];w.set(T,y,this.get(A,B))}}return w}trace(){let l=Math.min(this.rows,this.columns),p=0;for(let m=0;m<l;m++)p+=this.get(m,m);return p}clone(){let l=new Matrix$2(this.rows,this.columns);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)l.set(p,m,this.get(p,m));return l}sum(l){switch(l){case"row":return sumByRow(this);case"column":return sumByColumn(this);case void 0:return sumAll(this);default:throw new Error(`invalid option: ${l}`)}}product(l){switch(l){case"row":return productByRow(this);case"column":return productByColumn(this);case void 0:return productAll(this);default:throw new Error(`invalid option: ${l}`)}}mean(l){const p=this.sum(l);switch(l){case"row":{for(let m=0;m<this.rows;m++)p[m]/=this.columns;return p}case"column":{for(let m=0;m<this.columns;m++)p[m]/=this.rows;return p}case void 0:return p/this.size;default:throw new Error(`invalid option: ${l}`)}}variance(l,p={}){if(typeof l=="object"&&(p=l,l=void 0),typeof p!="object")throw new TypeError("options must be an object");const{unbiased:m=!0,mean:w=this.mean(l)}=p;if(typeof m!="boolean")throw new TypeError("unbiased must be a boolean");switch(l){case"row":{if(!Array.isArray(w))throw new TypeError("mean must be an array");return varianceByRow(this,m,w)}case"column":{if(!Array.isArray(w))throw new TypeError("mean must be an array");return varianceByColumn(this,m,w)}case void 0:{if(typeof w!="number")throw new TypeError("mean must be a number");return varianceAll(this,m,w)}default:throw new Error(`invalid option: ${l}`)}}standardDeviation(l,p){typeof l=="object"&&(p=l,l=void 0);const m=this.variance(l,p);if(l===void 0)return Math.sqrt(m);for(let w=0;w<m.length;w++)m[w]=Math.sqrt(m[w]);return m}center(l,p={}){if(typeof l=="object"&&(p=l,l=void 0),typeof p!="object")throw new TypeError("options must be an object");const{center:m=this.mean(l)}=p;switch(l){case"row":{if(!Array.isArray(m))throw new TypeError("center must be an array");return centerByRow(this,m),this}case"column":{if(!Array.isArray(m))throw new TypeError("center must be an array");return centerByColumn(this,m),this}case void 0:{if(typeof m!="number")throw new TypeError("center must be a number");return centerAll(this,m),this}default:throw new Error(`invalid option: ${l}`)}}scale(l,p={}){if(typeof l=="object"&&(p=l,l=void 0),typeof p!="object")throw new TypeError("options must be an object");let m=p.scale;switch(l){case"row":{if(m===void 0)m=getScaleByRow(this);else if(!Array.isArray(m))throw new TypeError("scale must be an array");return scaleByRow(this,m),this}case"column":{if(m===void 0)m=getScaleByColumn(this);else if(!Array.isArray(m))throw new TypeError("scale must be an array");return scaleByColumn(this,m),this}case void 0:{if(m===void 0)m=getScaleAll(this);else if(typeof m!="number")throw new TypeError("scale must be a number");return scaleAll(this,m),this}default:throw new Error(`invalid option: ${l}`)}}toString(l){return inspectMatrixWithOptions(this,l)}}AbstractMatrix.prototype.klass="Matrix";typeof Symbol!="undefined"&&(AbstractMatrix.prototype[Symbol.for("nodejs.util.inspect.custom")]=inspectMatrix);function compareNumbers(h,l){return h-l}AbstractMatrix.random=AbstractMatrix.rand;AbstractMatrix.randomInt=AbstractMatrix.randInt;AbstractMatrix.diagonal=AbstractMatrix.diag;AbstractMatrix.prototype.diagonal=AbstractMatrix.prototype.diag;AbstractMatrix.identity=AbstractMatrix.eye;AbstractMatrix.prototype.negate=AbstractMatrix.prototype.neg;AbstractMatrix.prototype.tensorProduct=AbstractMatrix.prototype.kroneckerProduct;class Matrix$2 extends AbstractMatrix{constructor(l,p){super();if(Matrix$2.isMatrix(l))return l.clone();if(Number.isInteger(l)&&l>=0)if(this.data=[],Number.isInteger(p)&&p>=0)for(let m=0;m<l;m++)this.data.push(new Float64Array(p));else throw new TypeError("nColumns must be a positive integer");else if(Array.isArray(l)){const m=l;if(l=m.length,p=l?m[0].length:0,typeof p!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let w=0;w<l;w++){if(m[w].length!==p)throw new RangeError("Inconsistent array dimensions");this.data.push(Float64Array.from(m[w]))}}else throw new TypeError("First argument must be a positive number or an array");this.rows=l,this.columns=p}set(l,p,m){return this.data[l][p]=m,this}get(l,p){return this.data[l][p]}removeRow(l){return checkRowIndex(this,l),this.data.splice(l,1),this.rows-=1,this}addRow(l,p){return p===void 0&&(p=l,l=this.rows),checkRowIndex(this,l,!0),p=Float64Array.from(checkRowVector(this,p)),this.data.splice(l,0,p),this.rows+=1,this}removeColumn(l){checkColumnIndex(this,l);for(let p=0;p<this.rows;p++){const m=new Float64Array(this.columns-1);for(let w=0;w<l;w++)m[w]=this.data[p][w];for(let w=l+1;w<this.columns;w++)m[w-1]=this.data[p][w];this.data[p]=m}return this.columns-=1,this}addColumn(l,p){typeof p=="undefined"&&(p=l,l=this.columns),checkColumnIndex(this,l,!0),p=checkColumnVector(this,p);for(let m=0;m<this.rows;m++){const w=new Float64Array(this.columns+1);let T=0;for(;T<l;T++)w[T]=this.data[m][T];for(w[T++]=p[m];T<this.columns+1;T++)w[T]=this.data[m][T-1];this.data[m]=w}return this.columns+=1,this}}installMathOperations(AbstractMatrix,Matrix$2);class BaseView extends AbstractMatrix{constructor(l,p,m){super();this.matrix=l,this.rows=p,this.columns=m}}class MatrixColumnView extends BaseView{constructor(l,p){checkColumnIndex(l,p);super(l,l.rows,1);this.column=p}set(l,p,m){return this.matrix.set(l,this.column,m),this}get(l){return this.matrix.get(l,this.column)}}class MatrixColumnSelectionView extends BaseView{constructor(l,p){p=checkColumnIndices(l,p);super(l,l.rows,p.length);this.columnIndices=p}set(l,p,m){return this.matrix.set(l,this.columnIndices[p],m),this}get(l,p){return this.matrix.get(l,this.columnIndices[p])}}class MatrixFlipColumnView extends BaseView{constructor(l){super(l,l.rows,l.columns)}set(l,p,m){return this.matrix.set(l,this.columns-p-1,m),this}get(l,p){return this.matrix.get(l,this.columns-p-1)}}class MatrixFlipRowView extends BaseView{constructor(l){super(l,l.rows,l.columns)}set(l,p,m){return this.matrix.set(this.rows-l-1,p,m),this}get(l,p){return this.matrix.get(this.rows-l-1,p)}}class MatrixRowView extends BaseView{constructor(l,p){checkRowIndex(l,p);super(l,1,l.columns);this.row=p}set(l,p,m){return this.matrix.set(this.row,p,m),this}get(l,p){return this.matrix.get(this.row,p)}}class MatrixRowSelectionView extends BaseView{constructor(l,p){p=checkRowIndices(l,p);super(l,p.length,l.columns);this.rowIndices=p}set(l,p,m){return this.matrix.set(this.rowIndices[l],p,m),this}get(l,p){return this.matrix.get(this.rowIndices[l],p)}}class MatrixSelectionView extends BaseView{constructor(l,p,m){let w=checkIndices(l,p,m);super(l,w.row.length,w.column.length);this.rowIndices=w.row,this.columnIndices=w.column}set(l,p,m){return this.matrix.set(this.rowIndices[l],this.columnIndices[p],m),this}get(l,p){return this.matrix.get(this.rowIndices[l],this.columnIndices[p])}}class MatrixSubView extends BaseView{constructor(l,p,m,w,T){checkRange(l,p,m,w,T);super(l,m-p+1,T-w+1);this.startRow=p,this.startColumn=w}set(l,p,m){return this.matrix.set(this.startRow+l,this.startColumn+p,m),this}get(l,p){return this.matrix.get(this.startRow+l,this.startColumn+p)}}class MatrixTransposeView$1 extends BaseView{constructor(l){super(l,l.columns,l.rows)}set(l,p,m){return this.matrix.set(p,l,m),this}get(l,p){return this.matrix.get(p,l)}}class WrapperMatrix1D extends AbstractMatrix{constructor(l,p={}){const{rows:m=1}=p;if(l.length%m!=0)throw new Error("the data length is not divisible by the number of rows");super();this.rows=m,this.columns=l.length/m,this.data=l}set(l,p,m){let w=this._calculateIndex(l,p);return this.data[w]=m,this}get(l,p){let m=this._calculateIndex(l,p);return this.data[m]}_calculateIndex(l,p){return l*this.columns+p}}class WrapperMatrix2D extends AbstractMatrix{constructor(l){super();this.data=l,this.rows=l.length,this.columns=l[0].length}set(l,p,m){return this.data[l][p]=m,this}get(l,p){return this.data[l][p]}}function wrap(h,l){if(Array.isArray(h))return h[0]&&Array.isArray(h[0])?new WrapperMatrix2D(h):new WrapperMatrix1D(h,l);throw new Error("the argument is not an array")}class LuDecomposition{constructor(l){l=WrapperMatrix2D.checkMatrix(l);let p=l.clone(),m=p.rows,w=p.columns,T=new Float64Array(m),A=1,y,B,D,O,N,j,G,H,te;for(y=0;y<m;y++)T[y]=y;for(H=new Float64Array(m),B=0;B<w;B++){for(y=0;y<m;y++)H[y]=p.get(y,B);for(y=0;y<m;y++){for(te=Math.min(y,B),N=0,D=0;D<te;D++)N+=p.get(y,D)*H[D];H[y]-=N,p.set(y,B,H[y])}for(O=B,y=B+1;y<m;y++)Math.abs(H[y])>Math.abs(H[O])&&(O=y);if(O!==B){for(D=0;D<w;D++)j=p.get(O,D),p.set(O,D,p.get(B,D)),p.set(B,D,j);G=T[O],T[O]=T[B],T[B]=G,A=-A}if(B<m&&p.get(B,B)!==0)for(y=B+1;y<m;y++)p.set(y,B,p.get(y,B)/p.get(B,B))}this.LU=p,this.pivotVector=T,this.pivotSign=A}isSingular(){let l=this.LU,p=l.columns;for(let m=0;m<p;m++)if(l.get(m,m)===0)return!0;return!1}solve(l){l=Matrix$2.checkMatrix(l);let p=this.LU;if(p.rows!==l.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let w=l.columns,T=l.subMatrixRow(this.pivotVector,0,w-1),A=p.columns,y,B,D;for(D=0;D<A;D++)for(y=D+1;y<A;y++)for(B=0;B<w;B++)T.set(y,B,T.get(y,B)-T.get(D,B)*p.get(y,D));for(D=A-1;D>=0;D--){for(B=0;B<w;B++)T.set(D,B,T.get(D,B)/p.get(D,D));for(y=0;y<D;y++)for(B=0;B<w;B++)T.set(y,B,T.get(y,B)-T.get(D,B)*p.get(y,D))}return T}get determinant(){let l=this.LU;if(!l.isSquare())throw new Error("Matrix must be square");let p=this.pivotSign,m=l.columns;for(let w=0;w<m;w++)p*=l.get(w,w);return p}get lowerTriangularMatrix(){let l=this.LU,p=l.rows,m=l.columns,w=new Matrix$2(p,m);for(let T=0;T<p;T++)for(let A=0;A<m;A++)T>A?w.set(T,A,l.get(T,A)):T===A?w.set(T,A,1):w.set(T,A,0);return w}get upperTriangularMatrix(){let l=this.LU,p=l.rows,m=l.columns,w=new Matrix$2(p,m);for(let T=0;T<p;T++)for(let A=0;A<m;A++)T<=A?w.set(T,A,l.get(T,A)):w.set(T,A,0);return w}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function hypotenuse$1(h,l){let p=0;return Math.abs(h)>Math.abs(l)?(p=l/h,Math.abs(h)*Math.sqrt(1+p*p)):l!==0?(p=h/l,Math.abs(l)*Math.sqrt(1+p*p)):0}class QrDecomposition{constructor(l){l=WrapperMatrix2D.checkMatrix(l);let p=l.clone(),m=l.rows,w=l.columns,T=new Float64Array(w),A,y,B,D;for(B=0;B<w;B++){let O=0;for(A=B;A<m;A++)O=hypotenuse$1(O,p.get(A,B));if(O!==0){for(p.get(B,B)<0&&(O=-O),A=B;A<m;A++)p.set(A,B,p.get(A,B)/O);for(p.set(B,B,p.get(B,B)+1),y=B+1;y<w;y++){for(D=0,A=B;A<m;A++)D+=p.get(A,B)*p.get(A,y);for(D=-D/p.get(B,B),A=B;A<m;A++)p.set(A,y,p.get(A,y)+D*p.get(A,B))}}T[B]=-O}this.QR=p,this.Rdiag=T}solve(l){l=Matrix$2.checkMatrix(l);let p=this.QR,m=p.rows;if(l.rows!==m)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let w=l.columns,T=l.clone(),A=p.columns,y,B,D,O;for(D=0;D<A;D++)for(B=0;B<w;B++){for(O=0,y=D;y<m;y++)O+=p.get(y,D)*T.get(y,B);for(O=-O/p.get(D,D),y=D;y<m;y++)T.set(y,B,T.get(y,B)+O*p.get(y,D))}for(D=A-1;D>=0;D--){for(B=0;B<w;B++)T.set(D,B,T.get(D,B)/this.Rdiag[D]);for(y=0;y<D;y++)for(B=0;B<w;B++)T.set(y,B,T.get(y,B)-T.get(D,B)*p.get(y,D))}return T.subMatrix(0,A-1,0,w-1)}isFullRank(){let l=this.QR.columns;for(let p=0;p<l;p++)if(this.Rdiag[p]===0)return!1;return!0}get upperTriangularMatrix(){let l=this.QR,p=l.columns,m=new Matrix$2(p,p),w,T;for(w=0;w<p;w++)for(T=0;T<p;T++)w<T?m.set(w,T,l.get(w,T)):w===T?m.set(w,T,this.Rdiag[w]):m.set(w,T,0);return m}get orthogonalMatrix(){let l=this.QR,p=l.rows,m=l.columns,w=new Matrix$2(p,m),T,A,y,B;for(y=m-1;y>=0;y--){for(T=0;T<p;T++)w.set(T,y,0);for(w.set(y,y,1),A=y;A<m;A++)if(l.get(y,y)!==0){for(B=0,T=y;T<p;T++)B+=l.get(T,y)*w.get(T,A);for(B=-B/l.get(y,y),T=y;T<p;T++)w.set(T,A,w.get(T,A)+B*l.get(T,y))}}return w}}class SingularValueDecomposition{constructor(l,p={}){if(l=WrapperMatrix2D.checkMatrix(l),l.isEmpty())throw new Error("Matrix must be non-empty");let m=l.rows,w=l.columns;const{computeLeftSingularVectors:T=!0,computeRightSingularVectors:A=!0,autoTranspose:y=!1}=p;let B=Boolean(T),D=Boolean(A),O=!1,N;if(m<w)if(!y)N=l.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{N=l.transpose(),m=N.rows,w=N.columns,O=!0;let le=B;B=D,D=le}else N=l.clone();let j=Math.min(m,w),G=Math.min(m+1,w),H=new Float64Array(G),te=new Matrix$2(m,j),oe=new Matrix$2(w,w),Q=new Float64Array(w),_e=new Float64Array(m),se=new Float64Array(G);for(let le=0;le<G;le++)se[le]=le;let he=Math.min(m-1,w),me=Math.max(0,Math.min(w-2,m)),Re=Math.max(he,me);for(let le=0;le<Re;le++){if(le<he){H[le]=0;for(let pe=le;pe<m;pe++)H[le]=hypotenuse$1(H[le],N.get(pe,le));if(H[le]!==0){N.get(le,le)<0&&(H[le]=-H[le]);for(let pe=le;pe<m;pe++)N.set(pe,le,N.get(pe,le)/H[le]);N.set(le,le,N.get(le,le)+1)}H[le]=-H[le]}for(let pe=le+1;pe<w;pe++){if(le<he&&H[le]!==0){let Le=0;for(let Ze=le;Ze<m;Ze++)Le+=N.get(Ze,le)*N.get(Ze,pe);Le=-Le/N.get(le,le);for(let Ze=le;Ze<m;Ze++)N.set(Ze,pe,N.get(Ze,pe)+Le*N.get(Ze,le))}Q[pe]=N.get(le,pe)}if(B&&le<he)for(let pe=le;pe<m;pe++)te.set(pe,le,N.get(pe,le));if(le<me){Q[le]=0;for(let pe=le+1;pe<w;pe++)Q[le]=hypotenuse$1(Q[le],Q[pe]);if(Q[le]!==0){Q[le+1]<0&&(Q[le]=0-Q[le]);for(let pe=le+1;pe<w;pe++)Q[pe]/=Q[le];Q[le+1]+=1}if(Q[le]=-Q[le],le+1<m&&Q[le]!==0){for(let pe=le+1;pe<m;pe++)_e[pe]=0;for(let pe=le+1;pe<m;pe++)for(let Le=le+1;Le<w;Le++)_e[pe]+=Q[Le]*N.get(pe,Le);for(let pe=le+1;pe<w;pe++){let Le=-Q[pe]/Q[le+1];for(let Ze=le+1;Ze<m;Ze++)N.set(Ze,pe,N.get(Ze,pe)+Le*_e[Ze])}}if(D)for(let pe=le+1;pe<w;pe++)oe.set(pe,le,Q[pe])}}let ge=Math.min(w,m+1);if(he<w&&(H[he]=N.get(he,he)),m<ge&&(H[ge-1]=0),me+1<ge&&(Q[me]=N.get(me,ge-1)),Q[ge-1]=0,B){for(let le=he;le<j;le++){for(let pe=0;pe<m;pe++)te.set(pe,le,0);te.set(le,le,1)}for(let le=he-1;le>=0;le--)if(H[le]!==0){for(let pe=le+1;pe<j;pe++){let Le=0;for(let Ze=le;Ze<m;Ze++)Le+=te.get(Ze,le)*te.get(Ze,pe);Le=-Le/te.get(le,le);for(let Ze=le;Ze<m;Ze++)te.set(Ze,pe,te.get(Ze,pe)+Le*te.get(Ze,le))}for(let pe=le;pe<m;pe++)te.set(pe,le,-te.get(pe,le));te.set(le,le,1+te.get(le,le));for(let pe=0;pe<le-1;pe++)te.set(pe,le,0)}else{for(let pe=0;pe<m;pe++)te.set(pe,le,0);te.set(le,le,1)}}if(D)for(let le=w-1;le>=0;le--){if(le<me&&Q[le]!==0)for(let pe=le+1;pe<w;pe++){let Le=0;for(let Ze=le+1;Ze<w;Ze++)Le+=oe.get(Ze,le)*oe.get(Ze,pe);Le=-Le/oe.get(le+1,le);for(let Ze=le+1;Ze<w;Ze++)oe.set(Ze,pe,oe.get(Ze,pe)+Le*oe.get(Ze,le))}for(let pe=0;pe<w;pe++)oe.set(pe,le,0);oe.set(le,le,1)}let ue=ge-1,Se=Number.EPSILON;for(;ge>0;){let le,pe;for(le=ge-2;le>=-1&&le!==-1;le--){const Le=Number.MIN_VALUE+Se*Math.abs(H[le]+Math.abs(H[le+1]));if(Math.abs(Q[le])<=Le||Number.isNaN(Q[le])){Q[le]=0;break}}if(le===ge-2)pe=4;else{let Le;for(Le=ge-1;Le>=le&&Le!==le;Le--){let Ze=(Le!==ge?Math.abs(Q[Le]):0)+(Le!==le+1?Math.abs(Q[Le-1]):0);if(Math.abs(H[Le])<=Se*Ze){H[Le]=0;break}}Le===le?pe=3:Le===ge-1?pe=1:(pe=2,le=Le)}switch(le++,pe){case 1:{let Le=Q[ge-2];Q[ge-2]=0;for(let Ze=ge-2;Ze>=le;Ze--){let lt=hypotenuse$1(H[Ze],Le),ct=H[Ze]/lt,$t=Le/lt;if(H[Ze]=lt,Ze!==le&&(Le=-$t*Q[Ze-1],Q[Ze-1]=ct*Q[Ze-1]),D)for(let Nt=0;Nt<w;Nt++)lt=ct*oe.get(Nt,Ze)+$t*oe.get(Nt,ge-1),oe.set(Nt,ge-1,-$t*oe.get(Nt,Ze)+ct*oe.get(Nt,ge-1)),oe.set(Nt,Ze,lt)}break}case 2:{let Le=Q[le-1];Q[le-1]=0;for(let Ze=le;Ze<ge;Ze++){let lt=hypotenuse$1(H[Ze],Le),ct=H[Ze]/lt,$t=Le/lt;if(H[Ze]=lt,Le=-$t*Q[Ze],Q[Ze]=ct*Q[Ze],B)for(let Nt=0;Nt<m;Nt++)lt=ct*te.get(Nt,Ze)+$t*te.get(Nt,le-1),te.set(Nt,le-1,-$t*te.get(Nt,Ze)+ct*te.get(Nt,le-1)),te.set(Nt,Ze,lt)}break}case 3:{const Le=Math.max(Math.abs(H[ge-1]),Math.abs(H[ge-2]),Math.abs(Q[ge-2]),Math.abs(H[le]),Math.abs(Q[le])),Ze=H[ge-1]/Le,lt=H[ge-2]/Le,ct=Q[ge-2]/Le,$t=H[le]/Le,Nt=Q[le]/Le,St=((lt+Ze)*(lt-Ze)+ct*ct)/2,Gt=Ze*ct*(Ze*ct);let Dt=0;(St!==0||Gt!==0)&&(St<0?Dt=0-Math.sqrt(St*St+Gt):Dt=Math.sqrt(St*St+Gt),Dt=Gt/(St+Dt));let Ut=($t+Ze)*($t-Ze)+Dt,Xt=$t*Nt;for(let ft=le;ft<ge-1;ft++){let wt=hypotenuse$1(Ut,Xt);wt===0&&(wt=Number.MIN_VALUE);let bt=Ut/wt,zt=Xt/wt;if(ft!==le&&(Q[ft-1]=wt),Ut=bt*H[ft]+zt*Q[ft],Q[ft]=bt*Q[ft]-zt*H[ft],Xt=zt*H[ft+1],H[ft+1]=bt*H[ft+1],D)for(let qt=0;qt<w;qt++)wt=bt*oe.get(qt,ft)+zt*oe.get(qt,ft+1),oe.set(qt,ft+1,-zt*oe.get(qt,ft)+bt*oe.get(qt,ft+1)),oe.set(qt,ft,wt);if(wt=hypotenuse$1(Ut,Xt),wt===0&&(wt=Number.MIN_VALUE),bt=Ut/wt,zt=Xt/wt,H[ft]=wt,Ut=bt*Q[ft]+zt*H[ft+1],H[ft+1]=-zt*Q[ft]+bt*H[ft+1],Xt=zt*Q[ft+1],Q[ft+1]=bt*Q[ft+1],B&&ft<m-1)for(let qt=0;qt<m;qt++)wt=bt*te.get(qt,ft)+zt*te.get(qt,ft+1),te.set(qt,ft+1,-zt*te.get(qt,ft)+bt*te.get(qt,ft+1)),te.set(qt,ft,wt)}Q[ge-2]=Ut;break}case 4:{if(H[le]<=0&&(H[le]=H[le]<0?-H[le]:0,D))for(let Le=0;Le<=ue;Le++)oe.set(Le,le,-oe.get(Le,le));for(;le<ue&&!(H[le]>=H[le+1]);){let Le=H[le];if(H[le]=H[le+1],H[le+1]=Le,D&&le<w-1)for(let Ze=0;Ze<w;Ze++)Le=oe.get(Ze,le+1),oe.set(Ze,le+1,oe.get(Ze,le)),oe.set(Ze,le,Le);if(B&&le<m-1)for(let Ze=0;Ze<m;Ze++)Le=te.get(Ze,le+1),te.set(Ze,le+1,te.get(Ze,le)),te.set(Ze,le,Le);le++}ge--;break}}}if(O){let le=oe;oe=te,te=le}this.m=m,this.n=w,this.s=H,this.U=te,this.V=oe}solve(l){let p=l,m=this.threshold,w=this.s.length,T=Matrix$2.zeros(w,w);for(let j=0;j<w;j++)Math.abs(this.s[j])<=m?T.set(j,j,0):T.set(j,j,1/this.s[j]);let A=this.U,y=this.rightSingularVectors,B=y.mmul(T),D=y.rows,O=A.rows,N=Matrix$2.zeros(D,O);for(let j=0;j<D;j++)for(let G=0;G<O;G++){let H=0;for(let te=0;te<w;te++)H+=B.get(j,te)*A.get(G,te);N.set(j,G,H)}return N.mmul(p)}solveForDiagonal(l){return this.solve(Matrix$2.diag(l))}inverse(){let l=this.V,p=this.threshold,m=l.rows,w=l.columns,T=new Matrix$2(m,this.s.length);for(let O=0;O<m;O++)for(let N=0;N<w;N++)Math.abs(this.s[N])>p&&T.set(O,N,l.get(O,N)/this.s[N]);let A=this.U,y=A.rows,B=A.columns,D=new Matrix$2(m,y);for(let O=0;O<m;O++)for(let N=0;N<y;N++){let j=0;for(let G=0;G<B;G++)j+=T.get(O,G)*A.get(N,G);D.set(O,N,j)}return D}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let l=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,p=0,m=this.s;for(let w=0,T=m.length;w<T;w++)m[w]>l&&p++;return p}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return Matrix$2.diag(this.s)}}function inverse(h,l=!1){return h=WrapperMatrix2D.checkMatrix(h),l?new SingularValueDecomposition(h).inverse():solve(h,Matrix$2.eye(h.rows))}function solve(h,l,p=!1){return h=WrapperMatrix2D.checkMatrix(h),l=WrapperMatrix2D.checkMatrix(l),p?new SingularValueDecomposition(h).solve(l):h.isSquare()?new LuDecomposition(h).solve(l):new QrDecomposition(h).solve(l)}function determinant(h){if(h=Matrix$2.checkMatrix(h),h.isSquare()){if(h.columns===0)return 1;let l,p,m,w;if(h.columns===2)return l=h.get(0,0),p=h.get(0,1),m=h.get(1,0),w=h.get(1,1),l*w-p*m;if(h.columns===3){let T,A,y;return T=new MatrixSelectionView(h,[1,2],[1,2]),A=new MatrixSelectionView(h,[1,2],[0,2]),y=new MatrixSelectionView(h,[1,2],[0,1]),l=h.get(0,0),p=h.get(0,1),m=h.get(0,2),l*determinant(T)-p*determinant(A)+m*determinant(y)}else return new LuDecomposition(h).determinant}else throw Error("determinant can only be calculated for a square matrix")}function xrange(h,l){let p=[];for(let m=0;m<h;m++)m!==l&&p.push(m);return p}function dependenciesOneRow(h,l,p,m=1e-9,w=1e-9){if(h>w)return new Array(l.rows+1).fill(0);{let T=l.addRow(p,[0]);for(let A=0;A<T.rows;A++)Math.abs(T.get(A,0))<m&&T.set(A,0,0);return T.to1DArray()}}function linearDependencies(h,l={}){const{thresholdValue:p=1e-9,thresholdError:m=1e-9}=l;h=Matrix$2.checkMatrix(h);let w=h.rows,T=new Matrix$2(w,w);for(let A=0;A<w;A++){let y=Matrix$2.columnVector(h.getRow(A)),B=h.subMatrixRow(xrange(w,A)).transpose(),O=new SingularValueDecomposition(B).solve(y),N=Matrix$2.sub(y,B.mmul(O)).abs().max();T.setRow(A,dependenciesOneRow(N,O,A,p,m))}return T}function pseudoInverse(h,l=Number.EPSILON){if(h=Matrix$2.checkMatrix(h),h.isEmpty())return h.transpose();let p=new SingularValueDecomposition(h,{autoTranspose:!0}),m=p.leftSingularVectors,w=p.rightSingularVectors,T=p.diagonal;for(let A=0;A<T.length;A++)Math.abs(T[A])>l?T[A]=1/T[A]:T[A]=0;return w.mmul(Matrix$2.diag(T).mmul(m.transpose()))}function covariance(h,l=h,p={}){h=new Matrix$2(h);let m=!1;if(typeof l=="object"&&!Matrix$2.isMatrix(l)&&!Array.isArray(l)?(p=l,l=h,m=!0):l=new Matrix$2(l),h.rows!==l.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:w=!0}=p;w&&(h=h.center("column"),m||(l=l.center("column")));const T=h.transpose().mmul(l);for(let A=0;A<T.rows;A++)for(let y=0;y<T.columns;y++)T.set(A,y,T.get(A,y)*(1/(h.rows-1)));return T}function correlation(h,l=h,p={}){h=new Matrix$2(h);let m=!1;if(typeof l=="object"&&!Matrix$2.isMatrix(l)&&!Array.isArray(l)?(p=l,l=h,m=!0):l=new Matrix$2(l),h.rows!==l.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:w=!0,scale:T=!0}=p;w&&(h.center("column"),m||l.center("column")),T&&(h.scale("column"),m||l.scale("column"));const A=h.standardDeviation("column",{unbiased:!0}),y=m?A:l.standardDeviation("column",{unbiased:!0}),B=h.transpose().mmul(l);for(let D=0;D<B.rows;D++)for(let O=0;O<B.columns;O++)B.set(D,O,B.get(D,O)*(1/(A[D]*y[O]))*(1/(h.rows-1)));return B}class EigenvalueDecomposition{constructor(l,p={}){const{assumeSymmetric:m=!1}=p;if(l=WrapperMatrix2D.checkMatrix(l),!l.isSquare())throw new Error("Matrix is not a square matrix");if(l.isEmpty())throw new Error("Matrix must be non-empty");let w=l.columns,T=new Matrix$2(w,w),A=new Float64Array(w),y=new Float64Array(w),B=l,D,O,N=!1;if(m?N=!0:N=l.isSymmetric(),N){for(D=0;D<w;D++)for(O=0;O<w;O++)T.set(D,O,B.get(D,O));tred2(w,y,A,T),tql2(w,y,A,T)}else{let j=new Matrix$2(w,w),G=new Float64Array(w);for(O=0;O<w;O++)for(D=0;D<w;D++)j.set(D,O,B.get(D,O));orthes(w,j,G,T),hqr2(w,y,A,T,j)}this.n=w,this.e=y,this.d=A,this.V=T}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let l=this.n,p=this.e,m=this.d,w=new Matrix$2(l,l),T,A;for(T=0;T<l;T++){for(A=0;A<l;A++)w.set(T,A,0);w.set(T,T,m[T]),p[T]>0?w.set(T,T+1,p[T]):p[T]<0&&w.set(T,T-1,p[T])}return w}}function tred2(h,l,p,m){let w,T,A,y,B,D,O,N;for(B=0;B<h;B++)p[B]=m.get(h-1,B);for(y=h-1;y>0;y--){for(N=0,A=0,D=0;D<y;D++)N=N+Math.abs(p[D]);if(N===0)for(l[y]=p[y-1],B=0;B<y;B++)p[B]=m.get(y-1,B),m.set(y,B,0),m.set(B,y,0);else{for(D=0;D<y;D++)p[D]/=N,A+=p[D]*p[D];for(w=p[y-1],T=Math.sqrt(A),w>0&&(T=-T),l[y]=N*T,A=A-w*T,p[y-1]=w-T,B=0;B<y;B++)l[B]=0;for(B=0;B<y;B++){for(w=p[B],m.set(B,y,w),T=l[B]+m.get(B,B)*w,D=B+1;D<=y-1;D++)T+=m.get(D,B)*p[D],l[D]+=m.get(D,B)*w;l[B]=T}for(w=0,B=0;B<y;B++)l[B]/=A,w+=l[B]*p[B];for(O=w/(A+A),B=0;B<y;B++)l[B]-=O*p[B];for(B=0;B<y;B++){for(w=p[B],T=l[B],D=B;D<=y-1;D++)m.set(D,B,m.get(D,B)-(w*l[D]+T*p[D]));p[B]=m.get(y-1,B),m.set(y,B,0)}}p[y]=A}for(y=0;y<h-1;y++){if(m.set(h-1,y,m.get(y,y)),m.set(y,y,1),A=p[y+1],A!==0){for(D=0;D<=y;D++)p[D]=m.get(D,y+1)/A;for(B=0;B<=y;B++){for(T=0,D=0;D<=y;D++)T+=m.get(D,y+1)*m.get(D,B);for(D=0;D<=y;D++)m.set(D,B,m.get(D,B)-T*p[D])}}for(D=0;D<=y;D++)m.set(D,y+1,0)}for(B=0;B<h;B++)p[B]=m.get(h-1,B),m.set(h-1,B,0);m.set(h-1,h-1,1),l[0]=0}function tql2(h,l,p,m){let w,T,A,y,B,D,O,N,j,G,H,te,oe,Q,_e,se;for(A=1;A<h;A++)l[A-1]=l[A];l[h-1]=0;let he=0,me=0,Re=Number.EPSILON;for(D=0;D<h;D++){for(me=Math.max(me,Math.abs(p[D])+Math.abs(l[D])),O=D;O<h&&!(Math.abs(l[O])<=Re*me);)O++;if(O>D)do{for(w=p[D],N=(p[D+1]-w)/(2*l[D]),j=hypotenuse$1(N,1),N<0&&(j=-j),p[D]=l[D]/(N+j),p[D+1]=l[D]*(N+j),G=p[D+1],T=w-p[D],A=D+2;A<h;A++)p[A]-=T;for(he=he+T,N=p[O],H=1,te=H,oe=H,Q=l[D+1],_e=0,se=0,A=O-1;A>=D;A--)for(oe=te,te=H,se=_e,w=H*l[A],T=H*N,j=hypotenuse$1(N,l[A]),l[A+1]=_e*j,_e=l[A]/j,H=N/j,N=H*p[A]-_e*w,p[A+1]=T+_e*(H*w+_e*p[A]),B=0;B<h;B++)T=m.get(B,A+1),m.set(B,A+1,_e*m.get(B,A)+H*T),m.set(B,A,H*m.get(B,A)-_e*T);N=-_e*se*oe*Q*l[D]/G,l[D]=_e*N,p[D]=H*N}while(Math.abs(l[D])>Re*me);p[D]=p[D]+he,l[D]=0}for(A=0;A<h-1;A++){for(B=A,N=p[A],y=A+1;y<h;y++)p[y]<N&&(B=y,N=p[y]);if(B!==A)for(p[B]=p[A],p[A]=N,y=0;y<h;y++)N=m.get(y,A),m.set(y,A,m.get(y,B)),m.set(y,B,N)}}function orthes(h,l,p,m){let w=0,T=h-1,A,y,B,D,O,N,j;for(N=w+1;N<=T-1;N++){for(j=0,D=N;D<=T;D++)j=j+Math.abs(l.get(D,N-1));if(j!==0){for(B=0,D=T;D>=N;D--)p[D]=l.get(D,N-1)/j,B+=p[D]*p[D];for(y=Math.sqrt(B),p[N]>0&&(y=-y),B=B-p[N]*y,p[N]=p[N]-y,O=N;O<h;O++){for(A=0,D=T;D>=N;D--)A+=p[D]*l.get(D,O);for(A=A/B,D=N;D<=T;D++)l.set(D,O,l.get(D,O)-A*p[D])}for(D=0;D<=T;D++){for(A=0,O=T;O>=N;O--)A+=p[O]*l.get(D,O);for(A=A/B,O=N;O<=T;O++)l.set(D,O,l.get(D,O)-A*p[O])}p[N]=j*p[N],l.set(N,N-1,j*y)}}for(D=0;D<h;D++)for(O=0;O<h;O++)m.set(D,O,D===O?1:0);for(N=T-1;N>=w+1;N--)if(l.get(N,N-1)!==0){for(D=N+1;D<=T;D++)p[D]=l.get(D,N-1);for(O=N;O<=T;O++){for(y=0,D=N;D<=T;D++)y+=p[D]*m.get(D,O);for(y=y/p[N]/l.get(N,N-1),D=N;D<=T;D++)m.set(D,O,m.get(D,O)+y*p[D])}}}function hqr2(h,l,p,m,w){let T=h-1,A=0,y=h-1,B=Number.EPSILON,D=0,O=0,N=0,j=0,G=0,H=0,te=0,oe=0,Q,_e,se,he,me,Re,ge,ue,Se,le,pe,Le,Ze,lt,ct;for(Q=0;Q<h;Q++)for((Q<A||Q>y)&&(p[Q]=w.get(Q,Q),l[Q]=0),_e=Math.max(Q-1,0);_e<h;_e++)O=O+Math.abs(w.get(Q,_e));for(;T>=A;){for(he=T;he>A&&(H=Math.abs(w.get(he-1,he-1))+Math.abs(w.get(he,he)),H===0&&(H=O),!(Math.abs(w.get(he,he-1))<B*H));)he--;if(he===T)w.set(T,T,w.get(T,T)+D),p[T]=w.get(T,T),l[T]=0,T--,oe=0;else if(he===T-1){if(ge=w.get(T,T-1)*w.get(T-1,T),N=(w.get(T-1,T-1)-w.get(T,T))/2,j=N*N+ge,te=Math.sqrt(Math.abs(j)),w.set(T,T,w.get(T,T)+D),w.set(T-1,T-1,w.get(T-1,T-1)+D),ue=w.get(T,T),j>=0){for(te=N>=0?N+te:N-te,p[T-1]=ue+te,p[T]=p[T-1],te!==0&&(p[T]=ue-ge/te),l[T-1]=0,l[T]=0,ue=w.get(T,T-1),H=Math.abs(ue)+Math.abs(te),N=ue/H,j=te/H,G=Math.sqrt(N*N+j*j),N=N/G,j=j/G,_e=T-1;_e<h;_e++)te=w.get(T-1,_e),w.set(T-1,_e,j*te+N*w.get(T,_e)),w.set(T,_e,j*w.get(T,_e)-N*te);for(Q=0;Q<=T;Q++)te=w.get(Q,T-1),w.set(Q,T-1,j*te+N*w.get(Q,T)),w.set(Q,T,j*w.get(Q,T)-N*te);for(Q=A;Q<=y;Q++)te=m.get(Q,T-1),m.set(Q,T-1,j*te+N*m.get(Q,T)),m.set(Q,T,j*m.get(Q,T)-N*te)}else p[T-1]=ue+N,p[T]=ue+N,l[T-1]=te,l[T]=-te;T=T-2,oe=0}else{if(ue=w.get(T,T),Se=0,ge=0,he<T&&(Se=w.get(T-1,T-1),ge=w.get(T,T-1)*w.get(T-1,T)),oe===10){for(D+=ue,Q=A;Q<=T;Q++)w.set(Q,Q,w.get(Q,Q)-ue);H=Math.abs(w.get(T,T-1))+Math.abs(w.get(T-1,T-2)),ue=Se=.75*H,ge=-.4375*H*H}if(oe===30&&(H=(Se-ue)/2,H=H*H+ge,H>0)){for(H=Math.sqrt(H),Se<ue&&(H=-H),H=ue-ge/((Se-ue)/2+H),Q=A;Q<=T;Q++)w.set(Q,Q,w.get(Q,Q)-H);D+=H,ue=Se=ge=.964}for(oe=oe+1,me=T-2;me>=he&&(te=w.get(me,me),G=ue-te,H=Se-te,N=(G*H-ge)/w.get(me+1,me)+w.get(me,me+1),j=w.get(me+1,me+1)-te-G-H,G=w.get(me+2,me+1),H=Math.abs(N)+Math.abs(j)+Math.abs(G),N=N/H,j=j/H,G=G/H,!(me===he||Math.abs(w.get(me,me-1))*(Math.abs(j)+Math.abs(G))<B*(Math.abs(N)*(Math.abs(w.get(me-1,me-1))+Math.abs(te)+Math.abs(w.get(me+1,me+1))))));)me--;for(Q=me+2;Q<=T;Q++)w.set(Q,Q-2,0),Q>me+2&&w.set(Q,Q-3,0);for(se=me;se<=T-1&&(lt=se!==T-1,se!==me&&(N=w.get(se,se-1),j=w.get(se+1,se-1),G=lt?w.get(se+2,se-1):0,ue=Math.abs(N)+Math.abs(j)+Math.abs(G),ue!==0&&(N=N/ue,j=j/ue,G=G/ue)),ue!==0);se++)if(H=Math.sqrt(N*N+j*j+G*G),N<0&&(H=-H),H!==0){for(se!==me?w.set(se,se-1,-H*ue):he!==me&&w.set(se,se-1,-w.get(se,se-1)),N=N+H,ue=N/H,Se=j/H,te=G/H,j=j/N,G=G/N,_e=se;_e<h;_e++)N=w.get(se,_e)+j*w.get(se+1,_e),lt&&(N=N+G*w.get(se+2,_e),w.set(se+2,_e,w.get(se+2,_e)-N*te)),w.set(se,_e,w.get(se,_e)-N*ue),w.set(se+1,_e,w.get(se+1,_e)-N*Se);for(Q=0;Q<=Math.min(T,se+3);Q++)N=ue*w.get(Q,se)+Se*w.get(Q,se+1),lt&&(N=N+te*w.get(Q,se+2),w.set(Q,se+2,w.get(Q,se+2)-N*G)),w.set(Q,se,w.get(Q,se)-N),w.set(Q,se+1,w.get(Q,se+1)-N*j);for(Q=A;Q<=y;Q++)N=ue*m.get(Q,se)+Se*m.get(Q,se+1),lt&&(N=N+te*m.get(Q,se+2),m.set(Q,se+2,m.get(Q,se+2)-N*G)),m.set(Q,se,m.get(Q,se)-N),m.set(Q,se+1,m.get(Q,se+1)-N*j)}}}if(O!==0){for(T=h-1;T>=0;T--)if(N=p[T],j=l[T],j===0)for(he=T,w.set(T,T,1),Q=T-1;Q>=0;Q--){for(ge=w.get(Q,Q)-N,G=0,_e=he;_e<=T;_e++)G=G+w.get(Q,_e)*w.get(_e,T);if(l[Q]<0)te=ge,H=G;else if(he=Q,l[Q]===0?w.set(Q,T,ge!==0?-G/ge:-G/(B*O)):(ue=w.get(Q,Q+1),Se=w.get(Q+1,Q),j=(p[Q]-N)*(p[Q]-N)+l[Q]*l[Q],Re=(ue*H-te*G)/j,w.set(Q,T,Re),w.set(Q+1,T,Math.abs(ue)>Math.abs(te)?(-G-ge*Re)/ue:(-H-Se*Re)/te)),Re=Math.abs(w.get(Q,T)),B*Re*Re>1)for(_e=Q;_e<=T;_e++)w.set(_e,T,w.get(_e,T)/Re)}else if(j<0)for(he=T-1,Math.abs(w.get(T,T-1))>Math.abs(w.get(T-1,T))?(w.set(T-1,T-1,j/w.get(T,T-1)),w.set(T-1,T,-(w.get(T,T)-N)/w.get(T,T-1))):(ct=cdiv(0,-w.get(T-1,T),w.get(T-1,T-1)-N,j),w.set(T-1,T-1,ct[0]),w.set(T-1,T,ct[1])),w.set(T,T-1,0),w.set(T,T,1),Q=T-2;Q>=0;Q--){for(le=0,pe=0,_e=he;_e<=T;_e++)le=le+w.get(Q,_e)*w.get(_e,T-1),pe=pe+w.get(Q,_e)*w.get(_e,T);if(ge=w.get(Q,Q)-N,l[Q]<0)te=ge,G=le,H=pe;else if(he=Q,l[Q]===0?(ct=cdiv(-le,-pe,ge,j),w.set(Q,T-1,ct[0]),w.set(Q,T,ct[1])):(ue=w.get(Q,Q+1),Se=w.get(Q+1,Q),Le=(p[Q]-N)*(p[Q]-N)+l[Q]*l[Q]-j*j,Ze=(p[Q]-N)*2*j,Le===0&&Ze===0&&(Le=B*O*(Math.abs(ge)+Math.abs(j)+Math.abs(ue)+Math.abs(Se)+Math.abs(te))),ct=cdiv(ue*G-te*le+j*pe,ue*H-te*pe-j*le,Le,Ze),w.set(Q,T-1,ct[0]),w.set(Q,T,ct[1]),Math.abs(ue)>Math.abs(te)+Math.abs(j)?(w.set(Q+1,T-1,(-le-ge*w.get(Q,T-1)+j*w.get(Q,T))/ue),w.set(Q+1,T,(-pe-ge*w.get(Q,T)-j*w.get(Q,T-1))/ue)):(ct=cdiv(-G-Se*w.get(Q,T-1),-H-Se*w.get(Q,T),te,j),w.set(Q+1,T-1,ct[0]),w.set(Q+1,T,ct[1]))),Re=Math.max(Math.abs(w.get(Q,T-1)),Math.abs(w.get(Q,T))),B*Re*Re>1)for(_e=Q;_e<=T;_e++)w.set(_e,T-1,w.get(_e,T-1)/Re),w.set(_e,T,w.get(_e,T)/Re)}for(Q=0;Q<h;Q++)if(Q<A||Q>y)for(_e=Q;_e<h;_e++)m.set(Q,_e,w.get(Q,_e));for(_e=h-1;_e>=A;_e--)for(Q=A;Q<=y;Q++){for(te=0,se=A;se<=Math.min(_e,y);se++)te=te+m.get(Q,se)*w.get(se,_e);m.set(Q,_e,te)}}}function cdiv(h,l,p,m){let w,T;return Math.abs(p)>Math.abs(m)?(w=m/p,T=p+w*m,[(h+w*l)/T,(l-w*h)/T]):(w=p/m,T=m+w*p,[(w*h+l)/T,(w*l-h)/T])}class CholeskyDecomposition{constructor(l){if(l=WrapperMatrix2D.checkMatrix(l),!l.isSymmetric())throw new Error("Matrix is not symmetric");let p=l,m=p.rows,w=new Matrix$2(m,m),T=!0,A,y,B;for(y=0;y<m;y++){let D=0;for(B=0;B<y;B++){let O=0;for(A=0;A<B;A++)O+=w.get(B,A)*w.get(y,A);O=(p.get(y,B)-O)/w.get(B,B),w.set(y,B,O),D=D+O*O}for(D=p.get(y,y)-D,T&=D>0,w.set(y,y,Math.sqrt(Math.max(D,0))),B=y+1;B<m;B++)w.set(y,B,0)}this.L=w,this.positiveDefinite=Boolean(T)}isPositiveDefinite(){return this.positiveDefinite}solve(l){l=WrapperMatrix2D.checkMatrix(l);let p=this.L,m=p.rows;if(l.rows!==m)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let w=l.columns,T=l.clone(),A,y,B;for(B=0;B<m;B++)for(y=0;y<w;y++){for(A=0;A<B;A++)T.set(B,y,T.get(B,y)-T.get(A,y)*p.get(B,A));T.set(B,y,T.get(B,y)/p.get(B,B))}for(B=m-1;B>=0;B--)for(y=0;y<w;y++){for(A=B+1;A<m;A++)T.set(B,y,T.get(B,y)-T.get(A,y)*p.get(A,B));T.set(B,y,T.get(B,y)/p.get(B,B))}return T}get lowerTriangularMatrix(){return this.L}}class nipals{constructor(l,p={}){l=WrapperMatrix2D.checkMatrix(l);let{Y:m}=p;const{scaleScores:w=!1,maxIterations:T=1e3,terminationCriteria:A=1e-10}=p;let y;if(m){if(Array.isArray(m)&&typeof m[0]=="number"?m=Matrix$2.columnVector(m):m=WrapperMatrix2D.checkMatrix(m),m.rows!==l.rows)throw new Error("Y should have the same number of rows as X");y=m.getColumnVector(0)}else y=l.getColumnVector(0);let B=1,D,O,N,j;for(let G=0;G<T&&B>A;G++)N=l.transpose().mmul(y).div(y.transpose().mmul(y).get(0,0)),N=N.div(N.norm()),D=l.mmul(N).div(N.transpose().mmul(N).get(0,0)),G>0&&(B=D.clone().sub(j).pow(2).sum()),j=D.clone(),m?(O=m.transpose().mmul(D).div(D.transpose().mmul(D).get(0,0)),O=O.div(O.norm()),y=m.mmul(O).div(O.transpose().mmul(O).get(0,0))):y=D;if(m){let G=l.transpose().mmul(D).div(D.transpose().mmul(D).get(0,0));G=G.div(G.norm());let H=l.clone().sub(D.clone().mmul(G.transpose())),te=y.transpose().mmul(D).div(D.transpose().mmul(D).get(0,0)),oe=m.clone().sub(D.clone().mulS(te.get(0,0)).mmul(O.transpose()));this.t=D,this.p=G.transpose(),this.w=N.transpose(),this.q=O,this.u=y,this.s=D.transpose().mmul(D),this.xResidual=H,this.yResidual=oe,this.betas=te}else this.w=N.transpose(),this.s=D.transpose().mmul(D).sqrt(),w?this.t=D.clone().div(this.s.get(0,0)):this.t=D,this.xResidual=l.sub(D.mmul(N.transpose()))}}var src$1=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",AbstractMatrix,default:Matrix$2,Matrix:Matrix$2,wrap,WrapperMatrix1D,WrapperMatrix2D,solve,inverse,determinant,linearDependencies,pseudoInverse,covariance,correlation,SingularValueDecomposition,SVD:SingularValueDecomposition,EigenvalueDecomposition,EVD:EigenvalueDecomposition,CholeskyDecomposition,CHO:CholeskyDecomposition,LuDecomposition,LU:LuDecomposition,QrDecomposition,QR:QrDecomposition,Nipals:nipals,NIPALS:nipals,MatrixColumnView,MatrixColumnSelectionView,MatrixFlipColumnView,MatrixFlipRowView,MatrixRowView,MatrixRowSelectionView,MatrixSelectionView,MatrixSubView,MatrixTransposeView:MatrixTransposeView$1});function getSeparatedKernel(h){const l=new SingularValueDecomposition(h,{autoTranspose:!0});if(l.rank!==1)return null;const p=Math.sqrt(l.s[0]),m=l.U.to2DArray().map(T=>T[0]*p),w=l.V.to2DArray().map(T=>T[0]*p);return[m,w]}function convolution(h,l={}){let{channels:p,bitDepth:m,normalize:w=!1,divisor:T=1,border:A="copy",algorithm:y="auto"}=l,B={};m&&(B.bitDepth=m);let D=Image$1.createFrom(this,B);if(p=validateArrayOfChannels(this,p),y!=="separable")({kernel:h}=validateKernel(h));else if(!Array.isArray(h)||h.length!==2)throw new RangeError("separable convolution requires two arrays of numbers to represent the kernel");if(y==="auto"){let he=getSeparatedKernel(h);he!==null?(y="separable",h=he):(h.length>9||h[0].length>9)&&this.width<=4096&&this.height<=4096?y="fft":y="direct"}let O,N;y==="separable"?(O=Math.floor(h[0].length/2),N=Math.floor(h[1].length/2)):(O=Math.floor(h.length/2),N=Math.floor(h[0].length/2));let j=D.isClamped,G=new Array(this.height*this.width),H,te,oe,Q,_e,se;for(Q=0;Q<p.length;Q++){for(_e=p[Q],oe=0;oe<this.height;oe++)for(te=0;te<this.width;te++)H=oe*this.width+te,G[H]=this.data[H*this.channels+_e];if(y==="direct")se=src$2.direct(G,h,{rows:this.height,cols:this.width,normalize:w,divisor:T});else if(y==="separable"){if(se=convolutionSeparable(G,h,this.width,this.height),w){T=0;for(let he=0;he<h[0].length;he++)for(let me=0;me<h[1].length;me++)T+=h[0][he]*h[1][me]}if(T!==1)for(let he=0;he<se.length;he++)se[he]/=T}else se=src$2.fft(G,h,{rows:this.height,cols:this.width,normalize:w,divisor:T});for(oe=0;oe<this.height;oe++)for(te=0;te<this.width;te++)H=oe*this.width+te,j?D.data[H*this.channels+_e]=clamp(se[H],D):D.data[H*this.channels+_e]=se[H]}if(this.alpha&&!p.includes(this.channels))for(te=this.components;te<this.data.length;te=te+this.channels)D.data[te]=this.data[te];return A!=="periodic"&&D.setBorder({size:[N,O],algorithm:A}),D}function gradientFilter(h={}){let{direction:l="xy",border:p="copy",kernelX:m,kernelY:w,channels:T,bitDepth:A=this.bitDepth}=h;switch(this.checkProcessable("gradientFilter",{bitDepth:[8,16]}),l){case"x":if(!m)throw new Error("kernelX option is missing");return convolution.call(this,m,{channels:T,border:p,bitDepth:A});case"y":if(!w)throw new Error("kernelY option is missing");return convolution.call(this,w,{channels:T,border:p,bitDepth:A});case"xy":{if(!m)throw new Error("kernelX option is missing");if(!w)throw new Error("kernelY option is missing");const y=convolution.call(this,m,{channels:T,border:p,bitDepth:32}),B=convolution.call(this,w,{channels:T,border:p,bitDepth:32});return y.hypotenuse(B,{bitDepth:A,channels:T})}default:throw new Error(`Unknown parameter direction: ${l}`)}}function sobelFilter(h){return gradientFilter.call(this,Object.assign({},h,{kernelX:SOBEL_X,kernelY:SOBEL_Y}))}function scharrFilter(h){return gradientFilter.call(this,Object.assign({},h,{kernelX:SCHARR_X,kernelY:SCHARR_Y}))}var newArray_1=newArray;function newArray(h,l){h=h||0;for(var p=new Array(h),m=0;m<h;m++)p[m]=l;return p}function level(h={}){let{algorithm:l="range",channels:p,min:m=this.min,max:w=this.max}=h;switch(this.checkProcessable("level",{bitDepth:[8,16,32]}),p=validateArrayOfChannels(this,{channels:p}),p.length!==this.channel&&(Array.isArray(m)&&m.length===this.channels&&(m=m.filter((T,A)=>p.includes(A))),Array.isArray(w)&&w.length===this.channels&&(w=w.filter((T,A)=>p.includes(A)))),l){case"range":m<0&&(m=0),w>this.maxValue&&(w=this.maxValue),Array.isArray(m)||(m=newArray_1(p.length,m)),Array.isArray(w)||(w=newArray_1(p.length,w)),processImage(this,m,w,p);break;default:throw new Error(`level: algorithm not implement: ${l}`)}return this}function processImage(h,l,p,m){let w=1e-5,T=new Array(m.length);for(let A=0;A<m.length;A++)l[A]===0&&p[A]===h.maxValue||p[A]===l[A]?T[A]=0:T[A]=(h.maxValue+1-w)/(p[A]-l[A]),l[A]+=(.5-w/2)/T[A];for(let A=0;A<m.length;A++){let y=m[A];if(T[A]!==0)for(let B=0;B<h.data.length;B+=h.channels)h.data[B+y]=Math.min(Math.max(0,(h.data[B+y]-l[A])*T[A]+.5|0),h.maxValue)}}var toString$1=Object.prototype.toString,isArrayType=function h(l){return toString$1.call(l).substr(-6,5)==="Array"};function checkNumberArray(h){if(isNaN(h)){if(h instanceof Image$1)return h.data;if(!isArrayType(h))throw new Error("checkNumberArray: the value should be either a number, array or Image");return h}else{if(h<=0)throw new Error("checkNumberArray: the value must be greater than 0");return h}}function add(h,l={}){let{channels:p}=l;if(this.checkProcessable("add",{bitDepth:[8,16]}),p=validateArrayOfChannels(this,{channels:p}),h=checkNumberArray(h),isNaN(h)){if(this.data.length!==h.length)throw new Error("add: the data size is different");for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,Math.min(this.maxValue,this.data[T+w]+h[T+w]>>0))}}else for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.min(this.maxValue,this.data[T+w]+h>>0)}return this}function subtract(h,l={}){let{channels:p}=l;if(this.checkProcessable("subtract",{bitDepth:[8,16]}),p=validateArrayOfChannels(this,{channels:p}),h=checkNumberArray(h),isNaN(h)){if(this.data.length!==h.length)throw new Error("subtract: the data size is different");for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,Math.min(this.maxValue,this.data[T+w]-h[T+w]>>0))}}else for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,this.data[T+w]-h>>0)}return this}function subtractImage(h,l={}){let{channels:p,absolute:m=!1}=l;if(this.checkProcessable("subtractImage",{bitDepth:[8,16]}),this.width!==h.width||this.height!==h.height)throw new Error("subtractImage: both images must have the same size");if(this.alpha!==h.alpha||this.bitDepth!==h.bitDepth)throw new Error("subtractImage: both images must have the same alpha and bitDepth");if(this.channels!==h.channels)throw new Error("subtractImage: both images must have the same number of channels");let w=this.clone();p=validateArrayOfChannels(this,{channels:p});for(let T=0;T<p.length;T++){let A=p[T];for(let y=A;y<this.data.length;y+=this.channels){let B=this.data[y]-h.data[y];m?w.data[y]=Math.abs(B):w.data[y]=Math.max(B,0)}}return w}function hypotenuse(h,l={}){let{bitDepth:p=this.bitDepth,channels:m}=l;if(this.checkProcessable("hypotenuse",{bitDepth:[8,16,32]}),this.width!==h.width||this.height!==h.height)throw new Error("hypotenuse: both images must have the same size");if(this.alpha!==h.alpha||this.bitDepth!==h.bitDepth)throw new Error("hypotenuse: both images must have the same alpha and bitDepth");if(this.channels!==h.channels)throw new Error("hypotenuse: both images must have the same number of channels");let w=Image$1.createFrom(this,{bitDepth:p});m=validateArrayOfChannels(this,{channels:m});let T=w.isClamped;for(let A=0;A<m.length;A++){let y=m[A];for(let B=y;B<this.data.length;B+=this.channels){let D=Math.hypot(this.data[B],h.data[B]);T?w.data[B]=Math.min(Math.max(Math.round(D),0),w.maxValue):w.data[B]=D}}return w}function multiply(h,l={}){let{channels:p}=l;if(this.checkProcessable("multiply",{bitDepth:[8,16]}),h<=0)throw new Error("multiply: the value must be greater than 0");if(p=validateArrayOfChannels(this,{channels:p}),h=checkNumberArray(h),isNaN(h)){if(this.data.length!==h.length)throw new Error("multiply: the data size is different");for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,Math.min(this.maxValue,this.data[T+w]*h[T+w]>>0))}}else for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.min(this.maxValue,this.data[T+w]*h>>0)}return this}function divide(h,l={}){let{channels:p}=l;if(this.checkProcessable("divide",{bitDepth:[8,16]}),p=validateArrayOfChannels(this,{channels:p}),h=checkNumberArray(h),isNaN(h)){if(this.data.length!==h.length)throw new Error("divide: the: the data size is different");for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,Math.min(this.maxValue,this.data[T+w]/h[T+w]>>0))}}else for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.min(this.maxValue,this.data[T+w]/h>>0)}return this}class BaseRegression{constructor(){if(new.target===BaseRegression)throw new Error("BaseRegression must be subclassed")}predict(l){if(typeof l=="number")return this._predict(l);if(isAnyArray(l)){const p=[];for(let m=0;m<l.length;m++)p.push(this._predict(l[m]));return p}else throw new TypeError("x must be a number or array")}_predict(){throw new Error("_predict must be implemented")}train(){}toString(){return""}toLaTeX(){return""}score(l,p){if(!isAnyArray(l)||!isAnyArray(p)||l.length!==p.length)throw new Error("x and y must be arrays of the same length");const m=l.length,w=new Array(m);for(let G=0;G<m;G++)w[G]=this._predict(l[G]);let T=0,A=0,y=0,B=0,D=0,O=0,N=0;for(let G=0;G<m;G++)T+=w[G],A+=p[G],D+=w[G]*w[G],O+=p[G]*p[G],N+=w[G]*p[G],p[G]!==0&&(y+=(p[G]-w[G])*(p[G]-w[G])/p[G]),B+=(p[G]-w[G])*(p[G]-w[G]);const j=(m*N-T*A)/Math.sqrt((m*D-T*T)*(m*O-A*A));return{r:j,r2:j*j,chi2:y,rmsd:Math.sqrt(B/m)}}}var require$$0$1=getAugmentedNamespace(src$1);function squaredEuclidean$4(h,l){let p=0;for(let m=0;m<h.length;m++)p+=(h[m]-l[m])*(h[m]-l[m]);return p}function euclidean$2(h,l){return Math.sqrt(squaredEuclidean$4(h,l))}var euclidean$3=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",squaredEuclidean:squaredEuclidean$4,euclidean:euclidean$2}),require$$0=getAugmentedNamespace(euclidean$3);const{squaredEuclidean:squaredEuclidean$3}=require$$0,defaultOptions$b={sigma:1};class GaussianKernel$1{constructor(l){l=Object.assign({},defaultOptions$b,l),this.sigma=l.sigma,this.divisor=2*l.sigma*l.sigma}compute(l,p){const m=squaredEuclidean$3(l,p);return Math.exp(-m/this.divisor)}}var gaussianKernel=GaussianKernel$1;const defaultOptions$a={degree:1,constant:1,scale:1};class PolynomialKernel$1{constructor(l){l=Object.assign({},defaultOptions$a,l),this.degree=l.degree,this.constant=l.constant,this.scale=l.scale}compute(l,p){for(var m=0,w=0;w<l.length;w++)m+=l[w]*p[w];return Math.pow(this.scale*m+this.constant,this.degree)}}var polynomialKernel=PolynomialKernel$1;const defaultOptions$9={alpha:.01,constant:-Math.E};class SigmoidKernel$1{constructor(l){l=Object.assign({},defaultOptions$9,l),this.alpha=l.alpha,this.constant=l.constant}compute(l,p){for(var m=0,w=0;w<l.length;w++)m+=l[w]*p[w];return Math.tanh(this.alpha*m+this.constant)}}var sigmoidKernel=SigmoidKernel$1;const defaultOptions$8={sigma:1,degree:1};class ANOVAKernel$1{constructor(l){l=Object.assign({},defaultOptions$8,l),this.sigma=l.sigma,this.degree=l.degree}compute(l,p){for(var m=0,w=Math.min(l.length,p.length),T=1;T<=w;++T)m+=Math.pow(Math.exp(-this.sigma*Math.pow(Math.pow(l[T-1],T)-Math.pow(p[T-1],T),2)),this.degree);return m}}var anovaKernel=ANOVAKernel$1;const{squaredEuclidean:squaredEuclidean$2}=require$$0,defaultOptions$7={sigma:1};class CauchyKernel$1{constructor(l){l=Object.assign({},defaultOptions$7,l),this.sigma=l.sigma}compute(l,p){return 1/(1+squaredEuclidean$2(l,p)/(this.sigma*this.sigma))}}var cauchyKernel=CauchyKernel$1;const{euclidean:euclidean$1}=require$$0,defaultOptions$6={sigma:1};class ExponentialKernel$1{constructor(l){l=Object.assign({},defaultOptions$6,l),this.sigma=l.sigma,this.divisor=2*l.sigma*l.sigma}compute(l,p){const m=euclidean$1(l,p);return Math.exp(-m/this.divisor)}}var exponentialKernel=ExponentialKernel$1;class HistogramIntersectionKernel{compute(l,p){for(var m=Math.min(l.length,p.length),w=0,T=0;T<m;++T)w+=Math.min(l[T],p[T]);return w}}var histogramIntersectionKernel=HistogramIntersectionKernel;const{euclidean}=require$$0,defaultOptions$5={sigma:1};class LaplacianKernel$1{constructor(l){l=Object.assign({},defaultOptions$5,l),this.sigma=l.sigma}compute(l,p){const m=euclidean(l,p);return Math.exp(-m/this.sigma)}}var laplacianKernel=LaplacianKernel$1;const{squaredEuclidean:squaredEuclidean$1}=require$$0,defaultOptions$4={constant:1};class MultiquadraticKernel$1{constructor(l){l=Object.assign({},defaultOptions$4,l),this.constant=l.constant}compute(l,p){return Math.sqrt(squaredEuclidean$1(l,p)+this.constant*this.constant)}}var multiquadraticKernel=MultiquadraticKernel$1;const{squaredEuclidean}=require$$0,defaultOptions$3={constant:1};class RationalQuadraticKernel{constructor(l){l=Object.assign({},defaultOptions$3,l),this.constant=l.constant}compute(l,p){const m=squaredEuclidean(l,p);return 1-m/(m+this.constant)}}var rationalQuadraticKernel=RationalQuadraticKernel;const{Matrix:Matrix$1,MatrixTransposeView}=require$$0$1,GaussianKernel=gaussianKernel,PolynomialKernel=polynomialKernel,SigmoidKernel=sigmoidKernel,ANOVAKernel=anovaKernel,CauchyKernel=cauchyKernel,ExponentialKernel=exponentialKernel,HistogramKernel=histogramIntersectionKernel,LaplacianKernel=laplacianKernel,MultiquadraticKernel=multiquadraticKernel,RationalKernel=rationalQuadraticKernel,kernelType={gaussian:GaussianKernel,rbf:GaussianKernel,polynomial:PolynomialKernel,poly:PolynomialKernel,anova:ANOVAKernel,cauchy:CauchyKernel,exponential:ExponentialKernel,histogram:HistogramKernel,min:HistogramKernel,laplacian:LaplacianKernel,multiquadratic:MultiquadraticKernel,rational:RationalKernel,sigmoid:SigmoidKernel,mlp:SigmoidKernel};class Kernel{constructor(l,p){if(this.kernelType=l,l!=="linear")if(typeof l=="string"){l=l.toLowerCase();var m=kernelType[l];if(m)this.kernelFunction=new m(p);else throw new Error(`unsupported kernel type: ${l}`)}else if(typeof l=="object"&&typeof l.compute=="function")this.kernelFunction=l;else throw new TypeError("first argument must be a valid kernel type or instance")}compute(l,p){if(l=Matrix$1.checkMatrix(l),p===void 0?p=l:p=Matrix$1.checkMatrix(p),this.kernelType==="linear")return l.mmul(new MatrixTransposeView(p));const m=new Matrix$1(l.rows,p.rows);if(l===p)for(let w=0;w<l.rows;w++)for(let T=w;T<l.rows;T++){const A=this.kernelFunction.compute(l.getRow(w),l.getRow(T));m.set(w,T,A),m.set(T,w,A)}else for(let w=0;w<l.rows;w++)for(let T=0;T<p.rows;T++)m.set(w,T,this.kernelFunction.compute(l.getRow(w),p.getRow(T)));return m}}var kernel=Kernel;const defaultOptions$2={lambda:.1,kernelType:"gaussian",kernelOptions:{},computeCoefficient:!1};class KernelRidgeRegression extends BaseRegression{constructor(l,p,m){super();if(l===!0)this.alpha=p.alpha,this.inputs=p.inputs,this.kernelType=p.kernelType,this.kernelOptions=p.kernelOptions,this.kernel=new kernel(p.kernelType,p.kernelOptions);else{l=Matrix$2.checkMatrix(l),m=Object.assign({},defaultOptions$2,m);const w=new kernel(m.kernelType,m.kernelOptions),T=w.compute(l),A=l.rows;T.add(Matrix$2.eye(A,A).mul(m.lambda)),this.alpha=solve(T,p),this.inputs=l,this.kernelType=m.kernelType,this.kernelOptions=m.kernelOptions,this.kernel=w}}_predict(l){return this.kernel.compute([l],this.inputs).mmul(this.alpha).getRow(0)}toJSON(){return{name:"kernelRidgeRegression",alpha:this.alpha,inputs:this.inputs,kernelType:this.kernelType,kernelOptions:this.kernelOptions}}static load(l){if(l.name!=="kernelRidgeRegression")throw new TypeError("not a KRR model");return new KernelRidgeRegression(!0,l)}}function background$1(h,l,p){const m=new KernelRidgeRegression(h,l,p),w=new Array(this.size);for(let y=0;y<this.width;y++)for(let B=0;B<this.height;B++)w[B*this.width+y]=[y,B];const T=m.predict(w),A=Image$1.createFrom(this);for(let y=0;y<this.size;y++)A.data[y]=Math.min(this.maxValue,Math.max(0,T[y][0]));return A}function dilate(h={}){let{kernel:l=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=h;if(this.checkProcessable("dilate",{bitDepth:[1,8,16],components:1,alpha:0}),l.columns%2==0||l.rows%2==0)throw new TypeError("dilate: The number of rows and columns of the kernel must be odd");let m=!0;e:for(const T of l)for(const A of T)if(A!==1){m=!1;break e}let w=this;for(let T=0;T<p;T++)if(this.bitDepth===1)if(m){const A=w.clone();w=dilateOnceBinaryOnlyOnes(w,A,l.length,l[0].length)}else{const A=Image$1.createFrom(w);w=dilateOnceBinary(w,A,l)}else if(m){const A=Image$1.createFrom(w);w=dilateOnceGreyOnlyOnes(w,A,l.length,l[0].length)}else{const A=Image$1.createFrom(w);w=dilateOnceGrey(w,A,l)}return w}function dilateOnceGrey(h,l,p){const m=p.length,w=p[0].length;let T=(m-1)/2,A=(w-1)/2;for(let y=0;y<h.height;y++)for(let B=0;B<h.width;B++){let D=0;for(let O=0;O<w;O++)for(let N=0;N<m;N++){if(p[N][O]!==1)continue;let j=N-T+B,G=O-A+y;if(j<0||G<0||j>=h.width||G>=h.height)continue;const H=h.getValueXY(j,G,0);H>D&&(D=H)}l.setValueXY(B,y,0,D)}return l}function dilateOnceGreyOnlyOnes(h,l,p,m){const w=(p-1)/2,T=(m-1)/2,A=[];for(let y=0;y<h.width;y++)A.push(0);for(let y=0;y<h.height;y++){for(let B=0;B<h.width;B++){let D=0;for(let O=Math.max(0,y-T);O<Math.min(h.height,y+T+1);O++){const N=h.getValueXY(B,O,0);N>D&&(D=N)}A[B]=D}for(let B=0;B<h.width;B++){let D=0;for(let O=Math.max(0,B-w);O<Math.min(h.width,B+w+1);O++)A[O]>D&&(D=A[O]);l.setValueXY(B,y,0,D)}}return l}function dilateOnceBinary(h,l,p){const m=p.length,w=p[0].length;let T=(m-1)/2,A=(w-1)/2;for(let y=0;y<h.height;y++)for(let B=0;B<h.width;B++){let D=0;e:for(let O=0;O<w;O++)for(let N=0;N<m;N++){if(p[N][O]!==1)continue;let j=N-T+B,G=O-A+y;if(G<0||j<0||j>=h.width||G>=h.height)continue;if(h.getBitXY(j,G)===1){D=1;break e}}D===1&&l.setBitXY(B,y)}return l}function dilateOnceBinaryOnlyOnes(h,l,p,m){const w=(p-1)/2,T=(m-1)/2,A=[];for(let y=0;y<h.width;y++)A.push(1);for(let y=0;y<h.height;y++){for(let B=0;B<h.width;B++){A[B]=0;for(let D=Math.max(0,y-T);D<Math.min(h.height,y+T+1);D++)if(h.getBitXY(B,D)===1){A[B]=1;break}}for(let B=0;B<h.width;B++)if(l.getBitXY(B,y)!==1){for(let D=Math.max(0,B-w);D<Math.min(h.width,B+w+1);D++)if(A[D]===1){l.setBitXY(B,y);break}}}return l}function erode(h={}){let{kernel:l=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=h;if(this.checkProcessable("erode",{bitDepth:[1,8,16],components:1,alpha:0}),l.columns%2==0||l.rows%2==0)throw new TypeError("erode: The number of rows and columns of the kernel must be odd");let m=!0;e:for(const T of l)for(const A of T)if(A!==1){m=!1;break e}let w=this;for(let T=0;T<p;T++)if(this.bitDepth===1)if(m){const A=w.clone();w=erodeOnceBinaryOnlyOnes(w,A,l.length,l[0].length)}else{const A=Image$1.createFrom(w);w=erodeOnceBinary(w,A,l)}else if(m){const A=Image$1.createFrom(w);w=erodeOnceGreyOnlyOnes(w,A,l.length,l[0].length)}else{const A=Image$1.createFrom(w);w=erodeOnceGrey(w,A,l)}return w}function erodeOnceGrey(h,l,p){const m=p.length,w=p[0].length;let T=(m-1)/2,A=(w-1)/2;for(let y=0;y<h.height;y++)for(let B=0;B<h.width;B++){let D=h.maxValue;for(let O=0;O<w;O++)for(let N=0;N<m;N++){if(p[N][O]!==1)continue;let j=N-T+B,G=O-A+y;if(j<0||G<0||j>=h.width||G>=h.height)continue;const H=h.getValueXY(j,G,0);H<D&&(D=H)}l.setValueXY(B,y,0,D)}return l}function erodeOnceGreyOnlyOnes(h,l,p,m){const w=(p-1)/2,T=(m-1)/2,A=[];for(let y=0;y<h.width;y++)A.push(0);for(let y=0;y<h.height;y++){for(let B=0;B<h.width;B++){let D=h.maxValue;for(let O=Math.max(0,y-T);O<Math.min(h.height,y+T+1);O++){const N=h.getValueXY(B,O,0);N<D&&(D=N)}A[B]=D}for(let B=0;B<h.width;B++){let D=h.maxValue;for(let O=Math.max(0,B-w);O<Math.min(h.width,B+w+1);O++)A[O]<D&&(D=A[O]);l.setValueXY(B,y,0,D)}}return l}function erodeOnceBinary(h,l,p){const m=p.length,w=p[0].length;let T=(m-1)/2,A=(w-1)/2;for(let y=0;y<h.height;y++)for(let B=0;B<h.width;B++){let D=1;e:for(let O=0;O<w;O++)for(let N=0;N<m;N++){if(p[N][O]!==1)continue;let j=N-T+B,G=O-A+y;if(G<0||j<0||j>=h.width||G>=h.height)continue;if(h.getBitXY(j,G)===0){D=0;break e}}D===1&&l.setBitXY(B,y)}return l}function erodeOnceBinaryOnlyOnes(h,l,p,m){const w=(p-1)/2,T=(m-1)/2,A=[];for(let y=0;y<h.width;y++)A.push(0);for(let y=0;y<h.height;y++){for(let B=0;B<h.width;B++){A[B]=1;for(let D=Math.max(0,y-T);D<Math.min(h.height,y+T+1);D++)if(h.getBitXY(B,D)===0){A[B]=0;break}}for(let B=0;B<h.width;B++)if(l.getBitXY(B,y)!==0){for(let D=Math.max(0,B-w);D<Math.min(h.width,B+w+1);D++)if(A[D]===0){l.clearBitXY(B,y);break}}}return l}function open(h={}){let{kernel:l=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=h;if(this.checkProcessable("open",{bitDepth:[8,16],components:1,alpha:0}),l.columns%2==0||l.rows%2==0)throw new TypeError("open: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++)m=m.erode({kernel:l}),m=m.dilate({kernel:l});return m}function close(h={}){let{kernel:l=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=h;if(this.checkProcessable("close",{bitDepth:[1,8,16],components:1,alpha:0}),l.columns%2==0||l.rows%2==0)throw new TypeError("close: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++)m=m.dilate({kernel:l}).erode({kernel:l});return m}function topHat(h={}){let{kernel:l=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=h;if(this.checkProcessable("topHat",{bitDepth:[8,16],components:1,alpha:0}),l.length%2==0||l[0].length%2==0)throw new TypeError("topHat: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++)m=m.open({kernel:l}).subtractImage(m,{absolute:!0});return m}function blackHat(h={}){let{kernel:l=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=h;if(this.checkProcessable("blackHat",{bitDepth:[8,16],components:1,alpha:0}),l.columns%2==0||l.rows%2==0)throw new TypeError("blackHat: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++)m=m.close({kernel:l}).subtractImage(m,{absolute:!0});return m}function morphologicalGradient(h={}){let{kernel:l=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=h;if(this.checkProcessable("morphologicalGradient",{bitDepth:[8,16],components:1,alpha:0}),l.columns%2==0||l.rows%2==0)throw new TypeError("morphologicalGradient: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++){let T=m.dilate({kernel:l}),A=m.erode({kernel:l});m=T.subtractImage(A,{absolute:!0})}return m}function order4Points(h){let l=0,p=0,m=0,w=0,T=h[0][0],A=0;for(let D=1;D<h.length;D++)h[D][0]<T&&(T=h[D][0],A=D);let y=h[(A+1)%h.length][0],B=(A+1)%h.length;for(let D=1;D<h.length;D++)h[D][0]<y&&D!==A&&(y=h[D][0],B=D);return h[B][1]<h[A][1]?(l=h[B],w=h[A],A!==(B+1)%4?(p=h[(B+1)%4],m=h[(B+2)%4]):(p=h[(B+2)%4],m=h[(B+3)%4])):(w=h[B],l=h[A],B!==(A+1)%4?(p=h[(A+1)%4],m=h[(A+2)%4]):(p=h[(A+2)%4],m=h[(A+3)%4])),[l,p,m,w]}function distance2Points(h,l){return Math.sqrt(Math.pow(h[0]-l[0],2)+Math.pow(h[1]-l[1],2))}function crossVect(h,l){return[h[1]*l[2]-h[2]*l[1],h[2]*l[0]-h[0]*l[2],h[0]*l[1]-h[1]*l[0]]}function dotVect(h,l){return h[0]*l[0]+h[1]*l[1]+h[2]*l[2]}function computeWidthAndHeigth(h,l,p,m,w,T){let A=Math.max(distance2Points(h,l),distance2Points(m,p)),y=Math.max(distance2Points(h,m),distance2Points(l,p)),B=0,D=0,O=Math.ceil(w/2),N=Math.ceil(T/2),j=A/y,G=[h[0],h[1],1],H=[l[0],l[1],1],te=[m[0],m[1],1],oe=[p[0],p[1],1],Q=dotVect(crossVect(G,oe),te)/dotVect(crossVect(H,oe),te),_e=dotVect(crossVect(G,oe),H)/dotVect(crossVect(te,oe),H),se=[Q*H[0]-G[0],Q*H[1]-G[1],Q*H[2]-G[2]],he=[_e*te[0]-G[0],_e*te[1]-G[1],_e*te[2]-G[2]],me=se[0],Re=se[1],ge=se[2],ue=he[0],Se=he[1],le=he[2],pe=1/(ge*le)*(me*ue-(me*le+ge*ue)*O+ge*le*O*O+(Re*Se-(Re*le+ge*Se)*N+ge*le*N*N));pe>=0?pe=Math.sqrt(pe):pe=Math.sqrt(-pe);let Le=new Matrix$2([[pe,0,O],[0,pe,N],[0,0,1]]),Ze=Le.transpose(),lt=inverse(Ze),ct=inverse(Le),$t=Matrix$2.rowVector(se),Nt=Matrix$2.rowVector(he),St=Math.sqrt(dotVect($t.mmul(lt).mmul(ct).to1DArray(),se)/dotVect(Nt.mmul(lt).mmul(ct).to1DArray(),he));return St===0||j===0?(B=Math.ceil(A),D=Math.ceil(y)):St<j?(B=Math.ceil(A),D=Math.ceil(B/St)):(D=Math.ceil(y),B=Math.ceil(St*D)),[B,D]}function projectionPoint(h,l,p,m,w,T,A,y,B,D,O,N){let[j,G]=[(p*h+m*l+w)/(B*h+D*l+1),(T*h+A*l+y)/(B*h+D*l+1)];return O.getValueXY(Math.floor(j),Math.floor(G),N)}function warpingFourPoints(h,l={}){let{calculateRatio:p=!0}=l;if(h.length!==4)throw new Error(`The array pts must have four elements, which are the four corners. Currently, pts have ${h.length} elements`);let[m,w,T,A]=h,y=[m,w,T,A],[B,D,O,N]=order4Points(y),j,G;p?[j,G]=computeWidthAndHeigth(B,D,O,N,this.width,this.height):(j=Math.ceil(Math.max(distance2Points(B,D),distance2Points(N,O))),G=Math.ceil(Math.max(distance2Points(B,N),distance2Points(D,O))));let H=Image$1.createFrom(this,{width:j,height:G}),[te,oe]=B,[Q,_e]=D,[se,he]=O,[me,Re]=N,[ge,ue]=[0,0],[Se,le]=[0,j-1],[pe,Le]=[G-1,j-1],[Ze,lt]=[G-1,0],ct=new Matrix$2([[ge,ue,1,0,0,0,-ge*te,-ue*te],[Se,le,1,0,0,0,-Se*Q,-le*Q],[pe,Le,1,0,0,0,-pe*se,-ue*se],[Ze,lt,1,0,0,0,-Ze*me,-lt*me],[0,0,0,ge,ue,1,-ge*oe,-ue*oe],[0,0,0,Se,le,1,-Se*_e,-le*_e],[0,0,0,pe,Le,1,-pe*he,-Le*he],[0,0,0,Ze,lt,1,-Ze*Re,-lt*Re]]),$t=Matrix$2.columnVector([te,Q,se,me,oe,_e,he,Re]),St=new SingularValueDecomposition(ct).solve($t),[Gt,Dt,Ut,Xt,ft,wt,bt,zt]=St.to1DArray(),qt=new Matrix$2(G,j);for(let ui=0;ui<this.channels;ui++){for(let Ct=0;Ct<G;Ct++)for(let di=0;di<j;di++)qt.set(Ct,di,projectionPoint(Ct,di,Gt,Dt,Ut,Xt,ft,wt,bt,zt,this,ui));H.setMatrix(qt,{channel:ui})}return H}function crop(h={}){let{x:l=0,y:p=0,width:m=this.width-l,height:w=this.height-p}=h;if(this.checkProcessable("max",{bitDepth:[8,16]}),l=Math.round(l),p=Math.round(p),m=Math.round(m),w=Math.round(w),l>this.width-1||p>this.height-1)throw new RangeError(`crop: origin (x:${l}, y:${p}) out of range (${this.width-1}; ${this.height-1})`);if(m<=0||w<=0)throw new RangeError(`crop: width and height (width:${m}; height:${w}) must be positive numbers`);if(l<0||p<0)throw new RangeError(`crop: x and y (x:${l}, y:${p}) must be positive numbers`);if(m>this.width-l||w>this.height-p)throw new RangeError(`crop: (x: ${l}, y:${p}, width:${m}, height:${w}) size is out of range`);let T=Image$1.createFrom(this,{width:m,height:w,position:[l,p]}),A=m*this.channels,y=p+w,B=0,D=l*this.channels;for(let O=p;O<y;O++){let N=O*this.width*this.channels+D,j=N+A;for(;N<j;N++)T.data[B++]=this.data[N]}return T}function cropAlpha(h={}){this.checkProcessable("cropAlpha",{alpha:1});const{threshold:l=this.maxValue}=h;let p=findLeft(this,l,this.components);if(p===-1)throw new Error("Could not find new dimensions. Threshold may be too high.");let m=findTop(this,l,this.components,p),w=findBottom(this,l,this.components,p),T=findRight(this,l,this.components,p,m,w);return this.crop({x:p,y:m,width:T-p+1,height:w-m+1})}function findLeft(h,l,p){for(let m=0;m<h.width;m++)for(let w=0;w<h.height;w++)if(h.getValueXY(m,w,p)>=l)return m;return-1}function findTop(h,l,p,m){for(let w=0;w<h.height;w++)for(let T=m;T<h.width;T++)if(h.getValueXY(T,w,p)>=l)return w;return-1}function findBottom(h,l,p,m){for(let w=h.height-1;w>=0;w--)for(let T=m;T<h.width;T++)if(h.getValueXY(T,w,p)>=l)return w;return-1}function findRight(h,l,p,m,w,T){for(let A=h.width-1;A>=m;A--)for(let y=w;y<=T;y++)if(h.getValueXY(A,y,p)>=l)return A;return-1}function getFactor(h){if(typeof h=="string"){const l=h[h.length-1];h=parseFloat(h),l==="%"&&(h/=100)}return h}function getThreshold$1(h,l){if(!l)throw Error("getThreshold : the maxValue should be specified");if(typeof h=="string"){if(h[h.length-1]!=="%")throw Error("getThreshold : if the value is a string it must finish by %");return parseFloat(h)/100*l}else{if(typeof h=="number")return h<1?h*l:h;throw Error("getThreshold : the value is not valid")}}function factorDimensions(h,l,p){h=getFactor(h);let m=Math.round(h*l),w=Math.round(h*p);return m<=0&&(m=1),w<=0&&(w=1),{width:m,height:w}}function checkRow(h,l){if(l<0||l>=h.height)throw new RangeError(`row must be included between 0 and ${h.height-1}. Current value: ${l}`)}function checkColumn(h,l){if(l<0||l>=h.width)throw new RangeError(`column must be included between 0 and ${h.width-1}. Current value: ${l}`)}function checkChannel(h,l){if(l<0||l>=h.channels)throw new RangeError(`channel must be included between 0 and ${h.channels-1}. Current value: ${l}`)}const validInterpolations={nearestneighbor:"nearestNeighbor",nearestneighbour:"nearestNeighbor",bilinear:"bilinear"};function checkInterpolation(h){if(typeof h!="string")throw new TypeError("interpolation must be a string");if(h=h.toLowerCase(),!validInterpolations[h])throw new RangeError(`invalid interpolation algorithm: ${h}`);return validInterpolations[h]}function nearestNeighbor(h,l,p){const m=this.width/l,w=this.height/p;if(this.bitDepth>1)for(let T=0;T<l;T++){const A=Math.floor((T+.5)*m);for(let y=0;y<p;y++){const B=Math.floor((y+.5)*w);for(let D=0;D<this.channels;D++)h.setValueXY(T,y,D,this.getValueXY(A,B,D))}}else for(let T=0;T<l;T++){const A=Math.floor((T+.5)*m);for(let y=0;y<p;y++){const B=Math.floor((y+.5)*w);this.getBitXY(A,B)&&h.setBitXY(T,y)}}}function resize(h={}){const{factor:l=1,interpolation:p=validInterpolations.nearestneighbor,preserveAspectRatio:m=!0}=h,w=checkInterpolation(p);let T=h.width,A=h.height;if(T||(A&&m?T=Math.round(A*(this.width/this.height)):T=this.width),A||(m?A=Math.round(T*(this.height/this.width)):A=this.height),{width:T,height:A}=factorDimensions(l,T,A),T===this.width&&A===this.height){const O=this.clone();return O.position=[0,0],O}let y=Math.round((this.width-T)/2),B=Math.round((this.height-A)/2);const D=Image$1.createFrom(this,{width:T,height:A,position:[y,B]});switch(w){case validInterpolations.nearestneighbor:nearestNeighbor.call(this,D,T,A);break;default:throw new Error(`unsupported resize interpolation: ${w}`)}return D}function hsv(){this.checkProcessable("hsv",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let h=Image$1.createFrom(this,{colorModel:HSV}),l=0,p=this.data;for(let m=0;m<p.length;m+=this.channels){let w=p[m],T=p[m+1],A=p[m+2],y=Math.min(w,T,A),B=Math.max(w,T,A),D=B-y,O=0,N=B===0?0:D/B,j=B;if(B!==y){switch(B){case w:O=(T-A)/D+(T<A?6:0);break;case T:O=(A-w)/D+2;break;case A:O=(w-T)/D+4;break;default:throw new Error("unreachable")}O/=6}h.data[l++]=O*this.maxValue,h.data[l++]=N*this.maxValue,h.data[l++]=j,this.alpha&&(h.data[l++]=p[m+3])}return h}function hsl$1(){this.checkProcessable("hsl",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let h=Image$1.createFrom(this,{colorModel:HSL}),l=Math.floor(this.maxValue/2),p=0,m=this.data;for(let w=0;w<m.length;w+=this.channels){let T=m[w],A=m[w+1],y=m[w+2],B=Math.max(T,A,y),D=Math.min(T,A,y),O=0,N=0,j=(B+D)/2;if(B!==D){let G=B-D;switch(N=j>l?G/(2-B-D):G/(B+D),B){case T:O=(A-y)/G+(A<y?6:0);break;case A:O=(y-T)/G+2;break;case y:O=(T-A)/G+4;break;default:throw new Error("unreachable")}O/=6}h.data[p++]=O*this.maxValue,h.data[p++]=N*this.maxValue,h.data[p++]=j,this.alpha&&(h.data[p++]=m[w+3])}return h}function cmyk(){this.checkProcessable("cmyk",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let h=Image$1.createFrom(this,{components:4,colorModel:CMYK$1}),l=0,p=this.data;for(let m=0;m<p.length;m+=this.channels){let w=p[m],T=p[m+1],A=p[m+2],y=Math.min(this.maxValue-w,this.maxValue-T,this.maxValue-A),B=(this.maxValue-w-y)/(1-y/this.maxValue),D=(this.maxValue-T-y)/(1-y/this.maxValue),O=(this.maxValue-A-y)/(1-y/this.maxValue);h.data[l++]=Math.round(B),h.data[l++]=Math.round(D),h.data[l++]=Math.round(O),h.data[l++]=Math.round(y),this.alpha&&(h.data[l++]=p[m+3])}return h}function rgba8(){return new Image$1(this.width,this.height,this.getRGBAData(),{kind:"RGBA",parent:this})}const methods$1={luma709(h,l,p){return h*6966+l*23436+p*2366>>15},luma601(h,l,p){return h*9798+l*19235+p*3735>>15},maximum(h,l,p){return Math.max(h,l,p)},minimum(h,l,p){return Math.min(h,l,p)},average(h,l,p){return(h+l+p)/3>>0},minmax(h,l,p){return(Math.max(h,l,p)+Math.min(h,l,p))/2},red(h){return h},green(h,l){return l},blue(h,l,p){return p},cyan(h,l,p,m){let w=methods$1.black(h,l,p,m);return(m.maxValue-h-w)/(1-w/m.maxValue)>>0},magenta(h,l,p,m){let w=methods$1.black(h,l,p,m);return(m.maxValue-l-w)/(1-w/m.maxValue)>>0},yellow(h,l,p,m){let w=methods$1.black(h,l,p,m);return(m.maxValue-p-w)/(1-w/m.maxValue)>>0},black(h,l,p,m){return Math.min(m.maxValue-h,m.maxValue-l,m.maxValue-p)},hue(h,l,p,m){let w=methods$1.min(h,l,p),T=methods$1.max(h,l,p);if(T===w)return 0;let A=0,y=T-w;switch(T){case h:A=(l-p)/y+(l<p?6:0);break;case l:A=(p-h)/y+2;break;case p:A=(h-l)/y+4;break;default:throw new Error("unreachable")}return A/6*m.maxValue>>0},saturation(h,l,p,m){let w=methods$1.min(h,l,p),T=methods$1.max(h,l,p),A=T-w;return T===0?0:A/T*m.maxValue},lightness(h,l,p){let m=methods$1.min(h,l,p);return(methods$1.max(h,l,p)+m)/2}};Object.defineProperty(methods$1,"luminosity",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"luminance",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"min",{enumerable:!1,value:methods$1.minimum});Object.defineProperty(methods$1,"max",{enumerable:!1,value:methods$1.maximum});Object.defineProperty(methods$1,"brightness",{enumerable:!1,value:methods$1.maximum});const names$1={};Object.keys(methods$1).forEach(h=>{names$1[h]=h});function grey(h={}){let{algorithm:l="luma709",keepAlpha:p=!1,mergeAlpha:m=!0}=h;if(typeof l!="string"&&typeof l!="function")throw new TypeError("algorithm must be a string or a function");this.checkProcessable("grey",{bitDepth:[8,16],alpha:[0,1]}),this.components===1&&(l="red"),p&=this.alpha,m&=this.alpha,p&&(m=!1);let w=getOutputImage(this,h,{components:1,alpha:p,colorModel:GREY$1}),T;if(typeof l=="function")T=l;else if(T=methods$1[l.toLowerCase()],!T)throw new Error(`unsupported grey algorithm: ${l}`);let A=0;for(let y=0;y<this.data.length;y+=this.channels)m?w.data[A++]=clamp(T(this.data[y],this.data[y+1],this.data[y+2],this)*this.data[y+this.components]/this.maxValue,this):(w.data[A++]=clamp(T(this.data[y],this.data[y+1],this.data[y+2],this),this),w.alpha&&(w.data[A++]=this.data[y+this.components]));return w}function huang(h){let l=0;for(let O=0;O<h.length;O++)if(h[O]!==0){l=O;break}let p=h.length-1;for(let O=h.length-1;O>=l;O--)if(h[O]!==0){p=O;break}let m=1/(p-l),w=new Array(h.length),T=0,A=0;for(let O=l;O<h.length;O++)T+=O*h[O],A+=h[O],w[O]=T/A;let y=new Array(h.length);T=A=0;for(let O=p;O>0;O--)T+=O*h[O],A+=h[O],y[O-1]=T/A;let B=-1,D=Number.MAX_VALUE;for(let O=0;O<h.length;O++){let N=0,j;for(let G=0;G<=O;G++)j=1/(1+m*Math.abs(G-w[O])),j<1e-6||j>.999999||(N+=h[G]*(-j*Math.log(j)-(1-j)*Math.log(1-j)));for(let G=O+1;G<h.length;G++)j=1/(1+m*Math.abs(G-y[O])),j<1e-6||j>.999999||(N+=h[G]*(-j*Math.log(j)-(1-j)*Math.log(1-j)));N<D&&(D=N,B=O)}return B}function intermodes(h){let l=h.slice(),p=0;for(;!bimodalTest$1(l);){let w=0,T=0,A=l[0];for(let y=0;y<h.length-1;y++)w=T,T=A,A=l[y+1],l[y]=(w+T+A)/3;if(l[h.length-1]=(T+A)/3,p++,p>1e4)throw new Error("Intermodes Threshold not found after 10000 iterations")}let m=0;for(let w=1;w<h.length-1;w++)l[w-1]<l[w]&&l[w+1]<l[w]&&(m+=w);return Math.floor(m/2)}function bimodalTest$1(h){let l=!1,p=0;for(let m=1;m<h.length-1;m++)if(h[m-1]<h[m]&&h[m+1]<h[m]&&(p++,p>2))return!1;return p===2&&(l=!0),l}function isodata(h){let l,p,m,w,T=0;for(let A=1;A<h.length;A++)if(h[A]>0){T=A+1;break}for(;;){l=0,m=0;for(let A=0;A<T;A++)m=m+h[A],l=l+h[A]*A;w=0,p=0;for(let A=T+1;A<h.length;A++)p+=h[A],w+=h[A]*A;if(m>0&&p>0&&(l/=m,w/=p,T===Math.round((l+w)/2)))break;if(T++,T>h.length-2)throw new Error("Threshold not found")}return T}function li(h,l){let p,m,w,T,A,y,B,D,O,N,j,G;j=.5,N=0;for(let H=0;H<h.length;H++)N+=H*h[H];N/=l,B=N;do{y=B,p=y+.5|0,m=0,T=0;for(let H=0;H<=p;H++)m+=H*h[H],T+=h[H];D=T===0?0:m/T,w=0,A=0;for(let H=p+1;H<h.length;H++)w+=H*h[H],A+=h[H];O=A===0?0:w/A,G=(D-O)/(Math.log(D)-Math.log(O)),G<-Number.EPSILON?B=G-.5|0:B=G+.5|0}while(Math.abs(B-y)>j);return p}function maxEntropy(h,l){let p=new Array(h.length);for(let j=0;j<h.length;j++)p[j]=h[j]/l;let m=new Array(h.length),w=new Array(h.length);m[0]=p[0],w[0]=1-m[0];for(let j=1;j<h.length;j++)m[j]=m[j-1]+p[j],w[j]=1-m[j];let T=0;for(let j=0;j<h.length;j++)if(Math.abs(m[j])>=Number.EPSILON){T=j;break}let A=h.length-1;for(let j=h.length-1;j>=T;j--)if(Math.abs(w[j])>=Number.EPSILON){A=j;break}let y=-1,B,D=Number.MIN_VALUE,O,N;for(let j=T;j<=A;j++){O=0;for(let G=0;G<=j;G++)h[G]!==0&&(O-=p[G]/m[j]*Math.log(p[G]/m[j]));N=0;for(let G=j+1;G<h.length;G++)h[G]!==0&&(N-=p[G]/w[j]*Math.log(p[G]/w[j]));B=O+N,D<B&&(D=B,y=j)}return y}function mean$1(h,l){let p=0;for(let m=0;m<h.length;m++)p+=m*h[m];return Math.floor(p/l)}function minError(h,l){let p,m=-2,w,T,A,y,B,D,O,N,j,G,H,te=0;for(let oe=0;oe<h.length;oe++)te+=oe*h[oe];for(te/=l,p=te;p!==m;){let oe=sumA(h,p),Q=sumA(h,h.length-1),_e=sumB(h,p),se=sumB(h,h.length-1),he=sumC(h,p),me=sumC(h,h.length-1);if(w=_e/oe,T=(se-_e)/(Q-oe),A=oe/Q,y=(Q-oe)/Q,B=he/oe-w*w,D=(me-he)/(Q-oe)-T*T,O=1/B-1/D,N=w/B-T/D,j=w*w/B-T*T/D+Math.log10(B*(y*y)/(D*(A*A))),G=N*N-O*j,G<0)return p;m=p,H=(N+Math.sqrt(G))/O,isNaN(H)?p=m:p=Math.floor(H)}return p}function sumA(h,l){let p=0;for(let m=0;m<=l;m++)p+=h[m];return p}function sumB(h,l){let p=0;for(let m=0;m<=l;m++)p+=m*h[m];return p}function sumC(h,l){let p=0;for(let m=0;m<=l;m++)p+=m*m*h[m];return p}function minimum(h){if(h.length<2)return 0;let l=0,p=-1,m=-1,w=new Array(h.length);for(let T=0;T<h.length;T++)w[T]=h[T],h[T]>0&&(m=T);for(;!bimodalTest(w);)if(w=smoothed(w),l++,l>1e4)return p;return p=minimumBetweenPeeks(w,m),p}function smoothed(h){let l=new Array(h.length);for(let p=1;p<h.length-1;p++)l[p]=(h[p-1]+h[p]+h[p+1])/3;return l[0]=(h[0]+h[1])/3,l[h.length-1]=(h[h.length-2]+h[h.length-1])/3,l}function minimumBetweenPeeks(h,l){let p;for(let m=1;m<l;m++)if(h[m-1]>h[m]&&h[m+1]>=h[m]){p=m;break}return p}function bimodalTest(h){let l=h.length,p=!1,m=0;for(let w=1;w<l-1;w++)if(h[w-1]<h[w]&&h[w+1]<h[w]&&(m++,m>2))return!1;return m===2&&(p=!0),p}function moments(h,l){let p=1,m=0,w=0,T=0,A=0,y,B,D,O,N,j,G=-1,H=h.length,te=new Array(H);for(let oe=0;oe<H;oe++)te[oe]=h[oe]/l;for(let oe=0;oe<H;oe++)m+=oe*te[oe],w+=oe*oe*te[oe],T+=oe*oe*oe*te[oe];B=p*w-m*m,D=(-w*w+m*T)/B,O=(p*-T+w*m)/B,N=.5*(-O-Math.sqrt(O*O-4*D)),j=.5*(-O+Math.sqrt(O*O-4*D)),y=(j-m)/(j-N);for(let oe=0;oe<H;oe++)if(A+=te[oe],A>y){G=oe;break}return G}function otsu(h,l){let p=0,m=0,w=0,T=0,A=0;for(let y=0;y<h.length;y++)A+=y*h[y];for(let y=0;y<h.length;y++){m=m+h[y];const B=l-m;if(m===0||B===0)continue;p=p+y*h[y];const D=(A-p)/B,O=m*B*(p/m-D)*(p/m-D);O>=w&&(T=y,w=O)}return T}function percentile(h){let l=-1,p=.5,m=new Array(h.length),w=partialSum(h,h.length-1),T=1;for(let A=0;A<h.length;A++)m[A]=Math.abs(partialSum(h,A)/w-p),m[A]<T&&(T=m[A],l=A);return l}function partialSum(h,l){let p=0;for(let m=0;m<=l;m++)p+=h[m];return p}function renyiEntropy(h,l){let p,m,w,T=new Array(h.length),A=new Array(h.length),y=new Array(h.length),B=0,D=0,O=0,N=0,j=0,G=0,te=1/(1-.5),Q=1/(1-2);for(let me=0;me<h.length;me++)T[me]=h[me]/l;A[0]=T[0],y[0]=1-A[0];for(let me=1;me<h.length;me++)A[me]=A[me-1]+T[me],y[me]=1-A[me];m=0;for(let me=0;me<h.length;me++)if(Math.abs(A[me])>=Number.EPSILON){m=me;break}w=h.length-1;for(let me=h.length-1;me>=m;me--)if(Math.abs(y[me])>=Number.EPSILON){w=me;break}for(let me=m;me<=w;me++){let Re=0,ge=0,ue=0;for(let ct=0;ct<=me;ct++)h[ct]!==0&&(Re-=T[ct]/A[me]*Math.log(T[ct]/A[me])),ge+=Math.sqrt(T[ct]/A[me]),ue+=T[ct]*T[ct]/(A[me]*A[me]);let Se=0,le=0,pe=0;for(let ct=me+1;ct<h.length;ct++)h[ct]!==0&&(Se-=T[ct]/y[me]*Math.log(T[ct]/y[me])),le+=Math.sqrt(T[ct]/y[me]),pe+=T[ct]*T[ct]/(y[me]*y[me]);let Le=Re+Se,Ze=te*(ge*le>0?Math.log(ge*le):0),lt=Q*(ue*pe>0?Math.log(ue*pe):0);Le>N&&(N=Le,B=me),Ze>j&&(j=Ze,D=me),lt>G&&(G=lt,O=me)}let _e=[B,D,O];_e.sort((me,Re)=>me-Re);let se;Math.abs(_e[0]-_e[1])<=5?Math.abs(_e[1]-_e[2])<=5?se=[1,2,1]:se=[0,1,3]:Math.abs(_e[1]-_e[2])<=5?se=[3,1,0]:se=[1,2,1];let he=A[_e[2]]-A[_e[0]];return p=Math.round(_e[0]*(A[_e[0]]+.25*he*se[0])+.25*_e[1]*he*se[1]+_e[2]*(y[_e[2]]+.25*he*se[2])),p}function shanbhag(h,l){let p=new Array(h.length);for(let G=0;G<h.length;G++)p[G]=h[G]/l;let m=new Array(h.length),w=new Array(h.length);m[0]=p[0],w[0]=1-m[0];for(let G=1;G<h.length;G++)m[G]=m[G-1]+p[G],w[G]=1-m[G];let T=0;for(let G=0;G<h.length;G++)if(Math.abs(m[G])>=Number.EPSILON){T=G;break}let A=h.length-1;for(let G=h.length-1;G>=T;G--)if(Math.abs(w[G])>=Number.EPSILON){A=G;break}let y=-1,B=Number.MAX_VALUE,D,O,N,j;for(let G=T;G<=A;G++){N=0,D=.5/m[G];for(let H=1;H<=G;H++)N-=p[H]*Math.log(1-D*m[H-1]);N*=D,j=0,D=.5/w[G];for(let H=G+1;H<h.length;H++)j-=p[H]*Math.log(1-D*w[H]);j*=D,O=Math.abs(N-j),O<B&&(B=O,y=G)}return y}function triangle$1(h){let l=0,p=0,m=0,w=0;for(let N=0;N<h.length;N++)if(h[N]>0){l=N;break}l>0&&l--;for(let N=h.length-1;N>0;N--)if(h[N]>0){w=N;break}w<h.length-1&&w++;for(let N=0;N<h.length;N++)h[N]>p&&(m=N,p=h[N]);let T=!1;if(m-l<w-m){T=!0;let N=0,j=h.length-1;for(;N<j;){let G=h[N];h[N]=h[j],h[j]=G,N++,j--}l=h.length-1-w,m=h.length-1-m}if(l===m)return l;let A,y,B;A=h[m],y=l-m,B=Math.sqrt(A*A+y*y),A/=B,y/=B,B=A*l+y*h[l];let D=l,O=0;for(let N=l+1;N<=m;N++){let j=A*N+y*h[N]-B;j>O&&(D=N,O=j)}if(D--,T){let N=0,j=h.length-1;for(;N<j;){let G=h[N];h[N]=h[j],h[j]=G,N++,j--}return h.length-1-D}else return D}function yen(h,l){let p=new Array(h.length);for(let D=0;D<h.length;D++)p[D]=h[D]/l;let m=new Array(h.length);m[0]=p[0];for(let D=1;D<h.length;D++)m[D]=m[D-1]+p[D];let w=new Array(h.length);w[0]=p[0]*p[0];for(let D=1;D<h.length;D++)w[D]=w[D-1]+p[D]*p[D];let T=new Array(h.length);T[h.length-1]=0;for(let D=h.length-2;D>=0;D--)T[D]=T[D+1]+p[D+1]*p[D+1];let A=-1,y=Number.MIN_VALUE,B;for(let D=0;D<h.length;D++)B=-1*(w[D]*T[D]>0?Math.log(w[D]*T[D]):0)+2*(m[D]*(1-m[D])>0?Math.log(m[D]*(1-m[D])):0),B>y&&(y=B,A=D);return A}const methods={huang,intermodes,isodata,li,maxentropy:maxEntropy,mean:mean$1,minerror:minError,minimum,moments,otsu,percentile,renyientropy:renyiEntropy,shanbhag,triangle:triangle$1,yen},names={};Object.keys(methods).forEach(h=>{names[h]=h});function getThreshold(h={}){let{algorithm:l=names.otsu}=h;this.checkProcessable("getThreshold",{components:1,bitDepth:[8,16]});let p=methods[l.toLowerCase()];if(p){let m=this.getHistogram();return p(m,this.size)}else throw new Error(`unknown thresholding algorithm: ${l}`)}const THRESHOLD="threshold";function mask(h={}){let{algorithm:l=THRESHOLD,threshold:p=.5,useAlpha:m=!0,invert:w=!1}=h;this.checkProcessable("mask",{components:1,bitDepth:[8,16]}),l===THRESHOLD?p=getThreshold$1(p,this.maxValue):p=getThreshold.call(this,h);let T=new Image$1(this.width,this.height,{kind:"BINARY",parent:this}),A=0;if(this.alpha&&m)for(let y=0;y<this.data.length;y+=this.channels){let B=this.data[y]+(this.maxValue-this.data[y])*(this.maxValue-this.data[y+1])/this.maxValue;(w&&B<=p||!w&&B>=p)&&T.setBit(A),A++}else for(let y=0;y<this.data.length;y+=this.channels)(w&&this.data[y]<=p||!w&&this.data[y]>=p)&&T.setBit(A),A++;return T}function copyImage(h,l,p,m){let w=h.width,T=h.height,A=l.width,y=h.channels;for(let B=0;B<w;B++)for(let D=0;D<T;D++)for(let O=0;O<y;O++){let N=(D*w+B)*y+O,j=((m+D)*A+p+B)*y+O;l.data[j]=h.data[N]}}function pad(h={}){let{size:l=0,algorithm:p="copy",color:m}=h;if(this.checkProcessable("pad",{bitDepth:[8,16]}),p==="set"){if(m.length!==this.channels)throw new Error(`pad: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let B=0;B<m.length;B++)m[B]===0&&(m[B]=.001)}else m=newArray_1(this.channels,null);Array.isArray(l)||(l=[l,l]);let w=this.width+l[0]*2,T=this.height+l[1]*2,A=this.channels,y=Image$1.createFrom(this,{width:w,height:T});copyImage(this,y,l[0],l[1]);for(let B=l[0];B<w-l[0];B++)for(let D=0;D<A;D++){let O=m[D]||y.data[(l[1]*w+B)*A+D];for(let N=0;N<l[1];N++)y.data[(N*w+B)*A+D]=O;O=m[D]||y.data[((T-l[1]-1)*w+B)*A+D];for(let N=T-l[1];N<T;N++)y.data[(N*w+B)*A+D]=O}for(let B=0;B<T;B++)for(let D=0;D<A;D++){let O=m[D]||y.data[(B*w+l[0])*A+D];for(let N=0;N<l[0];N++)y.data[(B*w+N)*A+D]=O;O=m[D]||y.data[(B*w+w-l[0]-1)*A+D];for(let N=w-l[0];N<w;N++)y.data[(B*w+N)*A+D]=O}return y}function colorDepth(h=8){if(this.checkProcessable("colorDepth",{bitDepth:[1,8,16]}),![8,16].includes(h))throw Error("You need to specify the new colorDepth as 8 or 16");if(this.bitDepth===h)return this.clone();let l=Image$1.createFrom(this,{bitDepth:h});switch(h){case 8:if(this.bitDepth===1)for(let p=0;p<this.size;p++)this.getBit(p)&&(l.data[p]=255);else for(let p=0;p<this.data.length;p++)l.data[p]=this.data[p]>>8;break;case 16:if(this.bitDepth===1)for(let p=0;p<this.size;p++)this.getBit(p)&&(l.data[p]=65535);else for(let p=0;p<this.data.length;p++)l.data[p]=this.data[p]<<8|this.data[p];break;default:throw new Error("colorDepth conversion unexpected case")}return l}function rotateFree(h,l={}){const{interpolation:p=validInterpolations.nearestneighbor,width:m=this.width,height:w=this.height}=l;if(typeof h!="number")throw new TypeError("degrees must be a number");const T=checkInterpolation(p),A=h*Math.PI/180,y=Math.floor(Math.abs(m*Math.cos(A))+Math.abs(w*Math.sin(A))),B=Math.floor(Math.abs(w*Math.cos(A))+Math.abs(m*Math.sin(A))),D=Image$1.createFrom(this,{width:y,height:B}),O=Math.cos(-A),N=Math.sin(-A);let j=y/2,G=B/2;y%2==0?(j=j-.5,B%2==0?G=G-.5:G=Math.floor(G)):(j=Math.floor(j),B%2==0?G=G-.5:G=Math.floor(G));const H=Math.floor(m/2-j),te=Math.floor(w/2-G);switch(T){case validInterpolations.nearestneighbor:return rotateNearestNeighbor(this,D,H,te,j,G,O,N);case validInterpolations.bilinear:return rotateBilinear(this,D,H,te,j,G,O,N);default:throw new Error(`unsupported rotate interpolation: ${T}`)}}function rotateNearestNeighbor(h,l,p,m,w,T,A,y){for(let B=0;B<l.width;B+=1)for(let D=0;D<l.height;D+=1)for(let O=0;O<h.channels;O++){let N=Math.round((B-w)*A-(D-T)*y+w)+p,j=Math.round((D-T)*A+(B-w)*y+T)+m;N<0||N>=h.width||j<0||j>=h.height?h.alpha===1&&O===h.channels-1?l.setValueXY(B,D,O,0):l.setValueXY(B,D,O,h.maxValue):l.setValueXY(B,D,O,h.getValueXY(N,j,O))}return l}function rotateBilinear(h,l,p,m,w,T,A,y){let B=h.width*h.channels;for(let D=0;D<l.height;D++)for(let O=0;O<l.width;O++){let N=(O-w)*A-(D-T)*y+w+p,j=(D-T)*A+(O-w)*y+T+m,G=N|0,H=j|0,te=N-G,oe=j-H;for(let Q=0;Q<h.channels;Q++)if(N<0||N>=h.width||j<0||j>=h.height)h.alpha===1&&Q===h.channels-1?l.setValueXY(O,D,Q,0):l.setValueXY(O,D,Q,h.maxValue);else{let _e=(H*h.width+G)*h.channels+Q,se=h.data[_e],he=h.data[_e+h.channels],me=h.data[_e+B],Re=h.data[_e+B+h.channels],ge=se+te*(he-se)+oe*(me-se)+te*oe*(se-he-me+Re)|0;l.setValueXY(O,D,Q,ge)}}return l}function rotate$1(h,l){if(typeof h!="number")throw new TypeError("angle must be a number");switch(h<0&&(h=Math.ceil(-h/360)*360+h),h%360){case 0:return this.clone();case 90:return rotateRight.call(this);case 180:return rotate180.call(this);case 270:return rotateLeft.call(this);default:return rotateFree.call(this,h,l)}}function rotateLeft(){const h=Image$1.createFrom(this,{width:this.height,height:this.width}),l=h.height-1;for(let p=0;p<this.height;p++)for(let m=0;m<this.width;m++)for(let w=0;w<this.channels;w++)h.setValueXY(p,l-m,w,this.getValueXY(m,p,w));return h}function rotateRight(){const h=Image$1.createFrom(this,{width:this.height,height:this.width}),l=h.width-1;for(let p=0;p<this.height;p++)for(let m=0;m<this.width;m++)for(let w=0;w<this.channels;w++)h.setValueXY(l-p,m,w,this.getValueXY(m,p,w));return h}function rotate180(){const h=Image$1.createFrom(this),l=h.width-1,p=h.height-1;for(let m=0;m<this.height;m++)for(let w=0;w<this.width;w++)for(let T=0;T<this.channels;T++)h.setValueXY(l-w,p-m,T,this.getValueXY(w,m,T));return h}function insert(h,l={}){const p=getImageParameters(h);this.checkProcessable("insert",p);let{x:m=0,y:w=0}=l;const T=getOutputImageOrInPlace(this,l,{copy:!0}),A=Math.min(T.height,w+h.height),y=Math.min(T.width,m+h.width);if(T.bitDepth===1)for(let B=w;B<A;B++)for(let D=m;D<y;D++)h.getBitXY(D-m,B-w)?T.setBitXY(D,B):T.clearBitXY(D,B);else for(let B=w;B<A;B++)for(let D=m;D<y;D++)T.setPixelXY(D,B,h.getPixelXY(D-m,B-w));return T}function setBorder(h={}){let{size:l=0,algorithm:p="copy",color:m}=h;if(this.checkProcessable("setBorder",{bitDepth:[8,16,32,64]}),p==="set"){if(m.length!==this.channels)throw new Error(`setBorder: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let y=0;y<m.length;y++)m[y]===0&&(m[y]=.001)}else m=newArray_1(this.channels,null);Array.isArray(l)||(l=[l,l]);let w=l[0],T=l[1],A=this.channels;for(let y=w;y<this.width-w;y++)for(let B=0;B<A;B++){let D=m[B]||this.data[(y+this.width*T)*A+B];for(let O=0;O<T;O++)this.data[(O*this.width+y)*A+B]=D;D=m[B]||this.data[(y+this.width*(this.height-T-1))*A+B];for(let O=this.height-T;O<this.height;O++)this.data[(O*this.width+y)*A+B]=D}for(let y=0;y<this.height;y++)for(let B=0;B<A;B++){let D=m[B]||this.data[(y*this.width+w)*A+B];for(let O=0;O<w;O++)this.data[(y*this.width+O)*A+B]=D;D=m[B]||this.data[(y*this.width+this.width-w-1)*A+B];for(let O=this.width-w;O<this.width;O++)this.data[(y*this.width+O)*A+B]=D}return this}function split(h={}){let{preserveAlpha:l=!0}=h;if(this.checkProcessable("split",{bitDepth:[8,16]}),this.components===1)return new Stack([this.clone()]);let p=new Stack,m=this.data;if(this.alpha&&l)for(let w=0;w<this.components;w++){let T=Image$1.createFrom(this,{components:1,alpha:!0,colorModel:GREY$1}),A=0;for(let y=0;y<m.length;y+=this.channels)T.data[A++]=m[y+w],T.data[A++]=m[y+this.components];p.push(T)}else for(let w=0;w<this.channels;w++){let T=Image$1.createFrom(this,{components:1,alpha:!1,colorModel:GREY$1}),A=0;for(let y=0;y<m.length;y+=this.channels)T.data[A++]=m[y+w];p.push(T)}return p}function getChannel(h,l={}){let{keepAlpha:p=!1,mergeAlpha:m=!1}=l;p&=this.alpha,m&=this.alpha,this.checkProcessable("getChannel",{bitDepth:[8,16]}),h=validateChannel(this,h);let w=Image$1.createFrom(this,{components:1,alpha:p,colorModel:GREY$1}),T=0;for(let A=0;A<this.data.length;A+=this.channels)m?w.data[T++]=this.data[A+h]*this.data[A+this.components]/this.maxValue:(w.data[T++]=this.data[A+h],p&&(w.data[T++]=this.data[A+this.components]));return w}function combineChannels(h=defaultCombineMethod,l={}){let{mergeAlpha:p=!1,keepAlpha:m=!1}=l;p&=this.alpha,m&=this.alpha,this.checkProcessable("combineChannels",{bitDepth:[8,16]});let w=Image$1.createFrom(this,{components:1,alpha:m,colorModel:GREY$1}),T=0;for(let A=0;A<this.size;A++){let y=h(this.getPixel(A));p?w.data[T++]=y*this.data[A*this.channels+this.components]/this.maxValue:(w.data[T++]=y,m&&(w.data[T++]=this.data[A*this.channels+this.components]))}return w}function defaultCombineMethod(h){return(h[0]+h[1]+h[2])/3}function setChannel(h,l){if(this.checkProcessable("setChannel",{bitDepth:[8,16]}),l.checkProcessable("setChannel (image parameter check)",{bitDepth:[this.bitDepth],alpha:[0],components:[1]}),l.width!==this.width||l.height!==this.height)throw new Error("Images must have exactly the same width and height");h=validateChannel(this,h);let p=h;for(let m=0;m<l.data.length;m++)this.data[p]=l.data[m],p+=this.channels;return this}function getSimilarity(h,l={}){let{shift:p=[0,0],average:m,channels:w,defaultAlpha:T,normalize:A,border:y=[0,0]}=l;if(this.checkProcessable("getSimilarity",{bitDepth:[8,16]}),Array.isArray(y)||(y=[y,y]),w=validateArrayOfChannels(this,{channels:w,defaultAlpha:T}),this.bitDepth!==h.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==h.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==h.colorModel)throw new Error("Both images must have the same colorModel");typeof m=="undefined"&&(m=!0);let B=Math.max(y[0],-p[0]),D=Math.min(this.width-y[0],this.width-p[0]),O=Math.max(y[1],-p[1]),N=Math.min(this.height-y[1],this.height-p[1]),j=newArray_1(w.length,0);for(let G=0;G<w.length;G++){let H=w[G],te=A?this.sum[H]:Math.max(this.sum[H],h.sum[H]),oe=A?h.sum[H]:Math.max(this.sum[H],h.sum[H]);if(te!==0&&oe!==0)for(let Q=B;Q<D;Q++)for(let _e=O;_e<N;_e++){let se=Q*this.multiplierX+_e*this.multiplierY+H,he=se+p[0]*this.multiplierX+p[1]*this.multiplierY;j[G]+=Math.min(this.data[se]/te,h.data[he]/oe)}}return m?j.reduce((G,H)=>G+H)/j.length:j}function getPixelsGrid(h={}){let{sampling:l=[10,10],painted:p=!1,mask:m}=h;this.checkProcessable("getPixelsGrid",{bitDepth:[8,16],channels:1}),Array.isArray(l)||(l=[l,l]);const w=l[0],T=l[1],A=[],y=[],B=this.width/w,D=this.height/T;let O=Math.floor(B/2);for(let j=0;j<w;j++){let G=Math.floor(D/2);for(let H=0;H<T;H++){let te=Math.round(O),oe=Math.round(G);(!m||m.getBitXY(te,oe))&&(A.push([te,oe]),y.push(this.getPixelXY(te,oe))),G+=D}O+=B}const N={xyS:A,zS:y};return p&&(N.painted=this.rgba8().paintPoints(A)),N}function Matrix(h,l,p){const m=new Array(h);for(let w=0;w<h;w++)m[w]=new Array(l);if(p)for(let w=0;w<h;w++)for(let T=0;T<l;T++)m[w][T]=p;return m.width=h,m.height=l,Object.setPrototypeOf(m,Matrix.prototype),m}Matrix.prototype.localMin=function(h,l){let p=this[h][l],m=[h,l];for(let w=Math.max(0,h-1);w<Math.min(this.length,h+2);w++)for(let T=Math.max(0,l-1);T<Math.min(this[0].length,l+2);T++)this[w][T]<p&&(p=this[w][T],m=[w,T]);return{position:m,value:p}};Matrix.prototype.localMax=function(h,l){let p=this[h][l],m=[h,l];for(let w=Math.max(0,h-1);w<Math.min(this.length,h+2);w++)for(let T=Math.max(0,l-1);T<Math.min(this[0].length,l+2);T++)this[w][T]>p&&(p=this[w][T],m=[w,T]);return{position:m,value:p}};Matrix.prototype.localSearch=function(h,l,p){let m=[];for(let w=Math.max(0,h-1);w<Math.min(this.length,h+2);w++)for(let T=Math.max(0,l-1);T<Math.min(this[0].length,l+2);T++)this[w][T]===p&&m.push([w,T]);return m};function getBestMatch(h,l={}){let{border:p}=l;if(this.checkProcessable("getChannel",{bitDepth:[8,16]}),this.bitDepth!==h.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==h.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==h.colorModel)throw new Error("Both images must have the same colorModel");let m=new Matrix(h.width,h.height,-1/0),w=Math.floor(h.width/2),T=Math.floor(h.height/2),A=w,y=T,B=!1;for(;!B;){let D=m.localSearch(w,T,-1/0);for(let N=0;N<D.length;N++){let j=D[N],G=this.getSimilarity(h,{border:p,shift:[A-j[0],y-j[1]]});m[j[0]][j[1]]=G}let O=m.localMax(w,T);O.position[0]!==w||O.position[1]!==T?(w=O.position[0],T=O.position[1]):B=!0}return[w-A,T-y]}function getRow(h,l=0){this.checkProcessable("getRow",{bitDepth:[8,16]}),checkRow(this,h),checkChannel(this,l);let p=new Array(this.width),m=0,w=h*this.width*this.channels+l,T=w+this.width*this.channels;for(let A=w;A<T;A+=this.channels)p[m++]=this.data[A];return p}function getColumn(h,l=0){this.checkProcessable("getColumn",{bitDepth:[8,16]}),checkColumn(this,h),checkChannel(this,l);let p=new Array(this.height),m=0,w=this.width*this.channels;for(let T=l+h*this.channels;T<this.data.length;T+=w)p[m++]=this.data[T];return p}function getMatrix(h={}){let{channel:l}=h;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),l===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");l=0}let p=new Matrix$2(this.height,this.width);for(let m=0;m<this.height;m++)for(let w=0;w<this.width;w++)p.set(m,w,this.getValueXY(w,m,l));return p}function setMatrix(h,l={}){h=new Matrix$2(h);let{channel:p}=l;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),p===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");p=0}if(this.width!==h.columns||this.height!==h.rows)throw new RangeError("The size of the matrix must be equal to the size of the image");for(let m=0;m<this.height;m++)for(let w=0;w<this.width;w++)this.setValueXY(w,m,p,h.get(m,w))}function getPixelsArray(){this.checkProcessable("getPixelsArray",{bitDepth:[8,16,32]});let h=new Array(this.size),l=0;for(let p=0;p<this.data.length;p+=this.channels){let m=new Array(this.components);for(let w=0;w<this.components;w++)m[w]=this.data[p+w];h[l++]=m}return h}function getIntersection(h){let l=this,p=l.getClosestCommonParent(h),m=l.getRelativePosition(p,{defaultFurther:!0}),w=getRelativePositionForAllPixels(l,m),T=h.getRelativePosition(p,{defaultFurther:!0}),A=getRelativePositionForAllPixels(h,T),y=getCommonSurface(w,A),B={whitePixelsMask1:[],whitePixelsMask2:[],commonWhitePixels:[]};for(let D=0;D<y.length;D++){let O=y[D],N=[O[0]-m[0],O[1]-m[1]],j=[O[0]-T[0],O[1]-T[1]],G=l.getBitXY(N[0],N[1]),H=h.getBitXY(j[0],j[1]);G===1&&H===1&&B.commonWhitePixels.push(O)}for(let D=0;D<w.length;D++){let O,N;D!==0&&(O=Math.floor(D/l.width),N=D%l.width),l.getBitXY(O,N)===1&&B.whitePixelsMask1.push(w[D])}for(let D=0;D<A.length;D++){let O=0,N=0;D!==0&&(O=Math.floor(D/h.width),N=D%h.width),h.getBitXY(O,N)===1&&B.whitePixelsMask2.push(A[D])}return B}function getRelativePositionForAllPixels(h,l){let p=[];for(let m=0;m<h.height;m++)for(let w=0;w<h.width;w++){let T=[m,w];p.push([T[0]+l[0],T[1]+l[1]])}return p}function getCommonSurface(h,l){let p=0,m=0,w=[];for(;p<h.length&&m<l.length;)h[p][0]===l[m][0]&&h[p][1]===l[m][1]?(w.push(h[p]),p++,m++):h[p][0]<l[m][0]||h[p][0]===l[m][0]&&h[p][1]<l[m][1]?p++:m++;return w}function getClosestCommonParent(h){let l=getDepth(this),p=getDepth(h),m;if(l>=p?m=getFurthestParent(this,l):m=getFurthestParent(h,p),l===0||p===0)return m;let w=this,T=h;for(;l!==p;)if(l>p){if(w=w.parent,w===null)return m;l=l-1}else{if(T=T.parent,T===null)return m;p=p-1}for(;w!==T&&w!==null&&T!==null;)if(w=w.parent,T=T.parent,w===null||T===null)return m;return w!==T?m:w}function getDepth(h){let l=0,p=h;for(;p.parent!=null;)p=p.parent,l++;return l}function getFurthestParent(h,l){let p=h;for(;l>0;)p=p.parent,l=l-1;return p}const defaultOptions$1={lowThreshold:10,highThreshold:30,gaussianBlur:1.1},Gx=[[-1,0,1],[-2,0,2],[-1,0,1]],Gy=[[-1,-2,-1],[0,0,0],[1,2,1]],convOptions={bitDepth:32,mode:"periodic"};function cannyEdgeDetector(h,l){h.checkProcessable("Canny edge detector",{bitDepth:8,channels:1,components:1}),l=Object.assign({},defaultOptions$1,l);const p=h.width,m=h.height,w=h.maxValue,T={sigma:l.gaussianBlur,radius:3},A=h.gaussianFilter(T),y=A.convolution(Gy,convOptions),B=A.convolution(Gx,convOptions),D=B.hypotenuse(y),O=h.constructor,N=new O(p,m,{kind:"GREY",bitDepth:32}),j=new O(p,m,{kind:"GREY",bitDepth:32}),G=new O(p,m,{kind:"GREY"});for(var H=1;H<p-1;H++)for(var te=1;te<m-1;te++){var oe=(Math.round(Math.atan2(B.getValueXY(H,te,0),y.getValueXY(H,te,0))*(5/Math.PI))+5)%5;oe===0&&(D.getValueXY(H,te,0)<=D.getValueXY(H,te-1,0)||D.getValueXY(H,te,0)<=D.getValueXY(H,te+1,0))||oe===1&&(D.getValueXY(H,te,0)<=D.getValueXY(H-1,te+1,0)||D.getValueXY(H,te,0)<=D.getValueXY(H+1,te-1,0))||oe===2&&(D.getValueXY(H,te,0)<=D.getValueXY(H-1,te,0)||D.getValueXY(H,te,0)<=D.getValueXY(H+1,te,0))||oe===3&&(D.getValueXY(H,te,0)<=D.getValueXY(H-1,te-1,0)||D.getValueXY(H,te,0)<=D.getValueXY(H+1,te+1,0))||N.setValueXY(H,te,0,D.getValueXY(H,te,0))}for(H=0;H<p*m;++H){var Q=N.data[H],_e=0;Q>l.highThreshold&&(_e++,G.data[H]=w),Q>l.lowThreshold&&_e++,j.data[H]=_e}var se=[];for(H=1;H<p-1;++H)for(te=1;te<m-1;++te){if(j.getValueXY(H,te,0)!==1)continue;e:for(var he=H-1;he<H+2;++he)for(var me=te-1;me<te+2;++me)if(j.getValueXY(he,me,0)===2){se.push([H,te]),G.setValueXY(H,te,0,w);break e}}for(;se.length>0;){var Re=[];for(H=0;H<se.length;++H)for(te=-1;te<2;++te)for(he=-1;he<2;++he)if(!(te===0&&he===0)){var ge=se[H][0]+te,ue=se[H][1]+he;j.getValueXY(ge,ue,0)===1&&G.getValueXY(ge,ue,0)===0&&(Re.push([ge,ue]),G.setValueXY(ge,ue,0,w))}se=Re}return G}function cannyEdge(h){return cannyEdgeDetector(this,h)}function extract(h,l={}){let{position:p}=l;if(this.checkProcessable("extract",{bitDepth:[1,8,16]}),!p&&(p=h.getRelativePosition(this),!p))throw new Error("extract : can not extract an image because the relative position can not be determined, try to specify manually the position as an array of 2 elements [x,y].");if(this.bitDepth>1){let m=Image$1.createFrom(this,{width:h.width,height:h.height,alpha:1,position:p,parent:this});for(let w=0;w<h.width;w++)for(let T=0;T<h.height;T++){for(let A=0;A<this.channels;A++){let y=this.getValueXY(w+p[0],T+p[1],A);m.setValueXY(w,T,A,y)}h.getBitXY(w,T)||m.setValueXY(w,T,this.components,0)}return m}else{let m=Image$1.createFrom(this,{width:h.width,height:h.height,position:p,parent:this});for(let w=0;w<h.height;w++)for(let T=0;T<h.width;T++)h.getBitXY(T,w)&&this.getBitXY(T+p[0],w+p[1])&&m.setBitXY(T,w);return m}}var fastList={exports:{}};(function(h,l){(function(){function p(w,T,A){this.next=A,A&&(A.prev=this),this.prev=T,T&&(T.next=this),this.data=w}function m(){if(!(this instanceof m))return new m;this._head=null,this._tail=null,this.length=0}m.prototype={push:function(w){this._tail=new p(w,this._tail,null),this._head||(this._head=this._tail),this.length++},pop:function(){if(this.length!==0){var w=this._tail;return this._tail=w.prev,w.prev&&(w.prev=this._tail.next=null),this.length--,this.length===1?this._head=this._tail:this.length===0&&(this._head=this._tail=null),w.data}},unshift:function(w){this._head=new p(w,null,this._head),this._tail||(this._tail=this._head),this.length++},shift:function(){if(this.length!==0){var w=this._head;return this._head=w.next,w.next&&(w.next=this._head.prev=null),this.length--,this.length===1?this._tail=this._head:this.length===0&&(this._head=this._tail=null),w.data}},item:function(w){w<0&&(w=this.length+w);for(var T=this._head;w-- >0&&T;)T=T.next;return T?T.data:void 0},slice:function(w,T){if(w||(w=0),T||(T=this.length),T<0&&(T=this.length+T),w<0&&(w=this.length+w),T===w)return[];if(T<w)throw new Error("invalid offset: "+w+","+T+" (length="+this.length+")");for(var A=T-w,y=new Array(A),B=0,D=this._head;w-- >0&&D;)D=D.next;for(;B<A&&D;)y[B++]=D.data,D=D.next;return y},drop:function(){m.call(this)},forEach:function(w,T){for(var A=this._head,y=0,B=this.length;y<B&&A;)w.call(T||this,A.data,y,this),A=A.next,y++},map:function(w,T){var A=new m;return this.forEach(function(y,B,D){A.push(w.call(T||D,y,B,D))}),A},filter:function(w,T){var A=new m;return this.forEach(function(y,B,D){w.call(T||D,y,B,D)&&A.push(y)}),A},reduce:function(w,T,A){var y=0,B=this._head,D=this.length;for(T||(y=1,T=B&&B.data,B=B&&B.next);y<D&&B;)T=w.call(A||this,T,B.data,this),y++,B=B.next;return T}},h.exports=m})()})(fastList);var LinkedList=fastList.exports;function floodFill(h={}){const{x:l=0,y:p=0,inPlace:m=!0}=h,w=m?this:Image$1.createFrom(this);if(this.checkProcessable("floodFill",{bitDepth:1}),this.getBitXY(l,p))return w;const A=new LinkedList;for(A.push(new Node(l,p));A.length>0;){const y=A.shift();w.setBitXY(y.x,y.y);for(let B=y.x+1;B<this.width&&(!w.getBitXY(B,y.y)&&!this.getBitXY(B,y.y));B++)w.setBitXY(B,y.y),y.y+1<this.height&&!this.getBitXY(B,y.y+1)&&A.push(new Node(B,y.y+1)),y.y-1>=0&&!this.getBitXY(B,y.y-1)&&A.push(new Node(B,y.y-1));for(let B=y.x-1;B>=0&&(!w.getBitXY(B,y.y)&&!this.getBitXY(B,y.y));B++)w.setBitXY(B,y.y),y.y+1<this.height&&!this.getBitXY(B,y.y+1)&&A.push(new Node(B,y.y+1)),y.y-1>=0&&!this.getBitXY(B,y.y-1)&&A.push(new Node(B,y.y-1))}return w}function Node(h,l){this.x=h,this.y=l}function _extends(){return _extends=Object.assign||function(h){for(var l=1;l<arguments.length;l++){var p=arguments[l];for(var m in p)Object.prototype.hasOwnProperty.call(p,m)&&(h[m]=p[m])}return h},_extends.apply(this,arguments)}function hsv2rgb(h,l,p){l=l/100,p=p/100;var m=[],w=p*l,T=h/60,A=w*(1-Math.abs(T%2-1)),y=p-w;return T>=0&&T<1?m=[w,A,0]:T>=1&&T<2?m=[A,w,0]:T>=2&&T<3?m=[0,w,A]:h>=3&&T<4?m=[0,A,w]:h>=4&&T<5?m=[A,0,w]:h>=5&&T<=6?m=[w,0,A]:m=[0,0,0],{r:Math.round(255*(m[0]+y)),g:Math.round(255*(m[1]+y)),b:Math.round(255*(m[2]+y))}}function hsl2hsv(h,l,p){return l*=(p<50?p:100-p)/100,{h,s:2*l/(p+l)*100,v:p+l}}function hsl2rgb$1(h,l,p){var m=hsl2hsv(h,l,p);return hsv2rgb(m.h,m.s,m.v)}var colors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]};function parse(h){return named(h)||hex3(h)||hex6(h)||rgb(h)||rgba$1(h)||hsl(h)||hsla(h)}function named(h){var l=colors[h.toLowerCase()];if(!!l)return{r:l[0],g:l[1],b:l[2],a:100}}function rgb(h){var l=h.match(/rgb\(([^)]+)\)/);if(l){var p=l[1].split(/ *, */).map(Number);return{r:p[0],g:p[1],b:p[2],a:100}}}function rgba$1(h){var l=h.match(/rgba\(([^)]+)\)/);if(l){var p=l[1].split(/ *, */).map(Number);return{r:p[0],g:p[1],b:p[2],a:p[3]*100}}}function hex6(h){if(h[0]==="#"&&h.length===7)return{r:parseInt(h.slice(1,3),16),g:parseInt(h.slice(3,5),16),b:parseInt(h.slice(5,7),16),a:100}}function hex3(h){if(h[0]==="#"&&h.length===4)return{r:parseInt(h[1]+h[1],16),g:parseInt(h[2]+h[2],16),b:parseInt(h[3]+h[3],16),a:100}}function hsl(h){var l=h.match(/hsl\(([^)]+)\)/);if(l){var p=l[1].split(/ *, */),m=parseInt(p[0],10),w=parseInt(p[1],10),T=parseInt(p[2],10),A=hsl2rgb$1(m,w,T);return _extends({},A,{a:100})}}function hsla(h){var l=h.match(/hsla\(([^)]+)\)/);if(l){var p=l[1].split(/ *, */),m=parseInt(p[0],10),w=parseInt(p[1],10),T=parseInt(p[2],10),A=parseInt(parseFloat(p[3])*100,10),y=hsl2rgb$1(m,w,T);return _extends({},y,{a:A})}}function css2array(h){let l=parse(h);return[l.r,l.g,l.b,Math.round(l.a*255/100)]}function hue2rgb(h,l,p){return p<0&&(p+=1),p>1&&(p-=1),p<1/6?h+(l-h)*6*p:p<1/2?l:p<2/3?h+(l-h)*(2/3-p)*6:h}function hsl2rgb(h,l,p){let m,w,T,A,y,B;return l/=100,p/=100,l===0?A=y=B=p*255:(p<=.5?w=p*(l+1):w=p+l-p*l,m=p*2-w,T=h/360,A=hue2rgb(m,w,T+1/3),y=hue2rgb(m,w,T),B=hue2rgb(m,w,T-1/3)),{r:A,g:y,b:B}}function getDistinctColors(h){let l=new Array(h),p=0;for(let m=0;m<360;m+=360/h){p++;let w=hsl2rgb(m,100,30+p%4*15);l[p-1]=[Math.round(w.r*255),Math.round(w.g*255),Math.round(w.b*255)]}return l}function getRandomColor(){return[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)]}function getColors(h){let{color:l,colors:p,randomColors:m,numberColors:w=50}=h;if(l&&!Array.isArray(l)&&(l=css2array(l)),l)return[l];if(p)return p=p.map(function(T){return Array.isArray(T)?T:css2array(T)}),p;if(m){p=new Array(w);for(let T=0;T<w;T++)p[T]=getRandomColor()}return getDistinctColors(w)}function paintLabels(h,l,p={}){let{color:m="blue",colors:w,font:T="12px Helvetica",rotate:A=0}=p;if(this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1}),!Array.isArray(h))throw Error("paintLabels: labels must be an array");if(!Array.isArray(l))throw Error("paintLabels: positions must be an array");if(m&&!Array.isArray(m)&&(m=css2array(m)),w?w=w.map(function(D){return Array.isArray(D)?D:css2array(D)}):w=[m],h.length!==l.length)throw Error("paintLabels: positions and labels must be arrays from the same size");Array.isArray(T)||(T=[T]),Array.isArray(A)||(A=[A]);let B=this.getCanvas().getContext("2d");for(let D=0;D<h.length;D++){B.save();let O=w[D%w.length];B.fillStyle=`rgba(${O[0]},${O[1]},${O[2]},${O[3]/this.maxValue})`,B.font=T[D%T.length];let N=l[D];B.translate(N[0],N[1]),B.rotate(A[D%A.length]/180*Math.PI),B.fillText(h[D],0,0),B.restore()}return this.data=Uint8Array.from(B.getImageData(0,0,this.width,this.height).data),this}function paintMasks(h,l={}){let{alpha:p=255,labels:m=[],labelsPosition:w=[],labelColor:T="blue",labelFont:A="12px Helvetica"}=l;this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1});let y=getColors(Object.assign({},l,{numberColors:h.length}));Array.isArray(h)||(h=[h]);for(let B=0;B<h.length;B++){let D=h[B],O=y[B%y.length];for(let N=0;N<D.width;N++)for(let j=0;j<D.height;j++)if(D.getBitXY(N,j))for(let G=0;G<Math.min(this.components,O.length);G++)if(p===255)this.setValueXY(N+D.position[0],j+D.position[1],G,O[G]);else{let H=this.getValueXY(N+D.position[0],j+D.position[1],G);H=Math.round((H*(255-p)+O[G]*p)/255),this.setValueXY(N+D.position[0],j+D.position[1],G,H)}}if(Array.isArray(m)&&m.length>0){let D=this.getCanvas().getContext("2d");D.fillStyle=T,D.font=A;for(let O=0;O<Math.min(h.length,m.length);O++){let N=w[O]?w[O]:h[O].position;D.fillText(m[O],N[0],N[1])}this.data=Uint8Array.from(D.getImageData(0,0,this.width,this.height).data)}return this}function zerosMatrix(h,l){let p=new Array(h);for(let m=0;m<h;m++)p[m]=new Array(l).fill(0);return p}const cross=[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],smallCross=[[0,1,0],[1,1,1],[0,1,0]];class Shape{constructor(l={}){let{kind:p="cross",shape:m,size:w,width:T,height:A,filled:y=!0}=l;if(w&&(T=w,A=w),m)switch(m.toLowerCase()){case"square":case"rectangle":this.matrix=rectangle(T,A,{filled:y});break;case"circle":case"ellipse":this.matrix=ellipse(T,A,{filled:y});break;case"triangle":this.matrix=triangle(T,A,{filled:y});break;default:throw new Error(`Shape: unexpected shape: ${m}`)}else if(p)switch(p.toLowerCase()){case"cross":this.matrix=cross;break;case"smallcross":this.matrix=smallCross;break;default:throw new Error(`Shape: unexpected kind: ${p}`)}else throw new Error("Shape: expected a kind or a shape option");this.height=this.matrix.length,this.width=this.matrix[0].length,this.halfHeight=this.height/2>>0,this.halfWidth=this.width/2>>0}getPoints(){let l=this.matrix,p=[];for(let m=0;m<l.length;m++)for(let w=0;w<l[0].length;w++)l[m][w]&&p.push([w-this.halfWidth,m-this.halfHeight]);return p}getMask(){let l=new Image$1(this.width,this.height,{kind:BINARY});for(let p=0;p<this.matrix.length;p++)for(let m=0;m<this.matrix[0].length;m++)this.matrix[p][m]&&l.setBitXY(m,p);return l}}function rectangle(h,l,p){const m=zerosMatrix(l,h);if(p.filled)for(let w=0;w<l;w++)for(let T=0;T<h;T++)m[w][T]=1;else{for(let w of[0,l-1])for(let T=0;T<h;T++)m[w][T]=1;for(let w=0;w<l;w++)for(let T of[0,h-1])m[w][T]=1}return m}function ellipse(h,l,p){const m=zerosMatrix(l,h);let w=1-l%2,T=1-h%2,A=Math.floor((h-1)/2),y=Math.floor((l-1)/2),B=A*A,D=y*y;if(p.filled)for(let O=0;O<=y;O++){let N=Math.floor(Math.sqrt(B-B*O*O/D));for(let j=A-N;j<=A;j++)m[y-O][j]=1,m[y+O+w][j]=1,m[y-O][h-j-1]=1,m[y+O+w][h-j-1]=1}else{for(let O=0;O<=y;O++){let N=Math.floor(Math.sqrt(B-B*O*O/D)),j=A-N;m[y-O][j]=1,m[y+O+w][j]=1,m[y-O][h-j-1]=1,m[y+O+w][h-j-1]=1}for(let O=0;O<=A;O++){let N=Math.floor(Math.sqrt(D-D*O*O/B)),j=y-N;m[j][A-O]=1,m[j][A+O+T]=1,m[l-j-1][A-O]=1,m[l-j-1][A+O+T]=1}}return m}function triangle(h,l,p){if(!p.filled)throw new Error("Non filled triangle is not implemented");const m=zerosMatrix(l,h);for(let w=0;w<l;w++){let T=Math.floor((1-w/l)*h/2);for(let A=T;A<h-T;A++)m[w][A]=1}return m}function paintPoints(h,l={}){let{shape:p}=l;this.checkProcessable("paintPoints",{bitDepth:[8,16]});let m=getColors(Object.assign({},l,{numberColors:h.length})),w=new Shape(p).getPoints(),T=Math.min(this.channels,m[0].length);for(let A=0;A<h.length;A++){let y=m[A%m.length],B=h[A][0],D=h[A][1];for(let O=0;O<w.length;O++){let N=w[O][0],j=w[O][1];if(B+N>=0&&D+j>=0&&B+N<this.width&&D+j<this.height){let G=(B+N+(D+j)*this.width)*this.channels;for(let H=0;H<T;H++)this.data[G+H]=y[H]}}}return this}function paintPolyline(h,l={}){let{color:p=[this.maxValue,0,0],closed:m=!1}=l;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]});let w=Math.min(this.channels,p.length);for(let T=0;T<h.length-1+m;T++){let A=h[T],y=h[(T+1)%h.length],B=y[0]-A[0],D=y[1]-A[1],O=Math.max(Math.abs(B),Math.abs(D)),N=B/O,j=D/O,G=A[0],H=A[1];for(let te=0;te<=O;te++){let oe=Math.round(G),Q=Math.round(H);if(oe>=0&&Q>=0&&oe<this.width&&Q<this.height)if(this.bitDepth===1)this.setBitXY(oe,Q);else{let _e=(oe+Q*this.width)*this.channels;for(let se=0;se<w;se++)this.data[_e+se]=p[se]}G=G+N,H=H+j}}return this}function paintPolylines(h,l={}){let p=Object.assign({},l);this.checkProcessable("paintPolylines",{bitDepth:[8,16]});let m=getColors(Object.assign({},l,{numberColors:h.length}));for(let w=0;w<h.length;w++)p.color=m[w%m.length],this.paintPolyline(h[w],p);return this}function paintPolygon(h,l={}){let{color:p=[this.maxValue,0,0],filled:m=!1}=l;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]}),l.closed=!0;let w=deleteDouble(h);if(m===!1)return this.paintPolyline(h,l);{let T=Array(this.height);for(let A=0;A<this.height;A++){T[A]=[];for(let y=0;y<this.width;y++)T[A].push(0)}for(let A=0;A<w.length;A++){const y=lineBetweenTwoPoints(w[A],w[(A+1)%w.length]);for(let B=0;B<this.height;B++)for(let D=0;D<this.width;D++)isAtTheRightOfTheLine(D,B,y,this.height)&&(T[B][D]=T[B][D]===0?1:0)}for(let A=0;A<this.height;A++)for(let y=0;y<this.width;y++)if(T[A][y]===1)if(this.bitDepth===1)this.setBitXY(y,A);else{let B=Math.min(this.channels,p.length),D=(y+A*this.width)*this.channels;for(let O=0;O<B;O++)this.data[D+O]=p[O]}return this.paintPolyline(h,l)}}function deleteDouble(h){let l=[];for(let p=0;p<h.length;p++)if(!(h[p][0]===h[(p+1)%h.length][0]&&h[p][1]===h[(p+1)%h.length][1])){if(h[p][0]===h[(p-1+h.length)%h.length][0]&&h[p][1]===h[(p-1+h.length)%h.length][1])continue;if(h[(p+1)%h.length][0]===h[(p-1+h.length)%h.length][0]&&h[(p-1+h.length)%h.length][1]===h[(p+1)%h.length][1])continue;l.push(h[p])}return l}function lineBetweenTwoPoints(h,l){if(h[0]===l[0])return{a:0,b:h[0],vertical:!0};{const p=(l[1]-h[1])/(l[0]-h[0]),m=h[1]-p*h[0];return{a:p,b:m,vertical:!1}}}function isAtTheRightOfTheLine(h,l,p,m){if(p.vertical===!0)return p.b<=h;if(p.a===0)return!1;{const w=(l-p.b)/p.a;return w<h&&w>=0&&w<=m}}function paintPolygons(h,l={}){let p=Object.assign({},l);this.checkProcessable("paintPolygons",{bitDepth:[8,16]});let m=getColors(Object.assign({},l,{numberColors:h.length}));for(let w=0;w<h.length;w++)p.color=m[w%m.length],this.paintPolygon(h[w],p);return this}function getHistogram(h={}){let{maxSlots:l=256,channel:p,useAlpha:m=!0}=h;if(this.checkProcessable("getHistogram",{bitDepth:[1,8,16]}),p===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");p=0}return getChannelHistogram.call(this,p,{useAlpha:m,maxSlots:l})}function getHistograms(h={}){const{maxSlots:l=256,useAlpha:p=!0}=h;this.checkProcessable("getHistograms",{bitDepth:[8,16]});let m=new Array(p?this.components:this.channels);for(let w=0;w<m.length;w++)m[w]=getChannelHistogram.call(this,w,{useAlpha:p,maxSlots:l});return m}function getChannelHistogram(h,l){let{useAlpha:p,maxSlots:m}=l;if(this.bitDepth===1){let B=[0,0];for(let D=0;D<this.height;D++)for(let O=0;O<this.width;O++){let N=this.getBitXY(D,O);N===0?B[0]+=1:N===1&&(B[1]+=1)}return B}let w=Math.log2(m);if(!isInteger(w))throw new RangeError("maxSlots must be a power of 2, for example: 64, 256, 1024");let T=0;this.bitDepth>w&&(T=this.bitDepth-w);let A=this.data,y=newArray_1(Math.pow(2,Math.min(this.bitDepth,w)),0);if(p&&this.alpha){let B=this.channels-h-1;for(let D=h;D<A.length;D+=this.channels)y[A[D]>>T]+=A[D+B]/this.maxValue}else for(let B=h;B<A.length;B+=this.channels)y[A[B]>>T]++;return y}function getColorHistogram(h={}){let{useAlpha:l=!0,nbSlots:p=512}=h;this.checkProcessable("getColorHistogram",{bitDepth:[8,16],components:[3]});let m=Math.log(p)/Math.log(8);if(m!==Math.floor(m))throw new RangeError("nbSlots must be a power of 8. Usually 8, 64, 512 or 4096");let w=this.bitDepth-m,T=this.data,A=newArray_1(Math.pow(8,m),0),y=Math.pow(2,m*2),B=Math.pow(2,m);for(let D=0;D<T.length;D+=this.channels){let O=(T[D]>>w)*y+(T[D+1]>>w)*B+(T[D+2]>>w);l&&this.alpha?A[O]+=T[D+this.channels-1]/this.maxValue:A[O]++}return A}function min(){this.checkProcessable("min",{bitDepth:[8,16,32]});let h=newArray_1(this.channels,1/0);for(let l=0;l<this.data.length;l+=this.channels)for(let p=0;p<this.channels;p++)this.data[l+p]<h[p]&&(h[p]=this.data[l+p]);return h}function max(){this.checkProcessable("max",{bitDepth:[8,16,32]});let h=newArray_1(this.channels,-1/0);for(let l=0;l<this.data.length;l+=this.channels)for(let p=0;p<this.channels;p++)this.data[l+p]>h[p]&&(h[p]=this.data[l+p]);return h}function sum(){this.checkProcessable("sum",{bitDepth:[8,16]});let h=newArray_1(this.channels,0);for(let l=0;l<this.data.length;l+=this.channels)for(let p=0;p<this.channels;p++)h[p]+=this.data[l+p];return h}function getMoment(h=0,l=0){this.checkProcessable("getMoment",{bitDepth:[1]});let p=0;for(let m=0;m<this.width;m++)for(let w=0;w<this.height;w++)this.getBitXY(m,w)===1&&(p+=m**h*w**l);return p}function localMaxima(h={}){let{mask:l,region:p=3,removeClosePoints:m=0,invert:w=!1,maxEquals:T=2}=h,A=this;this.checkProcessable("localMaxima",{bitDepth:[8,16],components:1}),p*=4;let y=w?0:1,B=[1,0,-1,0,1,1,-1,-1,2,0,-2,0,2,2,-2,-2],D=[0,1,0,-1,1,-1,1,-1,0,2,0,-2,2,-2,2,-2],O=p<=8?1:2,N=[];for(let j=O;j<A.height-O;j++)for(let G=O;G<A.width-O;G++){if(l&&l.getBitXY(G,j)!==y)continue;let H=0,te=0,oe=A.data[G+j*A.width];for(let Q=0;Q<p;Q++)w?A.data[G+B[Q]+(j+D[Q])*A.width]>oe&&H++:A.data[G+B[Q]+(j+D[Q])*A.width]<oe&&H++,A.data[G+B[Q]+(j+D[Q])*A.width]===oe&&te++;H+te===p&&te<=T&&N.push([G,j])}if(m>0)for(let j=0;j<N.length;j++)for(let G=j+1;G<N.length;G++)Math.sqrt(Math.pow(N[j][0]-N[G][0],2)+Math.pow(N[j][1]-N[G][1],2))<m&&(N[j][0]=N[j][0]+N[G][0]>>1,N[j][1]=N[j][1]+N[G][1]>>1,N.splice(G,1),G--);return N}function mean(){let h=this.getHistograms({maxSlots:this.maxValue+1}),l=new Array(h.length);for(let p=0;p<h.length;p++){let m=h[p];l[p]=mean$2(m)}return l}function median(){let h=this.getHistograms({maxSlots:this.maxValue+1}),l=new Array(h.length);for(let p=0;p<h.length;p++){let m=h[p];l[p]=median$2(m)}return l}function points(){this.checkProcessable("points",{bitDepth:[1]});const h=[];for(let l=0;l<this.width;l++)for(let p=0;p<this.height;p++)this.getBitXY(l,p)===1&&h.push([l,p]);return h}function extendedPoints(){this.checkProcessable("extendedPoints",{bitDepth:[1]});const h=[];for(let l=0;l<this.height;l++)for(let p=0;p<this.width;p++)if(this.getBitXY(p,l)===1)for(h.push([p,l]),this.getBitXY(p+1,l)!==1?(h.push([p+1,l]),h.push([p+1,l+1]),this.getBitXY(p,l+1)!==1&&h.push([p,l+1])):this.getBitXY(p,l+1)!==1&&(h.push([p,l+1]),h.push([p+1,l+1]));p<this.width-2&&this.getBitXY(p+1,l)===1&&this.getBitXY(p+2,l)===1;)p++;return h}function getRelativePosition(h,l={}){if(this===h)return[0,0];let p=[0,0],m=this;for(;m;){if(m===h)return p;m.position&&(p[0]+=m.position[0],p[1]+=m.position[1]),m=m.parent}return l.defaultFurther?p:!1}function countAlphaPixels(h={}){let{alpha:l=1}=h;this.checkProcessable("countAlphaPixels",{bitDepth:[8,16],alpha:1});let p=0;if(l!==void 0){for(let m=this.components;m<this.data.length;m+=this.channels)this.data[m]===l&&p++;return p}else return this.size}function monotoneChainConvexHull$1(h,l={}){l.sorted||h.sort(byXThenY);const p=h.length,m=new Array(p*2);for(var w=0,T=0;T<p;T++){const y=h[T];for(;w>=2&&cw(m[w-2],m[w-1],y)<=0;)w--;m[w++]=y}const A=w+1;for(T=p-2;T>=0;T--){const y=h[T];for(;w>=A&&cw(m[w-2],m[w-1],y)<=0;)w--;m[w++]=y}return m.slice(0,w-1)}function cw(h,l,p){return(l[1]-h[1])*(p[0]-h[0])-(l[0]-h[0])*(p[1]-h[1])}function byXThenY(h,l){return h[0]===l[0]?h[1]-l[1]:h[0]-l[0]}function monotoneChainConvexHull(){return monotoneChainConvexHull$1(this.extendedPoints,{sorted:!1})}function round(h){for(let l=0;l<h.length;l++)h[l][0]=Math.round(h[l][0]),h[l][1]=Math.round(h[l][1]);return h}function difference(h,l){return[h[0]-l[0],h[1]-l[1]]}function normalize(h){let l=Math.sqrt(h[0]**2+h[1]**2);return[h[0]/l,h[1]/l]}function rotate(h,l,p){p===void 0&&(p=new Array(l.length));let m=Math.cos(h),w=Math.sin(h);for(let T=0;T<p.length;++T)p[T]=[m*l[T][0]-w*l[T][1],w*l[T][0]+m*l[T][1]];return p}function perimeter(h){let l=0;for(let p=0;p<h.length;p++){let m=h[p][0],w=h[p][1],T=h[p===h.length-1?0:p+1][0],A=h[p===h.length-1?0:p+1][1];l+=Math.sqrt((T-m)**2+(A-w)**2)}return l}function surface(h){let l=0;for(let p=0;p<h.length;p++){let m=h[p][0],w=h[p===h.length-1?0:p+1][1],T=h[p===h.length-1?0:p+1][0],A=h[p][1];l+=m*w*.5,l-=T*A*.5}return Math.abs(l)}function minMax(h){let l=1/0,p=1/0,m=-1/0,w=-1/0;for(let T=0;T<h.length;T++)h[T][0]<l&&(l=h[T][0]),h[T][0]>m&&(m=h[T][0]),h[T][1]<p&&(p=h[T][1]),h[T][1]>w&&(w=h[T][1]);return[[l,p],[m,w]]}function moveToZeroZero(h,l){l===void 0&&(l=new Array(h.length).fill(0).map(()=>[]));let p=minMax(h),m=p[0][0],w=p[0][1];for(let T=0;T<h.length;T++)l[T][0]=h[T][0]-m,l[T][1]=h[T][1]-w;return l}function minimalBoundingRectangle(h={}){const{originalPoints:l=monotoneChainConvexHull.call(this)}=h;if(l.length===0)return[];if(l.length===1)return[l[0],l[0],l[0],l[0]];const p=new Array(l.length);let m=1/0,w=0,T;for(let A=0;A<p.length;A++){let y=getAngle$1(l[A],l[(A+1)%p.length]);rotate(-y,l,p);let B=p[A][0],D=p[A][1],O=p[(A+1)%p.length][0],N=p[(A+1)%p.length][1],j=!0,G=0,H=0,te=0;for(let se=0;se<p.length;se++){let he=p[se][0],me=p[se][1],Re=(he-B)/(O-B);j===!0?(j=!1,G=Re,H=Re):(Re<G&&(G=Re),Re>H&&(H=Re));let ge=(-(O-B)*me+O*D-N*B)/(O-B);Math.abs(ge)>Math.abs(te)&&(te=ge)}let oe=[B+G*(O-B),D],Q=[B+H*(O-B),D],_e=Math.abs(te*(G-H)*(O-B));_e<m&&(w=y,m=_e,T=[oe,Q,[Q[0],Q[1]-te],[oe[0],oe[1]-te]])}return rotate(w,T,T),T}function getAngle$1(h,l){let p=difference(l,h),m=normalize(p),w=Math.acos(m[0]);return m[1]<0?-w:w}function extend$4(h){let l={inPlace:!0};h.extendMethod("invert",invert),h.extendMethod("abs",abs),h.extendMethod("level",level,l),h.extendMethod("add",add,l),h.extendMethod("subtract",subtract,l),h.extendMethod("subtractImage",subtractImage),h.extendMethod("multiply",multiply,l),h.extendMethod("divide",divide,l),h.extendMethod("hypotenuse",hypotenuse),h.extendMethod("background",background$1),h.extendMethod("flipX",flipX),h.extendMethod("flipY",flipY),h.extendMethod("blurFilter",blurFilter),h.extendMethod("medianFilter",medianFilter),h.extendMethod("gaussianFilter",gaussianFilter),h.extendMethod("sobelFilter",sobelFilter),h.extendMethod("gradientFilter",gradientFilter),h.extendMethod("scharrFilter",scharrFilter),h.extendMethod("dilate",dilate),h.extendMethod("erode",erode),h.extendMethod("open",open),h.extendMethod("close",close),h.extendMethod("topHat",topHat),h.extendMethod("blackHat",blackHat),h.extendMethod("morphologicalGradient",morphologicalGradient),h.extendMethod("warpingFourPoints",warpingFourPoints),h.extendMethod("crop",crop),h.extendMethod("cropAlpha",cropAlpha),h.extendMethod("resize",resize).extendMethod("scale",resize),h.extendMethod("hsv",hsv),h.extendMethod("hsl",hsl$1),h.extendMethod("cmyk",cmyk),h.extendMethod("rgba8",rgba8),h.extendMethod("grey",grey).extendMethod("gray",grey),h.extendMethod("mask",mask),h.extendMethod("pad",pad),h.extendMethod("colorDepth",colorDepth),h.extendMethod("setBorder",setBorder,l),h.extendMethod("rotate",rotate$1),h.extendMethod("rotateLeft",rotateLeft),h.extendMethod("rotateRight",rotateRight),h.extendMethod("insert",insert),h.extendMethod("getRow",getRow),h.extendMethod("getColumn",getColumn),h.extendMethod("getMatrix",getMatrix),h.extendMethod("setMatrix",setMatrix),h.extendMethod("getPixelsArray",getPixelsArray),h.extendMethod("getIntersection",getIntersection),h.extendMethod("getClosestCommonParent",getClosestCommonParent),h.extendMethod("getThreshold",getThreshold),h.extendMethod("split",split),h.extendMethod("getChannel",getChannel),h.extendMethod("combineChannels",combineChannels),h.extendMethod("setChannel",setChannel),h.extendMethod("getSimilarity",getSimilarity),h.extendMethod("getPixelsGrid",getPixelsGrid),h.extendMethod("getBestMatch",getBestMatch),h.extendMethod("cannyEdge",cannyEdge),h.extendMethod("convolution",convolution),h.extendMethod("extract",extract),h.extendMethod("floodFill",floodFill),h.extendMethod("paintLabels",paintLabels,l),h.extendMethod("paintMasks",paintMasks,l),h.extendMethod("paintPoints",paintPoints,l),h.extendMethod("paintPolyline",paintPolyline,l),h.extendMethod("paintPolylines",paintPolylines,l),h.extendMethod("paintPolygon",paintPolygon,l),h.extendMethod("paintPolygons",paintPolygons,l),h.extendMethod("countAlphaPixels",countAlphaPixels),h.extendMethod("monotoneChainConvexHull",monotoneChainConvexHull),h.extendMethod("minimalBoundingRectangle",minimalBoundingRectangle),h.extendMethod("getHistogram",getHistogram).extendProperty("histogram",getHistogram),h.extendMethod("getHistograms",getHistograms).extendProperty("histograms",getHistograms),h.extendMethod("getColorHistogram",getColorHistogram).extendProperty("colorHistogram",getColorHistogram),h.extendMethod("getMin",min).extendProperty("min",min),h.extendMethod("getMax",max).extendProperty("max",max),h.extendMethod("getSum",sum).extendProperty("sum",sum),h.extendMethod("getMoment",getMoment).extendProperty("moment",getMoment),h.extendMethod("getLocalMaxima",localMaxima),h.extendMethod("getMedian",median).extendProperty("median",median),h.extendMethod("getMean",mean).extendProperty("mean",mean),h.extendMethod("getPoints",points).extendProperty("points",points),h.extendMethod("getExtendedPoints",extendedPoints).extendProperty("extendedPoints",extendedPoints),h.extendMethod("getRelativePosition",getRelativePosition)}var quantities={exports:{}};(function(h,l){(function(p,m){h.exports=m()})(commonjsGlobal,function(){function p(we){return typeof we=="string"||we instanceof String}var m=Number.isFinite||window.isFinite;function w(we){return m(we)}function T(we){return we}function A(we){var Xe={};return we.filter(function(ae){return Xe.hasOwnProperty(ae)?!1:Xe[ae]=!0})}function y(we,Xe){if(Xe.length!==we.length)return!1;for(var ae=0;ae<we.length;ae++)if(Xe[ae].compareArray&&!Xe[ae].compareArray(we[ae])||Xe[ae]!==we[ae])return!1;return!0}function B(we,Xe){Object.keys(Xe).forEach(function(ae){we[ae]=Xe[ae]})}function D(){for(var we=1,Xe=0,ae=0;ae<arguments.length;ae++){var K=arguments[ae];Xe=Xe+j(K),we*=K}return Xe!==0?N(we,Xe):we}function O(we,Xe){if(Xe===0)throw new Error("Divide by zero");var ae=Math.pow(10,j(Xe)),K=ae/(ae*Xe);return D(we,K)}function N(we,Xe){return Math.round(we*Math.pow(10,Xe))/Math.pow(10,Xe)}function j(we){if(!isFinite(we))return 0;for(var Xe=0;we%1!=0;)we*=10,Xe++;return Xe}function G(){var we;if(!this)return we=Object.create(G.prototype),G.apply(we,arguments),we;we=Error.apply(this,arguments),this.name="QtyError",this.message=we.message,this.stack=we.stack}G.prototype=Object.create(Error.prototype,{constructor:{value:G}});function H(we,Xe){throw new G("Incompatible units: "+we+" and "+Xe)}var te={"<googol>":[["googol"],1e100,"prefix"],"<kibi>":[["Ki","Kibi","kibi"],Math.pow(2,10),"prefix"],"<mebi>":[["Mi","Mebi","mebi"],Math.pow(2,20),"prefix"],"<gibi>":[["Gi","Gibi","gibi"],Math.pow(2,30),"prefix"],"<tebi>":[["Ti","Tebi","tebi"],Math.pow(2,40),"prefix"],"<pebi>":[["Pi","Pebi","pebi"],Math.pow(2,50),"prefix"],"<exi>":[["Ei","Exi","exi"],Math.pow(2,60),"prefix"],"<zebi>":[["Zi","Zebi","zebi"],Math.pow(2,70),"prefix"],"<yebi>":[["Yi","Yebi","yebi"],Math.pow(2,80),"prefix"],"<yotta>":[["Y","Yotta","yotta"],1e24,"prefix"],"<zetta>":[["Z","Zetta","zetta"],1e21,"prefix"],"<exa>":[["E","Exa","exa"],1e18,"prefix"],"<peta>":[["P","Peta","peta"],1e15,"prefix"],"<tera>":[["T","Tera","tera"],1e12,"prefix"],"<giga>":[["G","Giga","giga"],1e9,"prefix"],"<mega>":[["M","Mega","mega"],1e6,"prefix"],"<kilo>":[["k","kilo"],1e3,"prefix"],"<hecto>":[["h","Hecto","hecto"],100,"prefix"],"<deca>":[["da","Deca","deca","deka"],10,"prefix"],"<deci>":[["d","Deci","deci"],.1,"prefix"],"<centi>":[["c","Centi","centi"],.01,"prefix"],"<milli>":[["m","Milli","milli"],.001,"prefix"],"<micro>":[["u","\u03BC","\xB5","Micro","mc","micro"],1e-6,"prefix"],"<nano>":[["n","Nano","nano"],1e-9,"prefix"],"<pico>":[["p","Pico","pico"],1e-12,"prefix"],"<femto>":[["f","Femto","femto"],1e-15,"prefix"],"<atto>":[["a","Atto","atto"],1e-18,"prefix"],"<zepto>":[["z","Zepto","zepto"],1e-21,"prefix"],"<yocto>":[["y","Yocto","yocto"],1e-24,"prefix"],"<1>":[["1","<1>"],1,""],"<meter>":[["m","meter","meters","metre","metres"],1,"length",["<meter>"]],"<inch>":[["in","inch","inches",'"'],.0254,"length",["<meter>"]],"<foot>":[["ft","foot","feet","'"],.3048,"length",["<meter>"]],"<yard>":[["yd","yard","yards"],.9144,"length",["<meter>"]],"<mile>":[["mi","mile","miles"],1609.344,"length",["<meter>"]],"<naut-mile>":[["nmi","naut-mile"],1852,"length",["<meter>"]],"<league>":[["league","leagues"],4828,"length",["<meter>"]],"<furlong>":[["furlong","furlongs"],201.2,"length",["<meter>"]],"<rod>":[["rd","rod","rods"],5.029,"length",["<meter>"]],"<mil>":[["mil","mils"],254e-7,"length",["<meter>"]],"<angstrom>":[["ang","angstrom","angstroms"],1e-10,"length",["<meter>"]],"<fathom>":[["fathom","fathoms"],1.829,"length",["<meter>"]],"<pica>":[["pica","picas"],.00423333333,"length",["<meter>"]],"<point>":[["pt","point","points"],.000352777778,"length",["<meter>"]],"<redshift>":[["z","red-shift","redshift"],1302773e20,"length",["<meter>"]],"<AU>":[["AU","astronomical-unit"],1495979e5,"length",["<meter>"]],"<light-second>":[["ls","light-second"],299792500,"length",["<meter>"]],"<light-minute>":[["lmin","light-minute"],1798755e4,"length",["<meter>"]],"<light-year>":[["ly","light-year"],9460528e9,"length",["<meter>"]],"<parsec>":[["pc","parsec","parsecs"],3085678e10,"length",["<meter>"]],"<datamile>":[["DM","datamile"],1828.8,"length",["<meter>"]],"<kilogram>":[["kg","kilogram","kilograms"],1,"mass",["<kilogram>"]],"<AMU>":[["u","AMU","amu"],1660538921e-36,"mass",["<kilogram>"]],"<dalton>":[["Da","Dalton","Daltons","dalton","daltons"],1660538921e-36,"mass",["<kilogram>"]],"<slug>":[["slug","slugs"],14.5939029,"mass",["<kilogram>"]],"<short-ton>":[["tn","ton","short-ton"],907.18474,"mass",["<kilogram>"]],"<metric-ton>":[["tonne","metric-ton"],1e3,"mass",["<kilogram>"]],"<carat>":[["ct","carat","carats"],2e-4,"mass",["<kilogram>"]],"<pound>":[["lbs","lb","pound","pounds","#"],.45359237,"mass",["<kilogram>"]],"<ounce>":[["oz","ounce","ounces"],.0283495231,"mass",["<kilogram>"]],"<gram>":[["g","gram","grams","gramme","grammes"],.001,"mass",["<kilogram>"]],"<grain>":[["grain","grains","gr"],6479891e-11,"mass",["<kilogram>"]],"<dram>":[["dram","drams","dr"],.0017718452,"mass",["<kilogram>"]],"<stone>":[["stone","stones","st"],6.35029318,"mass",["<kilogram>"]],"<hectare>":[["hectare"],1e4,"area",["<meter>","<meter>"]],"<acre>":[["acre","acres"],4046.85642,"area",["<meter>","<meter>"]],"<sqft>":[["sqft"],1,"area",["<foot>","<foot>"]],"<liter>":[["l","L","liter","liters","litre","litres"],.001,"volume",["<meter>","<meter>","<meter>"]],"<gallon>":[["gal","gallon","gallons"],.0037854118,"volume",["<meter>","<meter>","<meter>"]],"<gallon-imp>":[["galimp","gallon-imp","gallons-imp"],.00454609,"volume",["<meter>","<meter>","<meter>"]],"<quart>":[["qt","quart","quarts"],.00094635295,"volume",["<meter>","<meter>","<meter>"]],"<pint>":[["pt","pint","pints"],.000473176475,"volume",["<meter>","<meter>","<meter>"]],"<pint-imp>":[["ptimp","pint-imp","pints-imp"],.00056826125,"volume",["<meter>","<meter>","<meter>"]],"<cup>":[["cu","cup","cups"],.000236588238,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce>":[["floz","fluid-ounce","fluid-ounces"],295735297e-13,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce-imp>":[["flozimp","floz-imp","fluid-ounce-imp","fluid-ounces-imp"],284130625e-13,"volume",["<meter>","<meter>","<meter>"]],"<tablespoon>":[["tb","tbsp","tbs","tablespoon","tablespoons"],147867648e-13,"volume",["<meter>","<meter>","<meter>"]],"<teaspoon>":[["tsp","teaspoon","teaspoons"],492892161e-14,"volume",["<meter>","<meter>","<meter>"]],"<bushel>":[["bu","bsh","bushel","bushels"],.035239072,"volume",["<meter>","<meter>","<meter>"]],"<oilbarrel>":[["bbl","oilbarrel","oilbarrels","oil-barrel","oil-barrels"],.158987294928,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel>":[["bl","bl-us","beerbarrel","beerbarrels","beer-barrel","beer-barrels"],.1173477658,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel-imp>":[["blimp","bl-imp","beerbarrel-imp","beerbarrels-imp","beer-barrel-imp","beer-barrels-imp"],.16365924,"volume",["<meter>","<meter>","<meter>"]],"<kph>":[["kph"],.277777778,"speed",["<meter>"],["<second>"]],"<mph>":[["mph"],.44704,"speed",["<meter>"],["<second>"]],"<knot>":[["kt","kn","kts","knot","knots"],.514444444,"speed",["<meter>"],["<second>"]],"<fps>":[["fps"],.3048,"speed",["<meter>"],["<second>"]],"<gee>":[["gee"],9.80665,"acceleration",["<meter>"],["<second>","<second>"]],"<Gal>":[["Gal"],.01,"acceleration",["<meter>"],["<second>","<second>"]],"<kelvin>":[["degK","kelvin"],1,"temperature",["<kelvin>"]],"<celsius>":[["degC","celsius","celsius","centigrade"],1,"temperature",["<kelvin>"]],"<fahrenheit>":[["degF","fahrenheit"],5/9,"temperature",["<kelvin>"]],"<rankine>":[["degR","rankine"],5/9,"temperature",["<kelvin>"]],"<temp-K>":[["tempK","temp-K"],1,"temperature",["<temp-K>"]],"<temp-C>":[["tempC","temp-C"],1,"temperature",["<temp-K>"]],"<temp-F>":[["tempF","temp-F"],5/9,"temperature",["<temp-K>"]],"<temp-R>":[["tempR","temp-R"],5/9,"temperature",["<temp-K>"]],"<second>":[["s","sec","secs","second","seconds"],1,"time",["<second>"]],"<minute>":[["min","mins","minute","minutes"],60,"time",["<second>"]],"<hour>":[["h","hr","hrs","hour","hours"],3600,"time",["<second>"]],"<day>":[["d","day","days"],3600*24,"time",["<second>"]],"<week>":[["wk","week","weeks"],7*3600*24,"time",["<second>"]],"<fortnight>":[["fortnight","fortnights"],1209600,"time",["<second>"]],"<year>":[["y","yr","year","years","annum"],31556926,"time",["<second>"]],"<decade>":[["decade","decades"],315569260,"time",["<second>"]],"<century>":[["century","centuries"],3155692600,"time",["<second>"]],"<pascal>":[["Pa","pascal","Pascal"],1,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<bar>":[["bar","bars"],1e5,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<mmHg>":[["mmHg"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inHg>":[["inHg"],3386.3881472,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<torr>":[["torr"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<atm>":[["atm","ATM","atmosphere","atmospheres"],101325,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<psi>":[["psi"],6894.76,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<cmh2o>":[["cmH2O","cmh2o"],98.0638,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inh2o>":[["inH2O","inh2o"],249.082052,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<poise>":[["P","poise"],.1,"viscosity",["<kilogram>"],["<meter>","<second>"]],"<stokes>":[["St","stokes"],1e-4,"viscosity",["<meter>","<meter>"],["<second>"]],"<mole>":[["mol","mole"],1,"substance",["<mole>"]],"<molar>":[["M","molar"],1e3,"concentration",["<mole>"],["<meter>","<meter>","<meter>"]],"<wtpercent>":[["wt%","wtpercent"],10,"concentration",["<kilogram>"],["<meter>","<meter>","<meter>"]],"<katal>":[["kat","katal","Katal"],1,"activity",["<mole>"],["<second>"]],"<unit>":[["U","enzUnit","unit"],16667e-19,"activity",["<mole>"],["<second>"]],"<farad>":[["F","farad","Farad"],1,"capacitance",["<second>","<second>","<second>","<second>","<ampere>","<ampere>"],["<meter>","<meter>","<kilogram>"]],"<coulomb>":[["C","coulomb","Coulomb"],1,"charge",["<ampere>","<second>"]],"<Ah>":[["Ah"],3600,"charge",["<ampere>","<second>"]],"<ampere>":[["A","Ampere","ampere","amp","amps"],1,"current",["<ampere>"]],"<siemens>":[["S","Siemens","siemens"],1,"conductance",["<second>","<second>","<second>","<ampere>","<ampere>"],["<kilogram>","<meter>","<meter>"]],"<henry>":[["H","Henry","henry"],1,"inductance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>","<ampere>"]],"<volt>":[["V","Volt","volt","volts"],1,"potential",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>"]],"<ohm>":[["Ohm","ohm","\u03A9","\u2126"],1,"resistance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>","<ampere>"]],"<weber>":[["Wb","weber","webers"],1,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<tesla>":[["T","tesla","teslas"],1,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<gauss>":[["G","gauss"],1e-4,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<maxwell>":[["Mx","maxwell","maxwells"],1e-8,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<oersted>":[["Oe","oersted","oersteds"],250/Math.PI,"magnetism",["<ampere>"],["<meter>"]],"<joule>":[["J","joule","Joule","joules"],1,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<erg>":[["erg","ergs"],1e-7,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<btu>":[["BTU","btu","BTUs"],1055.056,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<calorie>":[["cal","calorie","calories"],4.184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Calorie>":[["Cal","Calorie","Calories"],4184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<therm-US>":[["th","therm","therms","Therm","therm-US"],105480400,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Wh>":[["Wh"],3600,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<newton>":[["N","Newton","newton"],1,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<dyne>":[["dyn","dyne"],1e-5,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<pound-force>":[["lbf","pound-force"],4.448222,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<hertz>":[["Hz","hertz","Hertz"],1,"frequency",["<1>"],["<second>"]],"<radian>":[["rad","radian","radians"],1,"angle",["<radian>"]],"<degree>":[["deg","degree","degrees"],Math.PI/180,"angle",["<radian>"]],"<gradian>":[["gon","grad","gradian","grads"],Math.PI/200,"angle",["<radian>"]],"<steradian>":[["sr","steradian","steradians"],1,"solid_angle",["<steradian>"]],"<rotation>":[["rotation"],2*Math.PI,"angle",["<radian>"]],"<rpm>":[["rpm"],2*Math.PI/60,"angular_velocity",["<radian>"],["<second>"]],"<byte>":[["B","byte","bytes"],1,"information",["<byte>"]],"<bit>":[["b","bit","bits"],.125,"information",["<byte>"]],"<Bps>":[["Bps"],1,"information_rate",["<byte>"],["<second>"]],"<bps>":[["bps"],.125,"information_rate",["<byte>"],["<second>"]],"<dollar>":[["USD","dollar"],1,"currency",["<dollar>"]],"<cents>":[["cents"],.01,"currency",["<dollar>"]],"<candela>":[["cd","candela"],1,"luminosity",["<candela>"]],"<lumen>":[["lm","lumen"],1,"luminous_power",["<candela>","<steradian>"]],"<lux>":[["lux"],1,"illuminance",["<candela>","<steradian>"],["<meter>","<meter>"]],"<watt>":[["W","watt","watts"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere>":[["VA","volt-ampere"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere-reactive>":[["var","Var","VAr","VAR","volt-ampere-reactive"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<horsepower>":[["hp","horsepower"],745.699872,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<gray>":[["Gy","gray","grays"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<roentgen>":[["R","roentgen"],.00933,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<sievert>":[["Sv","sievert","sieverts"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<becquerel>":[["Bq","becquerel","becquerels"],1,"radiation",["<1>"],["<second>"]],"<curie>":[["Ci","curie","curies"],37e9,"radiation",["<1>"],["<second>"]],"<cpm>":[["cpm"],1/60,"rate",["<count>"],["<second>"]],"<dpm>":[["dpm"],1/60,"rate",["<count>"],["<second>"]],"<bpm>":[["bpm"],1/60,"rate",["<count>"],["<second>"]],"<dot>":[["dot","dots"],1,"resolution",["<each>"]],"<pixel>":[["pixel","px"],1,"resolution",["<each>"]],"<ppi>":[["ppi"],1,"resolution",["<pixel>"],["<inch>"]],"<dpi>":[["dpi"],1,"typography",["<dot>"],["<inch>"]],"<cell>":[["cells","cell"],1,"counting",["<each>"]],"<each>":[["each"],1,"counting",["<each>"]],"<count>":[["count"],1,"counting",["<each>"]],"<base-pair>":[["bp","base-pair"],1,"counting",["<each>"]],"<nucleotide>":[["nt","nucleotide"],1,"counting",["<each>"]],"<molecule>":[["molecule","molecules"],1,"counting",["<1>"]],"<dozen>":[["doz","dz","dozen"],12,"prefix_only",["<each>"]],"<percent>":[["%","percent"],.01,"prefix_only",["<1>"]],"<ppm>":[["ppm"],1e-6,"prefix_only",["<1>"]],"<ppt>":[["ppt"],1e-9,"prefix_only",["<1>"]],"<gross>":[["gr","gross"],144,"prefix_only",["<dozen>","<dozen>"]],"<decibel>":[["dB","decibel","decibels"],1,"logarithmic",["<decibel>"]]},oe=["<meter>","<kilogram>","<second>","<mole>","<ampere>","<radian>","<kelvin>","<temp-K>","<byte>","<dollar>","<candela>","<each>","<steradian>","<decibel>"],Q="<1>",_e=[Q];function se(we,Xe){var ae=Xe[1],K=Xe[3]||[],re=Xe[4]||[];if(!w(ae))throw new G(we+": Invalid unit definition. 'scalar' must be a number");K.forEach(function(de){if(te[de]===void 0)throw new G(we+": Invalid unit definition. Unit "+de+" in 'numerator' is not recognized")}),re.forEach(function(de){if(te[de]===void 0)throw new G(we+": Invalid unit definition. Unit "+de+" in 'denominator' is not recognized")})}var he={},me={},Re={},ge={},ue={};for(var Se in te)if(te.hasOwnProperty(Se)){var le=te[Se];if(le[2]==="prefix"){he[Se]=le[1];for(var pe=0;pe<le[0].length;pe++)me[le[0][pe]]=Se}else{se(Se,le),Re[Se]={scalar:le[1],numerator:le[3],denominator:le[4]};for(var Le=0;Le<le[0].length;Le++)ge[le[0][Le]]=Se}ue[Se]=le[0][0]}function Ze(we){var Xe,ae=[],K=Object.keys(te);if(typeof we=="undefined")for(Xe=0;Xe<K.length;Xe++)["","prefix"].indexOf(te[K[Xe]][2])===-1&&ae.push(K[Xe].substr(1,K[Xe].length-2));else{if(this.getKinds().indexOf(we)===-1)throw new G("Kind not recognized");for(Xe=0;Xe<K.length;Xe++)te[K[Xe]][2]===we&&ae.push(K[Xe].substr(1,K[Xe].length-2))}return ae.sort(function(re,de){return re.toLowerCase()<de.toLowerCase()?-1:re.toLowerCase()>de.toLowerCase()?1:0})}function lt(we){if(!ge[we])throw new G("Unit not recognized");return te[ge[we]][0]}var ct=["length","time","temperature","mass","current","substance","luminosity","currency","information","angle"];function $t(){if(this.signature)return this.signature;for(var we=Nt.call(this),Xe=0;Xe<we.length;Xe++)we[Xe]*=Math.pow(20,Xe);return we.reduce(function(ae,K){return ae+K},0)}function Nt(){if(!this.isBase())return Nt.call(this.toBase());for(var we=new Array(ct.length),Xe=0;Xe<we.length;Xe++)we[Xe]=0;for(var ae,K,re=0;re<this.numerator.length;re++)(ae=te[this.numerator[re]])&&(K=ct.indexOf(ae[2]),K>=0&&(we[K]=we[K]+1));for(var de=0;de<this.denominator.length;de++)(ae=te[this.denominator[de]])&&(K=ct.indexOf(ae[2]),K>=0&&(we[K]=we[K]-1));return we}var St="[+-]",Gt="\\d+",Dt=St+"?"+Gt,Ut="\\."+Gt,Xt="(?:"+Gt+"(?:"+Ut+")?)|(?:"+Ut+")",ft="[Ee]"+Dt,wt="(?:"+Xt+")(?:"+ft+")?",bt=St+"?\\s*"+wt,zt="("+bt+")?\\s*([^/]*)(?:/(.+))?",qt=new RegExp("^"+zt+"$"),ui="\\^|\\*{2}",Ct="[01234]",di=new RegExp("([^ \\*\\d]+?)(?:"+ui+")?(-?"+Ct+"(?![a-zA-Z]))"),mi=new RegExp("([^ \\*\\d]+?)(?:"+ui+")?("+Ct+"(?![a-zA-Z]))");function Ti(we){p(we)||(we=we.toString()),we=we.trim();var Xe=qt.exec(we);if(!Xe)throw new G(we+": Quantity not recognized");var ae=Xe[1];ae?(ae=ae.replace(/\s/g,""),this.scalar=parseFloat(ae)):this.scalar=1;for(var K=Xe[2],re=Xe[3],de,Ae,Be;Xe=di.exec(K);){if(de=parseFloat(Xe[2]),isNaN(de))throw new G("Unit exponent is not a number");if(de===0&&!Jt.test(Xe[1]))throw new G("Unit not recognized");Ae=Xe[1]+" ",Be="";for(var Ne=0;Ne<Math.abs(de);Ne++)Be+=Ae;de>=0?K=K.replace(Xe[0],Be):(re=re?re+Be:Be,K=K.replace(Xe[0],""))}for(;Xe=mi.exec(re);){if(de=parseFloat(Xe[2]),isNaN(de))throw new G("Unit exponent is not a number");if(de===0&&!Jt.test(Xe[1]))throw new G("Unit not recognized");Ae=Xe[1]+" ",Be="";for(var Ue=0;Ue<de;Ue++)Be+=Ae;re=re.replace(Xe[0],Be)}K&&(this.numerator=Kt(K.trim())),re&&(this.denominator=Kt(re.trim()))}var hi=Object.keys(me).sort(function(we,Xe){return Xe.length-we.length}).join("|"),Pt=Object.keys(ge).sort(function(we,Xe){return Xe.length-we.length}).join("|"),Tt="\\b|$",Lt="("+hi+")??("+Pt+")(?:"+Tt+")",Jt=new RegExp("^\\s*("+Lt+"[\\s\\*]*)+$"),He=new RegExp(Lt,"g"),jt={};function Kt(we){var Xe=jt[we];if(Xe)return Xe;var ae,K=[];if(!Jt.test(we))throw new G("Unit not recognized");for(;ae=He.exec(we);)K.push(ae.slice(1));return K=K.map(function(re){return me[re[0]]?[me[re[0]],ge[re[1]]]:[ge[re[1]]]}),K=K.reduce(function(re,de){return re.concat(de)},[]),K=K.filter(function(re){return re}),jt[we]=K,K}function Yt(we){if(!p(we))throw new G("Argument should be a string");try{return this(we)}catch{return null}}function ii(we){return we instanceof xt}function xt(we,Xe){if(Mi.apply(null,arguments),!ii(this))return new xt(we,Xe);if(this.scalar=null,this.baseScalar=null,this.signature=null,this._conversionCache={},this.numerator=_e,this.denominator=_e,ei(we)?(this.scalar=we.scalar,this.numerator=we.numerator&&we.numerator.length!==0?we.numerator:_e,this.denominator=we.denominator&&we.denominator.length!==0?we.denominator:_e):Xe?(Ti.call(this,Xe),this.scalar=we):Ti.call(this,we),this.denominator.join("*").indexOf("temp")>=0)throw new G("Cannot divide with temperatures");if(this.numerator.join("*").indexOf("temp")>=0){if(this.numerator.length>1)throw new G("Cannot multiply by temperatures");if(!y(this.denominator,_e))throw new G("Cannot divide with temperatures")}if(this.initValue=we,Vt.call(this),this.isTemperature()&&this.baseScalar<0)throw new G("Temperatures must not be less than absolute zero")}xt.prototype={constructor:xt};function Mi(we,Xe){if(Xe){if(!(w(we)&&p(Xe)))throw new G("Only number accepted as initialization value when units are explicitly provided")}else if(!(p(we)||w(we)||ii(we)||ei(we)))throw new G("Only string, number or quantity accepted as single initialization value")}function ei(we){return we&&typeof we=="object"&&we.hasOwnProperty("scalar")}function Vt(){if(this.baseScalar)return this.baseScalar;if(this.isBase())this.baseScalar=this.scalar,this.signature=$t.call(this);else{var we=this.toBase();this.baseScalar=we.scalar,this.signature=we.signature}}var Zt={"-312078":"elastance","-312058":"resistance","-312038":"inductance","-152058":"potential","-152040":"magnetism","-152038":"magnetism","-7997":"specific_volume","-79":"snap","-59":"jolt","-39":"acceleration","-38":"radiation","-20":"frequency","-19":"speed","-18":"viscosity","-17":"volumetric_flow","-1":"wavenumber","0":"unitless","1":"length","2":"area","3":"volume","20":"time","400":"temperature","7941":"yank","7942":"power","7959":"pressure","7961":"force","7962":"energy","7979":"viscosity","7981":"momentum","7982":"angular_momentum","7997":"density","7998":"area_density","8000":"mass","152020":"radiation_exposure","159999":"magnetism","160000":"current","160020":"charge","312058":"conductance","312078":"capacitance","3199980":"activity","3199997":"molar_concentration","3200000":"substance","63999998":"illuminance","64000000":"luminous_power","1280000000":"currency","25599999980":"information_rate","25600000000":"information","511999999980":"angular_velocity","512000000000":"angle"};function Et(){return A(Object.keys(Zt).map(function(we){return Zt[we]}))}xt.prototype.kind=function(){return Zt[this.signature.toString()]},B(xt.prototype,{isDegrees:function(){return(this.signature===null||this.signature===400)&&this.numerator.length===1&&y(this.denominator,_e)&&(this.numerator[0].match(/<temp-[CFRK]>/)||this.numerator[0].match(/<(kelvin|celsius|rankine|fahrenheit)>/))},isTemperature:function(){return this.isDegrees()&&this.numerator[0].match(/<temp-[CFRK]>/)}});function ti(we,Xe){var ae=we.units(),K=Xe.to(ae),re=xt(Ht(ae));return xt({scalar:we.scalar-K.scalar,numerator:re.numerator,denominator:re.denominator})}function _i(we,Xe){var ae=Xe.to(Ht(we.units()));return xt({scalar:we.scalar-ae.scalar,numerator:we.numerator,denominator:we.denominator})}function vi(we,Xe){var ae=Xe.to(Ht(we.units()));return xt({scalar:we.scalar+ae.scalar,numerator:we.numerator,denominator:we.denominator})}function Ht(we){if(we==="tempK")return"degK";if(we==="tempC")return"degC";if(we==="tempF")return"degF";if(we==="tempR")return"degR";throw new G("Unknown type for temp conversion from: "+we)}function ci(we,Xe){var ae=Di(we),K=Xe.units(),re;if(K==="degK")re=ae.scalar;else if(K==="degC")re=ae.scalar;else if(K==="degF")re=ae.scalar*9/5;else if(K==="degR")re=ae.scalar*9/5;else throw new G("Unknown type for degree conversion to: "+K);return xt({scalar:re,numerator:Xe.numerator,denominator:Xe.denominator})}function Di(we){var Xe=we.units(),ae;if(Xe.match(/(deg)[CFRK]/))ae=we.baseScalar;else if(Xe==="tempK")ae=we.scalar;else if(Xe==="tempC")ae=we.scalar;else if(Xe==="tempF")ae=we.scalar*5/9;else if(Xe==="tempR")ae=we.scalar*5/9;else throw new G("Unknown type for temp conversion from: "+Xe);return xt({scalar:ae,numerator:["<kelvin>"],denominator:_e})}function $i(we,Xe){var ae=Xe.units(),K;if(ae==="tempK")K=we.baseScalar;else if(ae==="tempC")K=we.baseScalar-273.15;else if(ae==="tempF")K=we.baseScalar*9/5-459.67;else if(ae==="tempR")K=we.baseScalar*9/5;else throw new G("Unknown type for temp conversion to: "+ae);return xt({scalar:K,numerator:Xe.numerator,denominator:Xe.denominator})}function Oi(we){var Xe=we.units(),ae;if(Xe.match(/(deg)[CFRK]/))ae=we.baseScalar;else if(Xe==="tempK")ae=we.scalar;else if(Xe==="tempC")ae=we.scalar+273.15;else if(Xe==="tempF")ae=(we.scalar+459.67)*5/9;else if(Xe==="tempR")ae=we.scalar*5/9;else throw new G("Unknown type for temp conversion from: "+Xe);return xt({scalar:ae,numerator:["<temp-K>"],denominator:_e})}B(xt.prototype,{to:function(we){var Xe,ae;if(we==null)return this;if(!p(we))return this.to(we.units());if(Xe=this._conversionCache[we],Xe)return Xe;if(ae=xt(we),ae.units()===this.units())return this;if(!this.isCompatible(ae))this.isInverse(ae)?ae=this.inverse().to(we):H(this.units(),ae.units());else if(ae.isTemperature())ae=$i(this,ae);else if(ae.isDegrees())ae=ci(this,ae);else{var K=O(this.baseScalar,ae.baseScalar);ae=xt({scalar:K,numerator:ae.numerator,denominator:ae.denominator})}return this._conversionCache[we]=ae,ae},toBase:function(){if(this.isBase())return this;if(this.isTemperature())return Oi(this);var we=vr[this.units()];return we||(we=Jr(this.numerator,this.denominator),vr[this.units()]=we),we.mul(this.scalar)},toFloat:function(){if(this.isUnitless())return this.scalar;throw new G("Can't convert to Float unless unitless.  Use Unit#scalar")},toPrec:function(we){if(p(we)&&(we=xt(we)),w(we)&&(we=xt(we+" "+this.units())),this.isUnitless()?we.isUnitless()||H(this.units(),we.units()):we=we.to(this.units()),we.scalar===0)throw new G("Divide by zero");var Xe=D(Math.round(this.scalar/we.scalar),we.scalar);return xt(Xe+this.units())}});function pr(we,Xe){var ae=xt(we),K=xt(Xe);if(ae.eq(K))return T;var re;return ae.isTemperature()?re=function(de){return ae.mul(de).to(K).scalar}:re=function(de){return de*ae.baseScalar/K.baseScalar},function(Ae){var Be,Ne,Ue;if(Array.isArray(Ae)){for(Ne=Ae.length,Ue=[],Be=0;Be<Ne;Be++)Ue.push(re(Ae[Be]));return Ue}else return re(Ae)}}var vr={};function Jr(we,Xe){for(var ae=[],K=[],re=1,de,Ae=0;Ae<we.length;Ae++)de=we[Ae],he[de]?re=D(re,he[de]):Re[de]&&(re*=Re[de].scalar,Re[de].numerator&&ae.push(Re[de].numerator),Re[de].denominator&&K.push(Re[de].denominator));for(var Be=0;Be<Xe.length;Be++)de=Xe[Be],he[de]?re/=he[de]:Re[de]&&(re/=Re[de].scalar,Re[de].numerator&&K.push(Re[de].numerator),Re[de].denominator&&ae.push(Re[de].denominator));return ae=ae.reduce(function(Ne,Ue){return Ne.concat(Ue)},[]),K=K.reduce(function(Ne,Ue){return Ne.concat(Ue)},[]),xt({scalar:re,numerator:ae,denominator:K})}xt.parse=Yt,xt.getUnits=Ze,xt.getAliases=lt,xt.mulSafe=D,xt.divSafe=O,xt.getKinds=Et,xt.swiftConverter=pr,xt.Error=G,B(xt.prototype,{add:function(we){if(p(we)&&(we=xt(we)),this.isCompatible(we)||H(this.units(),we.units()),this.isTemperature()&&we.isTemperature())throw new G("Cannot add two temperatures");return this.isTemperature()?vi(this,we):we.isTemperature()?vi(we,this):xt({scalar:this.scalar+we.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},sub:function(we){if(p(we)&&(we=xt(we)),this.isCompatible(we)||H(this.units(),we.units()),this.isTemperature()&&we.isTemperature())return ti(this,we);if(this.isTemperature())return _i(this,we);if(we.isTemperature())throw new G("Cannot subtract a temperature from a differential degree unit");return xt({scalar:this.scalar-we.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},mul:function(we){if(w(we))return xt({scalar:D(this.scalar,we),numerator:this.numerator,denominator:this.denominator});if(p(we)&&(we=xt(we)),(this.isTemperature()||we.isTemperature())&&!(this.isUnitless()||we.isUnitless()))throw new G("Cannot multiply by temperatures");var Xe=this,ae=we;Xe.isCompatible(ae)&&Xe.signature!==400&&(ae=ae.to(Xe));var K=Ji(Xe.numerator,Xe.denominator,ae.numerator,ae.denominator);return xt({scalar:D(Xe.scalar,ae.scalar,K[2]),numerator:K[0],denominator:K[1]})},div:function(we){if(w(we)){if(we===0)throw new G("Divide by zero");return xt({scalar:this.scalar/we,numerator:this.numerator,denominator:this.denominator})}else p(we)&&(we=xt(we));if(we.scalar===0)throw new G("Divide by zero");if(we.isTemperature())throw new G("Cannot divide with temperatures");if(this.isTemperature()&&!we.isUnitless())throw new G("Cannot divide with temperatures");var Xe=this,ae=we;Xe.isCompatible(ae)&&Xe.signature!==400&&(ae=ae.to(Xe));var K=Ji(Xe.numerator,Xe.denominator,ae.denominator,ae.numerator);return xt({scalar:D(Xe.scalar,K[2])/ae.scalar,numerator:K[0],denominator:K[1]})},inverse:function(){if(this.isTemperature())throw new G("Cannot divide with temperatures");if(this.scalar===0)throw new G("Divide by zero");return xt({scalar:1/this.scalar,numerator:this.denominator,denominator:this.numerator})}});function Ji(we,Xe,ae,K){function re(pt){return pt!==Q}we=we.filter(re),ae=ae.filter(re),Xe=Xe.filter(re),K=K.filter(re);var de={};function Ae(pt,st){for(var Rt,gt,Ve,Qe=0;Qe<pt.length;Qe++)if(he[pt[Qe]]?(Rt=pt[Qe+1],gt=pt[Qe],Ve=he[gt],Qe++):(Rt=pt[Qe],gt=null,Ve=1),Rt&&Rt!==Q)if(de[Rt]){de[Rt][0]+=st;var gi=de[Rt][2]?he[de[Rt][2]]:1;de[Rt][st===1?3:4]*=O(Ve,gi)}else de[Rt]=[st,Rt,gt,1,1]}Ae(we,1),Ae(Xe,-1),Ae(ae,1),Ae(K,-1);var Be=[],Ne=[],Ue=1;for(var Fe in de)if(de.hasOwnProperty(Fe)){var je=de[Fe],tt;if(je[0]>0)for(tt=0;tt<je[0];tt++)Be.push(je[2]===null?je[1]:[je[2],je[1]]);else if(je[0]<0)for(tt=0;tt<-je[0];tt++)Ne.push(je[2]===null?je[1]:[je[2],je[1]]);Ue*=O(je[3],je[4])}return Be.length===0&&(Be=_e),Ne.length===0&&(Ne=_e),Be=Be.reduce(function(pt,st){return pt.concat(st)},[]),Ne=Ne.reduce(function(pt,st){return pt.concat(st)},[]),[Be,Ne,Ue]}B(xt.prototype,{eq:function(we){return this.compareTo(we)===0},lt:function(we){return this.compareTo(we)===-1},lte:function(we){return this.eq(we)||this.lt(we)},gt:function(we){return this.compareTo(we)===1},gte:function(we){return this.eq(we)||this.gt(we)},compareTo:function(we){if(p(we))return this.compareTo(xt(we));if(this.isCompatible(we)||H(this.units(),we.units()),this.baseScalar<we.baseScalar)return-1;if(this.baseScalar===we.baseScalar)return 0;if(this.baseScalar>we.baseScalar)return 1},same:function(we){return this.scalar===we.scalar&&this.units()===we.units()}}),B(xt.prototype,{isUnitless:function(){return[this.numerator,this.denominator].every(function(we){return y(we,_e)})},isCompatible:function(we){return p(we)?this.isCompatible(xt(we)):ii(we)&&we.signature!==void 0?this.signature===we.signature:!1},isInverse:function(we){return this.inverse().isCompatible(we)},isBase:function(){return this._isBase!==void 0?this._isBase:this.isDegrees()&&this.numerator[0].match(/<(kelvin|temp-K)>/)?(this._isBase=!0,this._isBase):(this.numerator.concat(this.denominator).forEach(function(we){we!==Q&&oe.indexOf(we)===-1&&(this._isBase=!1)},this),this._isBase===!1?this._isBase:(this._isBase=!0,this._isBase))}});function _r(){}_r.prototype.get=function(we){return arguments.length>1&&(we=Array.apply(null,arguments)),we.reduce(function(Xe,ae,K){if(Xe){var re=Xe[ae];return K===we.length-1?re?re.data:void 0:re}},this)},_r.prototype.set=function(we,Xe){return arguments.length>2&&(we=Array.prototype.slice.call(arguments,0,-1),Xe=arguments[arguments.length-1]),we.reduce(function(ae,K,re){var de=ae[K];return de===void 0&&(de=ae[K]={}),re===we.length-1?(de.data=Xe,Xe):de},this)};function zr(we,Xe){return(we+" "+Xe).trim()}xt.formatter=zr,B(xt.prototype,{units:function(){if(this._units!==void 0)return this._units;var we=y(this.numerator,_e),Xe=y(this.denominator,_e);if(we&&Xe)return this._units="",this._units;var ae=yr(this.numerator),K=yr(this.denominator);return this._units=ae+(Xe?"":"/"+K),this._units},toString:function(we,Xe){var ae;if(w(we))ae=this.units(),Xe=we;else if(p(we))ae=we;else if(ii(we))return this.toPrec(we).toString(Xe);var K=this.to(ae),re=Xe!==void 0?N(K.scalar,Xe):K.scalar;return K=(re+" "+K.units()).trim(),K},format:function(we,Xe){arguments.length===1&&typeof we=="function"&&(Xe=we,we=void 0),Xe=Xe||xt.formatter;var ae=this.to(we);return Xe.call(this,ae.scalar,ae.units())}});var br=new _r;function yr(we){var Xe=br.get(we);if(Xe)return Xe;var ae=y(we,_e);return ae?Xe="1":Xe=Ur(Fr(we)).join("*"),br.set(we,Xe),Xe}function Fr(we){for(var Xe=[],ae,K,re=0;re<we.length;re++)ae=we[re],K=we[re+1],he[ae]?(Xe.push(ue[ae]+ue[K]),re++):Xe.push(ue[ae]);return Xe}function Ur(we){var Xe=we.reduce(function(ae,K){var re=ae[K];return re||ae.push(re=ae[K]=[K,0]),re[1]++,ae},[]);return Xe.map(function(ae){return ae[0]+(ae[1]>1?ae[1]:"")})}return xt.version="1.7.6",xt})})(quantities);var Qty=quantities.exports;function deepValue(h,l=""){let p=l.split(".");for(let m of p){if(h[m]===void 0)return;h=h[m]}return h}var orientation={exports:{}},twoProduct_1=twoProduct$1,SPLITTER=+(Math.pow(2,27)+1);function twoProduct$1(h,l,p){var m=h*l,w=SPLITTER*h,T=w-h,A=w-T,y=h-A,B=SPLITTER*l,D=B-l,O=B-D,N=l-O,j=m-A*O,G=j-y*O,H=G-A*N,te=y*N-H;return p?(p[0]=te,p[1]=m,p):[te,m]}var robustSum=linearExpansionSum;function scalarScalar$1(h,l){var p=h+l,m=p-h,w=p-m,T=l-m,A=h-w,y=A+T;return y?[y,p]:[p]}function linearExpansionSum(h,l){var p=h.length|0,m=l.length|0;if(p===1&&m===1)return scalarScalar$1(h[0],l[0]);var w=p+m,T=new Array(w),A=0,y=0,B=0,D=Math.abs,O=h[y],N=D(O),j=l[B],G=D(j),H,te;N<G?(te=O,y+=1,y<p&&(O=h[y],N=D(O))):(te=j,B+=1,B<m&&(j=l[B],G=D(j))),y<p&&N<G||B>=m?(H=O,y+=1,y<p&&(O=h[y],N=D(O))):(H=j,B+=1,B<m&&(j=l[B],G=D(j)));for(var oe=H+te,Q=oe-H,_e=te-Q,se=_e,he=oe,me,Re,ge,ue,Se;y<p&&B<m;)N<G?(H=O,y+=1,y<p&&(O=h[y],N=D(O))):(H=j,B+=1,B<m&&(j=l[B],G=D(j))),te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[A++]=_e),me=he+oe,Re=me-he,ge=me-Re,ue=oe-Re,Se=he-ge,se=Se+ue,he=me;for(;y<p;)H=O,te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[A++]=_e),me=he+oe,Re=me-he,ge=me-Re,ue=oe-Re,Se=he-ge,se=Se+ue,he=me,y+=1,y<p&&(O=h[y]);for(;B<m;)H=j,te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[A++]=_e),me=he+oe,Re=me-he,ge=me-Re,ue=oe-Re,Se=he-ge,se=Se+ue,he=me,B+=1,B<m&&(j=l[B]);return se&&(T[A++]=se),he&&(T[A++]=he),A||(T[A++]=0),T.length=A,T}var twoSum$1=fastTwoSum;function fastTwoSum(h,l,p){var m=h+l,w=m-h,T=m-w,A=l-w,y=h-T;return p?(p[0]=y+A,p[1]=m,p):[y+A,m]}var twoProduct=twoProduct_1,twoSum=twoSum$1,robustScale=scaleLinearExpansion;function scaleLinearExpansion(h,l){var p=h.length;if(p===1){var m=twoProduct(h[0],l);return m[0]?m:[m[1]]}var w=new Array(2*p),T=[.1,.1],A=[.1,.1],y=0;twoProduct(h[0],l,T),T[0]&&(w[y++]=T[0]);for(var B=1;B<p;++B){twoProduct(h[B],l,A);var D=T[1];twoSum(D,A[0],T),T[0]&&(w[y++]=T[0]);var O=A[1],N=T[1],j=O+N,G=j-O,H=N-G;T[1]=j,H&&(w[y++]=H)}return T[1]&&(w[y++]=T[1]),y===0&&(w[y++]=0),w.length=y,w}var robustDiff=robustSubtract;function scalarScalar(h,l){var p=h+l,m=p-h,w=p-m,T=l-m,A=h-w,y=A+T;return y?[y,p]:[p]}function robustSubtract(h,l){var p=h.length|0,m=l.length|0;if(p===1&&m===1)return scalarScalar(h[0],-l[0]);var w=p+m,T=new Array(w),A=0,y=0,B=0,D=Math.abs,O=h[y],N=D(O),j=-l[B],G=D(j),H,te;N<G?(te=O,y+=1,y<p&&(O=h[y],N=D(O))):(te=j,B+=1,B<m&&(j=-l[B],G=D(j))),y<p&&N<G||B>=m?(H=O,y+=1,y<p&&(O=h[y],N=D(O))):(H=j,B+=1,B<m&&(j=-l[B],G=D(j)));for(var oe=H+te,Q=oe-H,_e=te-Q,se=_e,he=oe,me,Re,ge,ue,Se;y<p&&B<m;)N<G?(H=O,y+=1,y<p&&(O=h[y],N=D(O))):(H=j,B+=1,B<m&&(j=-l[B],G=D(j))),te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[A++]=_e),me=he+oe,Re=me-he,ge=me-Re,ue=oe-Re,Se=he-ge,se=Se+ue,he=me;for(;y<p;)H=O,te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[A++]=_e),me=he+oe,Re=me-he,ge=me-Re,ue=oe-Re,Se=he-ge,se=Se+ue,he=me,y+=1,y<p&&(O=h[y]);for(;B<m;)H=j,te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[A++]=_e),me=he+oe,Re=me-he,ge=me-Re,ue=oe-Re,Se=he-ge,se=Se+ue,he=me,B+=1,B<m&&(j=-l[B]);return se&&(T[A++]=se),he&&(T[A++]=he),A||(T[A++]=0),T.length=A,T}(function(h){var l=twoProduct_1,p=robustSum,m=robustScale,w=robustDiff,T=5,A=11102230246251565e-32,y=(3+16*A)*A,B=(7+56*A)*A;function D(se,he,me,Re){return function(ue,Se,le){var pe=se(se(he(Se[1],le[0]),he(-le[1],Se[0])),se(he(ue[1],Se[0]),he(-Se[1],ue[0]))),Le=se(he(ue[1],le[0]),he(-le[1],ue[0])),Ze=Re(pe,Le);return Ze[Ze.length-1]}}function O(se,he,me,Re){return function(ue,Se,le,pe){var Le=se(se(me(se(he(le[1],pe[0]),he(-pe[1],le[0])),Se[2]),se(me(se(he(Se[1],pe[0]),he(-pe[1],Se[0])),-le[2]),me(se(he(Se[1],le[0]),he(-le[1],Se[0])),pe[2]))),se(me(se(he(Se[1],pe[0]),he(-pe[1],Se[0])),ue[2]),se(me(se(he(ue[1],pe[0]),he(-pe[1],ue[0])),-Se[2]),me(se(he(ue[1],Se[0]),he(-Se[1],ue[0])),pe[2])))),Ze=se(se(me(se(he(le[1],pe[0]),he(-pe[1],le[0])),ue[2]),se(me(se(he(ue[1],pe[0]),he(-pe[1],ue[0])),-le[2]),me(se(he(ue[1],le[0]),he(-le[1],ue[0])),pe[2]))),se(me(se(he(Se[1],le[0]),he(-le[1],Se[0])),ue[2]),se(me(se(he(ue[1],le[0]),he(-le[1],ue[0])),-Se[2]),me(se(he(ue[1],Se[0]),he(-Se[1],ue[0])),le[2])))),lt=Re(Le,Ze);return lt[lt.length-1]}}function N(se,he,me,Re){return function(ue,Se,le,pe,Le){var Ze=se(se(se(me(se(me(se(he(pe[1],Le[0]),he(-Le[1],pe[0])),le[2]),se(me(se(he(le[1],Le[0]),he(-Le[1],le[0])),-pe[2]),me(se(he(le[1],pe[0]),he(-pe[1],le[0])),Le[2]))),Se[3]),se(me(se(me(se(he(pe[1],Le[0]),he(-Le[1],pe[0])),Se[2]),se(me(se(he(Se[1],Le[0]),he(-Le[1],Se[0])),-pe[2]),me(se(he(Se[1],pe[0]),he(-pe[1],Se[0])),Le[2]))),-le[3]),me(se(me(se(he(le[1],Le[0]),he(-Le[1],le[0])),Se[2]),se(me(se(he(Se[1],Le[0]),he(-Le[1],Se[0])),-le[2]),me(se(he(Se[1],le[0]),he(-le[1],Se[0])),Le[2]))),pe[3]))),se(me(se(me(se(he(le[1],pe[0]),he(-pe[1],le[0])),Se[2]),se(me(se(he(Se[1],pe[0]),he(-pe[1],Se[0])),-le[2]),me(se(he(Se[1],le[0]),he(-le[1],Se[0])),pe[2]))),-Le[3]),se(me(se(me(se(he(pe[1],Le[0]),he(-Le[1],pe[0])),Se[2]),se(me(se(he(Se[1],Le[0]),he(-Le[1],Se[0])),-pe[2]),me(se(he(Se[1],pe[0]),he(-pe[1],Se[0])),Le[2]))),ue[3]),me(se(me(se(he(pe[1],Le[0]),he(-Le[1],pe[0])),ue[2]),se(me(se(he(ue[1],Le[0]),he(-Le[1],ue[0])),-pe[2]),me(se(he(ue[1],pe[0]),he(-pe[1],ue[0])),Le[2]))),-Se[3])))),se(se(me(se(me(se(he(Se[1],Le[0]),he(-Le[1],Se[0])),ue[2]),se(me(se(he(ue[1],Le[0]),he(-Le[1],ue[0])),-Se[2]),me(se(he(ue[1],Se[0]),he(-Se[1],ue[0])),Le[2]))),pe[3]),se(me(se(me(se(he(Se[1],pe[0]),he(-pe[1],Se[0])),ue[2]),se(me(se(he(ue[1],pe[0]),he(-pe[1],ue[0])),-Se[2]),me(se(he(ue[1],Se[0]),he(-Se[1],ue[0])),pe[2]))),-Le[3]),me(se(me(se(he(le[1],pe[0]),he(-pe[1],le[0])),Se[2]),se(me(se(he(Se[1],pe[0]),he(-pe[1],Se[0])),-le[2]),me(se(he(Se[1],le[0]),he(-le[1],Se[0])),pe[2]))),ue[3]))),se(me(se(me(se(he(le[1],pe[0]),he(-pe[1],le[0])),ue[2]),se(me(se(he(ue[1],pe[0]),he(-pe[1],ue[0])),-le[2]),me(se(he(ue[1],le[0]),he(-le[1],ue[0])),pe[2]))),-Se[3]),se(me(se(me(se(he(Se[1],pe[0]),he(-pe[1],Se[0])),ue[2]),se(me(se(he(ue[1],pe[0]),he(-pe[1],ue[0])),-Se[2]),me(se(he(ue[1],Se[0]),he(-Se[1],ue[0])),pe[2]))),le[3]),me(se(me(se(he(Se[1],le[0]),he(-le[1],Se[0])),ue[2]),se(me(se(he(ue[1],le[0]),he(-le[1],ue[0])),-Se[2]),me(se(he(ue[1],Se[0]),he(-Se[1],ue[0])),le[2]))),-pe[3]))))),lt=se(se(se(me(se(me(se(he(pe[1],Le[0]),he(-Le[1],pe[0])),le[2]),se(me(se(he(le[1],Le[0]),he(-Le[1],le[0])),-pe[2]),me(se(he(le[1],pe[0]),he(-pe[1],le[0])),Le[2]))),ue[3]),me(se(me(se(he(pe[1],Le[0]),he(-Le[1],pe[0])),ue[2]),se(me(se(he(ue[1],Le[0]),he(-Le[1],ue[0])),-pe[2]),me(se(he(ue[1],pe[0]),he(-pe[1],ue[0])),Le[2]))),-le[3])),se(me(se(me(se(he(le[1],Le[0]),he(-Le[1],le[0])),ue[2]),se(me(se(he(ue[1],Le[0]),he(-Le[1],ue[0])),-le[2]),me(se(he(ue[1],le[0]),he(-le[1],ue[0])),Le[2]))),pe[3]),me(se(me(se(he(le[1],pe[0]),he(-pe[1],le[0])),ue[2]),se(me(se(he(ue[1],pe[0]),he(-pe[1],ue[0])),-le[2]),me(se(he(ue[1],le[0]),he(-le[1],ue[0])),pe[2]))),-Le[3]))),se(se(me(se(me(se(he(le[1],Le[0]),he(-Le[1],le[0])),Se[2]),se(me(se(he(Se[1],Le[0]),he(-Le[1],Se[0])),-le[2]),me(se(he(Se[1],le[0]),he(-le[1],Se[0])),Le[2]))),ue[3]),me(se(me(se(he(le[1],Le[0]),he(-Le[1],le[0])),ue[2]),se(me(se(he(ue[1],Le[0]),he(-Le[1],ue[0])),-le[2]),me(se(he(ue[1],le[0]),he(-le[1],ue[0])),Le[2]))),-Se[3])),se(me(se(me(se(he(Se[1],Le[0]),he(-Le[1],Se[0])),ue[2]),se(me(se(he(ue[1],Le[0]),he(-Le[1],ue[0])),-Se[2]),me(se(he(ue[1],Se[0]),he(-Se[1],ue[0])),Le[2]))),le[3]),me(se(me(se(he(Se[1],le[0]),he(-le[1],Se[0])),ue[2]),se(me(se(he(ue[1],le[0]),he(-le[1],ue[0])),-Se[2]),me(se(he(ue[1],Se[0]),he(-Se[1],ue[0])),le[2]))),-Le[3])))),ct=Re(Ze,lt);return ct[ct.length-1]}}function j(se){var he=se===3?D:se===4?O:N;return he(p,l,m,w)}var G=j(3),H=j(4),te=[function(){return 0},function(){return 0},function(he,me){return me[0]-he[0]},function(he,me,Re){var ge=(he[1]-Re[1])*(me[0]-Re[0]),ue=(he[0]-Re[0])*(me[1]-Re[1]),Se=ge-ue,le;if(ge>0){if(ue<=0)return Se;le=ge+ue}else if(ge<0){if(ue>=0)return Se;le=-(ge+ue)}else return Se;var pe=y*le;return Se>=pe||Se<=-pe?Se:G(he,me,Re)},function(he,me,Re,ge){var ue=he[0]-ge[0],Se=me[0]-ge[0],le=Re[0]-ge[0],pe=he[1]-ge[1],Le=me[1]-ge[1],Ze=Re[1]-ge[1],lt=he[2]-ge[2],ct=me[2]-ge[2],$t=Re[2]-ge[2],Nt=Se*Ze,St=le*Le,Gt=le*pe,Dt=ue*Ze,Ut=ue*Le,Xt=Se*pe,ft=lt*(Nt-St)+ct*(Gt-Dt)+$t*(Ut-Xt),wt=(Math.abs(Nt)+Math.abs(St))*Math.abs(lt)+(Math.abs(Gt)+Math.abs(Dt))*Math.abs(ct)+(Math.abs(Ut)+Math.abs(Xt))*Math.abs($t),bt=B*wt;return ft>bt||-ft>bt?ft:H(he,me,Re,ge)}];function oe(se){var he=te[se.length];return he||(he=te[se.length]=j(se.length)),he.apply(void 0,se)}function Q(se,he,me,Re,ge,ue,Se){return function(pe,Le,Ze,lt,ct){switch(arguments.length){case 0:case 1:return 0;case 2:return Re(pe,Le);case 3:return ge(pe,Le,Ze);case 4:return ue(pe,Le,Ze,lt);case 5:return Se(pe,Le,Ze,lt,ct)}for(var $t=new Array(arguments.length),Nt=0;Nt<arguments.length;++Nt)$t[Nt]=arguments[Nt];return se($t)}}function _e(){for(;te.length<=T;)te.push(j(te.length));h.exports=Q.apply(void 0,[oe].concat(te));for(var se=0;se<=T;++se)h.exports[se]=te[se]}_e()})(orientation);var robustPnp=robustPointInPolygon,orient=orientation.exports;function robustPointInPolygon(h,l){for(var p=l[0],m=l[1],w=h.length,T=1,A=w,y=0,B=w-1;y<A;B=y++){var D=h[y],O=h[B],N=D[1],j=O[1];if(j<N){if(j<m&&m<N){var G=orient(D,O,l);if(G===0)return 0;T^=0<G|0}else if(m===N){var H=h[(y+1)%w],te=H[1];if(N<te){var G=orient(D,O,l);if(G===0)return 0;T^=0<G|0}}}else if(N<j){if(N<m&&m<j){var G=orient(D,O,l);if(G===0)return 0;T^=G<0|0}else if(m===N){var H=h[(y+1)%w],te=H[1];if(te<N){var G=orient(D,O,l);if(G===0)return 0;T^=G<0|0}}}else if(m===N){var oe=Math.min(D[0],O[0]),Q=Math.max(D[0],O[0]);if(y===0){for(;B>0;){var _e=(B+w-1)%w,se=h[_e];if(se[1]!==m)break;var he=se[0];oe=Math.min(oe,he),Q=Math.max(Q,he),B=_e}if(B===0)return oe<=p&&p<=Q?0:1;A=B+1}for(var me=h[(B+w-1)%w][1];y+1<A;){var se=h[y+1];if(se[1]!==m)break;var he=se[0];oe=Math.min(oe,he),Q=Math.max(Q,he),y+=1}if(oe<=p&&p<=Q)return 0;var Re=h[(y+1)%w][1];p<oe&&me<m!=Re<m&&(T^=1)}}return 2*T-1}var robustPointInPolygon$1=robustPnp;function feretDiameters(h={}){const{originalPoints:l=monotoneChainConvexHull.call(this)}=h;if(l.length===0)return{min:0,max:0,minLine:[],maxLine:[],aspectRatio:1};if(l.length===1)return{min:1,max:1,minLine:[l[0],l[0]],maxLine:[l[0],l[0]],aspectRatio:1};const p=new Array(l.length);let m=1/0,w=0,T=[];for(let D=0;D<l.length;D++){let O=getAngle(l[D],l[(D+1)%l.length]);rotate(-O,l,p);let N=0,j=[];for(let G=0;G<l.length;G++){let H=Math.abs(p[D][1]-p[G][1]);H>N&&(N=H,j=[],j.push([p[G][0],p[D][1]],[p[G][0],p[G][1]]))}N<m&&(m=N,w=O,T=j)}rotate(w,T,T);let A=0,y=[],B=0;for(let D=0;D<l.length-1;D++)for(let O=D+1;O<l.length;O++){let N=(l[D][0]-l[O][0])**2+(l[D][1]-l[O][1])**2;N>B&&(B=N,A=Math.sqrt(N),y=[l[D],l[O]])}return{min:m,minLine:T,max:A,maxLine:y,aspectRatio:m/A}}function getAngle(h,l){let p=difference(l,h),m=normalize(p),w=Math.acos(m[0]);return m[1]<0?-w:w}class Roi{constructor(l,p){this.map=l,this.id=p,this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.meanX=0,this.meanY=0,this.surface=0,this.computed={}}getMask(l={}){const{scale:p=1,kind:m=""}=l;let w;switch(m){case"contour":w=this.contourMask;break;case"box":w=this.boxMask;break;case"filled":w=this.filledMask;break;case"center":w=this.centerMask;break;case"mbr":w=this.mbrFilledMask;break;case"hull":w=this.convexHullFilledMask;break;case"hullContour":w=this.convexHullMask;break;case"mbrContour":w=this.mbrMask;break;case"feret":w=this.feretMask;break;default:w=this.mask}return p<1&&(w=w.resize({factor:p}),w.parent=this.mask.parent,w.position[0]+=this.minX,w.position[1]+=this.minY),w}get mean(){throw new Error("Roi mean not implemented yet")}get center(){return this.computed.center||(this.computed.center=[this.width/2>>0,this.height/2>>0]),this.computed.center}get ratio(){return this.width/this.height}get width(){return this.maxX-this.minX+1}get height(){return this.maxY-this.minY+1}_computExternalIDs(){let l=this.borderIDs,p=this.borderLengths;this.computed.externalIDs=[],this.computed.externalLengths=[];let m=this.internalIDs;for(let w=0;w<l.length;w++)m.includes(l[w])||(this.computed.externalIDs.push(l[w]),this.computed.externalLengths.push(p[w]))}get externalIDs(){return this.computed.externalIDs?this.computed.externalIDs:(this._computExternalIDs(),this.computed.externalIDs)}get externalLengths(){return this.computed.externalLengths?this.computed.externalLengths:(this._computExternalIDs(),this.computed.externalLengths)}_computeBorderIDs(){let l=getBorders(this);this.computed.borderIDs=l.ids,this.computed.borderLengths=l.lengths}get borderIDs(){return this.computed.borderIDs?this.computed.borderIDs:(this._computeBorderIDs(),this.computed.borderIDs)}get borderLengths(){return this.computed.borderLengths?this.computed.borderLengths:(this._computeBorderIDs(),this.computed.borderLengths)}get boxIDs(){return this.computed.boxIDs||(this.computed.boxIDs=getBoxIDs(this)),this.computed.boxIDs}get internalIDs(){return this.computed.internalIDs||(this.computed.internalIDs=getInternalIDs(this)),this.computed.internalIDs}get box(){return this.computed.box||(this.computed.box=getBox(this)),this.computed.box}get external(){return this.computed.external||(this.computed.external=getExternal(this)),this.computed.external}get holesInfo(){return this.computed.holesInfo||(this.computed.holesInfo=getHolesInfo(this)),this.computed.holesInfo}get border(){return this.computed.border||(this.computed.border=getBorder(this)),this.computed.border}get contourMask(){if(!this.computed.contourMask){let l=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let p=0;p<this.width;p++)for(let m=0;m<this.height;m++)this.map.data[p+this.minX+(m+this.minY)*this.map.width]===this.id&&(p>0&&p<this.width-1&&m>0&&m<this.height-1?(this.map.data[p-1+this.minX+(m+this.minY)*this.map.width]!==this.id||this.map.data[p+1+this.minX+(m+this.minY)*this.map.width]!==this.id||this.map.data[p+this.minX+(m-1+this.minY)*this.map.width]!==this.id||this.map.data[p+this.minX+(m+1+this.minY)*this.map.width]!==this.id)&&l.setBitXY(p,m):l.setBitXY(p,m));this.computed.contourMask=l}return this.computed.contourMask}get boxMask(){if(!this.computed.boxMask){let l=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let p=0;p<this.width;p++)l.setBitXY(p,0),l.setBitXY(p,this.height-1);for(let p=0;p<this.height;p++)l.setBitXY(0,p),l.setBitXY(this.width-1,p);this.computed.boxMask=l}return this.computed.boxMask}get mask(){if(!this.computed.mask){let l=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let p=0;p<this.width;p++)for(let m=0;m<this.height;m++)this.map.data[p+this.minX+(m+this.minY)*this.map.width]===this.id&&l.setBitXY(p,m);this.computed.mask=l}return this.computed.mask}get filledMask(){if(!this.computed.filledMask){let l=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let p=0;p<this.width;p++)for(let m=0;m<this.height;m++){let w=p+this.minX+(m+this.minY)*this.map.width;this.internalIDs.includes(this.map.data[w])&&l.setBitXY(p,m)}this.computed.filledMask=l}return this.computed.filledMask}get centerMask(){if(!this.computed.centerMask){let l=new Shape({kind:"smallCross"}).getMask();l.parent=this.map.parent,l.position=[this.minX+this.center[0]-1,this.minY+this.center[1]-1],this.computed.centerMask=l}return this.computed.centerMask}get convexHull(){if(!this.computed.convexHull){const l=[];for(let m=0;m<this.width;m++)for(let w=0;w<this.height;w++)this.map.data[m+this.minX+(w+this.minY)*this.map.width]===this.id&&(m>0&&m<this.width-1&&w>0&&w<this.height-1?(this.map.data[m-1+this.minX+(w+this.minY)*this.map.width]!==this.id||this.map.data[m+1+this.minX+(w+this.minY)*this.map.width]!==this.id||this.map.data[m+this.minX+(w-1+this.minY)*this.map.width]!==this.id||this.map.data[m+this.minX+(w+1+this.minY)*this.map.width]!==this.id)&&(l.push([m,w]),l.push([m+1,w]),l.push([m,w+1]),l.push([m+1,w+1])):(l.push([m,w]),l.push([m+1,w]),l.push([m,w+1]),l.push([m+1,w+1])));const p=monotoneChainConvexHull$1(l);this.computed.convexHull={polyline:p,surface:surface(p),perimeter:perimeter(p)}}return this.computed.convexHull}get convexHullMask(){if(!this.computed.convexHullMask){const l=this.convexHull,p=new Image$1(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});p.paintPolyline(l.polyline,{closed:!0}),this.computed.convexHullMask=p}return this.computed.convexHullMask}get convexHullFilledMask(){if(!this.computed.convexHullFilledMask){const l=this.convexHull,p=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let m=0;m<this.width;m++)for(let w=0;w<this.height;w++)robustPointInPolygon$1(l.polyline,[m,w])!==1&&p.setBitXY(m,w);this.computed.convexHullFilledMask=p}return this.computed.convexHullFilledMask}get mbr(){if(!this.computed.mbr){let l=minimalBoundingRectangle({originalPoints:this.convexHull.polyline});if(l.length===0)this.computed.mbr={width:0,height:0,surface:0,perimeter:0,rectangle:l};else{let p=l[0],m=l[1],w=l[2],T=Math.sqrt((p[0]-m[0])**2+(p[1]-m[1])**2),A=Math.sqrt((w[0]-m[0])**2+(w[1]-m[1])**2);this.computed.mbr={width:T,height:A,elongation:1-T/A,aspectRatio:T/A,surface:T*A,perimeter:(T+A)*2,rectangle:l}}}return this.computed.mbr}get fillRatio(){return this.surface/(this.surface+this.holesInfo.surface)}get feretDiameters(){return this.computed.feretDiameters||(this.computed.feretDiameters=feretDiameters({originalPoints:this.convexHull.polyline})),this.computed.feretDiameters}get eqpc(){return this.computed.eqpc||(this.computed.eqpc=2*Math.sqrt(this.surface/Math.PI)),this.computed.eqpc}get perimeterInfo(){return this.computed.perimeterInfo||(this.computed.perimeterInfo=getPerimeterInfo(this)),this.computed.perimeterInfo}get perimeter(){let l=this.perimeterInfo,p=2-Math.sqrt(2);return l.one+l.two*2+l.three*3+l.four*4-p*(l.two+l.three*2+l.four)}get ped(){return this.computed.ped||(this.computed.ped=this.perimeter/Math.PI),this.computed.ped}get feretMask(){if(!this.computed.feretMask){const l=new Image$1(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});l.paintPolyline(this.feretDiameters.minLine),l.paintPolyline(this.feretDiameters.maxLine),this.computed.feretMask=l}return this.computed.feretMask}get mbrMask(){if(!this.computed.mbrMask){let l=round(this.mbr.rectangle);if(l.length>0){const p=minMax(l),m=new Image$1(p[1][0]-p[0][0]+1,p[1][1]-p[0][1]+1,{kind:BINARY,position:[this.minX+p[0][0],this.minY+p[0][1]],parent:this.map.parent});l=moveToZeroZero(l),m.paintPolyline(l,{closed:!0}),this.computed.mbrMask=m}else this.computed.mbrMask=new Image$1(1,1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent})}return this.computed.mbrMask}get mbrFilledMask(){if(!this.computed.mbrFilledMask){const l=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),p=this.mask.minimalBoundingRectangle();for(let m=0;m<this.width;m++)for(let w=0;w<this.height;w++)robustPointInPolygon$1(p,[m,w])!==1&&l.setBitXY(m,w);this.computed.mbrFilledMask=l}return this.computed.mbrFilledMask}get points(){if(!this.computed.points){let l=[];for(let p=0;p<this.height;p++)for(let m=0;m<this.width;m++){let w=(p+this.minY)*this.map.width+m+this.minX;this.map.data[w]===this.id&&l.push([m,p])}this.computed.points=l}return this.computed.points}get maxLengthPoints(){if(!this.computed.maxLengthPoints){let l=0,p;const m=this.points;for(let w=0;w<m.length;w++)for(let T=w+1;T<m.length;T++){let A=Math.pow(m[w][0]-m[T][0],2)+Math.pow(m[w][1]-m[T][1],2);A>=l&&(l=A,p=[m[w],m[T]])}this.computed.maxLengthPoints=p}return this.computed.maxLengthPoints}get maxLength(){if(!this.computed.maxLength){let l=Math.sqrt(Math.pow(this.maxLengthPoints[0][0]-this.maxLengthPoints[1][0],2)+Math.pow(this.maxLengthPoints[0][1]-this.maxLengthPoints[1][1],2));this.computed.maxLength=l}return this.computed.maxLength}get roundness(){return 4*this.surface/(Math.PI*this.feretDiameters.max**2)}get sphericity(){return 2*Math.sqrt(this.surface*Math.PI)/this.perimeter}get solidity(){return this.surface/this.convexHull.surface}get angle(){if(!this.computed.angle){let l=this.maxLengthPoints,p=-Math.atan2(l[0][1]-l[1][1],l[0][0]-l[1][0])*180/Math.PI;this.computed.angle=p}return this.computed.angle}toJSON(){return{id:this.id,minX:this.minX,maxX:this.maxX,minY:this.minY,maxY:this.maxY,meanX:this.meanX,meanY:this.meanY,height:this.height,width:this.width,surface:this.surface,mbrWidth:this.mbr.width,mbrHeight:this.mbr.height,mbrSurface:this.mbr.surface,eqpc:this.eqpc,ped:this.ped,feretDiameterMin:this.feretDiameters.min,feretDiameterMax:this.feretDiameters.max,aspectRatio:this.feretDiameters.aspectRatio,fillRatio:this.fillRatio,sphericity:this.sphericity,roundness:this.roundness,solidity:this.solidity,perimeter:this.perimeter}}}function getBorders(h){let l=h.map,p=l.data,m=new Set,w=new Map,T=new Set,A=[1,0,-1,0],y=[0,1,0,-1];for(let O=h.minX;O<=h.maxX;O++)for(let N=h.minY;N<=h.maxY;N++){let j=O+N*l.width;if(p[j]===h.id)for(let G=0;G<4;G++){let H=O+A[G],te=N+y[G];if(H>=0&&te>=0&&H<l.width&&te<l.height){let oe=H+te*l.width;if(p[oe]!==h.id&&!T.has(oe)){T.add(oe),m.add(p[oe]);let Q=w.get(p[oe]);Q?w.set(p[oe],++Q):w.set(p[oe],1)}}}}let B=Array.from(m),D=B.map(function(O){return w.get(O)});return{ids:B,lengths:D}}function getBoxIDs(h){let l=new Set,p=h.map,m=p.data;for(let w of[0,h.height-1])for(let T=0;T<h.width;T++){let A=(w+h.minY)*p.width+T+h.minX;if(T-h.minX>0&&m[A]===h.id&&m[A-1]!==h.id){let y=m[A-1];l.add(y)}if(p.width-T-h.minX>1&&m[A]===h.id&&m[A+1]!==h.id){let y=m[A+1];l.add(y)}}for(let w of[0,h.width-1])for(let T=0;T<h.height;T++){let A=(T+h.minY)*p.width+w+h.minX;if(T-h.minY>0&&m[A]===h.id&&m[A-p.width]!==h.id){let y=m[A-p.width];l.add(y)}if(p.height-T-h.minY>1&&m[A]===h.id&&m[A+p.width]!==h.id){let y=m[A+p.width];l.add(y)}}return Array.from(l)}function getBox(h){let l=0,p=h.map,m=p.data,w=[0];h.height>1&&(w[1]=h.height-1);for(let A of w)for(let y=1;y<h.width-1;y++){let B=(A+h.minY)*p.width+y+h.minX;m[B]===h.id&&l++}let T=[0];h.width>1&&(T[1]=h.width-1);for(let A of T)for(let y=0;y<h.height;y++){let B=(y+h.minY)*p.width+A+h.minX;m[B]===h.id&&l++}return l}function getBorder(h){let l=0,p=h.map,m=p.data;for(let w=1;w<h.width-1;w++)for(let T=1;T<h.height-1;T++){let A=(T+h.minY)*p.width+w+h.minX;m[A]===h.id&&(m[A-1]!==h.id||m[A+1]!==h.id||m[A-p.width]!==h.id||m[A+p.width]!==h.id)&&l++}return l+h.box}function getPerimeterInfo(h){let l=h.map,p=l.data,m=0,w=0,T=0,A=0;for(let y=0;y<h.width;y++)for(let B=0;B<h.height;B++){let D=(B+h.minY)*l.width+y+h.minX;if(p[D]===h.id){let O=0;switch((y===0||h.externalIDs.includes(p[D-1]))&&O++,(y===h.width-1||h.externalIDs.includes(p[D+1]))&&O++,(B===0||h.externalIDs.includes(p[D-l.width]))&&O++,(B===h.height-1||h.externalIDs.includes(p[D+l.width]))&&O++,O){case 1:m++;break;case 2:w++;break;case 3:T++;break;case 4:A++;break}}}return{one:m,two:w,three:T,four:A}}function getExternal(h){let l=0,p=h.map,m=p.data;for(let w=1;w<h.width-1;w++)for(let T=1;T<h.height-1;T++){let A=(T+h.minY)*p.width+w+h.minX;m[A]===h.id&&(h.externalIDs.includes(m[A-1])||h.externalIDs.includes(m[A+1])||h.externalIDs.includes(m[A-p.width])||h.externalIDs.includes(m[A+p.width]))&&l++}return l+h.box}function getHolesInfo(h){let l=0,p=h.map.width,m=h.map.data;for(let w=1;w<h.width-1;w++)for(let T=1;T<h.height-1;T++){let A=(T+h.minY)*p+w+h.minX;h.internalIDs.includes(m[A])&&m[A]!==h.id&&l++}return{number:h.internalIDs.length-1,surface:l}}function getInternalIDs(h){let l=[h.id],p=h.map,m=p.data;if(h.height>2)for(let T=0;T<h.width;T++){let A=h.minY*p.width+T+h.minX;if(l.includes(m[A])){let y=m[A+p.width];!l.includes(y)&&!h.boxIDs.includes(y)&&l.push(y)}}let w=new Array(4);for(let T=1;T<h.width-1;T++)for(let A=1;A<h.height-1;A++){let y=(A+h.minY)*p.width+T+h.minX;if(l.includes(m[y])){w[0]=m[y-1],w[1]=m[y+1],w[2]=m[y-p.width],w[3]=m[y+p.width];for(let B=0;B<4;B++){let D=w[B];!l.includes(D)&&!h.boxIDs.includes(D)&&l.push(D)}}}return l}class RoiLayer{constructor(l,p){this.roiMap=l,this.options=p,this.roi=this.createRoi()}createRoi(){let l=this.roiMap.data,p={};this.roiMap.positive=0,this.roiMap.negative=0;for(let y=0;y<l.length;y++)l[y]&&!p[l[y]]&&(p[l[y]]=!0,l[y]>0?this.roiMap.positive++:this.roiMap.negative++);let m={};for(let y in p)m[y]=new Roi(this.roiMap,y*1);let w=this.roiMap.width,T=this.roiMap.height;for(let y=0;y<T;y++)for(let B=0;B<w;B++){let D=y*w+B;if(l[D]!==0){const O=l[D],N=m[O];B<N.minX&&(N.minX=B),B>N.maxX&&(N.maxX=B),y<N.minY&&(N.minY=y),y>N.maxY&&(N.maxY=y),N.meanX+=B,N.meanY+=y,N.surface++}}let A=[];for(let y in p)m[y].meanX/=m[y].surface,m[y].meanY/=m[y].surface,A.push(m[y]);return A}}function commonBorderLength(h){let l=h.data,p=[1,0,-1,0],m=[0,1,0,-1],w=h.minMax,T=-w.min,A=w.max+T,y=[];for(let D=0;D<=A;D++)y.push(Object.create(null));for(let D=0;D<h.width;D++)for(let O=0;O<h.height;O++){let N=D+O*h.width,j=l[N];if(j!==0){let G=Object.create(null),H=!1;for(let te=0;te<4;te++){let oe=D+p[te],Q=O+m[te];if(oe>=0&&Q>=0&&oe<h.width&&Q<h.height){let _e=l[oe+Q*h.width];j!==_e&&(H=!0,_e!==0&&G[_e]===void 0&&(G[_e]=!0,y[_e+T][j]?y[_e+T][j]++:y[_e+T][j]=1))}else H=!0}H&&(y[j+T][j]?y[j+T][j]++:y[j+T][j]=1)}}let B={};for(let D=0;D<y.length;D++)Object.keys(y[D]).length>0&&(B[D-T]=y[D]);return B}function mergeRoi(h={}){const{algorithm:l="commonBorderLength",minCommonBorderLength:p=5,maxCommonBorderLength:m=100,minCommonBorderRatio:w=.3,maxCommonBorderRatio:T=1}=h;let A=function(oe,Q,_e){return oe[_e]>=p&&oe[_e]<=m};typeof l=="function"&&(A=l),l.toLowerCase()==="commonborderratio"&&(A=function(oe,Q,_e){let se=Math.min(oe[_e]/oe[Q],1);return se>=w&&se<=T});const y=this,B=y.commonBorderLength;let D={},O={};for(let oe of Object.keys(B)){let Q=B[oe],_e=Object.keys(Q);for(let se of _e)if(se!==oe&&A(Q,oe,se)){let he=se;O[se]&&(he=O[se]);let me=oe;if(O[oe]&&(me=O[oe]),Number(he)!==me){let Re=Math.min(he,me),ge=Math.max(he,me);if(D[Re]||(D[Re]={}),D[Re][ge]=!0,O[ge]=Re,D[ge]){for(let ue of Object.keys(D[ge]))D[Re][ue]=!0,O[ue]=Re;delete D[ge]}}}}let N=y.minMax,j=-N.min,G=N.max+j,H=new Array(G+1).fill(0);for(let oe of Object.keys(O))H[Number(oe)+j]=O[oe];let te=y.data;for(let oe=0;oe<te.length;oe++){let Q=te[oe];if(Q!==0){let _e=H[Q+j];_e!==0&&(te[oe]=_e)}}return y.computed={},y}class RoiMap{constructor(l,p){this.parent=l,this.width=l.width,this.height=l.height,this.data=p,this.negative=0,this.positive=0}get total(){return this.negative+this.positive}get minMax(){let l=Number.MAX_SAFE_INTEGER,p=Number.MIN_SAFE_INTEGER;for(let m=0;m<this.data.length;m++)this.data[m]<l&&(l=this.data[m]),this.data[m]>p&&(p=this.data[m]);return{min:l,max:p}}get commonBorderLength(){return commonBorderLength(this)}mergeRoi(l={}){return mergeRoi.call(this,l)}mergeRois(l){const p=l[0],m=l.slice(1);for(let w=0;w<this.data.length;w++)m.includes(this.data[w])&&(this.data[w]=p)}rowsInfo(){let l=new Array(this.height),p=0;for(let m=0;m<this.data.length;m+=this.width){let w={row:p,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};l[p++]=w;let T={},A={},y=[],B=this.data[m],D=0;for(let O=m;O<m+this.width;O++){let N=this.data[O];B!==N&&(B=N,y.push(D),D=0),D++,N>0?(w.positivePixel++,T[N]||(T[N]=!0)):N<0?(w.negativePixel++,A[N]||(A[N]=!0)):w.zeroPixel++}y.push(D),w.medianChange=y.sort((O,N)=>O-N)[Math.floor(y.length/2)],w.positiveRoiIDs=Object.keys(T),w.negativeRoiIDs=Object.keys(A),w.positiveRoi=w.positiveRoiIDs.length,w.negativeRoi=w.negativeRoiIDs.length}return l}colsInfo(){let l=new Array(this.width),p=0;for(let m=0;m<this.width;m++){let w={col:p,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};l[p++]=w;let T={},A={},y=[],B=this.data[m],D=0;for(let O=m;O<m+this.data.length;O+=this.width){let N=this.data[O];B!==N&&(B=N,y.push(D),D=0),D++,N>0?(w.positivePixel++,T[N]||(T[N]=!0)):N<0?(w.negativePixel++,A[N]||(A[N]=!0)):w.zeroPixel++}y.push(D),w.medianChange=y.sort((O,N)=>O-N)[Math.floor(y.length/2)],w.positiveRoiIDs=Object.keys(T),w.negativeRoiIDs=Object.keys(A),w.positiveRoi=w.positiveRoiIDs.length,w.negativeRoi=w.negativeRoiIDs.length}return l}}function fromMask(h,l={}){const{allowCorners:p=!1}=l,m=65535;let w=new Int16Array(h.size),T=0,A=0,y=new Uint16Array(m+1),B=new Uint16Array(m+1);for(let O=0;O<h.width;O++)for(let N=0;N<h.height;N++)w[N*h.width+O]===0&&D(O,N);function D(O,N){let j=0,G=0,H=h.getBitXY(O,N),te=H?++T:--A;if(T>32767||A<-32768)throw new Error("Too many regions of interest");for(y[0]=O,B[0]=N;j<=G;){let oe=y[j&m],Q=B[j&m];if(w[Q*h.width+oe]=te,oe>0&&w[Q*h.width+oe-1]===0&&h.getBitXY(oe-1,Q)===H&&(G++,y[G&m]=oe-1,B[G&m]=Q,w[Q*h.width+oe-1]=-32768),Q>0&&w[(Q-1)*h.width+oe]===0&&h.getBitXY(oe,Q-1)===H&&(G++,y[G&m]=oe,B[G&m]=Q-1,w[(Q-1)*h.width+oe]=-32768),oe<h.width-1&&w[Q*h.width+oe+1]===0&&h.getBitXY(oe+1,Q)===H&&(G++,y[G&m]=oe+1,B[G&m]=Q,w[Q*h.width+oe+1]=-32768),Q<h.height-1&&w[(Q+1)*h.width+oe]===0&&h.getBitXY(oe,Q+1)===H&&(G++,y[G&m]=oe,B[G&m]=Q+1,w[(Q+1)*h.width+oe]=-32768),p&&(oe>0&&Q>0&&w[(Q-1)*h.width+oe-1]===0&&h.getBitXY(oe-1,Q-1)===H&&(G++,y[G&m]=oe-1,B[G&m]=Q-1,w[(Q-1)*h.width+oe-1]=-32768),oe<h.width-1&&Q>0&&w[(Q-1)*h.width+oe+1]===0&&h.getBitXY(oe+1,Q-1)===H&&(G++,y[G&m]=oe+1,B[G&m]=Q-1,w[(Q-1)*h.width+oe+1]=-32768),oe>0&&Q<h.height-1&&w[(Q+1)*h.width+oe-1]===0&&h.getBitXY(oe-1,Q+1)===H&&(G++,y[G&m]=oe-1,B[G&m]=Q+1,w[(Q+1)*h.width+oe-1]=-32768),oe<h.width-1&&Q<h.height-1&&w[(Q+1)*h.width+oe+1]===0&&h.getBitXY(oe+1,Q+1)===H&&(G++,y[G&m]=oe+1,B[G&m]=Q+1,w[(Q+1)*h.width+oe+1]=-32768)),j++,G-j>m)throw new Error("analyseMask can not finish, the array to manage internal data is not big enough.You could improve mask by changing MAX_ARRAY")}}return new RoiMap(h,w)}class DisjointSet{constructor(){this.nodes=new Map}add(l){var p=this.nodes.get(l);return p||(p=new DisjointSetNode(l),this.nodes.set(l,p)),p}union(l,p){const m=this.find(l),w=this.find(p);m!==w&&(m.rank<w.rank?m.parent=w:m.rank>w.rank?w.parent=m:(w.parent=m,m.rank++))}find(l){for(var p=l;p.parent!==null;)p=p.parent;for(var m=l;m.parent!==null;){var w=m;m=m.parent,w.parent=p}return p}connected(l,p){return this.find(l)===this.find(p)}}var DisjointSet_1=DisjointSet;function DisjointSetNode(h){this.value=h,this.parent=null,this.rank=0}var DisjointSet$1=DisjointSet_1;const direction4X=[-1,0],direction4Y=[0,-1],neighbours4=[null,null],direction8X=[-1,-1,0,1],direction8Y=[0,-1,-1,-1],neighbours8=[null,null,null,null];function fromMaskConnectedComponentLabelingAlgorithm(h,l={}){const{allowCorners:p=!1}=l;let m=4;p&&(m=8);let w,T,A;if(m===8)w=direction8X,T=direction8Y,A=neighbours8;else if(m===4)w=direction4X,T=direction4Y,A=neighbours4;else throw new RangeError(`unsupported neighbours count: ${m}`);const y=h.size,B=h.width,D=h.height,O=new Array(y),N=new Uint32Array(y),j=new DisjointSet$1;let G=1;for(let H=0;H<D;H++)for(let te=0;te<B;te++){const oe=te+H*B;if(h.getBit(oe)){let Q=null;for(let _e=0;_e<A.length;_e++){const se=te+w[_e],he=H+T[_e];if(se>=0&&he>=0&&se<B&&he<D){const me=se+he*B;let Re=O[me];Re?(A[_e]=Re,(!Q||A[_e].value<Q.value)&&(Q=A[_e])):A[_e]=null}}if(!Q)O[oe]=j.add(G++);else{O[oe]=Q;for(let _e=0;_e<A.length;_e++)A[_e]&&A[_e]!==Q&&j.union(Q,A[_e])}}}for(let H=0;H<D;H++)for(let te=0;te<B;te++){const oe=te+H*B;h.getBit(oe)&&(N[oe]=j.find(O[oe]).value)}return new RoiMap(h,N)}function fromMaxima(h={}){let{allowCorner:l=!0,onlyTop:p=!1,invert:m=!1}=h,w=this;w.checkProcessable("fromMaxima",{components:[1]});const T=1,A=2;let y=0,B=0,D=new Int16Array(w.size),O=new Int8Array(w.size),N=new Float32Array(w.size),j=1048575,G=new Uint16Array(j+1),H=new Uint16Array(j+1),te=0,oe=0,Q=new Uint16Array(j+1),_e=new Uint16Array(j+1),se=0,he=0;for(me(w);te<oe;){let ue=G[te&j],Se=H[te&j];ge(ue,Se,A),te++}return new RoiMap(w,D);function me({maxima:ue=!0}){for(let Se=1;Se<w.height-1;Se++)for(let le=1;le<w.width-1;le++){let pe=le+Se*w.width;if(O[pe]===0){let Le=ue?w.data[pe]:-w.data[le+Se*w.width];if(w.data[Se*w.width+le-1]>Le||w.data[Se*w.width+le+1]>Le||w.data[(Se-1)*w.width+le]>Le||w.data[(Se+1)*w.width+le]>Le||l&&(w.data[(Se-1)*w.width+le-1]>Le||w.data[(Se-1)*w.width+le+1]>Le||w.data[(Se+1)*w.width+le-1]>Le||w.data[(Se+1)*w.width+le+1]>Le))continue;D[pe]=ue?++y:--B,Re(le,Se)||(ue?--y:++B)}}}function Re(ue,Se){let le=oe;se=0,he=1,Q[0]=ue,_e[0]=Se;let pe=!0;for(;se<he;){let Le=Q[se&j],Ze=_e[se&j];pe&=ge(Le,Ze,T),se++}if(!pe){for(let Le=0;Le<he;Le++){let Ze=Q[Le&j],ct=_e[Le&j]*w.width+Ze;D[ct]=0}oe=le}return pe}function ge(ue,Se,le){let pe=D[Se*w.width+ue],Le=w.data[Se*w.width+ue];for(let Ze=Se-1;Ze<=Se+1;Ze++)for(let lt=ue-1;lt<=ue+1;lt++){let ct=Ze*w.width+lt;if(O[ct]===0)switch(O[ct]=1,N[ct]=w.data[ct]-Le,le){case T:if(N[ct]===0){if(lt===0||Ze===0||lt===w.width-1||Ze===w.height-1)return!1;D[ct]=pe,Q[he&j]=lt,_e[he&j]=Ze,he++}else{if(N[ct]>0)return!1;p||(D[ct]=pe,G[oe&j]=lt,H[oe&j]=Ze,oe++)}break;case A:N[ct]<=0&&(D[ct]=pe,G[oe&j]=lt,H[oe&j]=Ze,oe++);break;default:throw new Error("unreachable")}}return!0}}function fromPoints(h,l={}){let p=new Shape(l),m=new Int16Array(this.size),w=0,T=p.getPoints();for(let A=0;A<h.length;A++){w++;let y=h[A][0],B=h[A][1];for(let D=0;D<T.length;D++){let O=T[D][0],N=T[D][1];y+O>=0&&B+N>=0&&y+O<this.width&&B+N<this.height&&(m[y+O+(B+N)*this.width]=w)}}return new RoiMap(this,m)}var priorityQueue={exports:{}};(function(h,l){(function(p){h.exports=p()})(function(){return function p(m,w,T){function A(D,O){if(!w[D]){if(!m[D]){var N=typeof commonjsRequire=="function"&&commonjsRequire;if(!O&&N)return N(D,!0);if(y)return y(D,!0);var j=new Error("Cannot find module '"+D+"'");throw j.code="MODULE_NOT_FOUND",j}var G=w[D]={exports:{}};m[D][0].call(G.exports,function(H){var te=m[D][1][H];return A(te||H)},G,G.exports,p,m,w,T)}return w[D].exports}for(var y=typeof commonjsRequire=="function"&&commonjsRequire,B=0;B<T.length;B++)A(T[B]);return A}({1:[function(p,m,w){var T,A,y,B,D,O=function(j,G){for(var H in G)N.call(G,H)&&(j[H]=G[H]);function te(){this.constructor=j}return te.prototype=G.prototype,j.prototype=new te,j.__super__=G.prototype,j},N={}.hasOwnProperty;T=p("./PriorityQueue/AbstractPriorityQueue"),A=p("./PriorityQueue/ArrayStrategy"),B=p("./PriorityQueue/BinaryHeapStrategy"),y=p("./PriorityQueue/BHeapStrategy"),D=function(j){O(G,j);function G(H){H||(H={}),H.strategy||(H.strategy=B),H.comparator||(H.comparator=function(te,oe){return(te||0)-(oe||0)}),G.__super__.constructor.call(this,H)}return G}(T),D.ArrayStrategy=A,D.BinaryHeapStrategy=B,D.BHeapStrategy=y,m.exports=D},{"./PriorityQueue/AbstractPriorityQueue":2,"./PriorityQueue/ArrayStrategy":3,"./PriorityQueue/BHeapStrategy":4,"./PriorityQueue/BinaryHeapStrategy":5}],2:[function(p,m,w){m.exports=function(){function T(A){var y;if((A!=null?A.strategy:void 0)==null)throw"Must pass options.strategy, a strategy";if((A!=null?A.comparator:void 0)==null)throw"Must pass options.comparator, a comparator";this.priv=new A.strategy(A),this.length=(A!=null&&(y=A.initialValues)!=null?y.length:void 0)||0}return T.prototype.queue=function(A){this.length++,this.priv.queue(A)},T.prototype.dequeue=function(A){if(!this.length)throw"Empty queue";return this.length--,this.priv.dequeue()},T.prototype.peek=function(A){if(!this.length)throw"Empty queue";return this.priv.peek()},T.prototype.clear=function(){return this.length=0,this.priv.clear()},T}()},{}],3:[function(p,m,w){var T;T=function(A,y,B){var D,O,N;for(O=0,D=A.length;O<D;)N=O+D>>>1,B(A[N],y)>=0?O=N+1:D=N;return O},m.exports=function(){function A(y){var B;this.options=y,this.comparator=this.options.comparator,this.data=((B=this.options.initialValues)!=null?B.slice(0):void 0)||[],this.data.sort(this.comparator).reverse()}return A.prototype.queue=function(y){var B;B=T(this.data,y,this.comparator),this.data.splice(B,0,y)},A.prototype.dequeue=function(){return this.data.pop()},A.prototype.peek=function(){return this.data[this.data.length-1]},A.prototype.clear=function(){this.data.length=0},A}()},{}],4:[function(p,m,w){m.exports=function(){function T(A){var y,B,D,O,N,j,G,H;for(this.comparator=(A!=null?A.comparator:void 0)||function(te,oe){return te-oe},this.pageSize=(A!=null?A.pageSize:void 0)||512,this.length=0,G=0;1<<G<this.pageSize;)G+=1;if(1<<G!==this.pageSize)throw"pageSize must be a power of two";for(this._shift=G,this._emptyMemoryPageTemplate=y=[],B=0,N=this.pageSize;0<=N?B<N:B>N;0<=N?++B:--B)y.push(null);if(this._memory=[],this._mask=this.pageSize-1,A.initialValues)for(j=A.initialValues,D=0,O=j.length;D<O;D++)H=j[D],this.queue(H)}return T.prototype.queue=function(A){this.length+=1,this._write(this.length,A),this._bubbleUp(this.length,A)},T.prototype.dequeue=function(){var A,y;return A=this._read(1),y=this._read(this.length),this.length-=1,this.length>0&&(this._write(1,y),this._bubbleDown(1,y)),A},T.prototype.peek=function(){return this._read(1)},T.prototype.clear=function(){this.length=0,this._memory.length=0},T.prototype._write=function(A,y){var B;for(B=A>>this._shift;B>=this._memory.length;)this._memory.push(this._emptyMemoryPageTemplate.slice(0));return this._memory[B][A&this._mask]=y},T.prototype._read=function(A){return this._memory[A>>this._shift][A&this._mask]},T.prototype._bubbleUp=function(A,y){var B,D,O,N;for(B=this.comparator;A>1&&(D=A&this._mask,A<this.pageSize||D>3?O=A&~this._mask|D>>1:D<2?(O=A-this.pageSize>>this._shift,O+=O&~(this._mask>>1),O|=this.pageSize>>1):O=A-2,N=this._read(O),!(B(N,y)<0));)this._write(O,y),this._write(A,N),A=O},T.prototype._bubbleDown=function(A,y){var B,D,O,N,j;for(j=this.comparator;A<this.length;)if(A>this._mask&&!(A&this._mask-1)?B=D=A+2:A&this.pageSize>>1?(B=(A&~this._mask)>>1,B|=A&this._mask>>1,B=B+1<<this._shift,D=B+1):(B=A+(A&this._mask),D=B+1),B!==D&&D<=this.length)if(O=this._read(B),N=this._read(D),j(O,y)<0&&j(O,N)<=0)this._write(B,y),this._write(A,O),A=B;else if(j(N,y)<0)this._write(D,y),this._write(A,N),A=D;else break;else if(B<=this.length)if(O=this._read(B),j(O,y)<0)this._write(B,y),this._write(A,O),A=B;else break;else break},T}()},{}],5:[function(p,m,w){m.exports=function(){function T(A){var y;this.comparator=(A!=null?A.comparator:void 0)||function(B,D){return B-D},this.length=0,this.data=((y=A.initialValues)!=null?y.slice(0):void 0)||[],this._heapify()}return T.prototype._heapify=function(){var A,y,B;if(this.data.length>0)for(A=y=1,B=this.data.length;1<=B?y<B:y>B;A=1<=B?++y:--y)this._bubbleUp(A)},T.prototype.queue=function(A){this.data.push(A),this._bubbleUp(this.data.length-1)},T.prototype.dequeue=function(){var A,y;return y=this.data[0],A=this.data.pop(),this.data.length>0&&(this.data[0]=A,this._bubbleDown(0)),y},T.prototype.peek=function(){return this.data[0]},T.prototype.clear=function(){this.length=0,this.data.length=0},T.prototype._bubbleUp=function(A){for(var y,B;A>0&&(y=A-1>>>1,this.comparator(this.data[A],this.data[y])<0);)B=this.data[y],this.data[y]=this.data[A],this.data[A]=B,A=y},T.prototype._bubbleDown=function(A){var y,B,D,O,N;for(y=this.data.length-1;B=(A<<1)+1,O=B+1,D=A,B<=y&&this.comparator(this.data[B],this.data[D])<0&&(D=B),O<=y&&this.comparator(this.data[O],this.data[D])<0&&(D=O),D!==A;)N=this.data[D],this.data[D]=this.data[A],this.data[A]=N,A=D},T}()},{}]},{},[1])(1)})})(priorityQueue);var PriorityQueue=priorityQueue.exports;const dxs=[1,0,-1,0,1,1,-1,-1],dys=[0,1,0,-1,1,-1,1,-1];function fromWaterShed(h={}){let{points:l,mask:p,image:m,fillMaxValue:w=this.maxValue,invert:T=!1}=h,A=m||this;A.checkProcessable("fromWaterShed",{bitDepth:[8,16],components:1}),T=!T,l||(l=A.getLocalMaxima({invert:T,mask:p}));let y=T?0:1,B=new Int16Array(A.size),D=A.width,O=A.height,N=new PriorityQueue({comparator:(j,G)=>j[2]-G[2],strategy:PriorityQueue.BinaryHeapStrategy});for(let j=0;j<l.length;j++){let G=l[j][0]+l[j][1]*D;B[G]=j+1;let H=A.data[G];(T&&H<=w||!T&&H>=w)&&N.queue([l[j][0],l[j][1],H])}for(;N.length>0;){let j=N.dequeue(),G=j[0]+j[1]*D;for(let H=0;H<4;H++){let te=j[0]+dxs[H],oe=j[1]+dys[H];if(te>=0&&oe>=0&&te<D&&oe<O){let Q=te+oe*D;if(!p||p.getBit(Q)===y){let _e=A.data[Q];(T&&_e<=w||!T&&_e>=w)&&B[Q]===0&&(B[Q]=B[G],N.queue([j[0]+dxs[H],j[1]+dys[H],_e]))}}}}return new RoiMap(A,B)}class RoiManager{constructor(l,p={}){this._image=l,this._options=p,this._options.label||(this._options.label="default"),this._layers={},this._painted=null}fromMaxima(l={}){let p=Object.assign({},this._options,l),m=fromMaxima.call(this._image,l);this._layers[p.label]=new RoiLayer(m,p)}fromPoints(l,p={}){let m=Object.assign({},this._options,p),w=fromPoints.call(this._image,l,p);return this._layers[m.label]=new RoiLayer(w,m),this}putMap(l,p={}){let m=new RoiMap(this._image,l),w=Object.assign({},this._options,p);return this._layers[w.label]=new RoiLayer(m,w),this}fromWaterShed(l={}){let p=Object.assign({},this._options,l),m=fromWaterShed.call(this._image,l);this._layers[p.label]=new RoiLayer(m,p)}fromMask(l,p={}){let m=Object.assign({},this._options,p),w=fromMask.call(this._image,l,p);return this._layers[m.label]=new RoiLayer(w,m),this}fromMaskConnectedComponentLabelingAlgorithm(l,p={}){let m=Object.assign({},this._options,p),w=fromMaskConnectedComponentLabelingAlgorithm.call(this._image,l,p);return this._layers[m.label]=new RoiLayer(w,m),this}getMap(l={}){let p=Object.assign({},this._options,l);return this._assertLayerWithLabel(p.label),this._layers[p.label].roiMap}rowsInfo(l={}){return this.getMap(l).rowsInfo()}colsInfo(l={}){return this.getMap(l).rowsInfo()}getRoiIds(l={}){let p=this.getRois(l);if(p){let m=new Array(p.length);for(let w=0;w<p.length;w++)m[w]=p[w].id;return m}throw new Error("ROIs not found")}getRois(l={}){let{label:p=this._options.label,positive:m=!0,negative:w=!0,minSurface:T=0,maxSurface:A=Number.POSITIVE_INFINITY,minWidth:y=0,maxWidth:B=Number.POSITIVE_INFINITY,minHeight:D=0,maxHeight:O=Number.POSITIVE_INFINITY,minRatio:N=0,maxRatio:j=Number.POSITIVE_INFINITY}=l;if(!this._layers[p])throw new Error(`this Roi layer (${p}) does not exist`);const G=this._layers[p].roi,H=[];for(const te of G)(te.id<0&&w||te.id>0&&m)&&te.surface>=T&&te.surface<=A&&te.width>=y&&te.width<=B&&te.height>=D&&te.height<=O&&te.ratio>=N&&te.ratio<=j&&H.push(te);return H}getRoi(l,p={}){const{label:m=this._options.label}=p;if(!this._layers[m])throw new Error(`this Roi layer (${m}) does not exist`);const w=this._layers[m].roi.find(T=>T.id===l);if(!w)throw new Error(`found no Roi with id ${l}`);return w}getMasks(l={}){let p=this.getRois(l),m=new Array(p.length);for(let w=0;w<p.length;w++)m[w]=p[w].getMask(l);return m}getAnalysisMasks(l={}){const{analysisProperty:p}=l;let m=`${p}Mask`,w=this.getRois(l);return w.length===0||!w[0][m]?[]:w.map(T=>T[m])}getData(l={}){let p=Object.assign({},this._options,l);return this._assertLayerWithLabel(p.label),this._layers[p.label].roiMap.data}paint(l={}){let{labelProperty:p,analysisProperty:m}=l;this._painted||(this._painted=this._image.rgba8());let w=this.getMasks(l);if(p){const T=this.getRois(l);l.labels=T.map(D=>deepValue(D,p));const A=Math.max(...l.labels);let y=!1,B=!1;if(p.includes("surface")?y=!0:/(?:perimeter|min|max|external|width|height|length)/.test(p)&&(B=!0),isFinite(A)){let D="";if(l.unit!=="pixel"&&l.pixelSize&&(B||y)){D=y?`${l.unit}^2`:l.unit;let O=y?"m^2":"m",N=y?l.pixelSize**2:l.pixelSize;const j=Qty.swiftConverter(O,D);l.labels=l.labels.map(G=>j(N*G))}A>50?l.labels=l.labels.map(O=>Math.round(O)+D):A>10?l.labels=l.labels.map(O=>O.toFixed(1)+D):l.labels=l.labels.map(O=>O.toFixed(2)+D)}l.labelsPosition=T.map(D=>[D.meanX,D.meanY])}if(this._painted.paintMasks(w,l),m){let T=this.getAnalysisMasks(l);this._painted.paintMasks(T,{color:l.analysisColor,alpha:l.analysisAlpha})}return this._painted}getMask(l={}){let p=new Image$1(this._image.width,this._image.height,{kind:"BINARY"}),m=this.getMasks(l);for(let w=0;w<m.length;w++){let T=m[w];for(let A=0;A<T.width;A++)for(let y=0;y<T.height;y++)T.getBitXY(A,y)&&p.setBitXY(A+T.position[0],y+T.position[1])}return p}resetPainted(l={}){const{image:p}=l;p?this._painted=this.image.rgba8():this._painted=this._image.rgba8()}mergeRoi(l={}){const p=this.getMap(l);return p.mergeRoi(l),this.putMap(p.data,l),this}mergeRois(l,p={}){if(!Array.isArray(l)||l.some(w=>!Number.isInteger(w)))throw new Error("Roi ids must be an array of integers");if(l.length<2)throw new Error("Roi ids must have at least two elements");if(new Set(l).size!==l.length)throw new Error("Roi ids must be all different");l.forEach(w=>this.getRoi(w));const m=this.getMap(p);return m.mergeRois(l),this.putMap(m.data,p),this}findCorrespondingRoi(l,p={}){let m=this.getRois(p),w=[];for(let T=0;T<m.length;T++){let A=m[T],y=A.minX,B=A.minY,D=A.points,O=Math.sign(A.id),N=correspondingRoisInformation(y,B,D,l,O);w.push(N)}return w}_assertLayerWithLabel(l){if(!this._layers[l])throw new Error(`no layer with label ${l}`)}}function correspondingRoisInformation(h,l,p,m,w){let T={id:[],surface:[],roiSurfaceCovered:[],same:0,opposite:0,total:0};for(let A=0;A<p.length;A++){let y=p[A],B=y[0],D=y[1],O=B+h+(D+l)*m.width,N=m.data[O];(N>0||N<0)&&(T.id.includes(N)?T.surface[T.id.indexOf(N)]+=1:(T.id.push(N),T.surface.push(1)))}for(let A=0;A<T.id.length;A++)Math.sign(T.id[A])===w?T.same+=T.surface[A]:T.opposite+=T.surface[A],T.roiSurfaceCovered[A]=T.surface[A]/p.length;return T.total=T.opposite+T.same,T}const objectToString$1=Object.prototype.toString;class Image$1{constructor(l,p,m,w){if(arguments.length===1?(w=l,{width:l,height:p,data:m}=w):m&&!m.length&&(w=m,{data:m}=w),l===void 0&&(l=1),p===void 0&&(p=1),w===void 0&&(w={}),typeof w!="object"||w===null)throw new TypeError("options must be an object");if(!Number.isInteger(l)||l<=0)throw new RangeError("width must be a positive integer");if(!Number.isInteger(p)||p<=0)throw new RangeError("height must be a positive integer");const{kind:T=RGBA}=w;if(typeof T!="string")throw new TypeError("kind must be a string");const A=getKind(T),y=Object.assign({},w);for(const te in A)y[te]===void 0&&(y[te]=A[te]);verifyKindDefinition(y);const{components:B,bitDepth:D,colorModel:O}=y,N=y.alpha+0,j=l*p,G=B+N,H=D===32?Number.MAX_VALUE:2**D-1;if(m===void 0)m=createPixelArray(j,B,N,G,D,H);else{const te=getTheoreticalPixelArraySize(j,G,D);if(m.length!==te)throw new RangeError(`incorrect data size: ${m.length}. Should be ${te}`)}this.width=l,this.height=p,this.data=m,this.size=j,this.components=B,this.alpha=N,this.bitDepth=D,this.maxValue=H,this.colorModel=O,this.channels=G,this.meta=w.meta||{},Object.defineProperty(this,"parent",{enumerable:!1,writable:!0,configurable:!0,value:w.parent||null}),this.position=w.position||[0,0],this.computed=null,this.sizes=[this.width,this.height],this.multiplierX=this.channels,this.multiplierY=this.channels*this.width,this.isClamped=this.bitDepth<32,this.borderSizes=[0,0]}get[Symbol.toStringTag](){return"IJSImage"}static isImage(l){return objectToString$1.call(l)==="[object IJSImage]"}static fromCanvas(l){const m=l.getContext("2d").getImageData(0,0,l.width,l.height);return new Image$1(m.width,m.height,m.data)}static createFrom(l,p){const m=getImageParameters(l);return Object.assign(m,{parent:l,position:[0,0]},p),new Image$1(m)}getRoiManager(l){return new RoiManager(this,l)}clone(){const l=this.data.slice();return new Image$1(this.width,this.height,l,this)}apply(l){for(let p=0;p<this.height;p++)for(let m=0;m<this.width;m++){let w=(p*this.width+m)*this.channels;l.call(this,w)}}}setValueMethods(Image$1);setBitMethods(Image$1);setExportMethods(Image$1);Image$1.prototype.checkProcessable=checkProcessable;Image$1.prototype.getRGBAData=getRGBAData;Image$1.load=load;Image$1.extendMethod=extendMethod;Image$1.extendProperty=extendProperty;extend$4(Image$1);var workerTemplate$1={},worker$1=function(){self.window=self;function h(){this._listeners={}}h.prototype.on=function(p,m){if(this._listeners[p])throw new RangeError("there is already a listener for "+p);if(typeof m!="function")throw new TypeError("callback argument must be a function");this._listeners[p]=m},h.prototype._send=function(p,m,w){w===void 0?w=[]:Array.isArray(w)||(w=[w]),self.postMessage({id:p,data:m},w)},h.prototype._trigger=function(p,m){if(!this._listeners[p])throw new Error("event "+p+" is not defined");this._listeners[p].apply(null,m)};var l=new h;self.onmessage=function(p){switch(p.data.action){case"exec":p.data.args.unshift(function(m,w){l._send(p.data.id,m,w)}),l._trigger(p.data.event,p.data.args);break;case"ping":l._send(p.data.id,"pong");break;default:throw new Error("unexpected action: "+p.data.action)}}},workerStr=worker$1.toString().split('"CODE";');workerTemplate$1.newWorkerURL=function h(l,p){var m=new Blob(["(",workerStr[0],"importScripts.apply(self, "+JSON.stringify(p)+`);
`,"(",l,")();",workerStr[1],")();"],{type:"application/javascript"});return URL.createObjectURL(m)};var workerTemplate=workerTemplate$1,CORES=navigator.hardwareConcurrency||1;function WorkerManager(h,l){if(typeof h!="string"&&typeof h!="function")throw new TypeError("func argument must be a function");if(l===void 0&&(l={}),typeof l!="object"||l===null)throw new TypeError("options argument must be an object");this._workerCode=h.toString(),l.maxWorkers===void 0||l.maxWorkers==="auto"?this._numWorkers=Math.min(CORES-1,1):l.maxWorkers>0?this._numWorkers=Math.min(l.maxWorkers,CORES):this._numWorkers=CORES,this._workers=new Map,this._timeout=l.timeout||0,this._terminateOnError=!!l.terminateOnError;var p=l.deps;typeof p=="string"&&(p=[p]),Array.isArray(p)||(p=void 0),this._id=0,this._terminated=!1,this._working=0,this._waiting=[],this._init(p)}WorkerManager.prototype._init=function(h){for(var l=workerTemplate.newWorkerURL(this._workerCode,h),p=0;p<this._numWorkers;p++){var m=new Worker(l);m.onmessage=this._onmessage.bind(this,m),m.onerror=this._onerror.bind(this,m),m.running=!1,m.id=p,this._workers.set(m,null)}URL.revokeObjectURL(l)};WorkerManager.prototype._onerror=function(h,l){if(!this._terminated){this._working--,h.running=!1;var p=this._workers.get(h);p&&p[1](l.message),this._workers.set(h,null),this._terminateOnError?this.terminate():this._exec()}};WorkerManager.prototype._onmessage=function(h,l){if(!this._terminated){this._working--,h.running=!1;var p=this._workers.get(h);p&&p[0](l.data.data),this._workers.set(h,null),this._exec()}};WorkerManager.prototype._exec=function(){for(var h of this._workers.keys()){if(this._working===this._numWorkers||this._waiting.length===0)return;if(!h.running)for(var l=0;l<this._waiting.length;l++){var p=this._waiting[l];if(!(typeof p[4]=="number"&&p[4]!==h.id)){this._waiting.splice(l,1),h.postMessage({action:"exec",event:p[0],args:p[1]},p[2]),h.running=!0,h.time=Date.now(),this._workers.set(h,p[3]),this._working++;break}}}};WorkerManager.prototype.terminate=function(){if(!this._terminated){for(var h of this._workers)h[0].terminate(),h[1]&&h[1][1](new Error("Terminated"));this._workers.clear(),this._waiting=[],this._working=0,this._terminated=!0}};WorkerManager.prototype.postAll=function(h,l){if(this._terminated)throw new Error("Cannot post (terminated)");var p=[];for(var m of this._workers.keys())p.push(this.post(h,l,[],m.id));return Promise.all(p)};WorkerManager.prototype.post=function(h,l,p,m){l===void 0&&(l=[]),p===void 0&&(p=[]),Array.isArray(l)||(l=[l]),Array.isArray(p)||(p=[p]);var w=this;return new Promise(function(T,A){if(w._terminated)throw new Error("Cannot post (terminated)");w._waiting.push([h,l,p,[T,A],m]),w._exec()})};var src=WorkerManager;const defaultOptions={regression:{kernelType:"polynomial",kernelOptions:{degree:2,constant:1}},threshold:.02,roi:{minSurface:100,positive:!1},sampling:20,include:[]};function run(h,l,p){l=Object.assign({},defaultOptions,l);const m=this.manager;return Array.isArray(h)?Promise.all(h.map(function(w){const T=runOnce(m,w,l);return typeof p=="function"&&T.then(p),T})):runOnce(m,h,l)}function runOnce(h,l,p){return h.post("data",[l,p]).then(function(m){for(let w in m)m[w]=new Image$1(m[w]);return m})}function work(){worker.on("data",function(h,l,p){l=new IJS(l);const m={},w=[],T=l.grey(),A=T.sobelFilter();G("sobel",A);const y=A.level().mask({threshold:p.threshold});G("mask",y);const B=A.getRoiManager();B.fromMask(y);const D=B.getMask(p.roi);G("realMask",D);const O=T.getPixelsGrid({sampling:p.sampling,mask:D}),N=l.getBackground(O.xyS,O.zS,p.regression);G("background",N);const j=l.subtract(N);m.result=j,w.push(j.data.buffer),h(m,w);function G(H,te){p.include.includes(H)&&(m[H]=te,w.push(te.data.buffer))}})}const background={run,work};function extend$3(h){h.extendMethod("background",background)}class Worker$1{constructor(){this._url=null,this._deps=[null]}checkUrl(){if(this._url===null)throw new Error("image worker must be initialized with an URL")}get url(){return this._url}set url(l){if(typeof l!="string")throw new TypeError("worker URL must be a string");this._url=l,this._deps[0]=l}static extendMethod(l,p){let m,w,T={};function A(...y){return m||(this.checkUrl(),w=this.url,m=new src(p.work,{deps:w}),T.manager=m),p.run.call(T,...y)}A.reset=function(){m&&(m.terminate(),m=new src(p.work,{deps:w}),T.manager=m)},Worker$1.prototype[l]=A}}extend$3(Worker$1);new Worker$1;function getFileHandle(){if("showOpenFilePicker"in window)return window.showOpenFilePicker().then(h=>h[0])}function getDirHandle(){if("showDirectoryPicker"in window)return window.showDirectoryPicker().then(h=>h)}async function verifyPermission(h,l){const p={};return l&&(p.writable=!0,p.mode="readwrite"),await h.queryPermission(p)==="granted"||await h.requestPermission(p)==="granted"}async function writeFileToDisk(h,l,p){let w=await(await h.getFileHandle(l,{create:!0})).createWritable();await w.write(p),await w.close()}async function fileExists(h,l){try{return await h.getFileHandle(l),!0}catch(p){if(p.name==="NotFoundError")return!1;if(p.name==="NotAllowedError")return console.log("Please select directory to verify permissions"),!1}}function getHeightFromRgb(h,l,p){return-1e4+(h*256*256+l*256+p)*.1}function getHeightArray(h){let l=[],p=h.getPixelsArray();for(const m of p){let w=m[0],T=m[1],A=m[2],y=getHeightFromRgb(w,T,A);l.push(y)}return{decodedHeightArray:l}}function createHeightMapImage(h,l,p){let m=getHeightArray(h),w=convertImage(h.width,h.height,m.decodedHeightArray,l,p);return m.minElevation=w.min[0],m.maxElevation=w.max[0],m.image=w,m}async function loadImageFromArray(h){return await Image$1.load(h)}function convertImage(h,l,p,m,w){return new Image$1(h,l,p,{kind:w,bitDepth:m})}async function getMapboxTerrainRgb(h,l,p){let m,w=await fileExists(h,l.rgbFileName),T;return w===!1?m=await downloadTerrainRgb(p):m=await readFileFromDisk(h,l.rgbFileName),T=await loadImageFromArray(m),T}async function downloadTerrainRgb(h){return(await fetch(h)).arrayBuffer()}async function readFileFromDisk(h,l){return await(await(await h.getFileHandle(l)).getFile()).arrayBuffer()}var fileUtils={getDirHandle,verifyPermission,createHeightMapImage,convertImage,writeFileToDisk,getMapboxTerrainRgb,fileExists,getFileHandle,loadImageFromArray},mapboxGl={exports:{}};(function(h,l){(function(p,m){h.exports=m()})(commonjsGlobal,function(){var p,m,w;function T(y,B){if(!p)p=B;else if(!m)m=B;else{var D="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+p+")(sharedChunk); ("+m+")(sharedChunk); self.onerror = null;",O={};p(O),w=B(O),typeof window!="undefined"&&(w.workerUrl=window.URL.createObjectURL(new Blob([D],{type:"text/javascript"})))}}T(["exports"],function(y){var B="2.6.1",D=O;function O(x,d,b,E){this.cx=3*x,this.bx=3*(b-x)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*d,this.by=3*(E-d)-this.cy,this.ay=1-this.cy-this.by,this.p1x=x,this.p1y=E,this.p2x=b,this.p2y=E}O.prototype.sampleCurveX=function(x){return((this.ax*x+this.bx)*x+this.cx)*x},O.prototype.sampleCurveY=function(x){return((this.ay*x+this.by)*x+this.cy)*x},O.prototype.sampleCurveDerivativeX=function(x){return(3*this.ax*x+2*this.bx)*x+this.cx},O.prototype.solveCurveX=function(x,d){var b,E,S,k,P;for(d===void 0&&(d=1e-6),S=x,P=0;P<8;P++){if(k=this.sampleCurveX(S)-x,Math.abs(k)<d)return S;var F=this.sampleCurveDerivativeX(S);if(Math.abs(F)<1e-6)break;S-=k/F}if((S=x)<(b=0))return b;if(S>(E=1))return E;for(;b<E;){if(k=this.sampleCurveX(S),Math.abs(k-x)<d)return S;x>k?b=S:E=S,S=.5*(E-b)+b}return S},O.prototype.solve=function(x,d){return this.sampleCurveY(this.solveCurveX(x,d))};var N=j;function j(x,d){this.x=x,this.y=d}j.prototype={clone:function(){return new j(this.x,this.y)},add:function(x){return this.clone()._add(x)},sub:function(x){return this.clone()._sub(x)},multByPoint:function(x){return this.clone()._multByPoint(x)},divByPoint:function(x){return this.clone()._divByPoint(x)},mult:function(x){return this.clone()._mult(x)},div:function(x){return this.clone()._div(x)},rotate:function(x){return this.clone()._rotate(x)},rotateAround:function(x,d){return this.clone()._rotateAround(x,d)},matMult:function(x){return this.clone()._matMult(x)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(x){return this.x===x.x&&this.y===x.y},dist:function(x){return Math.sqrt(this.distSqr(x))},distSqr:function(x){var d=x.x-this.x,b=x.y-this.y;return d*d+b*b},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(x){return Math.atan2(this.y-x.y,this.x-x.x)},angleWith:function(x){return this.angleWithSep(x.x,x.y)},angleWithSep:function(x,d){return Math.atan2(this.x*d-this.y*x,this.x*x+this.y*d)},_matMult:function(x){var d=x[2]*this.x+x[3]*this.y;return this.x=x[0]*this.x+x[1]*this.y,this.y=d,this},_add:function(x){return this.x+=x.x,this.y+=x.y,this},_sub:function(x){return this.x-=x.x,this.y-=x.y,this},_mult:function(x){return this.x*=x,this.y*=x,this},_div:function(x){return this.x/=x,this.y/=x,this},_multByPoint:function(x){return this.x*=x.x,this.y*=x.y,this},_divByPoint:function(x){return this.x/=x.x,this.y/=x.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var x=this.y;return this.y=this.x,this.x=-x,this},_rotate:function(x){var d=Math.cos(x),b=Math.sin(x),E=b*this.x+d*this.y;return this.x=d*this.x-b*this.y,this.y=E,this},_rotateAround:function(x,d){var b=Math.cos(x),E=Math.sin(x),S=d.y+E*(this.x-d.x)+b*(this.y-d.y);return this.x=d.x+b*(this.x-d.x)-E*(this.y-d.y),this.y=S,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},j.convert=function(x){return x instanceof j?x:Array.isArray(x)?new j(x[0],x[1]):x};var G=typeof self!="undefined"?self:{};const H=Math.pow(2,53)-1,te=Math.PI/180,oe=180/Math.PI;function Q(x){return x*te}function _e(x){return x*oe}const se=[[0,0],[1,0],[1,1],[0,1]];function he(x){if(x<=0)return 0;if(x>=1)return 1;const d=x*x,b=d*x;return 4*(x<.5?b:3*(x-d)+b-.75)}function me(x,d,b,E){const S=new D(x,d,b,E);return function(k){return S.solve(k)}}const Re=me(.25,.1,.25,1);function ge(x,d,b){return Math.min(b,Math.max(d,x))}function ue(x,d,b){const E=b-d,S=((x-d)%E+E)%E+d;return S===d?b:S}function Se(x,d,b){if(!x.length)return b(null,[]);let E=x.length;const S=new Array(x.length);let k=null;x.forEach((P,F)=>{d(P,($,V)=>{$&&(k=$),S[F]=V,--E==0&&b(k,S)})})}function le(x){const d=[];for(const b in x)d.push(x[b]);return d}function pe(x,...d){for(const b of d)for(const E in b)x[E]=b[E];return x}let Le=1;function Ze(){return Le++}function lt(){return function x(d){return d?(d^16*Math.random()>>d/4).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,x)}()}function ct(x){return x<=1?1:Math.pow(2,Math.ceil(Math.log(x)/Math.LN2))}function $t(x){return!!x&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(x)}function Nt(x,d){x.forEach(b=>{d[b]&&(d[b]=d[b].bind(d))})}function St(x,d){return x.indexOf(d,x.length-d.length)!==-1}function Gt(x,d,b){const E={};for(const S in x)E[S]=d.call(b||this,x[S],S,x);return E}function Dt(x,d,b){const E={};for(const S in x)d.call(b||this,x[S],S,x)&&(E[S]=x[S]);return E}function Ut(x){return Array.isArray(x)?x.map(Ut):typeof x=="object"&&x?Gt(x,Ut):x}const Xt={};function ft(x){Xt[x]||(typeof console!="undefined"&&console.warn(x),Xt[x]=!0)}function wt(x,d,b){return(b.y-x.y)*(d.x-x.x)>(d.y-x.y)*(b.x-x.x)}function bt(x){let d=0;for(let b,E,S=0,k=x.length,P=k-1;S<k;P=S++)b=x[S],E=x[P],d+=(E.x-b.x)*(b.y+E.y);return d}function zt(){return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope}function qt(x){const d={};if(x.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(b,E,S,k)=>{const P=S||k;return d[E]=!P||P.toLowerCase(),""}),d["max-age"]){const b=parseInt(d["max-age"],10);isNaN(b)?delete d["max-age"]:d["max-age"]=b}return d}let ui,Ct,di,mi=null;function Ti(x){if(mi==null){const d=x.navigator?x.navigator.userAgent:null;mi=!!x.safari||!(!d||!(/\b(iPad|iPhone|iPod)\b/.test(d)||d.match("Safari")&&!d.match("Chrome")))}return mi}function hi(x){try{const d=G[x];return d.setItem("_mapbox_test_",1),d.removeItem("_mapbox_test_"),!0}catch{return!1}}const Pt={now:()=>di!==void 0?di:G.performance.now(),setNow(x){di=x},restoreNow(){di=void 0},frame(x){const d=G.requestAnimationFrame(x);return{cancel:()=>G.cancelAnimationFrame(d)}},getImageData(x,d=0){const b=G.document.createElement("canvas"),E=b.getContext("2d");if(!E)throw new Error("failed to create canvas 2d context");return b.width=x.width,b.height=x.height,E.drawImage(x,0,0,x.width,x.height),E.getImageData(-d,-d,x.width+2*d,x.height+2*d)},resolveURL:x=>(ui||(ui=G.document.createElement("a")),ui.href=x,ui.href),get devicePixelRatio(){return G.devicePixelRatio},get prefersReducedMotion(){return!!G.matchMedia&&(Ct==null&&(Ct=G.matchMedia("(prefers-reduced-motion: reduce)")),Ct.matches)}};let Tt;const Lt={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(Tt==null){const x=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{Tt={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):x}catch{Tt=x}}return Tt},get EVENTS_URL(){return this.API_URL?this.API_URL.indexOf("https://api.mapbox.cn")===0?"https://events.mapbox.cn/events/v2":this.API_URL.indexOf("https://api.mapbox.com")===0?"https://events.mapbox.com/events/v2":null:null},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},Jt={supported:!1,testSupport:function(x){!Kt&&jt&&(Yt?ii(x):He=x)}};let He,jt,Kt=!1,Yt=!1;function ii(x){const d=x.createTexture();x.bindTexture(x.TEXTURE_2D,d);try{if(x.texImage2D(x.TEXTURE_2D,0,x.RGBA,x.RGBA,x.UNSIGNED_BYTE,jt),x.isContextLost())return;Jt.supported=!0}catch{}x.deleteTexture(d),Kt=!0}G.document&&(jt=G.document.createElement("img"),jt.onload=function(){He&&ii(He),He=null,Yt=!0},jt.onerror=function(){Kt=!0,He=null},jt.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const xt="01",Mi="NO_ACCESS_TOKEN";function ei(x){return x.indexOf("mapbox:")===0}function Vt(x){return Lt.API_URL_REGEX.test(x)}const Zt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Et(x){const d=x.match(Zt);if(!d)throw new Error("Unable to parse URL object");return{protocol:d[1],authority:d[2],path:d[3]||"/",params:d[4]?d[4].split("&"):[]}}function ti(x){const d=x.params.length?`?${x.params.join("&")}`:"";return`${x.protocol}://${x.authority}${x.path}${d}`}function _i(x){if(!x)return null;const d=x.split(".");if(!d||d.length!==3)return null;try{return JSON.parse(decodeURIComponent(G.atob(d[1]).split("").map(b=>"%"+("00"+b.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class vi{constructor(d){this.type=d,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(d){const b=_i(Lt.ACCESS_TOKEN);let E="";return E=b&&b.u?G.btoa(encodeURIComponent(b.u).replace(/%([0-9A-F]{2})/g,(S,k)=>String.fromCharCode(Number("0x"+k)))):Lt.ACCESS_TOKEN||"",d?`mapbox.eventData.${d}:${E}`:`mapbox.eventData:${E}`}fetchEventData(){const d=hi("localStorage"),b=this.getStorageKey(),E=this.getStorageKey("uuid");if(d)try{const S=G.localStorage.getItem(b);S&&(this.eventData=JSON.parse(S));const k=G.localStorage.getItem(E);k&&(this.anonId=k)}catch{ft("Unable to read from LocalStorage")}}saveEventData(){const d=hi("localStorage"),b=this.getStorageKey(),E=this.getStorageKey("uuid");if(d)try{G.localStorage.setItem(E,this.anonId),Object.keys(this.eventData).length>=1&&G.localStorage.setItem(b,JSON.stringify(this.eventData))}catch{ft("Unable to write to LocalStorage")}}processRequests(d){}postEvent(d,b,E,S){if(!Lt.EVENTS_URL)return;const k=Et(Lt.EVENTS_URL);k.params.push(`access_token=${S||Lt.ACCESS_TOKEN||""}`);const P={event:this.type,created:new Date(d).toISOString(),sdkIdentifier:"mapbox-gl-js",sdkVersion:B,skuId:xt,userId:this.anonId},F=b?pe(P,b):P,$={url:ti(k),headers:{"Content-Type":"text/plain"},body:JSON.stringify([F])};this.pendingRequest=de($,V=>{this.pendingRequest=null,E(V),this.saveEventData(),this.processRequests(S)})}queueRequest(d,b){this.queue.push(d),this.processRequests(b)}}const Ht=new class extends vi{constructor(x){super("appUserTurnstile"),this._customAccessToken=x}postTurnstileEvent(x,d){Lt.EVENTS_URL&&Lt.ACCESS_TOKEN&&Array.isArray(x)&&x.some(b=>ei(b)||Vt(b))&&this.queueRequest(Date.now(),d)}processRequests(x){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const d=_i(Lt.ACCESS_TOKEN),b=d?d.u:Lt.ACCESS_TOKEN;let E=b!==this.eventData.tokenU;$t(this.anonId)||(this.anonId=lt(),E=!0);const S=this.queue.shift();if(this.eventData.lastSuccess){const k=new Date(this.eventData.lastSuccess),P=new Date(S),F=(S-this.eventData.lastSuccess)/864e5;E=E||F>=1||F<-1||k.getDate()!==P.getDate()}else E=!0;if(!E)return this.processRequests();this.postEvent(S,{"enabled.telemetry":!1},k=>{k||(this.eventData.lastSuccess=S,this.eventData.tokenU=b)},x)}},ci=Ht.postTurnstileEvent.bind(Ht),Di=new class extends vi{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(x,d,b,E){this.skuToken=d,this.errorCb=E,Lt.EVENTS_URL&&(b||Lt.ACCESS_TOKEN?this.queueRequest({id:x,timestamp:Date.now()},b):this.errorCb(new Error(Mi)))}processRequests(x){if(this.pendingRequest||this.queue.length===0)return;const{id:d,timestamp:b}=this.queue.shift();d&&this.success[d]||(this.anonId||this.fetchEventData(),$t(this.anonId)||(this.anonId=lt()),this.postEvent(b,{skuToken:this.skuToken},E=>{E?this.errorCb(E):d&&(this.success[d]=!0)},x))}},$i=Di.postMapLoadEvent.bind(Di),Oi=new class extends vi{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(x,d,b,E){if(!Lt.API_URL||!Lt.SESSION_PATH)return;const S=Et(Lt.API_URL+Lt.SESSION_PATH);S.params.push(`sku=${d||""}`),S.params.push(`access_token=${E||Lt.ACCESS_TOKEN||""}`);const k={url:ti(S),headers:{"Content-Type":"text/plain"}};this.pendingRequest=Ae(k,P=>{this.pendingRequest=null,b(P),this.saveEventData(),this.processRequests(E)})}getSessionAPI(x,d,b,E){this.skuToken=d,this.errorCb=E,Lt.SESSION_PATH&&Lt.API_URL&&(b||Lt.ACCESS_TOKEN?this.queueRequest({id:x,timestamp:Date.now()},b):this.errorCb(new Error(Mi)))}processRequests(x){if(this.pendingRequest||this.queue.length===0)return;const{id:d,timestamp:b}=this.queue.shift();d&&this.success[d]||this.getSession(b,this.skuToken,E=>{E?this.errorCb(E):d&&(this.success[d]=!0)},x)}},pr=Oi.getSessionAPI.bind(Oi),vr=new Set,Jr="mapbox-tiles";let Ji,_r,zr=500,br=50;function yr(){G.caches&&!Ji&&(Ji=G.caches.open(Jr))}function Fr(x){const d=x.indexOf("?");return d<0?x:x.slice(0,d)}let Ur=1/0;const we={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(we);class Xe extends Error{constructor(d,b,E){b===401&&Vt(E)&&(d+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(d),this.status=b,this.url=E}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const ae=zt()?()=>self.worker&&self.worker.referrer:()=>(G.location.protocol==="blob:"?G.parent:G).location.href,K=function(x,d){if(!(/^file:/.test(b=x.url)||/^file:/.test(ae())&&!/^\w+:/.test(b))){if(G.fetch&&G.Request&&G.AbortController&&G.Request.prototype.hasOwnProperty("signal"))return function(E,S){const k=new G.AbortController,P=new G.Request(E.url,{method:E.method||"GET",body:E.body,credentials:E.credentials,headers:E.headers,referrer:ae(),signal:k.signal});let F=!1,$=!1;const V=(Z=P.url).indexOf("sku=")>0&&Vt(Z);var Z;E.type==="json"&&P.headers.set("Accept","application/json");const X=(ne,ce,ye)=>{if($)return;if(ne&&ne.message!=="SecurityError"&&ft(ne),ce&&ye)return W(ce);const Me=Date.now();G.fetch(P).then(Ce=>{if(Ce.ok){const ze=V?Ce.clone():null;return W(Ce,ze,Me)}return S(new Xe(Ce.statusText,Ce.status,E.url))}).catch(Ce=>{Ce.code!==20&&S(new Error(Ce.message))})},W=(ne,ce,ye)=>{(E.type==="arrayBuffer"?ne.arrayBuffer():E.type==="json"?ne.json():ne.text()).then(Me=>{$||(ce&&ye&&function(Ce,ze,$e){if(yr(),!Ji)return;const qe={status:ze.status,statusText:ze.statusText,headers:new G.Headers};ze.headers.forEach((Ye,ot)=>qe.headers.set(ot,Ye));const Ge=qt(ze.headers.get("Cache-Control")||"");Ge["no-store"]||(Ge["max-age"]&&qe.headers.set("Expires",new Date($e+1e3*Ge["max-age"]).toUTCString()),new Date(qe.headers.get("Expires")).getTime()-$e<42e4||function(Ye,ot){if(_r===void 0)try{new Response(new ReadableStream),_r=!0}catch{_r=!1}_r?ot(Ye.body):Ye.blob().then(ot)}(ze,Ye=>{const ot=new G.Response(Ye,qe);yr(),Ji&&Ji.then(et=>et.put(Fr(Ce.url),ot)).catch(et=>ft(et.message))}))}(P,ce,ye),F=!0,S(null,Me,ne.headers.get("Cache-Control"),ne.headers.get("Expires")))}).catch(Me=>{$||S(new Error(Me.message))})};return V?function(ne,ce){if(yr(),!Ji)return ce(null);const ye=Fr(ne.url);Ji.then(Me=>{Me.match(ye).then(Ce=>{const ze=function($e){if(!$e)return!1;const qe=new Date($e.headers.get("Expires")||0),Ge=qt($e.headers.get("Cache-Control")||"");return qe>Date.now()&&!Ge["no-cache"]}(Ce);Me.delete(ye),ze&&Me.put(ye,Ce.clone()),ce(null,Ce,ze)}).catch(ce)}).catch(ce)}(P,X):X(null,null),{cancel:()=>{$=!0,F||k.abort()}}}(x,d);if(zt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",x,d,void 0,!0)}var b;return function(E,S){const k=new G.XMLHttpRequest;k.open(E.method||"GET",E.url,!0),E.type==="arrayBuffer"&&(k.responseType="arraybuffer");for(const P in E.headers)k.setRequestHeader(P,E.headers[P]);return E.type==="json"&&(k.responseType="text",k.setRequestHeader("Accept","application/json")),k.withCredentials=E.credentials==="include",k.onerror=()=>{S(new Error(k.statusText))},k.onload=()=>{if((k.status>=200&&k.status<300||k.status===0)&&k.response!==null){let P=k.response;if(E.type==="json")try{P=JSON.parse(k.response)}catch(F){return S(F)}S(null,P,k.getResponseHeader("Cache-Control"),k.getResponseHeader("Expires"))}else S(new Xe(k.statusText,k.status,E.url))},k.send(E.body),{cancel:()=>k.abort()}}(x,d)},re=function(x,d){return K(pe(x,{type:"arrayBuffer"}),d)},de=function(x,d){return K(pe(x,{method:"POST"}),d)},Ae=function(x,d){return K(pe(x,{method:"GET"}),d)};function Be(x){const d=G.document.createElement("a");return d.href=x,d.protocol===G.document.location.protocol&&d.host===G.document.location.host}const Ne="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Ue,Fe;Ue=[],Fe=0;const je=function(x,d){if(Jt.supported&&(x.headers||(x.headers={}),x.headers.accept="image/webp,*/*"),Fe>=Lt.MAX_PARALLEL_IMAGE_REQUESTS){const k={requestParameters:x,callback:d,cancelled:!1,cancel(){this.cancelled=!0}};return Ue.push(k),k}Fe++;let b=!1;const E=()=>{if(!b)for(b=!0,Fe--;Ue.length&&Fe<Lt.MAX_PARALLEL_IMAGE_REQUESTS;){const k=Ue.shift(),{requestParameters:P,callback:F,cancelled:$}=k;$||(k.cancel=je(P,F).cancel)}},S=re(x,(k,P,F,$)=>{E(),k?d(k):P&&(G.createImageBitmap?function(V,Z){const X=new G.Blob([new Uint8Array(V)],{type:"image/png"});G.createImageBitmap(X).then(W=>{Z(null,W)}).catch(W=>{Z(new Error(`Could not load image because of ${W.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(P,(V,Z)=>d(V,Z,F,$)):function(V,Z){const X=new G.Image,W=G.URL;X.onload=()=>{Z(null,X),W.revokeObjectURL(X.src),X.onload=null,G.requestAnimationFrame(()=>{X.src=Ne})},X.onerror=()=>Z(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const ne=new G.Blob([new Uint8Array(V)],{type:"image/png"});X.src=V.byteLength?W.createObjectURL(ne):Ne}(P,(V,Z)=>d(V,Z,F,$)))});return{cancel:()=>{S.cancel(),E()}}};function tt(x,d,b){b[x]&&b[x].indexOf(d)!==-1||(b[x]=b[x]||[],b[x].push(d))}function pt(x,d,b){if(b&&b[x]){const E=b[x].indexOf(d);E!==-1&&b[x].splice(E,1)}}class st{constructor(d,b={}){pe(this,b),this.type=d}}class Rt extends st{constructor(d,b={}){super("error",pe({error:d},b))}}class gt{on(d,b){return this._listeners=this._listeners||{},tt(d,b,this._listeners),this}off(d,b){return pt(d,b,this._listeners),pt(d,b,this._oneTimeListeners),this}once(d,b){return b?(this._oneTimeListeners=this._oneTimeListeners||{},tt(d,b,this._oneTimeListeners),this):new Promise(E=>this.once(d,E))}fire(d,b){typeof d=="string"&&(d=new st(d,b||{}));const E=d.type;if(this.listens(E)){d.target=this;const S=this._listeners&&this._listeners[E]?this._listeners[E].slice():[];for(const F of S)F.call(this,d);const k=this._oneTimeListeners&&this._oneTimeListeners[E]?this._oneTimeListeners[E].slice():[];for(const F of k)pt(E,F,this._oneTimeListeners),F.call(this,d);const P=this._eventedParent;P&&(pe(d,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),P.fire(d))}else d instanceof Rt&&console.error(d.error);return this}listens(d){return!!(this._listeners&&this._listeners[d]&&this._listeners[d].length>0||this._oneTimeListeners&&this._oneTimeListeners[d]&&this._oneTimeListeners[d].length>0||this._eventedParent&&this._eventedParent.listens(d))}setEventedParent(d,b){return this._eventedParent=d,this._eventedParentData=b,this}}var Ve=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":0.1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class Qe{constructor(d,b,E,S){this.message=(d?`${d}: `:"")+E,S&&(this.identifier=S),b!=null&&b.__line__&&(this.line=b.__line__)}}function gi(x){const d=x.value;return d?[new Qe(x.key,d,"constants have been deprecated as of v8")]:[]}function Ai(x,...d){for(const b of d)for(const E in b)x[E]=b[E];return x}function ri(x){return x instanceof Number||x instanceof String||x instanceof Boolean?x.valueOf():x}function wi(x){if(Array.isArray(x))return x.map(wi);if(x instanceof Object&&!(x instanceof Number||x instanceof String||x instanceof Boolean)){const d={};for(const b in x)d[b]=wi(x[b]);return d}return ri(x)}class Ei extends Error{constructor(d,b){super(b),this.message=b,this.key=d}}class On{constructor(d,b=[]){this.parent=d,this.bindings={};for(const[E,S]of b)this.bindings[E]=S}concat(d){return new On(this,d)}get(d){if(this.bindings[d])return this.bindings[d];if(this.parent)return this.parent.get(d);throw new Error(`${d} not found in scope.`)}has(d){return!!this.bindings[d]||!!this.parent&&this.parent.has(d)}}const hn={kind:"null"},Mt={kind:"number"},bi={kind:"string"},yi={kind:"boolean"},ir={kind:"color"},$n={kind:"object"},xi={kind:"value"},os={kind:"collator"},eo={kind:"formatted"},to={kind:"resolvedImage"};function Vr(x,d){return{kind:"array",itemType:x,N:d}}function Wi(x){if(x.kind==="array"){const d=Wi(x.itemType);return typeof x.N=="number"?`array<${d}, ${x.N}>`:x.itemType.kind==="value"?"array":`array<${d}>`}return x.kind}const cl=[hn,Mt,bi,yi,ir,eo,$n,Vr(xi),to];function vn(x,d){if(d.kind==="error")return null;if(x.kind==="array"){if(d.kind==="array"&&(d.N===0&&d.itemType.kind==="value"||!vn(x.itemType,d.itemType))&&(typeof x.N!="number"||x.N===d.N))return null}else{if(x.kind===d.kind)return null;if(x.kind==="value"){for(const b of cl)if(!vn(b,d))return null}}return`Expected ${Wi(x)} but found ${Wi(d)} instead.`}function la(x,d){return d.some(b=>b.kind===x.kind)}function Qr(x,d){return d.some(b=>b==="null"?x===null:b==="array"?Array.isArray(x):b==="object"?x&&!Array.isArray(x)&&typeof x=="object":b===typeof x)}function ss(x){var d={exports:{}};return x(d,d.exports),d.exports}var en=ss(function(x,d){var b={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function E(F){return(F=Math.round(F))<0?0:F>255?255:F}function S(F){return E(F[F.length-1]==="%"?parseFloat(F)/100*255:parseInt(F))}function k(F){return($=F[F.length-1]==="%"?parseFloat(F)/100:parseFloat(F))<0?0:$>1?1:$;var $}function P(F,$,V){return V<0?V+=1:V>1&&(V-=1),6*V<1?F+($-F)*V*6:2*V<1?$:3*V<2?F+($-F)*(2/3-V)*6:F}try{d.parseCSSColor=function(F){var $,V=F.replace(/ /g,"").toLowerCase();if(V in b)return b[V].slice();if(V[0]==="#")return V.length===4?($=parseInt(V.substr(1),16))>=0&&$<=4095?[(3840&$)>>4|(3840&$)>>8,240&$|(240&$)>>4,15&$|(15&$)<<4,1]:null:V.length===7&&($=parseInt(V.substr(1),16))>=0&&$<=16777215?[(16711680&$)>>16,(65280&$)>>8,255&$,1]:null;var Z=V.indexOf("("),X=V.indexOf(")");if(Z!==-1&&X+1===V.length){var W=V.substr(0,Z),ne=V.substr(Z+1,X-(Z+1)).split(","),ce=1;switch(W){case"rgba":if(ne.length!==4)return null;ce=k(ne.pop());case"rgb":return ne.length!==3?null:[S(ne[0]),S(ne[1]),S(ne[2]),ce];case"hsla":if(ne.length!==4)return null;ce=k(ne.pop());case"hsl":if(ne.length!==3)return null;var ye=(parseFloat(ne[0])%360+360)%360/360,Me=k(ne[1]),Ce=k(ne[2]),ze=Ce<=.5?Ce*(Me+1):Ce+Me-Ce*Me,$e=2*Ce-ze;return[E(255*P($e,ze,ye+1/3)),E(255*P($e,ze,ye)),E(255*P($e,ze,ye-1/3)),ce];default:return null}}return null}}catch{}});class Ci{constructor(d,b,E,S=1){this.r=d,this.g=b,this.b=E,this.a=S}static parse(d){if(!d)return;if(d instanceof Ci)return d;if(typeof d!="string")return;const b=en.parseCSSColor(d);return b?new Ci(b[0]/255*b[3],b[1]/255*b[3],b[2]/255*b[3],b[3]):void 0}toString(){const[d,b,E,S]=this.toArray();return`rgba(${Math.round(d)},${Math.round(b)},${Math.round(E)},${S})`}toArray(){const{r:d,g:b,b:E,a:S}=this;return S===0?[0,0,0,0]:[255*d/S,255*b/S,255*E/S,S]}}Ci.black=new Ci(0,0,0,1),Ci.white=new Ci(1,1,1,1),Ci.transparent=new Ci(0,0,0,0),Ci.red=new Ci(1,0,0,1),Ci.blue=new Ci(0,0,1,1);class as{constructor(d,b,E){this.sensitivity=d?b?"variant":"case":b?"accent":"base",this.locale=E,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(d,b){return this.collator.compare(d,b)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Nn{constructor(d,b,E,S,k){this.text=d,this.image=b,this.scale=E,this.fontStack=S,this.textColor=k}}class Sr{constructor(d){this.sections=d}static fromString(d){return new Sr([new Nn(d,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(d=>d.text.length!==0||d.image&&d.image.name.length!==0)}static factory(d){return d instanceof Sr?d:Sr.fromString(d)}toString(){return this.sections.length===0?"":this.sections.map(d=>d.text).join("")}serialize(){const d=["format"];for(const b of this.sections){if(b.image){d.push(["image",b.image.name]);continue}d.push(b.text);const E={};b.fontStack&&(E["text-font"]=["literal",b.fontStack.split(",")]),b.scale&&(E["font-scale"]=b.scale),b.textColor&&(E["text-color"]=["rgba"].concat(b.textColor.toArray())),d.push(E)}return d}}class Xr{constructor(d){this.name=d.name,this.available=d.available}toString(){return this.name}static fromString(d){return d?new Xr({name:d,available:!1}):null}serialize(){return["image",this.name]}}function ul(x,d,b,E){return typeof x=="number"&&x>=0&&x<=255&&typeof d=="number"&&d>=0&&d<=255&&typeof b=="number"&&b>=0&&b<=255?E===void 0||typeof E=="number"&&E>=0&&E<=1?null:`Invalid rgba value [${[x,d,b,E].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof E=="number"?[x,d,b,E]:[x,d,b]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ls(x){if(x===null||typeof x=="string"||typeof x=="boolean"||typeof x=="number"||x instanceof Ci||x instanceof as||x instanceof Sr||x instanceof Xr)return!0;if(Array.isArray(x)){for(const d of x)if(!ls(d))return!1;return!0}if(typeof x=="object"){for(const d in x)if(!ls(x[d]))return!1;return!0}return!1}function rr(x){if(x===null)return hn;if(typeof x=="string")return bi;if(typeof x=="boolean")return yi;if(typeof x=="number")return Mt;if(x instanceof Ci)return ir;if(x instanceof as)return os;if(x instanceof Sr)return eo;if(x instanceof Xr)return to;if(Array.isArray(x)){const d=x.length;let b;for(const E of x){const S=rr(E);if(b){if(b===S)continue;b=xi;break}b=S}return Vr(b||xi,d)}return $n}function Un(x){const d=typeof x;return x===null?"":d==="string"||d==="number"||d==="boolean"?String(x):x instanceof Ci||x instanceof Sr||x instanceof Xr?x.toString():JSON.stringify(x)}class Vn{constructor(d,b){this.type=d,this.value=b}static parse(d,b){if(d.length!==2)return b.error(`'literal' expression requires exactly one argument, but found ${d.length-1} instead.`);if(!ls(d[1]))return b.error("invalid value");const E=d[1];let S=rr(E);const k=b.expectedType;return S.kind!=="array"||S.N!==0||!k||k.kind!=="array"||typeof k.N=="number"&&k.N!==0||(S=k),new Vn(S,E)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ci?["rgba"].concat(this.value.toArray()):this.value instanceof Sr?this.value.serialize():this.value}}class sr{constructor(d){this.name="ExpressionEvaluationError",this.message=d}toJSON(){return this.message}}const ha={string:bi,number:Mt,boolean:yi,object:$n};class tn{constructor(d,b){this.type=d,this.args=b}static parse(d,b){if(d.length<2)return b.error("Expected at least one argument.");let E,S=1;const k=d[0];if(k==="array"){let F,$;if(d.length>2){const V=d[1];if(typeof V!="string"||!(V in ha)||V==="object")return b.error('The item type argument of "array" must be one of string, number, boolean',1);F=ha[V],S++}else F=xi;if(d.length>3){if(d[2]!==null&&(typeof d[2]!="number"||d[2]<0||d[2]!==Math.floor(d[2])))return b.error('The length argument to "array" must be a positive integer literal',2);$=d[2],S++}E=Vr(F,$)}else E=ha[k];const P=[];for(;S<d.length;S++){const F=b.parse(d[S],S,xi);if(!F)return null;P.push(F)}return new tn(E,P)}evaluate(d){for(let b=0;b<this.args.length;b++){const E=this.args[b].evaluate(d);if(!vn(this.type,rr(E)))return E;if(b===this.args.length-1)throw new sr(`Expected value to be of type ${Wi(this.type)}, but found ${Wi(rr(E))} instead.`)}return null}eachChild(d){this.args.forEach(d)}outputDefined(){return this.args.every(d=>d.outputDefined())}serialize(){const d=this.type,b=[d.kind];if(d.kind==="array"){const E=d.itemType;if(E.kind==="string"||E.kind==="number"||E.kind==="boolean"){b.push(E.kind);const S=d.N;(typeof S=="number"||this.args.length>1)&&b.push(S)}}return b.concat(this.args.map(E=>E.serialize()))}}class Co{constructor(d){this.type=eo,this.sections=d}static parse(d,b){if(d.length<2)return b.error("Expected at least one argument.");const E=d[1];if(!Array.isArray(E)&&typeof E=="object")return b.error("First argument must be an image or text section.");const S=[];let k=!1;for(let P=1;P<=d.length-1;++P){const F=d[P];if(k&&typeof F=="object"&&!Array.isArray(F)){k=!1;let $=null;if(F["font-scale"]&&($=b.parse(F["font-scale"],1,Mt),!$))return null;let V=null;if(F["text-font"]&&(V=b.parse(F["text-font"],1,Vr(bi)),!V))return null;let Z=null;if(F["text-color"]&&(Z=b.parse(F["text-color"],1,ir),!Z))return null;const X=S[S.length-1];X.scale=$,X.font=V,X.textColor=Z}else{const $=b.parse(d[P],1,xi);if(!$)return null;const V=$.type.kind;if(V!=="string"&&V!=="value"&&V!=="null"&&V!=="resolvedImage")return b.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");k=!0,S.push({content:$,scale:null,font:null,textColor:null})}}return new Co(S)}evaluate(d){return new Sr(this.sections.map(b=>{const E=b.content.evaluate(d);return rr(E)===to?new Nn("",E,null,null,null):new Nn(Un(E),null,b.scale?b.scale.evaluate(d):null,b.font?b.font.evaluate(d).join(","):null,b.textColor?b.textColor.evaluate(d):null)}))}eachChild(d){for(const b of this.sections)d(b.content),b.scale&&d(b.scale),b.font&&d(b.font),b.textColor&&d(b.textColor)}outputDefined(){return!1}serialize(){const d=["format"];for(const b of this.sections){d.push(b.content.serialize());const E={};b.scale&&(E["font-scale"]=b.scale.serialize()),b.font&&(E["text-font"]=b.font.serialize()),b.textColor&&(E["text-color"]=b.textColor.serialize()),d.push(E)}return d}}class hs{constructor(d){this.type=to,this.input=d}static parse(d,b){if(d.length!==2)return b.error("Expected two arguments.");const E=b.parse(d[1],1,bi);return E?new hs(E):b.error("No image name provided.")}evaluate(d){const b=this.input.evaluate(d),E=Xr.fromString(b);return E&&d.availableImages&&(E.available=d.availableImages.indexOf(b)>-1),E}eachChild(d){d(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const Bh={"to-boolean":yi,"to-color":ir,"to-number":Mt,"to-string":bi};class bn{constructor(d,b){this.type=d,this.args=b}static parse(d,b){if(d.length<2)return b.error("Expected at least one argument.");const E=d[0];if((E==="to-boolean"||E==="to-string")&&d.length!==2)return b.error("Expected one argument.");const S=Bh[E],k=[];for(let P=1;P<d.length;P++){const F=b.parse(d[P],P,xi);if(!F)return null;k.push(F)}return new bn(S,k)}evaluate(d){if(this.type.kind==="boolean")return Boolean(this.args[0].evaluate(d));if(this.type.kind==="color"){let b,E;for(const S of this.args){if(b=S.evaluate(d),E=null,b instanceof Ci)return b;if(typeof b=="string"){const k=d.parseColor(b);if(k)return k}else if(Array.isArray(b)&&(E=b.length<3||b.length>4?`Invalid rbga value ${JSON.stringify(b)}: expected an array containing either three or four numeric values.`:ul(b[0],b[1],b[2],b[3]),!E))return new Ci(b[0]/255,b[1]/255,b[2]/255,b[3])}throw new sr(E||`Could not parse color from value '${typeof b=="string"?b:String(JSON.stringify(b))}'`)}if(this.type.kind==="number"){let b=null;for(const E of this.args){if(b=E.evaluate(d),b===null)return 0;const S=Number(b);if(!isNaN(S))return S}throw new sr(`Could not convert ${JSON.stringify(b)} to number.`)}return this.type.kind==="formatted"?Sr.fromString(Un(this.args[0].evaluate(d))):this.type.kind==="resolvedImage"?Xr.fromString(Un(this.args[0].evaluate(d))):Un(this.args[0].evaluate(d))}eachChild(d){this.args.forEach(d)}outputDefined(){return this.args.every(d=>d.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Co([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new hs(this.args[0]).serialize();const d=[`to-${this.type.kind}`];return this.eachChild(b=>{d.push(b.serialize())}),d}}const Lh=["Unknown","Point","LineString","Polygon"];class ca{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Lh[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const d=this.featureDistanceData.center,b=this.featureDistanceData.scale,{x:E,y:S}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(E*b-d[0])+this.featureDistanceData.bearing[1]*(S*b-d[1])}return 0}parseColor(d){let b=this._parseColorCache[d];return b||(b=this._parseColorCache[d]=Ci.parse(d)),b}}class Ar{constructor(d,b,E,S){this.name=d,this.type=b,this._evaluate=E,this.args=S}evaluate(d){return this._evaluate(d,this.args)}eachChild(d){this.args.forEach(d)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(d=>d.serialize()))}static parse(d,b){const E=d[0],S=Ar.definitions[E];if(!S)return b.error(`Unknown expression "${E}". If you wanted a literal array, use ["literal", [...]].`,0);const k=Array.isArray(S)?S[0]:S.type,P=Array.isArray(S)?[[S[1],S[2]]]:S.overloads,F=P.filter(([V])=>!Array.isArray(V)||V.length===d.length-1);let $=null;for(const[V,Z]of F){$=new gs(b.registry,b.path,null,b.scope);const X=[];let W=!1;for(let ne=1;ne<d.length;ne++){const ce=d[ne],ye=Array.isArray(V)?V[ne-1]:V.type,Me=$.parse(ce,1+X.length,ye);if(!Me){W=!0;break}X.push(Me)}if(!W)if(Array.isArray(V)&&V.length!==X.length)$.error(`Expected ${V.length} arguments, but found ${X.length} instead.`);else{for(let ne=0;ne<X.length;ne++){const ce=Array.isArray(V)?V[ne]:V.type,ye=X[ne];$.concat(ne+1).checkSubtype(ce,ye.type)}if($.errors.length===0)return new Ar(E,k,Z,X)}}if(F.length===1)b.errors.push(...$.errors);else{const V=(F.length?F:P).map(([X])=>{return W=X,Array.isArray(W)?`(${W.map(Wi).join(", ")})`:`(${Wi(W.type)}...)`;var W}).join(" | "),Z=[];for(let X=1;X<d.length;X++){const W=b.parse(d[X],1+Z.length);if(!W)return null;Z.push(Wi(W.type))}b.error(`Expected arguments of type ${V}, but found (${Z.join(", ")}) instead.`)}return null}static register(d,b){Ar.definitions=b;for(const E in b)d[E]=Ar}}class cs{constructor(d,b,E){this.type=os,this.locale=E,this.caseSensitive=d,this.diacriticSensitive=b}static parse(d,b){if(d.length!==2)return b.error("Expected one argument.");const E=d[1];if(typeof E!="object"||Array.isArray(E))return b.error("Collator options argument must be an object.");const S=b.parse(E["case-sensitive"]!==void 0&&E["case-sensitive"],1,yi);if(!S)return null;const k=b.parse(E["diacritic-sensitive"]!==void 0&&E["diacritic-sensitive"],1,yi);if(!k)return null;let P=null;return E.locale&&(P=b.parse(E.locale,1,bi),!P)?null:new cs(S,k,P)}evaluate(d){return new as(this.caseSensitive.evaluate(d),this.diacriticSensitive.evaluate(d),this.locale?this.locale.evaluate(d):null)}eachChild(d){d(this.caseSensitive),d(this.diacriticSensitive),this.locale&&d(this.locale)}outputDefined(){return!1}serialize(){const d={};return d["case-sensitive"]=this.caseSensitive.serialize(),d["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(d.locale=this.locale.serialize()),["collator",d]}}const wn=8192;function ua(x,d){x[0]=Math.min(x[0],d[0]),x[1]=Math.min(x[1],d[1]),x[2]=Math.max(x[2],d[0]),x[3]=Math.max(x[3],d[1])}function us(x,d){return!(x[0]<=d[0]||x[2]>=d[2]||x[1]<=d[1]||x[3]>=d[3])}function zh(x,d){const b=(180+x[0])/360,E=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+x[1]*Math.PI/360)))/360,S=Math.pow(2,d.z);return[Math.round(b*S*wn),Math.round(E*S*wn)]}function Fh(x,d,b){const E=x[0]-d[0],S=x[1]-d[1],k=x[0]-b[0],P=x[1]-b[1];return E*P-k*S==0&&E*k<=0&&S*P<=0}function ds(x,d){let b=!1;for(let P=0,F=d.length;P<F;P++){const $=d[P];for(let V=0,Z=$.length;V<Z-1;V++){if(Fh(x,$[V],$[V+1]))return!1;(S=$[V])[1]>(E=x)[1]!=(k=$[V+1])[1]>E[1]&&E[0]<(k[0]-S[0])*(E[1]-S[1])/(k[1]-S[1])+S[0]&&(b=!b)}}var E,S,k;return b}function fs(x,d){for(let b=0;b<d.length;b++)if(ds(x,d[b]))return!0;return!1}function dl(x,d,b,E){const S=E[0]-b[0],k=E[1]-b[1],P=(x[0]-b[0])*k-S*(x[1]-b[1]),F=(d[0]-b[0])*k-S*(d[1]-b[1]);return P>0&&F<0||P<0&&F>0}function Oh(x,d,b){for(const V of b)for(let Z=0;Z<V.length-1;++Z)if((F=[(P=V[Z+1])[0]-(k=V[Z])[0],P[1]-k[1]])[0]*($=[(S=d)[0]-(E=x)[0],S[1]-E[1]])[1]-F[1]*$[0]!=0&&dl(E,S,k,P)&&dl(k,P,E,S))return!0;var E,S,k,P,F,$;return!1}function fl(x,d){for(let b=0;b<x.length;++b)if(!ds(x[b],d))return!1;for(let b=0;b<x.length-1;++b)if(Oh(x[b],x[b+1],d))return!1;return!0}function $h(x,d){for(let b=0;b<d.length;b++)if(fl(x,d[b]))return!0;return!1}function Yr(x,d,b){const E=[];for(let S=0;S<x.length;S++){const k=[];for(let P=0;P<x[S].length;P++){const F=zh(x[S][P],b);ua(d,F),k.push(F)}E.push(k)}return E}function da(x,d,b){const E=[];for(let S=0;S<x.length;S++){const k=Yr(x[S],d,b);E.push(k)}return E}function fa(x,d,b,E){if(x[0]<b[0]||x[0]>b[2]){const S=.5*E;let k=x[0]-b[0]>S?-E:b[0]-x[0]>S?E:0;k===0&&(k=x[0]-b[2]>S?-E:b[2]-x[0]>S?E:0),x[0]+=k}ua(d,x)}function Do(x,d,b,E){const S=Math.pow(2,E.z)*wn,k=[E.x*wn,E.y*wn],P=[];for(const F of x)for(const $ of F){const V=[$.x+k[0],$.y+k[1]];fa(V,d,b,S),P.push(V)}return P}function io(x,d,b,E){const S=Math.pow(2,E.z)*wn,k=[E.x*wn,E.y*wn],P=[];for(const $ of x){const V=[];for(const Z of $){const X=[Z.x+k[0],Z.y+k[1]];ua(d,X),V.push(X)}P.push(V)}if(d[2]-d[0]<=S/2){(F=d)[0]=F[1]=1/0,F[2]=F[3]=-1/0;for(const $ of P)for(const V of $)fa(V,d,b,S)}var F;return P}class En{constructor(d,b){this.type=yi,this.geojson=d,this.geometries=b}static parse(d,b){if(d.length!==2)return b.error(`'within' expression requires exactly one argument, but found ${d.length-1} instead.`);if(ls(d[1])){const E=d[1];if(E.type==="FeatureCollection")for(let S=0;S<E.features.length;++S){const k=E.features[S].geometry.type;if(k==="Polygon"||k==="MultiPolygon")return new En(E,E.features[S].geometry)}else if(E.type==="Feature"){const S=E.geometry.type;if(S==="Polygon"||S==="MultiPolygon")return new En(E,E.geometry)}else if(E.type==="Polygon"||E.type==="MultiPolygon")return new En(E,E)}return b.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(d){if(d.geometry()!=null&&d.canonicalID()!=null){if(d.geometryType()==="Point")return function(b,E){const S=[1/0,1/0,-1/0,-1/0],k=[1/0,1/0,-1/0,-1/0],P=b.canonicalID();if(E.type==="Polygon"){const F=Yr(E.coordinates,k,P),$=Do(b.geometry(),S,k,P);if(!us(S,k))return!1;for(const V of $)if(!ds(V,F))return!1}if(E.type==="MultiPolygon"){const F=da(E.coordinates,k,P),$=Do(b.geometry(),S,k,P);if(!us(S,k))return!1;for(const V of $)if(!fs(V,F))return!1}return!0}(d,this.geometries);if(d.geometryType()==="LineString")return function(b,E){const S=[1/0,1/0,-1/0,-1/0],k=[1/0,1/0,-1/0,-1/0],P=b.canonicalID();if(E.type==="Polygon"){const F=Yr(E.coordinates,k,P),$=io(b.geometry(),S,k,P);if(!us(S,k))return!1;for(const V of $)if(!fl(V,F))return!1}if(E.type==="MultiPolygon"){const F=da(E.coordinates,k,P),$=io(b.geometry(),S,k,P);if(!us(S,k))return!1;for(const V of $)if(!$h(V,F))return!1}return!0}(d,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}function ro(x){if(x instanceof Ar&&(x.name==="get"&&x.args.length===1||x.name==="feature-state"||x.name==="has"&&x.args.length===1||x.name==="properties"||x.name==="geometry-type"||x.name==="id"||/^filter-/.test(x.name))||x instanceof En)return!1;let d=!0;return x.eachChild(b=>{d&&!ro(b)&&(d=!1)}),d}function ps(x){if(x instanceof Ar&&x.name==="feature-state")return!1;let d=!0;return x.eachChild(b=>{d&&!ps(b)&&(d=!1)}),d}function Si(x,d){if(x instanceof Ar&&d.indexOf(x.name)>=0)return!1;let b=!0;return x.eachChild(E=>{b&&!Si(E,d)&&(b=!1)}),b}class ms{constructor(d,b){this.type=b.type,this.name=d,this.boundExpression=b}static parse(d,b){if(d.length!==2||typeof d[1]!="string")return b.error("'var' expression requires exactly one string literal argument.");const E=d[1];return b.scope.has(E)?new ms(E,b.scope.get(E)):b.error(`Unknown variable "${E}". Make sure "${E}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(d){return this.boundExpression.evaluate(d)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class gs{constructor(d,b=[],E,S=new On,k=[]){this.registry=d,this.path=b,this.key=b.map(P=>`[${P}]`).join(""),this.scope=S,this.errors=k,this.expectedType=E}parse(d,b,E,S,k={}){return b?this.concat(b,E,S)._parse(d,k):this._parse(d,k)}_parse(d,b){function E(S,k,P){return P==="assert"?new tn(k,[S]):P==="coerce"?new bn(k,[S]):S}if(d!==null&&typeof d!="string"&&typeof d!="boolean"&&typeof d!="number"||(d=["literal",d]),Array.isArray(d)){if(d.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const S=d[0];if(typeof S!="string")return this.error(`Expression name must be a string, but found ${typeof S} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const k=this.registry[S];if(k){let P=k.parse(d,this);if(!P)return null;if(this.expectedType){const F=this.expectedType,$=P.type;if(F.kind!=="string"&&F.kind!=="number"&&F.kind!=="boolean"&&F.kind!=="object"&&F.kind!=="array"||$.kind!=="value")if(F.kind!=="color"&&F.kind!=="formatted"&&F.kind!=="resolvedImage"||$.kind!=="value"&&$.kind!=="string"){if(this.checkSubtype(F,$))return null}else P=E(P,F,b.typeAnnotation||"coerce");else P=E(P,F,b.typeAnnotation||"assert")}if(!(P instanceof Vn)&&P.type.kind!=="resolvedImage"&&pa(P)){const F=new ca;try{P=new Vn(P.type,P.evaluate(F))}catch($){return this.error($.message),null}}return P}return this.error(`Unknown expression "${S}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(d===void 0?"'undefined' value invalid. Use null instead.":typeof d=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof d} instead.`)}concat(d,b,E){const S=typeof d=="number"?this.path.concat(d):this.path,k=E?this.scope.concat(E):this.scope;return new gs(this.registry,S,b||null,k,this.errors)}error(d,...b){const E=`${this.key}${b.map(S=>`[${S}]`).join("")}`;this.errors.push(new Ei(E,d))}checkSubtype(d,b){const E=vn(d,b);return E&&this.error(E),E}}function pa(x){if(x instanceof ms)return pa(x.boundExpression);if(x instanceof Ar&&x.name==="error"||x instanceof cs||x instanceof En)return!1;const d=x instanceof bn||x instanceof tn;let b=!0;return x.eachChild(E=>{b=d?b&&pa(E):b&&E instanceof Vn}),!!b&&ro(x)&&Si(x,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function Po(x,d){const b=x.length-1;let E,S,k=0,P=b,F=0;for(;k<=P;)if(F=Math.floor((k+P)/2),E=x[F],S=x[F+1],E<=d){if(F===b||d<S)return F;k=F+1}else{if(!(E>d))throw new sr("Input is not a number.");P=F-1}return 0}class Ro{constructor(d,b,E){this.type=d,this.input=b,this.labels=[],this.outputs=[];for(const[S,k]of E)this.labels.push(S),this.outputs.push(k)}static parse(d,b){if(d.length-1<4)return b.error(`Expected at least 4 arguments, but found only ${d.length-1}.`);if((d.length-1)%2!=0)return b.error("Expected an even number of arguments.");const E=b.parse(d[1],1,Mt);if(!E)return null;const S=[];let k=null;b.expectedType&&b.expectedType.kind!=="value"&&(k=b.expectedType);for(let P=1;P<d.length;P+=2){const F=P===1?-1/0:d[P],$=d[P+1],V=P,Z=P+1;if(typeof F!="number")return b.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',V);if(S.length&&S[S.length-1][0]>=F)return b.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',V);const X=b.parse($,Z,k);if(!X)return null;k=k||X.type,S.push([F,X])}return new Ro(k,E,S)}evaluate(d){const b=this.labels,E=this.outputs;if(b.length===1)return E[0].evaluate(d);const S=this.input.evaluate(d);if(S<=b[0])return E[0].evaluate(d);const k=b.length;return S>=b[k-1]?E[k-1].evaluate(d):E[Po(b,S)].evaluate(d)}eachChild(d){d(this.input);for(const b of this.outputs)d(b)}outputDefined(){return this.outputs.every(d=>d.outputDefined())}serialize(){const d=["step",this.input.serialize()];for(let b=0;b<this.labels.length;b++)b>0&&d.push(this.labels[b]),d.push(this.outputs[b].serialize());return d}}function Pi(x,d,b){return x*(1-b)+d*b}var Bo=Object.freeze({__proto__:null,number:Pi,color:function(x,d,b){return new Ci(Pi(x.r,d.r,b),Pi(x.g,d.g,b),Pi(x.b,d.b,b),Pi(x.a,d.a,b))},array:function(x,d,b){return x.map((E,S)=>Pi(E,d[S],b))}});const _s=.95047,ma=1.08883,pl=4/29,Lo=6/29,ga=3*Lo*Lo,Nh=Math.PI/180,ml=180/Math.PI;function _a(x){return x>.008856451679035631?Math.pow(x,1/3):x/ga+pl}function ys(x){return x>Lo?x*x*x:ga*(x-pl)}function xs(x){return 255*(x<=.0031308?12.92*x:1.055*Math.pow(x,1/2.4)-.055)}function vs(x){return(x/=255)<=.04045?x/12.92:Math.pow((x+.055)/1.055,2.4)}function ya(x){const d=vs(x.r),b=vs(x.g),E=vs(x.b),S=_a((.4124564*d+.3575761*b+.1804375*E)/_s),k=_a((.2126729*d+.7151522*b+.072175*E)/1);return{l:116*k-16,a:500*(S-k),b:200*(k-_a((.0193339*d+.119192*b+.9503041*E)/ma)),alpha:x.a}}function gl(x){let d=(x.l+16)/116,b=isNaN(x.a)?d:d+x.a/500,E=isNaN(x.b)?d:d-x.b/200;return d=1*ys(d),b=_s*ys(b),E=ma*ys(E),new Ci(xs(3.2404542*b-1.5371385*d-.4985314*E),xs(-.969266*b+1.8760108*d+.041556*E),xs(.0556434*b-.2040259*d+1.0572252*E),x.alpha)}function _l(x,d,b){const E=d-x;return x+b*(E>180||E<-180?E-360*Math.round(E/360):E)}const no={forward:ya,reverse:gl,interpolate:function(x,d,b){return{l:Pi(x.l,d.l,b),a:Pi(x.a,d.a,b),b:Pi(x.b,d.b,b),alpha:Pi(x.alpha,d.alpha,b)}}},zo={forward:function(x){const{l:d,a:b,b:E}=ya(x),S=Math.atan2(E,b)*ml;return{h:S<0?S+360:S,c:Math.sqrt(b*b+E*E),l:d,alpha:x.a}},reverse:function(x){const d=x.h*Nh,b=x.c;return gl({l:x.l,a:Math.cos(d)*b,b:Math.sin(d)*b,alpha:x.alpha})},interpolate:function(x,d,b){return{h:_l(x.h,d.h,b),c:Pi(x.c,d.c,b),l:Pi(x.l,d.l,b),alpha:Pi(x.alpha,d.alpha,b)}}};var yl=Object.freeze({__proto__:null,lab:no,hcl:zo});class jr{constructor(d,b,E,S,k){this.type=d,this.operator=b,this.interpolation=E,this.input=S,this.labels=[],this.outputs=[];for(const[P,F]of k)this.labels.push(P),this.outputs.push(F)}static interpolationFactor(d,b,E,S){let k=0;if(d.name==="exponential")k=xa(b,d.base,E,S);else if(d.name==="linear")k=xa(b,1,E,S);else if(d.name==="cubic-bezier"){const P=d.controlPoints;k=new D(P[0],P[1],P[2],P[3]).solve(xa(b,1,E,S))}return k}static parse(d,b){let[E,S,k,...P]=d;if(!Array.isArray(S)||S.length===0)return b.error("Expected an interpolation type expression.",1);if(S[0]==="linear")S={name:"linear"};else if(S[0]==="exponential"){const V=S[1];if(typeof V!="number")return b.error("Exponential interpolation requires a numeric base.",1,1);S={name:"exponential",base:V}}else{if(S[0]!=="cubic-bezier")return b.error(`Unknown interpolation type ${String(S[0])}`,1,0);{const V=S.slice(1);if(V.length!==4||V.some(Z=>typeof Z!="number"||Z<0||Z>1))return b.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);S={name:"cubic-bezier",controlPoints:V}}}if(d.length-1<4)return b.error(`Expected at least 4 arguments, but found only ${d.length-1}.`);if((d.length-1)%2!=0)return b.error("Expected an even number of arguments.");if(k=b.parse(k,2,Mt),!k)return null;const F=[];let $=null;E==="interpolate-hcl"||E==="interpolate-lab"?$=ir:b.expectedType&&b.expectedType.kind!=="value"&&($=b.expectedType);for(let V=0;V<P.length;V+=2){const Z=P[V],X=P[V+1],W=V+3,ne=V+4;if(typeof Z!="number")return b.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',W);if(F.length&&F[F.length-1][0]>=Z)return b.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',W);const ce=b.parse(X,ne,$);if(!ce)return null;$=$||ce.type,F.push([Z,ce])}return $.kind==="number"||$.kind==="color"||$.kind==="array"&&$.itemType.kind==="number"&&typeof $.N=="number"?new jr($,E,S,k,F):b.error(`Type ${Wi($)} is not interpolatable.`)}evaluate(d){const b=this.labels,E=this.outputs;if(b.length===1)return E[0].evaluate(d);const S=this.input.evaluate(d);if(S<=b[0])return E[0].evaluate(d);const k=b.length;if(S>=b[k-1])return E[k-1].evaluate(d);const P=Po(b,S),F=jr.interpolationFactor(this.interpolation,S,b[P],b[P+1]),$=E[P].evaluate(d),V=E[P+1].evaluate(d);return this.operator==="interpolate"?Bo[this.type.kind.toLowerCase()]($,V,F):this.operator==="interpolate-hcl"?zo.reverse(zo.interpolate(zo.forward($),zo.forward(V),F)):no.reverse(no.interpolate(no.forward($),no.forward(V),F))}eachChild(d){d(this.input);for(const b of this.outputs)d(b)}outputDefined(){return this.outputs.every(d=>d.outputDefined())}serialize(){let d;d=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const b=[this.operator,d,this.input.serialize()];for(let E=0;E<this.labels.length;E++)b.push(this.labels[E],this.outputs[E].serialize());return b}}function xa(x,d,b,E){const S=E-b,k=x-b;return S===0?0:d===1?k/S:(Math.pow(d,k)-1)/(Math.pow(d,S)-1)}class bs{constructor(d,b){this.type=d,this.args=b}static parse(d,b){if(d.length<2)return b.error("Expectected at least one argument.");let E=null;const S=b.expectedType;S&&S.kind!=="value"&&(E=S);const k=[];for(const F of d.slice(1)){const $=b.parse(F,1+k.length,E,void 0,{typeAnnotation:"omit"});if(!$)return null;E=E||$.type,k.push($)}const P=S&&k.some(F=>vn(S,F.type));return new bs(P?xi:E,k)}evaluate(d){let b,E=null,S=0;for(const k of this.args)if(S++,E=k.evaluate(d),E&&E instanceof Xr&&!E.available&&(b||(b=E.name),E=null,S===this.args.length&&(E=b)),E!==null)break;return E}eachChild(d){this.args.forEach(d)}outputDefined(){return this.args.every(d=>d.outputDefined())}serialize(){const d=["coalesce"];return this.eachChild(b=>{d.push(b.serialize())}),d}}class Fo{constructor(d,b){this.type=b.type,this.bindings=[].concat(d),this.result=b}evaluate(d){return this.result.evaluate(d)}eachChild(d){for(const b of this.bindings)d(b[1]);d(this.result)}static parse(d,b){if(d.length<4)return b.error(`Expected at least 3 arguments, but found ${d.length-1} instead.`);const E=[];for(let k=1;k<d.length-1;k+=2){const P=d[k];if(typeof P!="string")return b.error(`Expected string, but found ${typeof P} instead.`,k);if(/[^a-zA-Z0-9_]/.test(P))return b.error("Variable names must contain only alphanumeric characters or '_'.",k);const F=b.parse(d[k+1],k+1);if(!F)return null;E.push([P,F])}const S=b.parse(d[d.length-1],d.length-1,b.expectedType,E);return S?new Fo(E,S):null}outputDefined(){return this.result.outputDefined()}serialize(){const d=["let"];for(const[b,E]of this.bindings)d.push(b,E.serialize());return d.push(this.result.serialize()),d}}class va{constructor(d,b,E){this.type=d,this.index=b,this.input=E}static parse(d,b){if(d.length!==3)return b.error(`Expected 2 arguments, but found ${d.length-1} instead.`);const E=b.parse(d[1],1,Mt),S=b.parse(d[2],2,Vr(b.expectedType||xi));return E&&S?new va(S.type.itemType,E,S):null}evaluate(d){const b=this.index.evaluate(d),E=this.input.evaluate(d);if(b<0)throw new sr(`Array index out of bounds: ${b} < 0.`);if(b>=E.length)throw new sr(`Array index out of bounds: ${b} > ${E.length-1}.`);if(b!==Math.floor(b))throw new sr(`Array index must be an integer, but found ${b} instead.`);return E[b]}eachChild(d){d(this.index),d(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class ba{constructor(d,b){this.type=yi,this.needle=d,this.haystack=b}static parse(d,b){if(d.length!==3)return b.error(`Expected 2 arguments, but found ${d.length-1} instead.`);const E=b.parse(d[1],1,xi),S=b.parse(d[2],2,xi);return E&&S?la(E.type,[yi,bi,Mt,hn,xi])?new ba(E,S):b.error(`Expected first argument to be of type boolean, string, number or null, but found ${Wi(E.type)} instead`):null}evaluate(d){const b=this.needle.evaluate(d),E=this.haystack.evaluate(d);if(!E)return!1;if(!Qr(b,["boolean","string","number","null"]))throw new sr(`Expected first argument to be of type boolean, string, number or null, but found ${Wi(rr(b))} instead.`);if(!Qr(E,["string","array"]))throw new sr(`Expected second argument to be of type array or string, but found ${Wi(rr(E))} instead.`);return E.indexOf(b)>=0}eachChild(d){d(this.needle),d(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class ws{constructor(d,b,E){this.type=Mt,this.needle=d,this.haystack=b,this.fromIndex=E}static parse(d,b){if(d.length<=2||d.length>=5)return b.error(`Expected 3 or 4 arguments, but found ${d.length-1} instead.`);const E=b.parse(d[1],1,xi),S=b.parse(d[2],2,xi);if(!E||!S)return null;if(!la(E.type,[yi,bi,Mt,hn,xi]))return b.error(`Expected first argument to be of type boolean, string, number or null, but found ${Wi(E.type)} instead`);if(d.length===4){const k=b.parse(d[3],3,Mt);return k?new ws(E,S,k):null}return new ws(E,S)}evaluate(d){const b=this.needle.evaluate(d),E=this.haystack.evaluate(d);if(!Qr(b,["boolean","string","number","null"]))throw new sr(`Expected first argument to be of type boolean, string, number or null, but found ${Wi(rr(b))} instead.`);if(!Qr(E,["string","array"]))throw new sr(`Expected second argument to be of type array or string, but found ${Wi(rr(E))} instead.`);if(this.fromIndex){const S=this.fromIndex.evaluate(d);return E.indexOf(b,S)}return E.indexOf(b)}eachChild(d){d(this.needle),d(this.haystack),this.fromIndex&&d(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const d=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),d]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Es{constructor(d,b,E,S,k,P){this.inputType=d,this.type=b,this.input=E,this.cases=S,this.outputs=k,this.otherwise=P}static parse(d,b){if(d.length<5)return b.error(`Expected at least 4 arguments, but found only ${d.length-1}.`);if(d.length%2!=1)return b.error("Expected an even number of arguments.");let E,S;b.expectedType&&b.expectedType.kind!=="value"&&(S=b.expectedType);const k={},P=[];for(let V=2;V<d.length-1;V+=2){let Z=d[V];const X=d[V+1];Array.isArray(Z)||(Z=[Z]);const W=b.concat(V);if(Z.length===0)return W.error("Expected at least one branch label.");for(const ce of Z){if(typeof ce!="number"&&typeof ce!="string")return W.error("Branch labels must be numbers or strings.");if(typeof ce=="number"&&Math.abs(ce)>Number.MAX_SAFE_INTEGER)return W.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof ce=="number"&&Math.floor(ce)!==ce)return W.error("Numeric branch labels must be integer values.");if(E){if(W.checkSubtype(E,rr(ce)))return null}else E=rr(ce);if(k[String(ce)]!==void 0)return W.error("Branch labels must be unique.");k[String(ce)]=P.length}const ne=b.parse(X,V,S);if(!ne)return null;S=S||ne.type,P.push(ne)}const F=b.parse(d[1],1,xi);if(!F)return null;const $=b.parse(d[d.length-1],d.length-1,S);return $?F.type.kind!=="value"&&b.concat(1).checkSubtype(E,F.type)?null:new Es(E,S,F,k,P,$):null}evaluate(d){const b=this.input.evaluate(d);return(rr(b)===this.inputType&&this.outputs[this.cases[b]]||this.otherwise).evaluate(d)}eachChild(d){d(this.input),this.outputs.forEach(d),d(this.otherwise)}outputDefined(){return this.outputs.every(d=>d.outputDefined())&&this.otherwise.outputDefined()}serialize(){const d=["match",this.input.serialize()],b=Object.keys(this.cases).sort(),E=[],S={};for(const P of b){const F=S[this.cases[P]];F===void 0?(S[this.cases[P]]=E.length,E.push([this.cases[P],[P]])):E[F][1].push(P)}const k=P=>this.inputType.kind==="number"?Number(P):P;for(const[P,F]of E)d.push(F.length===1?k(F[0]):F.map(k)),d.push(this.outputs[P].serialize());return d.push(this.otherwise.serialize()),d}}class Ts{constructor(d,b,E){this.type=d,this.branches=b,this.otherwise=E}static parse(d,b){if(d.length<4)return b.error(`Expected at least 3 arguments, but found only ${d.length-1}.`);if(d.length%2!=0)return b.error("Expected an odd number of arguments.");let E;b.expectedType&&b.expectedType.kind!=="value"&&(E=b.expectedType);const S=[];for(let P=1;P<d.length-1;P+=2){const F=b.parse(d[P],P,yi);if(!F)return null;const $=b.parse(d[P+1],P+1,E);if(!$)return null;S.push([F,$]),E=E||$.type}const k=b.parse(d[d.length-1],d.length-1,E);return k?new Ts(E,S,k):null}evaluate(d){for(const[b,E]of this.branches)if(b.evaluate(d))return E.evaluate(d);return this.otherwise.evaluate(d)}eachChild(d){for(const[b,E]of this.branches)d(b),d(E);d(this.otherwise)}outputDefined(){return this.branches.every(([d,b])=>b.outputDefined())&&this.otherwise.outputDefined()}serialize(){const d=["case"];return this.eachChild(b=>{d.push(b.serialize())}),d}}class Ms{constructor(d,b,E,S){this.type=d,this.input=b,this.beginIndex=E,this.endIndex=S}static parse(d,b){if(d.length<=2||d.length>=5)return b.error(`Expected 3 or 4 arguments, but found ${d.length-1} instead.`);const E=b.parse(d[1],1,xi),S=b.parse(d[2],2,Mt);if(!E||!S)return null;if(!la(E.type,[Vr(xi),bi,xi]))return b.error(`Expected first argument to be of type array or string, but found ${Wi(E.type)} instead`);if(d.length===4){const k=b.parse(d[3],3,Mt);return k?new Ms(E.type,E,S,k):null}return new Ms(E.type,E,S)}evaluate(d){const b=this.input.evaluate(d),E=this.beginIndex.evaluate(d);if(!Qr(b,["string","array"]))throw new sr(`Expected first argument to be of type array or string, but found ${Wi(rr(b))} instead.`);if(this.endIndex){const S=this.endIndex.evaluate(d);return b.slice(E,S)}return b.slice(E)}eachChild(d){d(this.input),d(this.beginIndex),this.endIndex&&d(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const d=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),d]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function wa(x,d){return x==="=="||x==="!="?d.kind==="boolean"||d.kind==="string"||d.kind==="number"||d.kind==="null"||d.kind==="value":d.kind==="string"||d.kind==="number"||d.kind==="value"}function xl(x,d,b,E){return E.compare(d,b)===0}function oo(x,d,b){const E=x!=="=="&&x!=="!=";return class Kd{constructor(k,P,F){this.type=yi,this.lhs=k,this.rhs=P,this.collator=F,this.hasUntypedArgument=k.type.kind==="value"||P.type.kind==="value"}static parse(k,P){if(k.length!==3&&k.length!==4)return P.error("Expected two or three arguments.");const F=k[0];let $=P.parse(k[1],1,xi);if(!$)return null;if(!wa(F,$.type))return P.concat(1).error(`"${F}" comparisons are not supported for type '${Wi($.type)}'.`);let V=P.parse(k[2],2,xi);if(!V)return null;if(!wa(F,V.type))return P.concat(2).error(`"${F}" comparisons are not supported for type '${Wi(V.type)}'.`);if($.type.kind!==V.type.kind&&$.type.kind!=="value"&&V.type.kind!=="value")return P.error(`Cannot compare types '${Wi($.type)}' and '${Wi(V.type)}'.`);E&&($.type.kind==="value"&&V.type.kind!=="value"?$=new tn(V.type,[$]):$.type.kind!=="value"&&V.type.kind==="value"&&(V=new tn($.type,[V])));let Z=null;if(k.length===4){if($.type.kind!=="string"&&V.type.kind!=="string"&&$.type.kind!=="value"&&V.type.kind!=="value")return P.error("Cannot use collator to compare non-string types.");if(Z=P.parse(k[3],3,os),!Z)return null}return new Kd($,V,Z)}evaluate(k){const P=this.lhs.evaluate(k),F=this.rhs.evaluate(k);if(E&&this.hasUntypedArgument){const $=rr(P),V=rr(F);if($.kind!==V.kind||$.kind!=="string"&&$.kind!=="number")throw new sr(`Expected arguments for "${x}" to be (string, string) or (number, number), but found (${$.kind}, ${V.kind}) instead.`)}if(this.collator&&!E&&this.hasUntypedArgument){const $=rr(P),V=rr(F);if($.kind!=="string"||V.kind!=="string")return d(k,P,F)}return this.collator?b(k,P,F,this.collator.evaluate(k)):d(k,P,F)}eachChild(k){k(this.lhs),k(this.rhs),this.collator&&k(this.collator)}outputDefined(){return!0}serialize(){const k=[x];return this.eachChild(P=>{k.push(P.serialize())}),k}}}const vl=oo("==",function(x,d,b){return d===b},xl),bl=oo("!=",function(x,d,b){return d!==b},function(x,d,b,E){return!xl(0,d,b,E)}),Uh=oo("<",function(x,d,b){return d<b},function(x,d,b,E){return E.compare(d,b)<0}),Vh=oo(">",function(x,d,b){return d>b},function(x,d,b,E){return E.compare(d,b)>0}),jh=oo("<=",function(x,d,b){return d<=b},function(x,d,b,E){return E.compare(d,b)<=0}),Gh=oo(">=",function(x,d,b){return d>=b},function(x,d,b,E){return E.compare(d,b)>=0});class so{constructor(d,b,E,S,k){this.type=bi,this.number=d,this.locale=b,this.currency=E,this.minFractionDigits=S,this.maxFractionDigits=k}static parse(d,b){if(d.length!==3)return b.error("Expected two arguments.");const E=b.parse(d[1],1,Mt);if(!E)return null;const S=d[2];if(typeof S!="object"||Array.isArray(S))return b.error("NumberFormat options argument must be an object.");let k=null;if(S.locale&&(k=b.parse(S.locale,1,bi),!k))return null;let P=null;if(S.currency&&(P=b.parse(S.currency,1,bi),!P))return null;let F=null;if(S["min-fraction-digits"]&&(F=b.parse(S["min-fraction-digits"],1,Mt),!F))return null;let $=null;return S["max-fraction-digits"]&&($=b.parse(S["max-fraction-digits"],1,Mt),!$)?null:new so(E,k,P,F,$)}evaluate(d){return new Intl.NumberFormat(this.locale?this.locale.evaluate(d):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(d):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(d):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(d):void 0}).format(this.number.evaluate(d))}eachChild(d){d(this.number),this.locale&&d(this.locale),this.currency&&d(this.currency),this.minFractionDigits&&d(this.minFractionDigits),this.maxFractionDigits&&d(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const d={};return this.locale&&(d.locale=this.locale.serialize()),this.currency&&(d.currency=this.currency.serialize()),this.minFractionDigits&&(d["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(d["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),d]}}class Ss{constructor(d){this.type=Mt,this.input=d}static parse(d,b){if(d.length!==2)return b.error(`Expected 1 argument, but found ${d.length-1} instead.`);const E=b.parse(d[1],1);return E?E.type.kind!=="array"&&E.type.kind!=="string"&&E.type.kind!=="value"?b.error(`Expected argument of type string or array, but found ${Wi(E.type)} instead.`):new Ss(E):null}evaluate(d){const b=this.input.evaluate(d);if(typeof b=="string"||Array.isArray(b))return b.length;throw new sr(`Expected value to be of type string or array, but found ${Wi(rr(b))} instead.`)}eachChild(d){d(this.input)}outputDefined(){return!1}serialize(){const d=["length"];return this.eachChild(b=>{d.push(b.serialize())}),d}}const jn={"==":vl,"!=":bl,">":Vh,"<":Uh,">=":Gh,"<=":jh,array:tn,at:va,boolean:tn,case:Ts,coalesce:bs,collator:cs,format:Co,image:hs,in:ba,"index-of":ws,interpolate:jr,"interpolate-hcl":jr,"interpolate-lab":jr,length:Ss,let:Fo,literal:Vn,match:Es,number:tn,"number-format":so,object:tn,slice:Ms,step:Ro,string:tn,"to-boolean":bn,"to-color":bn,"to-number":bn,"to-string":bn,var:ms,within:En};function wl(x,[d,b,E,S]){d=d.evaluate(x),b=b.evaluate(x),E=E.evaluate(x);const k=S?S.evaluate(x):1,P=ul(d,b,E,k);if(P)throw new sr(P);return new Ci(d/255*k,b/255*k,E/255*k,k)}function El(x,d){return x in d}function Ea(x,d){const b=d[x];return b===void 0?null:b}function Tn(x){return{type:x}}function Ta(x){return{result:"success",value:x}}function Gn(x){return{result:"error",value:x}}function Mn(x){return x["property-type"]==="data-driven"||x["property-type"]==="cross-faded-data-driven"}function Tl(x){return!!x.expression&&x.expression.parameters.indexOf("zoom")>-1}function Ma(x){return!!x.expression&&x.expression.interpolated}function Ri(x){return x instanceof Number?"number":x instanceof String?"string":x instanceof Boolean?"boolean":Array.isArray(x)?"array":x===null?"null":typeof x}function As(x){return typeof x=="object"&&x!==null&&!Array.isArray(x)}function qh(x){return x}function Ml(x,d){const b=d.type==="color",E=x.stops&&typeof x.stops[0][0]=="object",S=E||!(E||x.property!==void 0),k=x.type||(Ma(d)?"exponential":"interval");if(b&&((x=Ai({},x)).stops&&(x.stops=x.stops.map(V=>[V[0],Ci.parse(V[1])])),x.default=Ci.parse(x.default?x.default:d.default)),x.colorSpace&&x.colorSpace!=="rgb"&&!yl[x.colorSpace])throw new Error(`Unknown color space: ${x.colorSpace}`);let P,F,$;if(k==="exponential")P=Al;else if(k==="interval")P=Is;else if(k==="categorical"){P=Sl,F=Object.create(null);for(const V of x.stops)F[V[0]]=V[1];$=typeof x.stops[0][0]}else{if(k!=="identity")throw new Error(`Unknown function type "${k}"`);P=Zh}if(E){const V={},Z=[];for(let ne=0;ne<x.stops.length;ne++){const ce=x.stops[ne],ye=ce[0].zoom;V[ye]===void 0&&(V[ye]={zoom:ye,type:x.type,property:x.property,default:x.default,stops:[]},Z.push(ye)),V[ye].stops.push([ce[0].value,ce[1]])}const X=[];for(const ne of Z)X.push([V[ne].zoom,Ml(V[ne],d)]);const W={name:"linear"};return{kind:"composite",interpolationType:W,interpolationFactor:jr.interpolationFactor.bind(void 0,W),zoomStops:X.map(ne=>ne[0]),evaluate:({zoom:ne},ce)=>Al({stops:X,base:x.base},d,ne).evaluate(ne,ce)}}if(S){const V=k==="exponential"?{name:"exponential",base:x.base!==void 0?x.base:1}:null;return{kind:"camera",interpolationType:V,interpolationFactor:jr.interpolationFactor.bind(void 0,V),zoomStops:x.stops.map(Z=>Z[0]),evaluate:({zoom:Z})=>P(x,d,Z,F,$)}}return{kind:"source",evaluate(V,Z){const X=Z&&Z.properties?Z.properties[x.property]:void 0;return X===void 0?ao(x.default,d.default):P(x,d,X,F,$)}}}function ao(x,d,b){return x!==void 0?x:d!==void 0?d:b!==void 0?b:void 0}function Sl(x,d,b,E,S){return ao(typeof b===S?E[b]:void 0,x.default,d.default)}function Is(x,d,b){if(Ri(b)!=="number")return ao(x.default,d.default);const E=x.stops.length;if(E===1||b<=x.stops[0][0])return x.stops[0][1];if(b>=x.stops[E-1][0])return x.stops[E-1][1];const S=Po(x.stops.map(k=>k[0]),b);return x.stops[S][1]}function Al(x,d,b){const E=x.base!==void 0?x.base:1;if(Ri(b)!=="number")return ao(x.default,d.default);const S=x.stops.length;if(S===1||b<=x.stops[0][0])return x.stops[0][1];if(b>=x.stops[S-1][0])return x.stops[S-1][1];const k=Po(x.stops.map(Z=>Z[0]),b),P=function(Z,X,W,ne){const ce=ne-W,ye=Z-W;return ce===0?0:X===1?ye/ce:(Math.pow(X,ye)-1)/(Math.pow(X,ce)-1)}(b,E,x.stops[k][0],x.stops[k+1][0]),F=x.stops[k][1],$=x.stops[k+1][1];let V=Bo[d.type]||qh;if(x.colorSpace&&x.colorSpace!=="rgb"){const Z=yl[x.colorSpace];V=(X,W)=>Z.reverse(Z.interpolate(Z.forward(X),Z.forward(W),P))}return typeof F.evaluate=="function"?{evaluate(...Z){const X=F.evaluate.apply(void 0,Z),W=$.evaluate.apply(void 0,Z);if(X!==void 0&&W!==void 0)return V(X,W,P)}}:V(F,$,P)}function Zh(x,d,b){return d.type==="color"?b=Ci.parse(b):d.type==="formatted"?b=Sr.fromString(b.toString()):d.type==="resolvedImage"?b=Xr.fromString(b.toString()):Ri(b)===d.type||d.type==="enum"&&d.values[b]||(b=void 0),ao(b,x.default,d.default)}Ar.register(jn,{error:[{kind:"error"},[bi],(x,[d])=>{throw new sr(d.evaluate(x))}],typeof:[bi,[xi],(x,[d])=>Wi(rr(d.evaluate(x)))],"to-rgba":[Vr(Mt,4),[ir],(x,[d])=>d.evaluate(x).toArray()],rgb:[ir,[Mt,Mt,Mt],wl],rgba:[ir,[Mt,Mt,Mt,Mt],wl],has:{type:yi,overloads:[[[bi],(x,[d])=>El(d.evaluate(x),x.properties())],[[bi,$n],(x,[d,b])=>El(d.evaluate(x),b.evaluate(x))]]},get:{type:xi,overloads:[[[bi],(x,[d])=>Ea(d.evaluate(x),x.properties())],[[bi,$n],(x,[d,b])=>Ea(d.evaluate(x),b.evaluate(x))]]},"feature-state":[xi,[bi],(x,[d])=>Ea(d.evaluate(x),x.featureState||{})],properties:[$n,[],x=>x.properties()],"geometry-type":[bi,[],x=>x.geometryType()],id:[xi,[],x=>x.id()],zoom:[Mt,[],x=>x.globals.zoom],pitch:[Mt,[],x=>x.globals.pitch||0],"distance-from-center":[Mt,[],x=>x.distanceFromCenter()],"heatmap-density":[Mt,[],x=>x.globals.heatmapDensity||0],"line-progress":[Mt,[],x=>x.globals.lineProgress||0],"sky-radial-progress":[Mt,[],x=>x.globals.skyRadialProgress||0],accumulated:[xi,[],x=>x.globals.accumulated===void 0?null:x.globals.accumulated],"+":[Mt,Tn(Mt),(x,d)=>{let b=0;for(const E of d)b+=E.evaluate(x);return b}],"*":[Mt,Tn(Mt),(x,d)=>{let b=1;for(const E of d)b*=E.evaluate(x);return b}],"-":{type:Mt,overloads:[[[Mt,Mt],(x,[d,b])=>d.evaluate(x)-b.evaluate(x)],[[Mt],(x,[d])=>-d.evaluate(x)]]},"/":[Mt,[Mt,Mt],(x,[d,b])=>d.evaluate(x)/b.evaluate(x)],"%":[Mt,[Mt,Mt],(x,[d,b])=>d.evaluate(x)%b.evaluate(x)],ln2:[Mt,[],()=>Math.LN2],pi:[Mt,[],()=>Math.PI],e:[Mt,[],()=>Math.E],"^":[Mt,[Mt,Mt],(x,[d,b])=>Math.pow(d.evaluate(x),b.evaluate(x))],sqrt:[Mt,[Mt],(x,[d])=>Math.sqrt(d.evaluate(x))],log10:[Mt,[Mt],(x,[d])=>Math.log(d.evaluate(x))/Math.LN10],ln:[Mt,[Mt],(x,[d])=>Math.log(d.evaluate(x))],log2:[Mt,[Mt],(x,[d])=>Math.log(d.evaluate(x))/Math.LN2],sin:[Mt,[Mt],(x,[d])=>Math.sin(d.evaluate(x))],cos:[Mt,[Mt],(x,[d])=>Math.cos(d.evaluate(x))],tan:[Mt,[Mt],(x,[d])=>Math.tan(d.evaluate(x))],asin:[Mt,[Mt],(x,[d])=>Math.asin(d.evaluate(x))],acos:[Mt,[Mt],(x,[d])=>Math.acos(d.evaluate(x))],atan:[Mt,[Mt],(x,[d])=>Math.atan(d.evaluate(x))],min:[Mt,Tn(Mt),(x,d)=>Math.min(...d.map(b=>b.evaluate(x)))],max:[Mt,Tn(Mt),(x,d)=>Math.max(...d.map(b=>b.evaluate(x)))],abs:[Mt,[Mt],(x,[d])=>Math.abs(d.evaluate(x))],round:[Mt,[Mt],(x,[d])=>{const b=d.evaluate(x);return b<0?-Math.round(-b):Math.round(b)}],floor:[Mt,[Mt],(x,[d])=>Math.floor(d.evaluate(x))],ceil:[Mt,[Mt],(x,[d])=>Math.ceil(d.evaluate(x))],"filter-==":[yi,[bi,xi],(x,[d,b])=>x.properties()[d.value]===b.value],"filter-id-==":[yi,[xi],(x,[d])=>x.id()===d.value],"filter-type-==":[yi,[bi],(x,[d])=>x.geometryType()===d.value],"filter-<":[yi,[bi,xi],(x,[d,b])=>{const E=x.properties()[d.value],S=b.value;return typeof E==typeof S&&E<S}],"filter-id-<":[yi,[xi],(x,[d])=>{const b=x.id(),E=d.value;return typeof b==typeof E&&b<E}],"filter->":[yi,[bi,xi],(x,[d,b])=>{const E=x.properties()[d.value],S=b.value;return typeof E==typeof S&&E>S}],"filter-id->":[yi,[xi],(x,[d])=>{const b=x.id(),E=d.value;return typeof b==typeof E&&b>E}],"filter-<=":[yi,[bi,xi],(x,[d,b])=>{const E=x.properties()[d.value],S=b.value;return typeof E==typeof S&&E<=S}],"filter-id-<=":[yi,[xi],(x,[d])=>{const b=x.id(),E=d.value;return typeof b==typeof E&&b<=E}],"filter->=":[yi,[bi,xi],(x,[d,b])=>{const E=x.properties()[d.value],S=b.value;return typeof E==typeof S&&E>=S}],"filter-id->=":[yi,[xi],(x,[d])=>{const b=x.id(),E=d.value;return typeof b==typeof E&&b>=E}],"filter-has":[yi,[xi],(x,[d])=>d.value in x.properties()],"filter-has-id":[yi,[],x=>x.id()!==null&&x.id()!==void 0],"filter-type-in":[yi,[Vr(bi)],(x,[d])=>d.value.indexOf(x.geometryType())>=0],"filter-id-in":[yi,[Vr(xi)],(x,[d])=>d.value.indexOf(x.id())>=0],"filter-in-small":[yi,[bi,Vr(xi)],(x,[d,b])=>b.value.indexOf(x.properties()[d.value])>=0],"filter-in-large":[yi,[bi,Vr(xi)],(x,[d,b])=>function(E,S,k,P){for(;k<=P;){const F=k+P>>1;if(S[F]===E)return!0;S[F]>E?P=F-1:k=F+1}return!1}(x.properties()[d.value],b.value,0,b.value.length-1)],all:{type:yi,overloads:[[[yi,yi],(x,[d,b])=>d.evaluate(x)&&b.evaluate(x)],[Tn(yi),(x,d)=>{for(const b of d)if(!b.evaluate(x))return!1;return!0}]]},any:{type:yi,overloads:[[[yi,yi],(x,[d,b])=>d.evaluate(x)||b.evaluate(x)],[Tn(yi),(x,d)=>{for(const b of d)if(b.evaluate(x))return!0;return!1}]]},"!":[yi,[yi],(x,[d])=>!d.evaluate(x)],"is-supported-script":[yi,[bi],(x,[d])=>{const b=x.globals&&x.globals.isSupportedScript;return!b||b(d.evaluate(x))}],upcase:[bi,[bi],(x,[d])=>d.evaluate(x).toUpperCase()],downcase:[bi,[bi],(x,[d])=>d.evaluate(x).toLowerCase()],concat:[bi,Tn(xi),(x,d)=>d.map(b=>Un(b.evaluate(x))).join("")],"resolved-locale":[bi,[os],(x,[d])=>d.evaluate(x).resolvedLocale()]});class Sa{constructor(d,b){this.expression=d,this._warningHistory={},this._evaluator=new ca,this._defaultValue=b?function(E){return E.type==="color"&&As(E.default)?new Ci(0,0,0,0):E.type==="color"?Ci.parse(E.default)||null:E.default===void 0?null:E.default}(b):null,this._enumValues=b&&b.type==="enum"?b.values:null}evaluateWithoutErrorHandling(d,b,E,S,k,P,F,$){return this._evaluator.globals=d,this._evaluator.feature=b,this._evaluator.featureState=E,this._evaluator.canonical=S,this._evaluator.availableImages=k||null,this._evaluator.formattedSection=P,this._evaluator.featureTileCoord=F||null,this._evaluator.featureDistanceData=$||null,this.expression.evaluate(this._evaluator)}evaluate(d,b,E,S,k,P,F,$){this._evaluator.globals=d,this._evaluator.feature=b||null,this._evaluator.featureState=E||null,this._evaluator.canonical=S,this._evaluator.availableImages=k||null,this._evaluator.formattedSection=P||null,this._evaluator.featureTileCoord=F||null,this._evaluator.featureDistanceData=$||null;try{const V=this.expression.evaluate(this._evaluator);if(V==null||typeof V=="number"&&V!=V)return this._defaultValue;if(this._enumValues&&!(V in this._enumValues))throw new sr(`Expected value to be one of ${Object.keys(this._enumValues).map(Z=>JSON.stringify(Z)).join(", ")}, but found ${JSON.stringify(V)} instead.`);return V}catch(V){return this._warningHistory[V.message]||(this._warningHistory[V.message]=!0,typeof console!="undefined"&&console.warn(V.message)),this._defaultValue}}}function rn(x){return Array.isArray(x)&&x.length>0&&typeof x[0]=="string"&&x[0]in jn}function lo(x,d){const b=new gs(jn,[],d?function(S){const k={color:ir,string:bi,number:Mt,enum:bi,boolean:yi,formatted:eo,resolvedImage:to};return S.type==="array"?Vr(k[S.value]||xi,S.length):k[S.type]}(d):void 0),E=b.parse(x,void 0,void 0,void 0,d&&d.type==="string"?{typeAnnotation:"coerce"}:void 0);return E?Ta(new Sa(E,d)):Gn(b.errors)}class Sn{constructor(d,b){this.kind=d,this._styleExpression=b,this.isStateDependent=d!=="constant"&&!ps(b.expression)}evaluateWithoutErrorHandling(d,b,E,S,k,P){return this._styleExpression.evaluateWithoutErrorHandling(d,b,E,S,k,P)}evaluate(d,b,E,S,k,P){return this._styleExpression.evaluate(d,b,E,S,k,P)}}class ks{constructor(d,b,E,S){this.kind=d,this.zoomStops=E,this._styleExpression=b,this.isStateDependent=d!=="camera"&&!ps(b.expression),this.interpolationType=S}evaluateWithoutErrorHandling(d,b,E,S,k,P){return this._styleExpression.evaluateWithoutErrorHandling(d,b,E,S,k,P)}evaluate(d,b,E,S,k,P){return this._styleExpression.evaluate(d,b,E,S,k,P)}interpolationFactor(d,b,E){return this.interpolationType?jr.interpolationFactor(this.interpolationType,d,b,E):0}}function Il(x,d){if((x=lo(x,d)).result==="error")return x;const b=x.value.expression,E=ro(b);if(!E&&!Mn(d))return Gn([new Ei("","data expressions not supported")]);const S=Si(b,["zoom","pitch","distance-from-center"]);if(!S&&!Tl(d))return Gn([new Ei("","zoom expressions not supported")]);const k=An(b);return k||S?k instanceof Ei?Gn([k]):k instanceof jr&&!Ma(d)?Gn([new Ei("",'"interpolate" expressions cannot be used with this property')]):Ta(k?new ks(E?"camera":"composite",x.value,k.labels,k instanceof jr?k.interpolation:void 0):new Sn(E?"constant":"source",x.value)):Gn([new Ei("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class ho{constructor(d,b){this._parameters=d,this._specification=b,Ai(this,Ml(this._parameters,this._specification))}static deserialize(d){return new ho(d._parameters,d._specification)}static serialize(d){return{_parameters:d._parameters,_specification:d._specification}}}function An(x){let d=null;if(x instanceof Fo)d=An(x.result);else if(x instanceof bs){for(const b of x.args)if(d=An(b),d)break}else(x instanceof Ro||x instanceof jr)&&x.input instanceof Ar&&x.input.name==="zoom"&&(d=x);return d instanceof Ei||x.eachChild(b=>{const E=An(b);E instanceof Ei?d=E:!d&&E?d=new Ei("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):d&&E&&d!==E&&(d=new Ei("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),d}function Hr(x){const d=x.key,b=x.value,E=x.valueSpec||{},S=x.objectElementValidators||{},k=x.style,P=x.styleSpec;let F=[];const $=Ri(b);if($!=="object")return[new Qe(d,b,`object expected, ${$} found`)];for(const V in b){const Z=V.split(".")[0],X=E[Z]||E["*"];let W;if(S[Z])W=S[Z];else if(E[Z])W=Ir;else if(S["*"])W=S["*"];else{if(!E["*"]){F.push(new Qe(d,b[V],`unknown property "${V}"`));continue}W=Ir}F=F.concat(W({key:(d&&`${d}.`)+V,value:b[V],valueSpec:X,style:k,styleSpec:P,object:b,objectKey:V},b))}for(const V in E)S[V]||E[V].required&&E[V].default===void 0&&b[V]===void 0&&F.push(new Qe(d,b,`missing required property "${V}"`));return F}function Cs(x){const d=x.value,b=x.valueSpec,E=x.style,S=x.styleSpec,k=x.key,P=x.arrayElementValidator||Ir;if(Ri(d)!=="array")return[new Qe(k,d,`array expected, ${Ri(d)} found`)];if(b.length&&d.length!==b.length)return[new Qe(k,d,`array length ${b.length} expected, length ${d.length} found`)];if(b["min-length"]&&d.length<b["min-length"])return[new Qe(k,d,`array length at least ${b["min-length"]} expected, length ${d.length} found`)];let F={type:b.value,values:b.values,minimum:b.minimum,maximum:b.maximum};S.$version<7&&(F.function=b.function),Ri(b.value)==="object"&&(F=b.value);let $=[];for(let V=0;V<d.length;V++)$=$.concat(P({array:d,arrayIndex:V,value:d[V],valueSpec:F,style:E,styleSpec:S,key:`${k}[${V}]`}));return $}function Aa(x){const d=x.key,b=x.value,E=x.valueSpec;let S=Ri(b);if(S==="number"&&b!=b&&(S="NaN"),S!=="number")return[new Qe(d,b,`number expected, ${S} found`)];if("minimum"in E){let k=E.minimum;if(Ri(E.minimum)==="array"&&(k=E.minimum[x.arrayIndex]),b<k)return[new Qe(d,b,`${b} is less than the minimum value ${k}`)]}if("maximum"in E){let k=E.maximum;if(Ri(E.maximum)==="array"&&(k=E.maximum[x.arrayIndex]),b>k)return[new Qe(d,b,`${b} is greater than the maximum value ${k}`)]}return[]}function Ds(x){const d=x.valueSpec,b=ri(x.value.type);let E,S,k,P={};const F=b!=="categorical"&&x.value.property===void 0,$=!F,V=Ri(x.value.stops)==="array"&&Ri(x.value.stops[0])==="array"&&Ri(x.value.stops[0][0])==="object",Z=Hr({key:x.key,value:x.value,valueSpec:x.styleSpec.function,style:x.style,styleSpec:x.styleSpec,objectElementValidators:{stops:function(ne){if(b==="identity")return[new Qe(ne.key,ne.value,'identity function may not have a "stops" property')];let ce=[];const ye=ne.value;return ce=ce.concat(Cs({key:ne.key,value:ye,valueSpec:ne.valueSpec,style:ne.style,styleSpec:ne.styleSpec,arrayElementValidator:X})),Ri(ye)==="array"&&ye.length===0&&ce.push(new Qe(ne.key,ye,"array must have at least one stop")),ce},default:function(ne){return Ir({key:ne.key,value:ne.value,valueSpec:d,style:ne.style,styleSpec:ne.styleSpec})}}});return b==="identity"&&F&&Z.push(new Qe(x.key,x.value,'missing required property "property"')),b==="identity"||x.value.stops||Z.push(new Qe(x.key,x.value,'missing required property "stops"')),b==="exponential"&&x.valueSpec.expression&&!Ma(x.valueSpec)&&Z.push(new Qe(x.key,x.value,"exponential functions not supported")),x.styleSpec.$version>=8&&($&&!Mn(x.valueSpec)?Z.push(new Qe(x.key,x.value,"property functions not supported")):F&&!Tl(x.valueSpec)&&Z.push(new Qe(x.key,x.value,"zoom functions not supported"))),b!=="categorical"&&!V||x.value.property!==void 0||Z.push(new Qe(x.key,x.value,'"property" property is required')),Z;function X(ne){let ce=[];const ye=ne.value,Me=ne.key;if(Ri(ye)!=="array")return[new Qe(Me,ye,`array expected, ${Ri(ye)} found`)];if(ye.length!==2)return[new Qe(Me,ye,`array length 2 expected, length ${ye.length} found`)];if(V){if(Ri(ye[0])!=="object")return[new Qe(Me,ye,`object expected, ${Ri(ye[0])} found`)];if(ye[0].zoom===void 0)return[new Qe(Me,ye,"object stop key must have zoom")];if(ye[0].value===void 0)return[new Qe(Me,ye,"object stop key must have value")];if(k&&k>ri(ye[0].zoom))return[new Qe(Me,ye[0].zoom,"stop zoom values must appear in ascending order")];ri(ye[0].zoom)!==k&&(k=ri(ye[0].zoom),S=void 0,P={}),ce=ce.concat(Hr({key:`${Me}[0]`,value:ye[0],valueSpec:{zoom:{}},style:ne.style,styleSpec:ne.styleSpec,objectElementValidators:{zoom:Aa,value:W}}))}else ce=ce.concat(W({key:`${Me}[0]`,value:ye[0],valueSpec:{},style:ne.style,styleSpec:ne.styleSpec},ye));return rn(wi(ye[1]))?ce.concat([new Qe(`${Me}[1]`,ye[1],"expressions are not allowed in function stops.")]):ce.concat(Ir({key:`${Me}[1]`,value:ye[1],valueSpec:d,style:ne.style,styleSpec:ne.styleSpec}))}function W(ne,ce){const ye=Ri(ne.value),Me=ri(ne.value),Ce=ne.value!==null?ne.value:ce;if(E){if(ye!==E)return[new Qe(ne.key,Ce,`${ye} stop domain type must match previous stop domain type ${E}`)]}else E=ye;if(ye!=="number"&&ye!=="string"&&ye!=="boolean")return[new Qe(ne.key,Ce,"stop domain value must be a number, string, or boolean")];if(ye!=="number"&&b!=="categorical"){let ze=`number expected, ${ye} found`;return Mn(d)&&b===void 0&&(ze+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Qe(ne.key,Ce,ze)]}return b!=="categorical"||ye!=="number"||isFinite(Me)&&Math.floor(Me)===Me?b!=="categorical"&&ye==="number"&&S!==void 0&&Me<S?[new Qe(ne.key,Ce,"stop domain values must appear in ascending order")]:(S=Me,b==="categorical"&&Me in P?[new Qe(ne.key,Ce,"stop domain values must be unique")]:(P[Me]=!0,[])):[new Qe(ne.key,Ce,`integer expected, found ${Me}`)]}}function In(x){const d=(x.expressionContext==="property"?Il:lo)(wi(x.value),x.valueSpec);if(d.result==="error")return d.value.map(E=>new Qe(`${x.key}${E.key}`,x.value,E.message));const b=d.value.expression||d.value._styleExpression.expression;if(x.expressionContext==="property"&&x.propertyKey==="text-font"&&!b.outputDefined())return[new Qe(x.key,x.value,`Invalid data expression for "${x.propertyKey}". Output values must be contained as literals within the expression.`)];if(x.expressionContext==="property"&&x.propertyType==="layout"&&!ps(b))return[new Qe(x.key,x.value,'"feature-state" data expressions are not supported with layout properties.')];if(x.expressionContext==="filter")return Ia(b,x);if(x.expressionContext&&x.expressionContext.indexOf("cluster")===0){if(!Si(b,["zoom","feature-state"]))return[new Qe(x.key,x.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(x.expressionContext==="cluster-initial"&&!ro(b))return[new Qe(x.key,x.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Ia(x,d){const b=new Set(["zoom","feature-state","pitch","distance-from-center"]);for(const S of d.valueSpec.expression.parameters)b.delete(S);if(b.size===0)return[];const E=[];return x instanceof Ar&&b.has(x.name)?[new Qe(d.key,d.value,`["${x.name}"] expression is not supported in a filter for a ${d.object.type} layer with id: ${d.object.id}`)]:(x.eachChild(S=>{E.push(...Ia(S,d))}),E)}function co(x){const d=x.key,b=x.value,E=x.valueSpec,S=[];return Array.isArray(E.values)?E.values.indexOf(ri(b))===-1&&S.push(new Qe(d,b,`expected one of [${E.values.join(", ")}], ${JSON.stringify(b)} found`)):Object.keys(E.values).indexOf(ri(b))===-1&&S.push(new Qe(d,b,`expected one of [${Object.keys(E.values).join(", ")}], ${JSON.stringify(b)} found`)),S}function Ps(x){if(x===!0||x===!1)return!0;if(!Array.isArray(x)||x.length===0)return!1;switch(x[0]){case"has":return x.length>=2&&x[1]!=="$id"&&x[1]!=="$type";case"in":return x.length>=3&&(typeof x[1]!="string"||Array.isArray(x[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return x.length!==3||Array.isArray(x[1])||Array.isArray(x[2]);case"any":case"all":for(const d of x.slice(1))if(!Ps(d)&&typeof d!="boolean")return!1;return!0;default:return!0}}function Oo(x,d="fill"){if(x==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Ps(x)||(x=Rs(x));const b=x;let E=!0;try{E=function(V){if(!Zn(V))return V;let Z=wi(V);return qn(Z),Z=ka(Z),Z}(b)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(b,null,2)}
        `)}const S=Ve[`filter_${d}`],k=lo(E,S);let P=null;if(k.result==="error")throw new Error(k.value.map(V=>`${V.key}: ${V.message}`).join(", "));P=(V,Z,X)=>k.value.evaluate(V,Z,{},X);let F=null,$=null;if(E!==b){const V=lo(b,S);if(V.result==="error")throw new Error(V.value.map(Z=>`${Z.key}: ${Z.message}`).join(", "));F=(Z,X,W,ne,ce)=>V.value.evaluate(Z,X,{},W,void 0,void 0,ne,ce),$=!ro(V.value.expression)}return P=P,{filter:P,dynamicFilter:F||void 0,needGeometry:Da(E),needFeature:!!$}}function ka(x){if(!Array.isArray(x))return x;const d=function(b){if(kl.has(b[0])){for(let E=1;E<b.length;E++)if(Zn(b[E]))return!0}return b}(x);return d===!0?d:d.map(b=>ka(b))}function qn(x){let d=!1;const b=[];if(x[0]==="case"){for(let E=1;E<x.length-1;E+=2)d=d||Zn(x[E]),b.push(x[E+1]);b.push(x[x.length-1])}else if(x[0]==="match"){d=d||Zn(x[1]);for(let E=2;E<x.length-1;E+=2)b.push(x[E+1]);b.push(x[x.length-1])}else if(x[0]==="step"){d=d||Zn(x[1]);for(let E=1;E<x.length-1;E+=2)b.push(x[E+1])}d&&(x.length=0,x.push("any",...b));for(let E=1;E<x.length;E++)qn(x[E])}function Zn(x){if(!Array.isArray(x))return!1;if((d=x[0])==="pitch"||d==="distance-from-center")return!0;var d;for(let b=1;b<x.length;b++)if(Zn(x[b]))return!0;return!1}const kl=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Ca(x,d){return x<d?-1:x>d?1:0}function Da(x){if(!Array.isArray(x))return!1;if(x[0]==="within")return!0;for(let d=1;d<x.length;d++)if(Da(x[d]))return!0;return!1}function Rs(x){if(!x)return!0;const d=x[0];return x.length<=1?d!=="any":d==="=="?uo(x[1],x[2],"=="):d==="!="?Bs(uo(x[1],x[2],"==")):d==="<"||d===">"||d==="<="||d===">="?uo(x[1],x[2],d):d==="any"?(b=x.slice(1),["any"].concat(b.map(Rs))):d==="all"?["all"].concat(x.slice(1).map(Rs)):d==="none"?["all"].concat(x.slice(1).map(Rs).map(Bs)):d==="in"?Cl(x[1],x.slice(2)):d==="!in"?Bs(Cl(x[1],x.slice(2))):d==="has"?Dl(x[1]):d==="!has"?Bs(Dl(x[1])):d!=="within"||x;var b}function uo(x,d,b){switch(x){case"$type":return[`filter-type-${b}`,d];case"$id":return[`filter-id-${b}`,d];default:return[`filter-${b}`,x,d]}}function Cl(x,d){if(d.length===0)return!1;switch(x){case"$type":return["filter-type-in",["literal",d]];case"$id":return["filter-id-in",["literal",d]];default:return d.length>200&&!d.some(b=>typeof b!=typeof d[0])?["filter-in-large",x,["literal",d.sort(Ca)]]:["filter-in-small",x,["literal",d]]}}function Dl(x){switch(x){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",x]}}function Bs(x){return["!",x]}function Pa(x){if(Ps(wi(x.value))){const d=wi(x.layerType);return In(Ai({},x,{expressionContext:"filter",valueSpec:x.styleSpec[`filter_${d||"fill"}`]}))}return Pl(x)}function Pl(x){const d=x.value,b=x.key;if(Ri(d)!=="array")return[new Qe(b,d,`array expected, ${Ri(d)} found`)];const E=x.styleSpec;let S,k=[];if(d.length<1)return[new Qe(b,d,"filter array must have at least 1 element")];switch(k=k.concat(co({key:`${b}[0]`,value:d[0],valueSpec:E.filter_operator,style:x.style,styleSpec:x.styleSpec})),ri(d[0])){case"<":case"<=":case">":case">=":d.length>=2&&ri(d[1])==="$type"&&k.push(new Qe(b,d,`"$type" cannot be use with operator "${d[0]}"`));case"==":case"!=":d.length!==3&&k.push(new Qe(b,d,`filter array for operator "${d[0]}" must have 3 elements`));case"in":case"!in":d.length>=2&&(S=Ri(d[1]),S!=="string"&&k.push(new Qe(`${b}[1]`,d[1],`string expected, ${S} found`)));for(let P=2;P<d.length;P++)S=Ri(d[P]),ri(d[1])==="$type"?k=k.concat(co({key:`${b}[${P}]`,value:d[P],valueSpec:E.geometry_type,style:x.style,styleSpec:x.styleSpec})):S!=="string"&&S!=="number"&&S!=="boolean"&&k.push(new Qe(`${b}[${P}]`,d[P],`string, number, or boolean expected, ${S} found`));break;case"any":case"all":case"none":for(let P=1;P<d.length;P++)k=k.concat(Pl({key:`${b}[${P}]`,value:d[P],style:x.style,styleSpec:x.styleSpec}));break;case"has":case"!has":S=Ri(d[1]),d.length!==2?k.push(new Qe(b,d,`filter array for "${d[0]}" operator must have 2 elements`)):S!=="string"&&k.push(new Qe(`${b}[1]`,d[1],`string expected, ${S} found`));break;case"within":S=Ri(d[1]),d.length!==2?k.push(new Qe(b,d,`filter array for "${d[0]}" operator must have 2 elements`)):S!=="object"&&k.push(new Qe(`${b}[1]`,d[1],`object expected, ${S} found`))}return k}function $o(x,d){const b=x.key,E=x.style,S=x.styleSpec,k=x.value,P=x.objectKey,F=S[`${d}_${x.layerType}`];if(!F)return[];const $=P.match(/^(.*)-transition$/);if(d==="paint"&&$&&F[$[1]]&&F[$[1]].transition)return Ir({key:b,value:k,valueSpec:S.transition,style:E,styleSpec:S});const V=x.valueSpec||F[P];if(!V)return[new Qe(b,k,`unknown property "${P}"`)];let Z;if(Ri(k)==="string"&&Mn(V)&&!V.tokens&&(Z=/^{([^}]+)}$/.exec(k)))return[new Qe(b,k,`"${P}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(Z[1])} }\`.`)];const X=[];return x.layerType==="symbol"&&(P==="text-field"&&E&&!E.glyphs&&X.push(new Qe(b,k,'use of "text-field" requires a style "glyphs" property')),P==="text-font"&&As(wi(k))&&ri(k.type)==="identity"&&X.push(new Qe(b,k,'"text-font" does not support identity functions'))),X.concat(Ir({key:x.key,value:k,valueSpec:V,style:E,styleSpec:S,expressionContext:"property",propertyType:d,propertyKey:P}))}function No(x){return $o(x,"paint")}function Or(x){return $o(x,"layout")}function Uo(x){let d=[];const b=x.value,E=x.key,S=x.style,k=x.styleSpec;b.type||b.ref||d.push(new Qe(E,b,'either "type" or "ref" is required'));let P=ri(b.type);const F=ri(b.ref);if(b.id){const $=ri(b.id);for(let V=0;V<x.arrayIndex;V++){const Z=S.layers[V];ri(Z.id)===$&&d.push(new Qe(E,b.id,`duplicate layer id "${b.id}", previously used at line ${Z.id.__line__}`))}}if("ref"in b){let $;["type","source","source-layer","filter","layout"].forEach(V=>{V in b&&d.push(new Qe(E,b[V],`"${V}" is prohibited for ref layers`))}),S.layers.forEach(V=>{ri(V.id)===F&&($=V)}),$?$.ref?d.push(new Qe(E,b.ref,"ref cannot reference another ref layer")):P=ri($.type):d.push(new Qe(E,b.ref,`ref layer "${F}" not found`))}else if(P!=="background"&&P!=="sky")if(b.source){const $=S.sources&&S.sources[b.source],V=$&&ri($.type);$?V==="vector"&&P==="raster"?d.push(new Qe(E,b.source,`layer "${b.id}" requires a raster source`)):V==="raster"&&P!=="raster"?d.push(new Qe(E,b.source,`layer "${b.id}" requires a vector source`)):V!=="vector"||b["source-layer"]?V==="raster-dem"&&P!=="hillshade"?d.push(new Qe(E,b.source,"raster-dem source can only be used with layer type 'hillshade'.")):P!=="line"||!b.paint||!b.paint["line-gradient"]||V==="geojson"&&$.lineMetrics||d.push(new Qe(E,b,`layer "${b.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):d.push(new Qe(E,b,`layer "${b.id}" must specify a "source-layer"`)):d.push(new Qe(E,b.source,`source "${b.source}" not found`))}else d.push(new Qe(E,b,'missing required property "source"'));return d=d.concat(Hr({key:E,value:b,valueSpec:k.layer,style:x.style,styleSpec:x.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Ir({key:`${E}.type`,value:b.type,valueSpec:k.layer.type,style:x.style,styleSpec:x.styleSpec,object:b,objectKey:"type"}),filter:$=>Pa(Ai({layerType:P},$)),layout:$=>Hr({layer:b,key:$.key,value:$.value,style:$.style,styleSpec:$.styleSpec,objectElementValidators:{"*":V=>Or(Ai({layerType:P},V))}}),paint:$=>Hr({layer:b,key:$.key,value:$.value,style:$.style,styleSpec:$.styleSpec,objectElementValidators:{"*":V=>No(Ai({layerType:P},V))}})}})),d}function fo(x){const d=x.value,b=x.key,E=Ri(d);return E!=="string"?[new Qe(b,d,`string expected, ${E} found`)]:[]}const Rl={promoteId:function({key:x,value:d}){if(Ri(d)==="string")return fo({key:x,value:d});{const b=[];for(const E in d)b.push(...fo({key:`${x}.${E}`,value:d[E]}));return b}}};function Bl(x){const d=x.value,b=x.key,E=x.styleSpec,S=x.style;if(!d.type)return[new Qe(b,d,'"type" is required')];const k=ri(d.type);let P;switch(k){case"vector":case"raster":case"raster-dem":return P=Hr({key:b,value:d,valueSpec:E[`source_${k.replace("-","_")}`],style:x.style,styleSpec:E,objectElementValidators:Rl}),P;case"geojson":if(P=Hr({key:b,value:d,valueSpec:E.source_geojson,style:S,styleSpec:E,objectElementValidators:Rl}),d.cluster)for(const F in d.clusterProperties){const[$,V]=d.clusterProperties[F],Z=typeof $=="string"?[$,["accumulated"],["get",F]]:$;P.push(...In({key:`${b}.${F}.map`,value:V,expressionContext:"cluster-map"})),P.push(...In({key:`${b}.${F}.reduce`,value:Z,expressionContext:"cluster-reduce"}))}return P;case"video":return Hr({key:b,value:d,valueSpec:E.source_video,style:S,styleSpec:E});case"image":return Hr({key:b,value:d,valueSpec:E.source_image,style:S,styleSpec:E});case"canvas":return[new Qe(b,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return co({key:`${b}.type`,value:d.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:S,styleSpec:E})}}function Ll(x){const d=x.value,b=x.styleSpec,E=b.light,S=x.style;let k=[];const P=Ri(d);if(d===void 0)return k;if(P!=="object")return k=k.concat([new Qe("light",d,`object expected, ${P} found`)]),k;for(const F in d){const $=F.match(/^(.*)-transition$/);k=k.concat($&&E[$[1]]&&E[$[1]].transition?Ir({key:F,value:d[F],valueSpec:b.transition,style:S,styleSpec:b}):E[F]?Ir({key:F,value:d[F],valueSpec:E[F],style:S,styleSpec:b}):[new Qe(F,d[F],`unknown property "${F}"`)])}return k}function Ls(x){const d=x.value,b=x.key,E=x.style,S=x.styleSpec,k=S.terrain;let P=[];const F=Ri(d);if(d===void 0)return P;if(F!=="object")return P=P.concat([new Qe("terrain",d,`object expected, ${F} found`)]),P;for(const $ in d){const V=$.match(/^(.*)-transition$/);P=P.concat(V&&k[V[1]]&&k[V[1]].transition?Ir({key:$,value:d[$],valueSpec:S.transition,style:E,styleSpec:S}):k[$]?Ir({key:$,value:d[$],valueSpec:k[$],style:E,styleSpec:S}):[new Qe($,d[$],`unknown property "${$}"`)])}if(d.source){const $=E.sources&&E.sources[d.source],V=$&&ri($.type);$?V!=="raster-dem"&&P.push(new Qe(b,d.source,`terrain cannot be used with a source of type ${V}, it only be used with a "raster-dem" source type`)):P.push(new Qe(b,d.source,`source "${d.source}" not found`))}else P.push(new Qe(b,d,'terrain is missing required property "source"'));return P}function zl(x){const d=x.value,b=x.style,E=x.styleSpec,S=E.fog;let k=[];const P=Ri(d);if(d===void 0)return k;if(P!=="object")return k=k.concat([new Qe("fog",d,`object expected, ${P} found`)]),k;for(const F in d){const $=F.match(/^(.*)-transition$/);k=k.concat($&&S[$[1]]&&S[$[1]].transition?Ir({key:F,value:d[F],valueSpec:E.transition,style:b,styleSpec:E}):S[F]?Ir({key:F,value:d[F],valueSpec:S[F],style:b,styleSpec:E}):[new Qe(F,d[F],`unknown property "${F}"`)])}return k}const zs={"*":()=>[],array:Cs,boolean:function(x){const d=x.value,b=x.key,E=Ri(d);return E!=="boolean"?[new Qe(b,d,`boolean expected, ${E} found`)]:[]},number:Aa,color:function(x){const d=x.key,b=x.value,E=Ri(b);return E!=="string"?[new Qe(d,b,`color expected, ${E} found`)]:en.parseCSSColor(b)===null?[new Qe(d,b,`color expected, "${b}" found`)]:[]},constants:gi,enum:co,filter:Pa,function:Ds,layer:Uo,object:Hr,source:Bl,light:Ll,terrain:Ls,fog:zl,string:fo,formatted:function(x){return fo(x).length===0?[]:In(x)},resolvedImage:function(x){return fo(x).length===0?[]:In(x)},projection:function(x){const d=x.value,b=x.styleSpec,E=b.projection,S=x.style;let k=[];const P=Ri(d);if(P==="object")for(const F in d)k=k.concat(Ir({key:F,value:d[F],valueSpec:E[F],style:S,styleSpec:b}));else P!=="string"&&(k=k.concat([new Qe("projection",d,`object or string expected, ${P} found`)]));return k}};function Ir(x){const d=x.value,b=x.valueSpec,E=x.styleSpec;return b.expression&&As(ri(d))?Ds(x):b.expression&&rn(wi(d))?In(x):b.type&&zs[b.type]?zs[b.type](x):Hr(Ai({},x,{valueSpec:b.type?E[b.type]:b}))}function Xh(x){const d=x.value,b=x.key,E=fo(x);return E.length||(d.indexOf("{fontstack}")===-1&&E.push(new Qe(b,d,'"glyphs" url must include a "{fontstack}" token')),d.indexOf("{range}")===-1&&E.push(new Qe(b,d,'"glyphs" url must include a "{range}" token'))),E}function nn(x,d=Ve){let b=[];return b=b.concat(Ir({key:"",value:x,valueSpec:d.$root,styleSpec:d,style:x,objectElementValidators:{glyphs:Xh,"*":()=>[]}})),x.constants&&(b=b.concat(gi({key:"constants",value:x.constants,style:x,styleSpec:d}))),Fl(b)}function Fl(x){return[].concat(x).sort((d,b)=>d.line-b.line)}function pn(x){return function(...d){return Fl(x.apply(this,d))}}nn.source=pn(Bl),nn.light=pn(Ll),nn.terrain=pn(Ls),nn.fog=pn(zl),nn.layer=pn(Uo),nn.filter=pn(Pa),nn.paintProperty=pn(No),nn.layoutProperty=pn(Or);const Xn=nn,Yh=Xn.light,Ra=Xn.fog,Fs=Xn.paintProperty,Ol=Xn.layoutProperty;function $l(x,d){let b=!1;if(d&&d.length)for(const E of d)x.fire(new Rt(new Error(E.message))),b=!0;return b}var po=cn;function cn(x,d,b){var E=this.cells=[];if(x instanceof ArrayBuffer){this.arrayBuffer=x;var S=new Int32Array(this.arrayBuffer);x=S[0],this.d=(d=S[1])+2*(b=S[2]);for(var k=0;k<this.d*this.d;k++){var P=S[3+k],F=S[3+k+1];E.push(P===F?null:S.subarray(P,F))}var $=S[3+E.length+1];this.keys=S.subarray(S[3+E.length],$),this.bboxes=S.subarray($),this.insert=this._insertReadonly}else{this.d=d+2*b;for(var V=0;V<this.d*this.d;V++)E.push([]);this.keys=[],this.bboxes=[]}this.n=d,this.extent=x,this.padding=b,this.scale=d/x,this.uid=0;var Z=b/d*x;this.min=-Z,this.max=x+Z}cn.prototype.insert=function(x,d,b,E,S){this._forEachCell(d,b,E,S,this._insertCell,this.uid++),this.keys.push(x),this.bboxes.push(d),this.bboxes.push(b),this.bboxes.push(E),this.bboxes.push(S)},cn.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},cn.prototype._insertCell=function(x,d,b,E,S,k){this.cells[S].push(k)},cn.prototype.query=function(x,d,b,E,S){var k=this.min,P=this.max;if(x<=k&&d<=k&&P<=b&&P<=E&&!S)return Array.prototype.slice.call(this.keys);var F=[];return this._forEachCell(x,d,b,E,this._queryCell,F,{},S),F},cn.prototype._queryCell=function(x,d,b,E,S,k,P,F){var $=this.cells[S];if($!==null)for(var V=this.keys,Z=this.bboxes,X=0;X<$.length;X++){var W=$[X];if(P[W]===void 0){var ne=4*W;(F?F(Z[ne+0],Z[ne+1],Z[ne+2],Z[ne+3]):x<=Z[ne+2]&&d<=Z[ne+3]&&b>=Z[ne+0]&&E>=Z[ne+1])?(P[W]=!0,k.push(V[W])):P[W]=!1}}},cn.prototype._forEachCell=function(x,d,b,E,S,k,P,F){for(var $=this._convertToCellCoord(x),V=this._convertToCellCoord(d),Z=this._convertToCellCoord(b),X=this._convertToCellCoord(E),W=$;W<=Z;W++)for(var ne=V;ne<=X;ne++){var ce=this.d*ne+W;if((!F||F(this._convertFromCellCoord(W),this._convertFromCellCoord(ne),this._convertFromCellCoord(W+1),this._convertFromCellCoord(ne+1)))&&S.call(this,x,d,b,E,ce,k,P,F))return}},cn.prototype._convertFromCellCoord=function(x){return(x-this.padding)/this.scale},cn.prototype._convertToCellCoord=function(x){return Math.max(0,Math.min(this.d-1,Math.floor(x*this.scale)+this.padding))},cn.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var x=this.cells,d=3+this.cells.length+1+1,b=0,E=0;E<this.cells.length;E++)b+=this.cells[E].length;var S=new Int32Array(d+b+this.keys.length+this.bboxes.length);S[0]=this.extent,S[1]=this.n,S[2]=this.padding;for(var k=d,P=0;P<x.length;P++){var F=x[P];S[3+P]=k,S.set(F,k),k+=F.length}return S[3+x.length]=k,S.set(this.keys,k),S[3+x.length+1]=k+=this.keys.length,S.set(this.bboxes,k),k+=this.bboxes.length,S.buffer};const{ImageData:Os,ImageBitmap:Nl}=G,Vo={};function Ft(x,d,b={}){Object.defineProperty(d,"_classRegistryKey",{value:x,writeable:!1}),Vo[x]={klass:d,omit:b.omit||[],shallow:b.shallow||[]}}Ft("Object",Object),po.serialize=function(x,d){const b=x.toArrayBuffer();return d&&d.push(b),{buffer:b}},po.deserialize=function(x){return new po(x.buffer)},Ft("Grid",po),Ft("Color",Ci),Ft("Error",Error),Ft("ResolvedImage",Xr),Ft("StylePropertyFunction",ho),Ft("StyleExpression",Sa,{omit:["_evaluator"]}),Ft("ZoomDependentExpression",ks),Ft("ZoomConstantExpression",Sn),Ft("CompoundExpression",Ar,{omit:["_evaluate"]});for(const x in jn)jn[x]._classRegistryKey||Ft(`Expression_${x}`,jn[x]);function Ul(x){return x&&typeof ArrayBuffer!="undefined"&&(x instanceof ArrayBuffer||x.constructor&&x.constructor.name==="ArrayBuffer")}function Ba(x){return Nl&&x instanceof Nl}function jo(x,d){if(x==null||typeof x=="boolean"||typeof x=="number"||typeof x=="string"||x instanceof Boolean||x instanceof Number||x instanceof String||x instanceof Date||x instanceof RegExp)return x;if(Ul(x)||Ba(x))return d&&d.push(x),x;if(ArrayBuffer.isView(x)){const b=x;return d&&d.push(b.buffer),b}if(x instanceof Os)return d&&d.push(x.data.buffer),x;if(Array.isArray(x)){const b=[];for(const E of x)b.push(jo(E,d));return b}if(typeof x=="object"){const b=x.constructor,E=b._classRegistryKey;if(!E)throw new Error("can't serialize object of unregistered class");const S=b.serialize?b.serialize(x,d):{};if(!b.serialize){for(const k in x){if(!x.hasOwnProperty(k)||Vo[E].omit.indexOf(k)>=0)continue;const P=x[k];S[k]=Vo[E].shallow.indexOf(k)>=0?P:jo(P,d)}x instanceof Error&&(S.message=x.message)}if(S.$name)throw new Error("$name property is reserved for worker serialization logic.");return E!=="Object"&&(S.$name=E),S}throw new Error("can't serialize object of type "+typeof x)}function Go(x){if(x==null||typeof x=="boolean"||typeof x=="number"||typeof x=="string"||x instanceof Boolean||x instanceof Number||x instanceof String||x instanceof Date||x instanceof RegExp||Ul(x)||Ba(x)||ArrayBuffer.isView(x)||x instanceof Os)return x;if(Array.isArray(x))return x.map(Go);if(typeof x=="object"){const d=x.$name||"Object",{klass:b}=Vo[d];if(!b)throw new Error(`can't deserialize unregistered class ${d}`);if(b.deserialize)return b.deserialize(x);const E=Object.create(b.prototype);for(const S of Object.keys(x)){if(S==="$name")continue;const k=x[S];E[S]=Vo[d].shallow.indexOf(S)>=0?k:Go(k)}return E}throw new Error("can't deserialize object of type "+typeof x)}class Vl{constructor(){this.first=!0}update(d,b){const E=Math.floor(d);return this.first?(this.first=!1,this.lastIntegerZoom=E,this.lastIntegerZoomTime=0,this.lastZoom=d,this.lastFloorZoom=E,!0):(this.lastFloorZoom>E?(this.lastIntegerZoom=E+1,this.lastIntegerZoomTime=b):this.lastFloorZoom<E&&(this.lastIntegerZoom=E,this.lastIntegerZoomTime=b),d!==this.lastZoom&&(this.lastZoom=d,this.lastFloorZoom=E,!0))}}const jl=x=>x>=1536&&x<=1791,Gl=x=>x>=1872&&x<=1919,ql=x=>x>=2208&&x<=2303,Zl=x=>x>=11904&&x<=12031,qo=x=>x>=12032&&x<=12255,Xl=x=>x>=12272&&x<=12287,$s=x=>x>=12288&&x<=12351,mo=x=>x>=12352&&x<=12447,Ns=x=>x>=12448&&x<=12543,La=x=>x>=12544&&x<=12591,Yl=x=>x>=12704&&x<=12735,za=x=>x>=12736&&x<=12783,Fa=x=>x>=12784&&x<=12799,Oa=x=>x>=12800&&x<=13055,$a=x=>x>=13056&&x<=13311,Us=x=>x>=13312&&x<=19903,Zo=x=>x>=19968&&x<=40959,Hl=x=>x>=40960&&x<=42127,Wl=x=>x>=42128&&x<=42191,Xo=x=>x>=44032&&x<=55215,Kl=x=>x>=63744&&x<=64255,kn=x=>x>=64336&&x<=65023,Jl=x=>x>=65040&&x<=65055,Yo=x=>x>=65072&&x<=65103,Ql=x=>x>=65104&&x<=65135,Na=x=>x>=65136&&x<=65279,Ua=x=>x>=65280&&x<=65519;function Cn(x){for(const d of x)if(Va(d.charCodeAt(0)))return!0;return!1}function Vs(x){for(const d of x)if(!Ho(d.charCodeAt(0)))return!1;return!0}function Ho(x){return!(jl(x)||Gl(x)||ql(x)||kn(x)||Na(x))}function Va(x){return!(x!==746&&x!==747&&(x<4352||!(Yl(x)||La(x)||Yo(x)&&!(x>=65097&&x<=65103)||Kl(x)||$a(x)||Zl(x)||za(x)||!(!$s(x)||x>=12296&&x<=12305||x>=12308&&x<=12319||x===12336)||Us(x)||Zo(x)||Oa(x)||(d=>d>=12592&&d<=12687)(x)||(d=>d>=43360&&d<=43391)(x)||(d=>d>=55216&&d<=55295)(x)||(d=>d>=4352&&d<=4607)(x)||Xo(x)||mo(x)||Xl(x)||(d=>d>=12688&&d<=12703)(x)||qo(x)||Fa(x)||Ns(x)&&x!==12540||!(!Ua(x)||x===65288||x===65289||x===65293||x>=65306&&x<=65310||x===65339||x===65341||x===65343||x>=65371&&x<=65503||x===65507||x>=65512&&x<=65519)||!(!Ql(x)||x>=65112&&x<=65118||x>=65123&&x<=65126)||(d=>d>=5120&&d<=5759)(x)||(d=>d>=6320&&d<=6399)(x)||Jl(x)||(d=>d>=19904&&d<=19967)(x)||Hl(x)||Wl(x))))}function ja(x){return!(Va(x)||function(d){return!!((b=>b>=128&&b<=255)(d)&&(d===167||d===169||d===174||d===177||d===188||d===189||d===190||d===215||d===247)||(b=>b>=8192&&b<=8303)(d)&&(d===8214||d===8224||d===8225||d===8240||d===8241||d===8251||d===8252||d===8258||d===8263||d===8264||d===8265||d===8273)||(b=>b>=8448&&b<=8527)(d)||(b=>b>=8528&&b<=8591)(d)||(b=>b>=8960&&b<=9215)(d)&&(d>=8960&&d<=8967||d>=8972&&d<=8991||d>=8996&&d<=9e3||d===9003||d>=9085&&d<=9114||d>=9150&&d<=9165||d===9167||d>=9169&&d<=9179||d>=9186&&d<=9215)||(b=>b>=9216&&b<=9279)(d)&&d!==9251||(b=>b>=9280&&b<=9311)(d)||(b=>b>=9312&&b<=9471)(d)||(b=>b>=9632&&b<=9727)(d)||(b=>b>=9728&&b<=9983)(d)&&!(d>=9754&&d<=9759)||(b=>b>=11008&&b<=11263)(d)&&(d>=11026&&d<=11055||d>=11088&&d<=11097||d>=11192&&d<=11243)||$s(d)||Ns(d)||(b=>b>=57344&&b<=63743)(d)||Yo(d)||Ql(d)||Ua(d)||d===8734||d===8756||d===8757||d>=9984&&d<=10087||d>=10102&&d<=10131||d===65532||d===65533)}(x))}function go(x){return x>=1424&&x<=2303||kn(x)||Na(x)}function Hh(x,d){return!(!d&&go(x)||x>=2304&&x<=3583||x>=3840&&x<=4255||(b=>b>=6016&&b<=6143)(x))}function Wh(x){for(const d of x)if(go(d.charCodeAt(0)))return!0;return!1}const _o="deferred",I="loading",g="loaded";let M=null,C="unavailable",L=null;const z=function(x){x&&typeof x=="string"&&x.indexOf("NetworkError")>-1&&(C="error"),M&&M(x)};function U(){q.fire(new st("pluginStateChange",{pluginStatus:C,pluginURL:L}))}const q=new gt,Y=function(){return C},J=function(){if(C!==_o||!L)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");C=I,U(),L&&re({url:L},x=>{x?z(x):(C=g,U())})},ee={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>C===g||ee.applyArabicShaping!=null,isLoading:()=>C===I,setState(x){C=x.pluginStatus,L=x.pluginURL},isParsed:()=>ee.applyArabicShaping!=null&&ee.processBidirectionalText!=null&&ee.processStyledBidirectionalText!=null,getPluginURL:()=>L};class ie{constructor(d,b){this.zoom=d,b?(this.now=b.now,this.fadeDuration=b.fadeDuration,this.zoomHistory=b.zoomHistory,this.transition=b.transition,this.pitch=b.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Vl,this.transition={},this.pitch=0)}isSupportedScript(d){return function(b,E){for(const S of b)if(!Hh(S.charCodeAt(0),E))return!1;return!0}(d,ee.isLoaded())}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const d=this.zoom,b=d-Math.floor(d),E=this.crossFadingFactor();return d>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:b+(1-b)*E}:{fromScale:.5,toScale:1,t:1-(1-E)*b}}}class fe{constructor(d,b){this.property=d,this.value=b,this.expression=function(E,S){if(As(E))return new ho(E,S);if(rn(E)){const k=Il(E,S);if(k.result==="error")throw new Error(k.value.map(P=>`${P.key}: ${P.message}`).join(", "));return k.value}{let k=E;return typeof E=="string"&&S.type==="color"&&(k=Ci.parse(E)),{kind:"constant",evaluate:()=>k}}}(b===void 0?d.specification.default:b,d.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(d,b,E){return this.property.possiblyEvaluate(this,d,b,E)}}class be{constructor(d){this.property=d,this.value=new fe(d,void 0)}transitioned(d,b){return new xe(this.property,this.value,b,pe({},d.transition,this.transition),d.now)}untransitioned(){return new xe(this.property,this.value,null,{},0)}}class Te{constructor(d){this._properties=d,this._values=Object.create(d.defaultTransitionablePropertyValues)}getValue(d){return Ut(this._values[d].value.value)}setValue(d,b){this._values.hasOwnProperty(d)||(this._values[d]=new be(this._values[d].property)),this._values[d].value=new fe(this._values[d].property,b===null?void 0:Ut(b))}getTransition(d){return Ut(this._values[d].transition)}setTransition(d,b){this._values.hasOwnProperty(d)||(this._values[d]=new be(this._values[d].property)),this._values[d].transition=Ut(b)||void 0}serialize(){const d={};for(const b of Object.keys(this._values)){const E=this.getValue(b);E!==void 0&&(d[b]=E);const S=this.getTransition(b);S!==void 0&&(d[`${b}-transition`]=S)}return d}transitioned(d,b){const E=new Ie(this._properties);for(const S of Object.keys(this._values))E._values[S]=this._values[S].transitioned(d,b._values[S]);return E}untransitioned(){const d=new Ie(this._properties);for(const b of Object.keys(this._values))d._values[b]=this._values[b].untransitioned();return d}}class xe{constructor(d,b,E,S,k){const P=S.delay||0,F=S.duration||0;k=k||0,this.property=d,this.value=b,this.begin=k+P,this.end=this.begin+F,d.specification.transition&&(S.delay||S.duration)&&(this.prior=E)}possiblyEvaluate(d,b,E){const S=d.now||0,k=this.value.possiblyEvaluate(d,b,E),P=this.prior;if(P){if(S>this.end)return this.prior=null,k;if(this.value.isDataDriven())return this.prior=null,k;if(S<this.begin)return P.possiblyEvaluate(d,b,E);{const F=(S-this.begin)/(this.end-this.begin);return this.property.interpolate(P.possiblyEvaluate(d,b,E),k,he(F))}}return k}}class Ie{constructor(d){this._properties=d,this._values=Object.create(d.defaultTransitioningPropertyValues)}possiblyEvaluate(d,b,E){const S=new De(this._properties);for(const k of Object.keys(this._values))S._values[k]=this._values[k].possiblyEvaluate(d,b,E);return S}hasTransition(){for(const d of Object.keys(this._values))if(this._values[d].prior)return!0;return!1}}class ve{constructor(d){this._properties=d,this._values=Object.create(d.defaultPropertyValues)}getValue(d){return Ut(this._values[d].value)}setValue(d,b){this._values[d]=new fe(this._values[d].property,b===null?void 0:Ut(b))}serialize(){const d={};for(const b of Object.keys(this._values)){const E=this.getValue(b);E!==void 0&&(d[b]=E)}return d}possiblyEvaluate(d,b,E){const S=new De(this._properties);for(const k of Object.keys(this._values))S._values[k]=this._values[k].possiblyEvaluate(d,b,E);return S}}class ke{constructor(d,b,E){this.property=d,this.value=b,this.parameters=E}isConstant(){return this.value.kind==="constant"}constantOr(d){return this.value.kind==="constant"?this.value.value:d}evaluate(d,b,E,S){return this.property.evaluate(this.value,this.parameters,d,b,E,S)}}class De{constructor(d){this._properties=d,this._values=Object.create(d.defaultPossiblyEvaluatedValues)}get(d){return this._values[d]}}class Ee{constructor(d){this.specification=d}possiblyEvaluate(d,b){return d.expression.evaluate(b)}interpolate(d,b,E){const S=Bo[this.specification.type];return S?S(d,b,E):d}}class Pe{constructor(d,b){this.specification=d,this.overrides=b}possiblyEvaluate(d,b,E,S){return new ke(this,d.expression.kind==="constant"||d.expression.kind==="camera"?{kind:"constant",value:d.expression.evaluate(b,null,{},E,S)}:d.expression,b)}interpolate(d,b,E){if(d.value.kind!=="constant"||b.value.kind!=="constant")return d;if(d.value.value===void 0||b.value.value===void 0)return new ke(this,{kind:"constant",value:void 0},d.parameters);const S=Bo[this.specification.type];return S?new ke(this,{kind:"constant",value:S(d.value.value,b.value.value,E)},d.parameters):d}evaluate(d,b,E,S,k,P){return d.kind==="constant"?d.value:d.evaluate(b,E,S,k,P)}}class Oe extends Pe{possiblyEvaluate(d,b,E,S){if(d.value===void 0)return new ke(this,{kind:"constant",value:void 0},b);if(d.expression.kind==="constant"){const k=d.expression.evaluate(b,null,{},E,S),P=d.property.specification.type==="resolvedImage"&&typeof k!="string"?k.name:k,F=this._calculate(P,P,P,b);return new ke(this,{kind:"constant",value:F},b)}if(d.expression.kind==="camera"){const k=this._calculate(d.expression.evaluate({zoom:b.zoom-1}),d.expression.evaluate({zoom:b.zoom}),d.expression.evaluate({zoom:b.zoom+1}),b);return new ke(this,{kind:"constant",value:k},b)}return new ke(this,d.expression,b)}evaluate(d,b,E,S,k,P){if(d.kind==="source"){const F=d.evaluate(b,E,S,k,P);return this._calculate(F,F,F,b)}return d.kind==="composite"?this._calculate(d.evaluate({zoom:Math.floor(b.zoom)-1},E,S),d.evaluate({zoom:Math.floor(b.zoom)},E,S),d.evaluate({zoom:Math.floor(b.zoom)+1},E,S),b):d.value}_calculate(d,b,E,S){return S.zoom>S.zoomHistory.lastIntegerZoom?{from:d,to:b,other:E}:{from:E,to:b,other:d}}interpolate(d){return d}}class Je{constructor(d){this.specification=d}possiblyEvaluate(d,b,E,S){if(d.value!==void 0){if(d.expression.kind==="constant"){const k=d.expression.evaluate(b,null,{},E,S);return this._calculate(k,k,k,b)}return this._calculate(d.expression.evaluate(new ie(Math.floor(b.zoom-1),b)),d.expression.evaluate(new ie(Math.floor(b.zoom),b)),d.expression.evaluate(new ie(Math.floor(b.zoom+1),b)),b)}}_calculate(d,b,E,S){return S.zoom>S.zoomHistory.lastIntegerZoom?{from:d,to:b}:{from:E,to:b}}interpolate(d){return d}}class Ke{constructor(d){this.specification=d}possiblyEvaluate(d,b,E,S){return!!d.expression.evaluate(b,null,{},E,S)}interpolate(){return!1}}class rt{constructor(d){this.properties=d,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const b in d){const E=d[b];E.specification.overridable&&this.overridableProperties.push(b);const S=this.defaultPropertyValues[b]=new fe(E,void 0),k=this.defaultTransitionablePropertyValues[b]=new be(E);this.defaultTransitioningPropertyValues[b]=k.untransitioned(),this.defaultPossiblyEvaluatedValues[b]=S.possiblyEvaluate({})}}}function nt(x,d){return 256*(x=ge(Math.floor(x),0,255))+ge(Math.floor(d),0,255)}Ft("DataDrivenProperty",Pe),Ft("DataConstantProperty",Ee),Ft("CrossFadedDataDrivenProperty",Oe),Ft("CrossFadedProperty",Je),Ft("ColorRampProperty",Ke);const _t={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class it{constructor(d,b){this._structArray=d,this._pos1=b*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class yt{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(d,b){return d._trim(),b&&(d.isTransferred=!0,b.push(d.arrayBuffer)),{length:d.length,arrayBuffer:d.arrayBuffer}}static deserialize(d){const b=Object.create(this.prototype);return b.arrayBuffer=d.arrayBuffer,b.length=d.length,b.capacity=d.arrayBuffer.byteLength/b.bytesPerElement,b._refreshViews(),b}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(d){this.reserve(d),this.length=d}reserve(d){if(d>this.capacity){this.capacity=Math.max(d,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const b=this.uint8;this._refreshViews(),b&&this.uint8.set(b)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function We(x,d=1){let b=0,E=0;return{members:x.map(S=>{const k=_t[S.type].BYTES_PER_ELEMENT,P=b=vt(b,Math.max(d,k)),F=S.components||1;return E=Math.max(E,k),b+=k*F,{name:S.name,type:S.type,components:F,offset:P}}),size:vt(b,Math.max(E,d)),alignment:d}}function vt(x,d){return Math.ceil(x/d)*d}class Ot extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(d,b){const E=this.length;return this.resize(E+1),this.emplace(E,d,b)}emplace(d,b,E){const S=2*d;return this.int16[S+0]=b,this.int16[S+1]=E,d}}Ot.prototype.bytesPerElement=4,Ft("StructArrayLayout2i4",Ot);class Qt extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(d,b,E,S){const k=this.length;return this.resize(k+1),this.emplace(k,d,b,E,S)}emplace(d,b,E,S,k){const P=4*d;return this.int16[P+0]=b,this.int16[P+1]=E,this.int16[P+2]=S,this.int16[P+3]=k,d}}Qt.prototype.bytesPerElement=8,Ft("StructArrayLayout4i8",Qt);class ni extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k,P,F){const $=this.length;return this.resize($+1),this.emplace($,d,b,E,S,k,P,F)}emplace(d,b,E,S,k,P,F,$){const V=6*d,Z=12*d,X=3*d;return this.int16[V+0]=b,this.int16[V+1]=E,this.uint8[Z+4]=S,this.uint8[Z+5]=k,this.uint8[Z+6]=P,this.uint8[Z+7]=F,this.float32[X+2]=$,d}}ni.prototype.bytesPerElement=12,Ft("StructArrayLayout2i4ub1f12",ni);class si extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(d,b,E){const S=this.length;return this.resize(S+1),this.emplace(S,d,b,E)}emplace(d,b,E,S){const k=3*d;return this.float32[k+0]=b,this.float32[k+1]=E,this.float32[k+2]=S,d}}si.prototype.bytesPerElement=12,Ft("StructArrayLayout3f12",si);class ai extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k,P,F,$,V,Z){const X=this.length;return this.resize(X+1),this.emplace(X,d,b,E,S,k,P,F,$,V,Z)}emplace(d,b,E,S,k,P,F,$,V,Z,X){const W=10*d;return this.uint16[W+0]=b,this.uint16[W+1]=E,this.uint16[W+2]=S,this.uint16[W+3]=k,this.uint16[W+4]=P,this.uint16[W+5]=F,this.uint16[W+6]=$,this.uint16[W+7]=V,this.uint16[W+8]=Z,this.uint16[W+9]=X,d}}ai.prototype.bytesPerElement=20,Ft("StructArrayLayout10ui20",ai);class Wt extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k,P,F,$){const V=this.length;return this.resize(V+1),this.emplace(V,d,b,E,S,k,P,F,$)}emplace(d,b,E,S,k,P,F,$,V){const Z=8*d;return this.uint16[Z+0]=b,this.uint16[Z+1]=E,this.uint16[Z+2]=S,this.uint16[Z+3]=k,this.uint16[Z+4]=P,this.uint16[Z+5]=F,this.uint16[Z+6]=$,this.uint16[Z+7]=V,d}}Wt.prototype.bytesPerElement=16,Ft("StructArrayLayout8ui16",Wt);class fi extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me){const Ce=this.length;return this.resize(Ce+1),this.emplace(Ce,d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me)}emplace(d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me,Ce){const ze=16*d;return this.int16[ze+0]=b,this.int16[ze+1]=E,this.int16[ze+2]=S,this.int16[ze+3]=k,this.uint16[ze+4]=P,this.uint16[ze+5]=F,this.uint16[ze+6]=$,this.uint16[ze+7]=V,this.int16[ze+8]=Z,this.int16[ze+9]=X,this.int16[ze+10]=W,this.int16[ze+11]=ne,this.int16[ze+12]=ce,this.int16[ze+13]=ye,this.int16[ze+14]=Me,this.int16[ze+15]=Ce,d}}fi.prototype.bytesPerElement=32,Ft("StructArrayLayout4i4ui4i4i32",fi);class Li extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(d){const b=this.length;return this.resize(b+1),this.emplace(b,d)}emplace(d,b){return this.uint32[1*d+0]=b,d}}Li.prototype.bytesPerElement=4,Ft("StructArrayLayout1ul4",Li);class ar extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k,P,F,$,V,Z,X,W,ne){const ce=this.length;return this.resize(ce+1),this.emplace(ce,d,b,E,S,k,P,F,$,V,Z,X,W,ne)}emplace(d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce){const ye=20*d,Me=10*d;return this.int16[ye+0]=b,this.int16[ye+1]=E,this.int16[ye+2]=S,this.int16[ye+3]=k,this.int16[ye+4]=P,this.float32[Me+3]=F,this.float32[Me+4]=$,this.float32[Me+5]=V,this.float32[Me+6]=Z,this.int16[ye+14]=X,this.uint32[Me+8]=W,this.uint16[ye+18]=ne,this.uint16[ye+19]=ce,d}}ar.prototype.bytesPerElement=40,Ft("StructArrayLayout5i4f1i1ul2ui40",ar);class wr extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k,P,F){const $=this.length;return this.resize($+1),this.emplace($,d,b,E,S,k,P,F)}emplace(d,b,E,S,k,P,F,$){const V=8*d;return this.int16[V+0]=b,this.int16[V+1]=E,this.int16[V+2]=S,this.int16[V+4]=k,this.int16[V+5]=P,this.int16[V+6]=F,this.int16[V+7]=$,d}}wr.prototype.bytesPerElement=16,Ft("StructArrayLayout3i2i2i16",wr);class kr extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k){const P=this.length;return this.resize(P+1),this.emplace(P,d,b,E,S,k)}emplace(d,b,E,S,k,P){const F=4*d,$=8*d;return this.float32[F+0]=b,this.float32[F+1]=E,this.float32[F+2]=S,this.int16[$+6]=k,this.int16[$+7]=P,d}}kr.prototype.bytesPerElement=16,Ft("StructArrayLayout2f1f2i16",kr);class Rr extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(d,b,E,S){const k=this.length;return this.resize(k+1),this.emplace(k,d,b,E,S)}emplace(d,b,E,S,k){const P=12*d,F=3*d;return this.uint8[P+0]=b,this.uint8[P+1]=E,this.float32[F+1]=S,this.float32[F+2]=k,d}}Rr.prototype.bytesPerElement=12,Ft("StructArrayLayout2ub2f12",Rr);class lr extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(d,b,E){const S=this.length;return this.resize(S+1),this.emplace(S,d,b,E)}emplace(d,b,E,S){const k=3*d;return this.uint16[k+0]=b,this.uint16[k+1]=E,this.uint16[k+2]=S,d}}lr.prototype.bytesPerElement=6,Ft("StructArrayLayout3ui6",lr);class mn extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me,Ce,ze,$e,qe,Ge){const Ye=this.length;return this.resize(Ye+1),this.emplace(Ye,d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me,Ce,ze,$e,qe,Ge)}emplace(d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me,Ce,ze,$e,qe,Ge,Ye){const ot=30*d,et=15*d,At=60*d;return this.int16[ot+0]=b,this.int16[ot+1]=E,this.int16[ot+2]=S,this.float32[et+2]=k,this.float32[et+3]=P,this.uint16[ot+8]=F,this.uint16[ot+9]=$,this.uint32[et+5]=V,this.uint32[et+6]=Z,this.uint32[et+7]=X,this.uint16[ot+16]=W,this.uint16[ot+17]=ne,this.uint16[ot+18]=ce,this.float32[et+10]=ye,this.float32[et+11]=Me,this.uint8[At+48]=Ce,this.uint8[At+49]=ze,this.uint8[At+50]=$e,this.uint32[et+13]=qe,this.int16[ot+28]=Ge,this.uint8[At+58]=Ye,d}}mn.prototype.bytesPerElement=60,Ft("StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60",mn);class un extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me,Ce,ze,$e,qe,Ge,Ye,ot,et,At,ut,at,dt,mt,ht){const It=this.length;return this.resize(It+1),this.emplace(It,d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me,Ce,ze,$e,qe,Ge,Ye,ot,et,At,ut,at,dt,mt,ht)}emplace(d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me,Ce,ze,$e,qe,Ge,Ye,ot,et,At,ut,at,dt,mt,ht,It){const Bt=38*d,pi=19*d;return this.int16[Bt+0]=b,this.int16[Bt+1]=E,this.int16[Bt+2]=S,this.float32[pi+2]=k,this.float32[pi+3]=P,this.int16[Bt+8]=F,this.int16[Bt+9]=$,this.int16[Bt+10]=V,this.int16[Bt+11]=Z,this.int16[Bt+12]=X,this.int16[Bt+13]=W,this.uint16[Bt+14]=ne,this.uint16[Bt+15]=ce,this.uint16[Bt+16]=ye,this.uint16[Bt+17]=Me,this.uint16[Bt+18]=Ce,this.uint16[Bt+19]=ze,this.uint16[Bt+20]=$e,this.uint16[Bt+21]=qe,this.uint16[Bt+22]=Ge,this.uint16[Bt+23]=Ye,this.uint16[Bt+24]=ot,this.uint16[Bt+25]=et,this.uint16[Bt+26]=At,this.uint16[Bt+27]=ut,this.uint16[Bt+28]=at,this.uint32[pi+15]=dt,this.float32[pi+16]=mt,this.float32[pi+17]=ht,this.float32[pi+18]=It,d}}un.prototype.bytesPerElement=76,Ft("StructArrayLayout3i2f6i15ui1ul3f76",un);class Xi extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(d){const b=this.length;return this.resize(b+1),this.emplace(b,d)}emplace(d,b){return this.float32[1*d+0]=b,d}}Xi.prototype.bytesPerElement=4,Ft("StructArrayLayout1f4",Xi);class er extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(d,b,E){const S=this.length;return this.resize(S+1),this.emplace(S,d,b,E)}emplace(d,b,E,S){const k=3*d;return this.int16[k+0]=b,this.int16[k+1]=E,this.int16[k+2]=S,d}}er.prototype.bytesPerElement=6,Ft("StructArrayLayout3i6",er);class Ii extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(d,b,E,S){const k=this.length;return this.resize(k+1),this.emplace(k,d,b,E,S)}emplace(d,b,E,S,k){const P=6*d;return this.uint32[3*d+0]=b,this.uint16[P+2]=E,this.uint16[P+3]=S,this.uint16[P+4]=k,d}}Ii.prototype.bytesPerElement=12,Ft("StructArrayLayout1ul3ui12",Ii);class Hi extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(d,b){const E=this.length;return this.resize(E+1),this.emplace(E,d,b)}emplace(d,b,E){const S=2*d;return this.uint16[S+0]=b,this.uint16[S+1]=E,d}}Hi.prototype.bytesPerElement=4,Ft("StructArrayLayout2ui4",Hi);class Er extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(d){const b=this.length;return this.resize(b+1),this.emplace(b,d)}emplace(d,b){return this.uint16[1*d+0]=b,d}}Er.prototype.bytesPerElement=2,Ft("StructArrayLayout1ui2",Er);class Yi extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(d,b){const E=this.length;return this.resize(E+1),this.emplace(E,d,b)}emplace(d,b,E){const S=2*d;return this.float32[S+0]=b,this.float32[S+1]=E,d}}Yi.prototype.bytesPerElement=8,Ft("StructArrayLayout2f8",Yi);class Gr extends yt{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(d,b,E,S){const k=this.length;return this.resize(k+1),this.emplace(k,d,b,E,S)}emplace(d,b,E,S,k){const P=4*d;return this.float32[P+0]=b,this.float32[P+1]=E,this.float32[P+2]=S,this.float32[P+3]=k,d}}Gr.prototype.bytesPerElement=16,Ft("StructArrayLayout4f16",Gr);class Wo extends it{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Wo.prototype.size=40;class $r extends ar{get(d){return new Wo(this,d)}}Ft("CollisionBoxArray",$r);class Dn extends it{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(d){this._structArray.uint8[this._pos1+49]=d}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(d){this._structArray.uint8[this._pos1+50]=d}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(d){this._structArray.uint32[this._pos4+13]=d}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(d){this._structArray.uint8[this._pos1+58]=d}}Dn.prototype.size=60;class eh extends mn{get(d){return new Dn(this,d)}}Ft("PlacedSymbolArray",eh);class js extends it{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(d){this._structArray.uint32[this._pos4+15]=d}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}js.prototype.size=76;class yo extends un{get(d){return new js(this,d)}}Ft("SymbolInstanceArray",yo);class th extends Xi{getoffsetX(d){return this.float32[1*d+0]}}Ft("GlyphOffsetArray",th);class Ko extends er{getx(d){return this.int16[3*d+0]}gety(d){return this.int16[3*d+1]}gettileUnitDistanceFromAnchor(d){return this.int16[3*d+2]}}Ft("SymbolLineVertexArray",Ko);class Gs extends it{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Gs.prototype.size=12;class Hc extends Ii{get(d){return new Gs(this,d)}}Ft("FeatureIndexArray",Hc);class Wc extends it{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0]}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1]}}Wc.prototype.size=4;class Kc extends Hi{get(d){return new Wc(this,d)}}Ft("FillExtrusionCentroidArray",Kc);const Jd=We([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),Qd=We([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var Jc=ss(function(x){x.exports=function(d,b){var E,S,k,P,F,$,V,Z;for(S=d.length-(E=3&d.length),k=b,F=3432918353,$=461845907,Z=0;Z<S;)V=255&d.charCodeAt(Z)|(255&d.charCodeAt(++Z))<<8|(255&d.charCodeAt(++Z))<<16|(255&d.charCodeAt(++Z))<<24,++Z,k=27492+(65535&(P=5*(65535&(k=(k^=V=(65535&(V=(V=(65535&V)*F+(((V>>>16)*F&65535)<<16)&4294967295)<<15|V>>>17))*$+(((V>>>16)*$&65535)<<16)&4294967295)<<13|k>>>19))+((5*(k>>>16)&65535)<<16)&4294967295))+((58964+(P>>>16)&65535)<<16);switch(V=0,E){case 3:V^=(255&d.charCodeAt(Z+2))<<16;case 2:V^=(255&d.charCodeAt(Z+1))<<8;case 1:k^=V=(65535&(V=(V=(65535&(V^=255&d.charCodeAt(Z)))*F+(((V>>>16)*F&65535)<<16)&4294967295)<<15|V>>>17))*$+(((V>>>16)*$&65535)<<16)&4294967295}return k^=d.length,k=2246822507*(65535&(k^=k>>>16))+((2246822507*(k>>>16)&65535)<<16)&4294967295,k=3266489909*(65535&(k^=k>>>13))+((3266489909*(k>>>16)&65535)<<16)&4294967295,(k^=k>>>16)>>>0}}),ef=ss(function(x){x.exports=function(d,b){for(var E,S=d.length,k=b^S,P=0;S>=4;)E=1540483477*(65535&(E=255&d.charCodeAt(P)|(255&d.charCodeAt(++P))<<8|(255&d.charCodeAt(++P))<<16|(255&d.charCodeAt(++P))<<24))+((1540483477*(E>>>16)&65535)<<16),k=1540483477*(65535&k)+((1540483477*(k>>>16)&65535)<<16)^(E=1540483477*(65535&(E^=E>>>24))+((1540483477*(E>>>16)&65535)<<16)),S-=4,++P;switch(S){case 3:k^=(255&d.charCodeAt(P+2))<<16;case 2:k^=(255&d.charCodeAt(P+1))<<8;case 1:k=1540483477*(65535&(k^=255&d.charCodeAt(P)))+((1540483477*(k>>>16)&65535)<<16)}return k=1540483477*(65535&(k^=k>>>13))+((1540483477*(k>>>16)&65535)<<16),(k^=k>>>15)>>>0}}),Ga=Jc,tf=ef;Ga.murmur3=Jc,Ga.murmur2=tf;class ih{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(d,b,E,S){this.ids.push(Qc(d)),this.positions.push(b,E,S)}getPositions(d){const b=Qc(d);let E=0,S=this.ids.length-1;for(;E<S;){const P=E+S>>1;this.ids[P]>=b?S=P:E=P+1}const k=[];for(;this.ids[E]===b;)k.push({index:this.positions[3*E],start:this.positions[3*E+1],end:this.positions[3*E+2]}),E++;return k}static serialize(d,b){const E=new Float64Array(d.ids),S=new Uint32Array(d.positions);return Kh(E,S,0,E.length-1),b&&b.push(E.buffer,S.buffer),{ids:E,positions:S}}static deserialize(d){const b=new ih;return b.ids=d.ids,b.positions=d.positions,b.indexed=!0,b}}function Qc(x){const d=+x;return!isNaN(d)&&d<=H?d:Ga(String(x))}function Kh(x,d,b,E){for(;b<E;){const S=x[b+E>>1];let k=b-1,P=E+1;for(;;){do k++;while(x[k]<S);do P--;while(x[P]>S);if(k>=P)break;rh(x,k,P),rh(d,3*k,3*P),rh(d,3*k+1,3*P+1),rh(d,3*k+2,3*P+2)}P-b<E-P?(Kh(x,d,b,P),b=P+1):(Kh(x,d,P+1,E),E=P)}}function rh(x,d,b){const E=x[d];x[d]=x[b],x[b]=E}Ft("FeaturePositionMap",ih);class Yn{constructor(d,b){this.gl=d.gl,this.location=b}}class nh extends Yn{constructor(d,b){super(d,b),this.current=0}set(d){this.current!==d&&(this.current=d,this.gl.uniform1f(this.location,d))}}class eu extends Yn{constructor(d,b){super(d,b),this.current=[0,0,0,0]}set(d){d[0]===this.current[0]&&d[1]===this.current[1]&&d[2]===this.current[2]&&d[3]===this.current[3]||(this.current=d,this.gl.uniform4f(this.location,d[0],d[1],d[2],d[3]))}}class tu extends Yn{constructor(d,b){super(d,b),this.current=Ci.transparent}set(d){d.r===this.current.r&&d.g===this.current.g&&d.b===this.current.b&&d.a===this.current.a||(this.current=d,this.gl.uniform4f(this.location,d.r,d.g,d.b,d.a))}}const rf=new Float32Array(16),nf=new Float32Array(9),of=new Float32Array(4);function Jh(x){return[nt(255*x.r,255*x.g),nt(255*x.b,255*x.a)]}class qa{constructor(d,b,E){this.value=d,this.uniformNames=b.map(S=>`u_${S}`),this.type=E}setUniform(d,b,E){d.set(E.constantOr(this.value))}getBinding(d,b,E){return this.type==="color"?new tu(d,b):new nh(d,b)}}class qs{constructor(d,b){this.uniformNames=b.map(E=>`u_${E}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(d,b){this.pixelRatioFrom=b.pixelRatio,this.pixelRatioTo=d.pixelRatio,this.patternFrom=b.tl.concat(b.br),this.patternTo=d.tl.concat(d.br)}setUniform(d,b,E,S){const k=S==="u_pattern_to"||S==="u_dash_to"?this.patternTo:S==="u_pattern_from"||S==="u_dash_from"?this.patternFrom:S==="u_pixel_ratio_to"?this.pixelRatioTo:S==="u_pixel_ratio_from"?this.pixelRatioFrom:null;k&&d.set(k)}getBinding(d,b,E){return E==="u_pattern_from"||E==="u_pattern_to"||E==="u_dash_from"||E==="u_dash_to"?new eu(d,b):new nh(d,b)}}class Hn{constructor(d,b,E,S){this.expression=d,this.type=E,this.maxValue=0,this.paintVertexAttributes=b.map(k=>({name:`a_${k}`,type:"Float32",components:E==="color"?2:1,offset:0})),this.paintVertexArray=new S}populatePaintArray(d,b,E,S,k,P){const F=this.paintVertexArray.length,$=this.expression.evaluate(new ie(0),b,{},k,S,P);this.paintVertexArray.resize(d),this._setPaintValue(F,d,$)}updatePaintArray(d,b,E,S,k){const P=this.expression.evaluate({zoom:0},E,S,void 0,k);this._setPaintValue(d,b,P)}_setPaintValue(d,b,E){if(this.type==="color"){const S=Jh(E);for(let k=d;k<b;k++)this.paintVertexArray.emplace(k,S[0],S[1])}else{for(let S=d;S<b;S++)this.paintVertexArray.emplace(S,E);this.maxValue=Math.max(this.maxValue,Math.abs(E))}}upload(d){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=d.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class gn{constructor(d,b,E,S,k,P){this.expression=d,this.uniformNames=b.map(F=>`u_${F}_t`),this.type=E,this.useIntegerZoom=S,this.zoom=k,this.maxValue=0,this.paintVertexAttributes=b.map(F=>({name:`a_${F}`,type:"Float32",components:E==="color"?4:2,offset:0})),this.paintVertexArray=new P}populatePaintArray(d,b,E,S,k,P){const F=this.expression.evaluate(new ie(this.zoom),b,{},k,S,P),$=this.expression.evaluate(new ie(this.zoom+1),b,{},k,S,P),V=this.paintVertexArray.length;this.paintVertexArray.resize(d),this._setPaintValue(V,d,F,$)}updatePaintArray(d,b,E,S,k){const P=this.expression.evaluate({zoom:this.zoom},E,S,void 0,k),F=this.expression.evaluate({zoom:this.zoom+1},E,S,void 0,k);this._setPaintValue(d,b,P,F)}_setPaintValue(d,b,E,S){if(this.type==="color"){const k=Jh(E),P=Jh(S);for(let F=d;F<b;F++)this.paintVertexArray.emplace(F,k[0],k[1],P[0],P[1])}else{for(let k=d;k<b;k++)this.paintVertexArray.emplace(k,E,S);this.maxValue=Math.max(this.maxValue,Math.abs(E),Math.abs(S))}}upload(d){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=d.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(d,b){const E=this.useIntegerZoom?Math.floor(b.zoom):b.zoom,S=ge(this.expression.interpolationFactor(E,this.zoom,this.zoom+1),0,1);d.set(S)}getBinding(d,b,E){return new nh(d,b)}}class xo{constructor(d,b,E,S,k,P,F){this.expression=d,this.type=E,this.useIntegerZoom=S,this.zoom=k,this.layerId=F,this.paintVertexAttributes=(E==="array"?Qd:Jd).members;for(let $=0;$<b.length;++$);this.zoomInPaintVertexArray=new P,this.zoomOutPaintVertexArray=new P}populatePaintArray(d,b,E){const S=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(d),this.zoomOutPaintVertexArray.resize(d),this._setPaintValues(S,d,b.patterns&&b.patterns[this.layerId],E)}updatePaintArray(d,b,E,S,k,P){this._setPaintValues(d,b,E.patterns&&E.patterns[this.layerId],P)}_setPaintValues(d,b,E,S){if(!S||!E)return;const{min:k,mid:P,max:F}=E,$=S[k],V=S[P],Z=S[F];if($&&V&&Z)for(let X=d;X<b;X++)this._setPaintValue(this.zoomInPaintVertexArray,X,V,$),this._setPaintValue(this.zoomOutPaintVertexArray,X,V,Z)}_setPaintValue(d,b,E,S){d.emplace(b,E.tl[0],E.tl[1],E.br[0],E.br[1],S.tl[0],S.tl[1],S.br[0],S.br[1],E.pixelRatio,S.pixelRatio)}upload(d){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=d.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=d.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Wn{constructor(d,b,E=()=>!0){this.binders={},this._buffers=[];const S=[];for(const k in d.paint._values){if(!E(k))continue;const P=d.paint.get(k);if(!(P instanceof ke&&Mn(P.property.specification)))continue;const F=af(k,d.type),$=P.value,V=P.property.specification.type,Z=P.property.useIntegerZoom,X=P.property.specification["property-type"],W=X==="cross-faded"||X==="cross-faded-data-driven",ne=String(k)==="line-dasharray"&&d.layout.get("line-cap").value.kind!=="constant";if($.kind!=="constant"||ne)if($.kind==="source"||ne||W){const ce=iu(k,V,"source");this.binders[k]=W?new xo($,F,V,Z,b,ce,d.id):new Hn($,F,V,ce),S.push(`/a_${k}`)}else{const ce=iu(k,V,"composite");this.binders[k]=new gn($,F,V,Z,b,ce),S.push(`/z_${k}`)}else this.binders[k]=W?new qs($.value,F):new qa($.value,F,V),S.push(`/u_${k}`)}this.cacheKey=S.sort().join("")}getMaxValue(d){const b=this.binders[d];return b instanceof Hn||b instanceof gn?b.maxValue:0}populatePaintArrays(d,b,E,S,k,P){for(const F in this.binders){const $=this.binders[F];($ instanceof Hn||$ instanceof gn||$ instanceof xo)&&$.populatePaintArray(d,b,E,S,k,P)}}setConstantPatternPositions(d,b){for(const E in this.binders){const S=this.binders[E];S instanceof qs&&S.setConstantPatternPositions(d,b)}}updatePaintArrays(d,b,E,S,k,P){let F=!1;for(const $ in d){const V=b.getPositions($);for(const Z of V){const X=E.feature(Z.index);for(const W in this.binders){const ne=this.binders[W];if((ne instanceof Hn||ne instanceof gn||ne instanceof xo)&&ne.expression.isStateDependent===!0){const ce=S.paint.get(W);ne.expression=ce.value,ne.updatePaintArray(Z.start,Z.end,X,d[$],k,P),F=!0}}}}return F}defines(){const d=[];for(const b in this.binders){const E=this.binders[b];(E instanceof qa||E instanceof qs)&&d.push(...E.uniformNames.map(S=>`#define HAS_UNIFORM_${S}`))}return d}getBinderAttributes(){const d=[];for(const b in this.binders){const E=this.binders[b];if(E instanceof Hn||E instanceof gn||E instanceof xo)for(let S=0;S<E.paintVertexAttributes.length;S++)d.push(E.paintVertexAttributes[S].name)}return d}getBinderUniforms(){const d=[];for(const b in this.binders){const E=this.binders[b];if(E instanceof qa||E instanceof qs||E instanceof gn)for(const S of E.uniformNames)d.push(S)}return d}getPaintVertexBuffers(){return this._buffers}getUniforms(d,b){const E=[];for(const S in this.binders){const k=this.binders[S];if(k instanceof qa||k instanceof qs||k instanceof gn){for(const P of k.uniformNames)if(b[P]){const F=k.getBinding(d,b[P],P);E.push({name:P,property:S,binding:F})}}}return E}setUniforms(d,b,E,S){for(const{name:k,property:P,binding:F}of b)this.binders[P].setUniform(F,S,E.get(P),k)}updatePaintBuffers(d){this._buffers=[];for(const b in this.binders){const E=this.binders[b];if(d&&E instanceof xo){const S=d.fromScale===2?E.zoomInPaintVertexBuffer:E.zoomOutPaintVertexBuffer;S&&this._buffers.push(S)}else(E instanceof Hn||E instanceof gn)&&E.paintVertexBuffer&&this._buffers.push(E.paintVertexBuffer)}}upload(d){for(const b in this.binders){const E=this.binders[b];(E instanceof Hn||E instanceof gn||E instanceof xo)&&E.upload(d)}this.updatePaintBuffers()}destroy(){for(const d in this.binders){const b=this.binders[d];(b instanceof Hn||b instanceof gn||b instanceof xo)&&b.destroy()}}}class Jo{constructor(d,b,E=()=>!0){this.programConfigurations={};for(const S of d)this.programConfigurations[S.id]=new Wn(S,b,E);this.needsUpload=!1,this._featureMap=new ih,this._bufferOffset=0}populatePaintArrays(d,b,E,S,k,P,F){for(const $ in this.programConfigurations)this.programConfigurations[$].populatePaintArrays(d,b,S,k,P,F);b.id!==void 0&&this._featureMap.add(b.id,E,this._bufferOffset,d),this._bufferOffset=d,this.needsUpload=!0}updatePaintArrays(d,b,E,S,k){for(const P of E)this.needsUpload=this.programConfigurations[P.id].updatePaintArrays(d,this._featureMap,b,P,S,k)||this.needsUpload}get(d){return this.programConfigurations[d]}upload(d){if(this.needsUpload){for(const b in this.programConfigurations)this.programConfigurations[b].upload(d);this.needsUpload=!1}}destroy(){for(const d in this.programConfigurations)this.programConfigurations[d].destroy()}}const sf={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function af(x,d){return sf[x]||[x.replace(`${d}-`,"").replace(/-/g,"_")]}const lf={"line-pattern":{source:ai,composite:ai},"fill-pattern":{source:ai,composite:ai},"fill-extrusion-pattern":{source:ai,composite:ai},"line-dasharray":{source:Wt,composite:Wt}},hf={color:{source:Yi,composite:Gr},number:{source:Xi,composite:Yi}};function iu(x,d,b){const E=lf[x];return E&&E[b]||hf[d][b]}Ft("ConstantBinder",qa),Ft("CrossFadedConstantBinder",qs),Ft("SourceExpressionBinder",Hn),Ft("CrossFadedCompositeBinder",xo),Ft("CompositeExpressionBinder",gn),Ft("ProgramConfiguration",Wn,{omit:["_buffers"]}),Ft("ProgramConfigurationSet",Jo);const oh="-transition";class _n extends gt{constructor(d,b){if(super(),this.id=d.id,this.type=d.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,d.type!=="custom"&&(this.metadata=(d=d).metadata,this.minzoom=d.minzoom,this.maxzoom=d.maxzoom,d.type!=="background"&&d.type!=="sky"&&(this.source=d.source,this.sourceLayer=d["source-layer"],this.filter=d.filter),b.layout&&(this._unevaluatedLayout=new ve(b.layout)),b.paint)){this._transitionablePaint=new Te(b.paint);for(const E in d.paint)this.setPaintProperty(E,d.paint[E],{validate:!1});for(const E in d.layout)this.setLayoutProperty(E,d.layout[E],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new De(b.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(d){return d==="visibility"?this.visibility:this._unevaluatedLayout.getValue(d)}setLayoutProperty(d,b,E={}){b!=null&&this._validate(Ol,`layers.${this.id}.layout.${d}`,d,b,E)||(d!=="visibility"?this._unevaluatedLayout.setValue(d,b):this.visibility=b)}getPaintProperty(d){return St(d,oh)?this._transitionablePaint.getTransition(d.slice(0,-oh.length)):this._transitionablePaint.getValue(d)}setPaintProperty(d,b,E={}){if(b!=null&&this._validate(Fs,`layers.${this.id}.paint.${d}`,d,b,E))return!1;if(St(d,oh))return this._transitionablePaint.setTransition(d.slice(0,-oh.length),b||void 0),!1;{const S=this._transitionablePaint._values[d],k=S.property.specification["property-type"]==="cross-faded-data-driven",P=S.value.isDataDriven(),F=S.value;this._transitionablePaint.setValue(d,b),this._handleSpecialPaintPropertyUpdate(d);const $=this._transitionablePaint._values[d].value;return $.isDataDriven()||P||k||this._handleOverridablePaintPropertyUpdate(d,F,$)}}_handleSpecialPaintPropertyUpdate(d){}getProgramIds(){return null}getProgramConfiguration(d){return null}_handleOverridablePaintPropertyUpdate(d,b,E){return!1}isHidden(d){return!!(this.minzoom&&d<this.minzoom)||!!(this.maxzoom&&d>=this.maxzoom)||this.visibility==="none"}updateTransitions(d){this._transitioningPaint=this._transitionablePaint.transitioned(d,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(d,b){d.getCrossfadeParameters&&(this._crossfadeParameters=d.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(d,void 0,b)),this.paint=this._transitioningPaint.possiblyEvaluate(d,void 0,b)}serialize(){const d={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(d.layout=d.layout||{},d.layout.visibility=this.visibility),Dt(d,(b,E)=>!(b===void 0||E==="layout"&&!Object.keys(b).length||E==="paint"&&!Object.keys(b).length))}_validate(d,b,E,S,k={}){return(!k||k.validate!==!1)&&$l(this,d.call(Xn,{key:b,layerType:this.type,objectKey:E,value:S,styleSpec:Ve,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const d in this.paint._values){const b=this.paint.get(d);if(b instanceof ke&&Mn(b.property.specification)&&(b.value.kind==="source"||b.value.kind==="composite")&&b.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Oo(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const cf=We([{name:"a_pos",components:2,type:"Int16"}],4),{members:uf}=cf;class Tr{constructor(d=[]){this.segments=d}prepareSegment(d,b,E,S){let k=this.segments[this.segments.length-1];return d>Tr.MAX_VERTEX_ARRAY_LENGTH&&ft(`Max vertices per segment is ${Tr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${d}`),(!k||k.vertexLength+d>Tr.MAX_VERTEX_ARRAY_LENGTH||k.sortKey!==S)&&(k={vertexOffset:b.length,primitiveOffset:E.length,vertexLength:0,primitiveLength:0},S!==void 0&&(k.sortKey=S),this.segments.push(k)),k}get(){return this.segments}destroy(){for(const d of this.segments)for(const b in d.vaos)d.vaos[b].destroy()}static simpleSegment(d,b,E,S){return new Tr([{vertexOffset:d,primitiveOffset:b,vertexLength:E,primitiveLength:S,vaos:{},sortKey:0}])}}Tr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ft("SegmentVector",Tr);var ki=8192;class Qo{constructor(d,b){d&&(b?this.setSouthWest(d).setNorthEast(b):d.length===4?this.setSouthWest([d[0],d[1]]).setNorthEast([d[2],d[3]]):this.setSouthWest(d[0]).setNorthEast(d[1]))}setNorthEast(d){return this._ne=d instanceof Ni?new Ni(d.lng,d.lat):Ni.convert(d),this}setSouthWest(d){return this._sw=d instanceof Ni?new Ni(d.lng,d.lat):Ni.convert(d),this}extend(d){const b=this._sw,E=this._ne;let S,k;if(d instanceof Ni)S=d,k=d;else{if(!(d instanceof Qo))return Array.isArray(d)?d.length===4||d.every(Array.isArray)?this.extend(Qo.convert(d)):this.extend(Ni.convert(d)):this;if(S=d._sw,k=d._ne,!S||!k)return this}return b||E?(b.lng=Math.min(S.lng,b.lng),b.lat=Math.min(S.lat,b.lat),E.lng=Math.max(k.lng,E.lng),E.lat=Math.max(k.lat,E.lat)):(this._sw=new Ni(S.lng,S.lat),this._ne=new Ni(k.lng,k.lat)),this}getCenter(){return new Ni((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Ni(this.getWest(),this.getNorth())}getSouthEast(){return new Ni(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(d){const{lng:b,lat:E}=Ni.convert(d);let S=this._sw.lng<=b&&b<=this._ne.lng;return this._sw.lng>this._ne.lng&&(S=this._sw.lng>=b&&b>=this._ne.lng),this._sw.lat<=E&&E<=this._ne.lat&&S}static convert(d){return!d||d instanceof Qo?d:new Qo(d)}}const ru=63710088e-1;class Ni{constructor(d,b){if(isNaN(d)||isNaN(b))throw new Error(`Invalid LngLat object: (${d}, ${b})`);if(this.lng=+d,this.lat=+b,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ni(ue(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(d){const b=Math.PI/180,E=this.lat*b,S=d.lat*b,k=Math.sin(E)*Math.sin(S)+Math.cos(E)*Math.cos(S)*Math.cos((d.lng-this.lng)*b);return ru*Math.acos(Math.min(k,1))}toBounds(d=0){const b=360*d/40075017,E=b/Math.cos(Math.PI/180*this.lat);return new Qo(new Ni(this.lng-E,this.lat-b),new Ni(this.lng+E,this.lat+b))}static convert(d){if(d instanceof Ni)return d;if(Array.isArray(d)&&(d.length===2||d.length===3))return new Ni(Number(d[0]),Number(d[1]));if(!Array.isArray(d)&&typeof d=="object"&&d!==null)return new Ni(Number("lng"in d?d.lng:d.lon),Number(d.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const nu=2*Math.PI*ru;function ou(x){return nu*Math.cos(x*Math.PI/180)}function Qh(x){return(180+x)/360}function ec(x){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+x*Math.PI/360)))/360}function tc(x,d){return x/ou(d)}function es(x){return 360*x-180}function Pn(x){return 360/Math.PI*Math.atan(Math.exp((180-360*x)*Math.PI/180))-90}function ic(x,d){return x*ou(Pn(d))}const vo=85.051129;class sh{constructor(d,b,E=0){this.x=+d,this.y=+b,this.z=+E}static fromLngLat(d,b=0){const E=Ni.convert(d);return new sh(Qh(E.lng),ec(E.lat),tc(b,E.lat))}toLngLat(){return new Ni(es(this.x),Pn(this.y))}toAltitude(){return ic(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/nu*(d=Pn(this.y),1/Math.cos(d*Math.PI/180));var d}}function rc(x,d,b,E,S,k,P,F,$){const V=(d+E)/2,Z=(b+S)/2,X=new N(V,Z);F(X),function(W,ne,ce,ye,Me,Ce){const ze=ce-Me,$e=ye-Ce;return Math.abs((ye-ne)*ze-(ce-W)*$e)/Math.hypot(ze,$e)}(X.x,X.y,k.x,k.y,P.x,P.y)>=$?(rc(x,d,b,V,Z,k,X,F,$),rc(x,V,Z,E,S,X,P,F,$)):x.push(P)}function df(x,d,b){const E=[];let S,k,P;for(const F of x){const{x:$,y:V}=F;d(F),P?rc(E,S,k,$,V,P,F,d,b):E.push(F),S=$,k=V,P=F}return E}const nc=Math.pow(2,14)-1,su=-nc-1;function ff(x,d){const b=Math.round(x.x*d),E=Math.round(x.y*d);return x.x=ge(b,su,nc),x.y=ge(E,su,nc),(b<x.x||b>x.x+1||E<x.y||E>x.y+1)&&ft("Geometry exceeds allowed extent, reduce your vector tile buffer size"),x}function Kn(x,d,b){const E=x.loadGeometry(),S=x.extent,k=ki/S;if(d&&b&&b.projection.name!=="mercator"){const P=1<<d.z,{scale:F,x:$,y:V,projection:Z}=b,X=W=>{const ne=es((d.x+W.x/S)/P),ce=Pn((d.y+W.y/S)/P),ye=Z.project(ne,ce);W.x=(ye.x*F-$)*S,W.y=(ye.y*F-V)*S};for(let W=0;W<E.length;W++)if(x.type!==1)E[W]=df(E[W],X,1);else{const ne=[];for(const ce of E[W])ce.x<0||ce.x>=S||ce.y<0||ce.y>=S||(X(ce),ne.push(ce));E[W]=ne}}for(const P of E)for(const F of P)ff(F,k);return E}function ts(x,d){return{type:x.type,id:x.id,properties:x.properties,geometry:d?Kn(x):[]}}function ah(x,d,b,E,S){x.emplaceBack(2*d+(E+1)/2,2*b+(S+1)/2)}class oc{constructor(d){this.zoom=d.zoom,this.overscaling=d.overscaling,this.layers=d.layers,this.layerIds=this.layers.map(b=>b.id),this.index=d.index,this.hasPattern=!1,this.layoutVertexArray=new Ot,this.indexArray=new lr,this.segments=new Tr,this.programConfigurations=new Jo(d.layers,d.zoom),this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id)}populate(d,b,E,S){const k=this.layers[0],P=[];let F=null;k.type==="circle"&&(F=k.layout.get("circle-sort-key"));for(const{feature:$,id:V,index:Z,sourceLayerIndex:X}of d){const W=this.layers[0]._featureFilter.needGeometry,ne=ts($,W);if(!this.layers[0]._featureFilter.filter(new ie(this.zoom),ne,E))continue;const ce=F?F.evaluate(ne,{},E):void 0,ye={id:V,properties:$.properties,type:$.type,sourceLayerIndex:X,index:Z,geometry:W?ne.geometry:Kn($,E,S),patterns:{},sortKey:ce};P.push(ye)}F&&P.sort(($,V)=>$.sortKey-V.sortKey);for(const $ of P){const{geometry:V,index:Z,sourceLayerIndex:X}=$,W=d[Z].feature;this.addFeature($,V,Z,b.availableImages,E),b.featureIndex.insert(W,V,Z,X,this.index)}}update(d,b,E,S){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(d,b,this.stateDependentLayers,E,S)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(d){this.uploaded||(this.layoutVertexBuffer=d.createVertexBuffer(this.layoutVertexArray,uf),this.indexBuffer=d.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(d),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(d,b,E,S,k){for(const P of b)for(const F of P){const $=F.x,V=F.y;if($<0||$>=ki||V<0||V>=ki)continue;const Z=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,d.sortKey),X=Z.vertexLength;ah(this.layoutVertexArray,$,V,-1,-1),ah(this.layoutVertexArray,$,V,1,-1),ah(this.layoutVertexArray,$,V,1,1),ah(this.layoutVertexArray,$,V,-1,1),this.indexArray.emplaceBack(X,X+1,X+2),this.indexArray.emplaceBack(X,X+3,X+2),Z.vertexLength+=4,Z.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,d,E,{},S,k)}}function au(x,d){for(let b=0;b<x.length;b++)if(Zs(d,x[b]))return!0;for(let b=0;b<d.length;b++)if(Zs(x,d[b]))return!0;return!!sc(x,d)}function pf(x,d,b){return!!Zs(x,d)||!!ac(d,x,b)}function lu(x,d){if(x.length===1)return cu(d,x[0]);for(let b=0;b<d.length;b++){const E=d[b];for(let S=0;S<E.length;S++)if(Zs(x,E[S]))return!0}for(let b=0;b<x.length;b++)if(cu(d,x[b]))return!0;for(let b=0;b<d.length;b++)if(sc(x,d[b]))return!0;return!1}function mf(x,d,b){if(x.length>1){if(sc(x,d))return!0;for(let E=0;E<d.length;E++)if(ac(d[E],x,b))return!0}for(let E=0;E<x.length;E++)if(ac(x[E],d,b))return!0;return!1}function sc(x,d){if(x.length===0||d.length===0)return!1;for(let b=0;b<x.length-1;b++){const E=x[b],S=x[b+1];for(let k=0;k<d.length-1;k++)if(gf(E,S,d[k],d[k+1]))return!0}return!1}function gf(x,d,b,E){return wt(x,b,E)!==wt(d,b,E)&&wt(x,d,b)!==wt(x,d,E)}function ac(x,d,b){const E=b*b;if(d.length===1)return x.distSqr(d[0])<E;for(let S=1;S<d.length;S++)if(hu(x,d[S-1],d[S])<E)return!0;return!1}function hu(x,d,b){const E=d.distSqr(b);if(E===0)return x.distSqr(d);const S=((x.x-d.x)*(b.x-d.x)+(x.y-d.y)*(b.y-d.y))/E;return x.distSqr(S<0?d:S>1?b:b.sub(d)._mult(S)._add(d))}function cu(x,d){let b,E,S,k=!1;for(let P=0;P<x.length;P++){b=x[P];for(let F=0,$=b.length-1;F<b.length;$=F++)E=b[F],S=b[$],E.y>d.y!=S.y>d.y&&d.x<(S.x-E.x)*(d.y-E.y)/(S.y-E.y)+E.x&&(k=!k)}return k}function Zs(x,d){let b=!1;for(let E=0,S=x.length-1;E<x.length;S=E++){const k=x[E],P=x[S];k.y>d.y!=P.y>d.y&&d.x<(P.x-k.x)*(d.y-k.y)/(P.y-k.y)+k.x&&(b=!b)}return b}function uu(x,d,b,E,S){for(const P of x)if(d<=P.x&&b<=P.y&&E>=P.x&&S>=P.y)return!0;const k=[new N(d,b),new N(d,S),new N(E,S),new N(E,b)];if(x.length>2){for(const P of k)if(Zs(x,P))return!0}for(let P=0;P<x.length-1;P++)if(_f(x[P],x[P+1],k))return!0;return!1}function _f(x,d,b){const E=b[0],S=b[2];if(x.x<E.x&&d.x<E.x||x.x>S.x&&d.x>S.x||x.y<E.y&&d.y<E.y||x.y>S.y&&d.y>S.y)return!1;const k=wt(x,d,b[0]);return k!==wt(x,d,b[1])||k!==wt(x,d,b[2])||k!==wt(x,d,b[3])}function Xs(x,d,b){const E=d.paint.get(x).value;return E.kind==="constant"?E.value:b.programConfigurations.get(d.id).getMaxValue(x)}function lh(x){return Math.sqrt(x[0]*x[0]+x[1]*x[1])}function du(x,d,b,E,S){if(!d[0]&&!d[1])return x;const k=N.convert(d)._mult(S);b==="viewport"&&k._rotate(-E);const P=[];for(let F=0;F<x.length;F++)P.push(x[F].sub(k));return P}function fu(x,d,b,E){const S=N.convert(x)._mult(E);return d==="viewport"&&S._rotate(-b),S}Ft("CircleBucket",oc,{omit:["layers"]});const yf=new rt({"circle-sort-key":new Pe(Ve.layout_circle["circle-sort-key"])});var xf={paint:new rt({"circle-radius":new Pe(Ve.paint_circle["circle-radius"]),"circle-color":new Pe(Ve.paint_circle["circle-color"]),"circle-blur":new Pe(Ve.paint_circle["circle-blur"]),"circle-opacity":new Pe(Ve.paint_circle["circle-opacity"]),"circle-translate":new Ee(Ve.paint_circle["circle-translate"]),"circle-translate-anchor":new Ee(Ve.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ee(Ve.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ee(Ve.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Pe(Ve.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Pe(Ve.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Pe(Ve.paint_circle["circle-stroke-opacity"])}),layout:yf},Nr=typeof Float32Array!="undefined"?Float32Array:Array;function pu(){var x=new Nr(9);return Nr!=Float32Array&&(x[1]=0,x[2]=0,x[3]=0,x[5]=0,x[6]=0,x[7]=0),x[0]=1,x[4]=1,x[8]=1,x}function lc(x){return x[0]=1,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=1,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=1,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function mu(x,d,b){var E=d[0],S=d[1],k=d[2],P=d[3],F=d[4],$=d[5],V=d[6],Z=d[7],X=d[8],W=d[9],ne=d[10],ce=d[11],ye=d[12],Me=d[13],Ce=d[14],ze=d[15],$e=b[0],qe=b[1],Ge=b[2],Ye=b[3];return x[0]=$e*E+qe*F+Ge*X+Ye*ye,x[1]=$e*S+qe*$+Ge*W+Ye*Me,x[2]=$e*k+qe*V+Ge*ne+Ye*Ce,x[3]=$e*P+qe*Z+Ge*ce+Ye*ze,x[4]=($e=b[4])*E+(qe=b[5])*F+(Ge=b[6])*X+(Ye=b[7])*ye,x[5]=$e*S+qe*$+Ge*W+Ye*Me,x[6]=$e*k+qe*V+Ge*ne+Ye*Ce,x[7]=$e*P+qe*Z+Ge*ce+Ye*ze,x[8]=($e=b[8])*E+(qe=b[9])*F+(Ge=b[10])*X+(Ye=b[11])*ye,x[9]=$e*S+qe*$+Ge*W+Ye*Me,x[10]=$e*k+qe*V+Ge*ne+Ye*Ce,x[11]=$e*P+qe*Z+Ge*ce+Ye*ze,x[12]=($e=b[12])*E+(qe=b[13])*F+(Ge=b[14])*X+(Ye=b[15])*ye,x[13]=$e*S+qe*$+Ge*W+Ye*Me,x[14]=$e*k+qe*V+Ge*ne+Ye*Ce,x[15]=$e*P+qe*Z+Ge*ce+Ye*ze,x}Math.hypot||(Math.hypot=function(){for(var x=0,d=arguments.length;d--;)x+=arguments[d]*arguments[d];return Math.sqrt(x)});var vf=mu;function hh(){var x=new Nr(3);return Nr!=Float32Array&&(x[0]=0,x[1]=0,x[2]=0),x}function gu(x){return Math.hypot(x[0],x[1],x[2])}function Ys(x,d,b){var E=new Nr(3);return E[0]=x,E[1]=d,E[2]=b,E}function _u(x,d,b){return x[0]=d[0]-b[0],x[1]=d[1]-b[1],x[2]=d[2]-b[2],x}function yu(x,d,b){return x[0]=d[0]*b[0],x[1]=d[1]*b[1],x[2]=d[2]*b[2],x}function xu(x,d,b,E){return x[0]=d[0]+b[0]*E,x[1]=d[1]+b[1]*E,x[2]=d[2]+b[2]*E,x}function vu(x,d){var b=d[0],E=d[1],S=d[2],k=b*b+E*E+S*S;return k>0&&(k=1/Math.sqrt(k)),x[0]=d[0]*k,x[1]=d[1]*k,x[2]=d[2]*k,x}function bu(x,d,b){var E=b[0],S=b[1],k=b[2],P=d[0],F=d[1],$=d[2],V=S*$-k*F,Z=k*P-E*$,X=E*F-S*P,W=S*X-k*Z,ne=k*V-E*X,ce=E*Z-S*V,ye=2*b[3];return Z*=ye,X*=ye,ne*=2,ce*=2,x[0]=P+(V*=ye)+(W*=2),x[1]=F+Z+ne,x[2]=$+X+ce,x}var Za,bf=_u,wf=yu,Ef=gu;function Xa(x,d,b){var E=d[0],S=d[1],k=d[2],P=d[3];return x[0]=b[0]*E+b[4]*S+b[8]*k+b[12]*P,x[1]=b[1]*E+b[5]*S+b[9]*k+b[13]*P,x[2]=b[2]*E+b[6]*S+b[10]*k+b[14]*P,x[3]=b[3]*E+b[7]*S+b[11]*k+b[15]*P,x}function hc(){var x=new Nr(4);return Nr!=Float32Array&&(x[0]=0,x[1]=0,x[2]=0),x[3]=1,x}function wu(x){return x[0]=0,x[1]=0,x[2]=0,x[3]=1,x}function Eu(x,d,b){b*=.5;var E=d[0],S=d[1],k=d[2],P=d[3],F=Math.sin(b),$=Math.cos(b);return x[0]=E*$+P*F,x[1]=S*$+k*F,x[2]=k*$-S*F,x[3]=P*$-E*F,x}function Tu(x,d){return x[0]===d[0]&&x[1]===d[1]}function Mu(x,d,b,E,S,k,P,F,$){if(k&&x.queryGeometry.isAboveHorizon)return!1;k&&($*=x.pixelToTileUnitsFactor);for(const V of d)for(const Z of V){const X=Z.add(F),W=S&&b.elevation?b.elevation.exaggeration()*S.getElevationAt(X.x,X.y,!0):0,ne=k?X:Tf(X,W,E),ce=k?x.tilespaceRays.map(Me=>Sf(Me,W)):x.queryGeometry.screenGeometry,ye=Xa([],[Z.x,Z.y,W,1],E);if(!P&&k?$*=ye[3]/b.cameraToCenterDistance:P&&!k&&($*=b.cameraToCenterDistance/ye[3]),pf(ce,ne,$))return!0}return!1}function Tf(x,d,b){const E=Xa([],[x.x,x.y,d,1],b);return new N(E[0]/E[3],E[1]/E[3])}hh(),Za=new Nr(4),Nr!=Float32Array&&(Za[0]=0,Za[1]=0,Za[2]=0,Za[3]=0),hh(),Ys(1,0,0),Ys(0,1,0),hc(),hc(),pu(),function(){var x;x=new Nr(2),Nr!=Float32Array&&(x[0]=0,x[1]=0)}();const Su=Ys(0,0,0),Mf=Ys(0,0,1);function Sf(x,d){const b=hh();return Su[2]=d,x.intersectsPlane(Su,Mf,b),new N(b[0],b[1])}class Au extends oc{}function cc(x,{width:d,height:b},E,S){if(S){if(S instanceof Uint8ClampedArray)S=new Uint8Array(S.buffer);else if(S.length!==d*b*E)throw new RangeError("mismatched image size")}else S=new Uint8Array(d*b*E);return x.width=d,x.height=b,x.data=S,x}function Iu(x,{width:d,height:b},E){if(d===x.width&&b===x.height)return;const S=cc({},{width:d,height:b},E);uc(x,S,{x:0,y:0},{x:0,y:0},{width:Math.min(x.width,d),height:Math.min(x.height,b)},E),x.width=d,x.height=b,x.data=S.data}function uc(x,d,b,E,S,k){if(S.width===0||S.height===0)return d;if(S.width>x.width||S.height>x.height||b.x>x.width-S.width||b.y>x.height-S.height)throw new RangeError("out of range source coordinates for image copy");if(S.width>d.width||S.height>d.height||E.x>d.width-S.width||E.y>d.height-S.height)throw new RangeError("out of range destination coordinates for image copy");const P=x.data,F=d.data;for(let $=0;$<S.height;$++){const V=((b.y+$)*x.width+b.x)*k,Z=((E.y+$)*d.width+E.x)*k;for(let X=0;X<S.width*k;X++)F[Z+X]=P[V+X]}return d}Ft("HeatmapBucket",Au,{omit:["layers"]});class bo{constructor(d,b){cc(this,d,1,b)}resize(d){Iu(this,d,1)}clone(){return new bo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(d,b,E,S,k){uc(d,b,E,S,k,1)}}class on{constructor(d,b){cc(this,d,4,b)}resize(d){Iu(this,d,4)}replace(d,b){b?this.data.set(d):this.data=d instanceof Uint8ClampedArray?new Uint8Array(d.buffer):d}clone(){return new on({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(d,b,E,S,k){uc(d,b,E,S,k,4)}}Ft("AlphaImage",bo),Ft("RGBAImage",on);var Af={paint:new rt({"heatmap-radius":new Pe(Ve.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Pe(Ve.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ee(Ve.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Ke(Ve.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ee(Ve.paint_heatmap["heatmap-opacity"])})};function dc(x){const d={},b=x.resolution||256,E=x.clips?x.clips.length:1,S=x.image||new on({width:b,height:E}),k=(P,F,$)=>{d[x.evaluationKey]=$;const V=x.expression.evaluate(d);S.data[P+F+0]=Math.floor(255*V.r/V.a),S.data[P+F+1]=Math.floor(255*V.g/V.a),S.data[P+F+2]=Math.floor(255*V.b/V.a),S.data[P+F+3]=Math.floor(255*V.a)};if(x.clips)for(let P=0,F=0;P<E;++P,F+=4*b)for(let $=0,V=0;$<b;$++,V+=4){const Z=$/(b-1),{start:X,end:W}=x.clips[P];k(F,V,X*(1-Z)+W*Z)}else for(let P=0,F=0;P<b;P++,F+=4)k(0,F,P/(b-1));return S}var If={paint:new rt({"hillshade-illumination-direction":new Ee(Ve.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ee(Ve.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ee(Ve.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ee(Ve.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ee(Ve.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ee(Ve.paint_hillshade["hillshade-accent-color"])})};const kf=We([{name:"a_pos",components:2,type:"Int16"}],4),{members:Cf}=kf;var ch=uh,Df=uh;function uh(x,d,b){b=b||2;var E,S,k,P,F,$,V,Z=d&&d.length,X=Z?d[0]*b:x.length,W=ku(x,0,X,b,!0),ne=[];if(!W||W.next===W.prev)return ne;if(Z&&(W=function(ye,Me,Ce,ze){var $e,qe,Ge,Ye=[];for($e=0,qe=Me.length;$e<qe;$e++)(Ge=ku(ye,Me[$e]*ze,$e<qe-1?Me[$e+1]*ze:ye.length,ze,!1))===Ge.next&&(Ge.steiner=!0),Ye.push($f(Ge));for(Ye.sort(zf),$e=0;$e<Ye.length;$e++)Ce=wo(Ce=Ff(Ye[$e],Ce),Ce.next);return Ce}(x,d,W,b)),x.length>80*b){E=k=x[0],S=P=x[1];for(var ce=b;ce<X;ce+=b)(F=x[ce])<E&&(E=F),($=x[ce+1])<S&&(S=$),F>k&&(k=F),$>P&&(P=$);V=(V=Math.max(k-E,P-S))!==0?1/V:0}return Ya(W,ne,b,E,S,V),ne}function ku(x,d,b,E,S){var k,P;if(S===mc(x,d,b,E)>0)for(k=d;k<b;k+=E)P=Pu(k,x[k],x[k+1],P);else for(k=b-E;k>=d;k-=E)P=Pu(k,x[k],x[k+1],P);return P&&dh(P,P.next)&&(Wa(P),P=P.next),P}function wo(x,d){if(!x)return x;d||(d=x);var b,E=x;do if(b=!1,E.steiner||!dh(E,E.next)&&nr(E.prev,E,E.next)!==0)E=E.next;else{if(Wa(E),(E=d=E.prev)===E.next)break;b=!0}while(b||E!==d);return d}function Ya(x,d,b,E,S,k,P){if(x){!P&&k&&function(Z,X,W,ne){var ce=Z;do ce.z===null&&(ce.z=fc(ce.x,ce.y,X,W,ne)),ce.prevZ=ce.prev,ce.nextZ=ce.next,ce=ce.next;while(ce!==Z);ce.prevZ.nextZ=null,ce.prevZ=null,function(ye){var Me,Ce,ze,$e,qe,Ge,Ye,ot,et=1;do{for(Ce=ye,ye=null,qe=null,Ge=0;Ce;){for(Ge++,ze=Ce,Ye=0,Me=0;Me<et&&(Ye++,ze=ze.nextZ);Me++);for(ot=et;Ye>0||ot>0&&ze;)Ye!==0&&(ot===0||!ze||Ce.z<=ze.z)?($e=Ce,Ce=Ce.nextZ,Ye--):($e=ze,ze=ze.nextZ,ot--),qe?qe.nextZ=$e:ye=$e,$e.prevZ=qe,qe=$e;Ce=ze}qe.nextZ=null,et*=2}while(Ge>1)}(ce)}(x,E,S,k);for(var F,$,V=x;x.prev!==x.next;)if(F=x.prev,$=x.next,k?Rf(x,E,S,k):Pf(x))d.push(F.i/b),d.push(x.i/b),d.push($.i/b),Wa(x),x=$.next,V=$.next;else if((x=$)===V){P?P===1?Ya(x=Bf(wo(x),d,b),d,b,E,S,k,2):P===2&&Lf(x,d,b,E,S,k):Ya(wo(x),d,b,E,S,k,1);break}}}function Pf(x){var d=x.prev,b=x,E=x.next;if(nr(d,b,E)>=0)return!1;for(var S=x.next.next;S!==x.prev;){if(Hs(d.x,d.y,b.x,b.y,E.x,E.y,S.x,S.y)&&nr(S.prev,S,S.next)>=0)return!1;S=S.next}return!0}function Rf(x,d,b,E){var S=x.prev,k=x,P=x.next;if(nr(S,k,P)>=0)return!1;for(var F=S.x>k.x?S.x>P.x?S.x:P.x:k.x>P.x?k.x:P.x,$=S.y>k.y?S.y>P.y?S.y:P.y:k.y>P.y?k.y:P.y,V=fc(S.x<k.x?S.x<P.x?S.x:P.x:k.x<P.x?k.x:P.x,S.y<k.y?S.y<P.y?S.y:P.y:k.y<P.y?k.y:P.y,d,b,E),Z=fc(F,$,d,b,E),X=x.prevZ,W=x.nextZ;X&&X.z>=V&&W&&W.z<=Z;){if(X!==x.prev&&X!==x.next&&Hs(S.x,S.y,k.x,k.y,P.x,P.y,X.x,X.y)&&nr(X.prev,X,X.next)>=0||(X=X.prevZ,W!==x.prev&&W!==x.next&&Hs(S.x,S.y,k.x,k.y,P.x,P.y,W.x,W.y)&&nr(W.prev,W,W.next)>=0))return!1;W=W.nextZ}for(;X&&X.z>=V;){if(X!==x.prev&&X!==x.next&&Hs(S.x,S.y,k.x,k.y,P.x,P.y,X.x,X.y)&&nr(X.prev,X,X.next)>=0)return!1;X=X.prevZ}for(;W&&W.z<=Z;){if(W!==x.prev&&W!==x.next&&Hs(S.x,S.y,k.x,k.y,P.x,P.y,W.x,W.y)&&nr(W.prev,W,W.next)>=0)return!1;W=W.nextZ}return!0}function Bf(x,d,b){var E=x;do{var S=E.prev,k=E.next.next;!dh(S,k)&&Cu(S,E,E.next,k)&&Ha(S,k)&&Ha(k,S)&&(d.push(S.i/b),d.push(E.i/b),d.push(k.i/b),Wa(E),Wa(E.next),E=x=k),E=E.next}while(E!==x);return wo(E)}function Lf(x,d,b,E,S,k){var P=x;do{for(var F=P.next.next;F!==P.prev;){if(P.i!==F.i&&Nf(P,F)){var $=Du(P,F);return P=wo(P,P.next),$=wo($,$.next),Ya(P,d,b,E,S,k),void Ya($,d,b,E,S,k)}F=F.next}P=P.next}while(P!==x)}function zf(x,d){return x.x-d.x}function Ff(x,d){var b=function(k,P){var F,$=P,V=k.x,Z=k.y,X=-1/0;do{if(Z<=$.y&&Z>=$.next.y&&$.next.y!==$.y){var W=$.x+(Z-$.y)*($.next.x-$.x)/($.next.y-$.y);if(W<=V&&W>X){if(X=W,W===V){if(Z===$.y)return $;if(Z===$.next.y)return $.next}F=$.x<$.next.x?$:$.next}}$=$.next}while($!==P);if(!F)return null;if(V===X)return F;var ne,ce=F,ye=F.x,Me=F.y,Ce=1/0;$=F;do V>=$.x&&$.x>=ye&&V!==$.x&&Hs(Z<Me?V:X,Z,ye,Me,Z<Me?X:V,Z,$.x,$.y)&&(ne=Math.abs(Z-$.y)/(V-$.x),Ha($,k)&&(ne<Ce||ne===Ce&&($.x>F.x||$.x===F.x&&Of(F,$)))&&(F=$,Ce=ne)),$=$.next;while($!==ce);return F}(x,d);if(!b)return d;var E=Du(b,x),S=wo(b,b.next);return wo(E,E.next),d===b?S:d}function Of(x,d){return nr(x.prev,x,d.prev)<0&&nr(d.next,x,x.next)<0}function fc(x,d,b,E,S){return(x=1431655765&((x=858993459&((x=252645135&((x=16711935&((x=32767*(x-b)*S)|x<<8))|x<<4))|x<<2))|x<<1))|(d=1431655765&((d=858993459&((d=252645135&((d=16711935&((d=32767*(d-E)*S)|d<<8))|d<<4))|d<<2))|d<<1))<<1}function $f(x){var d=x,b=x;do(d.x<b.x||d.x===b.x&&d.y<b.y)&&(b=d),d=d.next;while(d!==x);return b}function Hs(x,d,b,E,S,k,P,F){return(S-P)*(d-F)-(x-P)*(k-F)>=0&&(x-P)*(E-F)-(b-P)*(d-F)>=0&&(b-P)*(k-F)-(S-P)*(E-F)>=0}function Nf(x,d){return x.next.i!==d.i&&x.prev.i!==d.i&&!function(b,E){var S=b;do{if(S.i!==b.i&&S.next.i!==b.i&&S.i!==E.i&&S.next.i!==E.i&&Cu(S,S.next,b,E))return!0;S=S.next}while(S!==b);return!1}(x,d)&&(Ha(x,d)&&Ha(d,x)&&function(b,E){var S=b,k=!1,P=(b.x+E.x)/2,F=(b.y+E.y)/2;do S.y>F!=S.next.y>F&&S.next.y!==S.y&&P<(S.next.x-S.x)*(F-S.y)/(S.next.y-S.y)+S.x&&(k=!k),S=S.next;while(S!==b);return k}(x,d)&&(nr(x.prev,x,d.prev)||nr(x,d.prev,d))||dh(x,d)&&nr(x.prev,x,x.next)>0&&nr(d.prev,d,d.next)>0)}function nr(x,d,b){return(d.y-x.y)*(b.x-d.x)-(d.x-x.x)*(b.y-d.y)}function dh(x,d){return x.x===d.x&&x.y===d.y}function Cu(x,d,b,E){var S=ph(nr(x,d,b)),k=ph(nr(x,d,E)),P=ph(nr(b,E,x)),F=ph(nr(b,E,d));return S!==k&&P!==F||!(S!==0||!fh(x,b,d))||!(k!==0||!fh(x,E,d))||!(P!==0||!fh(b,x,E))||!(F!==0||!fh(b,d,E))}function fh(x,d,b){return d.x<=Math.max(x.x,b.x)&&d.x>=Math.min(x.x,b.x)&&d.y<=Math.max(x.y,b.y)&&d.y>=Math.min(x.y,b.y)}function ph(x){return x>0?1:x<0?-1:0}function Ha(x,d){return nr(x.prev,x,x.next)<0?nr(x,d,x.next)>=0&&nr(x,x.prev,d)>=0:nr(x,d,x.prev)<0||nr(x,x.next,d)<0}function Du(x,d){var b=new pc(x.i,x.x,x.y),E=new pc(d.i,d.x,d.y),S=x.next,k=d.prev;return x.next=d,d.prev=x,b.next=S,S.prev=b,E.next=b,b.prev=E,k.next=E,E.prev=k,E}function Pu(x,d,b,E){var S=new pc(x,d,b);return E?(S.next=E.next,S.prev=E,E.next.prev=S,E.next=S):(S.prev=S,S.next=S),S}function Wa(x){x.next.prev=x.prev,x.prev.next=x.next,x.prevZ&&(x.prevZ.nextZ=x.nextZ),x.nextZ&&(x.nextZ.prevZ=x.prevZ)}function pc(x,d,b){this.i=x,this.x=d,this.y=b,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function mc(x,d,b,E){for(var S=0,k=d,P=b-E;k<b;k+=E)S+=(x[P]-x[k])*(x[k+1]+x[P+1]),P=k;return S}function Uf(x,d,b,E,S){Ru(x,d,b||0,E||x.length-1,S||Vf)}function Ru(x,d,b,E,S){for(;E>b;){if(E-b>600){var k=E-b+1,P=d-b+1,F=Math.log(k),$=.5*Math.exp(2*F/3),V=.5*Math.sqrt(F*$*(k-$)/k)*(P-k/2<0?-1:1);Ru(x,d,Math.max(b,Math.floor(d-P*$/k+V)),Math.min(E,Math.floor(d+(k-P)*$/k+V)),S)}var Z=x[d],X=b,W=E;for(Ka(x,b,d),S(x[E],Z)>0&&Ka(x,b,E);X<W;){for(Ka(x,X,W),X++,W--;S(x[X],Z)<0;)X++;for(;S(x[W],Z)>0;)W--}S(x[b],Z)===0?Ka(x,b,W):Ka(x,++W,E),W<=d&&(b=W+1),d<=W&&(E=W-1)}}function Ka(x,d,b){var E=x[d];x[d]=x[b],x[b]=E}function Vf(x,d){return x<d?-1:x>d?1:0}function gc(x,d){const b=x.length;if(b<=1)return[x];const E=[];let S,k;for(let P=0;P<b;P++){const F=bt(x[P]);F!==0&&(x[P].area=Math.abs(F),k===void 0&&(k=F<0),k===F<0?(S&&E.push(S),S=[x[P]]):S.push(x[P]))}if(S&&E.push(S),d>1)for(let P=0;P<E.length;P++)E[P].length<=d||(Uf(E[P],d,1,E[P].length-1,jf),E[P]=E[P].slice(0,d));return E}function jf(x,d){return d.area-x.area}function _c(x,d,b){const E=b.patternDependencies;let S=!1;for(const k of d){const P=k.paint.get(`${x}-pattern`);P.isConstant()||(S=!0);const F=P.constantOr(null);F&&(S=!0,E[F.to]=!0,E[F.from]=!0)}return S}function yc(x,d,b,E,S){const k=S.patternDependencies;for(const P of d){const F=P.paint.get(`${x}-pattern`).value;if(F.kind!=="constant"){let $=F.evaluate({zoom:E-1},b,{},S.availableImages),V=F.evaluate({zoom:E},b,{},S.availableImages),Z=F.evaluate({zoom:E+1},b,{},S.availableImages);$=$&&$.name?$.name:$,V=V&&V.name?V.name:V,Z=Z&&Z.name?Z.name:Z,k[$]=!0,k[V]=!0,k[Z]=!0,b.patterns[P.id]={min:$,mid:V,max:Z}}}return b}uh.deviation=function(x,d,b,E){var S=d&&d.length,k=Math.abs(mc(x,0,S?d[0]*b:x.length,b));if(S)for(var P=0,F=d.length;P<F;P++)k-=Math.abs(mc(x,d[P]*b,P<F-1?d[P+1]*b:x.length,b));var $=0;for(P=0;P<E.length;P+=3){var V=E[P]*b,Z=E[P+1]*b,X=E[P+2]*b;$+=Math.abs((x[V]-x[X])*(x[Z+1]-x[V+1])-(x[V]-x[Z])*(x[X+1]-x[V+1]))}return k===0&&$===0?0:Math.abs(($-k)/k)},uh.flatten=function(x){for(var d=x[0][0].length,b={vertices:[],holes:[],dimensions:d},E=0,S=0;S<x.length;S++){for(var k=0;k<x[S].length;k++)for(var P=0;P<d;P++)b.vertices.push(x[S][k][P]);S>0&&b.holes.push(E+=x[S-1].length)}return b},ch.default=Df;class mh{constructor(d){this.zoom=d.zoom,this.overscaling=d.overscaling,this.layers=d.layers,this.layerIds=this.layers.map(b=>b.id),this.index=d.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Ot,this.indexArray=new lr,this.indexArray2=new Hi,this.programConfigurations=new Jo(d.layers,d.zoom),this.segments=new Tr,this.segments2=new Tr,this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id)}populate(d,b,E,S){this.hasPattern=_c("fill",this.layers,b);const k=this.layers[0].layout.get("fill-sort-key"),P=[];for(const{feature:F,id:$,index:V,sourceLayerIndex:Z}of d){const X=this.layers[0]._featureFilter.needGeometry,W=ts(F,X);if(!this.layers[0]._featureFilter.filter(new ie(this.zoom),W,E))continue;const ne=k?k.evaluate(W,{},E,b.availableImages):void 0,ce={id:$,properties:F.properties,type:F.type,sourceLayerIndex:Z,index:V,geometry:X?W.geometry:Kn(F,E,S),patterns:{},sortKey:ne};P.push(ce)}k&&P.sort((F,$)=>F.sortKey-$.sortKey);for(const F of P){const{geometry:$,index:V,sourceLayerIndex:Z}=F;if(this.hasPattern){const X=yc("fill",this.layers,F,this.zoom,b);this.patternFeatures.push(X)}else this.addFeature(F,$,V,E,{},b.availableImages);b.featureIndex.insert(d[V].feature,$,V,Z,this.index)}}update(d,b,E,S){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(d,b,this.stateDependentLayers,E,S)}addFeatures(d,b,E,S){for(const k of this.patternFeatures)this.addFeature(k,k.geometry,k.index,b,E,S)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(d){this.uploaded||(this.layoutVertexBuffer=d.createVertexBuffer(this.layoutVertexArray,Cf),this.indexBuffer=d.createIndexBuffer(this.indexArray),this.indexBuffer2=d.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(d),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(d,b,E,S,k,P=[]){for(const F of gc(b,500)){let $=0;for(const ce of F)$+=ce.length;const V=this.segments.prepareSegment($,this.layoutVertexArray,this.indexArray),Z=V.vertexLength,X=[],W=[];for(const ce of F){if(ce.length===0)continue;ce!==F[0]&&W.push(X.length/2);const ye=this.segments2.prepareSegment(ce.length,this.layoutVertexArray,this.indexArray2),Me=ye.vertexLength;this.layoutVertexArray.emplaceBack(ce[0].x,ce[0].y),this.indexArray2.emplaceBack(Me+ce.length-1,Me),X.push(ce[0].x),X.push(ce[0].y);for(let Ce=1;Ce<ce.length;Ce++)this.layoutVertexArray.emplaceBack(ce[Ce].x,ce[Ce].y),this.indexArray2.emplaceBack(Me+Ce-1,Me+Ce),X.push(ce[Ce].x),X.push(ce[Ce].y);ye.vertexLength+=ce.length,ye.primitiveLength+=ce.length}const ne=ch(X,W);for(let ce=0;ce<ne.length;ce+=3)this.indexArray.emplaceBack(Z+ne[ce],Z+ne[ce+1],Z+ne[ce+2]);V.vertexLength+=$,V.primitiveLength+=ne.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,d,E,k,P,S)}}Ft("FillBucket",mh,{omit:["layers","patternFeatures"]});const Gf=new rt({"fill-sort-key":new Pe(Ve.layout_fill["fill-sort-key"])});var qf={paint:new rt({"fill-antialias":new Ee(Ve.paint_fill["fill-antialias"]),"fill-opacity":new Pe(Ve.paint_fill["fill-opacity"]),"fill-color":new Pe(Ve.paint_fill["fill-color"]),"fill-outline-color":new Pe(Ve.paint_fill["fill-outline-color"]),"fill-translate":new Ee(Ve.paint_fill["fill-translate"]),"fill-translate-anchor":new Ee(Ve.paint_fill["fill-translate-anchor"]),"fill-pattern":new Oe(Ve.paint_fill["fill-pattern"])}),layout:Gf};const Zf=We([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Xf=We([{name:"a_centroid_pos",components:2,type:"Uint16"}]),{members:Yf}=Zf;var Bu=Ws;function Ws(x,d,b,E,S){this.properties={},this.extent=b,this.type=0,this._pbf=x,this._geometry=-1,this._keys=E,this._values=S,x.readFields(Hf,this,d)}function Hf(x,d,b){x==1?d.id=b.readVarint():x==2?function(E,S){for(var k=E.readVarint()+E.pos;E.pos<k;){var P=S._keys[E.readVarint()],F=S._values[E.readVarint()];S.properties[P]=F}}(b,d):x==3?d.type=b.readVarint():x==4&&(d._geometry=b.pos)}function Wf(x){for(var d,b,E=0,S=0,k=x.length,P=k-1;S<k;P=S++)E+=((b=x[P]).x-(d=x[S]).x)*(d.y+b.y);return E}Ws.types=["Unknown","Point","LineString","Polygon"],Ws.prototype.loadGeometry=function(){var x=this._pbf;x.pos=this._geometry;for(var d,b=x.readVarint()+x.pos,E=1,S=0,k=0,P=0,F=[];x.pos<b;){if(S<=0){var $=x.readVarint();E=7&$,S=$>>3}if(S--,E===1||E===2)k+=x.readSVarint(),P+=x.readSVarint(),E===1&&(d&&F.push(d),d=[]),d.push(new N(k,P));else{if(E!==7)throw new Error("unknown command "+E);d&&d.push(d[0].clone())}}return d&&F.push(d),F},Ws.prototype.bbox=function(){var x=this._pbf;x.pos=this._geometry;for(var d=x.readVarint()+x.pos,b=1,E=0,S=0,k=0,P=1/0,F=-1/0,$=1/0,V=-1/0;x.pos<d;){if(E<=0){var Z=x.readVarint();b=7&Z,E=Z>>3}if(E--,b===1||b===2)(S+=x.readSVarint())<P&&(P=S),S>F&&(F=S),(k+=x.readSVarint())<$&&($=k),k>V&&(V=k);else if(b!==7)throw new Error("unknown command "+b)}return[P,$,F,V]},Ws.prototype.toGeoJSON=function(x,d,b){var E,S,k=this.extent*Math.pow(2,b),P=this.extent*x,F=this.extent*d,$=this.loadGeometry(),V=Ws.types[this.type];function Z(ne){for(var ce=0;ce<ne.length;ce++){var ye=ne[ce];ne[ce]=[360*(ye.x+P)/k-180,360/Math.PI*Math.atan(Math.exp((180-360*(ye.y+F)/k)*Math.PI/180))-90]}}switch(this.type){case 1:var X=[];for(E=0;E<$.length;E++)X[E]=$[E][0];Z($=X);break;case 2:for(E=0;E<$.length;E++)Z($[E]);break;case 3:for($=function(ne){var ce=ne.length;if(ce<=1)return[ne];for(var ye,Me,Ce=[],ze=0;ze<ce;ze++){var $e=Wf(ne[ze]);$e!==0&&(Me===void 0&&(Me=$e<0),Me===$e<0?(ye&&Ce.push(ye),ye=[ne[ze]]):ye.push(ne[ze]))}return ye&&Ce.push(ye),Ce}($),E=0;E<$.length;E++)for(S=0;S<$[E].length;S++)Z($[E][S])}$.length===1?$=$[0]:V="Multi"+V;var W={type:"Feature",geometry:{type:V,coordinates:$},properties:this.properties};return"id"in this&&(W.id=this.id),W};var Lu=zu;function zu(x,d){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=x,this._keys=[],this._values=[],this._features=[],x.readFields(Kf,this,d),this.length=this._features.length}function Kf(x,d,b){x===15?d.version=b.readVarint():x===1?d.name=b.readString():x===5?d.extent=b.readVarint():x===2?d._features.push(b.pos):x===3?d._keys.push(b.readString()):x===4&&d._values.push(function(E){for(var S=null,k=E.readVarint()+E.pos;E.pos<k;){var P=E.readVarint()>>3;S=P===1?E.readString():P===2?E.readFloat():P===3?E.readDouble():P===4?E.readVarint64():P===5?E.readVarint():P===6?E.readSVarint():P===7?E.readBoolean():null}return S}(b))}function Jf(x,d,b){if(x===3){var E=new Lu(b,b.readVarint()+b.pos);E.length&&(d[E.name]=E)}}zu.prototype.feature=function(x){if(x<0||x>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[x];var d=this._pbf.readVarint()+this._pbf.pos;return new Bu(this._pbf,d,this.extent,this._keys,this._values)};var is={VectorTile:function(x,d){this.layers=x.readFields(Jf,{},d)},VectorTileFeature:Bu,VectorTileLayer:Lu};const Qf=is.VectorTileFeature.types,ep=Math.pow(2,13);function Ja(x,d,b,E,S,k,P,F){x.emplaceBack((d<<1)+P,(b<<1)+k,(Math.floor(E*ep)<<1)+S,Math.round(F))}class Fu{constructor(){this.acc=new N(0,0),this.polyCount=[]}startRing(d){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new N(d.x,d.y),this.max=new N(d.x,d.y))}append(d,b){this.currentPolyCount.edges++,this.acc._add(d);let E=!!this.borders;const S=this.min,k=this.max;d.x<S.x?(S.x=d.x,E=!0):d.x>k.x&&(k.x=d.x,E=!0),d.y<S.y?(S.y=d.y,E=!0):d.y>k.y&&(k.y=d.y,E=!0),((d.x===0||d.x===ki)&&d.x===b.x)!=((d.y===0||d.y===ki)&&d.y===b.y)&&this.processBorderOverlap(d,b),E&&this.checkBorderIntersection(d,b)}checkBorderIntersection(d,b){b.x<0!=d.x<0&&this.addBorderIntersection(0,Pi(b.y,d.y,(0-b.x)/(d.x-b.x))),b.x>ki!=d.x>ki&&this.addBorderIntersection(1,Pi(b.y,d.y,(ki-b.x)/(d.x-b.x))),b.y<0!=d.y<0&&this.addBorderIntersection(2,Pi(b.x,d.x,(0-b.y)/(d.y-b.y))),b.y>ki!=d.y>ki&&this.addBorderIntersection(3,Pi(b.x,d.x,(ki-b.y)/(d.y-b.y)))}addBorderIntersection(d,b){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const E=this.borders[d];b<E[0]&&(E[0]=b),b>E[1]&&(E[1]=b)}processBorderOverlap(d,b){if(d.x===b.x){if(d.y===b.y)return;const E=d.x===0?0:1;this.addBorderIntersection(E,b.y),this.addBorderIntersection(E,d.y)}else{const E=d.y===0?2:3;this.addBorderIntersection(E,b.x),this.addBorderIntersection(E,d.x)}}centroid(){const d=this.polyCount.reduce((b,E)=>b+E.edges,0);return d!==0?this.acc.div(d)._round():new N(0,0)}span(){return new N(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((d,b)=>d+ +(b[0]!==Number.MAX_VALUE),0)}}class xc{constructor(d){this.zoom=d.zoom,this.overscaling=d.overscaling,this.layers=d.layers,this.layerIds=this.layers.map(b=>b.id),this.index=d.index,this.hasPattern=!1,this.layoutVertexArray=new Qt,this.centroidVertexArray=new Kc,this.indexArray=new lr,this.programConfigurations=new Jo(d.layers,d.zoom),this.segments=new Tr,this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id),this.enableTerrain=d.enableTerrain}populate(d,b,E,S){this.features=[],this.hasPattern=_c("fill-extrusion",this.layers,b),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDone=[!1,!1,!1,!1],this.tileToMeter=function(k){const P=Math.exp(Math.PI*(1-k.y/(1<<k.z)*2));return 80150034*P/(P*P+1)/ki/(1<<k.z)}(E);for(const{feature:k,id:P,index:F,sourceLayerIndex:$}of d){const V=this.layers[0]._featureFilter.needGeometry,Z=ts(k,V);if(!this.layers[0]._featureFilter.filter(new ie(this.zoom),Z,E))continue;const X={id:P,sourceLayerIndex:$,index:F,geometry:V?Z.geometry:Kn(k,E,S),properties:k.properties,type:k.type,patterns:{}},W=this.layoutVertexArray.length;this.hasPattern?this.features.push(yc("fill-extrusion",this.layers,X,this.zoom,b)):this.addFeature(X,X.geometry,F,E,{},b.availableImages),b.featureIndex.insert(k,X.geometry,F,$,this.index,W)}this.sortBorders()}addFeatures(d,b,E,S){for(const k of this.features){const{geometry:P}=k;this.addFeature(k,P,k.index,b,E,S)}this.sortBorders()}update(d,b,E,S){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(d,b,this.stateDependentLayers,E,S)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(d){this.uploaded||(this.layoutVertexBuffer=d.createVertexBuffer(this.layoutVertexArray,Yf),this.indexBuffer=d.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(d),this.uploaded=!0}uploadCentroid(d){this.centroidVertexArray.length!==0&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=d.createVertexBuffer(this.centroidVertexArray,Xf.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(d,b,E,S,k,P){const F=this.enableTerrain?new Fu:null;for(const V of gc(b,500)){let Z=0,X=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);if(V.length===0||($=V[0]).every(Me=>Me.x<=0)||$.every(Me=>Me.x>=ki)||$.every(Me=>Me.y<=0)||$.every(Me=>Me.y>=ki))continue;for(let Me=0;Me<V.length;Me++){const Ce=V[Me];if(Ce.length===0)continue;Z+=Ce.length;let ze=0;F&&F.startRing(Ce[0]);for(let $e=0;$e<Ce.length;$e++){const qe=Ce[$e];if($e>=1){const Ge=Ce[$e-1];if(!tp(qe,Ge)){F&&F.append(qe,Ge),X.vertexLength+4>Tr.MAX_VERTEX_ARRAY_LENGTH&&(X=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const Ye=qe.sub(Ge)._perp(),ot=Ye.x/(Math.abs(Ye.x)+Math.abs(Ye.y)),et=Ye.y>0?1:0,At=Ge.dist(qe);ze+At>32768&&(ze=0),Ja(this.layoutVertexArray,qe.x,qe.y,ot,et,0,0,ze),Ja(this.layoutVertexArray,qe.x,qe.y,ot,et,0,1,ze),ze+=At,Ja(this.layoutVertexArray,Ge.x,Ge.y,ot,et,0,0,ze),Ja(this.layoutVertexArray,Ge.x,Ge.y,ot,et,0,1,ze);const ut=X.vertexLength;this.indexArray.emplaceBack(ut,ut+2,ut+1),this.indexArray.emplaceBack(ut+1,ut+2,ut+3),X.vertexLength+=4,X.primitiveLength+=2}}}}if(X.vertexLength+Z>Tr.MAX_VERTEX_ARRAY_LENGTH&&(X=this.segments.prepareSegment(Z,this.layoutVertexArray,this.indexArray)),Qf[d.type]!=="Polygon")continue;const W=[],ne=[],ce=X.vertexLength;for(let Me=0;Me<V.length;Me++){const Ce=V[Me];if(Ce.length!==0){Ce!==V[0]&&ne.push(W.length/2);for(let ze=0;ze<Ce.length;ze++){const $e=Ce[ze];Ja(this.layoutVertexArray,$e.x,$e.y,0,0,1,1,0),W.push($e.x),W.push($e.y),F&&F.currentPolyCount.top++}}}const ye=ch(W,ne);for(let Me=0;Me<ye.length;Me+=3)this.indexArray.emplaceBack(ce+ye[Me],ce+ye[Me+2],ce+ye[Me+1]);X.primitiveLength+=ye.length/3,X.vertexLength+=Z}var $;if(F&&F.polyCount.length>0){if(F.borders){F.vertexArrayOffset=this.centroidVertexArray.length;const V=F.borders,Z=this.featuresOnBorder.push(F)-1;for(let X=0;X<4;X++)V[X][0]!==Number.MAX_VALUE&&this.borders[X].push(Z)}this.encodeCentroid(F.borders?void 0:F.centroid(),F)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,d,E,k,P,S)}sortBorders(){for(let d=0;d<4;d++)this.borders[d].sort((b,E)=>this.featuresOnBorder[b].borders[d][0]-this.featuresOnBorder[E].borders[d][0])}encodeCentroid(d,b,E=!0){let S,k;if(d)if(d.y!==0){const F=b.span()._mult(this.tileToMeter);S=(Math.max(d.x,1)<<3)+Math.min(7,Math.round(F.x/10)),k=(Math.max(d.y,1)<<3)+Math.min(7,Math.round(F.y/10))}else S=Math.ceil(7*(d.x+450)),k=0;else S=0,k=+E;let P=E?this.centroidVertexArray.length:b.vertexArrayOffset;for(const F of b.polyCount){E&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*F.edges+F.top);for(let $=0;$<2*F.edges;$++)this.centroidVertexArray.emplace(P++,0,k),this.centroidVertexArray.emplace(P++,S,k);for(let $=0;$<F.top;$++)this.centroidVertexArray.emplace(P++,S,k)}}}function tp(x,d){return x.x===d.x&&(x.x<0||x.x>ki)||x.y===d.y&&(x.y<0||x.y>ki)}Ft("FillExtrusionBucket",xc,{omit:["layers","features"]}),Ft("PartMetadata",Fu);var ip={paint:new rt({"fill-extrusion-opacity":new Ee(Ve["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Pe(Ve["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ee(Ve["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ee(Ve["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Oe(Ve["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Pe(Ve["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Pe(Ve["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Ee(Ve["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function Qa(x,d){return x.x*d.x+x.y*d.y}function Ou(x,d){if(x.length===1){let b=0;const E=d[b++];let S;for(;!S||E.equals(S);)if(S=d[b++],!S)return 1/0;for(;b<d.length;b++){const k=d[b],P=x[0],F=S.sub(E),$=k.sub(E),V=P.sub(E),Z=Qa(F,F),X=Qa(F,$),W=Qa($,$),ne=Qa(V,F),ce=Qa(V,$),ye=Z*W-X*X,Me=(W*ne-X*ce)/ye,Ce=(Z*ce-X*ne)/ye,ze=E.z*(1-Me-Ce)+S.z*Me+k.z*Ce;if(isFinite(ze))return ze}return 1/0}{let b=1/0;for(const E of d)b=Math.min(b,E.z);return b}}function $u(x){const d=new N(x[0],x[1]);return d.z=x[2],d}function rp(x,d,b,E,S,k,P,F){const $=P*S.getElevationAt(x,d,!0,!0),V=k[0]!==0,Z=V?k[1]===0?P*(k[0]/7-450):P*function(X,W,ne){const ce=Math.floor(W[0]/8),ye=Math.floor(W[1]/8),Me=10*(W[0]-8*ce),Ce=10*(W[1]-8*ye),ze=X.getElevationAt(ce,ye,!0,!0),$e=X.getMeterToDEM(ne),qe=Math.floor(.5*(Me*$e-1)),Ge=Math.floor(.5*(Ce*$e-1)),Ye=X.tileCoordToPixel(ce,ye),ot=2*qe+1,et=2*Ge+1,At=function(It,Bt,pi,ji,oi){return[It.getElevationAtPixel(Bt,pi,!0),It.getElevationAtPixel(Bt+oi,pi,!0),It.getElevationAtPixel(Bt,pi+oi,!0),It.getElevationAtPixel(Bt+ji,pi+oi,!0)]}(X,Ye.x-qe,Ye.y-Ge,ot,et),ut=Math.abs(At[0]-At[1]),at=Math.abs(At[2]-At[3]),dt=Math.abs(At[0]-At[2])+Math.abs(At[1]-At[3]),mt=Math.min(.25,.5*$e*(ut+at)/ot),ht=Math.min(.25,.5*$e*dt/et);return ze+Math.max(mt*Me,ht*Ce)}(S,k,F):$;return{base:$+(b===0)?-1:b,top:V?Math.max(Z+E,$+b+2):$+E}}const np=We([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:op}=np,sp=We([{name:"a_packed",components:3,type:"Float32"}]),{members:ap}=sp,lp=is.VectorTileFeature.types,hp=Math.cos(Math.PI/180*37.5);class gh{constructor(d){this.zoom=d.zoom,this.overscaling=d.overscaling,this.layers=d.layers,this.layerIds=this.layers.map(b=>b.id),this.index=d.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(b=>{this.gradients[b.id]={}}),this.layoutVertexArray=new ni,this.layoutVertexArray2=new si,this.indexArray=new lr,this.programConfigurations=new Jo(d.layers,d.zoom),this.segments=new Tr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id)}populate(d,b,E,S){this.hasPattern=_c("line",this.layers,b);const k=this.layers[0].layout.get("line-sort-key"),P=[];for(const{feature:Z,id:X,index:W,sourceLayerIndex:ne}of d){const ce=this.layers[0]._featureFilter.needGeometry,ye=ts(Z,ce);if(!this.layers[0]._featureFilter.filter(new ie(this.zoom),ye,E))continue;const Me=k?k.evaluate(ye,{},E):void 0,Ce={id:X,properties:Z.properties,type:Z.type,sourceLayerIndex:ne,index:W,geometry:ce?ye.geometry:Kn(Z,E,S),patterns:{},sortKey:Me};P.push(Ce)}k&&P.sort((Z,X)=>Z.sortKey-X.sortKey);const{lineAtlas:F,featureIndex:$}=b,V=this.addConstantDashes(F);for(const Z of P){const{geometry:X,index:W,sourceLayerIndex:ne}=Z;if(V&&this.addFeatureDashes(Z,F),this.hasPattern){const ce=yc("line",this.layers,Z,this.zoom,b);this.patternFeatures.push(ce)}else this.addFeature(Z,X,W,E,F.positions,b.availableImages);$.insert(d[W].feature,X,W,ne,this.index)}}addConstantDashes(d){let b=!1;for(const E of this.layers){const S=E.paint.get("line-dasharray").value,k=E.layout.get("line-cap").value;if(S.kind!=="constant"||k.kind!=="constant")b=!0;else{const P=k.value,F=S.value;if(!F)continue;d.addDash(F.from,P),d.addDash(F.to,P),F.other&&d.addDash(F.other,P)}}return b}addFeatureDashes(d,b){const E=this.zoom;for(const S of this.layers){const k=S.paint.get("line-dasharray").value,P=S.layout.get("line-cap").value;if(k.kind==="constant"&&P.kind==="constant")continue;let F,$,V,Z,X,W;if(k.kind==="constant"){const Me=k.value;if(!Me)continue;F=Me.other||Me.to,$=Me.to,V=Me.from}else F=k.evaluate({zoom:E-1},d),$=k.evaluate({zoom:E},d),V=k.evaluate({zoom:E+1},d);P.kind==="constant"?Z=X=W=P.value:(Z=P.evaluate({zoom:E-1},d),X=P.evaluate({zoom:E},d),W=P.evaluate({zoom:E+1},d)),b.addDash(F,Z),b.addDash($,X),b.addDash(V,W);const ne=b.getKey(F,Z),ce=b.getKey($,X),ye=b.getKey(V,W);d.patterns[S.id]={min:ne,mid:ce,max:ye}}}update(d,b,E,S){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(d,b,this.stateDependentLayers,E,S)}addFeatures(d,b,E,S){for(const k of this.patternFeatures)this.addFeature(k,k.geometry,k.index,b,E,S)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(d){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=d.createVertexBuffer(this.layoutVertexArray2,ap)),this.layoutVertexBuffer=d.createVertexBuffer(this.layoutVertexArray,op),this.indexBuffer=d.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(d),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(d){if(d.properties&&d.properties.hasOwnProperty("mapbox_clip_start")&&d.properties.hasOwnProperty("mapbox_clip_end"))return{start:+d.properties.mapbox_clip_start,end:+d.properties.mapbox_clip_end}}addFeature(d,b,E,S,k,P){const F=this.layers[0].layout,$=F.get("line-join").evaluate(d,{}),V=F.get("line-cap").evaluate(d,{}),Z=F.get("line-miter-limit"),X=F.get("line-round-limit");this.lineClips=this.lineFeatureClips(d);for(const W of b)this.addLine(W,d,$,V,Z,X);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,d,E,k,P,S)}addLine(d,b,E,S,k,P){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Ce=0;Ce<d.length-1;Ce++)this.totalDistance+=d[Ce].dist(d[Ce+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const F=lp[b.type]==="Polygon";let $=d.length;for(;$>=2&&d[$-1].equals(d[$-2]);)$--;let V=0;for(;V<$-1&&d[V].equals(d[V+1]);)V++;if($<(F?3:2))return;E==="bevel"&&(k=1.05);const Z=this.overscaling<=16?122880/(512*this.overscaling):0,X=this.segments.prepareSegment(10*$,this.layoutVertexArray,this.indexArray);let W,ne,ce,ye,Me;this.e1=this.e2=-1,F&&(W=d[$-2],Me=d[V].sub(W)._unit()._perp());for(let Ce=V;Ce<$;Ce++){if(ce=Ce===$-1?F?d[V+1]:void 0:d[Ce+1],ce&&d[Ce].equals(ce))continue;Me&&(ye=Me),W&&(ne=W),W=d[Ce],Me=ce?ce.sub(W)._unit()._perp():ye,ye=ye||Me;let ze=ye.add(Me);ze.x===0&&ze.y===0||ze._unit();const $e=ye.x*Me.x+ye.y*Me.y,qe=ze.x*Me.x+ze.y*Me.y,Ge=qe!==0?1/qe:1/0,Ye=2*Math.sqrt(2-2*qe),ot=qe<hp&&ne&&ce,et=ye.x*Me.y-ye.y*Me.x>0;if(ot&&Ce>V){const at=W.dist(ne);if(at>2*Z){const dt=W.sub(W.sub(ne)._mult(Z/at)._round());this.updateDistance(ne,dt),this.addCurrentVertex(dt,ye,0,0,X),ne=dt}}const At=ne&&ce;let ut=At?E:F?"butt":S;if(At&&ut==="round"&&(Ge<P?ut="miter":Ge<=2&&(ut="fakeround")),ut==="miter"&&Ge>k&&(ut="bevel"),ut==="bevel"&&(Ge>2&&(ut="flipbevel"),Ge<k&&(ut="miter")),ne&&this.updateDistance(ne,W),ut==="miter")ze._mult(Ge),this.addCurrentVertex(W,ze,0,0,X);else if(ut==="flipbevel"){if(Ge>100)ze=Me.mult(-1);else{const at=Ge*ye.add(Me).mag()/ye.sub(Me).mag();ze._perp()._mult(at*(et?-1:1))}this.addCurrentVertex(W,ze,0,0,X),this.addCurrentVertex(W,ze.mult(-1),0,0,X)}else if(ut==="bevel"||ut==="fakeround"){const at=-Math.sqrt(Ge*Ge-1),dt=et?at:0,mt=et?0:at;if(ne&&this.addCurrentVertex(W,ye,dt,mt,X),ut==="fakeround"){const ht=Math.round(180*Ye/Math.PI/20);for(let It=1;It<ht;It++){let Bt=It/ht;if(Bt!==.5){const ji=Bt-.5;Bt+=Bt*ji*(Bt-1)*((1.0904+$e*($e*(3.55645-1.43519*$e)-3.2452))*ji*ji+(.848013+$e*(.215638*$e-1.06021)))}const pi=Me.sub(ye)._mult(Bt)._add(ye)._unit()._mult(et?-1:1);this.addHalfVertex(W,pi.x,pi.y,!1,et,0,X)}}ce&&this.addCurrentVertex(W,Me,-dt,-mt,X)}else if(ut==="butt")this.addCurrentVertex(W,ze,0,0,X);else if(ut==="square"){const at=ne?1:-1;ne||this.addCurrentVertex(W,ze,at,at,X),this.addCurrentVertex(W,ze,0,0,X),ne&&this.addCurrentVertex(W,ze,at,at,X)}else ut==="round"&&(ne&&(this.addCurrentVertex(W,ye,0,0,X),this.addCurrentVertex(W,ye,1,1,X,!0)),ce&&(this.addCurrentVertex(W,Me,-1,-1,X,!0),this.addCurrentVertex(W,Me,0,0,X)));if(ot&&Ce<$-1){const at=W.dist(ce);if(at>2*Z){const dt=W.add(ce.sub(W)._mult(Z/at)._round());this.updateDistance(W,dt),this.addCurrentVertex(dt,Me,0,0,X),W=dt}}}}addCurrentVertex(d,b,E,S,k,P=!1){const F=b.y*S-b.x,$=-b.y-b.x*S;this.addHalfVertex(d,b.x+b.y*E,b.y-b.x*E,P,!1,E,k),this.addHalfVertex(d,F,$,P,!0,-S,k)}addHalfVertex({x:d,y:b},E,S,k,P,F,$){this.layoutVertexArray.emplaceBack((d<<1)+(k?1:0),(b<<1)+(P?1:0),Math.round(63*E)+128,Math.round(63*S)+128,1+(F===0?0:F<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineSoFar);const V=$.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,V),$.primitiveLength++),P?this.e2=V:this.e1=V}updateScaledDistance(){if(this.lineClips){const d=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=d*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(d,b){this.distance+=d.dist(b),this.updateScaledDistance()}}Ft("LineBucket",gh,{omit:["layers","patternFeatures"]});const cp=new rt({"line-cap":new Pe(Ve.layout_line["line-cap"]),"line-join":new Pe(Ve.layout_line["line-join"]),"line-miter-limit":new Ee(Ve.layout_line["line-miter-limit"]),"line-round-limit":new Ee(Ve.layout_line["line-round-limit"]),"line-sort-key":new Pe(Ve.layout_line["line-sort-key"])});var Nu={paint:new rt({"line-opacity":new Pe(Ve.paint_line["line-opacity"]),"line-color":new Pe(Ve.paint_line["line-color"]),"line-translate":new Ee(Ve.paint_line["line-translate"]),"line-translate-anchor":new Ee(Ve.paint_line["line-translate-anchor"]),"line-width":new Pe(Ve.paint_line["line-width"]),"line-gap-width":new Pe(Ve.paint_line["line-gap-width"]),"line-offset":new Pe(Ve.paint_line["line-offset"]),"line-blur":new Pe(Ve.paint_line["line-blur"]),"line-dasharray":new Oe(Ve.paint_line["line-dasharray"]),"line-pattern":new Oe(Ve.paint_line["line-pattern"]),"line-gradient":new Ke(Ve.paint_line["line-gradient"])}),layout:cp};const Uu=new class extends Pe{possiblyEvaluate(x,d){return d=new ie(Math.floor(d.zoom),{now:d.now,fadeDuration:d.fadeDuration,zoomHistory:d.zoomHistory,transition:d.transition}),super.possiblyEvaluate(x,d)}evaluate(x,d,b,E){return d=pe({},d,{zoom:Math.floor(d.zoom)}),super.evaluate(x,d,b,E)}}(Nu.paint.properties["line-width"].specification);function Vu(x,d){return d>0?d+2*x:x}Uu.useIntegerZoom=!0;const up=We([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"},{name:"a_z_tile_anchor",components:4,type:"Int16"}],4),dp=We([{name:"a_projected_pos",components:3,type:"Float32"}],4);We([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const fp=We([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),pp=We([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);We([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const ju=We([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),mp=We([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);We([{name:"triangle",components:3,type:"Uint16"}]),We([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),We([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),We([{type:"Float32",name:"offsetX"}]),We([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var Cr=24;const Rn=128;function vc(x,d){const{expression:b}=d;if(b.kind==="constant")return{kind:"constant",layoutSize:b.evaluate(new ie(x+1))};if(b.kind==="source")return{kind:"source"};{const{zoomStops:E,interpolationType:S}=b;let k=0;for(;k<E.length&&E[k]<=x;)k++;k=Math.max(0,k-1);let P=k;for(;P<E.length&&E[P]<x+1;)P++;P=Math.min(E.length-1,P);const F=E[k],$=E[P];return b.kind==="composite"?{kind:"composite",minZoom:F,maxZoom:$,interpolationType:S}:{kind:"camera",minZoom:F,maxZoom:$,minSize:b.evaluate(new ie(F)),maxSize:b.evaluate(new ie($)),interpolationType:S}}}function _h(x,{uSize:d,uSizeT:b},{lowerSize:E,upperSize:S}){return x.kind==="source"?E/Rn:x.kind==="composite"?Pi(E/Rn,S/Rn,b):d}function Ks(x,d){let b=0,E=0;if(x.kind==="constant")E=x.layoutSize;else if(x.kind!=="source"){const{interpolationType:S,minZoom:k,maxZoom:P}=x,F=S?ge(jr.interpolationFactor(S,d,k,P),0,1):0;x.kind==="camera"?E=Pi(x.minSize,x.maxSize,F):b=F}return{uSizeT:b,uSize:E}}var gp=Object.freeze({__proto__:null,getSizeData:vc,evaluateSizeForFeature:_h,evaluateSizeForZoom:Ks,SIZE_PACK_FACTOR:Rn});function _p(x,d,b){return x.sections.forEach(E=>{E.text=function(S,k,P){const F=k.layout.get("text-transform").evaluate(P,{});return F==="uppercase"?S=S.toLocaleUpperCase():F==="lowercase"&&(S=S.toLocaleLowerCase()),ee.applyArabicShaping&&(S=ee.applyArabicShaping(S)),S}(E.text,d,b)}),x}const el={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};function yp(x){return x==="\uFE36"||x==="\uFE48"||x==="\uFE38"||x==="\uFE44"||x==="\uFE42"||x==="\uFE3E"||x==="\uFE3C"||x==="\uFE3A"||x==="\uFE18"||x==="\uFE40"||x==="\uFE10"||x==="\uFE13"||x==="\uFE14"||x==="\uFF40"||x==="\uFFE3"||x==="\uFE11"||x==="\uFE12"}function xp(x){return x==="\uFE35"||x==="\uFE47"||x==="\uFE37"||x==="\uFE43"||x==="\uFE41"||x==="\uFE3D"||x==="\uFE3B"||x==="\uFE39"||x==="\uFE17"||x==="\uFE3F"}var Gu=function(x,d,b,E,S){var k,P,F=8*S-E-1,$=(1<<F)-1,V=$>>1,Z=-7,X=b?S-1:0,W=b?-1:1,ne=x[d+X];for(X+=W,k=ne&(1<<-Z)-1,ne>>=-Z,Z+=F;Z>0;k=256*k+x[d+X],X+=W,Z-=8);for(P=k&(1<<-Z)-1,k>>=-Z,Z+=E;Z>0;P=256*P+x[d+X],X+=W,Z-=8);if(k===0)k=1-V;else{if(k===$)return P?NaN:1/0*(ne?-1:1);P+=Math.pow(2,E),k-=V}return(ne?-1:1)*P*Math.pow(2,k-E)},qu=function(x,d,b,E,S,k){var P,F,$,V=8*k-S-1,Z=(1<<V)-1,X=Z>>1,W=S===23?Math.pow(2,-24)-Math.pow(2,-77):0,ne=E?0:k-1,ce=E?1:-1,ye=d<0||d===0&&1/d<0?1:0;for(d=Math.abs(d),isNaN(d)||d===1/0?(F=isNaN(d)?1:0,P=Z):(P=Math.floor(Math.log(d)/Math.LN2),d*($=Math.pow(2,-P))<1&&(P--,$*=2),(d+=P+X>=1?W/$:W*Math.pow(2,1-X))*$>=2&&(P++,$/=2),P+X>=Z?(F=0,P=Z):P+X>=1?(F=(d*$-1)*Math.pow(2,S),P+=X):(F=d*Math.pow(2,X-1)*Math.pow(2,S),P=0));S>=8;x[b+ne]=255&F,ne+=ce,F/=256,S-=8);for(P=P<<S|F,V+=S;V>0;x[b+ne]=255&P,ne+=ce,P/=256,V-=8);x[b+ne-ce]|=128*ye},tl=Vi;function Vi(x){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(x)?x:new Uint8Array(x||0),this.pos=0,this.type=0,this.length=this.buf.length}Vi.Varint=0,Vi.Fixed64=1,Vi.Bytes=2,Vi.Fixed32=5;var bc=4294967296,Zu=1/bc,Xu=typeof TextDecoder=="undefined"?null:new TextDecoder("utf8");function Jn(x){return x.type===Vi.Bytes?x.readVarint()+x.pos:x.pos+1}function Js(x,d,b){return b?4294967296*d+(x>>>0):4294967296*(d>>>0)+(x>>>0)}function Yu(x,d,b){var E=d<=16383?1:d<=2097151?2:d<=268435455?3:Math.floor(Math.log(d)/(7*Math.LN2));b.realloc(E);for(var S=b.pos-1;S>=x;S--)b.buf[S+E]=b.buf[S]}function vp(x,d){for(var b=0;b<x.length;b++)d.writeVarint(x[b])}function bp(x,d){for(var b=0;b<x.length;b++)d.writeSVarint(x[b])}function wp(x,d){for(var b=0;b<x.length;b++)d.writeFloat(x[b])}function Ep(x,d){for(var b=0;b<x.length;b++)d.writeDouble(x[b])}function Tp(x,d){for(var b=0;b<x.length;b++)d.writeBoolean(x[b])}function Mp(x,d){for(var b=0;b<x.length;b++)d.writeFixed32(x[b])}function Sp(x,d){for(var b=0;b<x.length;b++)d.writeSFixed32(x[b])}function Ap(x,d){for(var b=0;b<x.length;b++)d.writeFixed64(x[b])}function Ip(x,d){for(var b=0;b<x.length;b++)d.writeSFixed64(x[b])}function yh(x,d){return(x[d]|x[d+1]<<8|x[d+2]<<16)+16777216*x[d+3]}function Qs(x,d,b){x[b]=d,x[b+1]=d>>>8,x[b+2]=d>>>16,x[b+3]=d>>>24}function Hu(x,d){return(x[d]|x[d+1]<<8|x[d+2]<<16)+(x[d+3]<<24)}function kp(x,d,b){d.glyphs=[],x===1&&b.readMessage(Cp,d)}function Cp(x,d,b){if(x===3){const{id:E,bitmap:S,width:k,height:P,left:F,top:$,advance:V}=b.readMessage(Dp,{});d.glyphs.push({id:E,bitmap:new bo({width:k+6,height:P+6},S),metrics:{width:k,height:P,left:F,top:$,advance:V}})}else x===4?d.ascender=b.readSVarint():x===5&&(d.descender=b.readSVarint())}function Dp(x,d,b){x===1?d.id=b.readVarint():x===2?d.bitmap=b.readBytes():x===3?d.width=b.readVarint():x===4?d.height=b.readVarint():x===5?d.left=b.readSVarint():x===6?d.top=b.readSVarint():x===7&&(d.advance=b.readVarint())}function wc(x){let d=0,b=0;for(const P of x)d+=P.w*P.h,b=Math.max(b,P.w);x.sort((P,F)=>F.h-P.h);const E=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(d/.95)),b),h:1/0}];let S=0,k=0;for(const P of x)for(let F=E.length-1;F>=0;F--){const $=E[F];if(!(P.w>$.w||P.h>$.h)){if(P.x=$.x,P.y=$.y,k=Math.max(k,P.y+P.h),S=Math.max(S,P.x+P.w),P.w===$.w&&P.h===$.h){const V=E.pop();F<E.length&&(E[F]=V)}else P.h===$.h?($.x+=P.w,$.w-=P.w):P.w===$.w?($.y+=P.h,$.h-=P.h):(E.push({x:$.x+P.w,y:$.y,w:$.w-P.w,h:P.h}),$.y+=P.h,$.h-=P.h);break}}return{w:S,h:k,fill:d/(S*k)||0}}Vi.prototype={destroy:function(){this.buf=null},readFields:function(x,d,b){for(b=b||this.length;this.pos<b;){var E=this.readVarint(),S=E>>3,k=this.pos;this.type=7&E,x(S,d,this),this.pos===k&&this.skip(E)}return d},readMessage:function(x,d){return this.readFields(x,d,this.readVarint()+this.pos)},readFixed32:function(){var x=yh(this.buf,this.pos);return this.pos+=4,x},readSFixed32:function(){var x=Hu(this.buf,this.pos);return this.pos+=4,x},readFixed64:function(){var x=yh(this.buf,this.pos)+yh(this.buf,this.pos+4)*bc;return this.pos+=8,x},readSFixed64:function(){var x=yh(this.buf,this.pos)+Hu(this.buf,this.pos+4)*bc;return this.pos+=8,x},readFloat:function(){var x=Gu(this.buf,this.pos,!0,23,4);return this.pos+=4,x},readDouble:function(){var x=Gu(this.buf,this.pos,!0,52,8);return this.pos+=8,x},readVarint:function(x){var d,b,E=this.buf;return d=127&(b=E[this.pos++]),b<128?d:(d|=(127&(b=E[this.pos++]))<<7,b<128?d:(d|=(127&(b=E[this.pos++]))<<14,b<128?d:(d|=(127&(b=E[this.pos++]))<<21,b<128?d:function(S,k,P){var F,$,V=P.buf;if(F=(112&($=V[P.pos++]))>>4,$<128||(F|=(127&($=V[P.pos++]))<<3,$<128)||(F|=(127&($=V[P.pos++]))<<10,$<128)||(F|=(127&($=V[P.pos++]))<<17,$<128)||(F|=(127&($=V[P.pos++]))<<24,$<128)||(F|=(1&($=V[P.pos++]))<<31,$<128))return Js(S,F,k);throw new Error("Expected varint not more than 10 bytes")}(d|=(15&(b=E[this.pos]))<<28,x,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var x=this.readVarint();return x%2==1?(x+1)/-2:x/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var x=this.readVarint()+this.pos,d=this.pos;return this.pos=x,x-d>=12&&Xu?function(b,E,S){return Xu.decode(b.subarray(E,S))}(this.buf,d,x):function(b,E,S){for(var k="",P=E;P<S;){var F,$,V,Z=b[P],X=null,W=Z>239?4:Z>223?3:Z>191?2:1;if(P+W>S)break;W===1?Z<128&&(X=Z):W===2?(192&(F=b[P+1]))==128&&(X=(31&Z)<<6|63&F)<=127&&(X=null):W===3?($=b[P+2],(192&(F=b[P+1]))==128&&(192&$)==128&&((X=(15&Z)<<12|(63&F)<<6|63&$)<=2047||X>=55296&&X<=57343)&&(X=null)):W===4&&($=b[P+2],V=b[P+3],(192&(F=b[P+1]))==128&&(192&$)==128&&(192&V)==128&&((X=(15&Z)<<18|(63&F)<<12|(63&$)<<6|63&V)<=65535||X>=1114112)&&(X=null)),X===null?(X=65533,W=1):X>65535&&(X-=65536,k+=String.fromCharCode(X>>>10&1023|55296),X=56320|1023&X),k+=String.fromCharCode(X),P+=W}return k}(this.buf,d,x)},readBytes:function(){var x=this.readVarint()+this.pos,d=this.buf.subarray(this.pos,x);return this.pos=x,d},readPackedVarint:function(x,d){if(this.type!==Vi.Bytes)return x.push(this.readVarint(d));var b=Jn(this);for(x=x||[];this.pos<b;)x.push(this.readVarint(d));return x},readPackedSVarint:function(x){if(this.type!==Vi.Bytes)return x.push(this.readSVarint());var d=Jn(this);for(x=x||[];this.pos<d;)x.push(this.readSVarint());return x},readPackedBoolean:function(x){if(this.type!==Vi.Bytes)return x.push(this.readBoolean());var d=Jn(this);for(x=x||[];this.pos<d;)x.push(this.readBoolean());return x},readPackedFloat:function(x){if(this.type!==Vi.Bytes)return x.push(this.readFloat());var d=Jn(this);for(x=x||[];this.pos<d;)x.push(this.readFloat());return x},readPackedDouble:function(x){if(this.type!==Vi.Bytes)return x.push(this.readDouble());var d=Jn(this);for(x=x||[];this.pos<d;)x.push(this.readDouble());return x},readPackedFixed32:function(x){if(this.type!==Vi.Bytes)return x.push(this.readFixed32());var d=Jn(this);for(x=x||[];this.pos<d;)x.push(this.readFixed32());return x},readPackedSFixed32:function(x){if(this.type!==Vi.Bytes)return x.push(this.readSFixed32());var d=Jn(this);for(x=x||[];this.pos<d;)x.push(this.readSFixed32());return x},readPackedFixed64:function(x){if(this.type!==Vi.Bytes)return x.push(this.readFixed64());var d=Jn(this);for(x=x||[];this.pos<d;)x.push(this.readFixed64());return x},readPackedSFixed64:function(x){if(this.type!==Vi.Bytes)return x.push(this.readSFixed64());var d=Jn(this);for(x=x||[];this.pos<d;)x.push(this.readSFixed64());return x},skip:function(x){var d=7&x;if(d===Vi.Varint)for(;this.buf[this.pos++]>127;);else if(d===Vi.Bytes)this.pos=this.readVarint()+this.pos;else if(d===Vi.Fixed32)this.pos+=4;else{if(d!==Vi.Fixed64)throw new Error("Unimplemented type: "+d);this.pos+=8}},writeTag:function(x,d){this.writeVarint(x<<3|d)},realloc:function(x){for(var d=this.length||16;d<this.pos+x;)d*=2;if(d!==this.length){var b=new Uint8Array(d);b.set(this.buf),this.buf=b,this.length=d}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(x){this.realloc(4),Qs(this.buf,x,this.pos),this.pos+=4},writeSFixed32:function(x){this.realloc(4),Qs(this.buf,x,this.pos),this.pos+=4},writeFixed64:function(x){this.realloc(8),Qs(this.buf,-1&x,this.pos),Qs(this.buf,Math.floor(x*Zu),this.pos+4),this.pos+=8},writeSFixed64:function(x){this.realloc(8),Qs(this.buf,-1&x,this.pos),Qs(this.buf,Math.floor(x*Zu),this.pos+4),this.pos+=8},writeVarint:function(x){(x=+x||0)>268435455||x<0?function(d,b){var E,S;if(d>=0?(E=d%4294967296|0,S=d/4294967296|0):(S=~(-d/4294967296),4294967295^(E=~(-d%4294967296))?E=E+1|0:(E=0,S=S+1|0)),d>=18446744073709552e3||d<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");b.realloc(10),function(k,P,F){F.buf[F.pos++]=127&k|128,k>>>=7,F.buf[F.pos++]=127&k|128,k>>>=7,F.buf[F.pos++]=127&k|128,k>>>=7,F.buf[F.pos++]=127&k|128,F.buf[F.pos]=127&(k>>>=7)}(E,0,b),function(k,P){var F=(7&k)<<4;P.buf[P.pos++]|=F|((k>>>=3)?128:0),k&&(P.buf[P.pos++]=127&k|((k>>>=7)?128:0),k&&(P.buf[P.pos++]=127&k|((k>>>=7)?128:0),k&&(P.buf[P.pos++]=127&k|((k>>>=7)?128:0),k&&(P.buf[P.pos++]=127&k|((k>>>=7)?128:0),k&&(P.buf[P.pos++]=127&k)))))}(S,b)}(x,this):(this.realloc(4),this.buf[this.pos++]=127&x|(x>127?128:0),x<=127||(this.buf[this.pos++]=127&(x>>>=7)|(x>127?128:0),x<=127||(this.buf[this.pos++]=127&(x>>>=7)|(x>127?128:0),x<=127||(this.buf[this.pos++]=x>>>7&127))))},writeSVarint:function(x){this.writeVarint(x<0?2*-x-1:2*x)},writeBoolean:function(x){this.writeVarint(Boolean(x))},writeString:function(x){x=String(x),this.realloc(4*x.length),this.pos++;var d=this.pos;this.pos=function(E,S,k){for(var P,F,$=0;$<S.length;$++){if((P=S.charCodeAt($))>55295&&P<57344){if(!F){P>56319||$+1===S.length?(E[k++]=239,E[k++]=191,E[k++]=189):F=P;continue}if(P<56320){E[k++]=239,E[k++]=191,E[k++]=189,F=P;continue}P=F-55296<<10|P-56320|65536,F=null}else F&&(E[k++]=239,E[k++]=191,E[k++]=189,F=null);P<128?E[k++]=P:(P<2048?E[k++]=P>>6|192:(P<65536?E[k++]=P>>12|224:(E[k++]=P>>18|240,E[k++]=P>>12&63|128),E[k++]=P>>6&63|128),E[k++]=63&P|128)}return k}(this.buf,x,this.pos);var b=this.pos-d;b>=128&&Yu(d,b,this),this.pos=d-1,this.writeVarint(b),this.pos+=b},writeFloat:function(x){this.realloc(4),qu(this.buf,x,this.pos,!0,23,4),this.pos+=4},writeDouble:function(x){this.realloc(8),qu(this.buf,x,this.pos,!0,52,8),this.pos+=8},writeBytes:function(x){var d=x.length;this.writeVarint(d),this.realloc(d);for(var b=0;b<d;b++)this.buf[this.pos++]=x[b]},writeRawMessage:function(x,d){this.pos++;var b=this.pos;x(d,this);var E=this.pos-b;E>=128&&Yu(b,E,this),this.pos=b-1,this.writeVarint(E),this.pos+=E},writeMessage:function(x,d,b){this.writeTag(x,Vi.Bytes),this.writeRawMessage(d,b)},writePackedVarint:function(x,d){d.length&&this.writeMessage(x,vp,d)},writePackedSVarint:function(x,d){d.length&&this.writeMessage(x,bp,d)},writePackedBoolean:function(x,d){d.length&&this.writeMessage(x,Tp,d)},writePackedFloat:function(x,d){d.length&&this.writeMessage(x,wp,d)},writePackedDouble:function(x,d){d.length&&this.writeMessage(x,Ep,d)},writePackedFixed32:function(x,d){d.length&&this.writeMessage(x,Mp,d)},writePackedSFixed32:function(x,d){d.length&&this.writeMessage(x,Sp,d)},writePackedFixed64:function(x,d){d.length&&this.writeMessage(x,Ap,d)},writePackedSFixed64:function(x,d){d.length&&this.writeMessage(x,Ip,d)},writeBytesField:function(x,d){this.writeTag(x,Vi.Bytes),this.writeBytes(d)},writeFixed32Field:function(x,d){this.writeTag(x,Vi.Fixed32),this.writeFixed32(d)},writeSFixed32Field:function(x,d){this.writeTag(x,Vi.Fixed32),this.writeSFixed32(d)},writeFixed64Field:function(x,d){this.writeTag(x,Vi.Fixed64),this.writeFixed64(d)},writeSFixed64Field:function(x,d){this.writeTag(x,Vi.Fixed64),this.writeSFixed64(d)},writeVarintField:function(x,d){this.writeTag(x,Vi.Varint),this.writeVarint(d)},writeSVarintField:function(x,d){this.writeTag(x,Vi.Varint),this.writeSVarint(d)},writeStringField:function(x,d){this.writeTag(x,Vi.Bytes),this.writeString(d)},writeFloatField:function(x,d){this.writeTag(x,Vi.Fixed32),this.writeFloat(d)},writeDoubleField:function(x,d){this.writeTag(x,Vi.Fixed64),this.writeDouble(d)},writeBooleanField:function(x,d){this.writeVarintField(x,Boolean(d))}};class Ec{constructor(d,{pixelRatio:b,version:E,stretchX:S,stretchY:k,content:P}){this.paddedRect=d,this.pixelRatio=b,this.stretchX=S,this.stretchY=k,this.content=P,this.version=E}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Wu{constructor(d,b){const E={},S={};this.haveRenderCallbacks=[];const k=[];this.addImages(d,E,k),this.addImages(b,S,k);const{w:P,h:F}=wc(k),$=new on({width:P||1,height:F||1});for(const V in d){const Z=d[V],X=E[V].paddedRect;on.copy(Z.data,$,{x:0,y:0},{x:X.x+1,y:X.y+1},Z.data)}for(const V in b){const Z=b[V],X=S[V].paddedRect,W=X.x+1,ne=X.y+1,ce=Z.data.width,ye=Z.data.height;on.copy(Z.data,$,{x:0,y:0},{x:W,y:ne},Z.data),on.copy(Z.data,$,{x:0,y:ye-1},{x:W,y:ne-1},{width:ce,height:1}),on.copy(Z.data,$,{x:0,y:0},{x:W,y:ne+ye},{width:ce,height:1}),on.copy(Z.data,$,{x:ce-1,y:0},{x:W-1,y:ne},{width:1,height:ye}),on.copy(Z.data,$,{x:0,y:0},{x:W+ce,y:ne},{width:1,height:ye})}this.image=$,this.iconPositions=E,this.patternPositions=S}addImages(d,b,E){for(const S in d){const k=d[S],P={x:0,y:0,w:k.data.width+2,h:k.data.height+2};E.push(P),b[S]=new Ec(P,k),k.hasRenderCallback&&this.haveRenderCallbacks.push(S)}}patchUpdatedImages(d,b){d.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const E in d.updatedImages)this.patchUpdatedImage(this.iconPositions[E],d.getImage(E),b),this.patchUpdatedImage(this.patternPositions[E],d.getImage(E),b)}patchUpdatedImage(d,b,E){if(!d||!b||d.version===b.version)return;d.version=b.version;const[S,k]=d.tl;E.update(b.data,void 0,{x:S,y:k})}}Ft("ImagePosition",Ec),Ft("ImageAtlas",Wu);const sn={horizontal:1,vertical:2,horizontalOnly:3};class il{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(d,b){const E=new il;return E.scale=d||1,E.fontStack=b,E}static forImage(d){const b=new il;return b.imageName=d,b}}class ea{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(d,b){const E=new ea;for(let S=0;S<d.sections.length;S++){const k=d.sections[S];k.image?E.addImageSection(k):E.addTextSection(k,b)}return E}length(){return this.text.length}getSection(d){return this.sections[this.sectionIndex[d]]}getSections(){return this.sections}getSectionIndex(d){return this.sectionIndex[d]}getCharCode(d){return this.text.charCodeAt(d)}verticalizePunctuation(d){this.text=function(b,E){let S="";for(let k=0;k<b.length;k++){const P=b.charCodeAt(k+1)||null,F=b.charCodeAt(k-1)||null;S+=!E&&(P&&ja(P)&&!el[b[k+1]]||F&&ja(F)&&!el[b[k-1]])||!el[b[k]]?b[k]:el[b[k]]}return S}(this.text,d)}trim(){let d=0;for(let E=0;E<this.text.length&&xh[this.text.charCodeAt(E)];E++)d++;let b=this.text.length;for(let E=this.text.length-1;E>=0&&E>=d&&xh[this.text.charCodeAt(E)];E--)b--;this.text=this.text.substring(d,b),this.sectionIndex=this.sectionIndex.slice(d,b)}substring(d,b){const E=new ea;return E.text=this.text.substring(d,b),E.sectionIndex=this.sectionIndex.slice(d,b),E.sections=this.sections,E}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((d,b)=>Math.max(d,this.sections[b].scale),0)}addTextSection(d,b){this.text+=d.text,this.sections.push(il.forText(d.scale,d.fontStack||b));const E=this.sections.length-1;for(let S=0;S<d.text.length;++S)this.sectionIndex.push(E)}addImageSection(d){const b=d.image?d.image.name:"";if(b.length===0)return void ft("Can't add FormattedSection with an empty image.");const E=this.getNextImageSectionCharCode();E?(this.text+=String.fromCharCode(E),this.sections.push(il.forImage(b)),this.sectionIndex.push(this.sections.length-1)):ft("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Tc(x,d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye){const Me=ea.fromFeature(x,S);let Ce;X===sn.vertical&&Me.verticalizePunctuation(W);const{processBidirectionalText:ze,processStyledBidirectionalText:$e}=ee;if(ze&&Me.sections.length===1){Ce=[];const Ye=ze(Me.toString(),Mc(Me,V,k,d,E,ne,ce));for(const ot of Ye){const et=new ea;et.text=ot,et.sections=Me.sections;for(let At=0;At<ot.length;At++)et.sectionIndex.push(0);Ce.push(et)}}else if($e){Ce=[];const Ye=$e(Me.text,Me.sectionIndex,Mc(Me,V,k,d,E,ne,ce));for(const ot of Ye){const et=new ea;et.text=ot[0],et.sectionIndex=ot[1],et.sections=Me.sections,Ce.push(et)}}else Ce=function(Ye,ot){const et=[],At=Ye.text;let ut=0;for(const at of ot)et.push(Ye.substring(ut,at)),ut=at;return ut<At.length&&et.push(Ye.substring(ut,At.length)),et}(Me,Mc(Me,V,k,d,E,ne,ce));const qe=[],Ge={positionedLines:qe,text:Me.toString(),top:Z[1],bottom:Z[1],left:Z[0],right:Z[0],writingMode:X,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Ye,ot,et,At,ut,at,dt,mt,ht,It,Bt,pi){let ji=0,oi=0,zi=0;const kt=mt==="right"?1:mt==="left"?0:.5;let Gi=!1;for(const Ui of ut){const Fi=Ui.getSections();for(const Ki of Fi){if(Ki.imageName)continue;const Dr=ot[Ki.fontStack];if(Dr&&(Gi=Dr.ascender!==void 0&&Dr.descender!==void 0,!Gi))break}if(!Gi)break}let Bi=0;for(const Ui of ut){Ui.trim();const Fi=Ui.getMaxScale(),Ki=(Fi-1)*Cr,Dr={positionedGlyphs:[],lineOffset:0};Ye.positionedLines[Bi]=Dr;const ur=Dr.positionedGlyphs;let xr=0;if(!Ui.length()){oi+=at,++Bi;continue}let Pr=0,Qi=0;for(let qi=0;qi<Ui.length();qi++){const dr=Ui.getSection(qi),fr=Ui.getSectionIndex(qi),or=Ui.getCharCode(qi);let tr=dr.scale,gr=null,Zi=null,Br=null,xn=Cr,an=0;const fn=!(ht===sn.horizontal||!Bt&&!Va(or)||Bt&&(xh[or]||(hr=or,jl(hr)||Gl(hr)||ql(hr)||kn(hr)||Na(hr))));if(dr.imageName){const ln=At[dr.imageName];if(!ln)continue;Br=dr.imageName,Ye.iconsInText=Ye.iconsInText||!0,Zi=ln.paddedRect;const Lr=ln.displaySize;tr=tr*Cr/pi,gr={width:Lr[0],height:Lr[1],left:1,top:-3,advance:fn?Lr[1]:Lr[0],localGlyph:!1},an=Gi?-gr.height*tr:Fi*Cr-17-Lr[1]*tr,xn=gr.advance;const Qn=(fn?Lr[0]:Lr[1])*tr-Cr*Fi;Qn>0&&Qn>xr&&(xr=Qn)}else{const ln=et[dr.fontStack];if(!ln)continue;ln[or]&&(Zi=ln[or]);const Lr=ot[dr.fontStack];if(!Lr)continue;const Qn=Lr.glyphs[or];if(!Qn)continue;if(gr=Qn.metrics,xn=or!==8203?Cr:0,Gi){const oa=Lr.ascender!==void 0?Math.abs(Lr.ascender):0,sa=Lr.descender!==void 0?Math.abs(Lr.descender):0,aa=(oa+sa)*tr;Pr<aa&&(Pr=aa,Qi=(oa-sa)/2*tr),an=-oa*tr}else an=(Fi-tr)*Cr-17}fn?(Ye.verticalizable=!0,ur.push({glyph:or,imageName:Br,x:ji,y:oi+an,vertical:fn,scale:tr,localGlyph:gr.localGlyph,fontStack:dr.fontStack,sectionIndex:fr,metrics:gr,rect:Zi}),ji+=xn*tr+It):(ur.push({glyph:or,imageName:Br,x:ji,y:oi+an,vertical:fn,scale:tr,localGlyph:gr.localGlyph,fontStack:dr.fontStack,sectionIndex:fr,metrics:gr,rect:Zi}),ji+=gr.advance*tr+It)}ur.length!==0&&(zi=Math.max(ji-It,zi),Gi?td(ur,kt,xr,Qi,at*Fi/2):td(ur,kt,xr,0,at/2)),ji=0;const Zr=at*Fi+xr;Dr.lineOffset=Math.max(xr,Ki),oi+=Zr,++Bi}var hr;const cr=oi,{horizontalAlign:mr,verticalAlign:Mr}=Sc(dt);(function(Ui,Fi,Ki,Dr,ur,xr){const Pr=(Fi-Ki)*ur,Qi=-xr*Dr;for(const Zr of Ui)for(const qi of Zr.positionedGlyphs)qi.x+=Pr,qi.y+=Qi})(Ye.positionedLines,kt,mr,Mr,zi,cr),Ye.top+=-Mr*cr,Ye.bottom=Ye.top+cr,Ye.left+=-mr*zi,Ye.right=Ye.left+zi,Ye.hasBaseline=Gi}(Ge,d,b,E,Ce,P,F,$,X,V,W,ye),!function(Ye){for(const ot of Ye)if(ot.positionedGlyphs.length!==0)return!1;return!0}(qe)&&Ge}const xh={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Pp={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Ku(x,d,b,E,S,k){if(d.imageName){const P=E[d.imageName];return P?P.displaySize[0]*d.scale*Cr/k+S:0}{const P=b[d.fontStack],F=P&&P.glyphs[x];return F?F.metrics.advance*d.scale+S:0}}function Ju(x,d,b,E){const S=Math.pow(x-d,2);return E?x<d?S/2:2*S:S+Math.abs(b)*b}function Rp(x,d,b){let E=0;return x===10&&(E-=1e4),b&&(E+=150),x!==40&&x!==65288||(E+=50),d!==41&&d!==65289||(E+=50),E}function Qu(x,d,b,E,S,k){let P=null,F=Ju(d,b,S,k);for(const $ of E){const V=Ju(d-$.x,b,S,k)+$.badness;V<=F&&(P=$,F=V)}return{index:x,x:d,priorBreak:P,badness:F}}function ed(x){return x?ed(x.priorBreak).concat(x.index):[]}function Mc(x,d,b,E,S,k,P){if(k!=="point")return[];if(!x)return[];const F=[],$=function(W,ne,ce,ye,Me,Ce){let ze=0;for(let $e=0;$e<W.length();$e++){const qe=W.getSection($e);ze+=Ku(W.getCharCode($e),qe,ye,Me,ne,Ce)}return ze/Math.max(1,Math.ceil(ze/ce))}(x,d,b,E,S,P),V=x.text.indexOf("\u200B")>=0;let Z=0;for(let W=0;W<x.length();W++){const ne=x.getSection(W),ce=x.getCharCode(W);if(xh[ce]||(Z+=Ku(ce,ne,E,S,d,P)),W<x.length()-1){const ye=!((X=ce)<11904||!(Yl(X)||La(X)||Yo(X)||Kl(X)||$a(X)||Zl(X)||za(X)||$s(X)||Us(X)||Zo(X)||Oa(X)||Ua(X)||mo(X)||Xl(X)||qo(X)||Fa(X)||Ns(X)||Jl(X)||Wl(X)||Hl(X)));(Pp[ce]||ye||ne.imageName)&&F.push(Qu(W+1,Z,$,F,Rp(ce,x.getCharCode(W+1),ye&&V),!1))}}var X;return ed(Qu(x.length(),Z,$,F,0,!0))}function Sc(x){let d=.5,b=.5;switch(x){case"right":case"top-right":case"bottom-right":d=1;break;case"left":case"top-left":case"bottom-left":d=0}switch(x){case"bottom":case"bottom-right":case"bottom-left":b=1;break;case"top":case"top-right":case"top-left":b=0}return{horizontalAlign:d,verticalAlign:b}}function td(x,d,b,E,S){if(!(d||b||E||S))return;const k=x.length-1,P=x[k],F=(P.x+P.metrics.advance*P.scale)*d;for(let $=0;$<=k;$++)x[$].x-=F,x[$].y+=b+E+S}function Bp(x,d,b){const{horizontalAlign:E,verticalAlign:S}=Sc(b),k=d[0]-x.displaySize[0]*E,P=d[1]-x.displaySize[1]*S;return{image:x,top:P,bottom:P+x.displaySize[1],left:k,right:k+x.displaySize[0]}}function id(x,d,b,E,S,k){const P=x.image;let F;if(P.content){const Me=P.content,Ce=P.pixelRatio||1;F=[Me[0]/Ce,Me[1]/Ce,P.displaySize[0]-Me[2]/Ce,P.displaySize[1]-Me[3]/Ce]}const $=d.left*k,V=d.right*k;let Z,X,W,ne;b==="width"||b==="both"?(ne=S[0]+$-E[3],X=S[0]+V+E[1]):(ne=S[0]+($+V-P.displaySize[0])/2,X=ne+P.displaySize[0]);const ce=d.top*k,ye=d.bottom*k;return b==="height"||b==="both"?(Z=S[1]+ce-E[0],W=S[1]+ye+E[2]):(Z=S[1]+(ce+ye-P.displaySize[1])/2,W=Z+P.displaySize[1]),{image:P,top:Z,right:X,bottom:W,left:ne,collisionPadding:F}}class Eo extends N{constructor(d,b,E,S,k){super(d,b),this.angle=S,this.z=E,k!==void 0&&(this.segment=k)}clone(){return new Eo(this.x,this.y,this.z,this.angle,this.segment)}}function rd(x,d,b,E,S){if(d.segment===void 0)return!0;let k=d,P=d.segment+1,F=0;for(;F>-b/2;){if(P--,P<0)return!1;F-=x[P].dist(k),k=x[P]}F+=x[P].dist(x[P+1]),P++;const $=[];let V=0;for(;F<b/2;){const Z=x[P],X=x[P+1];if(!X)return!1;let W=x[P-1].angleTo(Z)-Z.angleTo(X);for(W=Math.abs((W+3*Math.PI)%(2*Math.PI)-Math.PI),$.push({distance:F,angleDelta:W}),V+=W;F-$[0].distance>E;)V-=$.shift().angleDelta;if(V>S)return!1;P++,F+=Z.dist(X)}return!0}function nd(x){let d=0;for(let b=0;b<x.length-1;b++)d+=x[b].dist(x[b+1]);return d}function od(x,d,b){return x?.6*d*b:0}function sd(x,d){return Math.max(x?x.right-x.left:0,d?d.right-d.left:0)}function Lp(x,d,b,E,S,k){const P=od(b,S,k),F=sd(b,E)*k;let $=0;const V=nd(x)/2;for(let Z=0;Z<x.length-1;Z++){const X=x[Z],W=x[Z+1],ne=X.dist(W);if($+ne>V){const ce=(V-$)/ne,ye=Pi(X.x,W.x,ce),Me=Pi(X.y,W.y,ce),Ce=new Eo(ye,Me,0,W.angleTo(X),Z);return!P||rd(x,Ce,F,P,d)?Ce:void 0}$+=ne}}function zp(x,d,b,E,S,k,P,F,$){const V=od(E,k,P),Z=sd(E,S),X=Z*P,W=x[0].x===0||x[0].x===$||x[0].y===0||x[0].y===$;return d-X<d/4&&(d=X+d/4),ad(x,W?d/2*F%d:(Z/2+2*k)*P*F%d,d,V,b,X,W,!1,$)}function ad(x,d,b,E,S,k,P,F,$){const V=k/2,Z=nd(x);let X=0,W=d-b,ne=[];for(let ce=0;ce<x.length-1;ce++){const ye=x[ce],Me=x[ce+1],Ce=ye.dist(Me),ze=Me.angleTo(ye);for(;W+b<X+Ce;){W+=b;const $e=(W-X)/Ce,qe=Pi(ye.x,Me.x,$e),Ge=Pi(ye.y,Me.y,$e);if(qe>=0&&qe<$&&Ge>=0&&Ge<$&&W-V>=0&&W+V<=Z){const Ye=new Eo(qe,Ge,0,ze,ce);Ye._round(),E&&!rd(x,Ye,k,E,S)||ne.push(Ye)}}X+=Ce}return F||ne.length||P||(ne=ad(x,X/2,b,E,S,k,P,!0,$)),ne}function ld(x,d,b,E,S){const k=[];for(let P=0;P<x.length;P++){const F=x[P];let $;for(let V=0;V<F.length-1;V++){let Z=F[V],X=F[V+1];Z.x<d&&X.x<d||(Z.x<d?Z=new N(d,Z.y+(d-Z.x)/(X.x-Z.x)*(X.y-Z.y))._round():X.x<d&&(X=new N(d,Z.y+(d-Z.x)/(X.x-Z.x)*(X.y-Z.y))._round()),Z.y<b&&X.y<b||(Z.y<b?Z=new N(Z.x+(b-Z.y)/(X.y-Z.y)*(X.x-Z.x),b)._round():X.y<b&&(X=new N(Z.x+(b-Z.y)/(X.y-Z.y)*(X.x-Z.x),b)._round()),Z.x>=E&&X.x>=E||(Z.x>=E?Z=new N(E,Z.y+(E-Z.x)/(X.x-Z.x)*(X.y-Z.y))._round():X.x>=E&&(X=new N(E,Z.y+(E-Z.x)/(X.x-Z.x)*(X.y-Z.y))._round()),Z.y>=S&&X.y>=S||(Z.y>=S?Z=new N(Z.x+(S-Z.y)/(X.y-Z.y)*(X.x-Z.x),S)._round():X.y>=S&&(X=new N(Z.x+(S-Z.y)/(X.y-Z.y)*(X.x-Z.x),S)._round()),$&&Z.equals($[$.length-1])||($=[Z],k.push($)),$.push(X)))))}}return k}Ft("Anchor",Eo);const rl=1e20;function hd(x,d,b,E,S,k,P,F,$){for(let V=d;V<d+E;V++)cd(x,b*k+V,k,S,P,F,$);for(let V=b;V<b+S;V++)cd(x,V*k+d,1,E,P,F,$)}function cd(x,d,b,E,S,k,P){k[0]=0,P[0]=-rl,P[1]=rl,S[0]=x[d];for(let F=1,$=0,V=0;F<E;F++){S[F]=x[d+F*b];const Z=F*F;do{const X=k[$];V=(S[F]-S[X]+Z-X*X)/(F-X)/2}while(V<=P[$]&&--$>-1);$++,k[$]=F,P[$]=V,P[$+1]=rl}for(let F=0,$=0;F<E;F++){for(;P[$+1]<F;)$++;const V=k[$],Z=F-V;x[d+F*b]=S[V]+Z*Z}}const Ac={none:0,ideographs:1,all:2};class ta{constructor(d,b,E){this.requestManager=d,this.localGlyphMode=b,this.localFontFamily=E,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(d){this.url=d}getGlyphs(d,b){const E=[];for(const S in d)for(const k of d[S])E.push({stack:S,id:k});Se(E,({stack:S,id:k},P)=>{let F=this.entries[S];F||(F=this.entries[S]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let $=F.glyphs[k];if($!==void 0)return void P(null,{stack:S,id:k,glyph:$});if($=this._tinySDF(F,S,k),$)return F.glyphs[k]=$,void P(null,{stack:S,id:k,glyph:$});const V=Math.floor(k/256);if(256*V>65535)return void P(new Error("glyphs > 65535 not supported"));if(F.ranges[V])return void P(null,{stack:S,id:k,glyph:$});let Z=F.requests[V];Z||(Z=F.requests[V]=[],ta.loadGlyphRange(S,V,this.url,this.requestManager,(X,W)=>{if(W){F.ascender=W.ascender,F.descender=W.descender;for(const ne in W.glyphs)this._doesCharSupportLocalGlyph(+ne)||(F.glyphs[+ne]=W.glyphs[+ne]);F.ranges[V]=!0}for(const ne of Z)ne(X,W);delete F.requests[V]})),Z.push((X,W)=>{X?P(X):W&&P(null,{stack:S,id:k,glyph:W.glyphs[k]||null})})},(S,k)=>{if(S)b(S);else if(k){const P={};for(const{stack:F,id:$,glyph:V}of k)P[F]===void 0&&(P[F]={}),P[F].glyphs===void 0&&(P[F].glyphs={}),P[F].glyphs[$]=V&&{id:V.id,bitmap:V.bitmap.clone(),metrics:V.metrics},P[F].ascender=this.entries[F].ascender,P[F].descender=this.entries[F].descender;b(null,P)}})}_doesCharSupportLocalGlyph(d){return this.localGlyphMode!==Ac.none&&(this.localGlyphMode===Ac.all?!!this.localFontFamily:!!this.localFontFamily&&(Zo(d)||Xo(d)||mo(d)||Ns(d))||$s(d))}_tinySDF(d,b,E){const S=this.localFontFamily;if(!S||!this._doesCharSupportLocalGlyph(E))return;let k=d.tinySDF;if(!k){let ye="400";/bold/i.test(b)?ye="900":/medium/i.test(b)?ye="500":/light/i.test(b)&&(ye="200"),k=d.tinySDF=new ta.TinySDF({fontFamily:S,fontWeight:ye,fontSize:48,buffer:6,radius:16}),k.fontWeight=ye}if(this.localGlyphs[k.fontWeight][E])return this.localGlyphs[k.fontWeight][E];const P=String.fromCharCode(E),{data:F,width:$,height:V,glyphWidth:Z,glyphHeight:X,glyphLeft:W,glyphTop:ne,glyphAdvance:ce}=k.draw(P);return this.localGlyphs[k.fontWeight][E]={id:E,bitmap:new bo({width:$,height:V},F),metrics:{width:Z/2,height:X/2,left:W/2,top:ne/2-27,advance:ce/2,localGlyph:!0}}}}function ud(x,d,b,E){const S=[],k=x.image,P=k.pixelRatio,F=k.paddedRect.w-2,$=k.paddedRect.h-2,V=x.right-x.left,Z=x.bottom-x.top,X=k.stretchX||[[0,F]],W=k.stretchY||[[0,$]],ne=(at,dt)=>at+dt[1]-dt[0],ce=X.reduce(ne,0),ye=W.reduce(ne,0),Me=F-ce,Ce=$-ye;let ze=0,$e=ce,qe=0,Ge=ye,Ye=0,ot=Me,et=0,At=Ce;if(k.content&&E){const at=k.content;ze=vh(X,0,at[0]),qe=vh(W,0,at[1]),$e=vh(X,at[0],at[2]),Ge=vh(W,at[1],at[3]),Ye=at[0]-ze,et=at[1]-qe,ot=at[2]-at[0]-$e,At=at[3]-at[1]-Ge}const ut=(at,dt,mt,ht)=>{const It=bh(at.stretch-ze,$e,V,x.left),Bt=wh(at.fixed-Ye,ot,at.stretch,ce),pi=bh(dt.stretch-qe,Ge,Z,x.top),ji=wh(dt.fixed-et,At,dt.stretch,ye),oi=bh(mt.stretch-ze,$e,V,x.left),zi=wh(mt.fixed-Ye,ot,mt.stretch,ce),kt=bh(ht.stretch-qe,Ge,Z,x.top),Gi=wh(ht.fixed-et,At,ht.stretch,ye),Bi=new N(It,pi),hr=new N(oi,pi),cr=new N(oi,kt),mr=new N(It,kt),Mr=new N(Bt/P,ji/P),Ui=new N(zi/P,Gi/P),Fi=d*Math.PI/180;if(Fi){const ur=Math.sin(Fi),xr=Math.cos(Fi),Pr=[xr,-ur,ur,xr];Bi._matMult(Pr),hr._matMult(Pr),mr._matMult(Pr),cr._matMult(Pr)}const Ki=at.stretch+at.fixed,Dr=dt.stretch+dt.fixed;return{tl:Bi,tr:hr,bl:mr,br:cr,tex:{x:k.paddedRect.x+1+Ki,y:k.paddedRect.y+1+Dr,w:mt.stretch+mt.fixed-Ki,h:ht.stretch+ht.fixed-Dr},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Mr,pixelOffsetBR:Ui,minFontScaleX:ot/P/V,minFontScaleY:At/P/Z,isSDF:b}};if(E&&(k.stretchX||k.stretchY)){const at=dd(X,Me,ce),dt=dd(W,Ce,ye);for(let mt=0;mt<at.length-1;mt++){const ht=at[mt],It=at[mt+1];for(let Bt=0;Bt<dt.length-1;Bt++)S.push(ut(ht,dt[Bt],It,dt[Bt+1]))}}else S.push(ut({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:F+1},{fixed:0,stretch:$+1}));return S}function vh(x,d,b){let E=0;for(const S of x)E+=Math.max(d,Math.min(b,S[1]))-Math.max(d,Math.min(b,S[0]));return E}function dd(x,d,b){const E=[{fixed:-1,stretch:0}];for(const[S,k]of x){const P=E[E.length-1];E.push({fixed:S-P.stretch,stretch:P.stretch}),E.push({fixed:S-P.stretch,stretch:P.stretch+(k-S)})}return E.push({fixed:d+1,stretch:b}),E}function bh(x,d,b,E){return x/d*b+E}function wh(x,d,b,E){return x-d*b/E}function Fp(x,d,b,E){const S=d+x.positionedLines[E].lineOffset;return E===0?b+S/2:b+(S+(d+x.positionedLines[E-1].lineOffset))/2}ta.loadGlyphRange=function(x,d,b,E,S){const k=256*d,P=k+255,F=E.transformRequest(E.normalizeGlyphsURL(b).replace("{fontstack}",x).replace("{range}",`${k}-${P}`),we.Glyphs);re(F,($,V)=>{if($)S($);else if(V){const Z={},X=function(W){return new tl(W).readFields(kp,{})}(V);for(const W of X.glyphs)Z[W.id]=W;S(null,{glyphs:Z,ascender:X.ascender,descender:X.descender})}})},ta.TinySDF=class{constructor({fontSize:x=24,buffer:d=3,radius:b=8,cutoff:E=.25,fontFamily:S="sans-serif",fontWeight:k="normal",fontStyle:P="normal"}){this.buffer=d,this.cutoff=E,this.radius=b;const F=this.size=x+4*d,$=this._createCanvas(F),V=this.ctx=$.getContext("2d",{willReadFrequently:!0});V.font=`${P} ${k} ${x}px ${S}`,V.textBaseline="alphabetic",V.textAlign="left",V.fillStyle="black",this.gridOuter=new Float64Array(F*F),this.gridInner=new Float64Array(F*F),this.f=new Float64Array(F),this.z=new Float64Array(F+1),this.v=new Uint16Array(F)}_createCanvas(x){const d=document.createElement("canvas");return d.width=d.height=x,d}draw(x){const{width:d,actualBoundingBoxAscent:b,actualBoundingBoxDescent:E,actualBoundingBoxLeft:S,actualBoundingBoxRight:k}=this.ctx.measureText(x),P=Math.floor(b),F=Math.min(this.size-this.buffer,Math.ceil(k-S)),$=Math.min(this.size-this.buffer,Math.ceil(b)+Math.ceil(E)),V=F+2*this.buffer,Z=$+2*this.buffer,X=V*Z,W=new Uint8ClampedArray(X),ne={data:W,width:V,height:Z,glyphWidth:F,glyphHeight:$,glyphTop:P,glyphLeft:0,glyphAdvance:d};if(F===0||$===0)return ne;const{ctx:ce,buffer:ye,gridInner:Me,gridOuter:Ce}=this;ce.clearRect(ye,ye,F,$),ce.fillText(x,ye,ye+P+1);const ze=ce.getImageData(ye,ye,F,$);Ce.fill(rl,0,X),Me.fill(0,0,X);for(let $e=0;$e<$;$e++)for(let qe=0;qe<F;qe++){const Ge=ze.data[4*($e*F+qe)+3]/255;if(Ge===0)continue;const Ye=($e+ye)*V+qe+ye;if(Ge===1)Ce[Ye]=0,Me[Ye]=rl;else{const ot=.5-Ge;Ce[Ye]=ot>0?ot*ot:0,Me[Ye]=ot<0?ot*ot:0}}hd(Ce,0,0,V,Z,V,this.f,this.v,this.z),hd(Me,ye,ye,F,$,V,this.f,this.v,this.z);for(let $e=0;$e<X;$e++){const qe=Math.sqrt(Ce[$e])-Math.sqrt(Me[$e]);W[$e]=Math.round(255-255*(qe/this.radius+this.cutoff))}return ne}};class Op{constructor(d=[],b=$p){if(this.data=d,this.length=this.data.length,this.compare=b,this.length>0)for(let E=(this.length>>1)-1;E>=0;E--)this._down(E)}push(d){this.data.push(d),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const d=this.data[0],b=this.data.pop();return this.length--,this.length>0&&(this.data[0]=b,this._down(0)),d}peek(){return this.data[0]}_up(d){const{data:b,compare:E}=this,S=b[d];for(;d>0;){const k=d-1>>1,P=b[k];if(E(S,P)>=0)break;b[d]=P,d=k}b[d]=S}_down(d){const{data:b,compare:E}=this,S=this.length>>1,k=b[d];for(;d<S;){let P=1+(d<<1),F=b[P];const $=P+1;if($<this.length&&E(b[$],F)<0&&(P=$,F=b[$]),E(F,k)>=0)break;b[d]=F,d=P}b[d]=k}}function $p(x,d){return x<d?-1:x>d?1:0}function Np(x,d=1,b=!1){let E=1/0,S=1/0,k=-1/0,P=-1/0;const F=x[0];for(let ne=0;ne<F.length;ne++){const ce=F[ne];(!ne||ce.x<E)&&(E=ce.x),(!ne||ce.y<S)&&(S=ce.y),(!ne||ce.x>k)&&(k=ce.x),(!ne||ce.y>P)&&(P=ce.y)}const $=Math.min(k-E,P-S);let V=$/2;const Z=new Op([],Up);if($===0)return new N(E,S);for(let ne=E;ne<k;ne+=$)for(let ce=S;ce<P;ce+=$)Z.push(new ia(ne+V,ce+V,V,x));let X=function(ne){let ce=0,ye=0,Me=0;const Ce=ne[0];for(let ze=0,$e=Ce.length,qe=$e-1;ze<$e;qe=ze++){const Ge=Ce[ze],Ye=Ce[qe],ot=Ge.x*Ye.y-Ye.x*Ge.y;ye+=(Ge.x+Ye.x)*ot,Me+=(Ge.y+Ye.y)*ot,ce+=3*ot}return new ia(ye/ce,Me/ce,0,ne)}(x),W=Z.length;for(;Z.length;){const ne=Z.pop();(ne.d>X.d||!X.d)&&(X=ne,b&&console.log("found best %d after %d probes",Math.round(1e4*ne.d)/1e4,W)),ne.max-X.d<=d||(V=ne.h/2,Z.push(new ia(ne.p.x-V,ne.p.y-V,V,x)),Z.push(new ia(ne.p.x+V,ne.p.y-V,V,x)),Z.push(new ia(ne.p.x-V,ne.p.y+V,V,x)),Z.push(new ia(ne.p.x+V,ne.p.y+V,V,x)),W+=4)}return b&&(console.log(`num probes: ${W}`),console.log(`best distance: ${X.d}`)),X.p}function Up(x,d){return d.max-x.max}function ia(x,d,b,E){this.p=new N(x,d),this.h=b,this.d=function(S,k){let P=!1,F=1/0;for(let $=0;$<k.length;$++){const V=k[$];for(let Z=0,X=V.length,W=X-1;Z<X;W=Z++){const ne=V[Z],ce=V[W];ne.y>S.y!=ce.y>S.y&&S.x<(ce.x-ne.x)*(S.y-ne.y)/(ce.y-ne.y)+ne.x&&(P=!P),F=Math.min(F,hu(S,ne,ce))}}return(P?1:-1)*Math.sqrt(F)}(this.p,E),this.max=this.d+this.h*Math.SQRT2}const Ic=Number.POSITIVE_INFINITY,Vp=Math.sqrt(2);function fd(x,d){return d[1]!==Ic?function(b,E,S){let k=0,P=0;switch(E=Math.abs(E),S=Math.abs(S),b){case"top-right":case"top-left":case"top":P=S-7;break;case"bottom-right":case"bottom-left":case"bottom":P=7-S}switch(b){case"top-right":case"bottom-right":case"right":k=-E;break;case"top-left":case"bottom-left":case"left":k=E}return[k,P]}(x,d[0],d[1]):function(b,E){let S=0,k=0;E<0&&(E=0);const P=E/Vp;switch(b){case"top-right":case"top-left":k=P-7;break;case"bottom-right":case"bottom-left":k=7-P;break;case"bottom":k=7-E;break;case"top":k=E-7}switch(b){case"top-right":case"bottom-right":S=-P;break;case"top-left":case"bottom-left":S=P;break;case"left":S=E;break;case"right":S=-E}return[S,k]}(x,d[0])}function jp(x,d,b,E,S,k,P,F,$){x.createArrays(),x.tilePixelRatio=ki/(512*x.overscaling),x.compareText={},x.iconsNeedLinear=!1;const V=x.layers[0].layout,Z=x.layers[0]._unevaluatedLayout._values,X={};if(x.textSizeData.kind==="composite"){const{minZoom:ce,maxZoom:ye}=x.textSizeData;X.compositeTextSizes=[Z["text-size"].possiblyEvaluate(new ie(ce),F),Z["text-size"].possiblyEvaluate(new ie(ye),F)]}if(x.iconSizeData.kind==="composite"){const{minZoom:ce,maxZoom:ye}=x.iconSizeData;X.compositeIconSizes=[Z["icon-size"].possiblyEvaluate(new ie(ce),F),Z["icon-size"].possiblyEvaluate(new ie(ye),F)]}X.layoutTextSize=Z["text-size"].possiblyEvaluate(new ie($+1),F),X.layoutIconSize=Z["icon-size"].possiblyEvaluate(new ie($+1),F),X.textMaxSize=Z["text-size"].possiblyEvaluate(new ie(18),F);const W=V.get("text-rotation-alignment")==="map"&&V.get("symbol-placement")!=="point",ne=V.get("text-size");for(const ce of x.features){const ye=V.get("text-font").evaluate(ce,{},F).join(","),Me=ne.evaluate(ce,{},F),Ce=X.layoutTextSize.evaluate(ce,{},F),ze=(X.layoutIconSize.evaluate(ce,{},F),{horizontal:{},vertical:void 0}),$e=ce.text;let qe,Ge=[0,0];if($e){const et=$e.toString(),At=V.get("text-letter-spacing").evaluate(ce,{},F)*Cr,ut=V.get("text-line-height").evaluate(ce,{},F)*Cr,at=Vs(et)?At:0,dt=V.get("text-anchor").evaluate(ce,{},F),mt=V.get("text-variable-anchor");if(!mt){const oi=V.get("text-radial-offset").evaluate(ce,{},F);Ge=oi?fd(dt,[oi*Cr,Ic]):V.get("text-offset").evaluate(ce,{},F).map(zi=>zi*Cr)}let ht=W?"center":V.get("text-justify").evaluate(ce,{},F);const It=V.get("symbol-placement"),Bt=It==="point",pi=It==="point"?V.get("text-max-width").evaluate(ce,{},F)*Cr:0,ji=oi=>{x.allowVerticalPlacement&&Cn(et)&&(ze.vertical=Tc($e,d,b,S,ye,pi,ut,dt,oi,at,Ge,sn.vertical,!0,It,Ce,Me))};if(!W&&mt){const oi=ht==="auto"?mt.map(kt=>kc(kt)):[ht];let zi=!1;for(let kt=0;kt<oi.length;kt++){const Gi=oi[kt];if(!ze.horizontal[Gi])if(zi)ze.horizontal[Gi]=ze.horizontal[0];else{const Bi=Tc($e,d,b,S,ye,pi,ut,"center",Gi,at,Ge,sn.horizontal,!1,It,Ce,Me);Bi&&(ze.horizontal[Gi]=Bi,zi=Bi.positionedLines.length===1)}}ji("left")}else{if(ht==="auto"&&(ht=kc(dt)),Bt||V.get("text-writing-mode").indexOf("horizontal")>=0||!Cn(et)){const oi=Tc($e,d,b,S,ye,pi,ut,dt,ht,at,Ge,sn.horizontal,!1,It,Ce,Me);oi&&(ze.horizontal[ht]=oi)}ji(It==="point"?"left":ht)}}let Ye=!1;if(ce.icon&&ce.icon.name){const et=E[ce.icon.name];et&&(qe=Bp(S[ce.icon.name],V.get("icon-offset").evaluate(ce,{},F),V.get("icon-anchor").evaluate(ce,{},F)),Ye=et.sdf,x.sdfIcons===void 0?x.sdfIcons=et.sdf:x.sdfIcons!==et.sdf&&ft("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(et.pixelRatio!==x.pixelRatio||V.get("icon-rotate").constantOr(1)!==0)&&(x.iconsNeedLinear=!0))}const ot=md(ze.horizontal)||ze.vertical;x.iconsInText||(x.iconsInText=!!ot&&ot.iconsInText),(ot||qe)&&Gp(x,ce,ze,qe,E,X,Ce,0,Ge,Ye,P,F)}k&&x.generateCollisionDebugBuffers($,x.collisionBoxArray)}function kc(x){switch(x){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Gp(x,d,b,E,S,k,P,F,$,V,Z,X){let W=k.textMaxSize.evaluate(d,{},X);W===void 0&&(W=P);const ne=x.layers[0].layout,ce=ne.get("icon-offset").evaluate(d,{},X),ye=md(b.horizontal)||b.vertical,Me=P/24,Ce=x.tilePixelRatio*W/24,ze=x.tilePixelRatio*ne.get("symbol-spacing"),$e=ne.get("text-padding")*x.tilePixelRatio,qe=ne.get("icon-padding")*x.tilePixelRatio,Ge=Q(ne.get("text-max-angle")),Ye=ne.get("text-rotation-alignment")==="map"&&ne.get("symbol-placement")!=="point",ot=ne.get("icon-rotation-alignment")==="map"&&ne.get("symbol-placement")!=="point",et=ne.get("symbol-placement"),At=ze/2,ut=ne.get("icon-text-fit");let at;E&&ut!=="none"&&(x.allowVerticalPlacement&&b.vertical&&(at=id(E,b.vertical,ut,ne.get("icon-text-fit-padding"),ce,Me)),ye&&(E=id(E,ye,ut,ne.get("icon-text-fit-padding"),ce,Me)));const dt=(mt,ht)=>{ht.x<0||ht.x>=ki||ht.y<0||ht.y>=ki||function(It,Bt,pi,ji,oi,zi,kt,Gi,Bi,hr,cr,mr,Mr,Ui,Fi,Ki,Dr,ur,xr,Pr,Qi,Zr,qi,dr,fr){const or=It.addToLineVertexArray(Bt,ji);let tr,gr,Zi,Br,xn,an,fn,ln=0,Lr=0,Qn=0,oa=0,sa=-1,aa=-1;const Fn={};let Xd=Ga(""),Gc=0,qc=0;if(Bi._unevaluatedLayout.getValue("text-radial-offset")===void 0?[Gc,qc]=Bi.layout.get("text-offset").evaluate(Qi,{},fr).map(Wr=>Wr*Cr):(Gc=Bi.layout.get("text-radial-offset").evaluate(Qi,{},fr)*Cr,qc=Ic),It.allowVerticalPlacement&&oi.vertical){const Wr=oi.vertical;if(Fi)an=Cc(Wr),Gi&&(fn=Cc(Gi));else{const Kr=Bi.layout.get("text-rotate").evaluate(Qi,{},fr)+90;Zi=Eh(hr,pi,Bt,cr,mr,Mr,Wr,Ui,Kr,Ki),Gi&&(Br=Eh(hr,pi,Bt,cr,mr,Mr,Gi,ur,Kr))}}if(zi){const Wr=Bi.layout.get("icon-rotate").evaluate(Qi,{},fr),Kr=Bi.layout.get("icon-text-fit")!=="none",hl=ud(zi,Wr,qi,Kr),Xc=Gi?ud(Gi,Wr,qi,Kr):void 0;gr=Eh(hr,pi,Bt,cr,mr,Mr,zi,ur,Wr),ln=4*hl.length;const Yd=It.iconSizeData;let ns=null;Yd.kind==="source"?(ns=[Rn*Bi.layout.get("icon-size").evaluate(Qi,{},fr)],ns[0]>To&&ft(`${It.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Yd.kind==="composite"&&(ns=[Rn*Zr.compositeIconSizes[0].evaluate(Qi,{},fr),Rn*Zr.compositeIconSizes[1].evaluate(Qi,{},fr)],(ns[0]>To||ns[1]>To)&&ft(`${It.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),It.addSymbols(It.icon,hl,ns,Pr,xr,Qi,!1,pi,Bt,or.lineStartIndex,or.lineLength,-1,dr,fr),sa=It.icon.placedSymbolArray.length-1,Xc&&(Lr=4*Xc.length,It.addSymbols(It.icon,Xc,ns,Pr,xr,Qi,sn.vertical,pi,Bt,or.lineStartIndex,or.lineLength,-1,dr,fr),aa=It.icon.placedSymbolArray.length-1)}for(const Wr in oi.horizontal){const Kr=oi.horizontal[Wr];tr||(Xd=Ga(Kr.text),Fi?xn=Cc(Kr):tr=Eh(hr,pi,Bt,cr,mr,Mr,Kr,Ui,Bi.layout.get("text-rotate").evaluate(Qi,{},fr),Ki));const hl=Kr.positionedLines.length===1;if(Qn+=pd(It,pi,Bt,Kr,kt,Bi,Fi,Qi,Ki,or,oi.vertical?sn.horizontal:sn.horizontalOnly,hl?Object.keys(oi.horizontal):[Wr],Fn,sa,Zr,dr,fr),hl)break}oi.vertical&&(oa+=pd(It,pi,Bt,oi.vertical,kt,Bi,Fi,Qi,Ki,or,sn.vertical,["vertical"],Fn,aa,Zr,dr,fr));let ko=-1;const Zc=(Wr,Kr)=>Wr?Math.max(Wr,Kr):Kr;ko=Zc(xn,ko),ko=Zc(an,ko),ko=Zc(fn,ko);const mm=ko>-1?1:0;It.glyphOffsetArray.length>=Mo.MAX_GLYPHS&&ft("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Qi.sortKey!==void 0&&It.addToSortKeyRanges(It.symbolInstances.length,Qi.sortKey),It.symbolInstances.emplaceBack(pi.x,pi.y,pi.z,Bt.x,Bt.y,Fn.right>=0?Fn.right:-1,Fn.center>=0?Fn.center:-1,Fn.left>=0?Fn.left:-1,Fn.vertical>=0?Fn.vertical:-1,sa,aa,Xd,tr!==void 0?tr:It.collisionBoxArray.length,tr!==void 0?tr+1:It.collisionBoxArray.length,Zi!==void 0?Zi:It.collisionBoxArray.length,Zi!==void 0?Zi+1:It.collisionBoxArray.length,gr!==void 0?gr:It.collisionBoxArray.length,gr!==void 0?gr+1:It.collisionBoxArray.length,Br||It.collisionBoxArray.length,Br?Br+1:It.collisionBoxArray.length,cr,Qn,oa,ln,Lr,mm,0,Gc,qc,ko)}(x,ht,ht,mt,b,E,S,at,x.layers[0],x.collisionBoxArray,d.index,d.sourceLayerIndex,x.index,$e,Ye,$,0,qe,ot,ce,d,k,V,Z,X)};if(et==="line")for(const mt of ld(d.geometry,0,0,ki,ki)){const ht=zp(mt,ze,Ge,b.vertical||ye,E,24,Ce,x.overscaling,ki);for(const It of ht){const Bt=ye;Bt&&qp(x,Bt.text,At,It)||dt(mt,It)}}else if(et==="line-center"){for(const mt of d.geometry)if(mt.length>1){const ht=Lp(mt,Ge,b.vertical||ye,E,24,Ce);ht&&dt(mt,ht)}}else if(d.type==="Polygon")for(const mt of gc(d.geometry,0)){const ht=Np(mt,16);dt(mt[0],new Eo(ht.x,ht.y,0,0,void 0))}else if(d.type==="LineString")for(const mt of d.geometry)dt(mt,new Eo(mt[0].x,mt[0].y,0,0,void 0));else if(d.type==="Point")for(const mt of d.geometry)for(const ht of mt)dt([ht],new Eo(ht.x,ht.y,0,0,void 0))}const To=32640;function pd(x,d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye,Me){const Ce=function(qe,Ge,Ye,ot,et,At,ut,at){const dt=[];if(Ge.positionedLines.length===0)return dt;const mt=ot.layout.get("text-rotate").evaluate(At,{})*Math.PI/180,ht=function(oi){const zi=oi[0],kt=oi[1],Gi=zi*kt;return Gi>0?[zi,-kt]:Gi<0?[-zi,kt]:zi===0?[kt,zi]:[kt,-zi]}(Ye);let It=Math.abs(Ge.top-Ge.bottom);for(const oi of Ge.positionedLines)It-=oi.lineOffset;const Bt=Ge.positionedLines.length,pi=It/Bt;let ji=Ge.top-Ye[1];for(let oi=0;oi<Bt;++oi){const zi=Ge.positionedLines[oi];ji=Fp(Ge,pi,ji,oi);for(const kt of zi.positionedGlyphs){if(!kt.rect)continue;const Gi=kt.rect||{};let Bi=4,hr=!0,cr=1,mr=0;if(kt.imageName){const Zi=ut[kt.imageName];if(!Zi)continue;if(Zi.sdf){ft("SDF images are not supported in formatted text and will be ignored.");continue}hr=!1,cr=Zi.pixelRatio,Bi=1/cr}const Mr=(et||at)&&kt.vertical,Ui=kt.metrics.advance*kt.scale/2,Fi=kt.metrics,Ki=kt.rect;if(Ki===null)continue;at&&Ge.verticalizable&&(mr=kt.imageName?Ui-kt.metrics.width*kt.scale/2:0);const Dr=et?[kt.x+Ui,kt.y]:[0,0];let ur=[0,0],xr=[0,0],Pr=!1;et||(Mr?(xr=[kt.x+Ui+ht[0],kt.y+ht[1]-mr],Pr=!0):ur=[kt.x+Ui+Ye[0],kt.y+Ye[1]-mr]);const Qi=Ki.w*kt.scale/(cr*(kt.localGlyph?2:1)),Zr=Ki.h*kt.scale/(cr*(kt.localGlyph?2:1));let qi,dr,fr,or;if(Mr){const Zi=kt.y-ji,Br=new N(-Ui,Ui-Zi),xn=-Math.PI/2,an=new N(...xr);qi=new N(-Ui+ur[0],ur[1]),qi._rotateAround(xn,Br)._add(an),qi.x+=-Zi+Ui,qi.y-=(Fi.left-Bi)*kt.scale;const fn=kt.imageName?Fi.advance*kt.scale:Cr*kt.scale,ln=String.fromCharCode(kt.glyph);yp(ln)?qi.x+=(1-Bi)*kt.scale:xp(ln)?qi.x+=fn-Fi.height*kt.scale+(-Bi-1)*kt.scale:qi.x+=kt.imageName||Fi.width+2*Bi===Ki.w&&Fi.height+2*Bi===Ki.h?(fn-Zr)/2:(fn-(Fi.height+2*Bi)*kt.scale)/2,dr=new N(qi.x,qi.y-Qi),fr=new N(qi.x+Zr,qi.y),or=new N(qi.x+Zr,qi.y-Qi)}else{const Zi=(Fi.left-Bi)*kt.scale-Ui+ur[0],Br=(-Fi.top-Bi)*kt.scale+ur[1],xn=Zi+Qi,an=Br+Zr;qi=new N(Zi,Br),dr=new N(xn,Br),fr=new N(Zi,an),or=new N(xn,an)}if(mt){let Zi;Zi=et?new N(0,0):Pr?new N(ht[0],ht[1]):new N(Ye[0],Ye[1]),qi._rotateAround(mt,Zi),dr._rotateAround(mt,Zi),fr._rotateAround(mt,Zi),or._rotateAround(mt,Zi)}const tr=new N(0,0),gr=new N(0,0);dt.push({tl:qi,tr:dr,bl:fr,br:or,tex:Gi,writingMode:Ge.writingMode,glyphOffset:Dr,sectionIndex:kt.sectionIndex,isSDF:hr,pixelOffsetTL:tr,pixelOffsetBR:gr,minFontScaleX:0,minFontScaleY:0})}}return dt}(0,E,$,k,P,F,S,x.allowVerticalPlacement),ze=x.textSizeData;let $e=null;ze.kind==="source"?($e=[Rn*k.layout.get("text-size").evaluate(F,{},Me)],$e[0]>To&&ft(`${x.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):ze.kind==="composite"&&($e=[Rn*ce.compositeTextSizes[0].evaluate(F,{},Me),Rn*ce.compositeTextSizes[1].evaluate(F,{},Me)],($e[0]>To||$e[1]>To)&&ft(`${x.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),x.addSymbols(x.text,Ce,$e,$,P,F,Z,d,b,V.lineStartIndex,V.lineLength,ne,ye,Me);for(const qe of X)W[qe]=x.text.placedSymbolArray.length-1;return 4*Ce.length}function md(x){for(const d in x)return x[d];return null}function Eh(x,d,b,E,S,k,P,F,$,V){let Z=P.top,X=P.bottom,W=P.left,ne=P.right;const ce=P.collisionPadding;if(ce&&(W-=ce[0],Z-=ce[1],ne+=ce[2],X+=ce[3]),$){const ye=new N(W,Z),Me=new N(ne,Z),Ce=new N(W,X),ze=new N(ne,X),$e=Q($);let qe=new N(0,0);V&&(qe=new N(V[0],V[1])),ye._rotateAround($e,qe),Me._rotateAround($e,qe),Ce._rotateAround($e,qe),ze._rotateAround($e,qe),W=Math.min(ye.x,Me.x,Ce.x,ze.x),ne=Math.max(ye.x,Me.x,Ce.x,ze.x),Z=Math.min(ye.y,Me.y,Ce.y,ze.y),X=Math.max(ye.y,Me.y,Ce.y,ze.y)}return x.emplaceBack(d.x,d.y,d.z,b.x,b.y,W,Z,ne,X,F,E,S,k),x.length-1}function Cc(x){x.collisionPadding&&(x.top-=x.collisionPadding[1],x.bottom+=x.collisionPadding[3]);const d=x.bottom-x.top;return d>0?Math.max(10,d):null}function qp(x,d,b,E){const S=x.compareText;if(d in S){const k=S[d];for(let P=k.length-1;P>=0;P--)if(E.dist(k[P])<b)return!0}else S[d]=[];return S[d].push(E),!1}const Zp=is.VectorTileFeature.types,Xp=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Th(x,d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce,ye){const Me=Z?Math.min(To,Math.round(Z[0])):0,Ce=Z?Math.min(To,Math.round(Z[1])):0;x.emplaceBack(d,b,Math.round(32*P),Math.round(32*F),$,V,(Me<<1)+(X?1:0),Ce,16*W,16*ne,256*ce,256*ye,E,S,k,0)}function Dc(x,d,b){x.emplaceBack(d.x,d.y,b),x.emplaceBack(d.x,d.y,b),x.emplaceBack(d.x,d.y,b),x.emplaceBack(d.x,d.y,b)}function Yp(x){for(const d of x.sections)if(Wh(d.text))return!0;return!1}class Pc{constructor(d){this.layoutVertexArray=new fi,this.indexArray=new lr,this.programConfigurations=d,this.segments=new Tr,this.dynamicLayoutVertexArray=new si,this.opacityVertexArray=new Li,this.placedSymbolArray=new eh}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(d,b,E,S){this.isEmpty()||(E&&(this.layoutVertexBuffer=d.createVertexBuffer(this.layoutVertexArray,up.members),this.indexBuffer=d.createIndexBuffer(this.indexArray,b),this.dynamicLayoutVertexBuffer=d.createVertexBuffer(this.dynamicLayoutVertexArray,dp.members,!0),this.opacityVertexBuffer=d.createVertexBuffer(this.opacityVertexArray,Xp,!0),this.opacityVertexBuffer.itemSize=1),(E||S)&&this.programConfigurations.upload(d))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Ft("SymbolBuffers",Pc);class Rc{constructor(d,b,E){this.layoutVertexArray=new d,this.layoutAttributes=b,this.indexArray=new E,this.segments=new Tr,this.collisionVertexArray=new Rr,this.collisionVertexArrayExt=new si}upload(d){this.layoutVertexBuffer=d.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=d.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=d.createVertexBuffer(this.collisionVertexArray,fp.members,!0),this.collisionVertexBufferExt=d.createVertexBuffer(this.collisionVertexArrayExt,pp.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Ft("CollisionBuffers",Rc);class Mo{constructor(d){this.collisionBoxArray=d.collisionBoxArray,this.zoom=d.zoom,this.overscaling=d.overscaling,this.layers=d.layers,this.layerIds=this.layers.map(P=>P.id),this.index=d.index,this.pixelRatio=d.pixelRatio,this.sourceLayerIndex=d.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=lc([]),this.placementViewportMatrix=lc([]);const b=this.layers[0]._unevaluatedLayout._values;this.textSizeData=vc(this.zoom,b["text-size"]),this.iconSizeData=vc(this.zoom,b["icon-size"]);const E=this.layers[0].layout,S=E.get("symbol-sort-key"),k=E.get("symbol-z-order");this.canOverlap=E.get("text-allow-overlap")||E.get("icon-allow-overlap")||E.get("text-ignore-placement")||E.get("icon-ignore-placement"),this.sortFeaturesByKey=k!=="viewport-y"&&S.constantOr(1)!==void 0,this.sortFeaturesByY=(k==="viewport-y"||k==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=E.get("text-writing-mode").map(P=>sn[P]),this.stateDependentLayerIds=this.layers.filter(P=>P.isStateDependent()).map(P=>P.id),this.sourceID=d.sourceID}createArrays(){this.text=new Pc(new Jo(this.layers,this.zoom,d=>/^text/.test(d))),this.icon=new Pc(new Jo(this.layers,this.zoom,d=>/^icon/.test(d))),this.glyphOffsetArray=new th,this.lineVertexArray=new Ko,this.symbolInstances=new yo}calculateGlyphDependencies(d,b,E,S,k){for(let P=0;P<d.length;P++)if(b[d.charCodeAt(P)]=!0,S&&k){const F=el[d.charAt(P)];F&&(b[F.charCodeAt(0)]=!0)}}populate(d,b,E,S){const k=this.layers[0],P=k.layout,F=P.get("text-font"),$=P.get("text-field"),V=P.get("icon-image"),Z=($.value.kind!=="constant"||$.value.value instanceof Sr&&!$.value.value.isEmpty()||$.value.value.toString().length>0)&&(F.value.kind!=="constant"||F.value.value.length>0),X=V.value.kind!=="constant"||!!V.value.value||Object.keys(V.parameters).length>0,W=P.get("symbol-sort-key");if(this.features=[],!Z&&!X)return;const ne=b.iconDependencies,ce=b.glyphDependencies,ye=b.availableImages,Me=new ie(this.zoom);for(const{feature:Ce,id:ze,index:$e,sourceLayerIndex:qe}of d){const Ge=k._featureFilter.needGeometry,Ye=ts(Ce,Ge);if(!k._featureFilter.filter(Me,Ye,E))continue;let ot,et;if(Ge||(Ye.geometry=Kn(Ce,E,S)),Z){const ut=k.getValueAndResolveTokens("text-field",Ye,E,ye),at=Sr.factory(ut);Yp(at)&&(this.hasRTLText=!0),(!this.hasRTLText||Y()==="unavailable"||this.hasRTLText&&ee.isParsed())&&(ot=_p(at,k,Ye))}if(X){const ut=k.getValueAndResolveTokens("icon-image",Ye,E,ye);et=ut instanceof Xr?ut:Xr.fromString(ut)}if(!ot&&!et)continue;const At=this.sortFeaturesByKey?W.evaluate(Ye,{},E):void 0;if(this.features.push({id:ze,text:ot,icon:et,index:$e,sourceLayerIndex:qe,geometry:Ye.geometry,properties:Ce.properties,type:Zp[Ce.type],sortKey:At}),et&&(ne[et.name]=!0),ot){const ut=F.evaluate(Ye,{},E).join(","),at=P.get("text-rotation-alignment")==="map"&&P.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(sn.vertical)>=0;for(const dt of ot.sections)if(dt.image)ne[dt.image.name]=!0;else{const mt=Cn(ot.toString()),ht=dt.fontStack||ut,It=ce[ht]=ce[ht]||{};this.calculateGlyphDependencies(dt.text,It,at,this.allowVerticalPlacement,mt)}}}P.get("symbol-placement")==="line"&&(this.features=function(Ce){const ze={},$e={},qe=[];let Ge=0;function Ye(ut){qe.push(Ce[ut]),Ge++}function ot(ut,at,dt){const mt=$e[ut];return delete $e[ut],$e[at]=mt,qe[mt].geometry[0].pop(),qe[mt].geometry[0]=qe[mt].geometry[0].concat(dt[0]),mt}function et(ut,at,dt){const mt=ze[at];return delete ze[at],ze[ut]=mt,qe[mt].geometry[0].shift(),qe[mt].geometry[0]=dt[0].concat(qe[mt].geometry[0]),mt}function At(ut,at,dt){const mt=dt?at[0][at[0].length-1]:at[0][0];return`${ut}:${mt.x}:${mt.y}`}for(let ut=0;ut<Ce.length;ut++){const at=Ce[ut],dt=at.geometry,mt=at.text?at.text.toString():null;if(!mt){Ye(ut);continue}const ht=At(mt,dt),It=At(mt,dt,!0);if(ht in $e&&It in ze&&$e[ht]!==ze[It]){const Bt=et(ht,It,dt),pi=ot(ht,It,qe[Bt].geometry);delete ze[ht],delete $e[It],$e[At(mt,qe[pi].geometry,!0)]=pi,qe[Bt].geometry=null}else ht in $e?ot(ht,It,dt):It in ze?et(ht,It,dt):(Ye(ut),ze[ht]=Ge-1,$e[It]=Ge-1)}return qe.filter(ut=>ut.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Ce,ze)=>Ce.sortKey-ze.sortKey)}update(d,b,E,S){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(d,b,this.layers,E,S),this.icon.programConfigurations.updatePaintArrays(d,b,this.layers,E,S))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(d){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(d),this.iconCollisionBox.upload(d)),this.text.upload(d,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(d,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(d,b){const E=this.lineVertexArray.length;if(d.segment!==void 0){let S=d.dist(b[d.segment+1]),k=d.dist(b[d.segment]);const P={};for(let F=d.segment+1;F<b.length;F++)P[F]={x:b[F].x,y:b[F].y,tileUnitDistanceFromAnchor:S},F<b.length-1&&(S+=b[F+1].dist(b[F]));for(let F=d.segment||0;F>=0;F--)P[F]={x:b[F].x,y:b[F].y,tileUnitDistanceFromAnchor:k},F>0&&(k+=b[F-1].dist(b[F]));for(let F=0;F<b.length;F++){const $=P[F];this.lineVertexArray.emplaceBack($.x,$.y,$.tileUnitDistanceFromAnchor)}}return{lineStartIndex:E,lineLength:this.lineVertexArray.length-E}}addSymbols(d,b,E,S,k,P,F,$,V,Z,X,W,ne,ce){const ye=d.indexArray,Me=d.layoutVertexArray,Ce=d.segments.prepareSegment(4*b.length,Me,ye,this.canOverlap?P.sortKey:void 0),ze=this.glyphOffsetArray.length,$e=Ce.vertexLength,qe=this.allowVerticalPlacement&&F===sn.vertical?Math.PI/2:0,Ge=P.text&&P.text.sections;for(let Ye=0;Ye<b.length;Ye++){const{tl:ot,tr:et,bl:At,br:ut,tex:at,pixelOffsetTL:dt,pixelOffsetBR:mt,minFontScaleX:ht,minFontScaleY:It,glyphOffset:Bt,isSDF:pi,sectionIndex:ji}=b[Ye],oi=Ce.vertexLength,zi=Bt[1];Th(Me,$.x,$.y,$.z,V.x,V.y,ot.x,zi+ot.y,at.x,at.y,E,pi,dt.x,dt.y,ht,It),Th(Me,$.x,$.y,$.z,V.x,V.y,et.x,zi+et.y,at.x+at.w,at.y,E,pi,mt.x,dt.y,ht,It),Th(Me,$.x,$.y,$.z,V.x,V.y,At.x,zi+At.y,at.x,at.y+at.h,E,pi,dt.x,mt.y,ht,It),Th(Me,$.x,$.y,$.z,V.x,V.y,ut.x,zi+ut.y,at.x+at.w,at.y+at.h,E,pi,mt.x,mt.y,ht,It),Dc(d.dynamicLayoutVertexArray,$,qe),ye.emplaceBack(oi,oi+1,oi+2),ye.emplaceBack(oi+1,oi+2,oi+3),Ce.vertexLength+=4,Ce.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Bt[0]),Ye!==b.length-1&&ji===b[Ye+1].sectionIndex||d.programConfigurations.populatePaintArrays(Me.length,P,P.index,{},ne,ce,Ge&&Ge[ji])}d.placedSymbolArray.emplaceBack($.x,$.y,$.z,V.x,V.y,ze,this.glyphOffsetArray.length-ze,$e,Z,X,V.segment,E?E[0]:0,E?E[1]:0,S[0],S[1],F,0,!1,0,W,0)}_commitLayoutVertex(d,b,E,S,k,P,F){d.emplaceBack(b,E,S,k,P,Math.round(F.x),Math.round(F.y))}_addCollisionDebugVertices(d,b,E,S,k,P,F){const $=E.segments.prepareSegment(4,E.layoutVertexArray,E.indexArray),V=$.vertexLength,Z=F.tileAnchorX,X=F.tileAnchorY;for(let ne=0;ne<4;ne++)E.collisionVertexArray.emplaceBack(0,0,0,0);E.collisionVertexArrayExt.emplaceBack(b,-d.padding,-d.padding),E.collisionVertexArrayExt.emplaceBack(b,d.padding,-d.padding),E.collisionVertexArrayExt.emplaceBack(b,d.padding,d.padding),E.collisionVertexArrayExt.emplaceBack(b,-d.padding,d.padding),this._commitLayoutVertex(E.layoutVertexArray,S,k,P,Z,X,new N(d.x1,d.y1)),this._commitLayoutVertex(E.layoutVertexArray,S,k,P,Z,X,new N(d.x2,d.y1)),this._commitLayoutVertex(E.layoutVertexArray,S,k,P,Z,X,new N(d.x2,d.y2)),this._commitLayoutVertex(E.layoutVertexArray,S,k,P,Z,X,new N(d.x1,d.y2)),$.vertexLength+=4;const W=E.indexArray;W.emplaceBack(V,V+1),W.emplaceBack(V+1,V+2),W.emplaceBack(V+2,V+3),W.emplaceBack(V+3,V),$.primitiveLength+=4}_addTextDebugCollisionBoxes(d,b,E,S,k,P){for(let F=S;F<k;F++){const $=E.get(F),V=this.getSymbolInstanceTextSize(d,P,b,F);this._addCollisionDebugVertices($,V,this.textCollisionBox,$.projectedAnchorX,$.projectedAnchorY,$.projectedAnchorZ,P)}}_addIconDebugCollisionBoxes(d,b,E,S,k,P){for(let F=S;F<k;F++){const $=E.get(F),V=this.getSymbolInstanceIconSize(d,b,F);this._addCollisionDebugVertices($,V,this.iconCollisionBox,$.projectedAnchorX,$.projectedAnchorY,$.projectedAnchorZ,P)}}generateCollisionDebugBuffers(d,b){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Rc(wr,ju.members,Hi),this.iconCollisionBox=new Rc(wr,ju.members,Hi);const E=Ks(this.iconSizeData,d),S=Ks(this.textSizeData,d);for(let k=0;k<this.symbolInstances.length;k++){const P=this.symbolInstances.get(k);this._addTextDebugCollisionBoxes(S,d,b,P.textBoxStartIndex,P.textBoxEndIndex,P),this._addTextDebugCollisionBoxes(S,d,b,P.verticalTextBoxStartIndex,P.verticalTextBoxEndIndex,P),this._addIconDebugCollisionBoxes(E,d,b,P.iconBoxStartIndex,P.iconBoxEndIndex,P),this._addIconDebugCollisionBoxes(E,d,b,P.verticalIconBoxStartIndex,P.verticalIconBoxEndIndex,P)}}getSymbolInstanceTextSize(d,b,E,S){const k=this.text.placedSymbolArray.get(b.rightJustifiedTextSymbolIndex>=0?b.rightJustifiedTextSymbolIndex:b.centerJustifiedTextSymbolIndex>=0?b.centerJustifiedTextSymbolIndex:b.leftJustifiedTextSymbolIndex>=0?b.leftJustifiedTextSymbolIndex:b.verticalPlacedTextSymbolIndex>=0?b.verticalPlacedTextSymbolIndex:S),P=_h(this.textSizeData,d,k)/Cr;return this.tilePixelRatio*P}getSymbolInstanceIconSize(d,b,E){const S=this.icon.placedSymbolArray.get(E),k=_h(this.iconSizeData,d,S);return this.tilePixelRatio*k}_commitDebugCollisionVertexUpdate(d,b,E){d.emplaceBack(b,-E,-E),d.emplaceBack(b,E,-E),d.emplaceBack(b,E,E),d.emplaceBack(b,-E,E)}_updateTextDebugCollisionBoxes(d,b,E,S,k,P){for(let F=S;F<k;F++){const $=E.get(F),V=this.getSymbolInstanceTextSize(d,P,b,F);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,V,$.padding)}}_updateIconDebugCollisionBoxes(d,b,E,S,k){for(let P=S;P<k;P++){const F=E.get(P),$=this.getSymbolInstanceIconSize(d,b,P);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,$,F.padding)}}updateCollisionDebugBuffers(d,b){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const E=Ks(this.iconSizeData,d),S=Ks(this.textSizeData,d);for(let k=0;k<this.symbolInstances.length;k++){const P=this.symbolInstances.get(k);this._updateTextDebugCollisionBoxes(S,d,b,P.textBoxStartIndex,P.textBoxEndIndex,P),this._updateTextDebugCollisionBoxes(S,d,b,P.verticalTextBoxStartIndex,P.verticalTextBoxEndIndex,P),this._updateIconDebugCollisionBoxes(E,d,b,P.iconBoxStartIndex,P.iconBoxEndIndex),this._updateIconDebugCollisionBoxes(E,d,b,P.verticalIconBoxStartIndex,P.verticalIconBoxEndIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(d,b,E,S,k,P,F,$,V){const Z={};for(let X=b;X<E;X++){const W=d.get(X);Z.textBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,padding:W.padding,projectedAnchorX:W.projectedAnchorX,projectedAnchorY:W.projectedAnchorY,projectedAnchorZ:W.projectedAnchorZ,tileAnchorX:W.tileAnchorX,tileAnchorY:W.tileAnchorY},Z.textFeatureIndex=W.featureIndex;break}for(let X=S;X<k;X++){const W=d.get(X);Z.verticalTextBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,padding:W.padding,projectedAnchorX:W.projectedAnchorX,projectedAnchorY:W.projectedAnchorY,projectedAnchorZ:W.projectedAnchorZ,tileAnchorX:W.tileAnchorX,tileAnchorY:W.tileAnchorY},Z.verticalTextFeatureIndex=W.featureIndex;break}for(let X=P;X<F;X++){const W=d.get(X);Z.iconBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,padding:W.padding,projectedAnchorX:W.projectedAnchorX,projectedAnchorY:W.projectedAnchorY,projectedAnchorZ:W.projectedAnchorZ,tileAnchorX:W.tileAnchorX,tileAnchorY:W.tileAnchorY},Z.iconFeatureIndex=W.featureIndex;break}for(let X=$;X<V;X++){const W=d.get(X);Z.verticalIconBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,padding:W.padding,projectedAnchorX:W.projectedAnchorX,projectedAnchorY:W.projectedAnchorY,projectedAnchorZ:W.projectedAnchorZ,tileAnchorX:W.tileAnchorX,tileAnchorY:W.tileAnchorY},Z.verticalIconFeatureIndex=W.featureIndex;break}return Z}deserializeCollisionBoxes(d){this.collisionArrays=[];for(let b=0;b<this.symbolInstances.length;b++){const E=this.symbolInstances.get(b);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(d,E.textBoxStartIndex,E.textBoxEndIndex,E.verticalTextBoxStartIndex,E.verticalTextBoxEndIndex,E.iconBoxStartIndex,E.iconBoxEndIndex,E.verticalIconBoxStartIndex,E.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(d,b){const E=d.placedSymbolArray.get(b),S=E.vertexStartIndex+4*E.numGlyphs;for(let k=E.vertexStartIndex;k<S;k+=4)d.indexArray.emplaceBack(k,k+1,k+2),d.indexArray.emplaceBack(k+1,k+2,k+3)}getSortedSymbolIndexes(d){if(this.sortedAngle===d&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const b=Math.sin(d),E=Math.cos(d),S=[],k=[],P=[];for(let F=0;F<this.symbolInstances.length;++F){P.push(F);const $=this.symbolInstances.get(F);S.push(0|Math.round(b*$.tileAnchorX+E*$.tileAnchorY)),k.push($.featureIndex)}return P.sort((F,$)=>S[F]-S[$]||k[$]-k[F]),P}addToSortKeyRanges(d,b){const E=this.sortKeyRanges[this.sortKeyRanges.length-1];E&&E.sortKey===b?E.symbolInstanceEnd=d+1:this.sortKeyRanges.push({sortKey:b,symbolInstanceStart:d,symbolInstanceEnd:d+1})}sortFeatures(d){if(this.sortFeaturesByY&&this.sortedAngle!==d&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(d),this.sortedAngle=d,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const b of this.symbolInstanceIndexes){const E=this.symbolInstances.get(b);this.featureSortOrder.push(E.featureIndex),[E.rightJustifiedTextSymbolIndex,E.centerJustifiedTextSymbolIndex,E.leftJustifiedTextSymbolIndex].forEach((S,k,P)=>{S>=0&&P.indexOf(S)===k&&this.addIndicesForPlacedSymbol(this.text,S)}),E.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,E.verticalPlacedTextSymbolIndex),E.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,E.placedIconSymbolIndex),E.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,E.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Ft("SymbolBucket",Mo,{omit:["layers","collisionBoxArray","features","compareText"]}),Mo.MAX_GLYPHS=65535,Mo.addDynamicAttributes=Dc;const Hp=new rt({"symbol-placement":new Ee(Ve.layout_symbol["symbol-placement"]),"symbol-spacing":new Ee(Ve.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ee(Ve.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Pe(Ve.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ee(Ve.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Ee(Ve.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ee(Ve.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ee(Ve.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ee(Ve.layout_symbol["icon-rotation-alignment"]),"icon-size":new Pe(Ve.layout_symbol["icon-size"]),"icon-text-fit":new Ee(Ve.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ee(Ve.layout_symbol["icon-text-fit-padding"]),"icon-image":new Pe(Ve.layout_symbol["icon-image"]),"icon-rotate":new Pe(Ve.layout_symbol["icon-rotate"]),"icon-padding":new Ee(Ve.layout_symbol["icon-padding"]),"icon-keep-upright":new Ee(Ve.layout_symbol["icon-keep-upright"]),"icon-offset":new Pe(Ve.layout_symbol["icon-offset"]),"icon-anchor":new Pe(Ve.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ee(Ve.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ee(Ve.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ee(Ve.layout_symbol["text-rotation-alignment"]),"text-field":new Pe(Ve.layout_symbol["text-field"]),"text-font":new Pe(Ve.layout_symbol["text-font"]),"text-size":new Pe(Ve.layout_symbol["text-size"]),"text-max-width":new Pe(Ve.layout_symbol["text-max-width"]),"text-line-height":new Pe(Ve.layout_symbol["text-line-height"]),"text-letter-spacing":new Pe(Ve.layout_symbol["text-letter-spacing"]),"text-justify":new Pe(Ve.layout_symbol["text-justify"]),"text-radial-offset":new Pe(Ve.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ee(Ve.layout_symbol["text-variable-anchor"]),"text-anchor":new Pe(Ve.layout_symbol["text-anchor"]),"text-max-angle":new Ee(Ve.layout_symbol["text-max-angle"]),"text-writing-mode":new Ee(Ve.layout_symbol["text-writing-mode"]),"text-rotate":new Pe(Ve.layout_symbol["text-rotate"]),"text-padding":new Ee(Ve.layout_symbol["text-padding"]),"text-keep-upright":new Ee(Ve.layout_symbol["text-keep-upright"]),"text-transform":new Pe(Ve.layout_symbol["text-transform"]),"text-offset":new Pe(Ve.layout_symbol["text-offset"]),"text-allow-overlap":new Ee(Ve.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ee(Ve.layout_symbol["text-ignore-placement"]),"text-optional":new Ee(Ve.layout_symbol["text-optional"])});var Bc={paint:new rt({"icon-opacity":new Pe(Ve.paint_symbol["icon-opacity"]),"icon-color":new Pe(Ve.paint_symbol["icon-color"]),"icon-halo-color":new Pe(Ve.paint_symbol["icon-halo-color"]),"icon-halo-width":new Pe(Ve.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Pe(Ve.paint_symbol["icon-halo-blur"]),"icon-translate":new Ee(Ve.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ee(Ve.paint_symbol["icon-translate-anchor"]),"text-opacity":new Pe(Ve.paint_symbol["text-opacity"]),"text-color":new Pe(Ve.paint_symbol["text-color"],{runtimeType:ir,getOverride:x=>x.textColor,hasOverride:x=>!!x.textColor}),"text-halo-color":new Pe(Ve.paint_symbol["text-halo-color"]),"text-halo-width":new Pe(Ve.paint_symbol["text-halo-width"]),"text-halo-blur":new Pe(Ve.paint_symbol["text-halo-blur"]),"text-translate":new Ee(Ve.paint_symbol["text-translate"]),"text-translate-anchor":new Ee(Ve.paint_symbol["text-translate-anchor"])}),layout:Hp};class gd{constructor(d){this.type=d.property.overrides?d.property.overrides.runtimeType:hn,this.defaultValue=d}evaluate(d){if(d.formattedSection){const b=this.defaultValue.property.overrides;if(b&&b.hasOverride(d.formattedSection))return b.getOverride(d.formattedSection)}return d.feature&&d.featureState?this.defaultValue.evaluate(d.feature,d.featureState):this.defaultValue.property.specification.default}eachChild(d){this.defaultValue.isConstant()||d(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ft("FormatSectionOverride",gd,{omit:["defaultValue"]});class Mh extends _n{constructor(d){super(d,Bc)}recalculate(d,b){super.recalculate(d,b),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const E=this.layout.get("text-writing-mode");if(E){const S=[];for(const k of E)S.indexOf(k)<0&&S.push(k);this.layout._values["text-writing-mode"]=S}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(d,b,E,S){const k=this.layout.get(d).evaluate(b,{},E,S),P=this._unevaluatedLayout._values[d];return P.isDataDriven()||rn(P.value)||!k?k:function(F,$){return $.replace(/{([^{}]+)}/g,(V,Z)=>Z in F?String(F[Z]):"")}(b.properties,k)}createBucket(d){return new Mo(d)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const d of Bc.paint.overridableProperties){if(!Mh.hasPaintOverride(this.layout,d))continue;const b=this.paint.get(d),E=new gd(b),S=new Sa(E,b.property.specification);let k=null;k=b.value.kind==="constant"||b.value.kind==="source"?new Sn("source",S):new ks("composite",S,b.value.zoomStops,b.value._interpolationType),this.paint._values[d]=new ke(b.property,k,b.parameters)}}_handleOverridablePaintPropertyUpdate(d,b,E){return!(!this.layout||b.isDataDriven()||E.isDataDriven())&&Mh.hasPaintOverride(this.layout,d)}static hasPaintOverride(d,b){const E=d.get("text-field"),S=Bc.paint.properties[b];let k=!1;const P=F=>{for(const $ of F)if(S.overrides&&S.overrides.hasOverride($))return void(k=!0)};if(E.value.kind==="constant"&&E.value.value instanceof Sr)P(E.value.value.sections);else if(E.value.kind==="source"){const F=V=>{k||(V instanceof Vn&&rr(V.value)===eo?P(V.value.sections):V instanceof Co?P(V.sections):V.eachChild(F))},$=E.value;$._styleExpression&&F($._styleExpression.expression)}return k}getProgramConfiguration(d){return new Wn(this,d)}}var Wp={paint:new rt({"background-color":new Ee(Ve.paint_background["background-color"]),"background-pattern":new Je(Ve.paint_background["background-pattern"]),"background-opacity":new Ee(Ve.paint_background["background-opacity"])})},Kp={paint:new rt({"raster-opacity":new Ee(Ve.paint_raster["raster-opacity"]),"raster-hue-rotate":new Ee(Ve.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ee(Ve.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ee(Ve.paint_raster["raster-brightness-max"]),"raster-saturation":new Ee(Ve.paint_raster["raster-saturation"]),"raster-contrast":new Ee(Ve.paint_raster["raster-contrast"]),"raster-resampling":new Ee(Ve.paint_raster["raster-resampling"]),"raster-fade-duration":new Ee(Ve.paint_raster["raster-fade-duration"])})};class Jp extends _n{constructor(d){super(d,{}),this.implementation=d}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){}serialize(){}onAdd(d){this.implementation.onAdd&&this.implementation.onAdd(d,d.painter.context.gl)}onRemove(d){this.implementation.onRemove&&this.implementation.onRemove(d,d.painter.context.gl)}}var Qp={paint:new rt({"sky-type":new Ee(Ve.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ee(Ve.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ee(Ve.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ee(Ve.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ee(Ve.paint_sky["sky-gradient-radius"]),"sky-gradient":new Ke(Ve.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ee(Ve.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ee(Ve.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ee(Ve.paint_sky["sky-opacity"])})};function Lc(x,d,b){const E=Ys(0,0,1),S=wu(hc());return function(k,P,F){F*=.5;var $=P[0],V=P[1],Z=P[2],X=P[3],W=Math.sin(F),ne=Math.cos(F);k[0]=$*ne-Z*W,k[1]=V*ne+X*W,k[2]=Z*ne+$*W,k[3]=X*ne-V*W}(S,S,b?-Q(x)+Math.PI:Q(x)),Eu(S,S,-Q(d)),bu(E,E,S),vu(E,E)}const em={circle:class extends _n{constructor(x){super(x,xf)}createBucket(x){return new oc(x)}queryRadius(x){const d=x;return Xs("circle-radius",this,d)+Xs("circle-stroke-width",this,d)+lh(this.paint.get("circle-translate"))}queryIntersectsFeature(x,d,b,E,S,k,P,F){const $=fu(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),k.angle,x.pixelToTileUnitsFactor),V=this.paint.get("circle-radius").evaluate(d,b)+this.paint.get("circle-stroke-width").evaluate(d,b);return Mu(x,E,k,P,F,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",$,V)}getProgramIds(){return["circle"]}getProgramConfiguration(x){return new Wn(this,x)}},heatmap:class extends _n{createBucket(x){return new Au(x)}constructor(x){super(x,Af),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(x){x==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=dc({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(x){return Xs("heatmap-radius",this,x)}queryIntersectsFeature(x,d,b,E,S,k,P,F){const $=this.paint.get("heatmap-radius").evaluate(d,b);return Mu(x,E,k,P,F,!0,!0,new N(0,0),$)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(x){return new Wn(this,x)}},hillshade:class extends _n{constructor(x){super(x,If)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getProgramConfiguration(x){return new Wn(this,x)}},fill:class extends _n{constructor(x){super(x,qf)}getProgramIds(){const x=this.paint.get("fill-pattern"),d=x&&x.constantOr(1),b=[d?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&b.push(d&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),b}getProgramConfiguration(x){return new Wn(this,x)}recalculate(x,d){super.recalculate(x,d);const b=this.paint._values["fill-outline-color"];b.value.kind==="constant"&&b.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(x){return new mh(x)}queryRadius(){return lh(this.paint.get("fill-translate"))}queryIntersectsFeature(x,d,b,E,S,k){return!x.queryGeometry.isAboveHorizon&&lu(du(x.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),k.angle,x.pixelToTileUnitsFactor),E)}isTileClipped(){return!0}},"fill-extrusion":class extends _n{constructor(x){super(x,ip)}createBucket(x){return new xc(x)}queryRadius(){return lh(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(x){return new Wn(this,x)}queryIntersectsFeature(x,d,b,E,S,k,P,F,$){const V=fu(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),k.angle,x.pixelToTileUnitsFactor),Z=this.paint.get("fill-extrusion-height").evaluate(d,b),X=this.paint.get("fill-extrusion-base").evaluate(d,b),W=[0,0],ne=F&&k.elevation,ce=k.elevation?k.elevation.exaggeration():1;if(ne){const Ce=x.tile.getBucket(this).centroidVertexArray,ze=$+1;if(ze<Ce.length){const $e=Ce.get(ze);W[0]=$e.a_centroid_pos0,W[1]=$e.a_centroid_pos1}}if(W[0]===0&&W[1]===1)return!1;const ye=function(Ce,ze,$e,qe,Ge,Ye,ot,et,At){return Ye?function(ut,at,dt,mt,ht,It,Bt,pi,ji){const oi=[],zi=[],kt=[0,0,0,1];for(const Gi of ut){const Bi=[],hr=[];for(const cr of Gi){const mr=cr.x+mt.x,Mr=cr.y+mt.y,Ui=rp(mr,Mr,at,dt,It,Bt,pi,ji);kt[0]=mr,kt[1]=Mr,kt[2]=Ui.base,kt[3]=1,Xa(kt,kt,ht),kt[3]=Math.max(kt[3],1e-5);const Fi=$u([kt[0]/kt[3],kt[1]/kt[3],kt[2]/kt[3]]);kt[0]=mr,kt[1]=Mr,kt[2]=Ui.top,kt[3]=1,Xa(kt,kt,ht),kt[3]=Math.max(kt[3],1e-5);const Ki=$u([kt[0]/kt[3],kt[1]/kt[3],kt[2]/kt[3]]);Bi.push(Fi),hr.push(Ki)}oi.push(Bi),zi.push(hr)}return[oi,zi]}(Ce,ze,$e,qe,Ge,Ye,ot,et,At):function(ut,at,dt,mt,ht){const It=[],Bt=[],pi=ht[8]*at,ji=ht[9]*at,oi=ht[10]*at,zi=ht[11]*at,kt=ht[8]*dt,Gi=ht[9]*dt,Bi=ht[10]*dt,hr=ht[11]*dt;for(const cr of ut){const mr=[],Mr=[];for(const Ui of cr){const Fi=Ui.x+mt.x,Ki=Ui.y+mt.y,Dr=ht[0]*Fi+ht[4]*Ki+ht[12],ur=ht[1]*Fi+ht[5]*Ki+ht[13],xr=ht[2]*Fi+ht[6]*Ki+ht[14],Pr=ht[3]*Fi+ht[7]*Ki+ht[15],Qi=Dr+pi,Zr=ur+ji,qi=xr+oi,dr=Math.max(Pr+zi,1e-5),fr=Dr+kt,or=ur+Gi,tr=xr+Bi,gr=Math.max(Pr+hr,1e-5),Zi=new N(Qi/dr,Zr/dr);Zi.z=qi/dr,mr.push(Zi);const Br=new N(fr/gr,or/gr);Br.z=tr/gr,Mr.push(Br)}It.push(mr),Bt.push(Mr)}return[It,Bt]}(Ce,ze,$e,qe,Ge)}(E,X,Z,V,P,ne?F:null,W,ce,k.center.lat),Me=x.queryGeometry;return function(Ce,ze,$e){let qe=1/0;lu($e,ze)&&(qe=Ou($e,ze[0]));for(let Ge=0;Ge<ze.length;Ge++){const Ye=ze[Ge],ot=Ce[Ge];for(let et=0;et<Ye.length-1;et++){const At=Ye[et],ut=[At,Ye[et+1],ot[et+1],ot[et],At];au($e,ut)&&(qe=Math.min(qe,Ou($e,ut)))}}return qe!==1/0&&qe}(ye[0],ye[1],Me.isPointQuery()?Me.screenBounds:Me.screenGeometry)}},line:class extends _n{constructor(x){super(x,Nu),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(x){if(x==="line-gradient"){const d=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=d._styleExpression&&d._styleExpression.expression instanceof Ro,this.gradientVersion=(this.gradientVersion+1)%H}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(x,d){super.recalculate(x,d),this.paint._values["line-floorwidth"]=Uu.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,x)}createBucket(x){return new gh(x)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(x){return new Wn(this,x)}queryRadius(x){const d=x,b=Vu(Xs("line-width",this,d),Xs("line-gap-width",this,d)),E=Xs("line-offset",this,d);return b/2+Math.abs(E)+lh(this.paint.get("line-translate"))}queryIntersectsFeature(x,d,b,E,S,k){if(x.queryGeometry.isAboveHorizon)return!1;const P=du(x.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),k.angle,x.pixelToTileUnitsFactor),F=x.pixelToTileUnitsFactor/2*Vu(this.paint.get("line-width").evaluate(d,b),this.paint.get("line-gap-width").evaluate(d,b)),$=this.paint.get("line-offset").evaluate(d,b);return $&&(E=function(V,Z){const X=[],W=new N(0,0);for(let ne=0;ne<V.length;ne++){const ce=V[ne],ye=[];for(let Me=0;Me<ce.length;Me++){const Ce=ce[Me-1],ze=ce[Me],$e=ce[Me+1],qe=Me===0?W:ze.sub(Ce)._unit()._perp(),Ge=Me===ce.length-1?W:$e.sub(ze)._unit()._perp(),Ye=qe._add(Ge)._unit();Ye._mult(1/(Ye.x*Ge.x+Ye.y*Ge.y)),ye.push(Ye._mult(Z)._add(ze))}X.push(ye)}return X}(E,$*x.pixelToTileUnitsFactor)),function(V,Z,X){for(let W=0;W<Z.length;W++){const ne=Z[W];if(V.length>=3){for(let ce=0;ce<ne.length;ce++)if(Zs(V,ne[ce]))return!0}if(mf(V,ne,X))return!0}return!1}(P,E,F)}isTileClipped(){return!0}},symbol:Mh,background:class extends _n{constructor(x){super(x,Wp)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends _n{constructor(x){super(x,Kp)}getProgramIds(){return["raster"]}},sky:class extends _n{constructor(x){super(x,Qp),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(x){x==="sky-gradient"?this._updateColorRamp():x!=="sky-atmosphere-sun"&&x!=="sky-atmosphere-halo-color"&&x!=="sky-atmosphere-color"&&x!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=dc({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(x){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const d=x.style.light.properties.get("position");return this._lightPosition.azimuthal!==d.azimuthal||this._lightPosition.polar!==d.polar}}getCenter(x,d){const b=this.paint.get("sky-type");if(b==="atmosphere"){const E=this.paint.get("sky-atmosphere-sun"),S=!E,k=x.style.light,P=k.properties.get("position");return S&&k.properties.get("anchor")==="viewport"&&ft("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),S?Lc(P.azimuthal,90-P.polar,d):Lc(E[0],90-E[1],d)}if(b==="gradient"){const E=this.paint.get("sky-gradient-center");return Lc(E[0],90-E[1],d)}}is3D(){return!1}isSky(){return!0}markSkyboxValid(x){this._skyboxInvalidated=!1,this._lightPosition=x.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const x=this.paint.get("sky-type");return x==="atmosphere"?["skyboxCapture","skybox"]:x==="gradient"?["skyboxGradient"]:null}}},{HTMLImageElement:_d,HTMLCanvasElement:yd,HTMLVideoElement:xd,ImageData:vd,ImageBitmap:Sh}=G;class Ah{constructor(d,b,E,S){this.context=d,this.format=E,this.texture=d.gl.createTexture(),this.update(b,S)}update(d,b,E){const{width:S,height:k}=d,{context:P}=this,{gl:F}=P;if(F.bindTexture(F.TEXTURE_2D,this.texture),P.pixelStoreUnpackFlipY.set(!1),P.pixelStoreUnpack.set(1),P.pixelStoreUnpackPremultiplyAlpha.set(this.format===F.RGBA&&(!b||b.premultiply!==!1)),E||this.size&&this.size[0]===S&&this.size[1]===k){const{x:$,y:V}=E||{x:0,y:0};d instanceof _d||d instanceof yd||d instanceof xd||d instanceof vd||Sh&&d instanceof Sh?F.texSubImage2D(F.TEXTURE_2D,0,$,V,F.RGBA,F.UNSIGNED_BYTE,d):F.texSubImage2D(F.TEXTURE_2D,0,$,V,S,k,F.RGBA,F.UNSIGNED_BYTE,d.data)}else this.size=[S,k],d instanceof _d||d instanceof yd||d instanceof xd||d instanceof vd||Sh&&d instanceof Sh?F.texImage2D(F.TEXTURE_2D,0,this.format,this.format,F.UNSIGNED_BYTE,d):F.texImage2D(F.TEXTURE_2D,0,this.format,S,k,0,this.format,F.UNSIGNED_BYTE,d.data);this.useMipmap=Boolean(b&&b.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&F.generateMipmap(F.TEXTURE_2D)}bind(d,b){const{context:E}=this,{gl:S}=E;S.bindTexture(S.TEXTURE_2D,this.texture),d!==this.filter&&(S.texParameteri(S.TEXTURE_2D,S.TEXTURE_MAG_FILTER,d),S.texParameteri(S.TEXTURE_2D,S.TEXTURE_MIN_FILTER,this.useMipmap?d===S.NEAREST?S.NEAREST_MIPMAP_NEAREST:S.LINEAR_MIPMAP_NEAREST:d),this.filter=d),b!==this.wrap&&(S.texParameteri(S.TEXTURE_2D,S.TEXTURE_WRAP_S,b),S.texParameteri(S.TEXTURE_2D,S.TEXTURE_WRAP_T,b),this.wrap=b)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:d}=this.context;d.deleteTexture(this.texture),this.texture=null}}class zc{constructor(d,b){this.width=d,this.height=b,this.nextRow=0,this.image=new bo({width:d,height:b}),this.positions={},this.uploaded=!1}getDash(d,b){const E=this.getKey(d,b);return this.positions[E]}trim(){const d=this.width,b=this.height=ct(this.nextRow);this.image.resize({width:d,height:b})}getKey(d,b){return d.join(",")+b}getDashRanges(d,b,E){const S=[];let k=d.length%2==1?-d[d.length-1]*E:0,P=d[0]*E,F=!0;S.push({left:k,right:P,isDash:F,zeroLength:d[0]===0});let $=d[0];for(let V=1;V<d.length;V++){F=!F;const Z=d[V];k=$*E,$+=Z,P=$*E,S.push({left:k,right:P,isDash:F,zeroLength:Z===0})}return S}addRoundDash(d,b,E){const S=b/2;for(let k=-E;k<=E;k++){const P=this.width*(this.nextRow+E+k);let F=0,$=d[F];for(let V=0;V<this.width;V++){V/$.right>1&&($=d[++F]);const Z=Math.abs(V-$.left),X=Math.abs(V-$.right),W=Math.min(Z,X);let ne;const ce=k/E*(S+1);if($.isDash){const ye=S-Math.abs(ce);ne=Math.sqrt(W*W+ye*ye)}else ne=S-Math.sqrt(W*W+ce*ce);this.image.data[P+V]=Math.max(0,Math.min(255,ne+128))}}}addRegularDash(d,b){for(let $=d.length-1;$>=0;--$){const V=d[$],Z=d[$+1];V.zeroLength?d.splice($,1):Z&&Z.isDash===V.isDash&&(Z.left=V.left,d.splice($,1))}const E=d[0],S=d[d.length-1];E.isDash===S.isDash&&(E.left=S.left-this.width,S.right=E.right+this.width);const k=this.width*this.nextRow;let P=0,F=d[P];for(let $=0;$<this.width;$++){$/F.right>1&&(F=d[++P]);const V=Math.abs($-F.left),Z=Math.abs($-F.right),X=Math.min(V,Z);this.image.data[k+$]=Math.max(0,Math.min(255,(F.isDash?X:-X)+b+128))}}addDash(d,b){const E=this.getKey(d,b);if(this.positions[E])return this.positions[E];const S=b==="round",k=S?7:0,P=2*k+1;if(this.nextRow+P>this.height)return ft("LineAtlas out of space"),null;d.length===0&&d.push(1);let F=0;for(let Z=0;Z<d.length;Z++)d[Z]<0&&(ft("Negative value is found in line dasharray, replacing values with 0"),d[Z]=0),F+=d[Z];if(F!==0){const Z=this.width/F,X=this.getDashRanges(d,this.width,Z);S?this.addRoundDash(X,Z,k):this.addRegularDash(X,b==="square"?.5*Z:0)}const $=this.nextRow+k;this.nextRow+=P;const V={tl:[$,k],br:[F,0]};return this.positions[E]=V,V}}Ft("LineAtlas",zc);class tm{constructor(d){this._callback=d,this._triggered=!1,typeof MessageChannel!="undefined"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){delete this._channel,this._callback=()=>{}}}const im=G.performance;function bd(x){const d=x?x.url.toString():void 0;return im.getEntriesByName(d)}class rm{constructor(){this.tasks={},this.taskQueue=[],Nt(["process"],this),this.invoker=new tm(this.process),this.nextId=0}add(d,b){const E=this.nextId++,S=function({type:k,isSymbolTile:P,zoom:F}){return F=F||0,k==="message"?0:k!=="maybePrepare"||P?k!=="parseTile"||P?k==="parseTile"&&P?300-F:k==="maybePrepare"&&P?400-F:500:200-F:100-F}(b);if(S===0){zt();try{d()}finally{}return{cancel:()=>{}}}return this.tasks[E]={fn:d,metadata:b,priority:S,id:E},this.taskQueue.push(E),this.invoker.trigger(),{cancel:()=>{delete this.tasks[E]}}}process(){zt();try{if(this.taskQueue=this.taskQueue.filter(E=>!!this.tasks[E]),!this.taskQueue.length)return;const d=this.pick();if(d===null)return;const b=this.tasks[d];if(delete this.tasks[d],this.taskQueue.length&&this.invoker.trigger(),!b)return;b.fn()}finally{}}pick(){let d=null,b=1/0;for(let S=0;S<this.taskQueue.length;S++){const k=this.tasks[this.taskQueue[S]];k.priority<b&&(b=k.priority,d=S)}if(d===null)return null;const E=this.taskQueue[d];return this.taskQueue.splice(d,1),E}remove(){this.invoker.remove()}}function Ih(x,d){const b=Math.pow(2,-x.z),E=x.x*b,S=(x.x+1)*b,k=x.y*b,P=(x.y+1)*b;if(d.name==="mercator")return{scale:1<<x.z,x:x.x,y:x.y,x2:x.x+1,y2:x.y+1,projection:d};const F=es(E),$=es(S),V=Pn(k),Z=Pn(P),X=d.project(F,V),W=d.project($,V),ne=d.project($,Z),ce=d.project(F,Z);let ye=Math.min(X.x,W.x,ne.x,ce.x),Me=Math.min(X.y,W.y,ne.y,ce.y),Ce=Math.max(X.x,W.x,ne.x,ce.x),ze=Math.max(X.y,W.y,ne.y,ce.y);const $e=b/16;function qe(Ye,ot,et,At,ut,at){const dt=(et+ut)/2,mt=(At+at)/2,ht=d.project(es(dt),Pn(mt)),It=Math.max(0,ye-ht.x,Me-ht.y,ht.x-Ce,ht.y-ze);ye=Math.min(ye,ht.x),Ce=Math.max(Ce,ht.x),Me=Math.min(Me,ht.y),ze=Math.max(ze,ht.y),It>$e&&(qe(Ye,ht,et,At,dt,mt),qe(ht,ot,dt,mt,ut,at))}qe(X,W,E,k,S,k),qe(W,ne,S,k,S,P),qe(ne,ce,S,P,E,P),qe(ce,X,E,P,E,k),ye-=$e,Me-=$e,Ce+=$e,ze+=$e;const Ge=1/Math.max(Ce-ye,ze-Me);return{scale:Ge,x:ye*Ge,y:Me*Ge,x2:Ce*Ge,y2:ze*Ge,projection:d}}function wd(x,d,b){var E=2*Math.PI*6378137/256/Math.pow(2,b);return[x*E-2*Math.PI*6378137/2,d*E-2*Math.PI*6378137/2]}class Fc{constructor(d,b,E){this.z=d,this.x=b,this.y=E,this.key=nl(0,d,d,b,E)}equals(d){return this.z===d.z&&this.x===d.x&&this.y===d.y}url(d,b){const E=(k=this.y,P=this.z,F=wd(256*(S=this.x),256*(k=Math.pow(2,P)-k-1),P),$=wd(256*(S+1),256*(k+1),P),F[0]+","+F[1]+","+$[0]+","+$[1]);var S,k,P,F,$;const V=function(Z,X,W){let ne,ce="";for(let ye=Z;ye>0;ye--)ne=1<<ye-1,ce+=(X&ne?1:0)+(W&ne?2:0);return ce}(this.z,this.x,this.y);return d[(this.x+this.y)%d.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace("{z}",String(this.z)).replace("{x}",String(this.x)).replace("{y}",String(b==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",V).replace("{bbox-epsg-3857}",E)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Ed{constructor(d,b){this.wrap=d,this.canonical=b,this.key=nl(d,b.z,b.z,b.x,b.y)}}class qr{constructor(d,b,E,S,k){this.overscaledZ=d,this.wrap=b,this.canonical=new Fc(E,+S,+k),this.key=b===0&&d===E?this.canonical.key:nl(b,d,E,S,k)}equals(d){return this.overscaledZ===d.overscaledZ&&this.wrap===d.wrap&&this.canonical.equals(d.canonical)}scaledTo(d){const b=this.canonical.z-d;return d>this.canonical.z?new qr(d,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new qr(d,this.wrap,d,this.canonical.x>>b,this.canonical.y>>b)}calculateScaledKey(d,b=!0){if(this.overscaledZ===d&&b)return this.key;if(d>this.canonical.z)return nl(this.wrap*+b,d,this.canonical.z,this.canonical.x,this.canonical.y);{const E=this.canonical.z-d;return nl(this.wrap*+b,d,d,this.canonical.x>>E,this.canonical.y>>E)}}isChildOf(d){if(d.wrap!==this.wrap)return!1;const b=this.canonical.z-d.canonical.z;return d.overscaledZ===0||d.overscaledZ<this.overscaledZ&&d.canonical.x===this.canonical.x>>b&&d.canonical.y===this.canonical.y>>b}children(d){if(this.overscaledZ>=d)return[new qr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const b=this.canonical.z+1,E=2*this.canonical.x,S=2*this.canonical.y;return[new qr(b,this.wrap,b,E,S),new qr(b,this.wrap,b,E+1,S),new qr(b,this.wrap,b,E,S+1),new qr(b,this.wrap,b,E+1,S+1)]}isLessThan(d){return this.wrap<d.wrap||!(this.wrap>d.wrap)&&(this.overscaledZ<d.overscaledZ||!(this.overscaledZ>d.overscaledZ)&&(this.canonical.x<d.canonical.x||!(this.canonical.x>d.canonical.x)&&this.canonical.y<d.canonical.y))}wrapped(){return new qr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(d){return new qr(this.overscaledZ,d,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Ed(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function nl(x,d,b,E,S){const k=1<<Math.min(b,22);let P=k*(S%k)+E%k;return x&&b<22&&(P+=k*k*((x<0?-2*x-1:2*x)%(1<<2*(22-b)))),16*(32*P+b)+(d-b)}Ft("CanonicalTileID",Fc),Ft("OverscaledTileID",qr,{omit:["projMatrix"]});class Td{constructor(d){this._stringToNumber={},this._numberToString=[];for(let b=0;b<d.length;b++){const E=d[b];this._stringToNumber[E]=b,this._numberToString[b]=E}}encode(d){return this._stringToNumber[d]}decode(d){return this._numberToString[d]}}class Md{constructor(d,b,E,S,k){this.type="Feature",this._vectorTileFeature=d,d._z=b,d._x=E,d._y=S,this.properties=d.properties,this.id=k}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(d){this._geometry=d}toJSON(){const d={geometry:this.geometry};for(const b in this)b!=="_geometry"&&b!=="_vectorTileFeature"&&(d[b]=this[b]);return d}}var nm=We([{name:"a_pos",type:"Int16",components:2}]);const dn=32,Bn=33,So=new Uint16Array(8184);for(let x=0;x<2046;x++){let d=x+2,b=0,E=0,S=0,k=0,P=0,F=0;for(1&d?S=k=P=dn:b=E=F=dn;(d>>=1)>1;){const V=b+S>>1,Z=E+k>>1;1&d?(S=b,k=E,b=P,E=F):(b=S,E=k,S=P,k=F),P=V,F=Z}const $=4*x;So[$+0]=b,So[$+1]=E,So[$+2]=S,So[$+3]=k}const Ln=new Uint16Array(2178),Ao=new Uint8Array(1089),kh=new Uint16Array(1089);function Sd(x){return x===0?-.03125:x===32?.03125:0}var Oc=We([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const Ad={type:2,extent:ki,loadGeometry:()=>[[new N(0,0),new N(8193,0),new N(8193,8193),new N(0,8193),new N(0,0)]]};class Id{constructor(d,b,E,S,k){this.tileID=d,this.uid=Ze(),this.uses=0,this.tileSize=b,this.tileZoom=E,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=k,this.expiredRequestCount=0,this.state="loading",S&&S.transform&&(this.projection=S.transform.projection)}registerFadeDuration(d){const b=d+this.timeAdded;b<Pt.now()||this.fadeEndTime&&b<this.fadeEndTime||(this.fadeEndTime=b)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=Ih(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(d,b,E){if(this.unloadVectorData(),this.state="loaded",d){d.featureIndex&&(this.latestFeatureIndex=d.featureIndex,d.rawTileData?(this.latestRawTileData=d.rawTileData,this.latestFeatureIndex.rawTileData=d.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=d.collisionBoxArray,this.buckets=function(S,k){const P={};if(!k)return P;for(const F of S){const $=F.layerIds.map(V=>k.getLayer(V)).filter(Boolean);if($.length!==0){F.layers=$,F.stateDependentLayerIds&&(F.stateDependentLayers=F.stateDependentLayerIds.map(V=>$.filter(Z=>Z.id===V)[0]));for(const V of $)P[V.id]=F}}return P}(d.buckets,b.style),this.hasSymbolBuckets=!1;for(const S in this.buckets){const k=this.buckets[S];if(k instanceof Mo){if(this.hasSymbolBuckets=!0,!E)break;k.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const S in this.buckets){const k=this.buckets[S];if(k instanceof Mo&&k.hasRTLText){this.hasRTLText=!0,ee.isLoading()||ee.isLoaded()||Y()!=="deferred"||J();break}}this.queryPadding=0;for(const S in this.buckets){const k=this.buckets[S];this.queryPadding=Math.max(this.queryPadding,b.style.getLayer(S).queryRadius(k))}d.imageAtlas&&(this.imageAtlas=d.imageAtlas),d.glyphAtlasImage&&(this.glyphAtlasImage=d.glyphAtlasImage),d.lineAtlas&&(this.lineAtlas=d.lineAtlas)}else this.collisionBoxArray=new $r}unloadVectorData(){if(this.hasData()){for(const d in this.buckets)this.buckets[d].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugIndexBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(d){return this.buckets[d.id]}upload(d){for(const E in this.buckets){const S=this.buckets[E];S.uploadPending()&&S.upload(d)}const b=d.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Ah(d,this.imageAtlas.image,b.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Ah(d,this.glyphAtlasImage,b.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new Ah(d,this.lineAtlas.image,b.ALPHA),this.lineAtlas.uploaded=!0)}prepare(d){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(d,this.imageAtlasTexture)}queryRenderedFeatures(d,b,E,S,k,P,F,$){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:S,pixelPosMatrix:F,transform:P,params:k,tileTransform:this.tileTransform},d,b,E):{}}querySourceFeatures(d,b){const E=this.latestFeatureIndex;if(!E||!E.rawTileData)return;const S=E.loadVTLayers(),k=b?b.sourceLayer:"",P=S._geojsonTileLayer||S[k];if(!P)return;const F=Oo(b&&b.filter),{z:$,x:V,y:Z}=this.tileID.canonical,X={z:$,x:V,y:Z};for(let W=0;W<P.length;W++){const ne=P.feature(W);if(F.needGeometry){const Me=ts(ne,!0);if(!F.filter(new ie(this.tileID.overscaledZ),Me,this.tileID.canonical))continue}else if(!F.filter(new ie(this.tileID.overscaledZ),ne))continue;const ce=E.getId(ne,k),ye=new Md(ne,$,V,Z,ce);ye.tile=X,d.push(ye)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(d){const b=this.expirationTime;if(d.cacheControl){const E=qt(d.cacheControl);E["max-age"]&&(this.expirationTime=Date.now()+1e3*E["max-age"])}else d.expires&&(this.expirationTime=new Date(d.expires).getTime());if(this.expirationTime){const E=Date.now();let S=!1;if(this.expirationTime>E)S=!1;else if(b)if(this.expirationTime<b)S=!0;else{const k=this.expirationTime-b;k?this.expirationTime=E+Math.max(k,3e4):S=!0}else S=!0;S?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(d,b){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(d).length===0||!b)return;const E=this.latestFeatureIndex.loadVTLayers(),S=b.style.listImages();for(const k in this.buckets){if(!b.style.hasLayer(k))continue;const P=this.buckets[k],F=P.layers[0].sourceLayer||"_geojsonTileLayer",$=E[F],V=d[F];if(!$||!V||Object.keys(V).length===0)continue;if(P.update(V,$,S,this.imageAtlas&&this.imageAtlas.patternPositions||{}),P instanceof gh||P instanceof mh){const X=b.style._getSourceCache(P.layers[0].source);b._terrain&&b._terrain.enabled&&X&&P.programConfigurations.needsUpload&&b._terrain._clearRenderCacheForTile(X.id,this.tileID)}const Z=b&&b.style&&b.style.getLayer(k);Z&&(this.queryPadding=Math.max(this.queryPadding,Z.queryRadius(P)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Pt.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(d){this.symbolFadeHoldUntil=Pt.now()+d}setDependencies(d,b){const E={};for(const S of b)E[S]=!0;this.dependencies[d]=E}hasDependency(d,b){for(const E of d){const S=this.dependencies[E];if(S){for(const k of b)if(S[k])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(d,b){if(!b||b.name==="mercator"||this._tileDebugBuffer)return;const E=Kn(Ad,this.tileID.canonical,this.tileTransform)[0],S=new Ot,k=new Er;for(let P=0;P<E.length;P++){const{x:F,y:$}=E[P];S.emplaceBack(F,$),k.emplaceBack(P)}k.emplaceBack(0),this._tileDebugIndexBuffer=d.createIndexBuffer(k),this._tileDebugBuffer=d.createVertexBuffer(S,Oc.members),this._tileDebugSegments=Tr.simpleSegment(0,0,S.length,k.length)}_makeTileBoundsBuffers(d,b){if(this._tileBoundsBuffer||!b||b.name==="mercator")return;const E=Kn(Ad,this.tileID.canonical,this.tileTransform)[0];let S,k;if(this.isRaster){const P=function(F,$){const V=Ih(F,$),Z=Math.pow(2,F.z);for(let Me=0;Me<Bn;Me++)for(let Ce=0;Ce<Bn;Ce++){const ze=es((F.x+(Ce+Sd(Ce))/dn)/Z),$e=Pn((F.y+(Me+Sd(Me))/dn)/Z),qe=$.project(ze,$e),Ge=Me*Bn+Ce;Ln[2*Ge+0]=Math.round((qe.x*V.scale-V.x)*ki),Ln[2*Ge+1]=Math.round((qe.y*V.scale-V.y)*ki)}Ao.fill(0),kh.fill(0);for(let Me=2045;Me>=0;Me--){const Ce=4*Me,ze=So[Ce+0],$e=So[Ce+1],qe=So[Ce+2],Ge=So[Ce+3],Ye=ze+qe>>1,ot=$e+Ge>>1,et=Ye+ot-$e,At=ot+ze-Ye,ut=$e*Bn+ze,at=Ge*Bn+qe,dt=ot*Bn+Ye,mt=Math.hypot((Ln[2*ut+0]+Ln[2*at+0])/2-Ln[2*dt+0],(Ln[2*ut+1]+Ln[2*at+1])/2-Ln[2*dt+1])>=16;if(Ao[dt]=Ao[dt]||(mt?1:0),Me<1022){const ht=($e+At>>1)*Bn+(ze+et>>1),It=(Ge+At>>1)*Bn+(qe+et>>1);Ao[dt]=Ao[dt]||Ao[ht]||Ao[It]}}const X=new Qt,W=new lr;let ne=0;function ce(Me,Ce){const ze=Ce*Bn+Me;return kh[ze]===0&&(X.emplaceBack(Ln[2*ze+0],Ln[2*ze+1],Me*ki/dn,Ce*ki/dn),kh[ze]=++ne),kh[ze]-1}function ye(Me,Ce,ze,$e,qe,Ge){const Ye=Me+ze>>1,ot=Ce+$e>>1;if(Math.abs(Me-qe)+Math.abs(Ce-Ge)>1&&Ao[ot*Bn+Ye])ye(qe,Ge,Me,Ce,Ye,ot),ye(ze,$e,qe,Ge,Ye,ot);else{const et=ce(Me,Ce),At=ce(ze,$e),ut=ce(qe,Ge);W.emplaceBack(et,At,ut)}}return ye(0,0,dn,dn,dn,0),ye(dn,dn,0,0,0,dn),{vertices:X,indices:W}}(this.tileID.canonical,b);S=P.vertices,k=P.indices}else{S=new Qt,k=new lr;for(const{x:F,y:$}of E)S.emplaceBack(F,$,0,0);const P=ch(S.int16,void 0,4);for(let F=0;F<P.length;F+=3)k.emplaceBack(P[F],P[F+1],P[F+2])}this._tileBoundsBuffer=d.createVertexBuffer(S,Oc.members),this._tileBoundsIndexBuffer=d.createIndexBuffer(k),this._tileBoundsSegments=Tr.simpleSegment(0,0,S.length,k.length)}}class om{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(d,b,E){const S=String(b);if(this.stateChanges[d]=this.stateChanges[d]||{},this.stateChanges[d][S]=this.stateChanges[d][S]||{},pe(this.stateChanges[d][S],E),this.deletedStates[d]===null){this.deletedStates[d]={};for(const k in this.state[d])k!==S&&(this.deletedStates[d][k]=null)}else if(this.deletedStates[d]&&this.deletedStates[d][S]===null){this.deletedStates[d][S]={};for(const k in this.state[d][S])E[k]||(this.deletedStates[d][S][k]=null)}else for(const k in E)this.deletedStates[d]&&this.deletedStates[d][S]&&this.deletedStates[d][S][k]===null&&delete this.deletedStates[d][S][k]}removeFeatureState(d,b,E){if(this.deletedStates[d]===null)return;const S=String(b);if(this.deletedStates[d]=this.deletedStates[d]||{},E&&b!==void 0)this.deletedStates[d][S]!==null&&(this.deletedStates[d][S]=this.deletedStates[d][S]||{},this.deletedStates[d][S][E]=null);else if(b!==void 0)if(this.stateChanges[d]&&this.stateChanges[d][S])for(E in this.deletedStates[d][S]={},this.stateChanges[d][S])this.deletedStates[d][S][E]=null;else this.deletedStates[d][S]=null;else this.deletedStates[d]=null}getState(d,b){const E=String(b),S=pe({},(this.state[d]||{})[E],(this.stateChanges[d]||{})[E]);if(this.deletedStates[d]===null)return{};if(this.deletedStates[d]){const k=this.deletedStates[d][b];if(k===null)return{};for(const P in k)delete S[P]}return S}initializeTileState(d,b){d.setFeatureState(this.state,b)}coalesceChanges(d,b){const E={};for(const S in this.stateChanges){this.state[S]=this.state[S]||{};const k={};for(const P in this.stateChanges[S])this.state[S][P]||(this.state[S][P]={}),pe(this.state[S][P],this.stateChanges[S][P]),k[P]=this.state[S][P];E[S]=k}for(const S in this.deletedStates){this.state[S]=this.state[S]||{};const k={};if(this.deletedStates[S]===null)for(const P in this.state[S])k[P]={},this.state[S][P]={};else for(const P in this.deletedStates[S]){if(this.deletedStates[S][P]===null)this.state[S][P]={};else for(const F of Object.keys(this.deletedStates[S][P]))delete this.state[S][P][F];k[P]=this.state[S][P]}E[S]=E[S]||{},pe(E[S],k)}if(this.stateChanges={},this.deletedStates={},Object.keys(E).length!==0)for(const S in d)d[S].setFeatureState(E,b)}}class kd{constructor(d){this.size=d,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(d,b){const E=this.toIdx(d,b);return{min:this.minimums[E],max:this.maximums[E]}}isLeaf(d,b){return this.leaves[this.toIdx(d,b)]}toIdx(d,b){return b*this.size+d}}function Cd(x,d,b,E){let S=0,k=Number.MAX_VALUE;for(let P=0;P<3;P++)if(Math.abs(E[P])<1e-15){if(b[P]<x[P]||b[P]>d[P])return null}else{const F=1/E[P];let $=(x[P]-b[P])*F,V=(d[P]-b[P])*F;if($>V){const Z=$;$=V,V=Z}if($>S&&(S=$),V<k&&(k=V),S>k)return null}return S}function Dd(x,d,b,E,S,k,P,F,$,V,Z){const X=E-x,W=S-d,ne=k-b,ce=P-x,ye=F-d,Me=$-b,Ce=Z[1]*Me-Z[2]*ye,ze=Z[2]*ce-Z[0]*Me,$e=Z[0]*ye-Z[1]*ce,qe=X*Ce+W*ze+ne*$e;if(Math.abs(qe)<1e-15)return null;const Ge=1/qe,Ye=V[0]-x,ot=V[1]-d,et=V[2]-b,At=(Ye*Ce+ot*ze+et*$e)*Ge;if(At<0||At>1)return null;const ut=ot*ne-et*W,at=et*X-Ye*ne,dt=Ye*W-ot*X,mt=(Z[0]*ut+Z[1]*at+Z[2]*dt)*Ge;return mt<0||At+mt>1?null:(ce*ut+ye*at+Me*dt)*Ge}function Pd(x,d,b){return(x-d)/(b-d)}function Rd(x,d,b,E,S,k,P,F,$){const V=1<<b,Z=k-E,X=P-S,W=(x+1)/V*Z+E,ne=(d+0)/V*X+S,ce=(d+1)/V*X+S;F[0]=(x+0)/V*Z+E,F[1]=ne,$[0]=W,$[1]=ce}class Bd{constructor(d){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=d,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const b=function(k){const P=Math.ceil(Math.log2(k.dim/8)),F=[];let $=Math.ceil(Math.pow(2,P));const V=1/$,Z=(ne,ce,ye,Me,Ce)=>{const ze=Me?1:0,$e=(ne+1)*ye-ze,qe=ce*ye,Ge=(ce+1)*ye-ze;Ce[0]=ne*ye,Ce[1]=qe,Ce[2]=$e,Ce[3]=Ge};let X=new kd($);const W=[];for(let ne=0;ne<$*$;ne++){Z(ne%$,Math.floor(ne/$),V,!1,W);const ce=Io(W[0],W[1],k),ye=Io(W[2],W[1],k),Me=Io(W[2],W[3],k),Ce=Io(W[0],W[3],k);X.minimums.push(Math.min(ce,ye,Me,Ce)),X.maximums.push(Math.max(ce,ye,Me,Ce)),X.leaves.push(1)}for(F.push(X),$/=2;$>=1;$/=2){const ne=F[F.length-1];X=new kd($);for(let ce=0;ce<$*$;ce++){Z(ce%$,Math.floor(ce/$),2,!0,W);const ye=ne.getElevation(W[0],W[1]),Me=ne.getElevation(W[2],W[1]),Ce=ne.getElevation(W[2],W[3]),ze=ne.getElevation(W[0],W[3]),$e=ne.isLeaf(W[0],W[1]),qe=ne.isLeaf(W[2],W[1]),Ge=ne.isLeaf(W[2],W[3]),Ye=ne.isLeaf(W[0],W[3]),ot=Math.min(ye.min,Me.min,Ce.min,ze.min),et=Math.max(ye.max,Me.max,Ce.max,ze.max),At=$e&&qe&&Ge&&Ye;X.maximums.push(et),X.minimums.push(ot),X.leaves.push(et-ot<=5&&At?1:0)}F.push(X)}return F}(this.dem),E=b.length-1,S=b[E];this._addNode(S.minimums[0],S.maximums[0],S.leaves[0]),this._construct(b,0,0,E,0)}raycastRoot(d,b,E,S,k,P,F=1){return Cd([d,b,-100],[E,S,this.maximums[0]*F],k,P)}raycast(d,b,E,S,k,P,F=1){if(!this.nodeCount)return null;const $=this.raycastRoot(d,b,E,S,k,P,F);if($==null)return null;const V=[],Z=[],X=[],W=[],ne=[{idx:0,t:$,nodex:0,nodey:0,depth:0}];for(;ne.length>0;){const{idx:ce,t:ye,nodex:Me,nodey:Ce,depth:ze}=ne.pop();if(this.leaves[ce]){Rd(Me,Ce,ze,d,b,E,S,X,W);const qe=1<<ze,Ge=(Me+0)/qe,Ye=(Me+1)/qe,ot=(Ce+0)/qe,et=(Ce+1)/qe,At=Io(Ge,ot,this.dem)*F,ut=Io(Ye,ot,this.dem)*F,at=Io(Ye,et,this.dem)*F,dt=Io(Ge,et,this.dem)*F,mt=Dd(X[0],X[1],At,W[0],X[1],ut,W[0],W[1],at,k,P),ht=Dd(W[0],W[1],at,X[0],W[1],dt,X[0],X[1],At,k,P),It=Math.min(mt!==null?mt:Number.MAX_VALUE,ht!==null?ht:Number.MAX_VALUE);if(It!==Number.MAX_VALUE)return It;{const Bt=xu([],k,P,ye);if(Ld(At,ut,dt,at,Pd(Bt[0],X[0],W[0]),Pd(Bt[1],X[1],W[1]))>=Bt[2])return ye}continue}let $e=0;for(let qe=0;qe<this._siblingOffset.length;qe++){Rd((Me<<1)+this._siblingOffset[qe][0],(Ce<<1)+this._siblingOffset[qe][1],ze+1,d,b,E,S,X,W),X[2]=-100,W[2]=this.maximums[this.childOffsets[ce]+qe]*F;const Ge=Cd(X,W,k,P);if(Ge!=null){const Ye=Ge;V[qe]=Ye;let ot=!1;for(let et=0;et<$e&&!ot;et++)Ye>=V[Z[et]]&&(Z.splice(et,0,qe),ot=!0);ot||(Z[$e]=qe),$e++}}for(let qe=0;qe<$e;qe++){const Ge=Z[qe];ne.push({idx:this.childOffsets[ce]+Ge,t:V[Ge],nodex:(Me<<1)+this._siblingOffset[Ge][0],nodey:(Ce<<1)+this._siblingOffset[Ge][1],depth:ze+1})}}return null}_addNode(d,b,E){return this.minimums.push(d),this.maximums.push(b),this.leaves.push(E),this.childOffsets.push(0),this.nodeCount++}_construct(d,b,E,S,k){if(d[S].isLeaf(b,E)===1)return;this.childOffsets[k]||(this.childOffsets[k]=this.nodeCount);const P=S-1,F=d[P];let $,V=0;for(let Z=0;Z<this._siblingOffset.length;Z++){const X=2*b+this._siblingOffset[Z][0],W=2*E+this._siblingOffset[Z][1],ne=F.getElevation(X,W),ce=F.isLeaf(X,W),ye=this._addNode(ne.min,ne.max,ce);ce&&(V|=1<<Z),$||($=ye)}for(let Z=0;Z<this._siblingOffset.length;Z++)V&1<<Z||this._construct(d,2*b+this._siblingOffset[Z][0],2*E+this._siblingOffset[Z][1],P,$+Z)}}function Ld(x,d,b,E,S,k){return Pi(Pi(x,b,k),Pi(d,E,k),S)}function Io(x,d,b){const E=b.dim,S=ge(x*E-.5,0,E-1),k=ge(d*E-.5,0,E-1),P=Math.floor(S),F=Math.floor(k),$=Math.min(P+1,E-1),V=Math.min(F+1,E-1);return Ld(b.get(P,F),b.get($,F),b.get(P,V),b.get($,V),S-P,k-F)}const zd={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class Ch{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(d,b,E,S=!1,k=!1){if(this.uid=d,b.height!==b.width)throw new RangeError("DEM tiles must be square");if(E&&E!=="mapbox"&&E!=="terrarium")return ft(`"${E}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=b.height;const P=this.dim=b.height-2;if(this.data=new Uint32Array(b.data.buffer),this.encoding=E||"mapbox",this.borderReady=S,!S){for(let F=0;F<P;F++)this.data[this._idx(-1,F)]=this.data[this._idx(0,F)],this.data[this._idx(P,F)]=this.data[this._idx(P-1,F)],this.data[this._idx(F,-1)]=this.data[this._idx(F,0)],this.data[this._idx(F,P)]=this.data[this._idx(F,P-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(P,-1)]=this.data[this._idx(P-1,0)],this.data[this._idx(-1,P)]=this.data[this._idx(0,P-1)],this.data[this._idx(P,P)]=this.data[this._idx(P-1,P-1)],k&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new Bd(this)}get(d,b,E=!1){const S=new Uint8Array(this.data.buffer);E&&(d=ge(d,-1,this.dim),b=ge(b,-1,this.dim));const k=4*this._idx(d,b);return(this.encoding==="terrarium"?this._unpackTerrarium:this._unpackMapbox)(S[k],S[k+1],S[k+2])}static getUnpackVector(d){return zd[d]}get unpackVector(){return zd[this.encoding]}_idx(d,b){if(d<-1||d>=this.dim+1||b<-1||b>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(b+1)*this.stride+(d+1)}_unpackMapbox(d,b,E){return(256*d*256+256*b+E)/10-1e4}_unpackTerrarium(d,b,E){return 256*d+b+E/256-32768}static pack(d,b){const E=[0,0,0,0],S=Ch.getUnpackVector(b);let k=Math.floor((d+S[3])/S[2]);return E[2]=k%256,k=Math.floor(k/256),E[1]=k%256,k=Math.floor(k/256),E[0]=k,E}getPixels(){return new on({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(d,b,E){if(this.dim!==d.dim)throw new Error("dem dimension mismatch");let S=b*this.dim,k=b*this.dim+this.dim,P=E*this.dim,F=E*this.dim+this.dim;switch(b){case-1:S=k-1;break;case 1:k=S+1}switch(E){case-1:P=F-1;break;case 1:F=P+1}const $=-b*this.dim,V=-E*this.dim;for(let Z=P;Z<F;Z++)for(let X=S;X<k;X++)this.data[this._idx(X,Z)]=d.data[this._idx(X+$,Z+V)]}onDeserialize(){this._tree&&(this._tree.dem=this)}}Ft("DEMData",Ch),Ft("DemMinMaxQuadTree",Bd,{omit:["dem"]});class sm{constructor(d,b){this.max=d,this.onRemove=b,this.reset()}reset(){for(const d in this.data)for(const b of this.data[d])b.timeout&&clearTimeout(b.timeout),this.onRemove(b.value);return this.data={},this.order=[],this}add(d,b,E){const S=d.wrapped().key;this.data[S]===void 0&&(this.data[S]=[]);const k={value:b,timeout:void 0};if(E!==void 0&&(k.timeout=setTimeout(()=>{this.remove(d,k)},E)),this.data[S].push(k),this.order.push(S),this.order.length>this.max){const P=this._getAndRemoveByKey(this.order[0]);P&&this.onRemove(P)}return this}has(d){return d.wrapped().key in this.data}getAndRemove(d){return this.has(d)?this._getAndRemoveByKey(d.wrapped().key):null}_getAndRemoveByKey(d){const b=this.data[d].shift();return b.timeout&&clearTimeout(b.timeout),this.data[d].length===0&&delete this.data[d],this.order.splice(this.order.indexOf(d),1),b.value}getByKey(d){const b=this.data[d];return b?b[0].value:null}get(d){return this.has(d)?this.data[d.wrapped().key][0].value:null}remove(d,b){if(!this.has(d))return this;const E=d.wrapped().key,S=b===void 0?0:this.data[E].indexOf(b),k=this.data[E][S];return this.data[E].splice(S,1),k.timeout&&clearTimeout(k.timeout),this.data[E].length===0&&delete this.data[E],this.onRemove(k.value),this.order.splice(this.order.indexOf(E),1),this}setMaxSize(d){for(this.max=d;this.order.length>this.max;){const b=this._getAndRemoveByKey(this.order[0]);b&&this.onRemove(b)}return this}filter(d){const b=[];for(const E in this.data)for(const S of this.data[E])d(S.value)||b.push(S);for(const E of b)this.remove(E.value.tileID,E)}}class ra{constructor(d,b,E){this.func=d,this.mask=b,this.range=E}}ra.ReadOnly=!1,ra.ReadWrite=!0,ra.disabled=new ra(519,ra.ReadOnly,[0,1]);const $c=7680;class Nc{constructor(d,b,E,S,k,P){this.test=d,this.ref=b,this.mask=E,this.fail=S,this.depthFail=k,this.pass=P}}Nc.disabled=new Nc({func:519,mask:0},0,0,$c,$c,$c);class zn{constructor(d,b,E){this.blendFunction=d,this.blendColor=b,this.mask=E}}zn.Replace=[1,0],zn.disabled=new zn(zn.Replace,Ci.transparent,[!1,!1,!1,!1]),zn.unblended=new zn(zn.Replace,Ci.transparent,[!0,!0,!0,!0]),zn.alphaBlended=new zn([1,771],Ci.transparent,[!0,!0,!0,!0]);const Uc=1029,Vc=2305;class yn{constructor(d,b,E){this.enable=d,this.mode=b,this.frontFace=E}}yn.disabled=new yn(!1,Uc,Vc),yn.backCCW=new yn(!0,Uc,Vc),yn.backCW=new yn(!0,Uc,2304),yn.frontCW=new yn(!0,1028,2304),yn.frontCCW=new yn(!0,1028,Vc);class rs extends gt{constructor(d,b,E){super(),this.id=d,this._onlySymbols=E,b.on("data",S=>{S.dataType==="source"&&S.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&S.dataType==="source"&&S.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),b.on("error",()=>{this._sourceErrored=!0}),this._source=b,this._tiles={},this._cache=new sm(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new om}onAdd(d){this.map=d,this._maxTileCacheSize=d?d._maxTileCacheSize:null}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const d in this._tiles){const b=this._tiles[d];if(b.state!=="loaded"&&b.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const d=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,d&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(d,b){return d.isSymbolTile=this._onlySymbols,this._source.loadTile(d,b)}_unloadTile(d){if(this._source.unloadTile)return this._source.unloadTile(d,()=>{})}_abortTile(d){if(this._source.abortTile)return this._source.abortTile(d,()=>{})}serialize(){return this._source.serialize()}prepare(d){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const b in this._tiles){const E=this._tiles[b];E.upload(d),E.prepare(this.map.style.imageManager)}}getIds(){return le(this._tiles).map(d=>d.tileID).sort(Fd).map(d=>d.key)}getRenderableIds(d){const b=[];for(const E in this._tiles)this._isIdRenderable(+E,d)&&b.push(this._tiles[E]);return d?b.sort((E,S)=>{const k=E.tileID,P=S.tileID,F=new N(k.canonical.x,k.canonical.y)._rotate(this.transform.angle),$=new N(P.canonical.x,P.canonical.y)._rotate(this.transform.angle);return k.overscaledZ-P.overscaledZ||$.y-F.y||$.x-F.x}).map(E=>E.tileID.key):b.map(E=>E.tileID).sort(Fd).map(E=>E.key)}hasRenderableParent(d){const b=this.findLoadedParent(d,0);return!!b&&this._isIdRenderable(b.tileID.key)}_isIdRenderable(d,b){return this._tiles[d]&&this._tiles[d].hasData()&&!this._coveredTiles[d]&&(b||!this._tiles[d].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const d in this._tiles)this._tiles[d].state!=="errored"&&this._reloadTile(+d,"reloading")}}_reloadTile(d,b){const E=this._tiles[d];E&&(E.state!=="loading"&&(E.state=b),this._loadTile(E,this._tileLoaded.bind(this,E,d,b)))}_tileLoaded(d,b,E,S){if(S)return d.state="errored",void(S.status!==404?this._source.fire(new Rt(S,{tile:d})):this.update(this.transform));d.timeAdded=Pt.now(),E==="expired"&&(d.refreshedUponExpiration=!0),this._setTileReloadTimer(b,d),this.getSource().type==="raster-dem"&&d.dem&&this._backfillDEM(d),this._state.initializeTileState(d,this.map?this.map.painter:null),this._source.fire(new st("data",{dataType:"source",tile:d,coord:d.tileID,sourceCacheId:this.id}))}_backfillDEM(d){const b=this.getRenderableIds();for(let S=0;S<b.length;S++){const k=b[S];if(d.neighboringTiles&&d.neighboringTiles[k]){const P=this.getTileByID(k);E(d,P),E(P,d)}}function E(S,k){if(!S.dem||S.dem.borderReady)return;S.needsHillshadePrepare=!0,S.needsDEMTextureUpload=!0;let P=k.tileID.canonical.x-S.tileID.canonical.x;const F=k.tileID.canonical.y-S.tileID.canonical.y,$=Math.pow(2,S.tileID.canonical.z),V=k.tileID.key;P===0&&F===0||Math.abs(F)>1||(Math.abs(P)>1&&(Math.abs(P+$)===1?P+=$:Math.abs(P-$)===1&&(P-=$)),k.dem&&S.dem&&(S.dem.backfillBorder(k.dem,P,F),S.neighboringTiles&&S.neighboringTiles[V]&&(S.neighboringTiles[V].backfilled=!0)))}}getTile(d){return this.getTileByID(d.key)}getTileByID(d){return this._tiles[d]}_retainLoadedChildren(d,b,E,S){for(const k in this._tiles){let P=this._tiles[k];if(S[k]||!P.hasData()||P.tileID.overscaledZ<=b||P.tileID.overscaledZ>E)continue;let F=P.tileID;for(;P&&P.tileID.overscaledZ>b+1;){const V=P.tileID.scaledTo(P.tileID.overscaledZ-1);P=this._tiles[V.key],P&&P.hasData()&&(F=V)}let $=F;for(;$.overscaledZ>b;)if($=$.scaledTo($.overscaledZ-1),d[$.key]){S[F.key]=F;break}}}findLoadedParent(d,b){if(d.key in this._loadedParentTiles){const E=this._loadedParentTiles[d.key];return E&&E.tileID.overscaledZ>=b?E:null}for(let E=d.overscaledZ-1;E>=b;E--){const S=d.scaledTo(E),k=this._getLoadedTile(S);if(k)return k}}_getLoadedTile(d){const b=this._tiles[d.key];return b&&b.hasData()?b:this._cache.getByKey(this._source.reparseOverscaled?d.wrapped().key:d.canonical.key)}updateCacheSize(d,b){b=b||this._source.tileSize;const E=Math.ceil(d.width/b)+1,S=Math.ceil(d.height/b)+1,k=Math.floor(E*S*5),P=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,k):k;this._cache.setMaxSize(P)}handleWrapJump(d){const b=Math.round((d-(this._prevLng===void 0?d:this._prevLng))/360);if(this._prevLng=d,b){const E={};for(const S in this._tiles){const k=this._tiles[S];k.tileID=k.tileID.unwrapTo(k.tileID.wrap+b),E[k.tileID.key]=k}this._tiles=E;for(const S in this._timers)clearTimeout(this._timers[S]),delete this._timers[S];for(const S in this._tiles)this._setTileReloadTimer(+S,this._tiles[S])}}update(d,b,E){if(this.transform=d,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!E)return;let S;this.updateCacheSize(d,b),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?S=d.getVisibleUnwrappedCoordinates(this._source.tileID).map(F=>new qr(F.canonical.z,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y)):(S=d.coveringTiles({tileSize:b||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!E,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(S=S.filter(F=>this._source.hasTile(F)))):S=[];const k=this._updateRetainedTiles(S);if(Od(this._source.type)&&S.length!==0){const F={},$={},V=Object.keys(k);for(const X of V){const W=k[X],ne=this._tiles[X];if(!ne||ne.fadeEndTime&&ne.fadeEndTime<=Pt.now())continue;const ce=this.findLoadedParent(W,Math.max(W.overscaledZ-rs.maxOverzooming,this._source.minzoom));ce&&(this._addTile(ce.tileID),F[ce.tileID.key]=ce.tileID),$[X]=W}const Z=S[S.length-1].overscaledZ;for(const X in this._tiles){const W=this._tiles[X];if(k[X]||!W.hasData())continue;let ne=W.tileID;for(;ne.overscaledZ>Z;){ne=ne.scaledTo(ne.overscaledZ-1);const ce=this._tiles[ne.key];if(ce&&ce.hasData()&&$[ne.key]){k[X]=W.tileID;break}}}for(const X in F)k[X]||(this._coveredTiles[X]=!0,k[X]=F[X])}for(const F in k)this._tiles[F].clearFadeHold();const P=function(F,$){const V=[];for(const Z in F)Z in $||V.push(Z);return V}(this._tiles,k);for(const F of P){const $=this._tiles[F];$.hasSymbolBuckets&&!$.holdingForFade()?$.setHoldDuration(this.map._fadeDuration):$.hasSymbolBuckets&&!$.symbolFadeFinished()||this._removeTile(+F)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const d in this._tiles)this._tiles[d].holdingForFade()&&this._removeTile(+d)}_updateRetainedTiles(d){const b={};if(d.length===0)return b;const E={},S=d.reduce((V,Z)=>Math.min(V,Z.overscaledZ),1/0),k=d[0].overscaledZ,P=Math.max(k-rs.maxOverzooming,this._source.minzoom),F=Math.max(k+rs.maxUnderzooming,this._source.minzoom),$={};for(const V of d){const Z=this._addTile(V);b[V.key]=V,Z.hasData()||S<this._source.maxzoom&&($[V.key]=V)}this._retainLoadedChildren($,S,F,b);for(const V of d){let Z=this._tiles[V.key];if(Z.hasData())continue;if(V.canonical.z>=this._source.maxzoom){const W=V.children(this._source.maxzoom)[0],ne=this.getTile(W);if(ne&&ne.hasData()){b[W.key]=W;continue}}else{const W=V.children(this._source.maxzoom);if(b[W[0].key]&&b[W[1].key]&&b[W[2].key]&&b[W[3].key])continue}let X=Z.wasRequested();for(let W=V.overscaledZ-1;W>=P;--W){const ne=V.scaledTo(W);if(E[ne.key]||(E[ne.key]=!0,Z=this.getTile(ne),!Z&&X&&(Z=this._addTile(ne)),Z&&(b[ne.key]=ne,X=Z.wasRequested(),Z.hasData())))break}}return b}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const d in this._tiles){const b=[];let E,S=this._tiles[d].tileID;for(;S.overscaledZ>0;){if(S.key in this._loadedParentTiles){E=this._loadedParentTiles[S.key];break}b.push(S.key);const k=S.scaledTo(S.overscaledZ-1);if(E=this._getLoadedTile(k),E)break;S=k}for(const k of b)this._loadedParentTiles[k]=E}}_addTile(d){let b=this._tiles[d.key];if(b)return b;b=this._cache.getAndRemove(d),b&&(this._setTileReloadTimer(d.key,b),b.tileID=d,this._state.initializeTileState(b,this.map?this.map.painter:null),this._cacheTimers[d.key]&&(clearTimeout(this._cacheTimers[d.key]),delete this._cacheTimers[d.key],this._setTileReloadTimer(d.key,b)));const E=Boolean(b);if(!E){const S=this.map?this.map.painter:null;b=new Id(d,this._source.tileSize*d.overscaleFactor(),this.transform.tileZoom,S,this._source.type==="raster"||this._source.type==="raster-dem"),this._loadTile(b,this._tileLoaded.bind(this,b,d.key,b.state))}return b?(b.uses++,this._tiles[d.key]=b,E||this._source.fire(new st("dataloading",{tile:b,coord:b.tileID,dataType:"source"})),b):null}_setTileReloadTimer(d,b){d in this._timers&&(clearTimeout(this._timers[d]),delete this._timers[d]);const E=b.getExpiryTimeout();E&&(this._timers[d]=setTimeout(()=>{this._reloadTile(d,"expired"),delete this._timers[d]},E))}_removeTile(d){const b=this._tiles[d];b&&(b.uses--,delete this._tiles[d],this._timers[d]&&(clearTimeout(this._timers[d]),delete this._timers[d]),b.uses>0||(b.hasData()&&b.state!=="reloading"?this._cache.add(b.tileID,b,b.getExpiryTimeout()):(b.aborted=!0,this._abortTile(b),this._unloadTile(b))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const d in this._tiles)this._removeTile(+d);this._source._clear&&this._source._clear(),this._cache.reset()}tilesIn(d,b,E){const S=[],k=this.transform;if(!k)return S;for(const P in this._tiles){const F=this._tiles[P];if(E&&F.clearQueryDebugViz(),F.holdingForFade())continue;const $=d.containsTile(F,k,b);$&&S.push($)}return S}getVisibleCoordinates(d){const b=this.getRenderableIds(d).map(E=>this._tiles[E].tileID);for(const E of b)E.projMatrix=this.transform.calculateProjMatrix(E.toUnwrapped());return b}hasTransition(){if(this._source.hasTransition())return!0;if(Od(this._source.type))for(const d in this._tiles){const b=this._tiles[d];if(b.fadeEndTime!==void 0&&b.fadeEndTime>=Pt.now())return!0}return!1}setFeatureState(d,b,E){this._state.updateState(d=d||"_geojsonTileLayer",b,E)}removeFeatureState(d,b,E){this._state.removeFeatureState(d=d||"_geojsonTileLayer",b,E)}getFeatureState(d,b){return this._state.getState(d=d||"_geojsonTileLayer",b)}setDependencies(d,b,E){const S=this._tiles[d];S&&S.setDependencies(b,E)}reloadTilesForDependencies(d,b){for(const E in this._tiles)this._tiles[E].hasDependency(d,b)&&this._reloadTile(+E,"reloading");this._cache.filter(E=>!E.hasDependency(d,b))}}function Fd(x,d){const b=Math.abs(2*x.wrap)-+(x.wrap<0),E=Math.abs(2*d.wrap)-+(d.wrap<0);return x.overscaledZ-d.overscaledZ||E-b||d.canonical.y-x.canonical.y||d.canonical.x-x.canonical.x}function Od(x){return x==="raster"||x==="image"||x==="video"}rs.maxOverzooming=10,rs.maxUnderzooming=3;class Dh{constructor(d,b,E){this._demTile=d,this._dem=this._demTile.dem,this._scale=b,this._offset=E}static create(d,b,E){const S=E||d.findDEMTileFor(b);if(!S||!S.dem)return;const k=S.dem,P=S.tileID,F=1<<b.canonical.z-P.canonical.z;return new Dh(S,S.tileSize/ki/F,[(b.canonical.x/F-P.canonical.x)*k.dim,(b.canonical.y/F-P.canonical.y)*k.dim])}tileCoordToPixel(d,b){const E=b*this._scale+this._offset[1],S=Math.floor(d*this._scale+this._offset[0]),k=Math.floor(E);return new N(S,k)}getElevationAt(d,b,E,S){const k=d*this._scale+this._offset[0],P=b*this._scale+this._offset[1],F=Math.floor(k),$=Math.floor(P),V=this._dem;return S=!!S,E?Pi(Pi(V.get(F,$,S),V.get(F,$+1,S),P-$),Pi(V.get(F+1,$,S),V.get(F+1,$+1,S),P-$),k-F):V.get(F,$,S)}getElevationAtPixel(d,b,E){return this._dem.get(d,b,!!E)}getMeterToDEM(d){return(1<<this._demTile.tileID.canonical.z)*tc(1,d)*this._dem.stride}}class $d{constructor(d,b){this.tileID=d,this.x=d.canonical.x,this.y=d.canonical.y,this.z=d.canonical.z,this.grid=new po(ki,16,0),this.featureIndexArray=new Hc,this.promoteId=b}insert(d,b,E,S,k,P=0){const F=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(E,S,k,P);const $=this.grid;for(let V=0;V<b.length;V++){const Z=b[V],X=[1/0,1/0,-1/0,-1/0];for(let W=0;W<Z.length;W++){const ne=Z[W];X[0]=Math.min(X[0],ne.x),X[1]=Math.min(X[1],ne.y),X[2]=Math.max(X[2],ne.x),X[3]=Math.max(X[3],ne.y)}X[0]<ki&&X[1]<ki&&X[2]>=0&&X[3]>=0&&$.insert(F,X[0],X[1],X[2],X[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new is.VectorTile(new tl(this.rawTileData)).layers,this.sourceLayerCoder=new Td(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const d in this.vtLayers)this.vtFeatures[d]=[]}return this.vtLayers}query(d,b,E,S){this.loadVTLayers();const k=d.params||{},P=Oo(k.filter),F=d.tileResult,$=d.transform,V=F.bufferedTilespaceBounds,Z=this.grid.query(V.min.x,V.min.y,V.max.x,V.max.y,(ce,ye,Me,Ce)=>uu(F.bufferedTilespaceGeometry,ce,ye,Me,Ce));Z.sort(am);let X=null;$.elevation&&Z.length>0&&(X=Dh.create($.elevation,this.tileID));const W={};let ne;for(let ce=0;ce<Z.length;ce++){const ye=Z[ce];if(ye===ne)continue;ne=ye;const Me=this.featureIndexArray.get(ye);let Ce=null;this.loadMatchingFeature(W,Me,P,k.layers,k.availableImages,b,E,S,(ze,$e,qe,Ge=0)=>(Ce||(Ce=Kn(ze,this.tileID.canonical,d.tileTransform)),$e.queryIntersectsFeature(F,ze,qe,Ce,this.z,d.transform,d.pixelPosMatrix,X,Ge)))}return W}loadMatchingFeature(d,b,E,S,k,P,F,$,V){const{featureIndex:Z,bucketIndex:X,sourceLayerIndex:W,layoutVertexArrayOffset:ne}=b,ce=this.bucketLayerIDs[X];if(S&&!function(ze,$e){for(let qe=0;qe<ze.length;qe++)if($e.indexOf(ze[qe])>=0)return!0;return!1}(S,ce))return;const ye=this.sourceLayerCoder.decode(W),Me=this.vtLayers[ye].feature(Z);if(E.needGeometry){const ze=ts(Me,!0);if(!E.filter(new ie(this.tileID.overscaledZ),ze,this.tileID.canonical))return}else if(!E.filter(new ie(this.tileID.overscaledZ),Me))return;const Ce=this.getId(Me,ye);for(let ze=0;ze<ce.length;ze++){const $e=ce[ze];if(S&&S.indexOf($e)<0)continue;const qe=P[$e];if(!qe)continue;let Ge={};Ce!==void 0&&$&&(Ge=$.getState(qe.sourceLayer||"_geojsonTileLayer",Ce));const Ye=pe({},F[$e]);Ye.paint=Nd(Ye.paint,qe.paint,Me,Ge,k),Ye.layout=Nd(Ye.layout,qe.layout,Me,Ge,k);const ot=!V||V(Me,qe,Ge,ne);if(!ot)continue;const et=new Md(Me,this.z,this.x,this.y,Ce);et.layer=Ye;let At=d[$e];At===void 0&&(At=d[$e]=[]),At.push({featureIndex:Z,feature:et,intersectionZ:ot})}}lookupSymbolFeatures(d,b,E,S,k,P,F,$){const V={};this.loadVTLayers();const Z=Oo(k);for(const X of d)this.loadMatchingFeature(V,{bucketIndex:E,sourceLayerIndex:S,featureIndex:X,layoutVertexArrayOffset:0},Z,P,F,$,b);return V}loadFeature(d){const{featureIndex:b,sourceLayerIndex:E}=d;this.loadVTLayers();const S=this.sourceLayerCoder.decode(E),k=this.vtFeatures[S];if(k[b])return k[b];const P=this.vtLayers[S].feature(b);return k[b]=P,P}hasLayer(d){for(const b of this.bucketLayerIDs)for(const E of b)if(d===E)return!0;return!1}getId(d,b){let E=d.id;return this.promoteId&&(E=d.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[b]],typeof E=="boolean"&&(E=Number(E))),E}}function Nd(x,d,b,E,S){return Gt(x,(k,P)=>{const F=d instanceof De?d.get(P):null;return F&&F.evaluate?F.evaluate(b,E,S):F})}function am(x,d){return d-x}Ft("FeatureIndex",$d,{omit:["rawTileData","sourceLayerCoder"]});class Ud{constructor(d){const b={},E=[];for(const F in d){const $=d[F],V=b[F]={};for(const Z in $.glyphs){const X=$.glyphs[+Z];if(!X||X.bitmap.width===0||X.bitmap.height===0)continue;const W=X.metrics.localGlyph?2:1,ne={x:0,y:0,w:X.bitmap.width+2*W,h:X.bitmap.height+2*W};E.push(ne),V[Z]=ne}}const{w:S,h:k}=wc(E),P=new bo({width:S||1,height:k||1});for(const F in d){const $=d[F];for(const V in $.glyphs){const Z=$.glyphs[+V];if(!Z||Z.bitmap.width===0||Z.bitmap.height===0)continue;const X=b[F][V],W=Z.metrics.localGlyph?2:1;bo.copy(Z.bitmap,P,{x:0,y:0},{x:X.x+W,y:X.y+W},Z.bitmap)}}this.image=P,this.positions=b}}Ft("GlyphAtlas",Ud);class lm{constructor(d){this.tileID=new qr(d.tileID.overscaledZ,d.tileID.wrap,d.tileID.canonical.z,d.tileID.canonical.x,d.tileID.canonical.y),this.tileZoom=d.tileZoom,this.uid=d.uid,this.zoom=d.zoom,this.canonical=d.tileID.canonical,this.pixelRatio=d.pixelRatio,this.tileSize=d.tileSize,this.source=d.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=d.showCollisionBoxes,this.collectResourceTiming=!!d.collectResourceTiming,this.returnDependencies=!!d.returnDependencies,this.promoteId=d.promoteId,this.enableTerrain=!!d.enableTerrain,this.isSymbolTile=d.isSymbolTile,d.projection&&(this.tileTransform=Ih(d.tileID.canonical,d.projection))}parse(d,b,E,S,k){this.status="parsing",this.data=d,this.collisionBoxArray=new $r;const P=new Td(Object.keys(d.layers).sort()),F=new $d(this.tileID,this.promoteId);F.bucketLayerIDs=[];const $={},V=new zc(256,256),Z={featureIndex:F,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:V,availableImages:E},X=b.familiesBySource[this.source];for(const Ge in X){const Ye=d.layers[Ge];if(!Ye)continue;let ot=!1,et=!1;for(const at of X[Ge])at[0].type==="symbol"?ot=!0:et=!0;if(this.isSymbolTile===!0&&!ot||this.isSymbolTile===!1&&!et)continue;Ye.version===1&&ft(`Vector tile source "${this.source}" layer "${Ge}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const At=P.encode(Ge),ut=[];for(let at=0;at<Ye.length;at++){const dt=Ye.feature(at),mt=F.getId(dt,Ge);ut.push({feature:dt,id:mt,index:at,sourceLayerIndex:At})}for(const at of X[Ge]){const dt=at[0];this.isSymbolTile!==void 0&&dt.type==="symbol"!==this.isSymbolTile||dt.minzoom&&this.zoom<Math.floor(dt.minzoom)||dt.maxzoom&&this.zoom>=dt.maxzoom||dt.visibility!=="none"&&(jc(at,this.zoom,E),($[dt.id]=dt.createBucket({index:F.bucketLayerIDs.length,layers:at,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:At,sourceID:this.source,enableTerrain:this.enableTerrain,availableImages:E})).populate(ut,Z,this.tileID.canonical,this.tileTransform),F.bucketLayerIDs.push(at.map(mt=>mt.id)))}}let W,ne,ce,ye;V.trim();const Me={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Ce=Gt(Z.glyphDependencies,Ge=>Object.keys(Ge).map(Number));Object.keys(Ce).length?S.send("getGlyphs",{uid:this.uid,stacks:Ce},(Ge,Ye)=>{W||(W=Ge,ne=Ye,qe.call(this))},void 0,!1,Me):ne={};const ze=Object.keys(Z.iconDependencies);ze.length?S.send("getImages",{icons:ze,source:this.source,tileID:this.tileID,type:"icons"},(Ge,Ye)=>{W||(W=Ge,ce=Ye,qe.call(this))},void 0,!1,Me):ce={};const $e=Object.keys(Z.patternDependencies);function qe(){if(W)return k(W);if(ne&&ce&&ye){const Ge=new Ud(ne),Ye=new Wu(ce,ye);for(const ot in $){const et=$[ot];et instanceof Mo?(jc(et.layers,this.zoom,E),jp(et,ne,Ge.positions,ce,Ye.iconPositions,this.showCollisionBoxes,E,this.tileID.canonical,this.tileZoom)):et.hasPattern&&(et instanceof gh||et instanceof mh||et instanceof xc)&&(jc(et.layers,this.zoom,E),et.addFeatures(Z,this.tileID.canonical,Ye.patternPositions,E))}this.status="done",k(null,{buckets:le($).filter(ot=>!ot.isEmpty()),featureIndex:F,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ge.image,lineAtlas:V,imageAtlas:Ye,glyphMap:this.returnDependencies?ne:null,iconMap:this.returnDependencies?ce:null,glyphPositions:this.returnDependencies?Ge.positions:null})}}$e.length?S.send("getImages",{icons:$e,source:this.source,tileID:this.tileID,type:"patterns"},(Ge,Ye)=>{W||(W=Ge,ye=Ye,qe.call(this))},void 0,!1,Me):ye={},qe.call(this)}}function jc(x,d,b){const E=new ie(d);for(const S of x)S.recalculate(E,b)}class Vd{constructor(d){this.entries={},this.scheduler=d}request(d,b,E,S){const k=this.entries[d]=this.entries[d]||{callbacks:[]};if(k.result){const[P,F]=k.result;return this.scheduler?this.scheduler.add(()=>{S(P,F)},b):S(P,F),()=>{}}return k.callbacks.push(S),k.cancel||(k.cancel=E((P,F)=>{k.result=[P,F];for(const $ of k.callbacks)this.scheduler?this.scheduler.add(()=>{$(P,F)},b):$(P,F);setTimeout(()=>delete this.entries[d],3e3)})),()=>{k.result||(k.callbacks=k.callbacks.filter(P=>P!==S),k.callbacks.length||(k.cancel(),delete this.entries[d]))}}}function jd(x,d,b){const E=JSON.stringify(x.request);return x.data&&(this.deduped.entries[E]={result:[null,x.data]}),this.deduped.request(E,{type:"parseTile",isSymbolTile:x.isSymbolTile,zoom:x.tileZoom},S=>{const k=re(x.request,(P,F,$,V)=>{P?S(P):F&&S(null,{vectorTile:b?void 0:new is.VectorTile(new tl(F)),rawData:F,cacheControl:$,expires:V})});return()=>{k.cancel(),S()}},d)}var hm={name:"albers",range:[4,7],center:[-96,37.5],parallels:[29.5,45.5],conic:!0,initializeConstants(){if(this.constants&&Tu(this.parallels,this.constants.parallels))return;const x=Math.sin(Q(this.parallels[0])),d=(x+Math.sin(Q(this.parallels[1])))/2,b=1+x*(2*d-x),E=Math.sqrt(b)/d;this.constants={n:d,c:b,r0:E,parallels:this.parallels}},project(x,d){this.initializeConstants();const b=Q(x-this.center[0]),E=Q(d),{n:S,c:k,r0:P}=this.constants,F=Math.sqrt(k-2*S*Math.sin(E))/S;return{x:F*Math.sin(b*S),y:F*Math.cos(b*S)-P}},unproject(x,d){this.initializeConstants();const{n:b,c:E,r0:S}=this.constants,k=S+d;let P=Math.atan2(x,Math.abs(k))*Math.sign(k);k*b<0&&(P-=Math.PI*Math.sign(x)*Math.sign(k));const F=Q(this.center[0])*b;P=ue(P,-Math.PI-F,Math.PI-F);const $=_e(P/b)+this.center[0],V=Math.asin(ge((E-(x*x+k*k)*b*b)/(2*b),-1,1)),Z=ge(_e(V),-85.051129,vo);return new Ni($,Z)}};const ol=1.340264,sl=-.081106,al=893e-6,ll=.003796,Ph=Math.sqrt(3)/2;var cm={name:"equalEarth",center:[0,0],range:[3.5,7],project(x,d){d=d/180*Math.PI,x=x/180*Math.PI;const b=Math.asin(Ph*Math.sin(d)),E=b*b,S=E*E*E;return{x:.5*(x*Math.cos(b)/(Ph*(ol+3*sl*E+S*(7*al+9*ll*E)))/Math.PI+.5),y:1-.5*(b*(ol+sl*E+S*(al+ll*E))/Math.PI+1)}},unproject(x,d){x=(2*x-.5)*Math.PI;let b=d=(2*(1-d)-1)*Math.PI,E=b*b,S=E*E*E;for(let V,Z,X,W=0;W<12&&(Z=b*(ol+sl*E+S*(al+ll*E))-d,X=ol+3*sl*E+S*(7*al+9*ll*E),V=Z/X,b=ge(b-V,-Math.PI/3,Math.PI/3),E=b*b,S=E*E*E,!(Math.abs(V)<1e-12));++W);const k=Ph*x*(ol+3*sl*E+S*(7*al+9*ll*E))/Math.cos(b),P=Math.asin(Math.sin(b)/Ph),F=ge(180*k/Math.PI,-180,180),$=ge(180*P/Math.PI,-85.051129,vo);return new Ni(F,$)}},um={name:"equirectangular",wrap:!0,center:[0,0],range:[3.5,7],project:(x,d)=>({x:.5+x/360,y:.5-d/360}),unproject(x,d){const b=360*(x-.5),E=ge(360*(.5-d),-85.051129,vo);return new Ni(b,E)}};const na=Math.PI/2;function Rh(x){return Math.tan((na+x)/2)}var dm={name:"lambertConformalConic",range:[3.5,7],center:[0,30],parallels:[30,30],conic:!0,initializeConstants(){if(this.constants&&Tu(this.parallels,this.constants.parallels))return;const x=Q(this.parallels[0]),d=Q(this.parallels[1]),b=Math.cos(x),E=x===d?Math.sin(x):Math.log(b/Math.cos(d))/Math.log(Rh(d)/Rh(x)),S=b*Math.pow(Rh(x),E)/E;this.constants={n:E,f:S,parallels:this.parallels}},project(x,d){this.initializeConstants(),d=Q(d),x=Q(x-this.center[0]);const b=1e-6,{n:E,f:S}=this.constants;S>0?d<-na+b&&(d=-na+b):d>na-b&&(d=na-b);const k=S/Math.pow(Rh(d),E),P=k*Math.sin(E*x),F=S-k*Math.cos(E*x);return{x:.5*(P/Math.PI+.5),y:1-.5*(F/Math.PI+.5)}},unproject(x,d){this.initializeConstants(),x=(2*x-.5)*Math.PI,d=(2*(1-d)-.5)*Math.PI;const{n:b,f:E}=this.constants,S=E-d,k=Math.sign(S),P=Math.sign(b)*Math.sqrt(x*x+S*S);let F=Math.atan2(x,Math.abs(S))*k;S*b<0&&(F-=Math.PI*Math.sign(x)*k);const $=ge(_e(F/b)+this.center[0],-180,180),V=ge(_e(2*Math.atan(Math.pow(E/P,1/b))-na),-85.051129,vo);return new Ni($,V)}},fm={name:"mercator",wrap:!0,center:[0,0],project:(x,d)=>({x:Qh(x),y:ec(d)}),unproject(x,d){const b=es(x),E=Pn(d);return new Ni(b,E)}};const Gd=Q(vo);var pm={name:"naturalEarth",center:[0,0],range:[3.5,7],project(x,d){const b=(d=Q(d))*d,E=b*b;return{x:.5*((x=Q(x))*(.8707-.131979*b+E*(E*(.003971*b-.001529*E)-.013791))/Math.PI+.5),y:1-.5*(d*(1.007226+b*(.015085+E*(.028874*b-.044475-.005916*E)))/Math.PI+1)}},unproject(x,d){x=(2*x-.5)*Math.PI;let b=d=(2*(1-d)-1)*Math.PI,E=25,S=0,k=b*b;do{k=b*b;const $=k*k;S=(b*(1.007226+k*(.015085+$*(.028874*k-.044475-.005916*$)))-d)/(1.007226+k*(.045255+$*(.259866*k-.311325-.005916*11*$))),b=ge(b-S,-Gd,Gd)}while(Math.abs(S)>1e-6&&--E>0);k=b*b;const P=ge(_e(x/(.8707+k*(k*(k*k*k*(.003971-.001529*k)-.013791)-.131979))),-180,180),F=_e(b);return new Ni(P,F)}};const qd=Q(vo),Zd={albers:hm,equalEarth:cm,equirectangular:um,lambertConformalConic:dm,mercator:fm,naturalEarth:pm,winkelTripel:{name:"winkelTripel",center:[0,0],range:[3.5,7],project(x,d){d=Q(d),x=Q(x);const b=Math.cos(d),E=2/Math.PI,S=Math.acos(b*Math.cos(x/2)),k=Math.sin(S)/S,P=.5*(x*E+2*b*Math.sin(x/2)/k)||0,F=.5*(d+Math.sin(d)/k)||0;return{x:.5*(P/Math.PI+.5),y:1-.5*(F/Math.PI+1)}},unproject(x,d){let b=x=(2*x-.5)*Math.PI,E=d=(2*(1-d)-1)*Math.PI,S=25;const k=1e-6;let P=0,F=0;do{const $=Math.cos(E),V=Math.sin(E),Z=2*V*$,X=V*V,W=$*$,ne=Math.cos(b/2),ce=Math.sin(b/2),ye=2*ne*ce,Me=ce*ce,Ce=1-W*ne*ne,ze=Ce?1/Ce:0,$e=Ce?Math.acos($*ne)*Math.sqrt(1/Ce):0,qe=.5*(2*$e*$*ce+2*b/Math.PI)-x,Ge=.5*($e*V+E)-d,Ye=.5*ze*(W*Me+$e*$*ne*X)+1/Math.PI,ot=ze*(ye*Z/4-$e*V*ce),et=.125*ze*(Z*ce-$e*V*W*ye),At=.5*ze*(X*ne+$e*Me*$)+.5,ut=ot*et-At*Ye;P=(Ge*ot-qe*At)/ut,F=(qe*et-Ge*Ye)/ut,b=ge(b-P,-Math.PI,Math.PI),E=ge(E-F,-qd,qd)}while((Math.abs(P)>k||Math.abs(F)>k)&&--S>0);return new Ni(_e(b),_e(E))}}};y.ARRAY_TYPE=Nr,y.AUTH_ERR_MSG=Mi,y.Actor=class{constructor(x,d,b){this.target=x,this.parent=d,this.mapId=b,this.callbacks={},this.cancelCallbacks={},Nt(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=zt()?x:G,this.scheduler=new rm}send(x,d,b,E,S=!1,k){const P=Math.round(1e18*Math.random()).toString(36).substring(0,10);b&&(b.metadata=k,this.callbacks[P]=b);const F=Ti(this.globalScope)?void 0:[];return this.target.postMessage({id:P,type:x,hasCallback:!!b,targetMapId:E,mustQueue:S,sourceMapId:this.mapId,data:jo(d,F)},F),{cancel:()=>{b&&delete this.callbacks[P],this.target.postMessage({id:P,type:"<cancel>",targetMapId:E,sourceMapId:this.mapId})}}}receive(x){const d=x.data,b=d.id;if(b&&(!d.targetMapId||this.mapId===d.targetMapId))if(d.type==="<cancel>"){const E=this.cancelCallbacks[b];delete this.cancelCallbacks[b],E&&E.cancel()}else if(d.mustQueue||zt()){const E=this.callbacks[b];this.cancelCallbacks[b]=this.scheduler.add(()=>this.processTask(b,d),E&&E.metadata||{type:"message"})}else this.processTask(b,d)}processTask(x,d){if(d.type==="<response>"){const b=this.callbacks[x];delete this.callbacks[x],b&&(d.error?b(Go(d.error)):b(null,Go(d.data)))}else{const b=Ti(this.globalScope)?void 0:[],E=d.hasCallback?(k,P)=>{delete this.cancelCallbacks[x],this.target.postMessage({id:x,type:"<response>",sourceMapId:this.mapId,error:k?jo(k):null,data:jo(P,b)},b)}:k=>{},S=Go(d.data);if(this.parent[d.type])this.parent[d.type](d.sourceMapId,S,E);else if(this.parent.getWorkerSource){const k=d.type.split(".");this.parent.getWorkerSource(d.sourceMapId,k[0],S.source)[k[1]](S,E)}else E(new Error(`Could not find function ${d.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},y.CanonicalTileID=Fc,y.Color=Ci,y.ColorMode=zn,y.CullFaceMode=yn,y.DEMData=Ch,y.DataConstantProperty=Ee,y.DedupedRequest=Vd,y.DepthMode=ra,y.EXTENT=ki,y.Elevation=class{getAtPointOrZero(x,d=0){return this.getAtPoint(x,d)||0}getAtPoint(x,d,b=!0){d==null&&(d=null);const E=this._source();if(!E||x.y<0||x.y>1)return d;const S=E.getSource().maxzoom,k=1<<S,P=Math.floor(x.x),F=x.x-P,$=new qr(S,P,S,Math.floor(F*k),Math.floor(x.y*k)),V=this.findDEMTileFor($);if(!V||!V.dem)return d;const Z=V.dem,X=1<<V.tileID.canonical.z,W=(F*X-V.tileID.canonical.x)*Z.dim,ne=(x.y*X-V.tileID.canonical.y)*Z.dim,ce=Math.floor(W),ye=Math.floor(ne);return(b?this.exaggeration():1)*Pi(Pi(Z.get(ce,ye),Z.get(ce,ye+1),ne-ye),Pi(Z.get(ce+1,ye),Z.get(ce+1,ye+1),ne-ye),W-ce)}getAtTileOffset(x,d,b){const E=1<<x.canonical.z;return this.getAtPointOrZero(new sh(x.wrap+(x.canonical.x+d/ki)/E,(x.canonical.y+b/ki)/E))}getForTilePoints(x,d,b,E){const S=Dh.create(this,x,E);return!!S&&(d.forEach(k=>{k[2]=this.exaggeration()*S.getElevationAt(k[0],k[1],b)}),!0)}getMinMaxForTile(x){const d=this.findDEMTileFor(x);if(!d||!d.dem)return null;const b=d.dem.tree,E=d.tileID,S=1<<x.canonical.z-E.canonical.z;let k=x.canonical.x/S-E.canonical.x,P=x.canonical.y/S-E.canonical.y,F=0;for(let $=0;$<x.canonical.z-E.canonical.z&&!b.leaves[F];$++){k*=2,P*=2;const V=2*Math.floor(P)+Math.floor(k);F=b.childOffsets[F]+V,k%=1,P%=1}return{min:this.exaggeration()*b.minimums[F],max:this.exaggeration()*b.maximums[F]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(x,d,b){throw new Error("Pure virtual method called.")}pointCoordinate(x){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(x){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},y.ErrorEvent=Rt,y.EvaluationParameters=ie,y.Event=st,y.Evented=gt,y.GlyphManager=ta,y.ImagePosition=Ec,y.LineAtlas=zc,y.LngLat=Ni,y.LngLatBounds=Qo,y.LocalGlyphMode=Ac,y.MAX_MERCATOR_LATITUDE=vo,y.MAX_SAFE_INTEGER=H,y.MercatorCoordinate=sh,y.ONE_EM=Cr,y.OverscaledTileID=qr,y.Properties=rt,y.RGBAImage=on,y.RequestManager=class{constructor(x,d,b){this._transformRequestFn=x,this._customAccessToken=d,this._silenceAuthErrors=!!b,this._createSkuToken()}_createSkuToken(){const x=function(){let d="";for(let b=0;b<10;b++)d+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",xt,d].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=x.token,this._skuTokenExpiresAt=x.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(x,d){return this._transformRequestFn&&this._transformRequestFn(x,d)||{url:x}}normalizeStyleURL(x,d){if(!ei(x))return x;const b=Et(x);return b.path=`/styles/v1${b.path}`,this._makeAPIURL(b,this._customAccessToken||d)}normalizeGlyphsURL(x,d){if(!ei(x))return x;const b=Et(x);return b.path=`/fonts/v1${b.path}`,this._makeAPIURL(b,this._customAccessToken||d)}normalizeSourceURL(x,d){if(!ei(x))return x;const b=Et(x);return b.path=`/v4/${b.authority}.json`,b.params.push("secure"),this._makeAPIURL(b,this._customAccessToken||d)}normalizeSpriteURL(x,d,b,E){const S=Et(x);return ei(x)?(S.path=`/styles/v1${S.path}/sprite${d}${b}`,this._makeAPIURL(S,this._customAccessToken||E)):(S.path+=`${d}${b}`,ti(S))}normalizeTileURL(x,d,b){if(this._isSkuTokenExpired()&&this._createSkuToken(),x&&!ei(x))return x;const E=Et(x);E.path=E.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${d||b&&E.authority!=="raster"&&b===512?"@2x":""}${Jt.supported?".webp":"$1"}`),E.authority==="raster"?E.path=`/${Lt.RASTER_URL_PREFIX}${E.path}`:(E.path=E.path.replace(/^.+\/v4\//,"/"),E.path=`/${Lt.TILE_URL_VERSION}${E.path}`);const S=this._customAccessToken||function(k){for(const P of k){const F=P.match(/^access_token=(.*)$/);if(F)return F[1]}return null}(E.params)||Lt.ACCESS_TOKEN;return Lt.REQUIRE_ACCESS_TOKEN&&S&&this._skuToken&&E.params.push(`sku=${this._skuToken}`),this._makeAPIURL(E,S)}canonicalizeTileURL(x,d){const b=Et(x);if(!b.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!b.path.match(/\.[\w]+$/))return x;let E="mapbox://";b.path.match(/^\/raster\/v1\//)?E+=`raster/${b.path.replace(`/${Lt.RASTER_URL_PREFIX}/`,"")}`:E+=`tiles/${b.path.replace(`/${Lt.TILE_URL_VERSION}/`,"")}`;let S=b.params;return d&&(S=S.filter(k=>!k.match(/^access_token=/))),S.length&&(E+=`?${S.join("&")}`),E}canonicalizeTileset(x,d){const b=!!d&&ei(d),E=[];for(const S of x.tiles||[])Vt(S)?E.push(this.canonicalizeTileURL(S,b)):E.push(S);return E}_makeAPIURL(x,d){const b="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",E=Et(Lt.API_URL);if(x.protocol=E.protocol,x.authority=E.authority,x.protocol==="http"){const S=x.params.indexOf("secure");S>=0&&x.params.splice(S,1)}if(E.path!=="/"&&(x.path=`${E.path}${x.path}`),!Lt.REQUIRE_ACCESS_TOKEN)return ti(x);if(d=d||Lt.ACCESS_TOKEN,!this._silenceAuthErrors){if(!d)throw new Error(`An API access token is required to use Mapbox GL. ${b}`);if(d[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${b}`)}return x.params=x.params.filter(S=>S.indexOf("access_token")===-1),x.params.push(`access_token=${d||""}`),ti(x)}},y.ResourceType=we,y.SegmentVector=Tr,y.SourceCache=rs,y.StencilMode=Nc,y.StructArrayLayout1ui2=Er,y.StructArrayLayout2f1f2i16=kr,y.StructArrayLayout2i4=Ot,y.StructArrayLayout2ui4=Hi,y.StructArrayLayout3f12=si,y.StructArrayLayout3ui6=lr,y.StructArrayLayout4i8=Qt,y.Texture=Ah,y.Tile=Id,y.Transitionable=Te,y.Uniform1f=nh,y.Uniform1i=class extends Yn{constructor(x,d){super(x,d),this.current=0}set(x){this.current!==x&&(this.current=x,this.gl.uniform1i(this.location,x))}},y.Uniform2f=class extends Yn{constructor(x,d){super(x,d),this.current=[0,0]}set(x){x[0]===this.current[0]&&x[1]===this.current[1]||(this.current=x,this.gl.uniform2f(this.location,x[0],x[1]))}},y.Uniform3f=class extends Yn{constructor(x,d){super(x,d),this.current=[0,0,0]}set(x){x[0]===this.current[0]&&x[1]===this.current[1]&&x[2]===this.current[2]||(this.current=x,this.gl.uniform3f(this.location,x[0],x[1],x[2]))}},y.Uniform4f=eu,y.UniformColor=tu,y.UniformMatrix2f=class extends Yn{constructor(x,d){super(x,d),this.current=of}set(x){for(let d=0;d<4;d++)if(x[d]!==this.current[d]){this.current=x,this.gl.uniformMatrix2fv(this.location,!1,x);break}}},y.UniformMatrix3f=class extends Yn{constructor(x,d){super(x,d),this.current=nf}set(x){for(let d=0;d<9;d++)if(x[d]!==this.current[d]){this.current=x,this.gl.uniformMatrix3fv(this.location,!1,x);break}}},y.UniformMatrix4f=class extends Yn{constructor(x,d){super(x,d),this.current=rf}set(x){if(x[12]!==this.current[12]||x[0]!==this.current[0])return this.current=x,void this.gl.uniformMatrix4fv(this.location,!1,x);for(let d=1;d<16;d++)if(x[d]!==this.current[d]){this.current=x,this.gl.uniformMatrix4fv(this.location,!1,x);break}}},y.UnwrappedTileID=Ed,y.ValidationError=Qe,y.VectorTileWorkerSource=class extends gt{constructor(x,d,b,E,S){super(),this.actor=x,this.layerIndex=d,this.availableImages=b,this.loadVectorData=S||jd,this.loading={},this.loaded={},this.deduped=new Vd(x.scheduler),this.isSpriteLoaded=E,this.scheduler=x.scheduler}loadTile(x,d){const b=x.uid,E=x&&x.request,S=E&&E.collectResourceTiming,k=this.loading[b]=new lm(x);k.abort=this.loadVectorData(x,(P,F)=>{const $=!this.loading[b];if(delete this.loading[b],$||P||!F)return k.status="done",$||(this.loaded[b]=k),d(P);const V=F.rawData,Z={};F.expires&&(Z.expires=F.expires),F.cacheControl&&(Z.cacheControl=F.cacheControl),k.vectorTile=F.vectorTile||new is.VectorTile(new tl(V));const X=()=>{k.parse(k.vectorTile,this.layerIndex,this.availableImages,this.actor,(W,ne)=>{if(W||!ne)return d(W);const ce={};if(S){const ye=bd(E);ye.length>0&&(ce.resourceTiming=JSON.parse(JSON.stringify(ye)))}d(null,pe({rawTileData:V.slice(0)},ne,Z,ce))})};this.isSpriteLoaded?X():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(X,{type:"parseTile",isSymbolTile:x.isSymbolTile,zoom:x.tileZoom}):X()}),this.loaded=this.loaded||{},this.loaded[b]=k})}reloadTile(x,d){const b=this.loaded,E=x.uid,S=this;if(b&&b[E]){const k=b[E];k.showCollisionBoxes=x.showCollisionBoxes,k.enableTerrain=!!x.enableTerrain;const P=(F,$)=>{const V=k.reloadCallback;V&&(delete k.reloadCallback,k.parse(k.vectorTile,S.layerIndex,this.availableImages,S.actor,V)),d(F,$)};k.status==="parsing"?k.reloadCallback=P:k.status==="done"&&(k.vectorTile?k.parse(k.vectorTile,this.layerIndex,this.availableImages,this.actor,P):P())}}abortTile(x,d){const b=x.uid,E=this.loading[b];E&&(E.abort&&E.abort(),delete this.loading[b]),d()}removeTile(x,d){const b=this.loaded,E=x.uid;b&&b[E]&&delete b[E],d()}},y.WritingMode=sn,y.ZoomHistory=Vl,y.add=function(x,d,b){return x[0]=d[0]+b[0],x[1]=d[1]+b[1],x[2]=d[2]+b[2],x},y.addDynamicAttributes=Dc,y.altitudeFromMercatorZ=ic,y.asyncAll=Se,y.bezier=me,y.bindAll=Nt,y.boundsAttributes=Oc,y.bufferConvexPolygon=function(x,d){const b=[];for(let E=0;E<x.length;E++){const S=ue(E-1,-1,x.length-1),k=ue(E+1,-1,x.length-1),P=x[E],F=x[k],$=x[S].sub(P).unit(),V=F.sub(P).unit(),Z=V.angleWithSep($.x,$.y),X=$.add(V).unit().mult(-1*d/Math.sin(Z/2));b.push(P.add(X))}return b},y.cacheEntryPossiblyAdded=function(x){Ur++,Ur>br&&(x.getActor().send("enforceCacheSizeLimit",zr),Ur=0)},y.clamp=ge,y.clearTileCache=function(x){const d=G.caches.delete(Jr);x&&d.catch(x).then(()=>x())},y.clipLine=ld,y.clone=function(x){var d=new Nr(3);return d[0]=x[0],d[1]=x[1],d[2]=x[2],d},y.clone$1=function(x){var d=new Nr(16);return d[0]=x[0],d[1]=x[1],d[2]=x[2],d[3]=x[3],d[4]=x[4],d[5]=x[5],d[6]=x[6],d[7]=x[7],d[8]=x[8],d[9]=x[9],d[10]=x[10],d[11]=x[11],d[12]=x[12],d[13]=x[13],d[14]=x[14],d[15]=x[15],d},y.clone$2=Ut,y.collisionCircleLayout=mp,y.config=Lt,y.conjugate=function(x,d){return x[0]=-d[0],x[1]=-d[1],x[2]=-d[2],x[3]=d[3],x},y.copy=function(x,d){return x[0]=d[0],x[1]=d[1],x[2]=d[2],x},y.create=hh,y.create$1=function(){var x=new Nr(16);return Nr!=Float32Array&&(x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[11]=0,x[12]=0,x[13]=0,x[14]=0),x[0]=1,x[5]=1,x[10]=1,x[15]=1,x},y.create$2=pu,y.createExpression=lo,y.createLayout=We,y.createStyleLayer=function(x){return x.type==="custom"?new Jp(x):new em[x.type](x)},y.cross=function(x,d,b){var E=d[0],S=d[1],k=d[2],P=b[0],F=b[1],$=b[2];return x[0]=S*$-k*F,x[1]=k*P-E*$,x[2]=E*F-S*P,x},y.degToRad=Q,y.div=function(x,d,b){return x[0]=d[0]/b[0],x[1]=d[1]/b[1],x[2]=d[2]/b[2],x},y.dot=function(x,d){return x[0]*d[0]+x[1]*d[1]+x[2]*d[2]},y.dot$1=function(x,d){return x[0]*d[0]+x[1]*d[1]+x[2]*d[2]+x[3]*d[3]},y.ease=Re,y.easeCubicInOut=he,y.emitValidationErrors=$l,y.endsWith=St,y.enforceCacheSizeLimit=function(x){yr(),Ji&&Ji.then(d=>{d.keys().then(b=>{for(let E=0;E<b.length-x;E++)d.delete(b[E])})})},y.evaluateSizeForFeature=_h,y.evaluateSizeForZoom=Ks,y.evaluateVariableOffset=fd,y.evented=q,y.exactEquals=function(x,d){return x[0]===d[0]&&x[1]===d[1]&&x[2]===d[2]&&x[3]===d[3]},y.exactEquals$1=function(x,d){return x[0]===d[0]&&x[1]===d[1]&&x[2]===d[2]},y.exported=Pt,y.exported$1=Jt,y.extend=pe,y.filterObject=Dt,y.fromMat4=function(x,d){return x[0]=d[0],x[1]=d[1],x[2]=d[2],x[3]=d[4],x[4]=d[5],x[5]=d[6],x[6]=d[8],x[7]=d[9],x[8]=d[10],x},y.fromQuat=function(x,d){var b=d[0],E=d[1],S=d[2],k=d[3],P=b+b,F=E+E,$=S+S,V=b*P,Z=E*P,X=E*F,W=S*P,ne=S*F,ce=S*$,ye=k*P,Me=k*F,Ce=k*$;return x[0]=1-X-ce,x[1]=Z+Ce,x[2]=W-Me,x[3]=0,x[4]=Z-Ce,x[5]=1-V-ce,x[6]=ne+ye,x[7]=0,x[8]=W+Me,x[9]=ne-ye,x[10]=1-V-X,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x},y.fromRotation=function(x,d){var b=Math.sin(d),E=Math.cos(d);return x[0]=E,x[1]=b,x[2]=0,x[3]=-b,x[4]=E,x[5]=0,x[6]=0,x[7]=0,x[8]=1,x},y.fromScaling=function(x,d){return x[0]=d[0],x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=d[1],x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=d[2],x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x},y.furthestTileCorner=function(x){const d=Math.round((x+45+360)%360/90)%4;return se[d]},y.getAABBPointSquareDist=function(x,d,b){let E=0;for(let S=0;S<2;++S){const k=b?b[S]:0;x[S]>k&&(E+=(x[S]-k)*(x[S]-k)),d[S]<k&&(E+=(k-d[S])*(k-d[S]))}return E},y.getAnchorAlignment=Sc,y.getAnchorJustification=kc,y.getBounds=function(x){let d=1/0,b=1/0,E=-1/0,S=-1/0;for(const k of x)d=Math.min(d,k.x),b=Math.min(b,k.y),E=Math.max(E,k.x),S=Math.max(S,k.y);return{min:new N(d,b),max:new N(E,S)}},y.getImage=je,y.getJSON=function(x,d){return K(pe(x,{type:"json"}),d)},y.getMapSessionAPI=pr,y.getPerformanceMeasurement=bd,y.getProjection=function(x){const d=Zd[x.name];if(!d)throw new Error(`Invalid projection name: ${x.name}`);return d.conic?function(b,E){if(E.parallels&&Math.abs(E.parallels[0]+E.parallels[1])<.01){let S=function(k){const P=Math.max(.01,Math.cos(Q(k))),F=1/(2*Math.max(Math.PI*P,1/P));return{wrap:!0,project($,V){const Z=Q($)*P,X=Math.sin(Q(V))/P;return{x:Z*F+.5,y:-X*F+.5}},unproject($,V){const Z=-(V-.5)/F,X=ge(_e(($-.5)/F)/P,-180,180),W=Math.asin(ge(Z*P,-1,1)),ne=ge(_e(W),-85.051129,vo);return new Ni(X,ne)}}}(E.parallels[0]);if(E.name==="lambertConformalConic"){const{project:k,unproject:P}=Zd.mercator;S={wrap:!0,project:k,unproject:P}}return pe({},b,E,S)}return pe({},b,E)}(d,x):d},y.getRTLTextPluginStatus=Y,y.getReferrer=ae,y.getTilePoint=function(x,{x:d,y:b},E=0){return new N(((d-E)*x.scale-x.x)*ki,(b*x.scale-x.y)*ki)},y.getTileVec3=function(x,d,b=0){return Ys(((d.x-b)*x.scale-x.x)*ki,(d.y*x.scale-x.y)*ki,ic(d.z,d.y))},y.getVideo=function(x,d){const b=G.document.createElement("video");b.muted=!0,b.onloadstart=function(){d(null,b)};for(let E=0;E<x.length;E++){const S=G.document.createElement("source");Be(x[E])||(b.crossOrigin="Anonymous"),S.src=x[E],b.appendChild(S)}return{cancel:()=>{}}},y.identity=lc,y.identity$1=wu,y.invert=function(x,d){var b=d[0],E=d[1],S=d[2],k=d[3],P=d[4],F=d[5],$=d[6],V=d[7],Z=d[8],X=d[9],W=d[10],ne=d[11],ce=d[12],ye=d[13],Me=d[14],Ce=d[15],ze=b*F-E*P,$e=b*$-S*P,qe=b*V-k*P,Ge=E*$-S*F,Ye=E*V-k*F,ot=S*V-k*$,et=Z*ye-X*ce,At=Z*Me-W*ce,ut=Z*Ce-ne*ce,at=X*Me-W*ye,dt=X*Ce-ne*ye,mt=W*Ce-ne*Me,ht=ze*mt-$e*dt+qe*at+Ge*ut-Ye*At+ot*et;return ht?(x[0]=(F*mt-$*dt+V*at)*(ht=1/ht),x[1]=(S*dt-E*mt-k*at)*ht,x[2]=(ye*ot-Me*Ye+Ce*Ge)*ht,x[3]=(W*Ye-X*ot-ne*Ge)*ht,x[4]=($*ut-P*mt-V*At)*ht,x[5]=(b*mt-S*ut+k*At)*ht,x[6]=(Me*qe-ce*ot-Ce*$e)*ht,x[7]=(Z*ot-W*qe+ne*$e)*ht,x[8]=(P*dt-F*ut+V*et)*ht,x[9]=(E*ut-b*dt-k*et)*ht,x[10]=(ce*Ye-ye*qe+Ce*ze)*ht,x[11]=(X*qe-Z*Ye-ne*ze)*ht,x[12]=(F*At-P*at-$*et)*ht,x[13]=(b*at-E*At+S*et)*ht,x[14]=(ye*$e-ce*Ge-Me*ze)*ht,x[15]=(Z*Ge-X*$e+W*ze)*ht,x):null},y.isMapAuthenticated=function(x){return vr.has(x)},y.isMapboxURL=ei,y.latFromMercatorY=Pn,y.len=Ef,y.length=gu,y.length$1=function(x){return Math.hypot(x[0],x[1],x[2],x[3])},y.loadVectorTile=jd,y.makeRequest=K,y.mercatorXfromLng=Qh,y.mercatorYfromLat=ec,y.mercatorZfromAltitude=tc,y.mul=function(x,d,b){return x[0]=d[0]*b[0],x[1]=d[1]*b[1],x[2]=d[2]*b[2],x[3]=d[3]*b[3],x},y.mul$1=vf,y.mul$2=wf,y.multiply=mu,y.multiply$1=yu,y.nextPowerOfTwo=ct,y.normalize=vu,y.normalize$1=function(x,d){var b=d[0],E=d[1],S=d[2],k=d[3],P=b*b+E*E+S*S+k*k;return P>0&&(P=1/Math.sqrt(P)),x[0]=b*P,x[1]=E*P,x[2]=S*P,x[3]=k*P,x},y.number=Pi,y.ortho=function(x,d,b,E,S,k,P){var F=1/(d-b),$=1/(E-S),V=1/(k-P);return x[0]=-2*F,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=-2*$,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=2*V,x[11]=0,x[12]=(d+b)*F,x[13]=(S+E)*$,x[14]=(P+k)*V,x[15]=1,x},y.pbf=tl,y.perspective=function(x,d,b,E,S){var k,P=1/Math.tan(d/2);return x[0]=P/b,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=P,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[11]=-1,x[12]=0,x[13]=0,x[15]=0,S!=null&&S!==1/0?(x[10]=(S+E)*(k=1/(E-S)),x[14]=2*S*E*k):(x[10]=-1,x[14]=-2*E),x},y.pick=function(x,d){const b={};for(let E=0;E<d.length;E++){const S=d[E];S in x&&(b[S]=x[S])}return b},y.plugin=ee,y.pointGeometry=N,y.polygonIntersectsBox=uu,y.polygonIntersectsPolygon=au,y.polygonizeBounds=function(x,d,b=0,E=!0){const S=new N(b,b),k=x.sub(S),P=d.add(S),F=[k,new N(P.x,k.y),P,new N(k.x,P.y)];return E&&F.push(k),F},y.posAttributes=nm,y.postMapLoadEvent=$i,y.postTurnstileEvent=ci,y.potpack=wc,y.prevPowerOfTwo=function(x){return x<=1?1:Math.pow(2,Math.floor(Math.log(x)/Math.LN2))},y.radToDeg=_e,y.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],y.registerForPluginStateChange=function(x){return x({pluginStatus:C,pluginURL:L}),q.on("pluginStateChange",x),x},y.removeAuthState=function(x){vr.delete(x)},y.renderColorRamp=dc,y.rotateX=function(x,d,b){var E=Math.sin(b),S=Math.cos(b),k=d[4],P=d[5],F=d[6],$=d[7],V=d[8],Z=d[9],X=d[10],W=d[11];return d!==x&&(x[0]=d[0],x[1]=d[1],x[2]=d[2],x[3]=d[3],x[12]=d[12],x[13]=d[13],x[14]=d[14],x[15]=d[15]),x[4]=k*S+V*E,x[5]=P*S+Z*E,x[6]=F*S+X*E,x[7]=$*S+W*E,x[8]=V*S-k*E,x[9]=Z*S-P*E,x[10]=X*S-F*E,x[11]=W*S-$*E,x},y.rotateX$1=Eu,y.rotateY=function(x,d,b){var E=Math.sin(b),S=Math.cos(b),k=d[0],P=d[1],F=d[2],$=d[3],V=d[8],Z=d[9],X=d[10],W=d[11];return d!==x&&(x[4]=d[4],x[5]=d[5],x[6]=d[6],x[7]=d[7],x[12]=d[12],x[13]=d[13],x[14]=d[14],x[15]=d[15]),x[0]=k*S-V*E,x[1]=P*S-Z*E,x[2]=F*S-X*E,x[3]=$*S-W*E,x[8]=k*E+V*S,x[9]=P*E+Z*S,x[10]=F*E+X*S,x[11]=$*E+W*S,x},y.rotateZ=function(x,d,b){var E=Math.sin(b),S=Math.cos(b),k=d[0],P=d[1],F=d[2],$=d[3],V=d[4],Z=d[5],X=d[6],W=d[7];return d!==x&&(x[8]=d[8],x[9]=d[9],x[10]=d[10],x[11]=d[11],x[12]=d[12],x[13]=d[13],x[14]=d[14],x[15]=d[15]),x[0]=k*S+V*E,x[1]=P*S+Z*E,x[2]=F*S+X*E,x[3]=$*S+W*E,x[4]=V*S-k*E,x[5]=Z*S-P*E,x[6]=X*S-F*E,x[7]=W*S-$*E,x},y.rotateZ$1=function(x,d,b){b*=.5;var E=d[0],S=d[1],k=d[2],P=d[3],F=Math.sin(b),$=Math.cos(b);return x[0]=E*$+S*F,x[1]=S*$-E*F,x[2]=k*$+P*F,x[3]=P*$-k*F,x},y.scale=function(x,d,b){return x[0]=d[0]*b,x[1]=d[1]*b,x[2]=d[2]*b,x},y.scale$1=function(x,d,b){var E=b[0],S=b[1],k=b[2];return x[0]=d[0]*E,x[1]=d[1]*E,x[2]=d[2]*E,x[3]=d[3]*E,x[4]=d[4]*S,x[5]=d[5]*S,x[6]=d[6]*S,x[7]=d[7]*S,x[8]=d[8]*k,x[9]=d[9]*k,x[10]=d[10]*k,x[11]=d[11]*k,x[12]=d[12],x[13]=d[13],x[14]=d[14],x[15]=d[15],x},y.scale$2=function(x,d,b){return x[0]=d[0]*b,x[1]=d[1]*b,x[2]=d[2]*b,x[3]=d[3]*b,x},y.scaleAndAdd=xu,y.setCacheLimits=function(x,d){zr=x,br=d},y.setRTLTextPlugin=function(x,d,b=!1){if(C===_o||C===I||C===g)throw new Error("setRTLTextPlugin cannot be called multiple times.");L=Pt.resolveURL(x),C=_o,M=d,U(),b||J()},y.smoothstep=function(x,d,b){return(b=ge((b-x)/(d-x),0,1))*b*(3-2*b)},y.spec=Ve,y.storeAuthState=function(x,d){d?vr.add(x):vr.delete(x)},y.sub=bf,y.subtract=_u,y.symbolSize=gp,y.tileTransform=Ih,y.transformMat3=function(x,d,b){var E=d[0],S=d[1],k=d[2];return x[0]=E*b[0]+S*b[3]+k*b[6],x[1]=E*b[1]+S*b[4]+k*b[7],x[2]=E*b[2]+S*b[5]+k*b[8],x},y.transformMat4=Xa,y.transformMat4$1=function(x,d,b){var E=d[0],S=d[1],k=d[2],P=b[3]*E+b[7]*S+b[11]*k+b[15];return x[0]=(b[0]*E+b[4]*S+b[8]*k+b[12])/(P=P||1),x[1]=(b[1]*E+b[5]*S+b[9]*k+b[13])/P,x[2]=(b[2]*E+b[6]*S+b[10]*k+b[14])/P,x},y.transformQuat=bu,y.translate=function(x,d,b){var E,S,k,P,F,$,V,Z,X,W,ne,ce,ye=b[0],Me=b[1],Ce=b[2];return d===x?(x[12]=d[0]*ye+d[4]*Me+d[8]*Ce+d[12],x[13]=d[1]*ye+d[5]*Me+d[9]*Ce+d[13],x[14]=d[2]*ye+d[6]*Me+d[10]*Ce+d[14],x[15]=d[3]*ye+d[7]*Me+d[11]*Ce+d[15]):(S=d[1],k=d[2],P=d[3],F=d[4],$=d[5],V=d[6],Z=d[7],X=d[8],W=d[9],ne=d[10],ce=d[11],x[0]=E=d[0],x[1]=S,x[2]=k,x[3]=P,x[4]=F,x[5]=$,x[6]=V,x[7]=Z,x[8]=X,x[9]=W,x[10]=ne,x[11]=ce,x[12]=E*ye+F*Me+X*Ce+d[12],x[13]=S*ye+$*Me+W*Ce+d[13],x[14]=k*ye+V*Me+ne*Ce+d[14],x[15]=P*ye+Z*Me+ce*Ce+d[15]),x},y.triggerPluginCompletionEvent=z,y.uniqueId=Ze,y.validateCustomStyleLayer=function(x){const d=[],b=x.id;return b===void 0&&d.push({message:`layers.${b}: missing required property "id"`}),x.render===void 0&&d.push({message:`layers.${b}: missing required method "render"`}),x.renderingMode&&x.renderingMode!=="2d"&&x.renderingMode!=="3d"&&d.push({message:`layers.${b}: property "renderingMode" must be either "2d" or "3d"`}),d},y.validateFog=Ra,y.validateLight=Yh,y.validateStyle=Xn,y.values=le,y.vectorTile=is,y.version=B,y.warnOnce=ft,y.window=G,y.wrap=ue}),T(["./shared"],function(y){function B(ae){const K=typeof ae;if(K==="number"||K==="boolean"||K==="string"||ae==null)return JSON.stringify(ae);if(Array.isArray(ae)){let Ae="[";for(const Be of ae)Ae+=`${B(Be)},`;return`${Ae}]`}const re=Object.keys(ae).sort();let de="{";for(let Ae=0;Ae<re.length;Ae++)de+=`${JSON.stringify(re[Ae])}:${B(ae[re[Ae]])},`;return`${de}}`}function D(ae){let K="";for(const re of y.refProperties)K+=`/${B(ae[re])}`;return K}class O{constructor(K){this.keyCache={},K&&this.replace(K)}replace(K){this._layerConfigs={},this._layers={},this.update(K,[])}update(K,re){for(const Ae of K)this._layerConfigs[Ae.id]=Ae,(this._layers[Ae.id]=y.createStyleLayer(Ae)).compileFilter(),this.keyCache[Ae.id]&&delete this.keyCache[Ae.id];for(const Ae of re)delete this.keyCache[Ae],delete this._layerConfigs[Ae],delete this._layers[Ae];this.familiesBySource={};const de=function(Ae,Be){const Ne={};for(let Fe=0;Fe<Ae.length;Fe++){const je=Be&&Be[Ae[Fe].id]||D(Ae[Fe]);Be&&(Be[Ae[Fe].id]=je);let tt=Ne[je];tt||(tt=Ne[je]=[]),tt.push(Ae[Fe])}const Ue=[];for(const Fe in Ne)Ue.push(Ne[Fe]);return Ue}(y.values(this._layerConfigs),this.keyCache);for(const Ae of de){const Be=Ae.map(pt=>this._layers[pt.id]),Ne=Be[0];if(Ne.visibility==="none")continue;const Ue=Ne.source||"";let Fe=this.familiesBySource[Ue];Fe||(Fe=this.familiesBySource[Ue]={});const je=Ne.sourceLayer||"_geojsonTileLayer";let tt=Fe[je];tt||(tt=Fe[je]=[]),tt.push(Be)}}}const{ImageBitmap:N}=y.window;class j{loadTile(K,re){const{uid:de,encoding:Ae,rawImageData:Be,padding:Ne,buildQuadTree:Ue}=K,Fe=N&&Be instanceof N?this.getImageData(Be,Ne):Be;re(null,new y.DEMData(de,Fe,Ae,Ne<1,Ue))}getImageData(K,re){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(K.width,K.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=K.width,this.offscreenCanvas.height=K.height,this.offscreenCanvasContext.drawImage(K,0,0,K.width,K.height);const de=this.offscreenCanvasContext.getImageData(-re,-re,K.width+2*re,K.height+2*re);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),new y.RGBAImage({width:de.width,height:de.height},de.data)}}var G=function ae(K,re){var de,Ae=K&&K.type;if(Ae==="FeatureCollection")for(de=0;de<K.features.length;de++)ae(K.features[de],re);else if(Ae==="GeometryCollection")for(de=0;de<K.geometries.length;de++)ae(K.geometries[de],re);else if(Ae==="Feature")ae(K.geometry,re);else if(Ae==="Polygon")H(K.coordinates,re);else if(Ae==="MultiPolygon")for(de=0;de<K.coordinates.length;de++)H(K.coordinates[de],re);return K};function H(ae,K){if(ae.length!==0){te(ae[0],K);for(var re=1;re<ae.length;re++)te(ae[re],!K)}}function te(ae,K){for(var re=0,de=0,Ae=0,Be=ae.length,Ne=Be-1;Ae<Be;Ne=Ae++){var Ue=(ae[Ae][0]-ae[Ne][0])*(ae[Ne][1]+ae[Ae][1]),Fe=re+Ue;de+=Math.abs(re)>=Math.abs(Ue)?re-Fe+Ue:Ue-Fe+re,re=Fe}re+de>=0!=!!K&&ae.reverse()}const oe=y.vectorTile.VectorTileFeature.prototype.toGeoJSON;class Q{constructor(K){this._feature=K,this.extent=y.EXTENT,this.type=K.type,this.properties=K.tags,"id"in K&&!isNaN(K.id)&&(this.id=parseInt(K.id,10))}loadGeometry(){if(this._feature.type===1){const K=[];for(const re of this._feature.geometry)K.push([new y.pointGeometry(re[0],re[1])]);return K}{const K=[];for(const re of this._feature.geometry){const de=[];for(const Ae of re)de.push(new y.pointGeometry(Ae[0],Ae[1]));K.push(de)}return K}}toGeoJSON(K,re,de){return oe.call(this,K,re,de)}}class _e{constructor(K){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=y.EXTENT,this.length=K.length,this._features=K}feature(K){return new Q(this._features[K])}}var se=y.vectorTile.VectorTileFeature,he=me;function me(ae,K){this.options=K||{},this.features=ae,this.length=ae.length}function Re(ae,K){this.id=typeof ae.id=="number"?ae.id:void 0,this.type=ae.type,this.rawGeometry=ae.type===1?[ae.geometry]:ae.geometry,this.properties=ae.tags,this.extent=K||4096}me.prototype.feature=function(ae){return new Re(this.features[ae],this.options.extent)},Re.prototype.loadGeometry=function(){var ae=this.rawGeometry;this.geometry=[];for(var K=0;K<ae.length;K++){for(var re=ae[K],de=[],Ae=0;Ae<re.length;Ae++)de.push(new y.pointGeometry(re[Ae][0],re[Ae][1]));this.geometry.push(de)}return this.geometry},Re.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var ae=this.geometry,K=1/0,re=-1/0,de=1/0,Ae=-1/0,Be=0;Be<ae.length;Be++)for(var Ne=ae[Be],Ue=0;Ue<Ne.length;Ue++){var Fe=Ne[Ue];K=Math.min(K,Fe.x),re=Math.max(re,Fe.x),de=Math.min(de,Fe.y),Ae=Math.max(Ae,Fe.y)}return[K,de,re,Ae]},Re.prototype.toGeoJSON=se.prototype.toGeoJSON;var ge=Se,ue=he;function Se(ae){var K=new y.pbf;return function(re,de){for(var Ae in re.layers)de.writeMessage(3,le,re.layers[Ae])}(ae,K),K.finish()}function le(ae,K){var re;K.writeVarintField(15,ae.version||1),K.writeStringField(1,ae.name||""),K.writeVarintField(5,ae.extent||4096);var de={keys:[],values:[],keycache:{},valuecache:{}};for(re=0;re<ae.length;re++)de.feature=ae.feature(re),K.writeMessage(2,pe,de);var Ae=de.keys;for(re=0;re<Ae.length;re++)K.writeStringField(3,Ae[re]);var Be=de.values;for(re=0;re<Be.length;re++)K.writeMessage(4,$t,Be[re])}function pe(ae,K){var re=ae.feature;re.id!==void 0&&K.writeVarintField(1,re.id),K.writeMessage(2,Le,ae),K.writeVarintField(3,re.type),K.writeMessage(4,ct,re)}function Le(ae,K){var re=ae.feature,de=ae.keys,Ae=ae.values,Be=ae.keycache,Ne=ae.valuecache;for(var Ue in re.properties){var Fe=re.properties[Ue],je=Be[Ue];if(Fe!==null){je===void 0&&(de.push(Ue),Be[Ue]=je=de.length-1),K.writeVarint(je);var tt=typeof Fe;tt!=="string"&&tt!=="boolean"&&tt!=="number"&&(Fe=JSON.stringify(Fe));var pt=tt+":"+Fe,st=Ne[pt];st===void 0&&(Ae.push(Fe),Ne[pt]=st=Ae.length-1),K.writeVarint(st)}}}function Ze(ae,K){return(K<<3)+(7&ae)}function lt(ae){return ae<<1^ae>>31}function ct(ae,K){for(var re=ae.loadGeometry(),de=ae.type,Ae=0,Be=0,Ne=re.length,Ue=0;Ue<Ne;Ue++){var Fe=re[Ue],je=1;de===1&&(je=Fe.length),K.writeVarint(Ze(1,je));for(var tt=de===3?Fe.length-1:Fe.length,pt=0;pt<tt;pt++){pt===1&&de!==1&&K.writeVarint(Ze(2,tt-1));var st=Fe[pt].x-Ae,Rt=Fe[pt].y-Be;K.writeVarint(lt(st)),K.writeVarint(lt(Rt)),Ae+=st,Be+=Rt}de===3&&K.writeVarint(Ze(7,1))}}function $t(ae,K){var re=typeof ae;re==="string"?K.writeStringField(1,ae):re==="boolean"?K.writeBooleanField(7,ae):re==="number"&&(ae%1!=0?K.writeDoubleField(3,ae):ae<0?K.writeSVarintField(6,ae):K.writeVarintField(5,ae))}function Nt(ae,K,re,de,Ae,Be){if(Ae-de<=re)return;const Ne=de+Ae>>1;St(ae,K,Ne,de,Ae,Be%2),Nt(ae,K,re,de,Ne-1,Be+1),Nt(ae,K,re,Ne+1,Ae,Be+1)}function St(ae,K,re,de,Ae,Be){for(;Ae>de;){if(Ae-de>600){const je=Ae-de+1,tt=re-de+1,pt=Math.log(je),st=.5*Math.exp(2*pt/3),Rt=.5*Math.sqrt(pt*st*(je-st)/je)*(tt-je/2<0?-1:1);St(ae,K,re,Math.max(de,Math.floor(re-tt*st/je+Rt)),Math.min(Ae,Math.floor(re+(je-tt)*st/je+Rt)),Be)}const Ne=K[2*re+Be];let Ue=de,Fe=Ae;for(Gt(ae,K,de,re),K[2*Ae+Be]>Ne&&Gt(ae,K,de,Ae);Ue<Fe;){for(Gt(ae,K,Ue,Fe),Ue++,Fe--;K[2*Ue+Be]<Ne;)Ue++;for(;K[2*Fe+Be]>Ne;)Fe--}K[2*de+Be]===Ne?Gt(ae,K,de,Fe):(Fe++,Gt(ae,K,Fe,Ae)),Fe<=re&&(de=Fe+1),re<=Fe&&(Ae=Fe-1)}}function Gt(ae,K,re,de){Dt(ae,re,de),Dt(K,2*re,2*de),Dt(K,2*re+1,2*de+1)}function Dt(ae,K,re){const de=ae[K];ae[K]=ae[re],ae[re]=de}function Ut(ae,K,re,de){const Ae=ae-re,Be=K-de;return Ae*Ae+Be*Be}ge.fromVectorTileJs=Se,ge.fromGeojsonVt=function(ae,K){K=K||{};var re={};for(var de in ae)re[de]=new he(ae[de].features,K),re[de].name=de,re[de].version=K.version,re[de].extent=K.extent;return Se({layers:re})},ge.GeoJSONWrapper=ue;const Xt=ae=>ae[0],ft=ae=>ae[1];class wt{constructor(K,re=Xt,de=ft,Ae=64,Be=Float64Array){this.nodeSize=Ae,this.points=K;const Ne=K.length<65536?Uint16Array:Uint32Array,Ue=this.ids=new Ne(K.length),Fe=this.coords=new Be(2*K.length);for(let je=0;je<K.length;je++)Ue[je]=je,Fe[2*je]=re(K[je]),Fe[2*je+1]=de(K[je]);Nt(Ue,Fe,Ae,0,Ue.length-1,0)}range(K,re,de,Ae){return function(Be,Ne,Ue,Fe,je,tt,pt){const st=[0,Be.length-1,0],Rt=[];let gt,Ve;for(;st.length;){const Qe=st.pop(),gi=st.pop(),Ai=st.pop();if(gi-Ai<=pt){for(let Ei=Ai;Ei<=gi;Ei++)gt=Ne[2*Ei],Ve=Ne[2*Ei+1],gt>=Ue&&gt<=je&&Ve>=Fe&&Ve<=tt&&Rt.push(Be[Ei]);continue}const ri=Math.floor((Ai+gi)/2);gt=Ne[2*ri],Ve=Ne[2*ri+1],gt>=Ue&&gt<=je&&Ve>=Fe&&Ve<=tt&&Rt.push(Be[ri]);const wi=(Qe+1)%2;(Qe===0?Ue<=gt:Fe<=Ve)&&(st.push(Ai),st.push(ri-1),st.push(wi)),(Qe===0?je>=gt:tt>=Ve)&&(st.push(ri+1),st.push(gi),st.push(wi))}return Rt}(this.ids,this.coords,K,re,de,Ae,this.nodeSize)}within(K,re,de){return function(Ae,Be,Ne,Ue,Fe,je){const tt=[0,Ae.length-1,0],pt=[],st=Fe*Fe;for(;tt.length;){const Rt=tt.pop(),gt=tt.pop(),Ve=tt.pop();if(gt-Ve<=je){for(let wi=Ve;wi<=gt;wi++)Ut(Be[2*wi],Be[2*wi+1],Ne,Ue)<=st&&pt.push(Ae[wi]);continue}const Qe=Math.floor((Ve+gt)/2),gi=Be[2*Qe],Ai=Be[2*Qe+1];Ut(gi,Ai,Ne,Ue)<=st&&pt.push(Ae[Qe]);const ri=(Rt+1)%2;(Rt===0?Ne-Fe<=gi:Ue-Fe<=Ai)&&(tt.push(Ve),tt.push(Qe-1),tt.push(ri)),(Rt===0?Ne+Fe>=gi:Ue+Fe>=Ai)&&(tt.push(Qe+1),tt.push(gt),tt.push(ri))}return pt}(this.ids,this.coords,K,re,de,this.nodeSize)}}const bt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ae=>ae},zt=Math.fround||(qt=new Float32Array(1),ae=>(qt[0]=+ae,qt[0]));var qt;class ui{constructor(K){this.options=Lt(Object.create(bt),K),this.trees=new Array(this.options.maxZoom+1)}load(K){const{log:re,minZoom:de,maxZoom:Ae,nodeSize:Be}=this.options;re&&console.time("total time");const Ne=`prepare ${K.length} points`;re&&console.time(Ne),this.points=K;let Ue=[];for(let Fe=0;Fe<K.length;Fe++)K[Fe].geometry&&Ue.push(di(K[Fe],Fe));this.trees[Ae+1]=new wt(Ue,Jt,He,Be,Float32Array),re&&console.timeEnd(Ne);for(let Fe=Ae;Fe>=de;Fe--){const je=+Date.now();Ue=this._cluster(Ue,Fe),this.trees[Fe]=new wt(Ue,Jt,He,Be,Float32Array),re&&console.log("z%d: %d clusters in %dms",Fe,Ue.length,+Date.now()-je)}return re&&console.timeEnd("total time"),this}getClusters(K,re){let de=((K[0]+180)%360+360)%360-180;const Ae=Math.max(-90,Math.min(90,K[1]));let Be=K[2]===180?180:((K[2]+180)%360+360)%360-180;const Ne=Math.max(-90,Math.min(90,K[3]));if(K[2]-K[0]>=360)de=-180,Be=180;else if(de>Be){const tt=this.getClusters([de,Ae,180,Ne],re),pt=this.getClusters([-180,Ae,Be,Ne],re);return tt.concat(pt)}const Ue=this.trees[this._limitZoom(re)],Fe=Ue.range(hi(de),Pt(Ne),hi(Be),Pt(Ae)),je=[];for(const tt of Fe){const pt=Ue.points[tt];je.push(pt.numPoints?mi(pt):this.points[pt.index])}return je}getChildren(K){const re=this._getOriginId(K),de=this._getOriginZoom(K),Ae="No cluster with the specified id.",Be=this.trees[de];if(!Be)throw new Error(Ae);const Ne=Be.points[re];if(!Ne)throw new Error(Ae);const Ue=this.options.radius/(this.options.extent*Math.pow(2,de-1)),Fe=Be.within(Ne.x,Ne.y,Ue),je=[];for(const tt of Fe){const pt=Be.points[tt];pt.parentId===K&&je.push(pt.numPoints?mi(pt):this.points[pt.index])}if(je.length===0)throw new Error(Ae);return je}getLeaves(K,re,de){const Ae=[];return this._appendLeaves(Ae,K,re=re||10,de=de||0,0),Ae}getTile(K,re,de){const Ae=this.trees[this._limitZoom(K)],Be=Math.pow(2,K),{extent:Ne,radius:Ue}=this.options,Fe=Ue/Ne,je=(de-Fe)/Be,tt=(de+1+Fe)/Be,pt={features:[]};return this._addTileFeatures(Ae.range((re-Fe)/Be,je,(re+1+Fe)/Be,tt),Ae.points,re,de,Be,pt),re===0&&this._addTileFeatures(Ae.range(1-Fe/Be,je,1,tt),Ae.points,Be,de,Be,pt),re===Be-1&&this._addTileFeatures(Ae.range(0,je,Fe/Be,tt),Ae.points,-1,de,Be,pt),pt.features.length?pt:null}getClusterExpansionZoom(K){let re=this._getOriginZoom(K)-1;for(;re<=this.options.maxZoom;){const de=this.getChildren(K);if(re++,de.length!==1)break;K=de[0].properties.cluster_id}return re}_appendLeaves(K,re,de,Ae,Be){const Ne=this.getChildren(re);for(const Ue of Ne){const Fe=Ue.properties;if(Fe&&Fe.cluster?Be+Fe.point_count<=Ae?Be+=Fe.point_count:Be=this._appendLeaves(K,Fe.cluster_id,de,Ae,Be):Be<Ae?Be++:K.push(Ue),K.length===de)break}return Be}_addTileFeatures(K,re,de,Ae,Be,Ne){for(const Ue of K){const Fe=re[Ue],je=Fe.numPoints;let tt,pt,st;if(je)tt=Ti(Fe),pt=Fe.x,st=Fe.y;else{const Ve=this.points[Fe.index];tt=Ve.properties,pt=hi(Ve.geometry.coordinates[0]),st=Pt(Ve.geometry.coordinates[1])}const Rt={type:1,geometry:[[Math.round(this.options.extent*(pt*Be-de)),Math.round(this.options.extent*(st*Be-Ae))]],tags:tt};let gt;je?gt=Fe.id:this.options.generateId?gt=Fe.index:this.points[Fe.index].id&&(gt=this.points[Fe.index].id),gt!==void 0&&(Rt.id=gt),Ne.features.push(Rt)}}_limitZoom(K){return Math.max(this.options.minZoom,Math.min(+K,this.options.maxZoom+1))}_cluster(K,re){const de=[],{radius:Ae,extent:Be,reduce:Ne,minPoints:Ue}=this.options,Fe=Ae/(Be*Math.pow(2,re));for(let je=0;je<K.length;je++){const tt=K[je];if(tt.zoom<=re)continue;tt.zoom=re;const pt=this.trees[re+1],st=pt.within(tt.x,tt.y,Fe),Rt=tt.numPoints||1;let gt=Rt;for(const Ve of st){const Qe=pt.points[Ve];Qe.zoom>re&&(gt+=Qe.numPoints||1)}if(gt>Rt&&gt>=Ue){let Ve=tt.x*Rt,Qe=tt.y*Rt,gi=Ne&&Rt>1?this._map(tt,!0):null;const Ai=(je<<5)+(re+1)+this.points.length;for(const ri of st){const wi=pt.points[ri];if(wi.zoom<=re)continue;wi.zoom=re;const Ei=wi.numPoints||1;Ve+=wi.x*Ei,Qe+=wi.y*Ei,wi.parentId=Ai,Ne&&(gi||(gi=this._map(tt,!0)),Ne(gi,this._map(wi)))}tt.parentId=Ai,de.push(Ct(Ve/gt,Qe/gt,Ai,gt,gi))}else if(de.push(tt),gt>1)for(const Ve of st){const Qe=pt.points[Ve];Qe.zoom<=re||(Qe.zoom=re,de.push(Qe))}}return de}_getOriginId(K){return K-this.points.length>>5}_getOriginZoom(K){return(K-this.points.length)%32}_map(K,re){if(K.numPoints)return re?Lt({},K.properties):K.properties;const de=this.points[K.index].properties,Ae=this.options.map(de);return re&&Ae===de?Lt({},Ae):Ae}}function Ct(ae,K,re,de,Ae){return{x:zt(ae),y:zt(K),zoom:1/0,id:re,parentId:-1,numPoints:de,properties:Ae}}function di(ae,K){const[re,de]=ae.geometry.coordinates;return{x:zt(hi(re)),y:zt(Pt(de)),zoom:1/0,index:K,parentId:-1}}function mi(ae){return{type:"Feature",id:ae.id,properties:Ti(ae),geometry:{type:"Point",coordinates:[(K=ae.x,360*(K-.5)),Tt(ae.y)]}};var K}function Ti(ae){const K=ae.numPoints,re=K>=1e4?`${Math.round(K/1e3)}k`:K>=1e3?Math.round(K/100)/10+"k":K;return Lt(Lt({},ae.properties),{cluster:!0,cluster_id:ae.id,point_count:K,point_count_abbreviated:re})}function hi(ae){return ae/360+.5}function Pt(ae){const K=Math.sin(ae*Math.PI/180),re=.5-.25*Math.log((1+K)/(1-K))/Math.PI;return re<0?0:re>1?1:re}function Tt(ae){const K=(180-360*ae)*Math.PI/180;return 360*Math.atan(Math.exp(K))/Math.PI-90}function Lt(ae,K){for(const re in K)ae[re]=K[re];return ae}function Jt(ae){return ae.x}function He(ae){return ae.y}function jt(ae,K,re,de){for(var Ae,Be=de,Ne=re-K>>1,Ue=re-K,Fe=ae[K],je=ae[K+1],tt=ae[re],pt=ae[re+1],st=K+3;st<re;st+=3){var Rt=Kt(ae[st],ae[st+1],Fe,je,tt,pt);if(Rt>Be)Ae=st,Be=Rt;else if(Rt===Be){var gt=Math.abs(st-Ne);gt<Ue&&(Ae=st,Ue=gt)}}Be>de&&(Ae-K>3&&jt(ae,K,Ae,de),ae[Ae+2]=Be,re-Ae>3&&jt(ae,Ae,re,de))}function Kt(ae,K,re,de,Ae,Be){var Ne=Ae-re,Ue=Be-de;if(Ne!==0||Ue!==0){var Fe=((ae-re)*Ne+(K-de)*Ue)/(Ne*Ne+Ue*Ue);Fe>1?(re=Ae,de=Be):Fe>0&&(re+=Ne*Fe,de+=Ue*Fe)}return(Ne=ae-re)*Ne+(Ue=K-de)*Ue}function Yt(ae,K,re,de){var Ae={id:ae===void 0?null:ae,type:K,geometry:re,tags:de,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Be){var Ne=Be.geometry,Ue=Be.type;if(Ue==="Point"||Ue==="MultiPoint"||Ue==="LineString")ii(Be,Ne);else if(Ue==="Polygon"||Ue==="MultiLineString")for(var Fe=0;Fe<Ne.length;Fe++)ii(Be,Ne[Fe]);else if(Ue==="MultiPolygon")for(Fe=0;Fe<Ne.length;Fe++)for(var je=0;je<Ne[Fe].length;je++)ii(Be,Ne[Fe][je])}(Ae),Ae}function ii(ae,K){for(var re=0;re<K.length;re+=3)ae.minX=Math.min(ae.minX,K[re]),ae.minY=Math.min(ae.minY,K[re+1]),ae.maxX=Math.max(ae.maxX,K[re]),ae.maxY=Math.max(ae.maxY,K[re+1])}function xt(ae,K,re,de){if(K.geometry){var Ae=K.geometry.coordinates,Be=K.geometry.type,Ne=Math.pow(re.tolerance/((1<<re.maxZoom)*re.extent),2),Ue=[],Fe=K.id;if(re.promoteId?Fe=K.properties[re.promoteId]:re.generateId&&(Fe=de||0),Be==="Point")Mi(Ae,Ue);else if(Be==="MultiPoint")for(var je=0;je<Ae.length;je++)Mi(Ae[je],Ue);else if(Be==="LineString")ei(Ae,Ue,Ne,!1);else if(Be==="MultiLineString"){if(re.lineMetrics){for(je=0;je<Ae.length;je++)ei(Ae[je],Ue=[],Ne,!1),ae.push(Yt(Fe,"LineString",Ue,K.properties));return}Vt(Ae,Ue,Ne,!1)}else if(Be==="Polygon")Vt(Ae,Ue,Ne,!0);else{if(Be!=="MultiPolygon"){if(Be==="GeometryCollection"){for(je=0;je<K.geometry.geometries.length;je++)xt(ae,{id:Fe,geometry:K.geometry.geometries[je],properties:K.properties},re,de);return}throw new Error("Input data is not a valid GeoJSON object.")}for(je=0;je<Ae.length;je++){var tt=[];Vt(Ae[je],tt,Ne,!0),Ue.push(tt)}}ae.push(Yt(Fe,Be,Ue,K.properties))}}function Mi(ae,K){K.push(Zt(ae[0])),K.push(Et(ae[1])),K.push(0)}function ei(ae,K,re,de){for(var Ae,Be,Ne=0,Ue=0;Ue<ae.length;Ue++){var Fe=Zt(ae[Ue][0]),je=Et(ae[Ue][1]);K.push(Fe),K.push(je),K.push(0),Ue>0&&(Ne+=de?(Ae*je-Fe*Be)/2:Math.sqrt(Math.pow(Fe-Ae,2)+Math.pow(je-Be,2))),Ae=Fe,Be=je}var tt=K.length-3;K[2]=1,jt(K,0,tt,re),K[tt+2]=1,K.size=Math.abs(Ne),K.start=0,K.end=K.size}function Vt(ae,K,re,de){for(var Ae=0;Ae<ae.length;Ae++){var Be=[];ei(ae[Ae],Be,re,de),K.push(Be)}}function Zt(ae){return ae/360+.5}function Et(ae){var K=Math.sin(ae*Math.PI/180),re=.5-.25*Math.log((1+K)/(1-K))/Math.PI;return re<0?0:re>1?1:re}function ti(ae,K,re,de,Ae,Be,Ne,Ue){if(de/=K,Be>=(re/=K)&&Ne<de)return ae;if(Ne<re||Be>=de)return null;for(var Fe=[],je=0;je<ae.length;je++){var tt=ae[je],pt=tt.geometry,st=tt.type,Rt=Ae===0?tt.minX:tt.minY,gt=Ae===0?tt.maxX:tt.maxY;if(Rt>=re&&gt<de)Fe.push(tt);else if(!(gt<re||Rt>=de)){var Ve=[];if(st==="Point"||st==="MultiPoint")_i(pt,Ve,re,de,Ae);else if(st==="LineString")vi(pt,Ve,re,de,Ae,!1,Ue.lineMetrics);else if(st==="MultiLineString")ci(pt,Ve,re,de,Ae,!1);else if(st==="Polygon")ci(pt,Ve,re,de,Ae,!0);else if(st==="MultiPolygon")for(var Qe=0;Qe<pt.length;Qe++){var gi=[];ci(pt[Qe],gi,re,de,Ae,!0),gi.length&&Ve.push(gi)}if(Ve.length){if(Ue.lineMetrics&&st==="LineString"){for(Qe=0;Qe<Ve.length;Qe++)Fe.push(Yt(tt.id,st,Ve[Qe],tt.tags));continue}st!=="LineString"&&st!=="MultiLineString"||(Ve.length===1?(st="LineString",Ve=Ve[0]):st="MultiLineString"),st!=="Point"&&st!=="MultiPoint"||(st=Ve.length===3?"Point":"MultiPoint"),Fe.push(Yt(tt.id,st,Ve,tt.tags))}}}return Fe.length?Fe:null}function _i(ae,K,re,de,Ae){for(var Be=0;Be<ae.length;Be+=3){var Ne=ae[Be+Ae];Ne>=re&&Ne<=de&&(K.push(ae[Be]),K.push(ae[Be+1]),K.push(ae[Be+2]))}}function vi(ae,K,re,de,Ae,Be,Ne){for(var Ue,Fe,je=Ht(ae),tt=Ae===0?$i:Oi,pt=ae.start,st=0;st<ae.length-3;st+=3){var Rt=ae[st],gt=ae[st+1],Ve=ae[st+2],Qe=ae[st+3],gi=ae[st+4],Ai=Ae===0?Rt:gt,ri=Ae===0?Qe:gi,wi=!1;Ne&&(Ue=Math.sqrt(Math.pow(Rt-Qe,2)+Math.pow(gt-gi,2))),Ai<re?ri>re&&(Fe=tt(je,Rt,gt,Qe,gi,re),Ne&&(je.start=pt+Ue*Fe)):Ai>de?ri<de&&(Fe=tt(je,Rt,gt,Qe,gi,de),Ne&&(je.start=pt+Ue*Fe)):Di(je,Rt,gt,Ve),ri<re&&Ai>=re&&(Fe=tt(je,Rt,gt,Qe,gi,re),wi=!0),ri>de&&Ai<=de&&(Fe=tt(je,Rt,gt,Qe,gi,de),wi=!0),!Be&&wi&&(Ne&&(je.end=pt+Ue*Fe),K.push(je),je=Ht(ae)),Ne&&(pt+=Ue)}var Ei=ae.length-3;Rt=ae[Ei],gt=ae[Ei+1],Ve=ae[Ei+2],(Ai=Ae===0?Rt:gt)>=re&&Ai<=de&&Di(je,Rt,gt,Ve),Ei=je.length-3,Be&&Ei>=3&&(je[Ei]!==je[0]||je[Ei+1]!==je[1])&&Di(je,je[0],je[1],je[2]),je.length&&K.push(je)}function Ht(ae){var K=[];return K.size=ae.size,K.start=ae.start,K.end=ae.end,K}function ci(ae,K,re,de,Ae,Be){for(var Ne=0;Ne<ae.length;Ne++)vi(ae[Ne],K,re,de,Ae,Be,!1)}function Di(ae,K,re,de){ae.push(K),ae.push(re),ae.push(de)}function $i(ae,K,re,de,Ae,Be){var Ne=(Be-K)/(de-K);return ae.push(Be),ae.push(re+(Ae-re)*Ne),ae.push(1),Ne}function Oi(ae,K,re,de,Ae,Be){var Ne=(Be-re)/(Ae-re);return ae.push(K+(de-K)*Ne),ae.push(Be),ae.push(1),Ne}function pr(ae,K){for(var re=[],de=0;de<ae.length;de++){var Ae,Be=ae[de],Ne=Be.type;if(Ne==="Point"||Ne==="MultiPoint"||Ne==="LineString")Ae=vr(Be.geometry,K);else if(Ne==="MultiLineString"||Ne==="Polygon"){Ae=[];for(var Ue=0;Ue<Be.geometry.length;Ue++)Ae.push(vr(Be.geometry[Ue],K))}else if(Ne==="MultiPolygon")for(Ae=[],Ue=0;Ue<Be.geometry.length;Ue++){for(var Fe=[],je=0;je<Be.geometry[Ue].length;je++)Fe.push(vr(Be.geometry[Ue][je],K));Ae.push(Fe)}re.push(Yt(Be.id,Ne,Ae,Be.tags))}return re}function vr(ae,K){var re=[];re.size=ae.size,ae.start!==void 0&&(re.start=ae.start,re.end=ae.end);for(var de=0;de<ae.length;de+=3)re.push(ae[de]+K,ae[de+1],ae[de+2]);return re}function Jr(ae,K){if(ae.transformed)return ae;var re,de,Ae,Be=1<<ae.z,Ne=ae.x,Ue=ae.y;for(re=0;re<ae.features.length;re++){var Fe=ae.features[re],je=Fe.geometry,tt=Fe.type;if(Fe.geometry=[],tt===1)for(de=0;de<je.length;de+=2)Fe.geometry.push(Ji(je[de],je[de+1],K,Be,Ne,Ue));else for(de=0;de<je.length;de++){var pt=[];for(Ae=0;Ae<je[de].length;Ae+=2)pt.push(Ji(je[de][Ae],je[de][Ae+1],K,Be,Ne,Ue));Fe.geometry.push(pt)}}return ae.transformed=!0,ae}function Ji(ae,K,re,de,Ae,Be){return[Math.round(re*(ae*de-Ae)),Math.round(re*(K*de-Be))]}function _r(ae,K,re,de,Ae){for(var Be=K===Ae.maxZoom?0:Ae.tolerance/((1<<K)*Ae.extent),Ne={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:re,y:de,z:K,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Ue=0;Ue<ae.length;Ue++){Ne.numFeatures++,zr(Ne,ae[Ue],Be,Ae);var Fe=ae[Ue].minX,je=ae[Ue].minY,tt=ae[Ue].maxX,pt=ae[Ue].maxY;Fe<Ne.minX&&(Ne.minX=Fe),je<Ne.minY&&(Ne.minY=je),tt>Ne.maxX&&(Ne.maxX=tt),pt>Ne.maxY&&(Ne.maxY=pt)}return Ne}function zr(ae,K,re,de){var Ae=K.geometry,Be=K.type,Ne=[];if(Be==="Point"||Be==="MultiPoint")for(var Ue=0;Ue<Ae.length;Ue+=3)Ne.push(Ae[Ue]),Ne.push(Ae[Ue+1]),ae.numPoints++,ae.numSimplified++;else if(Be==="LineString")br(Ne,Ae,ae,re,!1,!1);else if(Be==="MultiLineString"||Be==="Polygon")for(Ue=0;Ue<Ae.length;Ue++)br(Ne,Ae[Ue],ae,re,Be==="Polygon",Ue===0);else if(Be==="MultiPolygon")for(var Fe=0;Fe<Ae.length;Fe++){var je=Ae[Fe];for(Ue=0;Ue<je.length;Ue++)br(Ne,je[Ue],ae,re,!0,Ue===0)}if(Ne.length){var tt=K.tags||null;if(Be==="LineString"&&de.lineMetrics){for(var pt in tt={},K.tags)tt[pt]=K.tags[pt];tt.mapbox_clip_start=Ae.start/Ae.size,tt.mapbox_clip_end=Ae.end/Ae.size}var st={geometry:Ne,type:Be==="Polygon"||Be==="MultiPolygon"?3:Be==="LineString"||Be==="MultiLineString"?2:1,tags:tt};K.id!==null&&(st.id=K.id),ae.features.push(st)}}function br(ae,K,re,de,Ae,Be){var Ne=de*de;if(de>0&&K.size<(Ae?Ne:de))re.numPoints+=K.length/3;else{for(var Ue=[],Fe=0;Fe<K.length;Fe+=3)(de===0||K[Fe+2]>Ne)&&(re.numSimplified++,Ue.push(K[Fe]),Ue.push(K[Fe+1])),re.numPoints++;Ae&&function(je,tt){for(var pt=0,st=0,Rt=je.length,gt=Rt-2;st<Rt;gt=st,st+=2)pt+=(je[st]-je[gt])*(je[st+1]+je[gt+1]);if(pt>0===tt)for(st=0,Rt=je.length;st<Rt/2;st+=2){var Ve=je[st],Qe=je[st+1];je[st]=je[Rt-2-st],je[st+1]=je[Rt-1-st],je[Rt-2-st]=Ve,je[Rt-1-st]=Qe}}(Ue,Be),ae.push(Ue)}}function yr(ae,K){var re=(K=this.options=function(Ae,Be){for(var Ne in Be)Ae[Ne]=Be[Ne];return Ae}(Object.create(this.options),K)).debug;if(re&&console.time("preprocess data"),K.maxZoom<0||K.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(K.promoteId&&K.generateId)throw new Error("promoteId and generateId cannot be used together.");var de=function(Ae,Be){var Ne=[];if(Ae.type==="FeatureCollection")for(var Ue=0;Ue<Ae.features.length;Ue++)xt(Ne,Ae.features[Ue],Be,Ue);else xt(Ne,Ae.type==="Feature"?Ae:{geometry:Ae},Be);return Ne}(ae,K);this.tiles={},this.tileCoords=[],re&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",K.indexMaxZoom,K.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(de=function(Ae,Be){var Ne=Be.buffer/Be.extent,Ue=Ae,Fe=ti(Ae,1,-1-Ne,Ne,0,-1,2,Be),je=ti(Ae,1,1-Ne,2+Ne,0,-1,2,Be);return(Fe||je)&&(Ue=ti(Ae,1,-Ne,1+Ne,0,-1,2,Be)||[],Fe&&(Ue=pr(Fe,1).concat(Ue)),je&&(Ue=Ue.concat(pr(je,-1)))),Ue}(de,K)).length&&this.splitTile(de,0,0,0),re&&(de.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Fr(ae,K,re){return 32*((1<<ae)*re+K)+ae}function Ur(ae,K){const re=ae.tileID.canonical;if(!this._geoJSONIndex)return K(null,null);const de=this._geoJSONIndex.getTile(re.z,re.x,re.y);if(!de)return K(null,null);const Ae=new _e(de.features);let Be=ge(Ae);Be.byteOffset===0&&Be.byteLength===Be.buffer.byteLength||(Be=new Uint8Array(Be)),K(null,{vectorTile:Ae,rawData:Be.buffer})}yr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},yr.prototype.splitTile=function(ae,K,re,de,Ae,Be,Ne){for(var Ue=[ae,K,re,de],Fe=this.options,je=Fe.debug;Ue.length;){de=Ue.pop(),re=Ue.pop(),K=Ue.pop(),ae=Ue.pop();var tt=1<<K,pt=Fr(K,re,de),st=this.tiles[pt];if(!st&&(je>1&&console.time("creation"),st=this.tiles[pt]=_r(ae,K,re,de,Fe),this.tileCoords.push({z:K,x:re,y:de}),je)){je>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",K,re,de,st.numFeatures,st.numPoints,st.numSimplified),console.timeEnd("creation"));var Rt="z"+K;this.stats[Rt]=(this.stats[Rt]||0)+1,this.total++}if(st.source=ae,Ae){if(K===Fe.maxZoom||K===Ae)continue;var gt=1<<Ae-K;if(re!==Math.floor(Be/gt)||de!==Math.floor(Ne/gt))continue}else if(K===Fe.indexMaxZoom||st.numPoints<=Fe.indexMaxPoints)continue;if(st.source=null,ae.length!==0){je>1&&console.time("clipping");var Ve,Qe,gi,Ai,ri,wi,Ei=.5*Fe.buffer/Fe.extent,On=.5-Ei,hn=.5+Ei,Mt=1+Ei;Ve=Qe=gi=Ai=null,ri=ti(ae,tt,re-Ei,re+hn,0,st.minX,st.maxX,Fe),wi=ti(ae,tt,re+On,re+Mt,0,st.minX,st.maxX,Fe),ae=null,ri&&(Ve=ti(ri,tt,de-Ei,de+hn,1,st.minY,st.maxY,Fe),Qe=ti(ri,tt,de+On,de+Mt,1,st.minY,st.maxY,Fe),ri=null),wi&&(gi=ti(wi,tt,de-Ei,de+hn,1,st.minY,st.maxY,Fe),Ai=ti(wi,tt,de+On,de+Mt,1,st.minY,st.maxY,Fe),wi=null),je>1&&console.timeEnd("clipping"),Ue.push(Ve||[],K+1,2*re,2*de),Ue.push(Qe||[],K+1,2*re,2*de+1),Ue.push(gi||[],K+1,2*re+1,2*de),Ue.push(Ai||[],K+1,2*re+1,2*de+1)}}},yr.prototype.getTile=function(ae,K,re){var de=this.options,Ae=de.extent,Be=de.debug;if(ae<0||ae>24)return null;var Ne=1<<ae,Ue=Fr(ae,K=(K%Ne+Ne)%Ne,re);if(this.tiles[Ue])return Jr(this.tiles[Ue],Ae);Be>1&&console.log("drilling down to z%d-%d-%d",ae,K,re);for(var Fe,je=ae,tt=K,pt=re;!Fe&&je>0;)je--,tt=Math.floor(tt/2),pt=Math.floor(pt/2),Fe=this.tiles[Fr(je,tt,pt)];return Fe&&Fe.source?(Be>1&&console.log("found parent tile z%d-%d-%d",je,tt,pt),Be>1&&console.time("drilling down"),this.splitTile(Fe.source,je,tt,pt,ae,K,re),Be>1&&console.timeEnd("drilling down"),this.tiles[Ue]?Jr(this.tiles[Ue],Ae):null):null};class we extends y.VectorTileWorkerSource{constructor(K,re,de,Ae,Be){super(K,re,de,Ae,Ur),Be&&(this.loadGeoJSON=Be)}loadData(K,re){const de=K&&K.request,Ae=de&&de.collectResourceTiming;this.loadGeoJSON(K,(Be,Ne)=>{if(Be||!Ne)return re(Be);if(typeof Ne!="object")return re(new Error(`Input data given to '${K.source}' is not a valid GeoJSON object.`));{G(Ne,!0);try{if(K.filter){const Fe=y.createExpression(K.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Fe.result==="error")throw new Error(Fe.value.map(tt=>`${tt.key}: ${tt.message}`).join(", "));const je=Ne.features.filter(tt=>Fe.value.evaluate({zoom:0},tt));Ne={type:"FeatureCollection",features:je}}this._geoJSONIndex=K.cluster?new ui(function({superclusterOptions:Fe,clusterProperties:je}){if(!je||!Fe)return Fe;const tt={},pt={},st={accumulated:null,zoom:0},Rt={properties:null},gt=Object.keys(je);for(const Ve of gt){const[Qe,gi]=je[Ve],Ai=y.createExpression(gi),ri=y.createExpression(typeof Qe=="string"?[Qe,["accumulated"],["get",Ve]]:Qe);tt[Ve]=Ai.value,pt[Ve]=ri.value}return Fe.map=Ve=>{Rt.properties=Ve;const Qe={};for(const gi of gt)Qe[gi]=tt[gi].evaluate(st,Rt);return Qe},Fe.reduce=(Ve,Qe)=>{Rt.properties=Qe;for(const gi of gt)st.accumulated=Ve[gi],Ve[gi]=pt[gi].evaluate(st,Rt)},Fe}(K)).load(Ne.features):function(Fe,je){return new yr(Fe,je)}(Ne,K.geojsonVtOptions)}catch(Fe){return re(Fe)}this.loaded={};const Ue={};if(Ae){const Fe=y.getPerformanceMeasurement(de);Fe&&(Ue.resourceTiming={},Ue.resourceTiming[K.source]=JSON.parse(JSON.stringify(Fe)))}re(null,Ue)}})}reloadTile(K,re){const de=this.loaded;return de&&de[K.uid]?super.reloadTile(K,re):this.loadTile(K,re)}loadGeoJSON(K,re){if(K.request)y.getJSON(K.request,re);else{if(typeof K.data!="string")return re(new Error(`Input data given to '${K.source}' is not a valid GeoJSON object.`));try{return re(null,JSON.parse(K.data))}catch{return re(new Error(`Input data given to '${K.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(K,re){try{re(null,this._geoJSONIndex.getClusterExpansionZoom(K.clusterId))}catch(de){re(de)}}getClusterChildren(K,re){try{re(null,this._geoJSONIndex.getChildren(K.clusterId))}catch(de){re(de)}}getClusterLeaves(K,re){try{re(null,this._geoJSONIndex.getLeaves(K.clusterId,K.limit,K.offset))}catch(de){re(de)}}}class Xe{constructor(K){this.self=K,this.actor=new y.Actor(K,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=y.getProjection({name:"mercator"}),this.workerSourceTypes={vector:y.VectorTileWorkerSource,geojson:we},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(re,de)=>{if(this.workerSourceTypes[re])throw new Error(`Worker source with name "${re}" already registered.`);this.workerSourceTypes[re]=de},this.self.registerRTLTextPlugin=re=>{if(y.plugin.isParsed())throw new Error("RTL text plugin already registered.");y.plugin.applyArabicShaping=re.applyArabicShaping,y.plugin.processBidirectionalText=re.processBidirectionalText,y.plugin.processStyledBidirectionalText=re.processStyledBidirectionalText}}clearCaches(K,re,de){delete this.layerIndexes[K],delete this.availableImages[K],delete this.workerSources[K],delete this.demWorkerSources[K],de()}checkIfReady(K,re,de){de()}setReferrer(K,re){this.referrer=re}spriteLoaded(K,re){this.isSpriteLoaded[K]=re;for(const de in this.workerSources[K]){const Ae=this.workerSources[K][de];for(const Be in Ae)Ae[Be]instanceof y.VectorTileWorkerSource&&(Ae[Be].isSpriteLoaded=re,Ae[Be].fire(new y.Event("isSpriteLoaded")))}}setImages(K,re,de){this.availableImages[K]=re;for(const Ae in this.workerSources[K]){const Be=this.workerSources[K][Ae];for(const Ne in Be)Be[Ne].availableImages=re}de()}enableTerrain(K,re,de){this.terrain=re,de()}setProjection(K,re){this.projections[K]=y.getProjection(re)}setLayers(K,re,de){this.getLayerIndex(K).replace(re),de()}updateLayers(K,re,de){this.getLayerIndex(K).update(re.layers,re.removedIds),de()}loadTile(K,re,de){const Ae=this.enableTerrain?y.extend({enableTerrain:this.terrain},re):re;Ae.projection=this.projections[K]||this.defaultProjection,this.getWorkerSource(K,re.type,re.source).loadTile(Ae,de)}loadDEMTile(K,re,de){const Ae=this.enableTerrain?y.extend({buildQuadTree:this.terrain},re):re;this.getDEMWorkerSource(K,re.source).loadTile(Ae,de)}reloadTile(K,re,de){const Ae=this.enableTerrain?y.extend({enableTerrain:this.terrain},re):re;Ae.projection=this.projections[K]||this.defaultProjection,this.getWorkerSource(K,re.type,re.source).reloadTile(Ae,de)}abortTile(K,re,de){this.getWorkerSource(K,re.type,re.source).abortTile(re,de)}removeTile(K,re,de){this.getWorkerSource(K,re.type,re.source).removeTile(re,de)}removeSource(K,re,de){if(!this.workerSources[K]||!this.workerSources[K][re.type]||!this.workerSources[K][re.type][re.source])return;const Ae=this.workerSources[K][re.type][re.source];delete this.workerSources[K][re.type][re.source],Ae.removeSource!==void 0?Ae.removeSource(re,de):de()}loadWorkerSource(K,re,de){try{this.self.importScripts(re.url),de()}catch(Ae){de(Ae.toString())}}syncRTLPluginState(K,re,de){try{y.plugin.setState(re);const Ae=y.plugin.getPluginURL();if(y.plugin.isLoaded()&&!y.plugin.isParsed()&&Ae!=null){this.self.importScripts(Ae);const Be=y.plugin.isParsed();de(Be?void 0:new Error(`RTL Text Plugin failed to import scripts from ${Ae}`),Be)}}catch(Ae){de(Ae.toString())}}getAvailableImages(K){let re=this.availableImages[K];return re||(re=[]),re}getLayerIndex(K){let re=this.layerIndexes[K];return re||(re=this.layerIndexes[K]=new O),re}getWorkerSource(K,re,de){return this.workerSources[K]||(this.workerSources[K]={}),this.workerSources[K][re]||(this.workerSources[K][re]={}),this.workerSources[K][re][de]||(this.workerSources[K][re][de]=new this.workerSourceTypes[re]({send:(Ae,Be,Ne,Ue,Fe,je)=>{this.actor.send(Ae,Be,Ne,K,Fe,je)},scheduler:this.actor.scheduler},this.getLayerIndex(K),this.getAvailableImages(K),this.isSpriteLoaded[K])),this.workerSources[K][re][de]}getDEMWorkerSource(K,re){return this.demWorkerSources[K]||(this.demWorkerSources[K]={}),this.demWorkerSources[K][re]||(this.demWorkerSources[K][re]=new j),this.demWorkerSources[K][re]}enforceCacheSizeLimit(K,re){y.enforceCacheSizeLimit(re)}getWorkerPerformanceMetrics(K,re,de){de(void 0,void 0)}}return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope&&(self.worker=new Xe(self)),Xe}),T(["./shared"],function(y){var B=D;function D(I){return!function(g){return typeof window=="undefined"||typeof document=="undefined"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var C,L,z=new Blob([""],{type:"text/javascript"}),U=URL.createObjectURL(z);try{L=new Worker(U),C=!0}catch{C=!1}return L&&L.terminate(),URL.revokeObjectURL(U),C}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var C=document.createElement("canvas");C.width=C.height=1;var L=C.getContext("2d");if(!L)return!1;var z=L.getImageData(0,0,1,1);return z&&z.width===C.width}()?(O[M=g&&g.failIfMajorPerformanceCaveat]===void 0&&(O[M]=function(C){var L,z=function(U){var q=document.createElement("canvas"),Y=Object.create(D.webGLContextAttributes);return Y.failIfMajorPerformanceCaveat=U,q.getContext("webgl",Y)||q.getContext("experimental-webgl",Y)}(C);if(!z)return!1;try{L=z.createShader(z.VERTEX_SHADER)}catch{return!1}return!(!L||z.isContextLost())&&(z.shaderSource(L,"void main() {}"),z.compileShader(L),z.getShaderParameter(L,z.COMPILE_STATUS)===!0)}(M)),O[M]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var M}(I)}var O={};function N(I,g){if(Array.isArray(I)){if(!Array.isArray(g)||I.length!==g.length)return!1;for(let M=0;M<I.length;M++)if(!N(I[M],g[M]))return!1;return!0}if(typeof I=="object"&&I!==null&&g!==null){if(typeof g!="object"||Object.keys(I).length!==Object.keys(g).length)return!1;for(const M in I)if(!N(I[M],g[M]))return!1;return!0}return I===g}D.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const j={create:function(I,g,M){const C=y.window.document.createElement(I);return g!==void 0&&(C.className=g),M&&M.appendChild(C),C},createNS:function(I,g){return y.window.document.createElementNS(I,g)}},G=y.window.document&&y.window.document.documentElement.style,H=G&&G.userSelect!==void 0?"userSelect":"WebkitUserSelect";let te;j.disableDrag=function(){G&&H&&(te=G[H],G[H]="none")},j.enableDrag=function(){G&&H&&(G[H]=te)},j.setTransform=function(I,g){I.style.transform=g};let oe=!1;try{const I=Object.defineProperty({},"passive",{get(){oe=!0}});y.window.addEventListener("test",I,I),y.window.removeEventListener("test",I,I)}catch{oe=!1}j.addEventListener=function(I,g,M,C={}){I.addEventListener(g,M,"passive"in C&&oe?C:C.capture)},j.removeEventListener=function(I,g,M,C={}){I.removeEventListener(g,M,"passive"in C&&oe?C:C.capture)};const Q=function(I){I.preventDefault(),I.stopPropagation(),y.window.removeEventListener("click",Q,!0)};function _e(I,g,M){const C=I.offsetWidth===g.width?1:I.offsetWidth/g.width;return new y.pointGeometry((M.clientX-g.left)*C,(M.clientY-g.top)*C)}function se(I,g){var M=g[0],C=g[1],L=g[2],z=g[3],U=M*z-L*C;return U?(I[0]=z*(U=1/U),I[1]=-C*U,I[2]=-L*U,I[3]=M*U,I):null}j.suppressClick=function(){y.window.addEventListener("click",Q,!0),y.window.setTimeout(()=>{y.window.removeEventListener("click",Q,!0)},0)},j.mousePos=function(I,g){const M=I.getBoundingClientRect();return _e(I,M,g)},j.touchPos=function(I,g){const M=I.getBoundingClientRect(),C=[];for(let L=0;L<g.length;L++)C.push(_e(I,M,g[L]));return C},j.mouseButton=function(I){return y.window.InstallTrigger!==void 0&&I.button===2&&I.ctrlKey&&y.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:I.button},j.remove=function(I){I.parentNode&&I.parentNode.removeChild(I)};class he{constructor(g,M){this.pos=g,this.dir=M}intersectsPlane(g,M,C){const L=y.dot(M,this.dir);if(Math.abs(L)<1e-6)return!1;const z=y.dot(y.sub(y.create(),g,this.pos),M)/L,U=y.scaleAndAdd(y.create(),this.pos,this.dir,z);return y.copy(C,U),!0}}class me{constructor(g,M){this.points=g,this.planes=M}static fromInvProjectionMatrix(g,M,C){const L=Math.pow(2,C),z=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(q=>{const Y=y.transformMat4([],q,g),J=1/Y[3]/M*L;return y.mul(Y,Y,[J,J,1/Y[3],J])}),U=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(q=>{const Y=y.sub([],z[q[0]],z[q[1]]),J=y.sub([],z[q[2]],z[q[1]]),ee=y.normalize([],y.cross([],Y,J)),ie=-y.dot(ee,z[q[1]]);return ee.concat(ie)});return new me(z,U)}}class Re{constructor(g,M){this.min=g,this.max=M,this.center=y.scale([],y.add([],this.min,this.max),.5)}quadrant(g){const M=[g%2==0,g<2],C=y.clone(this.min),L=y.clone(this.max);for(let z=0;z<M.length;z++)C[z]=M[z]?this.min[z]:this.center[z],L[z]=M[z]?this.center[z]:this.max[z];return L[2]=this.max[2],new Re(C,L)}distanceX(g){return Math.max(Math.min(this.max[0],g[0]),this.min[0])-g[0]}distanceY(g){return Math.max(Math.min(this.max[1],g[1]),this.min[1])-g[1]}distanceZ(g){return Math.max(Math.min(this.max[2],g[2]),this.min[2])-g[2]}intersects(g){const M=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let C=!0;for(let L=0;L<g.planes.length;L++){const z=g.planes[L];let U=0;for(let q=0;q<M.length;q++)U+=y.dot$1(z,M[q])>=0;if(U===0)return 0;U!==M.length&&(C=!1)}if(C)return 2;for(let L=0;L<3;L++){let z=Number.MAX_VALUE,U=-Number.MAX_VALUE;for(let q=0;q<g.points.length;q++){const Y=g.points[q][L]-this.min[L];z=Math.min(z,Y),U=Math.max(U,Y)}if(U<0||z>this.max[L]-this.min[L])return 0}return 1}}function ge(I){const{userImage:g}=I;return!!(g&&g.render&&g.render())&&(I.data.replace(new Uint8Array(g.data.buffer)),!0)}class ue extends y.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new y.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(g){if(this.loaded!==g&&(this.loaded=g,g)){for(const{ids:M,callback:C}of this.requestors)this._notify(M,C);this.requestors=[]}}getImage(g){return this.images[g]}addImage(g,M){this._validate(g,M)&&(this.images[g]=M)}_validate(g,M){let C=!0;return this._validateStretch(M.stretchX,M.data&&M.data.width)||(this.fire(new y.ErrorEvent(new Error(`Image "${g}" has invalid "stretchX" value`))),C=!1),this._validateStretch(M.stretchY,M.data&&M.data.height)||(this.fire(new y.ErrorEvent(new Error(`Image "${g}" has invalid "stretchY" value`))),C=!1),this._validateContent(M.content,M)||(this.fire(new y.ErrorEvent(new Error(`Image "${g}" has invalid "content" value`))),C=!1),C}_validateStretch(g,M){if(!g)return!0;let C=0;for(const L of g){if(L[0]<C||L[1]<L[0]||M<L[1])return!1;C=L[1]}return!0}_validateContent(g,M){return!(g&&(g.length!==4||g[0]<0||M.data.width<g[0]||g[1]<0||M.data.height<g[1]||g[2]<0||M.data.width<g[2]||g[3]<0||M.data.height<g[3]||g[2]<g[0]||g[3]<g[1]))}updateImage(g,M){M.version=this.images[g].version+1,this.images[g]=M,this.updatedImages[g]=!0}removeImage(g){const M=this.images[g];delete this.images[g],delete this.patterns[g],M.userImage&&M.userImage.onRemove&&M.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(g,M){let C=!0;if(!this.isLoaded())for(const L of g)this.images[L]||(C=!1);this.isLoaded()||C?this._notify(g,M):this.requestors.push({ids:g,callback:M})}_notify(g,M){const C={};for(const L of g){this.images[L]||this.fire(new y.Event("styleimagemissing",{id:L}));const z=this.images[L];z?C[L]={data:z.data.clone(),pixelRatio:z.pixelRatio,sdf:z.sdf,version:z.version,stretchX:z.stretchX,stretchY:z.stretchY,content:z.content,hasRenderCallback:Boolean(z.userImage&&z.userImage.render)}:y.warnOnce(`Image "${L}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}M(null,C)}getPixelSize(){const{width:g,height:M}=this.atlasImage;return{width:g,height:M}}getPattern(g){const M=this.patterns[g],C=this.getImage(g);if(!C)return null;if(M&&M.position.version===C.version)return M.position;if(M)M.position.version=C.version;else{const L={w:C.data.width+2,h:C.data.height+2,x:0,y:0},z=new y.ImagePosition(L,C);this.patterns[g]={bin:L,position:z}}return this._updatePatternAtlas(),this.patterns[g].position}bind(g){const M=g.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new y.Texture(g,this.atlasImage,M.RGBA),this.atlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE)}_updatePatternAtlas(){const g=[];for(const z in this.patterns)g.push(this.patterns[z].bin);const{w:M,h:C}=y.potpack(g),L=this.atlasImage;L.resize({width:M||1,height:C||1});for(const z in this.patterns){const{bin:U}=this.patterns[z],q=U.x+1,Y=U.y+1,J=this.images[z].data,ee=J.width,ie=J.height;y.RGBAImage.copy(J,L,{x:0,y:0},{x:q,y:Y},{width:ee,height:ie}),y.RGBAImage.copy(J,L,{x:0,y:ie-1},{x:q,y:Y-1},{width:ee,height:1}),y.RGBAImage.copy(J,L,{x:0,y:0},{x:q,y:Y+ie},{width:ee,height:1}),y.RGBAImage.copy(J,L,{x:ee-1,y:0},{x:q-1,y:Y},{width:1,height:ie}),y.RGBAImage.copy(J,L,{x:0,y:0},{x:q+ee,y:Y},{width:1,height:ie})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(g){for(const M of g){if(this.callbackDispatchedThisFrame[M])continue;this.callbackDispatchedThisFrame[M]=!0;const C=this.images[M];ge(C)&&this.updateImage(M,C)}}}const Se=new y.Properties({anchor:new y.DataConstantProperty(y.spec.light.anchor),position:new class{constructor(){this.specification=y.spec.light.position}possiblyEvaluate(I,g){return function([M,C,L]){const z=y.degToRad(C+90),U=y.degToRad(L);return{x:M*Math.cos(z)*Math.sin(U),y:M*Math.sin(z)*Math.sin(U),z:M*Math.cos(U),azimuthal:C,polar:L}}(I.expression.evaluate(g))}interpolate(I,g,M){return{x:y.number(I.x,g.x,M),y:y.number(I.y,g.y,M),z:y.number(I.z,g.z,M),azimuthal:y.number(I.azimuthal,g.azimuthal,M),polar:y.number(I.polar,g.polar,M)}}},color:new y.DataConstantProperty(y.spec.light.color),intensity:new y.DataConstantProperty(y.spec.light.intensity)}),le="-transition";class pe extends y.Evented{constructor(g){super(),this._transitionable=new y.Transitionable(Se),this.setLight(g),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(g,M={}){if(!this._validate(y.validateLight,g,M))for(const C in g){const L=g[C];y.endsWith(C,le)?this._transitionable.setTransition(C.slice(0,-le.length),L):this._transitionable.setValue(C,L)}}updateTransitions(g){this._transitioning=this._transitionable.transitioned(g,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(g){this.properties=this._transitioning.possiblyEvaluate(g)}_validate(g,M,C){return(!C||C.validate!==!1)&&y.emitValidationErrors(this,g.call(y.validateStyle,y.extend({value:M,style:{glyphs:!0,sprite:!0},styleSpec:y.spec})))}}const Le=new y.Properties({source:new y.DataConstantProperty(y.spec.terrain.source),exaggeration:new y.DataConstantProperty(y.spec.terrain.exaggeration)}),Ze="-transition";class lt extends y.Evented{constructor(g){super(),this._transitionable=new y.Transitionable(Le),this.set(g),this._transitioning=this._transitionable.untransitioned()}get(){return this._transitionable.serialize()}set(g){for(const M in g){const C=g[M];y.endsWith(M,Ze)?this._transitionable.setTransition(M.slice(0,-Ze.length),C):this._transitionable.setValue(M,C)}}updateTransitions(g){this._transitioning=this._transitionable.transitioned(g,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(g){this.properties=this._transitioning.possiblyEvaluate(g)}}function ct(I,g,M,C){const L=y.smoothstep(45,65,M),[z,U]=$t(I,C),q=y.length(g);let Y=1-Math.min(1,Math.exp((q-z)/(U-z)*-6));return Y*=Y*Y,Y=Math.min(1,1.00747*Y),Y*L*I.alpha}function $t(I,g){const M=.5/Math.tan(.5*g);return[I.range[0]+M,I.range[1]+M]}const Nt=new y.Properties({range:new y.DataConstantProperty(y.spec.fog.range),color:new y.DataConstantProperty(y.spec.fog.color),"horizon-blend":new y.DataConstantProperty(y.spec.fog["horizon-blend"])}),St="-transition";class Gt extends y.Evented{constructor(g,M){super(),this._transitionable=new y.Transitionable(Nt),this.set(g),this._transitioning=this._transitionable.untransitioned(),this._transform=M}isSoftDisabled(){return this._transform.projection.name!=="mercator"}get state(){return{range:this.properties.get("range"),horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(g,M={}){if(!this._validate(y.validateFog,g,M))for(const C in g){const L=g[C];y.endsWith(C,St)?this._transitionable.setTransition(C.slice(0,-St.length),L):this._transitionable.setValue(C,L)}}getOpacity(g){if(this.isSoftDisabled())return 0;const M=this.properties&&this.properties.get("color")||1;return y.smoothstep(45,65,g)*M.a}getOpacityAtLatLng(g,M){return this.isSoftDisabled()?0:function(C,L,z){const U=y.MercatorCoordinate.fromLngLat(L),q=z.elevation?z.elevation.getAtPointOrZero(U):0,Y=[U.x,U.y,q];return y.transformMat4$1(Y,Y,z.mercatorFogMatrix),ct(C,Y,z.pitch,z._fov)}(this.state,g,M)}getFovAdjustedRange(g){return this.isSoftDisabled()?[0,1]:$t(this.state,g)}updateTransitions(g){this._transitioning=this._transitionable.transitioned(g,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(g){this.properties=this._transitioning.possiblyEvaluate(g)}_validate(g,M,C){return(!C||C.validate!==!1)&&y.emitValidationErrors(this,g.call(y.validateStyle,y.extend({value:M,style:{glyphs:!0,sprite:!0},styleSpec:y.spec})))}}class Dt{constructor(g,M){this.workerPool=g,this.actors=[],this.currentActor=0,this.id=y.uniqueId();const C=this.workerPool.acquire(this.id);for(let L=0;L<C.length;L++){const z=new Dt.Actor(C[L],M,this.id);z.name=`Worker ${L}`,this.actors.push(z)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(g,M,C){y.asyncAll(this.actors,(L,z)=>{L.send(g,M,z)},C=C||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(g=>{g.remove()}),this.actors=[],this.workerPool.release(this.id)}}function Ut(I,g,M){return g*(y.EXTENT/(I.tileSize*Math.pow(2,M-I.tileID.overscaledZ)))}Dt.Actor=y.Actor;class Xt{constructor(g,M,C,L){this.screenBounds=g,this.cameraPoint=M,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=C,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this.screenGeometry.map(z=>L.pointCoordinate3D(z)),this.cameraGeometry=this.bufferedCameraGeometry(0)}static createFromScreenPoints(g,M){let C,L;if(g instanceof y.pointGeometry||typeof g[0]=="number"){const z=y.pointGeometry.convert(g);C=[y.pointGeometry.convert(g)],L=M.isPointAboveHorizon(z)}else{const z=y.pointGeometry.convert(g[0]),U=y.pointGeometry.convert(g[1]);C=[z,U],L=y.polygonizeBounds(z,U).every(q=>M.isPointAboveHorizon(q))}return new Xt(C,M.getCameraPoint(),L,M)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(g){return y.polygonizeBounds(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],g)}bufferedCameraGeometry(g){const M=this.screenBounds[0],C=this.screenBounds.length===1?this.screenBounds[0].add(new y.pointGeometry(1,1)):this.screenBounds[1],L=y.polygonizeBounds(M,C,0,!1);return this.cameraPoint.y>C.y&&(this.cameraPoint.x>M.x&&this.cameraPoint.x<C.x?L.splice(3,0,this.cameraPoint):this.cameraPoint.x>=C.x?L[2]=this.cameraPoint:this.cameraPoint.x<=M.x&&(L[3]=this.cameraPoint)),y.bufferConvexPolygon(L,g)}containsTile(g,M,C){const L=g.queryPadding+1,z=g.tileID.wrap,U=C?this._bufferedCameraMercator(L,M).map(Te=>y.getTilePoint(g.tileTransform,Te,z)):this._bufferedScreenMercator(L,M).map(Te=>y.getTilePoint(g.tileTransform,Te,z)),q=this.screenGeometryMercator.map(Te=>y.getTileVec3(g.tileTransform,Te,z)),Y=q.map(Te=>new y.pointGeometry(Te[0],Te[1])),J=M.getFreeCameraOptions().position||new y.MercatorCoordinate(0,0,0),ee=y.getTileVec3(g.tileTransform,J,z),ie=q.map(Te=>{const xe=y.sub(Te,Te,ee);return y.normalize(xe,xe),new he(ee,xe)}),fe=Ut(g,1,M.zoom);if(y.polygonIntersectsBox(U,0,0,y.EXTENT,y.EXTENT))return{queryGeometry:this,tilespaceGeometry:Y,tilespaceRays:ie,bufferedTilespaceGeometry:U,bufferedTilespaceBounds:(be=y.getBounds(U),be.min.x=y.clamp(be.min.x,0,y.EXTENT),be.min.y=y.clamp(be.min.y,0,y.EXTENT),be.max.x=y.clamp(be.max.x,0,y.EXTENT),be.max.y=y.clamp(be.max.y,0,y.EXTENT),be),tile:g,tileID:g.tileID,pixelToTileUnitsFactor:fe};var be}_bufferedScreenMercator(g,M){const C=ft(g);if(this._screenRaycastCache[C])return this._screenRaycastCache[C];{const L=this.bufferedScreenGeometry(g).map(z=>M.pointCoordinate3D(z));return this._screenRaycastCache[C]=L,L}}_bufferedCameraMercator(g,M){const C=ft(g);if(this._cameraRaycastCache[C])return this._cameraRaycastCache[C];{const L=this.bufferedCameraGeometry(g).map(z=>M.pointCoordinate3D(z));return this._cameraRaycastCache[C]=L,L}}}function ft(I){return 100*I|0}function wt(I,g,M){const C=function(L,z){if(L)return M(L);if(z){const U=y.pick(y.extend(z,I),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);z.vector_layers&&(U.vectorLayers=z.vector_layers,U.vectorLayerIds=U.vectorLayers.map(q=>q.id)),U.tiles=g.canonicalizeTileset(U,I.url),M(null,U)}};return I.url?y.getJSON(g.transformRequest(g.normalizeSourceURL(I.url),y.ResourceType.Source),C):y.exported.frame(()=>C(null,I))}class bt{constructor(g,M,C){this.bounds=y.LngLatBounds.convert(this.validateBounds(g)),this.minzoom=M||0,this.maxzoom=C||24}validateBounds(g){return Array.isArray(g)&&g.length===4?[Math.max(-180,g[0]),Math.max(-90,g[1]),Math.min(180,g[2]),Math.min(90,g[3])]:[-180,-90,180,90]}contains(g){const M=Math.pow(2,g.z),C=Math.floor(y.mercatorXfromLng(this.bounds.getWest())*M),L=Math.floor(y.mercatorYfromLat(this.bounds.getNorth())*M),z=Math.ceil(y.mercatorXfromLng(this.bounds.getEast())*M),U=Math.ceil(y.mercatorYfromLat(this.bounds.getSouth())*M);return g.x>=C&&g.x<z&&g.y>=L&&g.y<U}}class zt{constructor(g,M,C){this.context=g;const L=g.gl;this.buffer=L.createBuffer(),this.dynamicDraw=Boolean(C),this.context.unbindVAO(),g.bindElementBuffer.set(this.buffer),L.bufferData(L.ELEMENT_ARRAY_BUFFER,M.arrayBuffer,this.dynamicDraw?L.DYNAMIC_DRAW:L.STATIC_DRAW),this.dynamicDraw||delete M.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(g){const M=this.context.gl;this.context.unbindVAO(),this.bind(),M.bufferSubData(M.ELEMENT_ARRAY_BUFFER,0,g.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const qt={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class ui{constructor(g,M,C,L){this.length=M.length,this.attributes=C,this.itemSize=M.bytesPerElement,this.dynamicDraw=L,this.context=g;const z=g.gl;this.buffer=z.createBuffer(),g.bindVertexBuffer.set(this.buffer),z.bufferData(z.ARRAY_BUFFER,M.arrayBuffer,this.dynamicDraw?z.DYNAMIC_DRAW:z.STATIC_DRAW),this.dynamicDraw||delete M.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(g){const M=this.context.gl;this.bind(),M.bufferSubData(M.ARRAY_BUFFER,0,g.arrayBuffer)}enableAttributes(g,M){for(let C=0;C<this.attributes.length;C++){const L=M.attributes[this.attributes[C].name];L!==void 0&&g.enableVertexAttribArray(L)}}setVertexAttribPointers(g,M,C){for(let L=0;L<this.attributes.length;L++){const z=this.attributes[L],U=M.attributes[z.name];U!==void 0&&g.vertexAttribPointer(U,z.components,g[qt[z.type]],!1,this.itemSize,z.offset+this.itemSize*(C||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Ct{constructor(g){this.gl=g.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(g){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class di extends Ct{getDefault(){return y.Color.transparent}set(g){const M=this.current;(g.r!==M.r||g.g!==M.g||g.b!==M.b||g.a!==M.a||this.dirty)&&(this.gl.clearColor(g.r,g.g,g.b,g.a),this.current=g,this.dirty=!1)}}class mi extends Ct{getDefault(){return 1}set(g){(g!==this.current||this.dirty)&&(this.gl.clearDepth(g),this.current=g,this.dirty=!1)}}class Ti extends Ct{getDefault(){return 0}set(g){(g!==this.current||this.dirty)&&(this.gl.clearStencil(g),this.current=g,this.dirty=!1)}}class hi extends Ct{getDefault(){return[!0,!0,!0,!0]}set(g){const M=this.current;(g[0]!==M[0]||g[1]!==M[1]||g[2]!==M[2]||g[3]!==M[3]||this.dirty)&&(this.gl.colorMask(g[0],g[1],g[2],g[3]),this.current=g,this.dirty=!1)}}class Pt extends Ct{getDefault(){return!0}set(g){(g!==this.current||this.dirty)&&(this.gl.depthMask(g),this.current=g,this.dirty=!1)}}class Tt extends Ct{getDefault(){return 255}set(g){(g!==this.current||this.dirty)&&(this.gl.stencilMask(g),this.current=g,this.dirty=!1)}}class Lt extends Ct{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(g){const M=this.current;(g.func!==M.func||g.ref!==M.ref||g.mask!==M.mask||this.dirty)&&(this.gl.stencilFunc(g.func,g.ref,g.mask),this.current=g,this.dirty=!1)}}class Jt extends Ct{getDefault(){const g=this.gl;return[g.KEEP,g.KEEP,g.KEEP]}set(g){const M=this.current;(g[0]!==M[0]||g[1]!==M[1]||g[2]!==M[2]||this.dirty)&&(this.gl.stencilOp(g[0],g[1],g[2]),this.current=g,this.dirty=!1)}}class He extends Ct{getDefault(){return!1}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;g?M.enable(M.STENCIL_TEST):M.disable(M.STENCIL_TEST),this.current=g,this.dirty=!1}}class jt extends Ct{getDefault(){return[0,1]}set(g){const M=this.current;(g[0]!==M[0]||g[1]!==M[1]||this.dirty)&&(this.gl.depthRange(g[0],g[1]),this.current=g,this.dirty=!1)}}class Kt extends Ct{getDefault(){return!1}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;g?M.enable(M.DEPTH_TEST):M.disable(M.DEPTH_TEST),this.current=g,this.dirty=!1}}class Yt extends Ct{getDefault(){return this.gl.LESS}set(g){(g!==this.current||this.dirty)&&(this.gl.depthFunc(g),this.current=g,this.dirty=!1)}}class ii extends Ct{getDefault(){return!1}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;g?M.enable(M.BLEND):M.disable(M.BLEND),this.current=g,this.dirty=!1}}class xt extends Ct{getDefault(){const g=this.gl;return[g.ONE,g.ZERO]}set(g){const M=this.current;(g[0]!==M[0]||g[1]!==M[1]||this.dirty)&&(this.gl.blendFunc(g[0],g[1]),this.current=g,this.dirty=!1)}}class Mi extends Ct{getDefault(){return y.Color.transparent}set(g){const M=this.current;(g.r!==M.r||g.g!==M.g||g.b!==M.b||g.a!==M.a||this.dirty)&&(this.gl.blendColor(g.r,g.g,g.b,g.a),this.current=g,this.dirty=!1)}}class ei extends Ct{getDefault(){return this.gl.FUNC_ADD}set(g){(g!==this.current||this.dirty)&&(this.gl.blendEquation(g),this.current=g,this.dirty=!1)}}class Vt extends Ct{getDefault(){return!1}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;g?M.enable(M.CULL_FACE):M.disable(M.CULL_FACE),this.current=g,this.dirty=!1}}class Zt extends Ct{getDefault(){return this.gl.BACK}set(g){(g!==this.current||this.dirty)&&(this.gl.cullFace(g),this.current=g,this.dirty=!1)}}class Et extends Ct{getDefault(){return this.gl.CCW}set(g){(g!==this.current||this.dirty)&&(this.gl.frontFace(g),this.current=g,this.dirty=!1)}}class ti extends Ct{getDefault(){return null}set(g){(g!==this.current||this.dirty)&&(this.gl.useProgram(g),this.current=g,this.dirty=!1)}}class _i extends Ct{getDefault(){return this.gl.TEXTURE0}set(g){(g!==this.current||this.dirty)&&(this.gl.activeTexture(g),this.current=g,this.dirty=!1)}}class vi extends Ct{getDefault(){const g=this.gl;return[0,0,g.drawingBufferWidth,g.drawingBufferHeight]}set(g){const M=this.current;(g[0]!==M[0]||g[1]!==M[1]||g[2]!==M[2]||g[3]!==M[3]||this.dirty)&&(this.gl.viewport(g[0],g[1],g[2],g[3]),this.current=g,this.dirty=!1)}}class Ht extends Ct{getDefault(){return null}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;M.bindFramebuffer(M.FRAMEBUFFER,g),this.current=g,this.dirty=!1}}class ci extends Ct{getDefault(){return null}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;M.bindRenderbuffer(M.RENDERBUFFER,g),this.current=g,this.dirty=!1}}class Di extends Ct{getDefault(){return null}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;M.bindTexture(M.TEXTURE_2D,g),this.current=g,this.dirty=!1}}class $i extends Ct{getDefault(){return null}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;M.bindBuffer(M.ARRAY_BUFFER,g),this.current=g,this.dirty=!1}}class Oi extends Ct{getDefault(){return null}set(g){const M=this.gl;M.bindBuffer(M.ELEMENT_ARRAY_BUFFER,g),this.current=g,this.dirty=!1}}class pr extends Ct{constructor(g){super(g),this.vao=g.extVertexArrayObject}getDefault(){return null}set(g){this.vao&&(g!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(g),this.current=g,this.dirty=!1)}}class vr extends Ct{getDefault(){return 4}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;M.pixelStorei(M.UNPACK_ALIGNMENT,g),this.current=g,this.dirty=!1}}class Jr extends Ct{getDefault(){return!1}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;M.pixelStorei(M.UNPACK_PREMULTIPLY_ALPHA_WEBGL,g),this.current=g,this.dirty=!1}}class Ji extends Ct{getDefault(){return!1}set(g){if(g===this.current&&!this.dirty)return;const M=this.gl;M.pixelStorei(M.UNPACK_FLIP_Y_WEBGL,g),this.current=g,this.dirty=!1}}class _r extends Ct{constructor(g,M){super(g),this.context=g,this.parent=M}getDefault(){return null}}class zr extends _r{setDirty(){this.dirty=!0}set(g){if(g===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const M=this.gl;M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,g,0),this.current=g,this.dirty=!1}}class br extends _r{attachment(){return this.gl.DEPTH_ATTACHMENT}set(g){if(g===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const M=this.gl;M.framebufferRenderbuffer(M.FRAMEBUFFER,this.attachment(),M.RENDERBUFFER,g),this.current=g,this.dirty=!1}}class yr extends br{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class Fr{constructor(g,M,C,L){this.context=g,this.width=M,this.height=C;const z=this.framebuffer=g.gl.createFramebuffer();this.colorAttachment=new zr(g,z),L&&(this.depthAttachment=new br(g,z))}destroy(){const g=this.context.gl,M=this.colorAttachment.get();if(M&&g.deleteTexture(M),this.depthAttachment){const C=this.depthAttachment.get();C&&g.deleteRenderbuffer(C)}g.deleteFramebuffer(this.framebuffer)}}class Ur{constructor(g){this.gl=g,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new di(this),this.clearDepth=new mi(this),this.clearStencil=new Ti(this),this.colorMask=new hi(this),this.depthMask=new Pt(this),this.stencilMask=new Tt(this),this.stencilFunc=new Lt(this),this.stencilOp=new Jt(this),this.stencilTest=new He(this),this.depthRange=new jt(this),this.depthTest=new Kt(this),this.depthFunc=new Yt(this),this.blend=new ii(this),this.blendFunc=new xt(this),this.blendColor=new Mi(this),this.blendEquation=new ei(this),this.cullFace=new Vt(this),this.cullFaceSide=new Zt(this),this.frontFace=new Et(this),this.program=new ti(this),this.activeTexture=new _i(this),this.viewport=new vi(this),this.bindFramebuffer=new Ht(this),this.bindRenderbuffer=new ci(this),this.bindTexture=new Di(this),this.bindVertexBuffer=new $i(this),this.bindElementBuffer=new Oi(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new pr(this),this.pixelStoreUnpack=new vr(this),this.pixelStoreUnpackPremultiplyAlpha=new Jr(this),this.pixelStoreUnpackFlipY=new Ji(this),this.extTextureFilterAnisotropic=g.getExtension("EXT_texture_filter_anisotropic")||g.getExtension("MOZ_EXT_texture_filter_anisotropic")||g.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=g.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extTextureHalfFloat=g.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(g.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=g.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=g.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=g.getParameter(g.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(g,M){return new zt(this,g,M)}createVertexBuffer(g,M,C){return new ui(this,g,M,C)}createRenderbuffer(g,M,C){const L=this.gl,z=L.createRenderbuffer();return this.bindRenderbuffer.set(z),L.renderbufferStorage(L.RENDERBUFFER,g,M,C),this.bindRenderbuffer.set(null),z}createFramebuffer(g,M,C){return new Fr(this,g,M,C)}clear({color:g,depth:M,stencil:C}){const L=this.gl;let z=0;g&&(z|=L.COLOR_BUFFER_BIT,this.clearColor.set(g),this.colorMask.set([!0,!0,!0,!0])),M!==void 0&&(z|=L.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(M),this.depthMask.set(!0)),C!==void 0&&(z|=L.STENCIL_BUFFER_BIT,this.clearStencil.set(C),this.stencilMask.set(255)),L.clear(z)}setCullFace(g){g.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(g.mode),this.frontFace.set(g.frontFace))}setDepthMode(g){g.func!==this.gl.ALWAYS||g.mask?(this.depthTest.set(!0),this.depthFunc.set(g.func),this.depthMask.set(g.mask),this.depthRange.set(g.range)):this.depthTest.set(!1)}setStencilMode(g){g.test.func!==this.gl.ALWAYS||g.mask?(this.stencilTest.set(!0),this.stencilMask.set(g.mask),this.stencilOp.set([g.fail,g.depthFail,g.pass]),this.stencilFunc.set({func:g.test.func,ref:g.ref,mask:g.test.mask})):this.stencilTest.set(!1)}setColorMode(g){N(g.blendFunction,y.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(g.blendFunction),this.blendColor.set(g.blendColor)),this.colorMask.set(g.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class we extends y.Evented{constructor(g,M,C,L){super(),this.id=g,this.dispatcher=C,this.setEventedParent(L),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=y.extend({type:"raster"},M),y.extend(this,y.pick(M,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new y.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=wt(this._options,this.map._requestManager,(g,M)=>{this._tileJSONRequest=null,this._loaded=!0,g?this.fire(new y.ErrorEvent(g)):M&&(y.extend(this,M),M.bounds&&(this.tileBounds=new bt(M.bounds,this.minzoom,this.maxzoom)),y.postTurnstileEvent(M.tiles),this.fire(new y.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new y.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(g){this.map=g,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return y.extend({},this._options)}hasTile(g){return!this.tileBounds||this.tileBounds.contains(g.canonical)}loadTile(g,M){const C=y.exported.devicePixelRatio>=2,L=this.map._requestManager.normalizeTileURL(g.tileID.canonical.url(this.tiles,this.scheme),C,this.tileSize);g.request=y.getImage(this.map._requestManager.transformRequest(L,y.ResourceType.Tile),(z,U,q,Y)=>{if(delete g.request,g.aborted)g.state="unloaded",M(null);else if(z)g.state="errored",M(z);else if(U){this.map._refreshExpiredTiles&&g.setExpiryData({cacheControl:q,expires:Y});const J=this.map.painter.context,ee=J.gl;g.texture=this.map.painter.getTileTexture(U.width),g.texture?g.texture.update(U,{useMipmap:!0}):(g.texture=new y.Texture(J,U,ee.RGBA,{useMipmap:!0}),g.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE),J.extTextureFilterAnisotropic&&ee.texParameterf(ee.TEXTURE_2D,J.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,J.extTextureFilterAnisotropicMax)),g.state="loaded",y.cacheEntryPossiblyAdded(this.dispatcher),M(null)}})}abortTile(g,M){g.request&&(g.request.cancel(),delete g.request),M()}unloadTile(g,M){g.texture&&this.map.painter.saveTileTexture(g.texture),M()}hasTransition(){return!1}}let Xe;class ae extends y.Evented{constructor(g,M,C,L){super(),this.id=g,this.dispatcher=C,this.coordinates=M.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(L),this.options=M}load(g,M){this._loaded=!1,this.fire(new y.Event("dataloading",{dataType:"source"})),this.url=this.options.url,y.getImage(this.map._requestManager.transformRequest(this.url,y.ResourceType.Image),(C,L)=>{this._loaded=!0,C?this.fire(new y.ErrorEvent(C)):L&&(this.image=y.exported.getImageData(L),g&&(this.coordinates=g),M&&M(),this._finishLoading())})}loaded(){return this._loaded}updateImage(g){return this.image&&g.url?(this.options.url=g.url,this.load(g.coordinates,()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new y.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(g){this.map=g,this.load()}setCoordinates(g){this.coordinates=g,delete this._boundsArray;const M=g.map(y.MercatorCoordinate.fromLngLat);return this.tileID=function(C){let L=1/0,z=1/0,U=-1/0,q=-1/0;for(const ie of C)L=Math.min(L,ie.x),z=Math.min(z,ie.y),U=Math.max(U,ie.x),q=Math.max(q,ie.y);const Y=Math.max(U-L,q-z),J=Math.max(0,Math.floor(-Math.log(Y)/Math.LN2)),ee=Math.pow(2,J);return new y.CanonicalTileID(J,Math.floor((L+U)/2*ee),Math.floor((z+q)/2*ee))}(M),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new y.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){delete this._boundsArray}_makeBoundsArray(){const g=y.tileTransform(this.tileID,this.map.transform.projection),M=this.coordinates.map(C=>{const L=g.projection.project(C[0],C[1]);return y.getTilePoint(g,L)._round()});return this._boundsArray=new y.StructArrayLayout4i8,this._boundsArray.emplaceBack(M[0].x,M[0].y,0,0),this._boundsArray.emplaceBack(M[1].x,M[1].y,y.EXTENT,0),this._boundsArray.emplaceBack(M[3].x,M[3].y,0,y.EXTENT),this._boundsArray.emplaceBack(M[2].x,M[2].y,y.EXTENT,y.EXTENT),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const g=this.map.painter.context,M=g.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=g.createVertexBuffer(this._boundsArray,y.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=y.SegmentVector.simpleSegment(0,0,4,2)),this.texture||(this.texture=new y.Texture(g,this.image,M.RGBA),this.texture.bind(M.LINEAR,M.CLAMP_TO_EDGE));for(const C in this.tiles){const L=this.tiles[C];L.state!=="loaded"&&(L.state="loaded",L.texture=this.texture)}}loadTile(g,M){this.tileID&&this.tileID.equals(g.tileID.canonical)?(this.tiles[String(g.tileID.wrap)]=g,g.buckets={},M(null)):(g.state="errored",M(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const K={vector:class extends y.Evented{constructor(I,g,M,C){if(super(),this.id=I,this.dispatcher=M,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,y.extend(this,y.pick(g,["url","scheme","tileSize","promoteId"])),this._options=y.extend({type:"vector"},g),this._collectResourceTiming=g.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(C),this._tileWorkers={},this._deduped=new y.DedupedRequest}load(){this._loaded=!1,this.fire(new y.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=wt(this._options,this.map._requestManager,(I,g)=>{this._tileJSONRequest=null,this._loaded=!0,I?this.fire(new y.ErrorEvent(I)):g&&(y.extend(this,g),g.bounds&&(this.tileBounds=new bt(g.bounds,this.minzoom,this.maxzoom)),y.postTurnstileEvent(g.tiles,this.map._requestManager._customAccessToken),this.fire(new y.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new y.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}hasTile(I){return!this.tileBounds||this.tileBounds.contains(I.canonical)}onAdd(I){this.map=I,this.load()}setSourceProperty(I){this._tileJSONRequest&&this._tileJSONRequest.cancel(),I();const g=this.map.style._getSourceCaches(this.id);for(const M of g)M.clearTiles();this.load()}setTiles(I){return this.setSourceProperty(()=>{this._options.tiles=I}),this}setUrl(I){return this.setSourceProperty(()=>{this.url=I,this._options.url=I}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return y.extend({},this._options)}loadTile(I,g){const M=this.map._requestManager.normalizeTileURL(I.tileID.canonical.url(this.tiles,this.scheme)),C={request:this.map._requestManager.transformRequest(M,y.ResourceType.Tile),data:void 0,uid:I.uid,tileID:I.tileID,tileZoom:I.tileZoom,zoom:I.tileID.overscaledZ,tileSize:this.tileSize*I.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:y.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:I.isSymbolTile};if(C.request.collectResourceTiming=this._collectResourceTiming,I.actor&&I.state!=="expired")I.state==="loading"?I.reloadCallback=g:I.request=I.actor.send("reloadTile",C,L.bind(this));else if(I.actor=this._tileWorkers[M]=this._tileWorkers[M]||this.dispatcher.getActor(),this.dispatcher.ready)I.request=I.actor.send("loadTile",C,L.bind(this),void 0,!0);else{const z=y.loadVectorTile.call({deduped:this._deduped},C,(U,q)=>{U||!q?L.call(this,U):(C.data={cacheControl:q.cacheControl,expires:q.expires,rawData:q.rawData.slice(0)},I.actor&&I.actor.send("loadTile",C,L.bind(this),void 0,!0))},!0);I.request={cancel:z}}function L(z,U){return delete I.request,I.aborted?g(null):z&&z.status!==404?g(z):(U&&U.resourceTiming&&(I.resourceTiming=U.resourceTiming),this.map._refreshExpiredTiles&&U&&I.setExpiryData(U),I.loadVectorData(U,this.map.painter),y.cacheEntryPossiblyAdded(this.dispatcher),g(null),void(I.reloadCallback&&(this.loadTile(I,I.reloadCallback),I.reloadCallback=null)))}}abortTile(I){I.request&&(I.request.cancel(),delete I.request),I.actor&&I.actor.send("abortTile",{uid:I.uid,type:this.type,source:this.id})}unloadTile(I){I.unloadVectorData(),I.actor&&I.actor.send("removeTile",{uid:I.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}},raster:we,"raster-dem":class extends we{constructor(I,g,M,C){super(I,g,M,C),this.type="raster-dem",this.maxzoom=22,this._options=y.extend({type:"raster-dem"},g),this.encoding=g.encoding||"mapbox"}loadTile(I,g){const M=this.map._requestManager.normalizeTileURL(I.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function C(L,z){L&&(I.state="errored",g(L)),z&&(I.dem=z,I.dem.onDeserialize(),I.needsHillshadePrepare=!0,I.needsDEMTextureUpload=!0,I.state="loaded",g(null))}I.request=y.getImage(this.map._requestManager.transformRequest(M,y.ResourceType.Tile),function(L,z,U,q){if(delete I.request,I.aborted)I.state="unloaded",g(null);else if(L)I.state="errored",g(L);else if(z){this.map._refreshExpiredTiles&&I.setExpiryData({cacheControl:U,expires:q});const Y=y.window.ImageBitmap&&z instanceof y.window.ImageBitmap&&(Xe==null&&(Xe=y.window.OffscreenCanvas&&new y.window.OffscreenCanvas(1,1).getContext("2d")&&typeof y.window.createImageBitmap=="function"),Xe),J=1-(z.width-y.prevPowerOfTwo(z.width))/2;J<1||I.neighboringTiles||(I.neighboringTiles=this._getNeighboringTiles(I.tileID));const ee=Y?z:y.exported.getImageData(z,J),ie={uid:I.uid,coord:I.tileID,source:this.id,rawImageData:ee,encoding:this.encoding,padding:J};I.actor&&I.state!=="expired"||(I.actor=this.dispatcher.getActor(),I.actor.send("loadDEMTile",ie,C.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(I){const g=I.canonical,M=Math.pow(2,g.z),C=(g.x-1+M)%M,L=g.x===0?I.wrap-1:I.wrap,z=(g.x+1+M)%M,U=g.x+1===M?I.wrap+1:I.wrap,q={};return q[new y.OverscaledTileID(I.overscaledZ,L,g.z,C,g.y).key]={backfilled:!1},q[new y.OverscaledTileID(I.overscaledZ,U,g.z,z,g.y).key]={backfilled:!1},g.y>0&&(q[new y.OverscaledTileID(I.overscaledZ,L,g.z,C,g.y-1).key]={backfilled:!1},q[new y.OverscaledTileID(I.overscaledZ,I.wrap,g.z,g.x,g.y-1).key]={backfilled:!1},q[new y.OverscaledTileID(I.overscaledZ,U,g.z,z,g.y-1).key]={backfilled:!1}),g.y+1<M&&(q[new y.OverscaledTileID(I.overscaledZ,L,g.z,C,g.y+1).key]={backfilled:!1},q[new y.OverscaledTileID(I.overscaledZ,I.wrap,g.z,g.x,g.y+1).key]={backfilled:!1},q[new y.OverscaledTileID(I.overscaledZ,U,g.z,z,g.y+1).key]={backfilled:!1}),q}unloadTile(I){I.demTexture&&this.map.painter.saveTileTexture(I.demTexture),I.fbo&&(I.fbo.destroy(),delete I.fbo),I.dem&&delete I.dem,delete I.neighboringTiles,I.state="unloaded"}},geojson:class extends y.Evented{constructor(I,g,M,C){super(),this.id=I,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=M.getActor(),this.setEventedParent(C),this._data=g.data,this._options=y.extend({},g),this._collectResourceTiming=g.collectResourceTiming,g.maxzoom!==void 0&&(this.maxzoom=g.maxzoom),g.type&&(this.type=g.type),g.attribution&&(this.attribution=g.attribution),this.promoteId=g.promoteId;const L=y.EXTENT/this.tileSize;this.workerOptions=y.extend({source:this.id,cluster:g.cluster||!1,geojsonVtOptions:{buffer:(g.buffer!==void 0?g.buffer:128)*L,tolerance:(g.tolerance!==void 0?g.tolerance:.375)*L,extent:y.EXTENT,maxZoom:this.maxzoom,lineMetrics:g.lineMetrics||!1,generateId:g.generateId||!1},superclusterOptions:{maxZoom:g.clusterMaxZoom!==void 0?g.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,g.clusterMinPoints||2),extent:y.EXTENT,radius:(g.clusterRadius!==void 0?g.clusterRadius:50)*L,log:!1,generateId:g.generateId||!1},clusterProperties:g.clusterProperties,filter:g.filter},g.workerOptions)}onAdd(I){this.map=I,this.setData(this._data)}setData(I){return this._data=I,this._updateWorkerData(),this}getClusterExpansionZoom(I,g){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:I,source:this.id},g),this}getClusterChildren(I,g){return this.actor.send("geojson.getClusterChildren",{clusterId:I,source:this.id},g),this}getClusterLeaves(I,g,M,C){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:I,limit:g,offset:M},C),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new y.Event("dataloading",{dataType:"source"})),this._loaded=!1;const I=y.extend({},this.workerOptions),g=this._data;typeof g=="string"?(I.request=this.map._requestManager.transformRequest(y.exported.resolveURL(g),y.ResourceType.Source),I.request.collectResourceTiming=this._collectResourceTiming):I.data=JSON.stringify(g),this._pendingLoad=this.actor.send(`${this.type}.loadData`,I,(M,C)=>{if(this._loaded=!0,this._pendingLoad=null,M)this.fire(new y.ErrorEvent(M));else{const L={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&C&&C.resourceTiming&&C.resourceTiming[this.id]&&(L.resourceTiming=C.resourceTiming[this.id]),this.fire(new y.Event("data",L)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(I,g){const M=I.actor?"reloadTile":"loadTile";I.actor=this.actor,I.request=this.actor.send(M,{type:this.type,uid:I.uid,tileID:I.tileID,tileZoom:I.tileZoom,zoom:I.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:y.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(C,L)=>(delete I.request,I.unloadVectorData(),I.aborted?g(null):C?g(C):(I.loadVectorData(L,this.map.painter,M==="reloadTile"),g(null))),void 0,M==="loadTile")}abortTile(I){I.request&&(I.request.cancel(),delete I.request),I.aborted=!0}unloadTile(I){I.unloadVectorData(),this.actor.send("removeTile",{uid:I.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return y.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends ae{constructor(I,g,M,C){super(I,g,M,C),this.roundZoom=!0,this.type="video",this.options=g}load(){this._loaded=!1;const I=this.options;this.urls=[];for(const g of I.urls)this.urls.push(this.map._requestManager.transformRequest(g,y.ResourceType.Source).url);y.getVideo(this.urls,(g,M)=>{this._loaded=!0,g?this.fire(new y.ErrorEvent(g)):M&&(this.video=M,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(I){if(this.video){const g=this.video.seekable;I<g.start(0)||I>g.end(0)?this.fire(new y.ErrorEvent(new y.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${g.start(0)} and ${g.end(0)}-second mark.`))):this.video.currentTime=I}}getVideo(){return this.video}onAdd(I){this.map||(this.map=I,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const I=this.map.painter.context,g=I.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=I.createVertexBuffer(this._boundsArray,y.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=y.SegmentVector.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE),g.texSubImage2D(g.TEXTURE_2D,0,0,0,g.RGBA,g.UNSIGNED_BYTE,this.video)):(this.texture=new y.Texture(I,this.video,g.RGBA),this.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE));for(const M in this.tiles){const C=this.tiles[M];C.state!=="loaded"&&(C.state="loaded",C.texture=this.texture)}}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:ae,canvas:class extends ae{constructor(I,g,M,C){super(I,g,M,C),g.coordinates?Array.isArray(g.coordinates)&&g.coordinates.length===4&&!g.coordinates.some(L=>!Array.isArray(L)||L.length!==2||L.some(z=>typeof z!="number"))||this.fire(new y.ErrorEvent(new y.ValidationError(`sources.${I}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new y.ErrorEvent(new y.ValidationError(`sources.${I}`,null,'missing required property "coordinates"'))),g.animate&&typeof g.animate!="boolean"&&this.fire(new y.ErrorEvent(new y.ValidationError(`sources.${I}`,null,'optional "animate" property must be a boolean value'))),g.canvas?typeof g.canvas=="string"||g.canvas instanceof y.window.HTMLCanvasElement||this.fire(new y.ErrorEvent(new y.ValidationError(`sources.${I}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new y.ErrorEvent(new y.ValidationError(`sources.${I}`,null,'missing required property "canvas"'))),this.options=g,this.animate=g.animate===void 0||g.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof y.window.HTMLCanvasElement?this.options.canvas:y.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new y.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(I){this.map=I,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let I=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,I=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,I=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const g=this.map.painter.context,M=g.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=g.createVertexBuffer(this._boundsArray,y.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=y.SegmentVector.simpleSegment(0,0,4,2)),this.texture?(I||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new y.Texture(g,this.canvas,M.RGBA,{premultiply:!0});for(const C in this.tiles){const L=this.tiles[C];L.state!=="loaded"&&(L.state="loaded",L.texture=this.texture)}}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const I of[this.canvas.width,this.canvas.height])if(isNaN(I)||I<=0)return!0;return!1}}},re=function(I,g,M,C){const L=new K[g.type](I,g,M,C);if(L.id!==I)throw new Error(`Expected Source id to be ${I} instead of ${L.id}`);return y.bindAll(["load","abort","unload","serialize","prepare"],L),L};function de(I,g){const M=y.identity([]);return y.scale$1(M,M,[.5*I.width,.5*-I.height,1]),y.translate(M,M,[1,-1,0]),y.multiply(M,M,I.calculateProjMatrix(g.toUnwrapped()))}function Ae(I,g,M,C,L,z,U,q=!1){const Y=I.tilesIn(C,U,q);Y.sort(Ne);const J=[];for(const ie of Y)J.push({wrappedTileID:ie.tile.tileID.wrapped().key,queryResults:ie.tile.queryRenderedFeatures(g,M,I._state,ie,L,z,de(I.transform,ie.tile.tileID),q)});const ee=function(ie){const fe={},be={};for(const Te of ie){const xe=Te.queryResults,Ie=Te.wrappedTileID,ve=be[Ie]=be[Ie]||{};for(const ke in xe){const De=xe[ke],Ee=ve[ke]=ve[ke]||{},Pe=fe[ke]=fe[ke]||[];for(const Oe of De)Ee[Oe.featureIndex]||(Ee[Oe.featureIndex]=!0,Pe.push(Oe))}}return fe}(J);for(const ie in ee)ee[ie].forEach(fe=>{const be=fe.feature,Te=I.getFeatureState(be.layer["source-layer"],be.id);be.source=be.layer.source,be.layer["source-layer"]&&(be.sourceLayer=be.layer["source-layer"]),be.state=Te});return ee}function Be(I,g){const M=I.getRenderableIds().map(z=>I.getTileByID(z)),C=[],L={};for(let z=0;z<M.length;z++){const U=M[z],q=U.tileID.canonical.key;L[q]||(L[q]=!0,U.querySourceFeatures(C,g))}return C}function Ne(I,g){const M=I.tileID,C=g.tileID;return M.overscaledZ-C.overscaledZ||M.canonical.y-C.canonical.y||M.wrap-C.wrap||M.canonical.x-C.canonical.x}function Ue(){return _o.workerClass!=null?new _o.workerClass:new y.window.Worker(_o.workerUrl)}const Fe="mapboxgl_preloaded_worker_pool";class je{constructor(){this.active={}}acquire(g){if(!this.workers)for(this.workers=[];this.workers.length<je.workerCount;)this.workers.push(new Ue);return this.active[g]=!0,this.workers.slice()}release(g){delete this.active[g],this.numActive()===0&&(this.workers.forEach(M=>{M.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Fe]}numActive(){return Object.keys(this.active).length}}let tt;function pt(){return tt||(tt=new je),tt}function st(I,g){const M={};for(const C in I)C!=="ref"&&(M[C]=I[C]);return y.refProperties.forEach(C=>{C in g&&(M[C]=g[C])}),M}function Rt(I){I=I.slice();const g=Object.create(null);for(let M=0;M<I.length;M++)g[I[M].id]=I[M];for(let M=0;M<I.length;M++)"ref"in I[M]&&(I[M]=st(I[M],g[I[M].ref]));return I}je.workerCount=2;const gt={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function Ve(I,g,M){M.push({command:gt.addSource,args:[I,g[I]]})}function Qe(I,g,M){g.push({command:gt.removeSource,args:[I]}),M[I]=!0}function gi(I,g,M,C){Qe(I,M,C),Ve(I,g,M)}function Ai(I,g,M){let C;for(C in I[M])if(I[M].hasOwnProperty(C)&&C!=="data"&&!N(I[M][C],g[M][C]))return!1;for(C in g[M])if(g[M].hasOwnProperty(C)&&C!=="data"&&!N(I[M][C],g[M][C]))return!1;return!0}function ri(I,g,M,C,L,z){let U;for(U in g=g||{},I=I||{})I.hasOwnProperty(U)&&(N(I[U],g[U])||M.push({command:z,args:[C,U,g[U],L]}));for(U in g)g.hasOwnProperty(U)&&!I.hasOwnProperty(U)&&(N(I[U],g[U])||M.push({command:z,args:[C,U,g[U],L]}))}function wi(I){return I.id}function Ei(I,g){return I[g.id]=g,I}class On{constructor(g,M){this.reset(g,M)}reset(g,M){this.points=g||[],this._distances=[0];for(let C=1;C<this.points.length;C++)this._distances[C]=this._distances[C-1]+this.points[C].dist(this.points[C-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(M||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(g){if(this.points.length===1)return this.points[0];g=y.clamp(g,0,1);let M=1,C=this._distances[M];const L=g*this.paddedLength+this.padding;for(;C<L&&M<this._distances.length;)C=this._distances[++M];const z=M-1,U=this._distances[z],q=C-U,Y=q>0?(L-U)/q:0;return this.points[z].mult(1-Y).add(this.points[M].mult(Y))}}class hn{constructor(g,M,C){const L=this.boxCells=[],z=this.circleCells=[];this.xCellCount=Math.ceil(g/C),this.yCellCount=Math.ceil(M/C);for(let U=0;U<this.xCellCount*this.yCellCount;U++)L.push([]),z.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=g,this.height=M,this.xScale=this.xCellCount/g,this.yScale=this.yCellCount/M,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(g,M,C,L,z){this._forEachCell(M,C,L,z,this._insertBoxCell,this.boxUid++),this.boxKeys.push(g),this.bboxes.push(M),this.bboxes.push(C),this.bboxes.push(L),this.bboxes.push(z)}insertCircle(g,M,C,L){this._forEachCell(M-L,C-L,M+L,C+L,this._insertCircleCell,this.circleUid++),this.circleKeys.push(g),this.circles.push(M),this.circles.push(C),this.circles.push(L)}_insertBoxCell(g,M,C,L,z,U){this.boxCells[z].push(U)}_insertCircleCell(g,M,C,L,z,U){this.circleCells[z].push(U)}_query(g,M,C,L,z,U){if(C<0||g>this.width||L<0||M>this.height)return!z&&[];const q=[];if(g<=0&&M<=0&&this.width<=C&&this.height<=L){if(z)return!0;for(let Y=0;Y<this.boxKeys.length;Y++)q.push({key:this.boxKeys[Y],x1:this.bboxes[4*Y],y1:this.bboxes[4*Y+1],x2:this.bboxes[4*Y+2],y2:this.bboxes[4*Y+3]});for(let Y=0;Y<this.circleKeys.length;Y++){const J=this.circles[3*Y],ee=this.circles[3*Y+1],ie=this.circles[3*Y+2];q.push({key:this.circleKeys[Y],x1:J-ie,y1:ee-ie,x2:J+ie,y2:ee+ie})}return U?q.filter(U):q}return this._forEachCell(g,M,C,L,this._queryCell,q,{hitTest:z,seenUids:{box:{},circle:{}}},U),z?q.length>0:q}_queryCircle(g,M,C,L,z){const U=g-C,q=g+C,Y=M-C,J=M+C;if(q<0||U>this.width||J<0||Y>this.height)return!L&&[];const ee=[];return this._forEachCell(U,Y,q,J,this._queryCellCircle,ee,{hitTest:L,circle:{x:g,y:M,radius:C},seenUids:{box:{},circle:{}}},z),L?ee.length>0:ee}query(g,M,C,L,z){return this._query(g,M,C,L,!1,z)}hitTest(g,M,C,L,z){return this._query(g,M,C,L,!0,z)}hitTestCircle(g,M,C,L){return this._queryCircle(g,M,C,!0,L)}_queryCell(g,M,C,L,z,U,q,Y){const J=q.seenUids,ee=this.boxCells[z];if(ee!==null){const fe=this.bboxes;for(const be of ee)if(!J.box[be]){J.box[be]=!0;const Te=4*be;if(g<=fe[Te+2]&&M<=fe[Te+3]&&C>=fe[Te+0]&&L>=fe[Te+1]&&(!Y||Y(this.boxKeys[be]))){if(q.hitTest)return U.push(!0),!0;U.push({key:this.boxKeys[be],x1:fe[Te],y1:fe[Te+1],x2:fe[Te+2],y2:fe[Te+3]})}}}const ie=this.circleCells[z];if(ie!==null){const fe=this.circles;for(const be of ie)if(!J.circle[be]){J.circle[be]=!0;const Te=3*be;if(this._circleAndRectCollide(fe[Te],fe[Te+1],fe[Te+2],g,M,C,L)&&(!Y||Y(this.circleKeys[be]))){if(q.hitTest)return U.push(!0),!0;{const xe=fe[Te],Ie=fe[Te+1],ve=fe[Te+2];U.push({key:this.circleKeys[be],x1:xe-ve,y1:Ie-ve,x2:xe+ve,y2:Ie+ve})}}}}}_queryCellCircle(g,M,C,L,z,U,q,Y){const J=q.circle,ee=q.seenUids,ie=this.boxCells[z];if(ie!==null){const be=this.bboxes;for(const Te of ie)if(!ee.box[Te]){ee.box[Te]=!0;const xe=4*Te;if(this._circleAndRectCollide(J.x,J.y,J.radius,be[xe+0],be[xe+1],be[xe+2],be[xe+3])&&(!Y||Y(this.boxKeys[Te])))return U.push(!0),!0}}const fe=this.circleCells[z];if(fe!==null){const be=this.circles;for(const Te of fe)if(!ee.circle[Te]){ee.circle[Te]=!0;const xe=3*Te;if(this._circlesCollide(be[xe],be[xe+1],be[xe+2],J.x,J.y,J.radius)&&(!Y||Y(this.circleKeys[Te])))return U.push(!0),!0}}}_forEachCell(g,M,C,L,z,U,q,Y){const J=this._convertToXCellCoord(g),ee=this._convertToYCellCoord(M),ie=this._convertToXCellCoord(C),fe=this._convertToYCellCoord(L);for(let be=J;be<=ie;be++)for(let Te=ee;Te<=fe;Te++)if(z.call(this,g,M,C,L,this.xCellCount*Te+be,U,q,Y))return}_convertToXCellCoord(g){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(g*this.xScale)))}_convertToYCellCoord(g){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(g*this.yScale)))}_circlesCollide(g,M,C,L,z,U){const q=L-g,Y=z-M,J=C+U;return J*J>q*q+Y*Y}_circleAndRectCollide(g,M,C,L,z,U,q){const Y=(U-L)/2,J=Math.abs(g-(L+Y));if(J>Y+C)return!1;const ee=(q-z)/2,ie=Math.abs(M-(z+ee));if(ie>ee+C)return!1;if(J<=Y||ie<=ee)return!0;const fe=J-Y,be=ie-ee;return fe*fe+be*be<=C*C}}const Mt=Math.tan(85*Math.PI/180);function bi(I,g,M,C,L){const z=y.create$1();if(g){const U=se([],L);z[0]=U[0],z[1]=U[1],z[4]=U[2],z[5]=U[3],M||y.rotateZ(z,z,C.angle)}else y.multiply(z,C.labelPlaneMatrix,I);return z}function yi(I,g,M,C,L){if(g){const z=y.clone$1(I),U=y.identity([]);return U[0]=L[0],U[1]=L[1],U[4]=L[2],U[5]=L[3],y.multiply(z,z,U),M||y.rotateZ(z,z,-C.angle),z}return C.glCoordMatrix}function ir(I,g,M=0){const C=[I.x,I.y,M,1];M?y.transformMat4(C,C,g):ss(C,C,g);const L=C[3];return{point:new y.pointGeometry(C[0]/L,C[1]/L),signedDistanceFromCamera:L}}function $n(I,g){return Math.min(.5+I/g*.5,1.5)}function xi(I,g){const M=I[0]/I[3],C=I[1]/I[3];return M>=-g[0]&&M<=g[0]&&C>=-g[1]&&C<=g[1]}function os(I,g,M,C,L,z,U,q,Y){const J=C?I.textSizeData:I.iconSizeData,ee=y.evaluateSizeForZoom(J,M.transform.zoom),ie=[256/M.width*2+1,256/M.height*2+1],fe=C?I.text.dynamicLayoutVertexArray:I.icon.dynamicLayoutVertexArray;fe.clear();const be=I.lineVertexArray,Te=C?I.text.placedSymbolArray:I.icon.placedSymbolArray,xe=M.transform.width/M.transform.height;let Ie=!1;for(let ve=0;ve<Te.length;ve++){const ke=Te.get(ve);if(ke.writingMode!==y.WritingMode.vertical||Ie||ve!==0&&Te.get(ve-1).writingMode===y.WritingMode.horizontal||(Ie=!0),ke.hidden||ke.writingMode===y.WritingMode.vertical&&!Ie){Qr(ke.numGlyphs,fe);continue}Ie=!1;const De=new y.pointGeometry(ke.tileAnchorX,ke.tileAnchorY),Ee=Y?Y(De):0,Pe=[De.x,De.y,Ee],Oe=[...Pe,1];if(y.transformMat4(Oe,Oe,g),!xi(Oe,ie)){Qr(ke.numGlyphs,fe);continue}const Je=$n(M.transform.cameraToCenterDistance,Oe[3]),Ke=y.evaluateSizeForFeature(J,ee,ke),rt=U?Ke/Je:Ke*Je,nt=ir(new y.pointGeometry(Pe[0],Pe[1]),L,Pe[2]);if(nt.signedDistanceFromCamera<=0){Qr(ke.numGlyphs,fe);continue}let _t={};const it=U?null:Y,yt=Vr(ke,rt,!1,q,g,L,z,I.glyphOffsetArray,be,fe,nt.point,De,_t,xe,it);Ie=yt.useVertical,it&&yt.needsFlipping&&(_t={}),(yt.notEnoughRoom||Ie||yt.needsFlipping&&Vr(ke,rt,!0,q,g,L,z,I.glyphOffsetArray,be,fe,nt.point,De,_t,xe,it).notEnoughRoom)&&Qr(ke.numGlyphs,fe)}C?I.text.dynamicLayoutVertexBuffer.updateData(fe):I.icon.dynamicLayoutVertexBuffer.updateData(fe)}function eo(I,g,M,C,L,z,U,q,Y,J,ee,ie,fe){const be=q.glyphStartIndex+q.numGlyphs,Te=q.lineStartIndex,xe=q.lineStartIndex+q.lineLength,Ie=g.getoffsetX(q.glyphStartIndex),ve=g.getoffsetX(be-1),ke=vn(I*Ie,M,C,L,z,U,q.segment,Te,xe,Y,J,ee,ie,fe,!0);if(!ke)return null;const De=vn(I*ve,M,C,L,z,U,q.segment,Te,xe,Y,J,ee,ie,fe,!0);return De?{first:ke,last:De}:null}function to(I,g,M,C){return I.writingMode===y.WritingMode.horizontal&&Math.abs(M.y-g.y)>Math.abs(M.x-g.x)*C?{useVertical:!0}:I.writingMode===y.WritingMode.vertical?g.y<M.y?{needsFlipping:!0}:null:I.flipState!==0&&function(L,z,U){const q=(z.x-L.x)*U;return q===0||Math.abs((z.y-L.y)/q)>Mt}(g,M,C)?I.flipState===1?{needsFlipping:!0}:null:g.x>M.x?{needsFlipping:!0}:null}function Vr(I,g,M,C,L,z,U,q,Y,J,ee,ie,fe,be,Te){const xe=g/24,Ie=I.lineOffsetX*xe,ve=I.lineOffsetY*xe;let ke;if(I.numGlyphs>1){const De=I.glyphStartIndex+I.numGlyphs,Ee=I.lineStartIndex,Pe=I.lineStartIndex+I.lineLength,Oe=eo(xe,q,Ie,ve,M,ee,ie,I,Y,z,fe,Te,!1);if(!Oe)return{notEnoughRoom:!0};const Je=ir(Oe.first.point,U).point,Ke=ir(Oe.last.point,U).point;if(C&&!M){const rt=to(I,Je,Ke,be);if(I.flipState=rt&&rt.needsFlipping?1:2,rt)return rt}ke=[Oe.first];for(let rt=I.glyphStartIndex+1;rt<De-1;rt++)ke.push(vn(xe*q.getoffsetX(rt),Ie,ve,M,ee,ie,I.segment,Ee,Pe,Y,z,fe,Te,!1,!1));ke.push(Oe.last)}else{if(C&&!M){const Ee=ir(ie,L).point,Pe=I.lineStartIndex+I.segment+1,Oe=new y.pointGeometry(Y.getx(Pe),Y.gety(Pe)),Je=ir(Oe,L),Ke=to(I,Ee,Je.signedDistanceFromCamera>0?Je.point:cl(ie,Oe,Ee,1,L,void 0),be);if(I.flipState=Ke&&Ke.needsFlipping?1:2,Ke)return Ke}const De=vn(xe*q.getoffsetX(I.glyphStartIndex),Ie,ve,M,ee,ie,I.segment,I.lineStartIndex,I.lineStartIndex+I.lineLength,Y,z,fe,Te,!1,!1);if(!De)return{notEnoughRoom:!0};ke=[De]}for(const De of ke)y.addDynamicAttributes(J,De.point,De.angle);return{}}function Wi(I,g,M){const C={x:I.x,y:I.y,z:0};if(!M)return ir(C,g,C.z);const L=M(I);return ir(new y.pointGeometry(C.x,C.y),g,C.z+L)}function cl(I,g,M,C,L,z){const U=Wi(I.add(I.sub(g)._unit()),L,z).point,q=M.sub(U);return M.add(q._mult(C/q.mag()))}function vn(I,g,M,C,L,z,U,q,Y,J,ee,ie,fe,be,Te){const xe=C?I-g:I+g;let Ie=xe>0?1:-1,ve=0;C&&(Ie*=-1,ve=Math.PI),Ie<0&&(ve+=Math.PI);let ke=Ie>0?q+U:q+U+1,De=L,Ee=L,Pe=0,Oe=0;const Je=Math.abs(xe),Ke=[],rt=[];let nt=z;const _t=()=>{const Qt=ke-Ie;return Pe===0?z:new y.pointGeometry(J.getx(Qt),J.gety(Qt))},it=()=>cl(_t(),nt,Ee,Je-Pe+1,ee,fe);for(;Pe+Oe<=Je;){if(ke+=Ie,ke<q||ke>=Y)return null;if(Ee=De,Ke.push(De),be&&rt.push(nt||_t()),De=ie[ke],De===void 0){nt=new y.pointGeometry(J.getx(ke),J.gety(ke));const Qt=Wi(nt,ee,fe);De=Qt.signedDistanceFromCamera>0?ie[ke]=Qt.point:it()}else nt=null;Pe+=Oe,Oe=Ee.dist(De)}Te&&fe&&(nt=nt||new y.pointGeometry(J.getx(ke),J.gety(ke)),ie[ke]=De=ie[ke]===void 0?De:it(),Oe=Ee.dist(De));const yt=(Je-Pe)/Oe,We=De.sub(Ee),vt=We.mult(yt)._add(Ee);M&&vt._add(We._unit()._perp()._mult(M*Ie));const Ot=ve+Math.atan2(De.y-Ee.y,De.x-Ee.x);return Ke.push(vt),be&&(nt=nt||new y.pointGeometry(J.getx(ke),J.gety(ke)),rt.push(function(Qt,ni,si){const ai=1-si;return new y.pointGeometry(Qt.x*ai+ni.x*si,Qt.y*ai+ni.y*si)}(rt.length>0?rt[rt.length-1]:nt,nt,yt))),{point:vt,angle:Ot,path:Ke,tilePath:rt}}const la=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Qr(I,g){for(let M=0;M<I;M++){const C=g.length;g.resize(C+4),g.float32.set(la,3*C)}}function ss(I,g,M){const C=g[0],L=g[1];return I[0]=M[0]*C+M[4]*L+M[12],I[1]=M[1]*C+M[5]*L+M[13],I[3]=M[3]*C+M[7]*L+M[15],I}const en=100;class Ci{constructor(g,M,C=new hn(g.width+200,g.height+200,25),L=new hn(g.width+200,g.height+200,25)){this.transform=g,this.grid=C,this.ignoredGrid=L,this.pitchfactor=Math.cos(g._pitch)*g.cameraToCenterDistance,this.screenRightBoundary=g.width+en,this.screenBottomBoundary=g.height+en,this.gridRightBoundary=g.width+200,this.gridBottomBoundary=g.height+200,this.fogState=M}placeCollisionBox(g,M,C,L,z,U,q){let Y=M.projectedAnchorZ;M.elevation&&(Y+=M.elevation);const J=this.projectAndGetPerspectiveRatio(U,M.projectedAnchorX,M.projectedAnchorY,Y,M.tileID),ee=z*J.perspectiveRatio,ie=(M.x1*g+C.x-M.padding)*ee+J.point.x,fe=(M.y1*g+C.y-M.padding)*ee+J.point.y,be=(M.x2*g+C.x+M.padding)*ee+J.point.x,Te=(M.y2*g+C.y+M.padding)*ee+J.point.y,xe=J.perspectiveRatio<=.55||J.aboveHorizon;return!this.isInsideGrid(ie,fe,be,Te)||!L&&this.grid.hitTest(ie,fe,be,Te,q)||xe?{box:[],offscreen:!1}:{box:[ie,fe,be,Te],offscreen:this.isOffscreen(ie,fe,be,Te)}}placeCollisionCircles(g,M,C,L,z,U,q,Y,J,ee,ie,fe,be,Te){const xe=[],Ie=this.transform.elevation,ve=Ie?it=>Ie.getAtTileOffset(Te,it.x,it.y):it=>0,ke=new y.pointGeometry(M.tileAnchorX,M.tileAnchorY),De=ve(ke),Ee=this.projectAndGetPerspectiveRatio(U,ke.x,ke.y,De,Te),{perspectiveRatio:Pe}=Ee,Oe=(ee?z/Pe:z*Pe)/y.ONE_EM,Je=ir(ke,q,De).point,Ke=Ee.signedDistanceFromCamera>0?eo(Oe,L,M.lineOffsetX*Oe,M.lineOffsetY*Oe,!1,Je,ke,M,C,q,{},Ie&&!ee?ve:null,ee&&!!Ie):null;let rt=!1,nt=!1,_t=!0;if(Ke&&!Ee.aboveHorizon){const it=.5*fe*Pe+be,yt=new y.pointGeometry(-100,-100),We=new y.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),vt=new On,Ot=Ke.first,Qt=Ke.last;let ni=[];for(let Wt=Ot.path.length-1;Wt>=1;Wt--)ni.push(Ot.path[Wt]);for(let Wt=1;Wt<Qt.path.length;Wt++)ni.push(Qt.path[Wt]);const si=2.5*it;if(Y){const Wt=ni.map(Ie?(fi,Li)=>{const ar=ve(Li<Ot.path.length-1?Ot.tilePath[Ot.path.length-1-Li]:Qt.tilePath[Li-Ot.path.length+2]);return ir(fi,Y,ar)}:fi=>ir(fi,Y));ni=Wt.some(fi=>fi.signedDistanceFromCamera<=0)?[]:Wt.map(fi=>fi.point)}let ai=[];if(ni.length>0){const Wt=ni[0].clone(),fi=ni[0].clone();for(let Li=1;Li<ni.length;Li++)Wt.x=Math.min(Wt.x,ni[Li].x),Wt.y=Math.min(Wt.y,ni[Li].y),fi.x=Math.max(fi.x,ni[Li].x),fi.y=Math.max(fi.y,ni[Li].y);ai=Wt.x>=yt.x&&fi.x<=We.x&&Wt.y>=yt.y&&fi.y<=We.y?[ni]:fi.x<yt.x||Wt.x>We.x||fi.y<yt.y||Wt.y>We.y?[]:y.clipLine([ni],yt.x,yt.y,We.x,We.y)}for(const Wt of ai){vt.reset(Wt,.25*it);let fi=0;fi=vt.length<=.5*it?1:Math.ceil(vt.paddedLength/si)+1;for(let Li=0;Li<fi;Li++){const ar=Li/Math.max(fi-1,1),wr=vt.lerp(ar),kr=wr.x+en,Rr=wr.y+en;xe.push(kr,Rr,it,0);const lr=kr-it,mn=Rr-it,un=kr+it,Xi=Rr+it;if(_t=_t&&this.isOffscreen(lr,mn,un,Xi),nt=nt||this.isInsideGrid(lr,mn,un,Xi),!g&&this.grid.hitTestCircle(kr,Rr,it,ie)&&(rt=!0,!J))return{circles:[],offscreen:!1,collisionDetected:rt}}}}return{circles:!J&&rt||!nt?[]:xe,offscreen:_t,collisionDetected:rt}}queryRenderedSymbols(g){if(g.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const M=[];let C=1/0,L=1/0,z=-1/0,U=-1/0;for(const ee of g){const ie=new y.pointGeometry(ee.x+en,ee.y+en);C=Math.min(C,ie.x),L=Math.min(L,ie.y),z=Math.max(z,ie.x),U=Math.max(U,ie.y),M.push(ie)}const q=this.grid.query(C,L,z,U).concat(this.ignoredGrid.query(C,L,z,U)),Y={},J={};for(const ee of q){const ie=ee.key;if(Y[ie.bucketInstanceId]===void 0&&(Y[ie.bucketInstanceId]={}),Y[ie.bucketInstanceId][ie.featureIndex])continue;const fe=[new y.pointGeometry(ee.x1,ee.y1),new y.pointGeometry(ee.x2,ee.y1),new y.pointGeometry(ee.x2,ee.y2),new y.pointGeometry(ee.x1,ee.y2)];y.polygonIntersectsPolygon(M,fe)&&(Y[ie.bucketInstanceId][ie.featureIndex]=!0,J[ie.bucketInstanceId]===void 0&&(J[ie.bucketInstanceId]=[]),J[ie.bucketInstanceId].push(ie.featureIndex))}return J}insertCollisionBox(g,M,C,L,z){(M?this.ignoredGrid:this.grid).insert({bucketInstanceId:C,featureIndex:L,collisionGroupID:z},g[0],g[1],g[2],g[3])}insertCollisionCircles(g,M,C,L,z){const U=M?this.ignoredGrid:this.grid,q={bucketInstanceId:C,featureIndex:L,collisionGroupID:z};for(let Y=0;Y<g.length;Y+=4)U.insertCircle(q,g[Y],g[Y+1],g[Y+2])}projectAndGetPerspectiveRatio(g,M,C,L,z){const U=[M,C,L||0,1];let q=!1;if(L||this.transform.pitch>0){y.transformMat4(U,U,g);let Y=!1;this.fogState&&z&&(Y=function(J,ee,ie,fe,be,Te){const xe=Te.calculateFogTileMatrix(be),Ie=[ee,ie,fe];return y.transformMat4$1(Ie,Ie,xe),ct(J,Ie,Te.pitch,Te._fov)}(this.fogState,M,C,L||0,z.toUnwrapped(),this.transform)>.9),q=U[2]>U[3]||Y}else ss(U,U,g);return{point:new y.pointGeometry((U[0]/U[3]+1)/2*this.transform.width+en,(-U[1]/U[3]+1)/2*this.transform.height+en),perspectiveRatio:Math.min(.5+this.transform.cameraToCenterDistance/U[3]*.5,1.5),signedDistanceFromCamera:U[3],aboveHorizon:q}}isOffscreen(g,M,C,L){return C<en||g>=this.screenRightBoundary||L<en||M>this.screenBottomBoundary}isInsideGrid(g,M,C,L){return C>=0&&g<this.gridRightBoundary&&L>=0&&M<this.gridBottomBoundary}getViewportMatrix(){const g=y.identity([]);return y.translate(g,g,[-100,-100,0]),g}}class as{constructor(g,M,C,L){this.opacity=g?Math.max(0,Math.min(1,g.opacity+(g.placed?M:-M))):L&&C?1:0,this.placed=C}isHidden(){return this.opacity===0&&!this.placed}}class Nn{constructor(g,M,C,L,z,U=!1){this.text=new as(g?g.text:null,M,C,z),this.icon=new as(g?g.icon:null,M,L,z),this.clipped=U}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Sr{constructor(g,M,C,L=!1){this.text=g,this.icon=M,this.skipFade=C,this.clipped=L}}class Xr{constructor(){this.invProjMatrix=y.create$1(),this.viewportMatrix=y.create$1(),this.circles=[]}}class ul{constructor(g,M,C,L,z){this.bucketInstanceId=g,this.featureIndex=M,this.sourceLayerIndex=C,this.bucketIndex=L,this.tileID=z}}class ls{constructor(g){this.crossSourceCollisions=g,this.maxGroupID=0,this.collisionGroups={}}get(g){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[g]){const M=++this.maxGroupID;this.collisionGroups[g]={ID:M,predicate:C=>C.collisionGroupID===M}}return this.collisionGroups[g]}}function rr(I,g,M,C,L){const{horizontalAlign:z,verticalAlign:U}=y.getAnchorAlignment(I),q=-(z-.5)*g,Y=-(U-.5)*M,J=y.evaluateVariableOffset(I,C);return new y.pointGeometry(q+J[0]*L,Y+J[1]*L)}function Un(I,g,M,C,L){const z=new y.pointGeometry(I,g);return M&&z._rotate(C?L:-L),z}class Vn{constructor(g,M,C,L,z){this.transform=g.clone(),this.collisionIndex=new Ci(this.transform,z),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=M,this.retainedQueryData={},this.collisionGroups=new ls(C),this.collisionCircleArrays={},this.prevPlacement=L,L&&(L.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(g,M,C,L){const z=C.getBucket(M),U=C.latestFeatureIndex;if(!z||!U||M.id!==z.layerIds[0])return;const q=z.layers[0].layout,Y=C.collisionBoxArray,J=Math.pow(2,this.transform.zoom-C.tileID.overscaledZ),ee=C.tileSize/y.EXTENT,ie=C.tileID.toUnwrapped(),fe=this.transform.calculateProjMatrix(ie),be=q.get("text-pitch-alignment")==="map",Te=q.get("text-rotation-alignment")==="map";M.compileFilter();const xe=M.dynamicFilter(),Ie=M.dynamicFilterNeedsFeature(),ve=this.transform.calculatePixelsToTileUnitsMatrix(C),ke=bi(fe,be,Te,this.transform,ve);let De=null;if(be){const Oe=yi(fe,be,Te,this.transform,ve);De=y.multiply([],this.transform.labelPlaneMatrix,Oe)}let Ee=null;xe&&C.latestFeatureIndex&&(Ee={unwrappedTileID:ie,dynamicFilter:xe,dynamicFilterNeedsFeature:Ie,featureIndex:C.latestFeatureIndex}),this.retainedQueryData[z.bucketInstanceId]=new ul(z.bucketInstanceId,U,z.sourceLayerIndex,z.index,C.tileID);const Pe={bucket:z,layout:q,posMatrix:fe,textLabelPlaneMatrix:ke,labelToScreenMatrix:De,clippingData:Ee,scale:J,textPixelRatio:ee,holdingForFade:C.holdingForFade(),collisionBoxArray:Y,partiallyEvaluatedTextSize:y.evaluateSizeForZoom(z.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:y.evaluateSizeForZoom(z.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(z.sourceID)};if(L)for(const Oe of z.sortKeyRanges){const{sortKey:Je,symbolInstanceStart:Ke,symbolInstanceEnd:rt}=Oe;g.push({sortKey:Je,symbolInstanceStart:Ke,symbolInstanceEnd:rt,parameters:Pe})}else g.push({symbolInstanceStart:0,symbolInstanceEnd:z.symbolInstances.length,parameters:Pe})}attemptAnchorPlacement(g,M,C,L,z,U,q,Y,J,ee,ie,fe,be,Te,xe,Ie,ve,ke){const De=[fe.textOffset0,fe.textOffset1],Ee=rr(g,C,L,De,z),Pe=this.collisionIndex.placeCollisionBox(z,M,Un(Ee.x,Ee.y,U,q,this.transform.angle),ie,Y,J,ee.predicate);if((!Ie||this.collisionIndex.placeCollisionBox(Te.getSymbolInstanceIconSize(ke,this.transform.zoom,be),Ie,Un(Ee.x,Ee.y,U,q,this.transform.angle),ie,Y,J,ee.predicate).box.length!==0)&&Pe.box.length>0){let Oe;return this.prevPlacement&&this.prevPlacement.variableOffsets[fe.crossTileID]&&this.prevPlacement.placements[fe.crossTileID]&&this.prevPlacement.placements[fe.crossTileID].text&&(Oe=this.prevPlacement.variableOffsets[fe.crossTileID].anchor),this.variableOffsets[fe.crossTileID]={textOffset:De,width:C,height:L,anchor:g,textScale:z,prevAnchor:Oe},this.markUsedJustification(Te,g,fe,xe),Te.allowVerticalPlacement&&(this.markUsedOrientation(Te,xe,fe),this.placedOrientations[fe.crossTileID]=xe),{shift:Ee,placedGlyphBoxes:Pe}}}placeLayerBucketPart(g,M,C,L){const{bucket:z,layout:U,posMatrix:q,textLabelPlaneMatrix:Y,labelToScreenMatrix:J,clippingData:ee,textPixelRatio:ie,holdingForFade:fe,collisionBoxArray:be,partiallyEvaluatedTextSize:Te,partiallyEvaluatedIconSize:xe,collisionGroup:Ie}=g.parameters,ve=U.get("text-optional"),ke=U.get("icon-optional"),De=U.get("text-allow-overlap"),Ee=U.get("icon-allow-overlap"),Pe=U.get("text-rotation-alignment")==="map",Oe=U.get("text-pitch-alignment")==="map",Je=U.get("icon-text-fit")!=="none",Ke=U.get("symbol-z-order")==="viewport-y",rt=De&&(Ee||!z.hasIconData()||ke),nt=Ee&&(De||!z.hasTextData()||ve);!z.collisionArrays&&be&&z.deserializeCollisionBoxes(be),C&&L&&z.updateCollisionDebugBuffers(this.transform.zoom,be);const _t=(it,yt,We)=>{if(ee){const Xi={zoom:this.transform.zoom,pitch:this.transform.pitch};let er=null;if(ee.dynamicFilterNeedsFeature){const Ii=this.retainedQueryData[z.bucketInstanceId];er=ee.featureIndex.loadFeature({featureIndex:it.featureIndex,bucketIndex:Ii.bucketIndex,sourceLayerIndex:Ii.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,ee.dynamicFilter)(Xi,er,this.retainedQueryData[z.bucketInstanceId].tileID.canonical,new y.pointGeometry(it.tileAnchorX,it.tileAnchorY),this.transform.calculateDistanceTileData(ee.unwrappedTileID)))return this.placements[it.crossTileID]=new Sr(!1,!1,!1,!0),void(M[it.crossTileID]=!0)}if(M[it.crossTileID])return;if(fe)return void(this.placements[it.crossTileID]=new Sr(!1,!1,!1));let vt=!1,Ot=!1,Qt=!0,ni=null,si={box:null,offscreen:null},ai={box:null,offscreen:null},Wt=null,fi=null,Li=null,ar=0,wr=0,kr=0;We.textFeatureIndex?ar=We.textFeatureIndex:it.useRuntimeCollisionCircles&&(ar=it.featureIndex),We.verticalTextFeatureIndex&&(wr=We.verticalTextFeatureIndex);const Rr=Xi=>{Xi.tileID=this.retainedQueryData[z.bucketInstanceId].tileID,(this.transform.elevation||Xi.elevation)&&(Xi.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[z.bucketInstanceId].tileID,Xi.tileAnchorX,Xi.tileAnchorY):0)},lr=We.textBox;if(lr){Rr(lr);const Xi=Ii=>{let Hi=y.WritingMode.horizontal;if(z.allowVerticalPlacement&&!Ii&&this.prevPlacement){const Er=this.prevPlacement.placedOrientations[it.crossTileID];Er&&(this.placedOrientations[it.crossTileID]=Er,Hi=Er,this.markUsedOrientation(z,Hi,it))}return Hi},er=(Ii,Hi)=>{if(z.allowVerticalPlacement&&it.numVerticalGlyphVertices>0&&We.verticalTextBox){for(const Er of z.writingModes)if(Er===y.WritingMode.vertical?(si=Hi(),ai=si):si=Ii(),si&&si.box&&si.box.length)break}else si=Ii()};if(U.get("text-variable-anchor")){let Ii=U.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[it.crossTileID]){const Yi=this.prevPlacement.variableOffsets[it.crossTileID];Ii.indexOf(Yi.anchor)>0&&(Ii=Ii.filter(Gr=>Gr!==Yi.anchor),Ii.unshift(Yi.anchor))}const Hi=(Yi,Gr,Wo)=>{const $r=z.getSymbolInstanceTextSize(Te,it,this.transform.zoom,yt),Dn=(Yi.x2-Yi.x1)*$r+2*Yi.padding,eh=(Yi.y2-Yi.y1)*$r+2*Yi.padding,js=Je&&!Ee?Gr:null;js&&Rr(js);let yo={box:[],offscreen:!1};const th=De?2*Ii.length:Ii.length;for(let Ko=0;Ko<th;++Ko){const Gs=this.attemptAnchorPlacement(Ii[Ko%Ii.length],Yi,Dn,eh,$r,Pe,Oe,ie,q,Ie,Ko>=Ii.length,it,yt,z,Wo,js,Te,xe);if(Gs&&(yo=Gs.placedGlyphBoxes,yo&&yo.box&&yo.box.length)){vt=!0,ni=Gs.shift;break}}return yo};er(()=>Hi(lr,We.iconBox,y.WritingMode.horizontal),()=>{const Yi=We.verticalTextBox;return Yi&&Rr(Yi),z.allowVerticalPlacement&&!(si&&si.box&&si.box.length)&&it.numVerticalGlyphVertices>0&&Yi?Hi(Yi,We.verticalIconBox,y.WritingMode.vertical):{box:null,offscreen:null}}),si&&(vt=si.box,Qt=si.offscreen);const Er=Xi(si&&si.box);if(!vt&&this.prevPlacement){const Yi=this.prevPlacement.variableOffsets[it.crossTileID];Yi&&(this.variableOffsets[it.crossTileID]=Yi,this.markUsedJustification(z,Yi.anchor,it,Er))}}else{const Ii=(Hi,Er)=>{const Yi=z.getSymbolInstanceTextSize(Te,it,this.transform.zoom,yt),Gr=this.collisionIndex.placeCollisionBox(Yi,Hi,new y.pointGeometry(0,0),De,ie,q,Ie.predicate);return Gr&&Gr.box&&Gr.box.length&&(this.markUsedOrientation(z,Er,it),this.placedOrientations[it.crossTileID]=Er),Gr};er(()=>Ii(lr,y.WritingMode.horizontal),()=>{const Hi=We.verticalTextBox;return z.allowVerticalPlacement&&it.numVerticalGlyphVertices>0&&Hi?(Rr(Hi),Ii(Hi,y.WritingMode.vertical)):{box:null,offscreen:null}}),Xi(si&&si.box&&si.box.length)}}if(Wt=si,vt=Wt&&Wt.box&&Wt.box.length>0,Qt=Wt&&Wt.offscreen,it.useRuntimeCollisionCircles){const Xi=z.text.placedSymbolArray.get(it.centerJustifiedTextSymbolIndex>=0?it.centerJustifiedTextSymbolIndex:it.verticalPlacedTextSymbolIndex),er=y.evaluateSizeForFeature(z.textSizeData,Te,Xi),Ii=U.get("text-padding");fi=this.collisionIndex.placeCollisionCircles(De,Xi,z.lineVertexArray,z.glyphOffsetArray,er,q,Y,J,C,Oe,Ie.predicate,it.collisionCircleDiameter*er/y.ONE_EM,Ii,this.retainedQueryData[z.bucketInstanceId].tileID),vt=De||fi.circles.length>0&&!fi.collisionDetected,Qt=Qt&&fi.offscreen}if(We.iconFeatureIndex&&(kr=We.iconFeatureIndex),We.iconBox){const Xi=er=>{Rr(er);const Ii=Je&&ni?Un(ni.x,ni.y,Pe,Oe,this.transform.angle):new y.pointGeometry(0,0),Hi=z.getSymbolInstanceIconSize(xe,this.transform.zoom,yt);return this.collisionIndex.placeCollisionBox(Hi,er,Ii,Ee,ie,q,Ie.predicate)};ai&&ai.box&&ai.box.length&&We.verticalIconBox?(Li=Xi(We.verticalIconBox),Ot=Li.box.length>0):(Li=Xi(We.iconBox),Ot=Li.box.length>0),Qt=Qt&&Li.offscreen}const mn=ve||it.numHorizontalGlyphVertices===0&&it.numVerticalGlyphVertices===0,un=ke||it.numIconVertices===0;if(mn||un?un?mn||(Ot=Ot&&vt):vt=Ot&&vt:Ot=vt=Ot&&vt,vt&&Wt&&Wt.box&&this.collisionIndex.insertCollisionBox(Wt.box,U.get("text-ignore-placement"),z.bucketInstanceId,ai&&ai.box&&wr?wr:ar,Ie.ID),Ot&&Li&&this.collisionIndex.insertCollisionBox(Li.box,U.get("icon-ignore-placement"),z.bucketInstanceId,kr,Ie.ID),fi&&(vt&&this.collisionIndex.insertCollisionCircles(fi.circles,U.get("text-ignore-placement"),z.bucketInstanceId,ar,Ie.ID),C)){const Xi=z.bucketInstanceId;let er=this.collisionCircleArrays[Xi];er===void 0&&(er=this.collisionCircleArrays[Xi]=new Xr);for(let Ii=0;Ii<fi.circles.length;Ii+=4)er.circles.push(fi.circles[Ii+0]),er.circles.push(fi.circles[Ii+1]),er.circles.push(fi.circles[Ii+2]),er.circles.push(fi.collisionDetected?1:0)}this.placements[it.crossTileID]=new Sr(vt||rt,Ot||nt,Qt||z.justReloaded),M[it.crossTileID]=!0};if(Ke){const it=z.getSortedSymbolIndexes(this.transform.angle);for(let yt=it.length-1;yt>=0;--yt){const We=it[yt];_t(z.symbolInstances.get(We),We,z.collisionArrays[We])}}else for(let it=g.symbolInstanceStart;it<g.symbolInstanceEnd;it++)_t(z.symbolInstances.get(it),it,z.collisionArrays[it]);if(C&&z.bucketInstanceId in this.collisionCircleArrays){const it=this.collisionCircleArrays[z.bucketInstanceId];y.invert(it.invProjMatrix,q),it.viewportMatrix=this.collisionIndex.getViewportMatrix()}z.justReloaded=!1}markUsedJustification(g,M,C,L){let z;z=L===y.WritingMode.vertical?C.verticalPlacedTextSymbolIndex:{left:C.leftJustifiedTextSymbolIndex,center:C.centerJustifiedTextSymbolIndex,right:C.rightJustifiedTextSymbolIndex}[y.getAnchorJustification(M)];const U=[C.leftJustifiedTextSymbolIndex,C.centerJustifiedTextSymbolIndex,C.rightJustifiedTextSymbolIndex,C.verticalPlacedTextSymbolIndex];for(const q of U)q>=0&&(g.text.placedSymbolArray.get(q).crossTileID=z>=0&&q!==z?0:C.crossTileID)}markUsedOrientation(g,M,C){const L=M===y.WritingMode.horizontal||M===y.WritingMode.horizontalOnly?M:0,z=M===y.WritingMode.vertical?M:0,U=[C.leftJustifiedTextSymbolIndex,C.centerJustifiedTextSymbolIndex,C.rightJustifiedTextSymbolIndex];for(const q of U)g.text.placedSymbolArray.get(q).placedOrientation=L;C.verticalPlacedTextSymbolIndex&&(g.text.placedSymbolArray.get(C.verticalPlacedTextSymbolIndex).placedOrientation=z)}commit(g){this.commitTime=g,this.zoomAtLastRecencyCheck=this.transform.zoom;const M=this.prevPlacement;let C=!1;this.prevZoomAdjustment=M?M.zoomAdjustment(this.transform.zoom):0;const L=M?M.symbolFadeChange(g):1,z=M?M.opacities:{},U=M?M.variableOffsets:{},q=M?M.placedOrientations:{};for(const Y in this.placements){const J=this.placements[Y],ee=z[Y];ee?(this.opacities[Y]=new Nn(ee,L,J.text,J.icon,null,J.clipped),C=C||J.text!==ee.text.placed||J.icon!==ee.icon.placed):(this.opacities[Y]=new Nn(null,L,J.text,J.icon,J.skipFade,J.clipped),C=C||J.text||J.icon)}for(const Y in z){const J=z[Y];if(!this.opacities[Y]){const ee=new Nn(J,L,!1,!1);ee.isHidden()||(this.opacities[Y]=ee,C=C||J.text.placed||J.icon.placed)}}for(const Y in U)this.variableOffsets[Y]||!this.opacities[Y]||this.opacities[Y].isHidden()||(this.variableOffsets[Y]=U[Y]);for(const Y in q)this.placedOrientations[Y]||!this.opacities[Y]||this.opacities[Y].isHidden()||(this.placedOrientations[Y]=q[Y]);C?this.lastPlacementChangeTime=g:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=M?M.lastPlacementChangeTime:g)}updateLayerOpacities(g,M){const C={};for(const L of M){const z=L.getBucket(g);z&&L.latestFeatureIndex&&g.id===z.layerIds[0]&&this.updateBucketOpacities(z,C,L.collisionBoxArray)}}updateBucketOpacities(g,M,C){g.hasTextData()&&g.text.opacityVertexArray.clear(),g.hasIconData()&&g.icon.opacityVertexArray.clear(),g.hasIconCollisionBoxData()&&g.iconCollisionBox.collisionVertexArray.clear(),g.hasTextCollisionBoxData()&&g.textCollisionBox.collisionVertexArray.clear();const L=g.layers[0].layout,z=!!g.layers[0].dynamicFilter(),U=new Nn(null,0,!1,!1,!0),q=L.get("text-allow-overlap"),Y=L.get("icon-allow-overlap"),J=L.get("text-variable-anchor"),ee=L.get("text-rotation-alignment")==="map",ie=L.get("text-pitch-alignment")==="map",fe=L.get("icon-text-fit")!=="none",be=new Nn(null,0,q&&(Y||!g.hasIconData()||L.get("icon-optional")),Y&&(q||!g.hasTextData()||L.get("text-optional")),!0);!g.collisionArrays&&C&&(g.hasIconCollisionBoxData()||g.hasTextCollisionBoxData())&&g.deserializeCollisionBoxes(C);const Te=(xe,Ie,ve)=>{for(let ke=0;ke<Ie/4;ke++)xe.opacityVertexArray.emplaceBack(ve)};for(let xe=0;xe<g.symbolInstances.length;xe++){const Ie=g.symbolInstances.get(xe),{numHorizontalGlyphVertices:ve,numVerticalGlyphVertices:ke,crossTileID:De}=Ie;let Ee=this.opacities[De];M[De]?Ee=U:Ee||(Ee=be,this.opacities[De]=Ee),M[De]=!0;const Pe=Ie.numIconVertices>0,Oe=this.placedOrientations[Ie.crossTileID],Je=Oe===y.WritingMode.vertical,Ke=Oe===y.WritingMode.horizontal||Oe===y.WritingMode.horizontalOnly;if(ve>0||ke>0){const rt=ca(Ee.text);Te(g.text,ve,Je?Ar:rt),Te(g.text,ke,Ke?Ar:rt);const nt=Ee.text.isHidden();[Ie.rightJustifiedTextSymbolIndex,Ie.centerJustifiedTextSymbolIndex,Ie.leftJustifiedTextSymbolIndex].forEach(yt=>{yt>=0&&(g.text.placedSymbolArray.get(yt).hidden=nt||Je?1:0)}),Ie.verticalPlacedTextSymbolIndex>=0&&(g.text.placedSymbolArray.get(Ie.verticalPlacedTextSymbolIndex).hidden=nt||Ke?1:0);const _t=this.variableOffsets[Ie.crossTileID];_t&&this.markUsedJustification(g,_t.anchor,Ie,Oe);const it=this.placedOrientations[Ie.crossTileID];it&&(this.markUsedJustification(g,"left",Ie,it),this.markUsedOrientation(g,it,Ie))}if(Pe){const rt=ca(Ee.icon);Ie.placedIconSymbolIndex>=0&&(Te(g.icon,Ie.numIconVertices,Je?Ar:rt),g.icon.placedSymbolArray.get(Ie.placedIconSymbolIndex).hidden=Ee.icon.isHidden()),Ie.verticalPlacedIconSymbolIndex>=0&&(Te(g.icon,Ie.numVerticalIconVertices,Ke?Ar:rt),g.icon.placedSymbolArray.get(Ie.verticalPlacedIconSymbolIndex).hidden=Ee.icon.isHidden())}if(g.hasIconCollisionBoxData()||g.hasTextCollisionBoxData()){const rt=g.collisionArrays[xe];if(rt){let nt=new y.pointGeometry(0,0),_t=!0;if(rt.textBox||rt.verticalTextBox){if(J){const yt=this.variableOffsets[De];yt?(nt=rr(yt.anchor,yt.width,yt.height,yt.textOffset,yt.textScale),ee&&nt._rotate(ie?this.transform.angle:-this.transform.angle)):_t=!1}z&&(_t=!Ee.clipped),rt.textBox&&sr(g.textCollisionBox.collisionVertexArray,Ee.text.placed,!_t||Je,nt.x,nt.y),rt.verticalTextBox&&sr(g.textCollisionBox.collisionVertexArray,Ee.text.placed,!_t||Ke,nt.x,nt.y)}const it=_t&&Boolean(!Ke&&rt.verticalIconBox);rt.iconBox&&sr(g.iconCollisionBox.collisionVertexArray,Ee.icon.placed,it,fe?nt.x:0,fe?nt.y:0),rt.verticalIconBox&&sr(g.iconCollisionBox.collisionVertexArray,Ee.icon.placed,!it,fe?nt.x:0,fe?nt.y:0)}}}if(g.sortFeatures(this.transform.angle),this.retainedQueryData[g.bucketInstanceId]&&(this.retainedQueryData[g.bucketInstanceId].featureSortOrder=g.featureSortOrder),g.hasTextData()&&g.text.opacityVertexBuffer&&g.text.opacityVertexBuffer.updateData(g.text.opacityVertexArray),g.hasIconData()&&g.icon.opacityVertexBuffer&&g.icon.opacityVertexBuffer.updateData(g.icon.opacityVertexArray),g.hasIconCollisionBoxData()&&g.iconCollisionBox.collisionVertexBuffer&&g.iconCollisionBox.collisionVertexBuffer.updateData(g.iconCollisionBox.collisionVertexArray),g.hasTextCollisionBoxData()&&g.textCollisionBox.collisionVertexBuffer&&g.textCollisionBox.collisionVertexBuffer.updateData(g.textCollisionBox.collisionVertexArray),g.bucketInstanceId in this.collisionCircleArrays){const xe=this.collisionCircleArrays[g.bucketInstanceId];g.placementInvProjMatrix=xe.invProjMatrix,g.placementViewportMatrix=xe.viewportMatrix,g.collisionCircleArray=xe.circles,delete this.collisionCircleArrays[g.bucketInstanceId]}}symbolFadeChange(g){return this.fadeDuration===0?1:(g-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(g){return Math.max(0,(this.transform.zoom-g)/1.5)}hasTransitions(g){return this.stale||g-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(g,M){const C=this.zoomAtLastRecencyCheck===M?1-this.zoomAdjustment(M):1;return this.zoomAtLastRecencyCheck=M,this.commitTime+this.fadeDuration*C>g}setStale(){this.stale=!0}}function sr(I,g,M,C,L){I.emplaceBack(g?1:0,M?1:0,C||0,L||0),I.emplaceBack(g?1:0,M?1:0,C||0,L||0),I.emplaceBack(g?1:0,M?1:0,C||0,L||0),I.emplaceBack(g?1:0,M?1:0,C||0,L||0)}const ha=Math.pow(2,25),tn=Math.pow(2,24),Co=Math.pow(2,17),hs=Math.pow(2,16),Bh=Math.pow(2,9),bn=Math.pow(2,8),Lh=Math.pow(2,1);function ca(I){if(I.opacity===0&&!I.placed)return 0;if(I.opacity===1&&I.placed)return 4294967295;const g=I.placed?1:0,M=Math.floor(127*I.opacity);return M*ha+g*tn+M*Co+g*hs+M*Bh+g*bn+M*Lh+g}const Ar=0;class cs{constructor(g){this._sortAcrossTiles=g.layout.get("symbol-z-order")!=="viewport-y"&&g.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(g,M,C,L,z){const U=this._bucketParts;for(;this._currentTileIndex<g.length;)if(M.getBucketParts(U,L,g[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,z())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,U.sort((q,Y)=>q.sortKey-Y.sortKey));this._currentPartIndex<U.length;){const q=U[this._currentPartIndex];if(M.placeLayerBucketPart(q,this._seenCrossTileIDs,C,q.symbolInstanceStart===0),this._currentPartIndex++,z())return!0}return!1}}class wn{constructor(g,M,C,L,z,U,q,Y){this.placement=new Vn(g,z,U,q,Y),this._currentPlacementIndex=M.length-1,this._forceFullPlacement=C,this._showCollisionBoxes=L,this._done=!1}isDone(){return this._done}continuePlacement(g,M,C){const L=y.exported.now(),z=()=>{const U=y.exported.now()-L;return!this._forceFullPlacement&&U>2};for(;this._currentPlacementIndex>=0;){const U=M[g[this._currentPlacementIndex]],q=this.placement.collisionIndex.transform.zoom;if(U.type==="symbol"&&(!U.minzoom||U.minzoom<=q)&&(!U.maxzoom||U.maxzoom>q)){if(this._inProgressLayer||(this._inProgressLayer=new cs(U)),this._inProgressLayer.continuePlacement(C[U.source],this.placement,this._showCollisionBoxes,U,z))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(g){return this.placement.commit(g),this.placement}}const ua=512/y.EXTENT/2;class us{constructor(g,M,C){this.tileID=g,this.indexedSymbolInstances={},this.bucketInstanceId=C;for(let L=0;L<M.length;L++){const z=M.get(L),U=z.key;this.indexedSymbolInstances[U]||(this.indexedSymbolInstances[U]=[]),this.indexedSymbolInstances[U].push({crossTileID:z.crossTileID,coord:this.getScaledCoordinates(z,g)})}}getScaledCoordinates(g,M){const C=ua/Math.pow(2,M.canonical.z-this.tileID.canonical.z);return{x:Math.floor((M.canonical.x*y.EXTENT+g.tileAnchorX)*C),y:Math.floor((M.canonical.y*y.EXTENT+g.tileAnchorY)*C)}}findMatches(g,M,C){const L=this.tileID.canonical.z<M.canonical.z?1:Math.pow(2,this.tileID.canonical.z-M.canonical.z);for(let z=0;z<g.length;z++){const U=g.get(z);if(U.crossTileID)continue;const q=this.indexedSymbolInstances[U.key];if(!q)continue;const Y=this.getScaledCoordinates(U,M);for(const J of q)if(Math.abs(J.coord.x-Y.x)<=L&&Math.abs(J.coord.y-Y.y)<=L&&!C[J.crossTileID]){C[J.crossTileID]=!0,U.crossTileID=J.crossTileID;break}}}}class zh{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Fh{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(g){const M=Math.round((g-this.lng)/360);if(M!==0)for(const C in this.indexes){const L=this.indexes[C],z={};for(const U in L){const q=L[U];q.tileID=q.tileID.unwrapTo(q.tileID.wrap+M),z[q.tileID.key]=q}this.indexes[C]=z}this.lng=g}addBucket(g,M,C){if(this.indexes[g.overscaledZ]&&this.indexes[g.overscaledZ][g.key]){if(this.indexes[g.overscaledZ][g.key].bucketInstanceId===M.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(g.overscaledZ,this.indexes[g.overscaledZ][g.key])}for(let z=0;z<M.symbolInstances.length;z++)M.symbolInstances.get(z).crossTileID=0;this.usedCrossTileIDs[g.overscaledZ]||(this.usedCrossTileIDs[g.overscaledZ]={});const L=this.usedCrossTileIDs[g.overscaledZ];for(const z in this.indexes){const U=this.indexes[z];if(Number(z)>g.overscaledZ)for(const q in U){const Y=U[q];Y.tileID.isChildOf(g)&&Y.findMatches(M.symbolInstances,g,L)}else{const q=U[g.scaledTo(Number(z)).key];q&&q.findMatches(M.symbolInstances,g,L)}}for(let z=0;z<M.symbolInstances.length;z++){const U=M.symbolInstances.get(z);U.crossTileID||(U.crossTileID=C.generate(),L[U.crossTileID]=!0)}return this.indexes[g.overscaledZ]===void 0&&(this.indexes[g.overscaledZ]={}),this.indexes[g.overscaledZ][g.key]=new us(g,M.symbolInstances,M.bucketInstanceId),!0}removeBucketCrossTileIDs(g,M){for(const C in M.indexedSymbolInstances)for(const L of M.indexedSymbolInstances[C])delete this.usedCrossTileIDs[g][L.crossTileID]}removeStaleBuckets(g){let M=!1;for(const C in this.indexes){const L=this.indexes[C];for(const z in L)g[L[z].bucketInstanceId]||(this.removeBucketCrossTileIDs(C,L[z]),delete L[z],M=!0)}return M}}class ds{constructor(){this.layerIndexes={},this.crossTileIDs=new zh,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(g,M,C){let L=this.layerIndexes[g.id];L===void 0&&(L=this.layerIndexes[g.id]=new Fh);let z=!1;const U={};L.handleWrapJump(C);for(const q of M){const Y=q.getBucket(g);Y&&g.id===Y.layerIds[0]&&(Y.bucketInstanceId||(Y.bucketInstanceId=++this.maxBucketInstanceId),L.addBucket(q.tileID,Y,this.crossTileIDs)&&(z=!0),U[Y.bucketInstanceId]=!0)}return L.removeStaleBuckets(U)&&(z=!0),z}pruneUnusedLayers(g){const M={};g.forEach(C=>{M[C]=!0});for(const C in this.layerIndexes)M[C]||delete this.layerIndexes[C]}}const fs=(I,g)=>y.emitValidationErrors(I,g&&g.filter(M=>M.identifier!=="source.canvas")),dl=y.pick(gt,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Oh=y.pick(gt,["setCenter","setZoom","setBearing","setPitch"]),fl=function(){const I={},g=y.spec.$version;for(const M in y.spec.$root){const C=y.spec.$root[M];if(C.required){let L=null;L=M==="version"?g:C.type==="array"?[]:{},L!=null&&(I[M]=L)}}return I}(),$h={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class Yr extends y.Evented{constructor(g,M={}){super(),this.map=g,this.dispatcher=new Dt(pt(),this),this.imageManager=new ue,this.imageManager.setEventedParent(this),this.glyphManager=new y.GlyphManager(g._requestManager,M.localFontFamily?y.LocalGlyphMode.all:M.localIdeographFontFamily?y.LocalGlyphMode.ideographs:y.LocalGlyphMode.none,M.localFontFamily||M.localIdeographFontFamily),this.lineAtlas=new y.LineAtlas(256,512),this.crossTileSymbolIndex=new ds,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new y.ZoomHistory,this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",y.getReferrer());const C=this;this._rtlTextPluginCallback=Yr.registerForPluginStateChange(L=>{C.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:L.pluginStatus,pluginURL:L.pluginURL},(z,U)=>{if(y.triggerPluginCompletionEvent(z),U&&U.every(q=>q))for(const q in C._sourceCaches){const Y=C._sourceCaches[q],J=Y.getSource().type;J!=="vector"&&J!=="geojson"||Y.reload()}})}),this.on("data",L=>{if(L.dataType!=="source"||L.sourceDataType!=="metadata")return;const z=this.getSource(L.sourceId);if(z&&z.vectorLayerIds)for(const U in this._layers){const q=this._layers[U];q.source===z.id&&this._validateLayer(q)}})}loadURL(g,M={}){this.fire(new y.Event("dataloading",{dataType:"style"}));const C=typeof M.validate=="boolean"?M.validate:!y.isMapboxURL(g);g=this.map._requestManager.normalizeStyleURL(g,M.accessToken);const L=this.map._requestManager.transformRequest(g,y.ResourceType.Style);this._request=y.getJSON(L,(z,U)=>{this._request=null,z?this.fire(new y.ErrorEvent(z)):U&&this._load(U,C)})}loadJSON(g,M={}){this.fire(new y.Event("dataloading",{dataType:"style"})),this._request=y.exported.frame(()=>{this._request=null,this._load(g,M.validate!==!1)})}loadEmpty(){this.fire(new y.Event("dataloading",{dataType:"style"})),this._load(fl,!1)}_updateLayerCount(g,M){const C=M?1:-1;g.is3D()&&(this._num3DLayers+=C),g.type==="circle"&&(this._numCircleLayers+=C),g.type==="symbol"&&(this._numSymbolLayers+=C)}_load(g,M){if(M&&fs(this,y.validateStyle(g)))return;this._loaded=!0,this.stylesheet=g,this.updateProjection();for(const L in g.sources)this.addSource(L,g.sources[L],{validate:!1});this._changed=!1,g.sprite?this._loadSprite(g.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(g.glyphs);const C=Rt(this.stylesheet.layers);this._order=C.map(L=>L.id),this._layers={},this._serializedLayers={};for(let L of C)L=y.createStyleLayer(L),L.setEventedParent(this,{layer:{id:L.id}}),this._layers[L.id]=L,this._serializedLayers[L.id]=L.serialize(),this._updateLayerCount(L,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new pe(this.stylesheet.light),this.stylesheet.terrain&&this._createTerrain(this.stylesheet.terrain),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new y.Event("data",{dataType:"style"})),this.fire(new y.Event("style.load"))}setProjection(g){g?this.stylesheet.projection=g:delete this.stylesheet.projection,this.updateProjection()}updateProjection(){const g=this.map.transform.setProjection(this.map._runtimeProjection||(this.stylesheet?this.stylesheet.projection:void 0));if(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),g){this.map.painter.clearBackgroundTiles();for(const M in this._sourceCaches)this._sourceCaches[M].clearTiles();this.map._update(!0)}}_loadSprite(g){this._spriteRequest=function(M,C,L){let z,U,q;const Y=y.exported.devicePixelRatio>1?"@2x":"";let J=y.getJSON(C.transformRequest(C.normalizeSpriteURL(M,Y,".json"),y.ResourceType.SpriteJSON),(fe,be)=>{J=null,q||(q=fe,z=be,ie())}),ee=y.getImage(C.transformRequest(C.normalizeSpriteURL(M,Y,".png"),y.ResourceType.SpriteImage),(fe,be)=>{ee=null,q||(q=fe,U=be,ie())});function ie(){if(q)L(q);else if(z&&U){const fe=y.exported.getImageData(U),be={};for(const Te in z){const{width:xe,height:Ie,x:ve,y:ke,sdf:De,pixelRatio:Ee,stretchX:Pe,stretchY:Oe,content:Je}=z[Te],Ke=new y.RGBAImage({width:xe,height:Ie});y.RGBAImage.copy(fe,Ke,{x:ve,y:ke},{x:0,y:0},{width:xe,height:Ie}),be[Te]={data:Ke,pixelRatio:Ee,sdf:De,stretchX:Pe,stretchY:Oe,content:Je}}L(null,be)}}return{cancel(){J&&(J.cancel(),J=null),ee&&(ee.cancel(),ee=null)}}}(g,this.map._requestManager,(M,C)=>{if(this._spriteRequest=null,M)this.fire(new y.ErrorEvent(M));else if(C)for(const L in C)this.imageManager.addImage(L,C[L]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new y.Event("data",{dataType:"style"}))})}_validateLayer(g){const M=this.getSource(g.source);if(!M)return;const C=g.sourceLayer;C&&(M.type==="geojson"||M.vectorLayerIds&&M.vectorLayerIds.indexOf(C)===-1)&&this.fire(new y.ErrorEvent(new Error(`Source layer "${C}" does not exist on source "${M.id}" as specified by style layer "${g.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const g in this._sourceCaches)if(!this._sourceCaches[g].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(g){const M=[];for(const C of g){const L=this._layers[C];L.type!=="custom"&&M.push(L.serialize())}return M}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const g in this._sourceCaches)if(this._sourceCaches[g].hasTransition())return!0;for(const g in this._layers)if(this._layers[g].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(g){return!!this.terrain&&$h[g.type]}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(g){if(!this._loaded)return;const M=this._changed;if(this._changed){const L=Object.keys(this._updatedLayers),z=Object.keys(this._removedLayers);(L.length||z.length)&&this._updateWorkerLayers(L,z);for(const U in this._updatedSources){const q=this._updatedSources[U];q==="reload"?this._reloadSource(U):q==="clear"&&this._clearSource(U)}this._updateTilesForChangedImages();for(const U in this._updatedPaintProps)this._layers[U].updateTransitions(g);this.light.updateTransitions(g),this.fog&&this.fog.updateTransitions(g),this._resetUpdates()}const C={};for(const L in this._sourceCaches){const z=this._sourceCaches[L];C[L]=z.used,z.used=!1}for(const L of this._order){const z=this._layers[L];if(z.recalculate(g,this._availableImages),!z.isHidden(g.zoom)){const q=this._getLayerSourceCache(z);q&&(q.used=!0)}const U=this.map.painter;if(U){const q=z.getProgramIds();if(!q)continue;const Y=z.getProgramConfiguration(g.zoom);for(const J of q)U.useProgram(J,Y)}}for(const L in C){const z=this._sourceCaches[L];C[L]!==z.used&&z.getSource().fire(new y.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:z.getSource().id}))}this.light.recalculate(g),this.terrain&&this.terrain.recalculate(g),this.fog&&this.fog.recalculate(g),this.z=g.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),M&&this.fire(new y.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const g=Object.keys(this._changedImages);if(g.length){for(const M in this._sourceCaches)this._sourceCaches[M].reloadTilesForDependencies(["icons","patterns"],g);this._changedImages={}}}_updateWorkerLayers(g,M){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(g),removedIds:M})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(g){if(this._checkLoaded(),fs(this,y.validateStyle(g)))return!1;(g=y.clone$2(g)).layers=Rt(g.layers);const M=function(L,z){if(!L)return[{command:gt.setStyle,args:[z]}];let U=[];try{if(!N(L.version,z.version))return[{command:gt.setStyle,args:[z]}];N(L.center,z.center)||U.push({command:gt.setCenter,args:[z.center]}),N(L.zoom,z.zoom)||U.push({command:gt.setZoom,args:[z.zoom]}),N(L.bearing,z.bearing)||U.push({command:gt.setBearing,args:[z.bearing]}),N(L.pitch,z.pitch)||U.push({command:gt.setPitch,args:[z.pitch]}),N(L.sprite,z.sprite)||U.push({command:gt.setSprite,args:[z.sprite]}),N(L.glyphs,z.glyphs)||U.push({command:gt.setGlyphs,args:[z.glyphs]}),N(L.transition,z.transition)||U.push({command:gt.setTransition,args:[z.transition]}),N(L.light,z.light)||U.push({command:gt.setLight,args:[z.light]}),N(L.fog,z.fog)||U.push({command:gt.setFog,args:[z.fog]}),N(L.projection,z.projection)||U.push({command:gt.setProjection,args:[z.projection]});const q={},Y=[];(function(ie,fe,be,Te){let xe;for(xe in fe=fe||{},ie=ie||{})ie.hasOwnProperty(xe)&&(fe.hasOwnProperty(xe)||Qe(xe,be,Te));for(xe in fe)fe.hasOwnProperty(xe)&&(ie.hasOwnProperty(xe)?N(ie[xe],fe[xe])||(ie[xe].type==="geojson"&&fe[xe].type==="geojson"&&Ai(ie,fe,xe)?be.push({command:gt.setGeoJSONSourceData,args:[xe,fe[xe].data]}):gi(xe,fe,be,Te)):Ve(xe,fe,be))})(L.sources,z.sources,Y,q);const J=[];L.layers&&L.layers.forEach(ie=>{q[ie.source]?U.push({command:gt.removeLayer,args:[ie.id]}):J.push(ie)});let ee=L.terrain;ee&&q[ee.source]&&(U.push({command:gt.setTerrain,args:[void 0]}),ee=void 0),U=U.concat(Y),N(ee,z.terrain)||U.push({command:gt.setTerrain,args:[z.terrain]}),function(ie,fe,be){fe=fe||[];const Te=(ie=ie||[]).map(wi),xe=fe.map(wi),Ie=ie.reduce(Ei,{}),ve=fe.reduce(Ei,{}),ke=Te.slice(),De=Object.create(null);let Ee,Pe,Oe,Je,Ke,rt,nt;for(Ee=0,Pe=0;Ee<Te.length;Ee++)Oe=Te[Ee],ve.hasOwnProperty(Oe)?Pe++:(be.push({command:gt.removeLayer,args:[Oe]}),ke.splice(ke.indexOf(Oe,Pe),1));for(Ee=0,Pe=0;Ee<xe.length;Ee++)Oe=xe[xe.length-1-Ee],ke[ke.length-1-Ee]!==Oe&&(Ie.hasOwnProperty(Oe)?(be.push({command:gt.removeLayer,args:[Oe]}),ke.splice(ke.lastIndexOf(Oe,ke.length-Pe),1)):Pe++,rt=ke[ke.length-Ee],be.push({command:gt.addLayer,args:[ve[Oe],rt]}),ke.splice(ke.length-Ee,0,Oe),De[Oe]=!0);for(Ee=0;Ee<xe.length;Ee++)if(Oe=xe[Ee],Je=Ie[Oe],Ke=ve[Oe],!De[Oe]&&!N(Je,Ke))if(N(Je.source,Ke.source)&&N(Je["source-layer"],Ke["source-layer"])&&N(Je.type,Ke.type)){for(nt in ri(Je.layout,Ke.layout,be,Oe,null,gt.setLayoutProperty),ri(Je.paint,Ke.paint,be,Oe,null,gt.setPaintProperty),N(Je.filter,Ke.filter)||be.push({command:gt.setFilter,args:[Oe,Ke.filter]}),N(Je.minzoom,Ke.minzoom)&&N(Je.maxzoom,Ke.maxzoom)||be.push({command:gt.setLayerZoomRange,args:[Oe,Ke.minzoom,Ke.maxzoom]}),Je)Je.hasOwnProperty(nt)&&nt!=="layout"&&nt!=="paint"&&nt!=="filter"&&nt!=="metadata"&&nt!=="minzoom"&&nt!=="maxzoom"&&(nt.indexOf("paint.")===0?ri(Je[nt],Ke[nt],be,Oe,nt.slice(6),gt.setPaintProperty):N(Je[nt],Ke[nt])||be.push({command:gt.setLayerProperty,args:[Oe,nt,Ke[nt]]}));for(nt in Ke)Ke.hasOwnProperty(nt)&&!Je.hasOwnProperty(nt)&&nt!=="layout"&&nt!=="paint"&&nt!=="filter"&&nt!=="metadata"&&nt!=="minzoom"&&nt!=="maxzoom"&&(nt.indexOf("paint.")===0?ri(Je[nt],Ke[nt],be,Oe,nt.slice(6),gt.setPaintProperty):N(Je[nt],Ke[nt])||be.push({command:gt.setLayerProperty,args:[Oe,nt,Ke[nt]]}))}else be.push({command:gt.removeLayer,args:[Oe]}),rt=ke[ke.lastIndexOf(Oe)+1],be.push({command:gt.addLayer,args:[Ke,rt]})}(J,z.layers,U)}catch(q){console.warn("Unable to compute style diff:",q),U=[{command:gt.setStyle,args:[z]}]}return U}(this.serialize(),g).filter(L=>!(L.command in Oh));if(M.length===0)return!1;const C=M.filter(L=>!(L.command in dl));if(C.length>0)throw new Error(`Unimplemented: ${C.map(L=>L.command).join(", ")}.`);return M.forEach(L=>{L.command!=="setTransition"&&this[L.command].apply(this,L.args)}),this.stylesheet=g,!0}addImage(g,M){if(this.getImage(g))return this.fire(new y.ErrorEvent(new Error("An image with this name already exists.")));this.imageManager.addImage(g,M),this._afterImageUpdated(g)}updateImage(g,M){this.imageManager.updateImage(g,M)}getImage(g){return this.imageManager.getImage(g)}removeImage(g){if(!this.getImage(g))return this.fire(new y.ErrorEvent(new Error("No image with this name exists.")));this.imageManager.removeImage(g),this._afterImageUpdated(g)}_afterImageUpdated(g){this._availableImages=this.imageManager.listImages(),this._changedImages[g]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new y.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(g,M,C={}){if(this._checkLoaded(),this.getSource(g)!==void 0)throw new Error("There is already a source with this ID");if(!M.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(M).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(M.type)>=0&&this._validate(y.validateStyle.source,`sources.${g}`,M,null,C))return;this.map&&this.map._collectResourceTiming&&(M.collectResourceTiming=!0);const L=re(g,M,this.dispatcher,this);L.setEventedParent(this,()=>({isSourceLoaded:this.loaded(),source:L.serialize(),sourceId:g}));const z=U=>{const q=(U?"symbol:":"other:")+g,Y=this._sourceCaches[q]=new y.SourceCache(q,L,U);(U?this._symbolSourceCaches:this._otherSourceCaches)[g]=Y,Y.style=this,Y.onAdd(this.map)};z(!1),M.type!=="vector"&&M.type!=="geojson"||z(!0),L.onAdd&&L.onAdd(this.map),this._changed=!0}removeSource(g){this._checkLoaded();const M=this.getSource(g);if(M===void 0)throw new Error("There is no source with this ID");for(const L in this._layers)if(this._layers[L].source===g)return this.fire(new y.ErrorEvent(new Error(`Source "${g}" cannot be removed while layer "${L}" is using it.`)));if(this.terrain&&this.terrain.get().source===g)return this.fire(new y.ErrorEvent(new Error(`Source "${g}" cannot be removed while terrain is using it.`)));const C=this._getSourceCaches(g);for(const L of C)delete this._sourceCaches[L.id],delete this._updatedSources[L.id],L.fire(new y.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:L.getSource().id})),L.setEventedParent(null),L.clearTiles();delete this._otherSourceCaches[g],delete this._symbolSourceCaches[g],M.setEventedParent(null),M.onRemove&&M.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(g,M){this._checkLoaded(),this.getSource(g).setData(M),this._changed=!0}getSource(g){const M=this._getSourceCache(g);return M&&M.getSource()}addLayer(g,M,C={}){this._checkLoaded();const L=g.id;if(this.getLayer(L))return void this.fire(new y.ErrorEvent(new Error(`Layer with id "${L}" already exists on this map`)));let z;if(g.type==="custom"){if(fs(this,y.validateCustomStyleLayer(g)))return;z=y.createStyleLayer(g)}else{if(typeof g.source=="object"&&(this.addSource(L,g.source),g=y.clone$2(g),g=y.extend(g,{source:L})),this._validate(y.validateStyle.layer,`layers.${L}`,g,{arrayIndex:-1},C))return;z=y.createStyleLayer(g),this._validateLayer(z),z.setEventedParent(this,{layer:{id:L}}),this._serializedLayers[z.id]=z.serialize(),this._updateLayerCount(z,!0)}const U=M?this._order.indexOf(M):this._order.length;if(M&&U===-1)return void this.fire(new y.ErrorEvent(new Error(`Layer with id "${M}" does not exist on this map.`)));this._order.splice(U,0,L),this._layerOrderChanged=!0,this._layers[L]=z;const q=this._getLayerSourceCache(z);if(this._removedLayers[L]&&z.source&&q&&z.type!=="custom"){const Y=this._removedLayers[L];delete this._removedLayers[L],Y.type!==z.type?this._updatedSources[z.source]="clear":(this._updatedSources[z.source]="reload",q.pause())}this._updateLayer(z),z.onAdd&&z.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(g,M){if(this._checkLoaded(),this._changed=!0,!this._layers[g])return void this.fire(new y.ErrorEvent(new Error(`The layer '${g}' does not exist in the map's style and cannot be moved.`)));if(g===M)return;const C=this._order.indexOf(g);this._order.splice(C,1);const L=M?this._order.indexOf(M):this._order.length;M&&L===-1?this.fire(new y.ErrorEvent(new Error(`Layer with id "${M}" does not exist on this map.`))):(this._order.splice(L,0,g),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(g){this._checkLoaded();const M=this._layers[g];if(!M)return void this.fire(new y.ErrorEvent(new Error(`The layer '${g}' does not exist in the map's style and cannot be removed.`)));M.setEventedParent(null),this._updateLayerCount(M,!1);const C=this._order.indexOf(g);this._order.splice(C,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[g]=M,delete this._layers[g],delete this._serializedLayers[g],delete this._updatedLayers[g],delete this._updatedPaintProps[g],M.onRemove&&M.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(g){return this._layers[g]}hasLayer(g){return g in this._layers}hasLayerType(g){for(const M in this._layers)if(this._layers[M].type===g)return!0;return!1}setLayerZoomRange(g,M,C){this._checkLoaded();const L=this.getLayer(g);L?L.minzoom===M&&L.maxzoom===C||(M!=null&&(L.minzoom=M),C!=null&&(L.maxzoom=C),this._updateLayer(L)):this.fire(new y.ErrorEvent(new Error(`The layer '${g}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(g,M,C={}){this._checkLoaded();const L=this.getLayer(g);if(L){if(!N(L.filter,M))return M==null?(L.filter=void 0,void this._updateLayer(L)):void(this._validate(y.validateStyle.filter,`layers.${L.id}.filter`,M,{layerType:L.type},C)||(L.filter=y.clone$2(M),this._updateLayer(L)))}else this.fire(new y.ErrorEvent(new Error(`The layer '${g}' does not exist in the map's style and cannot be filtered.`)))}getFilter(g){return y.clone$2(this.getLayer(g).filter)}setLayoutProperty(g,M,C,L={}){this._checkLoaded();const z=this.getLayer(g);z?N(z.getLayoutProperty(M),C)||(z.setLayoutProperty(M,C,L),this._updateLayer(z)):this.fire(new y.ErrorEvent(new Error(`The layer '${g}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(g,M){const C=this.getLayer(g);if(C)return C.getLayoutProperty(M);this.fire(new y.ErrorEvent(new Error(`The layer '${g}' does not exist in the map's style.`)))}setPaintProperty(g,M,C,L={}){this._checkLoaded();const z=this.getLayer(g);z?N(z.getPaintProperty(M),C)||(z.setPaintProperty(M,C,L)&&this._updateLayer(z),this._changed=!0,this._updatedPaintProps[g]=!0):this.fire(new y.ErrorEvent(new Error(`The layer '${g}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(g,M){return this.getLayer(g).getPaintProperty(M)}setFeatureState(g,M){this._checkLoaded();const C=g.source,L=g.sourceLayer,z=this.getSource(C);if(z===void 0)return void this.fire(new y.ErrorEvent(new Error(`The source '${C}' does not exist in the map's style.`)));const U=z.type;if(U==="geojson"&&L)return void this.fire(new y.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(U==="vector"&&!L)return void this.fire(new y.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));g.id===void 0&&this.fire(new y.ErrorEvent(new Error("The feature id parameter must be provided.")));const q=this._getSourceCaches(C);for(const Y of q)Y.setFeatureState(L,g.id,M)}removeFeatureState(g,M){this._checkLoaded();const C=g.source,L=this.getSource(C);if(L===void 0)return void this.fire(new y.ErrorEvent(new Error(`The source '${C}' does not exist in the map's style.`)));const z=L.type,U=z==="vector"?g.sourceLayer:void 0;if(z==="vector"&&!U)return void this.fire(new y.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(M&&typeof g.id!="string"&&typeof g.id!="number")return void this.fire(new y.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const q=this._getSourceCaches(C);for(const Y of q)Y.removeFeatureState(U,g.id,M)}getFeatureState(g){this._checkLoaded();const M=g.source,C=g.sourceLayer,L=this.getSource(M);if(L!==void 0){if(L.type!=="vector"||C)return g.id===void 0&&this.fire(new y.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(M)[0].getFeatureState(C,g.id);this.fire(new y.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new y.ErrorEvent(new Error(`The source '${M}' does not exist in the map's style.`)))}getTransition(){return y.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const g={};for(const M in this._sourceCaches){const C=this._sourceCaches[M].getSource();g[C.id]||(g[C.id]=C.serialize())}return y.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.stylesheet.terrain,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:g,layers:this._serializeLayers(this._order)},M=>M!==void 0)}_updateLayer(g){this._updatedLayers[g.id]=!0;const M=this._getLayerSourceCache(g);g.source&&!this._updatedSources[g.source]&&M&&M.getSource().type!=="raster"&&(this._updatedSources[g.source]="reload",M.pause()),this._changed=!0,g.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(g){const M=U=>this._layers[U].type==="fill-extrusion",C={},L=[];for(let U=this._order.length-1;U>=0;U--){const q=this._order[U];if(M(q)){C[q]=U;for(const Y of g){const J=Y[q];if(J)for(const ee of J)L.push(ee)}}}L.sort((U,q)=>q.intersectionZ-U.intersectionZ);const z=[];for(let U=this._order.length-1;U>=0;U--){const q=this._order[U];if(M(q))for(let Y=L.length-1;Y>=0;Y--){const J=L[Y].feature;if(C[J.layer.id]<U)break;z.push(J),L.pop()}else for(const Y of g){const J=Y[q];if(J)for(const ee of J)z.push(ee.feature)}}return z}queryRenderedFeatures(g,M,C){M&&M.filter&&this._validate(y.validateStyle.filter,"queryRenderedFeatures.filter",M.filter,null,M);const L={};if(M&&M.layers){if(!Array.isArray(M.layers))return this.fire(new y.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const Y of M.layers){const J=this._layers[Y];if(!J)return this.fire(new y.ErrorEvent(new Error(`The layer '${Y}' does not exist in the map's style and cannot be queried for features.`))),[];L[J.source]=!0}}const z=[];M.availableImages=this._availableImages;const U=M&&M.layers?M.layers.some(Y=>{const J=this.getLayer(Y);return J&&J.is3D()}):this.has3DLayers(),q=Xt.createFromScreenPoints(g,C);for(const Y in this._sourceCaches){const J=this._sourceCaches[Y].getSource().id;M.layers&&!L[J]||z.push(Ae(this._sourceCaches[Y],this._layers,this._serializedLayers,q,M,C,U,!!this.map._showQueryGeometry))}return this.placement&&z.push(function(Y,J,ee,ie,fe,be,Te){const xe={},Ie=be.queryRenderedSymbols(ie),ve=[];for(const ke of Object.keys(Ie).map(Number))ve.push(Te[ke]);ve.sort(Ne);for(const ke of ve){const De=ke.featureIndex.lookupSymbolFeatures(Ie[ke.bucketInstanceId],J,ke.bucketIndex,ke.sourceLayerIndex,fe.filter,fe.layers,fe.availableImages,Y);for(const Ee in De){const Pe=xe[Ee]=xe[Ee]||[],Oe=De[Ee];Oe.sort((Je,Ke)=>{const rt=ke.featureSortOrder;if(rt){const nt=rt.indexOf(Je.featureIndex);return rt.indexOf(Ke.featureIndex)-nt}return Ke.featureIndex-Je.featureIndex});for(const Je of Oe)Pe.push(Je)}}for(const ke in xe)xe[ke].forEach(De=>{const Ee=De.feature,Pe=ee(Y[ke]).getFeatureState(Ee.layer["source-layer"],Ee.id);Ee.source=Ee.layer.source,Ee.layer["source-layer"]&&(Ee.sourceLayer=Ee.layer["source-layer"]),Ee.state=Pe});return xe}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),q.screenGeometry,M,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(z)}querySourceFeatures(g,M){M&&M.filter&&this._validate(y.validateStyle.filter,"querySourceFeatures.filter",M.filter,null,M);const C=this._getSourceCaches(g);let L=[];for(const z of C)L=L.concat(Be(z,M));return L}addSourceType(g,M,C){return Yr.getSourceType(g)?C(new Error(`A source type called "${g}" already exists.`)):(Yr.setSourceType(g,M),M.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:g,url:M.workerSourceURL},C):C(null,null))}getLight(){return this.light.getLight()}setLight(g,M={}){this._checkLoaded();const C=this.light.getLight();let L=!1;for(const U in g)if(!N(g[U],C[U])){L=!0;break}if(!L)return;const z={now:y.exported.now(),transition:y.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(g,M),this.light.updateTransitions(z)}getTerrain(){return this.terrain?this.terrain.get():null}setTerrain(g){if(this._checkLoaded(),!g)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(typeof g.source=="object"){const M="terrain-dem-src";this.addSource(M,g.source),g=y.clone$2(g),g=y.extend(g,{source:M})}if(!this._validate(y.validateStyle.terrain,"terrain",g)){if(this.terrain){const M=this.terrain,C=M.get();for(const L in g)if(!N(g[L],C[L])){M.set(g),this.stylesheet.terrain=g;const z={now:y.exported.now(),transition:y.extend({duration:0},this.stylesheet.transition)};M.updateTransitions(z);break}}else this._createTerrain(g);this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}}_createFog(g){const M=this.fog=new Gt(g,this.map.transform);this.stylesheet.fog=g;const C={now:y.exported.now(),transition:y.extend({duration:0},this.stylesheet.transition)};M.updateTransitions(C)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const g of this.map._markers)g._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(g){if(this._checkLoaded(),!g)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const M=this.fog,C=M.get();for(const L in g)if(!N(g[L],C[L])){M.set(g),this.stylesheet.fog=g;const z={now:y.exported.now(),transition:y.extend({duration:0},this.stylesheet.transition)};M.updateTransitions(z);break}}else this._createFog(g);this._markersNeedUpdate=!0}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const g=this._order.filter(C=>this.isLayerDraped(this._layers[C])),M=this._order.filter(C=>!this.isLayerDraped(this._layers[C]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...g),this._drapedFirstOrder.push(...M)}_createTerrain(g){const M=this.terrain=new lt(g);this.stylesheet.terrain=g,this.dispatcher.broadcast("enableTerrain",!0),this._force3DLayerUpdate();const C={now:y.exported.now(),transition:y.extend({duration:0},this.stylesheet.transition)};M.updateTransitions(C)}_force3DLayerUpdate(){for(const g in this._layers){const M=this._layers[g];M.type==="fill-extrusion"&&this._updateLayer(M)}}_validate(g,M,C,L,z={}){return(!z||z.validate!==!1)&&fs(this,g.call(y.validateStyle,y.extend({key:M,style:this.serialize(),value:C,styleSpec:y.spec},L)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),y.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const g in this._layers)this._layers[g].setEventedParent(null);for(const g in this._sourceCaches)this._sourceCaches[g].clearTiles(),this._sourceCaches[g].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(g){const M=this._getSourceCaches(g);for(const C of M)C.clearTiles()}_reloadSource(g){const M=this._getSourceCaches(g);for(const C of M)C.resume(),C.reload()}_updateSources(g){for(const M in this._sourceCaches)this._sourceCaches[M].update(g)}_generateCollisionBoxes(){for(const g in this._sourceCaches){const M=this._sourceCaches[g];M.resume(),M.reload()}}_updatePlacement(g,M,C,L,z=!1){let U=!1,q=!1;const Y={};for(const J of this._order){const ee=this._layers[J];if(ee.type!=="symbol")continue;if(!Y[ee.source]){const fe=this._getLayerSourceCache(ee);if(!fe)continue;Y[ee.source]=fe.getRenderableIds(!0).map(be=>fe.getTileByID(be)).sort((be,Te)=>Te.tileID.overscaledZ-be.tileID.overscaledZ||(be.tileID.isLessThan(Te.tileID)?-1:1))}const ie=this.crossTileSymbolIndex.addLayer(ee,Y[ee.source],g.center.lng);U=U||ie}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),z=z||this._layerOrderChanged||C===0,this._layerOrderChanged&&this.fire(new y.Event("neworder")),(z||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(y.exported.now(),g.zoom))&&(this.pauseablePlacement=new wn(g,this._order,z,M,C,L,this.placement,this.fog&&!this.fog.isSoftDisabled()?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,Y),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(y.exported.now()),q=!0),U&&this.pauseablePlacement.placement.setStale()),q||U)for(const J of this._order){const ee=this._layers[J];ee.type==="symbol"&&this.placement.updateLayerOpacities(ee,Y[ee.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(y.exported.now())}_releaseSymbolFadeTiles(){for(const g in this._sourceCaches)this._sourceCaches[g].releaseSymbolFadeTiles()}getImages(g,M,C){this.imageManager.getImages(M.icons,C),this._updateTilesForChangedImages();const L=z=>{z&&z.setDependencies(M.tileID.key,M.type,M.icons)};L(this._otherSourceCaches[M.source]),L(this._symbolSourceCaches[M.source])}getGlyphs(g,M,C){this.glyphManager.getGlyphs(M.stacks,C)}getResource(g,M,C){return y.makeRequest(M,C)}_getSourceCache(g){return this._otherSourceCaches[g]}_getLayerSourceCache(g){return g.type==="symbol"?this._symbolSourceCaches[g.source]:this._otherSourceCaches[g.source]}_getSourceCaches(g){const M=[];return this._otherSourceCaches[g]&&M.push(this._otherSourceCaches[g]),this._symbolSourceCaches[g]&&M.push(this._symbolSourceCaches[g]),M}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}}Yr.getSourceType=function(I){return K[I]},Yr.setSourceType=function(I,g){K[I]=g},Yr.registerForPluginStateChange=y.registerForPluginStateChange;var da=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}
#endif`,fa="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}";let Do={},io={};Do=Si("",`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else 
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform sampler2D u_dem;uniform sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {return currentElevation(apos);}
#endif
float unpack_depth(vec4 rgba_depth)
{const vec4 bit_shift=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,!0),io=Si(`#ifdef FOG
uniform float u_fog_temporal_offset;float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,`#ifdef FOG
uniform mat4 u_fog_matrix;vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,!0);const En=Si(`
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef TERRAIN
highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(256.0*256.0*256.0,256.0*256.0,256.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/256.0,1.0/256.0,1.0/256.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#endif`,`
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {
#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)
return mix(globe,mercator,t);
#else
return globe;
#endif
}vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),ro=da;var ps={background:Si(`uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Si(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:Si(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float height=circle_elevation(circle_center);vec4 world_center=vec4(circle_center,height,1);vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);vec4 occlusion_world_center=vec4(circle_center,cantilevered_height,1);vec4 occlusion_projected_center=u_matrix*occlusion_world_center;
#else
vec4 occlusion_world_center=world_center;vec4 occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Si("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Si(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
extrude*=a_scale;vec3 normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));vec3 globePos=a_pos_3+xAxis*extrude.x+yAxis*extrude.y+elevationVector(tilePos)*elevation(tilePos);vec3 mercPos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+xAxis*extrude.x+yAxis*extrude.y;vec3 pos=mix_globe_mercator(globePos,mercPos,u_zoom_transition);
#else
vec3 pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Si(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Si("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Si("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Si("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);}"),fill:Si(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:Si(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Si(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Si(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Si(`varying vec4 v_color;void main() {vec4 color=v_color;
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 pos=vec3(pos_nx.xy,h);
#else
vec3 pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionPattern:Si(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 p=vec3(pos_nx.xy,h);
#else
vec3 p=vec3(pos_nx.xy,z);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),hillshadePrepare:Si(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Si(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Si(`uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
#ifdef RENDER_LINE_GRADIENT
vec4 out_color=texture2D(u_gradient_image,v_uv);
#else
vec4 out_color=color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#ifdef RENDER_LINE_GRADIENT
attribute vec3 a_packed;
#else
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_GRADIENT
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];float a_linesofar=a_packed[2];highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);
#endif
#ifdef RENDER_LINE_DASH
float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:Si(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:Si(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:Si(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}`),symbolSDF:Si(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}`),symbolTextAndIcon:Si(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}`),terrainRaster:Si(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
void main() {vec4 color=texture2D(u_image0,v_pos0);
#ifdef FOG
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
const float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;
#ifdef TERRAIN_WIREFRAME
elevation+=u_skirt_height*u_skirt_height*wireframeOffset;
#endif
vec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
}`),terrainDepth:Si(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:Si(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,fa),skyboxGradient:Si(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,fa),skyboxCapture:Si(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Si(`uniform sampler2D u_image0;varying vec2 v_pos0;void main() {vec4 color=texture2D(u_image0,v_pos0);gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_proj_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat4 u_up_vector_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;attribute vec3 a_globe_pos;attribute vec2 a_merc_pos;attribute vec2 a_uv;varying vec2 v_pos0;void main() {v_pos0=a_uv;vec2 uv=a_uv*EXTENT;vec4 up_vector=u_up_vector_matrix*vec4(elevationVector(uv),1.0);float height=elevation(uv);vec4 globe=u_globe_matrix*vec4(a_globe_pos+up_vector.xyz*height,1.0);vec4 mercator=vec4(a_merc_pos,height,1.0);mercator.xy-=u_merc_center;mercator.x=wrap(mercator.x,-0.5,0.5);mercator=u_merc_matrix*mercator;vec3 position=mix(globe.xyz,mercator.xyz,u_zoom_transition);gl_Position=u_proj_matrix*vec4(position,1.0);}"),globeAtmosphere:Si(`uniform vec2 u_center;uniform float u_radius;uniform vec2 u_screen_size;uniform float u_opacity;uniform highp float u_fadeout_range;uniform vec3 u_start_color;uniform vec3 u_end_color;uniform float u_pixel_ratio;void main() {highp vec2 fragCoord=gl_FragCoord.xy/u_pixel_ratio;fragCoord.y=u_screen_size.y-fragCoord.y;float distFromCenter=length(fragCoord-u_center);float normDistFromCenter=length(fragCoord-u_center)/u_radius;if (normDistFromCenter < 1.0)
discard;float t=clamp(1.0-sqrt(normDistFromCenter-1.0)/u_fadeout_range,0.0,1.0);vec3 color=mix(u_start_color,u_end_color,1.0-t);gl_FragColor=vec4(color*t*u_opacity,u_opacity);}`,"attribute vec3 a_pos;void main() {gl_Position=vec4(a_pos,1.0);}"),globeDepth:Si(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_proj_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat4 u_up_vector_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;attribute vec3 a_globe_pos;attribute vec2 a_merc_pos;attribute vec2 a_uv;varying float v_depth;void main() {vec2 uv=a_uv*EXTENT;vec4 up_vector=u_up_vector_matrix*vec4(elevationVector(uv),1.0);float height=elevation(uv);vec4 globe=u_globe_matrix*vec4(a_globe_pos+up_vector.xyz*height,1.0);vec4 mercator=vec4(a_merc_pos,height,1.0);mercator.xy-=u_merc_center;mercator.x=wrap(mercator.x,-0.5,0.5);mercator=u_merc_matrix*mercator;vec3 position=mix(globe.xyz,mercator.xyz,u_zoom_transition);gl_Position=u_proj_matrix*vec4(position,1.0);v_depth=gl_Position.z/gl_Position.w;}")};function Si(I,g,M){const C=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,L=/uniform (highp |mediump |lowp )?([\w]+) ([\w]+)([\s]*)([\w]*)/g,z=g.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),U=I.match(L),q=g.match(L),Y=da.match(L);let J=q?q.concat(U):U;M||(Do.staticUniforms&&(J=Do.staticUniforms.concat(J)),io.staticUniforms&&(J=io.staticUniforms.concat(J))),J&&(J=J.concat(Y));const ee={};return{fragmentSource:I=I.replace(C,(ie,fe,be,Te,xe)=>(ee[xe]=!0,fe==="define"?`
#ifndef HAS_UNIFORM_u_${xe}
varying ${be} ${Te} ${xe};
#else
uniform ${be} ${Te} u_${xe};
#endif
`:`
#ifdef HAS_UNIFORM_u_${xe}
    ${be} ${Te} ${xe} = u_${xe};
#endif
`)),vertexSource:g=g.replace(C,(ie,fe,be,Te,xe)=>{const Ie=Te==="float"?"vec2":"vec4",ve=xe.match(/color/)?"color":Ie;return ee[xe]?fe==="define"?`
#ifndef HAS_UNIFORM_u_${xe}
uniform lowp float u_${xe}_t;
attribute ${be} ${Ie} a_${xe};
varying ${be} ${Te} ${xe};
#else
uniform ${be} ${Te} u_${xe};
#endif
`:ve==="vec4"?`
#ifndef HAS_UNIFORM_u_${xe}
    ${xe} = a_${xe};
#else
    ${be} ${Te} ${xe} = u_${xe};
#endif
`:`
#ifndef HAS_UNIFORM_u_${xe}
    ${xe} = unpack_mix_${ve}(a_${xe}, u_${xe}_t);
#else
    ${be} ${Te} ${xe} = u_${xe};
#endif
`:fe==="define"?`
#ifndef HAS_UNIFORM_u_${xe}
uniform lowp float u_${xe}_t;
attribute ${be} ${Ie} a_${xe};
#else
uniform ${be} ${Te} u_${xe};
#endif
`:ve==="vec4"?`
#ifndef HAS_UNIFORM_u_${xe}
    ${be} ${Te} ${xe} = a_${xe};
#else
    ${be} ${Te} ${xe} = u_${xe};
#endif
`:`
#ifndef HAS_UNIFORM_u_${xe}
    ${be} ${Te} ${xe} = unpack_mix_${ve}(a_${xe}, u_${xe}_t);
#else
    ${be} ${Te} ${xe} = u_${xe};
#endif
`}),staticAttributes:z,staticUniforms:J}}class ms{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(g,M,C,L,z,U,q,Y){this.context=g;let J=this.boundPaintVertexBuffers.length!==L.length;for(let ee=0;!J&&ee<L.length;ee++)this.boundPaintVertexBuffers[ee]!==L[ee]&&(J=!0);g.extVertexArrayObject&&this.vao&&this.boundProgram===M&&this.boundLayoutVertexBuffer===C&&!J&&this.boundIndexBuffer===z&&this.boundVertexOffset===U&&this.boundDynamicVertexBuffer===q&&this.boundDynamicVertexBuffer2===Y?(g.bindVertexArrayOES.set(this.vao),q&&q.bind(),z&&z.dynamicDraw&&z.bind(),Y&&Y.bind()):this.freshBind(M,C,L,z,U,q,Y)}freshBind(g,M,C,L,z,U,q){let Y;const J=g.numAttributes,ee=this.context,ie=ee.gl;if(ee.extVertexArrayObject)this.vao&&this.destroy(),this.vao=ee.extVertexArrayObject.createVertexArrayOES(),ee.bindVertexArrayOES.set(this.vao),Y=0,this.boundProgram=g,this.boundLayoutVertexBuffer=M,this.boundPaintVertexBuffers=C,this.boundIndexBuffer=L,this.boundVertexOffset=z,this.boundDynamicVertexBuffer=U,this.boundDynamicVertexBuffer2=q;else{Y=ee.currentNumAttributes||0;for(let fe=J;fe<Y;fe++)ie.disableVertexAttribArray(fe)}M.enableAttributes(ie,g);for(const fe of C)fe.enableAttributes(ie,g);U&&U.enableAttributes(ie,g),q&&q.enableAttributes(ie,g),M.bind(),M.setVertexAttribPointers(ie,g,z);for(const fe of C)fe.bind(),fe.setVertexAttribPointers(ie,g,z);U&&(U.bind(),U.setVertexAttribPointers(ie,g,z)),L&&L.bind(),q&&(q.bind(),q.setVertexAttribPointers(ie,g,z)),ee.currentNumAttributes=J}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function gs(I,g){const M=Math.pow(2,g.canonical.z),C=g.canonical.y;return[new y.MercatorCoordinate(0,C/M).toLngLat().lat,new y.MercatorCoordinate(0,(C+1)/M).toLngLat().lat]}function pa(I,g,M,C,L,z,U){const q=I.context,Y=q.gl,J=M.fbo;if(!J)return;I.prepareDrawTile(g);const ee=I.useProgram("hillshade");q.activeTexture.set(Y.TEXTURE0),Y.bindTexture(Y.TEXTURE_2D,J.colorAttachment.get());const ie=((xe,Ie,ve,ke)=>{const De=ve.paint.get("hillshade-shadow-color"),Ee=ve.paint.get("hillshade-highlight-color"),Pe=ve.paint.get("hillshade-accent-color");let Oe=ve.paint.get("hillshade-illumination-direction")*(Math.PI/180);ve.paint.get("hillshade-illumination-anchor")==="viewport"&&(Oe-=xe.transform.angle);const Je=!xe.options.moving;return{u_matrix:ke||xe.transform.calculateProjMatrix(Ie.tileID.toUnwrapped(),Je),u_image:0,u_latrange:gs(0,Ie.tileID),u_light:[ve.paint.get("hillshade-exaggeration"),Oe],u_shadow:De,u_highlight:Ee,u_accent:Pe}})(I,M,C,I.terrain?g.projMatrix:null);I.prepareDrawProgram(q,ee,g.toUnwrapped());const{tileBoundsBuffer:fe,tileBoundsIndexBuffer:be,tileBoundsSegments:Te}=I.getTileBoundsBuffers(M);ee.draw(q,Y.TRIANGLES,L,z,U,y.CullFaceMode.disabled,ie,C.id,fe,be,Te)}function Po(I,g,M){if(!g.needsDEMTextureUpload)return;const C=I.context,L=C.gl;C.pixelStoreUnpackPremultiplyAlpha.set(!1),g.demTexture=g.demTexture||I.getTileTexture(M.stride);const z=M.getPixels();g.demTexture?g.demTexture.update(z,{premultiply:!1}):g.demTexture=new y.Texture(C,z,L.RGBA,{premultiply:!1}),g.needsDEMTextureUpload=!1}function Ro(I,g,M,C,L,z){const U=I.context,q=U.gl;if(!g.dem)return;const Y=g.dem;if(U.activeTexture.set(q.TEXTURE1),Po(I,g,Y),!g.demTexture)return;g.demTexture.bind(q.NEAREST,q.CLAMP_TO_EDGE);const J=Y.dim;U.activeTexture.set(q.TEXTURE0);let ee=g.fbo;if(!ee){const Te=new y.Texture(U,{width:J,height:J,data:null},q.RGBA);Te.bind(q.LINEAR,q.CLAMP_TO_EDGE),ee=g.fbo=U.createFramebuffer(J,J,!0),ee.colorAttachment.set(Te.texture)}U.bindFramebuffer.set(ee.framebuffer),U.viewport.set([0,0,J,J]);const{tileBoundsBuffer:ie,tileBoundsIndexBuffer:fe,tileBoundsSegments:be}=I.getMercatorTileBoundsBuffers();I.useProgram("hillshadePrepare").draw(U,q.TRIANGLES,C,L,z,y.CullFaceMode.disabled,((Te,xe)=>{const Ie=xe.stride,ve=y.create$1();return y.ortho(ve,0,y.EXTENT,-y.EXTENT,0,0,1),y.translate(ve,ve,[0,-y.EXTENT,0]),{u_matrix:ve,u_image:1,u_dimension:[Ie,Ie],u_zoom:Te.overscaledZ,u_unpack:xe.unpackVector}})(g.tileID,Y),M.id,ie,fe,be),g.needsHillshadePrepare=!1}const Pi=(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_image0:new y.Uniform1i(I,g.u_image0),u_skirt_height:new y.Uniform1f(I,g.u_skirt_height)}),Bo=(I,g)=>({u_matrix:I,u_image0:0,u_skirt_height:g}),_s=new class{constructor(){this.operations={}}newMorphing(I,g,M,C,L){if(I in this.operations){const z=this.operations[I];z.to.tileID.key!==M.tileID.key&&(z.queued=M)}else this.operations[I]={startTime:C,phase:0,duration:L,from:g,to:M,queued:null}}getMorphValuesForProxy(I){if(!(I in this.operations))return null;const g=this.operations[I];return{from:g.from,to:g.to,phase:g.phase}}update(I){for(const g in this.operations){const M=this.operations[g];for(M.phase=(I-M.startTime)/M.duration;M.phase>=1||!this._validOp(M);)if(!this._nextOp(M,I)){delete this.operations[g];break}}}_nextOp(I,g){return!!I.queued&&(I.from=I.to,I.to=I.queued,I.queued=null,I.phase=0,I.startTime=g,!0)}_validOp(I){return I.from.hasData()&&I.to.hasData()}},ma={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function pl(I,g){const M=1<<I.z;return!g&&(I.x===0||I.x===M-1)||I.y===0||I.y===M-1}const Lo=I=>({u_matrix:I});function ga(I,g,M,C,L){if(L>0){const z=y.exported.now(),U=(z-I.timeAdded)/L,q=g?(z-g.timeAdded)/L:-1,Y=M.getSource(),J=C.coveringZoomLevel({tileSize:Y.tileSize,roundZoom:Y.roundZoom}),ee=!g||Math.abs(g.tileID.overscaledZ-J)>Math.abs(I.tileID.overscaledZ-J),ie=ee&&I.refreshedUponExpiration?1:y.clamp(ee?U:1-q,0,1);return I.refreshedUponExpiration&&U>=1&&(I.refreshedUponExpiration=!1),g?{opacity:1,mix:1-ie}:{opacity:ie,mix:0}}return{opacity:1,mix:0}}class Nh extends y.SourceCache{constructor(g){const M=re("proxy",{type:"geojson",maxzoom:g.transform.maxZoom},new Dt(pt(),null),g.style);super("proxy",M,!1),M.setEventedParent(this),this.map=this.getSource().map=g,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(g,M,C){if(g.freezeTileCoverage)return;this.transform=g;const L=g.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((z,U)=>{if(z[U.key]="",!this._tiles[U.key]){const q=new y.Tile(U,this._source.tileSize*U.overscaleFactor(),g.tileZoom);q.state="loaded",this._tiles[U.key]=q}return z},{});for(const z in this._tiles)z in L||(this.freeFBO(z),this._tiles[z].unloadVectorData(),delete this._tiles[z])}freeFBO(g){const M=this.proxyCachedFBO[g];if(M!==void 0){const C=Object.values(M);this.renderCachePool.push(...C),delete this.proxyCachedFBO[g]}}deallocRenderCache(){this.renderCache.forEach(g=>g.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class ml extends y.OverscaledTileID{constructor(g,M,C){super(g.overscaledZ,g.wrap,g.canonical.z,g.canonical.x,g.canonical.y),this.proxyTileKey=M,this.projMatrix=C}}class _a extends y.Elevation{constructor(g,M){super(),this.painter=g,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[C,L,z]=function(Y){const J=new y.StructArrayLayout4i8,ee=new y.StructArrayLayout3ui6,ie=131;J.reserve(17161),ee.reserve(33800);const fe=y.EXTENT/128,be=y.EXTENT+fe/2,Te=be+fe;for(let Ie=-fe;Ie<Te;Ie+=fe)for(let ve=-fe;ve<Te;ve+=fe){const ke=ve<0||ve>be||Ie<0||Ie>be?24575:0,De=y.clamp(Math.round(ve),0,y.EXTENT),Ee=y.clamp(Math.round(Ie),0,y.EXTENT);J.emplaceBack(De+ke,Ee,De,Ee)}const xe=(Ie,ve)=>{const ke=ve*ie+Ie;ee.emplaceBack(ke+1,ke,ke+ie),ee.emplaceBack(ke+ie,ke+ie+1,ke+1)};for(let Ie=1;Ie<129;Ie++)for(let ve=1;ve<129;ve++)xe(ve,Ie);return[0,129].forEach(Ie=>{for(let ve=0;ve<130;ve++)xe(ve,Ie),xe(Ie,ve)}),[J,ee,32768]}(),U=g.context;this.gridBuffer=U.createVertexBuffer(C,y.boundsAttributes.members),this.gridIndexBuffer=U.createIndexBuffer(L),this.gridSegments=y.SegmentVector.simpleSegment(0,0,C.length,L.length),this.gridNoSkirtSegments=y.SegmentVector.simpleSegment(0,0,C.length,z),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Nh(M.map),this.orthoMatrix=y.create$1(),y.ortho(this.orthoMatrix,0,y.EXTENT,0,y.EXTENT,0,1);const q=U.gl;this._overlapStencilMode=new y.StencilMode({func:q.GEQUAL,mask:255},0,255,q.KEEP,q.KEEP,q.REPLACE),this._previousZoom=g.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=M,this._useVertexMorphing=!0,this._exaggeration=1}set style(g){g.on("data",this._onStyleDataEvent.bind(this)),g.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=g,this._checkRenderCacheEfficiency()}update(g,M,C){if(g&&g.terrain){this._style!==g&&(this.style=g),this.enabled=!0;const L=g.terrain.properties;this.sourceCache=g._getSourceCache(L.get("source")),this._exaggeration=L.get("exaggeration");const z=()=>{this.sourceCache.used&&y.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const U=this.sourceCache.getSource().tileSize/128,q=this.proxySourceCache.getSource().tileSize;this.sourceCache.update(M,U*q,!0),this._findCoveringTileCache[this.sourceCache.id]={}};this.sourceCache.usedForTerrain||(this._findCoveringTileCache[this.sourceCache.id]={},this.sourceCache.usedForTerrain=!0,z(),this._initializing=!0),z(),M.updateElevation(!C),this._findCoveringTileCache[this.proxySourceCache.id]={},this.proxySourceCache.update(M),this._emptyDEMTextureDirty=!0}else this._disable()}_checkRenderCacheEfficiency(){const g=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||g.efficiency!==100&&y.warnOnce(`Terrain render cache efficiency is not optimal (${g.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${g.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(g){g.coord&&g.dataType==="source"?this._clearRenderCacheForTile(g.sourceCacheId,g.coord):g.dataType==="style"&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const g in this._style._sourceCaches)this._style._sourceCaches[g].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(g=>g.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture)}_source(){return this.enabled?this.sourceCache:null}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const g=2*this.proxySourceCache.getSource().tileSize;return[g,g]}set useVertexMorphing(g){this._useVertexMorphing=g}updateTileBinding(g){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const M=this.proxySourceCache,C=this.painter.transform;this._initializing&&(this._initializing=C._centerAltitude===0&&this.getAtPointOrZero(y.MercatorCoordinate.fromLngLat(C.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const L=this.proxyCoords=M.getIds().map(Y=>{const J=M.getTileByID(Y).tileID;return J.projMatrix=C.calculateProjMatrix(J.toUnwrapped()),J});(function(Y,J){const ee=J.transform.pointCoordinate(J.transform.getCameraPoint()),ie=new y.pointGeometry(ee.x,ee.y);Y.sort((fe,be)=>{if(be.overscaledZ-fe.overscaledZ)return be.overscaledZ-fe.overscaledZ;const Te=new y.pointGeometry(fe.canonical.x+(1<<fe.canonical.z)*fe.wrap,fe.canonical.y),xe=new y.pointGeometry(be.canonical.x+(1<<be.canonical.z)*be.wrap,be.canonical.y),Ie=ie.mult(1<<fe.canonical.z);return Ie.x-=.5,Ie.y-=.5,Ie.distSqr(Te)-Ie.distSqr(xe)})})(L,this.painter),this._previousZoom=C.zoom;const z=this.proxyToSource||{};this.proxyToSource={},L.forEach(Y=>{this.proxyToSource[Y.key]={}}),this.terrainTileForTile={};const U=this._style._sourceCaches;for(const Y in U){const J=U[Y];if(!J.used||(J!==this.sourceCache&&(this._findCoveringTileCache[J.id]={}),this._setupProxiedCoordsForOrtho(J,g[Y],z),J.usedForTerrain))continue;const ee=g[Y];J.getSource().reparseOverscaled&&this._assignTerrainTiles(ee)}this.proxiedCoords[M.id]=L.map(Y=>new ml(Y,Y.key,this.orthoMatrix)),this._assignTerrainTiles(L),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(z),this.renderingToTexture=!1,this._updateTimestamp=y.exported.now();const q={};this._visibleDemTiles=[];for(const Y of this.proxyCoords){const J=this.terrainTileForTile[Y.key];if(!J)continue;const ee=J.tileID.key;ee in q||(this._visibleDemTiles.push(J),q[ee]=ee)}}_assignTerrainTiles(g){this._initializing||g.forEach(M=>{if(this.terrainTileForTile[M.key])return;const C=this._findTileCoveringTileID(M,this.sourceCache);C&&(this.terrainTileForTile[M.key]=C)})}_prepareDEMTextures(){const g=this.painter.context,M=g.gl;for(const C in this.terrainTileForTile){const L=this.terrainTileForTile[C],z=L.dem;!z||L.demTexture&&!L.needsDEMTextureUpload||(g.activeTexture.set(M.TEXTURE1),Po(this.painter,L,z))}}_prepareDemTileUniforms(g,M,C,L){if(!M||M.demTexture==null)return!1;const z=g.tileID.canonical,U=Math.pow(2,M.tileID.canonical.z-z.z),q=L||"";return C[`u_dem_tl${q}`]=[z.x*U%1,z.y*U%1],C[`u_dem_scale${q}`]=U,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){let g=0;const M=this._visibleDemTiles.reduce((C,L)=>{if(!L.dem)return C;const z=L.dem.tree.minimums[0];return z>0&&g++,C+z},0);return g?M/g:0}_updateEmptyDEMTexture(){const g=this.painter.context,M=g.gl;g.activeTexture.set(M.TEXTURE2);const C=this._getLoadedAreaMinimum(),L={width:1,height:1,data:new Uint8Array(y.DEMData.pack(C,this.sourceCache.getSource().encoding))};this._emptyDEMTextureDirty=!1;let z=this._emptyDEMTexture;return z?z.update(L,{premultiply:!1}):z=this._emptyDEMTexture=new y.Texture(g,L,M.RGBA,{premultiply:!1}),z}setupElevationDraw(g,M,C){const L=this.painter.context,z=L.gl,U=(q=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:y.DEMData.getUnpackVector(q),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0,u_tile_tl_up:[0,0,1],u_tile_tr_up:[0,0,1],u_tile_br_up:[0,0,1],u_tile_bl_up:[0,0,1],u_tile_up_scale:1});var q;U.u_dem_size=this.sourceCache.getSource().tileSize,U.u_exaggeration=this.exaggeration();let Y=null,J=null,ee=1;if(C&&C.morphing&&this._useVertexMorphing){const ie=C.morphing.srcDemTile,fe=C.morphing.dstDemTile;ee=C.morphing.phase,ie&&fe&&(this._prepareDemTileUniforms(g,ie,U,"_prev")&&(J=ie),this._prepareDemTileUniforms(g,fe,U)&&(Y=fe))}if(J&&Y?(L.activeTexture.set(z.TEXTURE2),Y.demTexture.bind(z.NEAREST,z.CLAMP_TO_EDGE,z.NEAREST),L.activeTexture.set(z.TEXTURE4),J.demTexture.bind(z.NEAREST,z.CLAMP_TO_EDGE,z.NEAREST),U.u_dem_lerp=ee):(Y=this.terrainTileForTile[g.tileID.key],L.activeTexture.set(z.TEXTURE2),(this._prepareDemTileUniforms(g,Y,U)?Y.demTexture:this.emptyDEMTexture).bind(z.NEAREST,z.CLAMP_TO_EDGE)),C&&C.useDepthForOcclusion&&(L.activeTexture.set(z.TEXTURE3),this._depthTexture.bind(z.NEAREST,z.CLAMP_TO_EDGE),U.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height]),C&&C.useMeterToDem&&Y){const ie=(1<<Y.tileID.canonical.z)*y.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;U.u_meter_to_dem=ie}C&&C.labelPlaneMatrixInv&&(U.u_label_plane_matrix_inv=C.labelPlaneMatrixInv),M.setTerrainUniformValues(L,U)}renderToBackBuffer(g){const M=this.painter,C=this.painter.context;g.length!==0&&(C.bindFramebuffer.set(null),C.viewport.set([0,0,M.width,M.height]),this.renderingToTexture=!1,function(L,z,U,q,Y){const J=L.context,ee=J.gl;let ie,fe;const be=L.options.showTerrainWireframe?2:0,Te=(De,Ee)=>{if(fe===De)return;const Pe=[ma[De]];Ee&&Pe.push(ma[be]),ie=L.useProgram("terrainRaster",null,Pe),fe=De},xe=L.colorModeForRenderPass(),Ie=new y.DepthMode(ee.LEQUAL,y.DepthMode.ReadWrite,L.depthRangeFor3D);_s.update(Y);const ve=L.transform,ke=6*Math.pow(1.5,22-ve.zoom)*z.exaggeration();(be?[!1,!0]:[!1]).forEach(De=>{fe=-1;const Ee=De?ee.LINES:ee.TRIANGLES,[Pe,Oe]=De?z.getWirefameBuffer():[z.gridIndexBuffer,z.gridSegments];for(const rt of q){const nt=U.getTile(rt),_t=y.StencilMode.disabled,it=z.prevTerrainTileForTile[rt.key],yt=z.terrainTileForTile[rt.key];Ke=yt,(Je=it)!=null&&Ke!=null&&Je.hasData()&&Ke.hasData()&&Je.demTexture!=null&&Ke.demTexture!=null&&Je.tileID.key!==Ke.tileID.key&&_s.newMorphing(rt.key,it,yt,Y,250),J.activeTexture.set(ee.TEXTURE0),nt.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE);const We=_s.getMorphValuesForProxy(rt.key),vt=We?1:0;let Ot;We&&(Ot={morphing:{srcDemTile:We.from,dstDemTile:We.to,phase:y.easeCubicInOut(We.phase)}});const Qt=Bo(rt.projMatrix,pl(rt.canonical,ve.renderWorldCopies)?ke/10:ke);Te(vt,De),z.setupElevationDraw(nt,ie,Ot),L.prepareDrawProgram(J,ie,rt.toUnwrapped()),ie.draw(J,Ee,Ie,_t,xe,y.CullFaceMode.backCCW,Qt,"terrain_raster",z.gridBuffer,Pe,Oe)}var Je,Ke})}(M,this,this.proxySourceCache,g,this._updateTimestamp),this.renderingToTexture=!0,g.splice(0,g.length))}renderBatch(g){if(this._drapedRenderBatches.length===0)return g+1;this.renderingToTexture=!0;const M=this.painter,C=this.painter.context,L=this.proxySourceCache,z=this.proxiedCoords[L.id],U=this._drapedRenderBatches.shift(),q=[],Y=M.style.order;let J=0;for(const ee of z){const ie=L.getTileByID(ee.proxyTileKey),fe=L.proxyCachedFBO[ee.key]?L.proxyCachedFBO[ee.key][g]:void 0,be=fe!==void 0?L.renderCache[fe]:this.pool[J++],Te=fe!==void 0;if(ie.texture=be.tex,Te&&!be.dirty){q.push(ie.tileID);continue}let xe;C.bindFramebuffer.set(be.fb.framebuffer),this.renderedToTile=!1,be.dirty&&(C.clear({color:y.Color.transparent}),be.dirty=!1);for(let Ie=U.start;Ie<=U.end;++Ie){const ve=M.style._layers[Y[Ie]];if(ve.isHidden(M.transform.zoom))continue;const ke=M.style._getLayerSourceCache(ve),De=ke?this.proxyToSource[ee.key][ke.id]:[ee];if(!De)continue;const Ee=De;C.viewport.set([0,0,be.fb.width,be.fb.height]),xe!==(ke?ke.id:null)&&(this._setupStencil(be,De,ve,ke),xe=ke?ke.id:null),M.renderLayer(M,ke,ve,Ee)}this.renderedToTile?(be.dirty=!0,q.push(ie.tileID)):Te||--J,J===5&&(J=0,this.renderToBackBuffer(q))}return this.renderToBackBuffer(q),this.renderingToTexture=!1,C.bindFramebuffer.set(null),C.viewport.set([0,0,M.width,M.height]),U.end+1}postRender(){}renderCacheEfficiency(g){const M=g.order.length;if(M===0)return{efficiency:100};let C,L=0,z=0,U=!1;for(let q=0;q<M;++q){const Y=g._layers[g.order[q]];this._style.isLayerDraped(Y)?(U&&++L,++z):U||(U=!0,C=Y.id)}return z===0?{efficiency:100}:{efficiency:100*(1-L/z),firstUndrapedLayer:C}}getMinElevationBelowMSL(){let g=0;return this._visibleDemTiles.filter(M=>M.dem).forEach(M=>{g=Math.min(g,M.dem.tree.minimums[0])}),g===0?g:(g-30)*this._exaggeration}raycast(g,M,C){if(!this._visibleDemTiles)return null;const L=this._visibleDemTiles.filter(z=>z.dem).map(z=>{const U=z.tileID,q=Math.pow(2,U.overscaledZ),{x:Y,y:J}=U.canonical,ee=Y/q,ie=(Y+1)/q,fe=J/q,be=(J+1)/q;return{minx:ee,miny:fe,maxx:ie,maxy:be,t:z.dem.tree.raycastRoot(ee,fe,ie,be,g,M,C),tile:z}});L.sort((z,U)=>(z.t!==null?z.t:Number.MAX_VALUE)-(U.t!==null?U.t:Number.MAX_VALUE));for(const z of L){if(z.t==null)return null;const U=z.tile.dem.tree.raycast(z.minx,z.miny,z.maxx,z.maxy,g,M,C);if(U!=null)return U}return null}_createFBO(){const g=this.painter.context,M=g.gl,C=this.drapeBufferSize;g.activeTexture.set(M.TEXTURE0);const L=new y.Texture(g,{width:C[0],height:C[1],data:null},M.RGBA);L.bind(M.LINEAR,M.CLAMP_TO_EDGE);const z=g.createFramebuffer(C[0],C[1],!1);return z.colorAttachment.set(L.texture),z.depthAttachment=new yr(g,z.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=g.createRenderbuffer(g.gl.DEPTH_STENCIL,C[0],C[1]),this._stencilRef=0,z.depthAttachment.set(this._sharedDepthStencil),g.clear({stencil:0})):z.depthAttachment.set(this._sharedDepthStencil),g.extTextureFilterAnisotropic&&!g.extTextureFilterAnisotropicForceOff&&M.texParameterf(M.TEXTURE_2D,g.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,g.extTextureFilterAnisotropicMax),{fb:z,tex:L,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const g in this._style._sourceCaches)if(this._style._sourceCaches[g].hasTransition())return!0;return this._style.order.some(g=>{const M=this._style._layers[g],C=M.isHidden(this.painter.transform.zoom),L=M.getCrossfadeParameters(),z=!!L&&L.t!==1,U=M.hasTransition();return M.type!=="custom"&&!C&&(z||U)})}_clearRasterFadeFromRenderCache(){let g=!1;for(const M in this._style._sourceCaches)if(this._style._sourceCaches[M]._source instanceof we){g=!0;break}if(g)for(let M=0;M<this._style.order.length;++M){const C=this._style._layers[this._style.order[M]],L=C.isHidden(this.painter.transform.zoom),z=this._style._getLayerSourceCache(C);if(C.type!=="raster"||L||!z)continue;const U=C.paint.get("raster-fade-duration");for(const q of this.proxyCoords){const Y=this.proxyToSource[q.key][z.id];if(Y)for(const J of Y){const ee=ga(z.getTile(J),z.findLoadedParent(J,0),z,this.painter.transform,U);(ee.opacity!==1||ee.mix!==0)&&this._clearRenderCacheForTile(z.id,J)}}}}_setupDrapedRenderBatches(){const g=this._style.order,M=g.length;if(M===0)return;const C=[];let L,z=0,U=this._style._layers[g[z]];for(;!this._style.isLayerDraped(U)&&U.isHidden(this.painter.transform.zoom)&&++z<M;)U=this._style._layers[g[z]];for(;z<M;++z){const q=this._style._layers[g[z]];q.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(q)?L===void 0&&(L=z):L!==void 0&&(C.push({start:L,end:z-1}),L=void 0))}L!==void 0&&C.push({start:L,end:z-1}),this._drapedRenderBatches=C}_setupRenderCache(g){const M=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,M.renderCache.length>M.renderCachePool.length){const U=Object.values(M.proxyCachedFBO);M.proxyCachedFBO={};for(let q=0;q<U.length;++q){const Y=Object.values(U[q]);M.renderCachePool.push(...Y)}}return}this._clearRasterFadeFromRenderCache();const C=this.proxyCoords,L=this._tilesDirty;for(let U=C.length-1;U>=0;U--){const q=C[U];if(M.getTileByID(q.key),M.proxyCachedFBO[q.key]!==void 0){const Y=g[q.key],J=this.proxyToSource[q.key];let ee=0;for(const ie in J){const fe=J[ie],be=Y[ie];if(!be||be.length!==fe.length||fe.some((Te,xe)=>Te!==be[xe]||L[ie]&&L[ie].hasOwnProperty(Te.key))){ee=-1;break}++ee}for(const ie in M.proxyCachedFBO[q.key])M.renderCache[M.proxyCachedFBO[q.key][ie]].dirty=ee<0||ee!==Object.values(Y).length}}const z=[...this._drapedRenderBatches];z.sort((U,q)=>q.end-q.start-(U.end-U.start));for(const U of z)for(const q of C){if(M.proxyCachedFBO[q.key])continue;let Y=M.renderCachePool.pop();Y===void 0&&M.renderCache.length<50&&(Y=M.renderCache.length,M.renderCache.push(this._createFBO())),Y!==void 0&&(M.proxyCachedFBO[q.key]={},M.proxyCachedFBO[q.key][U.start]=Y,M.renderCache[Y].dirty=!0)}this._tilesDirty={}}_setupStencil(g,M,C,L){if(!L||!this._sourceTilesOverlap[L.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const z=this.painter.context,U=z.gl;if(M.length<=1)return void(this._overlapStencilType=!1);let q;if(C.isTileClipped())q=M.length,this._overlapStencilMode.test={func:U.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(M[0].overscaledZ>M[M.length-1].overscaledZ))return void(this._overlapStencilType=!1);q=1,this._overlapStencilMode.test={func:U.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+q>255&&(z.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=q,this._overlapStencilMode.ref=this._stencilRef,C.isTileClipped()&&this._renderTileClippingMasks(M,this._overlapStencilMode.ref)}stencilModeForRTTOverlap(g){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[g.key]),this._overlapStencilMode):y.StencilMode.disabled}_renderTileClippingMasks(g,M){const C=this.painter,L=this.painter.context,z=L.gl;C._tileClippingMaskIDs={},L.setColorMode(y.ColorMode.disabled),L.setDepthMode(y.DepthMode.disabled);const U=C.useProgram("clippingMask");for(const q of g){const Y=C._tileClippingMaskIDs[q.key]=--M;U.draw(L,z.TRIANGLES,y.DepthMode.disabled,new y.StencilMode({func:z.ALWAYS,mask:0},Y,255,z.KEEP,z.KEEP,z.REPLACE),y.ColorMode.disabled,y.CullFaceMode.disabled,Lo(q.projMatrix),"$clipping",C.tileExtentBuffer,C.quadTriangleIndexBuffer,C.tileExtentSegments)}}pointCoordinate(g){const M=this.painter.transform;if(g.x<0||g.x>M.width||g.y<0||g.y>M.height)return null;const C=[g.x,g.y,1,1];y.transformMat4(C,C,M.pixelMatrixInverse),y.scale$2(C,C,1/C[3]),C[0]/=M.worldSize,C[1]/=M.worldSize;const L=M._camera.position,z=y.mercatorZfromAltitude(1,M.center.lat),U=[L[0],L[1],L[2]/z,0],q=y.subtract([],C.slice(0,3),U);y.normalize(q,q);const Y=this.raycast(U,q,this._exaggeration);return Y!==null&&Y?(y.scaleAndAdd(U,U,q,Y),U[3]=U[2],U[2]*=z,U):null}drawDepth(){const g=this.painter,M=g.context,C=this.proxySourceCache,L=Math.ceil(g.width),z=Math.ceil(g.height);if(!this._depthFBO||this._depthFBO.width===L&&this._depthFBO.height===z||(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture),!this._depthFBO){const U=M.gl,q=M.createFramebuffer(L,z,!0);M.activeTexture.set(U.TEXTURE0);const Y=new y.Texture(M,{width:L,height:z,data:null},U.RGBA);Y.bind(U.NEAREST,U.CLAMP_TO_EDGE),q.colorAttachment.set(Y.texture);const J=M.createRenderbuffer(M.gl.DEPTH_COMPONENT16,L,z);q.depthAttachment.set(J),this._depthFBO=q,this._depthTexture=Y}M.bindFramebuffer.set(this._depthFBO.framebuffer),M.viewport.set([0,0,L,z]),function(U,q,Y,J){const ee=U.context,ie=ee.gl;ee.clear({depth:1});const fe=U.useProgram("terrainDepth"),be=new y.DepthMode(ie.LESS,y.DepthMode.ReadWrite,U.depthRangeFor3D);for(const Te of J){const xe=Y.getTile(Te),Ie=Bo(Te.projMatrix,0);q.setupElevationDraw(xe,fe),fe.draw(ee,ie.TRIANGLES,be,y.StencilMode.disabled,y.ColorMode.unblended,y.CullFaceMode.backCCW,Ie,"terrain_depth",q.gridBuffer,q.gridIndexBuffer,q.gridNoSkirtSegments)}}(g,this,C,this.proxyCoords)}_setupProxiedCoordsForOrtho(g,M,C){if(g.getSource()instanceof ae)return this._setupProxiedCoordsForImageSource(g,M,C);this._findCoveringTileCache[g.id]=this._findCoveringTileCache[g.id]||{};const L=this.proxiedCoords[g.id]=[],z=this.proxyCoords;for(let q=0;q<z.length;q++){const Y=z[q],J=this._findTileCoveringTileID(Y,g);if(J){const ee=this._createProxiedId(Y,J,C[Y.key]&&C[Y.key][g.id]);L.push(ee),this.proxyToSource[Y.key][g.id]=[ee]}}let U=!1;for(let q=0;q<M.length;q++){const Y=g.getTile(M[q]);if(!Y||!Y.hasData())continue;const J=this._findTileCoveringTileID(Y.tileID,this.proxySourceCache);if(J&&J.tileID.canonical.z!==Y.tileID.canonical.z){const ee=this.proxyToSource[J.tileID.key][g.id],ie=this._createProxiedId(J.tileID,Y,C[J.tileID.key]&&C[J.tileID.key][g.id]);ee?ee.splice(ee.length-1,0,ie):this.proxyToSource[J.tileID.key][g.id]=[ie],L.push(ie),U=!0}}this._sourceTilesOverlap[g.id]=U}_setupProxiedCoordsForImageSource(g,M,C){if(!g.getSource().loaded())return;const L=this.proxiedCoords[g.id]=[],z=this.proxyCoords,U=g.getSource(),q=new y.pointGeometry(U.tileID.x,U.tileID.y)._div(1<<U.tileID.z),Y=U.coordinates.map(y.MercatorCoordinate.fromLngLat).reduce((ee,ie)=>(ee.min.x=Math.min(ee.min.x,ie.x-q.x),ee.min.y=Math.min(ee.min.y,ie.y-q.y),ee.max.x=Math.max(ee.max.x,ie.x-q.x),ee.max.y=Math.max(ee.max.y,ie.y-q.y),ee),{min:new y.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new y.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),J=(ee,ie)=>{const fe=ee.wrap+ee.canonical.x/(1<<ee.canonical.z),be=ee.canonical.y/(1<<ee.canonical.z),Te=y.EXTENT/(1<<ee.canonical.z),xe=ie.wrap+ie.canonical.x/(1<<ie.canonical.z),Ie=ie.canonical.y/(1<<ie.canonical.z);return fe+Te<xe+Y.min.x||fe>xe+Y.max.x||be+Te<Ie+Y.min.y||be>Ie+Y.max.y};for(let ee=0;ee<z.length;ee++){const ie=z[ee];for(let fe=0;fe<M.length;fe++){const be=g.getTile(M[fe]);if(!be||!be.hasData()||J(ie,be.tileID))continue;const Te=this._createProxiedId(ie,be,C[ie.key]&&C[ie.key][g.id]),xe=this.proxyToSource[ie.key][g.id];xe?xe.push(Te):this.proxyToSource[ie.key][g.id]=[Te],L.push(Te)}}}_createProxiedId(g,M,C){let L=this.orthoMatrix;if(C){const z=C.find(U=>U.key===M.tileID.key);if(z)return z}if(M.tileID.key!==g.key){const z=g.canonical.z-M.tileID.canonical.z;let U,q,Y;L=y.create$1();const J=M.tileID.wrap-g.wrap<<g.overscaledZ;z>0?(U=y.EXTENT>>z,q=U*((M.tileID.canonical.x<<z)-g.canonical.x+J),Y=U*((M.tileID.canonical.y<<z)-g.canonical.y)):(U=y.EXTENT<<-z,q=y.EXTENT*(M.tileID.canonical.x-(g.canonical.x+J<<-z)),Y=y.EXTENT*(M.tileID.canonical.y-(g.canonical.y<<-z))),y.ortho(L,0,U,0,U,0,1),y.translate(L,L,[q,Y,0])}return new ml(M.tileID,g.key,L)}_findTileCoveringTileID(g,M){let C=M.getTile(g);if(C&&C.hasData())return C;const L=this._findCoveringTileCache[M.id],z=L[g.key];if(C=z?M.getTileByID(z):null,C&&C.hasData()||z===null)return C;let U=C?C.tileID:g,q=U.overscaledZ;const Y=M.getSource().minzoom,J=[];if(!z){const ie=M.getSource().maxzoom;if(g.canonical.z>=ie){const fe=g.canonical.z-ie;M.getSource().reparseOverscaled?(q=Math.max(g.canonical.z+2,M.transform.tileZoom),U=new y.OverscaledTileID(q,g.wrap,ie,g.canonical.x>>fe,g.canonical.y>>fe)):fe!==0&&(q=ie,U=new y.OverscaledTileID(q,g.wrap,ie,g.canonical.x>>fe,g.canonical.y>>fe))}U.key!==g.key&&(J.push(U.key),C=M.getTile(U))}const ee=ie=>{J.forEach(fe=>{L[fe]=ie}),J.length=0};for(q-=1;q>=Y&&(!C||!C.hasData());q--){C&&ee(C.tileID.key);const ie=U.calculateScaledKey(q);if(C=M.getTileByID(ie),C&&C.hasData())break;const fe=L[ie];if(fe===null)break;fe===void 0?J.push(ie):C=M.getTileByID(fe)}return ee(C?C.tileID.key:null),C&&C.hasData()?C:null}findDEMTileFor(g){return this.enabled?this._findTileCoveringTileID(g,this.sourceCache):null}prepareDrawTile(g){this.renderedToTile=!0}_clearRenderCacheForTile(g,M){let C=this._tilesDirty[g];C||(C=this._tilesDirty[g]={}),C[M.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const g=function(M){let C,L,z;const U=new y.StructArrayLayout2ui4,q=131;for(L=1;L<129;L++){for(C=1;C<129;C++)z=L*q+C,U.emplaceBack(z,z+1),U.emplaceBack(z,z+q),U.emplaceBack(z+1,z+q),L===128&&U.emplaceBack(z+q,z+q+1);U.emplaceBack(z+1,z+1+q)}return U}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(g),this.wireframeSegments=y.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,g.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}function ys(I){const g=[];for(let M=0;M<I.length;M++){if(I[M]===null)continue;const C=I[M].split(" ");g.push(C.pop())}return g}class xs{static cacheKey(g,M,C){let L=`${g}${C?C.cacheKey:""}`;for(const z of M)L+=`/${z}`;return L}constructor(g,M,C,L,z,U){const q=g.gl;this.program=q.createProgram();const Y=ys(C.staticAttributes),J=L?L.getBinderAttributes():[],ee=Y.concat(J),ie=C.staticUniforms?ys(C.staticUniforms):[],fe=L?L.getBinderUniforms():[],be=ie.concat(fe),Te=[];for(const Pe of be)Te.indexOf(Pe)<0&&Te.push(Pe);let xe=L?L.defines():[];xe=xe.concat(U.map(Pe=>`#define ${Pe}`));const Ie=xe.concat(`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,ro,En.fragmentSource,io.fragmentSource,C.fragmentSource).join(`
`),ve=xe.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,ro,En.vertexSource,io.vertexSource,Do.vertexSource,C.vertexSource).join(`
`),ke=q.createShader(q.FRAGMENT_SHADER);if(q.isContextLost())return void(this.failedToCreate=!0);q.shaderSource(ke,Ie),q.compileShader(ke),q.attachShader(this.program,ke);const De=q.createShader(q.VERTEX_SHADER);if(q.isContextLost())return void(this.failedToCreate=!0);q.shaderSource(De,ve),q.compileShader(De),q.attachShader(this.program,De),this.attributes={};const Ee={};this.numAttributes=ee.length;for(let Pe=0;Pe<this.numAttributes;Pe++)ee[Pe]&&(q.bindAttribLocation(this.program,Pe,ee[Pe]),this.attributes[ee[Pe]]=Pe);q.linkProgram(this.program),q.deleteShader(De),q.deleteShader(ke);for(let Pe=0;Pe<Te.length;Pe++){const Oe=Te[Pe];if(Oe&&!Ee[Oe]){const Je=q.getUniformLocation(this.program,Oe);Je&&(Ee[Oe]=Je)}}this.fixedUniforms=z(g,Ee),this.binderUniforms=L?L.getUniforms(g,Ee):[],U.indexOf("TERRAIN")!==-1&&(this.terrainUniforms=((Pe,Oe)=>({u_dem:new y.Uniform1i(Pe,Oe.u_dem),u_dem_prev:new y.Uniform1i(Pe,Oe.u_dem_prev),u_dem_unpack:new y.Uniform4f(Pe,Oe.u_dem_unpack),u_dem_tl:new y.Uniform2f(Pe,Oe.u_dem_tl),u_dem_scale:new y.Uniform1f(Pe,Oe.u_dem_scale),u_dem_tl_prev:new y.Uniform2f(Pe,Oe.u_dem_tl_prev),u_dem_scale_prev:new y.Uniform1f(Pe,Oe.u_dem_scale_prev),u_dem_size:new y.Uniform1f(Pe,Oe.u_dem_size),u_dem_lerp:new y.Uniform1f(Pe,Oe.u_dem_lerp),u_exaggeration:new y.Uniform1f(Pe,Oe.u_exaggeration),u_depth:new y.Uniform1i(Pe,Oe.u_depth),u_depth_size_inv:new y.Uniform2f(Pe,Oe.u_depth_size_inv),u_meter_to_dem:new y.Uniform1f(Pe,Oe.u_meter_to_dem),u_label_plane_matrix_inv:new y.UniformMatrix4f(Pe,Oe.u_label_plane_matrix_inv),u_tile_tl_up:new y.Uniform3f(Pe,Oe.u_tile_tl_up),u_tile_tr_up:new y.Uniform3f(Pe,Oe.u_tile_tr_up),u_tile_br_up:new y.Uniform3f(Pe,Oe.u_tile_br_up),u_tile_bl_up:new y.Uniform3f(Pe,Oe.u_tile_bl_up),u_tile_up_scale:new y.Uniform1f(Pe,Oe.u_tile_up_scale)}))(g,Ee)),U.indexOf("FOG")!==-1&&(this.fogUniforms=((Pe,Oe)=>({u_fog_matrix:new y.UniformMatrix4f(Pe,Oe.u_fog_matrix),u_fog_range:new y.Uniform2f(Pe,Oe.u_fog_range),u_fog_color:new y.Uniform4f(Pe,Oe.u_fog_color),u_fog_horizon_blend:new y.Uniform1f(Pe,Oe.u_fog_horizon_blend),u_fog_temporal_offset:new y.Uniform1f(Pe,Oe.u_fog_temporal_offset)}))(g,Ee))}setTerrainUniformValues(g,M){if(!this.terrainUniforms)return;const C=this.terrainUniforms;if(!this.failedToCreate){g.program.set(this.program);for(const L in M)C[L].set(M[L])}}setFogUniformValues(g,M){if(!this.fogUniforms)return;const C=this.fogUniforms;if(!this.failedToCreate){g.program.set(this.program);for(const L in M)C[L].location&&C[L].set(M[L])}}draw(g,M,C,L,z,U,q,Y,J,ee,ie,fe,be,Te,xe,Ie){const ve=g.gl;if(this.failedToCreate)return;g.program.set(this.program),g.setDepthMode(C),g.setStencilMode(L),g.setColorMode(z),g.setCullFace(U);for(const De in this.fixedUniforms)this.fixedUniforms[De].set(q[De]);Te&&Te.setUniforms(g,this.binderUniforms,fe,{zoom:be});const ke={[ve.LINES]:2,[ve.TRIANGLES]:3,[ve.LINE_STRIP]:1}[M];for(const De of ie.get()){const Ee=De.vaos||(De.vaos={});(Ee[Y]||(Ee[Y]=new ms)).bind(g,this,J,Te?Te.getPaintVertexBuffers():[],ee,De.vertexOffset,xe,Ie),ve.drawElements(M,De.primitiveLength*ke,ve.UNSIGNED_SHORT,De.primitiveOffset*ke*2)}}}function vs(I,g,M){const C=1/Ut(M,1,g.transform.tileZoom),L=Math.pow(2,M.tileID.overscaledZ),z=M.tileSize*Math.pow(2,g.transform.tileZoom)/L,U=z*(M.tileID.canonical.x+M.tileID.wrap*L),q=z*M.tileID.canonical.y;return{u_image:0,u_texsize:M.imageAtlasTexture.size,u_scale:[C,I.fromScale,I.toScale],u_fade:I.t,u_pixel_coord_upper:[U>>16,q>>16],u_pixel_coord_lower:[65535&U,65535&q]}}const ya=(I,g,M,C)=>{const L=g.style.light,z=L.properties.get("position"),U=[z.x,z.y,z.z],q=y.create$2();L.properties.get("anchor")==="viewport"&&(y.fromRotation(q,-g.transform.angle),y.transformMat3(U,U,q));const Y=L.properties.get("color");return{u_matrix:I,u_lightpos:U,u_lightintensity:L.properties.get("intensity"),u_lightcolor:[Y.r,Y.g,Y.b],u_vertical_gradient:+M,u_opacity:C}},gl=(I,g,M,C,L,z,U)=>y.extend(ya(I,g,M,C),vs(z,g,U),{u_height_factor:-Math.pow(2,L.overscaledZ)/U.tileSize/8}),_l=I=>({u_matrix:I}),no=(I,g,M,C)=>y.extend(_l(I),vs(M,g,C)),zo=(I,g)=>({u_matrix:I,u_world:g}),yl=(I,g,M,C,L)=>y.extend(no(I,g,M,C),{u_world:L}),jr=(I,g,M,C)=>{const L=I.transform;let z;return z=C.paint.get("circle-pitch-alignment")==="map"?L.calculatePixelsToTileUnitsMatrix(M):new Float32Array([L.pixelsToGLUnits[0],0,0,L.pixelsToGLUnits[1]]),{u_camera_to_center_distance:L.cameraToCenterDistance,u_matrix:I.translatePosMatrix(g.projMatrix,M,C.paint.get("circle-translate"),C.paint.get("circle-translate-anchor")),u_device_pixel_ratio:y.exported.devicePixelRatio,u_extrude_scale:z}},xa=I=>{const g=[];return I.paint.get("circle-pitch-alignment")==="map"&&g.push("PITCH_WITH_MAP"),I.paint.get("circle-pitch-scale")==="map"&&g.push("SCALE_WITH_MAP"),g},bs=(I,g,M)=>{const C=y.EXTENT/M.tileSize;return{u_matrix:I,u_camera_to_center_distance:g.cameraToCenterDistance,u_extrude_scale:[g.pixelsToGLUnits[0]/C,g.pixelsToGLUnits[1]/C]}},Fo=(I,g,M=1)=>({u_matrix:I,u_color:g,u_overlay:0,u_overlay_scale:M}),va=(I,g,M,C)=>({u_matrix:I,u_extrude_scale:Ut(g,1,M),u_intensity:C}),ba=(I,g,M,C,L,z)=>{const U=I.transform,q=U.calculatePixelsToTileUnitsMatrix(g),Y={u_matrix:Ts(I,g,M,L),u_pixels_to_tile_units:q,u_device_pixel_ratio:y.exported.devicePixelRatio,u_units_to_pixels:[1/U.pixelsToGLUnits[0],1/U.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:z,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0};if(wa(M)){const J=Es(g,I.transform);Y.u_texsize=g.lineAtlasTexture.size,Y.u_scale=[J,C.fromScale,C.toScale],Y.u_mix=C.t}return Y},ws=(I,g,M,C,L)=>{const z=I.transform,U=Es(g,z);return{u_matrix:Ts(I,g,M,L),u_texsize:g.imageAtlasTexture.size,u_pixels_to_tile_units:z.calculatePixelsToTileUnitsMatrix(g),u_device_pixel_ratio:y.exported.devicePixelRatio,u_image:0,u_scale:[U,C.fromScale,C.toScale],u_fade:C.t,u_units_to_pixels:[1/z.pixelsToGLUnits[0],1/z.pixelsToGLUnits[1]]}};function Es(I,g){return 1/Ut(I,1,g.tileZoom)}function Ts(I,g,M,C){return I.translatePosMatrix(C||g.tileID.projMatrix,g,M.paint.get("line-translate"),M.paint.get("line-translate-anchor"))}const Ms=I=>{const g=[];return wa(I)&&g.push("RENDER_LINE_DASH"),I.paint.get("line-gradient")&&g.push("RENDER_LINE_GRADIENT"),g};function wa(I){const g=I.paint.get("line-dasharray").value;return g.value||g.kind!=="constant"}const xl=(I,g,M,C,L)=>{return{u_matrix:I,u_tl_parent:g,u_scale_parent:M,u_buffer_scale:1,u_fade_t:C.mix,u_opacity:C.opacity*L.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:L.paint.get("raster-brightness-min"),u_brightness_high:L.paint.get("raster-brightness-max"),u_saturation_factor:(U=L.paint.get("raster-saturation"),U>0?1-1/(1.001-U):-U),u_contrast_factor:(z=L.paint.get("raster-contrast"),z>0?1/(1-z):1+z),u_spin_weights:oo(L.paint.get("raster-hue-rotate"))};var z,U};function oo(I){I*=Math.PI/180;const g=Math.sin(I),M=Math.cos(I);return[(2*M+1)/3,(-Math.sqrt(3)*g-M+1)/3,(Math.sqrt(3)*g-M+1)/3]}const vl=(I,g,M,C,L,z,U,q,Y,J,ee,ie,fe,be)=>{const Te=L.transform;return{u_is_size_zoom_constant:+(I==="constant"||I==="source"),u_is_size_feature_constant:+(I==="constant"||I==="camera"),u_size_t:g?g.uSizeT:0,u_size:g?g.uSize:0,u_camera_to_center_distance:Te.cameraToCenterDistance,u_pitch:Te.pitch/360*2*Math.PI,u_rotate_symbol:+M,u_aspect_ratio:Te.width/Te.height,u_fade_change:L.options.fadeDuration?L.symbolFadeChange:1,u_matrix:z,u_label_plane_matrix:U,u_coord_matrix:q,u_is_text:+Y,u_pitch_with_map:+C,u_texsize:J,u_tile_id:ee,u_zoom_transition:ie,u_inv_rot_matrix:fe,u_merc_center:be,u_texture:0}},bl=(I,g,M,C,L,z,U,q,Y,J,ee,ie,fe,be,Te)=>{const{cameraToCenterDistance:xe,_pitch:Ie}=L.transform;return y.extend(vl(I,g,M,C,L,z,U,q,Y,J,ie,fe,be,Te),{u_gamma_scale:C?xe*Math.cos(L.terrain?0:Ie):1,u_device_pixel_ratio:y.exported.devicePixelRatio,u_is_halo:+ee})},Uh=(I,g,M,C,L,z,U,q,Y,J,ee,ie,fe,be)=>y.extend(bl(I,g,M,C,L,z,U,q,!0,Y,!0,ee,ie,fe,be),{u_texsize_icon:J,u_texture_icon:1}),Vh=(I,g,M)=>({u_matrix:I,u_opacity:g,u_color:M}),jh=(I,g,M,C,L,z)=>y.extend(function(U,q,Y,J){const ee=Y.imageManager.getPattern(U.from.toString()),ie=Y.imageManager.getPattern(U.to.toString()),{width:fe,height:be}=Y.imageManager.getPixelSize(),Te=Math.pow(2,J.tileID.overscaledZ),xe=J.tileSize*Math.pow(2,Y.transform.tileZoom)/Te,Ie=xe*(J.tileID.canonical.x+J.tileID.wrap*Te),ve=xe*J.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:ee.tl,u_pattern_br_a:ee.br,u_pattern_tl_b:ie.tl,u_pattern_br_b:ie.br,u_texsize:[fe,be],u_mix:q.t,u_pattern_size_a:ee.displaySize,u_pattern_size_b:ie.displaySize,u_scale_a:q.fromScale,u_scale_b:q.toScale,u_tile_units_to_pixels:1/Ut(J,1,Y.transform.tileZoom),u_pixel_coord_upper:[Ie>>16,ve>>16],u_pixel_coord_lower:[65535&Ie,65535&ve]}}(C,z,M,L),{u_matrix:I,u_opacity:g}),Gh={fillExtrusion:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_lightpos:new y.Uniform3f(I,g.u_lightpos),u_lightintensity:new y.Uniform1f(I,g.u_lightintensity),u_lightcolor:new y.Uniform3f(I,g.u_lightcolor),u_vertical_gradient:new y.Uniform1f(I,g.u_vertical_gradient),u_opacity:new y.Uniform1f(I,g.u_opacity)}),fillExtrusionPattern:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_lightpos:new y.Uniform3f(I,g.u_lightpos),u_lightintensity:new y.Uniform1f(I,g.u_lightintensity),u_lightcolor:new y.Uniform3f(I,g.u_lightcolor),u_vertical_gradient:new y.Uniform1f(I,g.u_vertical_gradient),u_height_factor:new y.Uniform1f(I,g.u_height_factor),u_image:new y.Uniform1i(I,g.u_image),u_texsize:new y.Uniform2f(I,g.u_texsize),u_pixel_coord_upper:new y.Uniform2f(I,g.u_pixel_coord_upper),u_pixel_coord_lower:new y.Uniform2f(I,g.u_pixel_coord_lower),u_scale:new y.Uniform3f(I,g.u_scale),u_fade:new y.Uniform1f(I,g.u_fade),u_opacity:new y.Uniform1f(I,g.u_opacity)}),fill:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix)}),fillPattern:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_image:new y.Uniform1i(I,g.u_image),u_texsize:new y.Uniform2f(I,g.u_texsize),u_pixel_coord_upper:new y.Uniform2f(I,g.u_pixel_coord_upper),u_pixel_coord_lower:new y.Uniform2f(I,g.u_pixel_coord_lower),u_scale:new y.Uniform3f(I,g.u_scale),u_fade:new y.Uniform1f(I,g.u_fade)}),fillOutline:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_world:new y.Uniform2f(I,g.u_world)}),fillOutlinePattern:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_world:new y.Uniform2f(I,g.u_world),u_image:new y.Uniform1i(I,g.u_image),u_texsize:new y.Uniform2f(I,g.u_texsize),u_pixel_coord_upper:new y.Uniform2f(I,g.u_pixel_coord_upper),u_pixel_coord_lower:new y.Uniform2f(I,g.u_pixel_coord_lower),u_scale:new y.Uniform3f(I,g.u_scale),u_fade:new y.Uniform1f(I,g.u_fade)}),circle:(I,g)=>({u_camera_to_center_distance:new y.Uniform1f(I,g.u_camera_to_center_distance),u_extrude_scale:new y.UniformMatrix2f(I,g.u_extrude_scale),u_device_pixel_ratio:new y.Uniform1f(I,g.u_device_pixel_ratio),u_matrix:new y.UniformMatrix4f(I,g.u_matrix)}),collisionBox:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_camera_to_center_distance:new y.Uniform1f(I,g.u_camera_to_center_distance),u_extrude_scale:new y.Uniform2f(I,g.u_extrude_scale)}),collisionCircle:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_inv_matrix:new y.UniformMatrix4f(I,g.u_inv_matrix),u_camera_to_center_distance:new y.Uniform1f(I,g.u_camera_to_center_distance),u_viewport_size:new y.Uniform2f(I,g.u_viewport_size)}),debug:(I,g)=>({u_color:new y.UniformColor(I,g.u_color),u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_overlay:new y.Uniform1i(I,g.u_overlay),u_overlay_scale:new y.Uniform1f(I,g.u_overlay_scale)}),clippingMask:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix)}),heatmap:(I,g)=>({u_extrude_scale:new y.Uniform1f(I,g.u_extrude_scale),u_intensity:new y.Uniform1f(I,g.u_intensity),u_matrix:new y.UniformMatrix4f(I,g.u_matrix)}),heatmapTexture:(I,g)=>({u_image:new y.Uniform1i(I,g.u_image),u_color_ramp:new y.Uniform1i(I,g.u_color_ramp),u_opacity:new y.Uniform1f(I,g.u_opacity)}),hillshade:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_image:new y.Uniform1i(I,g.u_image),u_latrange:new y.Uniform2f(I,g.u_latrange),u_light:new y.Uniform2f(I,g.u_light),u_shadow:new y.UniformColor(I,g.u_shadow),u_highlight:new y.UniformColor(I,g.u_highlight),u_accent:new y.UniformColor(I,g.u_accent)}),hillshadePrepare:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_image:new y.Uniform1i(I,g.u_image),u_dimension:new y.Uniform2f(I,g.u_dimension),u_zoom:new y.Uniform1f(I,g.u_zoom),u_unpack:new y.Uniform4f(I,g.u_unpack)}),line:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_pixels_to_tile_units:new y.UniformMatrix2f(I,g.u_pixels_to_tile_units),u_device_pixel_ratio:new y.Uniform1f(I,g.u_device_pixel_ratio),u_units_to_pixels:new y.Uniform2f(I,g.u_units_to_pixels),u_dash_image:new y.Uniform1i(I,g.u_dash_image),u_gradient_image:new y.Uniform1i(I,g.u_gradient_image),u_image_height:new y.Uniform1f(I,g.u_image_height),u_texsize:new y.Uniform2f(I,g.u_texsize),u_scale:new y.Uniform3f(I,g.u_scale),u_mix:new y.Uniform1f(I,g.u_mix)}),linePattern:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_texsize:new y.Uniform2f(I,g.u_texsize),u_pixels_to_tile_units:new y.UniformMatrix2f(I,g.u_pixels_to_tile_units),u_device_pixel_ratio:new y.Uniform1f(I,g.u_device_pixel_ratio),u_image:new y.Uniform1i(I,g.u_image),u_units_to_pixels:new y.Uniform2f(I,g.u_units_to_pixels),u_scale:new y.Uniform3f(I,g.u_scale),u_fade:new y.Uniform1f(I,g.u_fade)}),raster:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_tl_parent:new y.Uniform2f(I,g.u_tl_parent),u_scale_parent:new y.Uniform1f(I,g.u_scale_parent),u_buffer_scale:new y.Uniform1f(I,g.u_buffer_scale),u_fade_t:new y.Uniform1f(I,g.u_fade_t),u_opacity:new y.Uniform1f(I,g.u_opacity),u_image0:new y.Uniform1i(I,g.u_image0),u_image1:new y.Uniform1i(I,g.u_image1),u_brightness_low:new y.Uniform1f(I,g.u_brightness_low),u_brightness_high:new y.Uniform1f(I,g.u_brightness_high),u_saturation_factor:new y.Uniform1f(I,g.u_saturation_factor),u_contrast_factor:new y.Uniform1f(I,g.u_contrast_factor),u_spin_weights:new y.Uniform3f(I,g.u_spin_weights)}),symbolIcon:(I,g)=>({u_is_size_zoom_constant:new y.Uniform1i(I,g.u_is_size_zoom_constant),u_is_size_feature_constant:new y.Uniform1i(I,g.u_is_size_feature_constant),u_size_t:new y.Uniform1f(I,g.u_size_t),u_size:new y.Uniform1f(I,g.u_size),u_camera_to_center_distance:new y.Uniform1f(I,g.u_camera_to_center_distance),u_pitch:new y.Uniform1f(I,g.u_pitch),u_rotate_symbol:new y.Uniform1i(I,g.u_rotate_symbol),u_aspect_ratio:new y.Uniform1f(I,g.u_aspect_ratio),u_fade_change:new y.Uniform1f(I,g.u_fade_change),u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_label_plane_matrix:new y.UniformMatrix4f(I,g.u_label_plane_matrix),u_coord_matrix:new y.UniformMatrix4f(I,g.u_coord_matrix),u_is_text:new y.Uniform1i(I,g.u_is_text),u_pitch_with_map:new y.Uniform1i(I,g.u_pitch_with_map),u_texsize:new y.Uniform2f(I,g.u_texsize),u_tile_id:new y.Uniform3f(I,g.u_tile_id),u_zoom_transition:new y.Uniform1f(I,g.u_zoom_transition),u_inv_rot_matrix:new y.UniformMatrix4f(I,g.u_inv_rot_matrix),u_merc_center:new y.Uniform2f(I,g.u_merc_center),u_texture:new y.Uniform1i(I,g.u_texture)}),symbolSDF:(I,g)=>({u_is_size_zoom_constant:new y.Uniform1i(I,g.u_is_size_zoom_constant),u_is_size_feature_constant:new y.Uniform1i(I,g.u_is_size_feature_constant),u_size_t:new y.Uniform1f(I,g.u_size_t),u_size:new y.Uniform1f(I,g.u_size),u_camera_to_center_distance:new y.Uniform1f(I,g.u_camera_to_center_distance),u_pitch:new y.Uniform1f(I,g.u_pitch),u_rotate_symbol:new y.Uniform1i(I,g.u_rotate_symbol),u_aspect_ratio:new y.Uniform1f(I,g.u_aspect_ratio),u_fade_change:new y.Uniform1f(I,g.u_fade_change),u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_label_plane_matrix:new y.UniformMatrix4f(I,g.u_label_plane_matrix),u_coord_matrix:new y.UniformMatrix4f(I,g.u_coord_matrix),u_is_text:new y.Uniform1i(I,g.u_is_text),u_pitch_with_map:new y.Uniform1i(I,g.u_pitch_with_map),u_texsize:new y.Uniform2f(I,g.u_texsize),u_texture:new y.Uniform1i(I,g.u_texture),u_gamma_scale:new y.Uniform1f(I,g.u_gamma_scale),u_device_pixel_ratio:new y.Uniform1f(I,g.u_device_pixel_ratio),u_tile_id:new y.Uniform3f(I,g.u_tile_id),u_zoom_transition:new y.Uniform1f(I,g.u_zoom_transition),u_inv_rot_matrix:new y.UniformMatrix4f(I,g.u_inv_rot_matrix),u_merc_center:new y.Uniform2f(I,g.u_merc_center),u_is_halo:new y.Uniform1i(I,g.u_is_halo)}),symbolTextAndIcon:(I,g)=>({u_is_size_zoom_constant:new y.Uniform1i(I,g.u_is_size_zoom_constant),u_is_size_feature_constant:new y.Uniform1i(I,g.u_is_size_feature_constant),u_size_t:new y.Uniform1f(I,g.u_size_t),u_size:new y.Uniform1f(I,g.u_size),u_camera_to_center_distance:new y.Uniform1f(I,g.u_camera_to_center_distance),u_pitch:new y.Uniform1f(I,g.u_pitch),u_rotate_symbol:new y.Uniform1i(I,g.u_rotate_symbol),u_aspect_ratio:new y.Uniform1f(I,g.u_aspect_ratio),u_fade_change:new y.Uniform1f(I,g.u_fade_change),u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_label_plane_matrix:new y.UniformMatrix4f(I,g.u_label_plane_matrix),u_coord_matrix:new y.UniformMatrix4f(I,g.u_coord_matrix),u_is_text:new y.Uniform1i(I,g.u_is_text),u_pitch_with_map:new y.Uniform1i(I,g.u_pitch_with_map),u_texsize:new y.Uniform2f(I,g.u_texsize),u_texsize_icon:new y.Uniform2f(I,g.u_texsize_icon),u_texture:new y.Uniform1i(I,g.u_texture),u_texture_icon:new y.Uniform1i(I,g.u_texture_icon),u_gamma_scale:new y.Uniform1f(I,g.u_gamma_scale),u_device_pixel_ratio:new y.Uniform1f(I,g.u_device_pixel_ratio),u_is_halo:new y.Uniform1i(I,g.u_is_halo)}),background:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_opacity:new y.Uniform1f(I,g.u_opacity),u_color:new y.UniformColor(I,g.u_color)}),backgroundPattern:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_opacity:new y.Uniform1f(I,g.u_opacity),u_image:new y.Uniform1i(I,g.u_image),u_pattern_tl_a:new y.Uniform2f(I,g.u_pattern_tl_a),u_pattern_br_a:new y.Uniform2f(I,g.u_pattern_br_a),u_pattern_tl_b:new y.Uniform2f(I,g.u_pattern_tl_b),u_pattern_br_b:new y.Uniform2f(I,g.u_pattern_br_b),u_texsize:new y.Uniform2f(I,g.u_texsize),u_mix:new y.Uniform1f(I,g.u_mix),u_pattern_size_a:new y.Uniform2f(I,g.u_pattern_size_a),u_pattern_size_b:new y.Uniform2f(I,g.u_pattern_size_b),u_scale_a:new y.Uniform1f(I,g.u_scale_a),u_scale_b:new y.Uniform1f(I,g.u_scale_b),u_pixel_coord_upper:new y.Uniform2f(I,g.u_pixel_coord_upper),u_pixel_coord_lower:new y.Uniform2f(I,g.u_pixel_coord_lower),u_tile_units_to_pixels:new y.Uniform1f(I,g.u_tile_units_to_pixels)}),terrainRaster:Pi,terrainDepth:Pi,skybox:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_sun_direction:new y.Uniform3f(I,g.u_sun_direction),u_cubemap:new y.Uniform1i(I,g.u_cubemap),u_opacity:new y.Uniform1f(I,g.u_opacity),u_temporal_offset:new y.Uniform1f(I,g.u_temporal_offset)}),skyboxGradient:(I,g)=>({u_matrix:new y.UniformMatrix4f(I,g.u_matrix),u_color_ramp:new y.Uniform1i(I,g.u_color_ramp),u_center_direction:new y.Uniform3f(I,g.u_center_direction),u_radius:new y.Uniform1f(I,g.u_radius),u_opacity:new y.Uniform1f(I,g.u_opacity),u_temporal_offset:new y.Uniform1f(I,g.u_temporal_offset)}),skyboxCapture:(I,g)=>({u_matrix_3f:new y.UniformMatrix3f(I,g.u_matrix_3f),u_sun_direction:new y.Uniform3f(I,g.u_sun_direction),u_sun_intensity:new y.Uniform1f(I,g.u_sun_intensity),u_color_tint_r:new y.Uniform4f(I,g.u_color_tint_r),u_color_tint_m:new y.Uniform4f(I,g.u_color_tint_m),u_luminance:new y.Uniform1f(I,g.u_luminance)})};let so;function Ss(I,g,M,C,L,z,U){const q=I.context,Y=q.gl,J=I.useProgram("collisionBox"),ee=[];let ie=0,fe=0;for(let De=0;De<C.length;De++){const Ee=C[De],Pe=g.getTile(Ee),Oe=Pe.getBucket(M);if(!Oe)continue;let Je=Ee.projMatrix;L[0]===0&&L[1]===0||(Je=I.translatePosMatrix(Ee.projMatrix,Pe,L,z));const Ke=U?Oe.textCollisionBox:Oe.iconCollisionBox,rt=Oe.collisionCircleArray;if(rt.length>0){const nt=y.create$1(),_t=Je;y.mul$1(nt,Oe.placementInvProjMatrix,I.transform.glCoordMatrix),y.mul$1(nt,nt,Oe.placementViewportMatrix),ee.push({circleArray:rt,circleOffset:fe,transform:_t,invTransform:nt}),ie+=rt.length/4,fe=ie}Ke&&(I.terrain&&I.terrain.setupElevationDraw(Pe,J),J.draw(q,Y.LINES,y.DepthMode.disabled,y.StencilMode.disabled,I.colorModeForRenderPass(),y.CullFaceMode.disabled,bs(Je,I.transform,Pe),M.id,Ke.layoutVertexBuffer,Ke.indexBuffer,Ke.segments,null,I.transform.zoom,null,Ke.collisionVertexBuffer,Ke.collisionVertexBufferExt))}if(!U||!ee.length)return;const be=I.useProgram("collisionCircle"),Te=new y.StructArrayLayout2f1f2i16;Te.resize(4*ie),Te._trim();let xe=0;for(const De of ee)for(let Ee=0;Ee<De.circleArray.length/4;Ee++){const Pe=4*Ee,Oe=De.circleArray[Pe+0],Je=De.circleArray[Pe+1],Ke=De.circleArray[Pe+2],rt=De.circleArray[Pe+3];Te.emplace(xe++,Oe,Je,Ke,rt,0),Te.emplace(xe++,Oe,Je,Ke,rt,1),Te.emplace(xe++,Oe,Je,Ke,rt,2),Te.emplace(xe++,Oe,Je,Ke,rt,3)}(!so||so.length<2*ie)&&(so=function(De){const Ee=2*De,Pe=new y.StructArrayLayout3ui6;Pe.resize(Ee),Pe._trim();for(let Oe=0;Oe<Ee;Oe++){const Je=6*Oe;Pe.uint16[Je+0]=4*Oe+0,Pe.uint16[Je+1]=4*Oe+1,Pe.uint16[Je+2]=4*Oe+2,Pe.uint16[Je+3]=4*Oe+2,Pe.uint16[Je+4]=4*Oe+3,Pe.uint16[Je+5]=4*Oe+0}return Pe}(ie));const Ie=q.createIndexBuffer(so,!0),ve=q.createVertexBuffer(Te,y.collisionCircleLayout.members,!0);for(const De of ee){const Ee={u_matrix:De.transform,u_inv_matrix:De.invTransform,u_camera_to_center_distance:(ke=I.transform).cameraToCenterDistance,u_viewport_size:[ke.width,ke.height]};be.draw(q,Y.TRIANGLES,y.DepthMode.disabled,y.StencilMode.disabled,I.colorModeForRenderPass(),y.CullFaceMode.disabled,Ee,M.id,ve,Ie,y.SegmentVector.simpleSegment(0,2*De.circleOffset,De.circleArray.length,De.circleArray.length/2),null,I.transform.zoom,null,null,null)}var ke;ve.destroy(),Ie.destroy()}const jn=y.identity(new Float32Array(16));function wl(I,g,M,C,L,z){const{horizontalAlign:U,verticalAlign:q}=y.getAnchorAlignment(I),Y=-(U-.5)*g,J=-(q-.5)*M,ee=y.evaluateVariableOffset(I,C);return new y.pointGeometry((Y/L+ee[0])*z,(J/L+ee[1])*z)}function El(I,g,M,C,L,z,U,q,Y,J,ee,ie){const fe=I.text.placedSymbolArray,be=I.text.dynamicLayoutVertexArray,Te=I.icon.dynamicLayoutVertexArray,xe={};be.clear();for(let Ie=0;Ie<fe.length;Ie++){const ve=fe.get(Ie),ke=I.allowVerticalPlacement&&!ve.placedOrientation,De=ve.hidden||!ve.crossTileID||ke?null:C[ve.crossTileID];if(De){const Ee=new y.pointGeometry(ve.tileAnchorX,ve.tileAnchorY),Pe=ie(Ee),Oe=ir(Ee,M?q:U,Pe),Je=$n(z.cameraToCenterDistance,Oe.signedDistanceFromCamera);let Ke=L.evaluateSizeForFeature(I.textSizeData,J,ve)*Je/y.ONE_EM;M&&(Ke*=I.tilePixelRatio/Y);const{width:rt,height:nt,anchor:_t,textOffset:it,textScale:yt}=De,We=wl(_t,rt,nt,it,yt,Ke),vt=M?ir(Ee.add(We),U,Pe).point:Oe.point.add(g?We.rotate(-z.angle):We),Ot=I.allowVerticalPlacement&&ve.placedOrientation===y.WritingMode.vertical?Math.PI/2:0;for(let Qt=0;Qt<ve.numGlyphs;Qt++)y.addDynamicAttributes(be,vt,Ot);ee&&ve.associatedIconIndex>=0&&(xe[ve.associatedIconIndex]={shiftedAnchor:vt,angle:Ot})}else Qr(ve.numGlyphs,be)}if(ee){Te.clear();const Ie=I.icon.placedSymbolArray;for(let ve=0;ve<Ie.length;ve++){const ke=Ie.get(ve);if(ke.hidden)Qr(ke.numGlyphs,Te);else{const De=xe[ve];if(De)for(let Ee=0;Ee<ke.numGlyphs;Ee++)y.addDynamicAttributes(Te,De.shiftedAnchor,De.angle);else Qr(ke.numGlyphs,Te)}}I.icon.dynamicLayoutVertexBuffer.updateData(Te)}I.text.dynamicLayoutVertexBuffer.updateData(be)}function Ea(I,g,M){return M.iconsInText&&g?"symbolTextAndIcon":I?"symbolSDF":"symbolIcon"}function Tn(I,g,M,C,L,z,U,q,Y,J,ee,ie){const fe=I.context,be=fe.gl,Te=I.transform,xe=q==="map",Ie=Y==="map",ve=xe&&M.layout.get("symbol-placement")!=="point",ke=xe&&!Ie&&!ve,De=M.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Ee=!1;const Pe=I.depthModeForSublayer(0,y.DepthMode.ReadOnly),Oe=[0,0],Je=M.layout.get("text-variable-anchor"),Ke=[],rt=[];I.terrain&&Ie&&rt.push("PITCH_WITH_MAP_TERRAIN"),ve&&rt.push("PROJECTED_POS_ON_VIEWPORT");for(const nt of C){const _t=g.getTile(nt),it=_t.getBucket(M);if(!it)continue;const yt=L?it.text:it.icon;if(!yt||!yt.segments.get().length)continue;const We=yt.programConfigurations.get(M.id),vt=L||it.sdfIcons,Ot=L?it.textSizeData:it.iconSizeData,Qt=Ie||Te.pitch!==0,ni=I.useProgram(Ea(vt,L,it),We,rt),si=y.evaluateSizeForZoom(Ot,Te.zoom),ai=[nt.canonical.x,nt.canonical.y,1<<nt.canonical.z];let Wt,fi,Li,ar,wr=[0,0],kr=null;if(L){if(fi=_t.glyphAtlasTexture,Li=be.LINEAR,Wt=_t.glyphAtlasTexture.size,it.iconsInText){wr=_t.imageAtlasTexture.size,kr=_t.imageAtlasTexture;const $r=Ot.kind==="composite"||Ot.kind==="camera";ar=Qt||I.options.rotating||I.options.zooming||$r?be.LINEAR:be.NEAREST}}else{const $r=M.layout.get("icon-size").constantOr(0)!==1||it.iconsNeedLinear;fi=_t.imageAtlasTexture,Li=vt||I.options.rotating||I.options.zooming||$r||Qt?be.LINEAR:be.NEAREST,Wt=_t.imageAtlasTexture.size}const Rr=I.transform.calculatePixelsToTileUnitsMatrix(_t),lr=bi(nt.projMatrix,Ie,xe,I.transform,Rr),mn=I.terrain&&Ie&&ve?y.invert(new Float32Array(16),lr):jn,un=yi(nt.projMatrix,Ie,xe,I.transform,Rr),Xi=Je&&it.hasTextData(),er=M.layout.get("icon-text-fit")!=="none"&&Xi&&it.hasIconData();if(ve){const $r=Te.elevation;os(it,nt.projMatrix,I,L,lr,un,Ie,J,$r?Dn=>$r.getAtTileOffset(nt,Dn.x,Dn.y):null)}const Ii=I.translatePosMatrix(nt.projMatrix,_t,z,U),Hi=ve||L&&Je||er?jn:lr,Er=I.translatePosMatrix(un,_t,z,U,!0),Yi=vt&&M.paint.get(L?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Gr;Gr=vt?it.iconsInText?Uh(Ot.kind,si,ke,Ie,I,Ii,Hi,Er,Wt,wr,ai,0,I.identityMat,Oe):bl(Ot.kind,si,ke,Ie,I,Ii,Hi,Er,L,Wt,!0,ai,0,I.identityMat,Oe):vl(Ot.kind,si,ke,Ie,I,Ii,Hi,Er,L,Wt,ai,0,I.identityMat,Oe);const Wo={program:ni,buffers:yt,uniformValues:Gr,atlasTexture:fi,atlasTextureIcon:kr,atlasInterpolation:Li,atlasInterpolationIcon:ar,isSDF:vt,hasHalo:Yi,tile:_t,labelPlaneMatrixInv:mn};if(De&&it.canOverlap){Ee=!0;const $r=yt.segments.get();for(const Dn of $r)Ke.push({segments:new y.SegmentVector([Dn]),sortKey:Dn.sortKey,state:Wo})}else Ke.push({segments:yt.segments,sortKey:0,state:Wo})}Ee&&Ke.sort((nt,_t)=>nt.sortKey-_t.sortKey);for(const nt of Ke){const _t=nt.state;if(I.terrain&&I.terrain.setupElevationDraw(_t.tile,_t.program,{useDepthForOcclusion:!0,labelPlaneMatrixInv:_t.labelPlaneMatrixInv}),fe.activeTexture.set(be.TEXTURE0),_t.atlasTexture.bind(_t.atlasInterpolation,be.CLAMP_TO_EDGE),_t.atlasTextureIcon&&(fe.activeTexture.set(be.TEXTURE1),_t.atlasTextureIcon&&_t.atlasTextureIcon.bind(_t.atlasInterpolationIcon,be.CLAMP_TO_EDGE)),_t.isSDF){const it=_t.uniformValues;_t.hasHalo&&(it.u_is_halo=1,Ta(_t.buffers,nt.segments,M,I,_t.program,Pe,ee,ie,it)),it.u_is_halo=0}Ta(_t.buffers,nt.segments,M,I,_t.program,Pe,ee,ie,_t.uniformValues)}}function Ta(I,g,M,C,L,z,U,q,Y){const J=C.context;L.draw(J,J.gl.TRIANGLES,z,U,q,y.CullFaceMode.disabled,Y,M.id,I.layoutVertexBuffer,I.indexBuffer,g,M.paint,C.transform.zoom,I.programConfigurations.get(M.id),I.dynamicLayoutVertexBuffer,I.opacityVertexBuffer)}function Gn(I,g,M,C,L,z,U){const q=I.context.gl,Y=M.paint.get("fill-pattern"),J=Y&&Y.constantOr(1),ee=M.getCrossfadeParameters();let ie,fe,be,Te,xe;U?(fe=J&&!M.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ie=q.LINES):(fe=J?"fillPattern":"fill",ie=q.TRIANGLES);for(const Ie of C){const ve=g.getTile(Ie);if(J&&!ve.patternsLoaded())continue;const ke=ve.getBucket(M);if(!ke)continue;I.prepareDrawTile(Ie);const De=ke.programConfigurations.get(M.id),Ee=I.useProgram(fe,De);J&&(I.context.activeTexture.set(q.TEXTURE0),ve.imageAtlasTexture.bind(q.LINEAR,q.CLAMP_TO_EDGE),De.updatePaintBuffers(ee));const Pe=Y.constantOr(null);if(Pe&&ve.imageAtlas){const Je=ve.imageAtlas,Ke=Je.patternPositions[Pe.to.toString()],rt=Je.patternPositions[Pe.from.toString()];Ke&&rt&&De.setConstantPatternPositions(Ke,rt)}const Oe=I.translatePosMatrix(Ie.projMatrix,ve,M.paint.get("fill-translate"),M.paint.get("fill-translate-anchor"));if(U){Te=ke.indexBuffer2,xe=ke.segments2;const Je=I.terrain&&I.terrain.renderingToTexture?I.terrain.drapeBufferSize:[q.drawingBufferWidth,q.drawingBufferHeight];be=fe==="fillOutlinePattern"&&J?yl(Oe,I,ee,ve,Je):zo(Oe,Je)}else Te=ke.indexBuffer,xe=ke.segments,be=J?no(Oe,I,ee,ve):_l(Oe);I.prepareDrawProgram(I.context,Ee,Ie.toUnwrapped()),Ee.draw(I.context,ie,L,I.stencilModeForClipping(Ie),z,y.CullFaceMode.disabled,be,M.id,ke.layoutVertexBuffer,Te,xe,M.paint,I.transform.zoom,De)}}function Mn(I,g,M,C,L,z,U){const q=I.context,Y=q.gl,J=M.paint.get("fill-extrusion-pattern"),ee=J.constantOr(1),ie=M.getCrossfadeParameters(),fe=M.paint.get("fill-extrusion-opacity");for(const be of C){const Te=g.getTile(be),xe=Te.getBucket(M);if(!xe)continue;const Ie=xe.programConfigurations.get(M.id),ve=I.useProgram(ee?"fillExtrusionPattern":"fillExtrusion",Ie);if(I.terrain){const Oe=I.terrain;if(!xe.enableTerrain)continue;if(Oe.setupElevationDraw(Te,ve,{useMeterToDem:!0}),Tl(q,g,be,xe,M,Oe),!xe.centroidVertexBuffer){const Je=ve.attributes.a_centroid_pos;Je!==void 0&&Y.vertexAttrib2f(Je,0,0)}}ee&&(I.context.activeTexture.set(Y.TEXTURE0),Te.imageAtlasTexture.bind(Y.LINEAR,Y.CLAMP_TO_EDGE),Ie.updatePaintBuffers(ie));const ke=J.constantOr(null);if(ke&&Te.imageAtlas){const Oe=Te.imageAtlas,Je=Oe.patternPositions[ke.to.toString()],Ke=Oe.patternPositions[ke.from.toString()];Je&&Ke&&Ie.setConstantPatternPositions(Je,Ke)}const De=I.translatePosMatrix(be.projMatrix,Te,M.paint.get("fill-extrusion-translate"),M.paint.get("fill-extrusion-translate-anchor")),Ee=M.paint.get("fill-extrusion-vertical-gradient"),Pe=ee?gl(De,I,Ee,fe,be,ie,Te):ya(De,I,Ee,fe);I.prepareDrawProgram(q,ve,be.toUnwrapped()),ve.draw(q,q.gl.TRIANGLES,L,z,U,y.CullFaceMode.backCCW,Pe,M.id,xe.layoutVertexBuffer,xe.indexBuffer,xe.segments,M.paint,I.transform.zoom,Ie,I.terrain?xe.centroidVertexBuffer:null)}}function Tl(I,g,M,C,L,z){const U=[ve=>{let ke=ve.canonical.x-1,De=ve.wrap;return ke<0&&(ke=(1<<ve.canonical.z)-1,De--),new y.OverscaledTileID(ve.overscaledZ,De,ve.canonical.z,ke,ve.canonical.y)},ve=>{let ke=ve.canonical.x+1,De=ve.wrap;return ke===1<<ve.canonical.z&&(ke=0,De++),new y.OverscaledTileID(ve.overscaledZ,De,ve.canonical.z,ke,ve.canonical.y)},ve=>new y.OverscaledTileID(ve.overscaledZ,ve.wrap,ve.canonical.z,ve.canonical.x,(ve.canonical.y===0?1<<ve.canonical.z:ve.canonical.y)-1),ve=>new y.OverscaledTileID(ve.overscaledZ,ve.wrap,ve.canonical.z,ve.canonical.x,ve.canonical.y===(1<<ve.canonical.z)-1?0:ve.canonical.y+1)],q=ve=>{const ke=g.getSource().maxzoom,De=Je=>{const Ke=g.getTileByID(Je);if(Ke&&Ke.hasData())return Ke.getBucket(L)};let Ee,Pe,Oe;return(ve.overscaledZ===ve.canonical.z||ve.overscaledZ>=ke)&&(Ee=De(ve.key)),ve.overscaledZ>=ke&&(Pe=De(ve.calculateScaledKey(ve.overscaledZ+1))),ve.overscaledZ>ke&&(Oe=De(ve.calculateScaledKey(ve.overscaledZ-1))),Ee||Pe||Oe},Y=[0,0,0],J=(ve,ke)=>(Y[0]=Math.min(ve.min.y,ke.min.y),Y[1]=Math.max(ve.max.y,ke.max.y),Y[2]=y.EXTENT-ke.min.x>ve.max.x?ke.min.x-y.EXTENT:ve.max.x,Y),ee=(ve,ke)=>(Y[0]=Math.min(ve.min.x,ke.min.x),Y[1]=Math.max(ve.max.x,ke.max.x),Y[2]=y.EXTENT-ke.min.y>ve.max.y?ke.min.y-y.EXTENT:ve.max.y,Y),ie=[(ve,ke)=>J(ve,ke),(ve,ke)=>J(ke,ve),(ve,ke)=>ee(ve,ke),(ve,ke)=>ee(ke,ve)],fe=new y.pointGeometry(0,0);let be,Te,xe;const Ie=(ve,ke,De,Ee,Pe)=>{const Oe=[[Ee?De:ve,Ee?ve:De,0],[Ee?De:ke,Ee?ke:De,0]],Je=Pe<0?y.EXTENT+Pe:Pe,Ke=[Ee?Je:(ve+ke)/2,Ee?(ve+ke)/2:Je,0];return De===0&&Pe<0||De!==0&&Pe>0?z.getForTilePoints(xe,[Ke],!0,Te):Oe.push(Ke),z.getForTilePoints(M,Oe,!0,be),Math.max(Oe[0][2],Oe[1][2],Ke[2])/z.exaggeration()};for(let ve=0;ve<4;ve++){const ke=C.borders[ve];if(ke.length===0&&(C.borderDone[ve]=!0),C.borderDone[ve])continue;const De=xe=U[ve](M),Ee=q(De);if(!Ee||!Ee.enableTerrain||(Te=z.findDEMTileFor(De),!Te||!Te.dem))continue;if(!be){const Ke=z.findDEMTileFor(M);if(!Ke||!Ke.dem)return;be=Ke}const Pe=(ve<2?1:5)-ve,Oe=Ee.borders[Pe];let Je=0;for(let Ke=0;Ke<ke.length;Ke++){const rt=C.featuresOnBorder[ke[Ke]],nt=rt.borders[ve];let _t;for(;Je<Oe.length&&(_t=Ee.featuresOnBorder[Oe[Je]],!(_t.borders[Pe][1]>nt[0]+3));)Ee.borderDone[Pe]||Ee.encodeCentroid(void 0,_t,!1),Je++;if(_t&&Je<Oe.length){const it=Je;let yt=0;for(;!(_t.borders[Pe][0]>nt[1]-3)&&(yt++,++Je!==Oe.length);)_t=Ee.featuresOnBorder[Oe[Je]];if(_t=Ee.featuresOnBorder[Oe[it]],rt.intersectsCount()>1||_t.intersectsCount()>1||yt!==1){yt!==1&&(Je=it),C.encodeCentroid(void 0,rt,!1),Ee.borderDone[Pe]||Ee.encodeCentroid(void 0,_t,!1);continue}const We=ie[ve](rt,_t),vt=ve%2?y.EXTENT-1:0;fe.x=Ie(We[0],Math.min(y.EXTENT-1,We[1]),vt,ve<2,We[2]),fe.y=0,C.encodeCentroid(fe,rt,!1),Ee.borderDone[Pe]||Ee.encodeCentroid(fe,_t,!1)}else C.encodeCentroid(void 0,rt,!1)}C.borderDone[ve]=C.needsCentroidUpdate=!0,Ee.borderDone[Pe]||(Ee.borderDone[Pe]=Ee.needsCentroidUpdate=!0)}(C.needsCentroidUpdate||!C.centroidVertexBuffer&&C.centroidVertexArray.length!==0)&&C.uploadCentroid(I)}const Ma=new y.Color(1,0,0,1),Ri=new y.Color(0,1,0,1),As=new y.Color(0,0,1,1),qh=new y.Color(1,0,1,1),Ml=new y.Color(0,1,1,1);function ao(I,g,M,C){Is(I,0,g+M/2,I.transform.width,M,C)}function Sl(I,g,M,C){Is(I,g-M/2,0,M,I.transform.height,C)}function Is(I,g,M,C,L,z){const U=I.context,q=U.gl;q.enable(q.SCISSOR_TEST),q.scissor(g*y.exported.devicePixelRatio,M*y.exported.devicePixelRatio,C*y.exported.devicePixelRatio,L*y.exported.devicePixelRatio),U.clear({color:z}),q.disable(q.SCISSOR_TEST)}function Al(I,g,M){const C=I.context,L=C.gl,z=M.projMatrix,U=I.useProgram("debug"),q=g.getTileByID(M.key);I.terrain&&I.terrain.setupElevationDraw(q,U);const Y=y.DepthMode.disabled,J=y.StencilMode.disabled,ee=I.colorModeForRenderPass(),ie="$debug";C.activeTexture.set(L.TEXTURE0),I.emptyTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),q._makeDebugTileBoundsBuffers(I.context,I.transform.projection);const fe=q._tileDebugBuffer||I.debugBuffer,be=q._tileDebugIndexBuffer||I.debugIndexBuffer,Te=q._tileDebugSegments||I.debugSegments;U.draw(C,L.LINE_STRIP,Y,J,ee,y.CullFaceMode.disabled,Fo(z,y.Color.red),ie,fe,be,Te);const xe=q.latestRawTileData,Ie=Math.floor((xe&&xe.byteLength||0)/1024),ve=g.getTile(M).tileSize,ke=512/Math.min(ve,512)*(M.overscaledZ/I.transform.zoom)*.5;let De=M.canonical.toString();M.overscaledZ!==M.canonical.z&&(De+=` => ${M.overscaledZ}`),function(Ee,Pe){Ee.initDebugOverlayCanvas();const Oe=Ee.debugOverlayCanvas,Je=Ee.context.gl,Ke=Ee.debugOverlayCanvas.getContext("2d");Ke.clearRect(0,0,Oe.width,Oe.height),Ke.shadowColor="white",Ke.shadowBlur=2,Ke.lineWidth=1.5,Ke.strokeStyle="white",Ke.textBaseline="top",Ke.font="bold 36px Open Sans, sans-serif",Ke.fillText(Pe,5,5),Ke.strokeText(Pe,5,5),Ee.debugOverlayTexture.update(Oe),Ee.debugOverlayTexture.bind(Je.LINEAR,Je.CLAMP_TO_EDGE)}(I,`${De} ${Ie}kb`),U.draw(C,L.TRIANGLES,Y,J,y.ColorMode.alphaBlended,y.CullFaceMode.disabled,Fo(z,y.Color.transparent,ke),ie,I.debugBuffer,I.quadTriangleIndexBuffer,I.debugSegments)}const Zh=y.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Sa}=Zh;function rn(I,g,M,C){I.emplaceBack(g,M,C)}class lo{constructor(g){this.vertexArray=new y.StructArrayLayout3f12,this.indices=new y.StructArrayLayout3ui6,rn(this.vertexArray,-1,-1,1),rn(this.vertexArray,1,-1,1),rn(this.vertexArray,-1,1,1),rn(this.vertexArray,1,1,1),rn(this.vertexArray,-1,-1,-1),rn(this.vertexArray,1,-1,-1),rn(this.vertexArray,-1,1,-1),rn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=g.createVertexBuffer(this.vertexArray,Sa),this.indexBuffer=g.createIndexBuffer(this.indices),this.segment=y.SegmentVector.simpleSegment(0,0,36,12)}}function Sn(I,g,M,C,L,z){const U=I.gl,q=g.paint.get("sky-atmosphere-color"),Y=g.paint.get("sky-atmosphere-halo-color"),J=g.paint.get("sky-atmosphere-sun-intensity"),ee=((ie,fe,be,Te,xe)=>({u_matrix_3f:ie,u_sun_direction:fe,u_sun_intensity:be,u_color_tint_r:[Te.r,Te.g,Te.b,Te.a],u_color_tint_m:[xe.r,xe.g,xe.b,xe.a],u_luminance:5e-5}))(y.fromMat4([],C),L,J,q,Y);U.framebufferTexture2D(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,U.TEXTURE_CUBE_MAP_POSITIVE_X+z,g.skyboxTexture,0),M.draw(I,U.TRIANGLES,y.DepthMode.disabled,y.StencilMode.disabled,y.ColorMode.unblended,y.CullFaceMode.frontCW,ee,"skyboxCapture",g.skyboxGeometry.vertexBuffer,g.skyboxGeometry.indexBuffer,g.skyboxGeometry.segment)}const ks={symbol:function(I,g,M,C,L){if(I.renderPass!=="translucent")return;const z=y.StencilMode.disabled,U=I.colorModeForRenderPass();M.layout.get("text-variable-anchor")&&function(q,Y,J,ee,ie,fe,be){const Te=Y.transform,xe=ie==="map",Ie=fe==="map";for(const ve of q){const ke=ee.getTile(ve),De=ke.getBucket(J);if(!De||!De.text||!De.text.segments.get().length)continue;const Ee=y.evaluateSizeForZoom(De.textSizeData,Te.zoom),Pe=Y.transform.calculatePixelsToTileUnitsMatrix(ke),Oe=bi(ve.projMatrix,Ie,xe,Y.transform,Pe),Je=J.layout.get("icon-text-fit")!=="none"&&De.hasIconData();if(Ee){const Ke=Math.pow(2,Te.zoom-ke.tileID.overscaledZ),rt=Te.elevation;El(De,xe,Ie,be,y.symbolSize,Te,Oe,ve.projMatrix,Ke,Ee,Je,rt?nt=>rt.getAtTileOffset(ve,nt.x,nt.y):nt=>0)}}}(C,I,M,g,M.layout.get("text-rotation-alignment"),M.layout.get("text-pitch-alignment"),L),M.paint.get("icon-opacity").constantOr(1)!==0&&Tn(I,g,M,C,!1,M.paint.get("icon-translate"),M.paint.get("icon-translate-anchor"),M.layout.get("icon-rotation-alignment"),M.layout.get("icon-pitch-alignment"),M.layout.get("icon-keep-upright"),z,U),M.paint.get("text-opacity").constantOr(1)!==0&&Tn(I,g,M,C,!0,M.paint.get("text-translate"),M.paint.get("text-translate-anchor"),M.layout.get("text-rotation-alignment"),M.layout.get("text-pitch-alignment"),M.layout.get("text-keep-upright"),z,U),g.map.showCollisionBoxes&&(Ss(I,g,M,C,M.paint.get("text-translate"),M.paint.get("text-translate-anchor"),!0),Ss(I,g,M,C,M.paint.get("icon-translate"),M.paint.get("icon-translate-anchor"),!1))},circle:function(I,g,M,C){if(I.renderPass!=="translucent")return;const L=M.paint.get("circle-opacity"),z=M.paint.get("circle-stroke-width"),U=M.paint.get("circle-stroke-opacity"),q=M.layout.get("circle-sort-key").constantOr(1)!==void 0;if(L.constantOr(1)===0&&(z.constantOr(1)===0||U.constantOr(1)===0))return;const Y=I.context,J=Y.gl,ee=I.depthModeForSublayer(0,y.DepthMode.ReadOnly),ie=y.StencilMode.disabled,fe=I.colorModeForRenderPass(),be=[];for(let Te=0;Te<C.length;Te++){const xe=C[Te],Ie=g.getTile(xe),ve=Ie.getBucket(M);if(!ve)continue;const ke=ve.programConfigurations.get(M.id),De=xa(M),Ee={programConfiguration:ke,program:I.useProgram("circle",ke,De),layoutVertexBuffer:ve.layoutVertexBuffer,indexBuffer:ve.indexBuffer,uniformValues:jr(I,xe,Ie,M),tile:Ie};if(q){const Pe=ve.segments.get();for(const Oe of Pe)be.push({segments:new y.SegmentVector([Oe]),sortKey:Oe.sortKey,state:Ee})}else be.push({segments:ve.segments,sortKey:0,state:Ee})}q&&be.sort((Te,xe)=>Te.sortKey-xe.sortKey);for(const Te of be){const{programConfiguration:xe,program:Ie,layoutVertexBuffer:ve,indexBuffer:ke,uniformValues:De,tile:Ee}=Te.state,Pe=Te.segments;I.terrain&&I.terrain.setupElevationDraw(Ee,Ie,{useDepthForOcclusion:!0}),I.prepareDrawProgram(Y,Ie,Ee.tileID.toUnwrapped()),Ie.draw(Y,J.TRIANGLES,ee,ie,fe,y.CullFaceMode.disabled,De,M.id,ve,ke,Pe,M.paint,I.transform.zoom,xe)}},heatmap:function(I,g,M,C){if(M.paint.get("heatmap-opacity")!==0)if(I.renderPass==="offscreen"){const L=I.context,z=L.gl,U=y.StencilMode.disabled,q=new y.ColorMode([z.ONE,z.ONE],y.Color.transparent,[!0,!0,!0,!0]);(function(Y,J,ee){const ie=Y.gl;Y.activeTexture.set(ie.TEXTURE1),Y.viewport.set([0,0,J.width/4,J.height/4]);let fe=ee.heatmapFbo;if(fe)ie.bindTexture(ie.TEXTURE_2D,fe.colorAttachment.get()),Y.bindFramebuffer.set(fe.framebuffer);else{const be=ie.createTexture();ie.bindTexture(ie.TEXTURE_2D,be),ie.texParameteri(ie.TEXTURE_2D,ie.TEXTURE_WRAP_S,ie.CLAMP_TO_EDGE),ie.texParameteri(ie.TEXTURE_2D,ie.TEXTURE_WRAP_T,ie.CLAMP_TO_EDGE),ie.texParameteri(ie.TEXTURE_2D,ie.TEXTURE_MIN_FILTER,ie.LINEAR),ie.texParameteri(ie.TEXTURE_2D,ie.TEXTURE_MAG_FILTER,ie.LINEAR),fe=ee.heatmapFbo=Y.createFramebuffer(J.width/4,J.height/4,!1),function(Te,xe,Ie,ve){const ke=Te.gl;ke.texImage2D(ke.TEXTURE_2D,0,ke.RGBA,xe.width/4,xe.height/4,0,ke.RGBA,Te.extRenderToTextureHalfFloat?Te.extTextureHalfFloat.HALF_FLOAT_OES:ke.UNSIGNED_BYTE,null),ve.colorAttachment.set(Ie)}(Y,J,be,fe)}})(L,I,M),L.clear({color:y.Color.transparent});for(let Y=0;Y<C.length;Y++){const J=C[Y];if(g.hasRenderableParent(J))continue;const ee=g.getTile(J),ie=ee.getBucket(M);if(!ie)continue;const fe=ie.programConfigurations.get(M.id),be=I.useProgram("heatmap",fe),{zoom:Te}=I.transform;I.terrain&&I.terrain.setupElevationDraw(ee,be),I.prepareDrawProgram(L,be,J.toUnwrapped()),be.draw(L,z.TRIANGLES,y.DepthMode.disabled,U,q,y.CullFaceMode.disabled,va(J.projMatrix,ee,Te,M.paint.get("heatmap-intensity")),M.id,ie.layoutVertexBuffer,ie.indexBuffer,ie.segments,M.paint,I.transform.zoom,fe)}L.viewport.set([0,0,I.width,I.height])}else I.renderPass==="translucent"&&(I.context.setColorMode(I.colorModeForRenderPass()),function(L,z){const U=L.context,q=U.gl,Y=z.heatmapFbo;if(!Y)return;U.activeTexture.set(q.TEXTURE0),q.bindTexture(q.TEXTURE_2D,Y.colorAttachment.get()),U.activeTexture.set(q.TEXTURE1);let J=z.colorRampTexture;J||(J=z.colorRampTexture=new y.Texture(U,z.colorRamp,q.RGBA)),J.bind(q.LINEAR,q.CLAMP_TO_EDGE),L.useProgram("heatmapTexture").draw(U,q.TRIANGLES,y.DepthMode.disabled,y.StencilMode.disabled,L.colorModeForRenderPass(),y.CullFaceMode.disabled,((ee,ie,fe,be)=>({u_image:0,u_color_ramp:1,u_opacity:ie.paint.get("heatmap-opacity")}))(0,z),z.id,L.viewportBuffer,L.quadTriangleIndexBuffer,L.viewportSegments,z.paint,L.transform.zoom)}(I,M))},line:function(I,g,M,C){if(I.renderPass!=="translucent")return;const L=M.paint.get("line-opacity"),z=M.paint.get("line-width");if(L.constantOr(1)===0||z.constantOr(1)===0)return;const U=I.depthModeForSublayer(0,y.DepthMode.ReadOnly),q=I.colorModeForRenderPass(),Y=M.paint.get("line-dasharray"),J=Y.constantOr(1),ee=M.layout.get("line-cap"),ie=M.paint.get("line-pattern"),fe=ie.constantOr(1),be=M.paint.get("line-gradient"),Te=M.getCrossfadeParameters(),xe=fe?"linePattern":"line",Ie=I.context,ve=Ie.gl;for(const ke of C){const De=g.getTile(ke);if(fe&&!De.patternsLoaded())continue;const Ee=De.getBucket(M);if(!Ee)continue;I.prepareDrawTile(ke);const Pe=Ee.programConfigurations.get(M.id),Oe=Ms(M),Je=I.useProgram(xe,Pe,Oe),Ke=ie.constantOr(null);if(Ke&&De.imageAtlas){const yt=De.imageAtlas,We=yt.patternPositions[Ke.to.toString()],vt=yt.patternPositions[Ke.from.toString()];We&&vt&&Pe.setConstantPatternPositions(We,vt)}const rt=Y.constantOr(null),nt=ee.constantOr(null);if(!fe&&rt&&nt&&De.lineAtlas){const yt=De.lineAtlas,We=yt.getDash(rt.to,nt),vt=yt.getDash(rt.from,nt);We&&vt&&Pe.setConstantPatternPositions(We,vt)}const _t=I.terrain?ke.projMatrix:null,it=fe?ws(I,De,M,Te,_t):ba(I,De,M,Te,_t,Ee.lineClipsArray.length);if(be){const yt=Ee.gradients[M.id];let We=yt.texture;if(M.gradientVersion!==yt.version){let vt=256;if(M.stepInterpolant){const Ot=g.getSource().maxzoom,Qt=ke.canonical.z===Ot?Math.ceil(1<<I.transform.maxZoom-ke.canonical.z):1;vt=y.clamp(y.nextPowerOfTwo(Ee.maxLineLength/y.EXTENT*1024*Qt),256,Ie.maxTextureSize)}yt.gradient=y.renderColorRamp({expression:M.gradientExpression(),evaluationKey:"lineProgress",resolution:vt,image:yt.gradient||void 0,clips:Ee.lineClipsArray}),yt.texture?yt.texture.update(yt.gradient):yt.texture=new y.Texture(Ie,yt.gradient,ve.RGBA),yt.version=M.gradientVersion,We=yt.texture}Ie.activeTexture.set(ve.TEXTURE1),We.bind(M.stepInterpolant?ve.NEAREST:ve.LINEAR,ve.CLAMP_TO_EDGE)}J&&(Ie.activeTexture.set(ve.TEXTURE0),De.lineAtlasTexture.bind(ve.LINEAR,ve.REPEAT),Pe.updatePaintBuffers(Te)),fe&&(Ie.activeTexture.set(ve.TEXTURE0),De.imageAtlasTexture.bind(ve.LINEAR,ve.CLAMP_TO_EDGE),Pe.updatePaintBuffers(Te)),I.prepareDrawProgram(Ie,Je,ke.toUnwrapped()),Je.draw(Ie,ve.TRIANGLES,U,I.stencilModeForClipping(ke),q,y.CullFaceMode.disabled,it,M.id,Ee.layoutVertexBuffer,Ee.indexBuffer,Ee.segments,M.paint,I.transform.zoom,Pe,Ee.layoutVertexBuffer2)}},fill:function(I,g,M,C){const L=M.paint.get("fill-color"),z=M.paint.get("fill-opacity");if(z.constantOr(1)===0)return;const U=I.colorModeForRenderPass(),q=M.paint.get("fill-pattern"),Y=I.opaquePassEnabledForLayer()&&!q.constantOr(1)&&L.constantOr(y.Color.transparent).a===1&&z.constantOr(0)===1?"opaque":"translucent";if(I.renderPass===Y){const J=I.depthModeForSublayer(1,I.renderPass==="opaque"?y.DepthMode.ReadWrite:y.DepthMode.ReadOnly);Gn(I,g,M,C,J,U,!1)}if(I.renderPass==="translucent"&&M.paint.get("fill-antialias")){const J=I.depthModeForSublayer(M.getPaintProperty("fill-outline-color")?2:0,y.DepthMode.ReadOnly);Gn(I,g,M,C,J,U,!0)}},"fill-extrusion":function(I,g,M,C){const L=M.paint.get("fill-extrusion-opacity");if(L!==0&&I.renderPass==="translucent"){const z=new y.DepthMode(I.context.gl.LEQUAL,y.DepthMode.ReadWrite,I.depthRangeFor3D);if(L!==1||M.paint.get("fill-extrusion-pattern").constantOr(1))Mn(I,g,M,C,z,y.StencilMode.disabled,y.ColorMode.disabled),Mn(I,g,M,C,z,I.stencilModeFor3D(),I.colorModeForRenderPass());else{const U=I.colorModeForRenderPass();Mn(I,g,M,C,z,y.StencilMode.disabled,U)}}},hillshade:function(I,g,M,C){if(I.renderPass!=="offscreen"&&I.renderPass!=="translucent")return;const L=I.context,z=I.depthModeForSublayer(0,y.DepthMode.ReadOnly),U=I.colorModeForRenderPass(),q=I.terrain&&I.terrain.renderingToTexture,[Y,J]=I.renderPass!=="translucent"||q?[{},C]:I.stencilConfigForOverlap(C);for(const ee of J){const ie=g.getTile(ee);if(ie.needsHillshadePrepare&&I.renderPass==="offscreen")Ro(I,ie,M,z,y.StencilMode.disabled,U);else if(I.renderPass==="translucent"){const fe=q&&I.terrain?I.terrain.stencilModeForRTTOverlap(ee):Y[ee.overscaledZ];pa(I,ee,ie,M,z,fe,U)}}L.viewport.set([0,0,I.width,I.height])},raster:function(I,g,M,C,L,z){if(I.renderPass!=="translucent"||M.paint.get("raster-opacity")===0||!C.length)return;const U=I.context,q=U.gl,Y=g.getSource(),J=I.useProgram("raster"),ee=I.colorModeForRenderPass(),ie=I.terrain&&I.terrain.renderingToTexture,[fe,be]=Y instanceof ae||ie?[{},C]:I.stencilConfigForOverlap(C),Te=be[be.length-1].overscaledZ,xe=!I.options.moving;for(const Ie of be){const ve=ie?y.DepthMode.disabled:I.depthModeForSublayer(Ie.overscaledZ-Te,M.paint.get("raster-opacity")===1?y.DepthMode.ReadWrite:y.DepthMode.ReadOnly,q.LESS),ke=Ie.toUnwrapped(),De=g.getTile(Ie);if(ie&&(!De||!De.hasData()))continue;const Ee=ie?Ie.projMatrix:I.transform.calculateProjMatrix(ke,xe),Pe=I.terrain&&ie?I.terrain.stencilModeForRTTOverlap(Ie):fe[Ie.overscaledZ],Oe=z?0:M.paint.get("raster-fade-duration");De.registerFadeDuration(Oe);const Je=g.findLoadedParent(Ie,0),Ke=ga(De,Je,g,I.transform,Oe);let rt,nt;I.terrain&&I.terrain.prepareDrawTile(Ie);const _t=M.paint.get("raster-resampling")==="nearest"?q.NEAREST:q.LINEAR;U.activeTexture.set(q.TEXTURE0),De.texture.bind(_t,q.CLAMP_TO_EDGE),U.activeTexture.set(q.TEXTURE1),Je?(Je.texture.bind(_t,q.CLAMP_TO_EDGE),rt=Math.pow(2,Je.tileID.overscaledZ-De.tileID.overscaledZ),nt=[De.tileID.canonical.x*rt%1,De.tileID.canonical.y*rt%1]):De.texture.bind(_t,q.CLAMP_TO_EDGE);const it=xl(Ee,nt||[0,0],rt||1,Ke,M);if(I.prepareDrawProgram(U,J,ke),Y instanceof ae)J.draw(U,q.TRIANGLES,ve,y.StencilMode.disabled,ee,y.CullFaceMode.disabled,it,M.id,Y.boundsBuffer,I.quadTriangleIndexBuffer,Y.boundsSegments);else{const{tileBoundsBuffer:yt,tileBoundsIndexBuffer:We,tileBoundsSegments:vt}=I.getTileBoundsBuffers(De);J.draw(U,q.TRIANGLES,ve,Pe,ee,y.CullFaceMode.disabled,it,M.id,yt,We,vt)}}},background:function(I,g,M,C){const L=M.paint.get("background-color"),z=M.paint.get("background-opacity");if(z===0)return;const U=I.context,q=U.gl,Y=I.transform,J=Y.tileSize,ee=M.paint.get("background-pattern");if(I.isPatternMissing(ee))return;const ie=!ee&&L.a===1&&z===1&&I.opaquePassEnabledForLayer()?"opaque":"translucent";if(I.renderPass!==ie)return;const fe=y.StencilMode.disabled,be=I.depthModeForSublayer(0,ie==="opaque"?y.DepthMode.ReadWrite:y.DepthMode.ReadOnly),Te=I.colorModeForRenderPass(),xe=I.useProgram(ee?"backgroundPattern":"background");let Ie,ve=C;ve||(Ie=I.getBackgroundTiles(),ve=Object.values(Ie).map(De=>De.tileID)),ee&&(U.activeTexture.set(q.TEXTURE0),I.imageManager.bind(I.context));const ke=M.getCrossfadeParameters();for(const De of ve){const Ee=De.toUnwrapped(),Pe=C?De.projMatrix:I.transform.calculateProjMatrix(Ee);I.prepareDrawTile(De);const Oe=g?g.getTile(De):Ie?Ie[De.key]:new y.Tile(De,J,Y.zoom,I),Je=ee?jh(Pe,z,I,ee,{tileID:De,tileSize:J},ke):Vh(Pe,z,L);I.prepareDrawProgram(U,xe,Ee);const{tileBoundsBuffer:Ke,tileBoundsIndexBuffer:rt,tileBoundsSegments:nt}=I.getTileBoundsBuffers(Oe);xe.draw(U,q.TRIANGLES,be,fe,Te,y.CullFaceMode.disabled,Je,M.id,Ke,rt,nt)}},sky:function(I,g,M){const C=I.transform,L=C.projection.name==="mercator"?1:y.smoothstep(7,8,C.zoom),z=M.paint.get("sky-opacity")*L;if(z===0)return;const U=I.context,q=M.paint.get("sky-type"),Y=new y.DepthMode(U.gl.LEQUAL,y.DepthMode.ReadOnly,[0,1]),J=I.frameCounter/1e3%1;q==="atmosphere"?I.renderPass==="offscreen"?M.needsSkyboxCapture(I)&&(function(ee,ie,fe,be){const Te=ee.context,xe=Te.gl;let Ie=ie.skyboxFbo;if(!Ie){Ie=ie.skyboxFbo=Te.createFramebuffer(32,32,!1),ie.skyboxGeometry=new lo(Te),ie.skyboxTexture=Te.gl.createTexture(),xe.bindTexture(xe.TEXTURE_CUBE_MAP,ie.skyboxTexture),xe.texParameteri(xe.TEXTURE_CUBE_MAP,xe.TEXTURE_WRAP_S,xe.CLAMP_TO_EDGE),xe.texParameteri(xe.TEXTURE_CUBE_MAP,xe.TEXTURE_WRAP_T,xe.CLAMP_TO_EDGE),xe.texParameteri(xe.TEXTURE_CUBE_MAP,xe.TEXTURE_MIN_FILTER,xe.LINEAR),xe.texParameteri(xe.TEXTURE_CUBE_MAP,xe.TEXTURE_MAG_FILTER,xe.LINEAR);for(let Ee=0;Ee<6;++Ee)xe.texImage2D(xe.TEXTURE_CUBE_MAP_POSITIVE_X+Ee,0,xe.RGBA,32,32,0,xe.RGBA,xe.UNSIGNED_BYTE,null)}Te.bindFramebuffer.set(Ie.framebuffer),Te.viewport.set([0,0,32,32]);const ve=ie.getCenter(ee,!0),ke=ee.useProgram("skyboxCapture"),De=new Float64Array(16);y.identity(De),y.rotateY(De,De,.5*-Math.PI),Sn(Te,ie,ke,De,ve,0),y.identity(De),y.rotateY(De,De,.5*Math.PI),Sn(Te,ie,ke,De,ve,1),y.identity(De),y.rotateX(De,De,.5*-Math.PI),Sn(Te,ie,ke,De,ve,2),y.identity(De),y.rotateX(De,De,.5*Math.PI),Sn(Te,ie,ke,De,ve,3),y.identity(De),Sn(Te,ie,ke,De,ve,4),y.identity(De),y.rotateY(De,De,Math.PI),Sn(Te,ie,ke,De,ve,5),Te.viewport.set([0,0,ee.width,ee.height])}(I,M),M.markSkyboxValid(I)):I.renderPass==="sky"&&function(ee,ie,fe,be,Te){const xe=ee.context,Ie=xe.gl,ve=ee.transform,ke=ee.useProgram("skybox");xe.activeTexture.set(Ie.TEXTURE0),Ie.bindTexture(Ie.TEXTURE_CUBE_MAP,ie.skyboxTexture);const De=((Ee,Pe,Oe,Je,Ke)=>({u_matrix:Ee,u_sun_direction:Pe,u_cubemap:0,u_opacity:Je,u_temporal_offset:Ke}))(ve.skyboxMatrix,ie.getCenter(ee,!1),0,be,Te);ee.prepareDrawProgram(xe,ke),ke.draw(xe,Ie.TRIANGLES,fe,y.StencilMode.disabled,ee.colorModeForRenderPass(),y.CullFaceMode.backCW,De,"skybox",ie.skyboxGeometry.vertexBuffer,ie.skyboxGeometry.indexBuffer,ie.skyboxGeometry.segment)}(I,M,Y,z,J):q==="gradient"&&I.renderPass==="sky"&&function(ee,ie,fe,be,Te){const xe=ee.context,Ie=xe.gl,ve=ee.transform,ke=ee.useProgram("skyboxGradient");ie.skyboxGeometry||(ie.skyboxGeometry=new lo(xe)),xe.activeTexture.set(Ie.TEXTURE0);let De=ie.colorRampTexture;De||(De=ie.colorRampTexture=new y.Texture(xe,ie.colorRamp,Ie.RGBA)),De.bind(Ie.LINEAR,Ie.CLAMP_TO_EDGE);const Ee=((Pe,Oe,Je,Ke,rt)=>({u_matrix:Pe,u_color_ramp:0,u_center_direction:Oe,u_radius:y.degToRad(Je),u_opacity:Ke,u_temporal_offset:rt}))(ve.skyboxMatrix,ie.getCenter(ee,!1),ie.paint.get("sky-gradient-radius"),be,Te);ee.prepareDrawProgram(xe,ke),ke.draw(xe,Ie.TRIANGLES,fe,y.StencilMode.disabled,ee.colorModeForRenderPass(),y.CullFaceMode.backCW,Ee,"skyboxGradient",ie.skyboxGeometry.vertexBuffer,ie.skyboxGeometry.indexBuffer,ie.skyboxGeometry.segment)}(I,M,Y,z,J)},debug:function(I,g,M){for(let C=0;C<M.length;C++)Al(I,g,M[C])},custom:function(I,g,M){const C=I.context,L=M.implementation;if(I.transform.projection.name==="mercator"){if(I.renderPass==="offscreen"){const z=L.prerender;z&&(I.setCustomLayerDefaults(),C.setColorMode(I.colorModeForRenderPass()),z.call(L,C.gl,I.transform.customLayerMatrix()),C.setDirty(),I.setBaseState())}else if(I.renderPass==="translucent"){I.setCustomLayerDefaults(),C.setColorMode(I.colorModeForRenderPass()),C.setStencilMode(y.StencilMode.disabled);const z=L.renderingMode==="3d"?new y.DepthMode(I.context.gl.LEQUAL,y.DepthMode.ReadWrite,I.depthRangeFor3D):I.depthModeForSublayer(0,y.DepthMode.ReadOnly);C.setDepthMode(z),L.render(C.gl,I.transform.customLayerMatrix()),C.setDirty(),I.setBaseState(),C.bindFramebuffer.set(null)}}else y.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.")}};class Il{constructor(g,M){this.context=new Ur(g),this.transform=M,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=y.SourceCache.maxUnderzooming+y.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new ds,this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={}}updateTerrain(g,M){const C=!!g&&!!g.terrain&&this.transform.projection.name==="mercator";if(!(C||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new _a(this,g));const L=this._terrain;this.transform.elevation=C?L:null,L.update(g,this.transform,M)}_updateFog(g){const M=g.fog;if(!M||M.getOpacity(this.transform.pitch)<1||M.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[C,L]=M.getFovAdjustedRange(this.transform._fov);if(C>L)return void(this.transform.fogCullDistSq=null);const z=C+.78*(L-C);this.transform.fogCullDistSq=z*z}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(g,M){if(this.width=g*y.exported.devicePixelRatio,this.height=M*y.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const C of this.style.order)this.style._layers[C].resize()}setup(){const g=this.context,M=new y.StructArrayLayout2i4;M.emplaceBack(0,0),M.emplaceBack(y.EXTENT,0),M.emplaceBack(0,y.EXTENT),M.emplaceBack(y.EXTENT,y.EXTENT),this.tileExtentBuffer=g.createVertexBuffer(M,y.posAttributes.members),this.tileExtentSegments=y.SegmentVector.simpleSegment(0,0,4,2);const C=new y.StructArrayLayout2i4;C.emplaceBack(0,0),C.emplaceBack(y.EXTENT,0),C.emplaceBack(0,y.EXTENT),C.emplaceBack(y.EXTENT,y.EXTENT),this.debugBuffer=g.createVertexBuffer(C,y.posAttributes.members),this.debugSegments=y.SegmentVector.simpleSegment(0,0,4,5);const L=new y.StructArrayLayout2i4;L.emplaceBack(-1,-1),L.emplaceBack(1,-1),L.emplaceBack(-1,1),L.emplaceBack(1,1),this.viewportBuffer=g.createVertexBuffer(L,y.posAttributes.members),this.viewportSegments=y.SegmentVector.simpleSegment(0,0,4,2);const z=new y.StructArrayLayout4i8;z.emplaceBack(0,0,0,0),z.emplaceBack(y.EXTENT,0,y.EXTENT,0),z.emplaceBack(0,y.EXTENT,0,y.EXTENT),z.emplaceBack(y.EXTENT,y.EXTENT,y.EXTENT,y.EXTENT),this.mercatorBoundsBuffer=g.createVertexBuffer(z,y.boundsAttributes.members),this.mercatorBoundsSegments=y.SegmentVector.simpleSegment(0,0,4,2);const U=new y.StructArrayLayout3ui6;U.emplaceBack(0,1,2),U.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=g.createIndexBuffer(U);const q=new y.StructArrayLayout1ui2;for(const J of[0,1,3,2,0])q.emplaceBack(J);this.debugIndexBuffer=g.createIndexBuffer(q),this.emptyTexture=new y.Texture(g,{width:1,height:1,data:new Uint8Array([0,0,0,0])},g.gl.RGBA),this.identityMat=y.create$1();const Y=this.context.gl;this.stencilClearMode=new y.StencilMode({func:Y.ALWAYS,mask:0},0,255,Y.ZERO,Y.ZERO,Y.ZERO),this.loadTimeStamps.push(y.window.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(g){return g._makeTileBoundsBuffers(this.context,this.transform.projection),g._tileBoundsBuffer?{tileBoundsBuffer:g._tileBoundsBuffer,tileBoundsIndexBuffer:g._tileBoundsIndexBuffer,tileBoundsSegments:g._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const g=this.context,M=g.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this.useProgram("clippingMask").draw(g,M.TRIANGLES,y.DepthMode.disabled,this.stencilClearMode,y.ColorMode.disabled,y.CullFaceMode.disabled,Lo(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(g,M,C){if(!(M&&this.currentStencilSource!==M.id&&g.isTileClipped()&&C&&C.length))return;this.currentStencilSource=M.id;const L=this.context,z=L.gl;this.nextStencilID+C.length>256&&this.clearStencil(),L.setColorMode(y.ColorMode.disabled),L.setDepthMode(y.DepthMode.disabled);const U=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const q of C){const Y=M.getTile(q),J=this._tileClippingMaskIDs[q.key]=this.nextStencilID++,{tileBoundsBuffer:ee,tileBoundsIndexBuffer:ie,tileBoundsSegments:fe}=this.getTileBoundsBuffers(Y);U.draw(L,z.TRIANGLES,y.DepthMode.disabled,new y.StencilMode({func:z.ALWAYS,mask:0},J,255,z.KEEP,z.KEEP,z.REPLACE),y.ColorMode.disabled,y.CullFaceMode.disabled,Lo(q.projMatrix),"$clipping",ee,ie,fe)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const g=this.nextStencilID++,M=this.context.gl;return new y.StencilMode({func:M.NOTEQUAL,mask:255},g,255,M.KEEP,M.KEEP,M.REPLACE)}stencilModeForClipping(g){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(g);const M=this.context.gl;return new y.StencilMode({func:M.EQUAL,mask:255},this._tileClippingMaskIDs[g.key],0,M.KEEP,M.KEEP,M.REPLACE)}stencilConfigForOverlap(g){const M=this.context.gl,C=g.sort((U,q)=>q.overscaledZ-U.overscaledZ),L=C[C.length-1].overscaledZ,z=C[0].overscaledZ-L+1;if(z>1){this.currentStencilSource=void 0,this.nextStencilID+z>256&&this.clearStencil();const U={};for(let q=0;q<z;q++)U[q+L]=new y.StencilMode({func:M.GEQUAL,mask:255},q+this.nextStencilID,255,M.KEEP,M.KEEP,M.REPLACE);return this.nextStencilID+=z,[U,C]}return[{[L]:y.StencilMode.disabled},C]}colorModeForRenderPass(){const g=this.context.gl;if(this._showOverdrawInspector){const M=1/8;return new y.ColorMode([g.CONSTANT_COLOR,g.ONE],new y.Color(M,M,M,0),[!0,!0,!0,!0])}return this.renderPass==="opaque"?y.ColorMode.unblended:y.ColorMode.alphaBlended}depthModeForSublayer(g,M,C){if(!this.opaquePassEnabledForLayer())return y.DepthMode.disabled;const L=1-((1+this.currentLayer)*this.numSublayers+g)*this.depthEpsilon;return new y.DepthMode(C||this.context.gl.LEQUAL,M,[L,L])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(g,M){this.style=g,this.options=M,this.lineAtlas=g.lineAtlas,this.imageManager=g.imageManager,this.glyphManager=g.glyphManager,this.symbolFadeChange=g.placement.symbolFadeChange(y.exported.now()),this.imageManager.beginFrame();const C=this.style.order,L=this.style._sourceCaches;for(const J in L){const ee=L[J];ee.used&&ee.prepare(this.context)}const z={},U={},q={};for(const J in L){const ee=L[J];z[J]=ee.getVisibleCoordinates(),U[J]=z[J].slice().reverse(),q[J]=ee.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let J=0;J<C.length;J++)if(this.style._layers[C[J]].is3D()){this.opaquePassCutoff=J;break}if(this.terrain&&(this.terrain.updateTileBinding(q),this.opaquePassCutoff=0),!y.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const J of C){const ee=this.style._layers[J],ie=g._getLayerSourceCache(ee);if(!ee.hasOffscreenPass()||ee.isHidden(this.transform.zoom))continue;const fe=ie?U[ie.id]:void 0;(ee.type==="custom"||ee.isSky()||fe&&fe.length)&&this.renderLayer(this,ie,ee,fe)}this.depthRangeFor3D=[0,1-(g.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let Y=y.Color.transparent;if(this.style.fog&&this.style.fog.getOpacity(this.transform.pitch)&&(Y=this.style.fog.properties.get("color")),this.context.clear({color:M.showOverdrawInspector?y.Color.black:Y,depth:1}),this.clearStencil(),this._showOverdrawInspector=M.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=C.length-1;this.currentLayer>=0;this.currentLayer--){const J=this.style._layers[C[this.currentLayer]],ee=g._getLayerSourceCache(J);if(J.isSky())continue;const ie=ee?U[ee.id]:void 0;this._renderTileClippingMasks(J,ee,ie),this.renderLayer(this,ee,J,ie)}if(this.renderPass="sky",this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<C.length;this.currentLayer++){const J=this.style._layers[C[this.currentLayer]],ee=g._getLayerSourceCache(J);J.isSky()&&this.renderLayer(this,ee,J,ee?U[ee.id]:void 0)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<C.length;){const J=this.style._layers[C[this.currentLayer]],ee=g._getLayerSourceCache(J);if(J.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(J)){if(J.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const ie=ee?(J.type==="symbol"?q:U)[ee.id]:void 0;this._renderTileClippingMasks(J,ee,ee?z[ee.id]:void 0),this.renderLayer(this,ee,J,ie),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry){let J=null;y.values(this.style._layers).forEach(ee=>{const ie=g._getLayerSourceCache(ee);ie&&!ee.isHidden(this.transform.zoom)&&(!J||J.getSource().maxzoom<ie.getSource().maxzoom)&&(J=ie)}),J&&this.options.showTileBoundaries&&ks.debug(this,J,J.getVisibleCoordinates())}this.options.showPadding&&function(J){const ee=J.transform.padding;ao(J,J.transform.height-(ee.top||0),3,Ma),ao(J,ee.bottom||0,3,Ri),Sl(J,ee.left||0,3,As),Sl(J,J.transform.width-(ee.right||0),3,qh);const ie=J.transform.centerPoint;(function(fe,be,Te,xe){Is(fe,be-1,Te-10,2,20,xe),Is(fe,be-10,Te-1,20,2,xe)})(J,ie.x,J.transform.height-ie.y,Ml)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%y.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(y.window.performance.now()),this.saveCanvasCopy())}renderLayer(g,M,C,L){C.isHidden(this.transform.zoom)||(C.type==="background"||C.type==="sky"||C.type==="custom"||L&&L.length)&&(this.id=C.id,this.gpuTimingStart(C),ks[C.type](g,M,C,L,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(g){if(!this.options.gpuTiming)return;const M=this.context.extTimerQuery;let C=this.gpuTimers[g.id];C||(C=this.gpuTimers[g.id]={calls:0,cpuTime:0,query:M.createQueryEXT()}),C.calls++,M.beginQueryEXT(M.TIME_ELAPSED_EXT,C.query)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const g=this.context.extTimerQuery;g.endQueryEXT(g.TIME_ELAPSED_EXT)}collectGpuTimers(){const g=this.gpuTimers;return this.gpuTimers={},g}queryGpuTimers(g){const M={};for(const C in g){const L=g[C],z=this.context.extTimerQuery,U=z.getQueryObjectEXT(L.query,z.QUERY_RESULT_EXT)/1e6;z.deleteQueryEXT(L.query),M[C]=U}return M}translatePosMatrix(g,M,C,L,z){if(!C[0]&&!C[1])return g;const U=z?L==="map"?this.transform.angle:0:L==="viewport"?-this.transform.angle:0;if(U){const J=Math.sin(U),ee=Math.cos(U);C=[C[0]*ee-C[1]*J,C[0]*J+C[1]*ee]}const q=[z?C[0]:Ut(M,C[0],this.transform.zoom),z?C[1]:Ut(M,C[1],this.transform.zoom),0],Y=new Float32Array(16);return y.translate(Y,g,q),Y}saveTileTexture(g){const M=this._tileTextures[g.size[0]];M?M.push(g):this._tileTextures[g.size[0]]=[g]}getTileTexture(g){const M=this._tileTextures[g];return M&&M.length>0?M.pop():null}isPatternMissing(g){if(!g)return!1;if(!g.from||!g.to)return!0;const M=this.imageManager.getPattern(g.from.toString()),C=this.imageManager.getPattern(g.to.toString());return!M||!C}currentGlobalDefines(){const g=this.terrain&&this.terrain.renderingToTexture,M=this.style&&this.style.fog,C=[];return this.terrain&&!this.terrain.renderingToTexture&&C.push("TERRAIN"),M&&!g&&M.getOpacity(this.transform.pitch)!==0&&C.push("FOG"),g&&C.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&C.push("OVERDRAW_INSPECTOR"),C}useProgram(g,M,C){this.cache=this.cache||{};const L=C||[],z=this.currentGlobalDefines().concat(L),U=xs.cacheKey(g,z,M);return this.cache[U]||(this.cache[U]=new xs(this.context,g,ps[g],M,Gh[g],z)),this.cache[U]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const g=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(g.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=y.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new y.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}prepareDrawTile(g){this.terrain&&this.terrain.prepareDrawTile(g)}prepareDrawProgram(g,M,C){if(this.terrain&&this.terrain.renderingToTexture)return;const L=this.style.fog;if(L){const z=L.getOpacity(this.transform.pitch);z!==0&&M.setFogUniformValues(g,((U,q,Y,J)=>{const ee=q.properties.get("color"),ie=U.frameCounter/1e3%1,fe=[ee.r/ee.a,ee.g/ee.a,ee.b/ee.a,J];return{u_fog_matrix:Y?U.transform.calculateFogTileMatrix(Y):U.identityMat,u_fog_range:q.getFovAdjustedRange(U.transform._fov),u_fog_color:fe,u_fog_horizon_blend:q.properties.get("horizon-blend"),u_fog_temporal_offset:ie}})(this,L,C,z))}}setTileLoadedFlag(g){this.tileLoaded=g}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1}canvasCopy(){const g=this.context.gl,M=g.createTexture();return g.bindTexture(g.TEXTURE_2D,M),g.copyTexImage2D(g.TEXTURE_2D,0,g.RGBA,0,0,g.drawingBufferWidth,g.drawingBufferHeight,0),M}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const g=this.style&&this.style.fog;return!!g&&g.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const g=this._backgroundTiles,M=this._backgroundTiles={},C=this.transform.coveringTiles({tileSize:512});for(const L of C)M[L.key]=g[L.key]||new y.Tile(L,512,this.transform.tileZoom,this);return M}clearBackgroundTiles(){this._backgroundTiles={}}}class ho{constructor(g=0,M=0,C=0,L=0){if(isNaN(g)||g<0||isNaN(M)||M<0||isNaN(C)||C<0||isNaN(L)||L<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=g,this.bottom=M,this.left=C,this.right=L}interpolate(g,M,C){return M.top!=null&&g.top!=null&&(this.top=y.number(g.top,M.top,C)),M.bottom!=null&&g.bottom!=null&&(this.bottom=y.number(g.bottom,M.bottom,C)),M.left!=null&&g.left!=null&&(this.left=y.number(g.left,M.left,C)),M.right!=null&&g.right!=null&&(this.right=y.number(g.right,M.right,C)),this}getCenter(g,M){const C=y.clamp((this.left+g-this.right)/2,0,g),L=y.clamp((this.top+M-this.bottom)/2,0,M);return new y.pointGeometry(C,L)}equals(g){return this.top===g.top&&this.bottom===g.bottom&&this.left===g.left&&this.right===g.right}clone(){return new ho(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function An(I,g){return[I[4*g],I[4*g+1],I[4*g+2],I[4*g+3]]}function Hr(I,g,M){I[4*g+0]=M[0],I[4*g+1]=M[1],I[4*g+2]=M[2],I[4*g+3]=M[3]}function Cs(I,g){const M=An(I,3);y.fromQuat(I,g),Hr(I,3,M)}function Aa(I,g){Hr(I,3,[g[0],g[1],g[2],1])}function Ds(I,g){const M=y.identity$1([]);return y.rotateZ$1(M,M,-g),y.rotateX$1(M,M,-I),M}function In(I,g){const M=[I[0],I[1],0],C=[g[0],g[1],0];if(y.length(M)>=1e-15){const U=y.normalize([],M);y.scale(C,U,y.dot(C,U)),g[0]=C[0],g[1]=C[1]}const L=y.cross([],g,I);if(y.len(L)<1e-15)return null;const z=Math.atan2(-L[1],L[0]);return Ds(Math.atan2(Math.sqrt(I[0]*I[0]+I[1]*I[1]),-I[2]),z)}class Ia{constructor(g,M){this.position=g,this.orientation=M}get position(){return this._position}set position(g){this._position=this._renderWorldCopies?function(M){if(!M)return;const C=Array.isArray(M)?new y.MercatorCoordinate(M[0],M[1],M[2]):M;return C.x=y.wrap(C.x,0,1),C}(g):g}lookAtPoint(g,M){if(this.orientation=null,!this.position)return;const C=this._elevation?this._elevation.getAtPointOrZero(y.MercatorCoordinate.fromLngLat(g)):0,L=this.position,z=y.MercatorCoordinate.fromLngLat(g,C),U=[z.x-L.x,z.y-L.y,z.z-L.z];M||(M=[0,0,1]),M[2]=Math.abs(M[2]),this.orientation=In(U,M)}setPitchBearing(g,M){this.orientation=Ds(y.degToRad(g),y.degToRad(-M))}}class co{constructor(g,M){this._transform=y.identity([]),this._orientation=y.identity$1([]),M&&(this._orientation=M,Cs(this._transform,this._orientation)),g&&Aa(this._transform,g)}get mercatorPosition(){const g=this.position;return new y.MercatorCoordinate(g[0],g[1],g[2])}get position(){const g=An(this._transform,3);return[g[0],g[1],g[2]]}set position(g){Aa(this._transform,g)}get orientation(){return this._orientation}set orientation(g){this._orientation=g,Cs(this._transform,this._orientation)}getPitchBearing(){const g=this.forward(),M=this.right();return{bearing:Math.atan2(-M[1],M[0]),pitch:Math.atan2(Math.sqrt(g[0]*g[0]+g[1]*g[1]),-g[2])}}setPitchBearing(g,M){this._orientation=Ds(g,M),Cs(this._transform,this._orientation)}forward(){const g=An(this._transform,2);return[-g[0],-g[1],-g[2]]}up(){const g=An(this._transform,1);return[-g[0],-g[1],-g[2]]}right(){const g=An(this._transform,0);return[g[0],g[1],g[2]]}getCameraToWorld(g,M){const C=new Float64Array(16);return y.invert(C,this.getWorldToCamera(g,M)),C}getWorldToCameraPosition(g,M,C){const L=this.position;y.scale(L,L,-g);const z=new Float64Array(16);return y.fromScaling(z,[C,C,C]),y.translate(z,z,L),z[10]*=M,z}getWorldToCamera(g,M){const C=new Float64Array(16),L=new Float64Array(4),z=this.position;return y.conjugate(L,this._orientation),y.scale(z,z,-g),y.fromQuat(C,L),y.translate(C,C,z),C[1]*=-1,C[5]*=-1,C[9]*=-1,C[13]*=-1,C[8]*=M,C[9]*=M,C[10]*=M,C[11]*=M,C}getCameraToClipPerspective(g,M,C,L){const z=new Float64Array(16);return y.perspective(z,g,M,C,L),z}getDistanceToElevation(g){const M=g===0?0:y.mercatorZfromAltitude(g,this.position[1]),C=this.forward();return(M-this.position[2])/C[2]}clone(){return new co([...this.position],[...this.orientation])}}function Ps(I,g){const M=ka(I),C=function(z,U,q,Y,J){const ee=new y.LngLat(q.lng-180*qn,q.lat),ie=new y.LngLat(q.lng+180*qn,q.lat),fe=z.project(ee.lng,ee.lat),be=z.project(ie.lng,ie.lat),Te=-Math.atan2(be.y-fe.y,be.x-fe.x),xe=y.MercatorCoordinate.fromLngLat(q);xe.y=y.clamp(xe.y,-.999975,.999975);const Ie=xe.toLngLat(),ve=z.project(Ie.lng,Ie.lat),ke=y.MercatorCoordinate.fromLngLat(Ie);ke.x+=qn;const De=ke.toLngLat(),Ee=z.project(De.lng,De.lat),Pe=kl(Ee.x-ve.x,Ee.y-ve.y,Te),Oe=y.MercatorCoordinate.fromLngLat(Ie);Oe.y+=qn;const Je=Oe.toLngLat(),Ke=z.project(Je.lng,Je.lat),rt=kl(Ke.x-ve.x,Ke.y-ve.y,Te),nt=Math.abs(Pe.x)/Math.abs(rt.y),_t=y.identity([]);y.rotateZ(_t,_t,-Te*(1-(J?0:Y)));const it=y.identity([]);return y.scale$1(it,it,[1,1-(1-nt)*Y,1]),it[4]=-rt.x/rt.y*Y,y.rotateZ(it,it,Te),y.multiply(it,_t,it),it}(I.projection,0,I.center,M,g),L=Oo(I);return y.scale$1(C,C,[L,L,1]),C}function Oo(I){const g=I.projection,M=ka(I),C=Zn(g,I.center),L=Zn(g,y.LngLat.convert(g.center));return Math.pow(2,C*M+(1-M)*L)}function ka(I){const g=I.projection.range;if(!g)return 0;const M=Math.max(I.width,I.height),C=Math.log(M/1024)/Math.LN2;return y.smoothstep(g[0]+C,g[1]+C,I.zoom)}const qn=1/4e4;function Zn(I,g){const M=y.clamp(g.lat,-y.MAX_MERCATOR_LATITUDE,y.MAX_MERCATOR_LATITUDE),C=new y.LngLat(g.lng-180*qn,M),L=new y.LngLat(g.lng+180*qn,M),z=I.project(C.lng,M),U=I.project(L.lng,M),q=y.MercatorCoordinate.fromLngLat(C),Y=y.MercatorCoordinate.fromLngLat(L),J=U.x-z.x,ee=U.y-z.y,ie=Y.x-q.x,fe=Y.y-q.y,be=Math.sqrt((ie*ie+fe*fe)/(J*J+ee*ee));return Math.log(be)/Math.LN2}function kl(I,g,M){const C=Math.cos(M),L=Math.sin(M);return{x:I*C-g*L,y:I*L+g*C}}class Ca{constructor(g,M,C,L,z){this.tileSize=512,this._renderWorldCopies=z===void 0||z,this._minZoom=g||0,this._maxZoom=M||22,this._minPitch=C==null?0:C,this._maxPitch=L==null?60:L,this.setProjection(),this.setMaxBounds(),this.width=0,this.height=0,this._center=new y.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new ho,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new co,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._horizonShift=.1}clone(){const g=new Ca(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return g._elevation=this._elevation,g._centerAltitude=this._centerAltitude,g.tileSize=this.tileSize,g.setMaxBounds(this.getMaxBounds()),g.width=this.width,g.height=this.height,g.cameraElevationReference=this.cameraElevationReference,g._center=this._center,g._setZoom(this.zoom),g._cameraZoom=this._cameraZoom,g.angle=this.angle,g._fov=this._fov,g._pitch=this._pitch,g._averageElevation=this._averageElevation,g._unmodified=this._unmodified,g._edgeInsets=this._edgeInsets.clone(),g._camera=this._camera.clone(),g._calcMatrices(),g.freezeTileCoverage=this.freezeTileCoverage,g.setProjection(this.getProjection()),g}get elevation(){return this._elevation}set elevation(g){this._elevation!==g&&(this._elevation=g,g?this._updateCenterElevation()&&this._updateCameraOnTerrain():(this._cameraZoom=null,this._centerAltitude=0),this._calcMatrices())}updateElevation(g){this._terrainEnabled()&&this._cameraZoom==null&&this._updateCenterElevation()&&this._updateCameraOnTerrain(),g&&this._constrainCameraAltitude(),this._calcMatrices()}getProjection(){return y.pick(this.projection,["name","center","parallels"])}setProjection(g){g==null&&(g={name:"mercator"}),this.projectionOptions=g;const M=this.projection?this.getProjection():void 0;return this.projection=y.getProjection(g),!N(M,this.getProjection())&&(this._calcMatrices(),!0)}get minZoom(){return this._minZoom}set minZoom(g){this._minZoom!==g&&(this._minZoom=g,this.zoom=Math.max(this.zoom,g))}get maxZoom(){return this._maxZoom}set maxZoom(g){this._maxZoom!==g&&(this._maxZoom=g,this.zoom=Math.min(this.zoom,g))}get minPitch(){return this._minPitch}set minPitch(g){this._minPitch!==g&&(this._minPitch=g,this.pitch=Math.max(this.pitch,g))}get maxPitch(){return this._maxPitch}set maxPitch(g){this._maxPitch!==g&&(this._maxPitch=g,this.pitch=Math.min(this.pitch,g))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.wrap===!0}set renderWorldCopies(g){g===void 0?g=!0:g===null&&(g=!1),this._renderWorldCopies=g}get worldSize(){return this.tileSize*this.scale}get cameraWorldSize(){const g=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(g))}get pixelsPerMeter(){return y.mercatorZfromAltitude(1,this.center.lat)*this.worldSize}get cameraPixelsPerMeter(){return y.mercatorZfromAltitude(1,this.center.lat)*this.cameraWorldSize}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new y.pointGeometry(this.width,this.height)}get bearing(){return y.wrap(this.rotation,-180,180)}set bearing(g){this.rotation=g}get rotation(){return-this.angle/Math.PI*180}set rotation(g){const M=-g*Math.PI/180;var C;this.angle!==M&&(this._unmodified=!1,this.angle=M,this._calcMatrices(),this.rotationMatrix=(C=new y.ARRAY_TYPE(4),y.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0),C[0]=1,C[3]=1,C),function(L,z,U){var q=z[0],Y=z[1],J=z[2],ee=z[3],ie=Math.sin(U),fe=Math.cos(U);L[0]=q*fe+J*ie,L[1]=Y*fe+ee*ie,L[2]=q*-ie+J*fe,L[3]=Y*-ie+ee*fe}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(g){const M=y.clamp(g,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==M&&(this._unmodified=!1,this._pitch=M,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(g){g=Math.max(.01,Math.min(60,g)),this._fov!==g&&(this._unmodified=!1,this._fov=g/180*Math.PI,this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(g){this._averageElevation=g,this._calcFogMatrices()}get zoom(){return this._zoom}set zoom(g){const M=Math.min(Math.max(g,this.minZoom),this.maxZoom);this._zoom!==M&&(this._unmodified=!1,this._setZoom(M),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._constrain(),this._calcMatrices())}_setZoom(g){this._zoom=g,this.scale=this.zoomScale(g),this.tileZoom=Math.floor(g),this.zoomFraction=g-this.tileZoom}_updateCenterElevation(){if(!this._elevation)return!1;const g=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center),-1);return g===-1?(this._cameraZoom=null,!1):(this._centerAltitude=g,!0)}_updateCameraOnTerrain(){const g=this.cameraToCenterDistance/this.worldSize,M=y.mercatorZfromAltitude(this._centerAltitude,this.center.lat);this._cameraZoom=this._zoomFromMercatorZ(M+g)}sampleAverageElevation(){if(!this._elevation)return 0;const g=this._elevation,M=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],C=this.horizonLineFromTop();let L=0,z=0;for(let U=0;U<M.length;U++){const q=new y.pointGeometry(M[U][0]*this.width,C+M[U][1]*(this.height-C)),Y=g.pointCoordinate(q);if(!Y)continue;const J=1/Math.hypot(Y[0]-this._camera.position[0],Y[1]-this._camera.position[1]);L+=Y[3]*J,z+=J}return z===0?NaN:L/z}get center(){return this._center}set center(g){g.lat===this._center.lat&&g.lng===this._center.lng||(this._unmodified=!1,this._center=g,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCenterElevation()?this._updateCameraOnTerrain():this._cameraZoom=null:this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._cameraZoom==null||!this._elevation)return;const g=this._cameraZoom,M=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),C=y.mercatorZfromAltitude(M,this.center.lat),L=this._mercatorZfromZoom(g),z=this._mercatorZfromZoom(this._maxZoom),U=Math.max(L-C,z);this._setZoom(this._zoomFromMercatorZ(U))}get padding(){return this._edgeInsets.toJSON()}set padding(g){this._edgeInsets.equals(g)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,g,1),this._calcMatrices())}computeZoomRelativeTo(g){const M=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,g.toAltitude()));let C;C=g.z<this._camera.position[2]?[M.x,M.y,M.z]:[g.x,g.y,g.z];const L=y.length(y.sub([],this._camera.position,C));return y.clamp(this._zoomFromMercatorZ(L),this._minZoom,this._maxZoom)}setFreeCameraOptions(g){if(!this.height||!g.position&&!g.orientation)return;this._updateCameraState();let M=!1;if(g.orientation&&!y.exactEquals(g.orientation,this._camera.orientation)&&(M=this._setCameraOrientation(g.orientation)),g.position){const C=[g.position.x,g.position.y,g.position.z];y.exactEquals$1(C,this._camera.position)||(this._setCameraPosition(C),M=!0)}M&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const g=this._camera.position,M=new Ia;return M.position=new y.MercatorCoordinate(g[0],g[1],g[2]),M.orientation=this._camera.orientation,M._elevation=this.elevation,M._renderWorldCopies=this.renderWorldCopies,M}_setCameraOrientation(g){if(!y.length$1(g))return!1;y.normalize$1(g,g);const M=y.transformQuat([],[0,0,-1],g),C=y.transformQuat([],[0,-1,0],g);if(C[2]<0)return!1;const L=In(M,C);return!!L&&(this._camera.orientation=L,!0)}_setCameraPosition(g){const M=this.zoomScale(this.minZoom)*this.tileSize,C=this.zoomScale(this.maxZoom)*this.tileSize,L=this.cameraToCenterDistance;g[2]=y.clamp(g[2],L/C,L/M),this._camera.position=g}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(g){return this._edgeInsets.equals(g)}interpolatePadding(g,M,C){this._unmodified=!1,this._edgeInsets.interpolate(g,M,C),this._constrain(),this._calcMatrices()}coveringZoomLevel(g){const M=(g.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/g.tileSize));return Math.max(0,M)}getVisibleUnwrappedCoordinates(g){const M=[new y.UnwrappedTileID(0,g)];if(this.renderWorldCopies){const C=this.pointCoordinate(new y.pointGeometry(0,0)),L=this.pointCoordinate(new y.pointGeometry(this.width,0)),z=this.pointCoordinate(new y.pointGeometry(this.width,this.height)),U=this.pointCoordinate(new y.pointGeometry(0,this.height)),q=Math.floor(Math.min(C.x,L.x,z.x,U.x)),Y=Math.floor(Math.max(C.x,L.x,z.x,U.x)),J=1;for(let ee=q-J;ee<=Y+J;ee++)ee!==0&&M.push(new y.UnwrappedTileID(ee,g))}return M}coveringTiles(g){let M=this.coveringZoomLevel(g);const C=M,L=this.elevation&&!g.isTerrainDEM,z=this.projection.name==="mercator";if(g.minzoom!==void 0&&M<g.minzoom)return[];g.maxzoom!==void 0&&M>g.maxzoom&&(M=g.maxzoom);const U=this.locationCoordinate(this.center),q=1<<M,Y=[q*U.x,q*U.y,0],J=me.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,M),ee=this.pointCoordinate(this.getCameraPoint()),ie=q*y.mercatorZfromAltitude(1,this.center.lat),fe=this._camera.position[2]/y.mercatorZfromAltitude(1,this.center.lat),be=[q*ee.x,q*ee.y,fe],Te=this.cameraToCenterDistance/g.tileSize*(g.roundZoom?1:.502),xe=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&z?M:0,Ie=g.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,ve=g.isTerrainDEM?-Ie:this._elevation?this._elevation.getMinElevationBelowMSL():0,ke=Oo(this),De=We=>{const vt=1/4e4,Ot=new y.MercatorCoordinate(We.x+vt,We.y,We.z),Qt=new y.MercatorCoordinate(We.x,We.y+vt,We.z),ni=We.toLngLat(),si=Ot.toLngLat(),ai=Qt.toLngLat(),Wt=this.locationCoordinate(ni),fi=this.locationCoordinate(si),Li=this.locationCoordinate(ai),ar=Math.hypot(fi.x-Wt.x,fi.y-Wt.y),wr=Math.hypot(Li.x-Wt.x,Li.y-Wt.y);return Math.sqrt(ar*wr)*ke/vt},Ee=(We,vt,Ot,Qt,ni,si)=>{const ai=y.tileTransform({z:We,x:vt,y:Ot},this.projection);return new Re([(Qt+ai.x/ai.scale)*q,q*(ai.y/ai.scale),ni],[(Qt+ai.x2/ai.scale)*q,q*(ai.y2/ai.scale),si])},Pe=We=>({aabb:Ee(0,0,0,We,ve,Ie),zoom:0,x:0,y:0,wrap:We,fullyVisible:!1}),Oe=[];let Je=[];const Ke=M,rt=g.reparseOverscaled?C:M,nt=We=>{if(!this._elevation||!We.tileID)return;const vt=this._elevation.getMinMaxForTile(We.tileID),Ot=We.aabb;vt?(Ot.min[2]=vt.min,Ot.max[2]=vt.max,Ot.center[2]=(Ot.min[2]+Ot.max[2])/2):(We.shouldSplit=yt(We),We.shouldSplit||(Ot.min[2]=Ot.max[2]=Ot.center[2]=this._centerAltitude))},_t=We=>We*We,it=_t((fe-this._centerAltitude)*ie),yt=We=>{if(We.zoom<xe)return!0;if(We.zoom===Ke)return!1;if(We.shouldSplit!=null)return We.shouldSplit;const vt=We.aabb.distanceX(be),Ot=We.aabb.distanceY(be);let Qt=it;L&&(Qt=_t(We.aabb.distanceZ(be)*ie));let ni=1;if(!z&&C<=5){const ai=Math.pow(2,We.zoom),Wt=De(new y.MercatorCoordinate((We.x+.5)/ai,(We.y+.5)/ai));ni=Wt>.85?1:Wt}const si=vt*vt+Ot*Ot+Qt;return si<_t((1<<Ke-We.zoom)*Te*ni*((ai,Wt)=>{if(Wt*_t(.707)<ai)return 1;const fi=Math.sqrt(Wt/ai);return fi/(1.4144271570014144+(Math.pow(1.1,fi-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(Qt,it),si))};if(this.renderWorldCopies)for(let We=1;We<=3;We++)Oe.push(Pe(-We)),Oe.push(Pe(We));for(Oe.push(Pe(0));Oe.length>0;){const We=Oe.pop(),vt=We.x,Ot=We.y;let Qt=We.fullyVisible;if(!Qt){const ni=We.aabb.intersects(J);if(ni===0)continue;Qt=ni===2}if(We.zoom!==Ke&&yt(We))for(let ni=0;ni<4;ni++){const si=(vt<<1)+ni%2,ai=(Ot<<1)+(ni>>1),Wt={aabb:this.projection.name==="mercator"?We.aabb.quadrant(ni):Ee(We.zoom+1,si,ai,We.wrap,0,0),zoom:We.zoom+1,x:si,y:ai,wrap:We.wrap,fullyVisible:Qt,tileID:void 0,shouldSplit:void 0};L&&(Wt.tileID=new y.OverscaledTileID(We.zoom+1===Ke?rt:We.zoom+1,We.wrap,We.zoom+1,si,ai),nt(Wt)),Oe.push(Wt)}else{const ni=We.zoom===Ke?rt:We.zoom;if(g.minzoom&&g.minzoom>ni)continue;const si=Y[0]-(.5+vt+(We.wrap<<We.zoom))*(1<<M-We.zoom),ai=Y[1]-.5-Ot,Wt=We.tileID?We.tileID:new y.OverscaledTileID(ni,We.wrap,We.zoom,vt,Ot);Je.push({tileID:Wt,distanceSq:si*si+ai*ai})}}if(this.fogCullDistSq){const We=this.fogCullDistSq,vt=this.horizonLineFromTop();Je=Je.filter(Ot=>{const Qt=[0,0,0,1],ni=[y.EXTENT,y.EXTENT,0,1],si=this.calculateFogTileMatrix(Ot.tileID.toUnwrapped());y.transformMat4(Qt,Qt,si),y.transformMat4(ni,ni,si);const ai=y.getAABBPointSquareDist(Qt,ni);if(ai===0)return!0;let Wt=!1;const fi=this._elevation;if(fi&&ai>We&&vt!==0){const Li=this.calculateProjMatrix(Ot.tileID.toUnwrapped());let ar;g.isTerrainDEM||(ar=fi.getMinMaxForTile(Ot.tileID)),ar||(ar={min:ve,max:Ie});const wr=y.furthestTileCorner(this.rotation),kr=[wr[0]*y.EXTENT,wr[1]*y.EXTENT,ar.max];y.transformMat4$1(kr,kr,Li),Wt=(1-kr[1])*this.height*.5<vt}return ai<We||Wt})}return Je.sort((We,vt)=>We.distanceSq-vt.distanceSq).map(We=>We.tileID)}resize(g,M){this.width=g,this.height=M,this.pixelsToGLUnits=[2/g,-2/M],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(g){return Math.pow(2,g)}scaleZoom(g){return Math.log(g)/Math.LN2}project(g){const M=y.clamp(g.lat,-y.MAX_MERCATOR_LATITUDE,y.MAX_MERCATOR_LATITUDE),C=this.projection.project(g.lng,M);return new y.pointGeometry(C.x*this.worldSize,C.y*this.worldSize)}unproject(g){return this.projection.unproject(g.x/this.worldSize,g.y/this.worldSize)}get point(){return this.project(this.center)}setLocationAtPoint(g,M){const C=this.pointCoordinate(M),L=this.pointCoordinate(this.centerPoint),z=this.locationCoordinate(g);this.setLocation(new y.MercatorCoordinate(z.x-(C.x-L.x),z.y-(C.y-L.y)))}setLocation(g){this.center=this.coordinateLocation(g),this.renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(g){return this._coordinatePoint(this.locationCoordinate(g),!1)}locationPoint3D(g){return this._coordinatePoint(this.locationCoordinate(g),!0)}pointLocation(g){return this.coordinateLocation(this.pointCoordinate(g))}pointLocation3D(g){return this.coordinateLocation(this.pointCoordinate3D(g))}locationCoordinate(g,M){const C=M?y.mercatorZfromAltitude(M,g.lat):void 0,L=this.projection.project(g.lng,g.lat);return new y.MercatorCoordinate(L.x,L.y,C)}coordinateLocation(g){return this.projection.unproject(g.x,g.y)}pointRayIntersection(g,M){const C=M!=null?M:this._centerAltitude,L=[g.x,g.y,0,1],z=[g.x,g.y,1,1];y.transformMat4(L,L,this.pixelMatrixInverse),y.transformMat4(z,z,this.pixelMatrixInverse);const U=z[3];y.scale$2(L,L,1/L[3]),y.scale$2(z,z,1/U);const q=L[2],Y=z[2];return{p0:L,p1:z,t:q===Y?0:(C-q)/(Y-q)}}screenPointToMercatorRay(g){const M=[g.x,g.y,0,1],C=[g.x,g.y,1,1];return y.transformMat4(M,M,this.pixelMatrixInverse),y.transformMat4(C,C,this.pixelMatrixInverse),y.scale$2(M,M,1/M[3]),y.scale$2(C,C,1/C[3]),M[2]=y.mercatorZfromAltitude(M[2],this._center.lat)*this.worldSize,C[2]=y.mercatorZfromAltitude(C[2],this._center.lat)*this.worldSize,y.scale$2(M,M,1/this.worldSize),y.scale$2(C,C,1/this.worldSize),new he([M[0],M[1],M[2]],y.normalize([],y.sub([],C,M)))}rayIntersectionCoordinate(g){const{p0:M,p1:C,t:L}=g,z=y.mercatorZfromAltitude(M[2],this._center.lat),U=y.mercatorZfromAltitude(C[2],this._center.lat);return new y.MercatorCoordinate(y.number(M[0],C[0],L)/this.worldSize,y.number(M[1],C[1],L)/this.worldSize,y.number(z,U,L))}pointCoordinate(g,M=this._centerAltitude){const C=this.horizonLineFromTop(!1),L=new y.pointGeometry(g.x,Math.max(C,g.y));return this.rayIntersectionCoordinate(this.pointRayIntersection(L,M))}pointCoordinate3D(g){if(!this.elevation)return this.pointCoordinate(g);const M=this.elevation;let C=this.elevation.pointCoordinate(g);if(C)return new y.MercatorCoordinate(C[0],C[1],C[2]);let L=0,z=this.horizonLineFromTop();if(g.y>z)return this.pointCoordinate(g);const U=.02*z,q=g.clone();for(let Y=0;Y<10&&z-L>U;Y++){q.y=y.number(L,z,.66);const J=M.pointCoordinate(q);J?(z=q.y,C=J):L=q.y}return C?new y.MercatorCoordinate(C[0],C[1],C[2]):this.pointCoordinate(g)}isPointAboveHorizon(g){if(this.elevation)return!this.elevation.pointCoordinate(g);{const M=this.horizonLineFromTop();return g.y<M}}_coordinatePoint(g,M){const C=M&&this.elevation?this.elevation.getAtPointOrZero(g,this._centerAltitude):this._centerAltitude,L=[g.x*this.worldSize,g.y*this.worldSize,C+g.toAltitude(),1];return y.transformMat4(L,L,this.pixelMatrix),L[3]>0?new y.pointGeometry(L[0]/L[3],L[1]/L[3]):new y.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getBounds(g,M){const C=new y.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),L=new y.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),z=new y.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),U=new y.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let q=this.pointCoordinate(C,g),Y=this.pointCoordinate(L,g);const J=this.pointCoordinate(z,M),ee=this.pointCoordinate(U,M),ie=(fe,be)=>(be.y-fe.y)/(be.x-fe.x);return q.y>1&&Y.y>=0?q=new y.MercatorCoordinate((1-ee.y)/ie(ee,q)+ee.x,1):q.y<0&&Y.y<=1&&(q=new y.MercatorCoordinate(-ee.y/ie(ee,q)+ee.x,0)),Y.y>1&&q.y>=0?Y=new y.MercatorCoordinate((1-J.y)/ie(J,Y)+J.x,1):Y.y<0&&q.y<=1&&(Y=new y.MercatorCoordinate(-J.y/ie(J,Y)+J.x,0)),new y.LngLatBounds().extend(this.coordinateLocation(q)).extend(this.coordinateLocation(Y)).extend(this.coordinateLocation(ee)).extend(this.coordinateLocation(J))}_getBounds3D(){const g=this.elevation,M=g.visibleDemTiles.reduce((C,L)=>{if(L.dem){const z=L.dem.tree;C.min=Math.min(C.min,z.minimums[0]),C.max=Math.max(C.max,z.maximums[0])}return C},{min:Number.MAX_VALUE,max:0});return this._getBounds(M.min*g.exaggeration(),M.max*g.exaggeration())}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0)}horizonLineFromTop(g=!0){const M=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,C=this.height/2-M*(1-this._horizonShift);return g?Math.max(0,C):C}getMaxBounds(){return this.maxBounds}setMaxBounds(g){this.maxBounds=g,this.minLat=-y.MAX_MERCATOR_LATITUDE,this.maxLat=y.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,g&&(this.minLat=g.getSouth(),this.maxLat=g.getNorth(),this.minLng=g.getWest(),this.maxLng=g.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=y.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=y.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=y.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=y.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(g,M){let C,L,z;const U=g.canonical,q=y.identity(new Float64Array(16));if(this.projection.name==="mercator")C=M/this.zoomScale(U.z),L=(U.x+Math.pow(2,U.z)*g.wrap)*C,z=U.y*C;else{const Y=y.tileTransform(U,this.projection);C=1,L=Y.x+g.wrap*Y.scale,z=Y.y,y.scale$1(q,q,[C/Y.scale,C/Y.scale,this.pixelsPerMeter/this.worldSize])}return y.translate(q,q,[L,z,0]),y.scale$1(q,q,[C/y.EXTENT,C/y.EXTENT,1]),q}calculateDistanceTileData(g){const M=g.key,C=this._distanceTileDataCache;if(C[M])return C[M];const L=g.canonical,z=1/this.height,U=this.cameraWorldSize/this.zoomScale(L.z),q=(L.x+Math.pow(2,L.z)*g.wrap)*U,Y=L.y*U,J=this.point,ee=this.angle,ie=Math.sin(-ee),fe=-Math.cos(-ee);return C[M]={bearing:[ie,fe],center:[(J.x-q)*z,(J.y-Y)*z],scale:U/y.EXTENT*z},C[M]}calculateFogTileMatrix(g){const M=g.key,C=this._fogTileMatrixCache;if(C[M])return C[M];const L=this.calculatePosMatrix(g,this.cameraWorldSize);return y.multiply(L,this.worldToFogMatrix,L),C[M]=new Float32Array(L),C[M]}calculateProjMatrix(g,M=!1){const C=g.key,L=M?this._alignedProjMatrixCache:this._projMatrixCache;if(L[C])return L[C];const z=this.calculatePosMatrix(g,this.worldSize);return y.multiply(z,this.projection.name==="mercator"?M?this.alignedProjMatrix:this.projMatrix:this.mercatorMatrix,z),L[C]=new Float32Array(z),L[C]}calculatePixelsToTileUnitsMatrix(g){const M=g.tileID.key,C=this._pixelsToTileUnitsCache;if(C[M])return C[M];const L=function(z,U){const{scale:q}=z.tileTransform,Y=q*y.EXTENT/(z.tileSize*Math.pow(2,U.zoom-z.tileID.overscaledZ+z.tileID.canonical.z));return J=new Float32Array(4),fe=(ee=U.inverseAdjustmentMatrix)[1],be=ee[2],Te=ee[3],Ie=(ie=[Y,Y])[1],J[0]=ee[0]*(xe=ie[0]),J[1]=fe*xe,J[2]=be*Ie,J[3]=Te*Ie,J;var J,ee,ie,fe,be,Te,xe,Ie}(g,this);return C[M]=L,C[M]}customLayerMatrix(){return this.mercatorMatrix.slice()}recenterOnTerrain(){if(!this._elevation)return;const g=this._elevation;this._updateCameraState();const M=this._camera.position,C=this._camera.forward();if(M[2]<=0||C[2]>=0)return;const L=y.mercatorZfromAltitude(1,this._center.lat);M[2]/=L,C[2]/=L,y.normalize(C,C);const z=g.raycast(M,C,g.exaggeration());if(z){const U=y.scaleAndAdd([],M,C,z),q=new y.MercatorCoordinate(U[0],U[1],y.mercatorZfromAltitude(U[2],y.latFromMercatorY(U[1]))),Y=this._camera.position,J=q.z+y.length([q.x-Y[0],q.y-Y[1],q.z-Y[2]]);this._cameraZoom=this._zoomFromMercatorZ(J),this._centerAltitude=q.toAltitude(),this._center=this.coordinateLocation(q),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCameraAltitude(){if(!this._elevation)return;const g=this._elevation;this._updateCameraState();const M=g.getAtPointOrZero(this._camera.mercatorPosition),C=this._minimumHeightOverTerrain()*Math.cos(y.degToRad(this._maxPitch)),L=y.mercatorZfromAltitude(M,this._center.lat),z=this._camera.position[2]-L;if(z<C){const U=this.locationCoordinate(this._center,this._centerAltitude),q=this._camera.mercatorPosition,Y=[U.x-q.x,U.y-q.y,U.z-q.z],J=y.length(Y);Y[2]-=C-z;const ee=y.length(Y);if(ee===0)return;y.scale(Y,Y,J/ee),this._camera.position=[U.x-Y[0],U.y-Y[1],U.z-Y[2]],this._camera.orientation=In(Y,this._camera.up()),this._updateStateFromCamera()}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;if(this._constraining=!0,this.projection.name!=="mercator"){const ie=this.center;return ie.lat=y.clamp(ie.lat,this.minLat,this.maxLat),!this.maxBounds&&this.renderWorldCopies||(ie.lng=y.clamp(ie.lng,this.minLng,this.maxLng)),this.center=ie,void(this._constraining=!1)}const g=this._unmodified,{x:M,y:C}=this.point;let L=0,z=M,U=C;const q=this.width/2,Y=this.height/2,J=this.worldMinY*this.scale,ee=this.worldMaxY*this.scale;if(C-Y<J&&(U=J+Y),C+Y>ee&&(U=ee-Y),ee-J<this.height&&(L=Math.max(L,this.height/(ee-J)),U=(ee+J)/2),this.maxBounds||!this.renderWorldCopies){const ie=this.worldMinX*this.scale,fe=this.worldMaxX*this.scale,be=this.worldSize/2-(ie+fe)/2;z=(M+be+this.worldSize)%this.worldSize-be,z-q<ie&&(z=ie+q),z+q>fe&&(z=fe-q),fe-ie<this.width&&(L=Math.max(L,this.width/(fe-ie)),z=(fe+ie)/2)}z===M&&U===C||(this.center=this.unproject(new y.pointGeometry(z,U))),L&&(this.zoom+=this.scaleZoom(L)),this._constrainCameraAltitude(),this._unmodified=g,this._constraining=!1}_minZoomForBounds(){let g=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(g=Math.max(g,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),g}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const g=this.centerOffset;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height;const M=this.pixelsPerMeter;this._updateCameraState();const C=Math.PI/2+this._pitch,L=this.fovAboveCenter,z=this.elevation?this.elevation.getMinElevationBelowMSL()*M:0,U=(this._camera.position[2]*this.worldSize-z)/Math.cos(this._pitch),q=Math.sin(L)*U/Math.sin(y.clamp(Math.PI-C-L,.01,Math.PI-.01)),Y=this.point,J=Y.x,ee=Y.y,ie=Math.cos(Math.PI/2-this._pitch)*q+U,fe=Math.min(1.01*ie,U*(1/this._horizonShift)),be=this.height/50,Te=this._camera.getWorldToCamera(this.worldSize,M),xe=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,be,fe);xe[8]=2*-g.x/this.width,xe[9]=2*g.y/this.height;let Ie=y.mul$1([],xe,Te);if(this.projection.name!=="mercator"){const _t=this.locationCoordinate(this.center),it=y.identity([]);y.translate(it,it,[_t.x*this.worldSize,_t.y*this.worldSize,0]),y.multiply(it,it,Ps(this)),y.translate(it,it,[-_t.x*this.worldSize,-_t.y*this.worldSize,0]),y.multiply(Ie,Ie,it),this.inverseAdjustmentMatrix=function(yt){const We=Ps(yt,!0);return se([],[We[0],We[1],We[4],We[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=y.scale$1([],Ie,[this.worldSize,this.worldSize,this.worldSize/M]),this.projMatrix=Ie,this.invProjMatrix=y.invert(new Float64Array(16),this.projMatrix);const ve=new Float32Array(16);y.identity(ve),y.scale$1(ve,ve,[1,-1,1]),y.rotateX(ve,ve,this._pitch),y.rotateZ(ve,ve,this.angle);const ke=y.perspective(new Float32Array(16),this._fov,this.width/this.height,be,fe),De=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;ke[8]=2*-g.x/this.width,ke[9]=2*(g.y+De)/this.height,this.skyboxMatrix=y.multiply(ve,ke,ve);const Ee=this.width%2/2,Pe=this.height%2/2,Oe=Math.cos(this.angle),Je=Math.sin(this.angle),Ke=J-Math.round(J)+Oe*Ee+Je*Pe,rt=ee-Math.round(ee)+Oe*Pe+Je*Ee,nt=new Float64Array(Ie);if(y.translate(nt,nt,[Ke>.5?Ke-1:Ke,rt>.5?rt-1:rt,0]),this.alignedProjMatrix=nt,Ie=y.create$1(),y.scale$1(Ie,Ie,[this.width/2,-this.height/2,1]),y.translate(Ie,Ie,[1,-1,0]),this.labelPlaneMatrix=Ie,Ie=y.create$1(),y.scale$1(Ie,Ie,[1,-1,1]),y.translate(Ie,Ie,[-1,-1,0]),y.scale$1(Ie,Ie,[2/this.width,2/this.height,1]),this.glCoordMatrix=Ie,this.pixelMatrix=y.multiply(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},Ie=y.invert(new Float64Array(16),this.pixelMatrix),!Ie)throw new Error("failed to invert matrix");this.pixelMatrixInverse=Ie,this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const g=this.cameraWorldSize,M=this.cameraPixelsPerMeter,C=this._camera.position,L=1/this.height,z=[g,g,M];y.scale(z,z,L),y.scale(C,C,-1),y.multiply$1(C,C,z);const U=y.create$1();y.translate(U,U,C),y.scale$1(U,U,z),this.mercatorFogMatrix=U,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(g,M,L)}_updateCameraState(){if(!this.height)return;this._camera.setPitchBearing(this._pitch,this.angle);const g=this._camera.forward(),M=this.cameraToCenterDistance,C=this.point,L=this._mercatorZfromZoom(this._cameraZoom?this._cameraZoom:this._zoom)-y.mercatorZfromAltitude(this._centerAltitude,this.center.lat),z=this.cameraToCenterDistance/L;this._camera.position=[C.x/this.worldSize-g[0]*M/z,C.y/this.worldSize-g[1]*M/z,y.mercatorZfromAltitude(this._centerAltitude,this._center.lat)+-g[2]*M/z]}_translateCameraConstrained(g){const M=this._maxCameraBoundsDistance()*Math.cos(this._pitch),C=g[2];let L=1;C>0&&(L=Math.min((M-this._camera.position[2])/C,1)),this._camera.position=y.scaleAndAdd([],this._camera.position,g,L),this._updateStateFromCamera()}_updateStateFromCamera(){const g=this._camera.position,M=this._camera.forward(),{pitch:C,bearing:L}=this._camera.getPitchBearing(),z=y.mercatorZfromAltitude(this._centerAltitude,this.center.lat),U=this._mercatorZfromZoom(this._maxZoom)*Math.cos(y.degToRad(this._maxPitch)),q=Math.max((g[2]-z)/Math.cos(C),U),Y=this._zoomFromMercatorZ(q);y.scaleAndAdd(g,g,M,q),this._pitch=y.clamp(C,y.degToRad(this.minPitch),y.degToRad(this.maxPitch)),this.angle=y.wrap(L,-Math.PI,Math.PI),this._setZoom(y.clamp(Y,this._minZoom,this._maxZoom)),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._center=this.coordinateLocation(new y.MercatorCoordinate(g[0],g[1],g[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(g){return Math.pow(2,g)*this.tileSize}_mercatorZfromZoom(g){return this.cameraToCenterDistance/this._worldSizeFromZoom(g)}_minimumHeightOverTerrain(){const g=Math.min((this._cameraZoom!=null?this._cameraZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(g)}_zoomFromMercatorZ(g){return this.scaleZoom(this.cameraToCenterDistance/(g*this.tileSize))}_terrainEnabled(){return!(!this._elevation||this.projection.name!=="mercator"&&(y.warnOnce("Terrain is not yet supported with alternate projections. Use mercator to enable terrain."),1))}anyCornerOffEdge(g,M){const C=Math.min(g.x,M.x),L=Math.max(g.x,M.x),z=Math.min(g.y,M.y),U=Math.max(g.y,M.y);if(z<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const q=[new y.pointGeometry(C,z),new y.pointGeometry(L,U),new y.pointGeometry(C,U),new y.pointGeometry(L,z)],Y=this.renderWorldCopies?-3:0,J=this.renderWorldCopies?4:1;for(const ee of q){const ie=this.pointRayIntersection(ee);if(ie.t<0)return!0;const fe=this.rayIntersectionCoordinate(ie);if(fe.x<Y||fe.y<0||fe.x>J||fe.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+y.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new y.pointGeometry(0,0),new y.pointGeometry(this.width,this.height))}zoomDeltaToMovement(g,M){const C=y.length(y.sub([],this._camera.position,g)),L=this._zoomFromMercatorZ(C)+M;return C-this._mercatorZfromZoom(L)}getCameraPoint(){const g=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new y.pointGeometry(0,g))}}function Da(I,g){let M=!1,C=null;const L=()=>{C=null,M&&(I(),C=setTimeout(L,g),M=!1)};return()=>(M=!0,C||L(),C)}class Rs{constructor(g){this._hashName=g&&encodeURIComponent(g),y.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Da(this._updateHashUnthrottled.bind(this),300)}addTo(g){return this._map=g,y.window.addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return y.window.removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(g){const M=this._map.getCenter(),C=Math.round(100*this._map.getZoom())/100,L=Math.ceil((C*Math.LN2+Math.log(512/360/.5))/Math.LN10),z=Math.pow(10,L),U=Math.round(M.lng*z)/z,q=Math.round(M.lat*z)/z,Y=this._map.getBearing(),J=this._map.getPitch();let ee="";if(ee+=g?`/${U}/${q}/${C}`:`${C}/${q}/${U}`,(Y||J)&&(ee+="/"+Math.round(10*Y)/10),J&&(ee+=`/${Math.round(J)}`),this._hashName){const ie=this._hashName;let fe=!1;const be=y.window.location.hash.slice(1).split("&").map(Te=>{const xe=Te.split("=")[0];return xe===ie?(fe=!0,`${xe}=${ee}`):Te}).filter(Te=>Te);return fe||be.push(`${ie}=${ee}`),`#${be.join("&")}`}return`#${ee}`}_getCurrentHash(){const g=y.window.location.hash.replace("#","");if(this._hashName){let M;return g.split("&").map(C=>C.split("=")).forEach(C=>{C[0]===this._hashName&&(M=C)}),(M&&M[1]||"").split("/")}return g.split("/")}_onHashChange(){const g=this._getCurrentHash();if(g.length>=3&&!g.some(M=>isNaN(M))){const M=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(g[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+g[2],+g[1]],zoom:+g[0],bearing:M,pitch:+(g[4]||0)}),!0}return!1}_updateHashUnthrottled(){const g=y.window.location.href.replace(/(#.+)?$/,this.getHashString());y.window.history.replaceState(y.window.history.state,null,g)}}const uo={linearity:.3,easing:y.bezier(0,0,.3,1)},Cl=y.extend({deceleration:2500,maxSpeed:1400},uo),Dl=y.extend({deceleration:20,maxSpeed:1400},uo),Bs=y.extend({deceleration:1e3,maxSpeed:360},uo),Pa=y.extend({deceleration:1e3,maxSpeed:90},uo);class Pl{constructor(g){this._map=g,this.clear()}clear(){this._inertiaBuffer=[]}record(g){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:y.exported.now(),settings:g})}_drainInertiaBuffer(){const g=this._inertiaBuffer,M=y.exported.now();for(;g.length>0&&M-g[0].time>160;)g.shift()}_onMoveEnd(g){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const M={zoom:0,bearing:0,pitch:0,pan:new y.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:z}of this._inertiaBuffer)M.zoom+=z.zoomDelta||0,M.bearing+=z.bearingDelta||0,M.pitch+=z.pitchDelta||0,z.panDelta&&M.pan._add(z.panDelta),z.around&&(M.around=z.around),z.pinchAround&&(M.pinchAround=z.pinchAround);const C=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,L={};if(M.pan.mag()){const z=No(M.pan.mag(),C,y.extend({},Cl,g||{}));L.offset=M.pan.mult(z.amount/M.pan.mag()),L.center=this._map.transform.center,$o(L,z)}if(M.zoom){const z=No(M.zoom,C,Dl);L.zoom=this._map.transform.zoom+z.amount,$o(L,z)}if(M.bearing){const z=No(M.bearing,C,Bs);L.bearing=this._map.transform.bearing+y.clamp(z.amount,-179,179),$o(L,z)}if(M.pitch){const z=No(M.pitch,C,Pa);L.pitch=this._map.transform.pitch+z.amount,$o(L,z)}if(L.zoom||L.bearing){const z=M.pinchAround===void 0?M.around:M.pinchAround;L.around=z?this._map.unproject(z):this._map.getCenter()}return this.clear(),y.extend(L,{noMoveStart:!0})}}function $o(I,g){(!I.duration||I.duration<g.duration)&&(I.duration=g.duration,I.easing=g.easing)}function No(I,g,M){const{maxSpeed:C,linearity:L,deceleration:z}=M,U=y.clamp(I*L/(g/1e3),-C,C),q=Math.abs(U)/(z*L);return{easing:M.easing,duration:1e3*q,amount:U*(q/2)}}class Or extends y.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(g,M,C,L={}){const z=j.mousePos(M.getCanvasContainer(),C),U=M.unproject(z);super(g,y.extend({point:z,lngLat:U,originalEvent:C},L)),this._defaultPrevented=!1,this.target=M}}class Uo extends y.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(g,M,C){const L=g==="touchend"?C.changedTouches:C.touches,z=j.touchPos(M.getCanvasContainer(),L),U=z.map(Y=>M.unproject(Y)),q=z.reduce((Y,J,ee,ie)=>Y.add(J.div(ie.length)),new y.pointGeometry(0,0));super(g,{points:z,point:q,lngLats:U,lngLat:M.unproject(q),originalEvent:C}),this._defaultPrevented=!1}}class fo extends y.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(g,M,C){super(g,{originalEvent:C}),this._defaultPrevented=!1}}class Rl{constructor(g,M){this._map=g,this._clickTolerance=M.clickTolerance}reset(){delete this._mousedownPos}wheel(g){return this._firePreventable(new fo(g.type,this._map,g))}mousedown(g,M){return this._mousedownPos=M,this._firePreventable(new Or(g.type,this._map,g))}mouseup(g){this._map.fire(new Or(g.type,this._map,g))}preclick(g){const M=y.extend({},g);M.type="preclick",this._map.fire(new Or(M.type,this._map,M))}click(g,M){this._mousedownPos&&this._mousedownPos.dist(M)>=this._clickTolerance||(this.preclick(g),this._map.fire(new Or(g.type,this._map,g)))}dblclick(g){return this._firePreventable(new Or(g.type,this._map,g))}mouseover(g){this._map.fire(new Or(g.type,this._map,g))}mouseout(g){this._map.fire(new Or(g.type,this._map,g))}touchstart(g){return this._firePreventable(new Uo(g.type,this._map,g))}touchmove(g){this._map.fire(new Uo(g.type,this._map,g))}touchend(g){this._map.fire(new Uo(g.type,this._map,g))}touchcancel(g){this._map.fire(new Uo(g.type,this._map,g))}_firePreventable(g){if(this._map.fire(g),g.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Bl{constructor(g){this._map=g}reset(){this._delayContextMenu=!1,delete this._contextMenuEvent}mousemove(g){this._map.fire(new Or(g.type,this._map,g))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Or("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(g){this._delayContextMenu?this._contextMenuEvent=g:this._map.fire(new Or(g.type,this._map,g)),this._map.listens("contextmenu")&&g.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ll{constructor(g,M){this._map=g,this._el=g.getCanvasContainer(),this._container=g.getContainer(),this._clickTolerance=M.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(g,M){this.isEnabled()&&g.shiftKey&&g.button===0&&(j.disableDrag(),this._startPos=this._lastPos=M,this._active=!0)}mousemoveWindow(g,M){if(!this._active)return;const C=M;if(this._lastPos.equals(C)||!this._box&&C.dist(this._startPos)<this._clickTolerance)return;const L=this._startPos;this._lastPos=C,this._box||(this._box=j.create("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",g));const z=Math.min(L.x,C.x),U=Math.max(L.x,C.x),q=Math.min(L.y,C.y),Y=Math.max(L.y,C.y);this._map._requestDomTask(()=>{this._box&&(j.setTransform(this._box,`translate(${z}px,${q}px)`),this._box.style.width=U-z+"px",this._box.style.height=Y-q+"px")})}mouseupWindow(g,M){if(!this._active||g.button!==0)return;const C=this._startPos,L=M;if(this.reset(),j.suppressClick(),C.x!==L.x||C.y!==L.y)return this._map.fire(new y.Event("boxzoomend",{originalEvent:g})),{cameraAnimation:z=>z.fitScreenCoordinates(C,L,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",g)}keydown(g){this._active&&g.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",g))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(j.remove(this._box),this._box=null),j.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(g,M){return this._map.fire(new y.Event(g,{originalEvent:M}))}}function Ls(I,g){const M={};for(let C=0;C<I.length;C++)M[I[C].identifier]=g[C];return M}class zl{constructor(g){this.reset(),this.numTouches=g.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(g,M,C){(this.centroid||C.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=g.timeStamp),C.length===this.numTouches&&(this.centroid=function(L){const z=new y.pointGeometry(0,0);for(const U of L)z._add(U);return z.div(L.length)}(M),this.touches=Ls(C,M)))}touchmove(g,M,C){if(this.aborted||!this.centroid)return;const L=Ls(C,M);for(const z in this.touches){const U=this.touches[z],q=L[z];(!q||q.dist(U)>30)&&(this.aborted=!0)}}touchend(g,M,C){if((!this.centroid||g.timeStamp-this.startTime>500)&&(this.aborted=!0),C.length===0){const L=!this.aborted&&this.centroid;if(this.reset(),L)return L}}}class zs{constructor(g){this.singleTap=new zl(g),this.numTaps=g.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(g,M,C){this.singleTap.touchstart(g,M,C)}touchmove(g,M,C){this.singleTap.touchmove(g,M,C)}touchend(g,M,C){const L=this.singleTap.touchend(g,M,C);if(L){const z=g.timeStamp-this.lastTime<500,U=!this.lastTap||this.lastTap.dist(L)<30;if(z&&U||this.reset(),this.count++,this.lastTime=g.timeStamp,this.lastTap=L,this.count===this.numTaps)return this.reset(),L}}}class Ir{constructor(){this._zoomIn=new zs({numTouches:1,numTaps:2}),this._zoomOut=new zs({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(g,M,C){this._zoomIn.touchstart(g,M,C),this._zoomOut.touchstart(g,M,C)}touchmove(g,M,C){this._zoomIn.touchmove(g,M,C),this._zoomOut.touchmove(g,M,C)}touchend(g,M,C){const L=this._zoomIn.touchend(g,M,C),z=this._zoomOut.touchend(g,M,C);return L?(this._active=!0,g.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:U=>U.easeTo({duration:300,zoom:U.getZoom()+1,around:U.unproject(L)},{originalEvent:g})}):z?(this._active=!0,g.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:U=>U.easeTo({duration:300,zoom:U.getZoom()-1,around:U.unproject(z)},{originalEvent:g})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Xh={0:1,2:2};class nn{constructor(g){this.reset(),this._clickTolerance=g.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,delete this._lastPoint,delete this._eventButton}_correctButton(g,M){return!1}_move(g,M){return{}}mousedown(g,M){if(this._lastPoint)return;const C=j.mouseButton(g);this._correctButton(g,C)&&(this._lastPoint=M,this._eventButton=C)}mousemoveWindow(g,M){const C=this._lastPoint;if(C){if(g.preventDefault(),function(L,z){const U=Xh[z];return L.buttons===void 0||(L.buttons&U)!==U}(g,this._eventButton))this.reset();else if(this._moved||!(M.dist(C)<this._clickTolerance))return this._moved=!0,this._lastPoint=M,this._move(C,M)}}mouseupWindow(g){this._lastPoint&&j.mouseButton(g)===this._eventButton&&(this._moved&&j.suppressClick(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Fl extends nn{mousedown(g,M){super.mousedown(g,M),this._lastPoint&&(this._active=!0)}_correctButton(g,M){return M===0&&!g.ctrlKey}_move(g,M){return{around:M,panDelta:M.sub(g)}}}class pn extends nn{_correctButton(g,M){return M===0&&g.ctrlKey||M===2}_move(g,M){const C=.8*(M.x-g.x);if(C)return this._active=!0,{bearingDelta:C}}contextmenu(g){g.preventDefault()}}class Xn extends nn{_correctButton(g,M){return M===0&&g.ctrlKey||M===2}_move(g,M){const C=-.5*(M.y-g.y);if(C)return this._active=!0,{pitchDelta:C}}contextmenu(g){g.preventDefault()}}class Yh{constructor(g,M){this._map=g,this._el=g.getCanvasContainer(),this._minTouches=1,this._clickTolerance=M.clickTolerance||1,this.reset(),y.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new y.pointGeometry(0,0)}touchstart(g,M,C){return this._calculateTransform(g,M,C)}touchmove(g,M,C){if(this._active&&!(C.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(C.length===1)return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return g.preventDefault(),this._calculateTransform(g,M,C)}}touchend(g,M,C){this._calculateTransform(g,M,C),this._active&&C.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(g,M,C){C.length>0&&(this._active=!0);const L=Ls(C,M),z=new y.pointGeometry(0,0),U=new y.pointGeometry(0,0);let q=0;for(const J in L){const ee=L[J],ie=this._touches[J];ie&&(z._add(ee),U._add(ee.sub(ie)),q++,L[J]=ee)}if(this._touches=L,q<this._minTouches||!U.mag())return;const Y=U.div(q);return this._sum._add(Y),this._sum.mag()<this._clickTolerance?void 0:{around:z.div(q),panDelta:Y}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=j.create("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show")},500)}}class Ra{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}_start(g){}_move(g,M,C){return{}}touchstart(g,M,C){this._firstTwoTouches||C.length<2||(this._firstTwoTouches=[C[0].identifier,C[1].identifier],this._start([M[0],M[1]]))}touchmove(g,M,C){if(!this._firstTwoTouches)return;g.preventDefault();const[L,z]=this._firstTwoTouches,U=Fs(C,M,L),q=Fs(C,M,z);if(!U||!q)return;const Y=this._aroundCenter?null:U.add(q).div(2);return this._move([U,q],Y,g)}touchend(g,M,C){if(!this._firstTwoTouches)return;const[L,z]=this._firstTwoTouches,U=Fs(C,M,L),q=Fs(C,M,z);U&&q||(this._active&&j.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(g){this._enabled=!0,this._aroundCenter=!!g&&g.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Fs(I,g,M){for(let C=0;C<I.length;C++)if(I[C].identifier===M)return g[C]}function Ol(I,g){return Math.log(I/g)/Math.LN2}class $l extends Ra{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(g){this._startDistance=this._distance=g[0].dist(g[1])}_move(g,M){const C=this._distance;if(this._distance=g[0].dist(g[1]),this._active||!(Math.abs(Ol(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Ol(this._distance,C),pinchAround:M}}}function po(I,g){return 180*I.angleWith(g)/Math.PI}class cn extends Ra{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(g){this._startVector=this._vector=g[0].sub(g[1]),this._minDiameter=g[0].dist(g[1])}_move(g,M){const C=this._vector;if(this._vector=g[0].sub(g[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:po(this._vector,C),pinchAround:M}}_isBelowThreshold(g){this._minDiameter=Math.min(this._minDiameter,g.mag());const M=25/(Math.PI*this._minDiameter)*360,C=po(g,this._startVector);return Math.abs(C)<M}}function Os(I){return Math.abs(I.y)>Math.abs(I.x)}class Nl extends Ra{constructor(g){super(),this._map=g}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}_start(g){this._lastPoints=g,Os(g[0].sub(g[1]))&&(this._valid=!1)}_move(g,M,C){const L=g[0].sub(this._lastPoints[0]),z=g[1].sub(this._lastPoints[1]);if(!(this._map._cooperativeGestures&&C.touches.length<3)&&(this._valid=this.gestureBeginsVertically(L,z,C.timeStamp),this._valid))return this._lastPoints=g,this._active=!0,{pitchDelta:(L.y+z.y)/2*-.5}}gestureBeginsVertically(g,M,C){if(this._valid!==void 0)return this._valid;const L=g.mag()>=2,z=M.mag()>=2;if(!L&&!z)return;if(!L||!z)return this._firstMove===void 0&&(this._firstMove=C),C-this._firstMove<100&&void 0;const U=g.y>0==M.y>0;return Os(g)&&Os(M)&&U}}const Vo={panStep:100,bearingStep:15,pitchStep:10};class Ft{constructor(){const g=Vo;this._panStep=g.panStep,this._bearingStep=g.bearingStep,this._pitchStep=g.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(g){if(g.altKey||g.ctrlKey||g.metaKey)return;let M=0,C=0,L=0,z=0,U=0;switch(g.keyCode){case 61:case 107:case 171:case 187:M=1;break;case 189:case 109:case 173:M=-1;break;case 37:g.shiftKey?C=-1:(g.preventDefault(),z=-1);break;case 39:g.shiftKey?C=1:(g.preventDefault(),z=1);break;case 38:g.shiftKey?L=1:(g.preventDefault(),U=-1);break;case 40:g.shiftKey?L=-1:(g.preventDefault(),U=1);break;default:return}return this._rotationDisabled&&(C=0,L=0),{cameraAnimation:q=>{const Y=q.getZoom();q.easeTo({duration:300,easeId:"keyboardHandler",easing:Ul,zoom:M?Math.round(Y)+M*(g.shiftKey?2:1):Y,bearing:q.getBearing()+C*this._bearingStep,pitch:q.getPitch()+L*this._pitchStep,offset:[-z*this._panStep,-U*this._panStep],center:q.getCenter()},{originalEvent:g})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Ul(I){return I*(2-I)}const Ba=4.000244140625;class jo{constructor(g,M){this._map=g,this._el=g.getCanvasContainer(),this._handler=M,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,y.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert","_isFullscreen"],this)}setZoomRate(g){this._defaultZoomRate=g}setWheelZoomRate(g){this._wheelZoomRate=g}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(g){this.isEnabled()||(this._enabled=!0,this._aroundCenter=g&&g.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(g){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(g.ctrlKey||g.metaKey||this.isZooming()||this._isFullscreen()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let M=g.deltaMode===y.window.WheelEvent.DOM_DELTA_LINE?40*g.deltaY:g.deltaY;const C=y.exported.now(),L=C-(this._lastWheelEventTime||0);this._lastWheelEventTime=C,M!==0&&M%Ba==0?this._type="wheel":M!==0&&Math.abs(M)<4?this._type="trackpad":L>400?(this._type=null,this._lastValue=M,this._timeout=setTimeout(this._onTimeout,40,g)):this._type||(this._type=Math.abs(L*M)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,M+=this._lastValue)),g.shiftKey&&M&&(M/=4),this._type&&(this._lastWheelEvent=g,this._delta-=M,this._active||this._start(g)),g.preventDefault()}_onTimeout(g){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(g)}_start(g){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const M=j.mousePos(this._el,g);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:M,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const g=this._map.transform,M=()=>g._terrainEnabled()?g.computeZoomRelativeTo(this._aroundCoord):g.zoom;if(this._delta!==0){const Y=this._type==="wheel"&&Math.abs(this._delta)>Ba?this._wheelZoomRate:this._defaultZoomRate;let J=2/(1+Math.exp(-Math.abs(this._delta*Y)));this._delta<0&&J!==0&&(J=1/J);const ee=M(),ie=Math.pow(2,ee),fe=typeof this._targetZoom=="number"?g.zoomScale(this._targetZoom):ie;this._targetZoom=Math.min(g.maxZoom,Math.max(g.minZoom,g.scaleZoom(fe*J))),this._type==="wheel"&&(this._startZoom=M(),this._easing=this._smoothOutEasing(200)),this._delta=0}const C=typeof this._targetZoom=="number"?this._targetZoom:M(),L=this._startZoom,z=this._easing;let U,q=!1;if(this._type==="wheel"&&L&&z){const Y=Math.min((y.exported.now()-this._lastWheelEventTime)/200,1),J=z(Y);U=y.number(L,C,J),Y<1?this._frameId||(this._frameId=!0):q=!0}else U=C,q=!0;return this._active=!0,q&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!q,zoomDelta:U-M(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(g){let M=y.ease;if(this._prevEase){const C=this._prevEase,L=(y.exported.now()-C.start)/C.duration,z=C.easing(L+.01)-C.easing(L),U=.27/Math.sqrt(z*z+1e-4)*.01,q=Math.sqrt(.0729-U*U);M=y.bezier(U,q,.25,1)}return this._prevEase={start:y.exported.now(),duration:g,easing:M},M}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=j.create("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(y.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_isFullscreen(){return!!y.window.document.fullscreenElement}_showBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show")},200)}}class Go{constructor(g,M){this._clickZoom=g,this._tapZoom=M}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Vl{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(g,M){return g.preventDefault(),{cameraAnimation:C=>{C.easeTo({duration:300,zoom:C.getZoom()+(g.shiftKey?-1:1),around:C.unproject(M)},{originalEvent:g})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class jl{constructor(){this._tap=new zs({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,this._tap.reset()}touchstart(g,M,C){this._swipePoint||(this._tapTime&&g.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?C.length>0&&(this._swipePoint=M[0],this._swipeTouch=C[0].identifier):this._tap.touchstart(g,M,C))}touchmove(g,M,C){if(this._tapTime){if(this._swipePoint){if(C[0].identifier!==this._swipeTouch)return;const L=M[0],z=L.y-this._swipePoint.y;return this._swipePoint=L,g.preventDefault(),this._active=!0,{zoomDelta:z/128}}}else this._tap.touchmove(g,M,C)}touchend(g,M,C){this._tapTime?this._swipePoint&&C.length===0&&this.reset():this._tap.touchend(g,M,C)&&(this._tapTime=g.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Gl{constructor(g,M,C){this._el=g,this._mousePan=M,this._touchPan=C}enable(g){this._inertiaOptions=g||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class ql{constructor(g,M,C){this._pitchWithRotate=g.pitchWithRotate,this._mouseRotate=M,this._mousePitch=C}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Zl{constructor(g,M,C,L){this._el=g,this._touchZoom=M,this._touchRotate=C,this._tapDragZoom=L,this._rotationDisabled=!1,this._enabled=!0}enable(g){this._touchZoom.enable(g),this._rotationDisabled||this._touchRotate.enable(g),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const qo=I=>I.zoom||I.drag||I.pitch||I.rotate;class Xl extends y.Event{}class $s{constructor(){this.constants=[1,1,.01],this.radius=0}setup(g,M){const C=y.sub([],M,g);this.radius=y.length(C[2]<0?y.div([],C,this.constants):[C[0],C[1],0])}projectRay(g){y.div(g,g,this.constants),y.normalize(g,g),y.mul$2(g,g,this.constants);const M=y.scale([],g,this.radius);if(M[2]>0){const C=y.scale([],[0,0,1],y.dot(M,[0,0,1])),L=y.scale([],y.normalize([],[M[0],M[1],0]),this.radius),z=y.add([],M,y.scale([],y.sub([],y.add([],L,C),M),2));M[0]=z[0],M[1]=z[1]}return M}}function mo(I){return I.panDelta&&I.panDelta.mag()||I.zoomDelta||I.bearingDelta||I.pitchDelta}class Ns{constructor(g,M){this._map=g,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Pl(g),this._bearingSnap=M.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new $s,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(M),y.bindAll(["handleEvent","handleWindowEvent"],this);const C=this._el;this._listeners=[[C,"touchstart",{passive:!0}],[C,"touchmove",{passive:!1}],[C,"touchend",void 0],[C,"touchcancel",void 0],[C,"mousedown",void 0],[C,"mousemove",void 0],[C,"mouseup",void 0],[y.window.document,"mousemove",{capture:!0}],[y.window.document,"mouseup",void 0],[C,"mouseover",void 0],[C,"mouseout",void 0],[C,"dblclick",void 0],[C,"click",void 0],[C,"keydown",{capture:!1}],[C,"keyup",void 0],[C,"wheel",{passive:!1}],[C,"contextmenu",void 0],[y.window,"blur",void 0]];for(const[L,z,U]of this._listeners)j.addEventListener(L,z,L===y.window.document?this.handleWindowEvent:this.handleEvent,U)}destroy(){for(const[g,M,C]of this._listeners)j.removeEventListener(g,M,g===y.window.document?this.handleWindowEvent:this.handleEvent,C)}_addDefaultHandlers(g){const M=this._map,C=M.getCanvasContainer();this._add("mapEvent",new Rl(M,g));const L=M.boxZoom=new Ll(M,g);this._add("boxZoom",L);const z=new Ir,U=new Vl;M.doubleClickZoom=new Go(U,z),this._add("tapZoom",z),this._add("clickZoom",U);const q=new jl;this._add("tapDragZoom",q);const Y=M.touchPitch=new Nl(M);this._add("touchPitch",Y);const J=new pn(g),ee=new Xn(g);M.dragRotate=new ql(g,J,ee),this._add("mouseRotate",J,["mousePitch"]),this._add("mousePitch",ee,["mouseRotate"]);const ie=new Fl(g),fe=new Yh(M,g);M.dragPan=new Gl(C,ie,fe),this._add("mousePan",ie),this._add("touchPan",fe,["touchZoom","touchRotate"]);const be=new cn,Te=new $l;M.touchZoomRotate=new Zl(C,Te,be,q),this._add("touchRotate",be,["touchPan","touchZoom"]),this._add("touchZoom",Te,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Bl(M));const xe=M.scrollZoom=new jo(M,this);this._add("scrollZoom",xe,["mousePan"]);const Ie=M.keyboard=new Ft;this._add("keyboard",Ie);for(const ve of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])g.interactive&&g[ve]&&M[ve].enable(g[ve])}_add(g,M,C){this._handlers.push({handlerName:g,handler:M,allowed:C}),this._handlersById[g]=M}stop(g){if(!this._updatingCamera){for(const{handler:M}of this._handlers)M.reset();this._inertia.clear(),this._fireEvents({},{},g),this._changes=[]}}isActive(){for(const{handler:g}of this._handlers)if(g.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(qo(this._eventsInProgress))||this.isZooming()}_blockedByActive(g,M,C){for(const L in g)if(L!==C&&(!M||M.indexOf(L)<0))return!0;return!1}handleWindowEvent(g){this.handleEvent(g,`${g.type}Window`)}_getMapTouches(g){const M=[];for(const C of g)this._el.contains(C.target)&&M.push(C);return M}handleEvent(g,M){this._updatingCamera=!0;const C=g.type==="renderFrame",L=C?void 0:g,z={needsRenderFrame:!1},U={},q={},Y=g.touches?this._getMapTouches(g.touches):void 0,J=Y?j.touchPos(this._el,Y):C?void 0:j.mousePos(this._el,g);for(const{handlerName:fe,handler:be,allowed:Te}of this._handlers){if(!be.isEnabled())continue;let xe;this._blockedByActive(q,Te,fe)?be.reset():be[M||g.type]&&(xe=be[M||g.type](g,J,Y),this.mergeHandlerResult(z,U,xe,fe,L),xe&&xe.needsRenderFrame&&this._triggerRenderFrame()),(xe||be.isActive())&&(q[fe]=be)}const ee={};for(const fe in this._previousActiveHandlers)q[fe]||(ee[fe]=L);this._previousActiveHandlers=q,(Object.keys(ee).length||mo(z))&&(this._changes.push([z,U,ee]),this._triggerRenderFrame()),(Object.keys(q).length||mo(z))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ie}=z;ie&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ie(this._map))}mergeHandlerResult(g,M,C,L,z){if(!C)return;y.extend(g,C);const U={handlerName:L,originalEvent:C.originalEvent||z};C.zoomDelta!==void 0&&(M.zoom=U),C.panDelta!==void 0&&(M.drag=U),C.pitchDelta!==void 0&&(M.pitch=U),C.bearingDelta!==void 0&&(M.rotate=U)}_applyChanges(){const g={},M={},C={};for(const[L,z,U]of this._changes)L.panDelta&&(g.panDelta=(g.panDelta||new y.pointGeometry(0,0))._add(L.panDelta)),L.zoomDelta&&(g.zoomDelta=(g.zoomDelta||0)+L.zoomDelta),L.bearingDelta&&(g.bearingDelta=(g.bearingDelta||0)+L.bearingDelta),L.pitchDelta&&(g.pitchDelta=(g.pitchDelta||0)+L.pitchDelta),L.around!==void 0&&(g.around=L.around),L.aroundCoord!==void 0&&(g.aroundCoord=L.aroundCoord),L.pinchAround!==void 0&&(g.pinchAround=L.pinchAround),L.noInertia&&(g.noInertia=L.noInertia),y.extend(M,z),y.extend(C,U);this._updateMapTransform(g,M,C),this._changes=[]}_updateMapTransform(g,M,C){const L=this._map,z=L.transform,U=ke=>[ke.x,ke.y,ke.z];if((ke=>{const De=this._eventsInProgress.drag;return De&&!this._handlersById[De.handlerName].isActive()})()&&!mo(g)){const ke=z.zoom;z.cameraElevationReference="sea",z.recenterOnTerrain(),z.cameraElevationReference="ground",ke!==z.zoom&&this._map._update(!0)}if(!mo(g))return this._fireEvents(M,C,!0);let{panDelta:q,zoomDelta:Y,bearingDelta:J,pitchDelta:ee,around:ie,aroundCoord:fe,pinchAround:be}=g;be!==void 0&&(ie=be),(ke=>M.drag&&!this._eventsInProgress.drag)()&&ie&&(this._dragOrigin=U(z.pointCoordinate3D(ie)),this._trackingEllipsoid.setup(z._camera.position,this._dragOrigin)),z.cameraElevationReference="sea",L._stop(!0),ie=ie||L.transform.centerPoint,J&&(z.bearing+=J),ee&&(z.pitch+=ee),z._updateCameraState();const Te=[0,0,0];if(q){const ke=z.screenPointToMercatorRay(ie),De=z.screenPointToMercatorRay(ie.sub(q)),Ee=this._trackingEllipsoid.projectRay(ke.dir),Pe=this._trackingEllipsoid.projectRay(De.dir);Te[0]=Pe[0]-Ee[0],Te[1]=Pe[1]-Ee[1]}const xe=z.zoom,Ie=[0,0,0];if(Y){const ke=U(fe||z.pointCoordinate3D(ie)),De={dir:y.normalize([],y.sub([],ke,z._camera.position))},Ee=z.screenPointToMercatorRay(z.centerPoint);if(De.dir[2]<0){const Pe=y.altitudeFromMercatorZ(ke[2],ke[1]),Oe=z.rayIntersectionCoordinate(z.pointRayIntersection(z.centerPoint,Pe)),Je=z.zoomDeltaToMovement(U(Oe),Y)*(Ee.dir[2]/De.dir[2]);y.scale(Ie,De.dir,Je)}else if(z._terrainEnabled()){const Pe=z.zoomDeltaToMovement(ke,Y);y.scale(Ie,De.dir,Pe)}}const ve=y.add(Te,Te,Ie);z._translateCameraConstrained(ve),Y&&Math.abs(z.zoom-xe)>1e-4&&z.recenterOnTerrain(),z.cameraElevationReference="ground",this._map._update(),g.noInertia||this._inertia.record(g),this._fireEvents(M,C,!0)}_fireEvents(g,M,C){const L=qo(this._eventsInProgress),z=qo(g),U={};for(const ee in g){const{originalEvent:ie}=g[ee];this._eventsInProgress[ee]||(U[`${ee}start`]=ie),this._eventsInProgress[ee]=g[ee]}!L&&z&&this._fireEvent("movestart",z.originalEvent);for(const ee in U)this._fireEvent(ee,U[ee]);z&&this._fireEvent("move",z.originalEvent);for(const ee in g){const{originalEvent:ie}=g[ee];this._fireEvent(ee,ie)}const q={};let Y;for(const ee in this._eventsInProgress){const{handlerName:ie,originalEvent:fe}=this._eventsInProgress[ee];this._handlersById[ie].isActive()||(delete this._eventsInProgress[ee],Y=M[ie]||fe,q[`${ee}end`]=Y)}for(const ee in q)this._fireEvent(ee,q[ee]);const J=qo(this._eventsInProgress);if(C&&(L||z)&&!J){this._updatingCamera=!0;const ee=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),ie=fe=>fe!==0&&-this._bearingSnap<fe&&fe<this._bearingSnap;ee?(ie(ee.bearing||this._map.getBearing())&&(ee.bearing=0),this._map.easeTo(ee,{originalEvent:Y})):(this._map.fire(new y.Event("moveend",{originalEvent:Y})),ie(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(g,M){this._map.fire(new y.Event(g,M?{originalEvent:M}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(g=>{delete this._frameId,this.handleEvent(new Xl("renderFrame",{timeStamp:g})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const La="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Yl extends y.Evented{constructor(g,M){super(),this._moving=!1,this._zooming=!1,this.transform=g,this._bearingSnap=M.bearingSnap,y.bindAll(["_renderFrameCallback"],this)}getCenter(){return new y.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(g,M){return this.jumpTo({center:g},M)}panBy(g,M,C){return g=y.pointGeometry.convert(g).mult(-1),this.panTo(this.transform.center,y.extend({offset:g},M),C)}panTo(g,M,C){return this.easeTo(y.extend({center:g},M),C)}getZoom(){return this.transform.zoom}setZoom(g,M){return this.jumpTo({zoom:g},M),this}zoomTo(g,M,C){return this.easeTo(y.extend({zoom:g},M),C)}zoomIn(g,M){return this.zoomTo(this.getZoom()+1,g,M),this}zoomOut(g,M){return this.zoomTo(this.getZoom()-1,g,M),this}getBearing(){return this.transform.bearing}setBearing(g,M){return this.jumpTo({bearing:g},M),this}getPadding(){return this.transform.padding}setPadding(g,M){return this.jumpTo({padding:g},M),this}rotateTo(g,M,C){return this.easeTo(y.extend({bearing:g},M),C)}resetNorth(g,M){return this.rotateTo(0,y.extend({duration:1e3},g),M),this}resetNorthPitch(g,M){return this.easeTo(y.extend({bearing:0,pitch:0,duration:1e3},g),M),this}snapToNorth(g,M){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(g,M):this}getPitch(){return this.transform.pitch}setPitch(g,M){return this.jumpTo({pitch:g},M),this}cameraForBounds(g,M){g=y.LngLatBounds.convert(g);const C=M&&M.bearing||0;return this._cameraForBoxAndBearing(g.getNorthWest(),g.getSouthEast(),C,M)}_extendCameraOptions(g){const M={top:0,bottom:0,right:0,left:0};if(typeof(g=y.extend({padding:M,offset:[0,0],maxZoom:this.transform.maxZoom},g)).padding=="number"){const C=g.padding;g.padding={top:C,bottom:C,right:C,left:C}}return g.padding=y.extend(M,g.padding),g}_cameraForBoxAndBearing(g,M,C,L){const z=this._extendCameraOptions(L),U=this.transform,q=U.padding,Y=U.project(y.LngLat.convert(g)),J=U.project(y.LngLat.convert(M)),ee=Y.rotate(-y.degToRad(C)),ie=J.rotate(-y.degToRad(C)),fe=new y.pointGeometry(Math.max(ee.x,ie.x),Math.max(ee.y,ie.y)),be=new y.pointGeometry(Math.min(ee.x,ie.x),Math.min(ee.y,ie.y)),Te=fe.sub(be),xe=(U.width-(q.left+q.right+z.padding.left+z.padding.right))/Te.x,Ie=(U.height-(q.top+q.bottom+z.padding.top+z.padding.bottom))/Te.y;if(Ie<0||xe<0)return void y.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const ve=Math.min(U.scaleZoom(U.scale*Math.min(xe,Ie)),z.maxZoom),ke=typeof z.offset.x=="number"?new y.pointGeometry(z.offset.x,z.offset.y):y.pointGeometry.convert(z.offset),De=new y.pointGeometry((z.padding.left-z.padding.right)/2,(z.padding.top-z.padding.bottom)/2).rotate(C*Math.PI/180),Ee=ke.add(De).mult(U.scale/U.zoomScale(ve));return{center:U.unproject(Y.add(J).div(2).sub(Ee)),zoom:ve,bearing:C}}_cameraForBox(g,M,C,L,z){const U=this._extendCameraOptions(z);C=C||0,L=L||0,g=y.LngLat.convert(g),M=y.LngLat.convert(M);const q=this.transform.clone();q.padding=U.padding;const Y=this.getFreeCameraOptions(),J=new y.LngLat(.5*(g.lng+M.lng),.5*(g.lat+M.lat)),ee=.5*(C+L);if(q._camera.position[2]<y.mercatorZfromAltitude(ee,J.lat))return void y.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Y.lookAtPoint(J),q.setFreeCameraOptions(Y);const ie=y.MercatorCoordinate.fromLngLat(g),fe=y.MercatorCoordinate.fromLngLat(M),be=q.pointRayIntersection(q.centerPoint,ee),Te=[(xe=q.rayIntersectionCoordinate(be)).x,xe.y,xe.z];var xe;const Ie=q.screenPointToMercatorRay(q.centerPoint);let ve,ke=0;do{const De=Math.floor(q.zoom),Ee=1<<De,Pe=Math.min(Ee*ie.x,Ee*fe.x),Oe=Math.min(Ee*ie.y,Ee*fe.y),Je=Math.max(Ee*ie.x,Ee*fe.x),Ke=Math.max(Ee*ie.y,Ee*fe.y),rt=new Re([Pe,Oe,C],[Je,Ke,L]),nt=me.fromInvProjectionMatrix(q.invProjMatrix,q.worldSize,De);if(rt.intersects(nt)!==2){ve&&(q._camera.position=y.scaleAndAdd([],q._camera.position,Ie.dir,-ve),q._updateStateFromCamera());break}const _t=y.sub([],q._camera.position,Te);ve=.5*y.length(_t),q._camera.position=y.scaleAndAdd([],q._camera.position,Ie.dir,ve);try{q._updateStateFromCamera()}catch{return void y.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}}while(++ke<10);return{center:q.center,zoom:q.zoom,bearing:q.bearing,pitch:q.pitch}}fitBounds(g,M,C){return this._fitInternal(this.cameraForBounds(g,M),M,C)}_raycastElevationBox(g,M){const C=this.transform.elevation;if(!C)return;const L=new y.pointGeometry(g.x,M.y),z=new y.pointGeometry(M.x,g.y),U=C.pointCoordinate(g);if(!U)return;const q=C.pointCoordinate(M);if(!q)return;const Y=C.pointCoordinate(L);if(!Y)return;const J=C.pointCoordinate(z);if(!J)return;const ee=new y.MercatorCoordinate(U[0],U[1]).toLngLat(),ie=new y.MercatorCoordinate(q[0],q[1]).toLngLat(),fe=new y.MercatorCoordinate(Y[0],Y[1]).toLngLat(),be=new y.MercatorCoordinate(J[0],J[1]).toLngLat(),Te=Math.min(ee.lng,Math.min(ie.lng,Math.min(fe.lng,be.lng))),xe=Math.min(ee.lat,Math.min(ie.lat,Math.min(fe.lat,be.lat))),Ie=Math.max(ee.lng,Math.max(ie.lng,Math.max(fe.lng,be.lng))),ve=Math.max(ee.lat,Math.max(ie.lat,Math.max(fe.lat,be.lat))),ke=Math.min(U[3],Math.min(q[3],Math.min(Y[3],J[3]))),De=Math.max(U[3],Math.max(q[3],Math.max(Y[3],J[3])));return{minLngLat:new y.LngLat(Te,xe),maxLngLat:new y.LngLat(Ie,ve),minAltitude:ke,maxAltitude:De}}fitScreenCoordinates(g,M,C,L,z){let U,q,Y,J;const ee=y.pointGeometry.convert(g),ie=y.pointGeometry.convert(M),fe=this._raycastElevationBox(ee,ie);if(fe)U=fe.minLngLat,q=fe.maxLngLat,Y=fe.minAltitude,J=fe.maxAltitude;else{if(this.transform.anyCornerOffEdge(ee,ie))return this;U=this.transform.pointLocation(ee),q=this.transform.pointLocation(ie)}return this._fitInternal(this.transform.pitch===0?this._cameraForBoxAndBearing(this.transform.pointLocation(y.pointGeometry.convert(g)),this.transform.pointLocation(y.pointGeometry.convert(M)),C,L):this._cameraForBox(U,q,Y,J,L),L,z)}_fitInternal(g,M,C){return g?(delete(M=y.extend(g,M)).padding,M.linear?this.easeTo(M,C):this.flyTo(M,C)):this}jumpTo(g,M){this.stop();const C=this.transform;let L=!1,z=!1,U=!1;return"zoom"in g&&C.zoom!==+g.zoom&&(L=!0,C.zoom=+g.zoom),g.center!==void 0&&(C.center=y.LngLat.convert(g.center)),"bearing"in g&&C.bearing!==+g.bearing&&(z=!0,C.bearing=+g.bearing),"pitch"in g&&C.pitch!==+g.pitch&&(U=!0,C.pitch=+g.pitch),g.padding==null||C.isPaddingEqual(g.padding)||(C.padding=g.padding),this.fire(new y.Event("movestart",M)).fire(new y.Event("move",M)),L&&this.fire(new y.Event("zoomstart",M)).fire(new y.Event("zoom",M)).fire(new y.Event("zoomend",M)),z&&this.fire(new y.Event("rotatestart",M)).fire(new y.Event("rotate",M)).fire(new y.Event("rotateend",M)),U&&this.fire(new y.Event("pitchstart",M)).fire(new y.Event("pitch",M)).fire(new y.Event("pitchend",M)),this.fire(new y.Event("moveend",M))}getFreeCameraOptions(){return this.transform.projection.name!=="mercator"&&y.warnOnce(La),this.transform.getFreeCameraOptions()}setFreeCameraOptions(g,M){const C=this.transform;if(C.projection.name!=="mercator")return void y.warnOnce(La);this.stop();const L=C.zoom,z=C.pitch,U=C.bearing;C.setFreeCameraOptions(g);const q=L!==C.zoom,Y=z!==C.pitch,J=U!==C.bearing;return this.fire(new y.Event("movestart",M)).fire(new y.Event("move",M)),q&&this.fire(new y.Event("zoomstart",M)).fire(new y.Event("zoom",M)).fire(new y.Event("zoomend",M)),J&&this.fire(new y.Event("rotatestart",M)).fire(new y.Event("rotate",M)).fire(new y.Event("rotateend",M)),Y&&this.fire(new y.Event("pitchstart",M)).fire(new y.Event("pitch",M)).fire(new y.Event("pitchend",M)),this.fire(new y.Event("moveend",M)),this}easeTo(g,M){this._stop(!1,g.easeId),((g=y.extend({offset:[0,0],duration:500,easing:y.ease},g)).animate===!1||!g.essential&&y.exported.prefersReducedMotion)&&(g.duration=0);const C=this.transform,L=this.getZoom(),z=this.getBearing(),U=this.getPitch(),q=this.getPadding(),Y="zoom"in g?+g.zoom:L,J="bearing"in g?this._normalizeBearing(g.bearing,z):z,ee="pitch"in g?+g.pitch:U,ie="padding"in g?g.padding:C.padding,fe=y.pointGeometry.convert(g.offset);let be=C.centerPoint.add(fe);const Te=C.pointLocation(be),xe=y.LngLat.convert(g.center||Te);this._normalizeCenter(xe);const Ie=C.project(Te),ve=C.project(xe).sub(Ie),ke=C.zoomScale(Y-L);let De,Ee;g.around&&(De=y.LngLat.convert(g.around),Ee=C.locationPoint(De));const Pe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||Y!==L,this._rotating=this._rotating||z!==J,this._pitching=this._pitching||ee!==U,this._padding=!C.isPaddingEqual(ie),this._easeId=g.easeId,this._prepareEase(M,g.noMoveStart,Pe),this._ease(Oe=>{if(this._zooming&&(C.zoom=y.number(L,Y,Oe)),this._rotating&&(C.bearing=y.number(z,J,Oe)),this._pitching&&(C.pitch=y.number(U,ee,Oe)),this._padding&&(C.interpolatePadding(q,ie,Oe),be=C.centerPoint.add(fe)),De)C.setLocationAtPoint(De,Ee);else{const Je=C.zoomScale(C.zoom-L),Ke=Y>L?Math.min(2,ke):Math.max(.5,ke),rt=Math.pow(Ke,1-Oe),nt=C.unproject(Ie.add(ve.mult(Oe*rt)).mult(Je));C.setLocationAtPoint(C.renderWorldCopies?nt.wrap():nt,be)}this._fireMoveEvents(M)},Oe=>{C.recenterOnTerrain(),this._afterEase(M,Oe)},g),this}_prepareEase(g,M,C={}){this._moving=!0,this.transform.cameraElevationReference="sea",M||C.moving||this.fire(new y.Event("movestart",g)),this._zooming&&!C.zooming&&this.fire(new y.Event("zoomstart",g)),this._rotating&&!C.rotating&&this.fire(new y.Event("rotatestart",g)),this._pitching&&!C.pitching&&this.fire(new y.Event("pitchstart",g))}_fireMoveEvents(g){this.fire(new y.Event("move",g)),this._zooming&&this.fire(new y.Event("zoom",g)),this._rotating&&this.fire(new y.Event("rotate",g)),this._pitching&&this.fire(new y.Event("pitch",g))}_afterEase(g,M){if(this._easeId&&M&&this._easeId===M)return;delete this._easeId,this.transform.cameraElevationReference="ground";const C=this._zooming,L=this._rotating,z=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,C&&this.fire(new y.Event("zoomend",g)),L&&this.fire(new y.Event("rotateend",g)),z&&this.fire(new y.Event("pitchend",g)),this.fire(new y.Event("moveend",g))}flyTo(g,M){if(!g.essential&&y.exported.prefersReducedMotion){const vt=y.pick(g,["center","zoom","bearing","pitch","around"]);return this.jumpTo(vt,M)}this.stop(),g=y.extend({offset:[0,0],speed:1.2,curve:1.42,easing:y.ease},g);const C=this.transform,L=this.getZoom(),z=this.getBearing(),U=this.getPitch(),q=this.getPadding(),Y="zoom"in g?y.clamp(+g.zoom,C.minZoom,C.maxZoom):L,J="bearing"in g?this._normalizeBearing(g.bearing,z):z,ee="pitch"in g?+g.pitch:U,ie="padding"in g?g.padding:C.padding,fe=C.zoomScale(Y-L),be=y.pointGeometry.convert(g.offset);let Te=C.centerPoint.add(be);const xe=C.pointLocation(Te),Ie=y.LngLat.convert(g.center||xe);this._normalizeCenter(Ie);const ve=C.project(xe),ke=C.project(Ie).sub(ve);let De=g.curve;const Ee=Math.max(C.width,C.height),Pe=Ee/fe,Oe=ke.mag();if("minZoom"in g){const vt=y.clamp(Math.min(g.minZoom,L,Y),C.minZoom,C.maxZoom),Ot=Ee/C.zoomScale(vt-L);De=Math.sqrt(Ot/Oe*2)}const Je=De*De;function Ke(vt){const Ot=(Pe*Pe-Ee*Ee+(vt?-1:1)*Je*Je*Oe*Oe)/(2*(vt?Pe:Ee)*Je*Oe);return Math.log(Math.sqrt(Ot*Ot+1)-Ot)}function rt(vt){return(Math.exp(vt)-Math.exp(-vt))/2}function nt(vt){return(Math.exp(vt)+Math.exp(-vt))/2}const _t=Ke(0);let it=function(vt){return nt(_t)/nt(_t+De*vt)},yt=function(vt){return Ee*((nt(_t)*(rt(Ot=_t+De*vt)/nt(Ot))-rt(_t))/Je)/Oe;var Ot},We=(Ke(1)-_t)/De;if(Math.abs(Oe)<1e-6||!isFinite(We)){if(Math.abs(Ee-Pe)<1e-6)return this.easeTo(g,M);const vt=Pe<Ee?-1:1;We=Math.abs(Math.log(Pe/Ee))/De,yt=function(){return 0},it=function(Ot){return Math.exp(vt*De*Ot)}}return g.duration="duration"in g?+g.duration:1e3*We/("screenSpeed"in g?+g.screenSpeed/De:+g.speed),g.maxDuration&&g.duration>g.maxDuration&&(g.duration=0),this._zooming=!0,this._rotating=z!==J,this._pitching=ee!==U,this._padding=!C.isPaddingEqual(ie),this._prepareEase(M,!1),this._ease(vt=>{const Ot=vt*We,Qt=1/it(Ot);C.zoom=vt===1?Y:L+C.scaleZoom(Qt),this._rotating&&(C.bearing=y.number(z,J,vt)),this._pitching&&(C.pitch=y.number(U,ee,vt)),this._padding&&(C.interpolatePadding(q,ie,vt),Te=C.centerPoint.add(be));const ni=vt===1?Ie:C.unproject(ve.add(ke.mult(yt(Ot))).mult(Qt));C.setLocationAtPoint(C.renderWorldCopies?ni.wrap():ni,Te),C._updateCenterElevation(),this._fireMoveEvents(M)},()=>this._afterEase(M),g),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(g,M){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const C=this._onEaseEnd;delete this._onEaseEnd,C.call(this,M)}if(!g){const C=this.handlers;C&&C.stop(!1)}return this}_ease(g,M,C){C.animate===!1||C.duration===0?(g(1),M()):(this._easeStart=y.exported.now(),this._easeOptions=C,this._onEaseFrame=g,this._onEaseEnd=M,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const g=Math.min((y.exported.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(g)),g<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(g,M){g=y.wrap(g,-180,180);const C=Math.abs(g-M);return Math.abs(g-360-M)<C&&(g-=360),Math.abs(g+360-M)<C&&(g+=360),g}_normalizeCenter(g){const M=this.transform;if(!M.renderWorldCopies||M.maxBounds)return;const C=g.lng-M.center.lng;g.lng+=C>180?-360:C<-180?360:0}}class za{constructor(g={}){this.options=g,y.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(g){const M=this.options&&this.options.compact;return this._map=g,this._container=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=j.create("button","mapboxgl-ctrl-attrib-button",this._container),j.create("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden",!0),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=j.create("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),M&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),M===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){j.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(g,M){const C=this._map._getUIString(`AttributionControl.${M}`);g.setAttribute("aria-label",C),g.firstElementChild&&g.firstElementChild.setAttribute("title",C)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let g=this._editLink;g||(g=this._editLink=this._container.querySelector(".mapbox-improve-map"));const M=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||y.config.ACCESS_TOKEN}];if(g){const C=M.reduce((L,z,U)=>(z.value&&(L+=`${z.key}=${z.value}${U<M.length-1?"&":""}`),L),"?");g.href=`${y.config.FEEDBACK_URL}/${C}${this._map._hash?this._map._hash.getHashString(!0):""}`,g.rel="noopener nofollow",this._setElementTitle(g,"MapFeedback")}}_updateData(g){!g||g.sourceDataType!=="metadata"&&g.sourceDataType!=="visibility"&&g.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let g=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?g=g.concat(this.options.customAttribution.map(L=>typeof L!="string"?"":L)):typeof this.options.customAttribution=="string"&&g.push(this.options.customAttribution)),this._map.style.stylesheet){const L=this._map.style.stylesheet;this.styleOwner=L.owner,this.styleId=L.id}const M=this._map.style._sourceCaches;for(const L in M){const z=M[L];if(z.used){const U=z.getSource();U.attribution&&g.indexOf(U.attribution)<0&&g.push(U.attribution)}}g.sort((L,z)=>L.length-z.length),g=g.filter((L,z)=>{for(let U=z+1;U<g.length;U++)if(g[U].indexOf(L)>=0)return!1;return!0});const C=g.join(" | ");C!==this._attribHTML&&(this._attribHTML=C,g.length?(this._innerContainer.innerHTML=C,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Fa{constructor(){y.bindAll(["_updateLogo"],this),y.bindAll(["_updateCompact"],this)}onAdd(g){this._map=g,this._container=j.create("div","mapboxgl-ctrl");const M=j.create("a","mapboxgl-ctrl-logo");return M.target="_blank",M.rel="noopener nofollow",M.href="https://www.mapbox.com/",M.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),M.setAttribute("rel","noopener nofollow"),this._container.appendChild(M),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){j.remove(this._container),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(g){g&&g.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const g=this._map.style._sourceCaches;if(Object.entries(g).length===0)return!0;for(const M in g){const C=g[M].getSource();if(C.hasOwnProperty("mapbox_logo")&&!C.mapbox_logo)return!1}return!0}_updateCompact(){const g=this._container.children;if(g.length){const M=g[0];this._map.getCanvasContainer().offsetWidth<250?M.classList.add("mapboxgl-compact"):M.classList.remove("mapboxgl-compact")}}}class Oa{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(g){const M=++this._id;return this._queue.push({callback:g,id:M,cancelled:!1}),M}remove(g){const M=this._currentlyRunning,C=M?this._queue.concat(M):this._queue;for(const L of C)if(L.id===g)return void(L.cancelled=!0)}run(g=0){const M=this._currentlyRunning=this._queue;this._queue=[];for(const C of M)if(!C.cancelled&&(C.callback(g),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function $a(I,g,M){if(I=new y.LngLat(I.lng,I.lat),g){const C=new y.LngLat(I.lng-360,I.lat),L=new y.LngLat(I.lng+360,I.lat),z=360*Math.ceil(Math.abs(I.lng-M.center.lng)/360),U=M.locationPoint(I).distSqr(g),q=g.x<0||g.y<0||g.x>M.width||g.y>M.height;M.locationPoint(C).distSqr(g)<U&&(q||Math.abs(C.lng-M.center.lng)<z)?I=C:M.locationPoint(L).distSqr(g)<U&&(q||Math.abs(L.lng-M.center.lng)<z)&&(I=L)}for(;Math.abs(I.lng-M.center.lng)>180;){const C=M.locationPoint(I);if(C.x>=0&&C.y>=0&&C.x<=M.width&&C.y<=M.height)break;I.lng>M.center.lng?I.lng-=360:I.lng+=360}return I}const Us={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Zo extends y.Evented{constructor(g,M){if(super(),(g instanceof y.window.HTMLElement||M)&&(g=y.extend({element:g},M)),y.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=g&&g.anchor||"center",this._color=g&&g.color||"#3FB1CE",this._scale=g&&g.scale||1,this._draggable=g&&g.draggable||!1,this._clickTolerance=g&&g.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=g&&g.rotation||0,this._rotationAlignment=g&&g.rotationAlignment||"auto",this._pitchAlignment=g&&g.pitchAlignment&&g.pitchAlignment!=="auto"?g.pitchAlignment:this._rotationAlignment,g&&g.element)this._element=g.element,this._offset=y.pointGeometry.convert(g&&g.offset||[0,0]);else{this._defaultMarker=!0,this._element=j.create("div"),this._element.setAttribute("aria-label","Map marker");const L=j.createNS("http://www.w3.org/2000/svg","svg"),z=41,U=27;L.setAttributeNS(null,"display","block"),L.setAttributeNS(null,"height",`${z}px`),L.setAttributeNS(null,"width",`${U}px`),L.setAttributeNS(null,"viewBox",`0 0 ${U} ${z}`);const q=j.createNS("http://www.w3.org/2000/svg","g");q.setAttributeNS(null,"stroke","none"),q.setAttributeNS(null,"stroke-width","1"),q.setAttributeNS(null,"fill","none"),q.setAttributeNS(null,"fill-rule","evenodd");const Y=j.createNS("http://www.w3.org/2000/svg","g");Y.setAttributeNS(null,"fill-rule","nonzero");const J=j.createNS("http://www.w3.org/2000/svg","g");J.setAttributeNS(null,"transform","translate(3.0, 29.0)"),J.setAttributeNS(null,"fill","#000000");const ee=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const De of ee){const Ee=j.createNS("http://www.w3.org/2000/svg","ellipse");Ee.setAttributeNS(null,"opacity","0.04"),Ee.setAttributeNS(null,"cx","10.5"),Ee.setAttributeNS(null,"cy","5.80029008"),Ee.setAttributeNS(null,"rx",De.rx),Ee.setAttributeNS(null,"ry",De.ry),J.appendChild(Ee)}const ie=j.createNS("http://www.w3.org/2000/svg","g");ie.setAttributeNS(null,"fill",this._color);const fe=j.createNS("http://www.w3.org/2000/svg","path");fe.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),ie.appendChild(fe);const be=j.createNS("http://www.w3.org/2000/svg","g");be.setAttributeNS(null,"opacity","0.25"),be.setAttributeNS(null,"fill","#000000");const Te=j.createNS("http://www.w3.org/2000/svg","path");Te.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),be.appendChild(Te);const xe=j.createNS("http://www.w3.org/2000/svg","g");xe.setAttributeNS(null,"transform","translate(6.0, 7.0)"),xe.setAttributeNS(null,"fill","#FFFFFF");const Ie=j.createNS("http://www.w3.org/2000/svg","g");Ie.setAttributeNS(null,"transform","translate(8.0, 8.0)");const ve=j.createNS("http://www.w3.org/2000/svg","circle");ve.setAttributeNS(null,"fill","#000000"),ve.setAttributeNS(null,"opacity","0.25"),ve.setAttributeNS(null,"cx","5.5"),ve.setAttributeNS(null,"cy","5.5"),ve.setAttributeNS(null,"r","5.4999962");const ke=j.createNS("http://www.w3.org/2000/svg","circle");ke.setAttributeNS(null,"fill","#FFFFFF"),ke.setAttributeNS(null,"cx","5.5"),ke.setAttributeNS(null,"cy","5.5"),ke.setAttributeNS(null,"r","5.4999962"),Ie.appendChild(ve),Ie.appendChild(ke),Y.appendChild(J),Y.appendChild(ie),Y.appendChild(be),Y.appendChild(xe),Y.appendChild(Ie),L.appendChild(Y),L.setAttributeNS(null,"height",z*this._scale+"px"),L.setAttributeNS(null,"width",U*this._scale+"px"),this._element.appendChild(L),this._offset=y.pointGeometry.convert(g&&g.offset||[0,-14])}this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",L=>{L.preventDefault()}),this._element.addEventListener("mousedown",L=>{L.preventDefault()});const C=this._element.classList;for(const L in Us)C.remove(`mapboxgl-marker-anchor-${L}`);C.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(g){return this.remove(),this._map=g,g.getCanvasContainer().appendChild(this._element),g.on("move",this._update),g.on("moveend",this._update),g.on("remove",this._clearFadeTimer),g._addMarker(this),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._map.off("remove",this._clearFadeTimer),this._map._removeMarker(this),delete this._map),this._clearFadeTimer(),j.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(g){return this._lngLat=y.LngLat.convert(g),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(g){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),g){if(!("offset"in g.options)){const M=38.1,C=13.5,L=Math.sqrt(Math.pow(C,2)/2);g.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-M],"bottom-left":[L,-1*(M-C+L)],"bottom-right":[-L,-1*(M-C+L)],left:[C,-1*(M-C)],right:[-C,-1*(M-C)]}:this._offset}this._popup=g,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(g){const M=g.code,C=g.charCode||g.keyCode;M!=="Space"&&M!=="Enter"&&C!==32&&C!==13||this.togglePopup()}_onMapClick(g){const M=g.originalEvent.target,C=this._element;this._popup&&(M===C||C.contains(M))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const g=this._popup;return g?(g.isOpen()?(g.remove(),this._element.setAttribute("aria-expanded","false")):(g.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_evaluateOpacity(){const g=this._pos?this._pos.sub(this._transformedOffset()):null;if(!this._withinScreenBounds(g))return void this._clearFadeTimer();const M=this._map.unproject(g);let C=!1;if(this._map.transform._terrainEnabled()&&this._map.getTerrain()){const z=this._map.getFreeCameraOptions();if(z.position){const U=z.position.toLngLat();C=U.distanceTo(M)<.9*U.distanceTo(this._lngLat)}}const L=(1-this._map._queryFogOpacity(M))*(C?.2:1);this._element.style.opacity=`${L}`,this._popup&&this._popup._setOpacity(`${L}`),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_withinScreenBounds(g){const M=this._map.transform;return!!g&&g.x>=0&&g.x<M.width&&g.y>=0&&g.y<M.height}_update(g){if(!this._map)return;this._map.transform.renderWorldCopies&&(this._lngLat=$a(this._lngLat,this._pos,this._map.transform)),this._pos=this._map.project(this._lngLat)._add(this._transformedOffset());let M="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?M=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(M=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let C="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?C="rotateX(0deg)":this._pitchAlignment==="map"&&(C=`rotateX(${this._map.getPitch()}deg)`),g&&g.type!=="moveend"||(this._pos=this._pos.round()),this._map._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&j.setTransform(this._element,`${Us[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${C} ${M}`),!this._map.getTerrain()&&!this._map.getFog()||this._fadeTimer||(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))})}_transformedOffset(){if(!this._defaultMarker)return this._offset;const g=this._map.transform,M=this._offset.mult(this._scale);return this._rotationAlignment==="map"&&M._rotate(g.angle),this._pitchAlignment==="map"&&(M.y*=Math.cos(g._pitch)),M}getOffset(){return this._offset}setOffset(g){return this._offset=y.pointGeometry.convert(g),this._update(),this}_onMove(g){if(!this._isDragging){const M=this._clickTolerance||this._map._clickTolerance;this._isDragging=g.point.dist(this._pointerdownPos)>=M}this._isDragging&&(this._pos=g.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new y.Event("dragstart"))),this.fire(new y.Event("drag")))}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new y.Event("dragend")),this._state="inactive"}_addDragHandler(g){this._element.contains(g.originalEvent.target)&&(g.preventDefault(),this._positionDelta=g.point.sub(this._pos).add(this._transformedOffset()),this._pointerdownPos=g.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))}setDraggable(g){return this._draggable=!!g,this._map&&(g?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(g){return this._rotation=g||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(g){return this._rotationAlignment=g||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(g){return this._pitchAlignment=g&&g!=="auto"?g:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}}class Hl{constructor(g){this.jumpTo(g)}getValue(g){if(g<=this._startTime)return this._start;if(g>=this._endTime)return this._end;const M=y.easeCubicInOut((g-this._startTime)/(this._endTime-this._startTime));return this._start*(1-M)+this._end*M}isEasing(g){return g>=this._startTime&&g<=this._endTime}jumpTo(g){this._startTime=-1/0,this._endTime=-1/0,this._start=g,this._end=g}easeTo(g,M,C){this._start=this.getValue(M),this._end=g,this._startTime=M,this._endTime=M+C}}const Wl={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},{HTMLImageElement:Xo,HTMLElement:Kl,ImageBitmap:kn}=y.window,Jl={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function Yo(I){I.parentNode&&I.parentNode.removeChild(I)}const Ql={showCompass:!0,showZoom:!0,visualizePitch:!1};class Na{constructor(g,M,C=!1){this._clickTolerance=10,this.element=M,this.mouseRotate=new pn({clickTolerance:g.dragRotate._mouseRotate._clickTolerance}),this.map=g,C&&(this.mousePitch=new Xn({clickTolerance:g.dragRotate._mousePitch._clickTolerance})),y.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),j.addEventListener(M,"mousedown",this.mousedown),j.addEventListener(M,"touchstart",this.touchstart,{passive:!1}),j.addEventListener(M,"touchmove",this.touchmove),j.addEventListener(M,"touchend",this.touchend),j.addEventListener(M,"touchcancel",this.reset)}down(g,M){this.mouseRotate.mousedown(g,M),this.mousePitch&&this.mousePitch.mousedown(g,M),j.disableDrag()}move(g,M){const C=this.map,L=this.mouseRotate.mousemoveWindow(g,M);if(L&&L.bearingDelta&&C.setBearing(C.getBearing()+L.bearingDelta),this.mousePitch){const z=this.mousePitch.mousemoveWindow(g,M);z&&z.pitchDelta&&C.setPitch(C.getPitch()+z.pitchDelta)}}off(){const g=this.element;j.removeEventListener(g,"mousedown",this.mousedown),j.removeEventListener(g,"touchstart",this.touchstart,{passive:!1}),j.removeEventListener(g,"touchmove",this.touchmove),j.removeEventListener(g,"touchend",this.touchend),j.removeEventListener(g,"touchcancel",this.reset),this.offTemp()}offTemp(){j.enableDrag(),j.removeEventListener(y.window,"mousemove",this.mousemove),j.removeEventListener(y.window,"mouseup",this.mouseup)}mousedown(g){this.down(y.extend({},g,{ctrlKey:!0,preventDefault:()=>g.preventDefault()}),j.mousePos(this.element,g)),j.addEventListener(y.window,"mousemove",this.mousemove),j.addEventListener(y.window,"mouseup",this.mouseup)}mousemove(g){this.move(g,j.mousePos(this.element,g))}mouseup(g){this.mouseRotate.mouseupWindow(g),this.mousePitch&&this.mousePitch.mouseupWindow(g),this.offTemp()}touchstart(g){g.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=j.touchPos(this.element,g.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>g.preventDefault()},this._startPos))}touchmove(g){g.targetTouches.length!==1?this.reset():(this._lastPos=j.touchPos(this.element,g.targetTouches)[0],this.move({preventDefault:()=>g.preventDefault()},this._lastPos))}touchend(g){g.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const Ua={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1};let Cn,Vs=0,Ho=!1;const Va={maxWidth:100,unit:"metric"};function ja(I,g,M){const C=M&&M.maxWidth||100,L=I._container.getBoundingClientRect().height/2,z=I.unproject([0,L]),U=I.unproject([C,L]),q=z.distanceTo(U);if(M&&M.unit==="imperial"){const Y=3.2808*q;Y>5280?go(g,C,Y/5280,I._getUIString("ScaleControl.Miles"),I):go(g,C,Y,I._getUIString("ScaleControl.Feet"),I)}else M&&M.unit==="nautical"?go(g,C,q/1852,I._getUIString("ScaleControl.NauticalMiles"),I):q>=1e3?go(g,C,q/1e3,I._getUIString("ScaleControl.Kilometers"),I):go(g,C,q,I._getUIString("ScaleControl.Meters"),I)}function go(I,g,M,C,L){const z=function(q){const Y=Math.pow(10,`${Math.floor(q)}`.length-1);let J=q/Y;return J=J>=10?10:J>=5?5:J>=3?3:J>=2?2:J>=1?1:function(ee){const ie=Math.pow(10,Math.ceil(-Math.log(ee)/Math.LN10));return Math.round(ee*ie)/ie}(J),Y*J}(M),U=z/M;L._requestDomTask(()=>{I.style.width=g*U+"px",I.innerHTML=`${z}&nbsp;${C}`})}const Hh={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Wh=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", "),_o={version:y.version,supported:B,setRTLTextPlugin:y.setRTLTextPlugin,getRTLTextPluginStatus:y.getRTLTextPluginStatus,Map:class extends Yl{constructor(I){if((I=y.extend({},Jl,I)).minZoom!=null&&I.maxZoom!=null&&I.minZoom>I.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(I.minPitch!=null&&I.maxPitch!=null&&I.minPitch>I.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(I.minPitch!=null&&I.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(I.maxPitch!=null&&I.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new Ca(I.minZoom,I.maxZoom,I.minPitch,I.maxPitch,I.renderWorldCopies),I),this._interactive=I.interactive,this._maxTileCacheSize=I.maxTileCacheSize,this._failIfMajorPerformanceCaveat=I.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=I.preserveDrawingBuffer,this._antialias=I.antialias,this._trackResize=I.trackResize,this._bearingSnap=I.bearingSnap,this._refreshExpiredTiles=I.refreshExpiredTiles,this._fadeDuration=I.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=I.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=I.collectResourceTiming,this._optimizeForTerrain=I.optimizeForTerrain,this._renderTaskQueue=new Oa,this._domRenderTaskQueue=new Oa,this._controls=[],this._markers=[],this._mapId=y.uniqueId(),this._locale=y.extend({},Wl,I.locale),this._clickTolerance=I.clickTolerance,this._cooperativeGestures=I.cooperativeGestures,this._averageElevationLastSampledAt=-1/0,this._averageElevation=new Hl(0),this._requestManager=new y.RequestManager(I.transformRequest,I.accessToken,I.testMode),this._silenceAuthErrors=!!I.testMode,typeof I.container=="string"){if(this._container=y.window.document.getElementById(I.container),!this._container)throw new Error(`Container '${I.container}' not found.`)}else{if(!(I.container instanceof Kl))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=I.container}if(I.maxBounds&&this.setMaxBounds(I.maxBounds),y.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),y.window!==void 0&&(y.window.addEventListener("online",this._onWindowOnline,!1),y.window.addEventListener("resize",this._onWindowResize,!1),y.window.addEventListener("orientationchange",this._onWindowResize,!1),y.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new Ns(this,I),this._localFontFamily=I.localFontFamily,this._localIdeographFontFamily=I.localIdeographFontFamily,I.style&&this.setStyle(I.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),I.projection&&this.setProjection(I.projection),this._hash=I.hash&&new Rs(typeof I.hash=="string"&&I.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:I.center,zoom:I.zoom,bearing:I.bearing,pitch:I.pitch}),I.bounds&&(this.resize(),this.fitBounds(I.bounds,y.extend({},I.fitBoundsOptions,{duration:0})))),this.resize(),I.attributionControl&&this.addControl(new za({customAttribution:I.customAttribution})),this._logoControl=new Fa,this.addControl(this._logoControl,I.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",g=>{this._update(g.dataType==="style"),this.fire(new y.Event(`${g.dataType}data`,g))}),this.on("dataloading",g=>{this.fire(new y.Event(`${g.dataType}dataloading`,g))})}_getMapId(){return this._mapId}addControl(I,g){if(g===void 0&&(g=I.getDefaultPosition?I.getDefaultPosition():"top-right"),!I||!I.onAdd)return this.fire(new y.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const M=I.onAdd(this);this._controls.push(I);const C=this._controlPositions[g];return g.indexOf("bottom")!==-1?C.insertBefore(M,C.firstChild):C.appendChild(M),this}removeControl(I){if(!I||!I.onRemove)return this.fire(new y.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const g=this._controls.indexOf(I);return g>-1&&this._controls.splice(g,1),I.onRemove(this),this}hasControl(I){return this._controls.indexOf(I)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(I){const[g,M]=this._containerDimensions();if(g===this.transform.width&&M===this.transform.height)return this;this._resizeCanvas(g,M),this.transform.resize(g,M),this.painter.resize(Math.ceil(g),Math.ceil(M));const C=!this._moving;return C&&this.fire(new y.Event("movestart",I)).fire(new y.Event("move",I)),this.fire(new y.Event("resize",I)),C&&this.fire(new y.Event("moveend",I)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(I){return this.transform.setMaxBounds(y.LngLatBounds.convert(I)),this._update()}setMinZoom(I){if((I=I==null?-2:I)>=-2&&I<=this.transform.maxZoom)return this.transform.minZoom=I,this._update(),this.getZoom()<I?this.setZoom(I):this.fire(new y.Event("zoomstart")).fire(new y.Event("zoom")).fire(new y.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(I){if((I=I==null?22:I)>=this.transform.minZoom)return this.transform.maxZoom=I,this._update(),this.getZoom()>I?this.setZoom(I):this.fire(new y.Event("zoomstart")).fire(new y.Event("zoom")).fire(new y.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(I){if((I=I==null?0:I)<0)throw new Error("minPitch must be greater than or equal to 0");if(I>=0&&I<=this.transform.maxPitch)return this.transform.minPitch=I,this._update(),this.getPitch()<I?this.setPitch(I):this.fire(new y.Event("pitchstart")).fire(new y.Event("pitch")).fire(new y.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(I){if((I=I==null?85:I)>85)throw new Error("maxPitch must be less than or equal to 85");if(I>=this.transform.minPitch)return this.transform.maxPitch=I,this._update(),this.getPitch()>I?this.setPitch(I):this.fire(new y.Event("pitchstart")).fire(new y.Event("pitch")).fire(new y.Event("pitchend")),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(I){return this.transform.renderWorldCopies=I,this._update()}getProjection(){return this.transform.getProjection()}setProjection(I){this._lazyInitEmptyStyle(),typeof I=="string"&&(I={name:I}),this._runtimeProjection=I,this.style.updateProjection()}project(I){return this.transform.locationPoint3D(y.LngLat.convert(I))}unproject(I){return this.transform.pointLocation3D(y.pointGeometry.convert(I))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()}_createDelegatedListener(I,g,M){if(I==="mouseenter"||I==="mouseover"){let C=!1;const L=U=>{const q=g.filter(J=>this.getLayer(J)),Y=q.length?this.queryRenderedFeatures(U.point,{layers:q}):[];Y.length?C||(C=!0,M.call(this,new Or(I,this,U.originalEvent,{features:Y}))):C=!1},z=()=>{C=!1};return{layers:new Set(g),listener:M,delegates:{mousemove:L,mouseout:z}}}if(I==="mouseleave"||I==="mouseout"){let C=!1;const L=U=>{const q=g.filter(Y=>this.getLayer(Y));(q.length?this.queryRenderedFeatures(U.point,{layers:q}):[]).length?C=!0:C&&(C=!1,M.call(this,new Or(I,this,U.originalEvent)))},z=U=>{C&&(C=!1,M.call(this,new Or(I,this,U.originalEvent)))};return{layers:new Set(g),listener:M,delegates:{mousemove:L,mouseout:z}}}{const C=L=>{const z=g.filter(q=>this.getLayer(q)),U=z.length?this.queryRenderedFeatures(L.point,{layers:z}):[];U.length&&(L.features=U,M.call(this,L),delete L.features)};return{layers:new Set(g),listener:M,delegates:{[I]:C}}}}on(I,g,M){if(M===void 0)return super.on(I,g);Array.isArray(g)||(g=[g]);const C=this._createDelegatedListener(I,g,M);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[I]=this._delegatedListeners[I]||[],this._delegatedListeners[I].push(C);for(const L in C.delegates)this.on(L,C.delegates[L]);return this}once(I,g,M){if(M===void 0)return super.once(I,g);Array.isArray(g)||(g=[g]);const C=this._createDelegatedListener(I,g,M);for(const L in C.delegates)this.once(L,C.delegates[L]);return this}off(I,g,M){if(M===void 0)return super.off(I,g);g=new Set(Array.isArray(g)?g:[g]);const C=(z,U)=>{if(z.size!==U.size)return!1;for(const q of z)if(!U.has(q))return!1;return!0},L=this._delegatedListeners?this._delegatedListeners[I]:void 0;return L&&(z=>{for(let U=0;U<z.length;U++){const q=z[U];if(q.listener===M&&C(q.layers,g)){for(const Y in q.delegates)this.off(Y,q.delegates[Y]);return z.splice(U,1),this}}})(L),this}queryRenderedFeatures(I,g){return this.style?(g!==void 0||I===void 0||I instanceof y.pointGeometry||Array.isArray(I)||(g=I,I=void 0),this.style.queryRenderedFeatures(I=I||[[0,0],[this.transform.width,this.transform.height]],g=g||{},this.transform)):[]}querySourceFeatures(I,g){return this.style.querySourceFeatures(I,g)}queryTerrainElevation(I,g){const M=this.transform.elevation;return M?(g=y.extend({},{exaggerated:!0},g),M.getAtPoint(y.MercatorCoordinate.fromLngLat(I),null,g.exaggerated)):null}setStyle(I,g){return(g=y.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},g)).diff!==!1&&g.localIdeographFontFamily===this._localIdeographFontFamily&&g.localFontFamily===this._localFontFamily&&this.style&&I?(this._diffStyle(I,g),this):(this._localIdeographFontFamily=g.localIdeographFontFamily,this._localFontFamily=g.localFontFamily,this._updateStyle(I,g))}_getUIString(I){const g=this._locale[I];if(g==null)throw new Error(`Missing UI string '${I}'`);return g}_updateStyle(I,g){return this.style&&(this.style.setEventedParent(null),this.style._remove(),delete this.style),I&&(this.style=new Yr(this,g||{}),this.style.setEventedParent(this,{style:this.style}),typeof I=="string"?this.style.loadURL(I):this.style.loadJSON(I)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Yr(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(I,g){if(typeof I=="string"){const M=this._requestManager.normalizeStyleURL(I),C=this._requestManager.transformRequest(M,y.ResourceType.Style);y.getJSON(C,(L,z)=>{L?this.fire(new y.ErrorEvent(L)):z&&this._updateDiff(z,g)})}else typeof I=="object"&&this._updateDiff(I,g)}_updateDiff(I,g){try{this.style.setState(I)&&this._update(!0)}catch(M){y.warnOnce(`Unable to perform style diff: ${M.message||M.error||M}.  Rebuilding the style from scratch.`),this._updateStyle(I,g)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():y.warnOnce("There is no style added to the map.")}addSource(I,g){return this._lazyInitEmptyStyle(),this.style.addSource(I,g),this._update(!0)}isSourceLoaded(I){const g=this.style&&this.style._getSourceCaches(I);if(g.length!==0)return g.every(M=>M.loaded());this.fire(new y.ErrorEvent(new Error(`There is no source with ID '${I}'`)))}areTilesLoaded(){const I=this.style&&this.style._sourceCaches;for(const g in I){const M=I[g]._tiles;for(const C in M){const L=M[C];if(L.state!=="loaded"&&L.state!=="errored")return!1}}return!0}addSourceType(I,g,M){return this._lazyInitEmptyStyle(),this.style.addSourceType(I,g,M)}removeSource(I){return this.style.removeSource(I),this._updateTerrain(),this._update(!0)}getSource(I){return this.style.getSource(I)}addImage(I,g,{pixelRatio:M=1,sdf:C=!1,stretchX:L,stretchY:z,content:U}={}){if(this._lazyInitEmptyStyle(),g instanceof Xo||kn&&g instanceof kn){const{width:q,height:Y,data:J}=y.exported.getImageData(g);this.style.addImage(I,{data:new y.RGBAImage({width:q,height:Y},J),pixelRatio:M,stretchX:L,stretchY:z,content:U,sdf:C,version:0})}else{if(g.width===void 0||g.height===void 0)return this.fire(new y.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:q,height:Y,data:J}=g,ee=g;this.style.addImage(I,{data:new y.RGBAImage({width:q,height:Y},new Uint8Array(J)),pixelRatio:M,stretchX:L,stretchY:z,content:U,sdf:C,version:0,userImage:ee}),ee.onAdd&&ee.onAdd(this,I)}}}updateImage(I,g){const M=this.style.getImage(I);if(!M)return this.fire(new y.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const C=g instanceof Xo||kn&&g instanceof kn?y.exported.getImageData(g):g,{width:L,height:z,data:U}=C;return L===void 0||z===void 0?this.fire(new y.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`"))):L!==M.data.width||z!==M.data.height?this.fire(new y.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image"))):(M.data.replace(U,!(g instanceof Xo||kn&&g instanceof kn)),void this.style.updateImage(I,M))}hasImage(I){return I?!!this.style.getImage(I):(this.fire(new y.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(I){this.style.removeImage(I)}loadImage(I,g){y.getImage(this._requestManager.transformRequest(I,y.ResourceType.Image),(M,C)=>{g(M,C instanceof Xo?y.exported.getImageData(C):C)})}listImages(){return this.style.listImages()}addLayer(I,g){return this._lazyInitEmptyStyle(),this.style.addLayer(I,g),this._update(!0)}moveLayer(I,g){return this.style.moveLayer(I,g),this._update(!0)}removeLayer(I){return this.style.removeLayer(I),this._update(!0)}getLayer(I){return this.style.getLayer(I)}setLayerZoomRange(I,g,M){return this.style.setLayerZoomRange(I,g,M),this._update(!0)}setFilter(I,g,M={}){return this.style.setFilter(I,g,M),this._update(!0)}getFilter(I){return this.style.getFilter(I)}setPaintProperty(I,g,M,C={}){return this.style.setPaintProperty(I,g,M,C),this._update(!0)}getPaintProperty(I,g){return this.style.getPaintProperty(I,g)}setLayoutProperty(I,g,M,C={}){return this.style.setLayoutProperty(I,g,M,C),this._update(!0)}getLayoutProperty(I,g){return this.style.getLayoutProperty(I,g)}setLight(I,g={}){return this._lazyInitEmptyStyle(),this.style.setLight(I,g),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(I){return this._lazyInitEmptyStyle(),this.style.setTerrain(I),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(I){return this._lazyInitEmptyStyle(),this.style.setFog(I),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(I){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(y.LngLat.convert(I),this.transform):0}setFeatureState(I,g){return this.style.setFeatureState(I,g),this._update()}removeFeatureState(I,g){return this.style.removeFeatureState(I,g),this._update()}getFeatureState(I){return this.style.getFeatureState(I)}_containerDimensions(){let I=0,g=0;return this._container&&(I=this._container.getBoundingClientRect().width||400,g=this._container.getBoundingClientRect().height||300),[I,g]}_detectMissingCSS(){y.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&y.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const I=this._container;I.classList.add("mapboxgl-map"),(this._missingCSSCanary=j.create("div","mapboxgl-canary",I)).style.visibility="hidden",this._detectMissingCSS();const g=this._canvasContainer=j.create("div","mapboxgl-canvas-container",I);this._interactive&&g.classList.add("mapboxgl-interactive"),this._canvas=j.create("canvas","mapboxgl-canvas",g),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region");const M=this._containerDimensions();this._resizeCanvas(M[0],M[1]);const C=this._controlContainer=j.create("div","mapboxgl-control-container",I),L=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(z=>{L[z]=j.create("div",`mapboxgl-ctrl-${z}`,C)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(I,g){const M=y.exported.devicePixelRatio||1;this._canvas.width=M*Math.ceil(I),this._canvas.height=M*Math.ceil(g),this._canvas.style.width=`${I}px`,this._canvas.style.height=`${g}px`}_addMarker(I){this._markers.push(I)}_removeMarker(I){const g=this._markers.indexOf(I);g!==-1&&this._markers.splice(g,1)}_setupPainter(){const I=y.extend({},B.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),g=this._canvas.getContext("webgl",I)||this._canvas.getContext("experimental-webgl",I);g?(y.storeAuthState(g,!0),this.painter=new Il(g,this.transform),this.on("data",M=>{M.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),y.exported$1.testSupport(g)):this.fire(new y.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(I){I.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new y.Event("webglcontextlost",{originalEvent:I}))}_contextRestored(I){this._setupPainter(),this.resize(),this._update(),this.fire(new y.Event("webglcontextrestored",{originalEvent:I}))}_onMapScroll(I){if(I.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(I){return this.style?(this._styleDirty=this._styleDirty||I,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(I){return this._update(),this._renderTaskQueue.add(I)}_cancelRenderFrame(I){this._renderTaskQueue.remove(I)}_requestDomTask(I){!this.loaded()||this.loaded()&&!this.isMoving()?I():this._domRenderTaskQueue.add(I)}_render(I){let g;const M=this.painter.context.extTimerQuery,C=y.exported.now();this.listens("gpu-timing-frame")&&(g=M.createQueryEXT(),M.beginQueryEXT(M.TIME_ELAPSED_EXT,g));let L=this._updateAverageElevation(C);if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(I),this._domRenderTaskQueue.run(I),this._removed)return;let z=!1;const U=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const Y=this.transform.zoom,J=this.transform.pitch,ee=y.exported.now();this.style.zoomHistory.update(Y,ee);const ie=new y.EvaluationParameters(Y,{now:ee,fadeDuration:U,pitch:J,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),fe=ie.crossFadingFactor();fe===1&&fe===this._crossFadingFactor||(z=!0,this._crossFadingFactor=fe),this.style.update(ie)}if(this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0),this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),this.style._updateSources(this.transform),this._forceMarkerUpdate()),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,U,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:U,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),speedIndexTiming:this.speedIndexTiming}),this.fire(new y.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new y.Event("load"))),this.style&&(this.style.hasTransitions()||z)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const Y=y.exported.now()-C;M.endQueryEXT(M.TIME_ELAPSED_EXT,g),setTimeout(()=>{const J=M.getQueryObjectEXT(g,M.QUERY_RESULT_EXT)/1e6;M.deleteQueryEXT(g),this.fire(new y.Event("gpu-timing-frame",{cpuTime:Y,gpuTime:J}))},50)}if(this.listens("gpu-timing-layer")){const Y=this.painter.collectGpuTimers();setTimeout(()=>{const J=this.painter.queryGpuTimers(Y);this.fire(new y.Event("gpu-timing-layer",{layerTimes:J}))},50)}const q=this._sourcesDirty||this._styleDirty||this._placementDirty||L;if(q||this._repaint)this.triggerRepaint();else{const Y=!this.isMoving()&&this.loaded();if(Y&&(L=this._updateAverageElevation(C,!0)),L)this.triggerRepaint();else if(this._triggerFrame(!1),Y&&(this.fire(new y.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const J=this._calculateSpeedIndex();this.fire(new y.Event("speedindexcompleted",{speedIndex:J})),this.speedIndexTiming=!1}}return!this._loaded||this._fullyLoaded||q||(this._fullyLoaded=!0,this._authenticate()),this}_forceMarkerUpdate(){for(const I of this._markers)I._update()}_updateAverageElevation(I,g=!1){const M=C=>(this.transform.averageElevation=C,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&M(0);if((g||I-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(I)){const C=this.transform.averageElevation;let L=this.transform.sampleAverageElevation();isNaN(L)?L=0:this._averageElevationLastSampledAt=I;const z=Math.abs(C-L);if(z>1){if(this._isInitialLoad)return this._averageElevation.jumpTo(L),M(L);this._averageElevation.easeTo(L,I,300)}else if(z>1e-4)return this._averageElevation.jumpTo(L),M(L)}return!!this._averageElevation.isEasing(I)&&M(this._averageElevation.getValue(I))}_authenticate(){y.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,I=>{if(I&&(I.message===y.AUTH_ERR_MSG||I.status===401)){const g=this.painter.context.gl;y.storeAuthState(g,!1),this._logoControl instanceof Fa&&this._logoControl._updateLogo(),g&&g.clear(g.DEPTH_BUFFER_BIT|g.COLOR_BUFFER_BIT|g.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new y.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),y.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming())}_calculateSpeedIndex(){const I=this.painter.canvasCopy(),g=this.painter.getCanvasCopiesAndTimestamps();g.timeStamps.push(performance.now());const M=this.painter.context.gl,C=M.createFramebuffer();function L(z){M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,z,0);const U=new Uint8Array(M.drawingBufferWidth*M.drawingBufferHeight*4);return M.readPixels(0,0,M.drawingBufferWidth,M.drawingBufferHeight,M.RGBA,M.UNSIGNED_BYTE,U),U}return M.bindFramebuffer(M.FRAMEBUFFER,C),this._canvasPixelComparison(L(I),g.canvasCopies.map(L),g.timeStamps)}_canvasPixelComparison(I,g,M){let C=M[1]-M[0];const L=I.length/4;for(let z=0;z<g.length;z++){const U=g[z];let q=0;for(let Y=0;Y<U.length;Y+=4)U[Y]===I[Y]&&U[Y+1]===I[Y+1]&&U[Y+2]===I[Y+2]&&U[Y+3]===I[Y+3]&&(q+=1);C+=(M[z+2]-M[z+1])*(1-q/L)}return C}remove(){this._hash&&this._hash.remove();for(const g of this._controls)g.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.clearWorkerCaches(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),y.window!==void 0&&(y.window.removeEventListener("resize",this._onWindowResize,!1),y.window.removeEventListener("orientationchange",this._onWindowResize,!1),y.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),y.window.removeEventListener("online",this._onWindowOnline,!1));const I=this.painter.context.gl.getExtension("WEBGL_lose_context");I&&I.loseContext(),Yo(this._canvasContainer),Yo(this._controlContainer),Yo(this._missingCSSCanary),this._container.classList.remove("mapboxgl-map"),y.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new y.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(I){this._renderNextFrame=this._renderNextFrame||I,this.style&&!this._frame&&(this._frame=y.exported.frame(g=>{const M=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,M&&this._render(g)}))}_onWindowOnline(){this._update()}_onWindowResize(I){this._trackResize&&this.resize({originalEvent:I})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(I){this._showTileBoundaries!==I&&(this._showTileBoundaries=I,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(I){this._showTerrainWireframe!==I&&(this._showTerrainWireframe=I,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(I){this._speedIndexTiming!==I&&(this._speedIndexTiming=I,this._update())}get showPadding(){return!!this._showPadding}set showPadding(I){this._showPadding!==I&&(this._showPadding=I,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(I){this._showCollisionBoxes!==I&&(this._showCollisionBoxes=I,I?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(I){this._showOverdrawInspector!==I&&(this._showOverdrawInspector=I,this._update())}get repaint(){return!!this._repaint}set repaint(I){this._repaint!==I&&(this._repaint=I,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(I){this._vertices=I,this._update()}_setCacheLimits(I,g){y.setCacheLimits(I,g)}get version(){return y.version}},NavigationControl:class{constructor(I){this.options=y.extend({},Ql,I),this._container=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",g=>g.preventDefault()),this.options.showZoom&&(y.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",g=>this._map.zoomIn({},{originalEvent:g})),j.create("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden",!0),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",g=>this._map.zoomOut({},{originalEvent:g})),j.create("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden",!0)),this.options.showCompass&&(y.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",g=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:g}):this._map.resetNorth({},{originalEvent:g})}),this._compassIcon=j.create("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden",!0))}_updateZoomButtons(){const I=this._map.getZoom(),g=I===this._map.getMaxZoom(),M=I===this._map.getMinZoom();this._zoomInButton.disabled=g,this._zoomOutButton.disabled=M,this._zoomInButton.setAttribute("aria-disabled",g.toString()),this._zoomOutButton.setAttribute("aria-disabled",M.toString())}_rotateCompassArrow(){const I=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._map._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=I)})}onAdd(I){return this._map=I,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Na(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){j.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(I,g){const M=j.create("button",I,this._container);return M.type="button",M.addEventListener("click",g),M}_setButtonTitle(I,g){const M=this._map._getUIString(`NavigationControl.${g}`);I.setAttribute("aria-label",M),I.firstElementChild&&I.firstElementChild.setAttribute("title",M)}},GeolocateControl:class extends y.Evented{constructor(I){super(),this.options=y.extend({},Ua,I),y.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation"],this),this._onDeviceOrientationListener=this._onDeviceOrientation.bind(this),this._updateMarkerRotationThrottled=Da(this._updateMarkerRotation,20)}onAdd(I){var g;return this._map=I,this._container=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),g=this._setupUI,Cn!==void 0?g(Cn):y.window.navigator.permissions!==void 0?y.window.navigator.permissions.query({name:"geolocation"}).then(M=>{Cn=M.state!=="denied",g(Cn)}):(Cn=!!y.window.navigator.geolocation,g(Cn)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(y.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),j.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Vs=0,Ho=!1}_isOutOfMapMaxBounds(I){const g=this._map.getMaxBounds(),M=I.coords;return g&&(M.longitude<g.getWest()||M.longitude>g.getEast()||M.latitude<g.getSouth()||M.latitude>g.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(I){if(this._map){if(this._isOutOfMapMaxBounds(I))return this._setErrorState(),this.fire(new y.Event("outofmaxbounds",I)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=I,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(I),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(I),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new y.Event("geolocate",I)),this._finish()}}_updateCamera(I){const g=new y.LngLat(I.coords.longitude,I.coords.latitude),M=I.coords.accuracy,C=this._map.getBearing(),L=y.extend({bearing:C},this.options.fitBoundsOptions);this._map.fitBounds(g.toBounds(M),L,{geolocateSource:!0})}_updateMarker(I){if(I){const g=new y.LngLat(I.coords.longitude,I.coords.latitude);this._accuracyCircleMarker.setLngLat(g).addTo(this._map),this._userLocationDotMarker.setLngLat(g).addTo(this._map),this._accuracy=I.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const I=this._map._container.getBoundingClientRect().height/2,g=this._map.unproject([0,I]),M=this._map.unproject([100,I]),C=g.distanceTo(M)/100,L=Math.ceil(2*this._accuracy/C);this._circleElement.style.width=`${L}px`,this._circleElement.style.height=`${L}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(I){if(this._map){if(this.options.trackUserLocation)if(I.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const g=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",g),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",g),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(I.code===3&&Ho)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new y.Event("error",I)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(I){if(this._container.addEventListener("contextmenu",g=>g.preventDefault()),this._geolocateButton=j.create("button","mapboxgl-ctrl-geolocate",this._container),j.create("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden",!0),this._geolocateButton.type="button",I===!1){y.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const g=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",g),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",g)}else{const g=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",g),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",g)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=j.create("div","mapboxgl-user-location"),this._dotElement.appendChild(j.create("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(j.create("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Zo({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=j.create("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Zo({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",g=>{g.geolocateSource||this._watchState!=="ACTIVE_LOCK"||g.originalEvent&&g.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new y.Event("trackuserlocationend")))})}_onDeviceOrientation(I){this._userLocationDotMarker&&(I.webkitCompassHeading?this._heading=I.webkitCompassHeading:I.absolute===!0&&(this._heading=-1*I.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return y.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new y.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Vs--,Ho=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new y.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new y.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let I;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Vs++,Vs>1?(I={maximumAge:6e5,timeout:0},Ho=!0):(I=this.options.positionOptions,Ho=!1),this._geolocationWatchID=y.window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,I),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else y.window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const I=()=>{y.window.addEventListener("ondeviceorientationabsolute"in y.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientationListener)};y.window.DeviceMotionEvent!==void 0&&typeof y.window.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(g=>{g==="granted"&&I()}).catch(console.error):I()}_clearWatch(){y.window.navigator.geolocation.clearWatch(this._geolocationWatchID),y.window.removeEventListener("deviceorientation",this._onDeviceOrientationListener),y.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientationListener),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:za,ScaleControl:class{constructor(I){this.options=y.extend({},Va,I),y.bindAll(["_onMove","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_onMove(){ja(this._map,this._container,this.options)}onAdd(I){return this._map=I,this._container=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-scale",I.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){j.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}setUnit(I){this.options.unit=I,ja(this._map,this._container,this.options)}},FullscreenControl:class{constructor(I){this._fullscreen=!1,I&&I.container&&(I.container instanceof y.window.HTMLElement?this._container=I.container:y.warnOnce("Full screen control 'container' must be a DOM element.")),y.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in y.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in y.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(I){return this._map=I,this._container||(this._container=this._map.getContainer()),this._controlContainer=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",y.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){j.remove(this._controlContainer),this._map=null,y.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!y.window.document.fullscreenEnabled&&!y.window.document.webkitFullscreenEnabled)}_setupUI(){const I=this._fullscreenButton=j.create("button","mapboxgl-ctrl-fullscreen",this._controlContainer);j.create("span","mapboxgl-ctrl-icon",I).setAttribute("aria-hidden",!0),I.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),y.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const I=this._getTitle();this._fullscreenButton.setAttribute("aria-label",I),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",I)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(y.window.document.fullscreenElement||y.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?y.window.document.exitFullscreen?y.window.document.exitFullscreen():y.window.document.webkitCancelFullScreen&&y.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends y.Evented{constructor(I){super(),this.options=y.extend(Object.create(Hh),I),y.bindAll(["_update","_onClose","remove","_onMouseMove","_onMouseUp","_onDrag"],this),this._classList=new Set(I&&I.className?I.className.trim().split(/\s+/):[])}addTo(I){return this._map&&this.remove(),this._map=I,this.options.closeOnClick&&this._map.on("preclick",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")):this._map.on("move",this._update),this.fire(new y.Event("open")),this}isOpen(){return!!this._map}remove(){return this._content&&j.remove(this._content),this._container&&(j.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),delete this._map),this.fire(new y.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(I){return this._lngLat=y.LngLat.convert(I),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._map._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(I){return this.setDOMContent(y.window.document.createTextNode(I))}setHTML(I){const g=y.window.document.createDocumentFragment(),M=y.window.document.createElement("body");let C;for(M.innerHTML=I;C=M.firstChild,C;)g.appendChild(C);return this.setDOMContent(g)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(I){return this.options.maxWidth=I,this._update(),this}setDOMContent(I){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=j.create("div","mapboxgl-popup-content",this._container);return this._content.appendChild(I),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(I){return this._classList.add(I),this._container&&this._updateClassList(),this}removeClassName(I){return this._classList.delete(I),this._container&&this._updateClassList(),this}setOffset(I){return this.options.offset=I,this._update(),this}toggleClassName(I){let g;return this._classList.delete(I)?g=!1:(this._classList.add(I),g=!0),this._container&&this._updateClassList(),g}_createCloseButton(){this.options.closeButton&&(this._closeButton=j.create("button","mapboxgl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.setAttribute("aria-hidden","true"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_onMouseUp(I){this._update(I.point)}_onMouseMove(I){this._update(I.point)}_onDrag(I){this._update(I.point)}_getAnchor(I){if(this.options.anchor)return this.options.anchor;const g=this._pos,M=this._container.offsetWidth,C=this._container.offsetHeight;let L;return L=g.y+I.bottom.y<C?["top"]:g.y>this._map.transform.height-C?["bottom"]:[],g.x<M/2?L.push("left"):g.x>this._map.transform.width-M/2&&L.push("right"),L.length===0?"bottom":L.join("-")}_updateClassList(){const I=[...this._classList];I.push("mapboxgl-popup"),this._anchor&&I.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&I.push("mapboxgl-popup-track-pointer"),this._container.className=I.join(" ")}_update(I){if(this._map&&(this._lngLat||this._trackPointer)&&this._content){if(this._container||(this._container=j.create("div","mapboxgl-popup",this._map.getContainer()),this._tip=j.create("div","mapboxgl-popup-tip",this._container),this._container.appendChild(this._content)),this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=$a(this._lngLat,this._pos,this._map.transform)),!this._trackPointer||I){const g=this._pos=this._trackPointer&&I?I:this._map.project(this._lngLat),M=function(z){if(z||(z=new y.pointGeometry(0,0)),typeof z=="number"){const U=Math.round(Math.sqrt(.5*Math.pow(z,2)));return{center:new y.pointGeometry(0,0),top:new y.pointGeometry(0,z),"top-left":new y.pointGeometry(U,U),"top-right":new y.pointGeometry(-U,U),bottom:new y.pointGeometry(0,-z),"bottom-left":new y.pointGeometry(U,-U),"bottom-right":new y.pointGeometry(-U,-U),left:new y.pointGeometry(z,0),right:new y.pointGeometry(-z,0)}}if(z instanceof y.pointGeometry||Array.isArray(z)){const U=y.pointGeometry.convert(z);return{center:U,top:U,"top-left":U,"top-right":U,bottom:U,"bottom-left":U,"bottom-right":U,left:U,right:U}}return{center:y.pointGeometry.convert(z.center||[0,0]),top:y.pointGeometry.convert(z.top||[0,0]),"top-left":y.pointGeometry.convert(z["top-left"]||[0,0]),"top-right":y.pointGeometry.convert(z["top-right"]||[0,0]),bottom:y.pointGeometry.convert(z.bottom||[0,0]),"bottom-left":y.pointGeometry.convert(z["bottom-left"]||[0,0]),"bottom-right":y.pointGeometry.convert(z["bottom-right"]||[0,0]),left:y.pointGeometry.convert(z.left||[0,0]),right:y.pointGeometry.convert(z.right||[0,0])}}(this.options.offset),C=this._anchor=this._getAnchor(M),L=g.add(M[C]).round();this._map._requestDomTask(()=>{this._container&&C&&j.setTransform(this._container,`${Us[C]} translate(${L.x}px,${L.y}px)`)})}this._updateClassList()}}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const I=this._container.querySelector(Wh);I&&I.focus()}_onClose(){this.remove()}_setOpacity(I){this._content&&(this._content.style.opacity=I),this._tip&&(this._tip.style.opacity=I)}},Marker:Zo,Style:Yr,LngLat:y.LngLat,LngLatBounds:y.LngLatBounds,Point:y.pointGeometry,MercatorCoordinate:y.MercatorCoordinate,FreeCameraOptions:Ia,Evented:y.Evented,config:y.config,prewarm:function(){pt().acquire(Fe)},clearPrewarmedResources:function(){const I=tt;I&&(I.isPreloaded()&&I.numActive()===1?(I.release(Fe),tt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return y.config.ACCESS_TOKEN},set accessToken(I){y.config.ACCESS_TOKEN=I},get baseApiUrl(){return y.config.API_URL},set baseApiUrl(I){y.config.API_URL=I},get workerCount(){return je.workerCount},set workerCount(I){je.workerCount=I},get maxParallelImageRequests(){return y.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(I){y.config.MAX_PARALLEL_IMAGE_REQUESTS=I},clearStorage(I){y.clearTileCache(I)},workerUrl:"",workerClass:null,setNow:y.exported.setNow,restoreNow:y.exported.restoreNow};return _o});var A=w;return A})})(mapboxGl);var mapboxgl=mapboxGl.exports,d2r=Math.PI/180,r2d=180/Math.PI;function tileToBBOX(h){var l=tile2lon(h[0]+1,h[2]),p=tile2lon(h[0],h[2]),m=tile2lat(h[1]+1,h[2]),w=tile2lat(h[1],h[2]);return[p,m,l,w]}function tileToGeoJSON(h){var l=tileToBBOX(h),p={type:"Polygon",coordinates:[[[l[0],l[3]],[l[0],l[1]],[l[2],l[1]],[l[2],l[3]],[l[0],l[3]]]]};return p}function tile2lon(h,l){return h/Math.pow(2,l)*360-180}function tile2lat(h,l){var p=Math.PI-2*Math.PI*h/Math.pow(2,l);return r2d*Math.atan(.5*(Math.exp(p)-Math.exp(-p)))}function pointToTile(h,l,p){var m=pointToTileFraction(h,l,p);return m[0]=Math.floor(m[0]),m[1]=Math.floor(m[1]),m}function getChildren(h){return[[h[0]*2,h[1]*2,h[2]+1],[h[0]*2+1,h[1]*2,h[2]+1],[h[0]*2+1,h[1]*2+1,h[2]+1],[h[0]*2,h[1]*2+1,h[2]+1]]}function getParent(h){return[h[0]>>1,h[1]>>1,h[2]-1]}function getSiblings(h){return getChildren(getParent(h))}function hasSiblings(h,l){for(var p=getSiblings(h),m=0;m<p.length;m++)if(!hasTile(l,p[m]))return!1;return!0}function hasTile(h,l){for(var p=0;p<h.length;p++)if(tilesEqual(h[p],l))return!0;return!1}function tilesEqual(h,l){return h[0]===l[0]&&h[1]===l[1]&&h[2]===l[2]}function tileToQuadkey(h){for(var l="",p=h[2];p>0;p--){var m=0,w=1<<p-1;(h[0]&w)!=0&&m++,(h[1]&w)!=0&&(m+=2),l+=m.toString()}return l}function quadkeyToTile(h){for(var l=0,p=0,m=h.length,w=m;w>0;w--){var T=1<<w-1,A=+h[m-w];A===1&&(l|=T),A===2&&(p|=T),A===3&&(l|=T,p|=T)}return[l,p,m]}function bboxToTile(h){var l=pointToTile(h[0],h[1],32),p=pointToTile(h[2],h[3],32),m=[l[0],l[1],p[0],p[1]],w=getBboxZoom(m);if(w===0)return[0,0,0];var T=m[0]>>>32-w,A=m[1]>>>32-w;return[T,A,w]}function getBboxZoom(h){for(var l=28,p=0;p<l;p++){var m=1<<32-(p+1);if((h[0]&m)!=(h[2]&m)||(h[1]&m)!=(h[3]&m))return p}return l}function pointToTileFraction(h,l,p){var m=Math.sin(l*d2r),w=Math.pow(2,p),T=w*(h/360+.5),A=w*(.5-.25*Math.log((1+m)/(1-m))/Math.PI);return T=T%w,T<0&&(T=T+w),[T,A,p]}var tilebelt={tileToGeoJSON,tileToBBOX,getChildren,getParent,getSiblings,hasTile,hasSiblings,tilesEqual,tileToQuadkey,quadkeyToTile,pointToTile,bboxToTile,pointToTileFraction};function feature(h,l,p){p===void 0&&(p={});var m={type:"Feature"};return(p.id===0||p.id)&&(m.id=p.id),p.bbox&&(m.bbox=p.bbox),m.properties=l||{},m.geometry=h,m}function polygon(h,l,p){p===void 0&&(p={});for(var m=0,w=h;m<w.length;m++){var T=w[m];if(T.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var A=0;A<T[T.length-1].length;A++)if(T[T.length-1][A]!==T[0][A])throw new Error("First and last Position are not equivalent.")}var y={type:"Polygon",coordinates:h};return feature(y,l,p)}function bboxPolygon(h,l){l===void 0&&(l={});var p=Number(h[0]),m=Number(h[1]),w=Number(h[2]),T=Number(h[3]);if(h.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var A=[p,m],y=[p,T],B=[w,T],D=[w,m];return polygon([[A,D,B,y,A]],l.properties,{bbox:h,id:l.id})}function getTileInfo(h,l,p){let m={},w=Math.floor(p.getZoom()),T=40075016686e-3*Math.abs(Math.cos(l))/Math.pow(2,w),A=T/512,y=tilebelt.pointToTile(h,l,w);m.z=w,m.x=y[0],m.y=y[1],m.long=h,m.lat=l,m.tileWidthInMeters=T,m.metersPerPixel=A,m.polygon_bb=getTileGeoJsonBB(m),m.mapbox_tile_name=m.z+"-"+m.x+"-"+m.y,m.rgbFileName="terrain-rgb-"+m.mapbox_tile_name+".png",m.thirtytwoFile={name:"thirtytwo-"+m.mapbox_tile_name+".png",bitDepth:32},m.sixteenFile={name:"sixteen-"+m.mapbox_tile_name,bitDepth:16};let B=[m.x,m.y,m.z],D=tilebelt.tileToBBOX(B);m.bbox=D;let N=new mapboxgl.LngLatBounds(m.bbox).getCenter();return m.bbox_center=N,m}function getFeaturesFromBB(h,l){if(l){let p=[l.geometry.coordinates[0][4]],m=[l.geometry.coordinates[0][2]];const w=new mapboxgl.LngLat(p[0][0],p[0][1]),T=new mapboxgl.LngLat(m[0][0],m[0][1]),A=h.project(w),y=h.project(T);return h.queryRenderedFeatures([A,y])}}function getTileGeoJsonBB(h){let l=[h.x,h.y,h.z],p=tilebelt.tileToBBOX(l),m=bboxPolygon(p);return{type:"Feature",geometry:{type:m.geometry.type,coordinates:m.geometry.coordinates}}}var mapUtils={getTileInfo,getFeaturesFromBB};function mitt(h){return{all:h=h||new Map,on:function(l,p){var m=h.get(l);m?m.push(p):h.set(l,[p])},off:function(l,p){var m=h.get(l);m&&(p?m.splice(m.indexOf(p)>>>0,1):h.set(l,[]))},emit:function(l,p){var m=h.get(l);m&&m.slice().map(function(w){w(p)}),(m=h.get("*"))&&m.slice().map(function(w){w(l,p)})}}}var emitter=mitt(),immutable=extend$2,hasOwnProperty=Object.prototype.hasOwnProperty;function extend$2(){for(var h={},l=0;l<arguments.length;l++){var p=arguments[l];for(var m in p)hasOwnProperty.call(p,m)&&(h[m]=p[m])}return h}var fuzzy$1={exports:{}};(function(h,l){(function(){var p={};h.exports=p,p.simpleFilter=function(m,w){return w.filter(function(T){return p.test(m,T)})},p.test=function(m,w){return p.match(m,w)!==null},p.match=function(m,w,T){T=T||{};var A=0,y=[],B=w.length,D=0,O=0,N=T.pre||"",j=T.post||"",G=T.caseSensitive&&w||w.toLowerCase(),H;m=T.caseSensitive&&m||m.toLowerCase();for(var te=0;te<B;te++)H=w[te],G[te]===m[A]?(H=N+H+j,A+=1,O+=1+O):O=0,D+=O,y[y.length]=H;return A===m.length?(D=G===m?1/0:D,{rendered:y.join(""),score:D}):null},p.filter=function(m,w,T){return!w||w.length===0?[]:typeof m!="string"?w:(T=T||{},w.reduce(function(A,y,B,D){var O=y;T.extract&&(O=T.extract(y));var N=p.match(m,O,T);return N!=null&&(A[A.length]={string:N.rendered,score:N.score,index:B,original:y}),A},[]).sort(function(A,y){var B=y.score-A.score;return B||A.index-y.index}))}})()})(fuzzy$1);var List$1=function(h){return this.component=h,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,h.el.parentNode.insertBefore(this.wrapper,h.el.nextSibling),this};List$1.prototype.show=function(){this.element.style.display="block"};List$1.prototype.hide=function(){this.element.style.display="none"};List$1.prototype.add=function(h){this.items.push(h)};List$1.prototype.clear=function(){this.items=[],this.active=0};List$1.prototype.isEmpty=function(){return!this.items.length};List$1.prototype.isVisible=function(){return this.element.style.display==="block"};List$1.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var h=0;h<this.items.length;h++)this.drawItem(this.items[h],this.active===h);this.show()};List$1.prototype.drawItem=function(h,l){var p=document.createElement("li"),m=document.createElement("a");l&&(p.className+=" active"),m.innerHTML=h.string,p.appendChild(m),this.element.appendChild(p),p.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),p.addEventListener("mouseup",function(){this.handleMouseUp.call(this,h)}.bind(this))};List$1.prototype.handleMouseUp=function(h){this.selectingListItem=!1,this.component.value(h.original),this.clear(),this.draw()};List$1.prototype.move=function(h){this.active=h,this.draw()};List$1.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};List$1.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};List$1.prototype.drawError=function(h){var l=document.createElement("li");l.innerHTML=h,this.element.appendChild(l),this.show()};var list=List$1,extend$1=immutable,fuzzy=fuzzy$1.exports,List=list,Suggestions$1=function(h,l,p){return p=p||{},this.options=extend$1({minLength:2,limit:5,filter:!0,hideOnBlur:!0},p),this.el=h,this.data=l||[],this.list=new List(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",function(m){this.handleKeyUp(m.keyCode)}.bind(this),!1),this.el.addEventListener("keydown",function(m){this.handleKeyDown(m)}.bind(this)),this.el.addEventListener("focus",function(){this.handleFocus()}.bind(this)),this.el.addEventListener("blur",function(){this.handleBlur()}.bind(this)),this.el.addEventListener("paste",function(m){this.handlePaste(m)}.bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};Suggestions$1.prototype.handleKeyUp=function(h){h===40||h===38||h===27||h===13||h===9||this.handleInputChange(this.el.value)};Suggestions$1.prototype.handleKeyDown=function(h){switch(h.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&h.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};Suggestions$1.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};Suggestions$1.prototype.handlePaste=function(h){if(h.clipboardData)this.handleInputChange(h.clipboardData.getData("Text"));else{var l=this;setTimeout(function(){l.handleInputChange(h.target.value)},100)}};Suggestions$1.prototype.handleInputChange=function(h){if(this.query=this.normalize(h),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates(function(l){for(var p=0;p<l.length&&(this.list.add(l[p]),p!==this.options.limit-1);p++);this.list.draw()}.bind(this))};Suggestions$1.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};Suggestions$1.prototype.update=function(h){this.data=h,this.handleKeyUp()};Suggestions$1.prototype.clear=function(){this.data=[],this.list.clear()};Suggestions$1.prototype.normalize=function(h){return h=h.toLowerCase(),h};Suggestions$1.prototype.match=function(h,l){return h.indexOf(l)>-1};Suggestions$1.prototype.value=function(h){if(this.selected=h,this.el.value=this.getItemValue(h),document.createEvent){var l=document.createEvent("HTMLEvents");l.initEvent("change",!0,!1),this.el.dispatchEvent(l)}else this.el.fireEvent("onchange")};Suggestions$1.prototype.getCandidates=function(h){var l={pre:"<strong>",post:"</strong>",extract:function(m){return this.getItemValue(m)}.bind(this)},p;this.options.filter?(p=fuzzy.filter(this.query,this.data,l),p=p.map(function(m){return{original:m.original,string:this.render(m.original,m.string)}}.bind(this))):p=this.data.map(function(m){var w=this.render(m);return{original:m,string:w}}.bind(this)),h(p)};Suggestions$1.prototype.getItemValue=function(h){return h};Suggestions$1.prototype.render=function(h,l){if(l)return l;for(var p=h.original?this.getItemValue(h.original):this.getItemValue(h),m=this.normalize(p),w=m.lastIndexOf(this.query);w>-1;){var T=w+this.query.length;p=p.slice(0,w)+"<strong>"+p.slice(w,T)+"</strong>"+p.slice(T),w=m.slice(0,w).lastIndexOf(this.query)}return p};Suggestions$1.prototype.renderError=function(h){this.list.drawError(h)};var suggestions$1=Suggestions$1,Suggestions=suggestions$1,suggestions=Suggestions;typeof window!="undefined"&&(window.Suggestions=Suggestions);var FUNC_ERROR_TEXT="Expected a function",NAN=0/0,symbolTag="[object Symbol]",reTrim=/^\s+|\s+$/g,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsOctal=/^0o[0-7]+$/i,freeParseInt=parseInt,freeGlobal=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf=typeof self=="object"&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),objectProto=Object.prototype,objectToString=objectProto.toString,nativeMax=Math.max,nativeMin=Math.min,now=function(){return root.Date.now()};function debounce$1(h,l,p){var m,w,T,A,y,B,D=0,O=!1,N=!1,j=!0;if(typeof h!="function")throw new TypeError(FUNC_ERROR_TEXT);l=toNumber(l)||0,isObject(p)&&(O=!!p.leading,N="maxWait"in p,T=N?nativeMax(toNumber(p.maxWait)||0,l):T,j="trailing"in p?!!p.trailing:j);function G(Re){var ge=m,ue=w;return m=w=void 0,D=Re,A=h.apply(ue,ge),A}function H(Re){return D=Re,y=setTimeout(Q,l),O?G(Re):A}function te(Re){var ge=Re-B,ue=Re-D,Se=l-ge;return N?nativeMin(Se,T-ue):Se}function oe(Re){var ge=Re-B,ue=Re-D;return B===void 0||ge>=l||ge<0||N&&ue>=T}function Q(){var Re=now();if(oe(Re))return _e(Re);y=setTimeout(Q,te(Re))}function _e(Re){return y=void 0,j&&m?G(Re):(m=w=void 0,A)}function se(){y!==void 0&&clearTimeout(y),D=0,m=B=w=y=void 0}function he(){return y===void 0?A:_e(now())}function me(){var Re=now(),ge=oe(Re);if(m=arguments,w=this,B=Re,ge){if(y===void 0)return H(B);if(N)return y=setTimeout(Q,l),G(B)}return y===void 0&&(y=setTimeout(Q,l)),A}return me.cancel=se,me.flush=he,me}function isObject(h){var l=typeof h;return!!h&&(l=="object"||l=="function")}function isObjectLike(h){return!!h&&typeof h=="object"}function isSymbol(h){return typeof h=="symbol"||isObjectLike(h)&&objectToString.call(h)==symbolTag}function toNumber(h){if(typeof h=="number")return h;if(isSymbol(h))return NAN;if(isObject(h)){var l=typeof h.valueOf=="function"?h.valueOf():h;h=isObject(l)?l+"":l}if(typeof h!="string")return h===0?h:+h;h=h.replace(reTrim,"");var p=reIsBinary.test(h);return p||reIsOctal.test(h)?freeParseInt(h.slice(2),p?2:8):reIsBadHex.test(h)?NAN:+h}var lodash_debounce=debounce$1,events$1={exports:{}},R=typeof Reflect=="object"?Reflect:null,ReflectApply=R&&typeof R.apply=="function"?R.apply:function h(l,p,m){return Function.prototype.apply.call(l,p,m)},ReflectOwnKeys;R&&typeof R.ownKeys=="function"?ReflectOwnKeys=R.ownKeys:Object.getOwnPropertySymbols?ReflectOwnKeys=function(l){return Object.getOwnPropertyNames(l).concat(Object.getOwnPropertySymbols(l))}:ReflectOwnKeys=function(l){return Object.getOwnPropertyNames(l)};function ProcessEmitWarning(h){console&&console.warn&&console.warn(h)}var NumberIsNaN=Number.isNaN||function h(l){return l!==l};function EventEmitter$2(){EventEmitter$2.init.call(this)}events$1.exports=EventEmitter$2;events$1.exports.once=once;EventEmitter$2.EventEmitter=EventEmitter$2;EventEmitter$2.prototype._events=void 0;EventEmitter$2.prototype._eventsCount=0;EventEmitter$2.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(h){if(typeof h!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof h)}Object.defineProperty(EventEmitter$2,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(h){if(typeof h!="number"||h<0||NumberIsNaN(h))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+h+".");defaultMaxListeners=h}});EventEmitter$2.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};EventEmitter$2.prototype.setMaxListeners=function h(l){if(typeof l!="number"||l<0||NumberIsNaN(l))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+l+".");return this._maxListeners=l,this};function _getMaxListeners(h){return h._maxListeners===void 0?EventEmitter$2.defaultMaxListeners:h._maxListeners}EventEmitter$2.prototype.getMaxListeners=function h(){return _getMaxListeners(this)};EventEmitter$2.prototype.emit=function h(l){for(var p=[],m=1;m<arguments.length;m++)p.push(arguments[m]);var w=l==="error",T=this._events;if(T!==void 0)w=w&&T.error===void 0;else if(!w)return!1;if(w){var A;if(p.length>0&&(A=p[0]),A instanceof Error)throw A;var y=new Error("Unhandled error."+(A?" ("+A.message+")":""));throw y.context=A,y}var B=T[l];if(B===void 0)return!1;if(typeof B=="function")ReflectApply(B,this,p);else for(var D=B.length,O=arrayClone(B,D),m=0;m<D;++m)ReflectApply(O[m],this,p);return!0};function _addListener(h,l,p,m){var w,T,A;if(checkListener(p),T=h._events,T===void 0?(T=h._events=Object.create(null),h._eventsCount=0):(T.newListener!==void 0&&(h.emit("newListener",l,p.listener?p.listener:p),T=h._events),A=T[l]),A===void 0)A=T[l]=p,++h._eventsCount;else if(typeof A=="function"?A=T[l]=m?[p,A]:[A,p]:m?A.unshift(p):A.push(p),w=_getMaxListeners(h),w>0&&A.length>w&&!A.warned){A.warned=!0;var y=new Error("Possible EventEmitter memory leak detected. "+A.length+" "+String(l)+" listeners added. Use emitter.setMaxListeners() to increase limit");y.name="MaxListenersExceededWarning",y.emitter=h,y.type=l,y.count=A.length,ProcessEmitWarning(y)}return h}EventEmitter$2.prototype.addListener=function h(l,p){return _addListener(this,l,p,!1)};EventEmitter$2.prototype.on=EventEmitter$2.prototype.addListener;EventEmitter$2.prototype.prependListener=function h(l,p){return _addListener(this,l,p,!0)};function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(h,l,p){var m={fired:!1,wrapFn:void 0,target:h,type:l,listener:p},w=onceWrapper.bind(m);return w.listener=p,m.wrapFn=w,w}EventEmitter$2.prototype.once=function h(l,p){return checkListener(p),this.on(l,_onceWrap(this,l,p)),this};EventEmitter$2.prototype.prependOnceListener=function h(l,p){return checkListener(p),this.prependListener(l,_onceWrap(this,l,p)),this};EventEmitter$2.prototype.removeListener=function h(l,p){var m,w,T,A,y;if(checkListener(p),w=this._events,w===void 0)return this;if(m=w[l],m===void 0)return this;if(m===p||m.listener===p)--this._eventsCount==0?this._events=Object.create(null):(delete w[l],w.removeListener&&this.emit("removeListener",l,m.listener||p));else if(typeof m!="function"){for(T=-1,A=m.length-1;A>=0;A--)if(m[A]===p||m[A].listener===p){y=m[A].listener,T=A;break}if(T<0)return this;T===0?m.shift():spliceOne(m,T),m.length===1&&(w[l]=m[0]),w.removeListener!==void 0&&this.emit("removeListener",l,y||p)}return this};EventEmitter$2.prototype.off=EventEmitter$2.prototype.removeListener;EventEmitter$2.prototype.removeAllListeners=function h(l){var p,m,w;if(m=this._events,m===void 0)return this;if(m.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):m[l]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete m[l]),this;if(arguments.length===0){var T=Object.keys(m),A;for(w=0;w<T.length;++w)A=T[w],A!=="removeListener"&&this.removeAllListeners(A);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(p=m[l],typeof p=="function")this.removeListener(l,p);else if(p!==void 0)for(w=p.length-1;w>=0;w--)this.removeListener(l,p[w]);return this};function _listeners(h,l,p){var m=h._events;if(m===void 0)return[];var w=m[l];return w===void 0?[]:typeof w=="function"?p?[w.listener||w]:[w]:p?unwrapListeners(w):arrayClone(w,w.length)}EventEmitter$2.prototype.listeners=function h(l){return _listeners(this,l,!0)};EventEmitter$2.prototype.rawListeners=function h(l){return _listeners(this,l,!1)};EventEmitter$2.listenerCount=function(h,l){return typeof h.listenerCount=="function"?h.listenerCount(l):listenerCount.call(h,l)};EventEmitter$2.prototype.listenerCount=listenerCount;function listenerCount(h){var l=this._events;if(l!==void 0){var p=l[h];if(typeof p=="function")return 1;if(p!==void 0)return p.length}return 0}EventEmitter$2.prototype.eventNames=function h(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(h,l){for(var p=new Array(l),m=0;m<l;++m)p[m]=h[m];return p}function spliceOne(h,l){for(;l+1<h.length;l++)h[l]=h[l+1];h.pop()}function unwrapListeners(h){for(var l=new Array(h.length),p=0;p<l.length;++p)l[p]=h[p].listener||h[p];return l}function once(h,l){return new Promise(function(p,m){function w(A){h.removeListener(l,T),m(A)}function T(){typeof h.removeListener=="function"&&h.removeListener("error",w),p([].slice.call(arguments))}eventTargetAgnosticAddListener(h,l,T,{once:!0}),l!=="error"&&addErrorHandlerIfEventEmitter(h,w,{once:!0})})}function addErrorHandlerIfEventEmitter(h,l,p){typeof h.on=="function"&&eventTargetAgnosticAddListener(h,"error",l,p)}function eventTargetAgnosticAddListener(h,l,p,m){if(typeof h.on=="function")m.once?h.once(l,p):h.on(l,p);else if(typeof h.addEventListener=="function")h.addEventListener(l,function w(T){m.once&&h.removeEventListener(l,w),p(T)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof h)}var exceptions$1={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}};function parseParam(h){var l=h.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return l?{key:l[1],value:l[2]}:null}function parseLink(h){var l=h.match(/<?([^>]*)>(.*)/);if(!l)return null;var p=l[1],m=l[2].split(";"),w=null,T=m.reduce(function(A,y){var B=parseParam(y);return B?B.key==="rel"?(w||(w=B.value),A):(A[B.key]=B.value,A):A},{});return w?{url:p,rel:w,params:T}:null}function parseLinkHeader$1(h){return h?h.split(/,\s*</).reduce(function(l,p){var m=parseLink(p);if(!m)return l;var w=m.rel.split(/\s+/);return w.forEach(function(T){l[T]||(l[T]={url:m.url,params:m.params})}),l},{}):{}}var parseLinkHeader_1=parseLinkHeader$1,parseLinkHeader=parseLinkHeader_1;function MapiResponse$1(h,l){this.request=h,this.headers=l.headers,this.rawBody=l.body,this.statusCode=l.statusCode;try{this.body=JSON.parse(l.body||"{}")}catch{this.body=l.body}this.links=parseLinkHeader(this.headers.link)}MapiResponse$1.prototype.hasNextPage=function h(){return!!this.links.next};MapiResponse$1.prototype.nextPage=function h(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};var mapiResponse=MapiResponse$1,constants$4={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"},constants$3=constants$4;function MapiError$1(h){var l=h.type||constants$3.ERROR_HTTP,p;if(h.body)try{p=JSON.parse(h.body)}catch{p=h.body}else p=null;var m=h.message||null;m||(typeof p=="string"?m=p:p&&typeof p.message=="string"?m=p.message:l===constants$3.ERROR_REQUEST_ABORTED&&(m="Request aborted")),this.message=m,this.type=l,this.statusCode=h.statusCode||null,this.request=h.request,this.body=p}var mapiError=MapiError$1;function parseSingleHeader(h){var l=h.indexOf(":"),p=h.substring(0,l).trim().toLowerCase(),m=h.substring(l+1).trim();return{name:p,value:m}}function parseHeaders$1(h){var l={};return h&&h.trim().split(/[\r|\n]+/).forEach(function(p){var m=parseSingleHeader(p);l[m.name]=m.value}),l}var parseHeaders_1=parseHeaders$1,MapiResponse=mapiResponse,MapiError=mapiError,constants$2=constants$4,parseHeaders=parseHeaders_1,requestsUnderway={};function browserAbort(h){var l=requestsUnderway[h.id];!l||(l.abort(),delete requestsUnderway[h.id])}function createResponse(h,l){return new MapiResponse(h,{body:l.response,headers:parseHeaders(l.getAllResponseHeaders()),statusCode:l.status})}function normalizeBrowserProgressEvent(h){var l=h.total,p=h.loaded,m=100*p/l;return{total:l,transferred:p,percent:m}}function sendRequestXhr(h,l){return new Promise(function(p,m){l.onprogress=function(A){h.emitter.emit(constants$2.EVENT_PROGRESS_DOWNLOAD,normalizeBrowserProgressEvent(A))};var w=h.file;w&&(l.upload.onprogress=function(A){h.emitter.emit(constants$2.EVENT_PROGRESS_UPLOAD,normalizeBrowserProgressEvent(A))}),l.onerror=function(A){m(A)},l.onabort=function(){var A=new MapiError({request:h,type:constants$2.ERROR_REQUEST_ABORTED});m(A)},l.onload=function(){if(delete requestsUnderway[h.id],l.status<200||l.status>=400){var A=new MapiError({request:h,body:l.response,statusCode:l.status});m(A);return}p(l)};var T=h.body;typeof T=="string"?l.send(T):T?l.send(JSON.stringify(T)):w?l.send(w):l.send(),requestsUnderway[h.id]=l}).then(function(p){return createResponse(h,p)})}function createRequestXhr(h,l){var p=h.url(l),m=new window.XMLHttpRequest;return m.open(h.method,p),Object.keys(h.headers).forEach(function(w){m.setRequestHeader(w,h.headers[w])}),m}function browserSend(h){return Promise.resolve().then(function(){var l=createRequestXhr(h,h.client.accessToken);return sendRequestXhr(h,l)})}var browserLayer={browserAbort,sendRequestXhr,browserSend,createRequestXhr},base64$1={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */(function(h,l){(function(p){var m=l,w=h&&h.exports==m&&h,T=typeof commonjsGlobal=="object"&&commonjsGlobal;(T.global===T||T.window===T)&&(p=T);var A=function(H){this.message=H};A.prototype=new Error,A.prototype.name="InvalidCharacterError";var y=function(H){throw new A(H)},B="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",D=/[\t\n\f\r ]/g,O=function(H){H=String(H).replace(D,"");var te=H.length;te%4==0&&(H=H.replace(/==?$/,""),te=H.length),(te%4==1||/[^+a-zA-Z0-9/]/.test(H))&&y("Invalid character: the string to be decoded is not correctly encoded.");for(var oe=0,Q,_e,se="",he=-1;++he<te;)_e=B.indexOf(H.charAt(he)),Q=oe%4?Q*64+_e:_e,oe++%4&&(se+=String.fromCharCode(255&Q>>(-2*oe&6)));return se},N=function(H){H=String(H),/[^\0-\xFF]/.test(H)&&y("The string to be encoded contains characters outside of the Latin1 range.");for(var te=H.length%3,oe="",Q=-1,_e,se,he,me,Re=H.length-te;++Q<Re;)_e=H.charCodeAt(Q)<<16,se=H.charCodeAt(++Q)<<8,he=H.charCodeAt(++Q),me=_e+se+he,oe+=B.charAt(me>>18&63)+B.charAt(me>>12&63)+B.charAt(me>>6&63)+B.charAt(me&63);return te==2?(_e=H.charCodeAt(Q)<<8,se=H.charCodeAt(++Q),me=_e+se,oe+=B.charAt(me>>10)+B.charAt(me>>4&63)+B.charAt(me<<2&63)+"="):te==1&&(me=H.charCodeAt(Q),oe+=B.charAt(me>>2)+B.charAt(me<<4&63)+"=="),oe},j={encode:N,decode:O,version:"0.1.0"};if(m&&!m.nodeType)if(w)w.exports=j;else for(var G in j)j.hasOwnProperty(G)&&(m[G]=j[G]);else p.base64=j})(commonjsGlobal)})(base64$1,base64$1.exports);var base64=base64$1.exports,tokenCache={};function parseToken$2(h){if(tokenCache[h])return tokenCache[h];var l=h.split("."),p=l[0],m=l[1];if(!m)throw new Error("Invalid token");var w=parsePaylod(m),T={usage:p,user:w.u};return has(w,"a")&&(T.authorization=w.a),has(w,"exp")&&(T.expires=w.exp*1e3),has(w,"iat")&&(T.created=w.iat*1e3),has(w,"scopes")&&(T.scopes=w.scopes),has(w,"client")&&(T.client=w.client),has(w,"ll")&&(T.lastLogin=w.ll),has(w,"iu")&&(T.impersonator=w.iu),tokenCache[h]=T,T}function parsePaylod(h){try{return JSON.parse(base64.decode(h))}catch{throw new Error("Invalid token")}}function has(h,l){return Object.prototype.hasOwnProperty.call(h,l)}var parseMapboxToken=parseToken$2,eventemitter3={exports:{}};(function(h){var l=Object.prototype.hasOwnProperty,p="~";function m(){}Object.create&&(m.prototype=Object.create(null),new m().__proto__||(p=!1));function w(B,D,O){this.fn=B,this.context=D,this.once=O||!1}function T(B,D,O,N,j){if(typeof O!="function")throw new TypeError("The listener must be a function");var G=new w(O,N||B,j),H=p?p+D:D;return B._events[H]?B._events[H].fn?B._events[H]=[B._events[H],G]:B._events[H].push(G):(B._events[H]=G,B._eventsCount++),B}function A(B,D){--B._eventsCount==0?B._events=new m:delete B._events[D]}function y(){this._events=new m,this._eventsCount=0}y.prototype.eventNames=function(){var D=[],O,N;if(this._eventsCount===0)return D;for(N in O=this._events)l.call(O,N)&&D.push(p?N.slice(1):N);return Object.getOwnPropertySymbols?D.concat(Object.getOwnPropertySymbols(O)):D},y.prototype.listeners=function(D){var O=p?p+D:D,N=this._events[O];if(!N)return[];if(N.fn)return[N.fn];for(var j=0,G=N.length,H=new Array(G);j<G;j++)H[j]=N[j].fn;return H},y.prototype.listenerCount=function(D){var O=p?p+D:D,N=this._events[O];return N?N.fn?1:N.length:0},y.prototype.emit=function(D,O,N,j,G,H){var te=p?p+D:D;if(!this._events[te])return!1;var oe=this._events[te],Q=arguments.length,_e,se;if(oe.fn){switch(oe.once&&this.removeListener(D,oe.fn,void 0,!0),Q){case 1:return oe.fn.call(oe.context),!0;case 2:return oe.fn.call(oe.context,O),!0;case 3:return oe.fn.call(oe.context,O,N),!0;case 4:return oe.fn.call(oe.context,O,N,j),!0;case 5:return oe.fn.call(oe.context,O,N,j,G),!0;case 6:return oe.fn.call(oe.context,O,N,j,G,H),!0}for(se=1,_e=new Array(Q-1);se<Q;se++)_e[se-1]=arguments[se];oe.fn.apply(oe.context,_e)}else{var he=oe.length,me;for(se=0;se<he;se++)switch(oe[se].once&&this.removeListener(D,oe[se].fn,void 0,!0),Q){case 1:oe[se].fn.call(oe[se].context);break;case 2:oe[se].fn.call(oe[se].context,O);break;case 3:oe[se].fn.call(oe[se].context,O,N);break;case 4:oe[se].fn.call(oe[se].context,O,N,j);break;default:if(!_e)for(me=1,_e=new Array(Q-1);me<Q;me++)_e[me-1]=arguments[me];oe[se].fn.apply(oe[se].context,_e)}}return!0},y.prototype.on=function(D,O,N){return T(this,D,O,N,!1)},y.prototype.once=function(D,O,N){return T(this,D,O,N,!0)},y.prototype.removeListener=function(D,O,N,j){var G=p?p+D:D;if(!this._events[G])return this;if(!O)return A(this,G),this;var H=this._events[G];if(H.fn)H.fn===O&&(!j||H.once)&&(!N||H.context===N)&&A(this,G);else{for(var te=0,oe=[],Q=H.length;te<Q;te++)(H[te].fn!==O||j&&!H[te].once||N&&H[te].context!==N)&&oe.push(H[te]);oe.length?this._events[G]=oe.length===1?oe[0]:oe:A(this,G)}return this},y.prototype.removeAllListeners=function(D){var O;return D?(O=p?p+D:D,this._events[O]&&A(this,O)):(this._events=new m,this._eventsCount=0),this},y.prototype.off=y.prototype.removeListener,y.prototype.addListener=y.prototype.on,y.prefixed=p,y.EventEmitter=y,h.exports=y})(eventemitter3);function encodeArray(h){return h.map(encodeURIComponent).join(",")}function encodeValue(h){return Array.isArray(h)?encodeArray(h):encodeURIComponent(String(h))}function appendQueryParam(h,l,p){if(p===!1||p===null)return h;var m=/\?/.test(h)?"&":"?",w=encodeURIComponent(l);return p!==void 0&&p!==""&&p!==!0&&(w+="="+encodeValue(p)),""+h+m+w}function appendQueryObject(h,l){if(!l)return h;var p=h;return Object.keys(l).forEach(function(m){var w=l[m];w!==void 0&&(Array.isArray(w)&&(w=w.filter(function(T){return T!=null}).join(",")),p=appendQueryParam(p,m,w))}),p}function prependOrigin(h,l){if(!l||h.slice(0,4)==="http")return h;var p=h[0]==="/"?"":"/";return""+l.replace(/\/$/,"")+p+h}function interpolateRouteParams(h,l){return l?h.replace(/\/:([a-zA-Z0-9]+)/g,function(p,m){var w=l[m];if(w===void 0)throw new Error("Unspecified route parameter "+m);var T=encodeValue(w);return"/"+T}):h}var urlUtils$1={appendQueryObject,appendQueryParam,prependOrigin,interpolateRouteParams},parseToken$1=parseMapboxToken,xtend$3=immutable,EventEmitter$1=eventemitter3.exports,urlUtils=urlUtils$1,constants$1=constants$4,requestId=1;function MapiRequest$1(h,l){if(!h)throw new Error("MapiRequest requires a client");if(!l||!l.path||!l.method)throw new Error("MapiRequest requires an options object with path and method properties");var p={};l.body&&(p["content-type"]="application/json");var m=xtend$3(p,l.headers),w=Object.keys(m).reduce(function(T,A){return T[A.toLowerCase()]=m[A],T},{});this.id=requestId++,this._options=l,this.emitter=new EventEmitter$1,this.client=h,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=l.path,this.method=l.method,this.origin=l.origin||h.origin,this.query=l.query||{},this.params=l.params||{},this.body=l.body||null,this.file=l.file||null,this.encoding=l.encoding||"utf8",this.sendFileAs=l.sendFileAs||null,this.headers=w}MapiRequest$1.prototype.url=function h(l){var p=urlUtils.prependOrigin(this.path,this.origin);p=urlUtils.appendQueryObject(p,this.query);var m=this.params,w=l==null?this.client.accessToken:l;if(w){p=urlUtils.appendQueryParam(p,"access_token",w);var T=parseToken$1(w).user;m=xtend$3({ownerId:T},m)}return p=urlUtils.interpolateRouteParams(p,m),p};MapiRequest$1.prototype.send=function h(){var l=this;if(l.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return l.sent=!0,l.client.sendRequest(l).then(function(p){return l.response=p,l.emitter.emit(constants$1.EVENT_RESPONSE,p),p},function(p){throw l.error=p,l.emitter.emit(constants$1.EVENT_ERROR,p),p})};MapiRequest$1.prototype.abort=function h(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};MapiRequest$1.prototype.eachPage=function h(l){var p=this;function m(A){function y(){delete p._nextPageRequest;var B=A.nextPage();B&&(p._nextPageRequest=B,T(B))}l(null,A,y)}function w(A){l(A,null,function(){})}function T(A){A.send().then(m,w)}T(this)};MapiRequest$1.prototype.clone=function h(){return this._extend()};MapiRequest$1.prototype._extend=function h(l){var p=xtend$3(this._options,l);return new MapiRequest$1(this.client,p)};var mapiRequest=MapiRequest$1,parseToken=parseMapboxToken,MapiRequest=mapiRequest,constants=constants$4;function MapiClient$2(h){if(!h||!h.accessToken)throw new Error("Cannot create a client without an access token");parseToken(h.accessToken),this.accessToken=h.accessToken,this.origin=h.origin||constants.API_ORIGIN}MapiClient$2.prototype.createRequest=function h(l){return new MapiRequest(this,l)};var mapiClient=MapiClient$2,browser=browserLayer,MapiClient$1=mapiClient;function BrowserClient(h){MapiClient$1.call(this,h)}BrowserClient.prototype=Object.create(MapiClient$1.prototype);BrowserClient.prototype.constructor=BrowserClient;BrowserClient.prototype.sendRequest=browser.browserSend;BrowserClient.prototype.abortRequest=browser.browserAbort;function createBrowserClient(h){return new BrowserClient(h)}var browserClient=createBrowserClient,client=browserClient,mapboxSdk=client,toString=Object.prototype.toString,isPlainObj=function(h){var l;return toString.call(h)==="[object Object]"&&(l=Object.getPrototypeOf(h),l===null||l===Object.getPrototypeOf({}))},isPlainObject=isPlainObj,xtend$2=immutable,DEFAULT_ERROR_PATH="value",NEWLINE_INDENT=`
  `,v$3={};v$3.assert=function(h,l){return l=l||{},function(p){var m=validate(h,p);if(!!m){var w=processMessage(m,l);throw l.apiName&&(w=l.apiName+": "+w),new Error(w)}}};v$3.shape=function h(l){var p=objectEntries(l);return function(w){var T=validate(v$3.plainObject,w);if(T)return T;for(var A,y,B=[],D=0;D<p.length;D++)A=p[D].key,y=p[D].value,T=validate(y,w[A]),T&&B.push([A].concat(T));return B.length<2?B[0]:function(O){B=B.map(function(G){var H=G[0],te=processMessage(G,O).split(`
`).join(NEWLINE_INDENT);return"- "+H+": "+te});var N=O.path.join("."),j=N===DEFAULT_ERROR_PATH?"":" of "+N;return"The following properties"+j+" have invalid values:"+NEWLINE_INDENT+B.join(NEWLINE_INDENT)}}};v$3.strictShape=function h(l){var p=v$3.shape(l);return function(w){var T=p(w);if(T)return T;var A=Object.keys(w).reduce(function(y,B){return l[B]===void 0&&y.push(B),y},[]);if(A.length!==0)return function(){return"The following keys are invalid: "+A.join(", ")}}};v$3.arrayOf=function h(l){return createArrayValidator(l)};v$3.tuple=function h(){var l=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return createArrayValidator(l)};function createArrayValidator(h){var l=Array.isArray(h),p=function(m){return l?h[m]:h};return function(w){var T=validate(v$3.plainArray,w);if(T)return T;if(l&&w.length!==h.length)return"an array with "+h.length+" items";for(var A=0;A<w.length;A++)if(T=validate(p(A),w[A]),T)return[A].concat(T)}}v$3.required=function h(l){function p(m){return m==null?function(w){return formatErrorMessage(w,isArrayCulprit(w.path)?"cannot be undefined/null.":"is required.")}:l.apply(this,arguments)}return p.__required=!0,p};v$3.oneOfType=function h(){var l=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(m){var w=l.map(function(T){return validate(T,m)}).filter(Boolean);if(w.length===l.length)return w.every(function(T){return T.length===1&&typeof T[0]=="string"})?orList(w.map(function(T){return T[0]})):w.reduce(function(T,A){return A.length>T.length?A:T})}};v$3.equal=function h(l){return function(m){if(m!==l)return JSON.stringify(l)}};v$3.oneOf=function h(){var l=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),p=l.map(function(m){return v$3.equal(m)});return v$3.oneOfType.apply(this,p)};v$3.range=function h(l){var p=l[0],m=l[1];return function(T){var A=validate(v$3.number,T);if(A||T<p||T>m)return"number between "+p+" & "+m+" (inclusive)"}};v$3.any=function h(){};v$3.boolean=function h(l){if(typeof l!="boolean")return"boolean"};v$3.number=function h(l){if(typeof l!="number")return"number"};v$3.plainArray=function h(l){if(!Array.isArray(l))return"array"};v$3.plainObject=function h(l){if(!isPlainObject(l))return"object"};v$3.string=function h(l){if(typeof l!="string")return"string"};v$3.func=function h(l){if(typeof l!="function")return"function"};function validate(h,l){if(!(l==null&&!h.hasOwnProperty("__required"))){var p=h(l);if(p)return Array.isArray(p)?p:[p]}}function processMessage(h,l){var p=h.length,m=h[p-1],w=h.slice(0,p-1);return w.length===0&&(w=[DEFAULT_ERROR_PATH]),l=xtend$2(l,{path:w}),typeof m=="function"?m(l):formatErrorMessage(l,prettifyResult(m))}function orList(h){return h.length<2?h[0]:h.length===2?h.join(" or "):h.slice(0,-1).join(", ")+", or "+h.slice(-1)}function prettifyResult(h){return"must be "+addArticle(h)+"."}function addArticle(h){return/^an? /.test(h)?h:/^[aeiou]/i.test(h)?"an "+h:/^[a-z]/i.test(h)?"a "+h:h}function formatErrorMessage(h,l){var p=isArrayCulprit(h.path),m=h.path.join(".")+" "+l,w=p?"Item at position ":"";return w+m}function isArrayCulprit(h){return typeof h[h.length-1]=="number"||typeof h[0]=="number"}function objectEntries(h){return Object.keys(h||{}).map(function(l){return{key:l,value:h[l]}})}v$3.validate=validate;v$3.processMessage=processMessage;var lib$1=v$3,xtend$1=immutable,v$2=lib$1;function file(h){if(typeof window!="undefined")return h instanceof commonjsGlobal.Blob||h instanceof commonjsGlobal.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof h=="string"||h.pipe!==void 0))return"Filename or Readable stream"}function assertShape(h,l){return v$2.assert(v$2.strictShape(h),l)}function date(h){var l="date";if(typeof h=="boolean")return l;try{var p=new Date(h);if(p.getTime&&isNaN(p.getTime()))return l}catch{return l}}function coordinates(h){return v$2.tuple(v$2.number,v$2.number)(h)}var validator=xtend$1(v$2,{file,date,coordinates,assertShape});function pick$1(h,l){var p=function(m,w){return l.indexOf(m)!==-1&&w!==void 0};return typeof l=="function"&&(p=l),Object.keys(h).filter(function(m){return p(m,h[m])}).reduce(function(m,w){return m[w]=h[w],m},{})}var pick_1=pick$1;function objectMap$1(h,l){return Object.keys(h).reduce(function(p,m){return p[m]=l(m,h[m]),p},{})}var objectMap_1=objectMap$1,objectMap=objectMap_1;function stringifyBoolean(h){return objectMap(h,function(l,p){return typeof p=="boolean"?JSON.stringify(p):p})}var stringifyBooleans$1=stringifyBoolean,MapiClient=mapiClient,createClient=browserClient;function createServiceFactory$1(h){return function(l){var p;MapiClient.prototype.isPrototypeOf(l)?p=l:p=createClient(l);var m=Object.create(h);return m.client=p,m}}var createServiceFactory_1=createServiceFactory$1,xtend=immutable,v$1=validator,pick=pick_1,stringifyBooleans=stringifyBooleans$1,createServiceFactory=createServiceFactory_1,Geocoding={},featureTypes=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Geocoding.forwardGeocode=function(h){v$1.assertShape({query:v$1.required(v$1.string),mode:v$1.oneOf("mapbox.places","mapbox.places-permanent"),countries:v$1.arrayOf(v$1.string),proximity:v$1.coordinates,types:v$1.arrayOf(v$1.oneOf(featureTypes)),autocomplete:v$1.boolean,bbox:v$1.arrayOf(v$1.number),limit:v$1.number,language:v$1.arrayOf(v$1.string),routing:v$1.boolean,fuzzyMatch:v$1.boolean,worldview:v$1.string})(h),h.mode=h.mode||"mapbox.places";var l=stringifyBooleans(xtend({country:h.countries},pick(h,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(h,["mode","query"]),query:l})};Geocoding.reverseGeocode=function(h){v$1.assertShape({query:v$1.required(v$1.coordinates),mode:v$1.oneOf("mapbox.places","mapbox.places-permanent"),countries:v$1.arrayOf(v$1.string),types:v$1.arrayOf(v$1.oneOf(featureTypes)),bbox:v$1.arrayOf(v$1.number),limit:v$1.number,language:v$1.arrayOf(v$1.string),reverseMode:v$1.oneOf("distance","score"),routing:v$1.boolean,worldview:v$1.string})(h),h.mode=h.mode||"mapbox.places";var l=stringifyBooleans(xtend({country:h.countries},pick(h,["country","types","bbox","limit","language","reverseMode","routing","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(h,["mode","query"]),query:l})};var geocoding=createServiceFactory(Geocoding),crypto=self.crypto||self.msCrypto,url="-_",i$1=36;for(;i$1--;)url+=i$1.toString(36);i$1=36;for(;i$1---10;)url+=i$1.toString(36).toUpperCase();var index_browser=function(h){var l="",p=crypto.getRandomValues(new Uint8Array(h||21));for(i$1=h||21;i$1--;)l+=url[p[i$1]&63];return l},nanoid=index_browser;function MapboxEventManager$1(h){this.origin=h.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=h.accessToken,this.version="0.2.0",this.sessionID=this.generateSessionID(),this.userAgent=this.getUserAgent(),this.options=h,this.send=this.send.bind(this),this.countries=h.countries?h.countries.split(","):null,this.types=h.types?h.types.split(","):null,this.bbox=h.bbox?h.bbox:null,this.language=h.language?h.language.split(","):null,this.limit=h.limit?+h.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(h),this.eventQueue=new Array,this.flushInterval=h.flushInterval||1e3,this.maxQueueSize=h.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}MapboxEventManager$1.prototype={select:function(h,l){var p=this.getSelectedIndex(h,l),m=this.getEventPayload("search.select",l);if(m.resultIndex=p,m.resultPlaceName=h.place_name,m.resultId=h.id,!(p===this.lastSentIndex&&m.queryString===this.lastSentInput||p==-1)&&(this.lastSentIndex=p,this.lastSentInput=m.queryString,!!m.queryString))return this.push(m)},start:function(h){var l=this.getEventPayload("search.start",h);if(!!l.queryString)return this.push(l)},keyevent:function(h,l){if(!!h.key&&!(h.metaKey||[9,27,37,39,13,38,40].indexOf(h.keyCode)!==-1)){var p=this.getEventPayload("search.keystroke",l);if(p.lastAction=h.key,!!p.queryString)return this.push(p)}},send:function(h,l){if(!this.enableEventLogging)return l?l():void 0;var p=this.getRequestOptions(h);this.request(p,function(m){if(m)return this.handleError(m,l);if(l)return l()}.bind(this))},getRequestOptions:function(h){Array.isArray(h)||(h=[h]);var l={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(h)};return l},getEventPayload:function(h,l){var p;l.options.proximity?p=[l.options.proximity.longitude,l.options.proximity.latitude]:p=null;var m=l._map?l._map.getZoom():void 0,w={event:h,created:+new Date,sessionIdentifier:this.sessionID,country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:l.options.autocomplete,fuzzyMatch:l.options.fuzzyMatch,proximity:p,limit:l.options.limit,routing:l.options.routing,worldview:l.options.worldview,mapZoom:m,keyboardLocale:this.locale};return h==="search.select"?w.queryString=l.inputString:h!="search.select"&&l._inputEl?w.queryString=l._inputEl.value:w.queryString=l.inputString,w},request:function(h,l){var p=new XMLHttpRequest;p.onreadystatechange=function(){if(this.readyState==4)return this.status==204?l(null):l(this.statusText)},p.open(h.method,h.host+"/"+h.path,!0);for(var m in h.headers){var w=h.headers[m];p.setRequestHeader(m,w)}p.send(h.body)},handleError:function(h,l){if(l)return l(h)},generateSessionID:function(){return nanoid()},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(h,l){if(!!l._typeahead){var p=l._typeahead.data,m=h.id,w=p.map(function(A){return A.id}),T=w.indexOf(m);return T}},shouldEnableLogging:function(h){return!(h.enableEventLogging===!1||h.origin&&h.origin.indexOf("api.mapbox.com")==-1||h.localGeocoder||h.filter)},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(h,l){this.eventQueue.push(h),(this.eventQueue.length>=this.maxQueueSize||l)&&this.flush()},remove:function(){this.flush()}};var events=MapboxEventManager$1,placeholder={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"\u05DC\u05D7\u05E4\u05E9",ja:"\u30B5\u30FC\u30C1",lv:"Mekl\u0113t",pt:"Procurar",sr:"\u041F\u0440\u0435\u0442\u0440\u0430\u0433\u0430",zh:"\u641C\u7D22",cs:"Vyhled\xE1v\xE1n\xED",hu:"Keres\xE9s",ka:"\u10EB\u10D8\u10D4\u10D1\u10D0",nb:"S\xF8ke",sk:"Vyh\u013Ead\xE1vanie",th:"\u0E04\u0E49\u0E19\u0E2B\u0E32",fi:"Hae",is:"Leita",ko:"\uC218\uC0C9",pl:"Szukaj",sl:"Iskanje",fa:"\u062C\u0633\u062A\u062C\u0648",ru:"\u041F\u043E\u0438\u0441\u043A"},localization$1={placeholder},subtag$1={exports:{}};(function(h){(function(l,p,m){h.exports?h.exports=m():l[p]=m()})(commonjsGlobal,"subtag",function(){var l="",p=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function m(B){return B.match(p)||[]}function w(B){return m(B).filter(function(D,O){return D&&O})}function T(B){return B=m(B),{language:B[1]||l,extlang:B[2]||l,script:B[3]||l,region:B[4]||l}}function A(B,D,O){Object.defineProperty(B,D,{value:O,enumerable:!0})}function y(B,D,O){function N(j){return m(j)[B]||l}A(N,"pattern",D),A(T,O,N)}return y(1,/^[a-zA-Z]{2,3}$/,"language"),y(2,/^[a-zA-Z]{3}$/,"extlang"),y(3,/^[a-zA-Z]{4}$/,"script"),y(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),A(T,"split",w),T})})(subtag$1);var Typeahead=suggestions,debounce=lodash_debounce,extend=immutable,EventEmitter=events$1.exports.EventEmitter,exceptions=exceptions$1,MapboxClient=mapboxSdk,mbxGeocoder=geocoding,MapboxEventManager=events,localization=localization$1,subtag=subtag$1.exports;const GEOCODE_REQUEST_TYPE={FORWARD:0,LOCAL:1,REVERSE:2};function MapboxGeocoder(h){this._eventEmitter=new EventEmitter,this.options=extend({},this.options,h),this.inputString="",this.fresh=!0,this.lastSelected=null}MapboxGeocoder.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,getItemValue:function(h){return h.place_name},render:function(h){var l=h.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+l[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+l.splice(1,l.length).join(",")+"</div></div>"}},addTo:function(h){function l(p,m){if(!document.body.contains(m))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const w=p.onAdd();m.appendChild(w)}if(h._controlContainer)h.addControl(this);else if(h instanceof HTMLElement)l(this,h);else if(typeof h=="string"){const p=document.querySelectorAll(h);if(p.length===0)throw new Error("Element ",h,"not found.");if(p.length>1)throw new Error("Geocoder can only be added to a single html element");l(this,p[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(h){if(h&&typeof h!="string"&&(this._map=h),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new MapboxEventManager(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this);var l=this.container=document.createElement("div");l.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var p=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",debounce(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",function(T){this.eventManager.keyevent(T,this)}.bind(this));var m=document.createElement("div");m.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var w=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');return this._clearEl.appendChild(w),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),m.appendChild(this._clearEl),m.appendChild(this._loadingEl),l.appendChild(p),l.appendChild(this._inputEl),l.appendChild(m),this._typeahead=new Typeahead(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit}),this.setRenderFunction(this.options.render),this._typeahead.getItemValue=this.options.getItemValue,this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),l},createIcon:function(h,l){var p=document.createElementNS("http://www.w3.org/2000/svg","svg");if(p.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+h),p.setAttribute("viewBox","0 0 18 18"),p.setAttribute("xml:space","preserve"),p.setAttribute("width",18),p.setAttribute("height",18),"innerHTML"in p)p.innerHTML=l;else{var m=document.createElement("div");m.innerHTML="<svg>"+l.valueOf().toString()+"</svg>";var w=m.firstChild,T=w.firstChild;p.appendChild(T)}return p},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_onPaste:function(h){var l=(h.clipboardData||window.clipboardData).getData("text");l.length>=this.options.minLength&&this._geocode(l)},_onKeyDown:function(h){var l=27,p=9;if(h.keyCode===l&&this.options.clearAndBlurOnEsc)return this._clear(h),this._inputEl.blur();var m=h.target&&h.target.shadowRoot?h.target.shadowRoot.activeElement:h.target,w=m?m.value:"";if(!w)return this.fresh=!0,h.keyCode!==p&&this.clear(h),this._clearEl.style.display="none";h.metaKey||[p,l,37,39,13,38,40].indexOf(h.keyCode)!==-1||m.value.length>=this.options.minLength&&this._geocode(m.value)},_showButton:function(){this._typeahead.selected&&(this._clearEl.style.display="block")},_hideButton:function(){this._typeahead.selected&&(this._clearEl.style.display="none")},_onBlur:function(h){this.options.clearOnBlur&&this._clearOnBlur(h),this.options.collapsed&&this._collapse()},_onChange:function(){var h=this._typeahead.selected;if(h&&JSON.stringify(h)!==this.lastSelected){if(this._clearEl.style.display="none",this.options.flyTo){var l;if(h.properties&&exceptions[h.properties.short_code])l=extend({},this.options.flyTo),this._map&&this._map.fitBounds(exceptions[h.properties.short_code].bbox,l);else if(h.bbox){var p=h.bbox;l=extend({},this.options.flyTo),this._map&&this._map.fitBounds([[p[0],p[1]],[p[2],p[3]]],l)}else{var m={zoom:this.options.zoom};l=extend({},m,this.options.flyTo),h.center?l.center=h.center:h.geometry&&h.geometry.type&&h.geometry.type==="Point"&&h.geometry.coordinates&&(l.center=h.geometry.coordinates),this._map&&this._map.flyTo(l)}}this.options.marker&&this._mapboxgl&&this._handleMarker(h),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(h),this._eventEmitter.emit("result",{result:h}),this.eventManager.select(h,this)}},_requestType:function(h,l){var p;const m=/^[ ]*(-?\d+\.?\d*)[, ]+(-?\d+\.?\d*)[ ]*$/;return h.localGeocoderOnly?p=GEOCODE_REQUEST_TYPE.LOCAL:h.reverseGeocode&&m.test(l)?p=GEOCODE_REQUEST_TYPE.REVERSE:p=GEOCODE_REQUEST_TYPE.FORWARD,p},_setupConfig:function(h,l){const p=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],m=/[\s,]+/;var w=this,T=p.reduce(function(y,B){if(w.options[B]===void 0||w.options[B]===null)return y;["countries","types","language"].indexOf(B)>-1?y[B]=w.options[B].split(m):y[B]=w.options[B];const D=typeof w.options[B].longitude=="number"&&typeof w.options[B].latitude=="number";if(B==="proximity"&&D){const O=w.options[B].longitude,N=w.options[B].latitude;y[B]=[O,N]}return y},{});switch(h){case GEOCODE_REQUEST_TYPE.REVERSE:{var A=l.split(m).map(function(y){return parseFloat(y,10)}).reverse();T.types&&T.types[0],T=extend(T,{query:A,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(y){y in T&&delete T[y]})}break;case GEOCODE_REQUEST_TYPE.FORWARD:/^[ ]*(-?\d+\.?\d*)[, ]+(-?\d+\.?\d*)*[ ]*$/.test(l)&&(l=l.replace(/,/g," ")),T=extend(T,{query:l});break}return T},_geocode:function(h){this.inputString=h,this._loadingEl.style.display="block",this._eventEmitter.emit("loading",{query:h});const l=this._requestType(this.options,h),p=this._setupConfig(l,h);var m;switch(l){case GEOCODE_REQUEST_TYPE.LOCAL:m=Promise.resolve();break;case GEOCODE_REQUEST_TYPE.FORWARD:m=this.geocoderService.forwardGeocode(p).send();break;case GEOCODE_REQUEST_TYPE.REVERSE:m=this.geocoderService.reverseGeocode(p).send();break}var w=this.options.localGeocoder?this.options.localGeocoder(h)||[]:[],T=[],A=null;return m.catch(function(y){A=y}.bind(this)).then(function(y){this._loadingEl.style.display="none";var B={};return y?y.statusCode=="200"&&(B=y.body,B.request=y.request,B.headers=y.headers):B={type:"FeatureCollection",features:[]},B.config=p,this.fresh&&(this.eventManager.start(this),this.fresh=!1),B.features=B.features?w.concat(B.features):w,this.options.externalGeocoder?(T=this.options.externalGeocoder(h,B.features)||[],T.then(function(D){return B.features=B.features?D.concat(B.features):D,B},function(){return B})):B}.bind(this)).then(function(y){if(A)throw A;this.options.filter&&y.features.length&&(y.features=y.features.filter(this.options.filter)),y.features.length?(this._clearEl.style.display="block",this._eventEmitter.emit("results",y),this._typeahead.update(y.features)):(this._clearEl.style.display="none",this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",y))}.bind(this)).catch(function(y){this._loadingEl.style.display="none",w.length&&this.options.localGeocoder||T.length&&this.options.externalGeocoder?(this._clearEl.style.display="block",this._typeahead.update(w)):(this._clearEl.style.display="none",this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:w}),this._eventEmitter.emit("error",{error:y})}.bind(this)),m},_clear:function(h){h&&h.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this._onChange(),this._clearEl.style.display="none",this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(h){this._clear(h),this._inputEl.focus()},_clearOnBlur:function(h){var l=this;h.relatedTarget&&l._clear(h)},_onQueryResult:function(h){var l=h.body;if(!!l.features.length){var p=l.features[0];this._typeahead.selected=p,this._inputEl.value=p.place_name,this._onChange()}},_updateProximity:function(){if(!!this._map)if(this._map.getZoom()>9){var h=this._map.getCenter().wrap();this.setProximity({longitude:h.lng,latitude:h.lat})}else this.setProximity(null)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(h){return this._geocode(h).then(this._onQueryResult),this},_renderError:function(){var h="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(h)},_renderNoResults:function(){var h="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(h)},_renderMessage:function(h){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(h)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var h=this.options.language.split(",")[0],l=subtag.language(h),p=localization.placeholder[l];if(p)return p}return"Search"},setInput:function(h){return this._inputEl.value=h,this._typeahead.selected=null,this._typeahead.clear(),h.length>=this.options.minLength&&this._geocode(h),this},setProximity:function(h){return this.options.proximity=h,this},getProximity:function(){return this.options.proximity},setRenderFunction:function(h){return h&&typeof h=="function"&&(this._typeahead.render=h),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(h){var l=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=h||this.options.language||l,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(h){return this.options.zoom=h,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(h){return this.options.flyTo=h,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(h){return this.placeholder=h||this._getPlaceholderText(),this._inputEl.placeholder=this.placeholder,this._inputEl.setAttribute("aria-label",this.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(h){return this.options.bbox=h,this},getCountries:function(){return this.options.countries},setCountries:function(h){return this.options.countries=h,this},getTypes:function(){return this.options.types},setTypes:function(h){return this.options.types=h,this},getMinLength:function(){return this.options.minLength},setMinLength:function(h){return this.options.minLength=h,this._typeahead&&(this._typeahead.options.minLength=h),this},getLimit:function(){return this.options.limit},setLimit:function(h){return this.options.limit=h,this._typeahead&&(this._typeahead.options.limit=h),this},getFilter:function(){return this.options.filter},setFilter:function(h){return this.options.filter=h,this},setOrigin:function(h){return this.options.origin=h,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAutocomplete:function(h){return this.options.autocomplete=h,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(h){return this.options.fuzzyMatch=h,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(h){return this.options.routing=h,this},getRouting:function(){return this.options.routing},setWorldview:function(h){return this.options.worldview=h,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(h){if(!!this._map){this._removeMarker();var l={color:"#4668F2"},p=extend({},l,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(p),h.center?this.mapMarker.setLngLat(h.center).addTo(this._map):h.geometry&&h.geometry.type&&h.geometry.type==="Point"&&h.geometry.coordinates&&this.mapMarker.setLngLat(h.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(h,l){return this._eventEmitter.on(h,l),this},off:function(h,l){return this._eventEmitter.removeListener(h,l),this.eventManager.remove(),this}};var lib=MapboxGeocoder,mapboxMapViewer_vue_vue_type_style_index_0_lang="";const _sfc_main$4={name:"mapbox-map-viewer",setup(){return{dirHandle:ref(""),style_url:ref(""),access_token:ref(""),mapbox_raster_png_dem:ref(""),map:ref(""),threedview:ref(!1),layers:ref(["hillshading","bounding_box","undersea-features-lines","undersea-features-points","undersea-features-points-label","10m-bathymetry-81bsvj"]),layer_type:[{label:"Hillshade",value:"hillshading"},{label:"Bounding Box",value:"bounding_box"},{label:"Undersea Lines",value:"undersea-features-lines"},{label:"Undersea Points",value:"undersea-features-points"},{label:"Undersea Labels",value:"undersea-features-points-label"},{label:"Depth",value:"10m-bathymetry-81bsvj"},{label:"Satellite",value:"satellite"},{label:"3D",value:"3d"}]}},mounted(){},methods:{async changeLayers(h){for(const l of this.layer_type)h.includes(l.value)?l.value!=="3d"?this.map.setLayoutProperty(l.value,"visibility","visible"):this.map.setTerrain({source:"mapbox-3d",exaggeration:1.5}):l.value!=="3d"?this.map.setLayoutProperty(l.value,"visibility","none"):this.map.setTerrain(null)},loadMapSourcesLayers(h){h.addSource("mapbox_raster_png_dem",{type:"raster-dem",url:this.mapbox_raster_png_dem}),h.addSource("satellite",{type:"raster",url:"mapbox://mapbox.satellite",tileSize:512}),h.addLayer({id:"satellite",source:"satellite",type:"raster",layout:{visibility:"none"}}),h.addLayer({id:"hillshading",source:"mapbox_raster_png_dem",type:"hillshade"}),h.addSource("bounding_box_source",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,1],[1,1],[1,0],[0,0]]]}}}),h.addLayer({id:"bounding_box",type:"fill",source:"bounding_box_source",paint:{"fill-color":"#008888","fill-opacity":0}}),h.addSource("bathymetry",{type:"vector",url:"mapbox://mapbox-public.bathymetry"}),h.addLayer({id:"undersea-features-lines",type:"line",source:"bathymetry","source-layer":"undersea-features-lines",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ff69b4","line-width":2}}),h.addLayer({id:"undersea-features-points",type:"circle",source:"bathymetry","source-layer":"undersea-features-points",paint:{"circle-radius":4,"circle-color":"#01fe01"}}),h.addLayer({id:"undersea-features-points-label",type:"symbol",source:"bathymetry","source-layer":"undersea-features-points",layout:{"text-field":"{name}","text-anchor":"top-left","text-size":12}}),h.addSource("10m-bathymetry-81bsvj",{type:"vector",url:"mapbox://mapbox.9tm8dx88"}),h.addSource("mapbox-3d",{type:"raster-dem",url:this.mapbox_raster_png_dem,tileSize:512,maxzoom:14}),h.addLayer({id:"10m-bathymetry-81bsvj",type:"fill",source:"10m-bathymetry-81bsvj","source-layer":"10m-bathymetry-81bsvj",layout:{},paint:{"fill-outline-color":"hsla(337, 82%, 62%, 0)","fill-color":["interpolate",["cubic-bezier",0,.5,1,.5],["get","DEPTH"],200,"#78bced",9e3,"#15659f"]}},"land-structure-polygon")},async loadMapboxMap(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.dirHandle=await idbKeyval.get("dirHandle"),this.style_url=await idbKeyval.get("style_url"),this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem");let h=this,l=new mapboxgl.Map({container:"map",trackResize:!0,style:h.style_url,center:[-121.7598,46.876],zoom:9,doubleClickZoom:!0,antialias:!0,boxZoom:!0,failIfMajorPerformanceCaveat:!0});this.map=l;const p=function(A){const y=A.match(/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i);if(!y)return null;function B(j,G){return{center:[j,G],geometry:{type:"Point",coordinates:[j,G]},place_name:"Lat: "+G+" Lng: "+j,place_type:["coordinate"],properties:{},type:"Feature"}}const D=Number(y[1]),O=Number(y[2]),N=[];return(D<-90||D>90)&&N.push(B(D,O)),(O<-90||O>90)&&N.push(B(O,D)),N.length===0&&(N.push(B(D,O)),N.push(B(O,D))),N};l.addControl(new lib({accessToken:this.access_token,mapboxgl,localGeocoder:p,zoom:10,placeholder:"Try: -40, 170 or  Name",reverseGeocode:!0})),l.addControl(new mapboxgl.FullscreenControl({})),l.addControl(new mapboxgl.NavigationControl);const m=100,w=25;function T(A){return A*(2-A)}l.on("style.load",()=>{const A=()=>{l.isStyleLoaded()?h.loadMapSourcesLayers(l):setTimeout(A,200)};A()}),l.on("load",function(){l.getCanvas().focus(),l.getCanvas().addEventListener("keydown",A=>{A.preventDefault(),A.which===87?l.panBy([0,-m],{easing:T}):A.which===83?l.panBy([0,m],{easing:T}):A.which===65?l.easeTo({bearing:l.getBearing()-w,easing:T}):A.which===68&&l.easeTo({bearing:l.getBearing()+w,easing:T})},!0)}),l.on("error",A=>{console.error(A)}),l.on("click",async function(A){let y=await idbKeyval.get("dirHandle");if(await fileUtils.verifyPermission(y,!0)===!1){console.error(`User did not grant permission to '${y.name}'`);return}let B=A.lngLat.lng,D=A.lngLat.lat,O=mapUtils.getTileInfo(B,D,l);idbKeyval.set("tile_info",O),l.getSource("bounding_box_source").setData(O.polygon_bb),l.setPaintProperty("bounding_box","fill-opacity",.45);let j=await idbKeyval.get("mapbox_api_url")+`/mapbox.terrain-rgb/${O.z}/${O.x}/${O.y}@2x.pngraw?access_token=`+h.access_token,G=await fileUtils.getMapboxTerrainRgb(y,O,j),H=G.toBuffer();await idbKeyval.set("rgb_image_buffer",H),await fileUtils.writeFileToDisk(y,O.rgbFileName,H);let te=fileUtils.createHeightMapImage(G,32,"GREY");if(await fileUtils.fileExists(y,O.thirtytwoFile.name)===!1){let Q=await te.image.toBuffer();await fileUtils.writeFileToDisk(y,O.thirtytwoFile.name,Q)}emitter.emit("updatePreviewImage",{dir_handle:y,tile_info:O,preview_image_info:te,map:l})}),l.on("mousemove",A=>{l.getCanvas().style.cursor="pointer";const y=l.queryRenderedFeatures(A.point);for(const B of y)if(Object.keys(B.type).length>0&&Object.keys(B.properties).length>0){let D=B.properties;B.layer,D.DEPTH}})},resizeMap(){this.map.resize()},change3D(){},async geoCodeReverse(h){await lib.reverseGeocode({query:[h.lng,h.lat]}).send().then(function(l){l&&l.body&&l.body.features&&(h.address=l.body.features[0].place_name)})}}},_hoisted_1$4={id:"map"},_hoisted_2$4={class:"row no-wrap q-pa-md"},_hoisted_3$3={class:"column"},_hoisted_4$3=createBaseVNode("u",null,[createBaseVNode("b",null,"Enable Layers")],-1);function _sfc_render$3(h,l,p,m,w,T){const A=resolveComponent("q-option-group"),y=resolveComponent("q-menu"),B=resolveComponent("q-btn"),D=resolveComponent("q-toolbar");return openBlock(),createElementBlock("div",_hoisted_1$4,[createVNode(D,{id:"mb-tbar",class:"bg-primary text-white q-pa-none q-ma-none"},{default:withCtx(()=>[createVNode(B,{color:"info",label:"Map Settings"},{default:withCtx(()=>[createVNode(y,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_2$4,[createBaseVNode("div",_hoisted_3$3,[_hoisted_4$3,createVNode(A,{dense:"",color:"green","checked-icon":"check","unchecked-icon":"clear",options:m.layer_type,type:"toggle",modelValue:m.layers,"onUpdate:modelValue":[l[0]||(l[0]=O=>m.layers=O),T.changeLayers]},null,8,["options","modelValue","onUpdate:modelValue"])])])]),_:1})]),_:1})]),_:1})])}var MapboxMapViewer=_export_sfc(_sfc_main$4,[["render",_sfc_render$3]]);let vips;const _sfc_main$3={name:"SideNav",setup(){return{alert:ref(!1),unrealLandscape:ref({label:505,value:505}),landscapeSize:[{label:"8129x8129",value:8129},{label:"4033x4033",value:4033},{label:"2017x2017",value:2017},{label:"1009x1009",value:1009},{label:"512x512-Downloaded-Size",value:512},{label:"505x505",value:505}],url:ref("thirtytwo-9-82-180.png"),tile_info:ref(""),dirHandle:ref(""),preview_image_info:ref(""),rgb_image:ref(""),minmax:ref(""),elevation_range:ref(""),tileWidthInMeters:ref(""),metersPerPixel:ref(""),zscale:ref(""),map:null,data:null,levelImg:ref(!1)}},async mounted(){vips=await Vips(),emitter.on("updatePreviewImage",h=>{this.data=h,this.updatePreviewImage()})},methods:{updateStats(){this.maxElevation!==""?(this.minmax=this.preview_image_info.minElevation.toFixed(3)+" / "+this.preview_image_info.maxElevation.toFixed(3),this.elevation_range=(this.preview_image_info.maxElevation-this.preview_image_info.minElevation).toFixed(3),this.tileWidthInMeters=this.tile_info.tileWidthInMeters.toFixed(3),this.metersPerPixel=this.tile_info.metersPerPixel.toFixed(3),this.zscale=this.getUnrealZScale(this.preview_image_info.maxElevation).toFixed(3)):this.minmax=""},getUnrealZScale(h){return h*100*.001953125},async updatePreviewImage(){this.preview_image_info=await this.data.preview_image_info,this.tile_info=this.data.tile_info,this.map=this.data.map;let h=await this.preview_image_info.image.toBlob();const l=URL.createObjectURL(h);this.url=l,this.updateStats()},async createSixteenHeightMap(){if(this.tile_info){let h=await idbKeyval.get("dirHandle");if(fileUtils.verifyPermission(h,!0)===!1){console.error(`User did not grant permission to '${h.name}'`);return}if(fileUtils.fileExists(h,this.tile_info.thirtytwoFile)){let p=await idbKeyval.get("rgb_image_buffer"),m=await fileUtils.loadImageFromArray(p),T=fileUtils.createHeightMapImage(m,16,"GREY").image;this.tile_info.resolution=this.unrealLandscape.value,this.levelImg===!0&&(T=T.level());let A,y=await T.toBuffer();if(this.unrealLandscape.value!==512){let N=vips.Image.newFromBuffer(y);N=N.resize(this.unrealLandscape.value/N.width,{kernel:"lanczos3"});const j=N.writeToBuffer(".PNG");A=new Uint8Array(j)}else A=y;await fileUtils.writeFileToDisk(h,this.tile_info.sixteenFile.name+"-"+this.tile_info.resolution+".png",A);let B=mapUtils.getFeaturesFromBB(this.map,this.tile_info.polygon_bb),D=JSON.stringify(B),O=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(h,"geojson-"+this.tile_info.mapbox_tile_name+"-"+this.tile_info.resolution+".json",D),await fileUtils.writeFileToDisk(h,"tile_info-"+this.tile_info.mapbox_tile_name+"-"+this.tile_info.resolution+".json",O)}else this.alert=!0}else this.alert=!0}}},_hoisted_1$3=createBaseVNode("div",{id:"previewTitle",class:"text-h6 bg-primary text-white"},"Preview Image",-1),_hoisted_2$3={class:"row justify-start q-pt-none"},_hoisted_3$2={style:{width:"100%"}},_hoisted_4$2={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_5$1={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_6$1={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_7$1={class:"row justify-center q-pt-lg"},_hoisted_8$1=createBaseVNode("div",{class:"text-h6"},"Alert",-1),_hoisted_9=createTextVNode(" Please select a tile to download first. ");function _sfc_render$2(h,l,p,m,w,T){const A=resolveComponent("q-img"),y=resolveComponent("q-field"),B=resolveComponent("q-toggle"),D=resolveComponent("q-select"),O=resolveComponent("q-btn"),N=resolveComponent("q-card-section"),j=resolveComponent("q-card-actions"),G=resolveComponent("q-card"),H=resolveComponent("q-dialog"),te=resolveDirective("close-popup");return openBlock(),createElementBlock(Fragment,null,[_hoisted_1$3,createVNode(A,{src:m.url,height:"240px"},null,8,["src"]),createBaseVNode("div",_hoisted_2$3,[createBaseVNode("div",_hoisted_3$2,[createVNode(y,{dense:"",class:"text-weight-bolder q-pt-xs",label:"Min/Max Elevation","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_4$2,toDisplayString(m.minmax),1)]),_:1}),createVNode(y,{dense:"",label:"Tile width in meters","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_5$1,toDisplayString(m.tileWidthInMeters),1)]),_:1}),createVNode(y,{dense:"",label:"Unreal Z-Scale",hint:"Input into Unreal Landscape Z scale","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_6$1,toDisplayString(m.zscale),1)]),_:1}),createVNode(B,{dense:"",modelValue:m.levelImg,"onUpdate:modelValue":l[0]||(l[0]=oe=>m.levelImg=oe),color:"green",label:"Normalize Image - Better for flat landscapes - need to reduce Z scale"},null,8,["modelValue"]),createVNode(D,{dense:"",class:"q-pt-md",label:"Landscape Size","transition-show":"scale","transition-hide":"scale",hint:"Unreal Recommended Sizes",outlined:"",modelValue:m.unrealLandscape,"onUpdate:modelValue":l[1]||(l[1]=oe=>m.unrealLandscape=oe),options:m.landscapeSize},null,8,["modelValue","options"])])]),createBaseVNode("div",_hoisted_7$1,[createVNode(O,{onClick:T.createSixteenHeightMap,dense:"",color:"primary","no-caps":"",label:"Download 16bit HeightMap"},null,8,["onClick"])]),createVNode(H,{modelValue:m.alert,"onUpdate:modelValue":l[2]||(l[2]=oe=>m.alert=oe)},{default:withCtx(()=>[createVNode(G,null,{default:withCtx(()=>[createVNode(N,null,{default:withCtx(()=>[_hoisted_8$1]),_:1}),createVNode(N,{class:"q-pt-none"},{default:withCtx(()=>[_hoisted_9]),_:1}),createVNode(j,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(O,{flat:"",label:"OK",color:"primary"},null,512),[[te]])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}var SideNav=_export_sfc(_sfc_main$3,[["render",_sfc_render$2]]);const _sfc_main$2={props:{},emits:["ok","hide"],methods:{show(){this.$refs.dialog.show()},hide(){this.$refs.dialog.hide()},onDialogHide(){this.$emit("hide")},onOKClick(){this.$emit("ok"),this.hide()},onCancelClick(){this.hide()}}},_hoisted_1$2=createBaseVNode("div",null,[createBaseVNode("div",{class:"text-weight-bold"},"Help Section")],-1),_hoisted_2$2=createBaseVNode("div",{class:""},"TODO:",-1);function _sfc_render$1(h,l,p,m,w,T){const A=resolveComponent("q-space"),y=resolveComponent("q-btn"),B=resolveComponent("q-card-section"),D=resolveComponent("q-separator"),O=resolveComponent("q-card-actions"),N=resolveComponent("q-card"),j=resolveComponent("q-dialog"),G=resolveDirective("close-popup");return openBlock(),createBlock(j,{class:"dialog-plugin",ref:"dialog",onHide:T.onDialogHide},{default:withCtx(()=>[createVNode(N,{style:{width:"600px",height:"600px"}},{default:withCtx(()=>[createVNode(B,{class:"row items-center no-wrap",style:{height:"50px"}},{default:withCtx(()=>[_hoisted_1$2,createVNode(A),withDirectives(createVNode(y,{flat:"",round:"",icon:"close"},null,512),[[G]])]),_:1}),createVNode(D),_hoisted_2$2,createVNode(O,{class:"absolute-bottom",align:"right"},{default:withCtx(()=>[createVNode(y,{color:"primary",label:"OK",onClick:T.onOKClick},null,8,["onClick"]),createVNode(y,{color:"primary",label:"Cancel",onClick:T.onCancelClick},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["onHide"])}var Help=_export_sfc(_sfc_main$2,[["render",_sfc_render$1]]);try{self["workbox:window:6.4.1"]&&_()}catch(h){}function n(h,l){return new Promise(function(p){var m=new MessageChannel;m.port1.onmessage=function(w){p(w.data)},h.postMessage(l,[m.port2])})}function t(h,l){for(var p=0;p<l.length;p++){var m=l[p];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(h,m.key,m)}}function r(h,l){(l==null||l>h.length)&&(l=h.length);for(var p=0,m=new Array(l);p<l;p++)m[p]=h[p];return m}function e(h,l){var p;if(typeof Symbol=="undefined"||h[Symbol.iterator]==null){if(Array.isArray(h)||(p=function(w,T){if(w){if(typeof w=="string")return r(w,T);var A=Object.prototype.toString.call(w).slice(8,-1);return A==="Object"&&w.constructor&&(A=w.constructor.name),A==="Map"||A==="Set"?Array.from(w):A==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(A)?r(w,T):void 0}}(h))||l&&h&&typeof h.length=="number"){p&&(h=p);var m=0;return function(){return m>=h.length?{done:!0}:{done:!1,value:h[m++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}return(p=h[Symbol.iterator]()).next.bind(p)}try{self["workbox:core:6.4.1"]&&_()}catch(h){}var i=function(){var h=this;this.promise=new Promise(function(l,p){h.resolve=l,h.reject=p})};function o(h,l){var p=location.href;return new URL(h,p).href===new URL(l,p).href}var u=function(h,l){this.type=h,Object.assign(this,l)};function a(h,l,p){return p?l?l(h):h:(h&&h.then||(h=Promise.resolve(h)),l?h.then(l):h)}function c(){}var f={type:"SKIP_WAITING"};function s(h,l){if(!l)return h&&h.then?h.then(c):Promise.resolve()}var v=function(h){var l,p;function m(y,B){var D,O;return B===void 0&&(B={}),(D=h.call(this)||this).nn={},D.tn=0,D.rn=new i,D.en=new i,D.on=new i,D.un=0,D.an=new Set,D.cn=function(){var N=D.fn,j=N.installing;D.tn>0||!o(j.scriptURL,D.sn.toString())||performance.now()>D.un+6e4?(D.vn=j,N.removeEventListener("updatefound",D.cn)):(D.hn=j,D.an.add(j),D.rn.resolve(j)),++D.tn,j.addEventListener("statechange",D.ln)},D.ln=function(N){var j=D.fn,G=N.target,H=G.state,te=G===D.vn,oe={sw:G,isExternal:te,originalEvent:N};!te&&D.mn&&(oe.isUpdate=!0),D.dispatchEvent(new u(H,oe)),H==="installed"?D.wn=self.setTimeout(function(){H==="installed"&&j.waiting===G&&D.dispatchEvent(new u("waiting",oe))},200):H==="activating"&&(clearTimeout(D.wn),te||D.en.resolve(G))},D.dn=function(N){var j=D.hn,G=j!==navigator.serviceWorker.controller;D.dispatchEvent(new u("controlling",{isExternal:G,originalEvent:N,sw:j,isUpdate:D.mn})),G||D.on.resolve(j)},D.gn=(O=function(N){var j=N.data,G=N.ports,H=N.source;return a(D.getSW(),function(){D.an.has(H)&&D.dispatchEvent(new u("message",{data:j,originalEvent:N,ports:G,sw:H}))})},function(){for(var N=[],j=0;j<arguments.length;j++)N[j]=arguments[j];try{return Promise.resolve(O.apply(this,N))}catch(G){return Promise.reject(G)}}),D.sn=y,D.nn=B,navigator.serviceWorker.addEventListener("message",D.gn),D}p=h,(l=m).prototype=Object.create(p.prototype),l.prototype.constructor=l,l.__proto__=p;var w,T,A=m.prototype;return A.register=function(y){var B=(y===void 0?{}:y).immediate,D=B!==void 0&&B;try{var O=this;return function(N,j){var G=N();return G&&G.then?G.then(j):j(G)}(function(){if(!D&&document.readyState!=="complete")return s(new Promise(function(N){return window.addEventListener("load",N)}))},function(){return O.mn=Boolean(navigator.serviceWorker.controller),O.yn=O.pn(),a(O.bn(),function(N){O.fn=N,O.yn&&(O.hn=O.yn,O.en.resolve(O.yn),O.on.resolve(O.yn),O.yn.addEventListener("statechange",O.ln,{once:!0}));var j=O.fn.waiting;return j&&o(j.scriptURL,O.sn.toString())&&(O.hn=j,Promise.resolve().then(function(){O.dispatchEvent(new u("waiting",{sw:j,wasWaitingBeforeRegister:!0}))}).then(function(){})),O.hn&&(O.rn.resolve(O.hn),O.an.add(O.hn)),O.fn.addEventListener("updatefound",O.cn),navigator.serviceWorker.addEventListener("controllerchange",O.dn),O.fn})})}catch(N){return Promise.reject(N)}},A.update=function(){try{return this.fn?s(this.fn.update()):void 0}catch(y){return Promise.reject(y)}},A.getSW=function(){return this.hn!==void 0?Promise.resolve(this.hn):this.rn.promise},A.messageSW=function(y){try{return a(this.getSW(),function(B){return n(B,y)})}catch(B){return Promise.reject(B)}},A.messageSkipWaiting=function(){this.fn&&this.fn.waiting&&n(this.fn.waiting,f)},A.pn=function(){var y=navigator.serviceWorker.controller;return y&&o(y.scriptURL,this.sn.toString())?y:void 0},A.bn=function(){try{var y=this;return function(B,D){try{var O=B()}catch(N){return D(N)}return O&&O.then?O.then(void 0,D):O}(function(){return a(navigator.serviceWorker.register(y.sn,y.nn),function(B){return y.un=performance.now(),B})},function(B){throw B})}catch(B){return Promise.reject(B)}},w=m,(T=[{key:"active",get:function(){return this.en.promise}},{key:"controlling",get:function(){return this.on.promise}}])&&t(w.prototype,T),m}(function(){function h(){this.Pn=new Map}var l=h.prototype;return l.addEventListener=function(p,m){this.Sn(p).add(m)},l.removeEventListener=function(p,m){this.Sn(p).delete(m)},l.dispatchEvent=function(p){p.target=this;for(var m,w=e(this.Sn(p.type));!(m=w()).done;)(0,m.value)(p)},l.Sn=function(p){return this.Pn.has(p)||this.Pn.set(p,new Set),this.Pn.get(p)},h}());function registerSW(h={}){const{immediate:l=!1,onNeedRefresh:p,onOfflineReady:m,onRegistered:w,onRegisterError:T}=h;let A;const y=async(B=!0)=>{};return"serviceWorker"in navigator&&(A=new v("/sw.js",{scope:"/"}),A.addEventListener("activated",B=>{B.isUpdate?window.location.reload():m==null||m()}),A.register({immediate:l}).then(B=>{w==null||w(B)}).catch(B=>{T==null||T(B)})),y}function useRegisterSW(h={}){const{immediate:l=!0,onNeedRefresh:p,onOfflineReady:m,onRegistered:w,onRegisterError:T}=h,A=ref(!1),y=ref(!1);return{updateServiceWorker:registerSW({immediate:l,onNeedRefresh(){A.value=!0,p==null||p()},onOfflineReady(){y.value=!0,m==null||m()},onRegistered:w,onRegisterError:T}),offlineReady:y,needRefresh:A}}var ReloadPrompt_vue_vue_type_style_index_0_lang="";const _hoisted_1$1={key:0,class:"pwa-toast",role:"alert"},_hoisted_2$1={class:"message"},_hoisted_3$1={key:0},_hoisted_4$1={key:1},_sfc_main$1=defineComponent({setup(h){const{offlineReady:l,needRefresh:p,updateServiceWorker:m}=useRegisterSW({onRegistered(T){console.log(`SW Registered: ${T}`)}}),w=async()=>{l.value=!1,p.value=!1};return(T,A)=>unref(l)||unref(p)?(openBlock(),createElementBlock("div",_hoisted_1$1,[createBaseVNode("div",_hoisted_2$1,[unref(l)?(openBlock(),createElementBlock("span",_hoisted_3$1," App ready to work offline ")):(openBlock(),createElementBlock("span",_hoisted_4$1," New content available, click on reload button to update. "))]),unref(p)?(openBlock(),createElementBlock("button",{key:0,onClick:A[0]||(A[0]=y=>unref(m)())}," Reload ")):createCommentVNode("",!0),createBaseVNode("button",{onClick:w}," Close ")])):createCommentVNode("",!0)}}),_sfc_main={setup(){const h=useQuasar();return{showDialog(){h.dialog({component:Help,componentProps:{text:"something"}}).onOk(()=>{}).onCancel(()=>{}).onDismiss(()=>{})},data_path:"",selectedTab:ref("map"),dirHandle:ref(""),dirName:ref(""),style_url:ref(""),access_token:ref(""),showPwaBtn:!0,isPwd:ref(!0),drawerLeft:ref(!1),createFolder:ref(!1)}},mounted:async function(){await idbKeyval.get("pwa-installed")&&(this.showPwaBtn=!1),idbKeyval.set("mapbox_api_url","https://api.mapbox.com/v4"),idbKeyval.set("mapbox_raster_png_dem","mapbox://mapbox.mapbox-terrain-dem-v1"),await this.loadUserData(),this.isRequiredSettings()===!0&&await this.loadMap(),window.addEventListener("appinstalled",this.pwaInstalled)},methods:{pwaInstalled(){idbKeyval.set("pwa-installed",!0),this.showPwaBtn=!1},async installPWA(){console.log(window.installEvent),window.installEvent.prompt(),window.installEvent=null},resizeMap(){this.$refs.mapBoxViewer.resizeMap()},changeDrawer(){this.drawerLeft=!this.drawerLeft},async loadMap(){this.selectedTab="map",await this.$nextTick(()=>{this.$refs.mapBoxViewer.loadMapboxMap()})},isRequiredSettings(){return this.access_token&&this.style_url&&this.dirName?!0:(this.redirectToSettings(),!1)},redirectToSettings(){this.selectedTab="settings",Notify.create({color:"negative",textColor:"white",icon:"report_problem",message:"Please fill out the required fields!",position:"top"})},async openDirectory(){let h;try{h=await fileUtils.getDirHandle()}catch(l){if(l.name==="AbortError")return;console.error("An error occured trying to open the file.",l)}!h||(idbKeyval.set("dirHandle",h),this.dirName=h.name)},saveUserSettings(){idbKeyval.set("access_token",this.access_token),idbKeyval.set("style_url",this.style_url),idbKeyval.set("create_folder",this.createFolder),this.isRequiredSettings()===!0&&this.loadMap()},async loadUserData(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken||"",this.style_url=await idbKeyval.get("style_url")||"",this.style_url===""&&(this.style_url="mapbox://styles/mapbox/streets-v11");let h=await idbKeyval.get("dirHandle")||"";this.createFolder=await idbKeyval.get("create_folder")||"",this.dirHandle=h,this.dirName=h.name}},components:{MapboxMapViewer,SideNav,Help,ReloadPrompt:_sfc_main$1}},_hoisted_1={class:"row q-pa-xs full-height"},_hoisted_2=createTextVNode(" See: "),_hoisted_3=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/access-token/",target:"_blank"},"Mapbox access token docs",-1),_hoisted_4=createTextVNode(" See: "),_hoisted_5=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/style-url/",target:"_blank"},"Mapbox style url docs",-1),_hoisted_6={class:"q-pa-none row items-start"},_hoisted_7={class:"col q-pa-none"},_hoisted_8=createBaseVNode("br",null,null,-1);function _sfc_render(h,l,p,m,w,T){const A=resolveComponent("q-header"),y=resolveComponent("ReloadPrompt"),B=resolveComponent("side-nav"),D=resolveComponent("q-card"),O=resolveComponent("q-drawer"),N=resolveComponent("q-btn"),j=resolveComponent("q-tab"),G=resolveComponent("q-tabs"),H=resolveComponent("q-separator"),te=resolveComponent("mapbox-map-viewer"),oe=resolveComponent("q-tab-panel"),Q=resolveComponent("q-icon"),_e=resolveComponent("q-input"),se=resolveComponent("q-tab-panels"),he=resolveComponent("q-page"),me=resolveComponent("q-page-container"),Re=resolveComponent("q-layout");return openBlock(),createBlock(Re,{view:"lHr lpr lfr"},{default:withCtx(()=>[createVNode(A,{dense:"",elevated:"",class:"bg-primary text-white","height-hint":"98"}),createVNode(y),createVNode(O,{dense:"","show-if-above":"",modelValue:m.drawerLeft,"onUpdate:modelValue":l[0]||(l[0]=ge=>m.drawerLeft=ge),side:"left",onHide:T.resizeMap,class:"no-margin no-padding"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1,[createVNode(D,{class:"col q-pl-xs"},{default:withCtx(()=>[createVNode(B)]),_:1})])]),_:1},8,["modelValue","onHide"]),createVNode(me,null,{default:withCtx(()=>[createVNode(he,{class:"row no-margin q-pa-sm"},{default:withCtx(()=>[createVNode(D,{class:"col"},{default:withCtx(()=>[createVNode(G,{dense:"",modelValue:m.selectedTab,"onUpdate:modelValue":l[3]||(l[3]=ge=>m.selectedTab=ge),class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:withCtx(()=>[createVNode(N,{dense:"",flat:"",onClick:T.changeDrawer,round:"",icon:"menu"},null,8,["onClick"]),createVNode(j,{dense:"",name:"map",label:"Map"}),createVNode(j,{dense:"",name:"settings",label:"Settings"}),withDirectives(createVNode(N,{style:{color:"white"},label:"Install as App",class:"q-mr-lg bg-positive",onClick:l[1]||(l[1]=ge=>T.installPWA())},null,512),[[vShow,m.showPwaBtn]]),createVNode(N,{style:{background:"#FF0080",color:"white"},label:"Help",class:"q-mr-lg",onClick:m.showDialog},null,8,["onClick"]),createVNode(N,{dense:"",flat:"",round:"",onClick:l[2]||(l[2]=ge=>h.$q.dark.toggle()),icon:h.$q.dark.isActive?"nights_stay":"wb_sunny"},null,8,["icon"])]),_:1},8,["modelValue"]),createVNode(H),createVNode(se,{class:"q-pa-none q-ma-none","keep-alive":"",modelValue:m.selectedTab,"onUpdate:modelValue":l[10]||(l[10]=ge=>m.selectedTab=ge),animated:""},{default:withCtx(()=>[createVNode(oe,{name:"map",class:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",style:{width:"100%",height:"calc(100vh - 65px)"}},{default:withCtx(()=>[createVNode(te,{class:"col",ref:"mapBoxViewer"},null,512)]),_:1}),createVNode(oe,{lass:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",name:"settings"},{default:withCtx(()=>[_hoisted_2,_hoisted_3,createVNode(_e,{dense:"",modelValue:m.access_token,"onUpdate:modelValue":l[5]||(l[5]=ge=>m.access_token=ge),label:"Mapbox Access Token *",filled:"",type:m.isPwd?"password":"text","lazy-rules":"",hint:"You will need your own access token created from your Mapbox accounts page. The Mapbox free plan is a great choice.",rules:[ge=>ge&&ge.length>0||"Please type something"]},{append:withCtx(()=>[createVNode(Q,{dense:"",name:m.isPwd?"visibility_off":"visibility",class:"cursor-pointer",onClick:l[4]||(l[4]=ge=>m.isPwd=!m.isPwd)},null,8,["name"])]),_:1},8,["modelValue","type","rules"]),_hoisted_4,_hoisted_5,createVNode(_e,{dense:"",class:"q-pb-lg",modelValue:m.style_url,"onUpdate:modelValue":l[6]||(l[6]=ge=>m.style_url=ge),label:"Enter your Mapbox style url *",filled:"","lazy-rules":"",hint:"You can use the default style or you can create your own custom style in Mapbox Studio.",rules:[ge=>ge&&ge.length>0||"Please type something"],type:m.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createBaseVNode("div",_hoisted_6,[createBaseVNode("div",_hoisted_7,[createVNode(_e,{dense:"",class:"q-pb-none",modelValue:m.dirName,"onUpdate:modelValue":l[7]||(l[7]=ge=>m.dirName=ge),label:"Enter download directory path *",filled:"","lazy-rules":"",rules:[ge=>ge&&ge.length>0||"Please type something"],type:m.isPwd?"":"text"},null,8,["modelValue","rules","type"])]),createVNode(N,{class:"q-pb-none",dense:"",onClick:l[8]||(l[8]=ge=>T.openDirectory()),color:"secondary",label:"Select download folder"})]),_hoisted_8,createVNode(N,{class:"q-pt-none",dense:"",onClick:l[9]||(l[9]=ge=>T.saveUserSettings()),color:"secondary",label:"Save settings"})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})}var MainLayout=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{MainLayout as default};
