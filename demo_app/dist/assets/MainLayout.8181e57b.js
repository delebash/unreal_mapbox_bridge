var t0=Object.defineProperty;var Bf=Object.getOwnPropertySymbols;var i0=Object.prototype.hasOwnProperty,r0=Object.prototype.propertyIsEnumerable;var Lf=(d,h,p)=>h in d?t0(d,h,{enumerable:!0,configurable:!0,writable:!0,value:p}):d[h]=p,Mu=(d,h)=>{for(var p in h||(h={}))i0.call(h,p)&&Lf(d,p,h[p]);if(Bf)for(var p of Bf(h))r0.call(h,p)&&Lf(d,p,h[p]);return d};import{g as commonjsGlobal,h as getAugmentedNamespace,i as commonjsRequire,j as ref,r as resolveComponent,o as openBlock,k as createElementBlock,l as createVNode,w as withCtx,m as createBaseVNode,u as useQuasar,n as resolveDirective,t as toDisplayString,p as withDirectives,F as Fragment,q as createTextVNode,c as createBlock,d as defineComponent,s as unref,v as createCommentVNode,N as Notify,x as vShow}from"./vendor.94d20208.js";import{_ as _export_sfc}from"./index.826443e9.js";class Store{constructor(h="unreal-mapbox",p="keyval"){this.storeName=p,this._dbp=new Promise((m,w)=>{const T=indexedDB.open(h,3);T.onerror=()=>w(T.error),T.onsuccess=()=>m(T.result),T.onupgradeneeded=()=>{T.result.deleteObjectStore(p),T.result.createObjectStore(p)}})}_withIDBStore(h,p){return this._dbp.then(m=>new Promise((w,T)=>{const k=m.transaction(this.storeName,h);k.oncomplete=()=>w(),k.onabort=k.onerror=()=>T(k.error),p(k.objectStore(this.storeName))}))}}let store;function getDefaultStore(){return store||(store=new Store),store}function get(d,h=getDefaultStore()){let p;return h._withIDBStore("readonly",m=>{p=m.get(d)}).then(()=>p.result)}function set(d,h,p=getDefaultStore()){return p._withIDBStore("readwrite",m=>{m.put(h,d)})}function del(d,h=getDefaultStore()){return h._withIDBStore("readwrite",p=>{p.delete(d)})}function clear(d=getDefaultStore()){return d._withIDBStore("readwrite",h=>{h.clear()})}function keys(d=getDefaultStore()){const h=[];return d._withIDBStore("readonly",p=>{(p.openKeyCursor||p.openCursor).call(p).onsuccess=function(){!this.result||(h.push(this.result.key),this.result.continue())}}).then(()=>h)}var idbKeyval={keys,clear,del,set,get};const bitMethods={getBit(d){return this.data[getSlot(d)]&1<<getShift(d)?1:0},setBit(d){this.data[getSlot(d)]|=1<<getShift(d)},clearBit(d){this.data[getSlot(d)]&=~(1<<getShift(d))},toggleBit(d){this.data[getSlot(d)]^=1<<getShift(d)},getBitXY(d,h){return d>=this.width||h>=this.height?0:this.getBit(h*this.width+d)},setBitXY(d,h){this.setBit(h*this.width+d)},clearBitXY(d,h){this.clearBit(h*this.width+d)},toggleBitXY(d,h){this.toggleBit(h*this.width+d)}};function getSlot(d){return d>>3}function getShift(d){return 7-(d&7)}function setBitMethods(d){for(const h in bitMethods)d.prototype[h]=bitMethods[h]}function checkProcessable(d,h={}){let{bitDepth:p,alpha:m,colorModel:w,components:T,channels:k}=h;if(typeof d!="string"||d.length===0)throw new TypeError("processName must be a string");if(p&&(Array.isArray(p)||(p=[p]),!p.includes(this.bitDepth)))throw new TypeError(`The process: ${d} can only be applied if bit depth is in: ${p}`);if(m&&(Array.isArray(m)||(m=[m]),!m.includes(this.alpha)))throw new TypeError(`The process: ${d} can only be applied if alpha is in: ${m}`);if(w&&(Array.isArray(w)||(w=[w]),!w.includes(this.colorModel)))throw new TypeError(`The process: ${d} can only be applied if color model is in: ${w}`);if(T&&(Array.isArray(T)||(T=[T]),!T.includes(this.components))){let x=`The process: ${d} can only be applied if the number of components is in: ${T}`;throw T.length===1&&T[0]===1?new TypeError(`${x}.\rYou should transform your image using "image.grey()" before applying the algorithm.`):new TypeError(x)}if(k&&(Array.isArray(k)||(k=[k]),!k.includes(this.channels)))throw new TypeError(`The process: ${d} can only be applied if the number of channels is in: ${k}`)}function createBlob(d,h){d=d||[],h=h||{},typeof h=="string"&&(h={type:h});try{return new Blob(d,h)}catch(T){if(T.name!=="TypeError")throw T;for(var p=typeof BlobBuilder!="undefined"?BlobBuilder:typeof MSBlobBuilder!="undefined"?MSBlobBuilder:typeof MozBlobBuilder!="undefined"?MozBlobBuilder:WebKitBlobBuilder,m=new p,w=0;w<d.length;w+=1)m.append(d[w]);return m.getBlob(h.type)}}function dataURLToBlob(d){var h=d.match(/data:([^;]+)/)[1],p=d.replace(/^[^,]+,/,""),m=binaryStringToArrayBuffer(atob(p));return createBlob([m],{type:h})}function canvasToBlob(d,h,p){return typeof d.toBlob=="function"?new Promise(function(m){d.toBlob(m,h,p)}):Promise.resolve(dataURLToBlob(d.toDataURL(h,p)))}function binaryStringToArrayBuffer(d){for(var h=d.length,p=new ArrayBuffer(h),m=new Uint8Array(p),w=-1;++w<h;)m[w]=d.charCodeAt(w);return p}var utf8$1={exports:{}};/*! https://mths.be/utf8js v2.1.2 by @mathias */(function(d,h){(function(p){var m=h,w=d&&d.exports==m&&d,T=typeof commonjsGlobal=="object"&&commonjsGlobal;(T.global===T||T.window===T)&&(p=T);var k=String.fromCharCode;function x(xe){for(var ue=[],Me=0,he=xe.length,ge,Le;Me<he;)ge=xe.charCodeAt(Me++),ge>=55296&&ge<=56319&&Me<he?(Le=xe.charCodeAt(Me++),(Le&64512)==56320?ue.push(((ge&1023)<<10)+(Le&1023)+65536):(ue.push(ge),Me--)):ue.push(ge);return ue}function B(xe){for(var ue=xe.length,Me=-1,he,ge="";++Me<ue;)he=xe[Me],he>65535&&(he-=65536,ge+=k(he>>>10&1023|55296),he=56320|he&1023),ge+=k(he);return ge}function P(xe){if(xe>=55296&&xe<=57343)throw Error("Lone surrogate U+"+xe.toString(16).toUpperCase()+" is not a scalar value")}function O(xe,ue){return k(xe>>ue&63|128)}function U(xe){if((xe&4294967168)==0)return k(xe);var ue="";return(xe&4294965248)==0?ue=k(xe>>6&31|192):(xe&4294901760)==0?(P(xe),ue=k(xe>>12&15|224),ue+=O(xe,6)):(xe&4292870144)==0&&(ue=k(xe>>18&7|240),ue+=O(xe,12),ue+=O(xe,6)),ue+=k(xe&63|128),ue}function G(xe){for(var ue=x(xe),Me=ue.length,he=-1,ge,Le="";++he<Me;)ge=ue[he],Le+=U(ge);return Le}function j(){if(Q>=oe)throw Error("Invalid byte index");var xe=te[Q]&255;if(Q++,(xe&192)==128)return xe&63;throw Error("Invalid continuation byte")}function H(){var xe,ue,Me,he,ge;if(Q>oe)throw Error("Invalid byte index");if(Q==oe)return!1;if(xe=te[Q]&255,Q++,(xe&128)==0)return xe;if((xe&224)==192){if(ue=j(),ge=(xe&31)<<6|ue,ge>=128)return ge;throw Error("Invalid continuation byte")}if((xe&240)==224){if(ue=j(),Me=j(),ge=(xe&15)<<12|ue<<6|Me,ge>=2048)return P(ge),ge;throw Error("Invalid continuation byte")}if((xe&248)==240&&(ue=j(),Me=j(),he=j(),ge=(xe&7)<<18|ue<<12|Me<<6|he,ge>=65536&&ge<=1114111))return ge;throw Error("Invalid UTF-8 detected")}var te,oe,Q;function _e(xe){te=x(xe),oe=te.length,Q=0;for(var ue=[],Me;(Me=H())!==!1;)ue.push(Me);return B(ue)}var se={version:"2.1.2",encode:G,decode:_e};if(m&&!m.nodeType)if(w)w.exports=se;else{var le={},me=le.hasOwnProperty;for(var Re in se)me.call(se,Re)&&(m[Re]=se[Re])}else p.utf8=se})(commonjsGlobal)})(utf8$1,utf8$1.exports);const utf8=utf8$1.exports,defaultByteLength$3=1024*8,charArray$1=[];class IOBuffer$6{constructor(h,p){p=p||{};var m=!1;h===void 0&&(h=defaultByteLength$3),typeof h=="number"?h=new ArrayBuffer(h):(m=!0,this._lastWrittenByte=h.byteLength);const w=p.offset?p.offset>>>0:0;let T=h.byteLength-w,k=w;h.buffer&&(h.byteLength!==h.buffer.byteLength&&(k=h.byteOffset+w),h=h.buffer),m?this._lastWrittenByte=T:this._lastWrittenByte=0,this.buffer=h,this.length=T,this.byteLength=T,this.byteOffset=k,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,k,T),this._mark=0,this._marks=[]}available(h){return h===void 0&&(h=1),this.offset+h<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(h){return h===void 0&&(h=1),this.offset+=h,this}seek(h){return this.offset=h,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const h=this._marks.pop();if(h===void 0)throw new Error("Mark stack empty");return this.seek(h),this}rewind(){return this.offset=0,this}ensureAvailable(h){if(h===void 0&&(h=1),!this.available(h)){const m=(this.offset+h)*2,w=new Uint8Array(m);w.set(new Uint8Array(this.buffer)),this.buffer=w.buffer,this.length=this.byteLength=m,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(h){h===void 0&&(h=1);for(var p=new Uint8Array(h),m=0;m<h;m++)p[m]=this.readByte();return p}readInt16(){var h=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,h}readUint16(){var h=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,h}readInt32(){var h=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,h}readUint32(){var h=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,h}readFloat32(){var h=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,h}readFloat64(){var h=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,h}readChar(){return String.fromCharCode(this.readInt8())}readChars(h){h===void 0&&(h=1),charArray$1.length=h;for(var p=0;p<h;p++)charArray$1[p]=this.readChar();return charArray$1.join("")}readUtf8(h){h===void 0&&(h=1);const p=this.readChars(h);return utf8.decode(p)}writeBoolean(h){return this.writeUint8(h?255:0),this}writeInt8(h){return this.ensureAvailable(1),this._data.setInt8(this.offset++,h),this._updateLastWrittenByte(),this}writeUint8(h){return this.ensureAvailable(1),this._data.setUint8(this.offset++,h),this._updateLastWrittenByte(),this}writeByte(h){return this.writeUint8(h)}writeBytes(h){this.ensureAvailable(h.length);for(var p=0;p<h.length;p++)this._data.setUint8(this.offset++,h[p]);return this._updateLastWrittenByte(),this}writeInt16(h){return this.ensureAvailable(2),this._data.setInt16(this.offset,h,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(h){return this.ensureAvailable(2),this._data.setUint16(this.offset,h,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(h){return this.ensureAvailable(4),this._data.setInt32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(h){return this.ensureAvailable(4),this._data.setUint32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(h){return this.ensureAvailable(4),this._data.setFloat32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(h){return this.ensureAvailable(8),this._data.setFloat64(this.offset,h,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(h){return this.writeUint8(h.charCodeAt(0))}writeChars(h){for(var p=0;p<h.length;p++)this.writeUint8(h.charCodeAt(p));return this}writeUtf8(h){const p=utf8.encode(h);return this.writeChars(p)}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}getBuffer(){return typeof Buffer!="undefined"?Buffer.from(this.toArray()):this.toArray()}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}}var IOBuffer_1$1=IOBuffer$6,constants$7={BITMAPV5HEADER:{LogicalColorSpace:{LCS_CALIBRATED_RGB:0,LCS_sRGB:1934772034,LCS_WINDOWS_COLOR_SPACE:1466527264},Compression:{BI_RGB:0,BI_RLE8:1,BI_RLE4:2,BI_BITFIELDS:3,BI_JPEG:4,BI_PNG:5,BI_CMYK:11,BI_CMYKRLE8:12,BI_CMYKRLE4:13},GamutMappingIntent:{LCS_GM_ABS_COLORIMETRIC:8,LCS_GM_BUSINESS:1,LCS_GM_GRAPHICS:2,LCS_GM_IMAGES:4}}};const IOBuffer$5=IOBuffer_1$1,constants$6=constants$7,tableLeft=[];for(var i$5=0;i$5<=8;i$5++)tableLeft.push(255<<i$5);var encode$5=function(d){if(d.bitDepth!==1)throw new Error("Only bitDepth of 1 is supported");if(!d.height||!d.width)throw new Error("ImageData width and height are required");if(d.components!==1)throw new Error("Only 1 component is supported");if(d.channels!==1)throw new Error("Only 1 channel is supported");var h=new IOBuffer$5;h.skip(14),writeBitmapV5Header(h,d),writeColorTable(h,d);const p=h.offset;return writePixelArray(h,d),h.rewind(),writeBitmapFileHeader(h,p),h.getBuffer()};function writePixelArray(d,h){const p=Math.floor((h.bitDepth*h.width+31)/32)*4,m=Math.ceil(h.bitDepth*h.width/8),w=p-m,T=h.bitDepth*h.width%8,k=T===0?0:8-T,x=p*h.height;var B,P;const O=new IOBuffer$5(h.data);let U=0,G=0,j=8;d.mark(),P=O.readUint8();for(var H=h.height-1;H>=0;H--){const oe=H===0;d.reset(),d.skip(H*p);for(var te=0;te<m;te++){const Q=te===m-1;G<=k&&Q?(d.writeByte(P<<G),(k===0||k===G)&&!oe&&(B=P,P=O.readByte())):G===0?(B=P,P=O.readUint8(),d.writeByte(B)):(B=P,P=O.readUint8(),d.writeByte(B<<G&tableLeft[G]|P>>j)),Q?(U+=T||8,d.skip(w),G=U%8,j=8-G):U+=8}}p>m&&(d.reset(),d.skip(x-1),d.writeUint8(0))}function writeColorTable(d,h){h.bitDepth>8||d.writeUint32(0).writeUint32(16777215)}function writeBitmapFileHeader(d,h){d.writeChars("BM"),d.writeInt32(d._lastWrittenByte),d.writeUint16(0),d.writeUint16(0),d.writeUint32(h)}function writeBitmapV5Header(d,h){d.writeUint32(124).writeInt32(h.width).writeInt32(h.height).writeUint16(1).writeUint16(h.bitDepth).writeUint32(constants$6.BITMAPV5HEADER.Compression.BI_RGB).writeUint32(h.width*h.height*h.bitDepth).writeInt32(0).writeInt32(0).writeUint32(Math.pow(2,h.bitDepth)).writeUint32(Math.pow(2,h.bitDepth)).writeUint32(4278190080).writeUint32(16711680).writeUint32(65280).writeUint32(255).writeUint32(constants$6.BITMAPV5HEADER.LogicalColorSpace.LCS_sRGB).skip(36).skip(12).writeUint32(constants$6.BITMAPV5HEADER.GamutMappingIntent.LCS_GM_IMAGES).skip(12)}var encode$4=encode$5;(function(d){if(d.TextEncoder&&d.TextDecoder)return!1;function h(m="utf-8"){if(m!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${m}') is invalid.`)}Object.defineProperty(h.prototype,"encoding",{value:"utf-8"}),h.prototype.encode=function(m,w={stream:!1}){if(w.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let T=0;const k=m.length;let x=0,B=Math.max(32,k+(k>>1)+7),P=new Uint8Array(B>>3<<3);for(;T<k;){let O=m.charCodeAt(T++);if(O>=55296&&O<=56319){if(T<k){const U=m.charCodeAt(T);(U&64512)===56320&&(++T,O=((O&1023)<<10)+(U&1023)+65536)}if(O>=55296&&O<=56319)continue}if(x+4>P.length){B+=8,B*=1+T/m.length*2,B=B>>3<<3;const U=new Uint8Array(B);U.set(P),P=U}if((O&4294967168)===0){P[x++]=O;continue}else if((O&4294965248)===0)P[x++]=O>>6&31|192;else if((O&4294901760)===0)P[x++]=O>>12&15|224,P[x++]=O>>6&63|128;else if((O&4292870144)===0)P[x++]=O>>18&7|240,P[x++]=O>>12&63|128,P[x++]=O>>6&63|128;else continue;P[x++]=O&63|128}return P.slice(0,x)};function p(m="utf-8",w={fatal:!1}){if(m!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${m}') is invalid.`);if(w.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(p.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(p.prototype,"fatal",{value:!1}),Object.defineProperty(p.prototype,"ignoreBOM",{value:!1}),p.prototype.decode=function(m,w={stream:!1}){if(w.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const T=new Uint8Array(m);let k=0;const x=T.length,B=[];for(;k<x;){const P=T[k++];if(P===0)break;if((P&128)===0)B.push(P);else if((P&224)===192){const O=T[k++]&63;B.push((P&31)<<6|O)}else if((P&240)===224){const O=T[k++]&63,U=T[k++]&63;B.push((P&31)<<12|O<<6|U)}else if((P&248)===240){const O=T[k++]&63,U=T[k++]&63,G=T[k++]&63;let j=(P&7)<<18|O<<12|U<<6|G;j>65535&&(j-=65536,B.push(j>>>10&1023|55296),j=56320|j&1023),B.push(j)}}return String.fromCharCode.apply(null,B)},d.TextEncoder=h,d.TextDecoder=p})(typeof window!="undefined"?window:typeof self!="undefined"?self:globalThis);const decoder$2=new TextDecoder("utf-8");function decode$6(d){return decoder$2.decode(d)}const encoder$2=new TextEncoder;function encode$3(d){return encoder$2.encode(d)}const defaultByteLength$2=1024*8;class IOBuffer$4{constructor(h=defaultByteLength$2,p={}){let m=!1;typeof h=="number"?h=new ArrayBuffer(h):(m=!0,this.lastWrittenByte=h.byteLength);const w=p.offset?p.offset>>>0:0,T=h.byteLength-w;let k=w;(ArrayBuffer.isView(h)||h instanceof IOBuffer$4)&&(h.byteLength!==h.buffer.byteLength&&(k=h.byteOffset+w),h=h.buffer),m?this.lastWrittenByte=T:this.lastWrittenByte=0,this.buffer=h,this.length=T,this.byteLength=T,this.byteOffset=k,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,k,T),this._mark=0,this._marks=[]}available(h=1){return this.offset+h<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(h=1){return this.offset+=h,this}seek(h){return this.offset=h,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const h=this._marks.pop();if(h===void 0)throw new Error("Mark stack empty");return this.seek(h),this}rewind(){return this.offset=0,this}ensureAvailable(h=1){if(!this.available(h)){const m=(this.offset+h)*2,w=new Uint8Array(m);w.set(new Uint8Array(this.buffer)),this.buffer=w.buffer,this.length=this.byteLength=m,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(h=1){const p=new Uint8Array(h);for(let m=0;m<h;m++)p[m]=this.readByte();return p}readInt16(){const h=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,h}readUint16(){const h=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,h}readInt32(){const h=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,h}readUint32(){const h=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,h}readFloat32(){const h=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,h}readFloat64(){const h=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,h}readBigInt64(){const h=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,h}readBigUint64(){const h=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,h}readChar(){return String.fromCharCode(this.readInt8())}readChars(h=1){let p="";for(let m=0;m<h;m++)p+=this.readChar();return p}readUtf8(h=1){return decode$6(this.readBytes(h))}writeBoolean(h){return this.writeUint8(h?255:0),this}writeInt8(h){return this.ensureAvailable(1),this._data.setInt8(this.offset++,h),this._updateLastWrittenByte(),this}writeUint8(h){return this.ensureAvailable(1),this._data.setUint8(this.offset++,h),this._updateLastWrittenByte(),this}writeByte(h){return this.writeUint8(h)}writeBytes(h){this.ensureAvailable(h.length);for(let p=0;p<h.length;p++)this._data.setUint8(this.offset++,h[p]);return this._updateLastWrittenByte(),this}writeInt16(h){return this.ensureAvailable(2),this._data.setInt16(this.offset,h,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(h){return this.ensureAvailable(2),this._data.setUint16(this.offset,h,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(h){return this.ensureAvailable(4),this._data.setInt32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(h){return this.ensureAvailable(4),this._data.setUint32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(h){return this.ensureAvailable(4),this._data.setFloat32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(h){return this.ensureAvailable(8),this._data.setFloat64(this.offset,h,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(h){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,h,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(h){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,h,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(h){return this.writeUint8(h.charCodeAt(0))}writeChars(h){for(let p=0;p<h.length;p++)this.writeUint8(h.charCodeAt(p));return this}writeUtf8(h){return this.writeBytes(encode$3(h))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}/*! pako 2.0.4 https://github.com/nodeca/pako @license (MIT AND Zlib) */const Z_FIXED$1=4,Z_BINARY=0,Z_TEXT=1,Z_UNKNOWN$1=2;function zero$1(d){let h=d.length;for(;--h>=0;)d[h]=0}const STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,MIN_MATCH$1=3,MAX_MATCH$1=258,LENGTH_CODES$1=29,LITERALS$1=256,L_CODES$1=LITERALS$1+1+LENGTH_CODES$1,D_CODES$1=30,BL_CODES$1=19,HEAP_SIZE$1=2*L_CODES$1+1,MAX_BITS$1=15,Buf_size=16,MAX_BL_BITS=7,END_BLOCK=256,REP_3_6=16,REPZ_3_10=17,REPZ_11_138=18,extra_lbits=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),extra_dbits=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),extra_blbits=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),bl_order=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),DIST_CODE_LEN=512,static_ltree=new Array((L_CODES$1+2)*2);zero$1(static_ltree);const static_dtree=new Array(D_CODES$1*2);zero$1(static_dtree);const _dist_code=new Array(DIST_CODE_LEN);zero$1(_dist_code);const _length_code=new Array(MAX_MATCH$1-MIN_MATCH$1+1);zero$1(_length_code);const base_length=new Array(LENGTH_CODES$1);zero$1(base_length);const base_dist=new Array(D_CODES$1);zero$1(base_dist);function StaticTreeDesc(d,h,p,m,w){this.static_tree=d,this.extra_bits=h,this.extra_base=p,this.elems=m,this.max_length=w,this.has_stree=d&&d.length}let static_l_desc,static_d_desc,static_bl_desc;function TreeDesc(d,h){this.dyn_tree=d,this.max_code=0,this.stat_desc=h}const d_code=d=>d<256?_dist_code[d]:_dist_code[256+(d>>>7)],put_short=(d,h)=>{d.pending_buf[d.pending++]=h&255,d.pending_buf[d.pending++]=h>>>8&255},send_bits=(d,h,p)=>{d.bi_valid>Buf_size-p?(d.bi_buf|=h<<d.bi_valid&65535,put_short(d,d.bi_buf),d.bi_buf=h>>Buf_size-d.bi_valid,d.bi_valid+=p-Buf_size):(d.bi_buf|=h<<d.bi_valid&65535,d.bi_valid+=p)},send_code=(d,h,p)=>{send_bits(d,p[h*2],p[h*2+1])},bi_reverse=(d,h)=>{let p=0;do p|=d&1,d>>>=1,p<<=1;while(--h>0);return p>>>1},bi_flush=d=>{d.bi_valid===16?(put_short(d,d.bi_buf),d.bi_buf=0,d.bi_valid=0):d.bi_valid>=8&&(d.pending_buf[d.pending++]=d.bi_buf&255,d.bi_buf>>=8,d.bi_valid-=8)},gen_bitlen=(d,h)=>{const p=h.dyn_tree,m=h.max_code,w=h.stat_desc.static_tree,T=h.stat_desc.has_stree,k=h.stat_desc.extra_bits,x=h.stat_desc.extra_base,B=h.stat_desc.max_length;let P,O,U,G,j,H,te=0;for(G=0;G<=MAX_BITS$1;G++)d.bl_count[G]=0;for(p[d.heap[d.heap_max]*2+1]=0,P=d.heap_max+1;P<HEAP_SIZE$1;P++)O=d.heap[P],G=p[p[O*2+1]*2+1]+1,G>B&&(G=B,te++),p[O*2+1]=G,!(O>m)&&(d.bl_count[G]++,j=0,O>=x&&(j=k[O-x]),H=p[O*2],d.opt_len+=H*(G+j),T&&(d.static_len+=H*(w[O*2+1]+j)));if(te!==0){do{for(G=B-1;d.bl_count[G]===0;)G--;d.bl_count[G]--,d.bl_count[G+1]+=2,d.bl_count[B]--,te-=2}while(te>0);for(G=B;G!==0;G--)for(O=d.bl_count[G];O!==0;)U=d.heap[--P],!(U>m)&&(p[U*2+1]!==G&&(d.opt_len+=(G-p[U*2+1])*p[U*2],p[U*2+1]=G),O--)}},gen_codes=(d,h,p)=>{const m=new Array(MAX_BITS$1+1);let w=0,T,k;for(T=1;T<=MAX_BITS$1;T++)m[T]=w=w+p[T-1]<<1;for(k=0;k<=h;k++){let x=d[k*2+1];x!==0&&(d[k*2]=bi_reverse(m[x]++,x))}},tr_static_init=()=>{let d,h,p,m,w;const T=new Array(MAX_BITS$1+1);for(p=0,m=0;m<LENGTH_CODES$1-1;m++)for(base_length[m]=p,d=0;d<1<<extra_lbits[m];d++)_length_code[p++]=m;for(_length_code[p-1]=m,w=0,m=0;m<16;m++)for(base_dist[m]=w,d=0;d<1<<extra_dbits[m];d++)_dist_code[w++]=m;for(w>>=7;m<D_CODES$1;m++)for(base_dist[m]=w<<7,d=0;d<1<<extra_dbits[m]-7;d++)_dist_code[256+w++]=m;for(h=0;h<=MAX_BITS$1;h++)T[h]=0;for(d=0;d<=143;)static_ltree[d*2+1]=8,d++,T[8]++;for(;d<=255;)static_ltree[d*2+1]=9,d++,T[9]++;for(;d<=279;)static_ltree[d*2+1]=7,d++,T[7]++;for(;d<=287;)static_ltree[d*2+1]=8,d++,T[8]++;for(gen_codes(static_ltree,L_CODES$1+1,T),d=0;d<D_CODES$1;d++)static_dtree[d*2+1]=5,static_dtree[d*2]=bi_reverse(d,5);static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS$1+1,L_CODES$1,MAX_BITS$1),static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES$1,MAX_BITS$1),static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES$1,MAX_BL_BITS)},init_block=d=>{let h;for(h=0;h<L_CODES$1;h++)d.dyn_ltree[h*2]=0;for(h=0;h<D_CODES$1;h++)d.dyn_dtree[h*2]=0;for(h=0;h<BL_CODES$1;h++)d.bl_tree[h*2]=0;d.dyn_ltree[END_BLOCK*2]=1,d.opt_len=d.static_len=0,d.last_lit=d.matches=0},bi_windup=d=>{d.bi_valid>8?put_short(d,d.bi_buf):d.bi_valid>0&&(d.pending_buf[d.pending++]=d.bi_buf),d.bi_buf=0,d.bi_valid=0},copy_block=(d,h,p,m)=>{bi_windup(d),m&&(put_short(d,p),put_short(d,~p)),d.pending_buf.set(d.window.subarray(h,h+p),d.pending),d.pending+=p},smaller=(d,h,p,m)=>{const w=h*2,T=p*2;return d[w]<d[T]||d[w]===d[T]&&m[h]<=m[p]},pqdownheap=(d,h,p)=>{const m=d.heap[p];let w=p<<1;for(;w<=d.heap_len&&(w<d.heap_len&&smaller(h,d.heap[w+1],d.heap[w],d.depth)&&w++,!smaller(h,m,d.heap[w],d.depth));)d.heap[p]=d.heap[w],p=w,w<<=1;d.heap[p]=m},compress_block=(d,h,p)=>{let m,w,T=0,k,x;if(d.last_lit!==0)do m=d.pending_buf[d.d_buf+T*2]<<8|d.pending_buf[d.d_buf+T*2+1],w=d.pending_buf[d.l_buf+T],T++,m===0?send_code(d,w,h):(k=_length_code[w],send_code(d,k+LITERALS$1+1,h),x=extra_lbits[k],x!==0&&(w-=base_length[k],send_bits(d,w,x)),m--,k=d_code(m),send_code(d,k,p),x=extra_dbits[k],x!==0&&(m-=base_dist[k],send_bits(d,m,x)));while(T<d.last_lit);send_code(d,END_BLOCK,h)},build_tree=(d,h)=>{const p=h.dyn_tree,m=h.stat_desc.static_tree,w=h.stat_desc.has_stree,T=h.stat_desc.elems;let k,x,B=-1,P;for(d.heap_len=0,d.heap_max=HEAP_SIZE$1,k=0;k<T;k++)p[k*2]!==0?(d.heap[++d.heap_len]=B=k,d.depth[k]=0):p[k*2+1]=0;for(;d.heap_len<2;)P=d.heap[++d.heap_len]=B<2?++B:0,p[P*2]=1,d.depth[P]=0,d.opt_len--,w&&(d.static_len-=m[P*2+1]);for(h.max_code=B,k=d.heap_len>>1;k>=1;k--)pqdownheap(d,p,k);P=T;do k=d.heap[1],d.heap[1]=d.heap[d.heap_len--],pqdownheap(d,p,1),x=d.heap[1],d.heap[--d.heap_max]=k,d.heap[--d.heap_max]=x,p[P*2]=p[k*2]+p[x*2],d.depth[P]=(d.depth[k]>=d.depth[x]?d.depth[k]:d.depth[x])+1,p[k*2+1]=p[x*2+1]=P,d.heap[1]=P++,pqdownheap(d,p,1);while(d.heap_len>=2);d.heap[--d.heap_max]=d.heap[1],gen_bitlen(d,h),gen_codes(p,B,d.bl_count)},scan_tree=(d,h,p)=>{let m,w=-1,T,k=h[0*2+1],x=0,B=7,P=4;for(k===0&&(B=138,P=3),h[(p+1)*2+1]=65535,m=0;m<=p;m++)T=k,k=h[(m+1)*2+1],!(++x<B&&T===k)&&(x<P?d.bl_tree[T*2]+=x:T!==0?(T!==w&&d.bl_tree[T*2]++,d.bl_tree[REP_3_6*2]++):x<=10?d.bl_tree[REPZ_3_10*2]++:d.bl_tree[REPZ_11_138*2]++,x=0,w=T,k===0?(B=138,P=3):T===k?(B=6,P=3):(B=7,P=4))},send_tree=(d,h,p)=>{let m,w=-1,T,k=h[0*2+1],x=0,B=7,P=4;for(k===0&&(B=138,P=3),m=0;m<=p;m++)if(T=k,k=h[(m+1)*2+1],!(++x<B&&T===k)){if(x<P)do send_code(d,T,d.bl_tree);while(--x!==0);else T!==0?(T!==w&&(send_code(d,T,d.bl_tree),x--),send_code(d,REP_3_6,d.bl_tree),send_bits(d,x-3,2)):x<=10?(send_code(d,REPZ_3_10,d.bl_tree),send_bits(d,x-3,3)):(send_code(d,REPZ_11_138,d.bl_tree),send_bits(d,x-11,7));x=0,w=T,k===0?(B=138,P=3):T===k?(B=6,P=3):(B=7,P=4)}},build_bl_tree=d=>{let h;for(scan_tree(d,d.dyn_ltree,d.l_desc.max_code),scan_tree(d,d.dyn_dtree,d.d_desc.max_code),build_tree(d,d.bl_desc),h=BL_CODES$1-1;h>=3&&d.bl_tree[bl_order[h]*2+1]===0;h--);return d.opt_len+=3*(h+1)+5+5+4,h},send_all_trees=(d,h,p,m)=>{let w;for(send_bits(d,h-257,5),send_bits(d,p-1,5),send_bits(d,m-4,4),w=0;w<m;w++)send_bits(d,d.bl_tree[bl_order[w]*2+1],3);send_tree(d,d.dyn_ltree,h-1),send_tree(d,d.dyn_dtree,p-1)},detect_data_type=d=>{let h=4093624447,p;for(p=0;p<=31;p++,h>>>=1)if(h&1&&d.dyn_ltree[p*2]!==0)return Z_BINARY;if(d.dyn_ltree[9*2]!==0||d.dyn_ltree[10*2]!==0||d.dyn_ltree[13*2]!==0)return Z_TEXT;for(p=32;p<LITERALS$1;p++)if(d.dyn_ltree[p*2]!==0)return Z_TEXT;return Z_BINARY};let static_init_done=!1;const _tr_init$1=d=>{static_init_done||(tr_static_init(),static_init_done=!0),d.l_desc=new TreeDesc(d.dyn_ltree,static_l_desc),d.d_desc=new TreeDesc(d.dyn_dtree,static_d_desc),d.bl_desc=new TreeDesc(d.bl_tree,static_bl_desc),d.bi_buf=0,d.bi_valid=0,init_block(d)},_tr_stored_block$1=(d,h,p,m)=>{send_bits(d,(STORED_BLOCK<<1)+(m?1:0),3),copy_block(d,h,p,!0)},_tr_align$1=d=>{send_bits(d,STATIC_TREES<<1,3),send_code(d,END_BLOCK,static_ltree),bi_flush(d)},_tr_flush_block$1=(d,h,p,m)=>{let w,T,k=0;d.level>0?(d.strm.data_type===Z_UNKNOWN$1&&(d.strm.data_type=detect_data_type(d)),build_tree(d,d.l_desc),build_tree(d,d.d_desc),k=build_bl_tree(d),w=d.opt_len+3+7>>>3,T=d.static_len+3+7>>>3,T<=w&&(w=T)):w=T=p+5,p+4<=w&&h!==-1?_tr_stored_block$1(d,h,p,m):d.strategy===Z_FIXED$1||T===w?(send_bits(d,(STATIC_TREES<<1)+(m?1:0),3),compress_block(d,static_ltree,static_dtree)):(send_bits(d,(DYN_TREES<<1)+(m?1:0),3),send_all_trees(d,d.l_desc.max_code+1,d.d_desc.max_code+1,k+1),compress_block(d,d.dyn_ltree,d.dyn_dtree)),init_block(d),m&&bi_windup(d)},_tr_tally$1=(d,h,p)=>(d.pending_buf[d.d_buf+d.last_lit*2]=h>>>8&255,d.pending_buf[d.d_buf+d.last_lit*2+1]=h&255,d.pending_buf[d.l_buf+d.last_lit]=p&255,d.last_lit++,h===0?d.dyn_ltree[p*2]++:(d.matches++,h--,d.dyn_ltree[(_length_code[p]+LITERALS$1+1)*2]++,d.dyn_dtree[d_code(h)*2]++),d.last_lit===d.lit_bufsize-1);var _tr_init_1=_tr_init$1,_tr_stored_block_1=_tr_stored_block$1,_tr_flush_block_1=_tr_flush_block$1,_tr_tally_1=_tr_tally$1,_tr_align_1=_tr_align$1,trees={_tr_init:_tr_init_1,_tr_stored_block:_tr_stored_block_1,_tr_flush_block:_tr_flush_block_1,_tr_tally:_tr_tally_1,_tr_align:_tr_align_1};const adler32=(d,h,p,m)=>{let w=d&65535|0,T=d>>>16&65535|0,k=0;for(;p!==0;){k=p>2e3?2e3:p,p-=k;do w=w+h[m++]|0,T=T+w|0;while(--k);w%=65521,T%=65521}return w|T<<16|0};var adler32_1=adler32;const makeTable=()=>{let d,h=[];for(var p=0;p<256;p++){d=p;for(var m=0;m<8;m++)d=d&1?3988292384^d>>>1:d>>>1;h[p]=d}return h},crcTable$1=new Uint32Array(makeTable()),crc32=(d,h,p,m)=>{const w=crcTable$1,T=m+p;d^=-1;for(let k=m;k<T;k++)d=d>>>8^w[(d^h[k])&255];return d^-1};var crc32_1=crc32,messages={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},constants$2$1={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init,_tr_stored_block,_tr_flush_block,_tr_tally,_tr_align}=trees,{Z_NO_FLUSH:Z_NO_FLUSH$2,Z_PARTIAL_FLUSH,Z_FULL_FLUSH:Z_FULL_FLUSH$1,Z_FINISH:Z_FINISH$3,Z_BLOCK:Z_BLOCK$1,Z_OK:Z_OK$3,Z_STREAM_END:Z_STREAM_END$3,Z_STREAM_ERROR:Z_STREAM_ERROR$2,Z_DATA_ERROR:Z_DATA_ERROR$2,Z_BUF_ERROR:Z_BUF_ERROR$1,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$1,Z_FILTERED,Z_HUFFMAN_ONLY,Z_RLE,Z_FIXED,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY$1,Z_UNKNOWN,Z_DEFLATED:Z_DEFLATED$2}=constants$2$1,MAX_MEM_LEVEL=9,MAX_WBITS$1=15,DEF_MEM_LEVEL=8,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,MIN_MATCH=3,MAX_MATCH=258,MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1,PRESET_DICT=32,INIT_STATE=42,EXTRA_STATE=69,NAME_STATE=73,COMMENT_STATE=91,HCRC_STATE=103,BUSY_STATE=113,FINISH_STATE=666,BS_NEED_MORE=1,BS_BLOCK_DONE=2,BS_FINISH_STARTED=3,BS_FINISH_DONE=4,OS_CODE=3,err=(d,h)=>(d.msg=messages[h],h),rank=d=>(d<<1)-(d>4?9:0),zero=d=>{let h=d.length;for(;--h>=0;)d[h]=0};let HASH_ZLIB=(d,h,p)=>(h<<d.hash_shift^p)&d.hash_mask,HASH=HASH_ZLIB;const flush_pending=d=>{const h=d.state;let p=h.pending;p>d.avail_out&&(p=d.avail_out),p!==0&&(d.output.set(h.pending_buf.subarray(h.pending_out,h.pending_out+p),d.next_out),d.next_out+=p,h.pending_out+=p,d.total_out+=p,d.avail_out-=p,h.pending-=p,h.pending===0&&(h.pending_out=0))},flush_block_only=(d,h)=>{_tr_flush_block(d,d.block_start>=0?d.block_start:-1,d.strstart-d.block_start,h),d.block_start=d.strstart,flush_pending(d.strm)},put_byte=(d,h)=>{d.pending_buf[d.pending++]=h},putShortMSB=(d,h)=>{d.pending_buf[d.pending++]=h>>>8&255,d.pending_buf[d.pending++]=h&255},read_buf=(d,h,p,m)=>{let w=d.avail_in;return w>m&&(w=m),w===0?0:(d.avail_in-=w,h.set(d.input.subarray(d.next_in,d.next_in+w),p),d.state.wrap===1?d.adler=adler32_1(d.adler,h,w,p):d.state.wrap===2&&(d.adler=crc32_1(d.adler,h,w,p)),d.next_in+=w,d.total_in+=w,w)},longest_match=(d,h)=>{let p=d.max_chain_length,m=d.strstart,w,T,k=d.prev_length,x=d.nice_match;const B=d.strstart>d.w_size-MIN_LOOKAHEAD?d.strstart-(d.w_size-MIN_LOOKAHEAD):0,P=d.window,O=d.w_mask,U=d.prev,G=d.strstart+MAX_MATCH;let j=P[m+k-1],H=P[m+k];d.prev_length>=d.good_match&&(p>>=2),x>d.lookahead&&(x=d.lookahead);do if(w=h,!(P[w+k]!==H||P[w+k-1]!==j||P[w]!==P[m]||P[++w]!==P[m+1])){m+=2,w++;do;while(P[++m]===P[++w]&&P[++m]===P[++w]&&P[++m]===P[++w]&&P[++m]===P[++w]&&P[++m]===P[++w]&&P[++m]===P[++w]&&P[++m]===P[++w]&&P[++m]===P[++w]&&m<G);if(T=MAX_MATCH-(G-m),m=G-MAX_MATCH,T>k){if(d.match_start=h,k=T,T>=x)break;j=P[m+k-1],H=P[m+k]}}while((h=U[h&O])>B&&--p!==0);return k<=d.lookahead?k:d.lookahead},fill_window=d=>{const h=d.w_size;let p,m,w,T,k;do{if(T=d.window_size-d.lookahead-d.strstart,d.strstart>=h+(h-MIN_LOOKAHEAD)){d.window.set(d.window.subarray(h,h+h),0),d.match_start-=h,d.strstart-=h,d.block_start-=h,m=d.hash_size,p=m;do w=d.head[--p],d.head[p]=w>=h?w-h:0;while(--m);m=h,p=m;do w=d.prev[--p],d.prev[p]=w>=h?w-h:0;while(--m);T+=h}if(d.strm.avail_in===0)break;if(m=read_buf(d.strm,d.window,d.strstart+d.lookahead,T),d.lookahead+=m,d.lookahead+d.insert>=MIN_MATCH)for(k=d.strstart-d.insert,d.ins_h=d.window[k],d.ins_h=HASH(d,d.ins_h,d.window[k+1]);d.insert&&(d.ins_h=HASH(d,d.ins_h,d.window[k+MIN_MATCH-1]),d.prev[k&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=k,k++,d.insert--,!(d.lookahead+d.insert<MIN_MATCH)););}while(d.lookahead<MIN_LOOKAHEAD&&d.strm.avail_in!==0)},deflate_stored=(d,h)=>{let p=65535;for(p>d.pending_buf_size-5&&(p=d.pending_buf_size-5);;){if(d.lookahead<=1){if(fill_window(d),d.lookahead===0&&h===Z_NO_FLUSH$2)return BS_NEED_MORE;if(d.lookahead===0)break}d.strstart+=d.lookahead,d.lookahead=0;const m=d.block_start+p;if((d.strstart===0||d.strstart>=m)&&(d.lookahead=d.strstart-m,d.strstart=m,flush_block_only(d,!1),d.strm.avail_out===0)||d.strstart-d.block_start>=d.w_size-MIN_LOOKAHEAD&&(flush_block_only(d,!1),d.strm.avail_out===0))return BS_NEED_MORE}return d.insert=0,h===Z_FINISH$3?(flush_block_only(d,!0),d.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):(d.strstart>d.block_start&&(flush_block_only(d,!1),d.strm.avail_out===0),BS_NEED_MORE)},deflate_fast=(d,h)=>{let p,m;for(;;){if(d.lookahead<MIN_LOOKAHEAD){if(fill_window(d),d.lookahead<MIN_LOOKAHEAD&&h===Z_NO_FLUSH$2)return BS_NEED_MORE;if(d.lookahead===0)break}if(p=0,d.lookahead>=MIN_MATCH&&(d.ins_h=HASH(d,d.ins_h,d.window[d.strstart+MIN_MATCH-1]),p=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),p!==0&&d.strstart-p<=d.w_size-MIN_LOOKAHEAD&&(d.match_length=longest_match(d,p)),d.match_length>=MIN_MATCH)if(m=_tr_tally(d,d.strstart-d.match_start,d.match_length-MIN_MATCH),d.lookahead-=d.match_length,d.match_length<=d.max_lazy_match&&d.lookahead>=MIN_MATCH){d.match_length--;do d.strstart++,d.ins_h=HASH(d,d.ins_h,d.window[d.strstart+MIN_MATCH-1]),p=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart;while(--d.match_length!==0);d.strstart++}else d.strstart+=d.match_length,d.match_length=0,d.ins_h=d.window[d.strstart],d.ins_h=HASH(d,d.ins_h,d.window[d.strstart+1]);else m=_tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++;if(m&&(flush_block_only(d,!1),d.strm.avail_out===0))return BS_NEED_MORE}return d.insert=d.strstart<MIN_MATCH-1?d.strstart:MIN_MATCH-1,h===Z_FINISH$3?(flush_block_only(d,!0),d.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):d.last_lit&&(flush_block_only(d,!1),d.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_slow=(d,h)=>{let p,m,w;for(;;){if(d.lookahead<MIN_LOOKAHEAD){if(fill_window(d),d.lookahead<MIN_LOOKAHEAD&&h===Z_NO_FLUSH$2)return BS_NEED_MORE;if(d.lookahead===0)break}if(p=0,d.lookahead>=MIN_MATCH&&(d.ins_h=HASH(d,d.ins_h,d.window[d.strstart+MIN_MATCH-1]),p=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart),d.prev_length=d.match_length,d.prev_match=d.match_start,d.match_length=MIN_MATCH-1,p!==0&&d.prev_length<d.max_lazy_match&&d.strstart-p<=d.w_size-MIN_LOOKAHEAD&&(d.match_length=longest_match(d,p),d.match_length<=5&&(d.strategy===Z_FILTERED||d.match_length===MIN_MATCH&&d.strstart-d.match_start>4096)&&(d.match_length=MIN_MATCH-1)),d.prev_length>=MIN_MATCH&&d.match_length<=d.prev_length){w=d.strstart+d.lookahead-MIN_MATCH,m=_tr_tally(d,d.strstart-1-d.prev_match,d.prev_length-MIN_MATCH),d.lookahead-=d.prev_length-1,d.prev_length-=2;do++d.strstart<=w&&(d.ins_h=HASH(d,d.ins_h,d.window[d.strstart+MIN_MATCH-1]),p=d.prev[d.strstart&d.w_mask]=d.head[d.ins_h],d.head[d.ins_h]=d.strstart);while(--d.prev_length!==0);if(d.match_available=0,d.match_length=MIN_MATCH-1,d.strstart++,m&&(flush_block_only(d,!1),d.strm.avail_out===0))return BS_NEED_MORE}else if(d.match_available){if(m=_tr_tally(d,0,d.window[d.strstart-1]),m&&flush_block_only(d,!1),d.strstart++,d.lookahead--,d.strm.avail_out===0)return BS_NEED_MORE}else d.match_available=1,d.strstart++,d.lookahead--}return d.match_available&&(m=_tr_tally(d,0,d.window[d.strstart-1]),d.match_available=0),d.insert=d.strstart<MIN_MATCH-1?d.strstart:MIN_MATCH-1,h===Z_FINISH$3?(flush_block_only(d,!0),d.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):d.last_lit&&(flush_block_only(d,!1),d.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_rle=(d,h)=>{let p,m,w,T;const k=d.window;for(;;){if(d.lookahead<=MAX_MATCH){if(fill_window(d),d.lookahead<=MAX_MATCH&&h===Z_NO_FLUSH$2)return BS_NEED_MORE;if(d.lookahead===0)break}if(d.match_length=0,d.lookahead>=MIN_MATCH&&d.strstart>0&&(w=d.strstart-1,m=k[w],m===k[++w]&&m===k[++w]&&m===k[++w])){T=d.strstart+MAX_MATCH;do;while(m===k[++w]&&m===k[++w]&&m===k[++w]&&m===k[++w]&&m===k[++w]&&m===k[++w]&&m===k[++w]&&m===k[++w]&&w<T);d.match_length=MAX_MATCH-(T-w),d.match_length>d.lookahead&&(d.match_length=d.lookahead)}if(d.match_length>=MIN_MATCH?(p=_tr_tally(d,1,d.match_length-MIN_MATCH),d.lookahead-=d.match_length,d.strstart+=d.match_length,d.match_length=0):(p=_tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++),p&&(flush_block_only(d,!1),d.strm.avail_out===0))return BS_NEED_MORE}return d.insert=0,h===Z_FINISH$3?(flush_block_only(d,!0),d.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):d.last_lit&&(flush_block_only(d,!1),d.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_huff=(d,h)=>{let p;for(;;){if(d.lookahead===0&&(fill_window(d),d.lookahead===0)){if(h===Z_NO_FLUSH$2)return BS_NEED_MORE;break}if(d.match_length=0,p=_tr_tally(d,0,d.window[d.strstart]),d.lookahead--,d.strstart++,p&&(flush_block_only(d,!1),d.strm.avail_out===0))return BS_NEED_MORE}return d.insert=0,h===Z_FINISH$3?(flush_block_only(d,!0),d.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):d.last_lit&&(flush_block_only(d,!1),d.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE};function Config(d,h,p,m,w){this.good_length=d,this.max_lazy=h,this.nice_length=p,this.max_chain=m,this.func=w}const configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],lm_init=d=>{d.window_size=2*d.w_size,zero(d.head),d.max_lazy_match=configuration_table[d.level].max_lazy,d.good_match=configuration_table[d.level].good_length,d.nice_match=configuration_table[d.level].nice_length,d.max_chain_length=configuration_table[d.level].max_chain,d.strstart=0,d.block_start=0,d.lookahead=0,d.insert=0,d.match_length=d.prev_length=MIN_MATCH-1,d.match_available=0,d.ins_h=0};function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Z_DEFLATED$2,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(HEAP_SIZE*2),this.dyn_dtree=new Uint16Array((2*D_CODES+1)*2),this.bl_tree=new Uint16Array((2*BL_CODES+1)*2),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(MAX_BITS+1),this.heap=new Uint16Array(2*L_CODES+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*L_CODES+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const deflateResetKeep=d=>{if(!d||!d.state)return err(d,Z_STREAM_ERROR$2);d.total_in=d.total_out=0,d.data_type=Z_UNKNOWN;const h=d.state;return h.pending=0,h.pending_out=0,h.wrap<0&&(h.wrap=-h.wrap),h.status=h.wrap?INIT_STATE:BUSY_STATE,d.adler=h.wrap===2?0:1,h.last_flush=Z_NO_FLUSH$2,_tr_init(h),Z_OK$3},deflateReset=d=>{const h=deflateResetKeep(d);return h===Z_OK$3&&lm_init(d.state),h},deflateSetHeader=(d,h)=>!d||!d.state||d.state.wrap!==2?Z_STREAM_ERROR$2:(d.state.gzhead=h,Z_OK$3),deflateInit2=(d,h,p,m,w,T)=>{if(!d)return Z_STREAM_ERROR$2;let k=1;if(h===Z_DEFAULT_COMPRESSION$1&&(h=6),m<0?(k=0,m=-m):m>15&&(k=2,m-=16),w<1||w>MAX_MEM_LEVEL||p!==Z_DEFLATED$2||m<8||m>15||h<0||h>9||T<0||T>Z_FIXED)return err(d,Z_STREAM_ERROR$2);m===8&&(m=9);const x=new DeflateState;return d.state=x,x.strm=d,x.wrap=k,x.gzhead=null,x.w_bits=m,x.w_size=1<<x.w_bits,x.w_mask=x.w_size-1,x.hash_bits=w+7,x.hash_size=1<<x.hash_bits,x.hash_mask=x.hash_size-1,x.hash_shift=~~((x.hash_bits+MIN_MATCH-1)/MIN_MATCH),x.window=new Uint8Array(x.w_size*2),x.head=new Uint16Array(x.hash_size),x.prev=new Uint16Array(x.w_size),x.lit_bufsize=1<<w+6,x.pending_buf_size=x.lit_bufsize*4,x.pending_buf=new Uint8Array(x.pending_buf_size),x.d_buf=1*x.lit_bufsize,x.l_buf=(1+2)*x.lit_bufsize,x.level=h,x.strategy=T,x.method=p,deflateReset(d)},deflateInit=(d,h)=>deflateInit2(d,h,Z_DEFLATED$2,MAX_WBITS$1,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY$1),deflate$2=(d,h)=>{let p,m;if(!d||!d.state||h>Z_BLOCK$1||h<0)return d?err(d,Z_STREAM_ERROR$2):Z_STREAM_ERROR$2;const w=d.state;if(!d.output||!d.input&&d.avail_in!==0||w.status===FINISH_STATE&&h!==Z_FINISH$3)return err(d,d.avail_out===0?Z_BUF_ERROR$1:Z_STREAM_ERROR$2);w.strm=d;const T=w.last_flush;if(w.last_flush=h,w.status===INIT_STATE)if(w.wrap===2)d.adler=0,put_byte(w,31),put_byte(w,139),put_byte(w,8),w.gzhead?(put_byte(w,(w.gzhead.text?1:0)+(w.gzhead.hcrc?2:0)+(w.gzhead.extra?4:0)+(w.gzhead.name?8:0)+(w.gzhead.comment?16:0)),put_byte(w,w.gzhead.time&255),put_byte(w,w.gzhead.time>>8&255),put_byte(w,w.gzhead.time>>16&255),put_byte(w,w.gzhead.time>>24&255),put_byte(w,w.level===9?2:w.strategy>=Z_HUFFMAN_ONLY||w.level<2?4:0),put_byte(w,w.gzhead.os&255),w.gzhead.extra&&w.gzhead.extra.length&&(put_byte(w,w.gzhead.extra.length&255),put_byte(w,w.gzhead.extra.length>>8&255)),w.gzhead.hcrc&&(d.adler=crc32_1(d.adler,w.pending_buf,w.pending,0)),w.gzindex=0,w.status=EXTRA_STATE):(put_byte(w,0),put_byte(w,0),put_byte(w,0),put_byte(w,0),put_byte(w,0),put_byte(w,w.level===9?2:w.strategy>=Z_HUFFMAN_ONLY||w.level<2?4:0),put_byte(w,OS_CODE),w.status=BUSY_STATE);else{let k=Z_DEFLATED$2+(w.w_bits-8<<4)<<8,x=-1;w.strategy>=Z_HUFFMAN_ONLY||w.level<2?x=0:w.level<6?x=1:w.level===6?x=2:x=3,k|=x<<6,w.strstart!==0&&(k|=PRESET_DICT),k+=31-k%31,w.status=BUSY_STATE,putShortMSB(w,k),w.strstart!==0&&(putShortMSB(w,d.adler>>>16),putShortMSB(w,d.adler&65535)),d.adler=1}if(w.status===EXTRA_STATE)if(w.gzhead.extra){for(p=w.pending;w.gzindex<(w.gzhead.extra.length&65535)&&!(w.pending===w.pending_buf_size&&(w.gzhead.hcrc&&w.pending>p&&(d.adler=crc32_1(d.adler,w.pending_buf,w.pending-p,p)),flush_pending(d),p=w.pending,w.pending===w.pending_buf_size));)put_byte(w,w.gzhead.extra[w.gzindex]&255),w.gzindex++;w.gzhead.hcrc&&w.pending>p&&(d.adler=crc32_1(d.adler,w.pending_buf,w.pending-p,p)),w.gzindex===w.gzhead.extra.length&&(w.gzindex=0,w.status=NAME_STATE)}else w.status=NAME_STATE;if(w.status===NAME_STATE)if(w.gzhead.name){p=w.pending;do{if(w.pending===w.pending_buf_size&&(w.gzhead.hcrc&&w.pending>p&&(d.adler=crc32_1(d.adler,w.pending_buf,w.pending-p,p)),flush_pending(d),p=w.pending,w.pending===w.pending_buf_size)){m=1;break}w.gzindex<w.gzhead.name.length?m=w.gzhead.name.charCodeAt(w.gzindex++)&255:m=0,put_byte(w,m)}while(m!==0);w.gzhead.hcrc&&w.pending>p&&(d.adler=crc32_1(d.adler,w.pending_buf,w.pending-p,p)),m===0&&(w.gzindex=0,w.status=COMMENT_STATE)}else w.status=COMMENT_STATE;if(w.status===COMMENT_STATE)if(w.gzhead.comment){p=w.pending;do{if(w.pending===w.pending_buf_size&&(w.gzhead.hcrc&&w.pending>p&&(d.adler=crc32_1(d.adler,w.pending_buf,w.pending-p,p)),flush_pending(d),p=w.pending,w.pending===w.pending_buf_size)){m=1;break}w.gzindex<w.gzhead.comment.length?m=w.gzhead.comment.charCodeAt(w.gzindex++)&255:m=0,put_byte(w,m)}while(m!==0);w.gzhead.hcrc&&w.pending>p&&(d.adler=crc32_1(d.adler,w.pending_buf,w.pending-p,p)),m===0&&(w.status=HCRC_STATE)}else w.status=HCRC_STATE;if(w.status===HCRC_STATE&&(w.gzhead.hcrc?(w.pending+2>w.pending_buf_size&&flush_pending(d),w.pending+2<=w.pending_buf_size&&(put_byte(w,d.adler&255),put_byte(w,d.adler>>8&255),d.adler=0,w.status=BUSY_STATE)):w.status=BUSY_STATE),w.pending!==0){if(flush_pending(d),d.avail_out===0)return w.last_flush=-1,Z_OK$3}else if(d.avail_in===0&&rank(h)<=rank(T)&&h!==Z_FINISH$3)return err(d,Z_BUF_ERROR$1);if(w.status===FINISH_STATE&&d.avail_in!==0)return err(d,Z_BUF_ERROR$1);if(d.avail_in!==0||w.lookahead!==0||h!==Z_NO_FLUSH$2&&w.status!==FINISH_STATE){let k=w.strategy===Z_HUFFMAN_ONLY?deflate_huff(w,h):w.strategy===Z_RLE?deflate_rle(w,h):configuration_table[w.level].func(w,h);if((k===BS_FINISH_STARTED||k===BS_FINISH_DONE)&&(w.status=FINISH_STATE),k===BS_NEED_MORE||k===BS_FINISH_STARTED)return d.avail_out===0&&(w.last_flush=-1),Z_OK$3;if(k===BS_BLOCK_DONE&&(h===Z_PARTIAL_FLUSH?_tr_align(w):h!==Z_BLOCK$1&&(_tr_stored_block(w,0,0,!1),h===Z_FULL_FLUSH$1&&(zero(w.head),w.lookahead===0&&(w.strstart=0,w.block_start=0,w.insert=0))),flush_pending(d),d.avail_out===0))return w.last_flush=-1,Z_OK$3}return h!==Z_FINISH$3?Z_OK$3:w.wrap<=0?Z_STREAM_END$3:(w.wrap===2?(put_byte(w,d.adler&255),put_byte(w,d.adler>>8&255),put_byte(w,d.adler>>16&255),put_byte(w,d.adler>>24&255),put_byte(w,d.total_in&255),put_byte(w,d.total_in>>8&255),put_byte(w,d.total_in>>16&255),put_byte(w,d.total_in>>24&255)):(putShortMSB(w,d.adler>>>16),putShortMSB(w,d.adler&65535)),flush_pending(d),w.wrap>0&&(w.wrap=-w.wrap),w.pending!==0?Z_OK$3:Z_STREAM_END$3)},deflateEnd=d=>{if(!d||!d.state)return Z_STREAM_ERROR$2;const h=d.state.status;return h!==INIT_STATE&&h!==EXTRA_STATE&&h!==NAME_STATE&&h!==COMMENT_STATE&&h!==HCRC_STATE&&h!==BUSY_STATE&&h!==FINISH_STATE?err(d,Z_STREAM_ERROR$2):(d.state=null,h===BUSY_STATE?err(d,Z_DATA_ERROR$2):Z_OK$3)},deflateSetDictionary=(d,h)=>{let p=h.length;if(!d||!d.state)return Z_STREAM_ERROR$2;const m=d.state,w=m.wrap;if(w===2||w===1&&m.status!==INIT_STATE||m.lookahead)return Z_STREAM_ERROR$2;if(w===1&&(d.adler=adler32_1(d.adler,h,p,0)),m.wrap=0,p>=m.w_size){w===0&&(zero(m.head),m.strstart=0,m.block_start=0,m.insert=0);let B=new Uint8Array(m.w_size);B.set(h.subarray(p-m.w_size,p),0),h=B,p=m.w_size}const T=d.avail_in,k=d.next_in,x=d.input;for(d.avail_in=p,d.next_in=0,d.input=h,fill_window(m);m.lookahead>=MIN_MATCH;){let B=m.strstart,P=m.lookahead-(MIN_MATCH-1);do m.ins_h=HASH(m,m.ins_h,m.window[B+MIN_MATCH-1]),m.prev[B&m.w_mask]=m.head[m.ins_h],m.head[m.ins_h]=B,B++;while(--P);m.strstart=B,m.lookahead=MIN_MATCH-1,fill_window(m)}return m.strstart+=m.lookahead,m.block_start=m.strstart,m.insert=m.lookahead,m.lookahead=0,m.match_length=m.prev_length=MIN_MATCH-1,m.match_available=0,d.next_in=k,d.input=x,d.avail_in=T,m.wrap=w,Z_OK$3};var deflateInit_1=deflateInit,deflateInit2_1=deflateInit2,deflateReset_1=deflateReset,deflateResetKeep_1=deflateResetKeep,deflateSetHeader_1=deflateSetHeader,deflate_2$1=deflate$2,deflateEnd_1=deflateEnd,deflateSetDictionary_1=deflateSetDictionary,deflateInfo="pako deflate (from Nodeca project)",deflate_1$2={deflateInit:deflateInit_1,deflateInit2:deflateInit2_1,deflateReset:deflateReset_1,deflateResetKeep:deflateResetKeep_1,deflateSetHeader:deflateSetHeader_1,deflate:deflate_2$1,deflateEnd:deflateEnd_1,deflateSetDictionary:deflateSetDictionary_1,deflateInfo};const _has=(d,h)=>Object.prototype.hasOwnProperty.call(d,h);var assign=function(d){const h=Array.prototype.slice.call(arguments,1);for(;h.length;){const p=h.shift();if(!!p){if(typeof p!="object")throw new TypeError(p+"must be non-object");for(const m in p)_has(p,m)&&(d[m]=p[m])}}return d},flattenChunks=d=>{let h=0;for(let m=0,w=d.length;m<w;m++)h+=d[m].length;const p=new Uint8Array(h);for(let m=0,w=0,T=d.length;m<T;m++){let k=d[m];p.set(k,w),w+=k.length}return p},common={assign,flattenChunks};let STR_APPLY_UIA_OK=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{STR_APPLY_UIA_OK=!1}const _utf8len=new Uint8Array(256);for(let d=0;d<256;d++)_utf8len[d]=d>=252?6:d>=248?5:d>=240?4:d>=224?3:d>=192?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=d=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(d);let h,p,m,w,T,k=d.length,x=0;for(w=0;w<k;w++)p=d.charCodeAt(w),(p&64512)===55296&&w+1<k&&(m=d.charCodeAt(w+1),(m&64512)===56320&&(p=65536+(p-55296<<10)+(m-56320),w++)),x+=p<128?1:p<2048?2:p<65536?3:4;for(h=new Uint8Array(x),T=0,w=0;T<x;w++)p=d.charCodeAt(w),(p&64512)===55296&&w+1<k&&(m=d.charCodeAt(w+1),(m&64512)===56320&&(p=65536+(p-55296<<10)+(m-56320),w++)),p<128?h[T++]=p:p<2048?(h[T++]=192|p>>>6,h[T++]=128|p&63):p<65536?(h[T++]=224|p>>>12,h[T++]=128|p>>>6&63,h[T++]=128|p&63):(h[T++]=240|p>>>18,h[T++]=128|p>>>12&63,h[T++]=128|p>>>6&63,h[T++]=128|p&63);return h};const buf2binstring=(d,h)=>{if(h<65534&&d.subarray&&STR_APPLY_UIA_OK)return String.fromCharCode.apply(null,d.length===h?d:d.subarray(0,h));let p="";for(let m=0;m<h;m++)p+=String.fromCharCode(d[m]);return p};var buf2string=(d,h)=>{const p=h||d.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(d.subarray(0,h));let m,w;const T=new Array(p*2);for(w=0,m=0;m<p;){let k=d[m++];if(k<128){T[w++]=k;continue}let x=_utf8len[k];if(x>4){T[w++]=65533,m+=x-1;continue}for(k&=x===2?31:x===3?15:7;x>1&&m<p;)k=k<<6|d[m++]&63,x--;if(x>1){T[w++]=65533;continue}k<65536?T[w++]=k:(k-=65536,T[w++]=55296|k>>10&1023,T[w++]=56320|k&1023)}return buf2binstring(T,w)},utf8border=(d,h)=>{h=h||d.length,h>d.length&&(h=d.length);let p=h-1;for(;p>=0&&(d[p]&192)===128;)p--;return p<0||p===0?h:p+_utf8len[d[p]]>h?p:h},strings={string2buf,buf2string,utf8border};function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var zstream=ZStream;const toString$1$1=Object.prototype.toString,{Z_NO_FLUSH:Z_NO_FLUSH$1,Z_SYNC_FLUSH,Z_FULL_FLUSH,Z_FINISH:Z_FINISH$2,Z_OK:Z_OK$2,Z_STREAM_END:Z_STREAM_END$2,Z_DEFAULT_COMPRESSION,Z_DEFAULT_STRATEGY,Z_DEFLATED:Z_DEFLATED$1}=constants$2$1;function Deflate$1(d){this.options=common.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED$1,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY},d||{});let h=this.options;h.raw&&h.windowBits>0?h.windowBits=-h.windowBits:h.gzip&&h.windowBits>0&&h.windowBits<16&&(h.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let p=deflate_1$2.deflateInit2(this.strm,h.level,h.method,h.windowBits,h.memLevel,h.strategy);if(p!==Z_OK$2)throw new Error(messages[p]);if(h.header&&deflate_1$2.deflateSetHeader(this.strm,h.header),h.dictionary){let m;if(typeof h.dictionary=="string"?m=strings.string2buf(h.dictionary):toString$1$1.call(h.dictionary)==="[object ArrayBuffer]"?m=new Uint8Array(h.dictionary):m=h.dictionary,p=deflate_1$2.deflateSetDictionary(this.strm,m),p!==Z_OK$2)throw new Error(messages[p]);this._dict_set=!0}}Deflate$1.prototype.push=function(d,h){const p=this.strm,m=this.options.chunkSize;let w,T;if(this.ended)return!1;for(h===~~h?T=h:T=h===!0?Z_FINISH$2:Z_NO_FLUSH$1,typeof d=="string"?p.input=strings.string2buf(d):toString$1$1.call(d)==="[object ArrayBuffer]"?p.input=new Uint8Array(d):p.input=d,p.next_in=0,p.avail_in=p.input.length;;){if(p.avail_out===0&&(p.output=new Uint8Array(m),p.next_out=0,p.avail_out=m),(T===Z_SYNC_FLUSH||T===Z_FULL_FLUSH)&&p.avail_out<=6){this.onData(p.output.subarray(0,p.next_out)),p.avail_out=0;continue}if(w=deflate_1$2.deflate(p,T),w===Z_STREAM_END$2)return p.next_out>0&&this.onData(p.output.subarray(0,p.next_out)),w=deflate_1$2.deflateEnd(this.strm),this.onEnd(w),this.ended=!0,w===Z_OK$2;if(p.avail_out===0){this.onData(p.output);continue}if(T>0&&p.next_out>0){this.onData(p.output.subarray(0,p.next_out)),p.avail_out=0;continue}if(p.avail_in===0)break}return!0};Deflate$1.prototype.onData=function(d){this.chunks.push(d)};Deflate$1.prototype.onEnd=function(d){d===Z_OK$2&&(this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=d,this.msg=this.strm.msg};function deflate$1(d,h){const p=new Deflate$1(h);if(p.push(d,!0),p.err)throw p.msg||messages[p.err];return p.result}function deflateRaw$1(d,h){return h=h||{},h.raw=!0,deflate$1(d,h)}function gzip$1(d,h){return h=h||{},h.gzip=!0,deflate$1(d,h)}var Deflate_1$1=Deflate$1,deflate_2=deflate$1,deflateRaw_1$1=deflateRaw$1,gzip_1$1=gzip$1,constants$1$1=constants$2$1,deflate_1$1={Deflate:Deflate_1$1,deflate:deflate_2,deflateRaw:deflateRaw_1$1,gzip:gzip_1$1,constants:constants$1$1};const BAD$1=30,TYPE$1=12;var inffast=function(h,p){let m,w,T,k,x,B,P,O,U,G,j,H,te,oe,Q,_e,se,le,me,Re,xe,ue,Me,he;const ge=h.state;m=h.next_in,Me=h.input,w=m+(h.avail_in-5),T=h.next_out,he=h.output,k=T-(p-h.avail_out),x=T+(h.avail_out-257),B=ge.dmax,P=ge.wsize,O=ge.whave,U=ge.wnext,G=ge.window,j=ge.hold,H=ge.bits,te=ge.lencode,oe=ge.distcode,Q=(1<<ge.lenbits)-1,_e=(1<<ge.distbits)-1;e:do{H<15&&(j+=Me[m++]<<H,H+=8,j+=Me[m++]<<H,H+=8),se=te[j&Q];t:for(;;){if(le=se>>>24,j>>>=le,H-=le,le=se>>>16&255,le===0)he[T++]=se&65535;else if(le&16){me=se&65535,le&=15,le&&(H<le&&(j+=Me[m++]<<H,H+=8),me+=j&(1<<le)-1,j>>>=le,H-=le),H<15&&(j+=Me[m++]<<H,H+=8,j+=Me[m++]<<H,H+=8),se=oe[j&_e];i:for(;;){if(le=se>>>24,j>>>=le,H-=le,le=se>>>16&255,le&16){if(Re=se&65535,le&=15,H<le&&(j+=Me[m++]<<H,H+=8,H<le&&(j+=Me[m++]<<H,H+=8)),Re+=j&(1<<le)-1,Re>B){h.msg="invalid distance too far back",ge.mode=BAD$1;break e}if(j>>>=le,H-=le,le=T-k,Re>le){if(le=Re-le,le>O&&ge.sane){h.msg="invalid distance too far back",ge.mode=BAD$1;break e}if(xe=0,ue=G,U===0){if(xe+=P-le,le<me){me-=le;do he[T++]=G[xe++];while(--le);xe=T-Re,ue=he}}else if(U<le){if(xe+=P+U-le,le-=U,le<me){me-=le;do he[T++]=G[xe++];while(--le);if(xe=0,U<me){le=U,me-=le;do he[T++]=G[xe++];while(--le);xe=T-Re,ue=he}}}else if(xe+=U-le,le<me){me-=le;do he[T++]=G[xe++];while(--le);xe=T-Re,ue=he}for(;me>2;)he[T++]=ue[xe++],he[T++]=ue[xe++],he[T++]=ue[xe++],me-=3;me&&(he[T++]=ue[xe++],me>1&&(he[T++]=ue[xe++]))}else{xe=T-Re;do he[T++]=he[xe++],he[T++]=he[xe++],he[T++]=he[xe++],me-=3;while(me>2);me&&(he[T++]=he[xe++],me>1&&(he[T++]=he[xe++]))}}else if((le&64)===0){se=oe[(se&65535)+(j&(1<<le)-1)];continue i}else{h.msg="invalid distance code",ge.mode=BAD$1;break e}break}}else if((le&64)===0){se=te[(se&65535)+(j&(1<<le)-1)];continue t}else if(le&32){ge.mode=TYPE$1;break e}else{h.msg="invalid literal/length code",ge.mode=BAD$1;break e}break}}while(m<w&&T<x);me=H>>3,m-=me,H-=me<<3,j&=(1<<H)-1,h.next_in=m,h.next_out=T,h.avail_in=m<w?5+(w-m):5-(m-w),h.avail_out=T<x?257+(x-T):257-(T-x),ge.hold=j,ge.bits=H};const MAXBITS=15,ENOUGH_LENS$1=852,ENOUGH_DISTS$1=592,CODES$1=0,LENS$1=1,DISTS$1=2,lbase=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),lext=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),dbase=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),dext=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),inflate_table=(d,h,p,m,w,T,k,x)=>{const B=x.bits;let P=0,O=0,U=0,G=0,j=0,H=0,te=0,oe=0,Q=0,_e=0,se,le,me,Re,xe,ue=null,Me=0,he;const ge=new Uint16Array(MAXBITS+1),Le=new Uint16Array(MAXBITS+1);let Ze=null,st=0,ht,Rt,Bt;for(P=0;P<=MAXBITS;P++)ge[P]=0;for(O=0;O<m;O++)ge[h[p+O]]++;for(j=B,G=MAXBITS;G>=1&&ge[G]===0;G--);if(j>G&&(j=G),G===0)return w[T++]=1<<24|64<<16|0,w[T++]=1<<24|64<<16|0,x.bits=1,0;for(U=1;U<G&&ge[U]===0;U++);for(j<U&&(j=U),oe=1,P=1;P<=MAXBITS;P++)if(oe<<=1,oe-=ge[P],oe<0)return-1;if(oe>0&&(d===CODES$1||G!==1))return-1;for(Le[1]=0,P=1;P<MAXBITS;P++)Le[P+1]=Le[P]+ge[P];for(O=0;O<m;O++)h[p+O]!==0&&(k[Le[h[p+O]]++]=O);if(d===CODES$1?(ue=Ze=k,he=19):d===LENS$1?(ue=lbase,Me-=257,Ze=lext,st-=257,he=256):(ue=dbase,Ze=dext,he=-1),_e=0,O=0,P=U,xe=T,H=j,te=0,me=-1,Q=1<<j,Re=Q-1,d===LENS$1&&Q>ENOUGH_LENS$1||d===DISTS$1&&Q>ENOUGH_DISTS$1)return 1;for(;;){ht=P-te,k[O]<he?(Rt=0,Bt=k[O]):k[O]>he?(Rt=Ze[st+k[O]],Bt=ue[Me+k[O]]):(Rt=32+64,Bt=0),se=1<<P-te,le=1<<H,U=le;do le-=se,w[xe+(_e>>te)+le]=ht<<24|Rt<<16|Bt|0;while(le!==0);for(se=1<<P-1;_e&se;)se>>=1;if(se!==0?(_e&=se-1,_e+=se):_e=0,O++,--ge[P]===0){if(P===G)break;P=h[p+k[O]]}if(P>j&&(_e&Re)!==me){for(te===0&&(te=j),xe+=U,H=P-te,oe=1<<H;H+te<G&&(oe-=ge[H+te],!(oe<=0));)H++,oe<<=1;if(Q+=1<<H,d===LENS$1&&Q>ENOUGH_LENS$1||d===DISTS$1&&Q>ENOUGH_DISTS$1)return 1;me=_e&Re,w[me]=j<<24|H<<16|xe-T|0}}return _e!==0&&(w[xe+_e]=P-te<<24|64<<16|0),x.bits=j,0};var inftrees=inflate_table;const CODES=0,LENS=1,DISTS=2,{Z_FINISH:Z_FINISH$1,Z_BLOCK,Z_TREES,Z_OK:Z_OK$1,Z_STREAM_END:Z_STREAM_END$1,Z_NEED_DICT:Z_NEED_DICT$1,Z_STREAM_ERROR:Z_STREAM_ERROR$1,Z_DATA_ERROR:Z_DATA_ERROR$1,Z_MEM_ERROR:Z_MEM_ERROR$1,Z_BUF_ERROR,Z_DEFLATED}=constants$2$1,HEAD=1,FLAGS=2,TIME=3,OS=4,EXLEN=5,EXTRA=6,NAME=7,COMMENT=8,HCRC=9,DICTID=10,DICT=11,TYPE=12,TYPEDO=13,STORED=14,COPY_=15,COPY=16,TABLE=17,LENLENS=18,CODELENS=19,LEN_=20,LEN=21,LENEXT=22,DIST=23,DISTEXT=24,MATCH=25,LIT=26,CHECK=27,LENGTH=28,DONE=29,BAD=30,MEM=31,SYNC=32,ENOUGH_LENS=852,ENOUGH_DISTS=592,MAX_WBITS=15,DEF_WBITS=MAX_WBITS,zswap32=d=>(d>>>24&255)+(d>>>8&65280)+((d&65280)<<8)+((d&255)<<24);function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const inflateResetKeep=d=>{if(!d||!d.state)return Z_STREAM_ERROR$1;const h=d.state;return d.total_in=d.total_out=h.total=0,d.msg="",h.wrap&&(d.adler=h.wrap&1),h.mode=HEAD,h.last=0,h.havedict=0,h.dmax=32768,h.head=null,h.hold=0,h.bits=0,h.lencode=h.lendyn=new Int32Array(ENOUGH_LENS),h.distcode=h.distdyn=new Int32Array(ENOUGH_DISTS),h.sane=1,h.back=-1,Z_OK$1},inflateReset=d=>{if(!d||!d.state)return Z_STREAM_ERROR$1;const h=d.state;return h.wsize=0,h.whave=0,h.wnext=0,inflateResetKeep(d)},inflateReset2=(d,h)=>{let p;if(!d||!d.state)return Z_STREAM_ERROR$1;const m=d.state;return h<0?(p=0,h=-h):(p=(h>>4)+1,h<48&&(h&=15)),h&&(h<8||h>15)?Z_STREAM_ERROR$1:(m.window!==null&&m.wbits!==h&&(m.window=null),m.wrap=p,m.wbits=h,inflateReset(d))},inflateInit2=(d,h)=>{if(!d)return Z_STREAM_ERROR$1;const p=new InflateState;d.state=p,p.window=null;const m=inflateReset2(d,h);return m!==Z_OK$1&&(d.state=null),m},inflateInit=d=>inflateInit2(d,DEF_WBITS);let virgin=!0,lenfix,distfix;const fixedtables=d=>{if(virgin){lenfix=new Int32Array(512),distfix=new Int32Array(32);let h=0;for(;h<144;)d.lens[h++]=8;for(;h<256;)d.lens[h++]=9;for(;h<280;)d.lens[h++]=7;for(;h<288;)d.lens[h++]=8;for(inftrees(LENS,d.lens,0,288,lenfix,0,d.work,{bits:9}),h=0;h<32;)d.lens[h++]=5;inftrees(DISTS,d.lens,0,32,distfix,0,d.work,{bits:5}),virgin=!1}d.lencode=lenfix,d.lenbits=9,d.distcode=distfix,d.distbits=5},updatewindow=(d,h,p,m)=>{let w;const T=d.state;return T.window===null&&(T.wsize=1<<T.wbits,T.wnext=0,T.whave=0,T.window=new Uint8Array(T.wsize)),m>=T.wsize?(T.window.set(h.subarray(p-T.wsize,p),0),T.wnext=0,T.whave=T.wsize):(w=T.wsize-T.wnext,w>m&&(w=m),T.window.set(h.subarray(p-m,p-m+w),T.wnext),m-=w,m?(T.window.set(h.subarray(p-m,p),0),T.wnext=m,T.whave=T.wsize):(T.wnext+=w,T.wnext===T.wsize&&(T.wnext=0),T.whave<T.wsize&&(T.whave+=w))),0},inflate$2=(d,h)=>{let p,m,w,T,k,x,B,P,O,U,G,j,H,te,oe=0,Q,_e,se,le,me,Re,xe,ue;const Me=new Uint8Array(4);let he,ge;const Le=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!d||!d.state||!d.output||!d.input&&d.avail_in!==0)return Z_STREAM_ERROR$1;p=d.state,p.mode===TYPE&&(p.mode=TYPEDO),k=d.next_out,w=d.output,B=d.avail_out,T=d.next_in,m=d.input,x=d.avail_in,P=p.hold,O=p.bits,U=x,G=B,ue=Z_OK$1;e:for(;;)switch(p.mode){case HEAD:if(p.wrap===0){p.mode=TYPEDO;break}for(;O<16;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if(p.wrap&2&&P===35615){p.check=0,Me[0]=P&255,Me[1]=P>>>8&255,p.check=crc32_1(p.check,Me,2,0),P=0,O=0,p.mode=FLAGS;break}if(p.flags=0,p.head&&(p.head.done=!1),!(p.wrap&1)||(((P&255)<<8)+(P>>8))%31){d.msg="incorrect header check",p.mode=BAD;break}if((P&15)!==Z_DEFLATED){d.msg="unknown compression method",p.mode=BAD;break}if(P>>>=4,O-=4,xe=(P&15)+8,p.wbits===0)p.wbits=xe;else if(xe>p.wbits){d.msg="invalid window size",p.mode=BAD;break}p.dmax=1<<p.wbits,d.adler=p.check=1,p.mode=P&512?DICTID:TYPE,P=0,O=0;break;case FLAGS:for(;O<16;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if(p.flags=P,(p.flags&255)!==Z_DEFLATED){d.msg="unknown compression method",p.mode=BAD;break}if(p.flags&57344){d.msg="unknown header flags set",p.mode=BAD;break}p.head&&(p.head.text=P>>8&1),p.flags&512&&(Me[0]=P&255,Me[1]=P>>>8&255,p.check=crc32_1(p.check,Me,2,0)),P=0,O=0,p.mode=TIME;case TIME:for(;O<32;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}p.head&&(p.head.time=P),p.flags&512&&(Me[0]=P&255,Me[1]=P>>>8&255,Me[2]=P>>>16&255,Me[3]=P>>>24&255,p.check=crc32_1(p.check,Me,4,0)),P=0,O=0,p.mode=OS;case OS:for(;O<16;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}p.head&&(p.head.xflags=P&255,p.head.os=P>>8),p.flags&512&&(Me[0]=P&255,Me[1]=P>>>8&255,p.check=crc32_1(p.check,Me,2,0)),P=0,O=0,p.mode=EXLEN;case EXLEN:if(p.flags&1024){for(;O<16;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}p.length=P,p.head&&(p.head.extra_len=P),p.flags&512&&(Me[0]=P&255,Me[1]=P>>>8&255,p.check=crc32_1(p.check,Me,2,0)),P=0,O=0}else p.head&&(p.head.extra=null);p.mode=EXTRA;case EXTRA:if(p.flags&1024&&(j=p.length,j>x&&(j=x),j&&(p.head&&(xe=p.head.extra_len-p.length,p.head.extra||(p.head.extra=new Uint8Array(p.head.extra_len)),p.head.extra.set(m.subarray(T,T+j),xe)),p.flags&512&&(p.check=crc32_1(p.check,m,j,T)),x-=j,T+=j,p.length-=j),p.length))break e;p.length=0,p.mode=NAME;case NAME:if(p.flags&2048){if(x===0)break e;j=0;do xe=m[T+j++],p.head&&xe&&p.length<65536&&(p.head.name+=String.fromCharCode(xe));while(xe&&j<x);if(p.flags&512&&(p.check=crc32_1(p.check,m,j,T)),x-=j,T+=j,xe)break e}else p.head&&(p.head.name=null);p.length=0,p.mode=COMMENT;case COMMENT:if(p.flags&4096){if(x===0)break e;j=0;do xe=m[T+j++],p.head&&xe&&p.length<65536&&(p.head.comment+=String.fromCharCode(xe));while(xe&&j<x);if(p.flags&512&&(p.check=crc32_1(p.check,m,j,T)),x-=j,T+=j,xe)break e}else p.head&&(p.head.comment=null);p.mode=HCRC;case HCRC:if(p.flags&512){for(;O<16;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if(P!==(p.check&65535)){d.msg="header crc mismatch",p.mode=BAD;break}P=0,O=0}p.head&&(p.head.hcrc=p.flags>>9&1,p.head.done=!0),d.adler=p.check=0,p.mode=TYPE;break;case DICTID:for(;O<32;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}d.adler=p.check=zswap32(P),P=0,O=0,p.mode=DICT;case DICT:if(p.havedict===0)return d.next_out=k,d.avail_out=B,d.next_in=T,d.avail_in=x,p.hold=P,p.bits=O,Z_NEED_DICT$1;d.adler=p.check=1,p.mode=TYPE;case TYPE:if(h===Z_BLOCK||h===Z_TREES)break e;case TYPEDO:if(p.last){P>>>=O&7,O-=O&7,p.mode=CHECK;break}for(;O<3;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}switch(p.last=P&1,P>>>=1,O-=1,P&3){case 0:p.mode=STORED;break;case 1:if(fixedtables(p),p.mode=LEN_,h===Z_TREES){P>>>=2,O-=2;break e}break;case 2:p.mode=TABLE;break;case 3:d.msg="invalid block type",p.mode=BAD}P>>>=2,O-=2;break;case STORED:for(P>>>=O&7,O-=O&7;O<32;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if((P&65535)!==(P>>>16^65535)){d.msg="invalid stored block lengths",p.mode=BAD;break}if(p.length=P&65535,P=0,O=0,p.mode=COPY_,h===Z_TREES)break e;case COPY_:p.mode=COPY;case COPY:if(j=p.length,j){if(j>x&&(j=x),j>B&&(j=B),j===0)break e;w.set(m.subarray(T,T+j),k),x-=j,T+=j,B-=j,k+=j,p.length-=j;break}p.mode=TYPE;break;case TABLE:for(;O<14;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if(p.nlen=(P&31)+257,P>>>=5,O-=5,p.ndist=(P&31)+1,P>>>=5,O-=5,p.ncode=(P&15)+4,P>>>=4,O-=4,p.nlen>286||p.ndist>30){d.msg="too many length or distance symbols",p.mode=BAD;break}p.have=0,p.mode=LENLENS;case LENLENS:for(;p.have<p.ncode;){for(;O<3;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}p.lens[Le[p.have++]]=P&7,P>>>=3,O-=3}for(;p.have<19;)p.lens[Le[p.have++]]=0;if(p.lencode=p.lendyn,p.lenbits=7,he={bits:p.lenbits},ue=inftrees(CODES,p.lens,0,19,p.lencode,0,p.work,he),p.lenbits=he.bits,ue){d.msg="invalid code lengths set",p.mode=BAD;break}p.have=0,p.mode=CODELENS;case CODELENS:for(;p.have<p.nlen+p.ndist;){for(;oe=p.lencode[P&(1<<p.lenbits)-1],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(Q<=O);){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if(se<16)P>>>=Q,O-=Q,p.lens[p.have++]=se;else{if(se===16){for(ge=Q+2;O<ge;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if(P>>>=Q,O-=Q,p.have===0){d.msg="invalid bit length repeat",p.mode=BAD;break}xe=p.lens[p.have-1],j=3+(P&3),P>>>=2,O-=2}else if(se===17){for(ge=Q+3;O<ge;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}P>>>=Q,O-=Q,xe=0,j=3+(P&7),P>>>=3,O-=3}else{for(ge=Q+7;O<ge;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}P>>>=Q,O-=Q,xe=0,j=11+(P&127),P>>>=7,O-=7}if(p.have+j>p.nlen+p.ndist){d.msg="invalid bit length repeat",p.mode=BAD;break}for(;j--;)p.lens[p.have++]=xe}}if(p.mode===BAD)break;if(p.lens[256]===0){d.msg="invalid code -- missing end-of-block",p.mode=BAD;break}if(p.lenbits=9,he={bits:p.lenbits},ue=inftrees(LENS,p.lens,0,p.nlen,p.lencode,0,p.work,he),p.lenbits=he.bits,ue){d.msg="invalid literal/lengths set",p.mode=BAD;break}if(p.distbits=6,p.distcode=p.distdyn,he={bits:p.distbits},ue=inftrees(DISTS,p.lens,p.nlen,p.ndist,p.distcode,0,p.work,he),p.distbits=he.bits,ue){d.msg="invalid distances set",p.mode=BAD;break}if(p.mode=LEN_,h===Z_TREES)break e;case LEN_:p.mode=LEN;case LEN:if(x>=6&&B>=258){d.next_out=k,d.avail_out=B,d.next_in=T,d.avail_in=x,p.hold=P,p.bits=O,inffast(d,G),k=d.next_out,w=d.output,B=d.avail_out,T=d.next_in,m=d.input,x=d.avail_in,P=p.hold,O=p.bits,p.mode===TYPE&&(p.back=-1);break}for(p.back=0;oe=p.lencode[P&(1<<p.lenbits)-1],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(Q<=O);){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if(_e&&(_e&240)===0){for(le=Q,me=_e,Re=se;oe=p.lencode[Re+((P&(1<<le+me)-1)>>le)],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(le+Q<=O);){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}P>>>=le,O-=le,p.back+=le}if(P>>>=Q,O-=Q,p.back+=Q,p.length=se,_e===0){p.mode=LIT;break}if(_e&32){p.back=-1,p.mode=TYPE;break}if(_e&64){d.msg="invalid literal/length code",p.mode=BAD;break}p.extra=_e&15,p.mode=LENEXT;case LENEXT:if(p.extra){for(ge=p.extra;O<ge;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}p.length+=P&(1<<p.extra)-1,P>>>=p.extra,O-=p.extra,p.back+=p.extra}p.was=p.length,p.mode=DIST;case DIST:for(;oe=p.distcode[P&(1<<p.distbits)-1],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(Q<=O);){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if((_e&240)===0){for(le=Q,me=_e,Re=se;oe=p.distcode[Re+((P&(1<<le+me)-1)>>le)],Q=oe>>>24,_e=oe>>>16&255,se=oe&65535,!(le+Q<=O);){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}P>>>=le,O-=le,p.back+=le}if(P>>>=Q,O-=Q,p.back+=Q,_e&64){d.msg="invalid distance code",p.mode=BAD;break}p.offset=se,p.extra=_e&15,p.mode=DISTEXT;case DISTEXT:if(p.extra){for(ge=p.extra;O<ge;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}p.offset+=P&(1<<p.extra)-1,P>>>=p.extra,O-=p.extra,p.back+=p.extra}if(p.offset>p.dmax){d.msg="invalid distance too far back",p.mode=BAD;break}p.mode=MATCH;case MATCH:if(B===0)break e;if(j=G-B,p.offset>j){if(j=p.offset-j,j>p.whave&&p.sane){d.msg="invalid distance too far back",p.mode=BAD;break}j>p.wnext?(j-=p.wnext,H=p.wsize-j):H=p.wnext-j,j>p.length&&(j=p.length),te=p.window}else te=w,H=k-p.offset,j=p.length;j>B&&(j=B),B-=j,p.length-=j;do w[k++]=te[H++];while(--j);p.length===0&&(p.mode=LEN);break;case LIT:if(B===0)break e;w[k++]=p.length,B--,p.mode=LEN;break;case CHECK:if(p.wrap){for(;O<32;){if(x===0)break e;x--,P|=m[T++]<<O,O+=8}if(G-=B,d.total_out+=G,p.total+=G,G&&(d.adler=p.check=p.flags?crc32_1(p.check,w,G,k-G):adler32_1(p.check,w,G,k-G)),G=B,(p.flags?P:zswap32(P))!==p.check){d.msg="incorrect data check",p.mode=BAD;break}P=0,O=0}p.mode=LENGTH;case LENGTH:if(p.wrap&&p.flags){for(;O<32;){if(x===0)break e;x--,P+=m[T++]<<O,O+=8}if(P!==(p.total&4294967295)){d.msg="incorrect length check",p.mode=BAD;break}P=0,O=0}p.mode=DONE;case DONE:ue=Z_STREAM_END$1;break e;case BAD:ue=Z_DATA_ERROR$1;break e;case MEM:return Z_MEM_ERROR$1;case SYNC:default:return Z_STREAM_ERROR$1}return d.next_out=k,d.avail_out=B,d.next_in=T,d.avail_in=x,p.hold=P,p.bits=O,(p.wsize||G!==d.avail_out&&p.mode<BAD&&(p.mode<CHECK||h!==Z_FINISH$1))&&updatewindow(d,d.output,d.next_out,G-d.avail_out),U-=d.avail_in,G-=d.avail_out,d.total_in+=U,d.total_out+=G,p.total+=G,p.wrap&&G&&(d.adler=p.check=p.flags?crc32_1(p.check,w,G,d.next_out-G):adler32_1(p.check,w,G,d.next_out-G)),d.data_type=p.bits+(p.last?64:0)+(p.mode===TYPE?128:0)+(p.mode===LEN_||p.mode===COPY_?256:0),(U===0&&G===0||h===Z_FINISH$1)&&ue===Z_OK$1&&(ue=Z_BUF_ERROR),ue},inflateEnd=d=>{if(!d||!d.state)return Z_STREAM_ERROR$1;let h=d.state;return h.window&&(h.window=null),d.state=null,Z_OK$1},inflateGetHeader=(d,h)=>{if(!d||!d.state)return Z_STREAM_ERROR$1;const p=d.state;return(p.wrap&2)===0?Z_STREAM_ERROR$1:(p.head=h,h.done=!1,Z_OK$1)},inflateSetDictionary=(d,h)=>{const p=h.length;let m,w,T;return!d||!d.state||(m=d.state,m.wrap!==0&&m.mode!==DICT)?Z_STREAM_ERROR$1:m.mode===DICT&&(w=1,w=adler32_1(w,h,p,0),w!==m.check)?Z_DATA_ERROR$1:(T=updatewindow(d,h,p,p),T?(m.mode=MEM,Z_MEM_ERROR$1):(m.havedict=1,Z_OK$1))};var inflateReset_1=inflateReset,inflateReset2_1=inflateReset2,inflateResetKeep_1=inflateResetKeep,inflateInit_1=inflateInit,inflateInit2_1=inflateInit2,inflate_2$1=inflate$2,inflateEnd_1=inflateEnd,inflateGetHeader_1=inflateGetHeader,inflateSetDictionary_1=inflateSetDictionary,inflateInfo="pako inflate (from Nodeca project)",inflate_1$2={inflateReset:inflateReset_1,inflateReset2:inflateReset2_1,inflateResetKeep:inflateResetKeep_1,inflateInit:inflateInit_1,inflateInit2:inflateInit2_1,inflate:inflate_2$1,inflateEnd:inflateEnd_1,inflateGetHeader:inflateGetHeader_1,inflateSetDictionary:inflateSetDictionary_1,inflateInfo};function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var gzheader=GZheader;const toString$3=Object.prototype.toString,{Z_NO_FLUSH,Z_FINISH,Z_OK,Z_STREAM_END,Z_NEED_DICT,Z_STREAM_ERROR,Z_DATA_ERROR,Z_MEM_ERROR}=constants$2$1;function Inflate$1(d){this.options=common.assign({chunkSize:1024*64,windowBits:15,to:""},d||{});const h=this.options;h.raw&&h.windowBits>=0&&h.windowBits<16&&(h.windowBits=-h.windowBits,h.windowBits===0&&(h.windowBits=-15)),h.windowBits>=0&&h.windowBits<16&&!(d&&d.windowBits)&&(h.windowBits+=32),h.windowBits>15&&h.windowBits<48&&(h.windowBits&15)===0&&(h.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let p=inflate_1$2.inflateInit2(this.strm,h.windowBits);if(p!==Z_OK)throw new Error(messages[p]);if(this.header=new gzheader,inflate_1$2.inflateGetHeader(this.strm,this.header),h.dictionary&&(typeof h.dictionary=="string"?h.dictionary=strings.string2buf(h.dictionary):toString$3.call(h.dictionary)==="[object ArrayBuffer]"&&(h.dictionary=new Uint8Array(h.dictionary)),h.raw&&(p=inflate_1$2.inflateSetDictionary(this.strm,h.dictionary),p!==Z_OK)))throw new Error(messages[p])}Inflate$1.prototype.push=function(d,h){const p=this.strm,m=this.options.chunkSize,w=this.options.dictionary;let T,k,x;if(this.ended)return!1;for(h===~~h?k=h:k=h===!0?Z_FINISH:Z_NO_FLUSH,toString$3.call(d)==="[object ArrayBuffer]"?p.input=new Uint8Array(d):p.input=d,p.next_in=0,p.avail_in=p.input.length;;){for(p.avail_out===0&&(p.output=new Uint8Array(m),p.next_out=0,p.avail_out=m),T=inflate_1$2.inflate(p,k),T===Z_NEED_DICT&&w&&(T=inflate_1$2.inflateSetDictionary(p,w),T===Z_OK?T=inflate_1$2.inflate(p,k):T===Z_DATA_ERROR&&(T=Z_NEED_DICT));p.avail_in>0&&T===Z_STREAM_END&&p.state.wrap>0&&d[p.next_in]!==0;)inflate_1$2.inflateReset(p),T=inflate_1$2.inflate(p,k);switch(T){case Z_STREAM_ERROR:case Z_DATA_ERROR:case Z_NEED_DICT:case Z_MEM_ERROR:return this.onEnd(T),this.ended=!0,!1}if(x=p.avail_out,p.next_out&&(p.avail_out===0||T===Z_STREAM_END))if(this.options.to==="string"){let B=strings.utf8border(p.output,p.next_out),P=p.next_out-B,O=strings.buf2string(p.output,B);p.next_out=P,p.avail_out=m-P,P&&p.output.set(p.output.subarray(B,B+P),0),this.onData(O)}else this.onData(p.output.length===p.next_out?p.output:p.output.subarray(0,p.next_out));if(!(T===Z_OK&&x===0)){if(T===Z_STREAM_END)return T=inflate_1$2.inflateEnd(this.strm),this.onEnd(T),this.ended=!0,!0;if(p.avail_in===0)break}}return!0};Inflate$1.prototype.onData=function(d){this.chunks.push(d)};Inflate$1.prototype.onEnd=function(d){d===Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=d,this.msg=this.strm.msg};function inflate$1(d,h){const p=new Inflate$1(h);if(p.push(d),p.err)throw p.msg||messages[p.err];return p.result}function inflateRaw$1(d,h){return h=h||{},h.raw=!0,inflate$1(d,h)}var Inflate_1$1=Inflate$1,inflate_2=inflate$1,inflateRaw_1$1=inflateRaw$1,ungzip$1=inflate$1,constants$5=constants$2$1,inflate_1$1={Inflate:Inflate_1$1,inflate:inflate_2,inflateRaw:inflateRaw_1$1,ungzip:ungzip$1,constants:constants$5};const{Deflate,deflate,deflateRaw,gzip}=deflate_1$1,{Inflate,inflate,inflateRaw,ungzip}=inflate_1$1;var deflate_1=deflate,Inflate_1=Inflate,inflate_1=inflate;const pngSignature=[137,80,78,71,13,10,26,10],crcTable=[];for(let d=0;d<256;d++){let h=d;for(let p=0;p<8;p++)h&1?h=3988292384^h>>>1:h=h>>>1;crcTable[d]=h}const initialCrc=4294967295;function updateCrc(d,h,p){let m=d;for(let w=0;w<p;w++)m=crcTable[(m^h[w])&255]^m>>>8;return m}function crc(d,h){return(updateCrc(initialCrc,d,h)^initialCrc)>>>0}var ColorType;(function(d){d[d.UNKNOWN=-1]="UNKNOWN",d[d.GREYSCALE=0]="GREYSCALE",d[d.TRUECOLOUR=2]="TRUECOLOUR",d[d.INDEXED_COLOUR=3]="INDEXED_COLOUR",d[d.GREYSCALE_ALPHA=4]="GREYSCALE_ALPHA",d[d.TRUECOLOUR_ALPHA=6]="TRUECOLOUR_ALPHA"})(ColorType||(ColorType={}));var CompressionMethod;(function(d){d[d.UNKNOWN=-1]="UNKNOWN",d[d.DEFLATE=0]="DEFLATE"})(CompressionMethod||(CompressionMethod={}));var FilterMethod;(function(d){d[d.UNKNOWN=-1]="UNKNOWN",d[d.ADAPTIVE=0]="ADAPTIVE"})(FilterMethod||(FilterMethod={}));var InterlaceMethod;(function(d){d[d.UNKNOWN=-1]="UNKNOWN",d[d.NO_INTERLACE=0]="NO_INTERLACE",d[d.ADAM7=1]="ADAM7"})(InterlaceMethod||(InterlaceMethod={}));const empty=new Uint8Array(0),NULL="\0",uint16=new Uint16Array([255]),uint8=new Uint8Array(uint16.buffer),osIsLittleEndian=uint8[0]===255;class PngDecoder extends IOBuffer$4{constructor(h,p={}){super(h);const{checkCrc:m=!1}=p;this._checkCrc=m,this._inflator=new Inflate_1,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._end=!1,this._hasPalette=!1,this._palette=[],this._compressionMethod=CompressionMethod.UNKNOWN,this._filterMethod=FilterMethod.UNKNOWN,this._interlaceMethod=InterlaceMethod.UNKNOWN,this._colorType=-1,this.setBigEndian()}decode(){for(this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(let h=0;h<pngSignature.length;h++)if(this.readUint8()!==pngSignature[h])throw new Error(`wrong PNG signature. Byte at ${h} should be ${pngSignature[h]}.`)}decodeChunk(){const h=this.readUint32(),p=this.readChars(4),m=this.offset;switch(p){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(h);break;case"IDAT":this.decodeIDAT(h);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(h);break;case"iCCP":this.decodeiCCP(h);break;case"tEXt":this.decodetEXt(h);break;case"pHYs":this.decodepHYs();break;default:this.skip(h);break}if(this.offset-m!==h)throw new Error(`Length mismatch while decoding chunk ${p}`);if(this._checkCrc){const w=this.readUint32(),T=h+4,k=crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-T-4,T),T);if(k!==w)throw new Error(`CRC mismatch for chunk ${p}. Expected ${w}, found ${k}`)}else this.skip(4)}decodeIHDR(){const h=this._png;h.width=this.readUint32(),h.height=this.readUint32(),h.depth=checkBitDepth(this.readUint8());const p=this.readUint8();this._colorType=p;let m;switch(p){case ColorType.GREYSCALE:m=1;break;case ColorType.TRUECOLOUR:m=3;break;case ColorType.INDEXED_COLOUR:m=1;break;case ColorType.GREYSCALE_ALPHA:m=2;break;case ColorType.TRUECOLOUR_ALPHA:m=4;break;default:throw new Error(`Unknown color type: ${p}`)}if(this._png.channels=m,this._compressionMethod=this.readUint8(),this._compressionMethod!==CompressionMethod.DEFLATE)throw new Error(`Unsupported compression method: ${this._compressionMethod}`);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodePLTE(h){if(h%3!==0)throw new RangeError(`PLTE field length must be a multiple of 3. Got ${h}`);const p=h/3;this._hasPalette=!0;const m=[];this._palette=m;for(let w=0;w<p;w++)m.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(h){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,h)),this.skip(h)}decodetRNS(h){if(this._colorType===3){if(h>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${h} vs ${this._palette.length})`);let p=0;for(;p<h;p++){const m=this.readByte();this._palette[p].push(m)}for(;p<this._palette.length;p++)this._palette[p].push(255)}}decodeiCCP(h){let p="",m;for(;(m=this.readChar())!==NULL;)p+=m;const w=this.readUint8();if(w!==CompressionMethod.DEFLATE)throw new Error(`Unsupported iCCP compression method: ${w}`);const T=this.readBytes(h-p.length-2);this._png.iccEmbeddedProfile={name:p,profile:inflate_1(T)}}decodetEXt(h){let p="",m;for(;(m=this.readChar())!==NULL;)p+=m;this._png.text[p]=this.readChars(h-p.length-1)}decodepHYs(){const h=this.readUint32(),p=this.readUint32(),m=this.readByte();this._png.resolution={x:h,y:p,unit:m}}decodeImage(){if(this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);const h=this._inflator.result;if(this._filterMethod!==FilterMethod.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod===InterlaceMethod.NO_INTERLACE)this.decodeInterlaceNull(h);else throw new Error(`Interlace method ${this._interlaceMethod} not supported`)}decodeInterlaceNull(h){const p=this._png.height,m=this._png.channels*this._png.depth/8,w=this._png.width*m,T=new Uint8Array(this._png.height*w);let k=empty,x=0,B,P;for(let O=0;O<p;O++){switch(B=h.subarray(x+1,x+1+w),P=T.subarray(O*w,(O+1)*w),h[x]){case 0:unfilterNone(B,P,w);break;case 1:unfilterSub(B,P,w,m);break;case 2:unfilterUp(B,P,k,w);break;case 3:unfilterAverage(B,P,k,w,m);break;case 4:unfilterPaeth(B,P,k,w,m);break;default:throw new Error(`Unsupported filter: ${h[x]}`)}k=P,x+=w+1}if(this._hasPalette&&(this._png.palette=this._palette),this._png.depth===16){const O=new Uint16Array(T.buffer);if(osIsLittleEndian)for(let U=0;U<O.length;U++)O[U]=swap16(O[U]);this._png.data=O}else this._png.data=T}}function unfilterNone(d,h,p){for(let m=0;m<p;m++)h[m]=d[m]}function unfilterSub(d,h,p,m){let w=0;for(;w<m;w++)h[w]=d[w];for(;w<p;w++)h[w]=d[w]+h[w-m]&255}function unfilterUp(d,h,p,m){let w=0;if(p.length===0)for(;w<m;w++)h[w]=d[w];else for(;w<m;w++)h[w]=d[w]+p[w]&255}function unfilterAverage(d,h,p,m,w){let T=0;if(p.length===0){for(;T<w;T++)h[T]=d[T];for(;T<m;T++)h[T]=d[T]+(h[T-w]>>1)&255}else{for(;T<w;T++)h[T]=d[T]+(p[T]>>1)&255;for(;T<m;T++)h[T]=d[T]+(h[T-w]+p[T]>>1)&255}}function unfilterPaeth(d,h,p,m,w){let T=0;if(p.length===0){for(;T<w;T++)h[T]=d[T];for(;T<m;T++)h[T]=d[T]+h[T-w]&255}else{for(;T<w;T++)h[T]=d[T]+p[T]&255;for(;T<m;T++)h[T]=d[T]+paethPredictor(h[T-w],p[T],p[T-w])&255}}function paethPredictor(d,h,p){const m=d+h-p,w=Math.abs(m-d),T=Math.abs(m-h),k=Math.abs(m-p);return w<=T&&w<=k?d:T<=k?h:p}function swap16(d){return(d&255)<<8|d>>8&255}function checkBitDepth(d){if(d!==1&&d!==2&&d!==4&&d!==8&&d!==16)throw new Error(`invalid bit depth: ${d}`);return d}const defaultZlibOptions={level:3};class PngEncoder extends IOBuffer$4{constructor(h,p={}){super();this._colorType=ColorType.UNKNOWN,this._zlibOptions=Object.assign({},defaultZlibOptions,p.zlib),this._png=this._checkData(h),this.setBigEndian()}encode(){return this.encodeSignature(),this.encodeIHDR(),this.encodeData(),this.encodeIEND(),this.toArray()}encodeSignature(){this.writeBytes(pngSignature)}encodeIHDR(){this.writeUint32(13),this.writeChars("IHDR"),this.writeUint32(this._png.width),this.writeUint32(this._png.height),this.writeByte(this._png.depth),this.writeByte(this._colorType),this.writeByte(CompressionMethod.DEFLATE),this.writeByte(FilterMethod.ADAPTIVE),this.writeByte(InterlaceMethod.NO_INTERLACE),this.writeCrc(17)}encodeIEND(){this.writeUint32(0),this.writeChars("IEND"),this.writeCrc(4)}encodeIDAT(h){this.writeUint32(h.length),this.writeChars("IDAT"),this.writeBytes(h),this.writeCrc(h.length+4)}encodeData(){const{width:h,height:p,channels:m,depth:w,data:T}=this._png,k=m*h,x=new IOBuffer$4().setBigEndian();let B=0;for(let U=0;U<p;U++)if(x.writeByte(0),w===8)B=writeDataBytes(T,x,k,B);else if(w===16)B=writeDataUint16(T,x,k,B);else throw new Error("unreachable");const P=x.toArray(),O=deflate_1(P,this._zlibOptions);this.encodeIDAT(O)}_checkData(h){const{colorType:p,channels:m,depth:w}=getColorType(h),T={width:checkInteger(h.width,"width"),height:checkInteger(h.height,"height"),channels:m,data:h.data,depth:w,text:{}};this._colorType=p;const k=T.width*T.height*m;if(T.data.length!==k)throw new RangeError(`wrong data size. Found ${T.data.length}, expected ${k}`);return T}writeCrc(h){this.writeUint32(crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-h,h),h))}}function checkInteger(d,h){if(Number.isInteger(d)&&d>0)return d;throw new TypeError(`${h} must be a positive integer`)}function getColorType(d){const{channels:h=4,depth:p=8}=d;if(h!==4&&h!==3&&h!==2&&h!==1)throw new RangeError(`unsupported number of channels: ${h}`);if(p!==8&&p!==16)throw new RangeError(`unsupported bit depth: ${p}`);const m={channels:h,depth:p,colorType:ColorType.UNKNOWN};switch(h){case 4:m.colorType=ColorType.TRUECOLOUR_ALPHA;break;case 3:m.colorType=ColorType.TRUECOLOUR;break;case 1:m.colorType=ColorType.GREYSCALE;break;case 2:m.colorType=ColorType.GREYSCALE_ALPHA;break;default:throw new Error("unsupported number of channels")}return m}function writeDataBytes(d,h,p,m){for(let w=0;w<p;w++)h.writeByte(d[m++]);return m}function writeDataUint16(d,h,p,m){for(let w=0;w<p;w++)h.writeUint16(d[m++]);return m}var ResolutionUnitSpecifier;(function(d){d[d.UNKNOWN=0]="UNKNOWN",d[d.METRE=1]="METRE"})(ResolutionUnitSpecifier||(ResolutionUnitSpecifier={}));function decodePng(d,h){return new PngDecoder(d,h).decode()}function encodePng$1(d,h){return new PngEncoder(d,h).encode()}var encoder$1={exports:{}};(function(d){function h(m){var w=Math.floor,T=new Array(64),k=new Array(64),x=new Array(64),B=new Array(64),P,O,U,G,j=new Array(65535),H=new Array(65535),te=new Array(64),oe=new Array(64),Q=[],_e=0,se=7,le=new Array(64),me=new Array(64),Re=new Array(64),xe=new Array(256),ue=new Array(2048),Me,he=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],ge=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],Le=[0,1,2,3,4,5,6,7,8,9,10,11],Ze=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],st=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],ht=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],Rt=[0,1,2,3,4,5,6,7,8,9,10,11],Bt=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],At=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function Nt(He){for(var Ht=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],Pt=0;Pt<64;Pt++){var ei=w((Ht[Pt]*He+50)/100);ei<1?ei=1:ei>255&&(ei=255),T[he[Pt]]=ei}for(var ri=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],vt=0;vt<64;vt++){var Di=w((ri[vt]*He+50)/100);Di<1?Di=1:Di>255&&(Di=255),k[he[vt]]=Di}for(var Wt=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],Gt=0,qt=0;qt<8;qt++)for(var It=0;It<8;It++)x[Gt]=1/(T[he[Gt]]*Wt[qt]*Wt[It]*8),B[Gt]=1/(k[he[Gt]]*Wt[qt]*Wt[It]*8),Gt++}function zt(He,Ht){for(var Pt=0,ei=0,ri=new Array,vt=1;vt<=16;vt++){for(var Di=1;Di<=He[vt];Di++)ri[Ht[ei]]=[],ri[Ht[ei]][0]=Pt,ri[Ht[ei]][1]=vt,ei++,Pt++;Pt*=2}return ri}function Tt(){P=zt(ge,Le),O=zt(ht,Rt),U=zt(Ze,st),G=zt(Bt,At)}function ii(){for(var He=1,Ht=2,Pt=1;Pt<=15;Pt++){for(var ei=He;ei<Ht;ei++)H[32767+ei]=Pt,j[32767+ei]=[],j[32767+ei][1]=Pt,j[32767+ei][0]=ei;for(var ri=-(Ht-1);ri<=-He;ri++)H[32767+ri]=Pt,j[32767+ri]=[],j[32767+ri][1]=Pt,j[32767+ri][0]=Ht-1+ri;He<<=1,Ht<<=1}}function Mt(){for(var He=0;He<256;He++)ue[He]=19595*He,ue[He+256>>0]=38470*He,ue[He+512>>0]=7471*He+32768,ue[He+768>>0]=-11059*He,ue[He+1024>>0]=-21709*He,ue[He+1280>>0]=32768*He+8421375,ue[He+1536>>0]=-27439*He,ue[He+1792>>0]=-5329*He}function St(He){for(var Ht=He[0],Pt=He[1]-1;Pt>=0;)Ht&1<<Pt&&(_e|=1<<se),Pt--,se--,se<0&&(_e==255?(wt(255),wt(0)):wt(_e),se=7,_e=0)}function wt(He){Q.push(He)}function Ut(He){wt(He>>8&255),wt(He&255)}function Vt(He,Ht){var Pt,ei,ri,vt,Di,Wt,Gt,qt,It=0,hi,xi=8,Ei=64;for(hi=0;hi<xi;++hi){Pt=He[It],ei=He[It+1],ri=He[It+2],vt=He[It+3],Di=He[It+4],Wt=He[It+5],Gt=He[It+6],qt=He[It+7];var Qt=Pt+qt,ai=Pt-qt,$i=ei+Gt,Si=ei-Gt,Zi=ri+Wt,Ai=ri-Wt,dr=vt+Di,on=vt-Di,fr=Qt+dr,Rr=Qt-dr,Br=$i+Zi,Er=$i-Zi;He[It]=fr+Br,He[It+4]=fr-Br;var vr=(Er+Rr)*.707106781;He[It+2]=Rr+vr,He[It+6]=Rr-vr,fr=on+Ai,Br=Ai+Si,Er=Si+ai;var $r=(fr-Er)*.382683433,Mr=.5411961*fr+$r,Te=1.306562965*Er+$r,je=Br*.707106781,ae=ai+je,K=ai-je;He[It+5]=K+Mr,He[It+3]=K-Mr,He[It+1]=ae+Te,He[It+7]=ae-Te,It+=8}for(It=0,hi=0;hi<xi;++hi){Pt=He[It],ei=He[It+8],ri=He[It+16],vt=He[It+24],Di=He[It+32],Wt=He[It+40],Gt=He[It+48],qt=He[It+56];var re=Pt+qt,de=Pt-qt,Se=ei+Gt,De=ei-Gt,Ue=ri+Wt,Ne=ri-Wt,Oe=vt+Di,qe=vt-Di,Je=re+Oe,Qe=re-Oe,at=Se+Ue,kt=Se-Ue;He[It]=Je+at,He[It+32]=Je-at;var jt=(kt+Qe)*.707106781;He[It+16]=Qe+jt,He[It+48]=Qe-jt,Je=qe+Ne,at=Ne+De,kt=De+de;var Zt=(Je-kt)*.382683433,Yt=.5411961*Je+Zt,mi=1.306562965*kt+Zt,Xi=at*.707106781,Ki=de+Xi,Gi=de-Xi;He[It+40]=Gi+Yt,He[It+24]=Gi-Yt,He[It+8]=Ki+mi,He[It+56]=Ki-mi,It++}var Yi;for(hi=0;hi<Ei;++hi)Yi=He[hi]*Ht[hi],te[hi]=Yi>0?Yi+.5|0:Yi-.5|0;return te}function pi(){Ut(65504),Ut(16),wt(74),wt(70),wt(73),wt(70),wt(0),wt(1),wt(1),wt(0),Ut(1),Ut(1),wt(0),wt(0)}function ni(He){if(!!He){Ut(65505),He[0]===69&&He[1]===120&&He[2]===105&&He[3]===102?Ut(He.length+2):(Ut(He.length+5+2),wt(69),wt(120),wt(105),wt(102),wt(0));for(var Ht=0;Ht<He.length;Ht++)wt(He[Ht])}}function _i(He,Ht){Ut(65472),Ut(17),wt(8),Ut(Ht),Ut(He),wt(3),wt(1),wt(17),wt(0),wt(2),wt(17),wt(1),wt(3),wt(17),wt(1)}function yi(){Ut(65499),Ut(132),wt(0);for(var He=0;He<64;He++)wt(T[He]);wt(1);for(var Ht=0;Ht<64;Ht++)wt(k[Ht])}function Ri(){Ut(65476),Ut(418),wt(0);for(var He=0;He<16;He++)wt(ge[He+1]);for(var Ht=0;Ht<=11;Ht++)wt(Le[Ht]);wt(16);for(var Pt=0;Pt<16;Pt++)wt(Ze[Pt+1]);for(var ei=0;ei<=161;ei++)wt(st[ei]);wt(1);for(var ri=0;ri<16;ri++)wt(ht[ri+1]);for(var vt=0;vt<=11;vt++)wt(Rt[vt]);wt(17);for(var Di=0;Di<16;Di++)wt(Bt[Di+1]);for(var Wt=0;Wt<=161;Wt++)wt(At[Wt])}function di(){Ut(65498),Ut(12),wt(3),wt(1),wt(0),wt(2),wt(17),wt(3),wt(17),wt(0),wt(63),wt(0)}function pt(He,Ht,Pt,ei,ri){for(var vt=ri[0],Di=ri[240],Wt,Gt=16,qt=63,It=64,hi=Vt(He,Ht),xi=0;xi<It;++xi)oe[he[xi]]=hi[xi];var Ei=oe[0]-Pt;Pt=oe[0],Ei==0?St(ei[0]):(Wt=32767+Ei,St(ei[H[Wt]]),St(j[Wt]));for(var Qt=63;Qt>0&&oe[Qt]==0;Qt--);if(Qt==0)return St(vt),Pt;for(var ai=1,$i;ai<=Qt;){for(var Si=ai;oe[ai]==0&&ai<=Qt;++ai);var Zi=ai-Si;if(Zi>=Gt){$i=Zi>>4;for(var Ai=1;Ai<=$i;++Ai)St(Di);Zi=Zi&15}Wt=32767+oe[ai],St(ri[(Zi<<4)+H[Wt]]),St(j[Wt]),ai++}return Qt!=qt&&St(vt),Pt}function xt(){for(var He=String.fromCharCode,Ht=0;Ht<256;Ht++)xe[Ht]=He(Ht)}this.encode=function(He,Ht){new Date().getTime(),Ht&&fi(Ht),Q=new Array,_e=0,se=7,Ut(65496),pi(),ni(He.exifBuffer),yi(),_i(He.width,He.height),Ri(),di();var Pt=0,ei=0,ri=0;_e=0,se=7,this.encode.displayName="_encode_";for(var vt=He.data,Di=He.width,Wt=He.height,Gt=Di*4,qt,It=0,hi,xi,Ei,Qt,ai,$i,Si,Zi;It<Wt;){for(qt=0;qt<Gt;){for(Qt=Gt*It+qt,ai=Qt,$i=-1,Si=0,Zi=0;Zi<64;Zi++)Si=Zi>>3,$i=(Zi&7)*4,ai=Qt+Si*Gt+$i,It+Si>=Wt&&(ai-=Gt*(It+1+Si-Wt)),qt+$i>=Gt&&(ai-=qt+$i-Gt+4),hi=vt[ai++],xi=vt[ai++],Ei=vt[ai++],le[Zi]=(ue[hi]+ue[xi+256>>0]+ue[Ei+512>>0]>>16)-128,me[Zi]=(ue[hi+768>>0]+ue[xi+1024>>0]+ue[Ei+1280>>0]>>16)-128,Re[Zi]=(ue[hi+1280>>0]+ue[xi+1536>>0]+ue[Ei+1792>>0]>>16)-128;Pt=pt(le,x,Pt,P,U),ei=pt(me,B,ei,O,G),ri=pt(Re,B,ri,O,G),qt+=32}It+=8}if(se>=0){var Ai=[];Ai[1]=se+1,Ai[0]=(1<<se+1)-1,St(Ai)}return Ut(65497),Buffer.from(Q)};function fi(He){if(He<=0&&(He=1),He>100&&(He=100),Me!=He){var Ht=0;He<50?Ht=Math.floor(5e3/He):Ht=Math.floor(200-He*2),Nt(Ht),Me=He}}function oi(){var He=new Date().getTime();m||(m=50),xt(),Tt(),ii(),Mt(),fi(m),new Date().getTime()-He}oi()}d.exports=p;function p(m,w){typeof w=="undefined"&&(w=50);var T=new h(w),k=T.encode(m,w);return{data:k,width:m.width,height:m.height}}})(encoder$1);var decoder$1={exports:{}};(function(d){var h=function(){var w=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),T=4017,k=799,x=3406,B=2276,P=1567,O=3784,U=5793,G=2896;function j(){}function H(me,Re){for(var xe=0,ue=[],Me,he,ge=16;ge>0&&!me[ge-1];)ge--;ue.push({children:[],index:0});var Le=ue[0],Ze;for(Me=0;Me<ge;Me++){for(he=0;he<me[Me];he++){for(Le=ue.pop(),Le.children[Le.index]=Re[xe];Le.index>0;){if(ue.length===0)throw new Error("Could not recreate Huffman Table");Le=ue.pop()}for(Le.index++,ue.push(Le);ue.length<=Me;)ue.push(Ze={children:[],index:0}),Le.children[Le.index]=Ze.children,Le=Ze;xe++}Me+1<ge&&(ue.push(Ze={children:[],index:0}),Le.children[Le.index]=Ze.children,Le=Ze)}return ue[0].children}function te(me,Re,xe,ue,Me,he,ge,Le,Ze,st){xe.precision,xe.samplesPerLine,xe.scanLines;var ht=xe.mcusPerLine,Rt=xe.progressive;xe.maxH,xe.maxV;var Bt=Re,At=0,Nt=0;function zt(){if(Nt>0)return Nt--,At>>Nt&1;if(At=me[Re++],At==255){var Gt=me[Re++];if(Gt)throw new Error("unexpected marker: "+(At<<8|Gt).toString(16))}return Nt=7,At>>>7}function Tt(Gt){for(var qt=Gt,It;(It=zt())!==null;){if(qt=qt[It],typeof qt=="number")return qt;if(typeof qt!="object")throw new Error("invalid huffman sequence")}return null}function ii(Gt){for(var qt=0;Gt>0;){var It=zt();if(It===null)return;qt=qt<<1|It,Gt--}return qt}function Mt(Gt){var qt=ii(Gt);return qt>=1<<Gt-1?qt:qt+(-1<<Gt)+1}function St(Gt,qt){var It=Tt(Gt.huffmanTableDC),hi=It===0?0:Mt(It);qt[0]=Gt.pred+=hi;for(var xi=1;xi<64;){var Ei=Tt(Gt.huffmanTableAC),Qt=Ei&15,ai=Ei>>4;if(Qt===0){if(ai<15)break;xi+=16;continue}xi+=ai;var $i=w[xi];qt[$i]=Mt(Qt),xi++}}function wt(Gt,qt){var It=Tt(Gt.huffmanTableDC),hi=It===0?0:Mt(It)<<Ze;qt[0]=Gt.pred+=hi}function Ut(Gt,qt){qt[0]|=zt()<<Ze}var Vt=0;function pi(Gt,qt){if(Vt>0){Vt--;return}for(var It=he,hi=ge;It<=hi;){var xi=Tt(Gt.huffmanTableAC),Ei=xi&15,Qt=xi>>4;if(Ei===0){if(Qt<15){Vt=ii(Qt)+(1<<Qt)-1;break}It+=16;continue}It+=Qt;var ai=w[It];qt[ai]=Mt(Ei)*(1<<Ze),It++}}var ni=0,_i;function yi(Gt,qt){for(var It=he,hi=ge,xi=0;It<=hi;){var Ei=w[It],Qt=qt[Ei]<0?-1:1;switch(ni){case 0:var ai=Tt(Gt.huffmanTableAC),$i=ai&15,xi=ai>>4;if($i===0)xi<15?(Vt=ii(xi)+(1<<xi),ni=4):(xi=16,ni=1);else{if($i!==1)throw new Error("invalid ACn encoding");_i=Mt($i),ni=xi?2:3}continue;case 1:case 2:qt[Ei]?qt[Ei]+=(zt()<<Ze)*Qt:(xi--,xi===0&&(ni=ni==2?3:0));break;case 3:qt[Ei]?qt[Ei]+=(zt()<<Ze)*Qt:(qt[Ei]=_i<<Ze,ni=0);break;case 4:qt[Ei]&&(qt[Ei]+=(zt()<<Ze)*Qt);break}It++}ni===4&&(Vt--,Vt===0&&(ni=0))}function Ri(Gt,qt,It,hi,xi){var Ei=It/ht|0,Qt=It%ht,ai=Ei*Gt.v+hi,$i=Qt*Gt.h+xi;Gt.blocks[ai]===void 0&&st.tolerantDecoding||qt(Gt,Gt.blocks[ai][$i])}function di(Gt,qt,It){var hi=It/Gt.blocksPerLine|0,xi=It%Gt.blocksPerLine;Gt.blocks[hi]===void 0&&st.tolerantDecoding||qt(Gt,Gt.blocks[hi][xi])}var pt=ue.length,xt,fi,oi,He,Ht,Pt;Rt?he===0?Pt=Le===0?wt:Ut:Pt=Le===0?pi:yi:Pt=St;var ei=0,ri,vt;pt==1?vt=ue[0].blocksPerLine*ue[0].blocksPerColumn:vt=ht*xe.mcusPerColumn,Me||(Me=vt);for(var Di,Wt;ei<vt;){for(fi=0;fi<pt;fi++)ue[fi].pred=0;if(Vt=0,pt==1)for(xt=ue[0],Ht=0;Ht<Me;Ht++)di(xt,Pt,ei),ei++;else for(Ht=0;Ht<Me;Ht++){for(fi=0;fi<pt;fi++)for(xt=ue[fi],Di=xt.h,Wt=xt.v,oi=0;oi<Wt;oi++)for(He=0;He<Di;He++)Ri(xt,Pt,ei,oi,He);if(ei++,ei===vt)break}if(ei===vt)do{if(me[Re]===255&&me[Re+1]!==0)break;Re+=1}while(Re<me.length-2);if(Nt=0,ri=me[Re]<<8|me[Re+1],ri<65280)throw new Error("marker was not found");if(ri>=65488&&ri<=65495)Re+=2;else break}return Re-Bt}function oe(me,Re){var xe=[],ue=Re.blocksPerLine,Me=Re.blocksPerColumn,he=ue<<3,ge=new Int32Array(64),Le=new Uint8Array(64);function Ze(ii,Mt,St){var wt=Re.quantizationTable,Ut,Vt,pi,ni,_i,yi,Ri,di,pt,xt=St,fi;for(fi=0;fi<64;fi++)xt[fi]=ii[fi]*wt[fi];for(fi=0;fi<8;++fi){var oi=8*fi;if(xt[1+oi]==0&&xt[2+oi]==0&&xt[3+oi]==0&&xt[4+oi]==0&&xt[5+oi]==0&&xt[6+oi]==0&&xt[7+oi]==0){pt=U*xt[0+oi]+512>>10,xt[0+oi]=pt,xt[1+oi]=pt,xt[2+oi]=pt,xt[3+oi]=pt,xt[4+oi]=pt,xt[5+oi]=pt,xt[6+oi]=pt,xt[7+oi]=pt;continue}Ut=U*xt[0+oi]+128>>8,Vt=U*xt[4+oi]+128>>8,pi=xt[2+oi],ni=xt[6+oi],_i=G*(xt[1+oi]-xt[7+oi])+128>>8,di=G*(xt[1+oi]+xt[7+oi])+128>>8,yi=xt[3+oi]<<4,Ri=xt[5+oi]<<4,pt=Ut-Vt+1>>1,Ut=Ut+Vt+1>>1,Vt=pt,pt=pi*O+ni*P+128>>8,pi=pi*P-ni*O+128>>8,ni=pt,pt=_i-Ri+1>>1,_i=_i+Ri+1>>1,Ri=pt,pt=di+yi+1>>1,yi=di-yi+1>>1,di=pt,pt=Ut-ni+1>>1,Ut=Ut+ni+1>>1,ni=pt,pt=Vt-pi+1>>1,Vt=Vt+pi+1>>1,pi=pt,pt=_i*B+di*x+2048>>12,_i=_i*x-di*B+2048>>12,di=pt,pt=yi*k+Ri*T+2048>>12,yi=yi*T-Ri*k+2048>>12,Ri=pt,xt[0+oi]=Ut+di,xt[7+oi]=Ut-di,xt[1+oi]=Vt+Ri,xt[6+oi]=Vt-Ri,xt[2+oi]=pi+yi,xt[5+oi]=pi-yi,xt[3+oi]=ni+_i,xt[4+oi]=ni-_i}for(fi=0;fi<8;++fi){var He=fi;if(xt[8+He]==0&&xt[16+He]==0&&xt[24+He]==0&&xt[32+He]==0&&xt[40+He]==0&&xt[48+He]==0&&xt[56+He]==0){pt=U*St[fi+0]+8192>>14,xt[0+He]=pt,xt[8+He]=pt,xt[16+He]=pt,xt[24+He]=pt,xt[32+He]=pt,xt[40+He]=pt,xt[48+He]=pt,xt[56+He]=pt;continue}Ut=U*xt[0+He]+2048>>12,Vt=U*xt[32+He]+2048>>12,pi=xt[16+He],ni=xt[48+He],_i=G*(xt[8+He]-xt[56+He])+2048>>12,di=G*(xt[8+He]+xt[56+He])+2048>>12,yi=xt[24+He],Ri=xt[40+He],pt=Ut-Vt+1>>1,Ut=Ut+Vt+1>>1,Vt=pt,pt=pi*O+ni*P+2048>>12,pi=pi*P-ni*O+2048>>12,ni=pt,pt=_i-Ri+1>>1,_i=_i+Ri+1>>1,Ri=pt,pt=di+yi+1>>1,yi=di-yi+1>>1,di=pt,pt=Ut-ni+1>>1,Ut=Ut+ni+1>>1,ni=pt,pt=Vt-pi+1>>1,Vt=Vt+pi+1>>1,pi=pt,pt=_i*B+di*x+2048>>12,_i=_i*x-di*B+2048>>12,di=pt,pt=yi*k+Ri*T+2048>>12,yi=yi*T-Ri*k+2048>>12,Ri=pt,xt[0+He]=Ut+di,xt[56+He]=Ut-di,xt[8+He]=Vt+Ri,xt[48+He]=Vt-Ri,xt[16+He]=pi+yi,xt[40+He]=pi-yi,xt[24+He]=ni+_i,xt[32+He]=ni-_i}for(fi=0;fi<64;++fi){var Ht=128+(xt[fi]+8>>4);Mt[fi]=Ht<0?0:Ht>255?255:Ht}}le(he*Me*8);for(var st,ht,Rt=0;Rt<Me;Rt++){var Bt=Rt<<3;for(st=0;st<8;st++)xe.push(new Uint8Array(he));for(var At=0;At<ue;At++){Ze(Re.blocks[Rt][At],Le,ge);var Nt=0,zt=At<<3;for(ht=0;ht<8;ht++){var Tt=xe[Bt+ht];for(st=0;st<8;st++)Tt[zt+st]=Le[Nt++]}}}return xe}function Q(me){return me<0?0:me>255?255:me}j.prototype={load:function(Re){var xe=new XMLHttpRequest;xe.open("GET",Re,!0),xe.responseType="arraybuffer",xe.onload=function(){var ue=new Uint8Array(xe.response||xe.mozResponseArrayBuffer);this.parse(ue),this.onload&&this.onload()}.bind(this),xe.send(null)},parse:function(Re){var xe=this.opts.maxResolutionInMP*1e3*1e3,ue=0;Re.length;function Me(){var Qt=Re[ue]<<8|Re[ue+1];return ue+=2,Qt}function he(){var Qt=Me(),ai=Re.subarray(ue,ue+Qt-2);return ue+=ai.length,ai}function ge(Qt){var ai=0,$i=0,Si,Zi;for(Zi in Qt.components)Qt.components.hasOwnProperty(Zi)&&(Si=Qt.components[Zi],ai<Si.h&&(ai=Si.h),$i<Si.v&&($i=Si.v));var Ai=Math.ceil(Qt.samplesPerLine/8/ai),dr=Math.ceil(Qt.scanLines/8/$i);for(Zi in Qt.components)if(Qt.components.hasOwnProperty(Zi)){Si=Qt.components[Zi];var on=Math.ceil(Math.ceil(Qt.samplesPerLine/8)*Si.h/ai),fr=Math.ceil(Math.ceil(Qt.scanLines/8)*Si.v/$i),Rr=Ai*Si.h,Br=dr*Si.v,Er=Br*Rr,vr=[];le(Er*256);for(var $r=0;$r<Br;$r++){for(var Mr=[],Te=0;Te<Rr;Te++)Mr.push(new Int32Array(64));vr.push(Mr)}Si.blocksPerLine=on,Si.blocksPerColumn=fr,Si.blocks=vr}Qt.maxH=ai,Qt.maxV=$i,Qt.mcusPerLine=Ai,Qt.mcusPerColumn=dr}var Le=null,Ze=null,st,ht,Rt=[],Bt=[],At=[],Nt=[],zt=Me(),Tt=-1;if(this.comments=[],zt!=65496)throw new Error("SOI not found");for(zt=Me();zt!=65497;){var ii,Mt;switch(zt){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var St=he();if(zt===65534){var wt=String.fromCharCode.apply(null,St);this.comments.push(wt)}zt===65504&&St[0]===74&&St[1]===70&&St[2]===73&&St[3]===70&&St[4]===0&&(Le={version:{major:St[5],minor:St[6]},densityUnits:St[7],xDensity:St[8]<<8|St[9],yDensity:St[10]<<8|St[11],thumbWidth:St[12],thumbHeight:St[13],thumbData:St.subarray(14,14+3*St[12]*St[13])}),zt===65505&&St[0]===69&&St[1]===120&&St[2]===105&&St[3]===102&&St[4]===0&&(this.exifBuffer=St.subarray(5,St.length)),zt===65518&&St[0]===65&&St[1]===100&&St[2]===111&&St[3]===98&&St[4]===101&&St[5]===0&&(Ze={version:St[6],flags0:St[7]<<8|St[8],flags1:St[9]<<8|St[10],transformCode:St[11]});break;case 65499:for(var Ut=Me(),Vt=Ut+ue-2;ue<Vt;){var pi=Re[ue++];le(256);var ni=new Int32Array(64);if(pi>>4===0)for(Mt=0;Mt<64;Mt++){var _i=w[Mt];ni[_i]=Re[ue++]}else if(pi>>4===1)for(Mt=0;Mt<64;Mt++){var _i=w[Mt];ni[_i]=Me()}else throw new Error("DQT: invalid table spec");Rt[pi&15]=ni}break;case 65472:case 65473:case 65474:Me(),st={},st.extended=zt===65473,st.progressive=zt===65474,st.precision=Re[ue++],st.scanLines=Me(),st.samplesPerLine=Me(),st.components={},st.componentsOrder=[];var yi=st.scanLines*st.samplesPerLine;if(yi>xe){var Ri=Math.ceil((yi-xe)/1e6);throw new Error(`maxResolutionInMP limit exceeded by ${Ri}MP`)}var di=Re[ue++],pt;for(ii=0;ii<di;ii++){pt=Re[ue];var xt=Re[ue+1]>>4,fi=Re[ue+1]&15,oi=Re[ue+2];st.componentsOrder.push(pt),st.components[pt]={h:xt,v:fi,quantizationIdx:oi},ue+=3}ge(st),Bt.push(st);break;case 65476:var He=Me();for(ii=2;ii<He;){var Ht=Re[ue++],Pt=new Uint8Array(16),ei=0;for(Mt=0;Mt<16;Mt++,ue++)ei+=Pt[Mt]=Re[ue];le(16+ei);var ri=new Uint8Array(ei);for(Mt=0;Mt<ei;Mt++,ue++)ri[Mt]=Re[ue];ii+=17+ei,(Ht>>4===0?Nt:At)[Ht&15]=H(Pt,ri)}break;case 65501:Me(),ht=Me();break;case 65500:Me(),Me();break;case 65498:Me();var vt=Re[ue++],Di=[],Wt;for(ii=0;ii<vt;ii++){Wt=st.components[Re[ue++]];var Gt=Re[ue++];Wt.huffmanTableDC=Nt[Gt>>4],Wt.huffmanTableAC=At[Gt&15],Di.push(Wt)}var qt=Re[ue++],It=Re[ue++],hi=Re[ue++],xi=te(Re,ue,st,Di,ht,qt,It,hi>>4,hi&15,this.opts);ue+=xi;break;case 65535:Re[ue]!==255&&ue--;break;default:if(Re[ue-3]==255&&Re[ue-2]>=192&&Re[ue-2]<=254){ue-=3;break}else if(zt===224||zt==225){if(Tt!==-1)throw new Error(`first unknown JPEG marker at offset ${Tt.toString(16)}, second unknown JPEG marker ${zt.toString(16)} at offset ${(ue-1).toString(16)}`);Tt=ue-1;const Qt=Me();if(Re[ue+Qt-2]===255){ue+=Qt-2;break}}throw new Error("unknown JPEG marker "+zt.toString(16))}zt=Me()}if(Bt.length!=1)throw new Error("only single frame JPEGs supported");for(var ii=0;ii<Bt.length;ii++){var Ei=Bt[ii].components;for(var Mt in Ei)Ei[Mt].quantizationTable=Rt[Ei[Mt].quantizationIdx],delete Ei[Mt].quantizationIdx}this.width=st.samplesPerLine,this.height=st.scanLines,this.jfif=Le,this.adobe=Ze,this.components=[];for(var ii=0;ii<st.componentsOrder.length;ii++){var Wt=st.components[st.componentsOrder[ii]];this.components.push({lines:oe(st,Wt),scaleX:Wt.h/st.maxH,scaleY:Wt.v/st.maxV})}},getData:function(Re,xe){var ue=this.width/Re,Me=this.height/xe,he,ge,Le,Ze,st,ht,Rt,Bt,At,Nt,zt=0,Tt,ii,Mt,St,wt,Ut,Vt,pi,ni,_i,yi,Ri=Re*xe*this.components.length;le(Ri);var di=new Uint8Array(Ri);switch(this.components.length){case 1:for(he=this.components[0],Nt=0;Nt<xe;Nt++)for(st=he.lines[0|Nt*he.scaleY*Me],At=0;At<Re;At++)Tt=st[0|At*he.scaleX*ue],di[zt++]=Tt;break;case 2:for(he=this.components[0],ge=this.components[1],Nt=0;Nt<xe;Nt++)for(st=he.lines[0|Nt*he.scaleY*Me],ht=ge.lines[0|Nt*ge.scaleY*Me],At=0;At<Re;At++)Tt=st[0|At*he.scaleX*ue],di[zt++]=Tt,Tt=ht[0|At*ge.scaleX*ue],di[zt++]=Tt;break;case 3:for(yi=!0,this.adobe&&this.adobe.transformCode?yi=!0:typeof this.opts.colorTransform!="undefined"&&(yi=!!this.opts.colorTransform),he=this.components[0],ge=this.components[1],Le=this.components[2],Nt=0;Nt<xe;Nt++)for(st=he.lines[0|Nt*he.scaleY*Me],ht=ge.lines[0|Nt*ge.scaleY*Me],Rt=Le.lines[0|Nt*Le.scaleY*Me],At=0;At<Re;At++)yi?(Tt=st[0|At*he.scaleX*ue],ii=ht[0|At*ge.scaleX*ue],Mt=Rt[0|At*Le.scaleX*ue],pi=Q(Tt+1.402*(Mt-128)),ni=Q(Tt-.3441363*(ii-128)-.71413636*(Mt-128)),_i=Q(Tt+1.772*(ii-128))):(pi=st[0|At*he.scaleX*ue],ni=ht[0|At*ge.scaleX*ue],_i=Rt[0|At*Le.scaleX*ue]),di[zt++]=pi,di[zt++]=ni,di[zt++]=_i;break;case 4:if(!this.adobe)throw new Error("Unsupported color mode (4 components)");for(yi=!1,this.adobe&&this.adobe.transformCode?yi=!0:typeof this.opts.colorTransform!="undefined"&&(yi=!!this.opts.colorTransform),he=this.components[0],ge=this.components[1],Le=this.components[2],Ze=this.components[3],Nt=0;Nt<xe;Nt++)for(st=he.lines[0|Nt*he.scaleY*Me],ht=ge.lines[0|Nt*ge.scaleY*Me],Rt=Le.lines[0|Nt*Le.scaleY*Me],Bt=Ze.lines[0|Nt*Ze.scaleY*Me],At=0;At<Re;At++)yi?(Tt=st[0|At*he.scaleX*ue],ii=ht[0|At*ge.scaleX*ue],Mt=Rt[0|At*Le.scaleX*ue],St=Bt[0|At*Ze.scaleX*ue],wt=255-Q(Tt+1.402*(Mt-128)),Ut=255-Q(Tt-.3441363*(ii-128)-.71413636*(Mt-128)),Vt=255-Q(Tt+1.772*(ii-128))):(wt=st[0|At*he.scaleX*ue],Ut=ht[0|At*ge.scaleX*ue],Vt=Rt[0|At*Le.scaleX*ue],St=Bt[0|At*Ze.scaleX*ue]),di[zt++]=255-wt,di[zt++]=255-Ut,di[zt++]=255-Vt,di[zt++]=255-St;break;default:throw new Error("Unsupported color mode")}return di},copyToImageData:function(Re,xe){var ue=Re.width,Me=Re.height,he=Re.data,ge=this.getData(ue,Me),Le=0,Ze=0,st,ht,Rt,Bt,At,Nt,zt,Tt,ii;switch(this.components.length){case 1:for(ht=0;ht<Me;ht++)for(st=0;st<ue;st++)Rt=ge[Le++],he[Ze++]=Rt,he[Ze++]=Rt,he[Ze++]=Rt,xe&&(he[Ze++]=255);break;case 3:for(ht=0;ht<Me;ht++)for(st=0;st<ue;st++)zt=ge[Le++],Tt=ge[Le++],ii=ge[Le++],he[Ze++]=zt,he[Ze++]=Tt,he[Ze++]=ii,xe&&(he[Ze++]=255);break;case 4:for(ht=0;ht<Me;ht++)for(st=0;st<ue;st++)At=ge[Le++],Nt=ge[Le++],Rt=ge[Le++],Bt=ge[Le++],zt=255-Q(At*(1-Bt/255)+Bt),Tt=255-Q(Nt*(1-Bt/255)+Bt),ii=255-Q(Rt*(1-Bt/255)+Bt),he[Ze++]=zt,he[Ze++]=Tt,he[Ze++]=ii,xe&&(he[Ze++]=255);break;default:throw new Error("Unsupported color mode")}}};var _e=0,se=0;function le(me=0){var Re=_e+me;if(Re>se){var xe=Math.ceil((Re-se)/1024/1024);throw new Error(`maxMemoryUsageInMB limit exceeded by at least ${xe}MB`)}_e=Re}return j.resetMaxMemoryUsage=function(me){_e=0,se=me},j.getBytesAllocated=function(){return _e},j.requestMemoryAllocation=le,j}();d.exports=p;function p(m,w={}){var T={colorTransform:void 0,useTArray:!1,formatAsRGBA:!0,tolerantDecoding:!0,maxResolutionInMP:100,maxMemoryUsageInMB:512},k=Mu(Mu({},T),w),x=new Uint8Array(m),B=new h;B.opts=k,h.resetMaxMemoryUsage(k.maxMemoryUsageInMB*1024*1024),B.parse(x);var P=k.formatAsRGBA?4:3,O=B.width*B.height*P;try{h.requestMemoryAllocation(O);var U={width:B.width,height:B.height,exifBuffer:B.exifBuffer,data:k.useTArray?new Uint8Array(O):Buffer.alloc(O)};B.comments.length>0&&(U.comments=B.comments)}catch(G){throw G instanceof RangeError?new Error("Could not allocate enough memory for the image. Required: "+O):G}return B.copyToImageData(U,k.formatAsRGBA),U}})(decoder$1);var encode$2=encoder$1.exports,decode$5=decoder$1.exports,jpegJs={encode:encode$2,decode:decode$5};let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=new Uint8Array(256);for(let d=0;d<chars.length;d++)lookup[chars.charCodeAt(d)]=d;function encode$1(d){let h,p=d.length,m="";for(h=0;h<p;h+=3)m+=chars[d[h]>>2],m+=chars[(d[h]&3)<<4|d[h+1]>>4],m+=chars[(d[h+1]&15)<<2|d[h+2]>>6],m+=chars[d[h+2]&63];return p%3===2?m=`${m.substring(0,m.length-1)}=`:p%3===1&&(m=`${m.substring(0,m.length-2)}==`),m}function decode$4(d){let h=d.length*.75,p=d.length,m=0,w,T,k,x;d[d.length-1]==="="&&(h--,d[d.length-2]==="="&&h--);const B=new Uint8Array(h);for(let P=0;P<p;P+=4)w=lookup[d.charCodeAt(P)],T=lookup[d.charCodeAt(P+1)],k=lookup[d.charCodeAt(P+2)],x=lookup[d.charCodeAt(P+3)],B[m++]=w<<2|T>>4,B[m++]=(T&15)<<4|k>>2,B[m++]=(k&3)<<6|x&63;return B}function toBase64URL(d,h){const p=encode$1(d);return`data:${h};base64,${p}`}const ImageData=self.ImageData,DOMImage=self.Image;function createCanvas(d,h){let p=self.document.createElement("canvas");return p.width=d,p.height=h,p}function fetchBinary(d,{withCredentials:h=!1}={}){return new Promise(function(p,m){let w=new self.XMLHttpRequest;w.open("GET",d,!0),w.responseType="arraybuffer",w.withCredentials=h,w.onload=function(T){this.status!==200?m(T):p(this.response)},w.onerror=m,w.send()})}function createWriteStream(){throw new Error("createWriteStream does not exist in the browser")}function writeFile(){throw new Error("writeFile does not exist in the browser")}function getType(d){return d.includes("/")||(d=`image/${d}`),d}function encodeJpeg(d,h={}){const p={width:d.width,height:d.height,data:d.getRGBAData()};return jpegJs.encode(p,h.quality).data}function encodePng(d,h){const p={width:d.width,height:d.height,channels:d.channels,depth:d.bitDepth,data:d.data};return(p.depth===1||p.depth===32)&&(p.depth=8,p.channels=4,p.data=d.getRGBAData()),encodePng$1(p,h)}const exportMethods={save(d,h={}){const{useCanvas:p=!1,encoder:m=void 0}=h;let{format:w}=h;if(!w){const T=/\.(?<format>[a-zA-Z]+)$/.exec(d);T&&(w=T.groups.format.toLowerCase())}if(!w)throw new Error("file format not provided");return new Promise((T,k)=>{let x,B;switch(w.toLowerCase()){case"png":{p?x=this.getCanvas().pngStream():B=encodePng(this,m);break}case"jpg":case"jpeg":p?x=this.getCanvas().jpegStream():B=encodeJpeg(this,m);break;case"bmp":B=encode$4(this,m);break;default:throw new RangeError(`invalid output format: ${w}`)}if(x){let P=createWriteStream();P.on("finish",T),P.on("error",k),x.pipe(P)}else B&&writeFile()})},toDataURL(d="image/png",h={}){typeof d=="object"&&(h=d,d="image/png");const{useCanvas:p=!1,encoder:m=void 0}=h;d=getType(d);function w(T,k){const x=T(k,m);return toBase64URL(x,d)}return d==="image/bmp"?w(encode$4,this):d==="image/png"&&!p?w(encodePng,this):d==="image/jpeg"&&!p?w(encodeJpeg,this):this.getCanvas().toDataURL(d)},toBuffer(d={}){const{format:h="png",encoder:p=void 0}=d;switch(h.toLowerCase()){case"png":return encodePng(this,p);case"jpeg":case"jpg":return encodeJpeg(this,p);case"bmp":return encode$4(this,p);default:throw new RangeError(`invalid output format: ${h}`)}},toBase64(d="image/png",h={}){if(h.async)return this.toDataURL(d,h).then(function(p){return p.substring(p.indexOf(",")+1)});{const p=this.toDataURL(d,h);return p.substring(p.indexOf(",")+1)}},toBlob(d="image/png",h=.8){return canvasToBlob(this.getCanvas(),d,h)},getCanvas(){const d=new ImageData(this.getRGBAData({clamped:!0}),this.width,this.height);let h=createCanvas(this.width,this.height);return h.getContext("2d").putImageData(d,0,0),h}};function setExportMethods(d){for(const h in exportMethods)d.prototype[h]=exportMethods[h]}var hasOwn$1={exports:{}};const name="has-own",version="1.0.1",description="A safer .hasOwnProperty() - hasOwn(name, obj)",main="index.js",scripts={test:"make test"},author="Aaron Heckmann <aaron.heckmann+github@gmail.com>",license="MIT",repository={type:"git",url:"git://github.com/aheckmann/has-own.git"},homepage="https://github.com/aheckmann/has-own/",devDependencies={mocha:"^6.2.2"};var require$$0$2={name,version,description,main,scripts,author,license,repository,homepage,devDependencies};(function(d,h){var p=Object.prototype.hasOwnProperty;d.exports=h=function(w,T){return p.call(T,w)},h.version=require$$0$2.version})(hasOwn$1,hasOwn$1.exports);var hasOwn=hasOwn$1.exports;let computedPropertyDescriptor$1={configurable:!0,enumerable:!1,get:void 0};function extendMethod(d,h,p={}){let{inPlace:m=!1,returnThis:w=!0,partialArgs:T=[]}=p;return m?Image$1.prototype[d]=function(...k){this.computed=null;let x=h.apply(this,[...T,...k]);return w?this:x}:Image$1.prototype[d]=function(...k){return h.apply(this,[...T,...k])},Image$1}function extendProperty(d,h,p={}){let{partialArgs:m=[]}=p;return computedPropertyDescriptor$1.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(d,this.computed))return this.computed[d];let w=h.apply(this,m);return this.computed[d]=w,w},Object.defineProperty(Image$1.prototype,d,computedPropertyDescriptor$1),Image$1}const GREY$1="GREY",RGB$1="RGB",HSL="HSL",HSV="HSV",CMYK$1="CMYK";var ColorModel=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",GREY:GREY$1,RGB:RGB$1,HSL,HSV,CMYK:CMYK$1});function getRGBAData(d={}){const{clamped:h}=d;this.checkProcessable("getRGBAData",{components:[1,3],bitDepth:[1,8,16,32]});const p=this.width*this.height*4;let m=h?new Uint8ClampedArray(p):new Uint8Array(p);return this.bitDepth===1?fillDataFromBinary(this,m):this.bitDepth===32?(this.checkProcessable("getRGBAData",{alpha:0}),this.components===1?fillDataFromGrey32(this,m):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB32(this,m))):this.components===1?fillDataFromGrey(this,m):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB(this,m)),this.alpha===1?(this.checkProcessable("getRGBAData",{bitDepth:[8,16]}),copyAlpha(this,m)):fillAlpha(this,m),m}function fillDataFromBinary(d,h){for(let p=0;p<d.size;p++){const m=d.getBit(p);h[p*4]=m*255,h[p*4+1]=m*255,h[p*4+2]=m*255}}function fillDataFromGrey32(d,h){const p=d.min[0],w=d.max[0]-p;for(let T=0;T<d.size;T++){const k=Math.floor(255*(d.data[T]-p)/w);h[T*4]=k,h[T*4+1]=k,h[T*4+2]=k}}function fillDataFromRGB32(d,h){const p=Math.min(...d.min),w=Math.max(...d.max)-p;for(let T=0;T<d.size;T++){const k=Math.floor(255*(d.data[T*3]-p)/w),x=Math.floor(255*(d.data[T*3+1]-p)/w),B=Math.floor(255*(d.data[T*3+2]-p)/w);h[T*4]=k,h[T*4+1]=x,h[T*4+2]=B}}function fillDataFromGrey(d,h){for(let p=0;p<d.size;p++)h[p*4]=d.data[p*d.channels]>>>d.bitDepth-8,h[p*4+1]=d.data[p*d.channels]>>>d.bitDepth-8,h[p*4+2]=d.data[p*d.channels]>>>d.bitDepth-8}function fillDataFromRGB(d,h){for(let p=0;p<d.size;p++)h[p*4]=d.data[p*d.channels]>>>d.bitDepth-8,h[p*4+1]=d.data[p*d.channels+1]>>>d.bitDepth-8,h[p*4+2]=d.data[p*d.channels+2]>>>d.bitDepth-8}function copyAlpha(d,h){for(let p=0;p<d.size;p++)h[p*4+3]=d.data[p*d.channels+d.components]>>d.bitDepth-8}function fillAlpha(d,h){for(let p=0;p<d.size;p++)h[p*4+3]=255}const BINARY="BINARY",GREY="GREY",GREYA="GREYA",RGB="RGB",RGBA="RGBA",CMYK="CMYK",CMYKA="CMYKA",kinds={};kinds[BINARY]={components:1,alpha:0,bitDepth:1,colorModel:GREY$1};kinds[GREYA]={components:1,alpha:1,bitDepth:8,colorModel:GREY$1};kinds[GREY]={components:1,alpha:0,bitDepth:8,colorModel:GREY$1};kinds[RGBA]={components:3,alpha:1,bitDepth:8,colorModel:RGB$1};kinds[RGB]={components:3,alpha:0,bitDepth:8,colorModel:RGB$1};kinds[CMYK]={components:4,alpha:0,bitDepth:8,colorModel:CMYK$1};kinds[CMYKA]={components:4,alpha:1,bitDepth:8,colorModel:CMYK$1};function getKind(d){const h=kinds[d];if(!h)throw new RangeError(`invalid image kind: ${d}`);return h}const validBitDepth=[1,8,16,32];function verifyKindDefinition(d){const{components:h,alpha:p,bitDepth:m,colorModel:w}=d;if(!Number.isInteger(h)||h<=0)throw new RangeError(`invalid components: ${h}. Must be a positive integer`);if(p!==0&&p!==1&&typeof p!="boolean")throw new TypeError(`invalid alpha: ${p}: must be a boolean, 0 or 1`);if(!validBitDepth.includes(m))throw new RangeError(`invalid bitDepth: ${m}. Must be one of ${validBitDepth.join(", ")}`);if(!ColorModel[w])throw new RangeError(`invalid colorModel: ${w}. Must be one of ${Object.keys(ColorModel).join(", ")}`)}function getTheoreticalPixelArraySize(d,h,p){let m=h*d;return p===1&&(m=Math.ceil(m/8)),m}function createPixelArray(d,h,p,m,w,T){const k=m*d;let x;switch(w){case 1:x=new Uint8Array(Math.ceil(k/8));break;case 8:x=new Uint8Array(k);break;case 16:x=new Uint16Array(k);break;case 32:x=new Float32Array(k);break;default:throw new Error(`Cannot create pixel array for bit depth ${w}`)}if(p)for(let B=h;B<x.length;B+=m)x[B]=T;return x}const defaultByteLength$1=1024*8,charArray=[];class IOBuffer$3{constructor(h,p){p=p||{},h===void 0&&(h=defaultByteLength$1),typeof h=="number"&&(h=new ArrayBuffer(h));let m=h.byteLength;const w=p.offset?p.offset>>>0:0;h.buffer&&(m=h.byteLength-w,h.byteLength!==h.buffer.byteLength?h=h.buffer.slice(h.byteOffset+w,h.byteOffset+h.byteLength):w?h=h.buffer.slice(w):h=h.buffer),this.buffer=h,this.length=m,this.byteLength=m,this.byteOffset=0,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer),this._increment=m||defaultByteLength$1,this._mark=0}available(h){return h===void 0&&(h=1),this.offset+h<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){this.littleEndian=!0}isBigEndian(){return!this.littleEndian}setBigEndian(){this.littleEndian=!1}skip(h){h===void 0&&(h=1),this.offset+=h}seek(h){this.offset=h}mark(){this._mark=this.offset}reset(){this.offset=this._mark}rewind(){this.offset=0}ensureAvailable(h){if(h===void 0&&(h=1),!this.available(h)){const p=this._increment+this._increment;this._increment=p;const m=this.length+p,w=new Uint8Array(m);w.set(new Uint8Array(this.buffer)),this.buffer=w.buffer,this.length=m,this._data=new DataView(this.buffer)}}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(h){h===void 0&&(h=1);for(var p=new Uint8Array(h),m=0;m<h;m++)p[m]=this.readByte();return p}readInt16(){var h=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,h}readUint16(){var h=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,h}readInt32(){var h=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,h}readUint32(){var h=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,h}readFloat32(){var h=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,h}readFloat64(){var h=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,h}readChar(){return String.fromCharCode(this.readInt8())}readChars(h){h===void 0&&(h=1),charArray.length=h;for(var p=0;p<h;p++)charArray[p]=this.readChar();return charArray.join("")}writeBoolean(h){this.writeUint8(h?255:0)}writeInt8(h){this.ensureAvailable(1),this._data.setInt8(this.offset++,h)}writeUint8(h){this.ensureAvailable(1),this._data.setUint8(this.offset++,h)}writeByte(h){this.writeUint8(h)}writeBytes(h){this.ensureAvailable(h.length);for(var p=0;p<h.length;p++)this._data.setUint8(this.offset++,h[p])}writeInt16(h){this.ensureAvailable(2),this._data.setInt16(this.offset,h,this.littleEndian),this.offset+=2}writeUint16(h){this.ensureAvailable(2),this._data.setUint16(this.offset,h,this.littleEndian),this.offset+=2}writeInt32(h){this.ensureAvailable(4),this._data.setInt32(this.offset,h,this.littleEndian),this.offset+=4}writeUint32(h){this.ensureAvailable(4),this._data.setUint32(this.offset,h,this.littleEndian),this.offset+=4}writeFloat32(h){this.ensureAvailable(4),this._data.setFloat32(this.offset,h,this.littleEndian),this.offset+=4}writeFloat64(h){this.ensureAvailable(8),this._data.setFloat64(this.offset,h,this.littleEndian),this.offset+=8}writeChar(h){this.writeUint8(h.charCodeAt(0))}writeChars(h){for(var p=0;p<h.length;p++)this.writeUint8(h.charCodeAt(p))}toArray(){return new Uint8Array(this.buffer,0,this.offset)}}var IOBuffer_1=IOBuffer$3,src$4={};const tagsById$5={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName$5={};for(var i$4 in tagsById$5)tagsByName$5[tagsById$5[i$4]]=i$4;var standard$1={tagsById:tagsById$5,tagsByName:tagsByName$5};const tagsById$4={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$4={};for(var i$3 in tagsById$4)tagsByName$4[tagsById$4[i$3]]=i$3;var exif$1={tagsById:tagsById$4,tagsByName:tagsByName$4};const tagsById$3={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$3={};for(var i$2 in tagsById$3)tagsByName$3[tagsById$3[i$2]]=i$2;var gps$1={tagsById:tagsById$3,tagsByName:tagsByName$3};const tags$1={standard:standard$1,exif:exif$1,gps:gps$1};class IFD$2{constructor(h){if(!h)throw new Error("missing kind");this.data=null,this.fields=new Map,this.kind=h,this._map=null}get(h){if(typeof h=="number")return this.fields.get(h);if(typeof h=="string")return this.fields.get(tags$1[this.kind].tagsByName[h]);throw new Error("expected a number or string")}get map(){if(!this._map){this._map={};const p=tags$1[this.kind].tagsById;for(var h of this.fields.keys())p[h]&&(this._map[p[h]]=this.fields.get(h))}return this._map}}var ifd=IFD$2;const Ifd=ifd,dateTimeRegex$1=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd$1 extends Ifd{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){var h=new Date,p=dateTimeRegex$1.exec(this.dateTime);return h.setFullYear(p[1],p[2]-1,p[3]),h.setHours(p[4],p[5],p[6]),h}get newSubfileType(){return this.get(254)}get imageWidth(){return this.get(256)}get imageLength(){return this.get(257)}get bitsPerSample(){return this.get(258)}get compression(){return this.get(259)||1}get type(){return this.get(262)}get fillOrder(){return this.get(266)||1}get documentName(){return this.get(269)}get imageDescription(){return this.get(270)}get stripOffsets(){return alwaysArray$1(this.get(273))}get orientation(){return this.get(274)}get samplesPerPixel(){return this.get(277)}get rowsPerStrip(){return this.get(278)}get stripByteCounts(){return alwaysArray$1(this.get(279))}get minSampleValue(){return this.get(280)||0}get maxSampleValue(){return this.get(281)||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get(282)}get yResolution(){return this.get(283)}get planarConfiguration(){return this.get(284)||1}get resolutionUnit(){return this.get(296)||2}get dateTime(){return this.get(306)}get predictor(){return this.get(317)||1}get sampleFormat(){return this.get(339)||1}get sMinSampleValue(){return this.get(340)||this.minSampleValue}get sMaxSampleValue(){return this.get(341)||this.maxSampleValue}}function alwaysArray$1(d){return typeof d=="number"?[d]:d}var tiffIfd=TiffIfd$1,ifdValue={},types$1=new Map([[1,[1,readByte$1]],[2,[1,readASCII$1]],[3,[2,readShort$1]],[4,[4,readLong$1]],[5,[8,readRational$1]],[6,[1,readSByte$1]],[7,[1,readByte$1]],[8,[2,readSShort$1]],[9,[4,readSLong$1]],[10,[8,readSRational$1]],[11,[4,readFloat$1]],[12,[8,readDouble$1]]]);ifdValue.getByteLength=function(d,h){return types$1.get(d)[0]*h};ifdValue.readData=function(d,h,p){return types$1.get(h)[1](d,p)};function readByte$1(d,h){if(h===1)return d.readUint8();for(var p=new Uint8Array(h),m=0;m<h;m++)p[m]=d.readUint8();return p}function readASCII$1(d,h){for(var p=[],m="",w=0;w<h;w++){var T=String.fromCharCode(d.readUint8());T==="\0"?(p.push(m),m=""):m+=T}return p.length===1?p[0]:p}function readShort$1(d,h){if(h===1)return d.readUint16();for(var p=new Uint16Array(h),m=0;m<h;m++)p[m]=d.readUint16();return p}function readLong$1(d,h){if(h===1)return d.readUint32();for(var p=new Uint32Array(h),m=0;m<h;m++)p[m]=d.readUint32();return p}function readRational$1(d,h){if(h===1)return d.readUint32()/d.readUint32();for(var p=new Array(h),m=0;m<h;m++)p[m]=d.readUint32()/d.readUint32();return p}function readSByte$1(d,h){if(h===1)return d.readInt8();for(var p=new Int8Array(h),m=0;m<h;m++)p[m]=d.readInt8();return p}function readSShort$1(d,h){if(h===1)return d.readInt16();for(var p=new Int16Array(h),m=0;m<h;m++)p[m]=d.readInt16();return p}function readSLong$1(d,h){if(h===1)return d.readInt32();for(var p=new Int32Array(h),m=0;m<h;m++)p[m]=d.readInt32();return p}function readSRational$1(d,h){if(h===1)return d.readInt32()/d.readInt32();for(var p=new Array(h),m=0;m<h;m++)p[m]=d.readInt32()/d.readInt32();return p}function readFloat$1(d,h){if(h===1)return d.readFloat32();for(var p=new Float32Array(h),m=0;m<h;m++)p[m]=d.readFloat32();return p}function readDouble$1(d,h){if(h===1)return d.readFloat64();for(var p=new Float64Array(h),m=0;m<h;m++)p[m]=d.readFloat64();return p}const IOBuffer$2=IOBuffer_1,IFD$1=ifd,TiffIFD=tiffIfd,IFDValue=ifdValue,defaultOptions$d={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder$2 extends IOBuffer$2{constructor(h,p){super(h,p);this._nextIFD=0}decode(h){h=Object.assign({},defaultOptions$d,h);const p=[];for(this.decodeHeader();this._nextIFD;)if(p.push(this.decodeIFD(h)),h.onlyFirst)return p[0];return p}decodeHeader(){let h=this.readUint16();if(h===18761)this.setLittleEndian();else if(h===19789)this.setBigEndian();else throw new Error("invalid byte order: 0x"+h.toString(16));if(h=this.readUint16(),h!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(h){this.seek(this._nextIFD);var p;h.kind?p=new IFD$1(h.kind):p=new TiffIFD;const m=this.readUint16();for(var w=0;w<m;w++)this.decodeIFDEntry(p);return h.ignoreImageData||this.decodeImageData(p),this._nextIFD=this.readUint32(),p}decodeIFDEntry(h){const p=this.offset,m=this.readUint16(),w=this.readUint16(),T=this.readUint32();if(w<1||w>12){this.skip(4);return}IFDValue.getByteLength(w,T)>4&&this.seek(this.readUint32());const x=IFDValue.readData(this,w,T);if(h.fields.set(m,x),m===34665||m===34853){let B=this.offset,P;m===34665?P="exif":m===34853&&(P="gps"),this._nextIFD=x,h[P]=this.decodeIFD({kind:P,ignoreImageData:!0}),this.offset=B}this.seek(p),this.skip(12)}decodeImageData(h){const p=h.orientation;switch(p&&p!==1&&unsupported$1("orientation",p),h.type){case 1:case 2:this.readStripData(h);break;default:unsupported$1("image type",h.type);break}}readStripData(h){const p=h.width,m=h.height,w=validateBitDepth(h.bitsPerSample),T=h.sampleFormat;let k=p*m;const x=getDataArray$1(k,1,w,T),B=h.compression,O=h.rowsPerStrip*p,U=h.stripOffsets,G=h.stripByteCounts;for(var j=0,H=0;H<U.length;H++){var te=this.getStripData(B,U[H],G[H]),oe=k>O?O:k;k-=oe,w===8?j=fill8bit$1(x,te,j,oe):w===16?j=fill16bit$1(x,te,j,oe,this.isLittleEndian()):w===32&&T===3?j=fillFloat32$1(x,te,j,oe,this.isLittleEndian()):unsupported$1("bitDepth",w)}h.data=x}getStripData(h,p,m){switch(h){case 1:return new DataView(this.buffer,p,m);case 2:case 32773:return unsupported$1("Compression",h);default:throw new Error("invalid compression: "+h)}}}var tiffDecoder=TIFFDecoder$2;function getDataArray$1(d,h,p,m){return p===8?new Uint8Array(d*h):p===16?new Uint16Array(d*h):p===32&&m===3?new Float32Array(d*h):unsupported$1("bit depth / sample format",p+" / "+m)}function fill8bit$1(d,h,p,m){for(var w=0;w<m;w++)d[p++]=h.getUint8(w);return p}function fill16bit$1(d,h,p,m,w){for(var T=0;T<m*2;T+=2)d[p++]=h.getUint16(T,w);return p}function fillFloat32$1(d,h,p,m,w){for(var T=0;T<m*4;T+=4)d[p++]=h.getFloat32(T,w);return p}function unsupported$1(d,h){throw new Error("Unsupported "+d+": "+h)}function validateBitDepth(d){if(d.length){const p=d;d=p[0];for(var h=0;h<p.length;h++)p[h]!==d&&unsupported$1("bit depth",p)}return d}const TIFFDecoder$1=tiffDecoder;var decode$3=function(h,p){return new TIFFDecoder$1(h,p).decode(p)};src$4.decode=decode$3;const IOBuffer$1=IOBuffer_1,tiff=src$4;function decode$2(d){const h=new IOBuffer$1(d),p={};if(h.setBigEndian(),h.readUint16()!==65496)throw new Error("SOI marker not found. Not a valid JPEG file");if(h.readUint16()===65505){h.readUint16();const T=h.readBytes(6);if(T[0]===69&&T[1]===120&&T[2]===105&&T[3]===102&&T[4]===0&&T[5]===0){const k=tiff.decode(h,{onlyFirst:!0,ignoreImageData:!0,offset:h.offset});p.exif=k}}return p}var decode_1=decode$2,decode$1=decode_1,imageType$2={exports:{}},fileType$1={exports:{}};(function(module){const toBytes=d=>[...d].map(h=>h.charCodeAt(0)),xpiZipFilename=toBytes("META-INF/mozilla.rsa"),oxmlContentTypes=toBytes("[Content_Types].xml"),oxmlRels=toBytes("_rels/.rels");function readUInt64LE(d,h=0){let p=d[h],m=1,w=0;for(;++w<8;)m*=256,p+=d[h+w]*m;return p}const fileType=d=>{if(!(d instanceof Uint8Array||d instanceof ArrayBuffer||Buffer.isBuffer(d)))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`Buffer\` or \`ArrayBuffer\`, got \`${typeof d}\``);const h=d instanceof Uint8Array?d:new Uint8Array(d);if(!(h&&h.length>1))return null;const p=(w,T)=>{T=Object.assign({offset:0},T);for(let k=0;k<w.length;k++)if(T.mask){if(w[k]!==(T.mask[k]&h[k+T.offset]))return!1}else if(w[k]!==h[k+T.offset])return!1;return!0},m=(w,T)=>p(toBytes(w),T);if(p([255,216,255]))return{ext:"jpg",mime:"image/jpeg"};if(p([137,80,78,71,13,10,26,10]))return{ext:"png",mime:"image/png"};if(p([71,73,70]))return{ext:"gif",mime:"image/gif"};if(p([87,69,66,80],{offset:8}))return{ext:"webp",mime:"image/webp"};if(p([70,76,73,70]))return{ext:"flif",mime:"image/flif"};if((p([73,73,42,0])||p([77,77,0,42]))&&p([67,82],{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(p([73,73,42,0])||p([77,77,0,42]))return{ext:"tif",mime:"image/tiff"};if(p([66,77]))return{ext:"bmp",mime:"image/bmp"};if(p([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(p([56,66,80,83]))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(p([80,75,3,4])){if(p([109,105,109,101,116,121,112,101,97,112,112,108,105,99,97,116,105,111,110,47,101,112,117,98,43,122,105,112],{offset:30}))return{ext:"epub",mime:"application/epub+zip"};if(p(xpiZipFilename,{offset:30}))return{ext:"xpi",mime:"application/x-xpinstall"};if(m("mimetypeapplication/vnd.oasis.opendocument.text",{offset:30}))return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};if(m("mimetypeapplication/vnd.oasis.opendocument.spreadsheet",{offset:30}))return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};if(m("mimetypeapplication/vnd.oasis.opendocument.presentation",{offset:30}))return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};const w=(B,P=0)=>B.findIndex((O,U,G)=>U>=P&&G[U]===80&&G[U+1]===75&&G[U+2]===3&&G[U+3]===4);let T=0,k=!1,x=null;do{const B=T+30;if(k||(k=p(oxmlContentTypes,{offset:B})||p(oxmlRels,{offset:B})),x||(m("word/",{offset:B})?x={ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}:m("ppt/",{offset:B})?x={ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}:m("xl/",{offset:B})&&(x={ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),k&&x)return x;T=w(h,B)}while(T>=0);if(x)return x}if(p([80,75])&&(h[2]===3||h[2]===5||h[2]===7)&&(h[3]===4||h[3]===6||h[3]===8))return{ext:"zip",mime:"application/zip"};if(p([117,115,116,97,114],{offset:257}))return{ext:"tar",mime:"application/x-tar"};if(p([82,97,114,33,26,7])&&(h[6]===0||h[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(p([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(p([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(p([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(p([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(p([51,103,112,53])||p([0,0,0])&&p([102,116,121,112],{offset:4})&&(p([109,112,52,49],{offset:8})||p([109,112,52,50],{offset:8})||p([105,115,111,109],{offset:8})||p([105,115,111,50],{offset:8})||p([109,109,112,52],{offset:8})||p([77,52,86],{offset:8})||p([100,97,115,104],{offset:8})))return{ext:"mp4",mime:"video/mp4"};if(p([77,84,104,100]))return{ext:"mid",mime:"audio/midi"};if(p([26,69,223,163])){const w=h.subarray(4,4100),T=w.findIndex((k,x,B)=>B[x]===66&&B[x+1]===130);if(T!==-1){const k=T+3,x=B=>[...B].every((P,O)=>w[k+O]===P.charCodeAt(0));if(x("matroska"))return{ext:"mkv",mime:"video/x-matroska"};if(x("webm"))return{ext:"webm",mime:"video/webm"}}}if(p([0,0,0,20,102,116,121,112,113,116,32,32])||p([102,114,101,101],{offset:4})||p([102,116,121,112,113,116,32,32],{offset:4})||p([109,100,97,116],{offset:4})||p([109,111,111,118],{offset:4})||p([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(p([82,73,70,70])){if(p([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(p([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/vnd.wave"};if(p([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(p([48,38,178,117,142,102,207,17,166,217])){let w=30;do{const T=readUInt64LE(h,w+16);if(p([145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101],{offset:w})){if(p([64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43],{offset:w+24}))return{ext:"wma",mime:"audio/x-ms-wma"};if(p([192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43],{offset:w+24}))return{ext:"wmv",mime:"video/x-ms-asf"};break}w+=T}while(w+24<=h.length);return{ext:"asf",mime:"application/vnd.ms-asf"}}if(p([0,0,1,186])||p([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(p([102,116,121,112,51,103],{offset:4}))return{ext:"3gp",mime:"video/3gpp"};for(let w=0;w<2&&w<h.length-16;w++){if(p([73,68,51],{offset:w})||p([255,226],{offset:w,mask:[255,226]}))return{ext:"mp3",mime:"audio/mpeg"};if(p([255,228],{offset:w,mask:[255,228]}))return{ext:"mp2",mime:"audio/mpeg"};if(p([255,248],{offset:w,mask:[255,252]}))return{ext:"mp2",mime:"audio/mpeg"};if(p([255,240],{offset:w,mask:[255,252]}))return{ext:"mp4",mime:"audio/mpeg"}}if(p([102,116,121,112,77,52,65],{offset:4}))return{ext:"m4a",mime:"audio/mp4"};if(p([79,112,117,115,72,101,97,100],{offset:28}))return{ext:"opus",mime:"audio/opus"};if(p([79,103,103,83]))return p([128,116,104,101,111,114,97],{offset:28})?{ext:"ogv",mime:"video/ogg"}:p([1,118,105,100,101,111,0],{offset:28})?{ext:"ogm",mime:"video/ogg"}:p([127,70,76,65,67],{offset:28})?{ext:"oga",mime:"audio/ogg"}:p([83,112,101,101,120,32,32],{offset:28})?{ext:"spx",mime:"audio/ogg"}:p([1,118,111,114,98,105,115],{offset:28})?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"};if(p([102,76,97,67]))return{ext:"flac",mime:"audio/x-flac"};if(p([77,65,67,32]))return{ext:"ape",mime:"audio/ape"};if(p([119,118,112,107]))return{ext:"wv",mime:"audio/wavpack"};if(p([35,33,65,77,82,10]))return{ext:"amr",mime:"audio/amr"};if(p([37,80,68,70]))return{ext:"pdf",mime:"application/pdf"};if(p([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if((h[0]===67||h[0]===70)&&p([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(p([123,92,114,116,102]))return{ext:"rtf",mime:"application/rtf"};if(p([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(p([119,79,70,70])&&(p([0,1,0,0],{offset:4})||p([79,84,84,79],{offset:4})))return{ext:"woff",mime:"font/woff"};if(p([119,79,70,50])&&(p([0,1,0,0],{offset:4})||p([79,84,84,79],{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(p([76,80],{offset:34})&&(p([0,0,1],{offset:8})||p([1,0,2],{offset:8})||p([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(p([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(p([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(p([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(p([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(p([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(p([37,33]))return{ext:"ps",mime:"application/postscript"};if(p([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(p([83,81,76,105]))return{ext:"sqlite",mime:"application/x-sqlite3"};if(p([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(p([67,114,50,52]))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(p([77,83,67,70])||p([73,83,99,40]))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(p([33,60,97,114,99,104,62,10,100,101,98,105,97,110,45,98,105,110,97,114,121]))return{ext:"deb",mime:"application/x-deb"};if(p([33,60,97,114,99,104,62]))return{ext:"ar",mime:"application/x-unix-archive"};if(p([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(p([31,160])||p([31,157]))return{ext:"Z",mime:"application/x-compress"};if(p([76,90,73,80]))return{ext:"lz",mime:"application/x-lzip"};if(p([208,207,17,224,161,177,26,225]))return{ext:"msi",mime:"application/x-msi"};if(p([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(p([71],{offset:4})&&(p([71],{offset:192})||p([71],{offset:196})))return{ext:"mts",mime:"video/mp2t"};if(p([66,76,69,78,68,69,82]))return{ext:"blend",mime:"application/x-blender"};if(p([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(p([0,0,0,12,106,80,32,32,13,10,135,10])){if(p([106,112,50,32],{offset:20}))return{ext:"jp2",mime:"image/jp2"};if(p([106,112,120,32],{offset:20}))return{ext:"jpx",mime:"image/jpx"};if(p([106,112,109,32],{offset:20}))return{ext:"jpm",mime:"image/jpm"};if(p([109,106,112,50],{offset:20}))return{ext:"mj2",mime:"image/mj2"}}if(p([70,79,82,77]))return{ext:"aif",mime:"audio/aiff"};if(m("<?xml "))return{ext:"xml",mime:"application/xml"};if(p([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(p([102,116,121,112],{offset:4})){if(p([109,105,102,49],{offset:8}))return{ext:"heic",mime:"image/heif"};if(p([109,115,102,49],{offset:8}))return{ext:"heic",mime:"image/heif-sequence"};if(p([104,101,105,99],{offset:8})||p([104,101,105,120],{offset:8}))return{ext:"heic",mime:"image/heic"};if(p([104,101,118,99],{offset:8})||p([104,101,118,120],{offset:8}))return{ext:"heic",mime:"image/heic-sequence"}}return p([171,75,84,88,32,49,49,187,13,10,26,10])?{ext:"ktx",mime:"image/ktx"}:p([68,73,67,77],{offset:128})?{ext:"dcm",mime:"application/dicom"}:p([77,80,43])?{ext:"mpc",mime:"audio/x-musepack"}:p([77,80,67,75])?{ext:"mpc",mime:"audio/x-musepack"}:p([66,69,71,73,78,58])?{ext:"ics",mime:"text/calendar"}:p([103,108,84,70,2,0,0,0])?{ext:"glb",mime:"model/gltf-binary"}:p([212,195,178,161])||p([161,178,195,212])?{ext:"pcap",mime:"application/vnd.tcpdump.pcap"}:null};module.exports=fileType,module.exports.default=fileType,Object.defineProperty(fileType,"minimumBytes",{value:4100}),module.exports.stream=readableStream=>new Promise((resolve,reject)=>{const stream=eval("require")("stream");readableStream.once("readable",()=>{const d=new stream.PassThrough,h=readableStream.read(module.exports.minimumBytes)||readableStream.read();try{d.fileType=fileType(h)}catch(p){reject(p)}readableStream.unshift(h),stream.pipeline?resolve(stream.pipeline(readableStream,d,()=>{})):resolve(readableStream.pipe(d))})})})(fileType$1);const fileType=fileType$1.exports,imageExts=new Set(["jpg","png","gif","webp","flif","cr2","tif","bmp","jxr","psd","ico","bpg","jp2","jpm","jpx","heic","cur","dcm"]),imageType=d=>{const h=fileType(d);return imageExts.has(h&&h.ext)?h:null};imageType$2.exports=imageType;imageType$2.exports.default=imageType;Object.defineProperty(imageType,"minimumBytes",{value:fileType.minimumBytes});var imageType$1=imageType$2.exports;(function(d){if(d.TextEncoder&&d.TextDecoder)return!1;function h(m="utf-8"){if(m!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${m}') is invalid.`)}Object.defineProperty(h.prototype,"encoding",{value:"utf-8"}),h.prototype.encode=function(m,w={stream:!1}){if(w.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let T=0;const k=m.length;let x=0,B=Math.max(32,k+(k>>1)+7),P=new Uint8Array(B>>3<<3);for(;T<k;){let O=m.charCodeAt(T++);if(O>=55296&&O<=56319){if(T<k){const U=m.charCodeAt(T);(U&64512)===56320&&(++T,O=((O&1023)<<10)+(U&1023)+65536)}if(O>=55296&&O<=56319)continue}if(x+4>P.length){B+=8,B*=1+T/m.length*2,B=B>>3<<3;const U=new Uint8Array(B);U.set(P),P=U}if((O&4294967168)===0){P[x++]=O;continue}else if((O&4294965248)===0)P[x++]=O>>6&31|192;else if((O&4294901760)===0)P[x++]=O>>12&15|224,P[x++]=O>>6&63|128;else if((O&4292870144)===0)P[x++]=O>>18&7|240,P[x++]=O>>12&63|128,P[x++]=O>>6&63|128;else continue;P[x++]=O&63|128}return P.slice(0,x)};function p(m="utf-8",w={fatal:!1}){if(m!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${m}') is invalid.`);if(w.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(p.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(p.prototype,"fatal",{value:!1}),Object.defineProperty(p.prototype,"ignoreBOM",{value:!1}),p.prototype.decode=function(m,w={stream:!1}){if(w.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const T=new Uint8Array(m);let k=0;const x=T.length,B=[];for(;k<x;){const P=T[k++];if(P===0)break;if((P&128)===0)B.push(P);else if((P&224)===192){const O=T[k++]&63;B.push((P&31)<<6|O)}else if((P&240)===224){const O=T[k++]&63,U=T[k++]&63;B.push((P&31)<<12|O<<6|U)}else if((P&248)===240){const O=T[k++]&63,U=T[k++]&63,G=T[k++]&63;let j=(P&7)<<18|O<<12|U<<6|G;j>65535&&(j-=65536,B.push(j>>>10&1023|55296),j=56320|j&1023),B.push(j)}}return String.fromCharCode.apply(null,B)},d.TextEncoder=h,d.TextDecoder=p})(typeof window!="undefined"?window:typeof self!="undefined"?self:globalThis);const decoder=new TextDecoder("utf-8");function decode(d){return decoder.decode(d)}const encoder=new TextEncoder;function encode(d){return encoder.encode(d)}const defaultByteLength=1024*8;class IOBuffer{constructor(h=defaultByteLength,p={}){let m=!1;typeof h=="number"?h=new ArrayBuffer(h):(m=!0,this.lastWrittenByte=h.byteLength);const w=p.offset?p.offset>>>0:0,T=h.byteLength-w;let k=w;(ArrayBuffer.isView(h)||h instanceof IOBuffer)&&(h.byteLength!==h.buffer.byteLength&&(k=h.byteOffset+w),h=h.buffer),m?this.lastWrittenByte=T:this.lastWrittenByte=0,this.buffer=h,this.length=T,this.byteLength=T,this.byteOffset=k,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,k,T),this._mark=0,this._marks=[]}available(h=1){return this.offset+h<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(h=1){return this.offset+=h,this}seek(h){return this.offset=h,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const h=this._marks.pop();if(h===void 0)throw new Error("Mark stack empty");return this.seek(h),this}rewind(){return this.offset=0,this}ensureAvailable(h=1){if(!this.available(h)){const m=(this.offset+h)*2,w=new Uint8Array(m);w.set(new Uint8Array(this.buffer)),this.buffer=w.buffer,this.length=this.byteLength=m,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(h=1){const p=new Uint8Array(h);for(let m=0;m<h;m++)p[m]=this.readByte();return p}readInt16(){const h=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,h}readUint16(){const h=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,h}readInt32(){const h=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,h}readUint32(){const h=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,h}readFloat32(){const h=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,h}readFloat64(){const h=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,h}readBigInt64(){const h=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,h}readBigUint64(){const h=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,h}readChar(){return String.fromCharCode(this.readInt8())}readChars(h=1){let p="";for(let m=0;m<h;m++)p+=this.readChar();return p}readUtf8(h=1){return decode(this.readBytes(h))}writeBoolean(h){return this.writeUint8(h?255:0),this}writeInt8(h){return this.ensureAvailable(1),this._data.setInt8(this.offset++,h),this._updateLastWrittenByte(),this}writeUint8(h){return this.ensureAvailable(1),this._data.setUint8(this.offset++,h),this._updateLastWrittenByte(),this}writeByte(h){return this.writeUint8(h)}writeBytes(h){this.ensureAvailable(h.length);for(let p=0;p<h.length;p++)this._data.setUint8(this.offset++,h[p]);return this._updateLastWrittenByte(),this}writeInt16(h){return this.ensureAvailable(2),this._data.setInt16(this.offset,h,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(h){return this.ensureAvailable(2),this._data.setUint16(this.offset,h,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(h){return this.ensureAvailable(4),this._data.setInt32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(h){return this.ensureAvailable(4),this._data.setUint32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(h){return this.ensureAvailable(4),this._data.setFloat32(this.offset,h,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(h){return this.ensureAvailable(8),this._data.setFloat64(this.offset,h,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(h){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,h,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(h){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,h,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(h){return this.writeUint8(h.charCodeAt(0))}writeChars(h){for(let p=0;p<h.length;p++)this.writeUint8(h.charCodeAt(p));return this}writeUtf8(h){return this.writeBytes(encode(h))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}function guessStripByteCounts(d){if(d.compression!==1)throw new Error("missing mandatory StripByteCounts field in compressed image");const h=d.rowsPerStrip*d.width*d.samplesPerPixel*(d.bitsPerSample/8);return new Array(d.stripOffsets.length).fill(h)}function applyHorizontalDifferencing8Bit(d,h,p){let m=0;for(;m<d.length;){for(let w=p;w<h*p;w+=p)for(let T=0;T<p;T++)d[m+w+T]=d[m+w+T]+d[m+w-(p-T)]&255;m+=h*p}}function applyHorizontalDifferencing16Bit(d,h,p){let m=0;for(;m<d.length;){for(let w=p;w<h*p;w+=p)for(let T=0;T<p;T++)d[m+w+T]=d[m+w+T]+d[m+w-(p-T)]&65535;m+=h*p}}const tagsById$2={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$2={};for(let d in tagsById$2)tagsByName$2[tagsById$2[d]]=Number(d);var exif=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",tagsById:tagsById$2,tagsByName:tagsByName$2});const tagsById$1={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$1={};for(let d in tagsById$1)tagsByName$1[tagsById$1[d]]=Number(d);var gps=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",tagsById:tagsById$1,tagsByName:tagsByName$1});const tagsById={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName={};for(let d in tagsById)tagsByName[tagsById[d]]=Number(d);var standard=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",tagsById,tagsByName});const tags={standard,exif,gps};class IFD{constructor(h){if(!h)throw new Error("missing kind");this.data=new Uint8Array,this.fields=new Map,this.kind=h,this._hasMap=!1,this._map={}}get(h){if(typeof h=="number")return this.fields.get(h);if(typeof h=="string")return this.fields.get(tags[this.kind].tagsByName[h]);throw new Error("expected a number or string")}get map(){if(!this._hasMap){const h=tags[this.kind].tagsById;for(let p of this.fields.keys())h[p]&&(this._map[h[p]]=this.fields.get(p));this._hasMap=!0}return this._map}}let types=new Map([[1,[1,readByte]],[2,[1,readASCII]],[3,[2,readShort]],[4,[4,readLong]],[5,[8,readRational]],[6,[1,readSByte]],[7,[1,readByte]],[8,[2,readSShort]],[9,[4,readSLong]],[10,[8,readSRational]],[11,[4,readFloat]],[12,[8,readDouble]]]);function getByteLength(d,h){const p=types.get(d);if(!p)throw new Error(`type not found: ${d}`);return p[0]*h}function readData(d,h,p){const m=types.get(h);if(!m)throw new Error(`type not found: ${h}`);return m[1](d,p)}function readByte(d,h){if(h===1)return d.readUint8();let p=new Uint8Array(h);for(let m=0;m<h;m++)p[m]=d.readUint8();return p}function readASCII(d,h){let p=[],m="";for(let w=0;w<h;w++){let T=String.fromCharCode(d.readUint8());T==="\0"?(p.push(m),m=""):m+=T}return p.length===1?p[0]:p}function readShort(d,h){if(h===1)return d.readUint16();let p=new Uint16Array(h);for(let m=0;m<h;m++)p[m]=d.readUint16();return p}function readLong(d,h){if(h===1)return d.readUint32();let p=new Uint32Array(h);for(let m=0;m<h;m++)p[m]=d.readUint32();return p}function readRational(d,h){if(h===1)return d.readUint32()/d.readUint32();let p=new Array(h);for(let m=0;m<h;m++)p[m]=d.readUint32()/d.readUint32();return p}function readSByte(d,h){if(h===1)return d.readInt8();let p=new Int8Array(h);for(let m=0;m<h;m++)p[m]=d.readInt8();return p}function readSShort(d,h){if(h===1)return d.readInt16();let p=new Int16Array(h);for(let m=0;m<h;m++)p[m]=d.readInt16();return p}function readSLong(d,h){if(h===1)return d.readInt32();let p=new Int32Array(h);for(let m=0;m<h;m++)p[m]=d.readInt32();return p}function readSRational(d,h){if(h===1)return d.readInt32()/d.readInt32();let p=new Array(h);for(let m=0;m<h;m++)p[m]=d.readInt32()/d.readInt32();return p}function readFloat(d,h){if(h===1)return d.readFloat32();let p=new Float32Array(h);for(let m=0;m<h;m++)p[m]=d.readFloat32();return p}function readDouble(d,h){if(h===1)return d.readFloat64();let p=new Float64Array(h);for(let m=0;m<h;m++)p[m]=d.readFloat64();return p}const CLEAR_CODE=256,EOI_CODE=257,TABLE_START=258,MIN_BIT_LENGTH=9;let stringTable=[];function initializeStringTable(){if(stringTable.length===0){for(let h=0;h<256;h++)stringTable.push([h]);const d=[];for(let h=256;h<4096;h++)stringTable.push(d)}}const andTable=[511,1023,2047,4095],bitJumps=[0,0,0,0,0,0,0,0,0,511,1023,2047,4095];class LzwDecoder{constructor(h){this.nextData=0,this.nextBits=0,this.bytePointer=0,this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH,this.stripArray=new Uint8Array(h.buffer,h.byteOffset,h.byteLength),this.outData=new IOBuffer(h.byteLength),this.initializeTable()}decode(){let h=0,p=0;for(;(h=this.getNextCode())!==EOI_CODE;)if(h===CLEAR_CODE){if(this.initializeTable(),h=this.getNextCode(),h===EOI_CODE)break;this.writeString(this.stringFromCode(h)),p=h}else if(this.isInTable(h))this.writeString(this.stringFromCode(h)),this.addStringToTable(this.stringFromCode(p).concat(this.stringFromCode(h)[0])),p=h;else{const w=this.stringFromCode(p).concat(this.stringFromCode(p)[0]);this.writeString(w),this.addStringToTable(w),p=h}const m=this.outData.toArray();return new DataView(m.buffer,m.byteOffset,m.byteLength)}initializeTable(){initializeStringTable(),this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH}writeString(h){this.outData.writeBytes(h)}stringFromCode(h){return stringTable[h]}isInTable(h){return h<this.tableLength}addStringToTable(h){if(stringTable[this.tableLength++]=h,stringTable.length>4096)throw stringTable=[],new Error("LZW decoding error. Please open an issue at https://github.com/image-js/tiff/issues/new/choose (include a test image).");this.tableLength===bitJumps[this.currentBitLength]&&this.currentBitLength++}getNextCode(){this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8,this.nextBits<this.currentBitLength&&(this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8);const h=this.nextData>>this.nextBits-this.currentBitLength&andTable[this.currentBitLength-9];return this.nextBits-=this.currentBitLength,this.bytePointer>this.stripArray.length?257:h}}function decompressLzw(d){return new LzwDecoder(d).decode()}const dateTimeRegex=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd extends IFD{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){let h=new Date,p=dateTimeRegex.exec(this.dateTime);if(p===null)throw new Error(`invalid dateTime: ${this.dateTime}`);return h.setFullYear(Number(p[1]),Number(p[2])-1,Number(p[3])),h.setHours(Number(p[4]),Number(p[5]),Number(p[6])),h}get newSubfileType(){return this.get("NewSubfileType")}get imageWidth(){return this.get("ImageWidth")}get imageLength(){return this.get("ImageLength")}get bitsPerSample(){const h=this.get("BitsPerSample");return h&&typeof h!="number"?h[0]:h}get alpha(){const h=this.extraSamples;return h?h[0]!==0:!1}get associatedAlpha(){const h=this.extraSamples;return h?h[0]===1:!1}get extraSamples(){return alwaysArray(this.get("ExtraSamples"))}get compression(){return this.get("Compression")||1}get type(){return this.get("PhotometricInterpretation")}get fillOrder(){return this.get("FillOrder")||1}get documentName(){return this.get("DocumentName")}get imageDescription(){return this.get("ImageDescription")}get stripOffsets(){return alwaysArray(this.get("StripOffsets"))}get orientation(){return this.get("Orientation")}get samplesPerPixel(){return this.get("SamplesPerPixel")||1}get rowsPerStrip(){return this.get("RowsPerStrip")}get stripByteCounts(){return alwaysArray(this.get("StripByteCounts"))}get minSampleValue(){return this.get("MinSampleValue")||0}get maxSampleValue(){return this.get("MaxSampleValue")||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get("XResolution")}get yResolution(){return this.get("YResolution")}get planarConfiguration(){return this.get("PlanarConfiguration")||1}get resolutionUnit(){return this.get("ResolutionUnit")||2}get dateTime(){return this.get("DateTime")}get predictor(){return this.get("Predictor")||1}get sampleFormat(){return this.get("SampleFormat")||1}get sMinSampleValue(){return this.get("SMinSampleValue")||this.minSampleValue}get sMaxSampleValue(){return this.get("SMaxSampleValue")||this.maxSampleValue}get palette(){const h=2**this.bitsPerSample,p=this.get("ColorMap");if(!p)return;if(p.length!==3*h)throw new Error(`ColorMap size must be ${h}`);const m=[];for(let w=0;w<h;w++)m.push([p[w],p[w+h],p[w+2*h]]);return m}}function alwaysArray(d){return typeof d=="number"?[d]:d}function decompressZlib(d){const h=new Uint8Array(d.buffer,d.byteOffset,d.byteLength),p=inflate_1(h);return new DataView(p.buffer,p.byteOffset,p.byteLength)}const defaultOptions$c={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder extends IOBuffer{constructor(h){super(h);this._nextIFD=0}get isMultiPage(){let h=0;for(this.decodeHeader();this._nextIFD;)if(h++,this.decodeIFD({ignoreImageData:!0},!0),h===2)return!0;if(h===1)return!1;throw unsupported("ifdCount",h)}get pageCount(){let h=0;for(this.decodeHeader();this._nextIFD;)h++,this.decodeIFD({ignoreImageData:!0},!0);if(h>0)return h;throw unsupported("ifdCount",h)}decode(h={}){h=Object.assign({},defaultOptions$c,h);const p=[];for(this.decodeHeader();this._nextIFD;)if(p.push(this.decodeIFD(h,!0)),h.onlyFirst)return[p[0]];return p}decodeHeader(){const h=this.readUint16();if(h===18761)this.setLittleEndian();else if(h===19789)this.setBigEndian();else throw new Error(`invalid byte order: 0x${h.toString(16)}`);if(this.readUint16()!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(h,p){this.seek(this._nextIFD);let m;if(p)m=new TiffIfd;else{if(!h.kind)throw new Error("kind is missing");m=new IFD(h.kind)}const w=this.readUint16();for(let T=0;T<w;T++)this.decodeIFDEntry(m);if(!h.ignoreImageData){if(!(m instanceof TiffIfd))throw new Error("must be a tiff ifd");this.decodeImageData(m)}return this._nextIFD=this.readUint32(),m}decodeIFDEntry(h){const p=this.offset,m=this.readUint16(),w=this.readUint16(),T=this.readUint32();if(w<1||w>12){this.skip(4);return}getByteLength(w,T)>4&&this.seek(this.readUint32());const x=readData(this,w,T);if(h.fields.set(m,x),m===34665||m===34853){let B=this.offset,P="exif";m===34665?P="exif":m===34853&&(P="gps"),this._nextIFD=x,h[P]=this.decodeIFD({kind:P,ignoreImageData:!0},!1),this.offset=B}this.seek(p),this.skip(12)}decodeImageData(h){const p=h.orientation;if(p&&p!==1)throw unsupported("orientation",p);switch(h.type){case 0:case 1:case 2:case 3:this.readStripData(h);break;default:throw unsupported("image type",h.type)}if(this.applyPredictor(h),this.convertAlpha(h),h.type===0){const m=h.bitsPerSample,w=Math.pow(2,m)-1;for(let T=0;T<h.data.length;T++)h.data[T]=w-h.data[T]}}readStripData(h){const p=h.width,m=h.height,w=h.bitsPerSample,T=h.sampleFormat,k=p*m*h.samplesPerPixel,x=getDataArray(k,w,T),P=h.rowsPerStrip*p*h.samplesPerPixel,O=h.stripOffsets,U=h.stripByteCounts||guessStripByteCounts(h);let G=k,j=0;for(let H=0;H<O.length;H++){let te=new DataView(this.buffer,this.byteOffset+O[H],U[H]),oe=G>P?P:G;G-=oe;let Q=te;switch(h.compression){case 1:break;case 5:{Q=decompressLzw(te);break}case 8:{Q=decompressZlib(te);break}case 2:throw unsupported("Compression","CCITT Group 3");case 32773:throw unsupported("Compression","PackBits");default:throw unsupported("Compression",h.compression)}j=this.fillUncompressed(w,T,x,Q,j,oe)}h.data=x}fillUncompressed(h,p,m,w,T,k){if(h===8)return fill8bit(m,w,T,k);if(h===16)return fill16bit(m,w,T,k,this.isLittleEndian());if(h===32&&p===3)return fillFloat32(m,w,T,k,this.isLittleEndian());throw unsupported("bitDepth",h)}applyPredictor(h){const p=h.bitsPerSample;switch(h.predictor){case 1:break;case 2:{if(p===8)applyHorizontalDifferencing8Bit(h.data,h.width,h.components);else if(p===16)applyHorizontalDifferencing16Bit(h.data,h.width,h.components);else throw new Error(`Horizontal differencing is only supported for images with a bit depth of ${p}`);break}default:throw new Error(`invalid predictor: ${h.predictor}`)}}convertAlpha(h){if(h.alpha&&h.associatedAlpha){const{data:p,components:m,maxSampleValue:w}=h;for(let T=0;T<p.length;T+=m){const k=p[T+m-1];for(let x=0;x<m-1;x++)p[T+x]=Math.round(p[T+x]*w/k)}}}}function getDataArray(d,h,p){if(h===8)return new Uint8Array(d);if(h===16)return new Uint16Array(d);if(h===32&&p===3)return new Float32Array(d);throw unsupported("bit depth / sample format",`${h} / ${p}`)}function fill8bit(d,h,p,m){for(let w=0;w<m;w++)d[p++]=h.getUint8(w);return p}function fill16bit(d,h,p,m,w){for(let T=0;T<m*2;T+=2)d[p++]=h.getUint16(T,w);return p}function fillFloat32(d,h,p,m,w){for(let T=0;T<m*4;T+=4)d[p++]=h.getFloat32(T,w);return p}function unsupported(d,h){return new Error(`Unsupported ${d}: ${h}`)}function decodeTIFF(d,h){return new TIFFDecoder(d).decode(h)}function matchAndCrop(d={}){let{algorithm:h="matchToPrevious",ignoreBorder:p=[0,0]}=d;this.checkProcessable("matchAndCrop",{bitDepth:[8,16]});let m=h==="matchToPrevious",w=this[0],T=[];T[0]={position:[0,0],image:this[0]};let k=[0,0];for(let G=1;G<this.length;G++){let j=w.getBestMatch(this[G],{border:p});T[G]={position:[j[0]+k[0],j[1]+k[1]],image:this[G]},m&&(k[0]+=j[0],k[1]+=j[1],w=this[G])}let x=0,B=0,P=0,O=0;for(let G=0;G<T.length;G++){let j=T[G];j.position[0]>x&&(x=j.position[0]),j.position[0]<B&&(B=j.position[0]),j.position[1]>P&&(P=j.position[1]),j.position[1]<O&&(O=j.position[1])}B=0-B,O=0-O;for(let G=0;G<T.length;G++){let j=T[G];j.crop=j.image.crop({x:x-j.position[0],y:P-j.position[1],width:w.width-B-x,height:w.height-O-P})}let U=[];for(let G=0;G<T.length;G++)U[G]=T[G].crop;return new Stack(U)}function min$2(){this.checkProcessable("min",{bitDepth:[8,16]});let d=this[0].min;for(let h=1;h<this.length;h++)for(let p=0;p<d.length;p++)d[p]=Math.min(d[p],this[h].min[p]);return d}function max$2(){this.checkProcessable("min",{bitDepth:[8,16]});let d=this[0].max;for(let h=1;h<this.length;h++)for(let p=0;p<d.length;p++)d[p]=Math.max(d[p],this[h].max[p]);return d}function median$2(d){let h=d.reduce((k,x)=>k+x);if(h===0)throw new Error("unreachable");let p=0,m=0,w=h/2,T;for(;;){if(d[p]>0){if(T!==void 0)return(T+p)/2;if(m+=d[p],m>w)return p;m===w&&(T=p)}p++}}function mean$2(d){let h=0,p=0;for(let m=0;m<d.length;m++)h+=d[m],p+=d[m]*m;return h===0?0:p/h}function median$1(){this.checkProcessable("median",{bitDepth:[8,16]});let d=this.getHistograms({maxSlots:this[0].maxValue+1}),h=new Array(d.length);for(let p=0;p<d.length;p++){let m=d[p];h[p]=median$2(m)}return h}function histogram(d){this.checkProcessable("min",{bitDepth:[8,16]});let h=this[0].getHistogram(d);for(let p=1;p<this.length;p++){let m=this[p].getHistogram(d);for(let w=0;w<h.length;w++)h[w]+=m[w]}return h}function histograms(d){this.checkProcessable("min",{bitDepth:[8,16]});let h=this[0].getHistograms(d),p=h[0].length;for(let m=1;m<this.length;m++){let w=this[m].getHistograms(d);for(let T=0;T<h.length;T++)for(let k=0;k<p;k++)h[T][k]+=w[T][k]}return h}function averageImage(){this.checkProcessable("averageImage",{bitDepth:[8,16]});let d=new Uint32Array(this[0].data.length);for(let m=0;m<this.length;m++){let w=this[m];for(let T=0;T<this[0].data.length;T++)d[T]+=w.data[T]}let h=Image$1.createFrom(this[0]),p=h.data;for(let m=0;m<this[0].data.length;m++)p[m]=d[m]/this.length;return h}function maxImage(){this.checkProcessable("max",{bitDepth:[8,16]});let d=Image$1.createFrom(this[0]);d.data.fill(0);for(const h of this)for(let p=0;p<d.data.length;p++)d.data[p]=Math.max(h.data[p],d.data[p]);return d}function minImage(){this.checkProcessable("max",{bitDepth:[8,16]});let d=Image$1.createFrom(this[0]);d.data.fill(d.maxValue);for(const h of this)for(let p=0;p<d.data.length;p++)d.data[p]=Math.min(h.data[p],d.data[p]);return d}function extend$5(d){d.extendMethod("matchAndCrop",matchAndCrop),d.extendMethod("getMin",min$2),d.extendMethod("getMax",max$2),d.extendMethod("getMedian",median$1),d.extendMethod("getHistogram",histogram),d.extendMethod("getHistograms",histograms),d.extendMethod("getAverage",averageImage),d.extendMethod("getAverageImage",averageImage),d.extendMethod("getMaxImage",maxImage),d.extendMethod("getMinImage",minImage)}let computedPropertyDescriptor={configurable:!0,enumerable:!1,get:void 0};class Stack extends Array{constructor(h){if(Array.isArray(h)){super(h.length);for(let p=0;p<h.length;p++)this[p]=h[p]}else typeof h=="number"?super(h):super();this.computed=null}static load(h){return Promise.all(h.map(Image$1.load)).then(p=>new Stack(p))}static extendMethod(h,p,m={}){let{inPlace:w=!1,returnThis:T=!0,partialArgs:k=[]}=m;return w?Stack.prototype[h]=function(...x){this.computed=null;let B=p.apply(this,[...k,...x]);return T?this:B}:Stack.prototype[h]=function(...x){return p.apply(this,[...k,...x])},Stack}static extendProperty(h,p,m={}){let{partialArgs:w=[]}=m;return computedPropertyDescriptor.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(h,this.computed))return this.computed[h];let T=p.apply(this,w);return this.computed[h]=T,T},Object.defineProperty(Stack.prototype,h,computedPropertyDescriptor),Stack}checkProcessable(h,p={}){if(typeof h!="string")throw new TypeError("checkProcessable requires as first parameter the processName (a string)");if(this.size===0)throw new TypeError(`The process: ${h} can not be applied on an empty stack`);this[0].checkProcessable(h,p);for(let m=1;m<this.length;m++){if((p.sameSize===void 0||p.sameSize)&&this[0].width!==this[m].width)throw new TypeError(`The process: ${h} can not be applied if width is not identical in all images`);if((p.sameSize===void 0||p.sameSize)&&this[0].height!==this[m].height)throw new TypeError(`The process: ${h} can not be applied if height is not identical in all images`);if((p.sameAlpha===void 0||p.sameAlpha)&&this[0].alpha!==this[m].alpha)throw new TypeError(`The process: ${h} can not be applied if alpha is not identical in all images`);if((p.sameBitDepth===void 0||p.sameBitDepth)&&this[0].bitDepth!==this[m].bitDepth)throw new TypeError(`The process: ${h} can not be applied if bitDepth is not identical in all images`);if((p.sameColorModel===void 0||p.sameColorModel)&&this[0].colorModel!==this[m].colorModel)throw new TypeError(`The process: ${h} can not be applied if colorModel is not identical in all images`);if((p.sameNumberChannels===void 0||p.sameNumberChannels)&&this[0].channels!==this[m].channels)throw new TypeError(`The process: ${h} can not be applied if channels is not identical in all images`)}}}Array[Symbol.species]||(Stack.prototype.map=function(d,h){if(typeof d!="function")throw new TypeError(`${d} is not a function`);let p=new Stack(this.length);for(let m=0;m<this.length;m++)p[m]=d.call(h,this[m],m,this);return p});extend$5(Stack);const isDataURL=/^data:[a-z]+\/(?:[a-z]+);base64,/;function load(d,h){if(typeof d=="string")return loadURL(d,h);if(d instanceof ArrayBuffer)return Promise.resolve(loadBinary(new Uint8Array(d)));if(d.buffer)return Promise.resolve(loadBinary(d));throw new Error('argument to "load" must be a string or buffer.')}function loadBinary(d,h){const p=imageType$1(d);if(p)switch(p.mime){case"image/png":return loadPNG(d);case"image/jpeg":return loadJPEG(d);case"image/tiff":return loadTIFF(d);default:return loadGeneric(m(p.mime))}return loadGeneric(m("application/octet-stream"));function m(w){return h||toBase64URL(d,w)}}function loadURL(d,h){const p=d.slice(0,64).match(isDataURL);let m;return p!==null?m=Promise.resolve(decode$4(d.slice(p[0].length))):m=fetchBinary(d,h),m.then(w=>{const T=new Uint8Array(w);return loadBinary(T,p?d:void 0)})}function loadPNG(d){const h=decodePng(d);let p=h.channels,m,w=0;return p===2||p===4?(m=p-1,w=1):m=p,h.palette?loadPNGFromPalette(h):new Image$1(h.width,h.height,h.data,{components:m,alpha:w,bitDepth:h.depth})}function loadPNGFromPalette(d){const h=d.width*d.height,p=d.palette[0].length,m=new Uint8Array(h*p),w=8/d.depth,T=d.depth<8?w:1,k=parseInt("1".repeat(d.depth),2),x=p===4;let B=0;for(let P=0;P<h;P++){const O=Math.floor(P/T);let U=d.data[O];d.depth<8&&(U=U>>>d.depth*(w-1-P%w)&k);const G=d.palette[U];m[B++]=G[0],m[B++]=G[1],m[B++]=G[2],x&&(m[B++]=G[3])}return new Image$1(d.width,d.height,m,{components:3,alpha:x,bitDepth:8})}function loadJPEG(d){const h=decode$1(d);let p;h.exif&&(p=getMetadata(h.exif));const m=jpegJs.decode(d,{useTArray:!0,maxMemoryUsageInMB:1024});let w=new Image$1(m.width,m.height,m.data,{meta:p});if(p&&p.tiff.tags.Orientation){const T=p.tiff.tags.Orientation;T>2&&(w=w.rotate({3:180,4:180,5:90,6:90,7:270,8:270}[T])),[2,4,5,7].includes(T)&&(w=w.flipX())}return w}function loadTIFF(d){let h=decodeTIFF(d);return h.length===1?getImageFromIFD(h[0]):new Stack(h.map(getImageFromIFD))}function getMetadata(d){const h={tiff:{fields:d.fields,tags:d.map}};return d.exif&&(h.exif=d.exif),d.gps&&(h.gps=d.gps),h}function getImageFromIFD(d){if(d.type===3){const h=new Uint16Array(3*d.width*d.height),p=d.palette;let m=0;for(let w=0;w<d.data.length;w++){const T=d.data[w],k=p[T];h[m++]=k[0],h[m++]=k[1],h[m++]=k[2]}return new Image$1(d.width,d.height,h,{components:3,alpha:d.alpha,colorModel:RGB$1,bitDepth:16,meta:getMetadata(d)})}else return new Image$1(d.width,d.height,d.data,{components:d.type===2?3:1,alpha:d.alpha,colorModel:d.type===2?RGB$1:GREY$1,bitDepth:d.bitsPerSample.length?d.bitsPerSample[0]:d.bitsPerSample,meta:getMetadata(d)})}function loadGeneric(d,h){return h=h||{},new Promise(function(p,m){let w=new DOMImage;w.onload=function(){let T=w.width,k=w.height,B=createCanvas(T,k).getContext("2d");B.drawImage(w,0,0,T,k);let P=B.getImageData(0,0,T,k).data;p(new Image$1(T,k,P,h))},w.onerror=function(){m(new Error(`Could not load ${d}`))},w.src=d})}const valueMethods={getValueXY(d,h,p){return this.data[(h*this.width+d)*this.channels+p]},setValueXY(d,h,p,m){return this.data[(h*this.width+d)*this.channels+p]=m,this.computed=null,this},getValue(d,h){return this.data[d*this.channels+h]},setValue(d,h,p){return this.data[d*this.channels+h]=p,this.computed=null,this},getPixelXY(d,h){return this.getPixel(h*this.width+d)},setPixelXY(d,h,p){return this.setPixel(h*this.width+d,p)},getPixel(d){const h=new Array(this.channels),p=d*this.channels;for(let m=0;m<this.channels;m++)h[m]=this.data[p+m];return h},setPixel(d,h){const p=d*this.channels;for(let m=0;m<h.length;m++)this.data[p+m]=h[m];return this.computed=null,this}};function setValueMethods(d){for(const h in valueMethods)d.prototype[h]=valueMethods[h]}function getImageParameters(d){return{width:d.width,height:d.height,components:d.components,alpha:d.alpha,colorModel:d.colorModel,bitDepth:d.bitDepth}}function getOutputImage(d,h,p,m={}){const{out:w}=h;if(w===void 0)return m.copy?d.clone():Image$1.createFrom(d,p);{if(!Image$1.isImage(w))throw new TypeError("out must be an Image object");const T=Object.assign(getImageParameters(d),p);for(const k in T)if(w[k]!==T[k])throw new RangeError(`cannot use out. Its ${k} must be "${T[k]}" (found "${w[k]}")`);return w}}function getOutputImageOrInPlace(d,h,p){if(h.inPlace!==void 0&&typeof h.inPlace!="boolean")throw new TypeError("inPlace option must be a boolean");if(h.inPlace){if(h.out!==void 0)throw new TypeError("out option must not be set if inPlace option is true");return d}return getOutputImage(d,h,null,p)}function abs(d={}){this.checkProcessable("abs",{bitDepth:[32]});const h=getOutputImageOrInPlace(this,d);return absolute(this,h),h}function absolute(d,h){for(let p=0;p<d.data.length;p++)h.data[p]=Math.abs(d.data[p])}function copyAlphaChannel(d,h){if(d.alpha===1&&h.alpha===1)for(let p=0;p<d.size;p++)h.data[p*h.channels+h.components]=d.data[p*d.channels+d.components]}function invert(d={}){this.checkProcessable("invert",{bitDepth:[1,8,16]});const h=getOutputImageOrInPlace(this,d);return this.bitDepth===1?invertBinary(this,h):(invertColor(this,h),this!==h&&copyAlphaChannel(this,h)),h}function invertBinary(d,h){for(let p=0;p<d.data.length;p++)h.data[p]=~d.data[p]}function invertColor(d,h){for(let p=0;p<d.data.length;p+=d.channels)for(let m=0;m<d.components;m++)h.data[p+m]=d.maxValue-d.data[p+m]}function flipX(){this.checkProcessable("flipX",{bitDepth:[8,16]});for(let d=0;d<this.height;d++){let h=d*this.width*this.channels;for(let p=0;p<Math.floor(this.width/2);p++){let m=p*this.channels+h,w=(this.width-p-1)*this.channels+h;for(let T=0;T<this.channels;T++){let k=this.data[m+T];this.data[m+T]=this.data[w+T],this.data[w+T]=k}}}return this}function flipY(){this.checkProcessable("flipY",{bitDepth:[8,16]});for(let d=0;d<Math.floor(this.height/2);d++)for(let h=0;h<this.width;h++){let p=h*this.channels+d*this.width*this.channels,m=h*this.channels+(this.height-1-d)*this.channels*this.width;for(let w=0;w<this.channels;w++){let T=this.data[p+w];this.data[p+w]=this.data[m+w],this.data[m+w]=T}}return this}function blurFilter(d={}){const{radius:h=1}=d;if(h<1)throw new Error("radius must be greater than 1");const p=2*h+1,m=new Array(p);for(let w=0;w<p;w++){m[w]=new Array(p);for(let T=0;T<p;T++)m[w][T]=1/(p*p)}return this.convolution(m)}var medianQuickselect_min={exports:{}};(function(d){(function(){function h(w){for(var T=0,k=w.length-1,x=void 0,B=void 0,P=void 0,O=m(T,k);;){if(k<=T)return w[O];if(k==T+1)return w[T]>w[k]&&p(w,T,k),w[O];for(x=m(T,k),w[x]>w[k]&&p(w,x,k),w[T]>w[k]&&p(w,T,k),w[x]>w[T]&&p(w,x,T),p(w,x,T+1),B=T+1,P=k;;){do B++;while(w[T]>w[B]);do P--;while(w[P]>w[T]);if(P<B)break;p(w,B,P)}p(w,T,P),P<=O&&(T=B),P>=O&&(k=P-1)}}var p=function(T,k,x){var B;return B=[T[x],T[k]],T[k]=B[0],T[x]=B[1],B},m=function(T,k){return~~((T+k)/2)};d.exports?d.exports=h:window.median=h})()})(medianQuickselect_min);var quickSelectMedian=medianQuickselect_min.exports;function validateArrayOfChannels(d,h={}){let{channels:p,allowAlpha:m,defaultAlpha:w}=h;return typeof m!="boolean"&&(m=!0),typeof p=="undefined"?allChannels(d,w):validateChannels(d,p,m)}function allChannels(d,h){let p=h?d.channels:d.components,m=new Array(p);for(let w=0;w<p;w++)m[w]=w;return m}function validateChannels(d,h,p){Array.isArray(h)||(h=[h]);for(let m=0;m<h.length;m++)h[m]=validateChannel(d,h[m],p);return h}function validateChannel(d,h,p=!0){if(h===void 0)throw new RangeError(`validateChannel : the channel has to be >=0 and <${d.channels}`);if(typeof h=="string"){switch(d.colorModel){case GREY$1:break;case RGB$1:if("rgb".includes(h))switch(h){case"r":h=0;break;case"g":h=1;break;case"b":h=2;break}break;case HSL:if("hsl".includes(h))switch(h){case"h":h=0;break;case"s":h=1;break;case"l":h=2;break}break;case HSV:if("hsv".includes(h))switch(h){case"h":h=0;break;case"s":h=1;break;case"v":h=2;break}break;case CMYK$1:if("cmyk".includes(h))switch(h){case"c":h=0;break;case"m":h=1;break;case"y":h=2;break;case"k":h=3;break}break;default:throw new Error(`Unexpected color model: ${d.colorModel}`)}if(h==="a"){if(!d.alpha)throw new Error("validateChannel : the image does not contain alpha channel");h=d.components}if(typeof h=="string")throw new Error(`validateChannel : undefined channel: ${h}`)}if(h>=d.channels)throw new RangeError(`validateChannel : the channel has to be >=0 and <${d.channels}`);if(!p&&h>=d.components)throw new RangeError("validateChannel : alpha channel may not be selected");return h}function medianFilter(d={}){let{radius:h=1,border:p="copy",channels:m}=d;if(this.checkProcessable("medianFilter",{bitDepth:[8,16]}),h<1)throw new Error("radius must be greater than 0");m=validateArrayOfChannels(this,m);let w=h,T=h,k=Image$1.createFrom(this),x=(w*2+1)*(T*2+1),B=new Array(x);for(let P=0;P<m.length;P++){let O=m[P];for(let U=T;U<this.height-T;U++)for(let G=w;G<this.width-w;G++){let j=0;for(let te=-T;te<=T;te++)for(let oe=-w;oe<=w;oe++){let Q=((U+te)*this.width+G+oe)*this.channels+O;B[j++]=this.data[Q]}let H=(U*this.width+G)*this.channels+O;k.data[H]=quickSelectMedian(B)}}if(this.alpha&&!m.includes(this.channels))for(let P=this.components;P<this.data.length;P=P+this.channels)k.data[P]=this.data[P];return k.setBorder({size:[w,T],algorithm:p}),k}function gaussianFilter(d={}){let{radius:h=1,sigma:p,channels:m,border:w="copy"}=d;this.checkProcessable("gaussian",{bitDepth:[8,16]});const T=getKernel(h,p);return this.convolution([T,T],{border:w,channels:m,algorithm:"separable"})}function getKernel(d,h){const p=d*2+1,m=new Array(p),w=h||((p-1)*.5-1)*.3+.8,T=-.5/(w*w);let k=0;for(let x=0;x<p;x++){const B=x-d,P=Math.exp(T*B*B);m[x]=P,k+=P}for(let x=0;x<p;x++)m[x]/=k;return m}const SOBEL_X=[[-1,0,1],[-2,0,2],[-1,0,1]],SOBEL_Y=[[-1,-2,-1],[0,0,0],[1,2,1]],SCHARR_X=[[3,0,-3],[10,0,-10],[3,0,-3]],SCHARR_Y=[[3,10,3],[0,0,0],[-3,-10,-3]];var src$3={},fftlib={};(function(d){(function(){var h;h=d;var p={release:"0.3.0",date:"2013-03"};h.toString=function(){return"version "+p.release+", released "+p.date};for(var m=0,w=null,T=null,k={init:function(P){if(P!==0&&(P&P-1)===0)m=P,k._initArray(),k._makeBitReversalTable(),k._makeCosSinTable();else throw new Error("init: radix-2 required")},fft1d:function(P,O){k.fft(P,O,1)},ifft1d:function(P,O){var U=1/m;k.fft(P,O,-1);for(var G=0;G<m;G++)P[G]*=U,O[G]*=U},bt1d:function(P,O){k.fft(P,O,-1)},fft2d:function(P,O){for(var U=[],G=[],j=0,H=0;H<m;H++){j=H*m;for(var te=0;te<m;te++)U[te]=P[te+j],G[te]=O[te+j];k.fft1d(U,G);for(var oe=0;oe<m;oe++)P[oe+j]=U[oe],O[oe+j]=G[oe]}for(var Q=0;Q<m;Q++){for(var _e=0;_e<m;_e++)j=Q+_e*m,U[_e]=P[j],G[_e]=O[j];k.fft1d(U,G);for(var se=0;se<m;se++)j=Q+se*m,P[j]=U[se],O[j]=G[se]}},ifft2d:function(P,O){for(var U=[],G=[],j=0,H=0;H<m;H++){j=H*m;for(var te=0;te<m;te++)U[te]=P[te+j],G[te]=O[te+j];k.ifft1d(U,G);for(var oe=0;oe<m;oe++)P[oe+j]=U[oe],O[oe+j]=G[oe]}for(var Q=0;Q<m;Q++){for(var _e=0;_e<m;_e++)j=Q+_e*m,U[_e]=P[j],G[_e]=O[j];k.ifft1d(U,G);for(var se=0;se<m;se++)j=Q+se*m,P[j]=U[se],O[j]=G[se]}},fft:function(P,O,U){for(var G,j,H,te,oe,Q,_e,se,le,me=m>>2,Re=0;Re<m;Re++)te=w[Re],Re<te&&(oe=P[Re],P[Re]=P[te],P[te]=oe,oe=O[Re],O[Re]=O[te],O[te]=oe);for(var xe=1;xe<m;xe<<=1){j=0,G=m/(xe<<1);for(var ue=0;ue<xe;ue++){Q=T[j+me],_e=U*T[j];for(var Me=ue;Me<m;Me+=xe<<1)H=Me+xe,se=Q*P[H]+_e*O[H],le=Q*O[H]-_e*P[H],P[H]=P[Me]-se,P[Me]+=se,O[H]=O[Me]-le,O[Me]+=le;j+=G}}},_initArray:function(){typeof Uint32Array!="undefined"?w=new Uint32Array(m):w=[],typeof Float64Array!="undefined"?T=new Float64Array(m*1.25):T=[]},_paddingZero:function(){},_makeBitReversalTable:function(){var P=0,O=0,U=0;for(w[0]=0;++P<m;){for(U=m>>1;U<=O;)O-=U,U>>=1;O+=U,w[P]=O}},_makeCosSinTable:function(){var P=m>>1,O=m>>2,U=m>>3,G=P+O,j=Math.sin(Math.PI/m),H=2*j*j,te=Math.sqrt(H*(2-H)),oe=T[O]=1,Q=T[0]=0;j=2*H;for(var _e=1;_e<U;_e++)oe-=H,H+=j*oe,Q+=te,te-=j*Q,T[_e]=Q,T[O-_e]=oe;U!==0&&(T[U]=Math.sqrt(.5));for(var se=0;se<O;se++)T[P-se]=T[se];for(var le=0;le<G;le++)T[le+P]=-T[le]}},x=["init","fft1d","ifft1d","fft2d","ifft2d"],B=0;B<x.length;B++)h[x[B]]=k[x[B]];return h.bt=k.bt1d,h.fft=k.fft1d,h.ifft=k.ifft1d,h}).call(commonjsGlobal)})(fftlib);var FFT=fftlib,FFTUtils$1={DEBUG:!1,ifft2DArray:function(d,h,p){var m=new Array(h*p),w=h/2,T=(p-1)*2;FFT.init(w);for(var k={re:new Array(w),im:new Array(w)},x=0;x<p;x++){for(var B=w-1;B>=0;B--)k.re[B]=d[B*2*p+x],k.im[B]=d[(B*2+1)*p+x];FFT.bt(k.re,k.im);for(var B=w-1;B>=0;B--)m[B*2*p+x]=k.re[B],m[(B*2+1)*p+x]=k.im[B]}var P=new Array(w*T);FFT.init(T);for(var O={re:new Array(T),im:new Array(T)},U=T*w,B=0;B<h;B+=2){O.re[0]=m[B*p],O.im[0]=m[(B+1)*p];for(var x=1;x<p;x++)O.re[x]=m[B*p+x],O.im[x]=m[(B+1)*p+x],O.re[T-x]=m[B*p+x],O.im[T-x]=-m[(B+1)*p+x];FFT.bt(O.re,O.im);for(var G=B/2*T,x=T-1;x>=0;x--)P[G+x]=O.re[x]/U}return P},fft2DArray:function(d,h,p,m){Object.assign({},{inplace:!0});var w=p/2+1,T=h*2,k=new Array(T*w);FFT.init(p);for(var x={re:new Array(p),im:new Array(p)},B={re:new Array(p),im:new Array(p)},P={re:new Array(p),im:new Array(p)},O,U,G,j,H,te=0;te<h/2;te++){O=te*2*p,x.re=d.slice(O,O+p),O=(te*2+1)*p,x.im=d.slice(O,O+p),FFT.fft1d(x.re,x.im),this.reconstructTwoRealFFT(x,B,P),U=te*4*w,G=(te*4+1)*w,j=(te*4+2)*w,H=(te*4+3)*w;for(var oe=w-1;oe>=0;oe--)k[U+oe]=B.re[oe],k[G+oe]=B.im[oe],k[j+oe]=P.re[oe],k[H+oe]=P.im[oe]}B=null,P=null;var Q=new Array(T*w);FFT.init(h);for(var _e={re:new Array(h),im:new Array(h)},se=w-1;se>=0;se--){for(var te=h-1;te>=0;te--)_e.re[te]=k[te*2*w+se],_e.im[te]=k[(te*2+1)*w+se],isNaN(_e.re[te])&&(_e.re[te]=0),isNaN(_e.im[te])&&(_e.im[te]=0);FFT.fft1d(_e.re,_e.im);for(var te=h-1;te>=0;te--)Q[te*2*w+se]=_e.re[te],Q[(te*2+1)*w+se]=_e.im[te]}return Q},reconstructTwoRealFFT:function(d,h,p){var m=d.re.length;h.re[0]=d.re[0],h.im[0]=0,p.re[0]=d.im[0],p.im[0]=0;for(var w,T,k,x,B,P=m/2;P>0;P--)B=m-P,w=.5*(d.re[P]-d.re[B]),T=.5*(d.re[P]+d.re[B]),k=.5*(d.im[P]-d.im[B]),x=.5*(d.im[P]+d.im[B]),h.re[P]=T,h.im[P]=k,h.re[B]=T,h.im[B]=-k,p.re[P]=x,p.im[P]=-w,p.re[B]=x,p.im[B]=w},convolute2DI:function(d,h,p,m){for(var w,T,k=0;k<p/2;k++)for(var x=0;x<m;x++)w=d[k*2*m+x]*h[k*2*m+x]-d[(k*2+1)*m+x]*h[(k*2+1)*m+x],T=d[k*2*m+x]*h[(k*2+1)*m+x]+d[(k*2+1)*m+x]*h[k*2*m+x],d[k*2*m+x]=w,d[(k*2+1)*m+x]=T},convolute:function(d,h,p,m,w){for(var T=new Array(m*p),k=0;k<p*m;k++)T[k]=d[k];T=this.fft2DArray(T,p,m);for(var x=h.length,B=h[0].length,P=new Array(m*p),k=0;k<m*p;k++)P[k]=0;for(var O,U,G=Math.floor((x-1)/2),j=Math.floor((B-1)/2),H=0;H<x;H++){O=(H-G+p)%p;for(var te=0;te<B;te++)U=(te-j+m)%m,P[O*m+U]=h[H][te]}P=this.fft2DArray(P,p,m);var oe=p*2,Q=m/2+1;return this.convolute2DI(T,P,oe,Q),this.ifft2DArray(T,oe,Q)},toRadix2:function(d,h,p){var m,w,T,k,x=p,B=h;if(!(p!==0&&(p&p-1)===0)){for(x=0;p>>++x!=0;);x=1<<x}if(!(h!==0&&(h&h-1)===0)){for(B=0;h>>++B!=0;);B=1<<B}if(B==h&&x==p)return{data:d,rows:h,cols:p};var P=new Array(B*x),O=Math.floor((B-h)/2)-h,U=Math.floor((x-p)/2)-p;for(m=0;m<B;m++)for(T=m*x,k=(m-O)%h*p,w=0;w<x;w++)P[T+w]=d[k+(w-U)%p];return{data:P,rows:B,cols:x}},crop:function(d,h,p,m,w,T){if(h==m&&p==w)return d;Object.assign({},T);var k=new Array(w*m),x=Math.floor((h-m)/2),B=Math.floor((p-w)/2),P,O,U,G;for(U=0;U<m;U++)for(P=U*w,O=(U+x)*p,G=0;G<w;G++)k[P+G]=d[O+(G+B)];return k}},FFTUtils_1=FFTUtils$1;src$3.FFTUtils=FFTUtils_1;src$3.FFT=fftlib;var FFTUtils=src$3.FFTUtils;function convolutionFFT(d,h,p){var m=matrix2Array(d),w=m.data,T=Object.assign({normalize:!1,divisor:1,rows:m.rows,cols:m.cols},p),k,x;if(T.rows&&T.cols)k=T.rows,x=T.cols;else throw new Error("Invalid number of rows or columns "+k+" "+x);var B=T.divisor,P,O,U=h.length,G=h[0].length;if(T.normalize)for(B=0,P=0;P<U;P++)for(O=0;O<G;O++)B+=h[P][O];if(B===0)throw new RangeError("convolution: The divisor is equal to zero");var j=FFTUtils.toRadix2(w,k,x),H=FFTUtils.convolute(j.data,h,j.rows,j.cols);if(H=FFTUtils.crop(H,j.rows,j.cols,k,x),B!=0&&B!=1)for(P=0;P<H.length;P++)H[P]/=B;return H}function convolutionDirect(d,h,p){var m=matrix2Array(d),w=m.data,T=Object.assign({normalize:!1,divisor:1,rows:m.rows,cols:m.cols},p),k,x;if(T.rows&&T.cols)k=T.rows,x=T.cols;else throw new Error("Invalid number of rows or columns "+k+" "+x);var B=T.divisor,P=h.length,O=h[0].length,U,G,j,H,te,oe,Q,_e,se;if(T.normalize)for(B=0,U=0;U<P;U++)for(G=0;G<O;G++)B+=h[U][G];if(B===0)throw new RangeError("convolution: The divisor is equal to zero");var le=new Array(k*x),me=Math.floor(P/2),Re=Math.floor(O/2);for(H=0;H<k;H++)for(j=0;j<x;j++){for(oe=0,G=0;G<P;G++)for(U=0;U<O;U++)Q=h[P-G-1][O-U-1],_e=(H+G-me+k)%k,se=(j+U-Re+x)%x,te=_e*x+se,oe+=w[te]*Q;te=H*x+j,le[te]=oe/B}return le}function LoG(d,h,p){var m=1e3;p&&p.factor&&(m=p.factor);var w=new Array(h),T,k,x,B;m*=-1;var P=(h-1)/2,O=2*d*d;for(T=0;T<h;T++)for(w[T]=new Array(h),B=(T-P)*(T-P),k=0;k<h;k++)x=-((k-P)*(k-P)+B)/O,w[T][k]=Math.round(m*(1+x)*Math.exp(x));return w}function matrix2Array(d){var h=d,p,m;if(typeof d[0]!="number"){p=d.length,m=d[0].length,h=new Array(p*m);for(var w=0;w<p;w++)for(var T=0;T<m;T++)h[w*m+T]=d[w][T]}else{var k=Math.sqrt(d.length);Number.isInteger(k)&&(p=k,m=k)}return{data:h,rows:p,cols:m}}var src$2={fft:convolutionFFT,direct:convolutionDirect,kernelFactory:{LoG},matrix2Array},_isFinite=Number.isFinite||function(d){return!(typeof d!="number"||d!==d||d===1/0||d===-1/0)},isFinite$1=_isFinite,isInteger=Number.isInteger||function(d){return typeof d=="number"&&isFinite$1(d)&&Math.floor(d)===d};function validateKernel(d){let h,p;if(Array.isArray(d))if(Array.isArray(d[0])){if((d.length&1)===0||(d[0].length&1)===0)throw new RangeError("validateKernel: Kernel rows and columns should be odd numbers");h=Math.floor(d.length/2),p=Math.floor(d[0].length/2)}else{let m=Math.sqrt(d.length);if(isInteger(m))p=h=Math.floor(Math.sqrt(d.length)/2);else throw new RangeError("validateKernel: Kernel array should be a square");let w=new Array(m);for(let T=0;T<m;T++){w[T]=new Array(m);for(let k=0;k<m;k++)w[T][k]=d[T*m+k]}d=w}else throw new Error(`validateKernel: Invalid Kernel: ${d}`);return{kernel:d,kWidth:p,kHeight:h}}function clamp(d,h){return Math.round(Math.min(Math.max(d,0),h.maxValue))}function directConvolution(d,h,p){if(p===void 0){const T=d.length+h.length-1;p=new Array(T)}fill(p);for(var m=0;m<d.length;m++)for(var w=0;w<h.length;w++)p[m+w]+=d[m]*h[w];return p}function fill(d){for(var h=0;h<d.length;h++)d[h]=0}function convolutionSeparable(d,h,p,m){const w=new Array(d.length);let T,k,x,B;B=h[1],x=(B.length-1)/2,k=new Array(p+B.length-1),T=new Array(p);for(let P=0;P<m;P++){for(let O=0;O<p;O++)T[O]=d[P*p+O];directConvolution(T,B,k);for(let O=0;O<p;O++)w[P*p+O]=k[x+O]}B=h[0],x=(B.length-1)/2,k=new Array(m+B.length-1),T=new Array(m);for(let P=0;P<p;P++){for(let O=0;O<m;O++)T[O]=w[O*p+P];directConvolution(T,B,k);for(let O=0;O<m;O++)w[O*p+P]=k[x+O]}return w}const toString$2=Object.prototype.toString;function isAnyArray(d){return toString$2.call(d).endsWith("Array]")}function max$1(d){var h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(d))throw new TypeError("input must be an array");if(d.length===0)throw new TypeError("input must not be empty");var p=h.fromIndex,m=p===void 0?0:p,w=h.toIndex,T=w===void 0?d.length:w;if(m<0||m>=d.length||!Number.isInteger(m))throw new Error("fromIndex must be a positive integer smaller than length");if(T<=m||T>d.length||!Number.isInteger(T))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var k=d[m],x=m+1;x<T;x++)d[x]>k&&(k=d[x]);return k}function min$1(d){var h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(d))throw new TypeError("input must be an array");if(d.length===0)throw new TypeError("input must not be empty");var p=h.fromIndex,m=p===void 0?0:p,w=h.toIndex,T=w===void 0?d.length:w;if(m<0||m>=d.length||!Number.isInteger(m))throw new Error("fromIndex must be a positive integer smaller than length");if(T<=m||T>d.length||!Number.isInteger(T))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var k=d[m],x=m+1;x<T;x++)d[x]<k&&(k=d[x]);return k}function rescale(d){var h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(isAnyArray(d)){if(d.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var p;if(h.output!==void 0){if(!isAnyArray(h.output))throw new TypeError("output option must be an array if specified");p=h.output}else p=new Array(d.length);var m=min$1(d),w=max$1(d);if(m===w)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var T=h.min,k=T===void 0?h.autoMinMax?m:0:T,x=h.max,B=x===void 0?h.autoMinMax?w:1:x;if(k>=B)throw new RangeError("min option must be smaller than max option");for(var P=(B-k)/(w-m),O=0;O<d.length;O++)p[O]=(d[O]-m)*P+k;return p}const indent=" ".repeat(2),indentData=" ".repeat(4);function inspectMatrix(){return inspectMatrixWithOptions(this)}function inspectMatrixWithOptions(d,h={}){const{maxRows:p=15,maxColumns:m=10,maxNumSize:w=8}=h;return`${d.constructor.name} {
${indent}[
${indentData}${inspectData(d,p,m,w)}
${indent}]
${indent}rows: ${d.rows}
${indent}columns: ${d.columns}
}`}function inspectData(d,h,p,m){const{rows:w,columns:T}=d,k=Math.min(w,h),x=Math.min(T,p),B=[];for(let P=0;P<k;P++){let O=[];for(let U=0;U<x;U++)O.push(formatNumber(d.get(P,U),m));B.push(`${O.join(" ")}`)}return x!==T&&(B[B.length-1]+=` ... ${T-p} more columns`),k!==w&&B.push(`... ${w-h} more rows`),B.join(`
${indentData}`)}function formatNumber(d,h){const p=String(d);if(p.length<=h)return p.padEnd(h," ");const m=d.toPrecision(h-2);if(m.length<=h)return m;const w=d.toExponential(h-2),T=w.indexOf("e"),k=w.slice(T);return w.slice(0,h-k.length)+k}function installMathOperations(d,h){d.prototype.add=function(m){return typeof m=="number"?this.addS(m):this.addM(m)},d.prototype.addS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)+m);return this},d.prototype.addM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)+m.get(w,T));return this},d.add=function(m,w){return new h(m).add(w)},d.prototype.sub=function(m){return typeof m=="number"?this.subS(m):this.subM(m)},d.prototype.subS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)-m);return this},d.prototype.subM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)-m.get(w,T));return this},d.sub=function(m,w){return new h(m).sub(w)},d.prototype.subtract=d.prototype.sub,d.prototype.subtractS=d.prototype.subS,d.prototype.subtractM=d.prototype.subM,d.subtract=d.sub,d.prototype.mul=function(m){return typeof m=="number"?this.mulS(m):this.mulM(m)},d.prototype.mulS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)*m);return this},d.prototype.mulM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)*m.get(w,T));return this},d.mul=function(m,w){return new h(m).mul(w)},d.prototype.multiply=d.prototype.mul,d.prototype.multiplyS=d.prototype.mulS,d.prototype.multiplyM=d.prototype.mulM,d.multiply=d.mul,d.prototype.div=function(m){return typeof m=="number"?this.divS(m):this.divM(m)},d.prototype.divS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)/m);return this},d.prototype.divM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)/m.get(w,T));return this},d.div=function(m,w){return new h(m).div(w)},d.prototype.divide=d.prototype.div,d.prototype.divideS=d.prototype.divS,d.prototype.divideM=d.prototype.divM,d.divide=d.div,d.prototype.mod=function(m){return typeof m=="number"?this.modS(m):this.modM(m)},d.prototype.modS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)%m);return this},d.prototype.modM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)%m.get(w,T));return this},d.mod=function(m,w){return new h(m).mod(w)},d.prototype.modulus=d.prototype.mod,d.prototype.modulusS=d.prototype.modS,d.prototype.modulusM=d.prototype.modM,d.modulus=d.mod,d.prototype.and=function(m){return typeof m=="number"?this.andS(m):this.andM(m)},d.prototype.andS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)&m);return this},d.prototype.andM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)&m.get(w,T));return this},d.and=function(m,w){return new h(m).and(w)},d.prototype.or=function(m){return typeof m=="number"?this.orS(m):this.orM(m)},d.prototype.orS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)|m);return this},d.prototype.orM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)|m.get(w,T));return this},d.or=function(m,w){return new h(m).or(w)},d.prototype.xor=function(m){return typeof m=="number"?this.xorS(m):this.xorM(m)},d.prototype.xorS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)^m);return this},d.prototype.xorM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)^m.get(w,T));return this},d.xor=function(m,w){return new h(m).xor(w)},d.prototype.leftShift=function(m){return typeof m=="number"?this.leftShiftS(m):this.leftShiftM(m)},d.prototype.leftShiftS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)<<m);return this},d.prototype.leftShiftM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)<<m.get(w,T));return this},d.leftShift=function(m,w){return new h(m).leftShift(w)},d.prototype.signPropagatingRightShift=function(m){return typeof m=="number"?this.signPropagatingRightShiftS(m):this.signPropagatingRightShiftM(m)},d.prototype.signPropagatingRightShiftS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)>>m);return this},d.prototype.signPropagatingRightShiftM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)>>m.get(w,T));return this},d.signPropagatingRightShift=function(m,w){return new h(m).signPropagatingRightShift(w)},d.prototype.rightShift=function(m){return typeof m=="number"?this.rightShiftS(m):this.rightShiftM(m)},d.prototype.rightShiftS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)>>>m);return this},d.prototype.rightShiftM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,this.get(w,T)>>>m.get(w,T));return this},d.rightShift=function(m,w){return new h(m).rightShift(w)},d.prototype.zeroFillRightShift=d.prototype.rightShift,d.prototype.zeroFillRightShiftS=d.prototype.rightShiftS,d.prototype.zeroFillRightShiftM=d.prototype.rightShiftM,d.zeroFillRightShift=d.rightShift,d.prototype.not=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,~this.get(m,w));return this},d.not=function(m){return new h(m).not()},d.prototype.abs=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.abs(this.get(m,w)));return this},d.abs=function(m){return new h(m).abs()},d.prototype.acos=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.acos(this.get(m,w)));return this},d.acos=function(m){return new h(m).acos()},d.prototype.acosh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.acosh(this.get(m,w)));return this},d.acosh=function(m){return new h(m).acosh()},d.prototype.asin=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.asin(this.get(m,w)));return this},d.asin=function(m){return new h(m).asin()},d.prototype.asinh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.asinh(this.get(m,w)));return this},d.asinh=function(m){return new h(m).asinh()},d.prototype.atan=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.atan(this.get(m,w)));return this},d.atan=function(m){return new h(m).atan()},d.prototype.atanh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.atanh(this.get(m,w)));return this},d.atanh=function(m){return new h(m).atanh()},d.prototype.cbrt=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.cbrt(this.get(m,w)));return this},d.cbrt=function(m){return new h(m).cbrt()},d.prototype.ceil=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.ceil(this.get(m,w)));return this},d.ceil=function(m){return new h(m).ceil()},d.prototype.clz32=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.clz32(this.get(m,w)));return this},d.clz32=function(m){return new h(m).clz32()},d.prototype.cos=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.cos(this.get(m,w)));return this},d.cos=function(m){return new h(m).cos()},d.prototype.cosh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.cosh(this.get(m,w)));return this},d.cosh=function(m){return new h(m).cosh()},d.prototype.exp=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.exp(this.get(m,w)));return this},d.exp=function(m){return new h(m).exp()},d.prototype.expm1=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.expm1(this.get(m,w)));return this},d.expm1=function(m){return new h(m).expm1()},d.prototype.floor=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.floor(this.get(m,w)));return this},d.floor=function(m){return new h(m).floor()},d.prototype.fround=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.fround(this.get(m,w)));return this},d.fround=function(m){return new h(m).fround()},d.prototype.log=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.log(this.get(m,w)));return this},d.log=function(m){return new h(m).log()},d.prototype.log1p=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.log1p(this.get(m,w)));return this},d.log1p=function(m){return new h(m).log1p()},d.prototype.log10=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.log10(this.get(m,w)));return this},d.log10=function(m){return new h(m).log10()},d.prototype.log2=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.log2(this.get(m,w)));return this},d.log2=function(m){return new h(m).log2()},d.prototype.round=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.round(this.get(m,w)));return this},d.round=function(m){return new h(m).round()},d.prototype.sign=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.sign(this.get(m,w)));return this},d.sign=function(m){return new h(m).sign()},d.prototype.sin=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.sin(this.get(m,w)));return this},d.sin=function(m){return new h(m).sin()},d.prototype.sinh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.sinh(this.get(m,w)));return this},d.sinh=function(m){return new h(m).sinh()},d.prototype.sqrt=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.sqrt(this.get(m,w)));return this},d.sqrt=function(m){return new h(m).sqrt()},d.prototype.tan=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.tan(this.get(m,w)));return this},d.tan=function(m){return new h(m).tan()},d.prototype.tanh=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.tanh(this.get(m,w)));return this},d.tanh=function(m){return new h(m).tanh()},d.prototype.trunc=function(){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.set(m,w,Math.trunc(this.get(m,w)));return this},d.trunc=function(m){return new h(m).trunc()},d.pow=function(m,w){return new h(m).pow(w)},d.prototype.pow=function(m){return typeof m=="number"?this.powS(m):this.powM(m)},d.prototype.powS=function(m){for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,Math.pow(this.get(w,T),m));return this},d.prototype.powM=function(m){if(m=h.checkMatrix(m),this.rows!==m.rows||this.columns!==m.columns)throw new RangeError("Matrices dimensions must be equal");for(let w=0;w<this.rows;w++)for(let T=0;T<this.columns;T++)this.set(w,T,Math.pow(this.get(w,T),m.get(w,T)));return this}}function checkRowIndex(d,h,p){let m=p?d.rows:d.rows-1;if(h<0||h>m)throw new RangeError("Row index out of range")}function checkColumnIndex(d,h,p){let m=p?d.columns:d.columns-1;if(h<0||h>m)throw new RangeError("Column index out of range")}function checkRowVector(d,h){if(h.to1DArray&&(h=h.to1DArray()),h.length!==d.columns)throw new RangeError("vector size must be the same as the number of columns");return h}function checkColumnVector(d,h){if(h.to1DArray&&(h=h.to1DArray()),h.length!==d.rows)throw new RangeError("vector size must be the same as the number of rows");return h}function checkIndices(d,h,p){return{row:checkRowIndices(d,h),column:checkColumnIndices(d,p)}}function checkRowIndices(d,h){if(typeof h!="object")throw new TypeError("unexpected type for row indices");if(h.some(m=>m<0||m>=d.rows))throw new RangeError("row indices are out of range");return Array.isArray(h)||(h=Array.from(h)),h}function checkColumnIndices(d,h){if(typeof h!="object")throw new TypeError("unexpected type for column indices");if(h.some(m=>m<0||m>=d.columns))throw new RangeError("column indices are out of range");return Array.isArray(h)||(h=Array.from(h)),h}function checkRange(d,h,p,m,w){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(checkNumber("startRow",h),checkNumber("endRow",p),checkNumber("startColumn",m),checkNumber("endColumn",w),h>p||m>w||h<0||h>=d.rows||p<0||p>=d.rows||m<0||m>=d.columns||w<0||w>=d.columns)throw new RangeError("Submatrix indices are out of range")}function newArray$1(d,h=0){let p=[];for(let m=0;m<d;m++)p.push(h);return p}function checkNumber(d,h){if(typeof h!="number")throw new TypeError(`${d} must be a number`)}function checkNonEmpty(d){if(d.isEmpty())throw new Error("Empty matrix has no elements to index")}function sumByRow(d){let h=newArray$1(d.rows);for(let p=0;p<d.rows;++p)for(let m=0;m<d.columns;++m)h[p]+=d.get(p,m);return h}function sumByColumn(d){let h=newArray$1(d.columns);for(let p=0;p<d.rows;++p)for(let m=0;m<d.columns;++m)h[m]+=d.get(p,m);return h}function sumAll(d){let h=0;for(let p=0;p<d.rows;p++)for(let m=0;m<d.columns;m++)h+=d.get(p,m);return h}function productByRow(d){let h=newArray$1(d.rows,1);for(let p=0;p<d.rows;++p)for(let m=0;m<d.columns;++m)h[p]*=d.get(p,m);return h}function productByColumn(d){let h=newArray$1(d.columns,1);for(let p=0;p<d.rows;++p)for(let m=0;m<d.columns;++m)h[m]*=d.get(p,m);return h}function productAll(d){let h=1;for(let p=0;p<d.rows;p++)for(let m=0;m<d.columns;m++)h*=d.get(p,m);return h}function varianceByRow(d,h,p){const m=d.rows,w=d.columns,T=[];for(let k=0;k<m;k++){let x=0,B=0,P=0;for(let O=0;O<w;O++)P=d.get(k,O)-p[k],x+=P,B+=P*P;h?T.push((B-x*x/w)/(w-1)):T.push((B-x*x/w)/w)}return T}function varianceByColumn(d,h,p){const m=d.rows,w=d.columns,T=[];for(let k=0;k<w;k++){let x=0,B=0,P=0;for(let O=0;O<m;O++)P=d.get(O,k)-p[k],x+=P,B+=P*P;h?T.push((B-x*x/m)/(m-1)):T.push((B-x*x/m)/m)}return T}function varianceAll(d,h,p){const m=d.rows,w=d.columns,T=m*w;let k=0,x=0,B=0;for(let P=0;P<m;P++)for(let O=0;O<w;O++)B=d.get(P,O)-p,k+=B,x+=B*B;return h?(x-k*k/T)/(T-1):(x-k*k/T)/T}function centerByRow(d,h){for(let p=0;p<d.rows;p++)for(let m=0;m<d.columns;m++)d.set(p,m,d.get(p,m)-h[p])}function centerByColumn(d,h){for(let p=0;p<d.rows;p++)for(let m=0;m<d.columns;m++)d.set(p,m,d.get(p,m)-h[m])}function centerAll(d,h){for(let p=0;p<d.rows;p++)for(let m=0;m<d.columns;m++)d.set(p,m,d.get(p,m)-h)}function getScaleByRow(d){const h=[];for(let p=0;p<d.rows;p++){let m=0;for(let w=0;w<d.columns;w++)m+=Math.pow(d.get(p,w),2)/(d.columns-1);h.push(Math.sqrt(m))}return h}function scaleByRow(d,h){for(let p=0;p<d.rows;p++)for(let m=0;m<d.columns;m++)d.set(p,m,d.get(p,m)/h[p])}function getScaleByColumn(d){const h=[];for(let p=0;p<d.columns;p++){let m=0;for(let w=0;w<d.rows;w++)m+=Math.pow(d.get(w,p),2)/(d.rows-1);h.push(Math.sqrt(m))}return h}function scaleByColumn(d,h){for(let p=0;p<d.rows;p++)for(let m=0;m<d.columns;m++)d.set(p,m,d.get(p,m)/h[m])}function getScaleAll(d){const h=d.size-1;let p=0;for(let m=0;m<d.columns;m++)for(let w=0;w<d.rows;w++)p+=Math.pow(d.get(w,m),2)/h;return Math.sqrt(p)}function scaleAll(d,h){for(let p=0;p<d.rows;p++)for(let m=0;m<d.columns;m++)d.set(p,m,d.get(p,m)/h)}class AbstractMatrix{static from1DArray(h,p,m){if(h*p!==m.length)throw new RangeError("data length does not match given dimensions");let T=new Matrix$2(h,p);for(let k=0;k<h;k++)for(let x=0;x<p;x++)T.set(k,x,m[k*p+x]);return T}static rowVector(h){let p=new Matrix$2(1,h.length);for(let m=0;m<h.length;m++)p.set(0,m,h[m]);return p}static columnVector(h){let p=new Matrix$2(h.length,1);for(let m=0;m<h.length;m++)p.set(m,0,h[m]);return p}static zeros(h,p){return new Matrix$2(h,p)}static ones(h,p){return new Matrix$2(h,p).fill(1)}static rand(h,p,m={}){if(typeof m!="object")throw new TypeError("options must be an object");const{random:w=Math.random}=m;let T=new Matrix$2(h,p);for(let k=0;k<h;k++)for(let x=0;x<p;x++)T.set(k,x,w());return T}static randInt(h,p,m={}){if(typeof m!="object")throw new TypeError("options must be an object");const{min:w=0,max:T=1e3,random:k=Math.random}=m;if(!Number.isInteger(w))throw new TypeError("min must be an integer");if(!Number.isInteger(T))throw new TypeError("max must be an integer");if(w>=T)throw new RangeError("min must be smaller than max");let x=T-w,B=new Matrix$2(h,p);for(let P=0;P<h;P++)for(let O=0;O<p;O++){let U=w+Math.round(k()*x);B.set(P,O,U)}return B}static eye(h,p,m){p===void 0&&(p=h),m===void 0&&(m=1);let w=Math.min(h,p),T=this.zeros(h,p);for(let k=0;k<w;k++)T.set(k,k,m);return T}static diag(h,p,m){let w=h.length;p===void 0&&(p=w),m===void 0&&(m=p);let T=Math.min(w,p,m),k=this.zeros(p,m);for(let x=0;x<T;x++)k.set(x,x,h[x]);return k}static min(h,p){h=this.checkMatrix(h),p=this.checkMatrix(p);let m=h.rows,w=h.columns,T=new Matrix$2(m,w);for(let k=0;k<m;k++)for(let x=0;x<w;x++)T.set(k,x,Math.min(h.get(k,x),p.get(k,x)));return T}static max(h,p){h=this.checkMatrix(h),p=this.checkMatrix(p);let m=h.rows,w=h.columns,T=new this(m,w);for(let k=0;k<m;k++)for(let x=0;x<w;x++)T.set(k,x,Math.max(h.get(k,x),p.get(k,x)));return T}static checkMatrix(h){return AbstractMatrix.isMatrix(h)?h:new Matrix$2(h)}static isMatrix(h){return h!=null&&h.klass==="Matrix"}get size(){return this.rows*this.columns}apply(h){if(typeof h!="function")throw new TypeError("callback must be a function");for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)h.call(this,p,m);return this}to1DArray(){let h=[];for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)h.push(this.get(p,m));return h}to2DArray(){let h=[];for(let p=0;p<this.rows;p++){h.push([]);for(let m=0;m<this.columns;m++)h[p].push(this.get(p,m))}return h}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let h=0;h<this.rows;h++)for(let p=0;p<=h;p++)if(this.get(h,p)!==this.get(p,h))return!1;return!0}return!1}isEchelonForm(){let h=0,p=0,m=-1,w=!0,T=!1;for(;h<this.rows&&w;){for(p=0,T=!1;p<this.columns&&T===!1;)this.get(h,p)===0?p++:this.get(h,p)===1&&p>m?(T=!0,m=p):(w=!1,T=!0);h++}return w}isReducedEchelonForm(){let h=0,p=0,m=-1,w=!0,T=!1;for(;h<this.rows&&w;){for(p=0,T=!1;p<this.columns&&T===!1;)this.get(h,p)===0?p++:this.get(h,p)===1&&p>m?(T=!0,m=p):(w=!1,T=!0);for(let k=p+1;k<this.rows;k++)this.get(h,k)!==0&&(w=!1);h++}return w}echelonForm(){let h=this.clone(),p=0,m=0;for(;p<h.rows&&m<h.columns;){let w=p;for(let T=p;T<h.rows;T++)h.get(T,m)>h.get(w,m)&&(w=T);if(h.get(w,m)===0)m++;else{h.swapRows(p,w);let T=h.get(p,m);for(let k=m;k<h.columns;k++)h.set(p,k,h.get(p,k)/T);for(let k=p+1;k<h.rows;k++){let x=h.get(k,m)/h.get(p,m);h.set(k,m,0);for(let B=m+1;B<h.columns;B++)h.set(k,B,h.get(k,B)-h.get(p,B)*x)}p++,m++}}return h}reducedEchelonForm(){let h=this.echelonForm(),p=h.columns,m=h.rows,w=m-1;for(;w>=0;)if(h.maxRow(w)===0)w--;else{let T=0,k=!1;for(;T<m&&k===!1;)h.get(w,T)===1?k=!0:T++;for(let x=0;x<w;x++){let B=h.get(x,T);for(let P=T;P<p;P++){let O=h.get(x,P)-B*h.get(w,P);h.set(x,P,O)}}w--}return h}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(h={}){if(typeof h!="object")throw new TypeError("options must be an object");const{rows:p=1,columns:m=1}=h;if(!Number.isInteger(p)||p<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(m)||m<=0)throw new TypeError("columns must be a positive integer");let w=new Matrix$2(this.rows*p,this.columns*m);for(let T=0;T<p;T++)for(let k=0;k<m;k++)w.setSubMatrix(this,this.rows*T,this.columns*k);return w}fill(h){for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,h);return this}neg(){return this.mulS(-1)}getRow(h){checkRowIndex(this,h);let p=[];for(let m=0;m<this.columns;m++)p.push(this.get(h,m));return p}getRowVector(h){return Matrix$2.rowVector(this.getRow(h))}setRow(h,p){checkRowIndex(this,h),p=checkRowVector(this,p);for(let m=0;m<this.columns;m++)this.set(h,m,p[m]);return this}swapRows(h,p){checkRowIndex(this,h),checkRowIndex(this,p);for(let m=0;m<this.columns;m++){let w=this.get(h,m);this.set(h,m,this.get(p,m)),this.set(p,m,w)}return this}getColumn(h){checkColumnIndex(this,h);let p=[];for(let m=0;m<this.rows;m++)p.push(this.get(m,h));return p}getColumnVector(h){return Matrix$2.columnVector(this.getColumn(h))}setColumn(h,p){checkColumnIndex(this,h),p=checkColumnVector(this,p);for(let m=0;m<this.rows;m++)this.set(m,h,p[m]);return this}swapColumns(h,p){checkColumnIndex(this,h),checkColumnIndex(this,p);for(let m=0;m<this.rows;m++){let w=this.get(m,h);this.set(m,h,this.get(m,p)),this.set(m,p,w)}return this}addRowVector(h){h=checkRowVector(this,h);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)+h[m]);return this}subRowVector(h){h=checkRowVector(this,h);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)-h[m]);return this}mulRowVector(h){h=checkRowVector(this,h);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)*h[m]);return this}divRowVector(h){h=checkRowVector(this,h);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)/h[m]);return this}addColumnVector(h){h=checkColumnVector(this,h);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)+h[p]);return this}subColumnVector(h){h=checkColumnVector(this,h);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)-h[p]);return this}mulColumnVector(h){h=checkColumnVector(this,h);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)*h[p]);return this}divColumnVector(h){h=checkColumnVector(this,h);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.set(p,m,this.get(p,m)/h[p]);return this}mulRow(h,p){checkRowIndex(this,h);for(let m=0;m<this.columns;m++)this.set(h,m,this.get(h,m)*p);return this}mulColumn(h,p){checkColumnIndex(this,h);for(let m=0;m<this.rows;m++)this.set(m,h,this.get(m,h)*p);return this}max(){if(this.isEmpty())return NaN;let h=this.get(0,0);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.get(p,m)>h&&(h=this.get(p,m));return h}maxIndex(){checkNonEmpty(this);let h=this.get(0,0),p=[0,0];for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.get(m,w)>h&&(h=this.get(m,w),p[0]=m,p[1]=w);return p}min(){if(this.isEmpty())return NaN;let h=this.get(0,0);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)this.get(p,m)<h&&(h=this.get(p,m));return h}minIndex(){checkNonEmpty(this);let h=this.get(0,0),p=[0,0];for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)this.get(m,w)<h&&(h=this.get(m,w),p[0]=m,p[1]=w);return p}maxRow(h){if(checkRowIndex(this,h),this.isEmpty())return NaN;let p=this.get(h,0);for(let m=1;m<this.columns;m++)this.get(h,m)>p&&(p=this.get(h,m));return p}maxRowIndex(h){checkRowIndex(this,h),checkNonEmpty(this);let p=this.get(h,0),m=[h,0];for(let w=1;w<this.columns;w++)this.get(h,w)>p&&(p=this.get(h,w),m[1]=w);return m}minRow(h){if(checkRowIndex(this,h),this.isEmpty())return NaN;let p=this.get(h,0);for(let m=1;m<this.columns;m++)this.get(h,m)<p&&(p=this.get(h,m));return p}minRowIndex(h){checkRowIndex(this,h),checkNonEmpty(this);let p=this.get(h,0),m=[h,0];for(let w=1;w<this.columns;w++)this.get(h,w)<p&&(p=this.get(h,w),m[1]=w);return m}maxColumn(h){if(checkColumnIndex(this,h),this.isEmpty())return NaN;let p=this.get(0,h);for(let m=1;m<this.rows;m++)this.get(m,h)>p&&(p=this.get(m,h));return p}maxColumnIndex(h){checkColumnIndex(this,h),checkNonEmpty(this);let p=this.get(0,h),m=[0,h];for(let w=1;w<this.rows;w++)this.get(w,h)>p&&(p=this.get(w,h),m[0]=w);return m}minColumn(h){if(checkColumnIndex(this,h),this.isEmpty())return NaN;let p=this.get(0,h);for(let m=1;m<this.rows;m++)this.get(m,h)<p&&(p=this.get(m,h));return p}minColumnIndex(h){checkColumnIndex(this,h),checkNonEmpty(this);let p=this.get(0,h),m=[0,h];for(let w=1;w<this.rows;w++)this.get(w,h)<p&&(p=this.get(w,h),m[0]=w);return m}diag(){let h=Math.min(this.rows,this.columns),p=[];for(let m=0;m<h;m++)p.push(this.get(m,m));return p}norm(h="frobenius"){let p=0;if(h==="max")return this.max();if(h==="frobenius"){for(let m=0;m<this.rows;m++)for(let w=0;w<this.columns;w++)p=p+this.get(m,w)*this.get(m,w);return Math.sqrt(p)}else throw new RangeError(`unknown norm type: ${h}`)}cumulativeSum(){let h=0;for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)h+=this.get(p,m),this.set(p,m,h);return this}dot(h){AbstractMatrix.isMatrix(h)&&(h=h.to1DArray());let p=this.to1DArray();if(p.length!==h.length)throw new RangeError("vectors do not have the same size");let m=0;for(let w=0;w<p.length;w++)m+=p[w]*h[w];return m}mmul(h){h=Matrix$2.checkMatrix(h);let p=this.rows,m=this.columns,w=h.columns,T=new Matrix$2(p,w),k=new Float64Array(m);for(let x=0;x<w;x++){for(let B=0;B<m;B++)k[B]=h.get(B,x);for(let B=0;B<p;B++){let P=0;for(let O=0;O<m;O++)P+=this.get(B,O)*k[O];T.set(B,x,P)}}return T}strassen2x2(h){h=Matrix$2.checkMatrix(h);let p=new Matrix$2(2,2);const m=this.get(0,0),w=h.get(0,0),T=this.get(0,1),k=h.get(0,1),x=this.get(1,0),B=h.get(1,0),P=this.get(1,1),O=h.get(1,1),U=(m+P)*(w+O),G=(x+P)*w,j=m*(k-O),H=P*(B-w),te=(m+T)*O,oe=(x-m)*(w+k),Q=(T-P)*(B+O),_e=U+H-te+Q,se=j+te,le=G+H,me=U-G+j+oe;return p.set(0,0,_e),p.set(0,1,se),p.set(1,0,le),p.set(1,1,me),p}strassen3x3(h){h=Matrix$2.checkMatrix(h);let p=new Matrix$2(3,3);const m=this.get(0,0),w=this.get(0,1),T=this.get(0,2),k=this.get(1,0),x=this.get(1,1),B=this.get(1,2),P=this.get(2,0),O=this.get(2,1),U=this.get(2,2),G=h.get(0,0),j=h.get(0,1),H=h.get(0,2),te=h.get(1,0),oe=h.get(1,1),Q=h.get(1,2),_e=h.get(2,0),se=h.get(2,1),le=h.get(2,2),me=(m+w+T-k-x-O-U)*oe,Re=(m-k)*(-j+oe),xe=x*(-G+j+te-oe-Q-_e+le),ue=(-m+k+x)*(G-j+oe),Me=(k+x)*(-G+j),he=m*G,ge=(-m+P+O)*(G-H+Q),Le=(-m+P)*(H-Q),Ze=(P+O)*(-G+H),st=(m+w+T-x-B-P-O)*Q,ht=O*(-G+H+te-oe-Q-_e+se),Rt=(-T+O+U)*(oe+_e-se),Bt=(T-U)*(oe-se),At=T*_e,Nt=(O+U)*(-_e+se),zt=(-T+x+B)*(Q+_e-le),Tt=(T-B)*(Q-le),ii=(x+B)*(-_e+le),Mt=w*te,St=B*se,wt=k*H,Ut=P*j,Vt=U*le,pi=he+At+Mt,ni=me+ue+Me+he+Rt+At+Nt,_i=he+ge+Ze+st+At+zt+ii,yi=Re+xe+ue+he+At+zt+Tt,Ri=Re+ue+Me+he+St,di=At+zt+Tt+ii+wt,pt=he+ge+Le+ht+Rt+Bt+At,xt=Rt+Bt+At+Nt+Ut,fi=he+ge+Le+Ze+Vt;return p.set(0,0,pi),p.set(0,1,ni),p.set(0,2,_i),p.set(1,0,yi),p.set(1,1,Ri),p.set(1,2,di),p.set(2,0,pt),p.set(2,1,xt),p.set(2,2,fi),p}mmulStrassen(h){h=Matrix$2.checkMatrix(h);let p=this.clone(),m=p.rows,w=p.columns,T=h.rows,k=h.columns;w!==T&&console.warn(`Multiplying ${m} x ${w} and ${T} x ${k} matrix: dimensions do not match.`);function x(U,G,j){let H=U.rows,te=U.columns;if(H===G&&te===j)return U;{let oe=AbstractMatrix.zeros(G,j);return oe=oe.setSubMatrix(U,0,0),oe}}let B=Math.max(m,T),P=Math.max(w,k);p=x(p,B,P),h=x(h,B,P);function O(U,G,j,H){if(j<=512||H<=512)return U.mmul(G);j%2===1&&H%2===1?(U=x(U,j+1,H+1),G=x(G,j+1,H+1)):j%2===1?(U=x(U,j+1,H),G=x(G,j+1,H)):H%2===1&&(U=x(U,j,H+1),G=x(G,j,H+1));let te=parseInt(U.rows/2,10),oe=parseInt(U.columns/2,10),Q=U.subMatrix(0,te-1,0,oe-1),_e=G.subMatrix(0,te-1,0,oe-1),se=U.subMatrix(0,te-1,oe,U.columns-1),le=G.subMatrix(0,te-1,oe,G.columns-1),me=U.subMatrix(te,U.rows-1,0,oe-1),Re=G.subMatrix(te,G.rows-1,0,oe-1),xe=U.subMatrix(te,U.rows-1,oe,U.columns-1),ue=G.subMatrix(te,G.rows-1,oe,G.columns-1),Me=O(AbstractMatrix.add(Q,xe),AbstractMatrix.add(_e,ue),te,oe),he=O(AbstractMatrix.add(me,xe),_e,te,oe),ge=O(Q,AbstractMatrix.sub(le,ue),te,oe),Le=O(xe,AbstractMatrix.sub(Re,_e),te,oe),Ze=O(AbstractMatrix.add(Q,se),ue,te,oe),st=O(AbstractMatrix.sub(me,Q),AbstractMatrix.add(_e,le),te,oe),ht=O(AbstractMatrix.sub(se,xe),AbstractMatrix.add(Re,ue),te,oe),Rt=AbstractMatrix.add(Me,Le);Rt.sub(Ze),Rt.add(ht);let Bt=AbstractMatrix.add(ge,Ze),At=AbstractMatrix.add(he,Le),Nt=AbstractMatrix.sub(Me,he);Nt.add(ge),Nt.add(st);let zt=AbstractMatrix.zeros(2*Rt.rows,2*Rt.columns);return zt=zt.setSubMatrix(Rt,0,0),zt=zt.setSubMatrix(Bt,Rt.rows,0),zt=zt.setSubMatrix(At,0,Rt.columns),zt=zt.setSubMatrix(Nt,Rt.rows,Rt.columns),zt.subMatrix(0,j-1,0,H-1)}return O(p,h,B,P)}scaleRows(h={}){if(typeof h!="object")throw new TypeError("options must be an object");const{min:p=0,max:m=1}=h;if(!Number.isFinite(p))throw new TypeError("min must be a number");if(!Number.isFinite(m))throw new TypeError("max must be a number");if(p>=m)throw new RangeError("min must be smaller than max");let w=new Matrix$2(this.rows,this.columns);for(let T=0;T<this.rows;T++){const k=this.getRow(T);k.length>0&&rescale(k,{min:p,max:m,output:k}),w.setRow(T,k)}return w}scaleColumns(h={}){if(typeof h!="object")throw new TypeError("options must be an object");const{min:p=0,max:m=1}=h;if(!Number.isFinite(p))throw new TypeError("min must be a number");if(!Number.isFinite(m))throw new TypeError("max must be a number");if(p>=m)throw new RangeError("min must be smaller than max");let w=new Matrix$2(this.rows,this.columns);for(let T=0;T<this.columns;T++){const k=this.getColumn(T);k.length&&rescale(k,{min:p,max:m,output:k}),w.setColumn(T,k)}return w}flipRows(){const h=Math.ceil(this.columns/2);for(let p=0;p<this.rows;p++)for(let m=0;m<h;m++){let w=this.get(p,m),T=this.get(p,this.columns-1-m);this.set(p,m,T),this.set(p,this.columns-1-m,w)}return this}flipColumns(){const h=Math.ceil(this.rows/2);for(let p=0;p<this.columns;p++)for(let m=0;m<h;m++){let w=this.get(m,p),T=this.get(this.rows-1-m,p);this.set(m,p,T),this.set(this.rows-1-m,p,w)}return this}kroneckerProduct(h){h=Matrix$2.checkMatrix(h);let p=this.rows,m=this.columns,w=h.rows,T=h.columns,k=new Matrix$2(p*w,m*T);for(let x=0;x<p;x++)for(let B=0;B<m;B++)for(let P=0;P<w;P++)for(let O=0;O<T;O++)k.set(w*x+P,T*B+O,this.get(x,B)*h.get(P,O));return k}kroneckerSum(h){if(h=Matrix$2.checkMatrix(h),!this.isSquare()||!h.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let p=this.rows,m=h.rows,w=this.kroneckerProduct(Matrix$2.eye(m,m)),T=Matrix$2.eye(p,p).kroneckerProduct(h);return w.add(T)}transpose(){let h=new Matrix$2(this.columns,this.rows);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)h.set(m,p,this.get(p,m));return h}sortRows(h=compareNumbers){for(let p=0;p<this.rows;p++)this.setRow(p,this.getRow(p).sort(h));return this}sortColumns(h=compareNumbers){for(let p=0;p<this.columns;p++)this.setColumn(p,this.getColumn(p).sort(h));return this}subMatrix(h,p,m,w){checkRange(this,h,p,m,w);let T=new Matrix$2(p-h+1,w-m+1);for(let k=h;k<=p;k++)for(let x=m;x<=w;x++)T.set(k-h,x-m,this.get(k,x));return T}subMatrixRow(h,p,m){if(p===void 0&&(p=0),m===void 0&&(m=this.columns-1),p>m||p<0||p>=this.columns||m<0||m>=this.columns)throw new RangeError("Argument out of range");let w=new Matrix$2(h.length,m-p+1);for(let T=0;T<h.length;T++)for(let k=p;k<=m;k++){if(h[T]<0||h[T]>=this.rows)throw new RangeError(`Row index out of range: ${h[T]}`);w.set(T,k-p,this.get(h[T],k))}return w}subMatrixColumn(h,p,m){if(p===void 0&&(p=0),m===void 0&&(m=this.rows-1),p>m||p<0||p>=this.rows||m<0||m>=this.rows)throw new RangeError("Argument out of range");let w=new Matrix$2(m-p+1,h.length);for(let T=0;T<h.length;T++)for(let k=p;k<=m;k++){if(h[T]<0||h[T]>=this.columns)throw new RangeError(`Column index out of range: ${h[T]}`);w.set(k-p,T,this.get(k,h[T]))}return w}setSubMatrix(h,p,m){if(h=Matrix$2.checkMatrix(h),h.isEmpty())return this;let w=p+h.rows-1,T=m+h.columns-1;checkRange(this,p,w,m,T);for(let k=0;k<h.rows;k++)for(let x=0;x<h.columns;x++)this.set(p+k,m+x,h.get(k,x));return this}selection(h,p){let m=checkIndices(this,h,p),w=new Matrix$2(h.length,p.length);for(let T=0;T<m.row.length;T++){let k=m.row[T];for(let x=0;x<m.column.length;x++){let B=m.column[x];w.set(T,x,this.get(k,B))}}return w}trace(){let h=Math.min(this.rows,this.columns),p=0;for(let m=0;m<h;m++)p+=this.get(m,m);return p}clone(){let h=new Matrix$2(this.rows,this.columns);for(let p=0;p<this.rows;p++)for(let m=0;m<this.columns;m++)h.set(p,m,this.get(p,m));return h}sum(h){switch(h){case"row":return sumByRow(this);case"column":return sumByColumn(this);case void 0:return sumAll(this);default:throw new Error(`invalid option: ${h}`)}}product(h){switch(h){case"row":return productByRow(this);case"column":return productByColumn(this);case void 0:return productAll(this);default:throw new Error(`invalid option: ${h}`)}}mean(h){const p=this.sum(h);switch(h){case"row":{for(let m=0;m<this.rows;m++)p[m]/=this.columns;return p}case"column":{for(let m=0;m<this.columns;m++)p[m]/=this.rows;return p}case void 0:return p/this.size;default:throw new Error(`invalid option: ${h}`)}}variance(h,p={}){if(typeof h=="object"&&(p=h,h=void 0),typeof p!="object")throw new TypeError("options must be an object");const{unbiased:m=!0,mean:w=this.mean(h)}=p;if(typeof m!="boolean")throw new TypeError("unbiased must be a boolean");switch(h){case"row":{if(!Array.isArray(w))throw new TypeError("mean must be an array");return varianceByRow(this,m,w)}case"column":{if(!Array.isArray(w))throw new TypeError("mean must be an array");return varianceByColumn(this,m,w)}case void 0:{if(typeof w!="number")throw new TypeError("mean must be a number");return varianceAll(this,m,w)}default:throw new Error(`invalid option: ${h}`)}}standardDeviation(h,p){typeof h=="object"&&(p=h,h=void 0);const m=this.variance(h,p);if(h===void 0)return Math.sqrt(m);for(let w=0;w<m.length;w++)m[w]=Math.sqrt(m[w]);return m}center(h,p={}){if(typeof h=="object"&&(p=h,h=void 0),typeof p!="object")throw new TypeError("options must be an object");const{center:m=this.mean(h)}=p;switch(h){case"row":{if(!Array.isArray(m))throw new TypeError("center must be an array");return centerByRow(this,m),this}case"column":{if(!Array.isArray(m))throw new TypeError("center must be an array");return centerByColumn(this,m),this}case void 0:{if(typeof m!="number")throw new TypeError("center must be a number");return centerAll(this,m),this}default:throw new Error(`invalid option: ${h}`)}}scale(h,p={}){if(typeof h=="object"&&(p=h,h=void 0),typeof p!="object")throw new TypeError("options must be an object");let m=p.scale;switch(h){case"row":{if(m===void 0)m=getScaleByRow(this);else if(!Array.isArray(m))throw new TypeError("scale must be an array");return scaleByRow(this,m),this}case"column":{if(m===void 0)m=getScaleByColumn(this);else if(!Array.isArray(m))throw new TypeError("scale must be an array");return scaleByColumn(this,m),this}case void 0:{if(m===void 0)m=getScaleAll(this);else if(typeof m!="number")throw new TypeError("scale must be a number");return scaleAll(this,m),this}default:throw new Error(`invalid option: ${h}`)}}toString(h){return inspectMatrixWithOptions(this,h)}}AbstractMatrix.prototype.klass="Matrix";typeof Symbol!="undefined"&&(AbstractMatrix.prototype[Symbol.for("nodejs.util.inspect.custom")]=inspectMatrix);function compareNumbers(d,h){return d-h}AbstractMatrix.random=AbstractMatrix.rand;AbstractMatrix.randomInt=AbstractMatrix.randInt;AbstractMatrix.diagonal=AbstractMatrix.diag;AbstractMatrix.prototype.diagonal=AbstractMatrix.prototype.diag;AbstractMatrix.identity=AbstractMatrix.eye;AbstractMatrix.prototype.negate=AbstractMatrix.prototype.neg;AbstractMatrix.prototype.tensorProduct=AbstractMatrix.prototype.kroneckerProduct;class Matrix$2 extends AbstractMatrix{constructor(h,p){super();if(Matrix$2.isMatrix(h))return h.clone();if(Number.isInteger(h)&&h>=0)if(this.data=[],Number.isInteger(p)&&p>=0)for(let m=0;m<h;m++)this.data.push(new Float64Array(p));else throw new TypeError("nColumns must be a positive integer");else if(Array.isArray(h)){const m=h;if(h=m.length,p=h?m[0].length:0,typeof p!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let w=0;w<h;w++){if(m[w].length!==p)throw new RangeError("Inconsistent array dimensions");this.data.push(Float64Array.from(m[w]))}}else throw new TypeError("First argument must be a positive number or an array");this.rows=h,this.columns=p}set(h,p,m){return this.data[h][p]=m,this}get(h,p){return this.data[h][p]}removeRow(h){return checkRowIndex(this,h),this.data.splice(h,1),this.rows-=1,this}addRow(h,p){return p===void 0&&(p=h,h=this.rows),checkRowIndex(this,h,!0),p=Float64Array.from(checkRowVector(this,p)),this.data.splice(h,0,p),this.rows+=1,this}removeColumn(h){checkColumnIndex(this,h);for(let p=0;p<this.rows;p++){const m=new Float64Array(this.columns-1);for(let w=0;w<h;w++)m[w]=this.data[p][w];for(let w=h+1;w<this.columns;w++)m[w-1]=this.data[p][w];this.data[p]=m}return this.columns-=1,this}addColumn(h,p){typeof p=="undefined"&&(p=h,h=this.columns),checkColumnIndex(this,h,!0),p=checkColumnVector(this,p);for(let m=0;m<this.rows;m++){const w=new Float64Array(this.columns+1);let T=0;for(;T<h;T++)w[T]=this.data[m][T];for(w[T++]=p[m];T<this.columns+1;T++)w[T]=this.data[m][T-1];this.data[m]=w}return this.columns+=1,this}}installMathOperations(AbstractMatrix,Matrix$2);class BaseView extends AbstractMatrix{constructor(h,p,m){super();this.matrix=h,this.rows=p,this.columns=m}}class MatrixColumnView extends BaseView{constructor(h,p){checkColumnIndex(h,p);super(h,h.rows,1);this.column=p}set(h,p,m){return this.matrix.set(h,this.column,m),this}get(h){return this.matrix.get(h,this.column)}}class MatrixColumnSelectionView extends BaseView{constructor(h,p){p=checkColumnIndices(h,p);super(h,h.rows,p.length);this.columnIndices=p}set(h,p,m){return this.matrix.set(h,this.columnIndices[p],m),this}get(h,p){return this.matrix.get(h,this.columnIndices[p])}}class MatrixFlipColumnView extends BaseView{constructor(h){super(h,h.rows,h.columns)}set(h,p,m){return this.matrix.set(h,this.columns-p-1,m),this}get(h,p){return this.matrix.get(h,this.columns-p-1)}}class MatrixFlipRowView extends BaseView{constructor(h){super(h,h.rows,h.columns)}set(h,p,m){return this.matrix.set(this.rows-h-1,p,m),this}get(h,p){return this.matrix.get(this.rows-h-1,p)}}class MatrixRowView extends BaseView{constructor(h,p){checkRowIndex(h,p);super(h,1,h.columns);this.row=p}set(h,p,m){return this.matrix.set(this.row,p,m),this}get(h,p){return this.matrix.get(this.row,p)}}class MatrixRowSelectionView extends BaseView{constructor(h,p){p=checkRowIndices(h,p);super(h,p.length,h.columns);this.rowIndices=p}set(h,p,m){return this.matrix.set(this.rowIndices[h],p,m),this}get(h,p){return this.matrix.get(this.rowIndices[h],p)}}class MatrixSelectionView extends BaseView{constructor(h,p,m){let w=checkIndices(h,p,m);super(h,w.row.length,w.column.length);this.rowIndices=w.row,this.columnIndices=w.column}set(h,p,m){return this.matrix.set(this.rowIndices[h],this.columnIndices[p],m),this}get(h,p){return this.matrix.get(this.rowIndices[h],this.columnIndices[p])}}class MatrixSubView extends BaseView{constructor(h,p,m,w,T){checkRange(h,p,m,w,T);super(h,m-p+1,T-w+1);this.startRow=p,this.startColumn=w}set(h,p,m){return this.matrix.set(this.startRow+h,this.startColumn+p,m),this}get(h,p){return this.matrix.get(this.startRow+h,this.startColumn+p)}}class MatrixTransposeView$1 extends BaseView{constructor(h){super(h,h.columns,h.rows)}set(h,p,m){return this.matrix.set(p,h,m),this}get(h,p){return this.matrix.get(p,h)}}class WrapperMatrix1D extends AbstractMatrix{constructor(h,p={}){const{rows:m=1}=p;if(h.length%m!==0)throw new Error("the data length is not divisible by the number of rows");super();this.rows=m,this.columns=h.length/m,this.data=h}set(h,p,m){let w=this._calculateIndex(h,p);return this.data[w]=m,this}get(h,p){let m=this._calculateIndex(h,p);return this.data[m]}_calculateIndex(h,p){return h*this.columns+p}}class WrapperMatrix2D extends AbstractMatrix{constructor(h){super();this.data=h,this.rows=h.length,this.columns=h[0].length}set(h,p,m){return this.data[h][p]=m,this}get(h,p){return this.data[h][p]}}function wrap(d,h){if(Array.isArray(d))return d[0]&&Array.isArray(d[0])?new WrapperMatrix2D(d):new WrapperMatrix1D(d,h);throw new Error("the argument is not an array")}class LuDecomposition{constructor(h){h=WrapperMatrix2D.checkMatrix(h);let p=h.clone(),m=p.rows,w=p.columns,T=new Float64Array(m),k=1,x,B,P,O,U,G,j,H,te;for(x=0;x<m;x++)T[x]=x;for(H=new Float64Array(m),B=0;B<w;B++){for(x=0;x<m;x++)H[x]=p.get(x,B);for(x=0;x<m;x++){for(te=Math.min(x,B),U=0,P=0;P<te;P++)U+=p.get(x,P)*H[P];H[x]-=U,p.set(x,B,H[x])}for(O=B,x=B+1;x<m;x++)Math.abs(H[x])>Math.abs(H[O])&&(O=x);if(O!==B){for(P=0;P<w;P++)G=p.get(O,P),p.set(O,P,p.get(B,P)),p.set(B,P,G);j=T[O],T[O]=T[B],T[B]=j,k=-k}if(B<m&&p.get(B,B)!==0)for(x=B+1;x<m;x++)p.set(x,B,p.get(x,B)/p.get(B,B))}this.LU=p,this.pivotVector=T,this.pivotSign=k}isSingular(){let h=this.LU,p=h.columns;for(let m=0;m<p;m++)if(h.get(m,m)===0)return!0;return!1}solve(h){h=Matrix$2.checkMatrix(h);let p=this.LU;if(p.rows!==h.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let w=h.columns,T=h.subMatrixRow(this.pivotVector,0,w-1),k=p.columns,x,B,P;for(P=0;P<k;P++)for(x=P+1;x<k;x++)for(B=0;B<w;B++)T.set(x,B,T.get(x,B)-T.get(P,B)*p.get(x,P));for(P=k-1;P>=0;P--){for(B=0;B<w;B++)T.set(P,B,T.get(P,B)/p.get(P,P));for(x=0;x<P;x++)for(B=0;B<w;B++)T.set(x,B,T.get(x,B)-T.get(P,B)*p.get(x,P))}return T}get determinant(){let h=this.LU;if(!h.isSquare())throw new Error("Matrix must be square");let p=this.pivotSign,m=h.columns;for(let w=0;w<m;w++)p*=h.get(w,w);return p}get lowerTriangularMatrix(){let h=this.LU,p=h.rows,m=h.columns,w=new Matrix$2(p,m);for(let T=0;T<p;T++)for(let k=0;k<m;k++)T>k?w.set(T,k,h.get(T,k)):T===k?w.set(T,k,1):w.set(T,k,0);return w}get upperTriangularMatrix(){let h=this.LU,p=h.rows,m=h.columns,w=new Matrix$2(p,m);for(let T=0;T<p;T++)for(let k=0;k<m;k++)T<=k?w.set(T,k,h.get(T,k)):w.set(T,k,0);return w}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function hypotenuse$1(d,h){let p=0;return Math.abs(d)>Math.abs(h)?(p=h/d,Math.abs(d)*Math.sqrt(1+p*p)):h!==0?(p=d/h,Math.abs(h)*Math.sqrt(1+p*p)):0}class QrDecomposition{constructor(h){h=WrapperMatrix2D.checkMatrix(h);let p=h.clone(),m=h.rows,w=h.columns,T=new Float64Array(w),k,x,B,P;for(B=0;B<w;B++){let O=0;for(k=B;k<m;k++)O=hypotenuse$1(O,p.get(k,B));if(O!==0){for(p.get(B,B)<0&&(O=-O),k=B;k<m;k++)p.set(k,B,p.get(k,B)/O);for(p.set(B,B,p.get(B,B)+1),x=B+1;x<w;x++){for(P=0,k=B;k<m;k++)P+=p.get(k,B)*p.get(k,x);for(P=-P/p.get(B,B),k=B;k<m;k++)p.set(k,x,p.get(k,x)+P*p.get(k,B))}}T[B]=-O}this.QR=p,this.Rdiag=T}solve(h){h=Matrix$2.checkMatrix(h);let p=this.QR,m=p.rows;if(h.rows!==m)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let w=h.columns,T=h.clone(),k=p.columns,x,B,P,O;for(P=0;P<k;P++)for(B=0;B<w;B++){for(O=0,x=P;x<m;x++)O+=p.get(x,P)*T.get(x,B);for(O=-O/p.get(P,P),x=P;x<m;x++)T.set(x,B,T.get(x,B)+O*p.get(x,P))}for(P=k-1;P>=0;P--){for(B=0;B<w;B++)T.set(P,B,T.get(P,B)/this.Rdiag[P]);for(x=0;x<P;x++)for(B=0;B<w;B++)T.set(x,B,T.get(x,B)-T.get(P,B)*p.get(x,P))}return T.subMatrix(0,k-1,0,w-1)}isFullRank(){let h=this.QR.columns;for(let p=0;p<h;p++)if(this.Rdiag[p]===0)return!1;return!0}get upperTriangularMatrix(){let h=this.QR,p=h.columns,m=new Matrix$2(p,p),w,T;for(w=0;w<p;w++)for(T=0;T<p;T++)w<T?m.set(w,T,h.get(w,T)):w===T?m.set(w,T,this.Rdiag[w]):m.set(w,T,0);return m}get orthogonalMatrix(){let h=this.QR,p=h.rows,m=h.columns,w=new Matrix$2(p,m),T,k,x,B;for(x=m-1;x>=0;x--){for(T=0;T<p;T++)w.set(T,x,0);for(w.set(x,x,1),k=x;k<m;k++)if(h.get(x,x)!==0){for(B=0,T=x;T<p;T++)B+=h.get(T,x)*w.get(T,k);for(B=-B/h.get(x,x),T=x;T<p;T++)w.set(T,k,w.get(T,k)+B*h.get(T,x))}}return w}}class SingularValueDecomposition{constructor(h,p={}){if(h=WrapperMatrix2D.checkMatrix(h),h.isEmpty())throw new Error("Matrix must be non-empty");let m=h.rows,w=h.columns;const{computeLeftSingularVectors:T=!0,computeRightSingularVectors:k=!0,autoTranspose:x=!1}=p;let B=Boolean(T),P=Boolean(k),O=!1,U;if(m<w)if(!x)U=h.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{U=h.transpose(),m=U.rows,w=U.columns,O=!0;let he=B;B=P,P=he}else U=h.clone();let G=Math.min(m,w),j=Math.min(m+1,w),H=new Float64Array(j),te=new Matrix$2(m,G),oe=new Matrix$2(w,w),Q=new Float64Array(w),_e=new Float64Array(m),se=new Float64Array(j);for(let he=0;he<j;he++)se[he]=he;let le=Math.min(m-1,w),me=Math.max(0,Math.min(w-2,m)),Re=Math.max(le,me);for(let he=0;he<Re;he++){if(he<le){H[he]=0;for(let ge=he;ge<m;ge++)H[he]=hypotenuse$1(H[he],U.get(ge,he));if(H[he]!==0){U.get(he,he)<0&&(H[he]=-H[he]);for(let ge=he;ge<m;ge++)U.set(ge,he,U.get(ge,he)/H[he]);U.set(he,he,U.get(he,he)+1)}H[he]=-H[he]}for(let ge=he+1;ge<w;ge++){if(he<le&&H[he]!==0){let Le=0;for(let Ze=he;Ze<m;Ze++)Le+=U.get(Ze,he)*U.get(Ze,ge);Le=-Le/U.get(he,he);for(let Ze=he;Ze<m;Ze++)U.set(Ze,ge,U.get(Ze,ge)+Le*U.get(Ze,he))}Q[ge]=U.get(he,ge)}if(B&&he<le)for(let ge=he;ge<m;ge++)te.set(ge,he,U.get(ge,he));if(he<me){Q[he]=0;for(let ge=he+1;ge<w;ge++)Q[he]=hypotenuse$1(Q[he],Q[ge]);if(Q[he]!==0){Q[he+1]<0&&(Q[he]=0-Q[he]);for(let ge=he+1;ge<w;ge++)Q[ge]/=Q[he];Q[he+1]+=1}if(Q[he]=-Q[he],he+1<m&&Q[he]!==0){for(let ge=he+1;ge<m;ge++)_e[ge]=0;for(let ge=he+1;ge<m;ge++)for(let Le=he+1;Le<w;Le++)_e[ge]+=Q[Le]*U.get(ge,Le);for(let ge=he+1;ge<w;ge++){let Le=-Q[ge]/Q[he+1];for(let Ze=he+1;Ze<m;Ze++)U.set(Ze,ge,U.get(Ze,ge)+Le*_e[Ze])}}if(P)for(let ge=he+1;ge<w;ge++)oe.set(ge,he,Q[ge])}}let xe=Math.min(w,m+1);if(le<w&&(H[le]=U.get(le,le)),m<xe&&(H[xe-1]=0),me+1<xe&&(Q[me]=U.get(me,xe-1)),Q[xe-1]=0,B){for(let he=le;he<G;he++){for(let ge=0;ge<m;ge++)te.set(ge,he,0);te.set(he,he,1)}for(let he=le-1;he>=0;he--)if(H[he]!==0){for(let ge=he+1;ge<G;ge++){let Le=0;for(let Ze=he;Ze<m;Ze++)Le+=te.get(Ze,he)*te.get(Ze,ge);Le=-Le/te.get(he,he);for(let Ze=he;Ze<m;Ze++)te.set(Ze,ge,te.get(Ze,ge)+Le*te.get(Ze,he))}for(let ge=he;ge<m;ge++)te.set(ge,he,-te.get(ge,he));te.set(he,he,1+te.get(he,he));for(let ge=0;ge<he-1;ge++)te.set(ge,he,0)}else{for(let ge=0;ge<m;ge++)te.set(ge,he,0);te.set(he,he,1)}}if(P)for(let he=w-1;he>=0;he--){if(he<me&&Q[he]!==0)for(let ge=he+1;ge<w;ge++){let Le=0;for(let Ze=he+1;Ze<w;Ze++)Le+=oe.get(Ze,he)*oe.get(Ze,ge);Le=-Le/oe.get(he+1,he);for(let Ze=he+1;Ze<w;Ze++)oe.set(Ze,ge,oe.get(Ze,ge)+Le*oe.get(Ze,he))}for(let ge=0;ge<w;ge++)oe.set(ge,he,0);oe.set(he,he,1)}let ue=xe-1,Me=Number.EPSILON;for(;xe>0;){let he,ge;for(he=xe-2;he>=-1&&he!==-1;he--){const Le=Number.MIN_VALUE+Me*Math.abs(H[he]+Math.abs(H[he+1]));if(Math.abs(Q[he])<=Le||Number.isNaN(Q[he])){Q[he]=0;break}}if(he===xe-2)ge=4;else{let Le;for(Le=xe-1;Le>=he&&Le!==he;Le--){let Ze=(Le!==xe?Math.abs(Q[Le]):0)+(Le!==he+1?Math.abs(Q[Le-1]):0);if(Math.abs(H[Le])<=Me*Ze){H[Le]=0;break}}Le===he?ge=3:Le===xe-1?ge=1:(ge=2,he=Le)}switch(he++,ge){case 1:{let Le=Q[xe-2];Q[xe-2]=0;for(let Ze=xe-2;Ze>=he;Ze--){let st=hypotenuse$1(H[Ze],Le),ht=H[Ze]/st,Rt=Le/st;if(H[Ze]=st,Ze!==he&&(Le=-Rt*Q[Ze-1],Q[Ze-1]=ht*Q[Ze-1]),P)for(let Bt=0;Bt<w;Bt++)st=ht*oe.get(Bt,Ze)+Rt*oe.get(Bt,xe-1),oe.set(Bt,xe-1,-Rt*oe.get(Bt,Ze)+ht*oe.get(Bt,xe-1)),oe.set(Bt,Ze,st)}break}case 2:{let Le=Q[he-1];Q[he-1]=0;for(let Ze=he;Ze<xe;Ze++){let st=hypotenuse$1(H[Ze],Le),ht=H[Ze]/st,Rt=Le/st;if(H[Ze]=st,Le=-Rt*Q[Ze],Q[Ze]=ht*Q[Ze],B)for(let Bt=0;Bt<m;Bt++)st=ht*te.get(Bt,Ze)+Rt*te.get(Bt,he-1),te.set(Bt,he-1,-Rt*te.get(Bt,Ze)+ht*te.get(Bt,he-1)),te.set(Bt,Ze,st)}break}case 3:{const Le=Math.max(Math.abs(H[xe-1]),Math.abs(H[xe-2]),Math.abs(Q[xe-2]),Math.abs(H[he]),Math.abs(Q[he])),Ze=H[xe-1]/Le,st=H[xe-2]/Le,ht=Q[xe-2]/Le,Rt=H[he]/Le,Bt=Q[he]/Le,At=((st+Ze)*(st-Ze)+ht*ht)/2,Nt=Ze*ht*(Ze*ht);let zt=0;(At!==0||Nt!==0)&&(At<0?zt=0-Math.sqrt(At*At+Nt):zt=Math.sqrt(At*At+Nt),zt=Nt/(At+zt));let Tt=(Rt+Ze)*(Rt-Ze)+zt,ii=Rt*Bt;for(let Mt=he;Mt<xe-1;Mt++){let St=hypotenuse$1(Tt,ii);St===0&&(St=Number.MIN_VALUE);let wt=Tt/St,Ut=ii/St;if(Mt!==he&&(Q[Mt-1]=St),Tt=wt*H[Mt]+Ut*Q[Mt],Q[Mt]=wt*Q[Mt]-Ut*H[Mt],ii=Ut*H[Mt+1],H[Mt+1]=wt*H[Mt+1],P)for(let Vt=0;Vt<w;Vt++)St=wt*oe.get(Vt,Mt)+Ut*oe.get(Vt,Mt+1),oe.set(Vt,Mt+1,-Ut*oe.get(Vt,Mt)+wt*oe.get(Vt,Mt+1)),oe.set(Vt,Mt,St);if(St=hypotenuse$1(Tt,ii),St===0&&(St=Number.MIN_VALUE),wt=Tt/St,Ut=ii/St,H[Mt]=St,Tt=wt*Q[Mt]+Ut*H[Mt+1],H[Mt+1]=-Ut*Q[Mt]+wt*H[Mt+1],ii=Ut*Q[Mt+1],Q[Mt+1]=wt*Q[Mt+1],B&&Mt<m-1)for(let Vt=0;Vt<m;Vt++)St=wt*te.get(Vt,Mt)+Ut*te.get(Vt,Mt+1),te.set(Vt,Mt+1,-Ut*te.get(Vt,Mt)+wt*te.get(Vt,Mt+1)),te.set(Vt,Mt,St)}Q[xe-2]=Tt;break}case 4:{if(H[he]<=0&&(H[he]=H[he]<0?-H[he]:0,P))for(let Le=0;Le<=ue;Le++)oe.set(Le,he,-oe.get(Le,he));for(;he<ue&&!(H[he]>=H[he+1]);){let Le=H[he];if(H[he]=H[he+1],H[he+1]=Le,P&&he<w-1)for(let Ze=0;Ze<w;Ze++)Le=oe.get(Ze,he+1),oe.set(Ze,he+1,oe.get(Ze,he)),oe.set(Ze,he,Le);if(B&&he<m-1)for(let Ze=0;Ze<m;Ze++)Le=te.get(Ze,he+1),te.set(Ze,he+1,te.get(Ze,he)),te.set(Ze,he,Le);he++}xe--;break}}}if(O){let he=oe;oe=te,te=he}this.m=m,this.n=w,this.s=H,this.U=te,this.V=oe}solve(h){let p=h,m=this.threshold,w=this.s.length,T=Matrix$2.zeros(w,w);for(let G=0;G<w;G++)Math.abs(this.s[G])<=m?T.set(G,G,0):T.set(G,G,1/this.s[G]);let k=this.U,x=this.rightSingularVectors,B=x.mmul(T),P=x.rows,O=k.rows,U=Matrix$2.zeros(P,O);for(let G=0;G<P;G++)for(let j=0;j<O;j++){let H=0;for(let te=0;te<w;te++)H+=B.get(G,te)*k.get(j,te);U.set(G,j,H)}return U.mmul(p)}solveForDiagonal(h){return this.solve(Matrix$2.diag(h))}inverse(){let h=this.V,p=this.threshold,m=h.rows,w=h.columns,T=new Matrix$2(m,this.s.length);for(let O=0;O<m;O++)for(let U=0;U<w;U++)Math.abs(this.s[U])>p&&T.set(O,U,h.get(O,U)/this.s[U]);let k=this.U,x=k.rows,B=k.columns,P=new Matrix$2(m,x);for(let O=0;O<m;O++)for(let U=0;U<x;U++){let G=0;for(let j=0;j<B;j++)G+=T.get(O,j)*k.get(U,j);P.set(O,U,G)}return P}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let h=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,p=0,m=this.s;for(let w=0,T=m.length;w<T;w++)m[w]>h&&p++;return p}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return Matrix$2.diag(this.s)}}function inverse(d,h=!1){return d=WrapperMatrix2D.checkMatrix(d),h?new SingularValueDecomposition(d).inverse():solve(d,Matrix$2.eye(d.rows))}function solve(d,h,p=!1){return d=WrapperMatrix2D.checkMatrix(d),h=WrapperMatrix2D.checkMatrix(h),p?new SingularValueDecomposition(d).solve(h):d.isSquare()?new LuDecomposition(d).solve(h):new QrDecomposition(d).solve(h)}function determinant(d){if(d=Matrix$2.checkMatrix(d),d.isSquare()){if(d.columns===0)return 1;let h,p,m,w;if(d.columns===2)return h=d.get(0,0),p=d.get(0,1),m=d.get(1,0),w=d.get(1,1),h*w-p*m;if(d.columns===3){let T,k,x;return T=new MatrixSelectionView(d,[1,2],[1,2]),k=new MatrixSelectionView(d,[1,2],[0,2]),x=new MatrixSelectionView(d,[1,2],[0,1]),h=d.get(0,0),p=d.get(0,1),m=d.get(0,2),h*determinant(T)-p*determinant(k)+m*determinant(x)}else return new LuDecomposition(d).determinant}else throw Error("determinant can only be calculated for a square matrix")}function xrange(d,h){let p=[];for(let m=0;m<d;m++)m!==h&&p.push(m);return p}function dependenciesOneRow(d,h,p,m=1e-9,w=1e-9){if(d>w)return new Array(h.rows+1).fill(0);{let T=h.addRow(p,[0]);for(let k=0;k<T.rows;k++)Math.abs(T.get(k,0))<m&&T.set(k,0,0);return T.to1DArray()}}function linearDependencies(d,h={}){const{thresholdValue:p=1e-9,thresholdError:m=1e-9}=h;d=Matrix$2.checkMatrix(d);let w=d.rows,T=new Matrix$2(w,w);for(let k=0;k<w;k++){let x=Matrix$2.columnVector(d.getRow(k)),B=d.subMatrixRow(xrange(w,k)).transpose(),O=new SingularValueDecomposition(B).solve(x),U=Matrix$2.sub(x,B.mmul(O)).abs().max();T.setRow(k,dependenciesOneRow(U,O,k,p,m))}return T}function pseudoInverse(d,h=Number.EPSILON){if(d=Matrix$2.checkMatrix(d),d.isEmpty())return d.transpose();let p=new SingularValueDecomposition(d,{autoTranspose:!0}),m=p.leftSingularVectors,w=p.rightSingularVectors,T=p.diagonal;for(let k=0;k<T.length;k++)Math.abs(T[k])>h?T[k]=1/T[k]:T[k]=0;return w.mmul(Matrix$2.diag(T).mmul(m.transpose()))}function covariance(d,h=d,p={}){d=new Matrix$2(d);let m=!1;if(typeof h=="object"&&!Matrix$2.isMatrix(h)&&!Array.isArray(h)?(p=h,h=d,m=!0):h=new Matrix$2(h),d.rows!==h.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:w=!0}=p;w&&(d=d.center("column"),m||(h=h.center("column")));const T=d.transpose().mmul(h);for(let k=0;k<T.rows;k++)for(let x=0;x<T.columns;x++)T.set(k,x,T.get(k,x)*(1/(d.rows-1)));return T}function correlation(d,h=d,p={}){d=new Matrix$2(d);let m=!1;if(typeof h=="object"&&!Matrix$2.isMatrix(h)&&!Array.isArray(h)?(p=h,h=d,m=!0):h=new Matrix$2(h),d.rows!==h.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:w=!0,scale:T=!0}=p;w&&(d.center("column"),m||h.center("column")),T&&(d.scale("column"),m||h.scale("column"));const k=d.standardDeviation("column",{unbiased:!0}),x=m?k:h.standardDeviation("column",{unbiased:!0}),B=d.transpose().mmul(h);for(let P=0;P<B.rows;P++)for(let O=0;O<B.columns;O++)B.set(P,O,B.get(P,O)*(1/(k[P]*x[O]))*(1/(d.rows-1)));return B}class EigenvalueDecomposition{constructor(h,p={}){const{assumeSymmetric:m=!1}=p;if(h=WrapperMatrix2D.checkMatrix(h),!h.isSquare())throw new Error("Matrix is not a square matrix");if(h.isEmpty())throw new Error("Matrix must be non-empty");let w=h.columns,T=new Matrix$2(w,w),k=new Float64Array(w),x=new Float64Array(w),B=h,P,O,U=!1;if(m?U=!0:U=h.isSymmetric(),U){for(P=0;P<w;P++)for(O=0;O<w;O++)T.set(P,O,B.get(P,O));tred2(w,x,k,T),tql2(w,x,k,T)}else{let G=new Matrix$2(w,w),j=new Float64Array(w);for(O=0;O<w;O++)for(P=0;P<w;P++)G.set(P,O,B.get(P,O));orthes(w,G,j,T),hqr2(w,x,k,T,G)}this.n=w,this.e=x,this.d=k,this.V=T}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let h=this.n,p=this.e,m=this.d,w=new Matrix$2(h,h),T,k;for(T=0;T<h;T++){for(k=0;k<h;k++)w.set(T,k,0);w.set(T,T,m[T]),p[T]>0?w.set(T,T+1,p[T]):p[T]<0&&w.set(T,T-1,p[T])}return w}}function tred2(d,h,p,m){let w,T,k,x,B,P,O,U;for(B=0;B<d;B++)p[B]=m.get(d-1,B);for(x=d-1;x>0;x--){for(U=0,k=0,P=0;P<x;P++)U=U+Math.abs(p[P]);if(U===0)for(h[x]=p[x-1],B=0;B<x;B++)p[B]=m.get(x-1,B),m.set(x,B,0),m.set(B,x,0);else{for(P=0;P<x;P++)p[P]/=U,k+=p[P]*p[P];for(w=p[x-1],T=Math.sqrt(k),w>0&&(T=-T),h[x]=U*T,k=k-w*T,p[x-1]=w-T,B=0;B<x;B++)h[B]=0;for(B=0;B<x;B++){for(w=p[B],m.set(B,x,w),T=h[B]+m.get(B,B)*w,P=B+1;P<=x-1;P++)T+=m.get(P,B)*p[P],h[P]+=m.get(P,B)*w;h[B]=T}for(w=0,B=0;B<x;B++)h[B]/=k,w+=h[B]*p[B];for(O=w/(k+k),B=0;B<x;B++)h[B]-=O*p[B];for(B=0;B<x;B++){for(w=p[B],T=h[B],P=B;P<=x-1;P++)m.set(P,B,m.get(P,B)-(w*h[P]+T*p[P]));p[B]=m.get(x-1,B),m.set(x,B,0)}}p[x]=k}for(x=0;x<d-1;x++){if(m.set(d-1,x,m.get(x,x)),m.set(x,x,1),k=p[x+1],k!==0){for(P=0;P<=x;P++)p[P]=m.get(P,x+1)/k;for(B=0;B<=x;B++){for(T=0,P=0;P<=x;P++)T+=m.get(P,x+1)*m.get(P,B);for(P=0;P<=x;P++)m.set(P,B,m.get(P,B)-T*p[P])}}for(P=0;P<=x;P++)m.set(P,x+1,0)}for(B=0;B<d;B++)p[B]=m.get(d-1,B),m.set(d-1,B,0);m.set(d-1,d-1,1),h[0]=0}function tql2(d,h,p,m){let w,T,k,x,B,P,O,U,G,j,H,te,oe,Q,_e,se;for(k=1;k<d;k++)h[k-1]=h[k];h[d-1]=0;let le=0,me=0,Re=Number.EPSILON;for(P=0;P<d;P++){for(me=Math.max(me,Math.abs(p[P])+Math.abs(h[P])),O=P;O<d&&!(Math.abs(h[O])<=Re*me);)O++;if(O>P)do{for(w=p[P],U=(p[P+1]-w)/(2*h[P]),G=hypotenuse$1(U,1),U<0&&(G=-G),p[P]=h[P]/(U+G),p[P+1]=h[P]*(U+G),j=p[P+1],T=w-p[P],k=P+2;k<d;k++)p[k]-=T;for(le=le+T,U=p[O],H=1,te=H,oe=H,Q=h[P+1],_e=0,se=0,k=O-1;k>=P;k--)for(oe=te,te=H,se=_e,w=H*h[k],T=H*U,G=hypotenuse$1(U,h[k]),h[k+1]=_e*G,_e=h[k]/G,H=U/G,U=H*p[k]-_e*w,p[k+1]=T+_e*(H*w+_e*p[k]),B=0;B<d;B++)T=m.get(B,k+1),m.set(B,k+1,_e*m.get(B,k)+H*T),m.set(B,k,H*m.get(B,k)-_e*T);U=-_e*se*oe*Q*h[P]/j,h[P]=_e*U,p[P]=H*U}while(Math.abs(h[P])>Re*me);p[P]=p[P]+le,h[P]=0}for(k=0;k<d-1;k++){for(B=k,U=p[k],x=k+1;x<d;x++)p[x]<U&&(B=x,U=p[x]);if(B!==k)for(p[B]=p[k],p[k]=U,x=0;x<d;x++)U=m.get(x,k),m.set(x,k,m.get(x,B)),m.set(x,B,U)}}function orthes(d,h,p,m){let w=0,T=d-1,k,x,B,P,O,U,G;for(U=w+1;U<=T-1;U++){for(G=0,P=U;P<=T;P++)G=G+Math.abs(h.get(P,U-1));if(G!==0){for(B=0,P=T;P>=U;P--)p[P]=h.get(P,U-1)/G,B+=p[P]*p[P];for(x=Math.sqrt(B),p[U]>0&&(x=-x),B=B-p[U]*x,p[U]=p[U]-x,O=U;O<d;O++){for(k=0,P=T;P>=U;P--)k+=p[P]*h.get(P,O);for(k=k/B,P=U;P<=T;P++)h.set(P,O,h.get(P,O)-k*p[P])}for(P=0;P<=T;P++){for(k=0,O=T;O>=U;O--)k+=p[O]*h.get(P,O);for(k=k/B,O=U;O<=T;O++)h.set(P,O,h.get(P,O)-k*p[O])}p[U]=G*p[U],h.set(U,U-1,G*x)}}for(P=0;P<d;P++)for(O=0;O<d;O++)m.set(P,O,P===O?1:0);for(U=T-1;U>=w+1;U--)if(h.get(U,U-1)!==0){for(P=U+1;P<=T;P++)p[P]=h.get(P,U-1);for(O=U;O<=T;O++){for(x=0,P=U;P<=T;P++)x+=p[P]*m.get(P,O);for(x=x/p[U]/h.get(U,U-1),P=U;P<=T;P++)m.set(P,O,m.get(P,O)+x*p[P])}}}function hqr2(d,h,p,m,w){let T=d-1,k=0,x=d-1,B=Number.EPSILON,P=0,O=0,U=0,G=0,j=0,H=0,te=0,oe=0,Q,_e,se,le,me,Re,xe,ue,Me,he,ge,Le,Ze,st,ht;for(Q=0;Q<d;Q++)for((Q<k||Q>x)&&(p[Q]=w.get(Q,Q),h[Q]=0),_e=Math.max(Q-1,0);_e<d;_e++)O=O+Math.abs(w.get(Q,_e));for(;T>=k;){for(le=T;le>k&&(H=Math.abs(w.get(le-1,le-1))+Math.abs(w.get(le,le)),H===0&&(H=O),!(Math.abs(w.get(le,le-1))<B*H));)le--;if(le===T)w.set(T,T,w.get(T,T)+P),p[T]=w.get(T,T),h[T]=0,T--,oe=0;else if(le===T-1){if(xe=w.get(T,T-1)*w.get(T-1,T),U=(w.get(T-1,T-1)-w.get(T,T))/2,G=U*U+xe,te=Math.sqrt(Math.abs(G)),w.set(T,T,w.get(T,T)+P),w.set(T-1,T-1,w.get(T-1,T-1)+P),ue=w.get(T,T),G>=0){for(te=U>=0?U+te:U-te,p[T-1]=ue+te,p[T]=p[T-1],te!==0&&(p[T]=ue-xe/te),h[T-1]=0,h[T]=0,ue=w.get(T,T-1),H=Math.abs(ue)+Math.abs(te),U=ue/H,G=te/H,j=Math.sqrt(U*U+G*G),U=U/j,G=G/j,_e=T-1;_e<d;_e++)te=w.get(T-1,_e),w.set(T-1,_e,G*te+U*w.get(T,_e)),w.set(T,_e,G*w.get(T,_e)-U*te);for(Q=0;Q<=T;Q++)te=w.get(Q,T-1),w.set(Q,T-1,G*te+U*w.get(Q,T)),w.set(Q,T,G*w.get(Q,T)-U*te);for(Q=k;Q<=x;Q++)te=m.get(Q,T-1),m.set(Q,T-1,G*te+U*m.get(Q,T)),m.set(Q,T,G*m.get(Q,T)-U*te)}else p[T-1]=ue+U,p[T]=ue+U,h[T-1]=te,h[T]=-te;T=T-2,oe=0}else{if(ue=w.get(T,T),Me=0,xe=0,le<T&&(Me=w.get(T-1,T-1),xe=w.get(T,T-1)*w.get(T-1,T)),oe===10){for(P+=ue,Q=k;Q<=T;Q++)w.set(Q,Q,w.get(Q,Q)-ue);H=Math.abs(w.get(T,T-1))+Math.abs(w.get(T-1,T-2)),ue=Me=.75*H,xe=-.4375*H*H}if(oe===30&&(H=(Me-ue)/2,H=H*H+xe,H>0)){for(H=Math.sqrt(H),Me<ue&&(H=-H),H=ue-xe/((Me-ue)/2+H),Q=k;Q<=T;Q++)w.set(Q,Q,w.get(Q,Q)-H);P+=H,ue=Me=xe=.964}for(oe=oe+1,me=T-2;me>=le&&(te=w.get(me,me),j=ue-te,H=Me-te,U=(j*H-xe)/w.get(me+1,me)+w.get(me,me+1),G=w.get(me+1,me+1)-te-j-H,j=w.get(me+2,me+1),H=Math.abs(U)+Math.abs(G)+Math.abs(j),U=U/H,G=G/H,j=j/H,!(me===le||Math.abs(w.get(me,me-1))*(Math.abs(G)+Math.abs(j))<B*(Math.abs(U)*(Math.abs(w.get(me-1,me-1))+Math.abs(te)+Math.abs(w.get(me+1,me+1))))));)me--;for(Q=me+2;Q<=T;Q++)w.set(Q,Q-2,0),Q>me+2&&w.set(Q,Q-3,0);for(se=me;se<=T-1&&(st=se!==T-1,se!==me&&(U=w.get(se,se-1),G=w.get(se+1,se-1),j=st?w.get(se+2,se-1):0,ue=Math.abs(U)+Math.abs(G)+Math.abs(j),ue!==0&&(U=U/ue,G=G/ue,j=j/ue)),ue!==0);se++)if(H=Math.sqrt(U*U+G*G+j*j),U<0&&(H=-H),H!==0){for(se!==me?w.set(se,se-1,-H*ue):le!==me&&w.set(se,se-1,-w.get(se,se-1)),U=U+H,ue=U/H,Me=G/H,te=j/H,G=G/U,j=j/U,_e=se;_e<d;_e++)U=w.get(se,_e)+G*w.get(se+1,_e),st&&(U=U+j*w.get(se+2,_e),w.set(se+2,_e,w.get(se+2,_e)-U*te)),w.set(se,_e,w.get(se,_e)-U*ue),w.set(se+1,_e,w.get(se+1,_e)-U*Me);for(Q=0;Q<=Math.min(T,se+3);Q++)U=ue*w.get(Q,se)+Me*w.get(Q,se+1),st&&(U=U+te*w.get(Q,se+2),w.set(Q,se+2,w.get(Q,se+2)-U*j)),w.set(Q,se,w.get(Q,se)-U),w.set(Q,se+1,w.get(Q,se+1)-U*G);for(Q=k;Q<=x;Q++)U=ue*m.get(Q,se)+Me*m.get(Q,se+1),st&&(U=U+te*m.get(Q,se+2),m.set(Q,se+2,m.get(Q,se+2)-U*j)),m.set(Q,se,m.get(Q,se)-U),m.set(Q,se+1,m.get(Q,se+1)-U*G)}}}if(O!==0){for(T=d-1;T>=0;T--)if(U=p[T],G=h[T],G===0)for(le=T,w.set(T,T,1),Q=T-1;Q>=0;Q--){for(xe=w.get(Q,Q)-U,j=0,_e=le;_e<=T;_e++)j=j+w.get(Q,_e)*w.get(_e,T);if(h[Q]<0)te=xe,H=j;else if(le=Q,h[Q]===0?w.set(Q,T,xe!==0?-j/xe:-j/(B*O)):(ue=w.get(Q,Q+1),Me=w.get(Q+1,Q),G=(p[Q]-U)*(p[Q]-U)+h[Q]*h[Q],Re=(ue*H-te*j)/G,w.set(Q,T,Re),w.set(Q+1,T,Math.abs(ue)>Math.abs(te)?(-j-xe*Re)/ue:(-H-Me*Re)/te)),Re=Math.abs(w.get(Q,T)),B*Re*Re>1)for(_e=Q;_e<=T;_e++)w.set(_e,T,w.get(_e,T)/Re)}else if(G<0)for(le=T-1,Math.abs(w.get(T,T-1))>Math.abs(w.get(T-1,T))?(w.set(T-1,T-1,G/w.get(T,T-1)),w.set(T-1,T,-(w.get(T,T)-U)/w.get(T,T-1))):(ht=cdiv(0,-w.get(T-1,T),w.get(T-1,T-1)-U,G),w.set(T-1,T-1,ht[0]),w.set(T-1,T,ht[1])),w.set(T,T-1,0),w.set(T,T,1),Q=T-2;Q>=0;Q--){for(he=0,ge=0,_e=le;_e<=T;_e++)he=he+w.get(Q,_e)*w.get(_e,T-1),ge=ge+w.get(Q,_e)*w.get(_e,T);if(xe=w.get(Q,Q)-U,h[Q]<0)te=xe,j=he,H=ge;else if(le=Q,h[Q]===0?(ht=cdiv(-he,-ge,xe,G),w.set(Q,T-1,ht[0]),w.set(Q,T,ht[1])):(ue=w.get(Q,Q+1),Me=w.get(Q+1,Q),Le=(p[Q]-U)*(p[Q]-U)+h[Q]*h[Q]-G*G,Ze=(p[Q]-U)*2*G,Le===0&&Ze===0&&(Le=B*O*(Math.abs(xe)+Math.abs(G)+Math.abs(ue)+Math.abs(Me)+Math.abs(te))),ht=cdiv(ue*j-te*he+G*ge,ue*H-te*ge-G*he,Le,Ze),w.set(Q,T-1,ht[0]),w.set(Q,T,ht[1]),Math.abs(ue)>Math.abs(te)+Math.abs(G)?(w.set(Q+1,T-1,(-he-xe*w.get(Q,T-1)+G*w.get(Q,T))/ue),w.set(Q+1,T,(-ge-xe*w.get(Q,T)-G*w.get(Q,T-1))/ue)):(ht=cdiv(-j-Me*w.get(Q,T-1),-H-Me*w.get(Q,T),te,G),w.set(Q+1,T-1,ht[0]),w.set(Q+1,T,ht[1]))),Re=Math.max(Math.abs(w.get(Q,T-1)),Math.abs(w.get(Q,T))),B*Re*Re>1)for(_e=Q;_e<=T;_e++)w.set(_e,T-1,w.get(_e,T-1)/Re),w.set(_e,T,w.get(_e,T)/Re)}for(Q=0;Q<d;Q++)if(Q<k||Q>x)for(_e=Q;_e<d;_e++)m.set(Q,_e,w.get(Q,_e));for(_e=d-1;_e>=k;_e--)for(Q=k;Q<=x;Q++){for(te=0,se=k;se<=Math.min(_e,x);se++)te=te+m.get(Q,se)*w.get(se,_e);m.set(Q,_e,te)}}}function cdiv(d,h,p,m){let w,T;return Math.abs(p)>Math.abs(m)?(w=m/p,T=p+w*m,[(d+w*h)/T,(h-w*d)/T]):(w=p/m,T=m+w*p,[(w*d+h)/T,(w*h-d)/T])}class CholeskyDecomposition{constructor(h){if(h=WrapperMatrix2D.checkMatrix(h),!h.isSymmetric())throw new Error("Matrix is not symmetric");let p=h,m=p.rows,w=new Matrix$2(m,m),T=!0,k,x,B;for(x=0;x<m;x++){let P=0;for(B=0;B<x;B++){let O=0;for(k=0;k<B;k++)O+=w.get(B,k)*w.get(x,k);O=(p.get(x,B)-O)/w.get(B,B),w.set(x,B,O),P=P+O*O}for(P=p.get(x,x)-P,T&=P>0,w.set(x,x,Math.sqrt(Math.max(P,0))),B=x+1;B<m;B++)w.set(x,B,0)}this.L=w,this.positiveDefinite=Boolean(T)}isPositiveDefinite(){return this.positiveDefinite}solve(h){h=WrapperMatrix2D.checkMatrix(h);let p=this.L,m=p.rows;if(h.rows!==m)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let w=h.columns,T=h.clone(),k,x,B;for(B=0;B<m;B++)for(x=0;x<w;x++){for(k=0;k<B;k++)T.set(B,x,T.get(B,x)-T.get(k,x)*p.get(B,k));T.set(B,x,T.get(B,x)/p.get(B,B))}for(B=m-1;B>=0;B--)for(x=0;x<w;x++){for(k=B+1;k<m;k++)T.set(B,x,T.get(B,x)-T.get(k,x)*p.get(k,B));T.set(B,x,T.get(B,x)/p.get(B,B))}return T}get lowerTriangularMatrix(){return this.L}}class nipals{constructor(h,p={}){h=WrapperMatrix2D.checkMatrix(h);let{Y:m}=p;const{scaleScores:w=!1,maxIterations:T=1e3,terminationCriteria:k=1e-10}=p;let x;if(m){if(Array.isArray(m)&&typeof m[0]=="number"?m=Matrix$2.columnVector(m):m=WrapperMatrix2D.checkMatrix(m),m.rows!==h.rows)throw new Error("Y should have the same number of rows as X");x=m.getColumnVector(0)}else x=h.getColumnVector(0);let B=1,P,O,U,G;for(let j=0;j<T&&B>k;j++)U=h.transpose().mmul(x).div(x.transpose().mmul(x).get(0,0)),U=U.div(U.norm()),P=h.mmul(U).div(U.transpose().mmul(U).get(0,0)),j>0&&(B=P.clone().sub(G).pow(2).sum()),G=P.clone(),m?(O=m.transpose().mmul(P).div(P.transpose().mmul(P).get(0,0)),O=O.div(O.norm()),x=m.mmul(O).div(O.transpose().mmul(O).get(0,0))):x=P;if(m){let j=h.transpose().mmul(P).div(P.transpose().mmul(P).get(0,0));j=j.div(j.norm());let H=h.clone().sub(P.clone().mmul(j.transpose())),te=x.transpose().mmul(P).div(P.transpose().mmul(P).get(0,0)),oe=m.clone().sub(P.clone().mulS(te.get(0,0)).mmul(O.transpose()));this.t=P,this.p=j.transpose(),this.w=U.transpose(),this.q=O,this.u=x,this.s=P.transpose().mmul(P),this.xResidual=H,this.yResidual=oe,this.betas=te}else this.w=U.transpose(),this.s=P.transpose().mmul(P).sqrt(),w?this.t=P.clone().div(this.s.get(0,0)):this.t=P,this.xResidual=h.sub(P.mmul(U.transpose()))}}var src$1=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",AbstractMatrix,default:Matrix$2,Matrix:Matrix$2,wrap,WrapperMatrix1D,WrapperMatrix2D,solve,inverse,determinant,linearDependencies,pseudoInverse,covariance,correlation,SingularValueDecomposition,SVD:SingularValueDecomposition,EigenvalueDecomposition,EVD:EigenvalueDecomposition,CholeskyDecomposition,CHO:CholeskyDecomposition,LuDecomposition,LU:LuDecomposition,QrDecomposition,QR:QrDecomposition,Nipals:nipals,NIPALS:nipals,MatrixColumnView,MatrixColumnSelectionView,MatrixFlipColumnView,MatrixFlipRowView,MatrixRowView,MatrixRowSelectionView,MatrixSelectionView,MatrixSubView,MatrixTransposeView:MatrixTransposeView$1});function getSeparatedKernel(d){const h=new SingularValueDecomposition(d,{autoTranspose:!0});if(h.rank!==1)return null;const p=Math.sqrt(h.s[0]),m=h.U.to2DArray().map(T=>T[0]*p),w=h.V.to2DArray().map(T=>T[0]*p);return[m,w]}function convolution(d,h={}){let{channels:p,bitDepth:m,normalize:w=!1,divisor:T=1,border:k="copy",algorithm:x="auto"}=h,B={};m&&(B.bitDepth=m);let P=Image$1.createFrom(this,B);if(p=validateArrayOfChannels(this,p),x!=="separable")({kernel:d}=validateKernel(d));else if(!Array.isArray(d)||d.length!==2)throw new RangeError("separable convolution requires two arrays of numbers to represent the kernel");if(x==="auto"){let le=getSeparatedKernel(d);le!==null?(x="separable",d=le):(d.length>9||d[0].length>9)&&this.width<=4096&&this.height<=4096?x="fft":x="direct"}let O,U;x==="separable"?(O=Math.floor(d[0].length/2),U=Math.floor(d[1].length/2)):(O=Math.floor(d.length/2),U=Math.floor(d[0].length/2));let G=P.isClamped,j=new Array(this.height*this.width),H,te,oe,Q,_e,se;for(Q=0;Q<p.length;Q++){for(_e=p[Q],oe=0;oe<this.height;oe++)for(te=0;te<this.width;te++)H=oe*this.width+te,j[H]=this.data[H*this.channels+_e];if(x==="direct")se=src$2.direct(j,d,{rows:this.height,cols:this.width,normalize:w,divisor:T});else if(x==="separable"){if(se=convolutionSeparable(j,d,this.width,this.height),w){T=0;for(let le=0;le<d[0].length;le++)for(let me=0;me<d[1].length;me++)T+=d[0][le]*d[1][me]}if(T!==1)for(let le=0;le<se.length;le++)se[le]/=T}else se=src$2.fft(j,d,{rows:this.height,cols:this.width,normalize:w,divisor:T});for(oe=0;oe<this.height;oe++)for(te=0;te<this.width;te++)H=oe*this.width+te,G?P.data[H*this.channels+_e]=clamp(se[H],P):P.data[H*this.channels+_e]=se[H]}if(this.alpha&&!p.includes(this.channels))for(te=this.components;te<this.data.length;te=te+this.channels)P.data[te]=this.data[te];return k!=="periodic"&&P.setBorder({size:[U,O],algorithm:k}),P}function gradientFilter(d={}){let{direction:h="xy",border:p="copy",kernelX:m,kernelY:w,channels:T,bitDepth:k=this.bitDepth}=d;switch(this.checkProcessable("gradientFilter",{bitDepth:[8,16]}),h){case"x":if(!m)throw new Error("kernelX option is missing");return convolution.call(this,m,{channels:T,border:p,bitDepth:k});case"y":if(!w)throw new Error("kernelY option is missing");return convolution.call(this,w,{channels:T,border:p,bitDepth:k});case"xy":{if(!m)throw new Error("kernelX option is missing");if(!w)throw new Error("kernelY option is missing");const x=convolution.call(this,m,{channels:T,border:p,bitDepth:32}),B=convolution.call(this,w,{channels:T,border:p,bitDepth:32});return x.hypotenuse(B,{bitDepth:k,channels:T})}default:throw new Error(`Unknown parameter direction: ${h}`)}}function sobelFilter(d){return gradientFilter.call(this,Object.assign({},d,{kernelX:SOBEL_X,kernelY:SOBEL_Y}))}function scharrFilter(d){return gradientFilter.call(this,Object.assign({},d,{kernelX:SCHARR_X,kernelY:SCHARR_Y}))}var newArray_1=newArray;function newArray(d,h){d=d||0;for(var p=new Array(d),m=0;m<d;m++)p[m]=h;return p}function level(d={}){let{algorithm:h="range",channels:p,min:m=this.min,max:w=this.max}=d;switch(this.checkProcessable("level",{bitDepth:[8,16,32]}),p=validateArrayOfChannels(this,{channels:p}),p.length!==this.channel&&(Array.isArray(m)&&m.length===this.channels&&(m=m.filter((T,k)=>p.includes(k))),Array.isArray(w)&&w.length===this.channels&&(w=w.filter((T,k)=>p.includes(k)))),h){case"range":m<0&&(m=0),w>this.maxValue&&(w=this.maxValue),Array.isArray(m)||(m=newArray_1(p.length,m)),Array.isArray(w)||(w=newArray_1(p.length,w)),processImage(this,m,w,p);break;default:throw new Error(`level: algorithm not implement: ${h}`)}return this}function processImage(d,h,p,m){let w=1e-5,T=new Array(m.length);for(let k=0;k<m.length;k++)h[k]===0&&p[k]===d.maxValue||p[k]===h[k]?T[k]=0:T[k]=(d.maxValue+1-w)/(p[k]-h[k]),h[k]+=(.5-w/2)/T[k];for(let k=0;k<m.length;k++){let x=m[k];if(T[k]!==0)for(let B=0;B<d.data.length;B+=d.channels)d.data[B+x]=Math.min(Math.max(0,(d.data[B+x]-h[k])*T[k]+.5|0),d.maxValue)}}var toString$1=Object.prototype.toString,isArrayType=function d(h){return toString$1.call(h).substr(-6,5)==="Array"};function checkNumberArray(d){if(isNaN(d)){if(d instanceof Image$1)return d.data;if(!isArrayType(d))throw new Error("checkNumberArray: the value should be either a number, array or Image");return d}else{if(d<=0)throw new Error("checkNumberArray: the value must be greater than 0");return d}}function add(d,h={}){let{channels:p}=h;if(this.checkProcessable("add",{bitDepth:[8,16]}),p=validateArrayOfChannels(this,{channels:p}),d=checkNumberArray(d),isNaN(d)){if(this.data.length!==d.length)throw new Error("add: the data size is different");for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,Math.min(this.maxValue,this.data[T+w]+d[T+w]>>0))}}else for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.min(this.maxValue,this.data[T+w]+d>>0)}return this}function subtract(d,h={}){let{channels:p}=h;if(this.checkProcessable("subtract",{bitDepth:[8,16]}),p=validateArrayOfChannels(this,{channels:p}),d=checkNumberArray(d),isNaN(d)){if(this.data.length!==d.length)throw new Error("subtract: the data size is different");for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,Math.min(this.maxValue,this.data[T+w]-d[T+w]>>0))}}else for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,this.data[T+w]-d>>0)}return this}function subtractImage(d,h={}){let{channels:p,absolute:m=!1}=h;if(this.checkProcessable("subtractImage",{bitDepth:[8,16]}),this.width!==d.width||this.height!==d.height)throw new Error("subtractImage: both images must have the same size");if(this.alpha!==d.alpha||this.bitDepth!==d.bitDepth)throw new Error("subtractImage: both images must have the same alpha and bitDepth");if(this.channels!==d.channels)throw new Error("subtractImage: both images must have the same number of channels");let w=this.clone();p=validateArrayOfChannels(this,{channels:p});for(let T=0;T<p.length;T++){let k=p[T];for(let x=k;x<this.data.length;x+=this.channels){let B=this.data[x]-d.data[x];m?w.data[x]=Math.abs(B):w.data[x]=Math.max(B,0)}}return w}function hypotenuse(d,h={}){let{bitDepth:p=this.bitDepth,channels:m}=h;if(this.checkProcessable("hypotenuse",{bitDepth:[8,16,32]}),this.width!==d.width||this.height!==d.height)throw new Error("hypotenuse: both images must have the same size");if(this.alpha!==d.alpha||this.bitDepth!==d.bitDepth)throw new Error("hypotenuse: both images must have the same alpha and bitDepth");if(this.channels!==d.channels)throw new Error("hypotenuse: both images must have the same number of channels");let w=Image$1.createFrom(this,{bitDepth:p});m=validateArrayOfChannels(this,{channels:m});let T=w.isClamped;for(let k=0;k<m.length;k++){let x=m[k];for(let B=x;B<this.data.length;B+=this.channels){let P=Math.hypot(this.data[B],d.data[B]);T?w.data[B]=Math.min(Math.max(Math.round(P),0),w.maxValue):w.data[B]=P}}return w}function multiply(d,h={}){let{channels:p}=h;if(this.checkProcessable("multiply",{bitDepth:[8,16]}),d<=0)throw new Error("multiply: the value must be greater than 0");if(p=validateArrayOfChannels(this,{channels:p}),d=checkNumberArray(d),isNaN(d)){if(this.data.length!==d.length)throw new Error("multiply: the data size is different");for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,Math.min(this.maxValue,this.data[T+w]*d[T+w]>>0))}}else for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.min(this.maxValue,this.data[T+w]*d>>0)}return this}function divide(d,h={}){let{channels:p}=h;if(this.checkProcessable("divide",{bitDepth:[8,16]}),p=validateArrayOfChannels(this,{channels:p}),d=checkNumberArray(d),isNaN(d)){if(this.data.length!==d.length)throw new Error("divide: the: the data size is different");for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.max(0,Math.min(this.maxValue,this.data[T+w]/d[T+w]>>0))}}else for(let m=0;m<p.length;m++){let w=p[m];for(let T=0;T<this.data.length;T+=this.channels)this.data[T+w]=Math.min(this.maxValue,this.data[T+w]/d>>0)}return this}class BaseRegression{constructor(){if(new.target===BaseRegression)throw new Error("BaseRegression must be subclassed")}predict(h){if(typeof h=="number")return this._predict(h);if(isAnyArray(h)){const p=[];for(let m=0;m<h.length;m++)p.push(this._predict(h[m]));return p}else throw new TypeError("x must be a number or array")}_predict(){throw new Error("_predict must be implemented")}train(){}toString(){return""}toLaTeX(){return""}score(h,p){if(!isAnyArray(h)||!isAnyArray(p)||h.length!==p.length)throw new Error("x and y must be arrays of the same length");const m=h.length,w=new Array(m);for(let j=0;j<m;j++)w[j]=this._predict(h[j]);let T=0,k=0,x=0,B=0,P=0,O=0,U=0;for(let j=0;j<m;j++)T+=w[j],k+=p[j],P+=w[j]*w[j],O+=p[j]*p[j],U+=w[j]*p[j],p[j]!==0&&(x+=(p[j]-w[j])*(p[j]-w[j])/p[j]),B+=(p[j]-w[j])*(p[j]-w[j]);const G=(m*U-T*k)/Math.sqrt((m*P-T*T)*(m*O-k*k));return{r:G,r2:G*G,chi2:x,rmsd:Math.sqrt(B/m)}}}var require$$0$1=getAugmentedNamespace(src$1);function squaredEuclidean$4(d,h){let p=0;for(let m=0;m<d.length;m++)p+=(d[m]-h[m])*(d[m]-h[m]);return p}function euclidean$2(d,h){return Math.sqrt(squaredEuclidean$4(d,h))}var euclidean$3=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",squaredEuclidean:squaredEuclidean$4,euclidean:euclidean$2}),require$$0=getAugmentedNamespace(euclidean$3);const{squaredEuclidean:squaredEuclidean$3}=require$$0,defaultOptions$b={sigma:1};class GaussianKernel$1{constructor(h){h=Object.assign({},defaultOptions$b,h),this.sigma=h.sigma,this.divisor=2*h.sigma*h.sigma}compute(h,p){const m=squaredEuclidean$3(h,p);return Math.exp(-m/this.divisor)}}var gaussianKernel=GaussianKernel$1;const defaultOptions$a={degree:1,constant:1,scale:1};class PolynomialKernel$1{constructor(h){h=Object.assign({},defaultOptions$a,h),this.degree=h.degree,this.constant=h.constant,this.scale=h.scale}compute(h,p){for(var m=0,w=0;w<h.length;w++)m+=h[w]*p[w];return Math.pow(this.scale*m+this.constant,this.degree)}}var polynomialKernel=PolynomialKernel$1;const defaultOptions$9={alpha:.01,constant:-Math.E};class SigmoidKernel$1{constructor(h){h=Object.assign({},defaultOptions$9,h),this.alpha=h.alpha,this.constant=h.constant}compute(h,p){for(var m=0,w=0;w<h.length;w++)m+=h[w]*p[w];return Math.tanh(this.alpha*m+this.constant)}}var sigmoidKernel=SigmoidKernel$1;const defaultOptions$8={sigma:1,degree:1};class ANOVAKernel$1{constructor(h){h=Object.assign({},defaultOptions$8,h),this.sigma=h.sigma,this.degree=h.degree}compute(h,p){for(var m=0,w=Math.min(h.length,p.length),T=1;T<=w;++T)m+=Math.pow(Math.exp(-this.sigma*Math.pow(Math.pow(h[T-1],T)-Math.pow(p[T-1],T),2)),this.degree);return m}}var anovaKernel=ANOVAKernel$1;const{squaredEuclidean:squaredEuclidean$2}=require$$0,defaultOptions$7={sigma:1};class CauchyKernel$1{constructor(h){h=Object.assign({},defaultOptions$7,h),this.sigma=h.sigma}compute(h,p){return 1/(1+squaredEuclidean$2(h,p)/(this.sigma*this.sigma))}}var cauchyKernel=CauchyKernel$1;const{euclidean:euclidean$1}=require$$0,defaultOptions$6={sigma:1};class ExponentialKernel$1{constructor(h){h=Object.assign({},defaultOptions$6,h),this.sigma=h.sigma,this.divisor=2*h.sigma*h.sigma}compute(h,p){const m=euclidean$1(h,p);return Math.exp(-m/this.divisor)}}var exponentialKernel=ExponentialKernel$1;class HistogramIntersectionKernel{compute(h,p){for(var m=Math.min(h.length,p.length),w=0,T=0;T<m;++T)w+=Math.min(h[T],p[T]);return w}}var histogramIntersectionKernel=HistogramIntersectionKernel;const{euclidean}=require$$0,defaultOptions$5={sigma:1};class LaplacianKernel$1{constructor(h){h=Object.assign({},defaultOptions$5,h),this.sigma=h.sigma}compute(h,p){const m=euclidean(h,p);return Math.exp(-m/this.sigma)}}var laplacianKernel=LaplacianKernel$1;const{squaredEuclidean:squaredEuclidean$1}=require$$0,defaultOptions$4={constant:1};class MultiquadraticKernel$1{constructor(h){h=Object.assign({},defaultOptions$4,h),this.constant=h.constant}compute(h,p){return Math.sqrt(squaredEuclidean$1(h,p)+this.constant*this.constant)}}var multiquadraticKernel=MultiquadraticKernel$1;const{squaredEuclidean}=require$$0,defaultOptions$3={constant:1};class RationalQuadraticKernel{constructor(h){h=Object.assign({},defaultOptions$3,h),this.constant=h.constant}compute(h,p){const m=squaredEuclidean(h,p);return 1-m/(m+this.constant)}}var rationalQuadraticKernel=RationalQuadraticKernel;const{Matrix:Matrix$1,MatrixTransposeView}=require$$0$1,GaussianKernel=gaussianKernel,PolynomialKernel=polynomialKernel,SigmoidKernel=sigmoidKernel,ANOVAKernel=anovaKernel,CauchyKernel=cauchyKernel,ExponentialKernel=exponentialKernel,HistogramKernel=histogramIntersectionKernel,LaplacianKernel=laplacianKernel,MultiquadraticKernel=multiquadraticKernel,RationalKernel=rationalQuadraticKernel,kernelType={gaussian:GaussianKernel,rbf:GaussianKernel,polynomial:PolynomialKernel,poly:PolynomialKernel,anova:ANOVAKernel,cauchy:CauchyKernel,exponential:ExponentialKernel,histogram:HistogramKernel,min:HistogramKernel,laplacian:LaplacianKernel,multiquadratic:MultiquadraticKernel,rational:RationalKernel,sigmoid:SigmoidKernel,mlp:SigmoidKernel};class Kernel{constructor(h,p){if(this.kernelType=h,h!=="linear")if(typeof h=="string"){h=h.toLowerCase();var m=kernelType[h];if(m)this.kernelFunction=new m(p);else throw new Error(`unsupported kernel type: ${h}`)}else if(typeof h=="object"&&typeof h.compute=="function")this.kernelFunction=h;else throw new TypeError("first argument must be a valid kernel type or instance")}compute(h,p){if(h=Matrix$1.checkMatrix(h),p===void 0?p=h:p=Matrix$1.checkMatrix(p),this.kernelType==="linear")return h.mmul(new MatrixTransposeView(p));const m=new Matrix$1(h.rows,p.rows);if(h===p)for(let w=0;w<h.rows;w++)for(let T=w;T<h.rows;T++){const k=this.kernelFunction.compute(h.getRow(w),h.getRow(T));m.set(w,T,k),m.set(T,w,k)}else for(let w=0;w<h.rows;w++)for(let T=0;T<p.rows;T++)m.set(w,T,this.kernelFunction.compute(h.getRow(w),p.getRow(T)));return m}}var kernel=Kernel;const defaultOptions$2={lambda:.1,kernelType:"gaussian",kernelOptions:{},computeCoefficient:!1};class KernelRidgeRegression extends BaseRegression{constructor(h,p,m){super();if(h===!0)this.alpha=p.alpha,this.inputs=p.inputs,this.kernelType=p.kernelType,this.kernelOptions=p.kernelOptions,this.kernel=new kernel(p.kernelType,p.kernelOptions);else{h=Matrix$2.checkMatrix(h),m=Object.assign({},defaultOptions$2,m);const w=new kernel(m.kernelType,m.kernelOptions),T=w.compute(h),k=h.rows;T.add(Matrix$2.eye(k,k).mul(m.lambda)),this.alpha=solve(T,p),this.inputs=h,this.kernelType=m.kernelType,this.kernelOptions=m.kernelOptions,this.kernel=w}}_predict(h){return this.kernel.compute([h],this.inputs).mmul(this.alpha).getRow(0)}toJSON(){return{name:"kernelRidgeRegression",alpha:this.alpha,inputs:this.inputs,kernelType:this.kernelType,kernelOptions:this.kernelOptions}}static load(h){if(h.name!=="kernelRidgeRegression")throw new TypeError("not a KRR model");return new KernelRidgeRegression(!0,h)}}function background$1(d,h,p){const m=new KernelRidgeRegression(d,h,p),w=new Array(this.size);for(let x=0;x<this.width;x++)for(let B=0;B<this.height;B++)w[B*this.width+x]=[x,B];const T=m.predict(w),k=Image$1.createFrom(this);for(let x=0;x<this.size;x++)k.data[x]=Math.min(this.maxValue,Math.max(0,T[x][0]));return k}function dilate(d={}){let{kernel:h=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=d;if(this.checkProcessable("dilate",{bitDepth:[1,8,16],components:1,alpha:0}),h.columns%2===0||h.rows%2===0)throw new TypeError("dilate: The number of rows and columns of the kernel must be odd");let m=!0;e:for(const T of h)for(const k of T)if(k!==1){m=!1;break e}let w=this;for(let T=0;T<p;T++)if(this.bitDepth===1)if(m){const k=w.clone();w=dilateOnceBinaryOnlyOnes(w,k,h.length,h[0].length)}else{const k=Image$1.createFrom(w);w=dilateOnceBinary(w,k,h)}else if(m){const k=Image$1.createFrom(w);w=dilateOnceGreyOnlyOnes(w,k,h.length,h[0].length)}else{const k=Image$1.createFrom(w);w=dilateOnceGrey(w,k,h)}return w}function dilateOnceGrey(d,h,p){const m=p.length,w=p[0].length;let T=(m-1)/2,k=(w-1)/2;for(let x=0;x<d.height;x++)for(let B=0;B<d.width;B++){let P=0;for(let O=0;O<w;O++)for(let U=0;U<m;U++){if(p[U][O]!==1)continue;let G=U-T+B,j=O-k+x;if(G<0||j<0||G>=d.width||j>=d.height)continue;const H=d.getValueXY(G,j,0);H>P&&(P=H)}h.setValueXY(B,x,0,P)}return h}function dilateOnceGreyOnlyOnes(d,h,p,m){const w=(p-1)/2,T=(m-1)/2,k=[];for(let x=0;x<d.width;x++)k.push(0);for(let x=0;x<d.height;x++){for(let B=0;B<d.width;B++){let P=0;for(let O=Math.max(0,x-T);O<Math.min(d.height,x+T+1);O++){const U=d.getValueXY(B,O,0);U>P&&(P=U)}k[B]=P}for(let B=0;B<d.width;B++){let P=0;for(let O=Math.max(0,B-w);O<Math.min(d.width,B+w+1);O++)k[O]>P&&(P=k[O]);h.setValueXY(B,x,0,P)}}return h}function dilateOnceBinary(d,h,p){const m=p.length,w=p[0].length;let T=(m-1)/2,k=(w-1)/2;for(let x=0;x<d.height;x++)for(let B=0;B<d.width;B++){let P=0;e:for(let O=0;O<w;O++)for(let U=0;U<m;U++){if(p[U][O]!==1)continue;let G=U-T+B,j=O-k+x;if(j<0||G<0||G>=d.width||j>=d.height)continue;if(d.getBitXY(G,j)===1){P=1;break e}}P===1&&h.setBitXY(B,x)}return h}function dilateOnceBinaryOnlyOnes(d,h,p,m){const w=(p-1)/2,T=(m-1)/2,k=[];for(let x=0;x<d.width;x++)k.push(1);for(let x=0;x<d.height;x++){for(let B=0;B<d.width;B++){k[B]=0;for(let P=Math.max(0,x-T);P<Math.min(d.height,x+T+1);P++)if(d.getBitXY(B,P)===1){k[B]=1;break}}for(let B=0;B<d.width;B++)if(h.getBitXY(B,x)!==1){for(let P=Math.max(0,B-w);P<Math.min(d.width,B+w+1);P++)if(k[P]===1){h.setBitXY(B,x);break}}}return h}function erode(d={}){let{kernel:h=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=d;if(this.checkProcessable("erode",{bitDepth:[1,8,16],components:1,alpha:0}),h.columns%2===0||h.rows%2===0)throw new TypeError("erode: The number of rows and columns of the kernel must be odd");let m=!0;e:for(const T of h)for(const k of T)if(k!==1){m=!1;break e}let w=this;for(let T=0;T<p;T++)if(this.bitDepth===1)if(m){const k=w.clone();w=erodeOnceBinaryOnlyOnes(w,k,h.length,h[0].length)}else{const k=Image$1.createFrom(w);w=erodeOnceBinary(w,k,h)}else if(m){const k=Image$1.createFrom(w);w=erodeOnceGreyOnlyOnes(w,k,h.length,h[0].length)}else{const k=Image$1.createFrom(w);w=erodeOnceGrey(w,k,h)}return w}function erodeOnceGrey(d,h,p){const m=p.length,w=p[0].length;let T=(m-1)/2,k=(w-1)/2;for(let x=0;x<d.height;x++)for(let B=0;B<d.width;B++){let P=d.maxValue;for(let O=0;O<w;O++)for(let U=0;U<m;U++){if(p[U][O]!==1)continue;let G=U-T+B,j=O-k+x;if(G<0||j<0||G>=d.width||j>=d.height)continue;const H=d.getValueXY(G,j,0);H<P&&(P=H)}h.setValueXY(B,x,0,P)}return h}function erodeOnceGreyOnlyOnes(d,h,p,m){const w=(p-1)/2,T=(m-1)/2,k=[];for(let x=0;x<d.width;x++)k.push(0);for(let x=0;x<d.height;x++){for(let B=0;B<d.width;B++){let P=d.maxValue;for(let O=Math.max(0,x-T);O<Math.min(d.height,x+T+1);O++){const U=d.getValueXY(B,O,0);U<P&&(P=U)}k[B]=P}for(let B=0;B<d.width;B++){let P=d.maxValue;for(let O=Math.max(0,B-w);O<Math.min(d.width,B+w+1);O++)k[O]<P&&(P=k[O]);h.setValueXY(B,x,0,P)}}return h}function erodeOnceBinary(d,h,p){const m=p.length,w=p[0].length;let T=(m-1)/2,k=(w-1)/2;for(let x=0;x<d.height;x++)for(let B=0;B<d.width;B++){let P=1;e:for(let O=0;O<w;O++)for(let U=0;U<m;U++){if(p[U][O]!==1)continue;let G=U-T+B,j=O-k+x;if(j<0||G<0||G>=d.width||j>=d.height)continue;if(d.getBitXY(G,j)===0){P=0;break e}}P===1&&h.setBitXY(B,x)}return h}function erodeOnceBinaryOnlyOnes(d,h,p,m){const w=(p-1)/2,T=(m-1)/2,k=[];for(let x=0;x<d.width;x++)k.push(0);for(let x=0;x<d.height;x++){for(let B=0;B<d.width;B++){k[B]=1;for(let P=Math.max(0,x-T);P<Math.min(d.height,x+T+1);P++)if(d.getBitXY(B,P)===0){k[B]=0;break}}for(let B=0;B<d.width;B++)if(h.getBitXY(B,x)!==0){for(let P=Math.max(0,B-w);P<Math.min(d.width,B+w+1);P++)if(k[P]===0){h.clearBitXY(B,x);break}}}return h}function open(d={}){let{kernel:h=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=d;if(this.checkProcessable("open",{bitDepth:[8,16],components:1,alpha:0}),h.columns%2===0||h.rows%2===0)throw new TypeError("open: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++)m=m.erode({kernel:h}),m=m.dilate({kernel:h});return m}function close(d={}){let{kernel:h=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=d;if(this.checkProcessable("close",{bitDepth:[1,8,16],components:1,alpha:0}),h.columns%2===0||h.rows%2===0)throw new TypeError("close: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++)m=m.dilate({kernel:h}).erode({kernel:h});return m}function topHat(d={}){let{kernel:h=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=d;if(this.checkProcessable("topHat",{bitDepth:[8,16],components:1,alpha:0}),h.length%2===0||h[0].length%2===0)throw new TypeError("topHat: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++)m=m.open({kernel:h}).subtractImage(m,{absolute:!0});return m}function blackHat(d={}){let{kernel:h=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=d;if(this.checkProcessable("blackHat",{bitDepth:[8,16],components:1,alpha:0}),h.columns%2===0||h.rows%2===0)throw new TypeError("blackHat: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++)m=m.close({kernel:h}).subtractImage(m,{absolute:!0});return m}function morphologicalGradient(d={}){let{kernel:h=[[1,1,1],[1,1,1],[1,1,1]],iterations:p=1}=d;if(this.checkProcessable("morphologicalGradient",{bitDepth:[8,16],components:1,alpha:0}),h.columns%2===0||h.rows%2===0)throw new TypeError("morphologicalGradient: The number of rows and columns of the kernel must be odd");let m=this;for(let w=0;w<p;w++){let T=m.dilate({kernel:h}),k=m.erode({kernel:h});m=T.subtractImage(k,{absolute:!0})}return m}function order4Points(d){let h=0,p=0,m=0,w=0,T=d[0][0],k=0;for(let P=1;P<d.length;P++)d[P][0]<T&&(T=d[P][0],k=P);let x=d[(k+1)%d.length][0],B=(k+1)%d.length;for(let P=1;P<d.length;P++)d[P][0]<x&&P!==k&&(x=d[P][0],B=P);return d[B][1]<d[k][1]?(h=d[B],w=d[k],k!==(B+1)%4?(p=d[(B+1)%4],m=d[(B+2)%4]):(p=d[(B+2)%4],m=d[(B+3)%4])):(w=d[B],h=d[k],B!==(k+1)%4?(p=d[(k+1)%4],m=d[(k+2)%4]):(p=d[(k+2)%4],m=d[(k+3)%4])),[h,p,m,w]}function distance2Points(d,h){return Math.sqrt(Math.pow(d[0]-h[0],2)+Math.pow(d[1]-h[1],2))}function crossVect(d,h){return[d[1]*h[2]-d[2]*h[1],d[2]*h[0]-d[0]*h[2],d[0]*h[1]-d[1]*h[0]]}function dotVect(d,h){return d[0]*h[0]+d[1]*h[1]+d[2]*h[2]}function computeWidthAndHeigth(d,h,p,m,w,T){let k=Math.max(distance2Points(d,h),distance2Points(m,p)),x=Math.max(distance2Points(d,m),distance2Points(h,p)),B=0,P=0,O=Math.ceil(w/2),U=Math.ceil(T/2),G=k/x,j=[d[0],d[1],1],H=[h[0],h[1],1],te=[m[0],m[1],1],oe=[p[0],p[1],1],Q=dotVect(crossVect(j,oe),te)/dotVect(crossVect(H,oe),te),_e=dotVect(crossVect(j,oe),H)/dotVect(crossVect(te,oe),H),se=[Q*H[0]-j[0],Q*H[1]-j[1],Q*H[2]-j[2]],le=[_e*te[0]-j[0],_e*te[1]-j[1],_e*te[2]-j[2]],me=se[0],Re=se[1],xe=se[2],ue=le[0],Me=le[1],he=le[2],ge=1/(xe*he)*(me*ue-(me*he+xe*ue)*O+xe*he*O*O+(Re*Me-(Re*he+xe*Me)*U+xe*he*U*U));ge>=0?ge=Math.sqrt(ge):ge=Math.sqrt(-ge);let Le=new Matrix$2([[ge,0,O],[0,ge,U],[0,0,1]]),Ze=Le.transpose(),st=inverse(Ze),ht=inverse(Le),Rt=Matrix$2.rowVector(se),Bt=Matrix$2.rowVector(le),At=Math.sqrt(dotVect(Rt.mmul(st).mmul(ht).to1DArray(),se)/dotVect(Bt.mmul(st).mmul(ht).to1DArray(),le));return At===0||G===0?(B=Math.ceil(k),P=Math.ceil(x)):At<G?(B=Math.ceil(k),P=Math.ceil(B/At)):(P=Math.ceil(x),B=Math.ceil(At*P)),[B,P]}function projectionPoint(d,h,p,m,w,T,k,x,B,P,O,U){let[G,j]=[(p*d+m*h+w)/(B*d+P*h+1),(T*d+k*h+x)/(B*d+P*h+1)];return O.getValueXY(Math.floor(G),Math.floor(j),U)}function warpingFourPoints(d,h={}){let{calculateRatio:p=!0}=h;if(d.length!==4)throw new Error(`The array pts must have four elements, which are the four corners. Currently, pts have ${d.length} elements`);let[m,w,T,k]=d,x=[m,w,T,k],[B,P,O,U]=order4Points(x),G,j;p?[G,j]=computeWidthAndHeigth(B,P,O,U,this.width,this.height):(G=Math.ceil(Math.max(distance2Points(B,P),distance2Points(U,O))),j=Math.ceil(Math.max(distance2Points(B,U),distance2Points(P,O))));let H=Image$1.createFrom(this,{width:G,height:j}),[te,oe]=B,[Q,_e]=P,[se,le]=O,[me,Re]=U,[xe,ue]=[0,0],[Me,he]=[0,G-1],[ge,Le]=[j-1,G-1],[Ze,st]=[j-1,0],ht=new Matrix$2([[xe,ue,1,0,0,0,-xe*te,-ue*te],[Me,he,1,0,0,0,-Me*Q,-he*Q],[ge,Le,1,0,0,0,-ge*se,-ue*se],[Ze,st,1,0,0,0,-Ze*me,-st*me],[0,0,0,xe,ue,1,-xe*oe,-ue*oe],[0,0,0,Me,he,1,-Me*_e,-he*_e],[0,0,0,ge,Le,1,-ge*le,-Le*le],[0,0,0,Ze,st,1,-Ze*Re,-st*Re]]),Rt=Matrix$2.columnVector([te,Q,se,me,oe,_e,le,Re]),At=new SingularValueDecomposition(ht).solve(Rt),[Nt,zt,Tt,ii,Mt,St,wt,Ut]=At.to1DArray(),Vt=new Matrix$2(j,G);for(let pi=0;pi<this.channels;pi++){for(let ni=0;ni<j;ni++)for(let _i=0;_i<G;_i++)Vt.set(ni,_i,projectionPoint(ni,_i,Nt,zt,Tt,ii,Mt,St,wt,Ut,this,pi));H.setMatrix(Vt,{channel:pi})}return H}function crop(d={}){let{x:h=0,y:p=0,width:m=this.width-h,height:w=this.height-p}=d;if(this.checkProcessable("max",{bitDepth:[8,16]}),h=Math.round(h),p=Math.round(p),m=Math.round(m),w=Math.round(w),h>this.width-1||p>this.height-1)throw new RangeError(`crop: origin (x:${h}, y:${p}) out of range (${this.width-1}; ${this.height-1})`);if(m<=0||w<=0)throw new RangeError(`crop: width and height (width:${m}; height:${w}) must be positive numbers`);if(h<0||p<0)throw new RangeError(`crop: x and y (x:${h}, y:${p}) must be positive numbers`);if(m>this.width-h||w>this.height-p)throw new RangeError(`crop: (x: ${h}, y:${p}, width:${m}, height:${w}) size is out of range`);let T=Image$1.createFrom(this,{width:m,height:w,position:[h,p]}),k=m*this.channels,x=p+w,B=0,P=h*this.channels;for(let O=p;O<x;O++){let U=O*this.width*this.channels+P,G=U+k;for(;U<G;U++)T.data[B++]=this.data[U]}return T}function cropAlpha(d={}){this.checkProcessable("cropAlpha",{alpha:1});const{threshold:h=this.maxValue}=d;let p=findLeft(this,h,this.components);if(p===-1)throw new Error("Could not find new dimensions. Threshold may be too high.");let m=findTop(this,h,this.components,p),w=findBottom(this,h,this.components,p),T=findRight(this,h,this.components,p,m,w);return this.crop({x:p,y:m,width:T-p+1,height:w-m+1})}function findLeft(d,h,p){for(let m=0;m<d.width;m++)for(let w=0;w<d.height;w++)if(d.getValueXY(m,w,p)>=h)return m;return-1}function findTop(d,h,p,m){for(let w=0;w<d.height;w++)for(let T=m;T<d.width;T++)if(d.getValueXY(T,w,p)>=h)return w;return-1}function findBottom(d,h,p,m){for(let w=d.height-1;w>=0;w--)for(let T=m;T<d.width;T++)if(d.getValueXY(T,w,p)>=h)return w;return-1}function findRight(d,h,p,m,w,T){for(let k=d.width-1;k>=m;k--)for(let x=w;x<=T;x++)if(d.getValueXY(k,x,p)>=h)return k;return-1}function getFactor(d){if(typeof d=="string"){const h=d[d.length-1];d=parseFloat(d),h==="%"&&(d/=100)}return d}function getThreshold$1(d,h){if(!h)throw Error("getThreshold : the maxValue should be specified");if(typeof d=="string"){if(d[d.length-1]!=="%")throw Error("getThreshold : if the value is a string it must finish by %");return parseFloat(d)/100*h}else{if(typeof d=="number")return d<1?d*h:d;throw Error("getThreshold : the value is not valid")}}function factorDimensions(d,h,p){d=getFactor(d);let m=Math.round(d*h),w=Math.round(d*p);return m<=0&&(m=1),w<=0&&(w=1),{width:m,height:w}}function checkRow(d,h){if(h<0||h>=d.height)throw new RangeError(`row must be included between 0 and ${d.height-1}. Current value: ${h}`)}function checkColumn(d,h){if(h<0||h>=d.width)throw new RangeError(`column must be included between 0 and ${d.width-1}. Current value: ${h}`)}function checkChannel(d,h){if(h<0||h>=d.channels)throw new RangeError(`channel must be included between 0 and ${d.channels-1}. Current value: ${h}`)}const validInterpolations={nearestneighbor:"nearestNeighbor",nearestneighbour:"nearestNeighbor",bilinear:"bilinear"};function checkInterpolation(d){if(typeof d!="string")throw new TypeError("interpolation must be a string");if(d=d.toLowerCase(),!validInterpolations[d])throw new RangeError(`invalid interpolation algorithm: ${d}`);return validInterpolations[d]}function nearestNeighbor(d,h,p){const m=this.width/h,w=this.height/p;if(this.bitDepth>1)for(let T=0;T<h;T++){const k=Math.floor((T+.5)*m);for(let x=0;x<p;x++){const B=Math.floor((x+.5)*w);for(let P=0;P<this.channels;P++)d.setValueXY(T,x,P,this.getValueXY(k,B,P))}}else for(let T=0;T<h;T++){const k=Math.floor((T+.5)*m);for(let x=0;x<p;x++){const B=Math.floor((x+.5)*w);this.getBitXY(k,B)&&d.setBitXY(T,x)}}}function resize(d={}){const{factor:h=1,interpolation:p=validInterpolations.nearestneighbor,preserveAspectRatio:m=!0}=d,w=checkInterpolation(p);let T=d.width,k=d.height;if(T||(k&&m?T=Math.round(k*(this.width/this.height)):T=this.width),k||(m?k=Math.round(T*(this.height/this.width)):k=this.height),{width:T,height:k}=factorDimensions(h,T,k),T===this.width&&k===this.height){const O=this.clone();return O.position=[0,0],O}let x=Math.round((this.width-T)/2),B=Math.round((this.height-k)/2);const P=Image$1.createFrom(this,{width:T,height:k,position:[x,B]});switch(w){case validInterpolations.nearestneighbor:nearestNeighbor.call(this,P,T,k);break;default:throw new Error(`unsupported resize interpolation: ${w}`)}return P}function hsv(){this.checkProcessable("hsv",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let d=Image$1.createFrom(this,{colorModel:HSV}),h=0,p=this.data;for(let m=0;m<p.length;m+=this.channels){let w=p[m],T=p[m+1],k=p[m+2],x=Math.min(w,T,k),B=Math.max(w,T,k),P=B-x,O=0,U=B===0?0:P/B,G=B;if(B!==x){switch(B){case w:O=(T-k)/P+(T<k?6:0);break;case T:O=(k-w)/P+2;break;case k:O=(w-T)/P+4;break;default:throw new Error("unreachable")}O/=6}d.data[h++]=O*this.maxValue,d.data[h++]=U*this.maxValue,d.data[h++]=G,this.alpha&&(d.data[h++]=p[m+3])}return d}function hsl$1(){this.checkProcessable("hsl",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let d=Image$1.createFrom(this,{colorModel:HSL}),h=Math.floor(this.maxValue/2),p=0,m=this.data;for(let w=0;w<m.length;w+=this.channels){let T=m[w],k=m[w+1],x=m[w+2],B=Math.max(T,k,x),P=Math.min(T,k,x),O=0,U=0,G=(B+P)/2;if(B!==P){let j=B-P;switch(U=G>h?j/(2-B-P):j/(B+P),B){case T:O=(k-x)/j+(k<x?6:0);break;case k:O=(x-T)/j+2;break;case x:O=(T-k)/j+4;break;default:throw new Error("unreachable")}O/=6}d.data[p++]=O*this.maxValue,d.data[p++]=U*this.maxValue,d.data[p++]=G,this.alpha&&(d.data[p++]=m[w+3])}return d}function cmyk(){this.checkProcessable("cmyk",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let d=Image$1.createFrom(this,{components:4,colorModel:CMYK$1}),h=0,p=this.data;for(let m=0;m<p.length;m+=this.channels){let w=p[m],T=p[m+1],k=p[m+2],x=Math.min(this.maxValue-w,this.maxValue-T,this.maxValue-k),B=(this.maxValue-w-x)/(1-x/this.maxValue),P=(this.maxValue-T-x)/(1-x/this.maxValue),O=(this.maxValue-k-x)/(1-x/this.maxValue);d.data[h++]=Math.round(B),d.data[h++]=Math.round(P),d.data[h++]=Math.round(O),d.data[h++]=Math.round(x),this.alpha&&(d.data[h++]=p[m+3])}return d}function rgba8(){return new Image$1(this.width,this.height,this.getRGBAData(),{kind:"RGBA",parent:this})}const methods$1={luma709(d,h,p){return d*6966+h*23436+p*2366>>15},luma601(d,h,p){return d*9798+h*19235+p*3735>>15},maximum(d,h,p){return Math.max(d,h,p)},minimum(d,h,p){return Math.min(d,h,p)},average(d,h,p){return(d+h+p)/3>>0},minmax(d,h,p){return(Math.max(d,h,p)+Math.min(d,h,p))/2},red(d){return d},green(d,h){return h},blue(d,h,p){return p},cyan(d,h,p,m){let w=methods$1.black(d,h,p,m);return(m.maxValue-d-w)/(1-w/m.maxValue)>>0},magenta(d,h,p,m){let w=methods$1.black(d,h,p,m);return(m.maxValue-h-w)/(1-w/m.maxValue)>>0},yellow(d,h,p,m){let w=methods$1.black(d,h,p,m);return(m.maxValue-p-w)/(1-w/m.maxValue)>>0},black(d,h,p,m){return Math.min(m.maxValue-d,m.maxValue-h,m.maxValue-p)},hue(d,h,p,m){let w=methods$1.min(d,h,p),T=methods$1.max(d,h,p);if(T===w)return 0;let k=0,x=T-w;switch(T){case d:k=(h-p)/x+(h<p?6:0);break;case h:k=(p-d)/x+2;break;case p:k=(d-h)/x+4;break;default:throw new Error("unreachable")}return k/6*m.maxValue>>0},saturation(d,h,p,m){let w=methods$1.min(d,h,p),T=methods$1.max(d,h,p),k=T-w;return T===0?0:k/T*m.maxValue},lightness(d,h,p){let m=methods$1.min(d,h,p);return(methods$1.max(d,h,p)+m)/2}};Object.defineProperty(methods$1,"luminosity",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"luminance",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"min",{enumerable:!1,value:methods$1.minimum});Object.defineProperty(methods$1,"max",{enumerable:!1,value:methods$1.maximum});Object.defineProperty(methods$1,"brightness",{enumerable:!1,value:methods$1.maximum});const names$1={};Object.keys(methods$1).forEach(d=>{names$1[d]=d});function grey(d={}){let{algorithm:h="luma709",keepAlpha:p=!1,mergeAlpha:m=!0}=d;if(typeof h!="string"&&typeof h!="function")throw new TypeError("algorithm must be a string or a function");this.checkProcessable("grey",{bitDepth:[8,16],alpha:[0,1]}),this.components===1&&(h="red"),p&=this.alpha,m&=this.alpha,p&&(m=!1);let w=getOutputImage(this,d,{components:1,alpha:p,colorModel:GREY$1}),T;if(typeof h=="function")T=h;else if(T=methods$1[h.toLowerCase()],!T)throw new Error(`unsupported grey algorithm: ${h}`);let k=0;for(let x=0;x<this.data.length;x+=this.channels)m?w.data[k++]=clamp(T(this.data[x],this.data[x+1],this.data[x+2],this)*this.data[x+this.components]/this.maxValue,this):(w.data[k++]=clamp(T(this.data[x],this.data[x+1],this.data[x+2],this),this),w.alpha&&(w.data[k++]=this.data[x+this.components]));return w}function huang(d){let h=0;for(let O=0;O<d.length;O++)if(d[O]!==0){h=O;break}let p=d.length-1;for(let O=d.length-1;O>=h;O--)if(d[O]!==0){p=O;break}let m=1/(p-h),w=new Array(d.length),T=0,k=0;for(let O=h;O<d.length;O++)T+=O*d[O],k+=d[O],w[O]=T/k;let x=new Array(d.length);T=k=0;for(let O=p;O>0;O--)T+=O*d[O],k+=d[O],x[O-1]=T/k;let B=-1,P=Number.MAX_VALUE;for(let O=0;O<d.length;O++){let U=0,G;for(let j=0;j<=O;j++)G=1/(1+m*Math.abs(j-w[O])),G<1e-6||G>.999999||(U+=d[j]*(-G*Math.log(G)-(1-G)*Math.log(1-G)));for(let j=O+1;j<d.length;j++)G=1/(1+m*Math.abs(j-x[O])),G<1e-6||G>.999999||(U+=d[j]*(-G*Math.log(G)-(1-G)*Math.log(1-G)));U<P&&(P=U,B=O)}return B}function intermodes(d){let h=d.slice(),p=0;for(;!bimodalTest$1(h);){let w=0,T=0,k=h[0];for(let x=0;x<d.length-1;x++)w=T,T=k,k=h[x+1],h[x]=(w+T+k)/3;if(h[d.length-1]=(T+k)/3,p++,p>1e4)throw new Error("Intermodes Threshold not found after 10000 iterations")}let m=0;for(let w=1;w<d.length-1;w++)h[w-1]<h[w]&&h[w+1]<h[w]&&(m+=w);return Math.floor(m/2)}function bimodalTest$1(d){let h=!1,p=0;for(let m=1;m<d.length-1;m++)if(d[m-1]<d[m]&&d[m+1]<d[m]&&(p++,p>2))return!1;return p===2&&(h=!0),h}function isodata(d){let h,p,m,w,T=0;for(let k=1;k<d.length;k++)if(d[k]>0){T=k+1;break}for(;;){h=0,m=0;for(let k=0;k<T;k++)m=m+d[k],h=h+d[k]*k;w=0,p=0;for(let k=T+1;k<d.length;k++)p+=d[k],w+=d[k]*k;if(m>0&&p>0&&(h/=m,w/=p,T===Math.round((h+w)/2)))break;if(T++,T>d.length-2)throw new Error("Threshold not found")}return T}function li(d,h){let p,m,w,T,k,x,B,P,O,U,G,j;G=.5,U=0;for(let H=0;H<d.length;H++)U+=H*d[H];U/=h,B=U;do{x=B,p=x+.5|0,m=0,T=0;for(let H=0;H<=p;H++)m+=H*d[H],T+=d[H];P=T===0?0:m/T,w=0,k=0;for(let H=p+1;H<d.length;H++)w+=H*d[H],k+=d[H];O=k===0?0:w/k,j=(P-O)/(Math.log(P)-Math.log(O)),j<-Number.EPSILON?B=j-.5|0:B=j+.5|0}while(Math.abs(B-x)>G);return p}function maxEntropy(d,h){let p=new Array(d.length);for(let G=0;G<d.length;G++)p[G]=d[G]/h;let m=new Array(d.length),w=new Array(d.length);m[0]=p[0],w[0]=1-m[0];for(let G=1;G<d.length;G++)m[G]=m[G-1]+p[G],w[G]=1-m[G];let T=0;for(let G=0;G<d.length;G++)if(Math.abs(m[G])>=Number.EPSILON){T=G;break}let k=d.length-1;for(let G=d.length-1;G>=T;G--)if(Math.abs(w[G])>=Number.EPSILON){k=G;break}let x=-1,B,P=Number.MIN_VALUE,O,U;for(let G=T;G<=k;G++){O=0;for(let j=0;j<=G;j++)d[j]!==0&&(O-=p[j]/m[G]*Math.log(p[j]/m[G]));U=0;for(let j=G+1;j<d.length;j++)d[j]!==0&&(U-=p[j]/w[G]*Math.log(p[j]/w[G]));B=O+U,P<B&&(P=B,x=G)}return x}function mean$1(d,h){let p=0;for(let m=0;m<d.length;m++)p+=m*d[m];return Math.floor(p/h)}function minError(d,h){let p,m=-2,w,T,k,x,B,P,O,U,G,j,H,te=0;for(let oe=0;oe<d.length;oe++)te+=oe*d[oe];for(te/=h,p=te;p!==m;){let oe=sumA(d,p),Q=sumA(d,d.length-1),_e=sumB(d,p),se=sumB(d,d.length-1),le=sumC(d,p),me=sumC(d,d.length-1);if(w=_e/oe,T=(se-_e)/(Q-oe),k=oe/Q,x=(Q-oe)/Q,B=le/oe-w*w,P=(me-le)/(Q-oe)-T*T,O=1/B-1/P,U=w/B-T/P,G=w*w/B-T*T/P+Math.log10(B*(x*x)/(P*(k*k))),j=U*U-O*G,j<0)return p;m=p,H=(U+Math.sqrt(j))/O,isNaN(H)?p=m:p=Math.floor(H)}return p}function sumA(d,h){let p=0;for(let m=0;m<=h;m++)p+=d[m];return p}function sumB(d,h){let p=0;for(let m=0;m<=h;m++)p+=m*d[m];return p}function sumC(d,h){let p=0;for(let m=0;m<=h;m++)p+=m*m*d[m];return p}function minimum(d){if(d.length<2)return 0;let h=0,p=-1,m=-1,w=new Array(d.length);for(let T=0;T<d.length;T++)w[T]=d[T],d[T]>0&&(m=T);for(;!bimodalTest(w);)if(w=smoothed(w),h++,h>1e4)return p;return p=minimumBetweenPeeks(w,m),p}function smoothed(d){let h=new Array(d.length);for(let p=1;p<d.length-1;p++)h[p]=(d[p-1]+d[p]+d[p+1])/3;return h[0]=(d[0]+d[1])/3,h[d.length-1]=(d[d.length-2]+d[d.length-1])/3,h}function minimumBetweenPeeks(d,h){let p;for(let m=1;m<h;m++)if(d[m-1]>d[m]&&d[m+1]>=d[m]){p=m;break}return p}function bimodalTest(d){let h=d.length,p=!1,m=0;for(let w=1;w<h-1;w++)if(d[w-1]<d[w]&&d[w+1]<d[w]&&(m++,m>2))return!1;return m===2&&(p=!0),p}function moments(d,h){let p=1,m=0,w=0,T=0,k=0,x,B,P,O,U,G,j=-1,H=d.length,te=new Array(H);for(let oe=0;oe<H;oe++)te[oe]=d[oe]/h;for(let oe=0;oe<H;oe++)m+=oe*te[oe],w+=oe*oe*te[oe],T+=oe*oe*oe*te[oe];B=p*w-m*m,P=(-w*w+m*T)/B,O=(p*-T+w*m)/B,U=.5*(-O-Math.sqrt(O*O-4*P)),G=.5*(-O+Math.sqrt(O*O-4*P)),x=(G-m)/(G-U);for(let oe=0;oe<H;oe++)if(k+=te[oe],k>x){j=oe;break}return j}function otsu(d,h){let p=0,m=0,w=0,T=0,k=0;for(let x=0;x<d.length;x++)k+=x*d[x];for(let x=0;x<d.length;x++){m=m+d[x];const B=h-m;if(m===0||B===0)continue;p=p+x*d[x];const P=(k-p)/B,O=m*B*(p/m-P)*(p/m-P);O>=w&&(T=x,w=O)}return T}function percentile(d){let h=-1,p=.5,m=new Array(d.length),w=partialSum(d,d.length-1),T=1;for(let k=0;k<d.length;k++)m[k]=Math.abs(partialSum(d,k)/w-p),m[k]<T&&(T=m[k],h=k);return h}function partialSum(d,h){let p=0;for(let m=0;m<=h;m++)p+=d[m];return p}function renyiEntropy(d,h){let p,m,w,T=new Array(d.length),k=new Array(d.length),x=new Array(d.length),B=0,P=0,O=0,U=0,G=0,j=0,te=1/(1-.5),Q=1/(1-2);for(let me=0;me<d.length;me++)T[me]=d[me]/h;k[0]=T[0],x[0]=1-k[0];for(let me=1;me<d.length;me++)k[me]=k[me-1]+T[me],x[me]=1-k[me];m=0;for(let me=0;me<d.length;me++)if(Math.abs(k[me])>=Number.EPSILON){m=me;break}w=d.length-1;for(let me=d.length-1;me>=m;me--)if(Math.abs(x[me])>=Number.EPSILON){w=me;break}for(let me=m;me<=w;me++){let Re=0,xe=0,ue=0;for(let ht=0;ht<=me;ht++)d[ht]!==0&&(Re-=T[ht]/k[me]*Math.log(T[ht]/k[me])),xe+=Math.sqrt(T[ht]/k[me]),ue+=T[ht]*T[ht]/(k[me]*k[me]);let Me=0,he=0,ge=0;for(let ht=me+1;ht<d.length;ht++)d[ht]!==0&&(Me-=T[ht]/x[me]*Math.log(T[ht]/x[me])),he+=Math.sqrt(T[ht]/x[me]),ge+=T[ht]*T[ht]/(x[me]*x[me]);let Le=Re+Me,Ze=te*(xe*he>0?Math.log(xe*he):0),st=Q*(ue*ge>0?Math.log(ue*ge):0);Le>U&&(U=Le,B=me),Ze>G&&(G=Ze,P=me),st>j&&(j=st,O=me)}let _e=[B,P,O];_e.sort((me,Re)=>me-Re);let se;Math.abs(_e[0]-_e[1])<=5?Math.abs(_e[1]-_e[2])<=5?se=[1,2,1]:se=[0,1,3]:Math.abs(_e[1]-_e[2])<=5?se=[3,1,0]:se=[1,2,1];let le=k[_e[2]]-k[_e[0]];return p=Math.round(_e[0]*(k[_e[0]]+.25*le*se[0])+.25*_e[1]*le*se[1]+_e[2]*(x[_e[2]]+.25*le*se[2])),p}function shanbhag(d,h){let p=new Array(d.length);for(let j=0;j<d.length;j++)p[j]=d[j]/h;let m=new Array(d.length),w=new Array(d.length);m[0]=p[0],w[0]=1-m[0];for(let j=1;j<d.length;j++)m[j]=m[j-1]+p[j],w[j]=1-m[j];let T=0;for(let j=0;j<d.length;j++)if(Math.abs(m[j])>=Number.EPSILON){T=j;break}let k=d.length-1;for(let j=d.length-1;j>=T;j--)if(Math.abs(w[j])>=Number.EPSILON){k=j;break}let x=-1,B=Number.MAX_VALUE,P,O,U,G;for(let j=T;j<=k;j++){U=0,P=.5/m[j];for(let H=1;H<=j;H++)U-=p[H]*Math.log(1-P*m[H-1]);U*=P,G=0,P=.5/w[j];for(let H=j+1;H<d.length;H++)G-=p[H]*Math.log(1-P*w[H]);G*=P,O=Math.abs(U-G),O<B&&(B=O,x=j)}return x}function triangle$1(d){let h=0,p=0,m=0,w=0;for(let U=0;U<d.length;U++)if(d[U]>0){h=U;break}h>0&&h--;for(let U=d.length-1;U>0;U--)if(d[U]>0){w=U;break}w<d.length-1&&w++;for(let U=0;U<d.length;U++)d[U]>p&&(m=U,p=d[U]);let T=!1;if(m-h<w-m){T=!0;let U=0,G=d.length-1;for(;U<G;){let j=d[U];d[U]=d[G],d[G]=j,U++,G--}h=d.length-1-w,m=d.length-1-m}if(h===m)return h;let k,x,B;k=d[m],x=h-m,B=Math.sqrt(k*k+x*x),k/=B,x/=B,B=k*h+x*d[h];let P=h,O=0;for(let U=h+1;U<=m;U++){let G=k*U+x*d[U]-B;G>O&&(P=U,O=G)}if(P--,T){let U=0,G=d.length-1;for(;U<G;){let j=d[U];d[U]=d[G],d[G]=j,U++,G--}return d.length-1-P}else return P}function yen(d,h){let p=new Array(d.length);for(let P=0;P<d.length;P++)p[P]=d[P]/h;let m=new Array(d.length);m[0]=p[0];for(let P=1;P<d.length;P++)m[P]=m[P-1]+p[P];let w=new Array(d.length);w[0]=p[0]*p[0];for(let P=1;P<d.length;P++)w[P]=w[P-1]+p[P]*p[P];let T=new Array(d.length);T[d.length-1]=0;for(let P=d.length-2;P>=0;P--)T[P]=T[P+1]+p[P+1]*p[P+1];let k=-1,x=Number.MIN_VALUE,B;for(let P=0;P<d.length;P++)B=-1*(w[P]*T[P]>0?Math.log(w[P]*T[P]):0)+2*(m[P]*(1-m[P])>0?Math.log(m[P]*(1-m[P])):0),B>x&&(x=B,k=P);return k}const methods={huang,intermodes,isodata,li,maxentropy:maxEntropy,mean:mean$1,minerror:minError,minimum,moments,otsu,percentile,renyientropy:renyiEntropy,shanbhag,triangle:triangle$1,yen},names={};Object.keys(methods).forEach(d=>{names[d]=d});function getThreshold(d={}){let{algorithm:h=names.otsu}=d;this.checkProcessable("getThreshold",{components:1,bitDepth:[8,16]});let p=methods[h.toLowerCase()];if(p){let m=this.getHistogram();return p(m,this.size)}else throw new Error(`unknown thresholding algorithm: ${h}`)}const THRESHOLD="threshold";function mask(d={}){let{algorithm:h=THRESHOLD,threshold:p=.5,useAlpha:m=!0,invert:w=!1}=d;this.checkProcessable("mask",{components:1,bitDepth:[8,16]}),h===THRESHOLD?p=getThreshold$1(p,this.maxValue):p=getThreshold.call(this,d);let T=new Image$1(this.width,this.height,{kind:"BINARY",parent:this}),k=0;if(this.alpha&&m)for(let x=0;x<this.data.length;x+=this.channels){let B=this.data[x]+(this.maxValue-this.data[x])*(this.maxValue-this.data[x+1])/this.maxValue;(w&&B<=p||!w&&B>=p)&&T.setBit(k),k++}else for(let x=0;x<this.data.length;x+=this.channels)(w&&this.data[x]<=p||!w&&this.data[x]>=p)&&T.setBit(k),k++;return T}function copyImage(d,h,p,m){let w=d.width,T=d.height,k=h.width,x=d.channels;for(let B=0;B<w;B++)for(let P=0;P<T;P++)for(let O=0;O<x;O++){let U=(P*w+B)*x+O,G=((m+P)*k+p+B)*x+O;h.data[G]=d.data[U]}}function pad(d={}){let{size:h=0,algorithm:p="copy",color:m}=d;if(this.checkProcessable("pad",{bitDepth:[8,16]}),p==="set"){if(m.length!==this.channels)throw new Error(`pad: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let B=0;B<m.length;B++)m[B]===0&&(m[B]=.001)}else m=newArray_1(this.channels,null);Array.isArray(h)||(h=[h,h]);let w=this.width+h[0]*2,T=this.height+h[1]*2,k=this.channels,x=Image$1.createFrom(this,{width:w,height:T});copyImage(this,x,h[0],h[1]);for(let B=h[0];B<w-h[0];B++)for(let P=0;P<k;P++){let O=m[P]||x.data[(h[1]*w+B)*k+P];for(let U=0;U<h[1];U++)x.data[(U*w+B)*k+P]=O;O=m[P]||x.data[((T-h[1]-1)*w+B)*k+P];for(let U=T-h[1];U<T;U++)x.data[(U*w+B)*k+P]=O}for(let B=0;B<T;B++)for(let P=0;P<k;P++){let O=m[P]||x.data[(B*w+h[0])*k+P];for(let U=0;U<h[0];U++)x.data[(B*w+U)*k+P]=O;O=m[P]||x.data[(B*w+w-h[0]-1)*k+P];for(let U=w-h[0];U<w;U++)x.data[(B*w+U)*k+P]=O}return x}function colorDepth(d=8){if(this.checkProcessable("colorDepth",{bitDepth:[1,8,16]}),![8,16].includes(d))throw Error("You need to specify the new colorDepth as 8 or 16");if(this.bitDepth===d)return this.clone();let h=Image$1.createFrom(this,{bitDepth:d});switch(d){case 8:if(this.bitDepth===1)for(let p=0;p<this.size;p++)this.getBit(p)&&(h.data[p]=255);else for(let p=0;p<this.data.length;p++)h.data[p]=this.data[p]>>8;break;case 16:if(this.bitDepth===1)for(let p=0;p<this.size;p++)this.getBit(p)&&(h.data[p]=65535);else for(let p=0;p<this.data.length;p++)h.data[p]=this.data[p]<<8|this.data[p];break;default:throw new Error("colorDepth conversion unexpected case")}return h}function rotateFree(d,h={}){const{interpolation:p=validInterpolations.nearestneighbor,width:m=this.width,height:w=this.height}=h;if(typeof d!="number")throw new TypeError("degrees must be a number");const T=checkInterpolation(p),k=d*Math.PI/180,x=Math.floor(Math.abs(m*Math.cos(k))+Math.abs(w*Math.sin(k))),B=Math.floor(Math.abs(w*Math.cos(k))+Math.abs(m*Math.sin(k))),P=Image$1.createFrom(this,{width:x,height:B}),O=Math.cos(-k),U=Math.sin(-k);let G=x/2,j=B/2;x%2===0?(G=G-.5,B%2===0?j=j-.5:j=Math.floor(j)):(G=Math.floor(G),B%2===0?j=j-.5:j=Math.floor(j));const H=Math.floor(m/2-G),te=Math.floor(w/2-j);switch(T){case validInterpolations.nearestneighbor:return rotateNearestNeighbor(this,P,H,te,G,j,O,U);case validInterpolations.bilinear:return rotateBilinear(this,P,H,te,G,j,O,U);default:throw new Error(`unsupported rotate interpolation: ${T}`)}}function rotateNearestNeighbor(d,h,p,m,w,T,k,x){for(let B=0;B<h.width;B+=1)for(let P=0;P<h.height;P+=1)for(let O=0;O<d.channels;O++){let U=Math.round((B-w)*k-(P-T)*x+w)+p,G=Math.round((P-T)*k+(B-w)*x+T)+m;U<0||U>=d.width||G<0||G>=d.height?d.alpha===1&&O===d.channels-1?h.setValueXY(B,P,O,0):h.setValueXY(B,P,O,d.maxValue):h.setValueXY(B,P,O,d.getValueXY(U,G,O))}return h}function rotateBilinear(d,h,p,m,w,T,k,x){let B=d.width*d.channels;for(let P=0;P<h.height;P++)for(let O=0;O<h.width;O++){let U=(O-w)*k-(P-T)*x+w+p,G=(P-T)*k+(O-w)*x+T+m,j=U|0,H=G|0,te=U-j,oe=G-H;for(let Q=0;Q<d.channels;Q++)if(U<0||U>=d.width||G<0||G>=d.height)d.alpha===1&&Q===d.channels-1?h.setValueXY(O,P,Q,0):h.setValueXY(O,P,Q,d.maxValue);else{let _e=(H*d.width+j)*d.channels+Q,se=d.data[_e],le=d.data[_e+d.channels],me=d.data[_e+B],Re=d.data[_e+B+d.channels],xe=se+te*(le-se)+oe*(me-se)+te*oe*(se-le-me+Re)|0;h.setValueXY(O,P,Q,xe)}}return h}function rotate$1(d,h){if(typeof d!="number")throw new TypeError("angle must be a number");switch(d<0&&(d=Math.ceil(-d/360)*360+d),d%360){case 0:return this.clone();case 90:return rotateRight.call(this);case 180:return rotate180.call(this);case 270:return rotateLeft.call(this);default:return rotateFree.call(this,d,h)}}function rotateLeft(){const d=Image$1.createFrom(this,{width:this.height,height:this.width}),h=d.height-1;for(let p=0;p<this.height;p++)for(let m=0;m<this.width;m++)for(let w=0;w<this.channels;w++)d.setValueXY(p,h-m,w,this.getValueXY(m,p,w));return d}function rotateRight(){const d=Image$1.createFrom(this,{width:this.height,height:this.width}),h=d.width-1;for(let p=0;p<this.height;p++)for(let m=0;m<this.width;m++)for(let w=0;w<this.channels;w++)d.setValueXY(h-p,m,w,this.getValueXY(m,p,w));return d}function rotate180(){const d=Image$1.createFrom(this),h=d.width-1,p=d.height-1;for(let m=0;m<this.height;m++)for(let w=0;w<this.width;w++)for(let T=0;T<this.channels;T++)d.setValueXY(h-w,p-m,T,this.getValueXY(w,m,T));return d}function insert(d,h={}){const p=getImageParameters(d);this.checkProcessable("insert",p);let{x:m=0,y:w=0}=h;const T=getOutputImageOrInPlace(this,h,{copy:!0}),k=Math.min(T.height,w+d.height),x=Math.min(T.width,m+d.width);if(T.bitDepth===1)for(let B=w;B<k;B++)for(let P=m;P<x;P++)d.getBitXY(P-m,B-w)?T.setBitXY(P,B):T.clearBitXY(P,B);else for(let B=w;B<k;B++)for(let P=m;P<x;P++)T.setPixelXY(P,B,d.getPixelXY(P-m,B-w));return T}function setBorder(d={}){let{size:h=0,algorithm:p="copy",color:m}=d;if(this.checkProcessable("setBorder",{bitDepth:[8,16,32,64]}),p==="set"){if(m.length!==this.channels)throw new Error(`setBorder: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let x=0;x<m.length;x++)m[x]===0&&(m[x]=.001)}else m=newArray_1(this.channels,null);Array.isArray(h)||(h=[h,h]);let w=h[0],T=h[1],k=this.channels;for(let x=w;x<this.width-w;x++)for(let B=0;B<k;B++){let P=m[B]||this.data[(x+this.width*T)*k+B];for(let O=0;O<T;O++)this.data[(O*this.width+x)*k+B]=P;P=m[B]||this.data[(x+this.width*(this.height-T-1))*k+B];for(let O=this.height-T;O<this.height;O++)this.data[(O*this.width+x)*k+B]=P}for(let x=0;x<this.height;x++)for(let B=0;B<k;B++){let P=m[B]||this.data[(x*this.width+w)*k+B];for(let O=0;O<w;O++)this.data[(x*this.width+O)*k+B]=P;P=m[B]||this.data[(x*this.width+this.width-w-1)*k+B];for(let O=this.width-w;O<this.width;O++)this.data[(x*this.width+O)*k+B]=P}return this}function split(d={}){let{preserveAlpha:h=!0}=d;if(this.checkProcessable("split",{bitDepth:[8,16]}),this.components===1)return new Stack([this.clone()]);let p=new Stack,m=this.data;if(this.alpha&&h)for(let w=0;w<this.components;w++){let T=Image$1.createFrom(this,{components:1,alpha:!0,colorModel:GREY$1}),k=0;for(let x=0;x<m.length;x+=this.channels)T.data[k++]=m[x+w],T.data[k++]=m[x+this.components];p.push(T)}else for(let w=0;w<this.channels;w++){let T=Image$1.createFrom(this,{components:1,alpha:!1,colorModel:GREY$1}),k=0;for(let x=0;x<m.length;x+=this.channels)T.data[k++]=m[x+w];p.push(T)}return p}function getChannel(d,h={}){let{keepAlpha:p=!1,mergeAlpha:m=!1}=h;p&=this.alpha,m&=this.alpha,this.checkProcessable("getChannel",{bitDepth:[8,16]}),d=validateChannel(this,d);let w=Image$1.createFrom(this,{components:1,alpha:p,colorModel:GREY$1}),T=0;for(let k=0;k<this.data.length;k+=this.channels)m?w.data[T++]=this.data[k+d]*this.data[k+this.components]/this.maxValue:(w.data[T++]=this.data[k+d],p&&(w.data[T++]=this.data[k+this.components]));return w}function combineChannels(d=defaultCombineMethod,h={}){let{mergeAlpha:p=!1,keepAlpha:m=!1}=h;p&=this.alpha,m&=this.alpha,this.checkProcessable("combineChannels",{bitDepth:[8,16]});let w=Image$1.createFrom(this,{components:1,alpha:m,colorModel:GREY$1}),T=0;for(let k=0;k<this.size;k++){let x=d(this.getPixel(k));p?w.data[T++]=x*this.data[k*this.channels+this.components]/this.maxValue:(w.data[T++]=x,m&&(w.data[T++]=this.data[k*this.channels+this.components]))}return w}function defaultCombineMethod(d){return(d[0]+d[1]+d[2])/3}function setChannel(d,h){if(this.checkProcessable("setChannel",{bitDepth:[8,16]}),h.checkProcessable("setChannel (image parameter check)",{bitDepth:[this.bitDepth],alpha:[0],components:[1]}),h.width!==this.width||h.height!==this.height)throw new Error("Images must have exactly the same width and height");d=validateChannel(this,d);let p=d;for(let m=0;m<h.data.length;m++)this.data[p]=h.data[m],p+=this.channels;return this}function getSimilarity(d,h={}){let{shift:p=[0,0],average:m,channels:w,defaultAlpha:T,normalize:k,border:x=[0,0]}=h;if(this.checkProcessable("getSimilarity",{bitDepth:[8,16]}),Array.isArray(x)||(x=[x,x]),w=validateArrayOfChannels(this,{channels:w,defaultAlpha:T}),this.bitDepth!==d.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==d.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==d.colorModel)throw new Error("Both images must have the same colorModel");typeof m=="undefined"&&(m=!0);let B=Math.max(x[0],-p[0]),P=Math.min(this.width-x[0],this.width-p[0]),O=Math.max(x[1],-p[1]),U=Math.min(this.height-x[1],this.height-p[1]),G=newArray_1(w.length,0);for(let j=0;j<w.length;j++){let H=w[j],te=k?this.sum[H]:Math.max(this.sum[H],d.sum[H]),oe=k?d.sum[H]:Math.max(this.sum[H],d.sum[H]);if(te!==0&&oe!==0)for(let Q=B;Q<P;Q++)for(let _e=O;_e<U;_e++){let se=Q*this.multiplierX+_e*this.multiplierY+H,le=se+p[0]*this.multiplierX+p[1]*this.multiplierY;G[j]+=Math.min(this.data[se]/te,d.data[le]/oe)}}return m?G.reduce((j,H)=>j+H)/G.length:G}function getPixelsGrid(d={}){let{sampling:h=[10,10],painted:p=!1,mask:m}=d;this.checkProcessable("getPixelsGrid",{bitDepth:[8,16],channels:1}),Array.isArray(h)||(h=[h,h]);const w=h[0],T=h[1],k=[],x=[],B=this.width/w,P=this.height/T;let O=Math.floor(B/2);for(let G=0;G<w;G++){let j=Math.floor(P/2);for(let H=0;H<T;H++){let te=Math.round(O),oe=Math.round(j);(!m||m.getBitXY(te,oe))&&(k.push([te,oe]),x.push(this.getPixelXY(te,oe))),j+=P}O+=B}const U={xyS:k,zS:x};return p&&(U.painted=this.rgba8().paintPoints(k)),U}function Matrix(d,h,p){const m=new Array(d);for(let w=0;w<d;w++)m[w]=new Array(h);if(p)for(let w=0;w<d;w++)for(let T=0;T<h;T++)m[w][T]=p;return m.width=d,m.height=h,Object.setPrototypeOf(m,Matrix.prototype),m}Matrix.prototype.localMin=function(d,h){let p=this[d][h],m=[d,h];for(let w=Math.max(0,d-1);w<Math.min(this.length,d+2);w++)for(let T=Math.max(0,h-1);T<Math.min(this[0].length,h+2);T++)this[w][T]<p&&(p=this[w][T],m=[w,T]);return{position:m,value:p}};Matrix.prototype.localMax=function(d,h){let p=this[d][h],m=[d,h];for(let w=Math.max(0,d-1);w<Math.min(this.length,d+2);w++)for(let T=Math.max(0,h-1);T<Math.min(this[0].length,h+2);T++)this[w][T]>p&&(p=this[w][T],m=[w,T]);return{position:m,value:p}};Matrix.prototype.localSearch=function(d,h,p){let m=[];for(let w=Math.max(0,d-1);w<Math.min(this.length,d+2);w++)for(let T=Math.max(0,h-1);T<Math.min(this[0].length,h+2);T++)this[w][T]===p&&m.push([w,T]);return m};function getBestMatch(d,h={}){let{border:p}=h;if(this.checkProcessable("getChannel",{bitDepth:[8,16]}),this.bitDepth!==d.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==d.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==d.colorModel)throw new Error("Both images must have the same colorModel");let m=new Matrix(d.width,d.height,-1/0),w=Math.floor(d.width/2),T=Math.floor(d.height/2),k=w,x=T,B=!1;for(;!B;){let P=m.localSearch(w,T,-1/0);for(let U=0;U<P.length;U++){let G=P[U],j=this.getSimilarity(d,{border:p,shift:[k-G[0],x-G[1]]});m[G[0]][G[1]]=j}let O=m.localMax(w,T);O.position[0]!==w||O.position[1]!==T?(w=O.position[0],T=O.position[1]):B=!0}return[w-k,T-x]}function getRow(d,h=0){this.checkProcessable("getRow",{bitDepth:[8,16]}),checkRow(this,d),checkChannel(this,h);let p=new Array(this.width),m=0,w=d*this.width*this.channels+h,T=w+this.width*this.channels;for(let k=w;k<T;k+=this.channels)p[m++]=this.data[k];return p}function getColumn(d,h=0){this.checkProcessable("getColumn",{bitDepth:[8,16]}),checkColumn(this,d),checkChannel(this,h);let p=new Array(this.height),m=0,w=this.width*this.channels;for(let T=h+d*this.channels;T<this.data.length;T+=w)p[m++]=this.data[T];return p}function getMatrix(d={}){let{channel:h}=d;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),h===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");h=0}let p=new Matrix$2(this.height,this.width);for(let m=0;m<this.height;m++)for(let w=0;w<this.width;w++)p.set(m,w,this.getValueXY(w,m,h));return p}function setMatrix(d,h={}){d=new Matrix$2(d);let{channel:p}=h;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),p===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");p=0}if(this.width!==d.columns||this.height!==d.rows)throw new RangeError("The size of the matrix must be equal to the size of the image");for(let m=0;m<this.height;m++)for(let w=0;w<this.width;w++)this.setValueXY(w,m,p,d.get(m,w))}function getPixelsArray(){this.checkProcessable("getPixelsArray",{bitDepth:[8,16,32]});let d=new Array(this.size),h=0;for(let p=0;p<this.data.length;p+=this.channels){let m=new Array(this.components);for(let w=0;w<this.components;w++)m[w]=this.data[p+w];d[h++]=m}return d}function getIntersection(d){let h=this,p=h.getClosestCommonParent(d),m=h.getRelativePosition(p,{defaultFurther:!0}),w=getRelativePositionForAllPixels(h,m),T=d.getRelativePosition(p,{defaultFurther:!0}),k=getRelativePositionForAllPixels(d,T),x=getCommonSurface(w,k),B={whitePixelsMask1:[],whitePixelsMask2:[],commonWhitePixels:[]};for(let P=0;P<x.length;P++){let O=x[P],U=[O[0]-m[0],O[1]-m[1]],G=[O[0]-T[0],O[1]-T[1]],j=h.getBitXY(U[0],U[1]),H=d.getBitXY(G[0],G[1]);j===1&&H===1&&B.commonWhitePixels.push(O)}for(let P=0;P<w.length;P++){let O,U;P!==0&&(O=Math.floor(P/h.width),U=P%h.width),h.getBitXY(O,U)===1&&B.whitePixelsMask1.push(w[P])}for(let P=0;P<k.length;P++){let O=0,U=0;P!==0&&(O=Math.floor(P/d.width),U=P%d.width),d.getBitXY(O,U)===1&&B.whitePixelsMask2.push(k[P])}return B}function getRelativePositionForAllPixels(d,h){let p=[];for(let m=0;m<d.height;m++)for(let w=0;w<d.width;w++){let T=[m,w];p.push([T[0]+h[0],T[1]+h[1]])}return p}function getCommonSurface(d,h){let p=0,m=0,w=[];for(;p<d.length&&m<h.length;)d[p][0]===h[m][0]&&d[p][1]===h[m][1]?(w.push(d[p]),p++,m++):d[p][0]<h[m][0]||d[p][0]===h[m][0]&&d[p][1]<h[m][1]?p++:m++;return w}function getClosestCommonParent(d){let h=getDepth(this),p=getDepth(d),m;if(h>=p?m=getFurthestParent(this,h):m=getFurthestParent(d,p),h===0||p===0)return m;let w=this,T=d;for(;h!==p;)if(h>p){if(w=w.parent,w===null)return m;h=h-1}else{if(T=T.parent,T===null)return m;p=p-1}for(;w!==T&&w!==null&&T!==null;)if(w=w.parent,T=T.parent,w===null||T===null)return m;return w!==T?m:w}function getDepth(d){let h=0,p=d;for(;p.parent!=null;)p=p.parent,h++;return h}function getFurthestParent(d,h){let p=d;for(;h>0;)p=p.parent,h=h-1;return p}const defaultOptions$1={lowThreshold:10,highThreshold:30,gaussianBlur:1.1},Gx=[[-1,0,1],[-2,0,2],[-1,0,1]],Gy=[[-1,-2,-1],[0,0,0],[1,2,1]],convOptions={bitDepth:32,mode:"periodic"};function cannyEdgeDetector(d,h){d.checkProcessable("Canny edge detector",{bitDepth:8,channels:1,components:1}),h=Object.assign({},defaultOptions$1,h);const p=d.width,m=d.height,w=d.maxValue,T={sigma:h.gaussianBlur,radius:3},k=d.gaussianFilter(T),x=k.convolution(Gy,convOptions),B=k.convolution(Gx,convOptions),P=B.hypotenuse(x),O=d.constructor,U=new O(p,m,{kind:"GREY",bitDepth:32}),G=new O(p,m,{kind:"GREY",bitDepth:32}),j=new O(p,m,{kind:"GREY"});for(var H=1;H<p-1;H++)for(var te=1;te<m-1;te++){var oe=(Math.round(Math.atan2(B.getValueXY(H,te,0),x.getValueXY(H,te,0))*(5/Math.PI))+5)%5;oe===0&&(P.getValueXY(H,te,0)<=P.getValueXY(H,te-1,0)||P.getValueXY(H,te,0)<=P.getValueXY(H,te+1,0))||oe===1&&(P.getValueXY(H,te,0)<=P.getValueXY(H-1,te+1,0)||P.getValueXY(H,te,0)<=P.getValueXY(H+1,te-1,0))||oe===2&&(P.getValueXY(H,te,0)<=P.getValueXY(H-1,te,0)||P.getValueXY(H,te,0)<=P.getValueXY(H+1,te,0))||oe===3&&(P.getValueXY(H,te,0)<=P.getValueXY(H-1,te-1,0)||P.getValueXY(H,te,0)<=P.getValueXY(H+1,te+1,0))||U.setValueXY(H,te,0,P.getValueXY(H,te,0))}for(H=0;H<p*m;++H){var Q=U.data[H],_e=0;Q>h.highThreshold&&(_e++,j.data[H]=w),Q>h.lowThreshold&&_e++,G.data[H]=_e}var se=[];for(H=1;H<p-1;++H)for(te=1;te<m-1;++te){if(G.getValueXY(H,te,0)!==1)continue;e:for(var le=H-1;le<H+2;++le)for(var me=te-1;me<te+2;++me)if(G.getValueXY(le,me,0)===2){se.push([H,te]),j.setValueXY(H,te,0,w);break e}}for(;se.length>0;){var Re=[];for(H=0;H<se.length;++H)for(te=-1;te<2;++te)for(le=-1;le<2;++le)if(!(te===0&&le===0)){var xe=se[H][0]+te,ue=se[H][1]+le;G.getValueXY(xe,ue,0)===1&&j.getValueXY(xe,ue,0)===0&&(Re.push([xe,ue]),j.setValueXY(xe,ue,0,w))}se=Re}return j}function cannyEdge(d){return cannyEdgeDetector(this,d)}function extract(d,h={}){let{position:p}=h;if(this.checkProcessable("extract",{bitDepth:[1,8,16]}),!p&&(p=d.getRelativePosition(this),!p))throw new Error("extract : can not extract an image because the relative position can not be determined, try to specify manually the position as an array of 2 elements [x,y].");if(this.bitDepth>1){let m=Image$1.createFrom(this,{width:d.width,height:d.height,alpha:1,position:p,parent:this});for(let w=0;w<d.width;w++)for(let T=0;T<d.height;T++){for(let k=0;k<this.channels;k++){let x=this.getValueXY(w+p[0],T+p[1],k);m.setValueXY(w,T,k,x)}d.getBitXY(w,T)||m.setValueXY(w,T,this.components,0)}return m}else{let m=Image$1.createFrom(this,{width:d.width,height:d.height,position:p,parent:this});for(let w=0;w<d.height;w++)for(let T=0;T<d.width;T++)d.getBitXY(T,w)&&this.getBitXY(T+p[0],w+p[1])&&m.setBitXY(T,w);return m}}var fastList={exports:{}};(function(d,h){(function(){function p(w,T,k){this.next=k,k&&(k.prev=this),this.prev=T,T&&(T.next=this),this.data=w}function m(){if(!(this instanceof m))return new m;this._head=null,this._tail=null,this.length=0}m.prototype={push:function(w){this._tail=new p(w,this._tail,null),this._head||(this._head=this._tail),this.length++},pop:function(){if(this.length!==0){var w=this._tail;return this._tail=w.prev,w.prev&&(w.prev=this._tail.next=null),this.length--,this.length===1?this._head=this._tail:this.length===0&&(this._head=this._tail=null),w.data}},unshift:function(w){this._head=new p(w,null,this._head),this._tail||(this._tail=this._head),this.length++},shift:function(){if(this.length!==0){var w=this._head;return this._head=w.next,w.next&&(w.next=this._head.prev=null),this.length--,this.length===1?this._tail=this._head:this.length===0&&(this._head=this._tail=null),w.data}},item:function(w){w<0&&(w=this.length+w);for(var T=this._head;w-- >0&&T;)T=T.next;return T?T.data:void 0},slice:function(w,T){if(w||(w=0),T||(T=this.length),T<0&&(T=this.length+T),w<0&&(w=this.length+w),T===w)return[];if(T<w)throw new Error("invalid offset: "+w+","+T+" (length="+this.length+")");for(var k=T-w,x=new Array(k),B=0,P=this._head;w-- >0&&P;)P=P.next;for(;B<k&&P;)x[B++]=P.data,P=P.next;return x},drop:function(){m.call(this)},forEach:function(w,T){for(var k=this._head,x=0,B=this.length;x<B&&k;)w.call(T||this,k.data,x,this),k=k.next,x++},map:function(w,T){var k=new m;return this.forEach(function(x,B,P){k.push(w.call(T||P,x,B,P))}),k},filter:function(w,T){var k=new m;return this.forEach(function(x,B,P){w.call(T||P,x,B,P)&&k.push(x)}),k},reduce:function(w,T,k){var x=0,B=this._head,P=this.length;for(T||(x=1,T=B&&B.data,B=B&&B.next);x<P&&B;)T=w.call(k||this,T,B.data,this),x++,B=B.next;return T}},d.exports=m})()})(fastList);var LinkedList=fastList.exports;function floodFill(d={}){const{x:h=0,y:p=0,inPlace:m=!0}=d,w=m?this:Image$1.createFrom(this);if(this.checkProcessable("floodFill",{bitDepth:1}),this.getBitXY(h,p))return w;const k=new LinkedList;for(k.push(new Node(h,p));k.length>0;){const x=k.shift();w.setBitXY(x.x,x.y);for(let B=x.x+1;B<this.width&&(!w.getBitXY(B,x.y)&&!this.getBitXY(B,x.y));B++)w.setBitXY(B,x.y),x.y+1<this.height&&!this.getBitXY(B,x.y+1)&&k.push(new Node(B,x.y+1)),x.y-1>=0&&!this.getBitXY(B,x.y-1)&&k.push(new Node(B,x.y-1));for(let B=x.x-1;B>=0&&(!w.getBitXY(B,x.y)&&!this.getBitXY(B,x.y));B++)w.setBitXY(B,x.y),x.y+1<this.height&&!this.getBitXY(B,x.y+1)&&k.push(new Node(B,x.y+1)),x.y-1>=0&&!this.getBitXY(B,x.y-1)&&k.push(new Node(B,x.y-1))}return w}function Node(d,h){this.x=d,this.y=h}function _extends(){return _extends=Object.assign||function(d){for(var h=1;h<arguments.length;h++){var p=arguments[h];for(var m in p)Object.prototype.hasOwnProperty.call(p,m)&&(d[m]=p[m])}return d},_extends.apply(this,arguments)}function hsv2rgb(d,h,p){h=h/100,p=p/100;var m=[],w=p*h,T=d/60,k=w*(1-Math.abs(T%2-1)),x=p-w;return T>=0&&T<1?m=[w,k,0]:T>=1&&T<2?m=[k,w,0]:T>=2&&T<3?m=[0,w,k]:d>=3&&T<4?m=[0,k,w]:d>=4&&T<5?m=[k,0,w]:d>=5&&T<=6?m=[w,0,k]:m=[0,0,0],{r:Math.round(255*(m[0]+x)),g:Math.round(255*(m[1]+x)),b:Math.round(255*(m[2]+x))}}function hsl2hsv(d,h,p){return h*=(p<50?p:100-p)/100,{h:d,s:2*h/(p+h)*100,v:p+h}}function hsl2rgb$1(d,h,p){var m=hsl2hsv(d,h,p);return hsv2rgb(m.h,m.s,m.v)}var colors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]};function parse(d){return named(d)||hex3(d)||hex6(d)||rgb(d)||rgba$1(d)||hsl(d)||hsla(d)}function named(d){var h=colors[d.toLowerCase()];if(!!h)return{r:h[0],g:h[1],b:h[2],a:100}}function rgb(d){var h=d.match(/rgb\(([^)]+)\)/);if(h){var p=h[1].split(/ *, */).map(Number);return{r:p[0],g:p[1],b:p[2],a:100}}}function rgba$1(d){var h=d.match(/rgba\(([^)]+)\)/);if(h){var p=h[1].split(/ *, */).map(Number);return{r:p[0],g:p[1],b:p[2],a:p[3]*100}}}function hex6(d){if(d[0]==="#"&&d.length===7)return{r:parseInt(d.slice(1,3),16),g:parseInt(d.slice(3,5),16),b:parseInt(d.slice(5,7),16),a:100}}function hex3(d){if(d[0]==="#"&&d.length===4)return{r:parseInt(d[1]+d[1],16),g:parseInt(d[2]+d[2],16),b:parseInt(d[3]+d[3],16),a:100}}function hsl(d){var h=d.match(/hsl\(([^)]+)\)/);if(h){var p=h[1].split(/ *, */),m=parseInt(p[0],10),w=parseInt(p[1],10),T=parseInt(p[2],10),k=hsl2rgb$1(m,w,T);return _extends({},k,{a:100})}}function hsla(d){var h=d.match(/hsla\(([^)]+)\)/);if(h){var p=h[1].split(/ *, */),m=parseInt(p[0],10),w=parseInt(p[1],10),T=parseInt(p[2],10),k=parseInt(parseFloat(p[3])*100,10),x=hsl2rgb$1(m,w,T);return _extends({},x,{a:k})}}function css2array(d){let h=parse(d);return[h.r,h.g,h.b,Math.round(h.a*255/100)]}function hue2rgb(d,h,p){return p<0&&(p+=1),p>1&&(p-=1),p<1/6?d+(h-d)*6*p:p<1/2?h:p<2/3?d+(h-d)*(2/3-p)*6:d}function hsl2rgb(d,h,p){let m,w,T,k,x,B;return h/=100,p/=100,h===0?k=x=B=p*255:(p<=.5?w=p*(h+1):w=p+h-p*h,m=p*2-w,T=d/360,k=hue2rgb(m,w,T+1/3),x=hue2rgb(m,w,T),B=hue2rgb(m,w,T-1/3)),{r:k,g:x,b:B}}function getDistinctColors(d){let h=new Array(d),p=0;for(let m=0;m<360;m+=360/d){p++;let w=hsl2rgb(m,100,30+p%4*15);h[p-1]=[Math.round(w.r*255),Math.round(w.g*255),Math.round(w.b*255)]}return h}function getRandomColor(){return[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)]}function getColors(d){let{color:h,colors:p,randomColors:m,numberColors:w=50}=d;if(h&&!Array.isArray(h)&&(h=css2array(h)),h)return[h];if(p)return p=p.map(function(T){return Array.isArray(T)?T:css2array(T)}),p;if(m){p=new Array(w);for(let T=0;T<w;T++)p[T]=getRandomColor()}return getDistinctColors(w)}function paintLabels(d,h,p={}){let{color:m="blue",colors:w,font:T="12px Helvetica",rotate:k=0}=p;if(this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1}),!Array.isArray(d))throw Error("paintLabels: labels must be an array");if(!Array.isArray(h))throw Error("paintLabels: positions must be an array");if(m&&!Array.isArray(m)&&(m=css2array(m)),w?w=w.map(function(P){return Array.isArray(P)?P:css2array(P)}):w=[m],d.length!==h.length)throw Error("paintLabels: positions and labels must be arrays from the same size");Array.isArray(T)||(T=[T]),Array.isArray(k)||(k=[k]);let B=this.getCanvas().getContext("2d");for(let P=0;P<d.length;P++){B.save();let O=w[P%w.length];B.fillStyle=`rgba(${O[0]},${O[1]},${O[2]},${O[3]/this.maxValue})`,B.font=T[P%T.length];let U=h[P];B.translate(U[0],U[1]),B.rotate(k[P%k.length]/180*Math.PI),B.fillText(d[P],0,0),B.restore()}return this.data=Uint8Array.from(B.getImageData(0,0,this.width,this.height).data),this}function paintMasks(d,h={}){let{alpha:p=255,labels:m=[],labelsPosition:w=[],labelColor:T="blue",labelFont:k="12px Helvetica"}=h;this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1});let x=getColors(Object.assign({},h,{numberColors:d.length}));Array.isArray(d)||(d=[d]);for(let B=0;B<d.length;B++){let P=d[B],O=x[B%x.length];for(let U=0;U<P.width;U++)for(let G=0;G<P.height;G++)if(P.getBitXY(U,G))for(let j=0;j<Math.min(this.components,O.length);j++)if(p===255)this.setValueXY(U+P.position[0],G+P.position[1],j,O[j]);else{let H=this.getValueXY(U+P.position[0],G+P.position[1],j);H=Math.round((H*(255-p)+O[j]*p)/255),this.setValueXY(U+P.position[0],G+P.position[1],j,H)}}if(Array.isArray(m)&&m.length>0){let P=this.getCanvas().getContext("2d");P.fillStyle=T,P.font=k;for(let O=0;O<Math.min(d.length,m.length);O++){let U=w[O]?w[O]:d[O].position;P.fillText(m[O],U[0],U[1])}this.data=Uint8Array.from(P.getImageData(0,0,this.width,this.height).data)}return this}function zerosMatrix(d,h){let p=new Array(d);for(let m=0;m<d;m++)p[m]=new Array(h).fill(0);return p}const cross=[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],smallCross=[[0,1,0],[1,1,1],[0,1,0]];class Shape{constructor(h={}){let{kind:p="cross",shape:m,size:w,width:T,height:k,filled:x=!0}=h;if(w&&(T=w,k=w),m)switch(m.toLowerCase()){case"square":case"rectangle":this.matrix=rectangle(T,k,{filled:x});break;case"circle":case"ellipse":this.matrix=ellipse(T,k,{filled:x});break;case"triangle":this.matrix=triangle(T,k,{filled:x});break;default:throw new Error(`Shape: unexpected shape: ${m}`)}else if(p)switch(p.toLowerCase()){case"cross":this.matrix=cross;break;case"smallcross":this.matrix=smallCross;break;default:throw new Error(`Shape: unexpected kind: ${p}`)}else throw new Error("Shape: expected a kind or a shape option");this.height=this.matrix.length,this.width=this.matrix[0].length,this.halfHeight=this.height/2>>0,this.halfWidth=this.width/2>>0}getPoints(){let h=this.matrix,p=[];for(let m=0;m<h.length;m++)for(let w=0;w<h[0].length;w++)h[m][w]&&p.push([w-this.halfWidth,m-this.halfHeight]);return p}getMask(){let h=new Image$1(this.width,this.height,{kind:BINARY});for(let p=0;p<this.matrix.length;p++)for(let m=0;m<this.matrix[0].length;m++)this.matrix[p][m]&&h.setBitXY(m,p);return h}}function rectangle(d,h,p){const m=zerosMatrix(h,d);if(p.filled)for(let w=0;w<h;w++)for(let T=0;T<d;T++)m[w][T]=1;else{for(let w of[0,h-1])for(let T=0;T<d;T++)m[w][T]=1;for(let w=0;w<h;w++)for(let T of[0,d-1])m[w][T]=1}return m}function ellipse(d,h,p){const m=zerosMatrix(h,d);let w=1-h%2,T=1-d%2,k=Math.floor((d-1)/2),x=Math.floor((h-1)/2),B=k*k,P=x*x;if(p.filled)for(let O=0;O<=x;O++){let U=Math.floor(Math.sqrt(B-B*O*O/P));for(let G=k-U;G<=k;G++)m[x-O][G]=1,m[x+O+w][G]=1,m[x-O][d-G-1]=1,m[x+O+w][d-G-1]=1}else{for(let O=0;O<=x;O++){let U=Math.floor(Math.sqrt(B-B*O*O/P)),G=k-U;m[x-O][G]=1,m[x+O+w][G]=1,m[x-O][d-G-1]=1,m[x+O+w][d-G-1]=1}for(let O=0;O<=k;O++){let U=Math.floor(Math.sqrt(P-P*O*O/B)),G=x-U;m[G][k-O]=1,m[G][k+O+T]=1,m[h-G-1][k-O]=1,m[h-G-1][k+O+T]=1}}return m}function triangle(d,h,p){if(!p.filled)throw new Error("Non filled triangle is not implemented");const m=zerosMatrix(h,d);for(let w=0;w<h;w++){let T=Math.floor((1-w/h)*d/2);for(let k=T;k<d-T;k++)m[w][k]=1}return m}function paintPoints(d,h={}){let{shape:p}=h;this.checkProcessable("paintPoints",{bitDepth:[8,16]});let m=getColors(Object.assign({},h,{numberColors:d.length})),w=new Shape(p).getPoints(),T=Math.min(this.channels,m[0].length);for(let k=0;k<d.length;k++){let x=m[k%m.length],B=d[k][0],P=d[k][1];for(let O=0;O<w.length;O++){let U=w[O][0],G=w[O][1];if(B+U>=0&&P+G>=0&&B+U<this.width&&P+G<this.height){let j=(B+U+(P+G)*this.width)*this.channels;for(let H=0;H<T;H++)this.data[j+H]=x[H]}}}return this}function paintPolyline(d,h={}){let{color:p=[this.maxValue,0,0],closed:m=!1}=h;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]});let w=Math.min(this.channels,p.length);for(let T=0;T<d.length-1+m;T++){let k=d[T],x=d[(T+1)%d.length],B=x[0]-k[0],P=x[1]-k[1],O=Math.max(Math.abs(B),Math.abs(P)),U=B/O,G=P/O,j=k[0],H=k[1];for(let te=0;te<=O;te++){let oe=Math.round(j),Q=Math.round(H);if(oe>=0&&Q>=0&&oe<this.width&&Q<this.height)if(this.bitDepth===1)this.setBitXY(oe,Q);else{let _e=(oe+Q*this.width)*this.channels;for(let se=0;se<w;se++)this.data[_e+se]=p[se]}j=j+U,H=H+G}}return this}function paintPolylines(d,h={}){let p=Object.assign({},h);this.checkProcessable("paintPolylines",{bitDepth:[8,16]});let m=getColors(Object.assign({},h,{numberColors:d.length}));for(let w=0;w<d.length;w++)p.color=m[w%m.length],this.paintPolyline(d[w],p);return this}function paintPolygon(d,h={}){let{color:p=[this.maxValue,0,0],filled:m=!1}=h;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]}),h.closed=!0;let w=deleteDouble(d);if(m===!1)return this.paintPolyline(d,h);{let T=Array(this.height);for(let k=0;k<this.height;k++){T[k]=[];for(let x=0;x<this.width;x++)T[k].push(0)}for(let k=0;k<w.length;k++){const x=lineBetweenTwoPoints(w[k],w[(k+1)%w.length]);for(let B=0;B<this.height;B++)for(let P=0;P<this.width;P++)isAtTheRightOfTheLine(P,B,x,this.height)&&(T[B][P]=T[B][P]===0?1:0)}for(let k=0;k<this.height;k++)for(let x=0;x<this.width;x++)if(T[k][x]===1)if(this.bitDepth===1)this.setBitXY(x,k);else{let B=Math.min(this.channels,p.length),P=(x+k*this.width)*this.channels;for(let O=0;O<B;O++)this.data[P+O]=p[O]}return this.paintPolyline(d,h)}}function deleteDouble(d){let h=[];for(let p=0;p<d.length;p++)if(!(d[p][0]===d[(p+1)%d.length][0]&&d[p][1]===d[(p+1)%d.length][1])){if(d[p][0]===d[(p-1+d.length)%d.length][0]&&d[p][1]===d[(p-1+d.length)%d.length][1])continue;if(d[(p+1)%d.length][0]===d[(p-1+d.length)%d.length][0]&&d[(p-1+d.length)%d.length][1]===d[(p+1)%d.length][1])continue;h.push(d[p])}return h}function lineBetweenTwoPoints(d,h){if(d[0]===h[0])return{a:0,b:d[0],vertical:!0};{const p=(h[1]-d[1])/(h[0]-d[0]),m=d[1]-p*d[0];return{a:p,b:m,vertical:!1}}}function isAtTheRightOfTheLine(d,h,p,m){if(p.vertical===!0)return p.b<=d;if(p.a===0)return!1;{const w=(h-p.b)/p.a;return w<d&&w>=0&&w<=m}}function paintPolygons(d,h={}){let p=Object.assign({},h);this.checkProcessable("paintPolygons",{bitDepth:[8,16]});let m=getColors(Object.assign({},h,{numberColors:d.length}));for(let w=0;w<d.length;w++)p.color=m[w%m.length],this.paintPolygon(d[w],p);return this}function getHistogram(d={}){let{maxSlots:h=256,channel:p,useAlpha:m=!0}=d;if(this.checkProcessable("getHistogram",{bitDepth:[1,8,16]}),p===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");p=0}return getChannelHistogram.call(this,p,{useAlpha:m,maxSlots:h})}function getHistograms(d={}){const{maxSlots:h=256,useAlpha:p=!0}=d;this.checkProcessable("getHistograms",{bitDepth:[8,16]});let m=new Array(p?this.components:this.channels);for(let w=0;w<m.length;w++)m[w]=getChannelHistogram.call(this,w,{useAlpha:p,maxSlots:h});return m}function getChannelHistogram(d,h){let{useAlpha:p,maxSlots:m}=h;if(this.bitDepth===1){let B=[0,0];for(let P=0;P<this.height;P++)for(let O=0;O<this.width;O++){let U=this.getBitXY(P,O);U===0?B[0]+=1:U===1&&(B[1]+=1)}return B}let w=Math.log2(m);if(!isInteger(w))throw new RangeError("maxSlots must be a power of 2, for example: 64, 256, 1024");let T=0;this.bitDepth>w&&(T=this.bitDepth-w);let k=this.data,x=newArray_1(Math.pow(2,Math.min(this.bitDepth,w)),0);if(p&&this.alpha){let B=this.channels-d-1;for(let P=d;P<k.length;P+=this.channels)x[k[P]>>T]+=k[P+B]/this.maxValue}else for(let B=d;B<k.length;B+=this.channels)x[k[B]>>T]++;return x}function getColorHistogram(d={}){let{useAlpha:h=!0,nbSlots:p=512}=d;this.checkProcessable("getColorHistogram",{bitDepth:[8,16],components:[3]});let m=Math.log(p)/Math.log(8);if(m!==Math.floor(m))throw new RangeError("nbSlots must be a power of 8. Usually 8, 64, 512 or 4096");let w=this.bitDepth-m,T=this.data,k=newArray_1(Math.pow(8,m),0),x=Math.pow(2,m*2),B=Math.pow(2,m);for(let P=0;P<T.length;P+=this.channels){let O=(T[P]>>w)*x+(T[P+1]>>w)*B+(T[P+2]>>w);h&&this.alpha?k[O]+=T[P+this.channels-1]/this.maxValue:k[O]++}return k}function min(){this.checkProcessable("min",{bitDepth:[8,16,32]});let d=newArray_1(this.channels,1/0);for(let h=0;h<this.data.length;h+=this.channels)for(let p=0;p<this.channels;p++)this.data[h+p]<d[p]&&(d[p]=this.data[h+p]);return d}function max(){this.checkProcessable("max",{bitDepth:[8,16,32]});let d=newArray_1(this.channels,-1/0);for(let h=0;h<this.data.length;h+=this.channels)for(let p=0;p<this.channels;p++)this.data[h+p]>d[p]&&(d[p]=this.data[h+p]);return d}function sum(){this.checkProcessable("sum",{bitDepth:[8,16]});let d=newArray_1(this.channels,0);for(let h=0;h<this.data.length;h+=this.channels)for(let p=0;p<this.channels;p++)d[p]+=this.data[h+p];return d}function getMoment(d=0,h=0){this.checkProcessable("getMoment",{bitDepth:[1]});let p=0;for(let m=0;m<this.width;m++)for(let w=0;w<this.height;w++)this.getBitXY(m,w)===1&&(p+=m**d*w**h);return p}function localMaxima(d={}){let{mask:h,region:p=3,removeClosePoints:m=0,invert:w=!1,maxEquals:T=2}=d,k=this;this.checkProcessable("localMaxima",{bitDepth:[8,16],components:1}),p*=4;let x=w?0:1,B=[1,0,-1,0,1,1,-1,-1,2,0,-2,0,2,2,-2,-2],P=[0,1,0,-1,1,-1,1,-1,0,2,0,-2,2,-2,2,-2],O=p<=8?1:2,U=[];for(let G=O;G<k.height-O;G++)for(let j=O;j<k.width-O;j++){if(h&&h.getBitXY(j,G)!==x)continue;let H=0,te=0,oe=k.data[j+G*k.width];for(let Q=0;Q<p;Q++)w?k.data[j+B[Q]+(G+P[Q])*k.width]>oe&&H++:k.data[j+B[Q]+(G+P[Q])*k.width]<oe&&H++,k.data[j+B[Q]+(G+P[Q])*k.width]===oe&&te++;H+te===p&&te<=T&&U.push([j,G])}if(m>0)for(let G=0;G<U.length;G++)for(let j=G+1;j<U.length;j++)Math.sqrt(Math.pow(U[G][0]-U[j][0],2)+Math.pow(U[G][1]-U[j][1],2))<m&&(U[G][0]=U[G][0]+U[j][0]>>1,U[G][1]=U[G][1]+U[j][1]>>1,U.splice(j,1),j--);return U}function mean(){let d=this.getHistograms({maxSlots:this.maxValue+1}),h=new Array(d.length);for(let p=0;p<d.length;p++){let m=d[p];h[p]=mean$2(m)}return h}function median(){let d=this.getHistograms({maxSlots:this.maxValue+1}),h=new Array(d.length);for(let p=0;p<d.length;p++){let m=d[p];h[p]=median$2(m)}return h}function points(){this.checkProcessable("points",{bitDepth:[1]});const d=[];for(let h=0;h<this.width;h++)for(let p=0;p<this.height;p++)this.getBitXY(h,p)===1&&d.push([h,p]);return d}function extendedPoints(){this.checkProcessable("extendedPoints",{bitDepth:[1]});const d=[];for(let h=0;h<this.height;h++)for(let p=0;p<this.width;p++)if(this.getBitXY(p,h)===1)for(d.push([p,h]),this.getBitXY(p+1,h)!==1?(d.push([p+1,h]),d.push([p+1,h+1]),this.getBitXY(p,h+1)!==1&&d.push([p,h+1])):this.getBitXY(p,h+1)!==1&&(d.push([p,h+1]),d.push([p+1,h+1]));p<this.width-2&&this.getBitXY(p+1,h)===1&&this.getBitXY(p+2,h)===1;)p++;return d}function getRelativePosition(d,h={}){if(this===d)return[0,0];let p=[0,0],m=this;for(;m;){if(m===d)return p;m.position&&(p[0]+=m.position[0],p[1]+=m.position[1]),m=m.parent}return h.defaultFurther?p:!1}function countAlphaPixels(d={}){let{alpha:h=1}=d;this.checkProcessable("countAlphaPixels",{bitDepth:[8,16],alpha:1});let p=0;if(h!==void 0){for(let m=this.components;m<this.data.length;m+=this.channels)this.data[m]===h&&p++;return p}else return this.size}function monotoneChainConvexHull$1(d,h={}){h.sorted||d.sort(byXThenY);const p=d.length,m=new Array(p*2);for(var w=0,T=0;T<p;T++){const x=d[T];for(;w>=2&&cw(m[w-2],m[w-1],x)<=0;)w--;m[w++]=x}const k=w+1;for(T=p-2;T>=0;T--){const x=d[T];for(;w>=k&&cw(m[w-2],m[w-1],x)<=0;)w--;m[w++]=x}return m.slice(0,w-1)}function cw(d,h,p){return(h[1]-d[1])*(p[0]-d[0])-(h[0]-d[0])*(p[1]-d[1])}function byXThenY(d,h){return d[0]===h[0]?d[1]-h[1]:d[0]-h[0]}function monotoneChainConvexHull(){return monotoneChainConvexHull$1(this.extendedPoints,{sorted:!1})}function round(d){for(let h=0;h<d.length;h++)d[h][0]=Math.round(d[h][0]),d[h][1]=Math.round(d[h][1]);return d}function difference(d,h){return[d[0]-h[0],d[1]-h[1]]}function normalize(d){let h=Math.sqrt(d[0]**2+d[1]**2);return[d[0]/h,d[1]/h]}function rotate(d,h,p){p===void 0&&(p=new Array(h.length));let m=Math.cos(d),w=Math.sin(d);for(let T=0;T<p.length;++T)p[T]=[m*h[T][0]-w*h[T][1],w*h[T][0]+m*h[T][1]];return p}function perimeter(d){let h=0;for(let p=0;p<d.length;p++){let m=d[p][0],w=d[p][1],T=d[p===d.length-1?0:p+1][0],k=d[p===d.length-1?0:p+1][1];h+=Math.sqrt((T-m)**2+(k-w)**2)}return h}function surface(d){let h=0;for(let p=0;p<d.length;p++){let m=d[p][0],w=d[p===d.length-1?0:p+1][1],T=d[p===d.length-1?0:p+1][0],k=d[p][1];h+=m*w*.5,h-=T*k*.5}return Math.abs(h)}function minMax(d){let h=1/0,p=1/0,m=-1/0,w=-1/0;for(let T=0;T<d.length;T++)d[T][0]<h&&(h=d[T][0]),d[T][0]>m&&(m=d[T][0]),d[T][1]<p&&(p=d[T][1]),d[T][1]>w&&(w=d[T][1]);return[[h,p],[m,w]]}function moveToZeroZero(d,h){h===void 0&&(h=new Array(d.length).fill(0).map(()=>[]));let p=minMax(d),m=p[0][0],w=p[0][1];for(let T=0;T<d.length;T++)h[T][0]=d[T][0]-m,h[T][1]=d[T][1]-w;return h}function minimalBoundingRectangle(d={}){const{originalPoints:h=monotoneChainConvexHull.call(this)}=d;if(h.length===0)return[];if(h.length===1)return[h[0],h[0],h[0],h[0]];const p=new Array(h.length);let m=1/0,w=0,T;for(let k=0;k<p.length;k++){let x=getAngle$1(h[k],h[(k+1)%p.length]);rotate(-x,h,p);let B=p[k][0],P=p[k][1],O=p[(k+1)%p.length][0],U=p[(k+1)%p.length][1],G=!0,j=0,H=0,te=0;for(let se=0;se<p.length;se++){let le=p[se][0],me=p[se][1],Re=(le-B)/(O-B);G===!0?(G=!1,j=Re,H=Re):(Re<j&&(j=Re),Re>H&&(H=Re));let xe=(-(O-B)*me+O*P-U*B)/(O-B);Math.abs(xe)>Math.abs(te)&&(te=xe)}let oe=[B+j*(O-B),P],Q=[B+H*(O-B),P],_e=Math.abs(te*(j-H)*(O-B));_e<m&&(w=x,m=_e,T=[oe,Q,[Q[0],Q[1]-te],[oe[0],oe[1]-te]])}return rotate(w,T,T),T}function getAngle$1(d,h){let p=difference(h,d),m=normalize(p),w=Math.acos(m[0]);return m[1]<0?-w:w}function extend$4(d){let h={inPlace:!0};d.extendMethod("invert",invert),d.extendMethod("abs",abs),d.extendMethod("level",level,h),d.extendMethod("add",add,h),d.extendMethod("subtract",subtract,h),d.extendMethod("subtractImage",subtractImage),d.extendMethod("multiply",multiply,h),d.extendMethod("divide",divide,h),d.extendMethod("hypotenuse",hypotenuse),d.extendMethod("background",background$1),d.extendMethod("flipX",flipX),d.extendMethod("flipY",flipY),d.extendMethod("blurFilter",blurFilter),d.extendMethod("medianFilter",medianFilter),d.extendMethod("gaussianFilter",gaussianFilter),d.extendMethod("sobelFilter",sobelFilter),d.extendMethod("gradientFilter",gradientFilter),d.extendMethod("scharrFilter",scharrFilter),d.extendMethod("dilate",dilate),d.extendMethod("erode",erode),d.extendMethod("open",open),d.extendMethod("close",close),d.extendMethod("topHat",topHat),d.extendMethod("blackHat",blackHat),d.extendMethod("morphologicalGradient",morphologicalGradient),d.extendMethod("warpingFourPoints",warpingFourPoints),d.extendMethod("crop",crop),d.extendMethod("cropAlpha",cropAlpha),d.extendMethod("resize",resize).extendMethod("scale",resize),d.extendMethod("hsv",hsv),d.extendMethod("hsl",hsl$1),d.extendMethod("cmyk",cmyk),d.extendMethod("rgba8",rgba8),d.extendMethod("grey",grey).extendMethod("gray",grey),d.extendMethod("mask",mask),d.extendMethod("pad",pad),d.extendMethod("colorDepth",colorDepth),d.extendMethod("setBorder",setBorder,h),d.extendMethod("rotate",rotate$1),d.extendMethod("rotateLeft",rotateLeft),d.extendMethod("rotateRight",rotateRight),d.extendMethod("insert",insert),d.extendMethod("getRow",getRow),d.extendMethod("getColumn",getColumn),d.extendMethod("getMatrix",getMatrix),d.extendMethod("setMatrix",setMatrix),d.extendMethod("getPixelsArray",getPixelsArray),d.extendMethod("getIntersection",getIntersection),d.extendMethod("getClosestCommonParent",getClosestCommonParent),d.extendMethod("getThreshold",getThreshold),d.extendMethod("split",split),d.extendMethod("getChannel",getChannel),d.extendMethod("combineChannels",combineChannels),d.extendMethod("setChannel",setChannel),d.extendMethod("getSimilarity",getSimilarity),d.extendMethod("getPixelsGrid",getPixelsGrid),d.extendMethod("getBestMatch",getBestMatch),d.extendMethod("cannyEdge",cannyEdge),d.extendMethod("convolution",convolution),d.extendMethod("extract",extract),d.extendMethod("floodFill",floodFill),d.extendMethod("paintLabels",paintLabels,h),d.extendMethod("paintMasks",paintMasks,h),d.extendMethod("paintPoints",paintPoints,h),d.extendMethod("paintPolyline",paintPolyline,h),d.extendMethod("paintPolylines",paintPolylines,h),d.extendMethod("paintPolygon",paintPolygon,h),d.extendMethod("paintPolygons",paintPolygons,h),d.extendMethod("countAlphaPixels",countAlphaPixels),d.extendMethod("monotoneChainConvexHull",monotoneChainConvexHull),d.extendMethod("minimalBoundingRectangle",minimalBoundingRectangle),d.extendMethod("getHistogram",getHistogram).extendProperty("histogram",getHistogram),d.extendMethod("getHistograms",getHistograms).extendProperty("histograms",getHistograms),d.extendMethod("getColorHistogram",getColorHistogram).extendProperty("colorHistogram",getColorHistogram),d.extendMethod("getMin",min).extendProperty("min",min),d.extendMethod("getMax",max).extendProperty("max",max),d.extendMethod("getSum",sum).extendProperty("sum",sum),d.extendMethod("getMoment",getMoment).extendProperty("moment",getMoment),d.extendMethod("getLocalMaxima",localMaxima),d.extendMethod("getMedian",median).extendProperty("median",median),d.extendMethod("getMean",mean).extendProperty("mean",mean),d.extendMethod("getPoints",points).extendProperty("points",points),d.extendMethod("getExtendedPoints",extendedPoints).extendProperty("extendedPoints",extendedPoints),d.extendMethod("getRelativePosition",getRelativePosition)}var quantities={exports:{}};(function(d,h){(function(p,m){d.exports=m()})(commonjsGlobal,function(){function p(Te){return typeof Te=="string"||Te instanceof String}var m=Number.isFinite||window.isFinite;function w(Te){return m(Te)}function T(Te){return Te}function k(Te){var je={};return Te.filter(function(ae){return je.hasOwnProperty(ae)?!1:je[ae]=!0})}function x(Te,je){if(je.length!==Te.length)return!1;for(var ae=0;ae<Te.length;ae++)if(je[ae].compareArray&&!je[ae].compareArray(Te[ae])||je[ae]!==Te[ae])return!1;return!0}function B(Te,je){Object.keys(je).forEach(function(ae){Te[ae]=je[ae]})}function P(){for(var Te=1,je=0,ae=0;ae<arguments.length;ae++){var K=arguments[ae];je=je+G(K),Te*=K}return je!==0?U(Te,je):Te}function O(Te,je){if(je===0)throw new Error("Divide by zero");var ae=Math.pow(10,G(je)),K=ae/(ae*je);return P(Te,K)}function U(Te,je){return Math.round(Te*Math.pow(10,je))/Math.pow(10,je)}function G(Te){if(!isFinite(Te))return 0;for(var je=0;Te%1!==0;)Te*=10,je++;return je}function j(){var Te;if(!this)return Te=Object.create(j.prototype),j.apply(Te,arguments),Te;Te=Error.apply(this,arguments),this.name="QtyError",this.message=Te.message,this.stack=Te.stack}j.prototype=Object.create(Error.prototype,{constructor:{value:j}});function H(Te,je){throw new j("Incompatible units: "+Te+" and "+je)}var te={"<googol>":[["googol"],1e100,"prefix"],"<kibi>":[["Ki","Kibi","kibi"],Math.pow(2,10),"prefix"],"<mebi>":[["Mi","Mebi","mebi"],Math.pow(2,20),"prefix"],"<gibi>":[["Gi","Gibi","gibi"],Math.pow(2,30),"prefix"],"<tebi>":[["Ti","Tebi","tebi"],Math.pow(2,40),"prefix"],"<pebi>":[["Pi","Pebi","pebi"],Math.pow(2,50),"prefix"],"<exi>":[["Ei","Exi","exi"],Math.pow(2,60),"prefix"],"<zebi>":[["Zi","Zebi","zebi"],Math.pow(2,70),"prefix"],"<yebi>":[["Yi","Yebi","yebi"],Math.pow(2,80),"prefix"],"<yotta>":[["Y","Yotta","yotta"],1e24,"prefix"],"<zetta>":[["Z","Zetta","zetta"],1e21,"prefix"],"<exa>":[["E","Exa","exa"],1e18,"prefix"],"<peta>":[["P","Peta","peta"],1e15,"prefix"],"<tera>":[["T","Tera","tera"],1e12,"prefix"],"<giga>":[["G","Giga","giga"],1e9,"prefix"],"<mega>":[["M","Mega","mega"],1e6,"prefix"],"<kilo>":[["k","kilo"],1e3,"prefix"],"<hecto>":[["h","Hecto","hecto"],100,"prefix"],"<deca>":[["da","Deca","deca","deka"],10,"prefix"],"<deci>":[["d","Deci","deci"],.1,"prefix"],"<centi>":[["c","Centi","centi"],.01,"prefix"],"<milli>":[["m","Milli","milli"],.001,"prefix"],"<micro>":[["u","\u03BC","\xB5","Micro","mc","micro"],1e-6,"prefix"],"<nano>":[["n","Nano","nano"],1e-9,"prefix"],"<pico>":[["p","Pico","pico"],1e-12,"prefix"],"<femto>":[["f","Femto","femto"],1e-15,"prefix"],"<atto>":[["a","Atto","atto"],1e-18,"prefix"],"<zepto>":[["z","Zepto","zepto"],1e-21,"prefix"],"<yocto>":[["y","Yocto","yocto"],1e-24,"prefix"],"<1>":[["1","<1>"],1,""],"<meter>":[["m","meter","meters","metre","metres"],1,"length",["<meter>"]],"<inch>":[["in","inch","inches",'"'],.0254,"length",["<meter>"]],"<foot>":[["ft","foot","feet","'"],.3048,"length",["<meter>"]],"<yard>":[["yd","yard","yards"],.9144,"length",["<meter>"]],"<mile>":[["mi","mile","miles"],1609.344,"length",["<meter>"]],"<naut-mile>":[["nmi","naut-mile"],1852,"length",["<meter>"]],"<league>":[["league","leagues"],4828,"length",["<meter>"]],"<furlong>":[["furlong","furlongs"],201.2,"length",["<meter>"]],"<rod>":[["rd","rod","rods"],5.029,"length",["<meter>"]],"<mil>":[["mil","mils"],254e-7,"length",["<meter>"]],"<angstrom>":[["ang","angstrom","angstroms"],1e-10,"length",["<meter>"]],"<fathom>":[["fathom","fathoms"],1.829,"length",["<meter>"]],"<pica>":[["pica","picas"],.00423333333,"length",["<meter>"]],"<point>":[["pt","point","points"],.000352777778,"length",["<meter>"]],"<redshift>":[["z","red-shift","redshift"],1302773e20,"length",["<meter>"]],"<AU>":[["AU","astronomical-unit"],1495979e5,"length",["<meter>"]],"<light-second>":[["ls","light-second"],299792500,"length",["<meter>"]],"<light-minute>":[["lmin","light-minute"],1798755e4,"length",["<meter>"]],"<light-year>":[["ly","light-year"],9460528e9,"length",["<meter>"]],"<parsec>":[["pc","parsec","parsecs"],3085678e10,"length",["<meter>"]],"<datamile>":[["DM","datamile"],1828.8,"length",["<meter>"]],"<kilogram>":[["kg","kilogram","kilograms"],1,"mass",["<kilogram>"]],"<AMU>":[["u","AMU","amu"],1660538921e-36,"mass",["<kilogram>"]],"<dalton>":[["Da","Dalton","Daltons","dalton","daltons"],1660538921e-36,"mass",["<kilogram>"]],"<slug>":[["slug","slugs"],14.5939029,"mass",["<kilogram>"]],"<short-ton>":[["tn","ton","short-ton"],907.18474,"mass",["<kilogram>"]],"<metric-ton>":[["tonne","metric-ton"],1e3,"mass",["<kilogram>"]],"<carat>":[["ct","carat","carats"],2e-4,"mass",["<kilogram>"]],"<pound>":[["lbs","lb","pound","pounds","#"],.45359237,"mass",["<kilogram>"]],"<ounce>":[["oz","ounce","ounces"],.0283495231,"mass",["<kilogram>"]],"<gram>":[["g","gram","grams","gramme","grammes"],.001,"mass",["<kilogram>"]],"<grain>":[["grain","grains","gr"],6479891e-11,"mass",["<kilogram>"]],"<dram>":[["dram","drams","dr"],.0017718452,"mass",["<kilogram>"]],"<stone>":[["stone","stones","st"],6.35029318,"mass",["<kilogram>"]],"<hectare>":[["hectare"],1e4,"area",["<meter>","<meter>"]],"<acre>":[["acre","acres"],4046.85642,"area",["<meter>","<meter>"]],"<sqft>":[["sqft"],1,"area",["<foot>","<foot>"]],"<liter>":[["l","L","liter","liters","litre","litres"],.001,"volume",["<meter>","<meter>","<meter>"]],"<gallon>":[["gal","gallon","gallons"],.0037854118,"volume",["<meter>","<meter>","<meter>"]],"<gallon-imp>":[["galimp","gallon-imp","gallons-imp"],.00454609,"volume",["<meter>","<meter>","<meter>"]],"<quart>":[["qt","quart","quarts"],.00094635295,"volume",["<meter>","<meter>","<meter>"]],"<pint>":[["pt","pint","pints"],.000473176475,"volume",["<meter>","<meter>","<meter>"]],"<pint-imp>":[["ptimp","pint-imp","pints-imp"],.00056826125,"volume",["<meter>","<meter>","<meter>"]],"<cup>":[["cu","cup","cups"],.000236588238,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce>":[["floz","fluid-ounce","fluid-ounces"],295735297e-13,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce-imp>":[["flozimp","floz-imp","fluid-ounce-imp","fluid-ounces-imp"],284130625e-13,"volume",["<meter>","<meter>","<meter>"]],"<tablespoon>":[["tb","tbsp","tbs","tablespoon","tablespoons"],147867648e-13,"volume",["<meter>","<meter>","<meter>"]],"<teaspoon>":[["tsp","teaspoon","teaspoons"],492892161e-14,"volume",["<meter>","<meter>","<meter>"]],"<bushel>":[["bu","bsh","bushel","bushels"],.035239072,"volume",["<meter>","<meter>","<meter>"]],"<oilbarrel>":[["bbl","oilbarrel","oilbarrels","oil-barrel","oil-barrels"],.158987294928,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel>":[["bl","bl-us","beerbarrel","beerbarrels","beer-barrel","beer-barrels"],.1173477658,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel-imp>":[["blimp","bl-imp","beerbarrel-imp","beerbarrels-imp","beer-barrel-imp","beer-barrels-imp"],.16365924,"volume",["<meter>","<meter>","<meter>"]],"<kph>":[["kph"],.277777778,"speed",["<meter>"],["<second>"]],"<mph>":[["mph"],.44704,"speed",["<meter>"],["<second>"]],"<knot>":[["kt","kn","kts","knot","knots"],.514444444,"speed",["<meter>"],["<second>"]],"<fps>":[["fps"],.3048,"speed",["<meter>"],["<second>"]],"<gee>":[["gee"],9.80665,"acceleration",["<meter>"],["<second>","<second>"]],"<Gal>":[["Gal"],.01,"acceleration",["<meter>"],["<second>","<second>"]],"<kelvin>":[["degK","kelvin"],1,"temperature",["<kelvin>"]],"<celsius>":[["degC","celsius","celsius","centigrade"],1,"temperature",["<kelvin>"]],"<fahrenheit>":[["degF","fahrenheit"],5/9,"temperature",["<kelvin>"]],"<rankine>":[["degR","rankine"],5/9,"temperature",["<kelvin>"]],"<temp-K>":[["tempK","temp-K"],1,"temperature",["<temp-K>"]],"<temp-C>":[["tempC","temp-C"],1,"temperature",["<temp-K>"]],"<temp-F>":[["tempF","temp-F"],5/9,"temperature",["<temp-K>"]],"<temp-R>":[["tempR","temp-R"],5/9,"temperature",["<temp-K>"]],"<second>":[["s","sec","secs","second","seconds"],1,"time",["<second>"]],"<minute>":[["min","mins","minute","minutes"],60,"time",["<second>"]],"<hour>":[["h","hr","hrs","hour","hours"],3600,"time",["<second>"]],"<day>":[["d","day","days"],3600*24,"time",["<second>"]],"<week>":[["wk","week","weeks"],7*3600*24,"time",["<second>"]],"<fortnight>":[["fortnight","fortnights"],1209600,"time",["<second>"]],"<year>":[["y","yr","year","years","annum"],31556926,"time",["<second>"]],"<decade>":[["decade","decades"],315569260,"time",["<second>"]],"<century>":[["century","centuries"],3155692600,"time",["<second>"]],"<pascal>":[["Pa","pascal","Pascal"],1,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<bar>":[["bar","bars"],1e5,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<mmHg>":[["mmHg"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inHg>":[["inHg"],3386.3881472,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<torr>":[["torr"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<atm>":[["atm","ATM","atmosphere","atmospheres"],101325,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<psi>":[["psi"],6894.76,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<cmh2o>":[["cmH2O","cmh2o"],98.0638,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inh2o>":[["inH2O","inh2o"],249.082052,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<poise>":[["P","poise"],.1,"viscosity",["<kilogram>"],["<meter>","<second>"]],"<stokes>":[["St","stokes"],1e-4,"viscosity",["<meter>","<meter>"],["<second>"]],"<mole>":[["mol","mole"],1,"substance",["<mole>"]],"<molar>":[["M","molar"],1e3,"concentration",["<mole>"],["<meter>","<meter>","<meter>"]],"<wtpercent>":[["wt%","wtpercent"],10,"concentration",["<kilogram>"],["<meter>","<meter>","<meter>"]],"<katal>":[["kat","katal","Katal"],1,"activity",["<mole>"],["<second>"]],"<unit>":[["U","enzUnit","unit"],16667e-19,"activity",["<mole>"],["<second>"]],"<farad>":[["F","farad","Farad"],1,"capacitance",["<second>","<second>","<second>","<second>","<ampere>","<ampere>"],["<meter>","<meter>","<kilogram>"]],"<coulomb>":[["C","coulomb","Coulomb"],1,"charge",["<ampere>","<second>"]],"<Ah>":[["Ah"],3600,"charge",["<ampere>","<second>"]],"<ampere>":[["A","Ampere","ampere","amp","amps"],1,"current",["<ampere>"]],"<siemens>":[["S","Siemens","siemens"],1,"conductance",["<second>","<second>","<second>","<ampere>","<ampere>"],["<kilogram>","<meter>","<meter>"]],"<henry>":[["H","Henry","henry"],1,"inductance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>","<ampere>"]],"<volt>":[["V","Volt","volt","volts"],1,"potential",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>"]],"<ohm>":[["Ohm","ohm","\u03A9","\u2126"],1,"resistance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>","<ampere>"]],"<weber>":[["Wb","weber","webers"],1,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<tesla>":[["T","tesla","teslas"],1,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<gauss>":[["G","gauss"],1e-4,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<maxwell>":[["Mx","maxwell","maxwells"],1e-8,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<oersted>":[["Oe","oersted","oersteds"],250/Math.PI,"magnetism",["<ampere>"],["<meter>"]],"<joule>":[["J","joule","Joule","joules"],1,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<erg>":[["erg","ergs"],1e-7,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<btu>":[["BTU","btu","BTUs"],1055.056,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<calorie>":[["cal","calorie","calories"],4.184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Calorie>":[["Cal","Calorie","Calories"],4184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<therm-US>":[["th","therm","therms","Therm","therm-US"],105480400,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Wh>":[["Wh"],3600,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<newton>":[["N","Newton","newton"],1,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<dyne>":[["dyn","dyne"],1e-5,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<pound-force>":[["lbf","pound-force"],4.448222,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<hertz>":[["Hz","hertz","Hertz"],1,"frequency",["<1>"],["<second>"]],"<radian>":[["rad","radian","radians"],1,"angle",["<radian>"]],"<degree>":[["deg","degree","degrees"],Math.PI/180,"angle",["<radian>"]],"<gradian>":[["gon","grad","gradian","grads"],Math.PI/200,"angle",["<radian>"]],"<steradian>":[["sr","steradian","steradians"],1,"solid_angle",["<steradian>"]],"<rotation>":[["rotation"],2*Math.PI,"angle",["<radian>"]],"<rpm>":[["rpm"],2*Math.PI/60,"angular_velocity",["<radian>"],["<second>"]],"<byte>":[["B","byte","bytes"],1,"information",["<byte>"]],"<bit>":[["b","bit","bits"],.125,"information",["<byte>"]],"<Bps>":[["Bps"],1,"information_rate",["<byte>"],["<second>"]],"<bps>":[["bps"],.125,"information_rate",["<byte>"],["<second>"]],"<dollar>":[["USD","dollar"],1,"currency",["<dollar>"]],"<cents>":[["cents"],.01,"currency",["<dollar>"]],"<candela>":[["cd","candela"],1,"luminosity",["<candela>"]],"<lumen>":[["lm","lumen"],1,"luminous_power",["<candela>","<steradian>"]],"<lux>":[["lux"],1,"illuminance",["<candela>","<steradian>"],["<meter>","<meter>"]],"<watt>":[["W","watt","watts"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere>":[["VA","volt-ampere"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere-reactive>":[["var","Var","VAr","VAR","volt-ampere-reactive"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<horsepower>":[["hp","horsepower"],745.699872,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<gray>":[["Gy","gray","grays"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<roentgen>":[["R","roentgen"],.00933,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<sievert>":[["Sv","sievert","sieverts"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<becquerel>":[["Bq","becquerel","becquerels"],1,"radiation",["<1>"],["<second>"]],"<curie>":[["Ci","curie","curies"],37e9,"radiation",["<1>"],["<second>"]],"<cpm>":[["cpm"],1/60,"rate",["<count>"],["<second>"]],"<dpm>":[["dpm"],1/60,"rate",["<count>"],["<second>"]],"<bpm>":[["bpm"],1/60,"rate",["<count>"],["<second>"]],"<dot>":[["dot","dots"],1,"resolution",["<each>"]],"<pixel>":[["pixel","px"],1,"resolution",["<each>"]],"<ppi>":[["ppi"],1,"resolution",["<pixel>"],["<inch>"]],"<dpi>":[["dpi"],1,"typography",["<dot>"],["<inch>"]],"<cell>":[["cells","cell"],1,"counting",["<each>"]],"<each>":[["each"],1,"counting",["<each>"]],"<count>":[["count"],1,"counting",["<each>"]],"<base-pair>":[["bp","base-pair"],1,"counting",["<each>"]],"<nucleotide>":[["nt","nucleotide"],1,"counting",["<each>"]],"<molecule>":[["molecule","molecules"],1,"counting",["<1>"]],"<dozen>":[["doz","dz","dozen"],12,"prefix_only",["<each>"]],"<percent>":[["%","percent"],.01,"prefix_only",["<1>"]],"<ppm>":[["ppm"],1e-6,"prefix_only",["<1>"]],"<ppt>":[["ppt"],1e-9,"prefix_only",["<1>"]],"<gross>":[["gr","gross"],144,"prefix_only",["<dozen>","<dozen>"]],"<decibel>":[["dB","decibel","decibels"],1,"logarithmic",["<decibel>"]]},oe=["<meter>","<kilogram>","<second>","<mole>","<ampere>","<radian>","<kelvin>","<temp-K>","<byte>","<dollar>","<candela>","<each>","<steradian>","<decibel>"],Q="<1>",_e=[Q];function se(Te,je){var ae=je[1],K=je[3]||[],re=je[4]||[];if(!w(ae))throw new j(Te+": Invalid unit definition. 'scalar' must be a number");K.forEach(function(de){if(te[de]===void 0)throw new j(Te+": Invalid unit definition. Unit "+de+" in 'numerator' is not recognized")}),re.forEach(function(de){if(te[de]===void 0)throw new j(Te+": Invalid unit definition. Unit "+de+" in 'denominator' is not recognized")})}var le={},me={},Re={},xe={},ue={};for(var Me in te)if(te.hasOwnProperty(Me)){var he=te[Me];if(he[2]==="prefix"){le[Me]=he[1];for(var ge=0;ge<he[0].length;ge++)me[he[0][ge]]=Me}else{se(Me,he),Re[Me]={scalar:he[1],numerator:he[3],denominator:he[4]};for(var Le=0;Le<he[0].length;Le++)xe[he[0][Le]]=Me}ue[Me]=he[0][0]}function Ze(Te){var je,ae=[],K=Object.keys(te);if(typeof Te=="undefined")for(je=0;je<K.length;je++)["","prefix"].indexOf(te[K[je]][2])===-1&&ae.push(K[je].substr(1,K[je].length-2));else{if(this.getKinds().indexOf(Te)===-1)throw new j("Kind not recognized");for(je=0;je<K.length;je++)te[K[je]][2]===Te&&ae.push(K[je].substr(1,K[je].length-2))}return ae.sort(function(re,de){return re.toLowerCase()<de.toLowerCase()?-1:re.toLowerCase()>de.toLowerCase()?1:0})}function st(Te){if(!xe[Te])throw new j("Unit not recognized");return te[xe[Te]][0]}var ht=["length","time","temperature","mass","current","substance","luminosity","currency","information","angle"];function Rt(){if(this.signature)return this.signature;for(var Te=Bt.call(this),je=0;je<Te.length;je++)Te[je]*=Math.pow(20,je);return Te.reduce(function(ae,K){return ae+K},0)}function Bt(){if(!this.isBase())return Bt.call(this.toBase());for(var Te=new Array(ht.length),je=0;je<Te.length;je++)Te[je]=0;for(var ae,K,re=0;re<this.numerator.length;re++)(ae=te[this.numerator[re]])&&(K=ht.indexOf(ae[2]),K>=0&&(Te[K]=Te[K]+1));for(var de=0;de<this.denominator.length;de++)(ae=te[this.denominator[de]])&&(K=ht.indexOf(ae[2]),K>=0&&(Te[K]=Te[K]-1));return Te}var At="[+-]",Nt="\\d+",zt=At+"?"+Nt,Tt="\\."+Nt,ii="(?:"+Nt+"(?:"+Tt+")?)|(?:"+Tt+")",Mt="[Ee]"+zt,St="(?:"+ii+")(?:"+Mt+")?",wt=At+"?\\s*"+St,Ut="("+wt+")?\\s*([^/]*)(?:/(.+))?",Vt=new RegExp("^"+Ut+"$"),pi="\\^|\\*{2}",ni="[01234]",_i=new RegExp("([^ \\*\\d]+?)(?:"+pi+")?(-?"+ni+"(?![a-zA-Z]))"),yi=new RegExp("([^ \\*\\d]+?)(?:"+pi+")?("+ni+"(?![a-zA-Z]))");function Ri(Te){p(Te)||(Te=Te.toString()),Te=Te.trim();var je=Vt.exec(Te);if(!je)throw new j(Te+": Quantity not recognized");var ae=je[1];ae?(ae=ae.replace(/\s/g,""),this.scalar=parseFloat(ae)):this.scalar=1;for(var K=je[2],re=je[3],de,Se,De;je=_i.exec(K);){if(de=parseFloat(je[2]),isNaN(de))throw new j("Unit exponent is not a number");if(de===0&&!oi.test(je[1]))throw new j("Unit not recognized");Se=je[1]+" ",De="";for(var Ue=0;Ue<Math.abs(de);Ue++)De+=Se;de>=0?K=K.replace(je[0],De):(re=re?re+De:De,K=K.replace(je[0],""))}for(;je=yi.exec(re);){if(de=parseFloat(je[2]),isNaN(de))throw new j("Unit exponent is not a number");if(de===0&&!oi.test(je[1]))throw new j("Unit not recognized");Se=je[1]+" ",De="";for(var Ne=0;Ne<de;Ne++)De+=Se;re=re.replace(je[0],De)}K&&(this.numerator=Pt(K.trim())),re&&(this.denominator=Pt(re.trim()))}var di=Object.keys(me).sort(function(Te,je){return je.length-Te.length}).join("|"),pt=Object.keys(xe).sort(function(Te,je){return je.length-Te.length}).join("|"),xt="\\b|$",fi="("+di+")??("+pt+")(?:"+xt+")",oi=new RegExp("^\\s*("+fi+"[\\s\\*]*)+$"),He=new RegExp(fi,"g"),Ht={};function Pt(Te){var je=Ht[Te];if(je)return je;var ae,K=[];if(!oi.test(Te))throw new j("Unit not recognized");for(;ae=He.exec(Te);)K.push(ae.slice(1));return K=K.map(function(re){return me[re[0]]?[me[re[0]],xe[re[1]]]:[xe[re[1]]]}),K=K.reduce(function(re,de){return re.concat(de)},[]),K=K.filter(function(re){return re}),Ht[Te]=K,K}function ei(Te){if(!p(Te))throw new j("Argument should be a string");try{return this(Te)}catch{return null}}function ri(Te){return Te instanceof vt}function vt(Te,je){if(Di.apply(null,arguments),!ri(this))return new vt(Te,je);if(this.scalar=null,this.baseScalar=null,this.signature=null,this._conversionCache={},this.numerator=_e,this.denominator=_e,Wt(Te)?(this.scalar=Te.scalar,this.numerator=Te.numerator&&Te.numerator.length!==0?Te.numerator:_e,this.denominator=Te.denominator&&Te.denominator.length!==0?Te.denominator:_e):je?(Ri.call(this,je),this.scalar=Te):Ri.call(this,Te),this.denominator.join("*").indexOf("temp")>=0)throw new j("Cannot divide with temperatures");if(this.numerator.join("*").indexOf("temp")>=0){if(this.numerator.length>1)throw new j("Cannot multiply by temperatures");if(!x(this.denominator,_e))throw new j("Cannot divide with temperatures")}if(this.initValue=Te,Gt.call(this),this.isTemperature()&&this.baseScalar<0)throw new j("Temperatures must not be less than absolute zero")}vt.prototype={constructor:vt};function Di(Te,je){if(je){if(!(w(Te)&&p(je)))throw new j("Only number accepted as initialization value when units are explicitly provided")}else if(!(p(Te)||w(Te)||ri(Te)||Wt(Te)))throw new j("Only string, number or quantity accepted as single initialization value")}function Wt(Te){return Te&&typeof Te=="object"&&Te.hasOwnProperty("scalar")}function Gt(){if(this.baseScalar)return this.baseScalar;if(this.isBase())this.baseScalar=this.scalar,this.signature=Rt.call(this);else{var Te=this.toBase();this.baseScalar=Te.scalar,this.signature=Te.signature}}var qt={"-312078":"elastance","-312058":"resistance","-312038":"inductance","-152058":"potential","-152040":"magnetism","-152038":"magnetism","-7997":"specific_volume","-79":"snap","-59":"jolt","-39":"acceleration","-38":"radiation","-20":"frequency","-19":"speed","-18":"viscosity","-17":"volumetric_flow","-1":"wavenumber","0":"unitless","1":"length","2":"area","3":"volume","20":"time","400":"temperature","7941":"yank","7942":"power","7959":"pressure","7961":"force","7962":"energy","7979":"viscosity","7981":"momentum","7982":"angular_momentum","7997":"density","7998":"area_density","8000":"mass","152020":"radiation_exposure","159999":"magnetism","160000":"current","160020":"charge","312058":"conductance","312078":"capacitance","3199980":"activity","3199997":"molar_concentration","3200000":"substance","63999998":"illuminance","64000000":"luminous_power","1280000000":"currency","25599999980":"information_rate","25600000000":"information","511999999980":"angular_velocity","512000000000":"angle"};function It(){return k(Object.keys(qt).map(function(Te){return qt[Te]}))}vt.prototype.kind=function(){return qt[this.signature.toString()]},B(vt.prototype,{isDegrees:function(){return(this.signature===null||this.signature===400)&&this.numerator.length===1&&x(this.denominator,_e)&&(this.numerator[0].match(/<temp-[CFRK]>/)||this.numerator[0].match(/<(kelvin|celsius|rankine|fahrenheit)>/))},isTemperature:function(){return this.isDegrees()&&this.numerator[0].match(/<temp-[CFRK]>/)}});function hi(Te,je){var ae=Te.units(),K=je.to(ae),re=vt(Qt(ae));return vt({scalar:Te.scalar-K.scalar,numerator:re.numerator,denominator:re.denominator})}function xi(Te,je){var ae=je.to(Qt(Te.units()));return vt({scalar:Te.scalar-ae.scalar,numerator:Te.numerator,denominator:Te.denominator})}function Ei(Te,je){var ae=je.to(Qt(Te.units()));return vt({scalar:Te.scalar+ae.scalar,numerator:Te.numerator,denominator:Te.denominator})}function Qt(Te){if(Te==="tempK")return"degK";if(Te==="tempC")return"degC";if(Te==="tempF")return"degF";if(Te==="tempR")return"degR";throw new j("Unknown type for temp conversion from: "+Te)}function ai(Te,je){var ae=$i(Te),K=je.units(),re;if(K==="degK")re=ae.scalar;else if(K==="degC")re=ae.scalar;else if(K==="degF")re=ae.scalar*9/5;else if(K==="degR")re=ae.scalar*9/5;else throw new j("Unknown type for degree conversion to: "+K);return vt({scalar:re,numerator:je.numerator,denominator:je.denominator})}function $i(Te){var je=Te.units(),ae;if(je.match(/(deg)[CFRK]/))ae=Te.baseScalar;else if(je==="tempK")ae=Te.scalar;else if(je==="tempC")ae=Te.scalar;else if(je==="tempF")ae=Te.scalar*5/9;else if(je==="tempR")ae=Te.scalar*5/9;else throw new j("Unknown type for temp conversion from: "+je);return vt({scalar:ae,numerator:["<kelvin>"],denominator:_e})}function Si(Te,je){var ae=je.units(),K;if(ae==="tempK")K=Te.baseScalar;else if(ae==="tempC")K=Te.baseScalar-273.15;else if(ae==="tempF")K=Te.baseScalar*9/5-459.67;else if(ae==="tempR")K=Te.baseScalar*9/5;else throw new j("Unknown type for temp conversion to: "+ae);return vt({scalar:K,numerator:je.numerator,denominator:je.denominator})}function Zi(Te){var je=Te.units(),ae;if(je.match(/(deg)[CFRK]/))ae=Te.baseScalar;else if(je==="tempK")ae=Te.scalar;else if(je==="tempC")ae=Te.scalar+273.15;else if(je==="tempF")ae=(Te.scalar+459.67)*5/9;else if(je==="tempR")ae=Te.scalar*5/9;else throw new j("Unknown type for temp conversion from: "+je);return vt({scalar:ae,numerator:["<temp-K>"],denominator:_e})}B(vt.prototype,{to:function(Te){var je,ae;if(Te==null)return this;if(!p(Te))return this.to(Te.units());if(je=this._conversionCache[Te],je)return je;if(ae=vt(Te),ae.units()===this.units())return this;if(!this.isCompatible(ae))this.isInverse(ae)?ae=this.inverse().to(Te):H(this.units(),ae.units());else if(ae.isTemperature())ae=Si(this,ae);else if(ae.isDegrees())ae=ai(this,ae);else{var K=O(this.baseScalar,ae.baseScalar);ae=vt({scalar:K,numerator:ae.numerator,denominator:ae.denominator})}return this._conversionCache[Te]=ae,ae},toBase:function(){if(this.isBase())return this;if(this.isTemperature())return Zi(this);var Te=dr[this.units()];return Te||(Te=on(this.numerator,this.denominator),dr[this.units()]=Te),Te.mul(this.scalar)},toFloat:function(){if(this.isUnitless())return this.scalar;throw new j("Can't convert to Float unless unitless.  Use Unit#scalar")},toPrec:function(Te){if(p(Te)&&(Te=vt(Te)),w(Te)&&(Te=vt(Te+" "+this.units())),this.isUnitless()?Te.isUnitless()||H(this.units(),Te.units()):Te=Te.to(this.units()),Te.scalar===0)throw new j("Divide by zero");var je=P(Math.round(this.scalar/Te.scalar),Te.scalar);return vt(je+this.units())}});function Ai(Te,je){var ae=vt(Te),K=vt(je);if(ae.eq(K))return T;var re;return ae.isTemperature()?re=function(de){return ae.mul(de).to(K).scalar}:re=function(de){return de*ae.baseScalar/K.baseScalar},function(Se){var De,Ue,Ne;if(Array.isArray(Se)){for(Ue=Se.length,Ne=[],De=0;De<Ue;De++)Ne.push(re(Se[De]));return Ne}else return re(Se)}}var dr={};function on(Te,je){for(var ae=[],K=[],re=1,de,Se=0;Se<Te.length;Se++)de=Te[Se],le[de]?re=P(re,le[de]):Re[de]&&(re*=Re[de].scalar,Re[de].numerator&&ae.push(Re[de].numerator),Re[de].denominator&&K.push(Re[de].denominator));for(var De=0;De<je.length;De++)de=je[De],le[de]?re/=le[de]:Re[de]&&(re/=Re[de].scalar,Re[de].numerator&&K.push(Re[de].numerator),Re[de].denominator&&ae.push(Re[de].denominator));return ae=ae.reduce(function(Ue,Ne){return Ue.concat(Ne)},[]),K=K.reduce(function(Ue,Ne){return Ue.concat(Ne)},[]),vt({scalar:re,numerator:ae,denominator:K})}vt.parse=ei,vt.getUnits=Ze,vt.getAliases=st,vt.mulSafe=P,vt.divSafe=O,vt.getKinds=It,vt.swiftConverter=Ai,vt.Error=j,B(vt.prototype,{add:function(Te){if(p(Te)&&(Te=vt(Te)),this.isCompatible(Te)||H(this.units(),Te.units()),this.isTemperature()&&Te.isTemperature())throw new j("Cannot add two temperatures");return this.isTemperature()?Ei(this,Te):Te.isTemperature()?Ei(Te,this):vt({scalar:this.scalar+Te.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},sub:function(Te){if(p(Te)&&(Te=vt(Te)),this.isCompatible(Te)||H(this.units(),Te.units()),this.isTemperature()&&Te.isTemperature())return hi(this,Te);if(this.isTemperature())return xi(this,Te);if(Te.isTemperature())throw new j("Cannot subtract a temperature from a differential degree unit");return vt({scalar:this.scalar-Te.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},mul:function(Te){if(w(Te))return vt({scalar:P(this.scalar,Te),numerator:this.numerator,denominator:this.denominator});if(p(Te)&&(Te=vt(Te)),(this.isTemperature()||Te.isTemperature())&&!(this.isUnitless()||Te.isUnitless()))throw new j("Cannot multiply by temperatures");var je=this,ae=Te;je.isCompatible(ae)&&je.signature!==400&&(ae=ae.to(je));var K=fr(je.numerator,je.denominator,ae.numerator,ae.denominator);return vt({scalar:P(je.scalar,ae.scalar,K[2]),numerator:K[0],denominator:K[1]})},div:function(Te){if(w(Te)){if(Te===0)throw new j("Divide by zero");return vt({scalar:this.scalar/Te,numerator:this.numerator,denominator:this.denominator})}else p(Te)&&(Te=vt(Te));if(Te.scalar===0)throw new j("Divide by zero");if(Te.isTemperature())throw new j("Cannot divide with temperatures");if(this.isTemperature()&&!Te.isUnitless())throw new j("Cannot divide with temperatures");var je=this,ae=Te;je.isCompatible(ae)&&je.signature!==400&&(ae=ae.to(je));var K=fr(je.numerator,je.denominator,ae.denominator,ae.numerator);return vt({scalar:P(je.scalar,K[2])/ae.scalar,numerator:K[0],denominator:K[1]})},inverse:function(){if(this.isTemperature())throw new j("Cannot divide with temperatures");if(this.scalar===0)throw new j("Divide by zero");return vt({scalar:1/this.scalar,numerator:this.denominator,denominator:this.numerator})}});function fr(Te,je,ae,K){function re(Qe){return Qe!==Q}Te=Te.filter(re),ae=ae.filter(re),je=je.filter(re),K=K.filter(re);var de={};function Se(Qe,at){for(var kt,jt,Zt,Yt=0;Yt<Qe.length;Yt++)if(le[Qe[Yt]]?(kt=Qe[Yt+1],jt=Qe[Yt],Zt=le[jt],Yt++):(kt=Qe[Yt],jt=null,Zt=1),kt&&kt!==Q)if(de[kt]){de[kt][0]+=at;var mi=de[kt][2]?le[de[kt][2]]:1;de[kt][at===1?3:4]*=O(Zt,mi)}else de[kt]=[at,kt,jt,1,1]}Se(Te,1),Se(je,-1),Se(ae,1),Se(K,-1);var De=[],Ue=[],Ne=1;for(var Oe in de)if(de.hasOwnProperty(Oe)){var qe=de[Oe],Je;if(qe[0]>0)for(Je=0;Je<qe[0];Je++)De.push(qe[2]===null?qe[1]:[qe[2],qe[1]]);else if(qe[0]<0)for(Je=0;Je<-qe[0];Je++)Ue.push(qe[2]===null?qe[1]:[qe[2],qe[1]]);Ne*=O(qe[3],qe[4])}return De.length===0&&(De=_e),Ue.length===0&&(Ue=_e),De=De.reduce(function(Qe,at){return Qe.concat(at)},[]),Ue=Ue.reduce(function(Qe,at){return Qe.concat(at)},[]),[De,Ue,Ne]}B(vt.prototype,{eq:function(Te){return this.compareTo(Te)===0},lt:function(Te){return this.compareTo(Te)===-1},lte:function(Te){return this.eq(Te)||this.lt(Te)},gt:function(Te){return this.compareTo(Te)===1},gte:function(Te){return this.eq(Te)||this.gt(Te)},compareTo:function(Te){if(p(Te))return this.compareTo(vt(Te));if(this.isCompatible(Te)||H(this.units(),Te.units()),this.baseScalar<Te.baseScalar)return-1;if(this.baseScalar===Te.baseScalar)return 0;if(this.baseScalar>Te.baseScalar)return 1},same:function(Te){return this.scalar===Te.scalar&&this.units()===Te.units()}}),B(vt.prototype,{isUnitless:function(){return[this.numerator,this.denominator].every(function(Te){return x(Te,_e)})},isCompatible:function(Te){return p(Te)?this.isCompatible(vt(Te)):ri(Te)&&Te.signature!==void 0?this.signature===Te.signature:!1},isInverse:function(Te){return this.inverse().isCompatible(Te)},isBase:function(){return this._isBase!==void 0?this._isBase:this.isDegrees()&&this.numerator[0].match(/<(kelvin|temp-K)>/)?(this._isBase=!0,this._isBase):(this.numerator.concat(this.denominator).forEach(function(Te){Te!==Q&&oe.indexOf(Te)===-1&&(this._isBase=!1)},this),this._isBase===!1?this._isBase:(this._isBase=!0,this._isBase))}});function Rr(){}Rr.prototype.get=function(Te){return arguments.length>1&&(Te=Array.apply(null,arguments)),Te.reduce(function(je,ae,K){if(je){var re=je[ae];return K===Te.length-1?re?re.data:void 0:re}},this)},Rr.prototype.set=function(Te,je){return arguments.length>2&&(Te=Array.prototype.slice.call(arguments,0,-1),je=arguments[arguments.length-1]),Te.reduce(function(ae,K,re){var de=ae[K];return de===void 0&&(de=ae[K]={}),re===Te.length-1?(de.data=je,je):de},this)};function Br(Te,je){return(Te+" "+je).trim()}vt.formatter=Br,B(vt.prototype,{units:function(){if(this._units!==void 0)return this._units;var Te=x(this.numerator,_e),je=x(this.denominator,_e);if(Te&&je)return this._units="",this._units;var ae=vr(this.numerator),K=vr(this.denominator);return this._units=ae+(je?"":"/"+K),this._units},toString:function(Te,je){var ae;if(w(Te))ae=this.units(),je=Te;else if(p(Te))ae=Te;else if(ri(Te))return this.toPrec(Te).toString(je);var K=this.to(ae),re=je!==void 0?U(K.scalar,je):K.scalar;return K=(re+" "+K.units()).trim(),K},format:function(Te,je){arguments.length===1&&typeof Te=="function"&&(je=Te,Te=void 0),je=je||vt.formatter;var ae=this.to(Te);return je.call(this,ae.scalar,ae.units())}});var Er=new Rr;function vr(Te){var je=Er.get(Te);if(je)return je;var ae=x(Te,_e);return ae?je="1":je=Mr($r(Te)).join("*"),Er.set(Te,je),je}function $r(Te){for(var je=[],ae,K,re=0;re<Te.length;re++)ae=Te[re],K=Te[re+1],le[ae]?(je.push(ue[ae]+ue[K]),re++):je.push(ue[ae]);return je}function Mr(Te){var je=Te.reduce(function(ae,K){var re=ae[K];return re||ae.push(re=ae[K]=[K,0]),re[1]++,ae},[]);return je.map(function(ae){return ae[0]+(ae[1]>1?ae[1]:"")})}return vt.version="1.7.6",vt})})(quantities);var Qty=quantities.exports;function deepValue(d,h=""){let p=h.split(".");for(let m of p){if(d[m]===void 0)return;d=d[m]}return d}var orientation={exports:{}},twoProduct_1=twoProduct$1,SPLITTER=+(Math.pow(2,27)+1);function twoProduct$1(d,h,p){var m=d*h,w=SPLITTER*d,T=w-d,k=w-T,x=d-k,B=SPLITTER*h,P=B-h,O=B-P,U=h-O,G=m-k*O,j=G-x*O,H=j-k*U,te=x*U-H;return p?(p[0]=te,p[1]=m,p):[te,m]}var robustSum=linearExpansionSum;function scalarScalar$1(d,h){var p=d+h,m=p-d,w=p-m,T=h-m,k=d-w,x=k+T;return x?[x,p]:[p]}function linearExpansionSum(d,h){var p=d.length|0,m=h.length|0;if(p===1&&m===1)return scalarScalar$1(d[0],h[0]);var w=p+m,T=new Array(w),k=0,x=0,B=0,P=Math.abs,O=d[x],U=P(O),G=h[B],j=P(G),H,te;U<j?(te=O,x+=1,x<p&&(O=d[x],U=P(O))):(te=G,B+=1,B<m&&(G=h[B],j=P(G))),x<p&&U<j||B>=m?(H=O,x+=1,x<p&&(O=d[x],U=P(O))):(H=G,B+=1,B<m&&(G=h[B],j=P(G)));for(var oe=H+te,Q=oe-H,_e=te-Q,se=_e,le=oe,me,Re,xe,ue,Me;x<p&&B<m;)U<j?(H=O,x+=1,x<p&&(O=d[x],U=P(O))):(H=G,B+=1,B<m&&(G=h[B],j=P(G))),te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[k++]=_e),me=le+oe,Re=me-le,xe=me-Re,ue=oe-Re,Me=le-xe,se=Me+ue,le=me;for(;x<p;)H=O,te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[k++]=_e),me=le+oe,Re=me-le,xe=me-Re,ue=oe-Re,Me=le-xe,se=Me+ue,le=me,x+=1,x<p&&(O=d[x]);for(;B<m;)H=G,te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[k++]=_e),me=le+oe,Re=me-le,xe=me-Re,ue=oe-Re,Me=le-xe,se=Me+ue,le=me,B+=1,B<m&&(G=h[B]);return se&&(T[k++]=se),le&&(T[k++]=le),k||(T[k++]=0),T.length=k,T}var twoSum$1=fastTwoSum;function fastTwoSum(d,h,p){var m=d+h,w=m-d,T=m-w,k=h-w,x=d-T;return p?(p[0]=x+k,p[1]=m,p):[x+k,m]}var twoProduct=twoProduct_1,twoSum=twoSum$1,robustScale=scaleLinearExpansion;function scaleLinearExpansion(d,h){var p=d.length;if(p===1){var m=twoProduct(d[0],h);return m[0]?m:[m[1]]}var w=new Array(2*p),T=[.1,.1],k=[.1,.1],x=0;twoProduct(d[0],h,T),T[0]&&(w[x++]=T[0]);for(var B=1;B<p;++B){twoProduct(d[B],h,k);var P=T[1];twoSum(P,k[0],T),T[0]&&(w[x++]=T[0]);var O=k[1],U=T[1],G=O+U,j=G-O,H=U-j;T[1]=G,H&&(w[x++]=H)}return T[1]&&(w[x++]=T[1]),x===0&&(w[x++]=0),w.length=x,w}var robustDiff=robustSubtract;function scalarScalar(d,h){var p=d+h,m=p-d,w=p-m,T=h-m,k=d-w,x=k+T;return x?[x,p]:[p]}function robustSubtract(d,h){var p=d.length|0,m=h.length|0;if(p===1&&m===1)return scalarScalar(d[0],-h[0]);var w=p+m,T=new Array(w),k=0,x=0,B=0,P=Math.abs,O=d[x],U=P(O),G=-h[B],j=P(G),H,te;U<j?(te=O,x+=1,x<p&&(O=d[x],U=P(O))):(te=G,B+=1,B<m&&(G=-h[B],j=P(G))),x<p&&U<j||B>=m?(H=O,x+=1,x<p&&(O=d[x],U=P(O))):(H=G,B+=1,B<m&&(G=-h[B],j=P(G)));for(var oe=H+te,Q=oe-H,_e=te-Q,se=_e,le=oe,me,Re,xe,ue,Me;x<p&&B<m;)U<j?(H=O,x+=1,x<p&&(O=d[x],U=P(O))):(H=G,B+=1,B<m&&(G=-h[B],j=P(G))),te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[k++]=_e),me=le+oe,Re=me-le,xe=me-Re,ue=oe-Re,Me=le-xe,se=Me+ue,le=me;for(;x<p;)H=O,te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[k++]=_e),me=le+oe,Re=me-le,xe=me-Re,ue=oe-Re,Me=le-xe,se=Me+ue,le=me,x+=1,x<p&&(O=d[x]);for(;B<m;)H=G,te=se,oe=H+te,Q=oe-H,_e=te-Q,_e&&(T[k++]=_e),me=le+oe,Re=me-le,xe=me-Re,ue=oe-Re,Me=le-xe,se=Me+ue,le=me,B+=1,B<m&&(G=-h[B]);return se&&(T[k++]=se),le&&(T[k++]=le),k||(T[k++]=0),T.length=k,T}(function(d){var h=twoProduct_1,p=robustSum,m=robustScale,w=robustDiff,T=5,k=11102230246251565e-32,x=(3+16*k)*k,B=(7+56*k)*k;function P(se,le,me,Re){return function(ue,Me,he){var ge=se(se(le(Me[1],he[0]),le(-he[1],Me[0])),se(le(ue[1],Me[0]),le(-Me[1],ue[0]))),Le=se(le(ue[1],he[0]),le(-he[1],ue[0])),Ze=Re(ge,Le);return Ze[Ze.length-1]}}function O(se,le,me,Re){return function(ue,Me,he,ge){var Le=se(se(me(se(le(he[1],ge[0]),le(-ge[1],he[0])),Me[2]),se(me(se(le(Me[1],ge[0]),le(-ge[1],Me[0])),-he[2]),me(se(le(Me[1],he[0]),le(-he[1],Me[0])),ge[2]))),se(me(se(le(Me[1],ge[0]),le(-ge[1],Me[0])),ue[2]),se(me(se(le(ue[1],ge[0]),le(-ge[1],ue[0])),-Me[2]),me(se(le(ue[1],Me[0]),le(-Me[1],ue[0])),ge[2])))),Ze=se(se(me(se(le(he[1],ge[0]),le(-ge[1],he[0])),ue[2]),se(me(se(le(ue[1],ge[0]),le(-ge[1],ue[0])),-he[2]),me(se(le(ue[1],he[0]),le(-he[1],ue[0])),ge[2]))),se(me(se(le(Me[1],he[0]),le(-he[1],Me[0])),ue[2]),se(me(se(le(ue[1],he[0]),le(-he[1],ue[0])),-Me[2]),me(se(le(ue[1],Me[0]),le(-Me[1],ue[0])),he[2])))),st=Re(Le,Ze);return st[st.length-1]}}function U(se,le,me,Re){return function(ue,Me,he,ge,Le){var Ze=se(se(se(me(se(me(se(le(ge[1],Le[0]),le(-Le[1],ge[0])),he[2]),se(me(se(le(he[1],Le[0]),le(-Le[1],he[0])),-ge[2]),me(se(le(he[1],ge[0]),le(-ge[1],he[0])),Le[2]))),Me[3]),se(me(se(me(se(le(ge[1],Le[0]),le(-Le[1],ge[0])),Me[2]),se(me(se(le(Me[1],Le[0]),le(-Le[1],Me[0])),-ge[2]),me(se(le(Me[1],ge[0]),le(-ge[1],Me[0])),Le[2]))),-he[3]),me(se(me(se(le(he[1],Le[0]),le(-Le[1],he[0])),Me[2]),se(me(se(le(Me[1],Le[0]),le(-Le[1],Me[0])),-he[2]),me(se(le(Me[1],he[0]),le(-he[1],Me[0])),Le[2]))),ge[3]))),se(me(se(me(se(le(he[1],ge[0]),le(-ge[1],he[0])),Me[2]),se(me(se(le(Me[1],ge[0]),le(-ge[1],Me[0])),-he[2]),me(se(le(Me[1],he[0]),le(-he[1],Me[0])),ge[2]))),-Le[3]),se(me(se(me(se(le(ge[1],Le[0]),le(-Le[1],ge[0])),Me[2]),se(me(se(le(Me[1],Le[0]),le(-Le[1],Me[0])),-ge[2]),me(se(le(Me[1],ge[0]),le(-ge[1],Me[0])),Le[2]))),ue[3]),me(se(me(se(le(ge[1],Le[0]),le(-Le[1],ge[0])),ue[2]),se(me(se(le(ue[1],Le[0]),le(-Le[1],ue[0])),-ge[2]),me(se(le(ue[1],ge[0]),le(-ge[1],ue[0])),Le[2]))),-Me[3])))),se(se(me(se(me(se(le(Me[1],Le[0]),le(-Le[1],Me[0])),ue[2]),se(me(se(le(ue[1],Le[0]),le(-Le[1],ue[0])),-Me[2]),me(se(le(ue[1],Me[0]),le(-Me[1],ue[0])),Le[2]))),ge[3]),se(me(se(me(se(le(Me[1],ge[0]),le(-ge[1],Me[0])),ue[2]),se(me(se(le(ue[1],ge[0]),le(-ge[1],ue[0])),-Me[2]),me(se(le(ue[1],Me[0]),le(-Me[1],ue[0])),ge[2]))),-Le[3]),me(se(me(se(le(he[1],ge[0]),le(-ge[1],he[0])),Me[2]),se(me(se(le(Me[1],ge[0]),le(-ge[1],Me[0])),-he[2]),me(se(le(Me[1],he[0]),le(-he[1],Me[0])),ge[2]))),ue[3]))),se(me(se(me(se(le(he[1],ge[0]),le(-ge[1],he[0])),ue[2]),se(me(se(le(ue[1],ge[0]),le(-ge[1],ue[0])),-he[2]),me(se(le(ue[1],he[0]),le(-he[1],ue[0])),ge[2]))),-Me[3]),se(me(se(me(se(le(Me[1],ge[0]),le(-ge[1],Me[0])),ue[2]),se(me(se(le(ue[1],ge[0]),le(-ge[1],ue[0])),-Me[2]),me(se(le(ue[1],Me[0]),le(-Me[1],ue[0])),ge[2]))),he[3]),me(se(me(se(le(Me[1],he[0]),le(-he[1],Me[0])),ue[2]),se(me(se(le(ue[1],he[0]),le(-he[1],ue[0])),-Me[2]),me(se(le(ue[1],Me[0]),le(-Me[1],ue[0])),he[2]))),-ge[3]))))),st=se(se(se(me(se(me(se(le(ge[1],Le[0]),le(-Le[1],ge[0])),he[2]),se(me(se(le(he[1],Le[0]),le(-Le[1],he[0])),-ge[2]),me(se(le(he[1],ge[0]),le(-ge[1],he[0])),Le[2]))),ue[3]),me(se(me(se(le(ge[1],Le[0]),le(-Le[1],ge[0])),ue[2]),se(me(se(le(ue[1],Le[0]),le(-Le[1],ue[0])),-ge[2]),me(se(le(ue[1],ge[0]),le(-ge[1],ue[0])),Le[2]))),-he[3])),se(me(se(me(se(le(he[1],Le[0]),le(-Le[1],he[0])),ue[2]),se(me(se(le(ue[1],Le[0]),le(-Le[1],ue[0])),-he[2]),me(se(le(ue[1],he[0]),le(-he[1],ue[0])),Le[2]))),ge[3]),me(se(me(se(le(he[1],ge[0]),le(-ge[1],he[0])),ue[2]),se(me(se(le(ue[1],ge[0]),le(-ge[1],ue[0])),-he[2]),me(se(le(ue[1],he[0]),le(-he[1],ue[0])),ge[2]))),-Le[3]))),se(se(me(se(me(se(le(he[1],Le[0]),le(-Le[1],he[0])),Me[2]),se(me(se(le(Me[1],Le[0]),le(-Le[1],Me[0])),-he[2]),me(se(le(Me[1],he[0]),le(-he[1],Me[0])),Le[2]))),ue[3]),me(se(me(se(le(he[1],Le[0]),le(-Le[1],he[0])),ue[2]),se(me(se(le(ue[1],Le[0]),le(-Le[1],ue[0])),-he[2]),me(se(le(ue[1],he[0]),le(-he[1],ue[0])),Le[2]))),-Me[3])),se(me(se(me(se(le(Me[1],Le[0]),le(-Le[1],Me[0])),ue[2]),se(me(se(le(ue[1],Le[0]),le(-Le[1],ue[0])),-Me[2]),me(se(le(ue[1],Me[0]),le(-Me[1],ue[0])),Le[2]))),he[3]),me(se(me(se(le(Me[1],he[0]),le(-he[1],Me[0])),ue[2]),se(me(se(le(ue[1],he[0]),le(-he[1],ue[0])),-Me[2]),me(se(le(ue[1],Me[0]),le(-Me[1],ue[0])),he[2]))),-Le[3])))),ht=Re(Ze,st);return ht[ht.length-1]}}function G(se){var le=se===3?P:se===4?O:U;return le(p,h,m,w)}var j=G(3),H=G(4),te=[function(){return 0},function(){return 0},function(le,me){return me[0]-le[0]},function(le,me,Re){var xe=(le[1]-Re[1])*(me[0]-Re[0]),ue=(le[0]-Re[0])*(me[1]-Re[1]),Me=xe-ue,he;if(xe>0){if(ue<=0)return Me;he=xe+ue}else if(xe<0){if(ue>=0)return Me;he=-(xe+ue)}else return Me;var ge=x*he;return Me>=ge||Me<=-ge?Me:j(le,me,Re)},function(le,me,Re,xe){var ue=le[0]-xe[0],Me=me[0]-xe[0],he=Re[0]-xe[0],ge=le[1]-xe[1],Le=me[1]-xe[1],Ze=Re[1]-xe[1],st=le[2]-xe[2],ht=me[2]-xe[2],Rt=Re[2]-xe[2],Bt=Me*Ze,At=he*Le,Nt=he*ge,zt=ue*Ze,Tt=ue*Le,ii=Me*ge,Mt=st*(Bt-At)+ht*(Nt-zt)+Rt*(Tt-ii),St=(Math.abs(Bt)+Math.abs(At))*Math.abs(st)+(Math.abs(Nt)+Math.abs(zt))*Math.abs(ht)+(Math.abs(Tt)+Math.abs(ii))*Math.abs(Rt),wt=B*St;return Mt>wt||-Mt>wt?Mt:H(le,me,Re,xe)}];function oe(se){var le=te[se.length];return le||(le=te[se.length]=G(se.length)),le.apply(void 0,se)}function Q(se,le,me,Re,xe,ue,Me){return function(ge,Le,Ze,st,ht){switch(arguments.length){case 0:case 1:return 0;case 2:return Re(ge,Le);case 3:return xe(ge,Le,Ze);case 4:return ue(ge,Le,Ze,st);case 5:return Me(ge,Le,Ze,st,ht)}for(var Rt=new Array(arguments.length),Bt=0;Bt<arguments.length;++Bt)Rt[Bt]=arguments[Bt];return se(Rt)}}function _e(){for(;te.length<=T;)te.push(G(te.length));d.exports=Q.apply(void 0,[oe].concat(te));for(var se=0;se<=T;++se)d.exports[se]=te[se]}_e()})(orientation);var robustPnp=robustPointInPolygon,orient=orientation.exports;function robustPointInPolygon(d,h){for(var p=h[0],m=h[1],w=d.length,T=1,k=w,x=0,B=w-1;x<k;B=x++){var P=d[x],O=d[B],U=P[1],G=O[1];if(G<U){if(G<m&&m<U){var j=orient(P,O,h);if(j===0)return 0;T^=0<j|0}else if(m===U){var H=d[(x+1)%w],te=H[1];if(U<te){var j=orient(P,O,h);if(j===0)return 0;T^=0<j|0}}}else if(U<G){if(U<m&&m<G){var j=orient(P,O,h);if(j===0)return 0;T^=j<0|0}else if(m===U){var H=d[(x+1)%w],te=H[1];if(te<U){var j=orient(P,O,h);if(j===0)return 0;T^=j<0|0}}}else if(m===U){var oe=Math.min(P[0],O[0]),Q=Math.max(P[0],O[0]);if(x===0){for(;B>0;){var _e=(B+w-1)%w,se=d[_e];if(se[1]!==m)break;var le=se[0];oe=Math.min(oe,le),Q=Math.max(Q,le),B=_e}if(B===0)return oe<=p&&p<=Q?0:1;k=B+1}for(var me=d[(B+w-1)%w][1];x+1<k;){var se=d[x+1];if(se[1]!==m)break;var le=se[0];oe=Math.min(oe,le),Q=Math.max(Q,le),x+=1}if(oe<=p&&p<=Q)return 0;var Re=d[(x+1)%w][1];p<oe&&me<m!=Re<m&&(T^=1)}}return 2*T-1}var robustPointInPolygon$1=robustPnp;function feretDiameters(d={}){const{originalPoints:h=monotoneChainConvexHull.call(this)}=d;if(h.length===0)return{min:0,max:0,minLine:[],maxLine:[],aspectRatio:1};if(h.length===1)return{min:1,max:1,minLine:[h[0],h[0]],maxLine:[h[0],h[0]],aspectRatio:1};const p=new Array(h.length);let m=1/0,w=0,T=[];for(let P=0;P<h.length;P++){let O=getAngle(h[P],h[(P+1)%h.length]);rotate(-O,h,p);let U=0,G=[];for(let j=0;j<h.length;j++){let H=Math.abs(p[P][1]-p[j][1]);H>U&&(U=H,G=[],G.push([p[j][0],p[P][1]],[p[j][0],p[j][1]]))}U<m&&(m=U,w=O,T=G)}rotate(w,T,T);let k=0,x=[],B=0;for(let P=0;P<h.length-1;P++)for(let O=P+1;O<h.length;O++){let U=(h[P][0]-h[O][0])**2+(h[P][1]-h[O][1])**2;U>B&&(B=U,k=Math.sqrt(U),x=[h[P],h[O]])}return{min:m,minLine:T,max:k,maxLine:x,aspectRatio:m/k}}function getAngle(d,h){let p=difference(h,d),m=normalize(p),w=Math.acos(m[0]);return m[1]<0?-w:w}class Roi{constructor(h,p){this.map=h,this.id=p,this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.meanX=0,this.meanY=0,this.surface=0,this.computed={}}getMask(h={}){const{scale:p=1,kind:m=""}=h;let w;switch(m){case"contour":w=this.contourMask;break;case"box":w=this.boxMask;break;case"filled":w=this.filledMask;break;case"center":w=this.centerMask;break;case"mbr":w=this.mbrFilledMask;break;case"hull":w=this.convexHullFilledMask;break;case"hullContour":w=this.convexHullMask;break;case"mbrContour":w=this.mbrMask;break;case"feret":w=this.feretMask;break;default:w=this.mask}return p<1&&(w=w.resize({factor:p}),w.parent=this.mask.parent,w.position[0]+=this.minX,w.position[1]+=this.minY),w}get mean(){throw new Error("Roi mean not implemented yet")}get center(){return this.computed.center||(this.computed.center=[this.width/2>>0,this.height/2>>0]),this.computed.center}get ratio(){return this.width/this.height}get width(){return this.maxX-this.minX+1}get height(){return this.maxY-this.minY+1}_computExternalIDs(){let h=this.borderIDs,p=this.borderLengths;this.computed.externalIDs=[],this.computed.externalLengths=[];let m=this.internalIDs;for(let w=0;w<h.length;w++)m.includes(h[w])||(this.computed.externalIDs.push(h[w]),this.computed.externalLengths.push(p[w]))}get externalIDs(){return this.computed.externalIDs?this.computed.externalIDs:(this._computExternalIDs(),this.computed.externalIDs)}get externalLengths(){return this.computed.externalLengths?this.computed.externalLengths:(this._computExternalIDs(),this.computed.externalLengths)}_computeBorderIDs(){let h=getBorders(this);this.computed.borderIDs=h.ids,this.computed.borderLengths=h.lengths}get borderIDs(){return this.computed.borderIDs?this.computed.borderIDs:(this._computeBorderIDs(),this.computed.borderIDs)}get borderLengths(){return this.computed.borderLengths?this.computed.borderLengths:(this._computeBorderIDs(),this.computed.borderLengths)}get boxIDs(){return this.computed.boxIDs||(this.computed.boxIDs=getBoxIDs(this)),this.computed.boxIDs}get internalIDs(){return this.computed.internalIDs||(this.computed.internalIDs=getInternalIDs(this)),this.computed.internalIDs}get box(){return this.computed.box||(this.computed.box=getBox(this)),this.computed.box}get external(){return this.computed.external||(this.computed.external=getExternal(this)),this.computed.external}get holesInfo(){return this.computed.holesInfo||(this.computed.holesInfo=getHolesInfo(this)),this.computed.holesInfo}get border(){return this.computed.border||(this.computed.border=getBorder(this)),this.computed.border}get contourMask(){if(!this.computed.contourMask){let h=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let p=0;p<this.width;p++)for(let m=0;m<this.height;m++)this.map.data[p+this.minX+(m+this.minY)*this.map.width]===this.id&&(p>0&&p<this.width-1&&m>0&&m<this.height-1?(this.map.data[p-1+this.minX+(m+this.minY)*this.map.width]!==this.id||this.map.data[p+1+this.minX+(m+this.minY)*this.map.width]!==this.id||this.map.data[p+this.minX+(m-1+this.minY)*this.map.width]!==this.id||this.map.data[p+this.minX+(m+1+this.minY)*this.map.width]!==this.id)&&h.setBitXY(p,m):h.setBitXY(p,m));this.computed.contourMask=h}return this.computed.contourMask}get boxMask(){if(!this.computed.boxMask){let h=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let p=0;p<this.width;p++)h.setBitXY(p,0),h.setBitXY(p,this.height-1);for(let p=0;p<this.height;p++)h.setBitXY(0,p),h.setBitXY(this.width-1,p);this.computed.boxMask=h}return this.computed.boxMask}get mask(){if(!this.computed.mask){let h=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let p=0;p<this.width;p++)for(let m=0;m<this.height;m++)this.map.data[p+this.minX+(m+this.minY)*this.map.width]===this.id&&h.setBitXY(p,m);this.computed.mask=h}return this.computed.mask}get filledMask(){if(!this.computed.filledMask){let h=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let p=0;p<this.width;p++)for(let m=0;m<this.height;m++){let w=p+this.minX+(m+this.minY)*this.map.width;this.internalIDs.includes(this.map.data[w])&&h.setBitXY(p,m)}this.computed.filledMask=h}return this.computed.filledMask}get centerMask(){if(!this.computed.centerMask){let h=new Shape({kind:"smallCross"}).getMask();h.parent=this.map.parent,h.position=[this.minX+this.center[0]-1,this.minY+this.center[1]-1],this.computed.centerMask=h}return this.computed.centerMask}get convexHull(){if(!this.computed.convexHull){const h=[];for(let m=0;m<this.width;m++)for(let w=0;w<this.height;w++)this.map.data[m+this.minX+(w+this.minY)*this.map.width]===this.id&&(m>0&&m<this.width-1&&w>0&&w<this.height-1?(this.map.data[m-1+this.minX+(w+this.minY)*this.map.width]!==this.id||this.map.data[m+1+this.minX+(w+this.minY)*this.map.width]!==this.id||this.map.data[m+this.minX+(w-1+this.minY)*this.map.width]!==this.id||this.map.data[m+this.minX+(w+1+this.minY)*this.map.width]!==this.id)&&(h.push([m,w]),h.push([m+1,w]),h.push([m,w+1]),h.push([m+1,w+1])):(h.push([m,w]),h.push([m+1,w]),h.push([m,w+1]),h.push([m+1,w+1])));const p=monotoneChainConvexHull$1(h);this.computed.convexHull={polyline:p,surface:surface(p),perimeter:perimeter(p)}}return this.computed.convexHull}get convexHullMask(){if(!this.computed.convexHullMask){const h=this.convexHull,p=new Image$1(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});p.paintPolyline(h.polyline,{closed:!0}),this.computed.convexHullMask=p}return this.computed.convexHullMask}get convexHullFilledMask(){if(!this.computed.convexHullFilledMask){const h=this.convexHull,p=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let m=0;m<this.width;m++)for(let w=0;w<this.height;w++)robustPointInPolygon$1(h.polyline,[m,w])!==1&&p.setBitXY(m,w);this.computed.convexHullFilledMask=p}return this.computed.convexHullFilledMask}get mbr(){if(!this.computed.mbr){let h=minimalBoundingRectangle({originalPoints:this.convexHull.polyline});if(h.length===0)this.computed.mbr={width:0,height:0,surface:0,perimeter:0,rectangle:h};else{let p=h[0],m=h[1],w=h[2],T=Math.sqrt((p[0]-m[0])**2+(p[1]-m[1])**2),k=Math.sqrt((w[0]-m[0])**2+(w[1]-m[1])**2);this.computed.mbr={width:T,height:k,elongation:1-T/k,aspectRatio:T/k,surface:T*k,perimeter:(T+k)*2,rectangle:h}}}return this.computed.mbr}get fillRatio(){return this.surface/(this.surface+this.holesInfo.surface)}get feretDiameters(){return this.computed.feretDiameters||(this.computed.feretDiameters=feretDiameters({originalPoints:this.convexHull.polyline})),this.computed.feretDiameters}get eqpc(){return this.computed.eqpc||(this.computed.eqpc=2*Math.sqrt(this.surface/Math.PI)),this.computed.eqpc}get perimeterInfo(){return this.computed.perimeterInfo||(this.computed.perimeterInfo=getPerimeterInfo(this)),this.computed.perimeterInfo}get perimeter(){let h=this.perimeterInfo,p=2-Math.sqrt(2);return h.one+h.two*2+h.three*3+h.four*4-p*(h.two+h.three*2+h.four)}get ped(){return this.computed.ped||(this.computed.ped=this.perimeter/Math.PI),this.computed.ped}get feretMask(){if(!this.computed.feretMask){const h=new Image$1(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});h.paintPolyline(this.feretDiameters.minLine),h.paintPolyline(this.feretDiameters.maxLine),this.computed.feretMask=h}return this.computed.feretMask}get mbrMask(){if(!this.computed.mbrMask){let h=round(this.mbr.rectangle);if(h.length>0){const p=minMax(h),m=new Image$1(p[1][0]-p[0][0]+1,p[1][1]-p[0][1]+1,{kind:BINARY,position:[this.minX+p[0][0],this.minY+p[0][1]],parent:this.map.parent});h=moveToZeroZero(h),m.paintPolyline(h,{closed:!0}),this.computed.mbrMask=m}else this.computed.mbrMask=new Image$1(1,1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent})}return this.computed.mbrMask}get mbrFilledMask(){if(!this.computed.mbrFilledMask){const h=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),p=this.mask.minimalBoundingRectangle();for(let m=0;m<this.width;m++)for(let w=0;w<this.height;w++)robustPointInPolygon$1(p,[m,w])!==1&&h.setBitXY(m,w);this.computed.mbrFilledMask=h}return this.computed.mbrFilledMask}get points(){if(!this.computed.points){let h=[];for(let p=0;p<this.height;p++)for(let m=0;m<this.width;m++){let w=(p+this.minY)*this.map.width+m+this.minX;this.map.data[w]===this.id&&h.push([m,p])}this.computed.points=h}return this.computed.points}get maxLengthPoints(){if(!this.computed.maxLengthPoints){let h=0,p;const m=this.points;for(let w=0;w<m.length;w++)for(let T=w+1;T<m.length;T++){let k=Math.pow(m[w][0]-m[T][0],2)+Math.pow(m[w][1]-m[T][1],2);k>=h&&(h=k,p=[m[w],m[T]])}this.computed.maxLengthPoints=p}return this.computed.maxLengthPoints}get maxLength(){if(!this.computed.maxLength){let h=Math.sqrt(Math.pow(this.maxLengthPoints[0][0]-this.maxLengthPoints[1][0],2)+Math.pow(this.maxLengthPoints[0][1]-this.maxLengthPoints[1][1],2));this.computed.maxLength=h}return this.computed.maxLength}get roundness(){return 4*this.surface/(Math.PI*this.feretDiameters.max**2)}get sphericity(){return 2*Math.sqrt(this.surface*Math.PI)/this.perimeter}get solidity(){return this.surface/this.convexHull.surface}get angle(){if(!this.computed.angle){let h=this.maxLengthPoints,p=-Math.atan2(h[0][1]-h[1][1],h[0][0]-h[1][0])*180/Math.PI;this.computed.angle=p}return this.computed.angle}toJSON(){return{id:this.id,minX:this.minX,maxX:this.maxX,minY:this.minY,maxY:this.maxY,meanX:this.meanX,meanY:this.meanY,height:this.height,width:this.width,surface:this.surface,mbrWidth:this.mbr.width,mbrHeight:this.mbr.height,mbrSurface:this.mbr.surface,eqpc:this.eqpc,ped:this.ped,feretDiameterMin:this.feretDiameters.min,feretDiameterMax:this.feretDiameters.max,aspectRatio:this.feretDiameters.aspectRatio,fillRatio:this.fillRatio,sphericity:this.sphericity,roundness:this.roundness,solidity:this.solidity,perimeter:this.perimeter}}}function getBorders(d){let h=d.map,p=h.data,m=new Set,w=new Map,T=new Set,k=[1,0,-1,0],x=[0,1,0,-1];for(let O=d.minX;O<=d.maxX;O++)for(let U=d.minY;U<=d.maxY;U++){let G=O+U*h.width;if(p[G]===d.id)for(let j=0;j<4;j++){let H=O+k[j],te=U+x[j];if(H>=0&&te>=0&&H<h.width&&te<h.height){let oe=H+te*h.width;if(p[oe]!==d.id&&!T.has(oe)){T.add(oe),m.add(p[oe]);let Q=w.get(p[oe]);Q?w.set(p[oe],++Q):w.set(p[oe],1)}}}}let B=Array.from(m),P=B.map(function(O){return w.get(O)});return{ids:B,lengths:P}}function getBoxIDs(d){let h=new Set,p=d.map,m=p.data;for(let w of[0,d.height-1])for(let T=0;T<d.width;T++){let k=(w+d.minY)*p.width+T+d.minX;if(T-d.minX>0&&m[k]===d.id&&m[k-1]!==d.id){let x=m[k-1];h.add(x)}if(p.width-T-d.minX>1&&m[k]===d.id&&m[k+1]!==d.id){let x=m[k+1];h.add(x)}}for(let w of[0,d.width-1])for(let T=0;T<d.height;T++){let k=(T+d.minY)*p.width+w+d.minX;if(T-d.minY>0&&m[k]===d.id&&m[k-p.width]!==d.id){let x=m[k-p.width];h.add(x)}if(p.height-T-d.minY>1&&m[k]===d.id&&m[k+p.width]!==d.id){let x=m[k+p.width];h.add(x)}}return Array.from(h)}function getBox(d){let h=0,p=d.map,m=p.data,w=[0];d.height>1&&(w[1]=d.height-1);for(let k of w)for(let x=1;x<d.width-1;x++){let B=(k+d.minY)*p.width+x+d.minX;m[B]===d.id&&h++}let T=[0];d.width>1&&(T[1]=d.width-1);for(let k of T)for(let x=0;x<d.height;x++){let B=(x+d.minY)*p.width+k+d.minX;m[B]===d.id&&h++}return h}function getBorder(d){let h=0,p=d.map,m=p.data;for(let w=1;w<d.width-1;w++)for(let T=1;T<d.height-1;T++){let k=(T+d.minY)*p.width+w+d.minX;m[k]===d.id&&(m[k-1]!==d.id||m[k+1]!==d.id||m[k-p.width]!==d.id||m[k+p.width]!==d.id)&&h++}return h+d.box}function getPerimeterInfo(d){let h=d.map,p=h.data,m=0,w=0,T=0,k=0;for(let x=0;x<d.width;x++)for(let B=0;B<d.height;B++){let P=(B+d.minY)*h.width+x+d.minX;if(p[P]===d.id){let O=0;switch((x===0||d.externalIDs.includes(p[P-1]))&&O++,(x===d.width-1||d.externalIDs.includes(p[P+1]))&&O++,(B===0||d.externalIDs.includes(p[P-h.width]))&&O++,(B===d.height-1||d.externalIDs.includes(p[P+h.width]))&&O++,O){case 1:m++;break;case 2:w++;break;case 3:T++;break;case 4:k++;break}}}return{one:m,two:w,three:T,four:k}}function getExternal(d){let h=0,p=d.map,m=p.data;for(let w=1;w<d.width-1;w++)for(let T=1;T<d.height-1;T++){let k=(T+d.minY)*p.width+w+d.minX;m[k]===d.id&&(d.externalIDs.includes(m[k-1])||d.externalIDs.includes(m[k+1])||d.externalIDs.includes(m[k-p.width])||d.externalIDs.includes(m[k+p.width]))&&h++}return h+d.box}function getHolesInfo(d){let h=0,p=d.map.width,m=d.map.data;for(let w=1;w<d.width-1;w++)for(let T=1;T<d.height-1;T++){let k=(T+d.minY)*p+w+d.minX;d.internalIDs.includes(m[k])&&m[k]!==d.id&&h++}return{number:d.internalIDs.length-1,surface:h}}function getInternalIDs(d){let h=[d.id],p=d.map,m=p.data;if(d.height>2)for(let T=0;T<d.width;T++){let k=d.minY*p.width+T+d.minX;if(h.includes(m[k])){let x=m[k+p.width];!h.includes(x)&&!d.boxIDs.includes(x)&&h.push(x)}}let w=new Array(4);for(let T=1;T<d.width-1;T++)for(let k=1;k<d.height-1;k++){let x=(k+d.minY)*p.width+T+d.minX;if(h.includes(m[x])){w[0]=m[x-1],w[1]=m[x+1],w[2]=m[x-p.width],w[3]=m[x+p.width];for(let B=0;B<4;B++){let P=w[B];!h.includes(P)&&!d.boxIDs.includes(P)&&h.push(P)}}}return h}class RoiLayer{constructor(h,p){this.roiMap=h,this.options=p,this.roi=this.createRoi()}createRoi(){let h=this.roiMap.data,p={};this.roiMap.positive=0,this.roiMap.negative=0;for(let x=0;x<h.length;x++)h[x]&&!p[h[x]]&&(p[h[x]]=!0,h[x]>0?this.roiMap.positive++:this.roiMap.negative++);let m={};for(let x in p)m[x]=new Roi(this.roiMap,x*1);let w=this.roiMap.width,T=this.roiMap.height;for(let x=0;x<T;x++)for(let B=0;B<w;B++){let P=x*w+B;if(h[P]!==0){const O=h[P],U=m[O];B<U.minX&&(U.minX=B),B>U.maxX&&(U.maxX=B),x<U.minY&&(U.minY=x),x>U.maxY&&(U.maxY=x),U.meanX+=B,U.meanY+=x,U.surface++}}let k=[];for(let x in p)m[x].meanX/=m[x].surface,m[x].meanY/=m[x].surface,k.push(m[x]);return k}}function commonBorderLength(d){let h=d.data,p=[1,0,-1,0],m=[0,1,0,-1],w=d.minMax,T=-w.min,k=w.max+T,x=[];for(let P=0;P<=k;P++)x.push(Object.create(null));for(let P=0;P<d.width;P++)for(let O=0;O<d.height;O++){let U=P+O*d.width,G=h[U];if(G!==0){let j=Object.create(null),H=!1;for(let te=0;te<4;te++){let oe=P+p[te],Q=O+m[te];if(oe>=0&&Q>=0&&oe<d.width&&Q<d.height){let _e=h[oe+Q*d.width];G!==_e&&(H=!0,_e!==0&&j[_e]===void 0&&(j[_e]=!0,x[_e+T][G]?x[_e+T][G]++:x[_e+T][G]=1))}else H=!0}H&&(x[G+T][G]?x[G+T][G]++:x[G+T][G]=1)}}let B={};for(let P=0;P<x.length;P++)Object.keys(x[P]).length>0&&(B[P-T]=x[P]);return B}function mergeRoi(d={}){const{algorithm:h="commonBorderLength",minCommonBorderLength:p=5,maxCommonBorderLength:m=100,minCommonBorderRatio:w=.3,maxCommonBorderRatio:T=1}=d;let k=function(oe,Q,_e){return oe[_e]>=p&&oe[_e]<=m};typeof h=="function"&&(k=h),h.toLowerCase()==="commonborderratio"&&(k=function(oe,Q,_e){let se=Math.min(oe[_e]/oe[Q],1);return se>=w&&se<=T});const x=this,B=x.commonBorderLength;let P={},O={};for(let oe of Object.keys(B)){let Q=B[oe],_e=Object.keys(Q);for(let se of _e)if(se!==oe&&k(Q,oe,se)){let le=se;O[se]&&(le=O[se]);let me=oe;if(O[oe]&&(me=O[oe]),Number(le)!==me){let Re=Math.min(le,me),xe=Math.max(le,me);if(P[Re]||(P[Re]={}),P[Re][xe]=!0,O[xe]=Re,P[xe]){for(let ue of Object.keys(P[xe]))P[Re][ue]=!0,O[ue]=Re;delete P[xe]}}}}let U=x.minMax,G=-U.min,j=U.max+G,H=new Array(j+1).fill(0);for(let oe of Object.keys(O))H[Number(oe)+G]=O[oe];let te=x.data;for(let oe=0;oe<te.length;oe++){let Q=te[oe];if(Q!==0){let _e=H[Q+G];_e!==0&&(te[oe]=_e)}}return x.computed={},x}class RoiMap{constructor(h,p){this.parent=h,this.width=h.width,this.height=h.height,this.data=p,this.negative=0,this.positive=0}get total(){return this.negative+this.positive}get minMax(){let h=Number.MAX_SAFE_INTEGER,p=Number.MIN_SAFE_INTEGER;for(let m=0;m<this.data.length;m++)this.data[m]<h&&(h=this.data[m]),this.data[m]>p&&(p=this.data[m]);return{min:h,max:p}}get commonBorderLength(){return commonBorderLength(this)}mergeRoi(h={}){return mergeRoi.call(this,h)}mergeRois(h){const p=h[0],m=h.slice(1);for(let w=0;w<this.data.length;w++)m.includes(this.data[w])&&(this.data[w]=p)}rowsInfo(){let h=new Array(this.height),p=0;for(let m=0;m<this.data.length;m+=this.width){let w={row:p,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};h[p++]=w;let T={},k={},x=[],B=this.data[m],P=0;for(let O=m;O<m+this.width;O++){let U=this.data[O];B!==U&&(B=U,x.push(P),P=0),P++,U>0?(w.positivePixel++,T[U]||(T[U]=!0)):U<0?(w.negativePixel++,k[U]||(k[U]=!0)):w.zeroPixel++}x.push(P),w.medianChange=x.sort((O,U)=>O-U)[Math.floor(x.length/2)],w.positiveRoiIDs=Object.keys(T),w.negativeRoiIDs=Object.keys(k),w.positiveRoi=w.positiveRoiIDs.length,w.negativeRoi=w.negativeRoiIDs.length}return h}colsInfo(){let h=new Array(this.width),p=0;for(let m=0;m<this.width;m++){let w={col:p,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};h[p++]=w;let T={},k={},x=[],B=this.data[m],P=0;for(let O=m;O<m+this.data.length;O+=this.width){let U=this.data[O];B!==U&&(B=U,x.push(P),P=0),P++,U>0?(w.positivePixel++,T[U]||(T[U]=!0)):U<0?(w.negativePixel++,k[U]||(k[U]=!0)):w.zeroPixel++}x.push(P),w.medianChange=x.sort((O,U)=>O-U)[Math.floor(x.length/2)],w.positiveRoiIDs=Object.keys(T),w.negativeRoiIDs=Object.keys(k),w.positiveRoi=w.positiveRoiIDs.length,w.negativeRoi=w.negativeRoiIDs.length}return h}}function fromMask(d,h={}){const{allowCorners:p=!1}=h,m=65535;let w=new Int16Array(d.size),T=0,k=0,x=new Uint16Array(m+1),B=new Uint16Array(m+1);for(let O=0;O<d.width;O++)for(let U=0;U<d.height;U++)w[U*d.width+O]===0&&P(O,U);function P(O,U){let G=0,j=0,H=d.getBitXY(O,U),te=H?++T:--k;if(T>32767||k<-32768)throw new Error("Too many regions of interest");for(x[0]=O,B[0]=U;G<=j;){let oe=x[G&m],Q=B[G&m];if(w[Q*d.width+oe]=te,oe>0&&w[Q*d.width+oe-1]===0&&d.getBitXY(oe-1,Q)===H&&(j++,x[j&m]=oe-1,B[j&m]=Q,w[Q*d.width+oe-1]=-32768),Q>0&&w[(Q-1)*d.width+oe]===0&&d.getBitXY(oe,Q-1)===H&&(j++,x[j&m]=oe,B[j&m]=Q-1,w[(Q-1)*d.width+oe]=-32768),oe<d.width-1&&w[Q*d.width+oe+1]===0&&d.getBitXY(oe+1,Q)===H&&(j++,x[j&m]=oe+1,B[j&m]=Q,w[Q*d.width+oe+1]=-32768),Q<d.height-1&&w[(Q+1)*d.width+oe]===0&&d.getBitXY(oe,Q+1)===H&&(j++,x[j&m]=oe,B[j&m]=Q+1,w[(Q+1)*d.width+oe]=-32768),p&&(oe>0&&Q>0&&w[(Q-1)*d.width+oe-1]===0&&d.getBitXY(oe-1,Q-1)===H&&(j++,x[j&m]=oe-1,B[j&m]=Q-1,w[(Q-1)*d.width+oe-1]=-32768),oe<d.width-1&&Q>0&&w[(Q-1)*d.width+oe+1]===0&&d.getBitXY(oe+1,Q-1)===H&&(j++,x[j&m]=oe+1,B[j&m]=Q-1,w[(Q-1)*d.width+oe+1]=-32768),oe>0&&Q<d.height-1&&w[(Q+1)*d.width+oe-1]===0&&d.getBitXY(oe-1,Q+1)===H&&(j++,x[j&m]=oe-1,B[j&m]=Q+1,w[(Q+1)*d.width+oe-1]=-32768),oe<d.width-1&&Q<d.height-1&&w[(Q+1)*d.width+oe+1]===0&&d.getBitXY(oe+1,Q+1)===H&&(j++,x[j&m]=oe+1,B[j&m]=Q+1,w[(Q+1)*d.width+oe+1]=-32768)),G++,j-G>m)throw new Error("analyseMask can not finish, the array to manage internal data is not big enough.You could improve mask by changing MAX_ARRAY")}}return new RoiMap(d,w)}class DisjointSet{constructor(){this.nodes=new Map}add(h){var p=this.nodes.get(h);return p||(p=new DisjointSetNode(h),this.nodes.set(h,p)),p}union(h,p){const m=this.find(h),w=this.find(p);m!==w&&(m.rank<w.rank?m.parent=w:m.rank>w.rank?w.parent=m:(w.parent=m,m.rank++))}find(h){for(var p=h;p.parent!==null;)p=p.parent;for(var m=h;m.parent!==null;){var w=m;m=m.parent,w.parent=p}return p}connected(h,p){return this.find(h)===this.find(p)}}var DisjointSet_1=DisjointSet;function DisjointSetNode(d){this.value=d,this.parent=null,this.rank=0}var DisjointSet$1=DisjointSet_1;const direction4X=[-1,0],direction4Y=[0,-1],neighbours4=[null,null],direction8X=[-1,-1,0,1],direction8Y=[0,-1,-1,-1],neighbours8=[null,null,null,null];function fromMaskConnectedComponentLabelingAlgorithm(d,h={}){const{allowCorners:p=!1}=h;let m=4;p&&(m=8);let w,T,k;if(m===8)w=direction8X,T=direction8Y,k=neighbours8;else if(m===4)w=direction4X,T=direction4Y,k=neighbours4;else throw new RangeError(`unsupported neighbours count: ${m}`);const x=d.size,B=d.width,P=d.height,O=new Array(x),U=new Uint32Array(x),G=new DisjointSet$1;let j=1;for(let H=0;H<P;H++)for(let te=0;te<B;te++){const oe=te+H*B;if(d.getBit(oe)){let Q=null;for(let _e=0;_e<k.length;_e++){const se=te+w[_e],le=H+T[_e];if(se>=0&&le>=0&&se<B&&le<P){const me=se+le*B;let Re=O[me];Re?(k[_e]=Re,(!Q||k[_e].value<Q.value)&&(Q=k[_e])):k[_e]=null}}if(!Q)O[oe]=G.add(j++);else{O[oe]=Q;for(let _e=0;_e<k.length;_e++)k[_e]&&k[_e]!==Q&&G.union(Q,k[_e])}}}for(let H=0;H<P;H++)for(let te=0;te<B;te++){const oe=te+H*B;d.getBit(oe)&&(U[oe]=G.find(O[oe]).value)}return new RoiMap(d,U)}function fromMaxima(d={}){let{allowCorner:h=!0,onlyTop:p=!1,invert:m=!1}=d,w=this;w.checkProcessable("fromMaxima",{components:[1]});const T=1,k=2;let x=0,B=0,P=new Int16Array(w.size),O=new Int8Array(w.size),U=new Float32Array(w.size),G=1048575,j=new Uint16Array(G+1),H=new Uint16Array(G+1),te=0,oe=0,Q=new Uint16Array(G+1),_e=new Uint16Array(G+1),se=0,le=0;for(me(w);te<oe;){let ue=j[te&G],Me=H[te&G];xe(ue,Me,k),te++}return new RoiMap(w,P);function me({maxima:ue=!0}){for(let Me=1;Me<w.height-1;Me++)for(let he=1;he<w.width-1;he++){let ge=he+Me*w.width;if(O[ge]===0){let Le=ue?w.data[ge]:-w.data[he+Me*w.width];if(w.data[Me*w.width+he-1]>Le||w.data[Me*w.width+he+1]>Le||w.data[(Me-1)*w.width+he]>Le||w.data[(Me+1)*w.width+he]>Le||h&&(w.data[(Me-1)*w.width+he-1]>Le||w.data[(Me-1)*w.width+he+1]>Le||w.data[(Me+1)*w.width+he-1]>Le||w.data[(Me+1)*w.width+he+1]>Le))continue;P[ge]=ue?++x:--B,Re(he,Me)||(ue?--x:++B)}}}function Re(ue,Me){let he=oe;se=0,le=1,Q[0]=ue,_e[0]=Me;let ge=!0;for(;se<le;){let Le=Q[se&G],Ze=_e[se&G];ge&=xe(Le,Ze,T),se++}if(!ge){for(let Le=0;Le<le;Le++){let Ze=Q[Le&G],ht=_e[Le&G]*w.width+Ze;P[ht]=0}oe=he}return ge}function xe(ue,Me,he){let ge=P[Me*w.width+ue],Le=w.data[Me*w.width+ue];for(let Ze=Me-1;Ze<=Me+1;Ze++)for(let st=ue-1;st<=ue+1;st++){let ht=Ze*w.width+st;if(O[ht]===0)switch(O[ht]=1,U[ht]=w.data[ht]-Le,he){case T:if(U[ht]===0){if(st===0||Ze===0||st===w.width-1||Ze===w.height-1)return!1;P[ht]=ge,Q[le&G]=st,_e[le&G]=Ze,le++}else{if(U[ht]>0)return!1;p||(P[ht]=ge,j[oe&G]=st,H[oe&G]=Ze,oe++)}break;case k:U[ht]<=0&&(P[ht]=ge,j[oe&G]=st,H[oe&G]=Ze,oe++);break;default:throw new Error("unreachable")}}return!0}}function fromPoints(d,h={}){let p=new Shape(h),m=new Int16Array(this.size),w=0,T=p.getPoints();for(let k=0;k<d.length;k++){w++;let x=d[k][0],B=d[k][1];for(let P=0;P<T.length;P++){let O=T[P][0],U=T[P][1];x+O>=0&&B+U>=0&&x+O<this.width&&B+U<this.height&&(m[x+O+(B+U)*this.width]=w)}}return new RoiMap(this,m)}var priorityQueue={exports:{}};(function(d,h){(function(p){d.exports=p()})(function(){return function p(m,w,T){function k(P,O){if(!w[P]){if(!m[P]){var U=typeof commonjsRequire=="function"&&commonjsRequire;if(!O&&U)return U(P,!0);if(x)return x(P,!0);var G=new Error("Cannot find module '"+P+"'");throw G.code="MODULE_NOT_FOUND",G}var j=w[P]={exports:{}};m[P][0].call(j.exports,function(H){var te=m[P][1][H];return k(te||H)},j,j.exports,p,m,w,T)}return w[P].exports}for(var x=typeof commonjsRequire=="function"&&commonjsRequire,B=0;B<T.length;B++)k(T[B]);return k}({1:[function(p,m,w){var T,k,x,B,P,O=function(G,j){for(var H in j)U.call(j,H)&&(G[H]=j[H]);function te(){this.constructor=G}return te.prototype=j.prototype,G.prototype=new te,G.__super__=j.prototype,G},U={}.hasOwnProperty;T=p("./PriorityQueue/AbstractPriorityQueue"),k=p("./PriorityQueue/ArrayStrategy"),B=p("./PriorityQueue/BinaryHeapStrategy"),x=p("./PriorityQueue/BHeapStrategy"),P=function(G){O(j,G);function j(H){H||(H={}),H.strategy||(H.strategy=B),H.comparator||(H.comparator=function(te,oe){return(te||0)-(oe||0)}),j.__super__.constructor.call(this,H)}return j}(T),P.ArrayStrategy=k,P.BinaryHeapStrategy=B,P.BHeapStrategy=x,m.exports=P},{"./PriorityQueue/AbstractPriorityQueue":2,"./PriorityQueue/ArrayStrategy":3,"./PriorityQueue/BHeapStrategy":4,"./PriorityQueue/BinaryHeapStrategy":5}],2:[function(p,m,w){m.exports=function(){function T(k){var x;if((k!=null?k.strategy:void 0)==null)throw"Must pass options.strategy, a strategy";if((k!=null?k.comparator:void 0)==null)throw"Must pass options.comparator, a comparator";this.priv=new k.strategy(k),this.length=(k!=null&&(x=k.initialValues)!=null?x.length:void 0)||0}return T.prototype.queue=function(k){this.length++,this.priv.queue(k)},T.prototype.dequeue=function(k){if(!this.length)throw"Empty queue";return this.length--,this.priv.dequeue()},T.prototype.peek=function(k){if(!this.length)throw"Empty queue";return this.priv.peek()},T.prototype.clear=function(){return this.length=0,this.priv.clear()},T}()},{}],3:[function(p,m,w){var T;T=function(k,x,B){var P,O,U;for(O=0,P=k.length;O<P;)U=O+P>>>1,B(k[U],x)>=0?O=U+1:P=U;return O},m.exports=function(){function k(x){var B;this.options=x,this.comparator=this.options.comparator,this.data=((B=this.options.initialValues)!=null?B.slice(0):void 0)||[],this.data.sort(this.comparator).reverse()}return k.prototype.queue=function(x){var B;B=T(this.data,x,this.comparator),this.data.splice(B,0,x)},k.prototype.dequeue=function(){return this.data.pop()},k.prototype.peek=function(){return this.data[this.data.length-1]},k.prototype.clear=function(){this.data.length=0},k}()},{}],4:[function(p,m,w){m.exports=function(){function T(k){var x,B,P,O,U,G,j,H;for(this.comparator=(k!=null?k.comparator:void 0)||function(te,oe){return te-oe},this.pageSize=(k!=null?k.pageSize:void 0)||512,this.length=0,j=0;1<<j<this.pageSize;)j+=1;if(1<<j!==this.pageSize)throw"pageSize must be a power of two";for(this._shift=j,this._emptyMemoryPageTemplate=x=[],B=0,U=this.pageSize;0<=U?B<U:B>U;0<=U?++B:--B)x.push(null);if(this._memory=[],this._mask=this.pageSize-1,k.initialValues)for(G=k.initialValues,P=0,O=G.length;P<O;P++)H=G[P],this.queue(H)}return T.prototype.queue=function(k){this.length+=1,this._write(this.length,k),this._bubbleUp(this.length,k)},T.prototype.dequeue=function(){var k,x;return k=this._read(1),x=this._read(this.length),this.length-=1,this.length>0&&(this._write(1,x),this._bubbleDown(1,x)),k},T.prototype.peek=function(){return this._read(1)},T.prototype.clear=function(){this.length=0,this._memory.length=0},T.prototype._write=function(k,x){var B;for(B=k>>this._shift;B>=this._memory.length;)this._memory.push(this._emptyMemoryPageTemplate.slice(0));return this._memory[B][k&this._mask]=x},T.prototype._read=function(k){return this._memory[k>>this._shift][k&this._mask]},T.prototype._bubbleUp=function(k,x){var B,P,O,U;for(B=this.comparator;k>1&&(P=k&this._mask,k<this.pageSize||P>3?O=k&~this._mask|P>>1:P<2?(O=k-this.pageSize>>this._shift,O+=O&~(this._mask>>1),O|=this.pageSize>>1):O=k-2,U=this._read(O),!(B(U,x)<0));)this._write(O,x),this._write(k,U),k=O},T.prototype._bubbleDown=function(k,x){var B,P,O,U,G;for(G=this.comparator;k<this.length;)if(k>this._mask&&!(k&this._mask-1)?B=P=k+2:k&this.pageSize>>1?(B=(k&~this._mask)>>1,B|=k&this._mask>>1,B=B+1<<this._shift,P=B+1):(B=k+(k&this._mask),P=B+1),B!==P&&P<=this.length)if(O=this._read(B),U=this._read(P),G(O,x)<0&&G(O,U)<=0)this._write(B,x),this._write(k,O),k=B;else if(G(U,x)<0)this._write(P,x),this._write(k,U),k=P;else break;else if(B<=this.length)if(O=this._read(B),G(O,x)<0)this._write(B,x),this._write(k,O),k=B;else break;else break},T}()},{}],5:[function(p,m,w){m.exports=function(){function T(k){var x;this.comparator=(k!=null?k.comparator:void 0)||function(B,P){return B-P},this.length=0,this.data=((x=k.initialValues)!=null?x.slice(0):void 0)||[],this._heapify()}return T.prototype._heapify=function(){var k,x,B;if(this.data.length>0)for(k=x=1,B=this.data.length;1<=B?x<B:x>B;k=1<=B?++x:--x)this._bubbleUp(k)},T.prototype.queue=function(k){this.data.push(k),this._bubbleUp(this.data.length-1)},T.prototype.dequeue=function(){var k,x;return x=this.data[0],k=this.data.pop(),this.data.length>0&&(this.data[0]=k,this._bubbleDown(0)),x},T.prototype.peek=function(){return this.data[0]},T.prototype.clear=function(){this.length=0,this.data.length=0},T.prototype._bubbleUp=function(k){for(var x,B;k>0&&(x=k-1>>>1,this.comparator(this.data[k],this.data[x])<0);)B=this.data[x],this.data[x]=this.data[k],this.data[k]=B,k=x},T.prototype._bubbleDown=function(k){var x,B,P,O,U;for(x=this.data.length-1;B=(k<<1)+1,O=B+1,P=k,B<=x&&this.comparator(this.data[B],this.data[P])<0&&(P=B),O<=x&&this.comparator(this.data[O],this.data[P])<0&&(P=O),P!==k;)U=this.data[P],this.data[P]=this.data[k],this.data[k]=U,k=P},T}()},{}]},{},[1])(1)})})(priorityQueue);var PriorityQueue=priorityQueue.exports;const dxs=[1,0,-1,0,1,1,-1,-1],dys=[0,1,0,-1,1,-1,1,-1];function fromWaterShed(d={}){let{points:h,mask:p,image:m,fillMaxValue:w=this.maxValue,invert:T=!1}=d,k=m||this;k.checkProcessable("fromWaterShed",{bitDepth:[8,16],components:1}),T=!T,h||(h=k.getLocalMaxima({invert:T,mask:p}));let x=T?0:1,B=new Int16Array(k.size),P=k.width,O=k.height,U=new PriorityQueue({comparator:(G,j)=>G[2]-j[2],strategy:PriorityQueue.BinaryHeapStrategy});for(let G=0;G<h.length;G++){let j=h[G][0]+h[G][1]*P;B[j]=G+1;let H=k.data[j];(T&&H<=w||!T&&H>=w)&&U.queue([h[G][0],h[G][1],H])}for(;U.length>0;){let G=U.dequeue(),j=G[0]+G[1]*P;for(let H=0;H<4;H++){let te=G[0]+dxs[H],oe=G[1]+dys[H];if(te>=0&&oe>=0&&te<P&&oe<O){let Q=te+oe*P;if(!p||p.getBit(Q)===x){let _e=k.data[Q];(T&&_e<=w||!T&&_e>=w)&&B[Q]===0&&(B[Q]=B[j],U.queue([G[0]+dxs[H],G[1]+dys[H],_e]))}}}}return new RoiMap(k,B)}class RoiManager{constructor(h,p={}){this._image=h,this._options=p,this._options.label||(this._options.label="default"),this._layers={},this._painted=null}fromMaxima(h={}){let p=Object.assign({},this._options,h),m=fromMaxima.call(this._image,h);this._layers[p.label]=new RoiLayer(m,p)}fromPoints(h,p={}){let m=Object.assign({},this._options,p),w=fromPoints.call(this._image,h,p);return this._layers[m.label]=new RoiLayer(w,m),this}putMap(h,p={}){let m=new RoiMap(this._image,h),w=Object.assign({},this._options,p);return this._layers[w.label]=new RoiLayer(m,w),this}fromWaterShed(h={}){let p=Object.assign({},this._options,h),m=fromWaterShed.call(this._image,h);this._layers[p.label]=new RoiLayer(m,p)}fromMask(h,p={}){let m=Object.assign({},this._options,p),w=fromMask.call(this._image,h,p);return this._layers[m.label]=new RoiLayer(w,m),this}fromMaskConnectedComponentLabelingAlgorithm(h,p={}){let m=Object.assign({},this._options,p),w=fromMaskConnectedComponentLabelingAlgorithm.call(this._image,h,p);return this._layers[m.label]=new RoiLayer(w,m),this}getMap(h={}){let p=Object.assign({},this._options,h);return this._assertLayerWithLabel(p.label),this._layers[p.label].roiMap}rowsInfo(h={}){return this.getMap(h).rowsInfo()}colsInfo(h={}){return this.getMap(h).rowsInfo()}getRoiIds(h={}){let p=this.getRois(h);if(p){let m=new Array(p.length);for(let w=0;w<p.length;w++)m[w]=p[w].id;return m}throw new Error("ROIs not found")}getRois(h={}){let{label:p=this._options.label,positive:m=!0,negative:w=!0,minSurface:T=0,maxSurface:k=Number.POSITIVE_INFINITY,minWidth:x=0,maxWidth:B=Number.POSITIVE_INFINITY,minHeight:P=0,maxHeight:O=Number.POSITIVE_INFINITY,minRatio:U=0,maxRatio:G=Number.POSITIVE_INFINITY}=h;if(!this._layers[p])throw new Error(`this Roi layer (${p}) does not exist`);const j=this._layers[p].roi,H=[];for(const te of j)(te.id<0&&w||te.id>0&&m)&&te.surface>=T&&te.surface<=k&&te.width>=x&&te.width<=B&&te.height>=P&&te.height<=O&&te.ratio>=U&&te.ratio<=G&&H.push(te);return H}getRoi(h,p={}){const{label:m=this._options.label}=p;if(!this._layers[m])throw new Error(`this Roi layer (${m}) does not exist`);const w=this._layers[m].roi.find(T=>T.id===h);if(!w)throw new Error(`found no Roi with id ${h}`);return w}getMasks(h={}){let p=this.getRois(h),m=new Array(p.length);for(let w=0;w<p.length;w++)m[w]=p[w].getMask(h);return m}getAnalysisMasks(h={}){const{analysisProperty:p}=h;let m=`${p}Mask`,w=this.getRois(h);return w.length===0||!w[0][m]?[]:w.map(T=>T[m])}getData(h={}){let p=Object.assign({},this._options,h);return this._assertLayerWithLabel(p.label),this._layers[p.label].roiMap.data}paint(h={}){let{labelProperty:p,analysisProperty:m}=h;this._painted||(this._painted=this._image.rgba8());let w=this.getMasks(h);if(p){const T=this.getRois(h);h.labels=T.map(P=>deepValue(P,p));const k=Math.max(...h.labels);let x=!1,B=!1;if(p.includes("surface")?x=!0:/(?:perimeter|min|max|external|width|height|length)/.test(p)&&(B=!0),isFinite(k)){let P="";if(h.unit!=="pixel"&&h.pixelSize&&(B||x)){P=x?`${h.unit}^2`:h.unit;let O=x?"m^2":"m",U=x?h.pixelSize**2:h.pixelSize;const G=Qty.swiftConverter(O,P);h.labels=h.labels.map(j=>G(U*j))}k>50?h.labels=h.labels.map(O=>Math.round(O)+P):k>10?h.labels=h.labels.map(O=>O.toFixed(1)+P):h.labels=h.labels.map(O=>O.toFixed(2)+P)}h.labelsPosition=T.map(P=>[P.meanX,P.meanY])}if(this._painted.paintMasks(w,h),m){let T=this.getAnalysisMasks(h);this._painted.paintMasks(T,{color:h.analysisColor,alpha:h.analysisAlpha})}return this._painted}getMask(h={}){let p=new Image$1(this._image.width,this._image.height,{kind:"BINARY"}),m=this.getMasks(h);for(let w=0;w<m.length;w++){let T=m[w];for(let k=0;k<T.width;k++)for(let x=0;x<T.height;x++)T.getBitXY(k,x)&&p.setBitXY(k+T.position[0],x+T.position[1])}return p}resetPainted(h={}){const{image:p}=h;p?this._painted=this.image.rgba8():this._painted=this._image.rgba8()}mergeRoi(h={}){const p=this.getMap(h);return p.mergeRoi(h),this.putMap(p.data,h),this}mergeRois(h,p={}){if(!Array.isArray(h)||h.some(w=>!Number.isInteger(w)))throw new Error("Roi ids must be an array of integers");if(h.length<2)throw new Error("Roi ids must have at least two elements");if(new Set(h).size!==h.length)throw new Error("Roi ids must be all different");h.forEach(w=>this.getRoi(w));const m=this.getMap(p);return m.mergeRois(h),this.putMap(m.data,p),this}findCorrespondingRoi(h,p={}){let m=this.getRois(p),w=[];for(let T=0;T<m.length;T++){let k=m[T],x=k.minX,B=k.minY,P=k.points,O=Math.sign(k.id),U=correspondingRoisInformation(x,B,P,h,O);w.push(U)}return w}_assertLayerWithLabel(h){if(!this._layers[h])throw new Error(`no layer with label ${h}`)}}function correspondingRoisInformation(d,h,p,m,w){let T={id:[],surface:[],roiSurfaceCovered:[],same:0,opposite:0,total:0};for(let k=0;k<p.length;k++){let x=p[k],B=x[0],P=x[1],O=B+d+(P+h)*m.width,U=m.data[O];(U>0||U<0)&&(T.id.includes(U)?T.surface[T.id.indexOf(U)]+=1:(T.id.push(U),T.surface.push(1)))}for(let k=0;k<T.id.length;k++)Math.sign(T.id[k])===w?T.same+=T.surface[k]:T.opposite+=T.surface[k],T.roiSurfaceCovered[k]=T.surface[k]/p.length;return T.total=T.opposite+T.same,T}const objectToString$1=Object.prototype.toString;class Image$1{constructor(h,p,m,w){if(arguments.length===1?(w=h,{width:h,height:p,data:m}=w):m&&!m.length&&(w=m,{data:m}=w),h===void 0&&(h=1),p===void 0&&(p=1),w===void 0&&(w={}),typeof w!="object"||w===null)throw new TypeError("options must be an object");if(!Number.isInteger(h)||h<=0)throw new RangeError("width must be a positive integer");if(!Number.isInteger(p)||p<=0)throw new RangeError("height must be a positive integer");const{kind:T=RGBA}=w;if(typeof T!="string")throw new TypeError("kind must be a string");const k=getKind(T),x=Object.assign({},w);for(const te in k)x[te]===void 0&&(x[te]=k[te]);verifyKindDefinition(x);const{components:B,bitDepth:P,colorModel:O}=x,U=x.alpha+0,G=h*p,j=B+U,H=P===32?Number.MAX_VALUE:2**P-1;if(m===void 0)m=createPixelArray(G,B,U,j,P,H);else{const te=getTheoreticalPixelArraySize(G,j,P);if(m.length!==te)throw new RangeError(`incorrect data size: ${m.length}. Should be ${te}`)}this.width=h,this.height=p,this.data=m,this.size=G,this.components=B,this.alpha=U,this.bitDepth=P,this.maxValue=H,this.colorModel=O,this.channels=j,this.meta=w.meta||{},Object.defineProperty(this,"parent",{enumerable:!1,writable:!0,configurable:!0,value:w.parent||null}),this.position=w.position||[0,0],this.computed=null,this.sizes=[this.width,this.height],this.multiplierX=this.channels,this.multiplierY=this.channels*this.width,this.isClamped=this.bitDepth<32,this.borderSizes=[0,0]}get[Symbol.toStringTag](){return"IJSImage"}static isImage(h){return objectToString$1.call(h)==="[object IJSImage]"}static fromCanvas(h){const m=h.getContext("2d").getImageData(0,0,h.width,h.height);return new Image$1(m.width,m.height,m.data)}static createFrom(h,p){const m=getImageParameters(h);return Object.assign(m,{parent:h,position:[0,0]},p),new Image$1(m)}getRoiManager(h){return new RoiManager(this,h)}clone(){const h=this.data.slice();return new Image$1(this.width,this.height,h,this)}apply(h){for(let p=0;p<this.height;p++)for(let m=0;m<this.width;m++){let w=(p*this.width+m)*this.channels;h.call(this,w)}}}setValueMethods(Image$1);setBitMethods(Image$1);setExportMethods(Image$1);Image$1.prototype.checkProcessable=checkProcessable;Image$1.prototype.getRGBAData=getRGBAData;Image$1.load=load;Image$1.extendMethod=extendMethod;Image$1.extendProperty=extendProperty;extend$4(Image$1);var workerTemplate$1={},worker$1=function(){self.window=self;function d(){this._listeners={}}d.prototype.on=function(p,m){if(this._listeners[p])throw new RangeError("there is already a listener for "+p);if(typeof m!="function")throw new TypeError("callback argument must be a function");this._listeners[p]=m},d.prototype._send=function(p,m,w){w===void 0?w=[]:Array.isArray(w)||(w=[w]),self.postMessage({id:p,data:m},w)},d.prototype._trigger=function(p,m){if(!this._listeners[p])throw new Error("event "+p+" is not defined");this._listeners[p].apply(null,m)};var h=new d;self.onmessage=function(p){switch(p.data.action){case"exec":p.data.args.unshift(function(m,w){h._send(p.data.id,m,w)}),h._trigger(p.data.event,p.data.args);break;case"ping":h._send(p.data.id,"pong");break;default:throw new Error("unexpected action: "+p.data.action)}}},workerStr=worker$1.toString().split('"CODE";');workerTemplate$1.newWorkerURL=function d(h,p){var m=new Blob(["(",workerStr[0],"importScripts.apply(self, "+JSON.stringify(p)+`);
`,"(",h,")();",workerStr[1],")();"],{type:"application/javascript"});return URL.createObjectURL(m)};var workerTemplate=workerTemplate$1,CORES=navigator.hardwareConcurrency||1;function WorkerManager(d,h){if(typeof d!="string"&&typeof d!="function")throw new TypeError("func argument must be a function");if(h===void 0&&(h={}),typeof h!="object"||h===null)throw new TypeError("options argument must be an object");this._workerCode=d.toString(),h.maxWorkers===void 0||h.maxWorkers==="auto"?this._numWorkers=Math.min(CORES-1,1):h.maxWorkers>0?this._numWorkers=Math.min(h.maxWorkers,CORES):this._numWorkers=CORES,this._workers=new Map,this._timeout=h.timeout||0,this._terminateOnError=!!h.terminateOnError;var p=h.deps;typeof p=="string"&&(p=[p]),Array.isArray(p)||(p=void 0),this._id=0,this._terminated=!1,this._working=0,this._waiting=[],this._init(p)}WorkerManager.prototype._init=function(d){for(var h=workerTemplate.newWorkerURL(this._workerCode,d),p=0;p<this._numWorkers;p++){var m=new Worker(h);m.onmessage=this._onmessage.bind(this,m),m.onerror=this._onerror.bind(this,m),m.running=!1,m.id=p,this._workers.set(m,null)}URL.revokeObjectURL(h)};WorkerManager.prototype._onerror=function(d,h){if(!this._terminated){this._working--,d.running=!1;var p=this._workers.get(d);p&&p[1](h.message),this._workers.set(d,null),this._terminateOnError?this.terminate():this._exec()}};WorkerManager.prototype._onmessage=function(d,h){if(!this._terminated){this._working--,d.running=!1;var p=this._workers.get(d);p&&p[0](h.data.data),this._workers.set(d,null),this._exec()}};WorkerManager.prototype._exec=function(){for(var d of this._workers.keys()){if(this._working===this._numWorkers||this._waiting.length===0)return;if(!d.running)for(var h=0;h<this._waiting.length;h++){var p=this._waiting[h];if(!(typeof p[4]=="number"&&p[4]!==d.id)){this._waiting.splice(h,1),d.postMessage({action:"exec",event:p[0],args:p[1]},p[2]),d.running=!0,d.time=Date.now(),this._workers.set(d,p[3]),this._working++;break}}}};WorkerManager.prototype.terminate=function(){if(!this._terminated){for(var d of this._workers)d[0].terminate(),d[1]&&d[1][1](new Error("Terminated"));this._workers.clear(),this._waiting=[],this._working=0,this._terminated=!0}};WorkerManager.prototype.postAll=function(d,h){if(this._terminated)throw new Error("Cannot post (terminated)");var p=[];for(var m of this._workers.keys())p.push(this.post(d,h,[],m.id));return Promise.all(p)};WorkerManager.prototype.post=function(d,h,p,m){h===void 0&&(h=[]),p===void 0&&(p=[]),Array.isArray(h)||(h=[h]),Array.isArray(p)||(p=[p]);var w=this;return new Promise(function(T,k){if(w._terminated)throw new Error("Cannot post (terminated)");w._waiting.push([d,h,p,[T,k],m]),w._exec()})};var src=WorkerManager;const defaultOptions={regression:{kernelType:"polynomial",kernelOptions:{degree:2,constant:1}},threshold:.02,roi:{minSurface:100,positive:!1},sampling:20,include:[]};function run(d,h,p){h=Object.assign({},defaultOptions,h);const m=this.manager;return Array.isArray(d)?Promise.all(d.map(function(w){const T=runOnce(m,w,h);return typeof p=="function"&&T.then(p),T})):runOnce(m,d,h)}function runOnce(d,h,p){return d.post("data",[h,p]).then(function(m){for(let w in m)m[w]=new Image$1(m[w]);return m})}function work(){worker.on("data",function(d,h,p){h=new IJS(h);const m={},w=[],T=h.grey(),k=T.sobelFilter();j("sobel",k);const x=k.level().mask({threshold:p.threshold});j("mask",x);const B=k.getRoiManager();B.fromMask(x);const P=B.getMask(p.roi);j("realMask",P);const O=T.getPixelsGrid({sampling:p.sampling,mask:P}),U=h.getBackground(O.xyS,O.zS,p.regression);j("background",U);const G=h.subtract(U);m.result=G,w.push(G.data.buffer),d(m,w);function j(H,te){p.include.includes(H)&&(m[H]=te,w.push(te.data.buffer))}})}const background={run,work};function extend$3(d){d.extendMethod("background",background)}class Worker$1{constructor(){this._url=null,this._deps=[null]}checkUrl(){if(this._url===null)throw new Error("image worker must be initialized with an URL")}get url(){return this._url}set url(h){if(typeof h!="string")throw new TypeError("worker URL must be a string");this._url=h,this._deps[0]=h}static extendMethod(h,p){let m,w,T={};function k(...x){return m||(this.checkUrl(),w=this.url,m=new src(p.work,{deps:w}),T.manager=m),p.run.call(T,...x)}k.reset=function(){m&&(m.terminate(),m=new src(p.work,{deps:w}),T.manager=m)},Worker$1.prototype[h]=k}}extend$3(Worker$1);new Worker$1;function getFileHandle(){if("showOpenFilePicker"in window)return window.showOpenFilePicker().then(d=>d[0])}function getDirHandle(){if("showDirectoryPicker"in window)return window.showDirectoryPicker().then(d=>d)}async function verifyPermission(d,h){const p={};return h&&(p.writable=!0,p.mode="readwrite"),await d.queryPermission(p)==="granted"||await d.requestPermission(p)==="granted"}async function writeFileToDisk(d,h,p){let w=await(await d.getFileHandle(h,{create:!0})).createWritable();await w.write(p),await w.close()}async function fileExists(d,h){try{return await d.getFileHandle(h),!0}catch(p){if(p.name==="NotFoundError")return!1;if(p.name==="NotAllowedError")return console.log("Please select directory to verify permissions"),!1}}async function readFileFromDisk(d,h){return await(await(await d.getFileHandle(h)).getFile()).arrayBuffer()}var fileUtils={getDirHandle,verifyPermission,writeFileToDisk,fileExists,getFileHandle,readFileFromDisk},mapboxGl={exports:{}};(function(d,h){(function(p,m){d.exports=m()})(commonjsGlobal,function(){var p,m,w;function T(x,B){if(!p)p=B;else if(!m)m=B;else{var P="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+p+")(sharedChunk); ("+m+")(sharedChunk); self.onerror = null;",O={};p(O),w=B(O),typeof window!="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(w.workerUrl=window.URL.createObjectURL(new Blob([P],{type:"text/javascript"})))}}T(["exports"],function(x){var B="2.7.0",P=O;function O(g,l,b,E){this.cx=3*g,this.bx=3*(b-g)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*l,this.by=3*(E-l)-this.cy,this.ay=1-this.cy-this.by,this.p1x=g,this.p1y=E,this.p2x=b,this.p2y=E}O.prototype.sampleCurveX=function(g){return((this.ax*g+this.bx)*g+this.cx)*g},O.prototype.sampleCurveY=function(g){return((this.ay*g+this.by)*g+this.cy)*g},O.prototype.sampleCurveDerivativeX=function(g){return(3*this.ax*g+2*this.bx)*g+this.cx},O.prototype.solveCurveX=function(g,l){var b,E,S,A,D;for(l===void 0&&(l=1e-6),S=g,D=0;D<8;D++){if(A=this.sampleCurveX(S)-g,Math.abs(A)<l)return S;var z=this.sampleCurveDerivativeX(S);if(Math.abs(z)<1e-6)break;S-=A/z}if((S=g)<(b=0))return b;if(S>(E=1))return E;for(;b<E;){if(A=this.sampleCurveX(S),Math.abs(A-g)<l)return S;g>A?b=S:E=S,S=.5*(E-b)+b}return S},O.prototype.solve=function(g,l){return this.sampleCurveY(this.solveCurveX(g,l))};var U=G;function G(g,l){this.x=g,this.y=l}G.prototype={clone:function(){return new G(this.x,this.y)},add:function(g){return this.clone()._add(g)},sub:function(g){return this.clone()._sub(g)},multByPoint:function(g){return this.clone()._multByPoint(g)},divByPoint:function(g){return this.clone()._divByPoint(g)},mult:function(g){return this.clone()._mult(g)},div:function(g){return this.clone()._div(g)},rotate:function(g){return this.clone()._rotate(g)},rotateAround:function(g,l){return this.clone()._rotateAround(g,l)},matMult:function(g){return this.clone()._matMult(g)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(g){return this.x===g.x&&this.y===g.y},dist:function(g){return Math.sqrt(this.distSqr(g))},distSqr:function(g){var l=g.x-this.x,b=g.y-this.y;return l*l+b*b},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(g){return Math.atan2(this.y-g.y,this.x-g.x)},angleWith:function(g){return this.angleWithSep(g.x,g.y)},angleWithSep:function(g,l){return Math.atan2(this.x*l-this.y*g,this.x*g+this.y*l)},_matMult:function(g){var l=g[2]*this.x+g[3]*this.y;return this.x=g[0]*this.x+g[1]*this.y,this.y=l,this},_add:function(g){return this.x+=g.x,this.y+=g.y,this},_sub:function(g){return this.x-=g.x,this.y-=g.y,this},_mult:function(g){return this.x*=g,this.y*=g,this},_div:function(g){return this.x/=g,this.y/=g,this},_multByPoint:function(g){return this.x*=g.x,this.y*=g.y,this},_divByPoint:function(g){return this.x/=g.x,this.y/=g.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var g=this.y;return this.y=this.x,this.x=-g,this},_rotate:function(g){var l=Math.cos(g),b=Math.sin(g),E=b*this.x+l*this.y;return this.x=l*this.x-b*this.y,this.y=E,this},_rotateAround:function(g,l){var b=Math.cos(g),E=Math.sin(g),S=l.y+E*(this.x-l.x)+b*(this.y-l.y);return this.x=l.x+b*(this.x-l.x)-E*(this.y-l.y),this.y=S,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},G.convert=function(g){return g instanceof G?g:Array.isArray(g)?new G(g[0],g[1]):g};var j=typeof self!="undefined"?self:{},H=1e-6,te=typeof Float32Array!="undefined"?Float32Array:Array;function oe(){var g=new te(9);return te!=Float32Array&&(g[1]=0,g[2]=0,g[3]=0,g[5]=0,g[6]=0,g[7]=0),g[0]=1,g[4]=1,g[8]=1,g}function Q(g){return g[0]=1,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=1,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=1,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g}function _e(g,l,b){var E=l[0],S=l[1],A=l[2],D=l[3],z=l[4],$=l[5],V=l[6],Z=l[7],X=l[8],Y=l[9],ie=l[10],ce=l[11],pe=l[12],ve=l[13],Ae=l[14],Be=l[15],$e=b[0],Ve=b[1],Ge=b[2],Xe=b[3];return g[0]=$e*E+Ve*z+Ge*X+Xe*pe,g[1]=$e*S+Ve*$+Ge*Y+Xe*ve,g[2]=$e*A+Ve*V+Ge*ie+Xe*Ae,g[3]=$e*D+Ve*Z+Ge*ce+Xe*Be,g[4]=($e=b[4])*E+(Ve=b[5])*z+(Ge=b[6])*X+(Xe=b[7])*pe,g[5]=$e*S+Ve*$+Ge*Y+Xe*ve,g[6]=$e*A+Ve*V+Ge*ie+Xe*Ae,g[7]=$e*D+Ve*Z+Ge*ce+Xe*Be,g[8]=($e=b[8])*E+(Ve=b[9])*z+(Ge=b[10])*X+(Xe=b[11])*pe,g[9]=$e*S+Ve*$+Ge*Y+Xe*ve,g[10]=$e*A+Ve*V+Ge*ie+Xe*Ae,g[11]=$e*D+Ve*Z+Ge*ce+Xe*Be,g[12]=($e=b[12])*E+(Ve=b[13])*z+(Ge=b[14])*X+(Xe=b[15])*pe,g[13]=$e*S+Ve*$+Ge*Y+Xe*ve,g[14]=$e*A+Ve*V+Ge*ie+Xe*Ae,g[15]=$e*D+Ve*Z+Ge*ce+Xe*Be,g}function se(g,l,b){var E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe=b[0],ve=b[1],Ae=b[2];return l===g?(g[12]=l[0]*pe+l[4]*ve+l[8]*Ae+l[12],g[13]=l[1]*pe+l[5]*ve+l[9]*Ae+l[13],g[14]=l[2]*pe+l[6]*ve+l[10]*Ae+l[14],g[15]=l[3]*pe+l[7]*ve+l[11]*Ae+l[15]):(S=l[1],A=l[2],D=l[3],z=l[4],$=l[5],V=l[6],Z=l[7],X=l[8],Y=l[9],ie=l[10],ce=l[11],g[0]=E=l[0],g[1]=S,g[2]=A,g[3]=D,g[4]=z,g[5]=$,g[6]=V,g[7]=Z,g[8]=X,g[9]=Y,g[10]=ie,g[11]=ce,g[12]=E*pe+z*ve+X*Ae+l[12],g[13]=S*pe+$*ve+Y*Ae+l[13],g[14]=A*pe+V*ve+ie*Ae+l[14],g[15]=D*pe+Z*ve+ce*Ae+l[15]),g}function le(g,l,b){var E=b[0],S=b[1],A=b[2];return g[0]=l[0]*E,g[1]=l[1]*E,g[2]=l[2]*E,g[3]=l[3]*E,g[4]=l[4]*S,g[5]=l[5]*S,g[6]=l[6]*S,g[7]=l[7]*S,g[8]=l[8]*A,g[9]=l[9]*A,g[10]=l[10]*A,g[11]=l[11]*A,g[12]=l[12],g[13]=l[13],g[14]=l[14],g[15]=l[15],g}function me(g,l,b){var E=Math.sin(b),S=Math.cos(b),A=l[4],D=l[5],z=l[6],$=l[7],V=l[8],Z=l[9],X=l[10],Y=l[11];return l!==g&&(g[0]=l[0],g[1]=l[1],g[2]=l[2],g[3]=l[3],g[12]=l[12],g[13]=l[13],g[14]=l[14],g[15]=l[15]),g[4]=A*S+V*E,g[5]=D*S+Z*E,g[6]=z*S+X*E,g[7]=$*S+Y*E,g[8]=V*S-A*E,g[9]=Z*S-D*E,g[10]=X*S-z*E,g[11]=Y*S-$*E,g}function Re(g,l,b){var E=Math.sin(b),S=Math.cos(b),A=l[0],D=l[1],z=l[2],$=l[3],V=l[8],Z=l[9],X=l[10],Y=l[11];return l!==g&&(g[4]=l[4],g[5]=l[5],g[6]=l[6],g[7]=l[7],g[12]=l[12],g[13]=l[13],g[14]=l[14],g[15]=l[15]),g[0]=A*S-V*E,g[1]=D*S-Z*E,g[2]=z*S-X*E,g[3]=$*S-Y*E,g[8]=A*E+V*S,g[9]=D*E+Z*S,g[10]=z*E+X*S,g[11]=$*E+Y*S,g}Math.hypot||(Math.hypot=function(){for(var g=0,l=arguments.length;l--;)g+=arguments[l]*arguments[l];return Math.sqrt(g)});var xe=_e;function ue(){var g=new te(3);return te!=Float32Array&&(g[0]=0,g[1]=0,g[2]=0),g}function Me(g){var l=new te(3);return l[0]=g[0],l[1]=g[1],l[2]=g[2],l}function he(g){return Math.hypot(g[0],g[1],g[2])}function ge(g,l,b){var E=new te(3);return E[0]=g,E[1]=l,E[2]=b,E}function Le(g,l,b){return g[0]=l[0]+b[0],g[1]=l[1]+b[1],g[2]=l[2]+b[2],g}function Ze(g,l,b){return g[0]=l[0]-b[0],g[1]=l[1]-b[1],g[2]=l[2]-b[2],g}function st(g,l,b){return g[0]=l[0]*b[0],g[1]=l[1]*b[1],g[2]=l[2]*b[2],g}function ht(g,l,b){return g[0]=Math.max(l[0],b[0]),g[1]=Math.max(l[1],b[1]),g[2]=Math.max(l[2],b[2]),g}function Rt(g,l,b){return g[0]=l[0]*b,g[1]=l[1]*b,g[2]=l[2]*b,g}function Bt(g,l,b,E){return g[0]=l[0]+b[0]*E,g[1]=l[1]+b[1]*E,g[2]=l[2]+b[2]*E,g}function At(g,l){var b=l[0],E=l[1],S=l[2],A=b*b+E*E+S*S;return A>0&&(A=1/Math.sqrt(A)),g[0]=l[0]*A,g[1]=l[1]*A,g[2]=l[2]*A,g}function Nt(g,l){return g[0]*l[0]+g[1]*l[1]+g[2]*l[2]}function zt(g,l,b){var E=l[0],S=l[1],A=l[2],D=b[0],z=b[1],$=b[2];return g[0]=S*$-A*z,g[1]=A*D-E*$,g[2]=E*z-S*D,g}function Tt(g,l,b){var E=l[0],S=l[1],A=l[2],D=b[3]*E+b[7]*S+b[11]*A+b[15];return g[0]=(b[0]*E+b[4]*S+b[8]*A+b[12])/(D=D||1),g[1]=(b[1]*E+b[5]*S+b[9]*A+b[13])/D,g[2]=(b[2]*E+b[6]*S+b[10]*A+b[14])/D,g}function ii(g,l,b){var E=b[0],S=b[1],A=b[2],D=l[0],z=l[1],$=l[2],V=S*$-A*z,Z=A*D-E*$,X=E*z-S*D,Y=S*X-A*Z,ie=A*V-E*X,ce=E*Z-S*V,pe=2*b[3];return Z*=pe,X*=pe,ie*=2,ce*=2,g[0]=D+(V*=pe)+(Y*=2),g[1]=z+Z+ie,g[2]=$+X+ce,g}var Mt,St=Ze,wt=st,Ut=he;function Vt(g,l,b){var E=l[0],S=l[1],A=l[2],D=l[3];return g[0]=b[0]*E+b[4]*S+b[8]*A+b[12]*D,g[1]=b[1]*E+b[5]*S+b[9]*A+b[13]*D,g[2]=b[2]*E+b[6]*S+b[10]*A+b[14]*D,g[3]=b[3]*E+b[7]*S+b[11]*A+b[15]*D,g}function pi(){var g=new te(4);return te!=Float32Array&&(g[0]=0,g[1]=0,g[2]=0),g[3]=1,g}function ni(g){return g[0]=0,g[1]=0,g[2]=0,g[3]=1,g}function _i(g,l,b){b*=.5;var E=l[0],S=l[1],A=l[2],D=l[3],z=Math.sin(b),$=Math.cos(b);return g[0]=E*$+D*z,g[1]=S*$+A*z,g[2]=A*$-S*z,g[3]=D*$-E*z,g}function yi(g,l){return g[0]===l[0]&&g[1]===l[1]}ue(),Mt=new te(4),te!=Float32Array&&(Mt[0]=0,Mt[1]=0,Mt[2]=0,Mt[3]=0),ue(),ge(1,0,0),ge(0,1,0),pi(),pi(),oe(),function(){var g;g=new te(2),te!=Float32Array&&(g[0]=0,g[1]=0)}();const Ri=Math.PI/180,di=180/Math.PI;function pt(g){return g*Ri}function xt(g){return g*di}const fi=[[0,0],[1,0],[1,1],[0,1]];function oi(g){if(g<=0)return 0;if(g>=1)return 1;const l=g*g,b=l*g;return 4*(g<.5?b:3*(g-l)+b-.75)}function He(g,l,b,E){const S=new P(g,l,b,E);return function(A){return S.solve(A)}}const Ht=He(.25,.1,.25,1);function Pt(g,l,b){return Math.min(b,Math.max(l,g))}function ei(g,l,b){return(b=Pt((b-g)/(l-g),0,1))*b*(3-2*b)}function ri(g,l,b){const E=b-l,S=((g-l)%E+E)%E+l;return S===l?b:S}function vt(g,l,b){if(!g.length)return b(null,[]);let E=g.length;const S=new Array(g.length);let A=null;g.forEach((D,z)=>{l(D,($,V)=>{$&&(A=$),S[z]=V,--E==0&&b(A,S)})})}function Di(g){const l=[];for(const b in g)l.push(g[b]);return l}function Wt(g,...l){for(const b of l)for(const E in b)g[E]=b[E];return g}let Gt=1;function qt(){return Gt++}function It(){return function g(l){return l?(l^16*Math.random()>>l/4).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,g)}()}function hi(g){return g<=1?1:Math.pow(2,Math.ceil(Math.log(g)/Math.LN2))}function xi(g){return!!g&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(g)}function Ei(g,l){g.forEach(b=>{l[b]&&(l[b]=l[b].bind(l))})}function Qt(g,l){return g.indexOf(l,g.length-l.length)!==-1}function ai(g,l,b){const E={};for(const S in g)E[S]=l.call(b||this,g[S],S,g);return E}function $i(g,l,b){const E={};for(const S in g)l.call(b||this,g[S],S,g)&&(E[S]=g[S]);return E}function Si(g){return Array.isArray(g)?g.map(Si):typeof g=="object"&&g?ai(g,Si):g}const Zi={};function Ai(g){Zi[g]||(typeof console!="undefined"&&console.warn(g),Zi[g]=!0)}function dr(g,l,b){return(b.y-g.y)*(l.x-g.x)>(l.y-g.y)*(b.x-g.x)}function on(g){let l=0;for(let b,E,S=0,A=g.length,D=A-1;S<A;D=S++)b=g[S],E=g[D],l+=(E.x-b.x)*(b.y+E.y);return l}function fr(){return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope}function Rr(g){const l={};if(g.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(b,E,S,A)=>{const D=S||A;return l[E]=!D||D.toLowerCase(),""}),l["max-age"]){const b=parseInt(l["max-age"],10);isNaN(b)?delete l["max-age"]:l["max-age"]=b}return l}let Br,Er,vr,$r=null;function Mr(g){if($r==null){const l=g.navigator?g.navigator.userAgent:null;$r=!!g.safari||!(!l||!(/\b(iPad|iPhone|iPod)\b/.test(l)||l.match("Safari")&&!l.match("Chrome")))}return $r}function Te(g){try{const l=j[g];return l.setItem("_mapbox_test_",1),l.removeItem("_mapbox_test_"),!0}catch{return!1}}const je={now:()=>vr!==void 0?vr:j.performance.now(),setNow(g){vr=g},restoreNow(){vr=void 0},frame(g){const l=j.requestAnimationFrame(g);return{cancel:()=>j.cancelAnimationFrame(l)}},getImageData(g,l=0){const b=j.document.createElement("canvas"),E=b.getContext("2d");if(!E)throw new Error("failed to create canvas 2d context");return b.width=g.width,b.height=g.height,E.drawImage(g,0,0,g.width,g.height),E.getImageData(-l,-l,g.width+2*l,g.height+2*l)},resolveURL:g=>(Br||(Br=j.document.createElement("a")),Br.href=g,Br.href),get devicePixelRatio(){return j.devicePixelRatio},get prefersReducedMotion(){return!!j.matchMedia&&(Er==null&&(Er=j.matchMedia("(prefers-reduced-motion: reduce)")),Er.matches)}};let ae;const K={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(ae==null){const g=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{ae={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):g}catch{ae=g}}return ae},get EVENTS_URL(){return this.API_URL?this.API_URL.indexOf("https://api.mapbox.cn")===0?"https://events.mapbox.cn/events/v2":this.API_URL.indexOf("https://api.mapbox.com")===0?"https://events.mapbox.com/events/v2":null:null},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},re={supported:!1,testSupport:function(g){!De&&Se&&(Ue?Ne(g):de=g)}};let de,Se,De=!1,Ue=!1;function Ne(g){const l=g.createTexture();g.bindTexture(g.TEXTURE_2D,l);try{if(g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,Se),g.isContextLost())return;re.supported=!0}catch{}g.deleteTexture(l),De=!0}j.document&&(Se=j.document.createElement("img"),Se.onload=function(){de&&Ne(de),de=null,Ue=!0},Se.onerror=function(){De=!0,de=null},Se.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Oe="01",qe="NO_ACCESS_TOKEN";function Je(g){return g.indexOf("mapbox:")===0}function Qe(g){return K.API_URL_REGEX.test(g)}const at=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function kt(g){const l=g.match(at);if(!l)throw new Error("Unable to parse URL object");return{protocol:l[1],authority:l[2],path:l[3]||"/",params:l[4]?l[4].split("&"):[]}}function jt(g){const l=g.params.length?`?${g.params.join("&")}`:"";return`${g.protocol}://${g.authority}${g.path}${l}`}function Zt(g){if(!g)return null;const l=g.split(".");if(!l||l.length!==3)return null;try{return JSON.parse(decodeURIComponent(j.atob(l[1]).split("").map(b=>"%"+("00"+b.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class Yt{constructor(l){this.type=l,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(l){const b=Zt(K.ACCESS_TOKEN);let E="";return E=b&&b.u?j.btoa(encodeURIComponent(b.u).replace(/%([0-9A-F]{2})/g,(S,A)=>String.fromCharCode(Number("0x"+A)))):K.ACCESS_TOKEN||"",l?`mapbox.eventData.${l}:${E}`:`mapbox.eventData:${E}`}fetchEventData(){const l=Te("localStorage"),b=this.getStorageKey(),E=this.getStorageKey("uuid");if(l)try{const S=j.localStorage.getItem(b);S&&(this.eventData=JSON.parse(S));const A=j.localStorage.getItem(E);A&&(this.anonId=A)}catch{Ai("Unable to read from LocalStorage")}}saveEventData(){const l=Te("localStorage"),b=this.getStorageKey(),E=this.getStorageKey("uuid");if(l)try{j.localStorage.setItem(E,this.anonId),Object.keys(this.eventData).length>=1&&j.localStorage.setItem(b,JSON.stringify(this.eventData))}catch{Ai("Unable to write to LocalStorage")}}processRequests(l){}postEvent(l,b,E,S){if(!K.EVENTS_URL)return;const A=kt(K.EVENTS_URL);A.params.push(`access_token=${S||K.ACCESS_TOKEN||""}`);const D={event:this.type,created:new Date(l).toISOString(),sdkIdentifier:"mapbox-gl-js",sdkVersion:B,skuId:Oe,userId:this.anonId},z=b?Wt(D,b):D,$={url:jt(A),headers:{"Content-Type":"text/plain"},body:JSON.stringify([z])};this.pendingRequest=Tn($,V=>{this.pendingRequest=null,E(V),this.saveEventData(),this.processRequests(S)})}queueRequest(l,b){this.queue.push(l),this.processRequests(b)}}const mi=new class extends Yt{constructor(g){super("appUserTurnstile"),this._customAccessToken=g}postTurnstileEvent(g,l){K.EVENTS_URL&&K.ACCESS_TOKEN&&Array.isArray(g)&&g.some(b=>Je(b)||Qe(b))&&this.queueRequest(Date.now(),l)}processRequests(g){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const l=Zt(K.ACCESS_TOKEN),b=l?l.u:K.ACCESS_TOKEN;let E=b!==this.eventData.tokenU;xi(this.anonId)||(this.anonId=It(),E=!0);const S=this.queue.shift();if(this.eventData.lastSuccess){const A=new Date(this.eventData.lastSuccess),D=new Date(S),z=(S-this.eventData.lastSuccess)/864e5;E=E||z>=1||z<-1||A.getDate()!==D.getDate()}else E=!0;if(!E)return this.processRequests();this.postEvent(S,{"enabled.telemetry":!1},A=>{A||(this.eventData.lastSuccess=S,this.eventData.tokenU=b)},g)}},Xi=mi.postTurnstileEvent.bind(mi),Ki=new class extends Yt{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(g,l,b,E){this.skuToken=l,this.errorCb=E,K.EVENTS_URL&&(b||K.ACCESS_TOKEN?this.queueRequest({id:g,timestamp:Date.now()},b):this.errorCb(new Error(qe)))}processRequests(g){if(this.pendingRequest||this.queue.length===0)return;const{id:l,timestamp:b}=this.queue.shift();l&&this.success[l]||(this.anonId||this.fetchEventData(),xi(this.anonId)||(this.anonId=It()),this.postEvent(b,{skuToken:this.skuToken},E=>{E?this.errorCb(E):l&&(this.success[l]=!0)},g))}},Gi=Ki.postMapLoadEvent.bind(Ki),Yi=new class extends Yt{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(g,l,b,E){if(!K.API_URL||!K.SESSION_PATH)return;const S=kt(K.API_URL+K.SESSION_PATH);S.params.push(`sku=${l||""}`),S.params.push(`access_token=${E||K.ACCESS_TOKEN||""}`);const A={url:jt(S),headers:{"Content-Type":"text/plain"}};this.pendingRequest=tc(A,D=>{this.pendingRequest=null,b(D),this.saveEventData(),this.processRequests(E)})}getSessionAPI(g,l,b,E){this.skuToken=l,this.errorCb=E,K.SESSION_PATH&&K.API_URL&&(b||K.ACCESS_TOKEN?this.queueRequest({id:g,timestamp:Date.now()},b):this.errorCb(new Error(qe)))}processRequests(g){if(this.pendingRequest||this.queue.length===0)return;const{id:l,timestamp:b}=this.queue.shift();l&&this.success[l]||this.getSession(b,this.skuToken,E=>{E?this.errorCb(E):l&&(this.success[l]=!0)},g)}},jn=Yi.getSessionAPI.bind(Yi),Pn=new Set,Lr="mapbox-tiles";let En,Ds,Pl=500,Ra=50;function Yo(){j.caches&&!En&&(En=j.caches.open(Lr))}function Ba(g){const l=g.indexOf("?");return l<0?g:g.slice(0,l)}let Ps=1/0;const Rs={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(Rs);class Ho extends Error{constructor(l,b,E){b===401&&Qe(E)&&(l+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(l),this.status=b,this.url=E}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const La=fr()?()=>self.worker&&self.worker.referrer:()=>(j.location.protocol==="blob:"?j.parent:j).location.href,mn=function(g,l){if(!(/^file:/.test(b=g.url)||/^file:/.test(La())&&!/^\w+:/.test(b))){if(j.fetch&&j.Request&&j.AbortController&&j.Request.prototype.hasOwnProperty("signal"))return function(E,S){const A=new j.AbortController,D=new j.Request(E.url,{method:E.method||"GET",body:E.body,credentials:E.credentials,headers:E.headers,referrer:La(),signal:A.signal});let z=!1,$=!1;const V=(Z=D.url).indexOf("sku=")>0&&Qe(Z);var Z;E.type==="json"&&D.headers.set("Accept","application/json");const X=(ie,ce,pe)=>{if($)return;if(ie&&ie.message!=="SecurityError"&&Ai(ie),ce&&pe)return Y(ce);const ve=Date.now();j.fetch(D).then(Ae=>{if(Ae.ok){const Be=V?Ae.clone():null;return Y(Ae,Be,ve)}return S(new Ho(Ae.statusText,Ae.status,E.url))}).catch(Ae=>{Ae.code!==20&&S(new Error(Ae.message))})},Y=(ie,ce,pe)=>{(E.type==="arrayBuffer"?ie.arrayBuffer():E.type==="json"?ie.json():ie.text()).then(ve=>{$||(ce&&pe&&function(Ae,Be,$e){if(Yo(),!En)return;const Ve={status:Be.status,statusText:Be.statusText,headers:new j.Headers};Be.headers.forEach((Xe,nt)=>Ve.headers.set(nt,Xe));const Ge=Rr(Be.headers.get("Cache-Control")||"");Ge["no-store"]||(Ge["max-age"]&&Ve.headers.set("Expires",new Date($e+1e3*Ge["max-age"]).toUTCString()),new Date(Ve.headers.get("Expires")).getTime()-$e<42e4||function(Xe,nt){if(Ds===void 0)try{new Response(new ReadableStream),Ds=!0}catch{Ds=!1}Ds?nt(Xe.body):Xe.blob().then(nt)}(Be,Xe=>{const nt=new j.Response(Xe,Ve);Yo(),En&&En.then(it=>it.put(Ba(Ae.url),nt)).catch(it=>Ai(it.message))}))}(D,ce,pe),z=!0,S(null,ve,ie.headers.get("Cache-Control"),ie.headers.get("Expires")))}).catch(ve=>{$||S(new Error(ve.message))})};return V?function(ie,ce){if(Yo(),!En)return ce(null);const pe=Ba(ie.url);En.then(ve=>{ve.match(pe).then(Ae=>{const Be=function($e){if(!$e)return!1;const Ve=new Date($e.headers.get("Expires")||0),Ge=Rr($e.headers.get("Cache-Control")||"");return Ve>Date.now()&&!Ge["no-cache"]}(Ae);ve.delete(pe),Be&&ve.put(pe,Ae.clone()),ce(null,Ae,Be)}).catch(ce)}).catch(ce)}(D,X):X(null,null),{cancel:()=>{$=!0,z||A.abort()}}}(g,l);if(fr()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",g,l,void 0,!0)}var b;return function(E,S){const A=new j.XMLHttpRequest;A.open(E.method||"GET",E.url,!0),E.type==="arrayBuffer"&&(A.responseType="arraybuffer");for(const D in E.headers)A.setRequestHeader(D,E.headers[D]);return E.type==="json"&&(A.responseType="text",A.setRequestHeader("Accept","application/json")),A.withCredentials=E.credentials==="include",A.onerror=()=>{S(new Error(A.statusText))},A.onload=()=>{if((A.status>=200&&A.status<300||A.status===0)&&A.response!==null){let D=A.response;if(E.type==="json")try{D=JSON.parse(A.response)}catch(z){return S(z)}S(null,D,A.getResponseHeader("Cache-Control"),A.getResponseHeader("Expires"))}else S(new Ho(A.statusText,A.status,E.url))},A.send(E.body),{cancel:()=>A.abort()}}(g,l)},Wo=function(g,l){return mn(Wt(g,{type:"arrayBuffer"}),l)},Tn=function(g,l){return mn(Wt(g,{method:"POST"}),l)},tc=function(g,l){return mn(Wt(g,{method:"GET"}),l)};function Rl(g){const l=j.document.createElement("a");return l.href=g,l.protocol===j.document.location.protocol&&l.host===j.document.location.host}const bo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let wo,Ko;wo=[],Ko=0;const Bl=function(g,l){if(re.supported&&(g.headers||(g.headers={}),g.headers.accept="image/webp,*/*"),Ko>=K.MAX_PARALLEL_IMAGE_REQUESTS){const A={requestParameters:g,callback:l,cancelled:!1,cancel(){this.cancelled=!0}};return wo.push(A),A}Ko++;let b=!1;const E=()=>{if(!b)for(b=!0,Ko--;wo.length&&Ko<K.MAX_PARALLEL_IMAGE_REQUESTS;){const A=wo.shift(),{requestParameters:D,callback:z,cancelled:$}=A;$||(A.cancel=Bl(D,z).cancel)}},S=Wo(g,(A,D,z,$)=>{E(),A?l(A):D&&(j.createImageBitmap?function(V,Z){const X=new j.Blob([new Uint8Array(V)],{type:"image/png"});j.createImageBitmap(X).then(Y=>{Z(null,Y)}).catch(Y=>{Z(new Error(`Could not load image because of ${Y.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(D,(V,Z)=>l(V,Z,z,$)):function(V,Z){const X=new j.Image,Y=j.URL;X.onload=()=>{Z(null,X),Y.revokeObjectURL(X.src),X.onload=null,j.requestAnimationFrame(()=>{X.src=bo})},X.onerror=()=>Z(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const ie=new j.Blob([new Uint8Array(V)],{type:"image/png"});X.src=V.byteLength?Y.createObjectURL(ie):bo}(D,(V,Z)=>l(V,Z,z,$)))});return{cancel:()=>{S.cancel(),E()}}};function Ll(g,l,b){b[g]&&b[g].indexOf(l)!==-1||(b[g]=b[g]||[],b[g].push(l))}function Bs(g,l,b){if(b&&b[g]){const E=b[g].indexOf(l);E!==-1&&b[g].splice(E,1)}}class Gn{constructor(l,b={}){Wt(this,b),this.type=l}}class Ls extends Gn{constructor(l,b={}){super("error",Wt({error:l},b))}}class qn{on(l,b){return this._listeners=this._listeners||{},Ll(l,b,this._listeners),this}off(l,b){return Bs(l,b,this._listeners),Bs(l,b,this._oneTimeListeners),this}once(l,b){return b?(this._oneTimeListeners=this._oneTimeListeners||{},Ll(l,b,this._oneTimeListeners),this):new Promise(E=>this.once(l,E))}fire(l,b){typeof l=="string"&&(l=new Gn(l,b||{}));const E=l.type;if(this.listens(E)){l.target=this;const S=this._listeners&&this._listeners[E]?this._listeners[E].slice():[];for(const z of S)z.call(this,l);const A=this._oneTimeListeners&&this._oneTimeListeners[E]?this._oneTimeListeners[E].slice():[];for(const z of A)Bs(E,z,this._oneTimeListeners),z.call(this,l);const D=this._eventedParent;D&&(Wt(l,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),D.fire(l))}else l instanceof Ls&&console.error(l.error);return this}listens(l){return!!(this._listeners&&this._listeners[l]&&this._listeners[l].length>0||this._oneTimeListeners&&this._oneTimeListeners[l]&&this._oneTimeListeners[l].length>0||this._eventedParent&&this._eventedParent.listens(l))}setEventedParent(l,b){return this._eventedParent=l,this._eventedParentData=b,this}}var et=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":0.1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class Dt{constructor(l,b,E,S){this.message=(l?`${l}: `:"")+E,S&&(this.identifier=S),b!=null&&b.__line__&&(this.line=b.__line__)}}function zl(g){const l=g.value;return l?[new Dt(g.key,l,"constants have been deprecated as of v8")]:[]}function Zn(g,...l){for(const b of l)for(const E in b)g[E]=b[E];return g}function cr(g){return g instanceof Number||g instanceof String||g instanceof Boolean?g.valueOf():g}function Rn(g){if(Array.isArray(g))return g.map(Rn);if(g instanceof Object&&!(g instanceof Number||g instanceof String||g instanceof Boolean)){const l={};for(const b in g)l[b]=Rn(g[b]);return l}return cr(g)}class Mn extends Error{constructor(l,b){super(b),this.message=b,this.key=l}}class zs{constructor(l,b=[]){this.parent=l,this.bindings={};for(const[E,S]of b)this.bindings[E]=S}concat(l){return new zs(this,l)}get(l){if(this.bindings[l])return this.bindings[l];if(this.parent)return this.parent.get(l);throw new Error(`${l} not found in scope.`)}has(l){return!!this.bindings[l]||!!this.parent&&this.parent.has(l)}}const Xn={kind:"null"},Ct={kind:"number"},Ii={kind:"string"},bi={kind:"boolean"},Sn={kind:"color"},Eo={kind:"object"},wi={kind:"value"},Jo={kind:"collator"},Yn={kind:"formatted"},Qo={kind:"resolvedImage"};function sn(g,l){return{kind:"array",itemType:g,N:l}}function sr(g){if(g.kind==="array"){const l=sr(g.itemType);return typeof g.N=="number"?`array<${l}, ${g.N}>`:g.itemType.kind==="value"?"array":`array<${l}>`}return g.kind}const ic=[Xn,Ct,Ii,bi,Sn,Yn,Eo,sn(wi),Qo];function Zr(g,l){if(l.kind==="error")return null;if(g.kind==="array"){if(l.kind==="array"&&(l.N===0&&l.itemType.kind==="value"||!Zr(g.itemType,l.itemType))&&(typeof g.N!="number"||g.N===l.N))return null}else{if(g.kind===l.kind)return null;if(g.kind==="value"){for(const b of ic)if(!Zr(b,l))return null}}return`Expected ${sr(g)} but found ${sr(l)} instead.`}function Fs(g,l){return l.some(b=>b.kind===g.kind)}function To(g,l){return l.some(b=>b==="null"?g===null:b==="array"?Array.isArray(g):b==="object"?g&&!Array.isArray(g)&&typeof g=="object":b===typeof g)}function Mo(g){var l={exports:{}};return g(l,l.exports),l.exports}var So=Mo(function(g,l){var b={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function E(z){return(z=Math.round(z))<0?0:z>255?255:z}function S(z){return E(z[z.length-1]==="%"?parseFloat(z)/100*255:parseInt(z))}function A(z){return($=z[z.length-1]==="%"?parseFloat(z)/100:parseFloat(z))<0?0:$>1?1:$;var $}function D(z,$,V){return V<0?V+=1:V>1&&(V-=1),6*V<1?z+($-z)*V*6:2*V<1?$:3*V<2?z+($-z)*(2/3-V)*6:z}try{l.parseCSSColor=function(z){var $,V=z.replace(/ /g,"").toLowerCase();if(V in b)return b[V].slice();if(V[0]==="#")return V.length===4?($=parseInt(V.substr(1),16))>=0&&$<=4095?[(3840&$)>>4|(3840&$)>>8,240&$|(240&$)>>4,15&$|(15&$)<<4,1]:null:V.length===7&&($=parseInt(V.substr(1),16))>=0&&$<=16777215?[(16711680&$)>>16,(65280&$)>>8,255&$,1]:null;var Z=V.indexOf("("),X=V.indexOf(")");if(Z!==-1&&X+1===V.length){var Y=V.substr(0,Z),ie=V.substr(Z+1,X-(Z+1)).split(","),ce=1;switch(Y){case"rgba":if(ie.length!==4)return null;ce=A(ie.pop());case"rgb":return ie.length!==3?null:[S(ie[0]),S(ie[1]),S(ie[2]),ce];case"hsla":if(ie.length!==4)return null;ce=A(ie.pop());case"hsl":if(ie.length!==3)return null;var pe=(parseFloat(ie[0])%360+360)%360/360,ve=A(ie[1]),Ae=A(ie[2]),Be=Ae<=.5?Ae*(ve+1):Ae+ve-Ae*ve,$e=2*Ae-Be;return[E(255*D($e,Be,pe+1/3)),E(255*D($e,Be,pe)),E(255*D($e,Be,pe-1/3)),ce];default:return null}}return null}}catch{}});class Fi{constructor(l,b,E,S=1){this.r=l,this.g=b,this.b=E,this.a=S}static parse(l){if(!l)return;if(l instanceof Fi)return l;if(typeof l!="string")return;const b=So.parseCSSColor(l);return b?new Fi(b[0]/255*b[3],b[1]/255*b[3],b[2]/255*b[3],b[3]):void 0}toString(){const[l,b,E,S]=this.toArray();return`rgba(${Math.round(l)},${Math.round(b)},${Math.round(E)},${S})`}toArray(){const{r:l,g:b,b:E,a:S}=this;return S===0?[0,0,0,0]:[255*l/S,255*b/S,255*E/S,S]}}Fi.black=new Fi(0,0,0,1),Fi.white=new Fi(1,1,1,1),Fi.transparent=new Fi(0,0,0,0),Fi.red=new Fi(1,0,0,1),Fi.blue=new Fi(0,0,1,1);class Os{constructor(l,b,E){this.sensitivity=l?b?"variant":"case":b?"accent":"base",this.locale=E,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(l,b){return this.collator.compare(l,b)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class za{constructor(l,b,E,S,A){this.text=l.normalize?l.normalize():l,this.image=b,this.scale=E,this.fontStack=S,this.textColor=A}}class gi{constructor(l){this.sections=l}static fromString(l){return new gi([new za(l,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(l=>l.text.length!==0||l.image&&l.image.name.length!==0)}static factory(l){return l instanceof gi?l:gi.fromString(l)}toString(){return this.sections.length===0?"":this.sections.map(l=>l.text).join("")}serialize(){const l=["format"];for(const b of this.sections){if(b.image){l.push(["image",b.image.name]);continue}l.push(b.text);const E={};b.fontStack&&(E["text-font"]=["literal",b.fontStack.split(",")]),b.scale&&(E["font-scale"]=b.scale),b.textColor&&(E["text-color"]=["rgba"].concat(b.textColor.toArray())),l.push(E)}return l}}class an{constructor(l){this.name=l.name,this.available=l.available}toString(){return this.name}static fromString(l){return l?new an({name:l,available:!1}):null}serialize(){return["image",this.name]}}function Fl(g,l,b,E){return typeof g=="number"&&g>=0&&g<=255&&typeof l=="number"&&l>=0&&l<=255&&typeof b=="number"&&b>=0&&b<=255?E===void 0||typeof E=="number"&&E>=0&&E<=1?null:`Invalid rgba value [${[g,l,b,E].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof E=="number"?[g,l,b,E]:[g,l,b]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function $s(g){if(g===null||typeof g=="string"||typeof g=="boolean"||typeof g=="number"||g instanceof Fi||g instanceof Os||g instanceof gi||g instanceof an)return!0;if(Array.isArray(g)){for(const l of g)if(!$s(l))return!1;return!0}if(typeof g=="object"){for(const l in g)if(!$s(g[l]))return!1;return!0}return!1}function pr(g){if(g===null)return Xn;if(typeof g=="string")return Ii;if(typeof g=="boolean")return bi;if(typeof g=="number")return Ct;if(g instanceof Fi)return Sn;if(g instanceof Os)return Jo;if(g instanceof gi)return Yn;if(g instanceof an)return Qo;if(Array.isArray(g)){const l=g.length;let b;for(const E of g){const S=pr(E);if(b){if(b===S)continue;b=wi;break}b=S}return sn(b||wi,l)}return Eo}function es(g){const l=typeof g;return g===null?"":l==="string"||l==="number"||l==="boolean"?String(g):g instanceof Fi||g instanceof gi||g instanceof an?g.toString():JSON.stringify(g)}class Hn{constructor(l,b){this.type=l,this.value=b}static parse(l,b){if(l.length!==2)return b.error(`'literal' expression requires exactly one argument, but found ${l.length-1} instead.`);if(!$s(l[1]))return b.error("invalid value");const E=l[1];let S=pr(E);const A=b.expectedType;return S.kind!=="array"||S.N!==0||!A||A.kind!=="array"||typeof A.N=="number"&&A.N!==0||(S=A),new Hn(S,E)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Fi?["rgba"].concat(this.value.toArray()):this.value instanceof gi?this.value.serialize():this.value}}class Sr{constructor(l){this.name="ExpressionEvaluationError",this.message=l}toJSON(){return this.message}}const Us={string:Ii,number:Ct,boolean:bi,object:Eo};class ln{constructor(l,b){this.type=l,this.args=b}static parse(l,b){if(l.length<2)return b.error("Expected at least one argument.");let E,S=1;const A=l[0];if(A==="array"){let z,$;if(l.length>2){const V=l[1];if(typeof V!="string"||!(V in Us)||V==="object")return b.error('The item type argument of "array" must be one of string, number, boolean',1);z=Us[V],S++}else z=wi;if(l.length>3){if(l[2]!==null&&(typeof l[2]!="number"||l[2]<0||l[2]!==Math.floor(l[2])))return b.error('The length argument to "array" must be a positive integer literal',2);$=l[2],S++}E=sn(z,$)}else E=Us[A];const D=[];for(;S<l.length;S++){const z=b.parse(l[S],S,wi);if(!z)return null;D.push(z)}return new ln(E,D)}evaluate(l){for(let b=0;b<this.args.length;b++){const E=this.args[b].evaluate(l);if(!Zr(this.type,pr(E)))return E;if(b===this.args.length-1)throw new Sr(`Expected value to be of type ${sr(this.type)}, but found ${sr(pr(E))} instead.`)}return null}eachChild(l){this.args.forEach(l)}outputDefined(){return this.args.every(l=>l.outputDefined())}serialize(){const l=this.type,b=[l.kind];if(l.kind==="array"){const E=l.itemType;if(E.kind==="string"||E.kind==="number"||E.kind==="boolean"){b.push(E.kind);const S=l.N;(typeof S=="number"||this.args.length>1)&&b.push(S)}}return b.concat(this.args.map(E=>E.serialize()))}}class An{constructor(l){this.type=Yn,this.sections=l}static parse(l,b){if(l.length<2)return b.error("Expected at least one argument.");const E=l[1];if(!Array.isArray(E)&&typeof E=="object")return b.error("First argument must be an image or text section.");const S=[];let A=!1;for(let D=1;D<=l.length-1;++D){const z=l[D];if(A&&typeof z=="object"&&!Array.isArray(z)){A=!1;let $=null;if(z["font-scale"]&&($=b.parse(z["font-scale"],1,Ct),!$))return null;let V=null;if(z["text-font"]&&(V=b.parse(z["text-font"],1,sn(Ii)),!V))return null;let Z=null;if(z["text-color"]&&(Z=b.parse(z["text-color"],1,Sn),!Z))return null;const X=S[S.length-1];X.scale=$,X.font=V,X.textColor=Z}else{const $=b.parse(l[D],1,wi);if(!$)return null;const V=$.type.kind;if(V!=="string"&&V!=="value"&&V!=="null"&&V!=="resolvedImage")return b.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");A=!0,S.push({content:$,scale:null,font:null,textColor:null})}}return new An(S)}evaluate(l){return new gi(this.sections.map(b=>{const E=b.content.evaluate(l);return pr(E)===Qo?new za("",E,null,null,null):new za(es(E),null,b.scale?b.scale.evaluate(l):null,b.font?b.font.evaluate(l).join(","):null,b.textColor?b.textColor.evaluate(l):null)}))}eachChild(l){for(const b of this.sections)l(b.content),b.scale&&l(b.scale),b.font&&l(b.font),b.textColor&&l(b.textColor)}outputDefined(){return!1}serialize(){const l=["format"];for(const b of this.sections){l.push(b.content.serialize());const E={};b.scale&&(E["font-scale"]=b.scale.serialize()),b.font&&(E["text-font"]=b.font.serialize()),b.textColor&&(E["text-color"]=b.textColor.serialize()),l.push(E)}return l}}class lo{constructor(l){this.type=Qo,this.input=l}static parse(l,b){if(l.length!==2)return b.error("Expected two arguments.");const E=b.parse(l[1],1,Ii);return E?new lo(E):b.error("No image name provided.")}evaluate(l){const b=this.input.evaluate(l),E=an.fromString(b);return E&&l.availableImages&&(E.available=l.availableImages.indexOf(b)>-1),E}eachChild(l){l(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const rc={"to-boolean":bi,"to-color":Sn,"to-number":Ct,"to-string":Ii};class In{constructor(l,b){this.type=l,this.args=b}static parse(l,b){if(l.length<2)return b.error("Expected at least one argument.");const E=l[0];if((E==="to-boolean"||E==="to-string")&&l.length!==2)return b.error("Expected one argument.");const S=rc[E],A=[];for(let D=1;D<l.length;D++){const z=b.parse(l[D],D,wi);if(!z)return null;A.push(z)}return new In(S,A)}evaluate(l){if(this.type.kind==="boolean")return Boolean(this.args[0].evaluate(l));if(this.type.kind==="color"){let b,E;for(const S of this.args){if(b=S.evaluate(l),E=null,b instanceof Fi)return b;if(typeof b=="string"){const A=l.parseColor(b);if(A)return A}else if(Array.isArray(b)&&(E=b.length<3||b.length>4?`Invalid rbga value ${JSON.stringify(b)}: expected an array containing either three or four numeric values.`:Fl(b[0],b[1],b[2],b[3]),!E))return new Fi(b[0]/255,b[1]/255,b[2]/255,b[3])}throw new Sr(E||`Could not parse color from value '${typeof b=="string"?b:String(JSON.stringify(b))}'`)}if(this.type.kind==="number"){let b=null;for(const E of this.args){if(b=E.evaluate(l),b===null)return 0;const S=Number(b);if(!isNaN(S))return S}throw new Sr(`Could not convert ${JSON.stringify(b)} to number.`)}return this.type.kind==="formatted"?gi.fromString(es(this.args[0].evaluate(l))):this.type.kind==="resolvedImage"?an.fromString(es(this.args[0].evaluate(l))):es(this.args[0].evaluate(l))}eachChild(l){this.args.forEach(l)}outputDefined(){return this.args.every(l=>l.outputDefined())}serialize(){if(this.type.kind==="formatted")return new An([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new lo(this.args[0]).serialize();const l=[`to-${this.type.kind}`];return this.eachChild(b=>{l.push(b.serialize())}),l}}const Ol=["Unknown","Point","LineString","Polygon"];class $l{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Ol[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const l=this.featureDistanceData.center,b=this.featureDistanceData.scale,{x:E,y:S}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(E*b-l[0])+this.featureDistanceData.bearing[1]*(S*b-l[1])}return 0}parseColor(l){let b=this._parseColorCache[l];return b||(b=this._parseColorCache[l]=Fi.parse(l)),b}}class Jr{constructor(l,b,E,S){this.name=l,this.type=b,this._evaluate=E,this.args=S}evaluate(l){return this._evaluate(l,this.args)}eachChild(l){this.args.forEach(l)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(l=>l.serialize()))}static parse(l,b){const E=l[0],S=Jr.definitions[E];if(!S)return b.error(`Unknown expression "${E}". If you wanted a literal array, use ["literal", [...]].`,0);const A=Array.isArray(S)?S[0]:S.type,D=Array.isArray(S)?[[S[1],S[2]]]:S.overloads,z=D.filter(([V])=>!Array.isArray(V)||V.length===l.length-1);let $=null;for(const[V,Z]of z){$=new js(b.registry,b.path,null,b.scope);const X=[];let Y=!1;for(let ie=1;ie<l.length;ie++){const ce=l[ie],pe=Array.isArray(V)?V[ie-1]:V.type,ve=$.parse(ce,1+X.length,pe);if(!ve){Y=!0;break}X.push(ve)}if(!Y)if(Array.isArray(V)&&V.length!==X.length)$.error(`Expected ${V.length} arguments, but found ${X.length} instead.`);else{for(let ie=0;ie<X.length;ie++){const ce=Array.isArray(V)?V[ie]:V.type,pe=X[ie];$.concat(ie+1).checkSubtype(ce,pe.type)}if($.errors.length===0)return new Jr(E,A,Z,X)}}if(z.length===1)b.errors.push(...$.errors);else{const V=(z.length?z:D).map(([X])=>{return Y=X,Array.isArray(Y)?`(${Y.map(sr).join(", ")})`:`(${sr(Y.type)}...)`;var Y}).join(" | "),Z=[];for(let X=1;X<l.length;X++){const Y=b.parse(l[X],1+Z.length);if(!Y)return null;Z.push(sr(Y.type))}b.error(`Expected arguments of type ${V}, but found (${Z.join(", ")}) instead.`)}return null}static register(l,b){Jr.definitions=b;for(const E in b)l[E]=Jr}}class ts{constructor(l,b,E){this.type=Jo,this.locale=E,this.caseSensitive=l,this.diacriticSensitive=b}static parse(l,b){if(l.length!==2)return b.error("Expected one argument.");const E=l[1];if(typeof E!="object"||Array.isArray(E))return b.error("Collator options argument must be an object.");const S=b.parse(E["case-sensitive"]!==void 0&&E["case-sensitive"],1,bi);if(!S)return null;const A=b.parse(E["diacritic-sensitive"]!==void 0&&E["diacritic-sensitive"],1,bi);if(!A)return null;let D=null;return E.locale&&(D=b.parse(E.locale,1,Ii),!D)?null:new ts(S,A,D)}evaluate(l){return new Os(this.caseSensitive.evaluate(l),this.diacriticSensitive.evaluate(l),this.locale?this.locale.evaluate(l):null)}eachChild(l){l(this.caseSensitive),l(this.diacriticSensitive),this.locale&&l(this.locale)}outputDefined(){return!1}serialize(){const l={};return l["case-sensitive"]=this.caseSensitive.serialize(),l["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(l.locale=this.locale.serialize()),["collator",l]}}const Wn=8192;function Ns(g,l){g[0]=Math.min(g[0],l[0]),g[1]=Math.min(g[1],l[1]),g[2]=Math.max(g[2],l[0]),g[3]=Math.max(g[3],l[1])}function is(g,l){return!(g[0]<=l[0]||g[2]>=l[2]||g[1]<=l[1]||g[3]>=l[3])}function Ul(g,l){const b=(180+g[0])/360,E=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+g[1]*Math.PI/360)))/360,S=Math.pow(2,l.z);return[Math.round(b*S*Wn),Math.round(E*S*Wn)]}function Nl(g,l,b){const E=g[0]-l[0],S=g[1]-l[1],A=g[0]-b[0],D=g[1]-b[1];return E*D-A*S==0&&E*A<=0&&S*D<=0}function Fa(g,l){let b=!1;for(let D=0,z=l.length;D<z;D++){const $=l[D];for(let V=0,Z=$.length;V<Z-1;V++){if(Nl(g,$[V],$[V+1]))return!1;(S=$[V])[1]>(E=g)[1]!=(A=$[V+1])[1]>E[1]&&E[0]<(A[0]-S[0])*(E[1]-S[1])/(A[1]-S[1])+S[0]&&(b=!b)}}var E,S,A;return b}function Vl(g,l){for(let b=0;b<l.length;b++)if(Fa(g,l[b]))return!0;return!1}function Oa(g,l,b,E){const S=E[0]-b[0],A=E[1]-b[1],D=(g[0]-b[0])*A-S*(g[1]-b[1]),z=(l[0]-b[0])*A-S*(l[1]-b[1]);return D>0&&z<0||D<0&&z>0}function nc(g,l,b){for(const V of b)for(let Z=0;Z<V.length-1;++Z)if((z=[(D=V[Z+1])[0]-(A=V[Z])[0],D[1]-A[1]])[0]*($=[(S=l)[0]-(E=g)[0],S[1]-E[1]])[1]-z[1]*$[0]!=0&&Oa(E,S,A,D)&&Oa(A,D,E,S))return!0;var E,S,A,D,z,$;return!1}function jl(g,l){for(let b=0;b<g.length;++b)if(!Fa(g[b],l))return!1;for(let b=0;b<g.length-1;++b)if(nc(g[b],g[b+1],l))return!1;return!0}function oc(g,l){for(let b=0;b<l.length;b++)if(jl(g,l[b]))return!0;return!1}function $a(g,l,b){const E=[];for(let S=0;S<g.length;S++){const A=[];for(let D=0;D<g[S].length;D++){const z=Ul(g[S][D],b);Ns(l,z),A.push(z)}E.push(A)}return E}function Gl(g,l,b){const E=[];for(let S=0;S<g.length;S++){const A=$a(g[S],l,b);E.push(A)}return E}function Ua(g,l,b,E){if(g[0]<b[0]||g[0]>b[2]){const S=.5*E;let A=g[0]-b[0]>S?-E:b[0]-g[0]>S?E:0;A===0&&(A=g[0]-b[2]>S?-E:b[2]-g[0]>S?E:0),g[0]+=A}Ns(l,g)}function ql(g,l,b,E){const S=Math.pow(2,E.z)*Wn,A=[E.x*Wn,E.y*Wn],D=[];for(const z of g)for(const $ of z){const V=[$.x+A[0],$.y+A[1]];Ua(V,l,b,S),D.push(V)}return D}function Zl(g,l,b,E){const S=Math.pow(2,E.z)*Wn,A=[E.x*Wn,E.y*Wn],D=[];for(const $ of g){const V=[];for(const Z of $){const X=[Z.x+A[0],Z.y+A[1]];Ns(l,X),V.push(X)}D.push(V)}if(l[2]-l[0]<=S/2){(z=l)[0]=z[1]=1/0,z[2]=z[3]=-1/0;for(const $ of D)for(const V of $)Ua(V,l,b,S)}var z;return D}class ho{constructor(l,b){this.type=bi,this.geojson=l,this.geometries=b}static parse(l,b){if(l.length!==2)return b.error(`'within' expression requires exactly one argument, but found ${l.length-1} instead.`);if($s(l[1])){const E=l[1];if(E.type==="FeatureCollection")for(let S=0;S<E.features.length;++S){const A=E.features[S].geometry.type;if(A==="Polygon"||A==="MultiPolygon")return new ho(E,E.features[S].geometry)}else if(E.type==="Feature"){const S=E.geometry.type;if(S==="Polygon"||S==="MultiPolygon")return new ho(E,E.geometry)}else if(E.type==="Polygon"||E.type==="MultiPolygon")return new ho(E,E)}return b.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(l){if(l.geometry()!=null&&l.canonicalID()!=null){if(l.geometryType()==="Point")return function(b,E){const S=[1/0,1/0,-1/0,-1/0],A=[1/0,1/0,-1/0,-1/0],D=b.canonicalID();if(E.type==="Polygon"){const z=$a(E.coordinates,A,D),$=ql(b.geometry(),S,A,D);if(!is(S,A))return!1;for(const V of $)if(!Fa(V,z))return!1}if(E.type==="MultiPolygon"){const z=Gl(E.coordinates,A,D),$=ql(b.geometry(),S,A,D);if(!is(S,A))return!1;for(const V of $)if(!Vl(V,z))return!1}return!0}(l,this.geometries);if(l.geometryType()==="LineString")return function(b,E){const S=[1/0,1/0,-1/0,-1/0],A=[1/0,1/0,-1/0,-1/0],D=b.canonicalID();if(E.type==="Polygon"){const z=$a(E.coordinates,A,D),$=Zl(b.geometry(),S,A,D);if(!is(S,A))return!1;for(const V of $)if(!jl(V,z))return!1}if(E.type==="MultiPolygon"){const z=Gl(E.coordinates,A,D),$=Zl(b.geometry(),S,A,D);if(!is(S,A))return!1;for(const V of $)if(!oc(V,z))return!1}return!0}(l,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}function Ao(g){if(g instanceof Jr&&(g.name==="get"&&g.args.length===1||g.name==="feature-state"||g.name==="has"&&g.args.length===1||g.name==="properties"||g.name==="geometry-type"||g.name==="id"||/^filter-/.test(g.name))||g instanceof ho)return!1;let l=!0;return g.eachChild(b=>{l&&!Ao(b)&&(l=!1)}),l}function rs(g){if(g instanceof Jr&&g.name==="feature-state")return!1;let l=!0;return g.eachChild(b=>{l&&!rs(b)&&(l=!1)}),l}function ns(g,l){if(g instanceof Jr&&l.indexOf(g.name)>=0)return!1;let b=!0;return g.eachChild(E=>{b&&!ns(E,l)&&(b=!1)}),b}class Vs{constructor(l,b){this.type=b.type,this.name=l,this.boundExpression=b}static parse(l,b){if(l.length!==2||typeof l[1]!="string")return b.error("'var' expression requires exactly one string literal argument.");const E=l[1];return b.scope.has(E)?new Vs(E,b.scope.get(E)):b.error(`Unknown variable "${E}". Make sure "${E}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(l){return this.boundExpression.evaluate(l)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class js{constructor(l,b=[],E,S=new zs,A=[]){this.registry=l,this.path=b,this.key=b.map(D=>`[${D}]`).join(""),this.scope=S,this.errors=A,this.expectedType=E}parse(l,b,E,S,A={}){return b?this.concat(b,E,S)._parse(l,A):this._parse(l,A)}_parse(l,b){function E(S,A,D){return D==="assert"?new ln(A,[S]):D==="coerce"?new In(A,[S]):S}if(l!==null&&typeof l!="string"&&typeof l!="boolean"&&typeof l!="number"||(l=["literal",l]),Array.isArray(l)){if(l.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const S=l[0];if(typeof S!="string")return this.error(`Expression name must be a string, but found ${typeof S} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const A=this.registry[S];if(A){let D=A.parse(l,this);if(!D)return null;if(this.expectedType){const z=this.expectedType,$=D.type;if(z.kind!=="string"&&z.kind!=="number"&&z.kind!=="boolean"&&z.kind!=="object"&&z.kind!=="array"||$.kind!=="value")if(z.kind!=="color"&&z.kind!=="formatted"&&z.kind!=="resolvedImage"||$.kind!=="value"&&$.kind!=="string"){if(this.checkSubtype(z,$))return null}else D=E(D,z,b.typeAnnotation||"coerce");else D=E(D,z,b.typeAnnotation||"assert")}if(!(D instanceof Hn)&&D.type.kind!=="resolvedImage"&&Gs(D)){const z=new $l;try{D=new Hn(D.type,D.evaluate(z))}catch($){return this.error($.message),null}}return D}return this.error(`Unknown expression "${S}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(l===void 0?"'undefined' value invalid. Use null instead.":typeof l=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof l} instead.`)}concat(l,b,E){const S=typeof l=="number"?this.path.concat(l):this.path,A=E?this.scope.concat(E):this.scope;return new js(this.registry,S,b||null,A,this.errors)}error(l,...b){const E=`${this.key}${b.map(S=>`[${S}]`).join("")}`;this.errors.push(new Mn(E,l))}checkSubtype(l,b){const E=Zr(l,b);return E&&this.error(E),E}}function Gs(g){if(g instanceof Vs)return Gs(g.boundExpression);if(g instanceof Jr&&g.name==="error"||g instanceof ts||g instanceof ho)return!1;const l=g instanceof In||g instanceof ln;let b=!0;return g.eachChild(E=>{b=l?b&&Gs(E):b&&E instanceof Hn}),!!b&&Ao(g)&&ns(g,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function os(g,l){const b=g.length-1;let E,S,A=0,D=b,z=0;for(;A<=D;)if(z=Math.floor((A+D)/2),E=g[z],S=g[z+1],E<=l){if(z===b||l<S)return z;A=z+1}else{if(!(E>l))throw new Sr("Input is not a number.");D=z-1}return 0}class ss{constructor(l,b,E){this.type=l,this.input=b,this.labels=[],this.outputs=[];for(const[S,A]of E)this.labels.push(S),this.outputs.push(A)}static parse(l,b){if(l.length-1<4)return b.error(`Expected at least 4 arguments, but found only ${l.length-1}.`);if((l.length-1)%2!=0)return b.error("Expected an even number of arguments.");const E=b.parse(l[1],1,Ct);if(!E)return null;const S=[];let A=null;b.expectedType&&b.expectedType.kind!=="value"&&(A=b.expectedType);for(let D=1;D<l.length;D+=2){const z=D===1?-1/0:l[D],$=l[D+1],V=D,Z=D+1;if(typeof z!="number")return b.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',V);if(S.length&&S[S.length-1][0]>=z)return b.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',V);const X=b.parse($,Z,A);if(!X)return null;A=A||X.type,S.push([z,X])}return new ss(A,E,S)}evaluate(l){const b=this.labels,E=this.outputs;if(b.length===1)return E[0].evaluate(l);const S=this.input.evaluate(l);if(S<=b[0])return E[0].evaluate(l);const A=b.length;return S>=b[A-1]?E[A-1].evaluate(l):E[os(b,S)].evaluate(l)}eachChild(l){l(this.input);for(const b of this.outputs)l(b)}outputDefined(){return this.outputs.every(l=>l.outputDefined())}serialize(){const l=["step",this.input.serialize()];for(let b=0;b<this.labels.length;b++)b>0&&l.push(this.labels[b]),l.push(this.outputs[b].serialize());return l}}function ji(g,l,b){return g*(1-b)+l*b}var qs=Object.freeze({__proto__:null,number:ji,color:function(g,l,b){return new Fi(ji(g.r,l.r,b),ji(g.g,l.g,b),ji(g.b,l.b,b),ji(g.a,l.a,b))},array:function(g,l,b){return g.map((E,S)=>ji(E,l[S],b))}});const Xl=.95047,as=1.08883,Na=4/29,Zs=6/29,Yl=3*Zs*Zs,sc=Math.PI/180,ac=180/Math.PI;function Xs(g){return g>.008856451679035631?Math.pow(g,1/3):g/Yl+Na}function Ys(g){return g>Zs?g*g*g:Yl*(g-Na)}function Hs(g){return 255*(g<=.0031308?12.92*g:1.055*Math.pow(g,1/2.4)-.055)}function ls(g){return(g/=255)<=.04045?g/12.92:Math.pow((g+.055)/1.055,2.4)}function Hl(g){const l=ls(g.r),b=ls(g.g),E=ls(g.b),S=Xs((.4124564*l+.3575761*b+.1804375*E)/Xl),A=Xs((.2126729*l+.7151522*b+.072175*E)/1);return{l:116*A-16,a:500*(S-A),b:200*(A-Xs((.0193339*l+.119192*b+.9503041*E)/as)),alpha:g.a}}function Wl(g){let l=(g.l+16)/116,b=isNaN(g.a)?l:l+g.a/500,E=isNaN(g.b)?l:l-g.b/200;return l=1*Ys(l),b=Xl*Ys(b),E=as*Ys(E),new Fi(Hs(3.2404542*b-1.5371385*l-.4985314*E),Hs(-.969266*b+1.8760108*l+.041556*E),Hs(.0556434*b-.2040259*l+1.0572252*E),g.alpha)}function lc(g,l,b){const E=l-g;return g+b*(E>180||E<-180?E-360*Math.round(E/360):E)}const hs={forward:Hl,reverse:Wl,interpolate:function(g,l,b){return{l:ji(g.l,l.l,b),a:ji(g.a,l.a,b),b:ji(g.b,l.b,b),alpha:ji(g.alpha,l.alpha,b)}}},cs={forward:function(g){const{l,a:b,b:E}=Hl(g),S=Math.atan2(E,b)*ac;return{h:S<0?S+360:S,c:Math.sqrt(b*b+E*E),l,alpha:g.a}},reverse:function(g){const l=g.h*sc,b=g.c;return Wl({l:g.l,a:Math.cos(l)*b,b:Math.sin(l)*b,alpha:g.alpha})},interpolate:function(g,l,b){return{h:lc(g.h,l.h,b),c:ji(g.c,l.c,b),l:ji(g.l,l.l,b),alpha:ji(g.alpha,l.alpha,b)}}};var Kl=Object.freeze({__proto__:null,lab:hs,hcl:cs});class Xr{constructor(l,b,E,S,A){this.type=l,this.operator=b,this.interpolation=E,this.input=S,this.labels=[],this.outputs=[];for(const[D,z]of A)this.labels.push(D),this.outputs.push(z)}static interpolationFactor(l,b,E,S){let A=0;if(l.name==="exponential")A=Ws(b,l.base,E,S);else if(l.name==="linear")A=Ws(b,1,E,S);else if(l.name==="cubic-bezier"){const D=l.controlPoints;A=new P(D[0],D[1],D[2],D[3]).solve(Ws(b,1,E,S))}return A}static parse(l,b){let[E,S,A,...D]=l;if(!Array.isArray(S)||S.length===0)return b.error("Expected an interpolation type expression.",1);if(S[0]==="linear")S={name:"linear"};else if(S[0]==="exponential"){const V=S[1];if(typeof V!="number")return b.error("Exponential interpolation requires a numeric base.",1,1);S={name:"exponential",base:V}}else{if(S[0]!=="cubic-bezier")return b.error(`Unknown interpolation type ${String(S[0])}`,1,0);{const V=S.slice(1);if(V.length!==4||V.some(Z=>typeof Z!="number"||Z<0||Z>1))return b.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);S={name:"cubic-bezier",controlPoints:V}}}if(l.length-1<4)return b.error(`Expected at least 4 arguments, but found only ${l.length-1}.`);if((l.length-1)%2!=0)return b.error("Expected an even number of arguments.");if(A=b.parse(A,2,Ct),!A)return null;const z=[];let $=null;E==="interpolate-hcl"||E==="interpolate-lab"?$=Sn:b.expectedType&&b.expectedType.kind!=="value"&&($=b.expectedType);for(let V=0;V<D.length;V+=2){const Z=D[V],X=D[V+1],Y=V+3,ie=V+4;if(typeof Z!="number")return b.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',Y);if(z.length&&z[z.length-1][0]>=Z)return b.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',Y);const ce=b.parse(X,ie,$);if(!ce)return null;$=$||ce.type,z.push([Z,ce])}return $.kind==="number"||$.kind==="color"||$.kind==="array"&&$.itemType.kind==="number"&&typeof $.N=="number"?new Xr($,E,S,A,z):b.error(`Type ${sr($)} is not interpolatable.`)}evaluate(l){const b=this.labels,E=this.outputs;if(b.length===1)return E[0].evaluate(l);const S=this.input.evaluate(l);if(S<=b[0])return E[0].evaluate(l);const A=b.length;if(S>=b[A-1])return E[A-1].evaluate(l);const D=os(b,S),z=Xr.interpolationFactor(this.interpolation,S,b[D],b[D+1]),$=E[D].evaluate(l),V=E[D+1].evaluate(l);return this.operator==="interpolate"?qs[this.type.kind.toLowerCase()]($,V,z):this.operator==="interpolate-hcl"?cs.reverse(cs.interpolate(cs.forward($),cs.forward(V),z)):hs.reverse(hs.interpolate(hs.forward($),hs.forward(V),z))}eachChild(l){l(this.input);for(const b of this.outputs)l(b)}outputDefined(){return this.outputs.every(l=>l.outputDefined())}serialize(){let l;l=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const b=[this.operator,l,this.input.serialize()];for(let E=0;E<this.labels.length;E++)b.push(this.labels[E],this.outputs[E].serialize());return b}}function Ws(g,l,b,E){const S=E-b,A=g-b;return S===0?0:l===1?A/S:(Math.pow(l,A)-1)/(Math.pow(l,S)-1)}class co{constructor(l,b){this.type=l,this.args=b}static parse(l,b){if(l.length<2)return b.error("Expectected at least one argument.");let E=null;const S=b.expectedType;S&&S.kind!=="value"&&(E=S);const A=[];for(const z of l.slice(1)){const $=b.parse(z,1+A.length,E,void 0,{typeAnnotation:"omit"});if(!$)return null;E=E||$.type,A.push($)}const D=S&&A.some(z=>Zr(S,z.type));return new co(D?wi:E,A)}evaluate(l){let b,E=null,S=0;for(const A of this.args){if(S++,E=A.evaluate(l),E&&E instanceof an&&!E.available&&(b||(b=E),E=null,S===this.args.length))return b;if(E!==null)break}return E}eachChild(l){this.args.forEach(l)}outputDefined(){return this.args.every(l=>l.outputDefined())}serialize(){const l=["coalesce"];return this.eachChild(b=>{l.push(b.serialize())}),l}}class Ks{constructor(l,b){this.type=b.type,this.bindings=[].concat(l),this.result=b}evaluate(l){return this.result.evaluate(l)}eachChild(l){for(const b of this.bindings)l(b[1]);l(this.result)}static parse(l,b){if(l.length<4)return b.error(`Expected at least 3 arguments, but found ${l.length-1} instead.`);const E=[];for(let A=1;A<l.length-1;A+=2){const D=l[A];if(typeof D!="string")return b.error(`Expected string, but found ${typeof D} instead.`,A);if(/[^a-zA-Z0-9_]/.test(D))return b.error("Variable names must contain only alphanumeric characters or '_'.",A);const z=b.parse(l[A+1],A+1);if(!z)return null;E.push([D,z])}const S=b.parse(l[l.length-1],l.length-1,b.expectedType,E);return S?new Ks(E,S):null}outputDefined(){return this.result.outputDefined()}serialize(){const l=["let"];for(const[b,E]of this.bindings)l.push(b,E.serialize());return l.push(this.result.serialize()),l}}class Va{constructor(l,b,E){this.type=l,this.index=b,this.input=E}static parse(l,b){if(l.length!==3)return b.error(`Expected 2 arguments, but found ${l.length-1} instead.`);const E=b.parse(l[1],1,Ct),S=b.parse(l[2],2,sn(b.expectedType||wi));return E&&S?new Va(S.type.itemType,E,S):null}evaluate(l){const b=this.index.evaluate(l),E=this.input.evaluate(l);if(b<0)throw new Sr(`Array index out of bounds: ${b} < 0.`);if(b>=E.length)throw new Sr(`Array index out of bounds: ${b} > ${E.length-1}.`);if(b!==Math.floor(b))throw new Sr(`Array index must be an integer, but found ${b} instead.`);return E[b]}eachChild(l){l(this.index),l(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class ja{constructor(l,b){this.type=bi,this.needle=l,this.haystack=b}static parse(l,b){if(l.length!==3)return b.error(`Expected 2 arguments, but found ${l.length-1} instead.`);const E=b.parse(l[1],1,wi),S=b.parse(l[2],2,wi);return E&&S?Fs(E.type,[bi,Ii,Ct,Xn,wi])?new ja(E,S):b.error(`Expected first argument to be of type boolean, string, number or null, but found ${sr(E.type)} instead`):null}evaluate(l){const b=this.needle.evaluate(l),E=this.haystack.evaluate(l);if(!E)return!1;if(!To(b,["boolean","string","number","null"]))throw new Sr(`Expected first argument to be of type boolean, string, number or null, but found ${sr(pr(b))} instead.`);if(!To(E,["string","array"]))throw new Sr(`Expected second argument to be of type array or string, but found ${sr(pr(E))} instead.`);return E.indexOf(b)>=0}eachChild(l){l(this.needle),l(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class gn{constructor(l,b,E){this.type=Ct,this.needle=l,this.haystack=b,this.fromIndex=E}static parse(l,b){if(l.length<=2||l.length>=5)return b.error(`Expected 3 or 4 arguments, but found ${l.length-1} instead.`);const E=b.parse(l[1],1,wi),S=b.parse(l[2],2,wi);if(!E||!S)return null;if(!Fs(E.type,[bi,Ii,Ct,Xn,wi]))return b.error(`Expected first argument to be of type boolean, string, number or null, but found ${sr(E.type)} instead`);if(l.length===4){const A=b.parse(l[3],3,Ct);return A?new gn(E,S,A):null}return new gn(E,S)}evaluate(l){const b=this.needle.evaluate(l),E=this.haystack.evaluate(l);if(!To(b,["boolean","string","number","null"]))throw new Sr(`Expected first argument to be of type boolean, string, number or null, but found ${sr(pr(b))} instead.`);if(!To(E,["string","array"]))throw new Sr(`Expected second argument to be of type array or string, but found ${sr(pr(E))} instead.`);if(this.fromIndex){const S=this.fromIndex.evaluate(l);return E.indexOf(b,S)}return E.indexOf(b)}eachChild(l){l(this.needle),l(this.haystack),this.fromIndex&&l(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const l=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),l]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Js{constructor(l,b,E,S,A,D){this.inputType=l,this.type=b,this.input=E,this.cases=S,this.outputs=A,this.otherwise=D}static parse(l,b){if(l.length<5)return b.error(`Expected at least 4 arguments, but found only ${l.length-1}.`);if(l.length%2!=1)return b.error("Expected an even number of arguments.");let E,S;b.expectedType&&b.expectedType.kind!=="value"&&(S=b.expectedType);const A={},D=[];for(let V=2;V<l.length-1;V+=2){let Z=l[V];const X=l[V+1];Array.isArray(Z)||(Z=[Z]);const Y=b.concat(V);if(Z.length===0)return Y.error("Expected at least one branch label.");for(const ce of Z){if(typeof ce!="number"&&typeof ce!="string")return Y.error("Branch labels must be numbers or strings.");if(typeof ce=="number"&&Math.abs(ce)>Number.MAX_SAFE_INTEGER)return Y.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof ce=="number"&&Math.floor(ce)!==ce)return Y.error("Numeric branch labels must be integer values.");if(E){if(Y.checkSubtype(E,pr(ce)))return null}else E=pr(ce);if(A[String(ce)]!==void 0)return Y.error("Branch labels must be unique.");A[String(ce)]=D.length}const ie=b.parse(X,V,S);if(!ie)return null;S=S||ie.type,D.push(ie)}const z=b.parse(l[1],1,wi);if(!z)return null;const $=b.parse(l[l.length-1],l.length-1,S);return $?z.type.kind!=="value"&&b.concat(1).checkSubtype(E,z.type)?null:new Js(E,S,z,A,D,$):null}evaluate(l){const b=this.input.evaluate(l);return(pr(b)===this.inputType&&this.outputs[this.cases[b]]||this.otherwise).evaluate(l)}eachChild(l){l(this.input),this.outputs.forEach(l),l(this.otherwise)}outputDefined(){return this.outputs.every(l=>l.outputDefined())&&this.otherwise.outputDefined()}serialize(){const l=["match",this.input.serialize()],b=Object.keys(this.cases).sort(),E=[],S={};for(const D of b){const z=S[this.cases[D]];z===void 0?(S[this.cases[D]]=E.length,E.push([this.cases[D],[D]])):E[z][1].push(D)}const A=D=>this.inputType.kind==="number"?Number(D):D;for(const[D,z]of E)l.push(z.length===1?A(z[0]):z.map(A)),l.push(this.outputs[D].serialize());return l.push(this.otherwise.serialize()),l}}class Kn{constructor(l,b,E){this.type=l,this.branches=b,this.otherwise=E}static parse(l,b){if(l.length<4)return b.error(`Expected at least 3 arguments, but found only ${l.length-1}.`);if(l.length%2!=0)return b.error("Expected an odd number of arguments.");let E;b.expectedType&&b.expectedType.kind!=="value"&&(E=b.expectedType);const S=[];for(let D=1;D<l.length-1;D+=2){const z=b.parse(l[D],D,bi);if(!z)return null;const $=b.parse(l[D+1],D+1,E);if(!$)return null;S.push([z,$]),E=E||$.type}const A=b.parse(l[l.length-1],l.length-1,E);return A?new Kn(E,S,A):null}evaluate(l){for(const[b,E]of this.branches)if(b.evaluate(l))return E.evaluate(l);return this.otherwise.evaluate(l)}eachChild(l){for(const[b,E]of this.branches)l(b),l(E);l(this.otherwise)}outputDefined(){return this.branches.every(([l,b])=>b.outputDefined())&&this.otherwise.outputDefined()}serialize(){const l=["case"];return this.eachChild(b=>{l.push(b.serialize())}),l}}class us{constructor(l,b,E,S){this.type=l,this.input=b,this.beginIndex=E,this.endIndex=S}static parse(l,b){if(l.length<=2||l.length>=5)return b.error(`Expected 3 or 4 arguments, but found ${l.length-1} instead.`);const E=b.parse(l[1],1,wi),S=b.parse(l[2],2,Ct);if(!E||!S)return null;if(!Fs(E.type,[sn(wi),Ii,wi]))return b.error(`Expected first argument to be of type array or string, but found ${sr(E.type)} instead`);if(l.length===4){const A=b.parse(l[3],3,Ct);return A?new us(E.type,E,S,A):null}return new us(E.type,E,S)}evaluate(l){const b=this.input.evaluate(l),E=this.beginIndex.evaluate(l);if(!To(b,["string","array"]))throw new Sr(`Expected first argument to be of type array or string, but found ${sr(pr(b))} instead.`);if(this.endIndex){const S=this.endIndex.evaluate(l);return b.slice(E,S)}return b.slice(E)}eachChild(l){l(this.input),l(this.beginIndex),this.endIndex&&l(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const l=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),l]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Jl(g,l){return g==="=="||g==="!="?l.kind==="boolean"||l.kind==="string"||l.kind==="number"||l.kind==="null"||l.kind==="value":l.kind==="string"||l.kind==="number"||l.kind==="value"}function Qs(g,l,b,E){return E.compare(l,b)===0}function Jn(g,l,b){const E=g!=="=="&&g!=="!=";return class zf{constructor(A,D,z){this.type=bi,this.lhs=A,this.rhs=D,this.collator=z,this.hasUntypedArgument=A.type.kind==="value"||D.type.kind==="value"}static parse(A,D){if(A.length!==3&&A.length!==4)return D.error("Expected two or three arguments.");const z=A[0];let $=D.parse(A[1],1,wi);if(!$)return null;if(!Jl(z,$.type))return D.concat(1).error(`"${z}" comparisons are not supported for type '${sr($.type)}'.`);let V=D.parse(A[2],2,wi);if(!V)return null;if(!Jl(z,V.type))return D.concat(2).error(`"${z}" comparisons are not supported for type '${sr(V.type)}'.`);if($.type.kind!==V.type.kind&&$.type.kind!=="value"&&V.type.kind!=="value")return D.error(`Cannot compare types '${sr($.type)}' and '${sr(V.type)}'.`);E&&($.type.kind==="value"&&V.type.kind!=="value"?$=new ln(V.type,[$]):$.type.kind!=="value"&&V.type.kind==="value"&&(V=new ln($.type,[V])));let Z=null;if(A.length===4){if($.type.kind!=="string"&&V.type.kind!=="string"&&$.type.kind!=="value"&&V.type.kind!=="value")return D.error("Cannot use collator to compare non-string types.");if(Z=D.parse(A[3],3,Jo),!Z)return null}return new zf($,V,Z)}evaluate(A){const D=this.lhs.evaluate(A),z=this.rhs.evaluate(A);if(E&&this.hasUntypedArgument){const $=pr(D),V=pr(z);if($.kind!==V.kind||$.kind!=="string"&&$.kind!=="number")throw new Sr(`Expected arguments for "${g}" to be (string, string) or (number, number), but found (${$.kind}, ${V.kind}) instead.`)}if(this.collator&&!E&&this.hasUntypedArgument){const $=pr(D),V=pr(z);if($.kind!=="string"||V.kind!=="string")return l(A,D,z)}return this.collator?b(A,D,z,this.collator.evaluate(A)):l(A,D,z)}eachChild(A){A(this.lhs),A(this.rhs),this.collator&&A(this.collator)}outputDefined(){return!0}serialize(){const A=[g];return this.eachChild(D=>{A.push(D.serialize())}),A}}}const Ql=Jn("==",function(g,l,b){return l===b},Qs),Ga=Jn("!=",function(g,l,b){return l!==b},function(g,l,b,E){return!Qs(0,l,b,E)}),qa=Jn("<",function(g,l,b){return l<b},function(g,l,b,E){return E.compare(l,b)<0}),eh=Jn(">",function(g,l,b){return l>b},function(g,l,b,E){return E.compare(l,b)>0}),Za=Jn("<=",function(g,l,b){return l<=b},function(g,l,b,E){return E.compare(l,b)<=0}),th=Jn(">=",function(g,l,b){return l>=b},function(g,l,b,E){return E.compare(l,b)>=0});class ea{constructor(l,b,E,S,A){this.type=Ii,this.number=l,this.locale=b,this.currency=E,this.minFractionDigits=S,this.maxFractionDigits=A}static parse(l,b){if(l.length!==3)return b.error("Expected two arguments.");const E=b.parse(l[1],1,Ct);if(!E)return null;const S=l[2];if(typeof S!="object"||Array.isArray(S))return b.error("NumberFormat options argument must be an object.");let A=null;if(S.locale&&(A=b.parse(S.locale,1,Ii),!A))return null;let D=null;if(S.currency&&(D=b.parse(S.currency,1,Ii),!D))return null;let z=null;if(S["min-fraction-digits"]&&(z=b.parse(S["min-fraction-digits"],1,Ct),!z))return null;let $=null;return S["max-fraction-digits"]&&($=b.parse(S["max-fraction-digits"],1,Ct),!$)?null:new ea(E,A,D,z,$)}evaluate(l){return new Intl.NumberFormat(this.locale?this.locale.evaluate(l):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(l):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(l):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(l):void 0}).format(this.number.evaluate(l))}eachChild(l){l(this.number),this.locale&&l(this.locale),this.currency&&l(this.currency),this.minFractionDigits&&l(this.minFractionDigits),this.maxFractionDigits&&l(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const l={};return this.locale&&(l.locale=this.locale.serialize()),this.currency&&(l.currency=this.currency.serialize()),this.minFractionDigits&&(l["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(l["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),l]}}class ta{constructor(l){this.type=Ct,this.input=l}static parse(l,b){if(l.length!==2)return b.error(`Expected 1 argument, but found ${l.length-1} instead.`);const E=b.parse(l[1],1);return E?E.type.kind!=="array"&&E.type.kind!=="string"&&E.type.kind!=="value"?b.error(`Expected argument of type string or array, but found ${sr(E.type)} instead.`):new ta(E):null}evaluate(l){const b=this.input.evaluate(l);if(typeof b=="string"||Array.isArray(b))return b.length;throw new Sr(`Expected value to be of type string or array, but found ${sr(pr(b))} instead.`)}eachChild(l){l(this.input)}outputDefined(){return!1}serialize(){const l=["length"];return this.eachChild(b=>{l.push(b.serialize())}),l}}const _n={"==":Ql,"!=":Ga,">":eh,"<":qa,">=":th,"<=":Za,array:ln,at:Va,boolean:ln,case:Kn,coalesce:co,collator:ts,format:An,image:lo,in:ja,"index-of":gn,interpolate:Xr,"interpolate-hcl":Xr,"interpolate-lab":Xr,length:ta,let:Ks,literal:Hn,match:Js,number:ln,"number-format":ea,object:ln,slice:us,step:ss,string:ln,"to-boolean":In,"to-color":In,"to-number":In,"to-string":In,var:Vs,within:ho};function Xa(g,[l,b,E,S]){l=l.evaluate(g),b=b.evaluate(g),E=E.evaluate(g);const A=S?S.evaluate(g):1,D=Fl(l,b,E,A);if(D)throw new Sr(D);return new Fi(l/255*A,b/255*A,E/255*A,A)}function Ya(g,l){return g in l}function ds(g,l){const b=l[g];return b===void 0?null:b}function Qn(g){return{type:g}}function ih(g){return{result:"success",value:g}}function Bn(g){return{result:"error",value:g}}function Io(g){return g["property-type"]==="data-driven"||g["property-type"]==="cross-faded-data-driven"}function rh(g){return!!g.expression&&g.expression.parameters.indexOf("zoom")>-1}function Ha(g){return!!g.expression&&g.expression.interpolated}function Ui(g){return g instanceof Number?"number":g instanceof String?"string":g instanceof Boolean?"boolean":Array.isArray(g)?"array":g===null?"null":typeof g}function ia(g){return typeof g=="object"&&g!==null&&!Array.isArray(g)}function ra(g){return g}function fs(g,l){const b=l.type==="color",E=g.stops&&typeof g.stops[0][0]=="object",S=E||!(E||g.property!==void 0),A=g.type||(Ha(l)?"exponential":"interval");if(b&&((g=Zn({},g)).stops&&(g.stops=g.stops.map(V=>[V[0],Fi.parse(V[1])])),g.default=Fi.parse(g.default?g.default:l.default)),g.colorSpace&&g.colorSpace!=="rgb"&&!Kl[g.colorSpace])throw new Error(`Unknown color space: ${g.colorSpace}`);let D,z,$;if(A==="exponential")D=nh;else if(A==="interval")D=hc;else if(A==="categorical"){D=na,z=Object.create(null);for(const V of g.stops)z[V[0]]=V[1];$=typeof g.stops[0][0]}else{if(A!=="identity")throw new Error(`Unknown function type "${A}"`);D=cc}if(E){const V={},Z=[];for(let ie=0;ie<g.stops.length;ie++){const ce=g.stops[ie],pe=ce[0].zoom;V[pe]===void 0&&(V[pe]={zoom:pe,type:g.type,property:g.property,default:g.default,stops:[]},Z.push(pe)),V[pe].stops.push([ce[0].value,ce[1]])}const X=[];for(const ie of Z)X.push([V[ie].zoom,fs(V[ie],l)]);const Y={name:"linear"};return{kind:"composite",interpolationType:Y,interpolationFactor:Xr.interpolationFactor.bind(void 0,Y),zoomStops:X.map(ie=>ie[0]),evaluate:({zoom:ie},ce)=>nh({stops:X,base:g.base},l,ie).evaluate(ie,ce)}}if(S){const V=A==="exponential"?{name:"exponential",base:g.base!==void 0?g.base:1}:null;return{kind:"camera",interpolationType:V,interpolationFactor:Xr.interpolationFactor.bind(void 0,V),zoomStops:g.stops.map(Z=>Z[0]),evaluate:({zoom:Z})=>D(g,l,Z,z,$)}}return{kind:"source",evaluate(V,Z){const X=Z&&Z.properties?Z.properties[g.property]:void 0;return X===void 0?zr(g.default,l.default):D(g,l,X,z,$)}}}function zr(g,l,b){return g!==void 0?g:l!==void 0?l:b!==void 0?b:void 0}function na(g,l,b,E,S){return zr(typeof b===S?E[b]:void 0,g.default,l.default)}function hc(g,l,b){if(Ui(b)!=="number")return zr(g.default,l.default);const E=g.stops.length;if(E===1||b<=g.stops[0][0])return g.stops[0][1];if(b>=g.stops[E-1][0])return g.stops[E-1][1];const S=os(g.stops.map(A=>A[0]),b);return g.stops[S][1]}function nh(g,l,b){const E=g.base!==void 0?g.base:1;if(Ui(b)!=="number")return zr(g.default,l.default);const S=g.stops.length;if(S===1||b<=g.stops[0][0])return g.stops[0][1];if(b>=g.stops[S-1][0])return g.stops[S-1][1];const A=os(g.stops.map(Z=>Z[0]),b),D=function(Z,X,Y,ie){const ce=ie-Y,pe=Z-Y;return ce===0?0:X===1?pe/ce:(Math.pow(X,pe)-1)/(Math.pow(X,ce)-1)}(b,E,g.stops[A][0],g.stops[A+1][0]),z=g.stops[A][1],$=g.stops[A+1][1];let V=qs[l.type]||ra;if(g.colorSpace&&g.colorSpace!=="rgb"){const Z=Kl[g.colorSpace];V=(X,Y)=>Z.reverse(Z.interpolate(Z.forward(X),Z.forward(Y),D))}return typeof z.evaluate=="function"?{evaluate(...Z){const X=z.evaluate.apply(void 0,Z),Y=$.evaluate.apply(void 0,Z);if(X!==void 0&&Y!==void 0)return V(X,Y,D)}}:V(z,$,D)}function cc(g,l,b){return l.type==="color"?b=Fi.parse(b):l.type==="formatted"?b=gi.fromString(b.toString()):l.type==="resolvedImage"?b=an.fromString(b.toString()):Ui(b)===l.type||l.type==="enum"&&l.values[b]||(b=void 0),zr(b,g.default,l.default)}Jr.register(_n,{error:[{kind:"error"},[Ii],(g,[l])=>{throw new Sr(l.evaluate(g))}],typeof:[Ii,[wi],(g,[l])=>sr(pr(l.evaluate(g)))],"to-rgba":[sn(Ct,4),[Sn],(g,[l])=>l.evaluate(g).toArray()],rgb:[Sn,[Ct,Ct,Ct],Xa],rgba:[Sn,[Ct,Ct,Ct,Ct],Xa],has:{type:bi,overloads:[[[Ii],(g,[l])=>Ya(l.evaluate(g),g.properties())],[[Ii,Eo],(g,[l,b])=>Ya(l.evaluate(g),b.evaluate(g))]]},get:{type:wi,overloads:[[[Ii],(g,[l])=>ds(l.evaluate(g),g.properties())],[[Ii,Eo],(g,[l,b])=>ds(l.evaluate(g),b.evaluate(g))]]},"feature-state":[wi,[Ii],(g,[l])=>ds(l.evaluate(g),g.featureState||{})],properties:[Eo,[],g=>g.properties()],"geometry-type":[Ii,[],g=>g.geometryType()],id:[wi,[],g=>g.id()],zoom:[Ct,[],g=>g.globals.zoom],pitch:[Ct,[],g=>g.globals.pitch||0],"distance-from-center":[Ct,[],g=>g.distanceFromCenter()],"heatmap-density":[Ct,[],g=>g.globals.heatmapDensity||0],"line-progress":[Ct,[],g=>g.globals.lineProgress||0],"sky-radial-progress":[Ct,[],g=>g.globals.skyRadialProgress||0],accumulated:[wi,[],g=>g.globals.accumulated===void 0?null:g.globals.accumulated],"+":[Ct,Qn(Ct),(g,l)=>{let b=0;for(const E of l)b+=E.evaluate(g);return b}],"*":[Ct,Qn(Ct),(g,l)=>{let b=1;for(const E of l)b*=E.evaluate(g);return b}],"-":{type:Ct,overloads:[[[Ct,Ct],(g,[l,b])=>l.evaluate(g)-b.evaluate(g)],[[Ct],(g,[l])=>-l.evaluate(g)]]},"/":[Ct,[Ct,Ct],(g,[l,b])=>l.evaluate(g)/b.evaluate(g)],"%":[Ct,[Ct,Ct],(g,[l,b])=>l.evaluate(g)%b.evaluate(g)],ln2:[Ct,[],()=>Math.LN2],pi:[Ct,[],()=>Math.PI],e:[Ct,[],()=>Math.E],"^":[Ct,[Ct,Ct],(g,[l,b])=>Math.pow(l.evaluate(g),b.evaluate(g))],sqrt:[Ct,[Ct],(g,[l])=>Math.sqrt(l.evaluate(g))],log10:[Ct,[Ct],(g,[l])=>Math.log(l.evaluate(g))/Math.LN10],ln:[Ct,[Ct],(g,[l])=>Math.log(l.evaluate(g))],log2:[Ct,[Ct],(g,[l])=>Math.log(l.evaluate(g))/Math.LN2],sin:[Ct,[Ct],(g,[l])=>Math.sin(l.evaluate(g))],cos:[Ct,[Ct],(g,[l])=>Math.cos(l.evaluate(g))],tan:[Ct,[Ct],(g,[l])=>Math.tan(l.evaluate(g))],asin:[Ct,[Ct],(g,[l])=>Math.asin(l.evaluate(g))],acos:[Ct,[Ct],(g,[l])=>Math.acos(l.evaluate(g))],atan:[Ct,[Ct],(g,[l])=>Math.atan(l.evaluate(g))],min:[Ct,Qn(Ct),(g,l)=>Math.min(...l.map(b=>b.evaluate(g)))],max:[Ct,Qn(Ct),(g,l)=>Math.max(...l.map(b=>b.evaluate(g)))],abs:[Ct,[Ct],(g,[l])=>Math.abs(l.evaluate(g))],round:[Ct,[Ct],(g,[l])=>{const b=l.evaluate(g);return b<0?-Math.round(-b):Math.round(b)}],floor:[Ct,[Ct],(g,[l])=>Math.floor(l.evaluate(g))],ceil:[Ct,[Ct],(g,[l])=>Math.ceil(l.evaluate(g))],"filter-==":[bi,[Ii,wi],(g,[l,b])=>g.properties()[l.value]===b.value],"filter-id-==":[bi,[wi],(g,[l])=>g.id()===l.value],"filter-type-==":[bi,[Ii],(g,[l])=>g.geometryType()===l.value],"filter-<":[bi,[Ii,wi],(g,[l,b])=>{const E=g.properties()[l.value],S=b.value;return typeof E==typeof S&&E<S}],"filter-id-<":[bi,[wi],(g,[l])=>{const b=g.id(),E=l.value;return typeof b==typeof E&&b<E}],"filter->":[bi,[Ii,wi],(g,[l,b])=>{const E=g.properties()[l.value],S=b.value;return typeof E==typeof S&&E>S}],"filter-id->":[bi,[wi],(g,[l])=>{const b=g.id(),E=l.value;return typeof b==typeof E&&b>E}],"filter-<=":[bi,[Ii,wi],(g,[l,b])=>{const E=g.properties()[l.value],S=b.value;return typeof E==typeof S&&E<=S}],"filter-id-<=":[bi,[wi],(g,[l])=>{const b=g.id(),E=l.value;return typeof b==typeof E&&b<=E}],"filter->=":[bi,[Ii,wi],(g,[l,b])=>{const E=g.properties()[l.value],S=b.value;return typeof E==typeof S&&E>=S}],"filter-id->=":[bi,[wi],(g,[l])=>{const b=g.id(),E=l.value;return typeof b==typeof E&&b>=E}],"filter-has":[bi,[wi],(g,[l])=>l.value in g.properties()],"filter-has-id":[bi,[],g=>g.id()!==null&&g.id()!==void 0],"filter-type-in":[bi,[sn(Ii)],(g,[l])=>l.value.indexOf(g.geometryType())>=0],"filter-id-in":[bi,[sn(wi)],(g,[l])=>l.value.indexOf(g.id())>=0],"filter-in-small":[bi,[Ii,sn(wi)],(g,[l,b])=>b.value.indexOf(g.properties()[l.value])>=0],"filter-in-large":[bi,[Ii,sn(wi)],(g,[l,b])=>function(E,S,A,D){for(;A<=D;){const z=A+D>>1;if(S[z]===E)return!0;S[z]>E?D=z-1:A=z+1}return!1}(g.properties()[l.value],b.value,0,b.value.length-1)],all:{type:bi,overloads:[[[bi,bi],(g,[l,b])=>l.evaluate(g)&&b.evaluate(g)],[Qn(bi),(g,l)=>{for(const b of l)if(!b.evaluate(g))return!1;return!0}]]},any:{type:bi,overloads:[[[bi,bi],(g,[l,b])=>l.evaluate(g)||b.evaluate(g)],[Qn(bi),(g,l)=>{for(const b of l)if(b.evaluate(g))return!0;return!1}]]},"!":[bi,[bi],(g,[l])=>!l.evaluate(g)],"is-supported-script":[bi,[Ii],(g,[l])=>{const b=g.globals&&g.globals.isSupportedScript;return!b||b(l.evaluate(g))}],upcase:[Ii,[Ii],(g,[l])=>l.evaluate(g).toUpperCase()],downcase:[Ii,[Ii],(g,[l])=>l.evaluate(g).toLowerCase()],concat:[Ii,Qn(wi),(g,l)=>l.map(b=>es(b.evaluate(g))).join("")],"resolved-locale":[Ii,[Jo],(g,[l])=>l.evaluate(g).resolvedLocale()]});class Wa{constructor(l,b){this.expression=l,this._warningHistory={},this._evaluator=new $l,this._defaultValue=b?function(E){return E.type==="color"&&ia(E.default)?new Fi(0,0,0,0):E.type==="color"?Fi.parse(E.default)||null:E.default===void 0?null:E.default}(b):null,this._enumValues=b&&b.type==="enum"?b.values:null}evaluateWithoutErrorHandling(l,b,E,S,A,D,z,$){return this._evaluator.globals=l,this._evaluator.feature=b,this._evaluator.featureState=E,this._evaluator.canonical=S,this._evaluator.availableImages=A||null,this._evaluator.formattedSection=D,this._evaluator.featureTileCoord=z||null,this._evaluator.featureDistanceData=$||null,this.expression.evaluate(this._evaluator)}evaluate(l,b,E,S,A,D,z,$){this._evaluator.globals=l,this._evaluator.feature=b||null,this._evaluator.featureState=E||null,this._evaluator.canonical=S,this._evaluator.availableImages=A||null,this._evaluator.formattedSection=D||null,this._evaluator.featureTileCoord=z||null,this._evaluator.featureDistanceData=$||null;try{const V=this.expression.evaluate(this._evaluator);if(V==null||typeof V=="number"&&V!=V)return this._defaultValue;if(this._enumValues&&!(V in this._enumValues))throw new Sr(`Expected value to be one of ${Object.keys(this._enumValues).map(Z=>JSON.stringify(Z)).join(", ")}, but found ${JSON.stringify(V)} instead.`);return V}catch(V){return this._warningHistory[V.message]||(this._warningHistory[V.message]=!0,typeof console!="undefined"&&console.warn(V.message)),this._defaultValue}}}function ko(g){return Array.isArray(g)&&g.length>0&&typeof g[0]=="string"&&g[0]in _n}function ps(g,l){const b=new js(_n,[],l?function(S){const A={color:Sn,string:Ii,number:Ct,enum:Ii,boolean:bi,formatted:Yn,resolvedImage:Qo};return S.type==="array"?sn(A[S.value]||wi,S.length):A[S.type]}(l):void 0),E=b.parse(g,void 0,void 0,void 0,l&&l.type==="string"?{typeAnnotation:"coerce"}:void 0);return E?ih(new Wa(E,l)):Bn(b.errors)}class ms{constructor(l,b){this.kind=l,this._styleExpression=b,this.isStateDependent=l!=="constant"&&!rs(b.expression)}evaluateWithoutErrorHandling(l,b,E,S,A,D){return this._styleExpression.evaluateWithoutErrorHandling(l,b,E,S,A,D)}evaluate(l,b,E,S,A,D){return this._styleExpression.evaluate(l,b,E,S,A,D)}}class Ka{constructor(l,b,E,S){this.kind=l,this.zoomStops=E,this._styleExpression=b,this.isStateDependent=l!=="camera"&&!rs(b.expression),this.interpolationType=S}evaluateWithoutErrorHandling(l,b,E,S,A,D){return this._styleExpression.evaluateWithoutErrorHandling(l,b,E,S,A,D)}evaluate(l,b,E,S,A,D){return this._styleExpression.evaluate(l,b,E,S,A,D)}interpolationFactor(l,b,E){return this.interpolationType?Xr.interpolationFactor(this.interpolationType,l,b,E):0}}function oh(g,l){if((g=ps(g,l)).result==="error")return g;const b=g.value.expression,E=Ao(b);if(!E&&!Io(l))return Bn([new Mn("","data expressions not supported")]);const S=ns(b,["zoom","pitch","distance-from-center"]);if(!S&&!rh(l))return Bn([new Mn("","zoom expressions not supported")]);const A=oa(b);return A||S?A instanceof Mn?Bn([A]):A instanceof Xr&&!Ha(l)?Bn([new Mn("",'"interpolate" expressions cannot be used with this property')]):ih(A?new Ka(E?"camera":"composite",g.value,A.labels,A instanceof Xr?A.interpolation:void 0):new ms(E?"constant":"source",g.value)):Bn([new Mn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Co{constructor(l,b){this._parameters=l,this._specification=b,Zn(this,fs(this._parameters,this._specification))}static deserialize(l){return new Co(l._parameters,l._specification)}static serialize(l){return{_parameters:l._parameters,_specification:l._specification}}}function oa(g){let l=null;if(g instanceof Ks)l=oa(g.result);else if(g instanceof co){for(const b of g.args)if(l=oa(b),l)break}else(g instanceof ss||g instanceof Xr)&&g.input instanceof Jr&&g.input.name==="zoom"&&(l=g);return l instanceof Mn||g.eachChild(b=>{const E=oa(b);E instanceof Mn?l=E:!l&&E?l=new Mn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):l&&E&&l!==E&&(l=new Mn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),l}function hn(g){const l=g.key,b=g.value,E=g.valueSpec||{},S=g.objectElementValidators||{},A=g.style,D=g.styleSpec;let z=[];const $=Ui(b);if($!=="object")return[new Dt(l,b,`object expected, ${$} found`)];for(const V in b){const Z=V.split(".")[0],X=E[Z]||E["*"];let Y;if(S[Z])Y=S[Z];else if(E[Z])Y=Ar;else if(S["*"])Y=S["*"];else{if(!E["*"]){z.push(new Dt(l,b[V],`unknown property "${V}"`));continue}Y=Ar}z=z.concat(Y({key:(l&&`${l}.`)+V,value:b[V],valueSpec:X,style:A,styleSpec:D,object:b,objectKey:V},b))}for(const V in E)S[V]||E[V].required&&E[V].default===void 0&&b[V]===void 0&&z.push(new Dt(l,b,`missing required property "${V}"`));return z}function Ja(g){const l=g.value,b=g.valueSpec,E=g.style,S=g.styleSpec,A=g.key,D=g.arrayElementValidator||Ar;if(Ui(l)!=="array")return[new Dt(A,l,`array expected, ${Ui(l)} found`)];if(b.length&&l.length!==b.length)return[new Dt(A,l,`array length ${b.length} expected, length ${l.length} found`)];if(b["min-length"]&&l.length<b["min-length"])return[new Dt(A,l,`array length at least ${b["min-length"]} expected, length ${l.length} found`)];let z={type:b.value,values:b.values,minimum:b.minimum,maximum:b.maximum};S.$version<7&&(z.function=b.function),Ui(b.value)==="object"&&(z=b.value);let $=[];for(let V=0;V<l.length;V++)$=$.concat(D({array:l,arrayIndex:V,value:l[V],valueSpec:z,style:E,styleSpec:S,key:`${A}[${V}]`}));return $}function sh(g){const l=g.key,b=g.value,E=g.valueSpec;let S=Ui(b);if(S==="number"&&b!=b&&(S="NaN"),S!=="number")return[new Dt(l,b,`number expected, ${S} found`)];if("minimum"in E){let A=E.minimum;if(Ui(E.minimum)==="array"&&(A=E.minimum[g.arrayIndex]),b<A)return[new Dt(l,b,`${b} is less than the minimum value ${A}`)]}if("maximum"in E){let A=E.maximum;if(Ui(E.maximum)==="array"&&(A=E.maximum[g.arrayIndex]),b>A)return[new Dt(l,b,`${b} is greater than the maximum value ${A}`)]}return[]}function sa(g){const l=g.valueSpec,b=cr(g.value.type);let E,S,A,D={};const z=b!=="categorical"&&g.value.property===void 0,$=!z,V=Ui(g.value.stops)==="array"&&Ui(g.value.stops[0])==="array"&&Ui(g.value.stops[0][0])==="object",Z=hn({key:g.key,value:g.value,valueSpec:g.styleSpec.function,style:g.style,styleSpec:g.styleSpec,objectElementValidators:{stops:function(ie){if(b==="identity")return[new Dt(ie.key,ie.value,'identity function may not have a "stops" property')];let ce=[];const pe=ie.value;return ce=ce.concat(Ja({key:ie.key,value:pe,valueSpec:ie.valueSpec,style:ie.style,styleSpec:ie.styleSpec,arrayElementValidator:X})),Ui(pe)==="array"&&pe.length===0&&ce.push(new Dt(ie.key,pe,"array must have at least one stop")),ce},default:function(ie){return Ar({key:ie.key,value:ie.value,valueSpec:l,style:ie.style,styleSpec:ie.styleSpec})}}});return b==="identity"&&z&&Z.push(new Dt(g.key,g.value,'missing required property "property"')),b==="identity"||g.value.stops||Z.push(new Dt(g.key,g.value,'missing required property "stops"')),b==="exponential"&&g.valueSpec.expression&&!Ha(g.valueSpec)&&Z.push(new Dt(g.key,g.value,"exponential functions not supported")),g.styleSpec.$version>=8&&($&&!Io(g.valueSpec)?Z.push(new Dt(g.key,g.value,"property functions not supported")):z&&!rh(g.valueSpec)&&Z.push(new Dt(g.key,g.value,"zoom functions not supported"))),b!=="categorical"&&!V||g.value.property!==void 0||Z.push(new Dt(g.key,g.value,'"property" property is required')),Z;function X(ie){let ce=[];const pe=ie.value,ve=ie.key;if(Ui(pe)!=="array")return[new Dt(ve,pe,`array expected, ${Ui(pe)} found`)];if(pe.length!==2)return[new Dt(ve,pe,`array length 2 expected, length ${pe.length} found`)];if(V){if(Ui(pe[0])!=="object")return[new Dt(ve,pe,`object expected, ${Ui(pe[0])} found`)];if(pe[0].zoom===void 0)return[new Dt(ve,pe,"object stop key must have zoom")];if(pe[0].value===void 0)return[new Dt(ve,pe,"object stop key must have value")];if(A&&A>cr(pe[0].zoom))return[new Dt(ve,pe[0].zoom,"stop zoom values must appear in ascending order")];cr(pe[0].zoom)!==A&&(A=cr(pe[0].zoom),S=void 0,D={}),ce=ce.concat(hn({key:`${ve}[0]`,value:pe[0],valueSpec:{zoom:{}},style:ie.style,styleSpec:ie.styleSpec,objectElementValidators:{zoom:sh,value:Y}}))}else ce=ce.concat(Y({key:`${ve}[0]`,value:pe[0],valueSpec:{},style:ie.style,styleSpec:ie.styleSpec},pe));return ko(Rn(pe[1]))?ce.concat([new Dt(`${ve}[1]`,pe[1],"expressions are not allowed in function stops.")]):ce.concat(Ar({key:`${ve}[1]`,value:pe[1],valueSpec:l,style:ie.style,styleSpec:ie.styleSpec}))}function Y(ie,ce){const pe=Ui(ie.value),ve=cr(ie.value),Ae=ie.value!==null?ie.value:ce;if(E){if(pe!==E)return[new Dt(ie.key,Ae,`${pe} stop domain type must match previous stop domain type ${E}`)]}else E=pe;if(pe!=="number"&&pe!=="string"&&pe!=="boolean")return[new Dt(ie.key,Ae,"stop domain value must be a number, string, or boolean")];if(pe!=="number"&&b!=="categorical"){let Be=`number expected, ${pe} found`;return Io(l)&&b===void 0&&(Be+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Dt(ie.key,Ae,Be)]}return b!=="categorical"||pe!=="number"||isFinite(ve)&&Math.floor(ve)===ve?b!=="categorical"&&pe==="number"&&S!==void 0&&ve<S?[new Dt(ie.key,Ae,"stop domain values must appear in ascending order")]:(S=ve,b==="categorical"&&ve in D?[new Dt(ie.key,Ae,"stop domain values must be unique")]:(D[ve]=!0,[])):[new Dt(ie.key,Ae,`integer expected, found ${ve}`)]}}function Ln(g){const l=(g.expressionContext==="property"?oh:ps)(Rn(g.value),g.valueSpec);if(l.result==="error")return l.value.map(E=>new Dt(`${g.key}${E.key}`,g.value,E.message));const b=l.value.expression||l.value._styleExpression.expression;if(g.expressionContext==="property"&&g.propertyKey==="text-font"&&!b.outputDefined())return[new Dt(g.key,g.value,`Invalid data expression for "${g.propertyKey}". Output values must be contained as literals within the expression.`)];if(g.expressionContext==="property"&&g.propertyType==="layout"&&!rs(b))return[new Dt(g.key,g.value,'"feature-state" data expressions are not supported with layout properties.')];if(g.expressionContext==="filter")return Qa(b,g);if(g.expressionContext&&g.expressionContext.indexOf("cluster")===0){if(!ns(b,["zoom","feature-state"]))return[new Dt(g.key,g.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(g.expressionContext==="cluster-initial"&&!Ao(b))return[new Dt(g.key,g.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Qa(g,l){const b=new Set(["zoom","feature-state","pitch","distance-from-center"]);for(const S of l.valueSpec.expression.parameters)b.delete(S);if(b.size===0)return[];const E=[];return g instanceof Jr&&b.has(g.name)?[new Dt(l.key,l.value,`["${g.name}"] expression is not supported in a filter for a ${l.object.type} layer with id: ${l.object.id}`)]:(g.eachChild(S=>{E.push(...Qa(S,l))}),E)}function aa(g){const l=g.key,b=g.value,E=g.valueSpec,S=[];return Array.isArray(E.values)?E.values.indexOf(cr(b))===-1&&S.push(new Dt(l,b,`expected one of [${E.values.join(", ")}], ${JSON.stringify(b)} found`)):Object.keys(E.values).indexOf(cr(b))===-1&&S.push(new Dt(l,b,`expected one of [${Object.keys(E.values).join(", ")}], ${JSON.stringify(b)} found`)),S}function la(g){if(g===!0||g===!1)return!0;if(!Array.isArray(g)||g.length===0)return!1;switch(g[0]){case"has":return g.length>=2&&g[1]!=="$id"&&g[1]!=="$type";case"in":return g.length>=3&&(typeof g[1]!="string"||Array.isArray(g[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return g.length!==3||Array.isArray(g[1])||Array.isArray(g[2]);case"any":case"all":for(const l of g.slice(1))if(!la(l)&&typeof l!="boolean")return!1;return!0;default:return!0}}function ha(g,l="fill"){if(g==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};la(g)||(g=ua(g));const b=g;let E=!0;try{E=function(V){if(!Do(V))return V;let Z=Rn(V);return ah(Z),Z=ca(Z),Z}(b)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(b,null,2)}
        `)}const S=et[`filter_${l}`],A=ps(E,S);let D=null;if(A.result==="error")throw new Error(A.value.map(V=>`${V.key}: ${V.message}`).join(", "));D=(V,Z,X)=>A.value.evaluate(V,Z,{},X);let z=null,$=null;if(E!==b){const V=ps(b,S);if(V.result==="error")throw new Error(V.value.map(Z=>`${Z.key}: ${Z.message}`).join(", "));z=(Z,X,Y,ie,ce)=>V.value.evaluate(Z,X,{},Y,void 0,void 0,ie,ce),$=!Ao(V.value.expression)}return D=D,{filter:D,dynamicFilter:z||void 0,needGeometry:el(E),needFeature:!!$}}function ca(g){if(!Array.isArray(g))return g;const l=function(b){if(uc.has(b[0])){for(let E=1;E<b.length;E++)if(Do(b[E]))return!0}return b}(g);return l===!0?l:l.map(b=>ca(b))}function ah(g){let l=!1;const b=[];if(g[0]==="case"){for(let E=1;E<g.length-1;E+=2)l=l||Do(g[E]),b.push(g[E+1]);b.push(g[g.length-1])}else if(g[0]==="match"){l=l||Do(g[1]);for(let E=2;E<g.length-1;E+=2)b.push(g[E+1]);b.push(g[g.length-1])}else if(g[0]==="step"){l=l||Do(g[1]);for(let E=1;E<g.length-1;E+=2)b.push(g[E+1])}l&&(g.length=0,g.push("any",...b));for(let E=1;E<g.length;E++)ah(g[E])}function Do(g){if(!Array.isArray(g))return!1;if((l=g[0])==="pitch"||l==="distance-from-center")return!0;var l;for(let b=1;b<g.length;b++)if(Do(g[b]))return!0;return!1}const uc=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function dc(g,l){return g<l?-1:g>l?1:0}function el(g){if(!Array.isArray(g))return!1;if(g[0]==="within")return!0;for(let l=1;l<g.length;l++)if(el(g[l]))return!0;return!1}function ua(g){if(!g)return!0;const l=g[0];return g.length<=1?l!=="any":l==="=="?tl(g[1],g[2],"=="):l==="!="?da(tl(g[1],g[2],"==")):l==="<"||l===">"||l==="<="||l===">="?tl(g[1],g[2],l):l==="any"?(b=g.slice(1),["any"].concat(b.map(ua))):l==="all"?["all"].concat(g.slice(1).map(ua)):l==="none"?["all"].concat(g.slice(1).map(ua).map(da)):l==="in"?lh(g[1],g.slice(2)):l==="!in"?da(lh(g[1],g.slice(2))):l==="has"?hh(g[1]):l==="!has"?da(hh(g[1])):l!=="within"||g;var b}function tl(g,l,b){switch(g){case"$type":return[`filter-type-${b}`,l];case"$id":return[`filter-id-${b}`,l];default:return[`filter-${b}`,g,l]}}function lh(g,l){if(l.length===0)return!1;switch(g){case"$type":return["filter-type-in",["literal",l]];case"$id":return["filter-id-in",["literal",l]];default:return l.length>200&&!l.some(b=>typeof b!=typeof l[0])?["filter-in-large",g,["literal",l.sort(dc)]]:["filter-in-small",g,["literal",l]]}}function hh(g){switch(g){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",g]}}function da(g){return["!",g]}function il(g){if(la(Rn(g.value))){const l=Rn(g.layerType);return Ln(Zn({},g,{expressionContext:"filter",valueSpec:g.styleSpec[`filter_${l||"fill"}`]}))}return ch(g)}function ch(g){const l=g.value,b=g.key;if(Ui(l)!=="array")return[new Dt(b,l,`array expected, ${Ui(l)} found`)];const E=g.styleSpec;let S,A=[];if(l.length<1)return[new Dt(b,l,"filter array must have at least 1 element")];switch(A=A.concat(aa({key:`${b}[0]`,value:l[0],valueSpec:E.filter_operator,style:g.style,styleSpec:g.styleSpec})),cr(l[0])){case"<":case"<=":case">":case">=":l.length>=2&&cr(l[1])==="$type"&&A.push(new Dt(b,l,`"$type" cannot be use with operator "${l[0]}"`));case"==":case"!=":l.length!==3&&A.push(new Dt(b,l,`filter array for operator "${l[0]}" must have 3 elements`));case"in":case"!in":l.length>=2&&(S=Ui(l[1]),S!=="string"&&A.push(new Dt(`${b}[1]`,l[1],`string expected, ${S} found`)));for(let D=2;D<l.length;D++)S=Ui(l[D]),cr(l[1])==="$type"?A=A.concat(aa({key:`${b}[${D}]`,value:l[D],valueSpec:E.geometry_type,style:g.style,styleSpec:g.styleSpec})):S!=="string"&&S!=="number"&&S!=="boolean"&&A.push(new Dt(`${b}[${D}]`,l[D],`string, number, or boolean expected, ${S} found`));break;case"any":case"all":case"none":for(let D=1;D<l.length;D++)A=A.concat(ch({key:`${b}[${D}]`,value:l[D],style:g.style,styleSpec:g.styleSpec}));break;case"has":case"!has":S=Ui(l[1]),l.length!==2?A.push(new Dt(b,l,`filter array for "${l[0]}" operator must have 2 elements`)):S!=="string"&&A.push(new Dt(`${b}[1]`,l[1],`string expected, ${S} found`));break;case"within":S=Ui(l[1]),l.length!==2?A.push(new Dt(b,l,`filter array for "${l[0]}" operator must have 2 elements`)):S!=="object"&&A.push(new Dt(`${b}[1]`,l[1],`object expected, ${S} found`))}return A}function gs(g,l){const b=g.key,E=g.style,S=g.styleSpec,A=g.value,D=g.objectKey,z=S[`${l}_${g.layerType}`];if(!z)return[];const $=D.match(/^(.*)-transition$/);if(l==="paint"&&$&&z[$[1]]&&z[$[1]].transition)return Ar({key:b,value:A,valueSpec:S.transition,style:E,styleSpec:S});const V=g.valueSpec||z[D];if(!V)return[new Dt(b,A,`unknown property "${D}"`)];let Z;if(Ui(A)==="string"&&Io(V)&&!V.tokens&&(Z=/^{([^}]+)}$/.exec(A)))return[new Dt(b,A,`"${D}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(Z[1])} }\`.`)];const X=[];return g.layerType==="symbol"&&(D==="text-field"&&E&&!E.glyphs&&X.push(new Dt(b,A,'use of "text-field" requires a style "glyphs" property')),D==="text-font"&&ia(Rn(A))&&cr(A.type)==="identity"&&X.push(new Dt(b,A,'"text-font" does not support identity functions'))),X.concat(Ar({key:g.key,value:A,valueSpec:V,style:E,styleSpec:S,expressionContext:"property",propertyType:l,propertyKey:D}))}function uh(g){return gs(g,"paint")}function dh(g){return gs(g,"layout")}function _s(g){let l=[];const b=g.value,E=g.key,S=g.style,A=g.styleSpec;b.type||b.ref||l.push(new Dt(E,b,'either "type" or "ref" is required'));let D=cr(b.type);const z=cr(b.ref);if(b.id){const $=cr(b.id);for(let V=0;V<g.arrayIndex;V++){const Z=S.layers[V];cr(Z.id)===$&&l.push(new Dt(E,b.id,`duplicate layer id "${b.id}", previously used at line ${Z.id.__line__}`))}}if("ref"in b){let $;["type","source","source-layer","filter","layout"].forEach(V=>{V in b&&l.push(new Dt(E,b[V],`"${V}" is prohibited for ref layers`))}),S.layers.forEach(V=>{cr(V.id)===z&&($=V)}),$?$.ref?l.push(new Dt(E,b.ref,"ref cannot reference another ref layer")):D=cr($.type):l.push(new Dt(E,b.ref,`ref layer "${z}" not found`))}else if(D!=="background"&&D!=="sky")if(b.source){const $=S.sources&&S.sources[b.source],V=$&&cr($.type);$?V==="vector"&&D==="raster"?l.push(new Dt(E,b.source,`layer "${b.id}" requires a raster source`)):V==="raster"&&D!=="raster"?l.push(new Dt(E,b.source,`layer "${b.id}" requires a vector source`)):V!=="vector"||b["source-layer"]?V==="raster-dem"&&D!=="hillshade"?l.push(new Dt(E,b.source,"raster-dem source can only be used with layer type 'hillshade'.")):D!=="line"||!b.paint||!b.paint["line-gradient"]||V==="geojson"&&$.lineMetrics||l.push(new Dt(E,b,`layer "${b.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):l.push(new Dt(E,b,`layer "${b.id}" must specify a "source-layer"`)):l.push(new Dt(E,b.source,`source "${b.source}" not found`))}else l.push(new Dt(E,b,'missing required property "source"'));return l=l.concat(hn({key:E,value:b,valueSpec:A.layer,style:g.style,styleSpec:g.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Ar({key:`${E}.type`,value:b.type,valueSpec:A.layer.type,style:g.style,styleSpec:g.styleSpec,object:b,objectKey:"type"}),filter:$=>il(Zn({layerType:D},$)),layout:$=>hn({layer:b,key:$.key,value:$.value,style:$.style,styleSpec:$.styleSpec,objectElementValidators:{"*":V=>dh(Zn({layerType:D},V))}}),paint:$=>hn({layer:b,key:$.key,value:$.value,style:$.style,styleSpec:$.styleSpec,objectElementValidators:{"*":V=>uh(Zn({layerType:D},V))}})}})),l}function Po(g){const l=g.value,b=g.key,E=Ui(l);return E!=="string"?[new Dt(b,l,`string expected, ${E} found`)]:[]}const rl={promoteId:function({key:g,value:l}){if(Ui(l)==="string")return Po({key:g,value:l});{const b=[];for(const E in l)b.push(...Po({key:`${g}.${E}`,value:l[E]}));return b}}};function fh(g){const l=g.value,b=g.key,E=g.styleSpec,S=g.style;if(!l.type)return[new Dt(b,l,'"type" is required')];const A=cr(l.type);let D;switch(A){case"vector":case"raster":case"raster-dem":return D=hn({key:b,value:l,valueSpec:E[`source_${A.replace("-","_")}`],style:g.style,styleSpec:E,objectElementValidators:rl}),D;case"geojson":if(D=hn({key:b,value:l,valueSpec:E.source_geojson,style:S,styleSpec:E,objectElementValidators:rl}),l.cluster)for(const z in l.clusterProperties){const[$,V]=l.clusterProperties[z],Z=typeof $=="string"?[$,["accumulated"],["get",z]]:$;D.push(...Ln({key:`${b}.${z}.map`,value:V,expressionContext:"cluster-map"})),D.push(...Ln({key:`${b}.${z}.reduce`,value:Z,expressionContext:"cluster-reduce"}))}return D;case"video":return hn({key:b,value:l,valueSpec:E.source_video,style:S,styleSpec:E});case"image":return hn({key:b,value:l,valueSpec:E.source_image,style:S,styleSpec:E});case"canvas":return[new Dt(b,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return aa({key:`${b}.type`,value:l.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:S,styleSpec:E})}}function nl(g){const l=g.value,b=g.styleSpec,E=b.light,S=g.style;let A=[];const D=Ui(l);if(l===void 0)return A;if(D!=="object")return A=A.concat([new Dt("light",l,`object expected, ${D} found`)]),A;for(const z in l){const $=z.match(/^(.*)-transition$/);A=A.concat($&&E[$[1]]&&E[$[1]].transition?Ar({key:z,value:l[z],valueSpec:b.transition,style:S,styleSpec:b}):E[z]?Ar({key:z,value:l[z],valueSpec:E[z],style:S,styleSpec:b}):[new Dt(z,l[z],`unknown property "${z}"`)])}return A}function ol(g){const l=g.value,b=g.key,E=g.style,S=g.styleSpec,A=S.terrain;let D=[];const z=Ui(l);if(l===void 0)return D;if(z!=="object")return D=D.concat([new Dt("terrain",l,`object expected, ${z} found`)]),D;for(const $ in l){const V=$.match(/^(.*)-transition$/);D=D.concat(V&&A[V[1]]&&A[V[1]].transition?Ar({key:$,value:l[$],valueSpec:S.transition,style:E,styleSpec:S}):A[$]?Ar({key:$,value:l[$],valueSpec:A[$],style:E,styleSpec:S}):[new Dt($,l[$],`unknown property "${$}"`)])}if(l.source){const $=E.sources&&E.sources[l.source],V=$&&cr($.type);$?V!=="raster-dem"&&D.push(new Dt(b,l.source,`terrain cannot be used with a source of type ${V}, it only be used with a "raster-dem" source type`)):D.push(new Dt(b,l.source,`source "${l.source}" not found`))}else D.push(new Dt(b,l,'terrain is missing required property "source"'));return D}function sl(g){const l=g.value,b=g.style,E=g.styleSpec,S=E.fog;let A=[];const D=Ui(l);if(l===void 0)return A;if(D!=="object")return A=A.concat([new Dt("fog",l,`object expected, ${D} found`)]),A;for(const z in l){const $=z.match(/^(.*)-transition$/);A=A.concat($&&S[$[1]]&&S[$[1]].transition?Ar({key:z,value:l[z],valueSpec:E.transition,style:b,styleSpec:E}):S[z]?Ar({key:z,value:l[z],valueSpec:S[z],style:b,styleSpec:E}):[new Dt(z,l[z],`unknown property "${z}"`)])}return A}const al={"*":()=>[],array:Ja,boolean:function(g){const l=g.value,b=g.key,E=Ui(l);return E!=="boolean"?[new Dt(b,l,`boolean expected, ${E} found`)]:[]},number:sh,color:function(g){const l=g.key,b=g.value,E=Ui(b);return E!=="string"?[new Dt(l,b,`color expected, ${E} found`)]:So.parseCSSColor(b)===null?[new Dt(l,b,`color expected, "${b}" found`)]:[]},constants:zl,enum:aa,filter:il,function:sa,layer:_s,object:hn,source:fh,light:nl,terrain:ol,fog:sl,string:Po,formatted:function(g){return Po(g).length===0?[]:Ln(g)},resolvedImage:function(g){return Po(g).length===0?[]:Ln(g)},projection:function(g){const l=g.value,b=g.styleSpec,E=b.projection,S=g.style;let A=[];const D=Ui(l);if(D==="object")for(const z in l)A=A.concat(Ar({key:z,value:l[z],valueSpec:E[z],style:S,styleSpec:b}));else D!=="string"&&(A=A.concat([new Dt("projection",l,`object or string expected, ${D} found`)]));return A}};function Ar(g){const l=g.value,b=g.valueSpec,E=g.styleSpec;return b.expression&&ia(cr(l))?sa(g):b.expression&&ko(Rn(l))?Ln(g):b.type&&al[b.type]?al[b.type](g):hn(Zn({},g,{valueSpec:b.type?E[b.type]:b}))}function ll(g){const l=g.value,b=g.key,E=Po(g);return E.length||(l.indexOf("{fontstack}")===-1&&E.push(new Dt(b,l,'"glyphs" url must include a "{fontstack}" token')),l.indexOf("{range}")===-1&&E.push(new Dt(b,l,'"glyphs" url must include a "{range}" token'))),E}function zn(g,l=et){let b=[];return b=b.concat(Ar({key:"",value:g,valueSpec:l.$root,styleSpec:l,style:g,objectElementValidators:{glyphs:ll,"*":()=>[]}})),g.constants&&(b=b.concat(zl({key:"constants",value:g.constants,style:g,styleSpec:l}))),ph(b)}function ph(g){return[].concat(g).sort((l,b)=>l.line-b.line)}function yn(g){return function(...l){return ph(g.apply(this,l))}}zn.source=yn(fh),zn.light=yn(nl),zn.terrain=yn(ol),zn.fog=yn(sl),zn.layer=yn(_s),zn.filter=yn(il),zn.paintProperty=yn(uh),zn.layoutProperty=yn(dh);const Ro=zn,Bo=Ro.light,fc=Ro.fog,hl=Ro.paintProperty,pc=Ro.layoutProperty;function mh(g,l){let b=!1;if(l&&l.length)for(const E of l)g.fire(new Ls(new Error(E.message))),b=!0;return b}var ys=Vr;function Vr(g,l,b){var E=this.cells=[];if(g instanceof ArrayBuffer){this.arrayBuffer=g;var S=new Int32Array(this.arrayBuffer);g=S[0],this.d=(l=S[1])+2*(b=S[2]);for(var A=0;A<this.d*this.d;A++){var D=S[3+A],z=S[3+A+1];E.push(D===z?null:S.subarray(D,z))}var $=S[3+E.length+1];this.keys=S.subarray(S[3+E.length],$),this.bboxes=S.subarray($),this.insert=this._insertReadonly}else{this.d=l+2*b;for(var V=0;V<this.d*this.d;V++)E.push([]);this.keys=[],this.bboxes=[]}this.n=l,this.extent=g,this.padding=b,this.scale=l/g,this.uid=0;var Z=b/l*g;this.min=-Z,this.max=g+Z}Vr.prototype.insert=function(g,l,b,E,S){this._forEachCell(l,b,E,S,this._insertCell,this.uid++),this.keys.push(g),this.bboxes.push(l),this.bboxes.push(b),this.bboxes.push(E),this.bboxes.push(S)},Vr.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Vr.prototype._insertCell=function(g,l,b,E,S,A){this.cells[S].push(A)},Vr.prototype.query=function(g,l,b,E,S){var A=this.min,D=this.max;if(g<=A&&l<=A&&D<=b&&D<=E&&!S)return Array.prototype.slice.call(this.keys);var z=[];return this._forEachCell(g,l,b,E,this._queryCell,z,{},S),z},Vr.prototype._queryCell=function(g,l,b,E,S,A,D,z){var $=this.cells[S];if($!==null)for(var V=this.keys,Z=this.bboxes,X=0;X<$.length;X++){var Y=$[X];if(D[Y]===void 0){var ie=4*Y;(z?z(Z[ie+0],Z[ie+1],Z[ie+2],Z[ie+3]):g<=Z[ie+2]&&l<=Z[ie+3]&&b>=Z[ie+0]&&E>=Z[ie+1])?(D[Y]=!0,A.push(V[Y])):D[Y]=!1}}},Vr.prototype._forEachCell=function(g,l,b,E,S,A,D,z){for(var $=this._convertToCellCoord(g),V=this._convertToCellCoord(l),Z=this._convertToCellCoord(b),X=this._convertToCellCoord(E),Y=$;Y<=Z;Y++)for(var ie=V;ie<=X;ie++){var ce=this.d*ie+Y;if((!z||z(this._convertFromCellCoord(Y),this._convertFromCellCoord(ie),this._convertFromCellCoord(Y+1),this._convertFromCellCoord(ie+1)))&&S.call(this,g,l,b,E,ce,A,D,z))return}},Vr.prototype._convertFromCellCoord=function(g){return(g-this.padding)/this.scale},Vr.prototype._convertToCellCoord=function(g){return Math.max(0,Math.min(this.d-1,Math.floor(g*this.scale)+this.padding))},Vr.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var g=this.cells,l=3+this.cells.length+1+1,b=0,E=0;E<this.cells.length;E++)b+=this.cells[E].length;var S=new Int32Array(l+b+this.keys.length+this.bboxes.length);S[0]=this.extent,S[1]=this.n,S[2]=this.padding;for(var A=l,D=0;D<g.length;D++){var z=g[D];S[3+D]=A,S.set(z,A),A+=z.length}return S[3+g.length]=A,S.set(this.keys,A),S[3+g.length+1]=A+=this.keys.length,S.set(this.bboxes,A),A+=this.bboxes.length,S.buffer};const{ImageData:xs,ImageBitmap:Lo}=j,vs={};function Ft(g,l,b={}){Object.defineProperty(l,"_classRegistryKey",{value:g,writeable:!1}),vs[g]={klass:l,omit:b.omit||[],shallow:b.shallow||[]}}Ft("Object",Object),ys.serialize=function(g,l){const b=g.toArrayBuffer();return l&&l.push(b),{buffer:b}},ys.deserialize=function(g){return new ys(g.buffer)},Ft("Grid",ys),Ft("Color",Fi),Ft("Error",Error),Ft("ResolvedImage",an),Ft("StylePropertyFunction",Co),Ft("StyleExpression",Wa,{omit:["_evaluator"]}),Ft("ZoomDependentExpression",Ka),Ft("ZoomConstantExpression",ms),Ft("CompoundExpression",Jr,{omit:["_evaluate"]});for(const g in _n)_n[g]._classRegistryKey||Ft(`Expression_${g}`,_n[g]);function zo(g){return g&&typeof ArrayBuffer!="undefined"&&(g instanceof ArrayBuffer||g.constructor&&g.constructor.name==="ArrayBuffer")}function gh(g){return Lo&&g instanceof Lo}function bs(g,l){if(g==null||typeof g=="boolean"||typeof g=="number"||typeof g=="string"||g instanceof Boolean||g instanceof Number||g instanceof String||g instanceof Date||g instanceof RegExp)return g;if(zo(g)||gh(g))return l&&l.push(g),g;if(ArrayBuffer.isView(g)){const b=g;return l&&l.push(b.buffer),b}if(g instanceof xs)return l&&l.push(g.data.buffer),g;if(Array.isArray(g)){const b=[];for(const E of g)b.push(bs(E,l));return b}if(typeof g=="object"){const b=g.constructor,E=b._classRegistryKey;if(!E)throw new Error("can't serialize object of unregistered class");const S=b.serialize?b.serialize(g,l):{};if(!b.serialize){for(const A in g){if(!g.hasOwnProperty(A)||vs[E].omit.indexOf(A)>=0)continue;const D=g[A];S[A]=vs[E].shallow.indexOf(A)>=0?D:bs(D,l)}g instanceof Error&&(S.message=g.message)}if(S.$name)throw new Error("$name property is reserved for worker serialization logic.");return E!=="Object"&&(S.$name=E),S}throw new Error("can't serialize object of type "+typeof g)}function eo(g){if(g==null||typeof g=="boolean"||typeof g=="number"||typeof g=="string"||g instanceof Boolean||g instanceof Number||g instanceof String||g instanceof Date||g instanceof RegExp||zo(g)||gh(g)||ArrayBuffer.isView(g)||g instanceof xs)return g;if(Array.isArray(g))return g.map(eo);if(typeof g=="object"){const l=g.$name||"Object",{klass:b}=vs[l];if(!b)throw new Error(`can't deserialize unregistered class ${l}`);if(b.deserialize)return b.deserialize(g);const E=Object.create(b.prototype);for(const S of Object.keys(g)){if(S==="$name")continue;const A=g[S];E[S]=vs[l].shallow.indexOf(S)>=0?A:eo(A)}return E}throw new Error("can't deserialize object of type "+typeof g)}class I{constructor(){this.first=!0}update(l,b){const E=Math.floor(l);return this.first?(this.first=!1,this.lastIntegerZoom=E,this.lastIntegerZoomTime=0,this.lastZoom=l,this.lastFloorZoom=E,!0):(this.lastFloorZoom>E?(this.lastIntegerZoom=E+1,this.lastIntegerZoomTime=b):this.lastFloorZoom<E&&(this.lastIntegerZoom=E,this.lastIntegerZoomTime=b),l!==this.lastZoom&&(this.lastZoom=l,this.lastFloorZoom=E,!0))}}const y=g=>g>=1536&&g<=1791,M=g=>g>=1872&&g<=1919,C=g=>g>=2208&&g<=2303,L=g=>g>=11904&&g<=12031,F=g=>g>=12032&&g<=12255,N=g=>g>=12272&&g<=12287,q=g=>g>=12288&&g<=12351,W=g=>g>=12352&&g<=12447,J=g=>g>=12448&&g<=12543,ee=g=>g>=12544&&g<=12591,ne=g=>g>=12704&&g<=12735,fe=g=>g>=12736&&g<=12783,we=g=>g>=12784&&g<=12799,ye=g=>g>=12800&&g<=13055,Ee=g=>g>=13056&&g<=13311,ze=g=>g>=13312&&g<=19903,be=g=>g>=19968&&g<=40959,Ce=g=>g>=40960&&g<=42127,Pe=g=>g>=42128&&g<=42191,Ie=g=>g>=44032&&g<=55215,ke=g=>g>=63744&&g<=64255,Fe=g=>g>=64336&&g<=65023,Ye=g=>g>=65040&&g<=65055,Ke=g=>g>=65072&&g<=65103,yt=g=>g>=65104&&g<=65135,dt=g=>g>=65136&&g<=65279,ut=g=>g>=65280&&g<=65519;function tt(g){for(const l of g)if(ot(l.charCodeAt(0)))return!0;return!1}function We(g){for(const l of g)if(!ct(l.charCodeAt(0)))return!1;return!0}function ct(g){return!(y(g)||M(g)||C(g)||Fe(g)||dt(g))}function ot(g){return!(g!==746&&g!==747&&(g<4352||!(ne(g)||ee(g)||Ke(g)&&!(g>=65097&&g<=65103)||ke(g)||Ee(g)||L(g)||fe(g)||!(!q(g)||g>=12296&&g<=12305||g>=12308&&g<=12319||g===12336)||ze(g)||be(g)||ye(g)||(l=>l>=12592&&l<=12687)(g)||(l=>l>=43360&&l<=43391)(g)||(l=>l>=55216&&l<=55295)(g)||(l=>l>=4352&&l<=4607)(g)||Ie(g)||W(g)||N(g)||(l=>l>=12688&&l<=12703)(g)||F(g)||we(g)||J(g)&&g!==12540||!(!ut(g)||g===65288||g===65289||g===65293||g>=65306&&g<=65310||g===65339||g===65341||g===65343||g>=65371&&g<=65503||g===65507||g>=65512&&g<=65519)||!(!yt(g)||g>=65112&&g<=65118||g>=65123&&g<=65126)||(l=>l>=5120&&l<=5759)(g)||(l=>l>=6320&&l<=6399)(g)||Ye(g)||(l=>l>=19904&&l<=19967)(g)||Ce(g)||Pe(g))))}function Xt(g){return!(ot(g)||function(l){return!!((b=>b>=128&&b<=255)(l)&&(l===167||l===169||l===174||l===177||l===188||l===189||l===190||l===215||l===247)||(b=>b>=8192&&b<=8303)(l)&&(l===8214||l===8224||l===8225||l===8240||l===8241||l===8251||l===8252||l===8258||l===8263||l===8264||l===8265||l===8273)||(b=>b>=8448&&b<=8527)(l)||(b=>b>=8528&&b<=8591)(l)||(b=>b>=8960&&b<=9215)(l)&&(l>=8960&&l<=8967||l>=8972&&l<=8991||l>=8996&&l<=9e3||l===9003||l>=9085&&l<=9114||l>=9150&&l<=9165||l===9167||l>=9169&&l<=9179||l>=9186&&l<=9215)||(b=>b>=9216&&b<=9279)(l)&&l!==9251||(b=>b>=9280&&b<=9311)(l)||(b=>b>=9312&&b<=9471)(l)||(b=>b>=9632&&b<=9727)(l)||(b=>b>=9728&&b<=9983)(l)&&!(l>=9754&&l<=9759)||(b=>b>=11008&&b<=11263)(l)&&(l>=11026&&l<=11055||l>=11088&&l<=11097||l>=11192&&l<=11243)||q(l)||J(l)||(b=>b>=57344&&b<=63743)(l)||Ke(l)||yt(l)||ut(l)||l===8734||l===8756||l===8757||l>=9984&&l<=10087||l>=10102&&l<=10131||l===65532||l===65533)}(g))}function ti(g){return g>=1424&&g<=2303||Fe(g)||dt(g)}function vi(g,l){return!(!l&&ti(g)||g>=2304&&g<=3583||g>=3840&&g<=4255||(b=>b>=6016&&b<=6143)(g))}function _t(g){for(const l of g)if(ti(l.charCodeAt(0)))return!0;return!1}const Kt="deferred",ci="loading",qi="loaded";let Ji=null,si="unavailable",Ti=null;const ir=function(g){g&&typeof g=="string"&&g.indexOf("NetworkError")>-1&&(si="error"),Ji&&Ji(g)};function br(){Yr.fire(new Gn("pluginStateChange",{pluginStatus:si,pluginURL:Ti}))}const Yr=new qn,cn=function(){return si},xn=function(){if(si!==Kt||!Ti)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");si=ci,br(),Ti&&Wo({url:Ti},g=>{g?ir(g):(si=qi,br())})},Bi={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>si===qi||Bi.applyArabicShaping!=null,isLoading:()=>si===ci,setState(g){si=g.pluginStatus,Ti=g.pluginURL},isParsed:()=>Bi.applyArabicShaping!=null&&Bi.processBidirectionalText!=null&&Bi.processStyledBidirectionalText!=null,getPluginURL:()=>Ti};class ui{constructor(l,b){this.zoom=l,b?(this.now=b.now,this.fadeDuration=b.fadeDuration,this.zoomHistory=b.zoomHistory,this.transition=b.transition,this.pitch=b.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new I,this.transition={},this.pitch=0)}isSupportedScript(l){return function(b,E){for(const S of b)if(!vi(S.charCodeAt(0),E))return!1;return!0}(l,Bi.isLoaded())}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const l=this.zoom,b=l-Math.floor(l),E=this.crossFadingFactor();return l>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:b+(1-b)*E}:{fromScale:.5,toScale:1,t:1-(1-E)*b}}}class ki{constructor(l,b){this.property=l,this.value=b,this.expression=function(E,S){if(ia(E))return new Co(E,S);if(ko(E)){const A=oh(E,S);if(A.result==="error")throw new Error(A.value.map(D=>`${D.key}: ${D.message}`).join(", "));return A.value}{let A=E;return typeof E=="string"&&S.type==="color"&&(A=Fi.parse(E)),{kind:"constant",evaluate:()=>A}}}(b===void 0?l.specification.default:b,l.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(l,b,E){return this.property.possiblyEvaluate(this,l,b,E)}}class lr{constructor(l){this.property=l,this.value=new ki(l,void 0)}transitioned(l,b){return new tr(this.property,this.value,b,Wt({},l.transition,this.transition),l.now)}untransitioned(){return new tr(this.property,this.value,null,{},0)}}class Qr{constructor(l){this._properties=l,this._values=Object.create(l.defaultTransitionablePropertyValues)}getValue(l){return Si(this._values[l].value.value)}setValue(l,b){this._values.hasOwnProperty(l)||(this._values[l]=new lr(this._values[l].property)),this._values[l].value=new ki(this._values[l].property,b===null?void 0:Si(b))}getTransition(l){return Si(this._values[l].transition)}setTransition(l,b){this._values.hasOwnProperty(l)||(this._values[l]=new lr(this._values[l].property)),this._values[l].transition=Si(b)||void 0}serialize(){const l={};for(const b of Object.keys(this._values)){const E=this.getValue(b);E!==void 0&&(l[b]=E);const S=this.getTransition(b);S!==void 0&&(l[`${b}-transition`]=S)}return l}transitioned(l,b){const E=new en(this._properties);for(const S of Object.keys(this._values))E._values[S]=this._values[S].transitioned(l,b._values[S]);return E}untransitioned(){const l=new en(this._properties);for(const b of Object.keys(this._values))l._values[b]=this._values[b].untransitioned();return l}}class tr{constructor(l,b,E,S,A){const D=S.delay||0,z=S.duration||0;A=A||0,this.property=l,this.value=b,this.begin=A+D,this.end=this.begin+z,l.specification.transition&&(S.delay||S.duration)&&(this.prior=E)}possiblyEvaluate(l,b,E){const S=l.now||0,A=this.value.possiblyEvaluate(l,b,E),D=this.prior;if(D){if(S>this.end)return this.prior=null,A;if(this.value.isDataDriven())return this.prior=null,A;if(S<this.begin)return D.possiblyEvaluate(l,b,E);{const z=(S-this.begin)/(this.end-this.begin);return this.property.interpolate(D.possiblyEvaluate(l,b,E),A,oi(z))}}return A}}class en{constructor(l){this._properties=l,this._values=Object.create(l.defaultTransitioningPropertyValues)}possiblyEvaluate(l,b,E){const S=new uo(this._properties);for(const A of Object.keys(this._values))S._values[A]=this._values[A].possiblyEvaluate(l,b,E);return S}hasTransition(){for(const l of Object.keys(this._values))if(this._values[l].prior)return!0;return!1}}class ws{constructor(l){this._properties=l,this._values=Object.create(l.defaultPropertyValues)}getValue(l){return Si(this._values[l].value)}setValue(l,b){this._values[l]=new ki(this._values[l].property,b===null?void 0:Si(b))}serialize(){const l={};for(const b of Object.keys(this._values)){const E=this.getValue(b);E!==void 0&&(l[b]=E)}return l}possiblyEvaluate(l,b,E){const S=new uo(this._properties);for(const A of Object.keys(this._values))S._values[A]=this._values[A].possiblyEvaluate(l,b,E);return S}}class Hr{constructor(l,b,E){this.property=l,this.value=b,this.parameters=E}isConstant(){return this.value.kind==="constant"}constantOr(l){return this.value.kind==="constant"?this.value.value:l}evaluate(l,b,E,S){return this.property.evaluate(this.value,this.parameters,l,b,E,S)}}class uo{constructor(l){this._properties=l,this._values=Object.create(l.defaultPossiblyEvaluatedValues)}get(l){return this._values[l]}}class Ot{constructor(l){this.specification=l}possiblyEvaluate(l,b){return l.expression.evaluate(b)}interpolate(l,b,E){const S=qs[this.specification.type];return S?S(l,b,E):l}}class Jt{constructor(l,b){this.specification=l,this.overrides=b}possiblyEvaluate(l,b,E,S){return new Hr(this,l.expression.kind==="constant"||l.expression.kind==="camera"?{kind:"constant",value:l.expression.evaluate(b,null,{},E,S)}:l.expression,b)}interpolate(l,b,E){if(l.value.kind!=="constant"||b.value.kind!=="constant")return l;if(l.value.value===void 0||b.value.value===void 0)return new Hr(this,{kind:"constant",value:void 0},l.parameters);const S=qs[this.specification.type];return S?new Hr(this,{kind:"constant",value:S(l.value.value,b.value.value,E)},l.parameters):l}evaluate(l,b,E,S,A,D){return l.kind==="constant"?l.value:l.evaluate(b,E,S,A,D)}}class Ir extends Jt{possiblyEvaluate(l,b,E,S){if(l.value===void 0)return new Hr(this,{kind:"constant",value:void 0},b);if(l.expression.kind==="constant"){const A=l.expression.evaluate(b,null,{},E,S),D=l.property.specification.type==="resolvedImage"&&typeof A!="string"?A.name:A,z=this._calculate(D,D,D,b);return new Hr(this,{kind:"constant",value:z},b)}if(l.expression.kind==="camera"){const A=this._calculate(l.expression.evaluate({zoom:b.zoom-1}),l.expression.evaluate({zoom:b.zoom}),l.expression.evaluate({zoom:b.zoom+1}),b);return new Hr(this,{kind:"constant",value:A},b)}return new Hr(this,l.expression,b)}evaluate(l,b,E,S,A,D){if(l.kind==="source"){const z=l.evaluate(b,E,S,A,D);return this._calculate(z,z,z,b)}return l.kind==="composite"?this._calculate(l.evaluate({zoom:Math.floor(b.zoom)-1},E,S),l.evaluate({zoom:Math.floor(b.zoom)},E,S),l.evaluate({zoom:Math.floor(b.zoom)+1},E,S),b):l.value}_calculate(l,b,E,S){return S.zoom>S.zoomHistory.lastIntegerZoom?{from:l,to:b,other:E}:{from:E,to:b,other:l}}interpolate(l){return l}}class fo{constructor(l){this.specification=l}possiblyEvaluate(l,b,E,S){if(l.value!==void 0){if(l.expression.kind==="constant"){const A=l.expression.evaluate(b,null,{},E,S);return this._calculate(A,A,A,b)}return this._calculate(l.expression.evaluate(new ui(Math.floor(b.zoom-1),b)),l.expression.evaluate(new ui(Math.floor(b.zoom),b)),l.expression.evaluate(new ui(Math.floor(b.zoom+1),b)),b)}}_calculate(l,b,E,S){return S.zoom>S.zoomHistory.lastIntegerZoom?{from:l,to:b}:{from:E,to:b}}interpolate(l){return l}}class to{constructor(l){this.specification=l}possiblyEvaluate(l,b,E,S){return!!l.expression.evaluate(b,null,{},E,S)}interpolate(){return!1}}class Fr{constructor(l){this.properties=l,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const b in l){const E=l[b];E.specification.overridable&&this.overridableProperties.push(b);const S=this.defaultPropertyValues[b]=new ki(E,void 0),A=this.defaultTransitionablePropertyValues[b]=new lr(E);this.defaultTransitioningPropertyValues[b]=A.untransitioned(),this.defaultPossiblyEvaluatedValues[b]=S.possiblyEvaluate({})}}}function Su(g,l){return 256*(g=Pt(Math.floor(g),0,255))+Pt(Math.floor(l),0,255)}Ft("DataDrivenProperty",Jt),Ft("DataConstantProperty",Ot),Ft("CrossFadedDataDrivenProperty",Ir),Ft("CrossFadedProperty",fo),Ft("ColorRampProperty",to);const Ff={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class cl{constructor(l,b){this._structArray=l,this._pos1=b*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class mr{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(l,b){return l._trim(),b&&(l.isTransferred=!0,b.push(l.arrayBuffer)),{length:l.length,arrayBuffer:l.arrayBuffer}}static deserialize(l){const b=Object.create(this.prototype);return b.arrayBuffer=l.arrayBuffer,b.length=l.length,b.capacity=l.arrayBuffer.byteLength/b.bytesPerElement,b._refreshViews(),b}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(l){this.reserve(l),this.length=l}reserve(l){if(l>this.capacity){this.capacity=Math.max(l,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const b=this.uint8;this._refreshViews(),b&&this.uint8.set(b)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function ar(g,l=1){let b=0,E=0;return{members:g.map(S=>{const A=Ff[S.type].BYTES_PER_ELEMENT,D=b=Au(b,Math.max(l,A)),z=S.components||1;return E=Math.max(E,A),b+=A*z,{name:S.name,type:S.type,components:z,offset:D}}),size:Au(b,Math.max(E,l)),alignment:l}}function Au(g,l){return Math.ceil(g/l)*l}class fa extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(l,b){const E=this.length;return this.resize(E+1),this.emplace(E,l,b)}emplace(l,b,E){const S=2*l;return this.int16[S+0]=b,this.int16[S+1]=E,l}}fa.prototype.bytesPerElement=4,Ft("StructArrayLayout2i4",fa);class pa extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(l,b,E,S){const A=this.length;return this.resize(A+1),this.emplace(A,l,b,E,S)}emplace(l,b,E,S,A){const D=4*l;return this.int16[D+0]=b,this.int16[D+1]=E,this.int16[D+2]=S,this.int16[D+3]=A,l}}pa.prototype.bytesPerElement=8,Ft("StructArrayLayout4i8",pa);class mc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z){const $=this.length;return this.resize($+1),this.emplace($,l,b,E,S,A,D,z)}emplace(l,b,E,S,A,D,z,$){const V=6*l,Z=12*l,X=3*l;return this.int16[V+0]=b,this.int16[V+1]=E,this.uint8[Z+4]=S,this.uint8[Z+5]=A,this.uint8[Z+6]=D,this.uint8[Z+7]=z,this.float32[X+2]=$,l}}mc.prototype.bytesPerElement=12,Ft("StructArrayLayout2i4ub1f12",mc);class ma extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(l,b,E){const S=this.length;return this.resize(S+1),this.emplace(S,l,b,E)}emplace(l,b,E,S){const A=3*l;return this.float32[A+0]=b,this.float32[A+1]=E,this.float32[A+2]=S,l}}ma.prototype.bytesPerElement=12,Ft("StructArrayLayout3f12",ma);class Fo extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z,$,V,Z){const X=this.length;return this.resize(X+1),this.emplace(X,l,b,E,S,A,D,z,$,V,Z)}emplace(l,b,E,S,A,D,z,$,V,Z,X){const Y=10*l;return this.uint16[Y+0]=b,this.uint16[Y+1]=E,this.uint16[Y+2]=S,this.uint16[Y+3]=A,this.uint16[Y+4]=D,this.uint16[Y+5]=z,this.uint16[Y+6]=$,this.uint16[Y+7]=V,this.uint16[Y+8]=Z,this.uint16[Y+9]=X,l}}Fo.prototype.bytesPerElement=20,Ft("StructArrayLayout10ui20",Fo);class _h extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z,$){const V=this.length;return this.resize(V+1),this.emplace(V,l,b,E,S,A,D,z,$)}emplace(l,b,E,S,A,D,z,$,V){const Z=8*l;return this.uint16[Z+0]=b,this.uint16[Z+1]=E,this.uint16[Z+2]=S,this.uint16[Z+3]=A,this.uint16[Z+4]=D,this.uint16[Z+5]=z,this.uint16[Z+6]=$,this.uint16[Z+7]=V,l}}_h.prototype.bytesPerElement=16,Ft("StructArrayLayout8ui16",_h);class gc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve)}emplace(l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve,Ae){const Be=16*l;return this.int16[Be+0]=b,this.int16[Be+1]=E,this.int16[Be+2]=S,this.int16[Be+3]=A,this.uint16[Be+4]=D,this.uint16[Be+5]=z,this.uint16[Be+6]=$,this.uint16[Be+7]=V,this.int16[Be+8]=Z,this.int16[Be+9]=X,this.int16[Be+10]=Y,this.int16[Be+11]=ie,this.int16[Be+12]=ce,this.int16[Be+13]=pe,this.int16[Be+14]=ve,this.int16[Be+15]=Ae,l}}gc.prototype.bytesPerElement=32,Ft("StructArrayLayout4i4ui4i4i32",gc);class _c extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(l){const b=this.length;return this.resize(b+1),this.emplace(b,l)}emplace(l,b){return this.uint32[1*l+0]=b,l}}_c.prototype.bytesPerElement=4,Ft("StructArrayLayout1ul4",_c);class yc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z,$,V,Z,X,Y,ie){const ce=this.length;return this.resize(ce+1),this.emplace(ce,l,b,E,S,A,D,z,$,V,Z,X,Y,ie)}emplace(l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce){const pe=20*l,ve=10*l;return this.int16[pe+0]=b,this.int16[pe+1]=E,this.int16[pe+2]=S,this.int16[pe+3]=A,this.int16[pe+4]=D,this.float32[ve+3]=z,this.float32[ve+4]=$,this.float32[ve+5]=V,this.float32[ve+6]=Z,this.int16[pe+14]=X,this.uint32[ve+8]=Y,this.uint16[pe+18]=ie,this.uint16[pe+19]=ce,l}}yc.prototype.bytesPerElement=40,Ft("StructArrayLayout5i4f1i1ul2ui40",yc);class yh extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z){const $=this.length;return this.resize($+1),this.emplace($,l,b,E,S,A,D,z)}emplace(l,b,E,S,A,D,z,$){const V=8*l;return this.int16[V+0]=b,this.int16[V+1]=E,this.int16[V+2]=S,this.int16[V+4]=A,this.int16[V+5]=D,this.int16[V+6]=z,this.int16[V+7]=$,l}}yh.prototype.bytesPerElement=16,Ft("StructArrayLayout3i2i2i16",yh);class xc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A){const D=this.length;return this.resize(D+1),this.emplace(D,l,b,E,S,A)}emplace(l,b,E,S,A,D){const z=4*l,$=8*l;return this.float32[z+0]=b,this.float32[z+1]=E,this.float32[z+2]=S,this.int16[$+6]=A,this.int16[$+7]=D,l}}xc.prototype.bytesPerElement=16,Ft("StructArrayLayout2f1f2i16",xc);class vc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(l,b,E,S){const A=this.length;return this.resize(A+1),this.emplace(A,l,b,E,S)}emplace(l,b,E,S,A){const D=12*l,z=3*l;return this.uint8[D+0]=b,this.uint8[D+1]=E,this.float32[z+1]=S,this.float32[z+2]=A,l}}vc.prototype.bytesPerElement=12,Ft("StructArrayLayout2ub2f12",vc);class vn extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(l,b,E){const S=this.length;return this.resize(S+1),this.emplace(S,l,b,E)}emplace(l,b,E,S){const A=3*l;return this.uint16[A+0]=b,this.uint16[A+1]=E,this.uint16[A+2]=S,l}}vn.prototype.bytesPerElement=6,Ft("StructArrayLayout3ui6",vn);class bc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve,Ae,Be,$e,Ve,Ge){const Xe=this.length;return this.resize(Xe+1),this.emplace(Xe,l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve,Ae,Be,$e,Ve,Ge)}emplace(l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve,Ae,Be,$e,Ve,Ge,Xe){const nt=30*l,it=15*l,bt=60*l;return this.int16[nt+0]=b,this.int16[nt+1]=E,this.int16[nt+2]=S,this.float32[it+2]=A,this.float32[it+3]=D,this.uint16[nt+8]=z,this.uint16[nt+9]=$,this.uint32[it+5]=V,this.uint32[it+6]=Z,this.uint32[it+7]=X,this.uint16[nt+16]=Y,this.uint16[nt+17]=ie,this.uint16[nt+18]=ce,this.float32[it+10]=pe,this.float32[it+11]=ve,this.uint8[bt+48]=Ae,this.uint8[bt+49]=Be,this.uint8[bt+50]=$e,this.uint32[it+13]=Ve,this.int16[nt+28]=Ge,this.uint8[bt+58]=Xe,l}}bc.prototype.bytesPerElement=60,Ft("StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60",bc);class wc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve,Ae,Be,$e,Ve,Ge,Xe,nt,it,bt,mt,rt,gt,Et,lt){const Lt=this.length;return this.resize(Lt+1),this.emplace(Lt,l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve,Ae,Be,$e,Ve,Ge,Xe,nt,it,bt,mt,rt,gt,Et,lt)}emplace(l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve,Ae,Be,$e,Ve,Ge,Xe,nt,it,bt,mt,rt,gt,Et,lt,Lt){const $t=38*l,Pi=19*l;return this.int16[$t+0]=b,this.int16[$t+1]=E,this.int16[$t+2]=S,this.float32[Pi+2]=A,this.float32[Pi+3]=D,this.int16[$t+8]=z,this.int16[$t+9]=$,this.int16[$t+10]=V,this.int16[$t+11]=Z,this.int16[$t+12]=X,this.int16[$t+13]=Y,this.uint16[$t+14]=ie,this.uint16[$t+15]=ce,this.uint16[$t+16]=pe,this.uint16[$t+17]=ve,this.uint16[$t+18]=Ae,this.uint16[$t+19]=Be,this.uint16[$t+20]=$e,this.uint16[$t+21]=Ve,this.uint16[$t+22]=Ge,this.uint16[$t+23]=Xe,this.uint16[$t+24]=nt,this.uint16[$t+25]=it,this.uint16[$t+26]=bt,this.uint16[$t+27]=mt,this.uint16[$t+28]=rt,this.uint32[Pi+15]=gt,this.float32[Pi+16]=Et,this.float32[Pi+17]=lt,this.float32[Pi+18]=Lt,l}}wc.prototype.bytesPerElement=76,Ft("StructArrayLayout3i2f6i15ui1ul3f76",wc);class xh extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(l){const b=this.length;return this.resize(b+1),this.emplace(b,l)}emplace(l,b){return this.float32[1*l+0]=b,l}}xh.prototype.bytesPerElement=4,Ft("StructArrayLayout1f4",xh);class Ec extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(l,b,E){const S=this.length;return this.resize(S+1),this.emplace(S,l,b,E)}emplace(l,b,E,S){const A=3*l;return this.int16[A+0]=b,this.int16[A+1]=E,this.int16[A+2]=S,l}}Ec.prototype.bytesPerElement=6,Ft("StructArrayLayout3i6",Ec);class ul extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(l,b,E,S,A,D,z){const $=this.length;return this.resize($+1),this.emplace($,l,b,E,S,A,D,z)}emplace(l,b,E,S,A,D,z,$){const V=7*l;return this.float32[V+0]=b,this.float32[V+1]=E,this.float32[V+2]=S,this.float32[V+3]=A,this.float32[V+4]=D,this.float32[V+5]=z,this.float32[V+6]=$,l}}ul.prototype.bytesPerElement=28,Ft("StructArrayLayout7f28",ul);class Tc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(l,b,E,S){const A=this.length;return this.resize(A+1),this.emplace(A,l,b,E,S)}emplace(l,b,E,S,A){const D=6*l;return this.uint32[3*l+0]=b,this.uint16[D+2]=E,this.uint16[D+3]=S,this.uint16[D+4]=A,l}}Tc.prototype.bytesPerElement=12,Ft("StructArrayLayout1ul3ui12",Tc);class Oo extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(l,b){const E=this.length;return this.resize(E+1),this.emplace(E,l,b)}emplace(l,b,E){const S=2*l;return this.uint16[S+0]=b,this.uint16[S+1]=E,l}}Oo.prototype.bytesPerElement=4,Ft("StructArrayLayout2ui4",Oo);class vh extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(l){const b=this.length;return this.resize(b+1),this.emplace(b,l)}emplace(l,b){return this.uint16[1*l+0]=b,l}}vh.prototype.bytesPerElement=2,Ft("StructArrayLayout1ui2",vh);class bh extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(l,b){const E=this.length;return this.resize(E+1),this.emplace(E,l,b)}emplace(l,b,E){const S=2*l;return this.float32[S+0]=b,this.float32[S+1]=E,l}}bh.prototype.bytesPerElement=8,Ft("StructArrayLayout2f8",bh);class Mc extends mr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(l,b,E,S){const A=this.length;return this.resize(A+1),this.emplace(A,l,b,E,S)}emplace(l,b,E,S,A){const D=4*l;return this.float32[D+0]=b,this.float32[D+1]=E,this.float32[D+2]=S,this.float32[D+3]=A,l}}Mc.prototype.bytesPerElement=16,Ft("StructArrayLayout4f16",Mc);class Iu extends cl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Iu.prototype.size=40;class Sc extends yc{get(l){return new Iu(this,l)}}Ft("CollisionBoxArray",Sc);class ku extends cl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(l){this._structArray.uint8[this._pos1+49]=l}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(l){this._structArray.uint8[this._pos1+50]=l}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(l){this._structArray.uint32[this._pos4+13]=l}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(l){this._structArray.uint8[this._pos1+58]=l}}ku.prototype.size=60;class Cu extends bc{get(l){return new ku(this,l)}}Ft("PlacedSymbolArray",Cu);class Du extends cl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(l){this._structArray.uint32[this._pos4+15]=l}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}Du.prototype.size=76;class Pu extends wc{get(l){return new Du(this,l)}}Ft("SymbolInstanceArray",Pu);class Ru extends xh{getoffsetX(l){return this.float32[1*l+0]}}Ft("GlyphOffsetArray",Ru);class Bu extends Ec{getx(l){return this.int16[3*l+0]}gety(l){return this.int16[3*l+1]}gettileUnitDistanceFromAnchor(l){return this.int16[3*l+2]}}Ft("SymbolLineVertexArray",Bu);class Lu extends cl{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Lu.prototype.size=12;class zu extends Tc{get(l){return new Lu(this,l)}}Ft("FeatureIndexArray",zu);class Fu extends cl{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0]}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1]}}Fu.prototype.size=4;class Ou extends Oo{get(l){return new Fu(this,l)}}Ft("FillExtrusionCentroidArray",Ou);const Of=ar([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),$f=ar([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var $u=Mo(function(g){g.exports=function(l,b){var E,S,A,D,z,$,V,Z;for(S=l.length-(E=3&l.length),A=b,z=3432918353,$=461845907,Z=0;Z<S;)V=255&l.charCodeAt(Z)|(255&l.charCodeAt(++Z))<<8|(255&l.charCodeAt(++Z))<<16|(255&l.charCodeAt(++Z))<<24,++Z,A=27492+(65535&(D=5*(65535&(A=(A^=V=(65535&(V=(V=(65535&V)*z+(((V>>>16)*z&65535)<<16)&4294967295)<<15|V>>>17))*$+(((V>>>16)*$&65535)<<16)&4294967295)<<13|A>>>19))+((5*(A>>>16)&65535)<<16)&4294967295))+((58964+(D>>>16)&65535)<<16);switch(V=0,E){case 3:V^=(255&l.charCodeAt(Z+2))<<16;case 2:V^=(255&l.charCodeAt(Z+1))<<8;case 1:A^=V=(65535&(V=(V=(65535&(V^=255&l.charCodeAt(Z)))*z+(((V>>>16)*z&65535)<<16)&4294967295)<<15|V>>>17))*$+(((V>>>16)*$&65535)<<16)&4294967295}return A^=l.length,A=2246822507*(65535&(A^=A>>>16))+((2246822507*(A>>>16)&65535)<<16)&4294967295,A=3266489909*(65535&(A^=A>>>13))+((3266489909*(A>>>16)&65535)<<16)&4294967295,(A^=A>>>16)>>>0}}),Uf=Mo(function(g){g.exports=function(l,b){for(var E,S=l.length,A=b^S,D=0;S>=4;)E=1540483477*(65535&(E=255&l.charCodeAt(D)|(255&l.charCodeAt(++D))<<8|(255&l.charCodeAt(++D))<<16|(255&l.charCodeAt(++D))<<24))+((1540483477*(E>>>16)&65535)<<16),A=1540483477*(65535&A)+((1540483477*(A>>>16)&65535)<<16)^(E=1540483477*(65535&(E^=E>>>24))+((1540483477*(E>>>16)&65535)<<16)),S-=4,++D;switch(S){case 3:A^=(255&l.charCodeAt(D+2))<<16;case 2:A^=(255&l.charCodeAt(D+1))<<8;case 1:A=1540483477*(65535&(A^=255&l.charCodeAt(D)))+((1540483477*(A>>>16)&65535)<<16)}return A=1540483477*(65535&(A^=A>>>13))+((1540483477*(A>>>16)&65535)<<16),(A^=A>>>15)>>>0}}),dl=$u,Nf=Uf;dl.murmur3=$u,dl.murmur2=Nf;class wh{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(l,b,E,S){this.ids.push(Uu(l)),this.positions.push(b,E,S)}getPositions(l){const b=Uu(l);let E=0,S=this.ids.length-1;for(;E<S;){const D=E+S>>1;this.ids[D]>=b?S=D:E=D+1}const A=[];for(;this.ids[E]===b;)A.push({index:this.positions[3*E],start:this.positions[3*E+1],end:this.positions[3*E+2]}),E++;return A}static serialize(l,b){const E=new Float64Array(l.ids),S=new Uint32Array(l.positions);return Ac(E,S,0,E.length-1),b&&b.push(E.buffer,S.buffer),{ids:E,positions:S}}static deserialize(l){const b=new wh;return b.ids=l.ids,b.positions=l.positions,b.indexed=!0,b}}function Uu(g){const l=+g;return!isNaN(l)&&Number.MIN_SAFE_INTEGER<=l&&l<=Number.MAX_SAFE_INTEGER?l:dl(String(g))}function Ac(g,l,b,E){for(;b<E;){const S=g[b+E>>1];let A=b-1,D=E+1;for(;;){do A++;while(g[A]<S);do D--;while(g[D]>S);if(A>=D)break;Eh(g,A,D),Eh(l,3*A,3*D),Eh(l,3*A+1,3*D+1),Eh(l,3*A+2,3*D+2)}D-b<E-D?(Ac(g,l,b,D),b=D+1):(Ac(g,l,D+1,E),E=D)}}function Eh(g,l,b){const E=g[l];g[l]=g[b],g[b]=E}Ft("FeaturePositionMap",wh);class po{constructor(l,b){this.gl=l.gl,this.location=b}}class Th extends po{constructor(l,b){super(l,b),this.current=0}set(l){this.current!==l&&(this.current=l,this.gl.uniform1f(this.location,l))}}class Nu extends po{constructor(l,b){super(l,b),this.current=[0,0,0,0]}set(l){l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]&&l[3]===this.current[3]||(this.current=l,this.gl.uniform4f(this.location,l[0],l[1],l[2],l[3]))}}class Vu extends po{constructor(l,b){super(l,b),this.current=Fi.transparent}set(l){l.r===this.current.r&&l.g===this.current.g&&l.b===this.current.b&&l.a===this.current.a||(this.current=l,this.gl.uniform4f(this.location,l.r,l.g,l.b,l.a))}}const Vf=new Float32Array(16),jf=new Float32Array(9),Gf=new Float32Array(4);function Ic(g){return[Su(255*g.r,255*g.g),Su(255*g.b,255*g.a)]}class fl{constructor(l,b,E){this.value=l,this.uniformNames=b.map(S=>`u_${S}`),this.type=E}setUniform(l,b,E){l.set(E.constantOr(this.value))}getBinding(l,b,E){return this.type==="color"?new Vu(l,b):new Th(l,b)}}class ga{constructor(l,b){this.uniformNames=b.map(E=>`u_${E}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(l,b){this.pixelRatioFrom=b.pixelRatio,this.pixelRatioTo=l.pixelRatio,this.patternFrom=b.tl.concat(b.br),this.patternTo=l.tl.concat(l.br)}setUniform(l,b,E,S){const A=S==="u_pattern_to"||S==="u_dash_to"?this.patternTo:S==="u_pattern_from"||S==="u_dash_from"?this.patternFrom:S==="u_pixel_ratio_to"?this.pixelRatioTo:S==="u_pixel_ratio_from"?this.pixelRatioFrom:null;A&&l.set(A)}getBinding(l,b,E){return E==="u_pattern_from"||E==="u_pattern_to"||E==="u_dash_from"||E==="u_dash_to"?new Nu(l,b):new Th(l,b)}}class mo{constructor(l,b,E,S){this.expression=l,this.type=E,this.maxValue=0,this.paintVertexAttributes=b.map(A=>({name:`a_${A}`,type:"Float32",components:E==="color"?2:1,offset:0})),this.paintVertexArray=new S}populatePaintArray(l,b,E,S,A,D){const z=this.paintVertexArray.length,$=this.expression.evaluate(new ui(0),b,{},A,S,D);this.paintVertexArray.resize(l),this._setPaintValue(z,l,$)}updatePaintArray(l,b,E,S,A){const D=this.expression.evaluate({zoom:0},E,S,void 0,A);this._setPaintValue(l,b,D)}_setPaintValue(l,b,E){if(this.type==="color"){const S=Ic(E);for(let A=l;A<b;A++)this.paintVertexArray.emplace(A,S[0],S[1])}else{for(let S=l;S<b;S++)this.paintVertexArray.emplace(S,E);this.maxValue=Math.max(this.maxValue,Math.abs(E))}}upload(l){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=l.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Fn{constructor(l,b,E,S,A,D){this.expression=l,this.uniformNames=b.map(z=>`u_${z}_t`),this.type=E,this.useIntegerZoom=S,this.zoom=A,this.maxValue=0,this.paintVertexAttributes=b.map(z=>({name:`a_${z}`,type:"Float32",components:E==="color"?4:2,offset:0})),this.paintVertexArray=new D}populatePaintArray(l,b,E,S,A,D){const z=this.expression.evaluate(new ui(this.zoom),b,{},A,S,D),$=this.expression.evaluate(new ui(this.zoom+1),b,{},A,S,D),V=this.paintVertexArray.length;this.paintVertexArray.resize(l),this._setPaintValue(V,l,z,$)}updatePaintArray(l,b,E,S,A){const D=this.expression.evaluate({zoom:this.zoom},E,S,void 0,A),z=this.expression.evaluate({zoom:this.zoom+1},E,S,void 0,A);this._setPaintValue(l,b,D,z)}_setPaintValue(l,b,E,S){if(this.type==="color"){const A=Ic(E),D=Ic(S);for(let z=l;z<b;z++)this.paintVertexArray.emplace(z,A[0],A[1],D[0],D[1])}else{for(let A=l;A<b;A++)this.paintVertexArray.emplace(A,E,S);this.maxValue=Math.max(this.maxValue,Math.abs(E),Math.abs(S))}}upload(l){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=l.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(l,b){const E=this.useIntegerZoom?Math.floor(b.zoom):b.zoom,S=Pt(this.expression.interpolationFactor(E,this.zoom,this.zoom+1),0,1);l.set(S)}getBinding(l,b,E){return new Th(l,b)}}class $o{constructor(l,b,E,S,A,D,z){this.expression=l,this.type=E,this.useIntegerZoom=S,this.zoom=A,this.layerId=z,this.paintVertexAttributes=(E==="array"?$f:Of).members;for(let $=0;$<b.length;++$);this.zoomInPaintVertexArray=new D,this.zoomOutPaintVertexArray=new D}populatePaintArray(l,b,E){const S=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(l),this.zoomOutPaintVertexArray.resize(l),this._setPaintValues(S,l,b.patterns&&b.patterns[this.layerId],E)}updatePaintArray(l,b,E,S,A,D){this._setPaintValues(l,b,E.patterns&&E.patterns[this.layerId],D)}_setPaintValues(l,b,E,S){if(!S||!E)return;const{min:A,mid:D,max:z}=E,$=S[A],V=S[D],Z=S[z];if($&&V&&Z)for(let X=l;X<b;X++)this._setPaintValue(this.zoomInPaintVertexArray,X,V,$),this._setPaintValue(this.zoomOutPaintVertexArray,X,V,Z)}_setPaintValue(l,b,E,S){l.emplace(b,E.tl[0],E.tl[1],E.br[0],E.br[1],S.tl[0],S.tl[1],S.br[0],S.br[1],E.pixelRatio,S.pixelRatio)}upload(l){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=l.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=l.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class go{constructor(l,b,E=()=>!0){this.binders={},this._buffers=[];const S=[];for(const A in l.paint._values){if(!E(A))continue;const D=l.paint.get(A);if(!(D instanceof Hr&&Io(D.property.specification)))continue;const z=Zf(A,l.type),$=D.value,V=D.property.specification.type,Z=D.property.useIntegerZoom,X=D.property.specification["property-type"],Y=X==="cross-faded"||X==="cross-faded-data-driven",ie=String(A)==="line-dasharray"&&l.layout.get("line-cap").value.kind!=="constant";if($.kind!=="constant"||ie)if($.kind==="source"||ie||Y){const ce=ju(A,V,"source");this.binders[A]=Y?new $o($,z,V,Z,b,ce,l.id):new mo($,z,V,ce),S.push(`/a_${A}`)}else{const ce=ju(A,V,"composite");this.binders[A]=new Fn($,z,V,Z,b,ce),S.push(`/z_${A}`)}else this.binders[A]=Y?new ga($.value,z):new fl($.value,z,V),S.push(`/u_${A}`)}this.cacheKey=S.sort().join("")}getMaxValue(l){const b=this.binders[l];return b instanceof mo||b instanceof Fn?b.maxValue:0}populatePaintArrays(l,b,E,S,A,D){for(const z in this.binders){const $=this.binders[z];($ instanceof mo||$ instanceof Fn||$ instanceof $o)&&$.populatePaintArray(l,b,E,S,A,D)}}setConstantPatternPositions(l,b){for(const E in this.binders){const S=this.binders[E];S instanceof ga&&S.setConstantPatternPositions(l,b)}}updatePaintArrays(l,b,E,S,A,D){let z=!1;for(const $ in l){const V=b.getPositions($);for(const Z of V){const X=E.feature(Z.index);for(const Y in this.binders){const ie=this.binders[Y];if((ie instanceof mo||ie instanceof Fn||ie instanceof $o)&&ie.expression.isStateDependent===!0){const ce=S.paint.get(Y);ie.expression=ce.value,ie.updatePaintArray(Z.start,Z.end,X,l[$],A,D),z=!0}}}}return z}defines(){const l=[];for(const b in this.binders){const E=this.binders[b];(E instanceof fl||E instanceof ga)&&l.push(...E.uniformNames.map(S=>`#define HAS_UNIFORM_${S}`))}return l}getBinderAttributes(){const l=[];for(const b in this.binders){const E=this.binders[b];if(E instanceof mo||E instanceof Fn||E instanceof $o)for(let S=0;S<E.paintVertexAttributes.length;S++)l.push(E.paintVertexAttributes[S].name)}return l}getBinderUniforms(){const l=[];for(const b in this.binders){const E=this.binders[b];if(E instanceof fl||E instanceof ga||E instanceof Fn)for(const S of E.uniformNames)l.push(S)}return l}getPaintVertexBuffers(){return this._buffers}getUniforms(l,b){const E=[];for(const S in this.binders){const A=this.binders[S];if(A instanceof fl||A instanceof ga||A instanceof Fn){for(const D of A.uniformNames)if(b[D]){const z=A.getBinding(l,b[D],D);E.push({name:D,property:S,binding:z})}}}return E}setUniforms(l,b,E,S){for(const{name:A,property:D,binding:z}of b)this.binders[D].setUniform(z,S,E.get(D),A)}updatePaintBuffers(l){this._buffers=[];for(const b in this.binders){const E=this.binders[b];if(l&&E instanceof $o){const S=l.fromScale===2?E.zoomInPaintVertexBuffer:E.zoomOutPaintVertexBuffer;S&&this._buffers.push(S)}else(E instanceof mo||E instanceof Fn)&&E.paintVertexBuffer&&this._buffers.push(E.paintVertexBuffer)}}upload(l){for(const b in this.binders){const E=this.binders[b];(E instanceof mo||E instanceof Fn||E instanceof $o)&&E.upload(l)}this.updatePaintBuffers()}destroy(){for(const l in this.binders){const b=this.binders[l];(b instanceof mo||b instanceof Fn||b instanceof $o)&&b.destroy()}}}class Es{constructor(l,b,E=()=>!0){this.programConfigurations={};for(const S of l)this.programConfigurations[S.id]=new go(S,b,E);this.needsUpload=!1,this._featureMap=new wh,this._bufferOffset=0}populatePaintArrays(l,b,E,S,A,D,z){for(const $ in this.programConfigurations)this.programConfigurations[$].populatePaintArrays(l,b,S,A,D,z);b.id!==void 0&&this._featureMap.add(b.id,E,this._bufferOffset,l),this._bufferOffset=l,this.needsUpload=!0}updatePaintArrays(l,b,E,S,A){for(const D of E)this.needsUpload=this.programConfigurations[D.id].updatePaintArrays(l,this._featureMap,b,D,S,A)||this.needsUpload}get(l){return this.programConfigurations[l]}upload(l){if(this.needsUpload){for(const b in this.programConfigurations)this.programConfigurations[b].upload(l);this.needsUpload=!1}}destroy(){for(const l in this.programConfigurations)this.programConfigurations[l].destroy()}}const qf={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function Zf(g,l){return qf[g]||[g.replace(`${l}-`,"").replace(/-/g,"_")]}const Xf={"line-pattern":{source:Fo,composite:Fo},"fill-pattern":{source:Fo,composite:Fo},"fill-extrusion-pattern":{source:Fo,composite:Fo},"line-dasharray":{source:_h,composite:_h}},Yf={color:{source:bh,composite:Mc},number:{source:xh,composite:bh}};function ju(g,l,b){const E=Xf[g];return E&&E[b]||Yf[l][b]}Ft("ConstantBinder",fl),Ft("CrossFadedConstantBinder",ga),Ft("SourceExpressionBinder",mo),Ft("CrossFadedCompositeBinder",$o),Ft("CompositeExpressionBinder",Fn),Ft("ProgramConfiguration",go,{omit:["_buffers"]}),Ft("ProgramConfigurationSet",Es);const Mh="-transition";class On extends qn{constructor(l,b){if(super(),this.id=l.id,this.type=l.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,l.type!=="custom"&&(this.metadata=(l=l).metadata,this.minzoom=l.minzoom,this.maxzoom=l.maxzoom,l.type!=="background"&&l.type!=="sky"&&(this.source=l.source,this.sourceLayer=l["source-layer"],this.filter=l.filter),b.layout&&(this._unevaluatedLayout=new ws(b.layout)),b.paint)){this._transitionablePaint=new Qr(b.paint);for(const E in l.paint)this.setPaintProperty(E,l.paint[E],{validate:!1});for(const E in l.layout)this.setLayoutProperty(E,l.layout[E],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new uo(b.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(l){return l==="visibility"?this.visibility:this._unevaluatedLayout.getValue(l)}setLayoutProperty(l,b,E={}){b!=null&&this._validate(pc,`layers.${this.id}.layout.${l}`,l,b,E)||(l!=="visibility"?this._unevaluatedLayout.setValue(l,b):this.visibility=b)}getPaintProperty(l){return Qt(l,Mh)?this._transitionablePaint.getTransition(l.slice(0,-Mh.length)):this._transitionablePaint.getValue(l)}setPaintProperty(l,b,E={}){if(b!=null&&this._validate(hl,`layers.${this.id}.paint.${l}`,l,b,E))return!1;if(Qt(l,Mh))return this._transitionablePaint.setTransition(l.slice(0,-Mh.length),b||void 0),!1;{const S=this._transitionablePaint._values[l],A=S.property.specification["property-type"]==="cross-faded-data-driven",D=S.value.isDataDriven(),z=S.value;this._transitionablePaint.setValue(l,b),this._handleSpecialPaintPropertyUpdate(l);const $=this._transitionablePaint._values[l].value;return $.isDataDriven()||D||A||this._handleOverridablePaintPropertyUpdate(l,z,$)}}_handleSpecialPaintPropertyUpdate(l){}getProgramIds(){return null}getProgramConfiguration(l){return null}_handleOverridablePaintPropertyUpdate(l,b,E){return!1}isHidden(l){return!!(this.minzoom&&l<this.minzoom)||!!(this.maxzoom&&l>=this.maxzoom)||this.visibility==="none"}updateTransitions(l){this._transitioningPaint=this._transitionablePaint.transitioned(l,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(l,b){l.getCrossfadeParameters&&(this._crossfadeParameters=l.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(l,void 0,b)),this.paint=this._transitioningPaint.possiblyEvaluate(l,void 0,b)}serialize(){const l={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(l.layout=l.layout||{},l.layout.visibility=this.visibility),$i(l,(b,E)=>!(b===void 0||E==="layout"&&!Object.keys(b).length||E==="paint"&&!Object.keys(b).length))}_validate(l,b,E,S,A={}){return(!A||A.validate!==!1)&&mh(this,l.call(Ro,{key:b,layerType:this.type,objectKey:E,value:S,styleSpec:et,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const l in this.paint._values){const b=this.paint.get(l);if(b instanceof Hr&&Io(b.property.specification)&&(b.value.kind==="source"||b.value.kind==="composite")&&b.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=ha(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const Hf=ar([{name:"a_pos",components:2,type:"Int16"}],4),{members:Wf}=Hf;class gr{constructor(l=[]){this.segments=l}prepareSegment(l,b,E,S){let A=this.segments[this.segments.length-1];return l>gr.MAX_VERTEX_ARRAY_LENGTH&&Ai(`Max vertices per segment is ${gr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${l}`),(!A||A.vertexLength+l>gr.MAX_VERTEX_ARRAY_LENGTH||A.sortKey!==S)&&(A={vertexOffset:b.length,primitiveOffset:E.length,vertexLength:0,primitiveLength:0},S!==void 0&&(A.sortKey=S),this.segments.push(A)),A}get(){return this.segments}destroy(){for(const l of this.segments)for(const b in l.vaos)l.vaos[b].destroy()}static simpleSegment(l,b,E,S){return new gr([{vertexOffset:l,primitiveOffset:b,vertexLength:E,primitiveLength:S,vaos:{},sortKey:0}])}}gr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ft("SegmentVector",gr);var Mi=8192;class Ts{constructor(l,b){l&&(b?this.setSouthWest(l).setNorthEast(b):l.length===4?this.setSouthWest([l[0],l[1]]).setNorthEast([l[2],l[3]]):this.setSouthWest(l[0]).setNorthEast(l[1]))}setNorthEast(l){return this._ne=l instanceof Hi?new Hi(l.lng,l.lat):Hi.convert(l),this}setSouthWest(l){return this._sw=l instanceof Hi?new Hi(l.lng,l.lat):Hi.convert(l),this}extend(l){const b=this._sw,E=this._ne;let S,A;if(l instanceof Hi)S=l,A=l;else{if(!(l instanceof Ts))return Array.isArray(l)?l.length===4||l.every(Array.isArray)?this.extend(Ts.convert(l)):this.extend(Hi.convert(l)):this;if(S=l._sw,A=l._ne,!S||!A)return this}return b||E?(b.lng=Math.min(S.lng,b.lng),b.lat=Math.min(S.lat,b.lat),E.lng=Math.max(A.lng,E.lng),E.lat=Math.max(A.lat,E.lat)):(this._sw=new Hi(S.lng,S.lat),this._ne=new Hi(A.lng,A.lat)),this}getCenter(){return new Hi((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Hi(this.getWest(),this.getNorth())}getSouthEast(){return new Hi(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(l){const{lng:b,lat:E}=Hi.convert(l);let S=this._sw.lng<=b&&b<=this._ne.lng;return this._sw.lng>this._ne.lng&&(S=this._sw.lng>=b&&b>=this._ne.lng),this._sw.lat<=E&&E<=this._ne.lat&&S}static convert(l){return!l||l instanceof Ts?l:new Ts(l)}}const Gu=63710088e-1;class Hi{constructor(l,b){if(isNaN(l)||isNaN(b))throw new Error(`Invalid LngLat object: (${l}, ${b})`);if(this.lng=+l,this.lat=+b,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Hi(ri(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(l){const b=Math.PI/180,E=this.lat*b,S=l.lat*b,A=Math.sin(E)*Math.sin(S)+Math.cos(E)*Math.cos(S)*Math.cos((l.lng-this.lng)*b);return Gu*Math.acos(Math.min(A,1))}toBounds(l=0){const b=360*l/40075017,E=b/Math.cos(Math.PI/180*this.lat);return new Ts(new Hi(this.lng-E,this.lat-b),new Hi(this.lng+E,this.lat+b))}static convert(l){if(l instanceof Hi)return l;if(Array.isArray(l)&&(l.length===2||l.length===3))return new Hi(Number(l[0]),Number(l[1]));if(!Array.isArray(l)&&typeof l=="object"&&l!==null)return new Hi(Number("lng"in l?l.lng:l.lon),Number(l.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const qu=2*Math.PI*Gu;function Zu(g){return qu*Math.cos(g*Math.PI/180)}function _a(g){return(180+g)/360}function ya(g){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+g*Math.PI/360)))/360}function $n(g,l){return g/Zu(l)}function _o(g){return 360*g-180}function kn(g){return 360/Math.PI*Math.atan(Math.exp((180-360*g)*Math.PI/180))-90}function Xu(g,l){return g*Zu(kn(l))}const io=85.051129;class Sh{constructor(l,b,E=0){this.x=+l,this.y=+b,this.z=+E}static fromLngLat(l,b=0){const E=Hi.convert(l);return new Sh(_a(E.lng),ya(E.lat),$n(b,E.lat))}toLngLat(){return new Hi(_o(this.x),kn(this.y))}toAltitude(){return Xu(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/qu*(l=kn(this.y),1/Math.cos(l*Math.PI/180));var l}}function kc(g,l,b,E,S,A,D,z,$){const V=(l+E)/2,Z=(b+S)/2,X=new U(V,Z);z(X),function(Y,ie,ce,pe,ve,Ae){const Be=ce-ve,$e=pe-Ae;return Math.abs((pe-ie)*Be-(ce-Y)*$e)/Math.hypot(Be,$e)}(X.x,X.y,A.x,A.y,D.x,D.y)>=$?(kc(g,l,b,V,Z,A,X,z,$),kc(g,V,Z,E,S,X,D,z,$)):g.push(D)}function Kf(g,l,b){const E=[];let S,A,D;for(const z of g){const{x:$,y:V}=z;l(z),D?kc(E,S,A,$,V,D,z,l,b):E.push(z),S=$,A=V,D=z}return E}const Cc=Math.pow(2,14)-1,Yu=-Cc-1;function Jf(g,l){const b=Math.round(g.x*l),E=Math.round(g.y*l);return g.x=Pt(b,Yu,Cc),g.y=Pt(E,Yu,Cc),(b<g.x||b>g.x+1||E<g.y||E>g.y+1)&&Ai("Geometry exceeds allowed extent, reduce your vector tile buffer size"),g}function yo(g,l,b){const E=g.loadGeometry(),S=g.extent,A=Mi/S;if(l&&b&&b.projection.isReprojectedInTileSpace){const D=1<<l.z,{scale:z,x:$,y:V,projection:Z}=b,X=Y=>{const ie=_o((l.x+Y.x/S)/D),ce=kn((l.y+Y.y/S)/D),pe=Z.project(ie,ce);Y.x=(pe.x*z-$)*S,Y.y=(pe.y*z-V)*S};for(let Y=0;Y<E.length;Y++)if(g.type!==1)E[Y]=Kf(E[Y],X,1);else{const ie=[];for(const ce of E[Y])ce.x<0||ce.x>=S||ce.y<0||ce.y>=S||(X(ce),ie.push(ce));E[Y]=ie}}for(const D of E)for(const z of D)Jf(z,A);return E}function Ms(g,l){return{type:g.type,id:g.id,properties:g.properties,geometry:l?yo(g):[]}}function Ah(g,l,b,E,S){g.emplaceBack(2*l+(E+1)/2,2*b+(S+1)/2)}class Dc{constructor(l){this.zoom=l.zoom,this.overscaling=l.overscaling,this.layers=l.layers,this.layerIds=this.layers.map(b=>b.id),this.index=l.index,this.hasPattern=!1,this.layoutVertexArray=new fa,this.indexArray=new vn,this.segments=new gr,this.programConfigurations=new Es(l.layers,l.zoom),this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id)}populate(l,b,E,S){const A=this.layers[0],D=[];let z=null;A.type==="circle"&&(z=A.layout.get("circle-sort-key"));for(const{feature:$,id:V,index:Z,sourceLayerIndex:X}of l){const Y=this.layers[0]._featureFilter.needGeometry,ie=Ms($,Y);if(!this.layers[0]._featureFilter.filter(new ui(this.zoom),ie,E))continue;const ce=z?z.evaluate(ie,{},E):void 0,pe={id:V,properties:$.properties,type:$.type,sourceLayerIndex:X,index:Z,geometry:Y?ie.geometry:yo($,E,S),patterns:{},sortKey:ce};D.push(pe)}z&&D.sort(($,V)=>$.sortKey-V.sortKey);for(const $ of D){const{geometry:V,index:Z,sourceLayerIndex:X}=$,Y=l[Z].feature;this.addFeature($,V,Z,b.availableImages,E),b.featureIndex.insert(Y,V,Z,X,this.index)}}update(l,b,E,S){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(l,b,this.stateDependentLayers,E,S)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(l){this.uploaded||(this.layoutVertexBuffer=l.createVertexBuffer(this.layoutVertexArray,Wf),this.indexBuffer=l.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(l),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(l,b,E,S,A){for(const D of b)for(const z of D){const $=z.x,V=z.y;if($<0||$>=Mi||V<0||V>=Mi)continue;const Z=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,l.sortKey),X=Z.vertexLength;Ah(this.layoutVertexArray,$,V,-1,-1),Ah(this.layoutVertexArray,$,V,1,-1),Ah(this.layoutVertexArray,$,V,1,1),Ah(this.layoutVertexArray,$,V,-1,1),this.indexArray.emplaceBack(X,X+1,X+2),this.indexArray.emplaceBack(X,X+3,X+2),Z.vertexLength+=4,Z.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,l,E,{},S,A)}}function Hu(g,l){for(let b=0;b<g.length;b++)if(xa(l,g[b]))return!0;for(let b=0;b<l.length;b++)if(xa(g,l[b]))return!0;return!!Pc(g,l)}function Qf(g,l,b){return!!xa(g,l)||!!Rc(l,g,b)}function Wu(g,l){if(g.length===1)return Ju(l,g[0]);for(let b=0;b<l.length;b++){const E=l[b];for(let S=0;S<E.length;S++)if(xa(g,E[S]))return!0}for(let b=0;b<g.length;b++)if(Ju(l,g[b]))return!0;for(let b=0;b<l.length;b++)if(Pc(g,l[b]))return!0;return!1}function ep(g,l,b){if(g.length>1){if(Pc(g,l))return!0;for(let E=0;E<l.length;E++)if(Rc(l[E],g,b))return!0}for(let E=0;E<g.length;E++)if(Rc(g[E],l,b))return!0;return!1}function Pc(g,l){if(g.length===0||l.length===0)return!1;for(let b=0;b<g.length-1;b++){const E=g[b],S=g[b+1];for(let A=0;A<l.length-1;A++)if(tp(E,S,l[A],l[A+1]))return!0}return!1}function tp(g,l,b,E){return dr(g,b,E)!==dr(l,b,E)&&dr(g,l,b)!==dr(g,l,E)}function Rc(g,l,b){const E=b*b;if(l.length===1)return g.distSqr(l[0])<E;for(let S=1;S<l.length;S++)if(Ku(g,l[S-1],l[S])<E)return!0;return!1}function Ku(g,l,b){const E=l.distSqr(b);if(E===0)return g.distSqr(l);const S=((g.x-l.x)*(b.x-l.x)+(g.y-l.y)*(b.y-l.y))/E;return g.distSqr(S<0?l:S>1?b:b.sub(l)._mult(S)._add(l))}function Ju(g,l){let b,E,S,A=!1;for(let D=0;D<g.length;D++){b=g[D];for(let z=0,$=b.length-1;z<b.length;$=z++)E=b[z],S=b[$],E.y>l.y!=S.y>l.y&&l.x<(S.x-E.x)*(l.y-E.y)/(S.y-E.y)+E.x&&(A=!A)}return A}function xa(g,l){let b=!1;for(let E=0,S=g.length-1;E<g.length;S=E++){const A=g[E],D=g[S];A.y>l.y!=D.y>l.y&&l.x<(D.x-A.x)*(l.y-A.y)/(D.y-A.y)+A.x&&(b=!b)}return b}function Qu(g,l,b,E,S){for(const D of g)if(l<=D.x&&b<=D.y&&E>=D.x&&S>=D.y)return!0;const A=[new U(l,b),new U(l,S),new U(E,S),new U(E,b)];if(g.length>2){for(const D of A)if(xa(g,D))return!0}for(let D=0;D<g.length-1;D++)if(ip(g[D],g[D+1],A))return!0;return!1}function ip(g,l,b){const E=b[0],S=b[2];if(g.x<E.x&&l.x<E.x||g.x>S.x&&l.x>S.x||g.y<E.y&&l.y<E.y||g.y>S.y&&l.y>S.y)return!1;const A=dr(g,l,b[0]);return A!==dr(g,l,b[1])||A!==dr(g,l,b[2])||A!==dr(g,l,b[3])}function va(g,l,b){const E=l.paint.get(g).value;return E.kind==="constant"?E.value:b.programConfigurations.get(l.id).getMaxValue(g)}function Ih(g){return Math.sqrt(g[0]*g[0]+g[1]*g[1])}function ed(g,l,b,E,S){if(!l[0]&&!l[1])return g;const A=U.convert(l)._mult(S);b==="viewport"&&A._rotate(-E);const D=[];for(let z=0;z<g.length;z++)D.push(g[z].sub(A));return D}function td(g,l,b,E){const S=U.convert(g)._mult(E);return l==="viewport"&&S._rotate(-b),S}Ft("CircleBucket",Dc,{omit:["layers"]});const rp=new Fr({"circle-sort-key":new Jt(et.layout_circle["circle-sort-key"])});var np={paint:new Fr({"circle-radius":new Jt(et.paint_circle["circle-radius"]),"circle-color":new Jt(et.paint_circle["circle-color"]),"circle-blur":new Jt(et.paint_circle["circle-blur"]),"circle-opacity":new Jt(et.paint_circle["circle-opacity"]),"circle-translate":new Ot(et.paint_circle["circle-translate"]),"circle-translate-anchor":new Ot(et.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ot(et.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ot(et.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Jt(et.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Jt(et.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Jt(et.paint_circle["circle-stroke-opacity"])}),layout:rp};class Bc{constructor(l,b){this.points=l,this.planes=b}static fromInvProjectionMatrix(l,b,E,S){const A=Math.pow(2,E),D=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map($=>{const V=Vt([],$,l),Z=1/V[3]/b*A;return function(X,Y,ie){return X[0]=Y[0]*ie[0],X[1]=Y[1]*ie[1],X[2]=Y[2]*ie[2],X[3]=Y[3]*ie[3],X}(V,V,[Z,Z,S?1/V[3]:Z,Z])}),z=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map($=>{const V=At([],zt([],St([],D[$[0]],D[$[1]]),St([],D[$[2]],D[$[1]]))),Z=-Nt(V,D[$[1]]);return V.concat(Z)});return new Bc(D,z)}}class Un{constructor(l,b){this.min=l,this.max=b,this.center=Rt([],Le([],this.min,this.max),.5)}quadrant(l){const b=[l%2==0,l<2],E=Me(this.min),S=Me(this.max);for(let A=0;A<b.length;A++)E[A]=b[A]?this.min[A]:this.center[A],S[A]=b[A]?this.center[A]:this.max[A];return S[2]=this.max[2],new Un(E,S)}distanceX(l){return Math.max(Math.min(this.max[0],l[0]),this.min[0])-l[0]}distanceY(l){return Math.max(Math.min(this.max[1],l[1]),this.min[1])-l[1]}distanceZ(l){return Math.max(Math.min(this.max[2],l[2]),this.min[2])-l[2]}getCorners(){const l=this.min,b=this.max;return[[l[0],l[1],l[2]],[b[0],l[1],l[2]],[b[0],b[1],l[2]],[l[0],b[1],l[2]],[l[0],l[1],b[2]],[b[0],l[1],b[2]],[b[0],b[1],b[2]],[l[0],b[1],b[2]]]}intersects(l){const b=this.getCorners();let E=!0;for(let S=0;S<l.planes.length;S++){const A=l.planes[S];let D=0;for(let z=0;z<b.length;z++)D+=Nt(A,b[z])+A[3]>=0;if(D===0)return 0;D!==b.length&&(E=!1)}if(E)return 2;for(let S=0;S<3;S++){let A=Number.MAX_VALUE,D=-Number.MAX_VALUE;for(let z=0;z<l.points.length;z++){const $=l.points[z][S]-this.min[S];A=Math.min(A,$),D=Math.max(D,$)}if(D<0||A>this.max[S]-this.min[S])return 0}return 1}}function id(g,l,b,E,S,A,D,z,$){if(A&&g.queryGeometry.isAboveHorizon)return!1;A&&($*=g.pixelToTileUnitsFactor);for(const V of l)for(const Z of V){const X=Z.add(z),Y=S&&b.elevation?b.elevation.exaggeration()*S.getElevationAt(X.x,X.y,!0):0,ie=A?X:op(X,Y,E),ce=A?g.tilespaceRays.map(ve=>ap(ve,Y)):g.queryGeometry.screenGeometry,pe=Vt([],[Z.x,Z.y,Y,1],E);if(!D&&A?$*=pe[3]/b.cameraToCenterDistance:D&&!A&&($*=b.cameraToCenterDistance/pe[3]),Qf(ce,ie,$))return!0}return!1}function op(g,l,b){const E=Vt([],[g.x,g.y,l,1],b);return new U(E[0]/E[3],E[1]/E[3])}const rd=ge(0,0,0),sp=ge(0,0,1);function ap(g,l){const b=ue();return rd[2]=l,g.intersectsPlane(rd,sp,b),new U(b[0],b[1])}class nd extends Dc{}function Lc(g,{width:l,height:b},E,S){if(S){if(S instanceof Uint8ClampedArray)S=new Uint8Array(S.buffer);else if(S.length!==l*b*E)throw new RangeError("mismatched image size")}else S=new Uint8Array(l*b*E);return g.width=l,g.height=b,g.data=S,g}function od(g,{width:l,height:b},E){if(l===g.width&&b===g.height)return;const S=Lc({},{width:l,height:b},E);zc(g,S,{x:0,y:0},{x:0,y:0},{width:Math.min(g.width,l),height:Math.min(g.height,b)},E),g.width=l,g.height=b,g.data=S.data}function zc(g,l,b,E,S,A){if(S.width===0||S.height===0)return l;if(S.width>g.width||S.height>g.height||b.x>g.width-S.width||b.y>g.height-S.height)throw new RangeError("out of range source coordinates for image copy");if(S.width>l.width||S.height>l.height||E.x>l.width-S.width||E.y>l.height-S.height)throw new RangeError("out of range destination coordinates for image copy");const D=g.data,z=l.data;for(let $=0;$<S.height;$++){const V=((b.y+$)*g.width+b.x)*A,Z=((E.y+$)*l.width+E.x)*A;for(let X=0;X<S.width*A;X++)z[Z+X]=D[V+X]}return l}Ft("HeatmapBucket",nd,{omit:["layers"]});class Uo{constructor(l,b){Lc(this,l,1,b)}resize(l){od(this,l,1)}clone(){return new Uo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(l,b,E,S,A){zc(l,b,E,S,A,1)}}class bn{constructor(l,b){Lc(this,l,4,b)}resize(l){od(this,l,4)}replace(l,b){b?this.data.set(l):this.data=l instanceof Uint8ClampedArray?new Uint8Array(l.buffer):l}clone(){return new bn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(l,b,E,S,A){zc(l,b,E,S,A,4)}}Ft("AlphaImage",Uo),Ft("RGBAImage",bn);var lp={paint:new Fr({"heatmap-radius":new Jt(et.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Jt(et.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ot(et.paint_heatmap["heatmap-intensity"]),"heatmap-color":new to(et.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ot(et.paint_heatmap["heatmap-opacity"])})};function Fc(g){const l={},b=g.resolution||256,E=g.clips?g.clips.length:1,S=g.image||new bn({width:b,height:E}),A=(D,z,$)=>{l[g.evaluationKey]=$;const V=g.expression.evaluate(l);S.data[D+z+0]=Math.floor(255*V.r/V.a),S.data[D+z+1]=Math.floor(255*V.g/V.a),S.data[D+z+2]=Math.floor(255*V.b/V.a),S.data[D+z+3]=Math.floor(255*V.a)};if(g.clips)for(let D=0,z=0;D<E;++D,z+=4*b)for(let $=0,V=0;$<b;$++,V+=4){const Z=$/(b-1),{start:X,end:Y}=g.clips[D];A(z,V,X*(1-Z)+Y*Z)}else for(let D=0,z=0;D<b;D++,z+=4)A(0,z,D/(b-1));return S}var hp={paint:new Fr({"hillshade-illumination-direction":new Ot(et.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ot(et.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ot(et.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ot(et.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ot(et.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ot(et.paint_hillshade["hillshade-accent-color"])})};const cp=ar([{name:"a_pos",components:2,type:"Int16"}],4),{members:up}=cp;var kh=Ch,dp=Ch;function Ch(g,l,b){b=b||2;var E,S,A,D,z,$,V,Z=l&&l.length,X=Z?l[0]*b:g.length,Y=sd(g,0,X,b,!0),ie=[];if(!Y||Y.next===Y.prev)return ie;if(Z&&(Y=function(pe,ve,Ae,Be){var $e,Ve,Ge,Xe=[];for($e=0,Ve=ve.length;$e<Ve;$e++)(Ge=sd(pe,ve[$e]*Be,$e<Ve-1?ve[$e+1]*Be:pe.length,Be,!1))===Ge.next&&(Ge.steiner=!0),Xe.push(vp(Ge));for(Xe.sort(_p),$e=0;$e<Xe.length;$e++)Ae=No(Ae=yp(Xe[$e],Ae),Ae.next);return Ae}(g,l,Y,b)),g.length>80*b){E=A=g[0],S=D=g[1];for(var ce=b;ce<X;ce+=b)(z=g[ce])<E&&(E=z),($=g[ce+1])<S&&(S=$),z>A&&(A=z),$>D&&(D=$);V=(V=Math.max(A-E,D-S))!==0?1/V:0}return pl(Y,ie,b,E,S,V),ie}function sd(g,l,b,E,S){var A,D;if(S===Uc(g,l,b,E)>0)for(A=l;A<b;A+=E)D=hd(A,g[A],g[A+1],D);else for(A=b-E;A>=l;A-=E)D=hd(A,g[A],g[A+1],D);return D&&Dh(D,D.next)&&(gl(D),D=D.next),D}function No(g,l){if(!g)return g;l||(l=g);var b,E=g;do if(b=!1,E.steiner||!Dh(E,E.next)&&_r(E.prev,E,E.next)!==0)E=E.next;else{if(gl(E),(E=l=E.prev)===E.next)break;b=!0}while(b||E!==l);return l}function pl(g,l,b,E,S,A,D){if(g){!D&&A&&function(Z,X,Y,ie){var ce=Z;do ce.z===null&&(ce.z=Oc(ce.x,ce.y,X,Y,ie)),ce.prevZ=ce.prev,ce.nextZ=ce.next,ce=ce.next;while(ce!==Z);ce.prevZ.nextZ=null,ce.prevZ=null,function(pe){var ve,Ae,Be,$e,Ve,Ge,Xe,nt,it=1;do{for(Ae=pe,pe=null,Ve=null,Ge=0;Ae;){for(Ge++,Be=Ae,Xe=0,ve=0;ve<it&&(Xe++,Be=Be.nextZ);ve++);for(nt=it;Xe>0||nt>0&&Be;)Xe!==0&&(nt===0||!Be||Ae.z<=Be.z)?($e=Ae,Ae=Ae.nextZ,Xe--):($e=Be,Be=Be.nextZ,nt--),Ve?Ve.nextZ=$e:pe=$e,$e.prevZ=Ve,Ve=$e;Ae=Be}Ve.nextZ=null,it*=2}while(Ge>1)}(ce)}(g,E,S,A);for(var z,$,V=g;g.prev!==g.next;)if(z=g.prev,$=g.next,A?pp(g,E,S,A):fp(g))l.push(z.i/b),l.push(g.i/b),l.push($.i/b),gl(g),g=$.next,V=$.next;else if((g=$)===V){D?D===1?pl(g=mp(No(g),l,b),l,b,E,S,A,2):D===2&&gp(g,l,b,E,S,A):pl(No(g),l,b,E,S,A,1);break}}}function fp(g){var l=g.prev,b=g,E=g.next;if(_r(l,b,E)>=0)return!1;for(var S=g.next.next;S!==g.prev;){if(ba(l.x,l.y,b.x,b.y,E.x,E.y,S.x,S.y)&&_r(S.prev,S,S.next)>=0)return!1;S=S.next}return!0}function pp(g,l,b,E){var S=g.prev,A=g,D=g.next;if(_r(S,A,D)>=0)return!1;for(var z=S.x>A.x?S.x>D.x?S.x:D.x:A.x>D.x?A.x:D.x,$=S.y>A.y?S.y>D.y?S.y:D.y:A.y>D.y?A.y:D.y,V=Oc(S.x<A.x?S.x<D.x?S.x:D.x:A.x<D.x?A.x:D.x,S.y<A.y?S.y<D.y?S.y:D.y:A.y<D.y?A.y:D.y,l,b,E),Z=Oc(z,$,l,b,E),X=g.prevZ,Y=g.nextZ;X&&X.z>=V&&Y&&Y.z<=Z;){if(X!==g.prev&&X!==g.next&&ba(S.x,S.y,A.x,A.y,D.x,D.y,X.x,X.y)&&_r(X.prev,X,X.next)>=0||(X=X.prevZ,Y!==g.prev&&Y!==g.next&&ba(S.x,S.y,A.x,A.y,D.x,D.y,Y.x,Y.y)&&_r(Y.prev,Y,Y.next)>=0))return!1;Y=Y.nextZ}for(;X&&X.z>=V;){if(X!==g.prev&&X!==g.next&&ba(S.x,S.y,A.x,A.y,D.x,D.y,X.x,X.y)&&_r(X.prev,X,X.next)>=0)return!1;X=X.prevZ}for(;Y&&Y.z<=Z;){if(Y!==g.prev&&Y!==g.next&&ba(S.x,S.y,A.x,A.y,D.x,D.y,Y.x,Y.y)&&_r(Y.prev,Y,Y.next)>=0)return!1;Y=Y.nextZ}return!0}function mp(g,l,b){var E=g;do{var S=E.prev,A=E.next.next;!Dh(S,A)&&ad(S,E,E.next,A)&&ml(S,A)&&ml(A,S)&&(l.push(S.i/b),l.push(E.i/b),l.push(A.i/b),gl(E),gl(E.next),E=g=A),E=E.next}while(E!==g);return No(E)}function gp(g,l,b,E,S,A){var D=g;do{for(var z=D.next.next;z!==D.prev;){if(D.i!==z.i&&bp(D,z)){var $=ld(D,z);return D=No(D,D.next),$=No($,$.next),pl(D,l,b,E,S,A),void pl($,l,b,E,S,A)}z=z.next}D=D.next}while(D!==g)}function _p(g,l){return g.x-l.x}function yp(g,l){var b=function(A,D){var z,$=D,V=A.x,Z=A.y,X=-1/0;do{if(Z<=$.y&&Z>=$.next.y&&$.next.y!==$.y){var Y=$.x+(Z-$.y)*($.next.x-$.x)/($.next.y-$.y);if(Y<=V&&Y>X){if(X=Y,Y===V){if(Z===$.y)return $;if(Z===$.next.y)return $.next}z=$.x<$.next.x?$:$.next}}$=$.next}while($!==D);if(!z)return null;if(V===X)return z;var ie,ce=z,pe=z.x,ve=z.y,Ae=1/0;$=z;do V>=$.x&&$.x>=pe&&V!==$.x&&ba(Z<ve?V:X,Z,pe,ve,Z<ve?X:V,Z,$.x,$.y)&&(ie=Math.abs(Z-$.y)/(V-$.x),ml($,A)&&(ie<Ae||ie===Ae&&($.x>z.x||$.x===z.x&&xp(z,$)))&&(z=$,Ae=ie)),$=$.next;while($!==ce);return z}(g,l);if(!b)return l;var E=ld(b,g),S=No(b,b.next);return No(E,E.next),l===b?S:l}function xp(g,l){return _r(g.prev,g,l.prev)<0&&_r(l.next,g,g.next)<0}function Oc(g,l,b,E,S){return(g=1431655765&((g=858993459&((g=252645135&((g=16711935&((g=32767*(g-b)*S)|g<<8))|g<<4))|g<<2))|g<<1))|(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=32767*(l-E)*S)|l<<8))|l<<4))|l<<2))|l<<1))<<1}function vp(g){var l=g,b=g;do(l.x<b.x||l.x===b.x&&l.y<b.y)&&(b=l),l=l.next;while(l!==g);return b}function ba(g,l,b,E,S,A,D,z){return(S-D)*(l-z)-(g-D)*(A-z)>=0&&(g-D)*(E-z)-(b-D)*(l-z)>=0&&(b-D)*(A-z)-(S-D)*(E-z)>=0}function bp(g,l){return g.next.i!==l.i&&g.prev.i!==l.i&&!function(b,E){var S=b;do{if(S.i!==b.i&&S.next.i!==b.i&&S.i!==E.i&&S.next.i!==E.i&&ad(S,S.next,b,E))return!0;S=S.next}while(S!==b);return!1}(g,l)&&(ml(g,l)&&ml(l,g)&&function(b,E){var S=b,A=!1,D=(b.x+E.x)/2,z=(b.y+E.y)/2;do S.y>z!=S.next.y>z&&S.next.y!==S.y&&D<(S.next.x-S.x)*(z-S.y)/(S.next.y-S.y)+S.x&&(A=!A),S=S.next;while(S!==b);return A}(g,l)&&(_r(g.prev,g,l.prev)||_r(g,l.prev,l))||Dh(g,l)&&_r(g.prev,g,g.next)>0&&_r(l.prev,l,l.next)>0)}function _r(g,l,b){return(l.y-g.y)*(b.x-l.x)-(l.x-g.x)*(b.y-l.y)}function Dh(g,l){return g.x===l.x&&g.y===l.y}function ad(g,l,b,E){var S=Rh(_r(g,l,b)),A=Rh(_r(g,l,E)),D=Rh(_r(b,E,g)),z=Rh(_r(b,E,l));return S!==A&&D!==z||!(S!==0||!Ph(g,b,l))||!(A!==0||!Ph(g,E,l))||!(D!==0||!Ph(b,g,E))||!(z!==0||!Ph(b,l,E))}function Ph(g,l,b){return l.x<=Math.max(g.x,b.x)&&l.x>=Math.min(g.x,b.x)&&l.y<=Math.max(g.y,b.y)&&l.y>=Math.min(g.y,b.y)}function Rh(g){return g>0?1:g<0?-1:0}function ml(g,l){return _r(g.prev,g,g.next)<0?_r(g,l,g.next)>=0&&_r(g,g.prev,l)>=0:_r(g,l,g.prev)<0||_r(g,g.next,l)<0}function ld(g,l){var b=new $c(g.i,g.x,g.y),E=new $c(l.i,l.x,l.y),S=g.next,A=l.prev;return g.next=l,l.prev=g,b.next=S,S.prev=b,E.next=b,b.prev=E,A.next=E,E.prev=A,E}function hd(g,l,b,E){var S=new $c(g,l,b);return E?(S.next=E.next,S.prev=E,E.next.prev=S,E.next=S):(S.prev=S,S.next=S),S}function gl(g){g.next.prev=g.prev,g.prev.next=g.next,g.prevZ&&(g.prevZ.nextZ=g.nextZ),g.nextZ&&(g.nextZ.prevZ=g.prevZ)}function $c(g,l,b){this.i=g,this.x=l,this.y=b,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Uc(g,l,b,E){for(var S=0,A=l,D=b-E;A<b;A+=E)S+=(g[D]-g[A])*(g[A+1]+g[D+1]),D=A;return S}function wp(g,l,b,E,S){cd(g,l,b||0,E||g.length-1,S||Ep)}function cd(g,l,b,E,S){for(;E>b;){if(E-b>600){var A=E-b+1,D=l-b+1,z=Math.log(A),$=.5*Math.exp(2*z/3),V=.5*Math.sqrt(z*$*(A-$)/A)*(D-A/2<0?-1:1);cd(g,l,Math.max(b,Math.floor(l-D*$/A+V)),Math.min(E,Math.floor(l+(A-D)*$/A+V)),S)}var Z=g[l],X=b,Y=E;for(_l(g,b,l),S(g[E],Z)>0&&_l(g,b,E);X<Y;){for(_l(g,X,Y),X++,Y--;S(g[X],Z)<0;)X++;for(;S(g[Y],Z)>0;)Y--}S(g[b],Z)===0?_l(g,b,Y):_l(g,++Y,E),Y<=l&&(b=Y+1),l<=Y&&(E=Y-1)}}function _l(g,l,b){var E=g[l];g[l]=g[b],g[b]=E}function Ep(g,l){return g<l?-1:g>l?1:0}function Nc(g,l){const b=g.length;if(b<=1)return[g];const E=[];let S,A;for(let D=0;D<b;D++){const z=on(g[D]);z!==0&&(g[D].area=Math.abs(z),A===void 0&&(A=z<0),A===z<0?(S&&E.push(S),S=[g[D]]):S.push(g[D]))}if(S&&E.push(S),l>1)for(let D=0;D<E.length;D++)E[D].length<=l||(wp(E[D],l,1,E[D].length-1,Tp),E[D]=E[D].slice(0,l));return E}function Tp(g,l){return l.area-g.area}function Vc(g,l,b){const E=b.patternDependencies;let S=!1;for(const A of l){const D=A.paint.get(`${g}-pattern`);D.isConstant()||(S=!0);const z=D.constantOr(null);z&&(S=!0,E[z.to]=!0,E[z.from]=!0)}return S}function jc(g,l,b,E,S){const A=S.patternDependencies;for(const D of l){const z=D.paint.get(`${g}-pattern`).value;if(z.kind!=="constant"){let $=z.evaluate({zoom:E-1},b,{},S.availableImages),V=z.evaluate({zoom:E},b,{},S.availableImages),Z=z.evaluate({zoom:E+1},b,{},S.availableImages);$=$&&$.name?$.name:$,V=V&&V.name?V.name:V,Z=Z&&Z.name?Z.name:Z,A[$]=!0,A[V]=!0,A[Z]=!0,b.patterns[D.id]={min:$,mid:V,max:Z}}}return b}Ch.deviation=function(g,l,b,E){var S=l&&l.length,A=Math.abs(Uc(g,0,S?l[0]*b:g.length,b));if(S)for(var D=0,z=l.length;D<z;D++)A-=Math.abs(Uc(g,l[D]*b,D<z-1?l[D+1]*b:g.length,b));var $=0;for(D=0;D<E.length;D+=3){var V=E[D]*b,Z=E[D+1]*b,X=E[D+2]*b;$+=Math.abs((g[V]-g[X])*(g[Z+1]-g[V+1])-(g[V]-g[Z])*(g[X+1]-g[V+1]))}return A===0&&$===0?0:Math.abs(($-A)/A)},Ch.flatten=function(g){for(var l=g[0][0].length,b={vertices:[],holes:[],dimensions:l},E=0,S=0;S<g.length;S++){for(var A=0;A<g[S].length;A++)for(var D=0;D<l;D++)b.vertices.push(g[S][A][D]);S>0&&b.holes.push(E+=g[S-1].length)}return b},kh.default=dp;class Bh{constructor(l){this.zoom=l.zoom,this.overscaling=l.overscaling,this.layers=l.layers,this.layerIds=this.layers.map(b=>b.id),this.index=l.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new fa,this.indexArray=new vn,this.indexArray2=new Oo,this.programConfigurations=new Es(l.layers,l.zoom),this.segments=new gr,this.segments2=new gr,this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id)}populate(l,b,E,S){this.hasPattern=Vc("fill",this.layers,b);const A=this.layers[0].layout.get("fill-sort-key"),D=[];for(const{feature:z,id:$,index:V,sourceLayerIndex:Z}of l){const X=this.layers[0]._featureFilter.needGeometry,Y=Ms(z,X);if(!this.layers[0]._featureFilter.filter(new ui(this.zoom),Y,E))continue;const ie=A?A.evaluate(Y,{},E,b.availableImages):void 0,ce={id:$,properties:z.properties,type:z.type,sourceLayerIndex:Z,index:V,geometry:X?Y.geometry:yo(z,E,S),patterns:{},sortKey:ie};D.push(ce)}A&&D.sort((z,$)=>z.sortKey-$.sortKey);for(const z of D){const{geometry:$,index:V,sourceLayerIndex:Z}=z;if(this.hasPattern){const X=jc("fill",this.layers,z,this.zoom,b);this.patternFeatures.push(X)}else this.addFeature(z,$,V,E,{},b.availableImages);b.featureIndex.insert(l[V].feature,$,V,Z,this.index)}}update(l,b,E,S){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(l,b,this.stateDependentLayers,E,S)}addFeatures(l,b,E,S){for(const A of this.patternFeatures)this.addFeature(A,A.geometry,A.index,b,E,S)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(l){this.uploaded||(this.layoutVertexBuffer=l.createVertexBuffer(this.layoutVertexArray,up),this.indexBuffer=l.createIndexBuffer(this.indexArray),this.indexBuffer2=l.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(l),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(l,b,E,S,A,D=[]){for(const z of Nc(b,500)){let $=0;for(const ce of z)$+=ce.length;const V=this.segments.prepareSegment($,this.layoutVertexArray,this.indexArray),Z=V.vertexLength,X=[],Y=[];for(const ce of z){if(ce.length===0)continue;ce!==z[0]&&Y.push(X.length/2);const pe=this.segments2.prepareSegment(ce.length,this.layoutVertexArray,this.indexArray2),ve=pe.vertexLength;this.layoutVertexArray.emplaceBack(ce[0].x,ce[0].y),this.indexArray2.emplaceBack(ve+ce.length-1,ve),X.push(ce[0].x),X.push(ce[0].y);for(let Ae=1;Ae<ce.length;Ae++)this.layoutVertexArray.emplaceBack(ce[Ae].x,ce[Ae].y),this.indexArray2.emplaceBack(ve+Ae-1,ve+Ae),X.push(ce[Ae].x),X.push(ce[Ae].y);pe.vertexLength+=ce.length,pe.primitiveLength+=ce.length}const ie=kh(X,Y);for(let ce=0;ce<ie.length;ce+=3)this.indexArray.emplaceBack(Z+ie[ce],Z+ie[ce+1],Z+ie[ce+2]);V.vertexLength+=$,V.primitiveLength+=ie.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,l,E,A,D,S)}}Ft("FillBucket",Bh,{omit:["layers","patternFeatures"]});const Mp=new Fr({"fill-sort-key":new Jt(et.layout_fill["fill-sort-key"])});var Sp={paint:new Fr({"fill-antialias":new Ot(et.paint_fill["fill-antialias"]),"fill-opacity":new Jt(et.paint_fill["fill-opacity"]),"fill-color":new Jt(et.paint_fill["fill-color"]),"fill-outline-color":new Jt(et.paint_fill["fill-outline-color"]),"fill-translate":new Ot(et.paint_fill["fill-translate"]),"fill-translate-anchor":new Ot(et.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ir(et.paint_fill["fill-pattern"])}),layout:Mp};const Ap=ar([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Ip=ar([{name:"a_centroid_pos",components:2,type:"Uint16"}]),{members:kp}=Ap;var ud=wa;function wa(g,l,b,E,S){this.properties={},this.extent=b,this.type=0,this._pbf=g,this._geometry=-1,this._keys=E,this._values=S,g.readFields(Cp,this,l)}function Cp(g,l,b){g==1?l.id=b.readVarint():g==2?function(E,S){for(var A=E.readVarint()+E.pos;E.pos<A;){var D=S._keys[E.readVarint()],z=S._values[E.readVarint()];S.properties[D]=z}}(b,l):g==3?l.type=b.readVarint():g==4&&(l._geometry=b.pos)}function Dp(g){for(var l,b,E=0,S=0,A=g.length,D=A-1;S<A;D=S++)E+=((b=g[D]).x-(l=g[S]).x)*(l.y+b.y);return E}wa.types=["Unknown","Point","LineString","Polygon"],wa.prototype.loadGeometry=function(){var g=this._pbf;g.pos=this._geometry;for(var l,b=g.readVarint()+g.pos,E=1,S=0,A=0,D=0,z=[];g.pos<b;){if(S<=0){var $=g.readVarint();E=7&$,S=$>>3}if(S--,E===1||E===2)A+=g.readSVarint(),D+=g.readSVarint(),E===1&&(l&&z.push(l),l=[]),l.push(new U(A,D));else{if(E!==7)throw new Error("unknown command "+E);l&&l.push(l[0].clone())}}return l&&z.push(l),z},wa.prototype.bbox=function(){var g=this._pbf;g.pos=this._geometry;for(var l=g.readVarint()+g.pos,b=1,E=0,S=0,A=0,D=1/0,z=-1/0,$=1/0,V=-1/0;g.pos<l;){if(E<=0){var Z=g.readVarint();b=7&Z,E=Z>>3}if(E--,b===1||b===2)(S+=g.readSVarint())<D&&(D=S),S>z&&(z=S),(A+=g.readSVarint())<$&&($=A),A>V&&(V=A);else if(b!==7)throw new Error("unknown command "+b)}return[D,$,z,V]},wa.prototype.toGeoJSON=function(g,l,b){var E,S,A=this.extent*Math.pow(2,b),D=this.extent*g,z=this.extent*l,$=this.loadGeometry(),V=wa.types[this.type];function Z(ie){for(var ce=0;ce<ie.length;ce++){var pe=ie[ce];ie[ce]=[360*(pe.x+D)/A-180,360/Math.PI*Math.atan(Math.exp((180-360*(pe.y+z)/A)*Math.PI/180))-90]}}switch(this.type){case 1:var X=[];for(E=0;E<$.length;E++)X[E]=$[E][0];Z($=X);break;case 2:for(E=0;E<$.length;E++)Z($[E]);break;case 3:for($=function(ie){var ce=ie.length;if(ce<=1)return[ie];for(var pe,ve,Ae=[],Be=0;Be<ce;Be++){var $e=Dp(ie[Be]);$e!==0&&(ve===void 0&&(ve=$e<0),ve===$e<0?(pe&&Ae.push(pe),pe=[ie[Be]]):pe.push(ie[Be]))}return pe&&Ae.push(pe),Ae}($),E=0;E<$.length;E++)for(S=0;S<$[E].length;S++)Z($[E][S])}$.length===1?$=$[0]:V="Multi"+V;var Y={type:"Feature",geometry:{type:V,coordinates:$},properties:this.properties};return"id"in this&&(Y.id=this.id),Y};var dd=fd;function fd(g,l){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=g,this._keys=[],this._values=[],this._features=[],g.readFields(Pp,this,l),this.length=this._features.length}function Pp(g,l,b){g===15?l.version=b.readVarint():g===1?l.name=b.readString():g===5?l.extent=b.readVarint():g===2?l._features.push(b.pos):g===3?l._keys.push(b.readString()):g===4&&l._values.push(function(E){for(var S=null,A=E.readVarint()+E.pos;E.pos<A;){var D=E.readVarint()>>3;S=D===1?E.readString():D===2?E.readFloat():D===3?E.readDouble():D===4?E.readVarint64():D===5?E.readVarint():D===6?E.readSVarint():D===7?E.readBoolean():null}return S}(b))}function Rp(g,l,b){if(g===3){var E=new dd(b,b.readVarint()+b.pos);E.length&&(l[E.name]=E)}}fd.prototype.feature=function(g){if(g<0||g>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[g];var l=this._pbf.readVarint()+this._pbf.pos;return new ud(this._pbf,l,this.extent,this._keys,this._values)};var Ss={VectorTile:function(g,l){this.layers=g.readFields(Rp,{},l)},VectorTileFeature:ud,VectorTileLayer:dd};const Bp=Ss.VectorTileFeature.types,Lp=Math.pow(2,13);function yl(g,l,b,E,S,A,D,z){g.emplaceBack((l<<1)+D,(b<<1)+A,(Math.floor(E*Lp)<<1)+S,Math.round(z))}class pd{constructor(){this.acc=new U(0,0),this.polyCount=[]}startRing(l){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new U(l.x,l.y),this.max=new U(l.x,l.y))}append(l,b){this.currentPolyCount.edges++,this.acc._add(l);let E=!!this.borders;const S=this.min,A=this.max;l.x<S.x?(S.x=l.x,E=!0):l.x>A.x&&(A.x=l.x,E=!0),l.y<S.y?(S.y=l.y,E=!0):l.y>A.y&&(A.y=l.y,E=!0),((l.x===0||l.x===Mi)&&l.x===b.x)!=((l.y===0||l.y===Mi)&&l.y===b.y)&&this.processBorderOverlap(l,b),E&&this.checkBorderIntersection(l,b)}checkBorderIntersection(l,b){b.x<0!=l.x<0&&this.addBorderIntersection(0,ji(b.y,l.y,(0-b.x)/(l.x-b.x))),b.x>Mi!=l.x>Mi&&this.addBorderIntersection(1,ji(b.y,l.y,(Mi-b.x)/(l.x-b.x))),b.y<0!=l.y<0&&this.addBorderIntersection(2,ji(b.x,l.x,(0-b.y)/(l.y-b.y))),b.y>Mi!=l.y>Mi&&this.addBorderIntersection(3,ji(b.x,l.x,(Mi-b.y)/(l.y-b.y)))}addBorderIntersection(l,b){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const E=this.borders[l];b<E[0]&&(E[0]=b),b>E[1]&&(E[1]=b)}processBorderOverlap(l,b){if(l.x===b.x){if(l.y===b.y)return;const E=l.x===0?0:1;this.addBorderIntersection(E,b.y),this.addBorderIntersection(E,l.y)}else{const E=l.y===0?2:3;this.addBorderIntersection(E,b.x),this.addBorderIntersection(E,l.x)}}centroid(){const l=this.polyCount.reduce((b,E)=>b+E.edges,0);return l!==0?this.acc.div(l)._round():new U(0,0)}span(){return new U(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((l,b)=>l+ +(b[0]!==Number.MAX_VALUE),0)}}class Gc{constructor(l){this.zoom=l.zoom,this.overscaling=l.overscaling,this.layers=l.layers,this.layerIds=this.layers.map(b=>b.id),this.index=l.index,this.hasPattern=!1,this.layoutVertexArray=new pa,this.centroidVertexArray=new Ou,this.indexArray=new vn,this.programConfigurations=new Es(l.layers,l.zoom),this.segments=new gr,this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id),this.enableTerrain=l.enableTerrain}populate(l,b,E,S){this.features=[],this.hasPattern=Vc("fill-extrusion",this.layers,b),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDone=[!1,!1,!1,!1],this.tileToMeter=function(A){const D=Math.exp(Math.PI*(1-A.y/(1<<A.z)*2));return 80150034*D/(D*D+1)/Mi/(1<<A.z)}(E);for(const{feature:A,id:D,index:z,sourceLayerIndex:$}of l){const V=this.layers[0]._featureFilter.needGeometry,Z=Ms(A,V);if(!this.layers[0]._featureFilter.filter(new ui(this.zoom),Z,E))continue;const X={id:D,sourceLayerIndex:$,index:z,geometry:V?Z.geometry:yo(A,E,S),properties:A.properties,type:A.type,patterns:{}},Y=this.layoutVertexArray.length;this.hasPattern?this.features.push(jc("fill-extrusion",this.layers,X,this.zoom,b)):this.addFeature(X,X.geometry,z,E,{},b.availableImages),b.featureIndex.insert(A,X.geometry,z,$,this.index,Y)}this.sortBorders()}addFeatures(l,b,E,S){for(const A of this.features){const{geometry:D}=A;this.addFeature(A,D,A.index,b,E,S)}this.sortBorders()}update(l,b,E,S){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(l,b,this.stateDependentLayers,E,S)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(l){this.uploaded||(this.layoutVertexBuffer=l.createVertexBuffer(this.layoutVertexArray,kp),this.indexBuffer=l.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(l),this.uploaded=!0}uploadCentroid(l){this.centroidVertexArray.length!==0&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=l.createVertexBuffer(this.centroidVertexArray,Ip.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(l,b,E,S,A,D){const z=this.enableTerrain?new pd:null;for(const V of Nc(b,500)){let Z=0,X=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);if(V.length===0||($=V[0]).every(ve=>ve.x<=0)||$.every(ve=>ve.x>=Mi)||$.every(ve=>ve.y<=0)||$.every(ve=>ve.y>=Mi))continue;for(let ve=0;ve<V.length;ve++){const Ae=V[ve];if(Ae.length===0)continue;Z+=Ae.length;let Be=0;z&&z.startRing(Ae[0]);for(let $e=0;$e<Ae.length;$e++){const Ve=Ae[$e];if($e>=1){const Ge=Ae[$e-1];if(!zp(Ve,Ge)){z&&z.append(Ve,Ge),X.vertexLength+4>gr.MAX_VERTEX_ARRAY_LENGTH&&(X=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const Xe=Ve.sub(Ge)._perp(),nt=Xe.x/(Math.abs(Xe.x)+Math.abs(Xe.y)),it=Xe.y>0?1:0,bt=Ge.dist(Ve);Be+bt>32768&&(Be=0),yl(this.layoutVertexArray,Ve.x,Ve.y,nt,it,0,0,Be),yl(this.layoutVertexArray,Ve.x,Ve.y,nt,it,0,1,Be),Be+=bt,yl(this.layoutVertexArray,Ge.x,Ge.y,nt,it,0,0,Be),yl(this.layoutVertexArray,Ge.x,Ge.y,nt,it,0,1,Be);const mt=X.vertexLength;this.indexArray.emplaceBack(mt,mt+2,mt+1),this.indexArray.emplaceBack(mt+1,mt+2,mt+3),X.vertexLength+=4,X.primitiveLength+=2}}}}if(X.vertexLength+Z>gr.MAX_VERTEX_ARRAY_LENGTH&&(X=this.segments.prepareSegment(Z,this.layoutVertexArray,this.indexArray)),Bp[l.type]!=="Polygon")continue;const Y=[],ie=[],ce=X.vertexLength;for(let ve=0;ve<V.length;ve++){const Ae=V[ve];if(Ae.length!==0){Ae!==V[0]&&ie.push(Y.length/2);for(let Be=0;Be<Ae.length;Be++){const $e=Ae[Be];yl(this.layoutVertexArray,$e.x,$e.y,0,0,1,1,0),Y.push($e.x),Y.push($e.y),z&&z.currentPolyCount.top++}}}const pe=kh(Y,ie);for(let ve=0;ve<pe.length;ve+=3)this.indexArray.emplaceBack(ce+pe[ve],ce+pe[ve+2],ce+pe[ve+1]);X.primitiveLength+=pe.length/3,X.vertexLength+=Z}var $;if(z&&z.polyCount.length>0){if(z.borders){z.vertexArrayOffset=this.centroidVertexArray.length;const V=z.borders,Z=this.featuresOnBorder.push(z)-1;for(let X=0;X<4;X++)V[X][0]!==Number.MAX_VALUE&&this.borders[X].push(Z)}this.encodeCentroid(z.borders?void 0:z.centroid(),z)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,l,E,A,D,S)}sortBorders(){for(let l=0;l<4;l++)this.borders[l].sort((b,E)=>this.featuresOnBorder[b].borders[l][0]-this.featuresOnBorder[E].borders[l][0])}encodeCentroid(l,b,E=!0){let S,A;if(l)if(l.y!==0){const z=b.span()._mult(this.tileToMeter);S=(Math.max(l.x,1)<<3)+Math.min(7,Math.round(z.x/10)),A=(Math.max(l.y,1)<<3)+Math.min(7,Math.round(z.y/10))}else S=Math.ceil(7*(l.x+450)),A=0;else S=0,A=+E;let D=E?this.centroidVertexArray.length:b.vertexArrayOffset;for(const z of b.polyCount){E&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*z.edges+z.top);for(let $=0;$<2*z.edges;$++)this.centroidVertexArray.emplace(D++,0,A),this.centroidVertexArray.emplace(D++,S,A);for(let $=0;$<z.top;$++)this.centroidVertexArray.emplace(D++,S,A)}}}function zp(g,l){return g.x===l.x&&(g.x<0||g.x>Mi)||g.y===l.y&&(g.y<0||g.y>Mi)}Ft("FillExtrusionBucket",Gc,{omit:["layers","features"]}),Ft("PartMetadata",pd);var Fp={paint:new Fr({"fill-extrusion-opacity":new Ot(et["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Jt(et["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ot(et["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ot(et["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ir(et["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Jt(et["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Jt(et["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Ot(et["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function xl(g,l){return g.x*l.x+g.y*l.y}function md(g,l){if(g.length===1){let b=0;const E=l[b++];let S;for(;!S||E.equals(S);)if(S=l[b++],!S)return 1/0;for(;b<l.length;b++){const A=l[b],D=g[0],z=S.sub(E),$=A.sub(E),V=D.sub(E),Z=xl(z,z),X=xl(z,$),Y=xl($,$),ie=xl(V,z),ce=xl(V,$),pe=Z*Y-X*X,ve=(Y*ie-X*ce)/pe,Ae=(Z*ce-X*ie)/pe,Be=E.z*(1-ve-Ae)+S.z*ve+A.z*Ae;if(isFinite(Be))return Be}return 1/0}{let b=1/0;for(const E of l)b=Math.min(b,E.z);return b}}function gd(g){const l=new U(g[0],g[1]);return l.z=g[2],l}function Op(g,l,b,E,S,A,D,z){const $=D*S.getElevationAt(g,l,!0,!0),V=A[0]!==0,Z=V?A[1]===0?D*(A[0]/7-450):D*function(X,Y,ie){const ce=Math.floor(Y[0]/8),pe=Math.floor(Y[1]/8),ve=10*(Y[0]-8*ce),Ae=10*(Y[1]-8*pe),Be=X.getElevationAt(ce,pe,!0,!0),$e=X.getMeterToDEM(ie),Ve=Math.floor(.5*(ve*$e-1)),Ge=Math.floor(.5*(Ae*$e-1)),Xe=X.tileCoordToPixel(ce,pe),nt=2*Ve+1,it=2*Ge+1,bt=function(Lt,$t,Pi,er,Li){return[Lt.getElevationAtPixel($t,Pi,!0),Lt.getElevationAtPixel($t+Li,Pi,!0),Lt.getElevationAtPixel($t,Pi+Li,!0),Lt.getElevationAtPixel($t+er,Pi+Li,!0)]}(X,Xe.x-Ve,Xe.y-Ge,nt,it),mt=Math.abs(bt[0]-bt[1]),rt=Math.abs(bt[2]-bt[3]),gt=Math.abs(bt[0]-bt[2])+Math.abs(bt[1]-bt[3]),Et=Math.min(.25,.5*$e*(mt+rt)/nt),lt=Math.min(.25,.5*$e*gt/it);return Be+Math.max(Et*ve,lt*Ae)}(S,A,z):$;return{base:$+(b===0)?-1:b,top:V?Math.max(Z+E,$+b+2):$+E}}const $p=ar([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:Up}=$p,Np=ar([{name:"a_packed",components:3,type:"Float32"}]),{members:Vp}=Np,jp=Ss.VectorTileFeature.types,Gp=Math.cos(Math.PI/180*37.5);class Lh{constructor(l){this.zoom=l.zoom,this.overscaling=l.overscaling,this.layers=l.layers,this.layerIds=this.layers.map(b=>b.id),this.index=l.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(b=>{this.gradients[b.id]={}}),this.layoutVertexArray=new mc,this.layoutVertexArray2=new ma,this.indexArray=new vn,this.programConfigurations=new Es(l.layers,l.zoom),this.segments=new gr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id)}populate(l,b,E,S){this.hasPattern=Vc("line",this.layers,b);const A=this.layers[0].layout.get("line-sort-key"),D=[];for(const{feature:Z,id:X,index:Y,sourceLayerIndex:ie}of l){const ce=this.layers[0]._featureFilter.needGeometry,pe=Ms(Z,ce);if(!this.layers[0]._featureFilter.filter(new ui(this.zoom),pe,E))continue;const ve=A?A.evaluate(pe,{},E):void 0,Ae={id:X,properties:Z.properties,type:Z.type,sourceLayerIndex:ie,index:Y,geometry:ce?pe.geometry:yo(Z,E,S),patterns:{},sortKey:ve};D.push(Ae)}A&&D.sort((Z,X)=>Z.sortKey-X.sortKey);const{lineAtlas:z,featureIndex:$}=b,V=this.addConstantDashes(z);for(const Z of D){const{geometry:X,index:Y,sourceLayerIndex:ie}=Z;if(V&&this.addFeatureDashes(Z,z),this.hasPattern){const ce=jc("line",this.layers,Z,this.zoom,b);this.patternFeatures.push(ce)}else this.addFeature(Z,X,Y,E,z.positions,b.availableImages);$.insert(l[Y].feature,X,Y,ie,this.index)}}addConstantDashes(l){let b=!1;for(const E of this.layers){const S=E.paint.get("line-dasharray").value,A=E.layout.get("line-cap").value;if(S.kind!=="constant"||A.kind!=="constant")b=!0;else{const D=A.value,z=S.value;if(!z)continue;l.addDash(z.from,D),l.addDash(z.to,D),z.other&&l.addDash(z.other,D)}}return b}addFeatureDashes(l,b){const E=this.zoom;for(const S of this.layers){const A=S.paint.get("line-dasharray").value,D=S.layout.get("line-cap").value;if(A.kind==="constant"&&D.kind==="constant")continue;let z,$,V,Z,X,Y;if(A.kind==="constant"){const ve=A.value;if(!ve)continue;z=ve.other||ve.to,$=ve.to,V=ve.from}else z=A.evaluate({zoom:E-1},l),$=A.evaluate({zoom:E},l),V=A.evaluate({zoom:E+1},l);D.kind==="constant"?Z=X=Y=D.value:(Z=D.evaluate({zoom:E-1},l),X=D.evaluate({zoom:E},l),Y=D.evaluate({zoom:E+1},l)),b.addDash(z,Z),b.addDash($,X),b.addDash(V,Y);const ie=b.getKey(z,Z),ce=b.getKey($,X),pe=b.getKey(V,Y);l.patterns[S.id]={min:ie,mid:ce,max:pe}}}update(l,b,E,S){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(l,b,this.stateDependentLayers,E,S)}addFeatures(l,b,E,S){for(const A of this.patternFeatures)this.addFeature(A,A.geometry,A.index,b,E,S)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(l){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=l.createVertexBuffer(this.layoutVertexArray2,Vp)),this.layoutVertexBuffer=l.createVertexBuffer(this.layoutVertexArray,Up),this.indexBuffer=l.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(l),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(l){if(l.properties&&l.properties.hasOwnProperty("mapbox_clip_start")&&l.properties.hasOwnProperty("mapbox_clip_end"))return{start:+l.properties.mapbox_clip_start,end:+l.properties.mapbox_clip_end}}addFeature(l,b,E,S,A,D){const z=this.layers[0].layout,$=z.get("line-join").evaluate(l,{}),V=z.get("line-cap").evaluate(l,{}),Z=z.get("line-miter-limit"),X=z.get("line-round-limit");this.lineClips=this.lineFeatureClips(l);for(const Y of b)this.addLine(Y,l,$,V,Z,X);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,l,E,A,D,S)}addLine(l,b,E,S,A,D){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Ae=0;Ae<l.length-1;Ae++)this.totalDistance+=l[Ae].dist(l[Ae+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const z=jp[b.type]==="Polygon";let $=l.length;for(;$>=2&&l[$-1].equals(l[$-2]);)$--;let V=0;for(;V<$-1&&l[V].equals(l[V+1]);)V++;if($<(z?3:2))return;E==="bevel"&&(A=1.05);const Z=this.overscaling<=16?122880/(512*this.overscaling):0,X=this.segments.prepareSegment(10*$,this.layoutVertexArray,this.indexArray);let Y,ie,ce,pe,ve;this.e1=this.e2=-1,z&&(Y=l[$-2],ve=l[V].sub(Y)._unit()._perp());for(let Ae=V;Ae<$;Ae++){if(ce=Ae===$-1?z?l[V+1]:void 0:l[Ae+1],ce&&l[Ae].equals(ce))continue;ve&&(pe=ve),Y&&(ie=Y),Y=l[Ae],ve=ce?ce.sub(Y)._unit()._perp():pe,pe=pe||ve;let Be=pe.add(ve);Be.x===0&&Be.y===0||Be._unit();const $e=pe.x*ve.x+pe.y*ve.y,Ve=Be.x*ve.x+Be.y*ve.y,Ge=Ve!==0?1/Ve:1/0,Xe=2*Math.sqrt(2-2*Ve),nt=Ve<Gp&&ie&&ce,it=pe.x*ve.y-pe.y*ve.x>0;if(nt&&Ae>V){const rt=Y.dist(ie);if(rt>2*Z){const gt=Y.sub(Y.sub(ie)._mult(Z/rt)._round());this.updateDistance(ie,gt),this.addCurrentVertex(gt,pe,0,0,X),ie=gt}}const bt=ie&&ce;let mt=bt?E:z?"butt":S;if(bt&&mt==="round"&&(Ge<D?mt="miter":Ge<=2&&(mt="fakeround")),mt==="miter"&&Ge>A&&(mt="bevel"),mt==="bevel"&&(Ge>2&&(mt="flipbevel"),Ge<A&&(mt="miter")),ie&&this.updateDistance(ie,Y),mt==="miter")Be._mult(Ge),this.addCurrentVertex(Y,Be,0,0,X);else if(mt==="flipbevel"){if(Ge>100)Be=ve.mult(-1);else{const rt=Ge*pe.add(ve).mag()/pe.sub(ve).mag();Be._perp()._mult(rt*(it?-1:1))}this.addCurrentVertex(Y,Be,0,0,X),this.addCurrentVertex(Y,Be.mult(-1),0,0,X)}else if(mt==="bevel"||mt==="fakeround"){const rt=-Math.sqrt(Ge*Ge-1),gt=it?rt:0,Et=it?0:rt;if(ie&&this.addCurrentVertex(Y,pe,gt,Et,X),mt==="fakeround"){const lt=Math.round(180*Xe/Math.PI/20);for(let Lt=1;Lt<lt;Lt++){let $t=Lt/lt;if($t!==.5){const er=$t-.5;$t+=$t*er*($t-1)*((1.0904+$e*($e*(3.55645-1.43519*$e)-3.2452))*er*er+(.848013+$e*(.215638*$e-1.06021)))}const Pi=ve.sub(pe)._mult($t)._add(pe)._unit()._mult(it?-1:1);this.addHalfVertex(Y,Pi.x,Pi.y,!1,it,0,X)}}ce&&this.addCurrentVertex(Y,ve,-gt,-Et,X)}else if(mt==="butt")this.addCurrentVertex(Y,Be,0,0,X);else if(mt==="square"){const rt=ie?1:-1;ie||this.addCurrentVertex(Y,Be,rt,rt,X),this.addCurrentVertex(Y,Be,0,0,X),ie&&this.addCurrentVertex(Y,Be,rt,rt,X)}else mt==="round"&&(ie&&(this.addCurrentVertex(Y,pe,0,0,X),this.addCurrentVertex(Y,pe,1,1,X,!0)),ce&&(this.addCurrentVertex(Y,ve,-1,-1,X,!0),this.addCurrentVertex(Y,ve,0,0,X)));if(nt&&Ae<$-1){const rt=Y.dist(ce);if(rt>2*Z){const gt=Y.add(ce.sub(Y)._mult(Z/rt)._round());this.updateDistance(Y,gt),this.addCurrentVertex(gt,ve,0,0,X),Y=gt}}}}addCurrentVertex(l,b,E,S,A,D=!1){const z=b.y*S-b.x,$=-b.y-b.x*S;this.addHalfVertex(l,b.x+b.y*E,b.y-b.x*E,D,!1,E,A),this.addHalfVertex(l,z,$,D,!0,-S,A)}addHalfVertex({x:l,y:b},E,S,A,D,z,$){this.layoutVertexArray.emplaceBack((l<<1)+(A?1:0),(b<<1)+(D?1:0),Math.round(63*E)+128,Math.round(63*S)+128,1+(z===0?0:z<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineSoFar);const V=$.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,V),$.primitiveLength++),D?this.e2=V:this.e1=V}updateScaledDistance(){if(this.lineClips){const l=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=l*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(l,b){this.distance+=l.dist(b),this.updateScaledDistance()}}Ft("LineBucket",Lh,{omit:["layers","patternFeatures"]});const qp=new Fr({"line-cap":new Jt(et.layout_line["line-cap"]),"line-join":new Jt(et.layout_line["line-join"]),"line-miter-limit":new Ot(et.layout_line["line-miter-limit"]),"line-round-limit":new Ot(et.layout_line["line-round-limit"]),"line-sort-key":new Jt(et.layout_line["line-sort-key"])});var _d={paint:new Fr({"line-opacity":new Jt(et.paint_line["line-opacity"]),"line-color":new Jt(et.paint_line["line-color"]),"line-translate":new Ot(et.paint_line["line-translate"]),"line-translate-anchor":new Ot(et.paint_line["line-translate-anchor"]),"line-width":new Jt(et.paint_line["line-width"]),"line-gap-width":new Jt(et.paint_line["line-gap-width"]),"line-offset":new Jt(et.paint_line["line-offset"]),"line-blur":new Jt(et.paint_line["line-blur"]),"line-dasharray":new Ir(et.paint_line["line-dasharray"]),"line-pattern":new Ir(et.paint_line["line-pattern"]),"line-gradient":new to(et.paint_line["line-gradient"])}),layout:qp};const yd=new class extends Jt{possiblyEvaluate(g,l){return l=new ui(Math.floor(l.zoom),{now:l.now,fadeDuration:l.fadeDuration,zoomHistory:l.zoomHistory,transition:l.transition}),super.possiblyEvaluate(g,l)}evaluate(g,l,b,E){return l=Wt({},l,{zoom:Math.floor(l.zoom)}),super.evaluate(g,l,b,E)}}(_d.paint.properties["line-width"].specification);function xd(g,l){return l>0?l+2*g:g}yd.useIntegerZoom=!0;const Zp=ar([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"},{name:"a_z_tile_anchor",components:4,type:"Int16"}],4),Xp=ar([{name:"a_projected_pos",components:3,type:"Float32"}],4);ar([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Yp=ar([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),Hp=ar([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);ar([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const vd=ar([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Wp=ar([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ar([{name:"triangle",components:3,type:"Uint16"}]),ar([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ar([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),ar([{type:"Float32",name:"offsetX"}]),ar([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var Ur=24;const ro=128;function qc(g,l){const{expression:b}=l;if(b.kind==="constant")return{kind:"constant",layoutSize:b.evaluate(new ui(g+1))};if(b.kind==="source")return{kind:"source"};{const{zoomStops:E,interpolationType:S}=b;let A=0;for(;A<E.length&&E[A]<=g;)A++;A=Math.max(0,A-1);let D=A;for(;D<E.length&&E[D]<g+1;)D++;D=Math.min(E.length-1,D);const z=E[A],$=E[D];return b.kind==="composite"?{kind:"composite",minZoom:z,maxZoom:$,interpolationType:S}:{kind:"camera",minZoom:z,maxZoom:$,minSize:b.evaluate(new ui(z)),maxSize:b.evaluate(new ui($)),interpolationType:S}}}function zh(g,{uSize:l,uSizeT:b},{lowerSize:E,upperSize:S}){return g.kind==="source"?E/ro:g.kind==="composite"?ji(E/ro,S/ro,b):l}function Ea(g,l){let b=0,E=0;if(g.kind==="constant")E=g.layoutSize;else if(g.kind!=="source"){const{interpolationType:S,minZoom:A,maxZoom:D}=g,z=S?Pt(Xr.interpolationFactor(S,l,A,D),0,1):0;g.kind==="camera"?E=ji(g.minSize,g.maxSize,z):b=z}return{uSizeT:b,uSize:E}}var Kp=Object.freeze({__proto__:null,getSizeData:qc,evaluateSizeForFeature:zh,evaluateSizeForZoom:Ea,SIZE_PACK_FACTOR:ro});function Jp(g,l,b){return g.sections.forEach(E=>{E.text=function(S,A,D){const z=A.layout.get("text-transform").evaluate(D,{});return z==="uppercase"?S=S.toLocaleUpperCase():z==="lowercase"&&(S=S.toLocaleLowerCase()),Bi.applyArabicShaping&&(S=Bi.applyArabicShaping(S)),S}(E.text,l,b)}),g}const vl={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};function Qp(g){return g==="\uFE36"||g==="\uFE48"||g==="\uFE38"||g==="\uFE44"||g==="\uFE42"||g==="\uFE3E"||g==="\uFE3C"||g==="\uFE3A"||g==="\uFE18"||g==="\uFE40"||g==="\uFE10"||g==="\uFE13"||g==="\uFE14"||g==="\uFF40"||g==="\uFFE3"||g==="\uFE11"||g==="\uFE12"}function em(g){return g==="\uFE35"||g==="\uFE47"||g==="\uFE37"||g==="\uFE43"||g==="\uFE41"||g==="\uFE3D"||g==="\uFE3B"||g==="\uFE39"||g==="\uFE17"||g==="\uFE3F"}var bd=function(g,l,b,E,S){var A,D,z=8*S-E-1,$=(1<<z)-1,V=$>>1,Z=-7,X=b?S-1:0,Y=b?-1:1,ie=g[l+X];for(X+=Y,A=ie&(1<<-Z)-1,ie>>=-Z,Z+=z;Z>0;A=256*A+g[l+X],X+=Y,Z-=8);for(D=A&(1<<-Z)-1,A>>=-Z,Z+=E;Z>0;D=256*D+g[l+X],X+=Y,Z-=8);if(A===0)A=1-V;else{if(A===$)return D?NaN:1/0*(ie?-1:1);D+=Math.pow(2,E),A-=V}return(ie?-1:1)*D*Math.pow(2,A-E)},wd=function(g,l,b,E,S,A){var D,z,$,V=8*A-S-1,Z=(1<<V)-1,X=Z>>1,Y=S===23?Math.pow(2,-24)-Math.pow(2,-77):0,ie=E?0:A-1,ce=E?1:-1,pe=l<0||l===0&&1/l<0?1:0;for(l=Math.abs(l),isNaN(l)||l===1/0?(z=isNaN(l)?1:0,D=Z):(D=Math.floor(Math.log(l)/Math.LN2),l*($=Math.pow(2,-D))<1&&(D--,$*=2),(l+=D+X>=1?Y/$:Y*Math.pow(2,1-X))*$>=2&&(D++,$/=2),D+X>=Z?(z=0,D=Z):D+X>=1?(z=(l*$-1)*Math.pow(2,S),D+=X):(z=l*Math.pow(2,X-1)*Math.pow(2,S),D=0));S>=8;g[b+ie]=255&z,ie+=ce,z/=256,S-=8);for(D=D<<S|z,V+=S;V>0;g[b+ie]=255&D,ie+=ce,D/=256,V-=8);g[b+ie-ce]|=128*pe},bl=Qi;function Qi(g){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(g)?g:new Uint8Array(g||0),this.pos=0,this.type=0,this.length=this.buf.length}Qi.Varint=0,Qi.Fixed64=1,Qi.Bytes=2,Qi.Fixed32=5;var Zc=4294967296,Ed=1/Zc,Td=typeof TextDecoder=="undefined"?null:new TextDecoder("utf8");function xo(g){return g.type===Qi.Bytes?g.readVarint()+g.pos:g.pos+1}function Ta(g,l,b){return b?4294967296*l+(g>>>0):4294967296*(l>>>0)+(g>>>0)}function Md(g,l,b){var E=l<=16383?1:l<=2097151?2:l<=268435455?3:Math.floor(Math.log(l)/(7*Math.LN2));b.realloc(E);for(var S=b.pos-1;S>=g;S--)b.buf[S+E]=b.buf[S]}function tm(g,l){for(var b=0;b<g.length;b++)l.writeVarint(g[b])}function im(g,l){for(var b=0;b<g.length;b++)l.writeSVarint(g[b])}function rm(g,l){for(var b=0;b<g.length;b++)l.writeFloat(g[b])}function nm(g,l){for(var b=0;b<g.length;b++)l.writeDouble(g[b])}function om(g,l){for(var b=0;b<g.length;b++)l.writeBoolean(g[b])}function sm(g,l){for(var b=0;b<g.length;b++)l.writeFixed32(g[b])}function am(g,l){for(var b=0;b<g.length;b++)l.writeSFixed32(g[b])}function lm(g,l){for(var b=0;b<g.length;b++)l.writeFixed64(g[b])}function hm(g,l){for(var b=0;b<g.length;b++)l.writeSFixed64(g[b])}function Fh(g,l){return(g[l]|g[l+1]<<8|g[l+2]<<16)+16777216*g[l+3]}function Ma(g,l,b){g[b]=l,g[b+1]=l>>>8,g[b+2]=l>>>16,g[b+3]=l>>>24}function Sd(g,l){return(g[l]|g[l+1]<<8|g[l+2]<<16)+(g[l+3]<<24)}function cm(g,l,b){l.glyphs=[],g===1&&b.readMessage(um,l)}function um(g,l,b){if(g===3){const{id:E,bitmap:S,width:A,height:D,left:z,top:$,advance:V}=b.readMessage(dm,{});l.glyphs.push({id:E,bitmap:new Uo({width:A+6,height:D+6},S),metrics:{width:A,height:D,left:z,top:$,advance:V}})}else g===4?l.ascender=b.readSVarint():g===5&&(l.descender=b.readSVarint())}function dm(g,l,b){g===1?l.id=b.readVarint():g===2?l.bitmap=b.readBytes():g===3?l.width=b.readVarint():g===4?l.height=b.readVarint():g===5?l.left=b.readSVarint():g===6?l.top=b.readSVarint():g===7&&(l.advance=b.readVarint())}function Xc(g){let l=0,b=0;for(const D of g)l+=D.w*D.h,b=Math.max(b,D.w);g.sort((D,z)=>z.h-D.h);const E=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(l/.95)),b),h:1/0}];let S=0,A=0;for(const D of g)for(let z=E.length-1;z>=0;z--){const $=E[z];if(!(D.w>$.w||D.h>$.h)){if(D.x=$.x,D.y=$.y,A=Math.max(A,D.y+D.h),S=Math.max(S,D.x+D.w),D.w===$.w&&D.h===$.h){const V=E.pop();z<E.length&&(E[z]=V)}else D.h===$.h?($.x+=D.w,$.w-=D.w):D.w===$.w?($.y+=D.h,$.h-=D.h):(E.push({x:$.x+D.w,y:$.y,w:$.w-D.w,h:D.h}),$.y+=D.h,$.h-=D.h);break}}return{w:S,h:A,fill:l/(S*A)||0}}Qi.prototype={destroy:function(){this.buf=null},readFields:function(g,l,b){for(b=b||this.length;this.pos<b;){var E=this.readVarint(),S=E>>3,A=this.pos;this.type=7&E,g(S,l,this),this.pos===A&&this.skip(E)}return l},readMessage:function(g,l){return this.readFields(g,l,this.readVarint()+this.pos)},readFixed32:function(){var g=Fh(this.buf,this.pos);return this.pos+=4,g},readSFixed32:function(){var g=Sd(this.buf,this.pos);return this.pos+=4,g},readFixed64:function(){var g=Fh(this.buf,this.pos)+Fh(this.buf,this.pos+4)*Zc;return this.pos+=8,g},readSFixed64:function(){var g=Fh(this.buf,this.pos)+Sd(this.buf,this.pos+4)*Zc;return this.pos+=8,g},readFloat:function(){var g=bd(this.buf,this.pos,!0,23,4);return this.pos+=4,g},readDouble:function(){var g=bd(this.buf,this.pos,!0,52,8);return this.pos+=8,g},readVarint:function(g){var l,b,E=this.buf;return l=127&(b=E[this.pos++]),b<128?l:(l|=(127&(b=E[this.pos++]))<<7,b<128?l:(l|=(127&(b=E[this.pos++]))<<14,b<128?l:(l|=(127&(b=E[this.pos++]))<<21,b<128?l:function(S,A,D){var z,$,V=D.buf;if(z=(112&($=V[D.pos++]))>>4,$<128||(z|=(127&($=V[D.pos++]))<<3,$<128)||(z|=(127&($=V[D.pos++]))<<10,$<128)||(z|=(127&($=V[D.pos++]))<<17,$<128)||(z|=(127&($=V[D.pos++]))<<24,$<128)||(z|=(1&($=V[D.pos++]))<<31,$<128))return Ta(S,z,A);throw new Error("Expected varint not more than 10 bytes")}(l|=(15&(b=E[this.pos]))<<28,g,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var g=this.readVarint();return g%2==1?(g+1)/-2:g/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var g=this.readVarint()+this.pos,l=this.pos;return this.pos=g,g-l>=12&&Td?function(b,E,S){return Td.decode(b.subarray(E,S))}(this.buf,l,g):function(b,E,S){for(var A="",D=E;D<S;){var z,$,V,Z=b[D],X=null,Y=Z>239?4:Z>223?3:Z>191?2:1;if(D+Y>S)break;Y===1?Z<128&&(X=Z):Y===2?(192&(z=b[D+1]))==128&&(X=(31&Z)<<6|63&z)<=127&&(X=null):Y===3?($=b[D+2],(192&(z=b[D+1]))==128&&(192&$)==128&&((X=(15&Z)<<12|(63&z)<<6|63&$)<=2047||X>=55296&&X<=57343)&&(X=null)):Y===4&&($=b[D+2],V=b[D+3],(192&(z=b[D+1]))==128&&(192&$)==128&&(192&V)==128&&((X=(15&Z)<<18|(63&z)<<12|(63&$)<<6|63&V)<=65535||X>=1114112)&&(X=null)),X===null?(X=65533,Y=1):X>65535&&(X-=65536,A+=String.fromCharCode(X>>>10&1023|55296),X=56320|1023&X),A+=String.fromCharCode(X),D+=Y}return A}(this.buf,l,g)},readBytes:function(){var g=this.readVarint()+this.pos,l=this.buf.subarray(this.pos,g);return this.pos=g,l},readPackedVarint:function(g,l){if(this.type!==Qi.Bytes)return g.push(this.readVarint(l));var b=xo(this);for(g=g||[];this.pos<b;)g.push(this.readVarint(l));return g},readPackedSVarint:function(g){if(this.type!==Qi.Bytes)return g.push(this.readSVarint());var l=xo(this);for(g=g||[];this.pos<l;)g.push(this.readSVarint());return g},readPackedBoolean:function(g){if(this.type!==Qi.Bytes)return g.push(this.readBoolean());var l=xo(this);for(g=g||[];this.pos<l;)g.push(this.readBoolean());return g},readPackedFloat:function(g){if(this.type!==Qi.Bytes)return g.push(this.readFloat());var l=xo(this);for(g=g||[];this.pos<l;)g.push(this.readFloat());return g},readPackedDouble:function(g){if(this.type!==Qi.Bytes)return g.push(this.readDouble());var l=xo(this);for(g=g||[];this.pos<l;)g.push(this.readDouble());return g},readPackedFixed32:function(g){if(this.type!==Qi.Bytes)return g.push(this.readFixed32());var l=xo(this);for(g=g||[];this.pos<l;)g.push(this.readFixed32());return g},readPackedSFixed32:function(g){if(this.type!==Qi.Bytes)return g.push(this.readSFixed32());var l=xo(this);for(g=g||[];this.pos<l;)g.push(this.readSFixed32());return g},readPackedFixed64:function(g){if(this.type!==Qi.Bytes)return g.push(this.readFixed64());var l=xo(this);for(g=g||[];this.pos<l;)g.push(this.readFixed64());return g},readPackedSFixed64:function(g){if(this.type!==Qi.Bytes)return g.push(this.readSFixed64());var l=xo(this);for(g=g||[];this.pos<l;)g.push(this.readSFixed64());return g},skip:function(g){var l=7&g;if(l===Qi.Varint)for(;this.buf[this.pos++]>127;);else if(l===Qi.Bytes)this.pos=this.readVarint()+this.pos;else if(l===Qi.Fixed32)this.pos+=4;else{if(l!==Qi.Fixed64)throw new Error("Unimplemented type: "+l);this.pos+=8}},writeTag:function(g,l){this.writeVarint(g<<3|l)},realloc:function(g){for(var l=this.length||16;l<this.pos+g;)l*=2;if(l!==this.length){var b=new Uint8Array(l);b.set(this.buf),this.buf=b,this.length=l}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(g){this.realloc(4),Ma(this.buf,g,this.pos),this.pos+=4},writeSFixed32:function(g){this.realloc(4),Ma(this.buf,g,this.pos),this.pos+=4},writeFixed64:function(g){this.realloc(8),Ma(this.buf,-1&g,this.pos),Ma(this.buf,Math.floor(g*Ed),this.pos+4),this.pos+=8},writeSFixed64:function(g){this.realloc(8),Ma(this.buf,-1&g,this.pos),Ma(this.buf,Math.floor(g*Ed),this.pos+4),this.pos+=8},writeVarint:function(g){(g=+g||0)>268435455||g<0?function(l,b){var E,S;if(l>=0?(E=l%4294967296|0,S=l/4294967296|0):(S=~(-l/4294967296),4294967295^(E=~(-l%4294967296))?E=E+1|0:(E=0,S=S+1|0)),l>=18446744073709552e3||l<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");b.realloc(10),function(A,D,z){z.buf[z.pos++]=127&A|128,A>>>=7,z.buf[z.pos++]=127&A|128,A>>>=7,z.buf[z.pos++]=127&A|128,A>>>=7,z.buf[z.pos++]=127&A|128,z.buf[z.pos]=127&(A>>>=7)}(E,0,b),function(A,D){var z=(7&A)<<4;D.buf[D.pos++]|=z|((A>>>=3)?128:0),A&&(D.buf[D.pos++]=127&A|((A>>>=7)?128:0),A&&(D.buf[D.pos++]=127&A|((A>>>=7)?128:0),A&&(D.buf[D.pos++]=127&A|((A>>>=7)?128:0),A&&(D.buf[D.pos++]=127&A|((A>>>=7)?128:0),A&&(D.buf[D.pos++]=127&A)))))}(S,b)}(g,this):(this.realloc(4),this.buf[this.pos++]=127&g|(g>127?128:0),g<=127||(this.buf[this.pos++]=127&(g>>>=7)|(g>127?128:0),g<=127||(this.buf[this.pos++]=127&(g>>>=7)|(g>127?128:0),g<=127||(this.buf[this.pos++]=g>>>7&127))))},writeSVarint:function(g){this.writeVarint(g<0?2*-g-1:2*g)},writeBoolean:function(g){this.writeVarint(Boolean(g))},writeString:function(g){g=String(g),this.realloc(4*g.length),this.pos++;var l=this.pos;this.pos=function(E,S,A){for(var D,z,$=0;$<S.length;$++){if((D=S.charCodeAt($))>55295&&D<57344){if(!z){D>56319||$+1===S.length?(E[A++]=239,E[A++]=191,E[A++]=189):z=D;continue}if(D<56320){E[A++]=239,E[A++]=191,E[A++]=189,z=D;continue}D=z-55296<<10|D-56320|65536,z=null}else z&&(E[A++]=239,E[A++]=191,E[A++]=189,z=null);D<128?E[A++]=D:(D<2048?E[A++]=D>>6|192:(D<65536?E[A++]=D>>12|224:(E[A++]=D>>18|240,E[A++]=D>>12&63|128),E[A++]=D>>6&63|128),E[A++]=63&D|128)}return A}(this.buf,g,this.pos);var b=this.pos-l;b>=128&&Md(l,b,this),this.pos=l-1,this.writeVarint(b),this.pos+=b},writeFloat:function(g){this.realloc(4),wd(this.buf,g,this.pos,!0,23,4),this.pos+=4},writeDouble:function(g){this.realloc(8),wd(this.buf,g,this.pos,!0,52,8),this.pos+=8},writeBytes:function(g){var l=g.length;this.writeVarint(l),this.realloc(l);for(var b=0;b<l;b++)this.buf[this.pos++]=g[b]},writeRawMessage:function(g,l){this.pos++;var b=this.pos;g(l,this);var E=this.pos-b;E>=128&&Md(b,E,this),this.pos=b-1,this.writeVarint(E),this.pos+=E},writeMessage:function(g,l,b){this.writeTag(g,Qi.Bytes),this.writeRawMessage(l,b)},writePackedVarint:function(g,l){l.length&&this.writeMessage(g,tm,l)},writePackedSVarint:function(g,l){l.length&&this.writeMessage(g,im,l)},writePackedBoolean:function(g,l){l.length&&this.writeMessage(g,om,l)},writePackedFloat:function(g,l){l.length&&this.writeMessage(g,rm,l)},writePackedDouble:function(g,l){l.length&&this.writeMessage(g,nm,l)},writePackedFixed32:function(g,l){l.length&&this.writeMessage(g,sm,l)},writePackedSFixed32:function(g,l){l.length&&this.writeMessage(g,am,l)},writePackedFixed64:function(g,l){l.length&&this.writeMessage(g,lm,l)},writePackedSFixed64:function(g,l){l.length&&this.writeMessage(g,hm,l)},writeBytesField:function(g,l){this.writeTag(g,Qi.Bytes),this.writeBytes(l)},writeFixed32Field:function(g,l){this.writeTag(g,Qi.Fixed32),this.writeFixed32(l)},writeSFixed32Field:function(g,l){this.writeTag(g,Qi.Fixed32),this.writeSFixed32(l)},writeFixed64Field:function(g,l){this.writeTag(g,Qi.Fixed64),this.writeFixed64(l)},writeSFixed64Field:function(g,l){this.writeTag(g,Qi.Fixed64),this.writeSFixed64(l)},writeVarintField:function(g,l){this.writeTag(g,Qi.Varint),this.writeVarint(l)},writeSVarintField:function(g,l){this.writeTag(g,Qi.Varint),this.writeSVarint(l)},writeStringField:function(g,l){this.writeTag(g,Qi.Bytes),this.writeString(l)},writeFloatField:function(g,l){this.writeTag(g,Qi.Fixed32),this.writeFloat(l)},writeDoubleField:function(g,l){this.writeTag(g,Qi.Fixed64),this.writeDouble(l)},writeBooleanField:function(g,l){this.writeVarintField(g,Boolean(l))}};class Yc{constructor(l,{pixelRatio:b,version:E,stretchX:S,stretchY:A,content:D}){this.paddedRect=l,this.pixelRatio=b,this.stretchX=S,this.stretchY=A,this.content=D,this.version=E}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Ad{constructor(l,b){const E={},S={};this.haveRenderCallbacks=[];const A=[];this.addImages(l,E,A),this.addImages(b,S,A);const{w:D,h:z}=Xc(A),$=new bn({width:D||1,height:z||1});for(const V in l){const Z=l[V],X=E[V].paddedRect;bn.copy(Z.data,$,{x:0,y:0},{x:X.x+1,y:X.y+1},Z.data)}for(const V in b){const Z=b[V],X=S[V].paddedRect,Y=X.x+1,ie=X.y+1,ce=Z.data.width,pe=Z.data.height;bn.copy(Z.data,$,{x:0,y:0},{x:Y,y:ie},Z.data),bn.copy(Z.data,$,{x:0,y:pe-1},{x:Y,y:ie-1},{width:ce,height:1}),bn.copy(Z.data,$,{x:0,y:0},{x:Y,y:ie+pe},{width:ce,height:1}),bn.copy(Z.data,$,{x:ce-1,y:0},{x:Y-1,y:ie},{width:1,height:pe}),bn.copy(Z.data,$,{x:0,y:0},{x:Y+ce,y:ie},{width:1,height:pe})}this.image=$,this.iconPositions=E,this.patternPositions=S}addImages(l,b,E){for(const S in l){const A=l[S],D={x:0,y:0,w:A.data.width+2,h:A.data.height+2};E.push(D),b[S]=new Yc(D,A),A.hasRenderCallback&&this.haveRenderCallbacks.push(S)}}patchUpdatedImages(l,b){l.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const E in l.updatedImages)this.patchUpdatedImage(this.iconPositions[E],l.getImage(E),b),this.patchUpdatedImage(this.patternPositions[E],l.getImage(E),b)}patchUpdatedImage(l,b,E){if(!l||!b||l.version===b.version)return;l.version=b.version;const[S,A]=l.tl;E.update(b.data,void 0,{x:S,y:A})}}Ft("ImagePosition",Yc),Ft("ImageAtlas",Ad);const wn={horizontal:1,vertical:2,horizontalOnly:3};class wl{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(l,b){const E=new wl;return E.scale=l||1,E.fontStack=b,E}static forImage(l){const b=new wl;return b.imageName=l,b}}class Sa{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(l,b){const E=new Sa;for(let S=0;S<l.sections.length;S++){const A=l.sections[S];A.image?E.addImageSection(A):E.addTextSection(A,b)}return E}length(){return this.text.length}getSection(l){return this.sections[this.sectionIndex[l]]}getSections(){return this.sections}getSectionIndex(l){return this.sectionIndex[l]}getCharCode(l){return this.text.charCodeAt(l)}verticalizePunctuation(l){this.text=function(b,E){let S="";for(let A=0;A<b.length;A++){const D=b.charCodeAt(A+1)||null,z=b.charCodeAt(A-1)||null;S+=!E&&(D&&Xt(D)&&!vl[b[A+1]]||z&&Xt(z)&&!vl[b[A-1]])||!vl[b[A]]?b[A]:vl[b[A]]}return S}(this.text,l)}trim(){let l=0;for(let E=0;E<this.text.length&&Oh[this.text.charCodeAt(E)];E++)l++;let b=this.text.length;for(let E=this.text.length-1;E>=0&&E>=l&&Oh[this.text.charCodeAt(E)];E--)b--;this.text=this.text.substring(l,b),this.sectionIndex=this.sectionIndex.slice(l,b)}substring(l,b){const E=new Sa;return E.text=this.text.substring(l,b),E.sectionIndex=this.sectionIndex.slice(l,b),E.sections=this.sections,E}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((l,b)=>Math.max(l,this.sections[b].scale),0)}addTextSection(l,b){this.text+=l.text,this.sections.push(wl.forText(l.scale,l.fontStack||b));const E=this.sections.length-1;for(let S=0;S<l.text.length;++S)this.sectionIndex.push(E)}addImageSection(l){const b=l.image?l.image.name:"";if(b.length===0)return void Ai("Can't add FormattedSection with an empty image.");const E=this.getNextImageSectionCharCode();E?(this.text+=String.fromCharCode(E),this.sections.push(wl.forImage(b)),this.sectionIndex.push(this.sections.length-1)):Ai("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Hc(g,l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe){const ve=Sa.fromFeature(g,S);let Ae;X===wn.vertical&&ve.verticalizePunctuation(Y);const{processBidirectionalText:Be,processStyledBidirectionalText:$e}=Bi;if(Be&&ve.sections.length===1){Ae=[];const Xe=Be(ve.toString(),Wc(ve,V,A,l,E,ie,ce));for(const nt of Xe){const it=new Sa;it.text=nt,it.sections=ve.sections;for(let bt=0;bt<nt.length;bt++)it.sectionIndex.push(0);Ae.push(it)}}else if($e){Ae=[];const Xe=$e(ve.text,ve.sectionIndex,Wc(ve,V,A,l,E,ie,ce));for(const nt of Xe){const it=new Sa;it.text=nt[0],it.sectionIndex=nt[1],it.sections=ve.sections,Ae.push(it)}}else Ae=function(Xe,nt){const it=[],bt=Xe.text;let mt=0;for(const rt of nt)it.push(Xe.substring(mt,rt)),mt=rt;return mt<bt.length&&it.push(Xe.substring(mt,bt.length)),it}(ve,Wc(ve,V,A,l,E,ie,ce));const Ve=[],Ge={positionedLines:Ve,text:ve.toString(),top:Z[1],bottom:Z[1],left:Z[0],right:Z[0],writingMode:X,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Xe,nt,it,bt,mt,rt,gt,Et,lt,Lt,$t,Pi){let er=0,Li=0,zi=0;const ft=Et==="right"?1:Et==="left"?0:.5;let Ni=!1;for(const Vi of mt){const Ci=Vi.getSections();for(const nr of Ci){if(nr.imageName)continue;const xr=nt[nr.fontStack];if(xr&&(Ni=xr.ascender!==void 0&&xr.descender!==void 0,!Ni))break}if(!Ni)break}let Oi=0;for(const Vi of mt){Vi.trim();const Ci=Vi.getMaxScale(),nr=(Ci-1)*Ur,xr={positionedGlyphs:[],lineOffset:0};Xe.positionedLines[Oi]=xr;const ur=xr.positionedGlyphs;let wr=0;if(!Vi.length()){Li+=rt,++Oi;continue}let Nr=0,rn=0;for(let rr=0;rr<Vi.length();rr++){const Cr=Vi.getSection(rr),Dn=Vi.getSectionIndex(rr),Or=Vi.getCharCode(rr);let Wi=Cr.scale,Dr=null,or=null,Gr=null,Tr=Ur,qr=0;const Wr=!(lt===wn.horizontal||!$t&&!ot(Or)||$t&&(Oh[Or]||(yr=Or,y(yr)||M(yr)||C(yr)||Fe(yr)||dt(yr))));if(Cr.imageName){const Kr=bt[Cr.imageName];if(!Kr)continue;Gr=Cr.imageName,Xe.iconsInText=Xe.iconsInText||!0,or=Kr.paddedRect;const Pr=Kr.displaySize;Wi=Wi*Ur/Pi,Dr={width:Pr[0],height:Pr[1],left:1,top:-3,advance:Wr?Pr[1]:Pr[0],localGlyph:!1},qr=Ni?-Dr.height*Wi:Ci*Ur-17-Pr[1]*Wi,Tr=Dr.advance;const Vn=(Wr?Pr[0]:Pr[1])*Wi-Ur*Ci;Vn>0&&Vn>wr&&(wr=Vn)}else{const Kr=it[Cr.fontStack];if(!Kr)continue;Kr[Or]&&(or=Kr[Or]);const Pr=nt[Cr.fontStack];if(!Pr)continue;const Vn=Pr.glyphs[Or];if(!Vn)continue;if(Dr=Vn.metrics,Tr=Or!==8203?Ur:0,Ni){const Pa=Pr.ascender!==void 0?Math.abs(Pr.ascender):0,kl=Pr.descender!==void 0?Math.abs(Pr.descender):0,Cl=(Pa+kl)*Wi;Nr<Cl&&(Nr=Cl,rn=(Pa-kl)/2*Wi),qr=-Pa*Wi}else qr=(Ci-Wi)*Ur-17}Wr?(Xe.verticalizable=!0,ur.push({glyph:Or,imageName:Gr,x:er,y:Li+qr,vertical:Wr,scale:Wi,localGlyph:Dr.localGlyph,fontStack:Cr.fontStack,sectionIndex:Dn,metrics:Dr,rect:or}),er+=Tr*Wi+Lt):(ur.push({glyph:Or,imageName:Gr,x:er,y:Li+qr,vertical:Wr,scale:Wi,localGlyph:Dr.localGlyph,fontStack:Cr.fontStack,sectionIndex:Dn,metrics:Dr,rect:or}),er+=Dr.advance*Wi+Lt)}ur.length!==0&&(zi=Math.max(er-Lt,zi),Ni?Pd(ur,ft,wr,rn,rt*Ci/2):Pd(ur,ft,wr,0,rt/2)),er=0;const nn=rt*Ci+wr;xr.lineOffset=Math.max(wr,nr),Li+=nn,++Oi}var yr;const hr=Li,{horizontalAlign:kr,verticalAlign:jr}=Kc(gt);(function(Vi,Ci,nr,xr,ur,wr){const Nr=(Ci-nr)*ur,rn=-wr*xr;for(const nn of Vi)for(const rr of nn.positionedGlyphs)rr.x+=Nr,rr.y+=rn})(Xe.positionedLines,ft,kr,jr,zi,hr),Xe.top+=-jr*hr,Xe.bottom=Xe.top+hr,Xe.left+=-kr*zi,Xe.right=Xe.left+zi,Xe.hasBaseline=Ni}(Ge,l,b,E,Ae,D,z,$,X,V,Y,pe),!function(Xe){for(const nt of Xe)if(nt.positionedGlyphs.length!==0)return!1;return!0}(Ve)&&Ge}const Oh={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},fm={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Id(g,l,b,E,S,A){if(l.imageName){const D=E[l.imageName];return D?D.displaySize[0]*l.scale*Ur/A+S:0}{const D=b[l.fontStack],z=D&&D.glyphs[g];return z?z.metrics.advance*l.scale+S:0}}function kd(g,l,b,E){const S=Math.pow(g-l,2);return E?g<l?S/2:2*S:S+Math.abs(b)*b}function pm(g,l,b){let E=0;return g===10&&(E-=1e4),b&&(E+=150),g!==40&&g!==65288||(E+=50),l!==41&&l!==65289||(E+=50),E}function Cd(g,l,b,E,S,A){let D=null,z=kd(l,b,S,A);for(const $ of E){const V=kd(l-$.x,b,S,A)+$.badness;V<=z&&(D=$,z=V)}return{index:g,x:l,priorBreak:D,badness:z}}function Dd(g){return g?Dd(g.priorBreak).concat(g.index):[]}function Wc(g,l,b,E,S,A,D){if(A!=="point")return[];if(!g)return[];const z=[],$=function(Y,ie,ce,pe,ve,Ae){let Be=0;for(let $e=0;$e<Y.length();$e++){const Ve=Y.getSection($e);Be+=Id(Y.getCharCode($e),Ve,pe,ve,ie,Ae)}return Be/Math.max(1,Math.ceil(Be/ce))}(g,l,b,E,S,D),V=g.text.indexOf("\u200B")>=0;let Z=0;for(let Y=0;Y<g.length();Y++){const ie=g.getSection(Y),ce=g.getCharCode(Y);if(Oh[ce]||(Z+=Id(ce,ie,E,S,l,D)),Y<g.length()-1){const pe=!((X=ce)<11904||!(ne(X)||ee(X)||Ke(X)||ke(X)||Ee(X)||L(X)||fe(X)||q(X)||ze(X)||be(X)||ye(X)||ut(X)||W(X)||N(X)||F(X)||we(X)||J(X)||Ye(X)||Pe(X)||Ce(X)));(fm[ce]||pe||ie.imageName)&&z.push(Cd(Y+1,Z,$,z,pm(ce,g.getCharCode(Y+1),pe&&V),!1))}}var X;return Dd(Cd(g.length(),Z,$,z,0,!0))}function Kc(g){let l=.5,b=.5;switch(g){case"right":case"top-right":case"bottom-right":l=1;break;case"left":case"top-left":case"bottom-left":l=0}switch(g){case"bottom":case"bottom-right":case"bottom-left":b=1;break;case"top":case"top-right":case"top-left":b=0}return{horizontalAlign:l,verticalAlign:b}}function Pd(g,l,b,E,S){if(!(l||b||E||S))return;const A=g.length-1,D=g[A],z=(D.x+D.metrics.advance*D.scale)*l;for(let $=0;$<=A;$++)g[$].x-=z,g[$].y+=b+E+S}function mm(g,l,b){const{horizontalAlign:E,verticalAlign:S}=Kc(b),A=l[0]-g.displaySize[0]*E,D=l[1]-g.displaySize[1]*S;return{image:g,top:D,bottom:D+g.displaySize[1],left:A,right:A+g.displaySize[0]}}function Rd(g,l,b,E,S,A){const D=g.image;let z;if(D.content){const ve=D.content,Ae=D.pixelRatio||1;z=[ve[0]/Ae,ve[1]/Ae,D.displaySize[0]-ve[2]/Ae,D.displaySize[1]-ve[3]/Ae]}const $=l.left*A,V=l.right*A;let Z,X,Y,ie;b==="width"||b==="both"?(ie=S[0]+$-E[3],X=S[0]+V+E[1]):(ie=S[0]+($+V-D.displaySize[0])/2,X=ie+D.displaySize[0]);const ce=l.top*A,pe=l.bottom*A;return b==="height"||b==="both"?(Z=S[1]+ce-E[0],Y=S[1]+pe+E[2]):(Z=S[1]+(ce+pe-D.displaySize[1])/2,Y=Z+D.displaySize[1]),{image:D,top:Z,right:X,bottom:Y,left:ie,collisionPadding:z}}class vo extends U{constructor(l,b,E,S,A){super(l,b),this.angle=S,this.z=E,A!==void 0&&(this.segment=A)}clone(){return new vo(this.x,this.y,this.z,this.angle,this.segment)}}function Bd(g,l,b,E,S){if(l.segment===void 0)return!0;let A=l,D=l.segment+1,z=0;for(;z>-b/2;){if(D--,D<0)return!1;z-=g[D].dist(A),A=g[D]}z+=g[D].dist(g[D+1]),D++;const $=[];let V=0;for(;z<b/2;){const Z=g[D],X=g[D+1];if(!X)return!1;let Y=g[D-1].angleTo(Z)-Z.angleTo(X);for(Y=Math.abs((Y+3*Math.PI)%(2*Math.PI)-Math.PI),$.push({distance:z,angleDelta:Y}),V+=Y;z-$[0].distance>E;)V-=$.shift().angleDelta;if(V>S)return!1;D++,z+=Z.dist(X)}return!0}function Ld(g){let l=0;for(let b=0;b<g.length-1;b++)l+=g[b].dist(g[b+1]);return l}function zd(g,l,b){return g?.6*l*b:0}function Fd(g,l){return Math.max(g?g.right-g.left:0,l?l.right-l.left:0)}function gm(g,l,b,E,S,A){const D=zd(b,S,A),z=Fd(b,E)*A;let $=0;const V=Ld(g)/2;for(let Z=0;Z<g.length-1;Z++){const X=g[Z],Y=g[Z+1],ie=X.dist(Y);if($+ie>V){const ce=(V-$)/ie,pe=ji(X.x,Y.x,ce),ve=ji(X.y,Y.y,ce),Ae=new vo(pe,ve,0,Y.angleTo(X),Z);return!D||Bd(g,Ae,z,D,l)?Ae:void 0}$+=ie}}function _m(g,l,b,E,S,A,D,z,$){const V=zd(E,A,D),Z=Fd(E,S),X=Z*D,Y=g[0].x===0||g[0].x===$||g[0].y===0||g[0].y===$;return l-X<l/4&&(l=X+l/4),Od(g,Y?l/2*z%l:(Z/2+2*A)*D*z%l,l,V,b,X,Y,!1,$)}function Od(g,l,b,E,S,A,D,z,$){const V=A/2,Z=Ld(g);let X=0,Y=l-b,ie=[];for(let ce=0;ce<g.length-1;ce++){const pe=g[ce],ve=g[ce+1],Ae=pe.dist(ve),Be=ve.angleTo(pe);for(;Y+b<X+Ae;){Y+=b;const $e=(Y-X)/Ae,Ve=ji(pe.x,ve.x,$e),Ge=ji(pe.y,ve.y,$e);if(Ve>=0&&Ve<$&&Ge>=0&&Ge<$&&Y-V>=0&&Y+V<=Z){const Xe=new vo(Ve,Ge,0,Be,ce);Xe._round(),E&&!Bd(g,Xe,A,E,S)||ie.push(Xe)}}X+=Ae}return z||ie.length||D||(ie=Od(g,X/2,b,E,S,A,D,!0,$)),ie}function $d(g,l,b,E,S){const A=[];for(let D=0;D<g.length;D++){const z=g[D];let $;for(let V=0;V<z.length-1;V++){let Z=z[V],X=z[V+1];Z.x<l&&X.x<l||(Z.x<l?Z=new U(l,Z.y+(l-Z.x)/(X.x-Z.x)*(X.y-Z.y))._round():X.x<l&&(X=new U(l,Z.y+(l-Z.x)/(X.x-Z.x)*(X.y-Z.y))._round()),Z.y<b&&X.y<b||(Z.y<b?Z=new U(Z.x+(b-Z.y)/(X.y-Z.y)*(X.x-Z.x),b)._round():X.y<b&&(X=new U(Z.x+(b-Z.y)/(X.y-Z.y)*(X.x-Z.x),b)._round()),Z.x>=E&&X.x>=E||(Z.x>=E?Z=new U(E,Z.y+(E-Z.x)/(X.x-Z.x)*(X.y-Z.y))._round():X.x>=E&&(X=new U(E,Z.y+(E-Z.x)/(X.x-Z.x)*(X.y-Z.y))._round()),Z.y>=S&&X.y>=S||(Z.y>=S?Z=new U(Z.x+(S-Z.y)/(X.y-Z.y)*(X.x-Z.x),S)._round():X.y>=S&&(X=new U(Z.x+(S-Z.y)/(X.y-Z.y)*(X.x-Z.x),S)._round()),$&&Z.equals($[$.length-1])||($=[Z],A.push($)),$.push(X)))))}}return A}Ft("Anchor",vo);const El=1e20;function Ud(g,l,b,E,S,A,D,z,$){for(let V=l;V<l+E;V++)Nd(g,b*A+V,A,S,D,z,$);for(let V=b;V<b+S;V++)Nd(g,V*A+l,1,E,D,z,$)}function Nd(g,l,b,E,S,A,D){A[0]=0,D[0]=-El,D[1]=El,S[0]=g[l];for(let z=1,$=0,V=0;z<E;z++){S[z]=g[l+z*b];const Z=z*z;do{const X=A[$];V=(S[z]-S[X]+Z-X*X)/(z-X)/2}while(V<=D[$]&&--$>-1);$++,A[$]=z,D[$]=V,D[$+1]=El}for(let z=0,$=0;z<E;z++){for(;D[$+1]<z;)$++;const V=A[$],Z=z-V;g[l+z*b]=S[V]+Z*Z}}const Jc={none:0,ideographs:1,all:2};class Aa{constructor(l,b,E){this.requestManager=l,this.localGlyphMode=b,this.localFontFamily=E,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(l){this.url=l}getGlyphs(l,b){const E=[];for(const S in l)for(const A of l[S])E.push({stack:S,id:A});vt(E,({stack:S,id:A},D)=>{let z=this.entries[S];z||(z=this.entries[S]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let $=z.glyphs[A];if($!==void 0)return void D(null,{stack:S,id:A,glyph:$});if($=this._tinySDF(z,S,A),$)return z.glyphs[A]=$,void D(null,{stack:S,id:A,glyph:$});const V=Math.floor(A/256);if(256*V>65535)return void D(new Error("glyphs > 65535 not supported"));if(z.ranges[V])return void D(null,{stack:S,id:A,glyph:$});let Z=z.requests[V];Z||(Z=z.requests[V]=[],Aa.loadGlyphRange(S,V,this.url,this.requestManager,(X,Y)=>{if(Y){z.ascender=Y.ascender,z.descender=Y.descender;for(const ie in Y.glyphs)this._doesCharSupportLocalGlyph(+ie)||(z.glyphs[+ie]=Y.glyphs[+ie]);z.ranges[V]=!0}for(const ie of Z)ie(X,Y);delete z.requests[V]})),Z.push((X,Y)=>{X?D(X):Y&&D(null,{stack:S,id:A,glyph:Y.glyphs[A]||null})})},(S,A)=>{if(S)b(S);else if(A){const D={};for(const{stack:z,id:$,glyph:V}of A)D[z]===void 0&&(D[z]={}),D[z].glyphs===void 0&&(D[z].glyphs={}),D[z].glyphs[$]=V&&{id:V.id,bitmap:V.bitmap.clone(),metrics:V.metrics},D[z].ascender=this.entries[z].ascender,D[z].descender=this.entries[z].descender;b(null,D)}})}_doesCharSupportLocalGlyph(l){return this.localGlyphMode!==Jc.none&&(this.localGlyphMode===Jc.all?!!this.localFontFamily:!!this.localFontFamily&&(be(l)||Ie(l)||W(l)||J(l))||q(l))}_tinySDF(l,b,E){const S=this.localFontFamily;if(!S||!this._doesCharSupportLocalGlyph(E))return;let A=l.tinySDF;if(!A){let pe="400";/bold/i.test(b)?pe="900":/medium/i.test(b)?pe="500":/light/i.test(b)&&(pe="200"),A=l.tinySDF=new Aa.TinySDF({fontFamily:S,fontWeight:pe,fontSize:48,buffer:6,radius:16}),A.fontWeight=pe}if(this.localGlyphs[A.fontWeight][E])return this.localGlyphs[A.fontWeight][E];const D=String.fromCharCode(E),{data:z,width:$,height:V,glyphWidth:Z,glyphHeight:X,glyphLeft:Y,glyphTop:ie,glyphAdvance:ce}=A.draw(D);return this.localGlyphs[A.fontWeight][E]={id:E,bitmap:new Uo({width:$,height:V},z),metrics:{width:Z/2,height:X/2,left:Y/2,top:ie/2-27,advance:ce/2,localGlyph:!0}}}}function Vd(g,l,b,E){const S=[],A=g.image,D=A.pixelRatio,z=A.paddedRect.w-2,$=A.paddedRect.h-2,V=g.right-g.left,Z=g.bottom-g.top,X=A.stretchX||[[0,z]],Y=A.stretchY||[[0,$]],ie=(rt,gt)=>rt+gt[1]-gt[0],ce=X.reduce(ie,0),pe=Y.reduce(ie,0),ve=z-ce,Ae=$-pe;let Be=0,$e=ce,Ve=0,Ge=pe,Xe=0,nt=ve,it=0,bt=Ae;if(A.content&&E){const rt=A.content;Be=$h(X,0,rt[0]),Ve=$h(Y,0,rt[1]),$e=$h(X,rt[0],rt[2]),Ge=$h(Y,rt[1],rt[3]),Xe=rt[0]-Be,it=rt[1]-Ve,nt=rt[2]-rt[0]-$e,bt=rt[3]-rt[1]-Ge}const mt=(rt,gt,Et,lt)=>{const Lt=Uh(rt.stretch-Be,$e,V,g.left),$t=Nh(rt.fixed-Xe,nt,rt.stretch,ce),Pi=Uh(gt.stretch-Ve,Ge,Z,g.top),er=Nh(gt.fixed-it,bt,gt.stretch,pe),Li=Uh(Et.stretch-Be,$e,V,g.left),zi=Nh(Et.fixed-Xe,nt,Et.stretch,ce),ft=Uh(lt.stretch-Ve,Ge,Z,g.top),Ni=Nh(lt.fixed-it,bt,lt.stretch,pe),Oi=new U(Lt,Pi),yr=new U(Li,Pi),hr=new U(Li,ft),kr=new U(Lt,ft),jr=new U($t/D,er/D),Vi=new U(zi/D,Ni/D),Ci=l*Math.PI/180;if(Ci){const ur=Math.sin(Ci),wr=Math.cos(Ci),Nr=[wr,-ur,ur,wr];Oi._matMult(Nr),yr._matMult(Nr),kr._matMult(Nr),hr._matMult(Nr)}const nr=rt.stretch+rt.fixed,xr=gt.stretch+gt.fixed;return{tl:Oi,tr:yr,bl:kr,br:hr,tex:{x:A.paddedRect.x+1+nr,y:A.paddedRect.y+1+xr,w:Et.stretch+Et.fixed-nr,h:lt.stretch+lt.fixed-xr},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:jr,pixelOffsetBR:Vi,minFontScaleX:nt/D/V,minFontScaleY:bt/D/Z,isSDF:b}};if(E&&(A.stretchX||A.stretchY)){const rt=jd(X,ve,ce),gt=jd(Y,Ae,pe);for(let Et=0;Et<rt.length-1;Et++){const lt=rt[Et],Lt=rt[Et+1];for(let $t=0;$t<gt.length-1;$t++)S.push(mt(lt,gt[$t],Lt,gt[$t+1]))}}else S.push(mt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:z+1},{fixed:0,stretch:$+1}));return S}function $h(g,l,b){let E=0;for(const S of g)E+=Math.max(l,Math.min(b,S[1]))-Math.max(l,Math.min(b,S[0]));return E}function jd(g,l,b){const E=[{fixed:-1,stretch:0}];for(const[S,A]of g){const D=E[E.length-1];E.push({fixed:S-D.stretch,stretch:D.stretch}),E.push({fixed:S-D.stretch,stretch:D.stretch+(A-S)})}return E.push({fixed:l+1,stretch:b}),E}function Uh(g,l,b,E){return g/l*b+E}function Nh(g,l,b,E){return g-l*b/E}function ym(g,l,b,E){const S=l+g.positionedLines[E].lineOffset;return E===0?b+S/2:b+(S+(l+g.positionedLines[E-1].lineOffset))/2}Aa.loadGlyphRange=function(g,l,b,E,S){const A=256*l,D=A+255,z=E.transformRequest(E.normalizeGlyphsURL(b).replace("{fontstack}",g).replace("{range}",`${A}-${D}`),Rs.Glyphs);Wo(z,($,V)=>{if($)S($);else if(V){const Z={},X=function(Y){return new bl(Y).readFields(cm,{})}(V);for(const Y of X.glyphs)Z[Y.id]=Y;S(null,{glyphs:Z,ascender:X.ascender,descender:X.descender})}})},Aa.TinySDF=class{constructor({fontSize:g=24,buffer:l=3,radius:b=8,cutoff:E=.25,fontFamily:S="sans-serif",fontWeight:A="normal",fontStyle:D="normal"}){this.buffer=l,this.cutoff=E,this.radius=b;const z=this.size=g+4*l,$=this._createCanvas(z),V=this.ctx=$.getContext("2d",{willReadFrequently:!0});V.font=`${D} ${A} ${g}px ${S}`,V.textBaseline="alphabetic",V.textAlign="left",V.fillStyle="black",this.gridOuter=new Float64Array(z*z),this.gridInner=new Float64Array(z*z),this.f=new Float64Array(z),this.z=new Float64Array(z+1),this.v=new Uint16Array(z)}_createCanvas(g){const l=document.createElement("canvas");return l.width=l.height=g,l}draw(g){const{width:l,actualBoundingBoxAscent:b,actualBoundingBoxDescent:E,actualBoundingBoxLeft:S,actualBoundingBoxRight:A}=this.ctx.measureText(g),D=Math.floor(b),z=Math.min(this.size-this.buffer,Math.ceil(A-S)),$=Math.min(this.size-this.buffer,Math.ceil(b)+Math.ceil(E)),V=z+2*this.buffer,Z=$+2*this.buffer,X=V*Z,Y=new Uint8ClampedArray(X),ie={data:Y,width:V,height:Z,glyphWidth:z,glyphHeight:$,glyphTop:D,glyphLeft:0,glyphAdvance:l};if(z===0||$===0)return ie;const{ctx:ce,buffer:pe,gridInner:ve,gridOuter:Ae}=this;ce.clearRect(pe,pe,z,$),ce.fillText(g,pe,pe+D+1);const Be=ce.getImageData(pe,pe,z,$);Ae.fill(El,0,X),ve.fill(0,0,X);for(let $e=0;$e<$;$e++)for(let Ve=0;Ve<z;Ve++){const Ge=Be.data[4*($e*z+Ve)+3]/255;if(Ge===0)continue;const Xe=($e+pe)*V+Ve+pe;if(Ge===1)Ae[Xe]=0,ve[Xe]=El;else{const nt=.5-Ge;Ae[Xe]=nt>0?nt*nt:0,ve[Xe]=nt<0?nt*nt:0}}Ud(Ae,0,0,V,Z,V,this.f,this.v,this.z),Ud(ve,pe,pe,z,$,V,this.f,this.v,this.z);for(let $e=0;$e<X;$e++){const Ve=Math.sqrt(Ae[$e])-Math.sqrt(ve[$e]);Y[$e]=Math.round(255-255*(Ve/this.radius+this.cutoff))}return ie}};class xm{constructor(l=[],b=vm){if(this.data=l,this.length=this.data.length,this.compare=b,this.length>0)for(let E=(this.length>>1)-1;E>=0;E--)this._down(E)}push(l){this.data.push(l),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const l=this.data[0],b=this.data.pop();return this.length--,this.length>0&&(this.data[0]=b,this._down(0)),l}peek(){return this.data[0]}_up(l){const{data:b,compare:E}=this,S=b[l];for(;l>0;){const A=l-1>>1,D=b[A];if(E(S,D)>=0)break;b[l]=D,l=A}b[l]=S}_down(l){const{data:b,compare:E}=this,S=this.length>>1,A=b[l];for(;l<S;){let D=1+(l<<1),z=b[D];const $=D+1;if($<this.length&&E(b[$],z)<0&&(D=$,z=b[$]),E(z,A)>=0)break;b[l]=z,l=D}b[l]=A}}function vm(g,l){return g<l?-1:g>l?1:0}function bm(g,l=1,b=!1){let E=1/0,S=1/0,A=-1/0,D=-1/0;const z=g[0];for(let ie=0;ie<z.length;ie++){const ce=z[ie];(!ie||ce.x<E)&&(E=ce.x),(!ie||ce.y<S)&&(S=ce.y),(!ie||ce.x>A)&&(A=ce.x),(!ie||ce.y>D)&&(D=ce.y)}const $=Math.min(A-E,D-S);let V=$/2;const Z=new xm([],wm);if($===0)return new U(E,S);for(let ie=E;ie<A;ie+=$)for(let ce=S;ce<D;ce+=$)Z.push(new Ia(ie+V,ce+V,V,g));let X=function(ie){let ce=0,pe=0,ve=0;const Ae=ie[0];for(let Be=0,$e=Ae.length,Ve=$e-1;Be<$e;Ve=Be++){const Ge=Ae[Be],Xe=Ae[Ve],nt=Ge.x*Xe.y-Xe.x*Ge.y;pe+=(Ge.x+Xe.x)*nt,ve+=(Ge.y+Xe.y)*nt,ce+=3*nt}return new Ia(pe/ce,ve/ce,0,ie)}(g),Y=Z.length;for(;Z.length;){const ie=Z.pop();(ie.d>X.d||!X.d)&&(X=ie,b&&console.log("found best %d after %d probes",Math.round(1e4*ie.d)/1e4,Y)),ie.max-X.d<=l||(V=ie.h/2,Z.push(new Ia(ie.p.x-V,ie.p.y-V,V,g)),Z.push(new Ia(ie.p.x+V,ie.p.y-V,V,g)),Z.push(new Ia(ie.p.x-V,ie.p.y+V,V,g)),Z.push(new Ia(ie.p.x+V,ie.p.y+V,V,g)),Y+=4)}return b&&(console.log(`num probes: ${Y}`),console.log(`best distance: ${X.d}`)),X.p}function wm(g,l){return l.max-g.max}function Ia(g,l,b,E){this.p=new U(g,l),this.h=b,this.d=function(S,A){let D=!1,z=1/0;for(let $=0;$<A.length;$++){const V=A[$];for(let Z=0,X=V.length,Y=X-1;Z<X;Y=Z++){const ie=V[Z],ce=V[Y];ie.y>S.y!=ce.y>S.y&&S.x<(ce.x-ie.x)*(S.y-ie.y)/(ce.y-ie.y)+ie.x&&(D=!D),z=Math.min(z,Ku(S,ie,ce))}}return(D?1:-1)*Math.sqrt(z)}(this.p,E),this.max=this.d+this.h*Math.SQRT2}const Qc=Number.POSITIVE_INFINITY,Em=Math.sqrt(2);function Gd(g,l){return l[1]!==Qc?function(b,E,S){let A=0,D=0;switch(E=Math.abs(E),S=Math.abs(S),b){case"top-right":case"top-left":case"top":D=S-7;break;case"bottom-right":case"bottom-left":case"bottom":D=7-S}switch(b){case"top-right":case"bottom-right":case"right":A=-E;break;case"top-left":case"bottom-left":case"left":A=E}return[A,D]}(g,l[0],l[1]):function(b,E){let S=0,A=0;E<0&&(E=0);const D=E/Em;switch(b){case"top-right":case"top-left":A=D-7;break;case"bottom-right":case"bottom-left":A=7-D;break;case"bottom":A=7-E;break;case"top":A=E-7}switch(b){case"top-right":case"bottom-right":S=-D;break;case"top-left":case"bottom-left":S=D;break;case"left":S=E;break;case"right":S=-E}return[S,A]}(g,l[0])}function Tm(g,l,b,E,S,A,D,z,$,V){g.createArrays(),g.tilePixelRatio=Mi/(512*g.overscaling),g.compareText={},g.iconsNeedLinear=!1;const Z=g.layers[0].layout,X=g.layers[0]._unevaluatedLayout._values,Y={};if(g.textSizeData.kind==="composite"){const{minZoom:pe,maxZoom:ve}=g.textSizeData;Y.compositeTextSizes=[X["text-size"].possiblyEvaluate(new ui(pe),z),X["text-size"].possiblyEvaluate(new ui(ve),z)]}if(g.iconSizeData.kind==="composite"){const{minZoom:pe,maxZoom:ve}=g.iconSizeData;Y.compositeIconSizes=[X["icon-size"].possiblyEvaluate(new ui(pe),z),X["icon-size"].possiblyEvaluate(new ui(ve),z)]}Y.layoutTextSize=X["text-size"].possiblyEvaluate(new ui($+1),z),Y.layoutIconSize=X["icon-size"].possiblyEvaluate(new ui($+1),z),Y.textMaxSize=X["text-size"].possiblyEvaluate(new ui(18),z);const ie=Z.get("text-rotation-alignment")==="map"&&Z.get("symbol-placement")!=="point",ce=Z.get("text-size");for(const pe of g.features){const ve=Z.get("text-font").evaluate(pe,{},z).join(","),Ae=ce.evaluate(pe,{},z),Be=Y.layoutTextSize.evaluate(pe,{},z),$e=(Y.layoutIconSize.evaluate(pe,{},z),{horizontal:{},vertical:void 0}),Ve=pe.text;let Ge,Xe=[0,0];if(Ve){const bt=Ve.toString(),mt=Z.get("text-letter-spacing").evaluate(pe,{},z)*Ur,rt=Z.get("text-line-height").evaluate(pe,{},z)*Ur,gt=We(bt)?mt:0,Et=Z.get("text-anchor").evaluate(pe,{},z),lt=Z.get("text-variable-anchor");if(!lt){const zi=Z.get("text-radial-offset").evaluate(pe,{},z);Xe=zi?Gd(Et,[zi*Ur,Qc]):Z.get("text-offset").evaluate(pe,{},z).map(ft=>ft*Ur)}let Lt=ie?"center":Z.get("text-justify").evaluate(pe,{},z);const $t=Z.get("symbol-placement"),Pi=$t==="point",er=$t==="point"?Z.get("text-max-width").evaluate(pe,{},z)*Ur:0,Li=zi=>{g.allowVerticalPlacement&&tt(bt)&&($e.vertical=Hc(Ve,l,b,S,ve,er,rt,Et,zi,gt,Xe,wn.vertical,!0,$t,Be,Ae))};if(!ie&&lt){const zi=Lt==="auto"?lt.map(Ni=>eu(Ni)):[Lt];let ft=!1;for(let Ni=0;Ni<zi.length;Ni++){const Oi=zi[Ni];if(!$e.horizontal[Oi])if(ft)$e.horizontal[Oi]=$e.horizontal[0];else{const yr=Hc(Ve,l,b,S,ve,er,rt,"center",Oi,gt,Xe,wn.horizontal,!1,$t,Be,Ae);yr&&($e.horizontal[Oi]=yr,ft=yr.positionedLines.length===1)}}Li("left")}else{if(Lt==="auto"&&(Lt=eu(Et)),Pi||Z.get("text-writing-mode").indexOf("horizontal")>=0||!tt(bt)){const zi=Hc(Ve,l,b,S,ve,er,rt,Et,Lt,gt,Xe,wn.horizontal,!1,$t,Be,Ae);zi&&($e.horizontal[Lt]=zi)}Li($t==="point"?"left":Lt)}}let nt=!1;if(pe.icon&&pe.icon.name){const bt=E[pe.icon.name];bt&&(Ge=mm(S[pe.icon.name],Z.get("icon-offset").evaluate(pe,{},z),Z.get("icon-anchor").evaluate(pe,{},z)),nt=bt.sdf,g.sdfIcons===void 0?g.sdfIcons=bt.sdf:g.sdfIcons!==bt.sdf&&Ai("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(bt.pixelRatio!==g.pixelRatio||Z.get("icon-rotate").constantOr(1)!==0)&&(g.iconsNeedLinear=!0))}const it=Zd($e.horizontal)||$e.vertical;g.iconsInText||(g.iconsInText=!!it&&it.iconsInText),(it||Ge)&&Mm(g,pe,$e,Ge,E,Y,Be,0,Xe,nt,D,z,V)}A&&g.generateCollisionDebugBuffers($,g.collisionBoxArray)}function eu(g){switch(g){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Mm(g,l,b,E,S,A,D,z,$,V,Z,X,Y){let ie=A.textMaxSize.evaluate(l,{},X);ie===void 0&&(ie=D);const ce=g.layers[0].layout,pe=ce.get("icon-offset").evaluate(l,{},X),ve=Zd(b.horizontal)||b.vertical,Ae=D/24,Be=g.tilePixelRatio*ie/24,$e=g.tilePixelRatio*ce.get("symbol-spacing"),Ve=ce.get("text-padding")*g.tilePixelRatio,Ge=ce.get("icon-padding")*g.tilePixelRatio,Xe=pt(ce.get("text-max-angle")),nt=ce.get("text-rotation-alignment")==="map"&&ce.get("symbol-placement")!=="point",it=ce.get("icon-rotation-alignment")==="map"&&ce.get("symbol-placement")!=="point",bt=ce.get("symbol-placement"),mt=$e/2,rt=ce.get("icon-text-fit");let gt;E&&rt!=="none"&&(g.allowVerticalPlacement&&b.vertical&&(gt=Rd(E,b.vertical,rt,ce.get("icon-text-fit-padding"),pe,Ae)),ve&&(E=Rd(E,ve,rt,ce.get("icon-text-fit-padding"),pe,Ae)));const Et=(lt,Lt,$t)=>{if(Lt.x<0||Lt.x>=Mi||Lt.y<0||Lt.y>=Mi)return;const{x:Pi,y:er,z:Li}=Y.projectTilePoint(Lt.x,Lt.y,$t),zi=new vo(Pi,er,Li,0,void 0);(function(ft,Ni,Oi,yr,hr,kr,jr,Vi,Ci,nr,xr,ur,wr,Nr,rn,nn,rr,Cr,Dn,Or,Wi,Dr,or,Gr,Tr){const qr=ft.addToLineVertexArray(Ni,yr);let Wr,Kr,Pr,Vn,Pa,kl,Cl,If=0,kf=0,Cf=0,Df=0,xu=-1,vu=-1;const ao={};let Pf=dl(""),bu=0,wu=0;if(Ci._unevaluatedLayout.getValue("text-radial-offset")===void 0?[bu,wu]=Ci.layout.get("text-offset").evaluate(Wi,{},Tr).map(fn=>fn*Ur):(bu=Ci.layout.get("text-radial-offset").evaluate(Wi,{},Tr)*Ur,wu=Qc),ft.allowVerticalPlacement&&hr.vertical){const fn=hr.vertical;if(rn)kl=tu(fn),Vi&&(Cl=tu(Vi));else{const pn=Ci.layout.get("text-rotate").evaluate(Wi,{},Tr)+90;Pr=Vh(nr,Oi,Ni,xr,ur,wr,fn,Nr,pn,nn),Vi&&(Vn=Vh(nr,Oi,Ni,xr,ur,wr,Vi,Cr,pn))}}if(kr){const fn=Ci.layout.get("icon-rotate").evaluate(Wi,{},Tr),pn=Ci.layout.get("icon-text-fit")!=="none",Dl=Vd(kr,fn,or,pn),Tu=Vi?Vd(Vi,fn,or,pn):void 0;Kr=Vh(nr,Oi,Ni,xr,ur,wr,kr,Cr,fn),If=4*Dl.length;const Rf=ft.iconSizeData;let Cs=null;Rf.kind==="source"?(Cs=[ro*Ci.layout.get("icon-size").evaluate(Wi,{},Tr)],Cs[0]>Vo&&Ai(`${ft.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Rf.kind==="composite"&&(Cs=[ro*Dr.compositeIconSizes[0].evaluate(Wi,{},Tr),ro*Dr.compositeIconSizes[1].evaluate(Wi,{},Tr)],(Cs[0]>Vo||Cs[1]>Vo)&&Ai(`${ft.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),ft.addSymbols(ft.icon,Dl,Cs,Or,Dn,Wi,!1,Oi,Ni,qr.lineStartIndex,qr.lineLength,-1,Gr,Tr),xu=ft.icon.placedSymbolArray.length-1,Tu&&(kf=4*Tu.length,ft.addSymbols(ft.icon,Tu,Cs,Or,Dn,Wi,wn.vertical,Oi,Ni,qr.lineStartIndex,qr.lineLength,-1,Gr,Tr),vu=ft.icon.placedSymbolArray.length-1)}for(const fn in hr.horizontal){const pn=hr.horizontal[fn];Wr||(Pf=dl(pn.text),rn?Pa=tu(pn):Wr=Vh(nr,Oi,Ni,xr,ur,wr,pn,Nr,Ci.layout.get("text-rotate").evaluate(Wi,{},Tr),nn));const Dl=pn.positionedLines.length===1;if(Cf+=qd(ft,Oi,Ni,pn,jr,Ci,rn,Wi,nn,qr,hr.vertical?wn.horizontal:wn.horizontalOnly,Dl?Object.keys(hr.horizontal):[fn],ao,xu,Dr,Gr,Tr),Dl)break}hr.vertical&&(Df+=qd(ft,Oi,Ni,hr.vertical,jr,Ci,rn,Wi,nn,qr,wn.vertical,["vertical"],ao,vu,Dr,Gr,Tr));let Xo=-1;const Eu=(fn,pn)=>fn?Math.max(fn,pn):pn;Xo=Eu(Pa,Xo),Xo=Eu(kl,Xo),Xo=Eu(Cl,Xo);const e0=Xo>-1?1:0;ft.glyphOffsetArray.length>=jo.MAX_GLYPHS&&Ai("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Wi.sortKey!==void 0&&ft.addToSortKeyRanges(ft.symbolInstances.length,Wi.sortKey),ft.symbolInstances.emplaceBack(Oi.x,Oi.y,Oi.z,Ni.x,Ni.y,ao.right>=0?ao.right:-1,ao.center>=0?ao.center:-1,ao.left>=0?ao.left:-1,ao.vertical>=0?ao.vertical:-1,xu,vu,Pf,Wr!==void 0?Wr:ft.collisionBoxArray.length,Wr!==void 0?Wr+1:ft.collisionBoxArray.length,Pr!==void 0?Pr:ft.collisionBoxArray.length,Pr!==void 0?Pr+1:ft.collisionBoxArray.length,Kr!==void 0?Kr:ft.collisionBoxArray.length,Kr!==void 0?Kr+1:ft.collisionBoxArray.length,Vn||ft.collisionBoxArray.length,Vn?Vn+1:ft.collisionBoxArray.length,xr,Cf,Df,If,kf,e0,0,bu,wu,Xo)})(g,Lt,zi,lt,b,E,S,gt,g.layers[0],g.collisionBoxArray,l.index,l.sourceLayerIndex,g.index,Ve,nt,$,0,Ge,it,pe,l,A,V,Z,X)};if(bt==="line")for(const lt of $d(l.geometry,0,0,Mi,Mi)){const Lt=_m(lt,$e,Xe,b.vertical||ve,E,24,Be,g.overscaling,Mi);for(const $t of Lt){const Pi=ve;Pi&&Sm(g,Pi.text,mt,$t)||Et(lt,$t,X)}}else if(bt==="line-center"){for(const lt of l.geometry)if(lt.length>1){const Lt=gm(lt,Xe,b.vertical||ve,E,24,Be);Lt&&Et(lt,Lt,X)}}else if(l.type==="Polygon")for(const lt of Nc(l.geometry,0)){const Lt=bm(lt,16);Et(lt[0],new vo(Lt.x,Lt.y,0,0,void 0),X)}else if(l.type==="LineString")for(const lt of l.geometry)Et(lt,new vo(lt[0].x,lt[0].y,0,0,void 0),X);else if(l.type==="Point")for(const lt of l.geometry)for(const Lt of lt)Et([Lt],new vo(Lt.x,Lt.y,0,0,void 0),X)}const Vo=32640;function qd(g,l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe,ve){const Ae=function(Ve,Ge,Xe,nt,it,bt,mt,rt){const gt=[];if(Ge.positionedLines.length===0)return gt;const Et=nt.layout.get("text-rotate").evaluate(bt,{})*Math.PI/180,lt=function(Li){const zi=Li[0],ft=Li[1],Ni=zi*ft;return Ni>0?[zi,-ft]:Ni<0?[-zi,ft]:zi===0?[ft,zi]:[ft,-zi]}(Xe);let Lt=Math.abs(Ge.top-Ge.bottom);for(const Li of Ge.positionedLines)Lt-=Li.lineOffset;const $t=Ge.positionedLines.length,Pi=Lt/$t;let er=Ge.top-Xe[1];for(let Li=0;Li<$t;++Li){const zi=Ge.positionedLines[Li];er=ym(Ge,Pi,er,Li);for(const ft of zi.positionedGlyphs){if(!ft.rect)continue;const Ni=ft.rect||{};let Oi=4,yr=!0,hr=1,kr=0;if(ft.imageName){const or=mt[ft.imageName];if(!or)continue;if(or.sdf){Ai("SDF images are not supported in formatted text and will be ignored.");continue}yr=!1,hr=or.pixelRatio,Oi=1/hr}const jr=(it||rt)&&ft.vertical,Vi=ft.metrics.advance*ft.scale/2,Ci=ft.metrics,nr=ft.rect;if(nr===null)continue;rt&&Ge.verticalizable&&(kr=ft.imageName?Vi-ft.metrics.width*ft.scale/2:0);const xr=it?[ft.x+Vi,ft.y]:[0,0];let ur=[0,0],wr=[0,0],Nr=!1;it||(jr?(wr=[ft.x+Vi+lt[0],ft.y+lt[1]-kr],Nr=!0):ur=[ft.x+Vi+Xe[0],ft.y+Xe[1]-kr]);const rn=nr.w*ft.scale/(hr*(ft.localGlyph?2:1)),nn=nr.h*ft.scale/(hr*(ft.localGlyph?2:1));let rr,Cr,Dn,Or;if(jr){const or=ft.y-er,Gr=new U(-Vi,Vi-or),Tr=-Math.PI/2,qr=new U(...wr);rr=new U(-Vi+ur[0],ur[1]),rr._rotateAround(Tr,Gr)._add(qr),rr.x+=-or+Vi,rr.y-=(Ci.left-Oi)*ft.scale;const Wr=ft.imageName?Ci.advance*ft.scale:Ur*ft.scale,Kr=String.fromCharCode(ft.glyph);Qp(Kr)?rr.x+=(1-Oi)*ft.scale:em(Kr)?rr.x+=Wr-Ci.height*ft.scale+(-Oi-1)*ft.scale:rr.x+=ft.imageName||Ci.width+2*Oi===nr.w&&Ci.height+2*Oi===nr.h?(Wr-nn)/2:(Wr-(Ci.height+2*Oi)*ft.scale)/2,Cr=new U(rr.x,rr.y-rn),Dn=new U(rr.x+nn,rr.y),Or=new U(rr.x+nn,rr.y-rn)}else{const or=(Ci.left-Oi)*ft.scale-Vi+ur[0],Gr=(-Ci.top-Oi)*ft.scale+ur[1],Tr=or+rn,qr=Gr+nn;rr=new U(or,Gr),Cr=new U(Tr,Gr),Dn=new U(or,qr),Or=new U(Tr,qr)}if(Et){let or;or=it?new U(0,0):Nr?new U(lt[0],lt[1]):new U(Xe[0],Xe[1]),rr._rotateAround(Et,or),Cr._rotateAround(Et,or),Dn._rotateAround(Et,or),Or._rotateAround(Et,or)}const Wi=new U(0,0),Dr=new U(0,0);gt.push({tl:rr,tr:Cr,bl:Dn,br:Or,tex:Ni,writingMode:Ge.writingMode,glyphOffset:xr,sectionIndex:ft.sectionIndex,isSDF:yr,pixelOffsetTL:Wi,pixelOffsetBR:Dr,minFontScaleX:0,minFontScaleY:0})}}return gt}(0,E,$,A,D,z,S,g.allowVerticalPlacement),Be=g.textSizeData;let $e=null;Be.kind==="source"?($e=[ro*A.layout.get("text-size").evaluate(z,{},ve)],$e[0]>Vo&&Ai(`${g.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Be.kind==="composite"&&($e=[ro*ce.compositeTextSizes[0].evaluate(z,{},ve),ro*ce.compositeTextSizes[1].evaluate(z,{},ve)],($e[0]>Vo||$e[1]>Vo)&&Ai(`${g.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),g.addSymbols(g.text,Ae,$e,$,D,z,Z,l,b,V.lineStartIndex,V.lineLength,ie,pe,ve);for(const Ve of X)Y[Ve]=g.text.placedSymbolArray.length-1;return 4*Ae.length}function Zd(g){for(const l in g)return g[l];return null}function Vh(g,l,b,E,S,A,D,z,$,V){let Z=D.top,X=D.bottom,Y=D.left,ie=D.right;const ce=D.collisionPadding;if(ce&&(Y-=ce[0],Z-=ce[1],ie+=ce[2],X+=ce[3]),$){const pe=new U(Y,Z),ve=new U(ie,Z),Ae=new U(Y,X),Be=new U(ie,X),$e=pt($);let Ve=new U(0,0);V&&(Ve=new U(V[0],V[1])),pe._rotateAround($e,Ve),ve._rotateAround($e,Ve),Ae._rotateAround($e,Ve),Be._rotateAround($e,Ve),Y=Math.min(pe.x,ve.x,Ae.x,Be.x),ie=Math.max(pe.x,ve.x,Ae.x,Be.x),Z=Math.min(pe.y,ve.y,Ae.y,Be.y),X=Math.max(pe.y,ve.y,Ae.y,Be.y)}return g.emplaceBack(l.x,l.y,l.z,b.x,b.y,Y,Z,ie,X,z,E,S,A),g.length-1}function tu(g){g.collisionPadding&&(g.top-=g.collisionPadding[1],g.bottom+=g.collisionPadding[3]);const l=g.bottom-g.top;return l>0?Math.max(10,l):null}function Sm(g,l,b,E){const S=g.compareText;if(l in S){const A=S[l];for(let D=A.length-1;D>=0;D--)if(E.dist(A[D])<b)return!0}else S[l]=[];return S[l].push(E),!1}const Am=Ss.VectorTileFeature.types,Im=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function jh(g,l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce,pe){const ve=Z?Math.min(Vo,Math.round(Z[0])):0,Ae=Z?Math.min(Vo,Math.round(Z[1])):0;g.emplaceBack(l,b,Math.round(32*D),Math.round(32*z),$,V,(ve<<1)+(X?1:0),Ae,16*Y,16*ie,256*ce,256*pe,E,S,A,0)}function iu(g,l,b){g.emplaceBack(l.x,l.y,b),g.emplaceBack(l.x,l.y,b),g.emplaceBack(l.x,l.y,b),g.emplaceBack(l.x,l.y,b)}function km(g){for(const l of g.sections)if(_t(l.text))return!0;return!1}class ru{constructor(l){this.layoutVertexArray=new gc,this.indexArray=new vn,this.programConfigurations=l,this.segments=new gr,this.dynamicLayoutVertexArray=new ma,this.opacityVertexArray=new _c,this.placedSymbolArray=new Cu}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(l,b,E,S){this.isEmpty()||(E&&(this.layoutVertexBuffer=l.createVertexBuffer(this.layoutVertexArray,Zp.members),this.indexBuffer=l.createIndexBuffer(this.indexArray,b),this.dynamicLayoutVertexBuffer=l.createVertexBuffer(this.dynamicLayoutVertexArray,Xp.members,!0),this.opacityVertexBuffer=l.createVertexBuffer(this.opacityVertexArray,Im,!0),this.opacityVertexBuffer.itemSize=1),(E||S)&&this.programConfigurations.upload(l))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Ft("SymbolBuffers",ru);class nu{constructor(l,b,E){this.layoutVertexArray=new l,this.layoutAttributes=b,this.indexArray=new E,this.segments=new gr,this.collisionVertexArray=new vc,this.collisionVertexArrayExt=new ma}upload(l){this.layoutVertexBuffer=l.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=l.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=l.createVertexBuffer(this.collisionVertexArray,Yp.members,!0),this.collisionVertexBufferExt=l.createVertexBuffer(this.collisionVertexArrayExt,Hp.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Ft("CollisionBuffers",nu);class jo{constructor(l){this.collisionBoxArray=l.collisionBoxArray,this.zoom=l.zoom,this.overscaling=l.overscaling,this.layers=l.layers,this.layerIds=this.layers.map(D=>D.id),this.index=l.index,this.pixelRatio=l.pixelRatio,this.sourceLayerIndex=l.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Q([]),this.placementViewportMatrix=Q([]);const b=this.layers[0]._unevaluatedLayout._values;this.textSizeData=qc(this.zoom,b["text-size"]),this.iconSizeData=qc(this.zoom,b["icon-size"]);const E=this.layers[0].layout,S=E.get("symbol-sort-key"),A=E.get("symbol-z-order");this.canOverlap=E.get("text-allow-overlap")||E.get("icon-allow-overlap")||E.get("text-ignore-placement")||E.get("icon-ignore-placement"),this.sortFeaturesByKey=A!=="viewport-y"&&S.constantOr(1)!==void 0,this.sortFeaturesByY=(A==="viewport-y"||A==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=E.get("text-writing-mode").map(D=>wn[D]),this.stateDependentLayerIds=this.layers.filter(D=>D.isStateDependent()).map(D=>D.id),this.sourceID=l.sourceID}createArrays(){this.text=new ru(new Es(this.layers,this.zoom,l=>/^text/.test(l))),this.icon=new ru(new Es(this.layers,this.zoom,l=>/^icon/.test(l))),this.glyphOffsetArray=new Ru,this.lineVertexArray=new Bu,this.symbolInstances=new Pu}calculateGlyphDependencies(l,b,E,S,A){for(let D=0;D<l.length;D++)if(b[l.charCodeAt(D)]=!0,S&&A){const z=vl[l.charAt(D)];z&&(b[z.charCodeAt(0)]=!0)}}populate(l,b,E,S){const A=this.layers[0],D=A.layout,z=D.get("text-font"),$=D.get("text-field"),V=D.get("icon-image"),Z=($.value.kind!=="constant"||$.value.value instanceof gi&&!$.value.value.isEmpty()||$.value.value.toString().length>0)&&(z.value.kind!=="constant"||z.value.value.length>0),X=V.value.kind!=="constant"||!!V.value.value||Object.keys(V.parameters).length>0,Y=D.get("symbol-sort-key");if(this.features=[],!Z&&!X)return;const ie=b.iconDependencies,ce=b.glyphDependencies,pe=b.availableImages,ve=new ui(this.zoom);for(const{feature:Ae,id:Be,index:$e,sourceLayerIndex:Ve}of l){const Ge=A._featureFilter.needGeometry,Xe=Ms(Ae,Ge);if(!A._featureFilter.filter(ve,Xe,E))continue;let nt,it;if(Ge||(Xe.geometry=yo(Ae,E,S)),Z){const mt=A.getValueAndResolveTokens("text-field",Xe,E,pe),rt=gi.factory(mt);km(rt)&&(this.hasRTLText=!0),(!this.hasRTLText||cn()==="unavailable"||this.hasRTLText&&Bi.isParsed())&&(nt=Jp(rt,A,Xe))}if(X){const mt=A.getValueAndResolveTokens("icon-image",Xe,E,pe);it=mt instanceof an?mt:an.fromString(mt)}if(!nt&&!it)continue;const bt=this.sortFeaturesByKey?Y.evaluate(Xe,{},E):void 0;if(this.features.push({id:Be,text:nt,icon:it,index:$e,sourceLayerIndex:Ve,geometry:Xe.geometry,properties:Ae.properties,type:Am[Ae.type],sortKey:bt}),it&&(ie[it.name]=!0),nt){const mt=z.evaluate(Xe,{},E).join(","),rt=D.get("text-rotation-alignment")==="map"&&D.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(wn.vertical)>=0;for(const gt of nt.sections)if(gt.image)ie[gt.image.name]=!0;else{const Et=tt(nt.toString()),lt=gt.fontStack||mt,Lt=ce[lt]=ce[lt]||{};this.calculateGlyphDependencies(gt.text,Lt,rt,this.allowVerticalPlacement,Et)}}}D.get("symbol-placement")==="line"&&(this.features=function(Ae){const Be={},$e={},Ve=[];let Ge=0;function Xe(mt){Ve.push(Ae[mt]),Ge++}function nt(mt,rt,gt){const Et=$e[mt];return delete $e[mt],$e[rt]=Et,Ve[Et].geometry[0].pop(),Ve[Et].geometry[0]=Ve[Et].geometry[0].concat(gt[0]),Et}function it(mt,rt,gt){const Et=Be[rt];return delete Be[rt],Be[mt]=Et,Ve[Et].geometry[0].shift(),Ve[Et].geometry[0]=gt[0].concat(Ve[Et].geometry[0]),Et}function bt(mt,rt,gt){const Et=gt?rt[0][rt[0].length-1]:rt[0][0];return`${mt}:${Et.x}:${Et.y}`}for(let mt=0;mt<Ae.length;mt++){const rt=Ae[mt],gt=rt.geometry,Et=rt.text?rt.text.toString():null;if(!Et){Xe(mt);continue}const lt=bt(Et,gt),Lt=bt(Et,gt,!0);if(lt in $e&&Lt in Be&&$e[lt]!==Be[Lt]){const $t=it(lt,Lt,gt),Pi=nt(lt,Lt,Ve[$t].geometry);delete Be[lt],delete $e[Lt],$e[bt(Et,Ve[Pi].geometry,!0)]=Pi,Ve[$t].geometry=null}else lt in $e?nt(lt,Lt,gt):Lt in Be?it(lt,Lt,gt):(Xe(mt),Be[lt]=Ge-1,$e[Lt]=Ge-1)}return Ve.filter(mt=>mt.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Ae,Be)=>Ae.sortKey-Be.sortKey)}update(l,b,E,S){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(l,b,this.layers,E,S),this.icon.programConfigurations.updatePaintArrays(l,b,this.layers,E,S))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(l){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(l),this.iconCollisionBox.upload(l)),this.text.upload(l,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(l,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(l,b){const E=this.lineVertexArray.length;if(l.segment!==void 0){let S=l.dist(b[l.segment+1]),A=l.dist(b[l.segment]);const D={};for(let z=l.segment+1;z<b.length;z++)D[z]={x:b[z].x,y:b[z].y,tileUnitDistanceFromAnchor:S},z<b.length-1&&(S+=b[z+1].dist(b[z]));for(let z=l.segment||0;z>=0;z--)D[z]={x:b[z].x,y:b[z].y,tileUnitDistanceFromAnchor:A},z>0&&(A+=b[z-1].dist(b[z]));for(let z=0;z<b.length;z++){const $=D[z];this.lineVertexArray.emplaceBack($.x,$.y,$.tileUnitDistanceFromAnchor)}}return{lineStartIndex:E,lineLength:this.lineVertexArray.length-E}}addSymbols(l,b,E,S,A,D,z,$,V,Z,X,Y,ie,ce){const pe=l.indexArray,ve=l.layoutVertexArray,Ae=l.segments.prepareSegment(4*b.length,ve,pe,this.canOverlap?D.sortKey:void 0),Be=this.glyphOffsetArray.length,$e=Ae.vertexLength,Ve=this.allowVerticalPlacement&&z===wn.vertical?Math.PI/2:0,Ge=D.text&&D.text.sections;for(let Xe=0;Xe<b.length;Xe++){const{tl:nt,tr:it,bl:bt,br:mt,tex:rt,pixelOffsetTL:gt,pixelOffsetBR:Et,minFontScaleX:lt,minFontScaleY:Lt,glyphOffset:$t,isSDF:Pi,sectionIndex:er}=b[Xe],Li=Ae.vertexLength,zi=$t[1];jh(ve,$.x,$.y,$.z,V.x,V.y,nt.x,zi+nt.y,rt.x,rt.y,E,Pi,gt.x,gt.y,lt,Lt),jh(ve,$.x,$.y,$.z,V.x,V.y,it.x,zi+it.y,rt.x+rt.w,rt.y,E,Pi,Et.x,gt.y,lt,Lt),jh(ve,$.x,$.y,$.z,V.x,V.y,bt.x,zi+bt.y,rt.x,rt.y+rt.h,E,Pi,gt.x,Et.y,lt,Lt),jh(ve,$.x,$.y,$.z,V.x,V.y,mt.x,zi+mt.y,rt.x+rt.w,rt.y+rt.h,E,Pi,Et.x,Et.y,lt,Lt),iu(l.dynamicLayoutVertexArray,$,Ve),pe.emplaceBack(Li,Li+1,Li+2),pe.emplaceBack(Li+1,Li+2,Li+3),Ae.vertexLength+=4,Ae.primitiveLength+=2,this.glyphOffsetArray.emplaceBack($t[0]),Xe!==b.length-1&&er===b[Xe+1].sectionIndex||l.programConfigurations.populatePaintArrays(ve.length,D,D.index,{},ie,ce,Ge&&Ge[er])}l.placedSymbolArray.emplaceBack($.x,$.y,$.z,V.x,V.y,Be,this.glyphOffsetArray.length-Be,$e,Z,X,V.segment,E?E[0]:0,E?E[1]:0,S[0],S[1],z,0,!1,0,Y,0)}_commitLayoutVertex(l,b,E,S,A,D,z){l.emplaceBack(b,E,S,A,D,Math.round(z.x),Math.round(z.y))}_addCollisionDebugVertices(l,b,E,S,A,D,z){const $=E.segments.prepareSegment(4,E.layoutVertexArray,E.indexArray),V=$.vertexLength,Z=z.tileAnchorX,X=z.tileAnchorY;for(let ie=0;ie<4;ie++)E.collisionVertexArray.emplaceBack(0,0,0,0);E.collisionVertexArrayExt.emplaceBack(b,-l.padding,-l.padding),E.collisionVertexArrayExt.emplaceBack(b,l.padding,-l.padding),E.collisionVertexArrayExt.emplaceBack(b,l.padding,l.padding),E.collisionVertexArrayExt.emplaceBack(b,-l.padding,l.padding),this._commitLayoutVertex(E.layoutVertexArray,S,A,D,Z,X,new U(l.x1,l.y1)),this._commitLayoutVertex(E.layoutVertexArray,S,A,D,Z,X,new U(l.x2,l.y1)),this._commitLayoutVertex(E.layoutVertexArray,S,A,D,Z,X,new U(l.x2,l.y2)),this._commitLayoutVertex(E.layoutVertexArray,S,A,D,Z,X,new U(l.x1,l.y2)),$.vertexLength+=4;const Y=E.indexArray;Y.emplaceBack(V,V+1),Y.emplaceBack(V+1,V+2),Y.emplaceBack(V+2,V+3),Y.emplaceBack(V+3,V),$.primitiveLength+=4}_addTextDebugCollisionBoxes(l,b,E,S,A,D){for(let z=S;z<A;z++){const $=E.get(z),V=this.getSymbolInstanceTextSize(l,D,b,z);this._addCollisionDebugVertices($,V,this.textCollisionBox,$.projectedAnchorX,$.projectedAnchorY,$.projectedAnchorZ,D)}}_addIconDebugCollisionBoxes(l,b,E,S,A,D){for(let z=S;z<A;z++){const $=E.get(z),V=this.getSymbolInstanceIconSize(l,b,z);this._addCollisionDebugVertices($,V,this.iconCollisionBox,$.projectedAnchorX,$.projectedAnchorY,$.projectedAnchorZ,D)}}generateCollisionDebugBuffers(l,b){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new nu(yh,vd.members,Oo),this.iconCollisionBox=new nu(yh,vd.members,Oo);const E=Ea(this.iconSizeData,l),S=Ea(this.textSizeData,l);for(let A=0;A<this.symbolInstances.length;A++){const D=this.symbolInstances.get(A);this._addTextDebugCollisionBoxes(S,l,b,D.textBoxStartIndex,D.textBoxEndIndex,D),this._addTextDebugCollisionBoxes(S,l,b,D.verticalTextBoxStartIndex,D.verticalTextBoxEndIndex,D),this._addIconDebugCollisionBoxes(E,l,b,D.iconBoxStartIndex,D.iconBoxEndIndex,D),this._addIconDebugCollisionBoxes(E,l,b,D.verticalIconBoxStartIndex,D.verticalIconBoxEndIndex,D)}}getSymbolInstanceTextSize(l,b,E,S){const A=this.text.placedSymbolArray.get(b.rightJustifiedTextSymbolIndex>=0?b.rightJustifiedTextSymbolIndex:b.centerJustifiedTextSymbolIndex>=0?b.centerJustifiedTextSymbolIndex:b.leftJustifiedTextSymbolIndex>=0?b.leftJustifiedTextSymbolIndex:b.verticalPlacedTextSymbolIndex>=0?b.verticalPlacedTextSymbolIndex:S),D=zh(this.textSizeData,l,A)/Ur;return this.tilePixelRatio*D}getSymbolInstanceIconSize(l,b,E){const S=this.icon.placedSymbolArray.get(E),A=zh(this.iconSizeData,l,S);return this.tilePixelRatio*A}_commitDebugCollisionVertexUpdate(l,b,E){l.emplaceBack(b,-E,-E),l.emplaceBack(b,E,-E),l.emplaceBack(b,E,E),l.emplaceBack(b,-E,E)}_updateTextDebugCollisionBoxes(l,b,E,S,A,D){for(let z=S;z<A;z++){const $=E.get(z),V=this.getSymbolInstanceTextSize(l,D,b,z);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,V,$.padding)}}_updateIconDebugCollisionBoxes(l,b,E,S,A){for(let D=S;D<A;D++){const z=E.get(D),$=this.getSymbolInstanceIconSize(l,b,D);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,$,z.padding)}}updateCollisionDebugBuffers(l,b){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const E=Ea(this.iconSizeData,l),S=Ea(this.textSizeData,l);for(let A=0;A<this.symbolInstances.length;A++){const D=this.symbolInstances.get(A);this._updateTextDebugCollisionBoxes(S,l,b,D.textBoxStartIndex,D.textBoxEndIndex,D),this._updateTextDebugCollisionBoxes(S,l,b,D.verticalTextBoxStartIndex,D.verticalTextBoxEndIndex,D),this._updateIconDebugCollisionBoxes(E,l,b,D.iconBoxStartIndex,D.iconBoxEndIndex),this._updateIconDebugCollisionBoxes(E,l,b,D.verticalIconBoxStartIndex,D.verticalIconBoxEndIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(l,b,E,S,A,D,z,$,V){const Z={};for(let X=b;X<E;X++){const Y=l.get(X);Z.textBox={x1:Y.x1,y1:Y.y1,x2:Y.x2,y2:Y.y2,padding:Y.padding,projectedAnchorX:Y.projectedAnchorX,projectedAnchorY:Y.projectedAnchorY,projectedAnchorZ:Y.projectedAnchorZ,tileAnchorX:Y.tileAnchorX,tileAnchorY:Y.tileAnchorY},Z.textFeatureIndex=Y.featureIndex;break}for(let X=S;X<A;X++){const Y=l.get(X);Z.verticalTextBox={x1:Y.x1,y1:Y.y1,x2:Y.x2,y2:Y.y2,padding:Y.padding,projectedAnchorX:Y.projectedAnchorX,projectedAnchorY:Y.projectedAnchorY,projectedAnchorZ:Y.projectedAnchorZ,tileAnchorX:Y.tileAnchorX,tileAnchorY:Y.tileAnchorY},Z.verticalTextFeatureIndex=Y.featureIndex;break}for(let X=D;X<z;X++){const Y=l.get(X);Z.iconBox={x1:Y.x1,y1:Y.y1,x2:Y.x2,y2:Y.y2,padding:Y.padding,projectedAnchorX:Y.projectedAnchorX,projectedAnchorY:Y.projectedAnchorY,projectedAnchorZ:Y.projectedAnchorZ,tileAnchorX:Y.tileAnchorX,tileAnchorY:Y.tileAnchorY},Z.iconFeatureIndex=Y.featureIndex;break}for(let X=$;X<V;X++){const Y=l.get(X);Z.verticalIconBox={x1:Y.x1,y1:Y.y1,x2:Y.x2,y2:Y.y2,padding:Y.padding,projectedAnchorX:Y.projectedAnchorX,projectedAnchorY:Y.projectedAnchorY,projectedAnchorZ:Y.projectedAnchorZ,tileAnchorX:Y.tileAnchorX,tileAnchorY:Y.tileAnchorY},Z.verticalIconFeatureIndex=Y.featureIndex;break}return Z}deserializeCollisionBoxes(l){this.collisionArrays=[];for(let b=0;b<this.symbolInstances.length;b++){const E=this.symbolInstances.get(b);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(l,E.textBoxStartIndex,E.textBoxEndIndex,E.verticalTextBoxStartIndex,E.verticalTextBoxEndIndex,E.iconBoxStartIndex,E.iconBoxEndIndex,E.verticalIconBoxStartIndex,E.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(l,b){const E=l.placedSymbolArray.get(b),S=E.vertexStartIndex+4*E.numGlyphs;for(let A=E.vertexStartIndex;A<S;A+=4)l.indexArray.emplaceBack(A,A+1,A+2),l.indexArray.emplaceBack(A+1,A+2,A+3)}getSortedSymbolIndexes(l){if(this.sortedAngle===l&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const b=Math.sin(l),E=Math.cos(l),S=[],A=[],D=[];for(let z=0;z<this.symbolInstances.length;++z){D.push(z);const $=this.symbolInstances.get(z);S.push(0|Math.round(b*$.tileAnchorX+E*$.tileAnchorY)),A.push($.featureIndex)}return D.sort((z,$)=>S[z]-S[$]||A[$]-A[z]),D}addToSortKeyRanges(l,b){const E=this.sortKeyRanges[this.sortKeyRanges.length-1];E&&E.sortKey===b?E.symbolInstanceEnd=l+1:this.sortKeyRanges.push({sortKey:b,symbolInstanceStart:l,symbolInstanceEnd:l+1})}sortFeatures(l){if(this.sortFeaturesByY&&this.sortedAngle!==l&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(l),this.sortedAngle=l,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const b of this.symbolInstanceIndexes){const E=this.symbolInstances.get(b);this.featureSortOrder.push(E.featureIndex),[E.rightJustifiedTextSymbolIndex,E.centerJustifiedTextSymbolIndex,E.leftJustifiedTextSymbolIndex].forEach((S,A,D)=>{S>=0&&D.indexOf(S)===A&&this.addIndicesForPlacedSymbol(this.text,S)}),E.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,E.verticalPlacedTextSymbolIndex),E.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,E.placedIconSymbolIndex),E.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,E.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Ft("SymbolBucket",jo,{omit:["layers","collisionBoxArray","features","compareText"]}),jo.MAX_GLYPHS=65535,jo.addDynamicAttributes=iu;const Cm=new Fr({"symbol-placement":new Ot(et.layout_symbol["symbol-placement"]),"symbol-spacing":new Ot(et.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ot(et.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Jt(et.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ot(et.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Ot(et.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ot(et.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ot(et.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ot(et.layout_symbol["icon-rotation-alignment"]),"icon-size":new Jt(et.layout_symbol["icon-size"]),"icon-text-fit":new Ot(et.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ot(et.layout_symbol["icon-text-fit-padding"]),"icon-image":new Jt(et.layout_symbol["icon-image"]),"icon-rotate":new Jt(et.layout_symbol["icon-rotate"]),"icon-padding":new Ot(et.layout_symbol["icon-padding"]),"icon-keep-upright":new Ot(et.layout_symbol["icon-keep-upright"]),"icon-offset":new Jt(et.layout_symbol["icon-offset"]),"icon-anchor":new Jt(et.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ot(et.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ot(et.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ot(et.layout_symbol["text-rotation-alignment"]),"text-field":new Jt(et.layout_symbol["text-field"]),"text-font":new Jt(et.layout_symbol["text-font"]),"text-size":new Jt(et.layout_symbol["text-size"]),"text-max-width":new Jt(et.layout_symbol["text-max-width"]),"text-line-height":new Jt(et.layout_symbol["text-line-height"]),"text-letter-spacing":new Jt(et.layout_symbol["text-letter-spacing"]),"text-justify":new Jt(et.layout_symbol["text-justify"]),"text-radial-offset":new Jt(et.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ot(et.layout_symbol["text-variable-anchor"]),"text-anchor":new Jt(et.layout_symbol["text-anchor"]),"text-max-angle":new Ot(et.layout_symbol["text-max-angle"]),"text-writing-mode":new Ot(et.layout_symbol["text-writing-mode"]),"text-rotate":new Jt(et.layout_symbol["text-rotate"]),"text-padding":new Ot(et.layout_symbol["text-padding"]),"text-keep-upright":new Ot(et.layout_symbol["text-keep-upright"]),"text-transform":new Jt(et.layout_symbol["text-transform"]),"text-offset":new Jt(et.layout_symbol["text-offset"]),"text-allow-overlap":new Ot(et.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ot(et.layout_symbol["text-ignore-placement"]),"text-optional":new Ot(et.layout_symbol["text-optional"])});var ou={paint:new Fr({"icon-opacity":new Jt(et.paint_symbol["icon-opacity"]),"icon-color":new Jt(et.paint_symbol["icon-color"]),"icon-halo-color":new Jt(et.paint_symbol["icon-halo-color"]),"icon-halo-width":new Jt(et.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Jt(et.paint_symbol["icon-halo-blur"]),"icon-translate":new Ot(et.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ot(et.paint_symbol["icon-translate-anchor"]),"text-opacity":new Jt(et.paint_symbol["text-opacity"]),"text-color":new Jt(et.paint_symbol["text-color"],{runtimeType:Sn,getOverride:g=>g.textColor,hasOverride:g=>!!g.textColor}),"text-halo-color":new Jt(et.paint_symbol["text-halo-color"]),"text-halo-width":new Jt(et.paint_symbol["text-halo-width"]),"text-halo-blur":new Jt(et.paint_symbol["text-halo-blur"]),"text-translate":new Ot(et.paint_symbol["text-translate"]),"text-translate-anchor":new Ot(et.paint_symbol["text-translate-anchor"])}),layout:Cm};class Xd{constructor(l){this.type=l.property.overrides?l.property.overrides.runtimeType:Xn,this.defaultValue=l}evaluate(l){if(l.formattedSection){const b=this.defaultValue.property.overrides;if(b&&b.hasOverride(l.formattedSection))return b.getOverride(l.formattedSection)}return l.feature&&l.featureState?this.defaultValue.evaluate(l.feature,l.featureState):this.defaultValue.property.specification.default}eachChild(l){this.defaultValue.isConstant()||l(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ft("FormatSectionOverride",Xd,{omit:["defaultValue"]});class Gh extends On{constructor(l){super(l,ou)}recalculate(l,b){super.recalculate(l,b),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const E=this.layout.get("text-writing-mode");if(E){const S=[];for(const A of E)S.indexOf(A)<0&&S.push(A);this.layout._values["text-writing-mode"]=S}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(l,b,E,S){const A=this.layout.get(l).evaluate(b,{},E,S),D=this._unevaluatedLayout._values[l];return D.isDataDriven()||ko(D.value)||!A?A:function(z,$){return $.replace(/{([^{}]+)}/g,(V,Z)=>Z in z?String(z[Z]):"")}(b.properties,A)}createBucket(l){return new jo(l)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const l of ou.paint.overridableProperties){if(!Gh.hasPaintOverride(this.layout,l))continue;const b=this.paint.get(l),E=new Xd(b),S=new Wa(E,b.property.specification);let A=null;A=b.value.kind==="constant"||b.value.kind==="source"?new ms("source",S):new Ka("composite",S,b.value.zoomStops,b.value._interpolationType),this.paint._values[l]=new Hr(b.property,A,b.parameters)}}_handleOverridablePaintPropertyUpdate(l,b,E){return!(!this.layout||b.isDataDriven()||E.isDataDriven())&&Gh.hasPaintOverride(this.layout,l)}static hasPaintOverride(l,b){const E=l.get("text-field"),S=ou.paint.properties[b];let A=!1;const D=z=>{for(const $ of z)if(S.overrides&&S.overrides.hasOverride($))return void(A=!0)};if(E.value.kind==="constant"&&E.value.value instanceof gi)D(E.value.value.sections);else if(E.value.kind==="source"){const z=V=>{A||(V instanceof Hn&&pr(V.value)===Yn?D(V.value.sections):V instanceof An?D(V.sections):V.eachChild(z))},$=E.value;$._styleExpression&&z($._styleExpression.expression)}return A}getProgramConfiguration(l){return new go(this,l)}}var Dm={paint:new Fr({"background-color":new Ot(et.paint_background["background-color"]),"background-pattern":new fo(et.paint_background["background-pattern"]),"background-opacity":new Ot(et.paint_background["background-opacity"])})},Pm={paint:new Fr({"raster-opacity":new Ot(et.paint_raster["raster-opacity"]),"raster-hue-rotate":new Ot(et.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ot(et.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ot(et.paint_raster["raster-brightness-max"]),"raster-saturation":new Ot(et.paint_raster["raster-saturation"]),"raster-contrast":new Ot(et.paint_raster["raster-contrast"]),"raster-resampling":new Ot(et.paint_raster["raster-resampling"]),"raster-fade-duration":new Ot(et.paint_raster["raster-fade-duration"])})};class Rm extends On{constructor(l){super(l,{}),this.implementation=l}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){}serialize(){}onAdd(l){this.implementation.onAdd&&this.implementation.onAdd(l,l.painter.context.gl)}onRemove(l){this.implementation.onRemove&&this.implementation.onRemove(l,l.painter.context.gl)}}var Bm={paint:new Fr({"sky-type":new Ot(et.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ot(et.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ot(et.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ot(et.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ot(et.paint_sky["sky-gradient-radius"]),"sky-gradient":new to(et.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ot(et.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ot(et.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ot(et.paint_sky["sky-opacity"])})};function su(g,l,b){const E=ge(0,0,1),S=ni(pi());return function(A,D,z){z*=.5;var $=D[0],V=D[1],Z=D[2],X=D[3],Y=Math.sin(z),ie=Math.cos(z);A[0]=$*ie-Z*Y,A[1]=V*ie+X*Y,A[2]=Z*ie+$*Y,A[3]=X*ie-V*Y}(S,S,b?-pt(g)+Math.PI:pt(g)),_i(S,S,-pt(l)),ii(E,E,S),At(E,E)}const Lm={circle:class extends On{constructor(g){super(g,np)}createBucket(g){return new Dc(g)}queryRadius(g){const l=g;return va("circle-radius",this,l)+va("circle-stroke-width",this,l)+Ih(this.paint.get("circle-translate"))}queryIntersectsFeature(g,l,b,E,S,A,D,z){const $=td(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),A.angle,g.pixelToTileUnitsFactor),V=this.paint.get("circle-radius").evaluate(l,b)+this.paint.get("circle-stroke-width").evaluate(l,b);return id(g,E,A,D,z,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",$,V)}getProgramIds(){return["circle"]}getProgramConfiguration(g){return new go(this,g)}},heatmap:class extends On{createBucket(g){return new nd(g)}constructor(g){super(g,lp),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(g){g==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Fc({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(g){return va("heatmap-radius",this,g)}queryIntersectsFeature(g,l,b,E,S,A,D,z){const $=this.paint.get("heatmap-radius").evaluate(l,b);return id(g,E,A,D,z,!0,!0,new U(0,0),$)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(g){return new go(this,g)}},hillshade:class extends On{constructor(g){super(g,hp)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getProgramConfiguration(g){return new go(this,g)}},fill:class extends On{constructor(g){super(g,Sp)}getProgramIds(){const g=this.paint.get("fill-pattern"),l=g&&g.constantOr(1),b=[l?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&b.push(l&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),b}getProgramConfiguration(g){return new go(this,g)}recalculate(g,l){super.recalculate(g,l);const b=this.paint._values["fill-outline-color"];b.value.kind==="constant"&&b.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(g){return new Bh(g)}queryRadius(){return Ih(this.paint.get("fill-translate"))}queryIntersectsFeature(g,l,b,E,S,A){return!g.queryGeometry.isAboveHorizon&&Wu(ed(g.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),A.angle,g.pixelToTileUnitsFactor),E)}isTileClipped(){return!0}},"fill-extrusion":class extends On{constructor(g){super(g,Fp)}createBucket(g){return new Gc(g)}queryRadius(){return Ih(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(g){return new go(this,g)}queryIntersectsFeature(g,l,b,E,S,A,D,z,$){const V=td(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),A.angle,g.pixelToTileUnitsFactor),Z=this.paint.get("fill-extrusion-height").evaluate(l,b),X=this.paint.get("fill-extrusion-base").evaluate(l,b),Y=[0,0],ie=z&&A.elevation,ce=A.elevation?A.elevation.exaggeration():1;if(ie){const Ae=g.tile.getBucket(this).centroidVertexArray,Be=$+1;if(Be<Ae.length){const $e=Ae.get(Be);Y[0]=$e.a_centroid_pos0,Y[1]=$e.a_centroid_pos1}}if(Y[0]===0&&Y[1]===1)return!1;const pe=function(Ae,Be,$e,Ve,Ge,Xe,nt,it,bt){return Xe?function(mt,rt,gt,Et,lt,Lt,$t,Pi,er){const Li=[],zi=[],ft=[0,0,0,1];for(const Ni of mt){const Oi=[],yr=[];for(const hr of Ni){const kr=hr.x+Et.x,jr=hr.y+Et.y,Vi=Op(kr,jr,rt,gt,Lt,$t,Pi,er);ft[0]=kr,ft[1]=jr,ft[2]=Vi.base,ft[3]=1,Vt(ft,ft,lt),ft[3]=Math.max(ft[3],1e-5);const Ci=gd([ft[0]/ft[3],ft[1]/ft[3],ft[2]/ft[3]]);ft[0]=kr,ft[1]=jr,ft[2]=Vi.top,ft[3]=1,Vt(ft,ft,lt),ft[3]=Math.max(ft[3],1e-5);const nr=gd([ft[0]/ft[3],ft[1]/ft[3],ft[2]/ft[3]]);Oi.push(Ci),yr.push(nr)}Li.push(Oi),zi.push(yr)}return[Li,zi]}(Ae,Be,$e,Ve,Ge,Xe,nt,it,bt):function(mt,rt,gt,Et,lt){const Lt=[],$t=[],Pi=lt[8]*rt,er=lt[9]*rt,Li=lt[10]*rt,zi=lt[11]*rt,ft=lt[8]*gt,Ni=lt[9]*gt,Oi=lt[10]*gt,yr=lt[11]*gt;for(const hr of mt){const kr=[],jr=[];for(const Vi of hr){const Ci=Vi.x+Et.x,nr=Vi.y+Et.y,xr=lt[0]*Ci+lt[4]*nr+lt[12],ur=lt[1]*Ci+lt[5]*nr+lt[13],wr=lt[2]*Ci+lt[6]*nr+lt[14],Nr=lt[3]*Ci+lt[7]*nr+lt[15],rn=xr+Pi,nn=ur+er,rr=wr+Li,Cr=Math.max(Nr+zi,1e-5),Dn=xr+ft,Or=ur+Ni,Wi=wr+Oi,Dr=Math.max(Nr+yr,1e-5),or=new U(rn/Cr,nn/Cr);or.z=rr/Cr,kr.push(or);const Gr=new U(Dn/Dr,Or/Dr);Gr.z=Wi/Dr,jr.push(Gr)}Lt.push(kr),$t.push(jr)}return[Lt,$t]}(Ae,Be,$e,Ve,Ge)}(E,X,Z,V,D,ie?z:null,Y,ce,A.center.lat),ve=g.queryGeometry;return function(Ae,Be,$e){let Ve=1/0;Wu($e,Be)&&(Ve=md($e,Be[0]));for(let Ge=0;Ge<Be.length;Ge++){const Xe=Be[Ge],nt=Ae[Ge];for(let it=0;it<Xe.length-1;it++){const bt=Xe[it],mt=[bt,Xe[it+1],nt[it+1],nt[it],bt];Hu($e,mt)&&(Ve=Math.min(Ve,md($e,mt)))}}return Ve!==1/0&&Ve}(pe[0],pe[1],ve.isPointQuery()?ve.screenBounds:ve.screenGeometry)}},line:class extends On{constructor(g){super(g,_d),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(g){if(g==="line-gradient"){const l=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=l._styleExpression&&l._styleExpression.expression instanceof ss,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(g,l){super.recalculate(g,l),this.paint._values["line-floorwidth"]=yd.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,g)}createBucket(g){return new Lh(g)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(g){return new go(this,g)}queryRadius(g){const l=g,b=xd(va("line-width",this,l),va("line-gap-width",this,l)),E=va("line-offset",this,l);return b/2+Math.abs(E)+Ih(this.paint.get("line-translate"))}queryIntersectsFeature(g,l,b,E,S,A){if(g.queryGeometry.isAboveHorizon)return!1;const D=ed(g.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),A.angle,g.pixelToTileUnitsFactor),z=g.pixelToTileUnitsFactor/2*xd(this.paint.get("line-width").evaluate(l,b),this.paint.get("line-gap-width").evaluate(l,b)),$=this.paint.get("line-offset").evaluate(l,b);return $&&(E=function(V,Z){const X=[],Y=new U(0,0);for(let ie=0;ie<V.length;ie++){const ce=V[ie],pe=[];for(let ve=0;ve<ce.length;ve++){const Ae=ce[ve-1],Be=ce[ve],$e=ce[ve+1],Ve=ve===0?Y:Be.sub(Ae)._unit()._perp(),Ge=ve===ce.length-1?Y:$e.sub(Be)._unit()._perp(),Xe=Ve._add(Ge)._unit();Xe._mult(1/(Xe.x*Ge.x+Xe.y*Ge.y)),pe.push(Xe._mult(Z)._add(Be))}X.push(pe)}return X}(E,$*g.pixelToTileUnitsFactor)),function(V,Z,X){for(let Y=0;Y<Z.length;Y++){const ie=Z[Y];if(V.length>=3){for(let ce=0;ce<ie.length;ce++)if(xa(V,ie[ce]))return!0}if(ep(V,ie,X))return!0}return!1}(D,E,z)}isTileClipped(){return!0}},symbol:Gh,background:class extends On{constructor(g){super(g,Dm)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends On{constructor(g){super(g,Pm)}getProgramIds(){return["raster"]}},sky:class extends On{constructor(g){super(g,Bm),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(g){g==="sky-gradient"?this._updateColorRamp():g!=="sky-atmosphere-sun"&&g!=="sky-atmosphere-halo-color"&&g!=="sky-atmosphere-color"&&g!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Fc({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(g){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const l=g.style.light.properties.get("position");return this._lightPosition.azimuthal!==l.azimuthal||this._lightPosition.polar!==l.polar}}getCenter(g,l){const b=this.paint.get("sky-type");if(b==="atmosphere"){const E=this.paint.get("sky-atmosphere-sun"),S=!E,A=g.style.light,D=A.properties.get("position");return S&&A.properties.get("anchor")==="viewport"&&Ai("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),S?su(D.azimuthal,90-D.polar,l):su(E[0],90-E[1],l)}if(b==="gradient"){const E=this.paint.get("sky-gradient-center");return su(E[0],90-E[1],l)}}is3D(){return!1}isSky(){return!0}markSkyboxValid(g){this._skyboxInvalidated=!1,this._lightPosition=g.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const g=this.paint.get("sky-type");return g==="atmosphere"?["skyboxCapture","skybox"]:g==="gradient"?["skyboxGradient"]:null}}},{HTMLImageElement:Yd,HTMLCanvasElement:Hd,HTMLVideoElement:Wd,ImageData:Kd,ImageBitmap:qh}=j;class Zh{constructor(l,b,E,S){this.context=l,this.format=E,this.texture=l.gl.createTexture(),this.update(b,S)}update(l,b,E){const{width:S,height:A}=l,{context:D}=this,{gl:z}=D;if(z.bindTexture(z.TEXTURE_2D,this.texture),D.pixelStoreUnpackFlipY.set(!1),D.pixelStoreUnpack.set(1),D.pixelStoreUnpackPremultiplyAlpha.set(this.format===z.RGBA&&(!b||b.premultiply!==!1)),E||this.size&&this.size[0]===S&&this.size[1]===A){const{x:$,y:V}=E||{x:0,y:0};l instanceof Yd||l instanceof Hd||l instanceof Wd||l instanceof Kd||qh&&l instanceof qh?z.texSubImage2D(z.TEXTURE_2D,0,$,V,z.RGBA,z.UNSIGNED_BYTE,l):z.texSubImage2D(z.TEXTURE_2D,0,$,V,S,A,z.RGBA,z.UNSIGNED_BYTE,l.data)}else this.size=[S,A],l instanceof Yd||l instanceof Hd||l instanceof Wd||l instanceof Kd||qh&&l instanceof qh?z.texImage2D(z.TEXTURE_2D,0,this.format,this.format,z.UNSIGNED_BYTE,l):z.texImage2D(z.TEXTURE_2D,0,this.format,S,A,0,this.format,z.UNSIGNED_BYTE,l.data);this.useMipmap=Boolean(b&&b.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&z.generateMipmap(z.TEXTURE_2D)}bind(l,b){const{context:E}=this,{gl:S}=E;S.bindTexture(S.TEXTURE_2D,this.texture),l!==this.filter&&(S.texParameteri(S.TEXTURE_2D,S.TEXTURE_MAG_FILTER,l),S.texParameteri(S.TEXTURE_2D,S.TEXTURE_MIN_FILTER,this.useMipmap?l===S.NEAREST?S.NEAREST_MIPMAP_NEAREST:S.LINEAR_MIPMAP_NEAREST:l),this.filter=l),b!==this.wrap&&(S.texParameteri(S.TEXTURE_2D,S.TEXTURE_WRAP_S,b),S.texParameteri(S.TEXTURE_2D,S.TEXTURE_WRAP_T,b),this.wrap=b)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:l}=this.context;l.deleteTexture(this.texture),this.texture=null}}class au{constructor(l,b){this.width=l,this.height=b,this.nextRow=0,this.image=new Uo({width:l,height:b}),this.positions={},this.uploaded=!1}getDash(l,b){const E=this.getKey(l,b);return this.positions[E]}trim(){const l=this.width,b=this.height=hi(this.nextRow);this.image.resize({width:l,height:b})}getKey(l,b){return l.join(",")+b}getDashRanges(l,b,E){const S=[];let A=l.length%2==1?-l[l.length-1]*E:0,D=l[0]*E,z=!0;S.push({left:A,right:D,isDash:z,zeroLength:l[0]===0});let $=l[0];for(let V=1;V<l.length;V++){z=!z;const Z=l[V];A=$*E,$+=Z,D=$*E,S.push({left:A,right:D,isDash:z,zeroLength:Z===0})}return S}addRoundDash(l,b,E){const S=b/2;for(let A=-E;A<=E;A++){const D=this.width*(this.nextRow+E+A);let z=0,$=l[z];for(let V=0;V<this.width;V++){V/$.right>1&&($=l[++z]);const Z=Math.abs(V-$.left),X=Math.abs(V-$.right),Y=Math.min(Z,X);let ie;const ce=A/E*(S+1);if($.isDash){const pe=S-Math.abs(ce);ie=Math.sqrt(Y*Y+pe*pe)}else ie=S-Math.sqrt(Y*Y+ce*ce);this.image.data[D+V]=Math.max(0,Math.min(255,ie+128))}}}addRegularDash(l,b){for(let $=l.length-1;$>=0;--$){const V=l[$],Z=l[$+1];V.zeroLength?l.splice($,1):Z&&Z.isDash===V.isDash&&(Z.left=V.left,l.splice($,1))}const E=l[0],S=l[l.length-1];E.isDash===S.isDash&&(E.left=S.left-this.width,S.right=E.right+this.width);const A=this.width*this.nextRow;let D=0,z=l[D];for(let $=0;$<this.width;$++){$/z.right>1&&(z=l[++D]);const V=Math.abs($-z.left),Z=Math.abs($-z.right),X=Math.min(V,Z);this.image.data[A+$]=Math.max(0,Math.min(255,(z.isDash?X:-X)+b+128))}}addDash(l,b){const E=this.getKey(l,b);if(this.positions[E])return this.positions[E];const S=b==="round",A=S?7:0,D=2*A+1;if(this.nextRow+D>this.height)return Ai("LineAtlas out of space"),null;l.length===0&&l.push(1);let z=0;for(let Z=0;Z<l.length;Z++)l[Z]<0&&(Ai("Negative value is found in line dasharray, replacing values with 0"),l[Z]=0),z+=l[Z];if(z!==0){const Z=this.width/z,X=this.getDashRanges(l,this.width,Z);S?this.addRoundDash(X,Z,A):this.addRegularDash(X,b==="square"?.5*Z:0)}const $=this.nextRow+A;this.nextRow+=D;const V={tl:[$,A],br:[z,0]};return this.positions[E]=V,V}}Ft("LineAtlas",au);class zm{constructor(l){this._callback=l,this._triggered=!1,typeof MessageChannel!="undefined"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){delete this._channel,this._callback=()=>{}}}const Fm=j.performance;function Jd(g){const l=g?g.url.toString():void 0;return Fm.getEntriesByName(l)}class Om{constructor(){this.tasks={},this.taskQueue=[],Ei(["process"],this),this.invoker=new zm(this.process),this.nextId=0}add(l,b){const E=this.nextId++,S=function({type:A,isSymbolTile:D,zoom:z}){return z=z||0,A==="message"?0:A!=="maybePrepare"||D?A!=="parseTile"||D?A==="parseTile"&&D?300-z:A==="maybePrepare"&&D?400-z:500:200-z:100-z}(b);if(S===0){fr();try{l()}finally{}return{cancel:()=>{}}}return this.tasks[E]={fn:l,metadata:b,priority:S,id:E},this.taskQueue.push(E),this.invoker.trigger(),{cancel:()=>{delete this.tasks[E]}}}process(){fr();try{if(this.taskQueue=this.taskQueue.filter(E=>!!this.tasks[E]),!this.taskQueue.length)return;const l=this.pick();if(l===null)return;const b=this.tasks[l];if(delete this.tasks[l],this.taskQueue.length&&this.invoker.trigger(),!b)return;b.fn()}finally{}}pick(){let l=null,b=1/0;for(let S=0;S<this.taskQueue.length;S++){const A=this.tasks[this.taskQueue[S]];A.priority<b&&(b=A.priority,l=S)}if(l===null)return null;const E=this.taskQueue[l];return this.taskQueue.splice(l,1),E}remove(){this.invoker.remove()}}function Qd(g,l,b){var E=2*Math.PI*6378137/256/Math.pow(2,b);return[g*E-2*Math.PI*6378137/2,l*E-2*Math.PI*6378137/2]}class Xh{constructor(l,b,E){this.z=l,this.x=b,this.y=E,this.key=Tl(0,l,l,b,E)}equals(l){return this.z===l.z&&this.x===l.x&&this.y===l.y}url(l,b){const E=function(A,D,z){var $=Qd(256*A,256*(D=Math.pow(2,z)-D-1),z),V=Qd(256*(A+1),256*(D+1),z);return $[0]+","+$[1]+","+V[0]+","+V[1]}(this.x,this.y,this.z),S=function(A,D,z){let $,V="";for(let Z=A;Z>0;Z--)$=1<<Z-1,V+=(D&$?1:0)+(z&$?2:0);return V}(this.z,this.x,this.y);return l[(this.x+this.y)%l.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace("{z}",String(this.z)).replace("{x}",String(this.x)).replace("{y}",String(b==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",S).replace("{bbox-epsg-3857}",E)}toString(){return`${this.z}/${this.x}/${this.y}`}}class lu{constructor(l,b){this.wrap=l,this.canonical=b,this.key=Tl(l,b.z,b.z,b.x,b.y)}}class tn{constructor(l,b,E,S,A){this.overscaledZ=l,this.wrap=b,this.canonical=new Xh(E,+S,+A),this.key=b===0&&l===E?this.canonical.key:Tl(b,l,E,S,A)}equals(l){return this.overscaledZ===l.overscaledZ&&this.wrap===l.wrap&&this.canonical.equals(l.canonical)}scaledTo(l){const b=this.canonical.z-l;return l>this.canonical.z?new tn(l,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new tn(l,this.wrap,l,this.canonical.x>>b,this.canonical.y>>b)}calculateScaledKey(l,b=!0){if(this.overscaledZ===l&&b)return this.key;if(l>this.canonical.z)return Tl(this.wrap*+b,l,this.canonical.z,this.canonical.x,this.canonical.y);{const E=this.canonical.z-l;return Tl(this.wrap*+b,l,l,this.canonical.x>>E,this.canonical.y>>E)}}isChildOf(l){if(l.wrap!==this.wrap)return!1;const b=this.canonical.z-l.canonical.z;return l.overscaledZ===0||l.overscaledZ<this.overscaledZ&&l.canonical.x===this.canonical.x>>b&&l.canonical.y===this.canonical.y>>b}children(l){if(this.overscaledZ>=l)return[new tn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const b=this.canonical.z+1,E=2*this.canonical.x,S=2*this.canonical.y;return[new tn(b,this.wrap,b,E,S),new tn(b,this.wrap,b,E+1,S),new tn(b,this.wrap,b,E,S+1),new tn(b,this.wrap,b,E+1,S+1)]}isLessThan(l){return this.wrap<l.wrap||!(this.wrap>l.wrap)&&(this.overscaledZ<l.overscaledZ||!(this.overscaledZ>l.overscaledZ)&&(this.canonical.x<l.canonical.x||!(this.canonical.x>l.canonical.x)&&this.canonical.y<l.canonical.y))}wrapped(){return new tn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(l){return new tn(this.overscaledZ,l,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new lu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Tl(g,l,b,E,S){const A=1<<Math.min(b,22);let D=A*(S%A)+E%A;return g&&b<22&&(D+=A*A*((g<0?-2*g-1:2*g)%(1<<2*(22-b)))),16*(32*D+b)+(l-b)}Ft("CanonicalTileID",Xh),Ft("OverscaledTileID",tn,{omit:["projMatrix"]});class ka{constructor(l,b,E){this.func=l,this.mask=b,this.range=E}}ka.ReadOnly=!1,ka.ReadWrite=!0,ka.disabled=new ka(519,ka.ReadOnly,[0,1]);const hu=7680;class cu{constructor(l,b,E,S,A,D){this.test=l,this.ref=b,this.mask=E,this.fail=S,this.depthFail=A,this.pass=D}}cu.disabled=new cu({func:519,mask:0},0,0,hu,hu,hu);class no{constructor(l,b,E){this.blendFunction=l,this.blendColor=b,this.mask=E}}no.Replace=[1,0],no.disabled=new no(no.Replace,Fi.transparent,[!1,!1,!1,!1]),no.unblended=new no(no.Replace,Fi.transparent,[!0,!0,!0,!0]),no.alphaBlended=new no([1,771],Fi.transparent,[!0,!0,!0,!0]);const uu=1029,du=2305;class Nn{constructor(l,b,E){this.enable=l,this.mode=b,this.frontFace=E}}Nn.disabled=new Nn(!1,uu,du),Nn.backCCW=new Nn(!0,uu,du),Nn.backCW=new Nn(!0,uu,2304),Nn.frontCW=new Nn(!0,1028,2304),Nn.frontCCW=new Nn(!0,1028,du);class ef{constructor(l){this._stringToNumber={},this._numberToString=[];for(let b=0;b<l.length;b++){const E=l[b];this._stringToNumber[E]=b,this._numberToString[b]=E}}encode(l){return this._stringToNumber[l]}decode(l){return this._numberToString[l]}}class tf{constructor(l,b,E,S,A){this.type="Feature",this._vectorTileFeature=l,l._z=b,l._x=E,l._y=S,this.properties=l.properties,this.id=A}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(l){this._geometry=l}toJSON(){const l={geometry:this.geometry};for(const b in this)b!=="_geometry"&&b!=="_vectorTileFeature"&&(l[b]=this[b]);return l}}class $m{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(l,b,E){const S=String(b);if(this.stateChanges[l]=this.stateChanges[l]||{},this.stateChanges[l][S]=this.stateChanges[l][S]||{},Wt(this.stateChanges[l][S],E),this.deletedStates[l]===null){this.deletedStates[l]={};for(const A in this.state[l])A!==S&&(this.deletedStates[l][A]=null)}else if(this.deletedStates[l]&&this.deletedStates[l][S]===null){this.deletedStates[l][S]={};for(const A in this.state[l][S])E[A]||(this.deletedStates[l][S][A]=null)}else for(const A in E)this.deletedStates[l]&&this.deletedStates[l][S]&&this.deletedStates[l][S][A]===null&&delete this.deletedStates[l][S][A]}removeFeatureState(l,b,E){if(this.deletedStates[l]===null)return;const S=String(b);if(this.deletedStates[l]=this.deletedStates[l]||{},E&&b!==void 0)this.deletedStates[l][S]!==null&&(this.deletedStates[l][S]=this.deletedStates[l][S]||{},this.deletedStates[l][S][E]=null);else if(b!==void 0)if(this.stateChanges[l]&&this.stateChanges[l][S])for(E in this.deletedStates[l][S]={},this.stateChanges[l][S])this.deletedStates[l][S][E]=null;else this.deletedStates[l][S]=null;else this.deletedStates[l]=null}getState(l,b){const E=String(b),S=Wt({},(this.state[l]||{})[E],(this.stateChanges[l]||{})[E]);if(this.deletedStates[l]===null)return{};if(this.deletedStates[l]){const A=this.deletedStates[l][b];if(A===null)return{};for(const D in A)delete S[D]}return S}initializeTileState(l,b){l.setFeatureState(this.state,b)}coalesceChanges(l,b){const E={};for(const S in this.stateChanges){this.state[S]=this.state[S]||{};const A={};for(const D in this.stateChanges[S])this.state[S][D]||(this.state[S][D]={}),Wt(this.state[S][D],this.stateChanges[S][D]),A[D]=this.state[S][D];E[S]=A}for(const S in this.deletedStates){this.state[S]=this.state[S]||{};const A={};if(this.deletedStates[S]===null)for(const D in this.state[S])A[D]={},this.state[S][D]={};else for(const D in this.deletedStates[S]){if(this.deletedStates[S][D]===null)this.state[S][D]={};else for(const z of Object.keys(this.deletedStates[S][D]))delete this.state[S][D][z];A[D]=this.state[S][D]}E[S]=E[S]||{},Wt(E[S],A)}if(this.stateChanges={},this.deletedStates={},Object.keys(E).length!==0)for(const S in l)l[S].setFeatureState(E,b)}}class rf{constructor(l){this.size=l,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(l,b){const E=this.toIdx(l,b);return{min:this.minimums[E],max:this.maximums[E]}}isLeaf(l,b){return this.leaves[this.toIdx(l,b)]}toIdx(l,b){return b*this.size+l}}function nf(g,l,b,E){let S=0,A=Number.MAX_VALUE;for(let D=0;D<3;D++)if(Math.abs(E[D])<1e-15){if(b[D]<g[D]||b[D]>l[D])return null}else{const z=1/E[D];let $=(g[D]-b[D])*z,V=(l[D]-b[D])*z;if($>V){const Z=$;$=V,V=Z}if($>S&&(S=$),V<A&&(A=V),S>A)return null}return S}function of(g,l,b,E,S,A,D,z,$,V,Z){const X=E-g,Y=S-l,ie=A-b,ce=D-g,pe=z-l,ve=$-b,Ae=Z[1]*ve-Z[2]*pe,Be=Z[2]*ce-Z[0]*ve,$e=Z[0]*pe-Z[1]*ce,Ve=X*Ae+Y*Be+ie*$e;if(Math.abs(Ve)<1e-15)return null;const Ge=1/Ve,Xe=V[0]-g,nt=V[1]-l,it=V[2]-b,bt=(Xe*Ae+nt*Be+it*$e)*Ge;if(bt<0||bt>1)return null;const mt=nt*ie-it*Y,rt=it*X-Xe*ie,gt=Xe*Y-nt*X,Et=(Z[0]*mt+Z[1]*rt+Z[2]*gt)*Ge;return Et<0||bt+Et>1?null:(ce*mt+pe*rt+ve*gt)*Ge}function sf(g,l,b){return(g-l)/(b-l)}function af(g,l,b,E,S,A,D,z,$){const V=1<<b,Z=A-E,X=D-S,Y=(g+1)/V*Z+E,ie=(l+0)/V*X+S,ce=(l+1)/V*X+S;z[0]=(g+0)/V*Z+E,z[1]=ie,$[0]=Y,$[1]=ce}class lf{constructor(l){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=l,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const b=function(A){const D=Math.ceil(Math.log2(A.dim/8)),z=[];let $=Math.ceil(Math.pow(2,D));const V=1/$,Z=(ie,ce,pe,ve,Ae)=>{const Be=ve?1:0,$e=(ie+1)*pe-Be,Ve=ce*pe,Ge=(ce+1)*pe-Be;Ae[0]=ie*pe,Ae[1]=Ve,Ae[2]=$e,Ae[3]=Ge};let X=new rf($);const Y=[];for(let ie=0;ie<$*$;ie++){Z(ie%$,Math.floor(ie/$),V,!1,Y);const ce=Go(Y[0],Y[1],A),pe=Go(Y[2],Y[1],A),ve=Go(Y[2],Y[3],A),Ae=Go(Y[0],Y[3],A);X.minimums.push(Math.min(ce,pe,ve,Ae)),X.maximums.push(Math.max(ce,pe,ve,Ae)),X.leaves.push(1)}for(z.push(X),$/=2;$>=1;$/=2){const ie=z[z.length-1];X=new rf($);for(let ce=0;ce<$*$;ce++){Z(ce%$,Math.floor(ce/$),2,!0,Y);const pe=ie.getElevation(Y[0],Y[1]),ve=ie.getElevation(Y[2],Y[1]),Ae=ie.getElevation(Y[2],Y[3]),Be=ie.getElevation(Y[0],Y[3]),$e=ie.isLeaf(Y[0],Y[1]),Ve=ie.isLeaf(Y[2],Y[1]),Ge=ie.isLeaf(Y[2],Y[3]),Xe=ie.isLeaf(Y[0],Y[3]),nt=Math.min(pe.min,ve.min,Ae.min,Be.min),it=Math.max(pe.max,ve.max,Ae.max,Be.max),bt=$e&&Ve&&Ge&&Xe;X.maximums.push(it),X.minimums.push(nt),X.leaves.push(it-nt<=5&&bt?1:0)}z.push(X)}return z}(this.dem),E=b.length-1,S=b[E];this._addNode(S.minimums[0],S.maximums[0],S.leaves[0]),this._construct(b,0,0,E,0)}raycastRoot(l,b,E,S,A,D,z=1){return nf([l,b,-100],[E,S,this.maximums[0]*z],A,D)}raycast(l,b,E,S,A,D,z=1){if(!this.nodeCount)return null;const $=this.raycastRoot(l,b,E,S,A,D,z);if($==null)return null;const V=[],Z=[],X=[],Y=[],ie=[{idx:0,t:$,nodex:0,nodey:0,depth:0}];for(;ie.length>0;){const{idx:ce,t:pe,nodex:ve,nodey:Ae,depth:Be}=ie.pop();if(this.leaves[ce]){af(ve,Ae,Be,l,b,E,S,X,Y);const Ve=1<<Be,Ge=(ve+0)/Ve,Xe=(ve+1)/Ve,nt=(Ae+0)/Ve,it=(Ae+1)/Ve,bt=Go(Ge,nt,this.dem)*z,mt=Go(Xe,nt,this.dem)*z,rt=Go(Xe,it,this.dem)*z,gt=Go(Ge,it,this.dem)*z,Et=of(X[0],X[1],bt,Y[0],X[1],mt,Y[0],Y[1],rt,A,D),lt=of(Y[0],Y[1],rt,X[0],Y[1],gt,X[0],X[1],bt,A,D),Lt=Math.min(Et!==null?Et:Number.MAX_VALUE,lt!==null?lt:Number.MAX_VALUE);if(Lt!==Number.MAX_VALUE)return Lt;{const $t=Bt([],A,D,pe);if(hf(bt,mt,gt,rt,sf($t[0],X[0],Y[0]),sf($t[1],X[1],Y[1]))>=$t[2])return pe}continue}let $e=0;for(let Ve=0;Ve<this._siblingOffset.length;Ve++){af((ve<<1)+this._siblingOffset[Ve][0],(Ae<<1)+this._siblingOffset[Ve][1],Be+1,l,b,E,S,X,Y),X[2]=-100,Y[2]=this.maximums[this.childOffsets[ce]+Ve]*z;const Ge=nf(X,Y,A,D);if(Ge!=null){const Xe=Ge;V[Ve]=Xe;let nt=!1;for(let it=0;it<$e&&!nt;it++)Xe>=V[Z[it]]&&(Z.splice(it,0,Ve),nt=!0);nt||(Z[$e]=Ve),$e++}}for(let Ve=0;Ve<$e;Ve++){const Ge=Z[Ve];ie.push({idx:this.childOffsets[ce]+Ge,t:V[Ge],nodex:(ve<<1)+this._siblingOffset[Ge][0],nodey:(Ae<<1)+this._siblingOffset[Ge][1],depth:Be+1})}}return null}_addNode(l,b,E){return this.minimums.push(l),this.maximums.push(b),this.leaves.push(E),this.childOffsets.push(0),this.nodeCount++}_construct(l,b,E,S,A){if(l[S].isLeaf(b,E)===1)return;this.childOffsets[A]||(this.childOffsets[A]=this.nodeCount);const D=S-1,z=l[D];let $,V=0;for(let Z=0;Z<this._siblingOffset.length;Z++){const X=2*b+this._siblingOffset[Z][0],Y=2*E+this._siblingOffset[Z][1],ie=z.getElevation(X,Y),ce=z.isLeaf(X,Y),pe=this._addNode(ie.min,ie.max,ce);ce&&(V|=1<<Z),$||($=pe)}for(let Z=0;Z<this._siblingOffset.length;Z++)V&1<<Z||this._construct(l,2*b+this._siblingOffset[Z][0],2*E+this._siblingOffset[Z][1],D,$+Z)}}function hf(g,l,b,E,S,A){return ji(ji(g,b,A),ji(l,E,A),S)}function Go(g,l,b){const E=b.dim,S=Pt(g*E-.5,0,E-1),A=Pt(l*E-.5,0,E-1),D=Math.floor(S),z=Math.floor(A),$=Math.min(D+1,E-1),V=Math.min(z+1,E-1);return hf(b.get(D,z),b.get($,z),b.get(D,V),b.get($,V),S-D,A-z)}const cf={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class Yh{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(l,b,E,S=!1,A=!1){if(this.uid=l,b.height!==b.width)throw new RangeError("DEM tiles must be square");if(E&&E!=="mapbox"&&E!=="terrarium")return Ai(`"${E}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=b.height;const D=this.dim=b.height-2;if(this.data=new Uint32Array(b.data.buffer),this.encoding=E||"mapbox",this.borderReady=S,!S){for(let z=0;z<D;z++)this.data[this._idx(-1,z)]=this.data[this._idx(0,z)],this.data[this._idx(D,z)]=this.data[this._idx(D-1,z)],this.data[this._idx(z,-1)]=this.data[this._idx(z,0)],this.data[this._idx(z,D)]=this.data[this._idx(z,D-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(D,-1)]=this.data[this._idx(D-1,0)],this.data[this._idx(-1,D)]=this.data[this._idx(0,D-1)],this.data[this._idx(D,D)]=this.data[this._idx(D-1,D-1)],A&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new lf(this)}get(l,b,E=!1){const S=new Uint8Array(this.data.buffer);E&&(l=Pt(l,-1,this.dim),b=Pt(b,-1,this.dim));const A=4*this._idx(l,b);return(this.encoding==="terrarium"?this._unpackTerrarium:this._unpackMapbox)(S[A],S[A+1],S[A+2])}static getUnpackVector(l){return cf[l]}get unpackVector(){return cf[this.encoding]}_idx(l,b){if(l<-1||l>=this.dim+1||b<-1||b>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(b+1)*this.stride+(l+1)}_unpackMapbox(l,b,E){return(256*l*256+256*b+E)/10-1e4}_unpackTerrarium(l,b,E){return 256*l+b+E/256-32768}static pack(l,b){const E=[0,0,0,0],S=Yh.getUnpackVector(b);let A=Math.floor((l+S[3])/S[2]);return E[2]=A%256,A=Math.floor(A/256),E[1]=A%256,A=Math.floor(A/256),E[0]=A,E}getPixels(){return new bn({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(l,b,E){if(this.dim!==l.dim)throw new Error("dem dimension mismatch");let S=b*this.dim,A=b*this.dim+this.dim,D=E*this.dim,z=E*this.dim+this.dim;switch(b){case-1:S=A-1;break;case 1:A=S+1}switch(E){case-1:D=z-1;break;case 1:z=D+1}const $=-b*this.dim,V=-E*this.dim;for(let Z=D;Z<z;Z++)for(let X=S;X<A;X++)this.data[this._idx(X,Z)]=l.data[this._idx(X+$,Z+V)]}onDeserialize(){this._tree&&(this._tree.dem=this)}}Ft("DEMData",Yh),Ft("DemMinMaxQuadTree",lf,{omit:["dem"]});class Um{constructor(l,b){this.max=l,this.onRemove=b,this.reset()}reset(){for(const l in this.data)for(const b of this.data[l])b.timeout&&clearTimeout(b.timeout),this.onRemove(b.value);return this.data={},this.order=[],this}add(l,b,E){const S=l.wrapped().key;this.data[S]===void 0&&(this.data[S]=[]);const A={value:b,timeout:void 0};if(E!==void 0&&(A.timeout=setTimeout(()=>{this.remove(l,A)},E)),this.data[S].push(A),this.order.push(S),this.order.length>this.max){const D=this._getAndRemoveByKey(this.order[0]);D&&this.onRemove(D)}return this}has(l){return l.wrapped().key in this.data}getAndRemove(l){return this.has(l)?this._getAndRemoveByKey(l.wrapped().key):null}_getAndRemoveByKey(l){const b=this.data[l].shift();return b.timeout&&clearTimeout(b.timeout),this.data[l].length===0&&delete this.data[l],this.order.splice(this.order.indexOf(l),1),b.value}getByKey(l){const b=this.data[l];return b?b[0].value:null}get(l){return this.has(l)?this.data[l.wrapped().key][0].value:null}remove(l,b){if(!this.has(l))return this;const E=l.wrapped().key,S=b===void 0?0:this.data[E].indexOf(b),A=this.data[E][S];return this.data[E].splice(S,1),A.timeout&&clearTimeout(A.timeout),this.data[E].length===0&&delete this.data[E],this.onRemove(A.value),this.order.splice(this.order.indexOf(E),1),this}setMaxSize(l){for(this.max=l;this.order.length>this.max;){const b=this._getAndRemoveByKey(this.order[0]);b&&this.onRemove(b)}return this}filter(l){const b=[];for(const E in this.data)for(const S of this.data[E])l(S.value)||b.push(S);for(const E of b)this.remove(E.value.tileID,E)}}class As extends qn{constructor(l,b,E){super(),this.id=l,this._onlySymbols=E,b.on("data",S=>{S.dataType==="source"&&S.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&S.dataType==="source"&&S.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),b.on("error",()=>{this._sourceErrored=!0}),this._source=b,this._tiles={},this._cache=new Um(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=null,this._maxTileCacheSize=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new $m}onAdd(l){this.map=l,this._minTileCacheSize=l?l._minTileCacheSize:null,this._maxTileCacheSize=l?l._maxTileCacheSize:null}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const l in this._tiles){const b=this._tiles[l];if(b.state!=="loaded"&&b.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const l=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,l&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(l,b){return l.isSymbolTile=this._onlySymbols,this._source.loadTile(l,b)}_unloadTile(l){if(this._source.unloadTile)return this._source.unloadTile(l,()=>{})}_abortTile(l){if(this._source.abortTile)return this._source.abortTile(l,()=>{})}serialize(){return this._source.serialize()}prepare(l){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const b in this._tiles){const E=this._tiles[b];E.upload(l),E.prepare(this.map.style.imageManager)}}getIds(){return Di(this._tiles).map(l=>l.tileID).sort(uf).map(l=>l.key)}getRenderableIds(l){const b=[];for(const E in this._tiles)this._isIdRenderable(+E,l)&&b.push(this._tiles[E]);return l?b.sort((E,S)=>{const A=E.tileID,D=S.tileID,z=new U(A.canonical.x,A.canonical.y)._rotate(this.transform.angle),$=new U(D.canonical.x,D.canonical.y)._rotate(this.transform.angle);return A.overscaledZ-D.overscaledZ||$.y-z.y||$.x-z.x}).map(E=>E.tileID.key):b.map(E=>E.tileID).sort(uf).map(E=>E.key)}hasRenderableParent(l){const b=this.findLoadedParent(l,0);return!!b&&this._isIdRenderable(b.tileID.key)}_isIdRenderable(l,b){return this._tiles[l]&&this._tiles[l].hasData()&&!this._coveredTiles[l]&&(b||!this._tiles[l].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const l in this._tiles)this._tiles[l].state!=="errored"&&this._reloadTile(+l,"reloading")}}_reloadTile(l,b){const E=this._tiles[l];E&&(E.state!=="loading"&&(E.state=b),this._loadTile(E,this._tileLoaded.bind(this,E,l,b)))}_tileLoaded(l,b,E,S){if(S)if(l.state="errored",S.status!==404)this._source.fire(new Ls(S,{tile:l}));else if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const A=this.map.painter.terrain;this.update(this.transform,A.getScaledDemTileSize(),!0),A.resetTileLookupCache(this.id)}else this.update(this.transform);else l.timeAdded=je.now(),E==="expired"&&(l.refreshedUponExpiration=!0),this._setTileReloadTimer(b,l),this._source.type==="raster-dem"&&l.dem&&this._backfillDEM(l),this._state.initializeTileState(l,this.map?this.map.painter:null),this._source.fire(new Gn("data",{dataType:"source",tile:l,coord:l.tileID,sourceCacheId:this.id}))}_backfillDEM(l){const b=this.getRenderableIds();for(let S=0;S<b.length;S++){const A=b[S];if(l.neighboringTiles&&l.neighboringTiles[A]){const D=this.getTileByID(A);E(l,D),E(D,l)}}function E(S,A){if(!S.dem||S.dem.borderReady)return;S.needsHillshadePrepare=!0,S.needsDEMTextureUpload=!0;let D=A.tileID.canonical.x-S.tileID.canonical.x;const z=A.tileID.canonical.y-S.tileID.canonical.y,$=Math.pow(2,S.tileID.canonical.z),V=A.tileID.key;D===0&&z===0||Math.abs(z)>1||(Math.abs(D)>1&&(Math.abs(D+$)===1?D+=$:Math.abs(D-$)===1&&(D-=$)),A.dem&&S.dem&&(S.dem.backfillBorder(A.dem,D,z),S.neighboringTiles&&S.neighboringTiles[V]&&(S.neighboringTiles[V].backfilled=!0)))}}getTile(l){return this.getTileByID(l.key)}getTileByID(l){return this._tiles[l]}_retainLoadedChildren(l,b,E,S){for(const A in this._tiles){let D=this._tiles[A];if(S[A]||!D.hasData()||D.tileID.overscaledZ<=b||D.tileID.overscaledZ>E)continue;let z=D.tileID;for(;D&&D.tileID.overscaledZ>b+1;){const V=D.tileID.scaledTo(D.tileID.overscaledZ-1);D=this._tiles[V.key],D&&D.hasData()&&(z=V)}let $=z;for(;$.overscaledZ>b;)if($=$.scaledTo($.overscaledZ-1),l[$.key]){S[z.key]=z;break}}}findLoadedParent(l,b){if(l.key in this._loadedParentTiles){const E=this._loadedParentTiles[l.key];return E&&E.tileID.overscaledZ>=b?E:null}for(let E=l.overscaledZ-1;E>=b;E--){const S=l.scaledTo(E),A=this._getLoadedTile(S);if(A)return A}}_getLoadedTile(l){const b=this._tiles[l.key];return b&&b.hasData()?b:this._cache.getByKey(this._source.reparseOverscaled?l.wrapped().key:l.canonical.key)}updateCacheSize(l,b){b=b||this._source.tileSize;const E=Math.ceil(l.width/b)+1,S=Math.ceil(l.height/b)+1,A=Math.floor(E*S*5),D=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,A):A,z=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,D):D;this._cache.setMaxSize(z)}handleWrapJump(l){const b=Math.round((l-(this._prevLng===void 0?l:this._prevLng))/360);if(this._prevLng=l,b){const E={};for(const S in this._tiles){const A=this._tiles[S];A.tileID=A.tileID.unwrapTo(A.tileID.wrap+b),E[A.tileID.key]=A}this._tiles=E;for(const S in this._timers)clearTimeout(this._timers[S]),delete this._timers[S];for(const S in this._tiles)this._setTileReloadTimer(+S,this._tiles[S])}}update(l,b,E){if(this.transform=l,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!E)return;let S;this.updateCacheSize(l,b),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?S=l.getVisibleUnwrappedCoordinates(this._source.tileID).map(z=>new tn(z.canonical.z,z.wrap,z.canonical.z,z.canonical.x,z.canonical.y)):(S=l.coveringTiles({tileSize:b||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!E,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(S=S.filter(z=>this._source.hasTile(z)))):S=[];const A=this._updateRetainedTiles(S);if(df(this._source.type)&&S.length!==0){const z={},$={},V=Object.keys(A);for(const X of V){const Y=A[X],ie=this._tiles[X];if(!ie||ie.fadeEndTime&&ie.fadeEndTime<=je.now())continue;const ce=this.findLoadedParent(Y,Math.max(Y.overscaledZ-As.maxOverzooming,this._source.minzoom));ce&&(this._addTile(ce.tileID),z[ce.tileID.key]=ce.tileID),$[X]=Y}const Z=S[S.length-1].overscaledZ;for(const X in this._tiles){const Y=this._tiles[X];if(A[X]||!Y.hasData())continue;let ie=Y.tileID;for(;ie.overscaledZ>Z;){ie=ie.scaledTo(ie.overscaledZ-1);const ce=this._tiles[ie.key];if(ce&&ce.hasData()&&$[ie.key]){A[X]=Y.tileID;break}}}for(const X in z)A[X]||(this._coveredTiles[X]=!0,A[X]=z[X])}for(const z in A)this._tiles[z].clearFadeHold();const D=function(z,$){const V=[];for(const Z in z)Z in $||V.push(Z);return V}(this._tiles,A);for(const z of D){const $=this._tiles[z];$.hasSymbolBuckets&&!$.holdingForFade()?$.setHoldDuration(this.map._fadeDuration):$.hasSymbolBuckets&&!$.symbolFadeFinished()||this._removeTile(+z)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const l in this._tiles)this._tiles[l].holdingForFade()&&this._removeTile(+l)}_updateRetainedTiles(l){const b={};if(l.length===0)return b;const E={},S=l.reduce((V,Z)=>Math.min(V,Z.overscaledZ),1/0),A=l[0].overscaledZ,D=Math.max(A-As.maxOverzooming,this._source.minzoom),z=Math.max(A+As.maxUnderzooming,this._source.minzoom),$={};for(const V of l){const Z=this._addTile(V);b[V.key]=V,Z.hasData()||S<this._source.maxzoom&&($[V.key]=V)}this._retainLoadedChildren($,S,z,b);for(const V of l){let Z=this._tiles[V.key];if(Z.hasData())continue;if(V.canonical.z>=this._source.maxzoom){const Y=V.children(this._source.maxzoom)[0],ie=this.getTile(Y);if(ie&&ie.hasData()){b[Y.key]=Y;continue}}else{const Y=V.children(this._source.maxzoom);if(b[Y[0].key]&&b[Y[1].key]&&b[Y[2].key]&&b[Y[3].key])continue}let X=Z.wasRequested();for(let Y=V.overscaledZ-1;Y>=D;--Y){const ie=V.scaledTo(Y);if(E[ie.key]||(E[ie.key]=!0,Z=this.getTile(ie),!Z&&X&&(Z=this._addTile(ie)),Z&&(b[ie.key]=ie,X=Z.wasRequested(),Z.hasData())))break}}return b}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const l in this._tiles){const b=[];let E,S=this._tiles[l].tileID;for(;S.overscaledZ>0;){if(S.key in this._loadedParentTiles){E=this._loadedParentTiles[S.key];break}b.push(S.key);const A=S.scaledTo(S.overscaledZ-1);if(E=this._getLoadedTile(A),E)break;S=A}for(const A of b)this._loadedParentTiles[A]=E}}_addTile(l){let b=this._tiles[l.key];if(b)return b;b=this._cache.getAndRemove(l),b&&(this._setTileReloadTimer(l.key,b),b.tileID=l,this._state.initializeTileState(b,this.map?this.map.painter:null),this._cacheTimers[l.key]&&(clearTimeout(this._cacheTimers[l.key]),delete this._cacheTimers[l.key],this._setTileReloadTimer(l.key,b)));const E=Boolean(b);if(!E){const S=this.map?this.map.painter:null,A=this._source.type==="raster"||this._source.type==="raster-dem";b=new pu(l,this._source.tileSize*l.overscaleFactor(),this.transform.tileZoom,S,A),this._loadTile(b,this._tileLoaded.bind(this,b,l.key,b.state))}return b?(b.uses++,this._tiles[l.key]=b,E||this._source.fire(new Gn("dataloading",{tile:b,coord:b.tileID,dataType:"source"})),b):null}_setTileReloadTimer(l,b){l in this._timers&&(clearTimeout(this._timers[l]),delete this._timers[l]);const E=b.getExpiryTimeout();E&&(this._timers[l]=setTimeout(()=>{this._reloadTile(l,"expired"),delete this._timers[l]},E))}_removeTile(l){const b=this._tiles[l];b&&(b.uses--,delete this._tiles[l],this._timers[l]&&(clearTimeout(this._timers[l]),delete this._timers[l]),b.uses>0||(b.hasData()&&b.state!=="reloading"?this._cache.add(b.tileID,b,b.getExpiryTimeout()):(b.aborted=!0,this._abortTile(b),this._unloadTile(b))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const l in this._tiles)this._removeTile(+l);this._source._clear&&this._source._clear(),this._cache.reset()}tilesIn(l,b,E){const S=[],A=this.transform;if(!A)return S;for(const D in this._tiles){const z=this._tiles[D];if(E&&z.clearQueryDebugViz(),z.holdingForFade())continue;const $=l.containsTile(z,A,b);$&&S.push($)}return S}getVisibleCoordinates(l){const b=this.getRenderableIds(l).map(E=>this._tiles[E].tileID);for(const E of b)E.projMatrix=this.transform.calculateProjMatrix(E.toUnwrapped());return b}hasTransition(){if(this._source.hasTransition())return!0;if(df(this._source.type))for(const l in this._tiles){const b=this._tiles[l];if(b.fadeEndTime!==void 0&&b.fadeEndTime>=je.now())return!0}return!1}setFeatureState(l,b,E){this._state.updateState(l=l||"_geojsonTileLayer",b,E)}removeFeatureState(l,b,E){this._state.removeFeatureState(l=l||"_geojsonTileLayer",b,E)}getFeatureState(l,b){return this._state.getState(l=l||"_geojsonTileLayer",b)}setDependencies(l,b,E){const S=this._tiles[l];S&&S.setDependencies(b,E)}reloadTilesForDependencies(l,b){for(const E in this._tiles)this._tiles[E].hasDependency(l,b)&&this._reloadTile(+E,"reloading");this._cache.filter(E=>!E.hasDependency(l,b))}_preloadTiles(l,b){const E=new Map,S=Array.isArray(l)?l:[l],A=this.map.painter.terrain,D=this.usedForTerrain&&A?A.getScaledDemTileSize():this._source.tileSize;for(const V of S){const Z=V.coveringTiles({tileSize:D,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const X of Z)E.set(X.key,X);this.usedForTerrain&&V.updateElevation(!1)}const z=Array.from(E.values()),$=this._source.type==="raster"||this._source.type==="raster-dem";vt(z,(V,Z)=>{const X=new pu(V,this._source.tileSize*V.overscaleFactor(),this.transform.tileZoom,this.map.painter,$);this._loadTile(X,Y=>{this._source.type==="raster-dem"&&X.dem&&this._backfillDEM(X),Z(Y,X)})},b)}}function uf(g,l){const b=Math.abs(2*g.wrap)-+(g.wrap<0),E=Math.abs(2*l.wrap)-+(l.wrap<0);return g.overscaledZ-l.overscaledZ||E-b||l.canonical.y-g.canonical.y||l.canonical.x-g.canonical.x}function df(g){return g==="raster"||g==="image"||g==="video"}As.maxOverzooming=10,As.maxUnderzooming=3;class Hh{constructor(l,b,E){this._demTile=l,this._dem=this._demTile.dem,this._scale=b,this._offset=E}static create(l,b,E){const S=E||l.findDEMTileFor(b);if(!S||!S.dem)return;const A=S.dem,D=S.tileID,z=1<<b.canonical.z-D.canonical.z;return new Hh(S,S.tileSize/Mi/z,[(b.canonical.x/z-D.canonical.x)*A.dim,(b.canonical.y/z-D.canonical.y)*A.dim])}tileCoordToPixel(l,b){const E=b*this._scale+this._offset[1],S=Math.floor(l*this._scale+this._offset[0]),A=Math.floor(E);return new U(S,A)}getElevationAt(l,b,E,S){const A=l*this._scale+this._offset[0],D=b*this._scale+this._offset[1],z=Math.floor(A),$=Math.floor(D),V=this._dem;return S=!!S,E?ji(ji(V.get(z,$,S),V.get(z,$+1,S),D-$),ji(V.get(z+1,$,S),V.get(z+1,$+1,S),D-$),A-z):V.get(z,$,S)}getElevationAtPixel(l,b,E){return this._dem.get(l,b,!!E)}getMeterToDEM(l){return(1<<this._demTile.tileID.canonical.z)*$n(1,l)*this._dem.stride}}class ff{constructor(l,b){this.tileID=l,this.x=l.canonical.x,this.y=l.canonical.y,this.z=l.canonical.z,this.grid=new ys(Mi,16,0),this.featureIndexArray=new zu,this.promoteId=b}insert(l,b,E,S,A,D=0){const z=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(E,S,A,D);const $=this.grid;for(let V=0;V<b.length;V++){const Z=b[V],X=[1/0,1/0,-1/0,-1/0];for(let Y=0;Y<Z.length;Y++){const ie=Z[Y];X[0]=Math.min(X[0],ie.x),X[1]=Math.min(X[1],ie.y),X[2]=Math.max(X[2],ie.x),X[3]=Math.max(X[3],ie.y)}X[0]<Mi&&X[1]<Mi&&X[2]>=0&&X[3]>=0&&$.insert(z,X[0],X[1],X[2],X[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Ss.VectorTile(new bl(this.rawTileData)).layers,this.sourceLayerCoder=new ef(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const l in this.vtLayers)this.vtFeatures[l]=[]}return this.vtLayers}query(l,b,E,S){this.loadVTLayers();const A=l.params||{},D=ha(A.filter),z=l.tileResult,$=l.transform,V=z.bufferedTilespaceBounds,Z=this.grid.query(V.min.x,V.min.y,V.max.x,V.max.y,(ce,pe,ve,Ae)=>Qu(z.bufferedTilespaceGeometry,ce,pe,ve,Ae));Z.sort(Nm);let X=null;$.elevation&&Z.length>0&&(X=Hh.create($.elevation,this.tileID));const Y={};let ie;for(let ce=0;ce<Z.length;ce++){const pe=Z[ce];if(pe===ie)continue;ie=pe;const ve=this.featureIndexArray.get(pe);let Ae=null;this.loadMatchingFeature(Y,ve,D,A.layers,A.availableImages,b,E,S,(Be,$e,Ve,Ge=0)=>(Ae||(Ae=yo(Be,this.tileID.canonical,l.tileTransform)),$e.queryIntersectsFeature(z,Be,Ve,Ae,this.z,l.transform,l.pixelPosMatrix,X,Ge)))}return Y}loadMatchingFeature(l,b,E,S,A,D,z,$,V){const{featureIndex:Z,bucketIndex:X,sourceLayerIndex:Y,layoutVertexArrayOffset:ie}=b,ce=this.bucketLayerIDs[X];if(S&&!function(Be,$e){for(let Ve=0;Ve<Be.length;Ve++)if($e.indexOf(Be[Ve])>=0)return!0;return!1}(S,ce))return;const pe=this.sourceLayerCoder.decode(Y),ve=this.vtLayers[pe].feature(Z);if(E.needGeometry){const Be=Ms(ve,!0);if(!E.filter(new ui(this.tileID.overscaledZ),Be,this.tileID.canonical))return}else if(!E.filter(new ui(this.tileID.overscaledZ),ve))return;const Ae=this.getId(ve,pe);for(let Be=0;Be<ce.length;Be++){const $e=ce[Be];if(S&&S.indexOf($e)<0)continue;const Ve=D[$e];if(!Ve)continue;let Ge={};Ae!==void 0&&$&&(Ge=$.getState(Ve.sourceLayer||"_geojsonTileLayer",Ae));const Xe=Wt({},z[$e]);Xe.paint=pf(Xe.paint,Ve.paint,ve,Ge,A),Xe.layout=pf(Xe.layout,Ve.layout,ve,Ge,A);const nt=!V||V(ve,Ve,Ge,ie);if(!nt)continue;const it=new tf(ve,this.z,this.x,this.y,Ae);it.layer=Xe;let bt=l[$e];bt===void 0&&(bt=l[$e]=[]),bt.push({featureIndex:Z,feature:it,intersectionZ:nt})}}lookupSymbolFeatures(l,b,E,S,A,D,z,$){const V={};this.loadVTLayers();const Z=ha(A);for(const X of l)this.loadMatchingFeature(V,{bucketIndex:E,sourceLayerIndex:S,featureIndex:X,layoutVertexArrayOffset:0},Z,D,z,$,b);return V}loadFeature(l){const{featureIndex:b,sourceLayerIndex:E}=l;this.loadVTLayers();const S=this.sourceLayerCoder.decode(E),A=this.vtFeatures[S];if(A[b])return A[b];const D=this.vtLayers[S].feature(b);return A[b]=D,D}hasLayer(l){for(const b of this.bucketLayerIDs)for(const E of b)if(l===E)return!0;return!1}getId(l,b){let E=l.id;return this.promoteId&&(E=l.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[b]],typeof E=="boolean"&&(E=Number(E))),E}}function pf(g,l,b,E,S){return ai(g,(A,D)=>{const z=l instanceof uo?l.get(D):null;return z&&z.evaluate?z.evaluate(b,E,S):z})}function Nm(g,l){return l-g}Ft("FeatureIndex",ff,{omit:["rawTileData","sourceLayerCoder"]});var Vm=ar([{name:"a_pos",type:"Int16",components:2}]);const Cn=32,oo=33,qo=new Uint16Array(8184);for(let g=0;g<2046;g++){let l=g+2,b=0,E=0,S=0,A=0,D=0,z=0;for(1&l?S=A=D=Cn:b=E=z=Cn;(l>>=1)>1;){const V=b+S>>1,Z=E+A>>1;1&l?(S=b,A=E,b=D,E=z):(b=S,E=A,S=D,A=z),D=V,z=Z}const $=4*g;qo[$+0]=b,qo[$+1]=E,qo[$+2]=S,qo[$+3]=A}const so=new Uint16Array(2178),Zo=new Uint8Array(1089),Wh=new Uint16Array(1089);function mf(g){return g===0?-.03125:g===32?.03125:0}var fu=ar([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const gf={type:2,extent:Mi,loadGeometry:()=>[[new U(0,0),new U(8193,0),new U(8193,8193),new U(0,8193),new U(0,0)]]};class pu{constructor(l,b,E,S,A){this.tileID=l,this.uid=qt(),this.uses=0,this.tileSize=b,this.tileZoom=E,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=A,this.expiredRequestCount=0,this.state="loading",S&&S.transform&&(this.projection=S.transform.projection)}registerFadeDuration(l){const b=l+this.timeAdded;b<je.now()||this.fadeEndTime&&b<this.fadeEndTime||(this.fadeEndTime=b)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=Ca(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(l,b,E){if(this.unloadVectorData(),this.state="loaded",l){l.featureIndex&&(this.latestFeatureIndex=l.featureIndex,l.rawTileData?(this.latestRawTileData=l.rawTileData,this.latestFeatureIndex.rawTileData=l.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=l.collisionBoxArray,this.buckets=function(S,A){const D={};if(!A)return D;for(const z of S){const $=z.layerIds.map(V=>A.getLayer(V)).filter(Boolean);if($.length!==0){z.layers=$,z.stateDependentLayerIds&&(z.stateDependentLayers=z.stateDependentLayerIds.map(V=>$.filter(Z=>Z.id===V)[0]));for(const V of $)D[V.id]=z}}return D}(l.buckets,b.style),this.hasSymbolBuckets=!1;for(const S in this.buckets){const A=this.buckets[S];if(A instanceof jo){if(this.hasSymbolBuckets=!0,!E)break;A.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const S in this.buckets){const A=this.buckets[S];if(A instanceof jo&&A.hasRTLText){this.hasRTLText=!0,Bi.isLoading()||Bi.isLoaded()||cn()!=="deferred"||xn();break}}this.queryPadding=0;for(const S in this.buckets){const A=this.buckets[S];this.queryPadding=Math.max(this.queryPadding,b.style.getLayer(S).queryRadius(A))}l.imageAtlas&&(this.imageAtlas=l.imageAtlas),l.glyphAtlasImage&&(this.glyphAtlasImage=l.glyphAtlasImage),l.lineAtlas&&(this.lineAtlas=l.lineAtlas)}else this.collisionBoxArray=new Sc}unloadVectorData(){if(this.hasData()){for(const l in this.buckets)this.buckets[l].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugIndexBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this.globeGridBuffer&&(this.globeGridBuffer.destroy(),this.globeGridBuffer=null),this.globePoleBuffer&&(this.globePoleBuffer.destroy(),this.globePoleBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(l){return this.buckets[l.id]}upload(l){for(const E in this.buckets){const S=this.buckets[E];S.uploadPending()&&S.upload(l)}const b=l.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Zh(l,this.imageAtlas.image,b.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Zh(l,this.glyphAtlasImage,b.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new Zh(l,this.lineAtlas.image,b.ALPHA),this.lineAtlas.uploaded=!0)}prepare(l){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(l,this.imageAtlasTexture)}queryRenderedFeatures(l,b,E,S,A,D,z,$){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:S,pixelPosMatrix:z,transform:D,params:A,tileTransform:this.tileTransform},l,b,E):{}}querySourceFeatures(l,b){const E=this.latestFeatureIndex;if(!E||!E.rawTileData)return;const S=E.loadVTLayers(),A=b?b.sourceLayer:"",D=S._geojsonTileLayer||S[A];if(!D)return;const z=ha(b&&b.filter),{z:$,x:V,y:Z}=this.tileID.canonical,X={z:$,x:V,y:Z};for(let Y=0;Y<D.length;Y++){const ie=D.feature(Y);if(z.needGeometry){const ve=Ms(ie,!0);if(!z.filter(new ui(this.tileID.overscaledZ),ve,this.tileID.canonical))continue}else if(!z.filter(new ui(this.tileID.overscaledZ),ie))continue;const ce=E.getId(ie,A),pe=new tf(ie,$,V,Z,ce);pe.tile=X,l.push(pe)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(l){const b=this.expirationTime;if(l.cacheControl){const E=Rr(l.cacheControl);E["max-age"]&&(this.expirationTime=Date.now()+1e3*E["max-age"])}else l.expires&&(this.expirationTime=new Date(l.expires).getTime());if(this.expirationTime){const E=Date.now();let S=!1;if(this.expirationTime>E)S=!1;else if(b)if(this.expirationTime<b)S=!0;else{const A=this.expirationTime-b;A?this.expirationTime=E+Math.max(A,3e4):S=!0}else S=!0;S?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(l,b){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(l).length===0||!b)return;const E=this.latestFeatureIndex.loadVTLayers(),S=b.style.listImages();for(const A in this.buckets){if(!b.style.hasLayer(A))continue;const D=this.buckets[A],z=D.layers[0].sourceLayer||"_geojsonTileLayer",$=E[z],V=l[z];if(!$||!V||Object.keys(V).length===0)continue;if(D.update(V,$,S,this.imageAtlas&&this.imageAtlas.patternPositions||{}),D instanceof Lh||D instanceof Bh){const X=b.style._getSourceCache(D.layers[0].source);b._terrain&&b._terrain.enabled&&X&&D.programConfigurations.needsUpload&&b._terrain._clearRenderCacheForTile(X.id,this.tileID)}const Z=b&&b.style&&b.style.getLayer(A);Z&&(this.queryPadding=Math.max(this.queryPadding,Z.queryRadius(D)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<je.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(l){this.symbolFadeHoldUntil=je.now()+l}setDependencies(l,b){const E={};for(const S of b)E[S]=!0;this.dependencies[l]=E}hasDependency(l,b){for(const E of l){const S=this.dependencies[E];if(S){for(const A of b)if(S[A])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(l,b){if(!b||b.name==="mercator"||this._tileDebugBuffer)return;const E=yo(gf,this.tileID.canonical,this.tileTransform)[0],S=new fa,A=new vh;for(let D=0;D<E.length;D++){const{x:z,y:$}=E[D];S.emplaceBack(z,$),A.emplaceBack(D)}A.emplaceBack(0),this._tileDebugIndexBuffer=l.createIndexBuffer(A),this._tileDebugBuffer=l.createVertexBuffer(S,fu.members),this._tileDebugSegments=gr.simpleSegment(0,0,S.length,A.length)}_makeTileBoundsBuffers(l,b){if(this._tileBoundsBuffer||!b||b.name==="mercator")return;const E=yo(gf,this.tileID.canonical,this.tileTransform)[0];let S,A;if(this.isRaster){const D=function(z,$){const V=Ca(z,$),Z=Math.pow(2,z.z);for(let ve=0;ve<oo;ve++)for(let Ae=0;Ae<oo;Ae++){const Be=_o((z.x+(Ae+mf(Ae))/Cn)/Z),$e=kn((z.y+(ve+mf(ve))/Cn)/Z),Ve=$.project(Be,$e),Ge=ve*oo+Ae;so[2*Ge+0]=Math.round((Ve.x*V.scale-V.x)*Mi),so[2*Ge+1]=Math.round((Ve.y*V.scale-V.y)*Mi)}Zo.fill(0),Wh.fill(0);for(let ve=2045;ve>=0;ve--){const Ae=4*ve,Be=qo[Ae+0],$e=qo[Ae+1],Ve=qo[Ae+2],Ge=qo[Ae+3],Xe=Be+Ve>>1,nt=$e+Ge>>1,it=Xe+nt-$e,bt=nt+Be-Xe,mt=$e*oo+Be,rt=Ge*oo+Ve,gt=nt*oo+Xe,Et=Math.hypot((so[2*mt+0]+so[2*rt+0])/2-so[2*gt+0],(so[2*mt+1]+so[2*rt+1])/2-so[2*gt+1])>=16;if(Zo[gt]=Zo[gt]||(Et?1:0),ve<1022){const lt=($e+bt>>1)*oo+(Be+it>>1),Lt=(Ge+bt>>1)*oo+(Ve+it>>1);Zo[gt]=Zo[gt]||Zo[lt]||Zo[Lt]}}const X=new pa,Y=new vn;let ie=0;function ce(ve,Ae){const Be=Ae*oo+ve;return Wh[Be]===0&&(X.emplaceBack(so[2*Be+0],so[2*Be+1],ve*Mi/Cn,Ae*Mi/Cn),Wh[Be]=++ie),Wh[Be]-1}function pe(ve,Ae,Be,$e,Ve,Ge){const Xe=ve+Be>>1,nt=Ae+$e>>1;if(Math.abs(ve-Ve)+Math.abs(Ae-Ge)>1&&Zo[nt*oo+Xe])pe(Ve,Ge,ve,Ae,Xe,nt),pe(Be,$e,Ve,Ge,Xe,nt);else{const it=ce(ve,Ae),bt=ce(Be,$e),mt=ce(Ve,Ge);Y.emplaceBack(it,bt,mt)}}return pe(0,0,Cn,Cn,Cn,0),pe(Cn,Cn,0,0,0,Cn),{vertices:X,indices:Y}}(this.tileID.canonical,b);S=D.vertices,A=D.indices}else{S=new pa,A=new vn;for(const{x:z,y:$}of E)S.emplaceBack(z,$,0,0);const D=kh(S.int16,void 0,4);for(let z=0;z<D.length;z+=3)A.emplaceBack(D[z],D[z+1],D[z+2])}this._tileBoundsBuffer=l.createVertexBuffer(S,fu.members),this._tileBoundsIndexBuffer=l.createIndexBuffer(A),this._tileBoundsSegments=gr.simpleSegment(0,0,S.length,A.length)}}const jm=ar([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_merc_pos",components:2},{type:"Float32",name:"a_uv",components:2}]),Gm=ar([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:_f}=jm;function Is(g,l){const b=g.fovAboveCenter,E=g.elevation?g.elevation.getMinElevationBelowMSL()*l:0,S=(g._camera.position[2]*g.worldSize-E)/Math.cos(g._pitch),A=Math.sin(b)*S/Math.sin(Math.max(Math.PI/2-g._pitch-b,.01)),D=Math.sin(g._pitch)*A+S;return Math.min(1.01*D,S*(1/g._horizonShift))}const mu=Mi/Math.PI/2,un=-mu,dn=mu,qm=[new Un([un,un,un],[dn,dn,dn]),new Un([un,un,un],[0,0,dn]),new Un([0,un,un],[dn,0,dn]),new Un([un,0,un],[0,dn,dn]),new Un([0,0,un],[dn,dn,dn])];function Kh(g){if(g.z<=1)return qm[g.z+2*g.y+g.x];const[l,b]=yf(g),E=[Jh(l[0],l[1]),Jh(l[0],b[1]),Jh(b[0],l[1]),Jh(b[0],b[1])],S=[dn,dn,dn],A=[un,un,un];for(const D of E)S[0]=Math.min(S[0],D[0]),S[1]=Math.min(S[1],D[1]),S[2]=Math.min(S[2],D[2]),A[0]=Math.max(A[0],D[0]),A[1]=Math.max(A[1],D[1]),A[2]=Math.max(A[2],D[2]);return new Un(S,A)}function yf(g){const l=Math.pow(2,g.z),b=g.x/l,E=(g.x+1)/l,S=(g.y+1)/l;return[[kn(g.y/l),_o(b)],[kn(S),_o(E)]]}function gu(g,l,b,E){return b=pt(b),E||(E=mu),[g*Math.sin(b)*E,-l*E,g*Math.cos(b)*E]}function Jh(g,l,b){return gu(Math.cos(pt(g)),Math.sin(pt(g)),l,b)}function xf(g){return 16383/Math.max(...St([],g.max,g.min))}function vf(g){const l=Q(new Float64Array(16)),b=1/xf(g);return se(l,l,g.min),le(l,l,[b,b,b]),l}function bf(g,l,b){const E=l/(2*Math.PI),S=function(D){const z=Mi/(2*Math.PI);return D/(2*Math.PI)/z}(l);if(!b){const D=Pt(g.center.lat,-85.051129,io);b=[_a(g.center.lng)*l,ya(D)*l]}const A=Q(new Float64Array(16));return se(A,A,[b[0],b[1],-E]),le(A,A,[S,S,S]),me(A,A,pt(-g._center.lat)),Re(A,A,pt(-g._center.lng)),A}class _u{constructor(l){const b=this._createGridIndices();this.gridIndexBuffer=l.createIndexBuffer(b,!0),this.gridSegments=gr.simpleSegment(0,0,4225,8192);const E=this._createPoleTriangleIndices();this.poleIndexBuffer=l.createIndexBuffer(E,!0),this.poleSegments=gr.simpleSegment(0,0,66,64);const S=new ul;S.emplaceBack(-1,1,1,0,0,0,0),S.emplaceBack(1,1,1,0,0,1,0),S.emplaceBack(1,-1,1,0,0,1,1),S.emplaceBack(-1,-1,1,0,0,0,1);const A=new vn;A.emplaceBack(0,1,2),A.emplaceBack(2,3,0),this.atmosphereVertexBuffer=l.createVertexBuffer(S,Gm.members),this.atmosphereIndexBuffer=l.createIndexBuffer(A),this.atmosphereSegments=gr.simpleSegment(0,0,4,2)}destroy(){this.poleIndexBuffer.destroy(),this.gridIndexBuffer.destroy(),this.poleSegments.destroy(),this.gridSegments.destroy(),this.atmosphereVertexBuffer.destroy(),this.atmosphereIndexBuffer.destroy(),this.atmosphereSegments.destroy(),this.wireframeIndexBuffer&&(this.wireframeIndexBuffer.destroy(),this.wireframeSegments.destroy())}static createPoleTriangleVertices(l,b,E){const S=new ul,A=b/Math.PI/2;S.emplaceBack(0,-A,0,0,0,.5,E?0:1);const D=360/l,z=Math.cos(pt(85)),$=Math.sin(pt(85));for(let Z=0;Z<=64;Z++){const X=Z/64,Y=gu(z,$,0*(1-(V=X))+D*V,A);S.emplaceBack(Y[0],Y[1],Y[2],0,0,X,E?0:1)}var V;return S}_createPoleTriangleIndices(){const l=new vn;for(let b=0;b<=64;b++)l.emplaceBack(0,b+1,b+2);return l}static createGridVertices(l){const b=Math.pow(2,l.z),E=($,V,Z)=>$*(1-Z)+V*Z,[S,A]=yf(l),D=new ul,z=function($){const V=Q(new Float64Array(16)),Z=xf($);var X,Y;return le(V,V,[Z,Z,Z]),se(V,V,((X=[])[0]=-(Y=$.min)[0],X[1]=-Y[1],X[2]=-Y[2],X)),V}(Kh(l));D.reserve(4096);for(let $=0;$<65;$++){const V=E(S[0],A[0],$/64),Z=ya(V),X=Z*b-l.y,Y=Math.sin(pt(V)),ie=Math.cos(pt(V));for(let ce=0;ce<65;ce++){const pe=ce/64,ve=E(S[1],A[1],pe),Ae=gu(ie,Y,ve);Tt(Ae,Ae,z);const Be=_a(ve);D.emplaceBack(Ae[0],Ae[1],Ae[2],Be,Z,pe,X)}}return D}_createGridIndices(){const l=new vn,b=(E,S)=>{const A=65*S+E;l.emplaceBack(A+1,A,A+65),l.emplaceBack(A+65,A+65+1,A+1)};for(let E=0;E<64;E++)for(let S=0;S<64;S++)b(S,E);return l}getWirefameBuffer(l){if(!this.wireframeSegments){const b=this._createWireframeGrid();this.wireframeIndexBuffer=l.createIndexBuffer(b),this.wireframeSegments=gr.simpleSegment(0,0,4096,b.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}_createWireframeGrid(){const l=new Oo,b=(E,S)=>{const A=65*S+E;l.emplaceBack(A,A+1),l.emplaceBack(A,A+65),l.emplaceBack(A,A+65+1)};for(let E=0;E<64;E++)for(let S=0;S<64;S++)b(S,E);return l}}function Ca(g,l){if(!l.isReprojectedInTileSpace)return{scale:1<<g.z,x:g.x,y:g.y,x2:g.x+1,y2:g.y+1,projection:l};const b=Math.pow(2,-g.z),E=g.x*b,S=(g.x+1)*b,A=g.y*b,D=(g.y+1)*b,z=_o(E),$=_o(S),V=kn(A),Z=kn(D),X=l.project(z,V),Y=l.project($,V),ie=l.project($,Z),ce=l.project(z,Z);let pe=Math.min(X.x,Y.x,ie.x,ce.x),ve=Math.min(X.y,Y.y,ie.y,ce.y),Ae=Math.max(X.x,Y.x,ie.x,ce.x),Be=Math.max(X.y,Y.y,ie.y,ce.y);const $e=b/16;function Ve(Xe,nt,it,bt,mt,rt){const gt=(it+mt)/2,Et=(bt+rt)/2,lt=l.project(_o(gt),kn(Et)),Lt=Math.max(0,pe-lt.x,ve-lt.y,lt.x-Ae,lt.y-Be);pe=Math.min(pe,lt.x),Ae=Math.max(Ae,lt.x),ve=Math.min(ve,lt.y),Be=Math.max(Be,lt.y),Lt>$e&&(Ve(Xe,lt,it,bt,gt,Et),Ve(lt,nt,gt,Et,mt,rt))}Ve(X,Y,E,A,S,A),Ve(Y,ie,S,A,S,D),Ve(ie,ce,S,D,E,D),Ve(ce,X,E,D,E,A),pe-=$e,ve-=$e,Ae+=$e,Be+=$e;const Ge=1/Math.max(Ae-pe,Be-ve);return{scale:Ge,x:pe*Ge,y:ve*Ge,x2:Ae*Ge,y2:Be*Ge,projection:l}}class wf{constructor(l){const b={},E=[];for(const z in l){const $=l[z],V=b[z]={};for(const Z in $.glyphs){const X=$.glyphs[+Z];if(!X||X.bitmap.width===0||X.bitmap.height===0)continue;const Y=X.metrics.localGlyph?2:1,ie={x:0,y:0,w:X.bitmap.width+2*Y,h:X.bitmap.height+2*Y};E.push(ie),V[Z]=ie}}const{w:S,h:A}=Xc(E),D=new Uo({width:S||1,height:A||1});for(const z in l){const $=l[z];for(const V in $.glyphs){const Z=$.glyphs[+V];if(!Z||Z.bitmap.width===0||Z.bitmap.height===0)continue;const X=b[z][V],Y=Z.metrics.localGlyph?2:1;Uo.copy(Z.bitmap,D,{x:0,y:0},{x:X.x+Y,y:X.y+Y},Z.bitmap)}}this.image=D,this.positions=b}}Ft("GlyphAtlas",wf);class Zm{constructor(l){this.tileID=new tn(l.tileID.overscaledZ,l.tileID.wrap,l.tileID.canonical.z,l.tileID.canonical.x,l.tileID.canonical.y),this.tileZoom=l.tileZoom,this.uid=l.uid,this.zoom=l.zoom,this.canonical=l.tileID.canonical,this.pixelRatio=l.pixelRatio,this.tileSize=l.tileSize,this.source=l.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=l.showCollisionBoxes,this.collectResourceTiming=!!l.collectResourceTiming,this.returnDependencies=!!l.returnDependencies,this.promoteId=l.promoteId,this.enableTerrain=!!l.enableTerrain,this.isSymbolTile=l.isSymbolTile,this.tileTransform=Ca(l.tileID.canonical,l.projection),this.projection=l.projection}parse(l,b,E,S,A){this.status="parsing",this.data=l,this.collisionBoxArray=new Sc;const D=new ef(Object.keys(l.layers).sort()),z=new ff(this.tileID,this.promoteId);z.bucketLayerIDs=[];const $={},V=new au(256,256),Z={featureIndex:z,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:V,availableImages:E},X=b.familiesBySource[this.source];for(const Ge in X){const Xe=l.layers[Ge];if(!Xe)continue;let nt=!1,it=!1;for(const rt of X[Ge])rt[0].type==="symbol"?nt=!0:it=!0;if(this.isSymbolTile===!0&&!nt||this.isSymbolTile===!1&&!it)continue;Xe.version===1&&Ai(`Vector tile source "${this.source}" layer "${Ge}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const bt=D.encode(Ge),mt=[];for(let rt=0;rt<Xe.length;rt++){const gt=Xe.feature(rt),Et=z.getId(gt,Ge);mt.push({feature:gt,id:Et,index:rt,sourceLayerIndex:bt})}for(const rt of X[Ge]){const gt=rt[0];this.isSymbolTile!==void 0&&gt.type==="symbol"!==this.isSymbolTile||gt.minzoom&&this.zoom<Math.floor(gt.minzoom)||gt.maxzoom&&this.zoom>=gt.maxzoom||gt.visibility!=="none"&&(yu(rt,this.zoom,E),($[gt.id]=gt.createBucket({index:z.bucketLayerIDs.length,layers:rt,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:bt,sourceID:this.source,enableTerrain:this.enableTerrain,availableImages:E})).populate(mt,Z,this.tileID.canonical,this.tileTransform),z.bucketLayerIDs.push(rt.map(Et=>Et.id)))}}let Y,ie,ce,pe;V.trim();const ve={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Ae=ai(Z.glyphDependencies,Ge=>Object.keys(Ge).map(Number));Object.keys(Ae).length?S.send("getGlyphs",{uid:this.uid,stacks:Ae},(Ge,Xe)=>{Y||(Y=Ge,ie=Xe,Ve.call(this))},void 0,!1,ve):ie={};const Be=Object.keys(Z.iconDependencies);Be.length?S.send("getImages",{icons:Be,source:this.source,tileID:this.tileID,type:"icons"},(Ge,Xe)=>{Y||(Y=Ge,ce=Xe,Ve.call(this))},void 0,!1,ve):ce={};const $e=Object.keys(Z.patternDependencies);function Ve(){if(Y)return A(Y);if(ie&&ce&&pe){const Ge=new wf(ie),Xe=new Ad(ce,pe);for(const nt in $){const it=$[nt];it instanceof jo?(yu(it.layers,this.zoom,E),Tm(it,ie,Ge.positions,ce,Xe.iconPositions,this.showCollisionBoxes,E,this.tileID.canonical,this.tileZoom,this.projection),it.projection=this.projection.name):it.hasPattern&&(it instanceof Lh||it instanceof Bh||it instanceof Gc)&&(yu(it.layers,this.zoom,E),it.addFeatures(Z,this.tileID.canonical,Xe.patternPositions,E))}this.status="done",A(null,{buckets:Di($).filter(nt=>!nt.isEmpty()),featureIndex:z,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ge.image,lineAtlas:V,imageAtlas:Xe,glyphMap:this.returnDependencies?ie:null,iconMap:this.returnDependencies?ce:null,glyphPositions:this.returnDependencies?Ge.positions:null})}}$e.length?S.send("getImages",{icons:$e,source:this.source,tileID:this.tileID,type:"patterns"},(Ge,Xe)=>{Y||(Y=Ge,pe=Xe,Ve.call(this))},void 0,!1,ve):pe={},Ve.call(this)}}function yu(g,l,b){const E=new ui(l);for(const S of g)S.recalculate(E,b)}class Ef{constructor(l){this.entries={},this.scheduler=l}request(l,b,E,S){const A=this.entries[l]=this.entries[l]||{callbacks:[]};if(A.result){const[D,z]=A.result;return this.scheduler?this.scheduler.add(()=>{S(D,z)},b):S(D,z),()=>{}}return A.callbacks.push(S),A.cancel||(A.cancel=E((D,z)=>{A.result=[D,z];for(const $ of A.callbacks)this.scheduler?this.scheduler.add(()=>{$(D,z)},b):$(D,z);setTimeout(()=>delete this.entries[l],3e3)})),()=>{A.result||(A.callbacks=A.callbacks.filter(D=>D!==S),A.callbacks.length||(A.cancel(),delete this.entries[l]))}}}function Tf(g,l,b){const E=JSON.stringify(g.request);return g.data&&(this.deduped.entries[E]={result:[null,g.data]}),this.deduped.request(E,{type:"parseTile",isSymbolTile:g.isSymbolTile,zoom:g.tileZoom},S=>{const A=Wo(g.request,(D,z,$,V)=>{D?S(D):z&&S(null,{vectorTile:b?void 0:new Ss.VectorTile(new bl(z)),rawData:z,cacheControl:$,expires:V})});return()=>{A.cancel(),S()}},l)}const Xm=Q(new Float64Array(16));class ks{constructor(l,b){this._tr=l,this._worldSize=b}createInversionMatrix(){return Xm}createTileMatrix(l){let b,E,S;const A=l.canonical,D=Q(new Float64Array(16)),z=this._tr.projection;if(z.isReprojectedInTileSpace){const $=Ca(A,z);b=1,E=$.x+l.wrap*$.scale,S=$.y,le(D,D,[b/$.scale,b/$.scale,this._tr.pixelsPerMeter/this._worldSize])}else b=this._worldSize/this._tr.zoomScale(A.z),E=(A.x+Math.pow(2,A.z)*l.wrap)*b,S=A.y*b;return se(D,D,[E,S,0]),le(D,D,[b/Mi,b/Mi,1]),D}pointCoordinate(l,b,E){const S=this._tr.horizonLineFromTop(!1),A=new U(l,Math.max(S,b));return this._tr.rayIntersectionCoordinate(this._tr.pointRayIntersection(A,E))}upVector(){return[0,0,1]}upVectorScale(){return 1}}var Ym={name:"albers",range:[4,7],center:[-96,37.5],parallels:[29.5,45.5],zAxisUnit:"meters",conic:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],initializeConstants(){if(this.constants&&yi(this.parallels,this.constants.parallels))return;const g=Math.sin(pt(this.parallels[0])),l=(g+Math.sin(pt(this.parallels[1])))/2,b=1+g*(2*l-g),E=Math.sqrt(b)/l;this.constants={n:l,c:b,r0:E,parallels:this.parallels}},project(g,l){this.initializeConstants();const b=pt(g-this.center[0]),E=pt(l),{n:S,c:A,r0:D}=this.constants,z=Math.sqrt(A-2*S*Math.sin(E))/S;return{x:z*Math.sin(b*S),y:z*Math.cos(b*S)-D,z:0}},unproject(g,l){this.initializeConstants();const{n:b,c:E,r0:S}=this.constants,A=S+l;let D=Math.atan2(g,Math.abs(A))*Math.sign(A);A*b<0&&(D-=Math.PI*Math.sign(g)*Math.sign(A));const z=pt(this.center[0])*b;D=ri(D,-Math.PI-z,Math.PI-z);const $=xt(D/b)+this.center[0],V=Math.asin(Pt((E-(g*g+A*A)*b*b)/(2*b),-1,1)),Z=Pt(xt(V),-85.051129,io);return new Hi($,Z)},projectTilePoint:(g,l)=>({x:g,y:l,z:0}),locationPoint:(g,l)=>g._coordinatePoint(g.locationCoordinate(l),!1),pixelsPerMeter:(g,l)=>$n(1,g)*l,farthestPixelDistance(g){return Is(g,this.pixelsPerMeter(g.center.lat,g.worldSize))},createTileTransform:(g,l)=>new ks(g,l)};const Ml=1.340264,Sl=-.081106,Al=893e-6,Il=.003796,Qh=Math.sqrt(3)/2;var Hm={name:"equalEarth",center:[0,0],range:[3.5,7],zAxisUnit:"meters",isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project(g,l){l=l/180*Math.PI,g=g/180*Math.PI;const b=Math.asin(Qh*Math.sin(l)),E=b*b,S=E*E*E;return{x:.5*(g*Math.cos(b)/(Qh*(Ml+3*Sl*E+S*(7*Al+9*Il*E)))/Math.PI+.5),y:1-.5*(b*(Ml+Sl*E+S*(Al+Il*E))/Math.PI+1),z:0}},unproject(g,l){g=(2*g-.5)*Math.PI;let b=l=(2*(1-l)-1)*Math.PI,E=b*b,S=E*E*E;for(let V,Z,X,Y=0;Y<12&&(Z=b*(Ml+Sl*E+S*(Al+Il*E))-l,X=Ml+3*Sl*E+S*(7*Al+9*Il*E),V=Z/X,b=Pt(b-V,-Math.PI/3,Math.PI/3),E=b*b,S=E*E*E,!(Math.abs(V)<1e-12));++Y);const A=Qh*g*(Ml+3*Sl*E+S*(7*Al+9*Il*E))/Math.cos(b),D=Math.asin(Math.sin(b)/Qh),z=Pt(180*A/Math.PI,-180,180),$=Pt(180*D/Math.PI,-85.051129,io);return new Hi(z,$)},projectTilePoint:(g,l)=>({x:g,y:l,z:0}),locationPoint:(g,l)=>g._coordinatePoint(g.locationCoordinate(l),!1),pixelsPerMeter:(g,l)=>$n(1,g)*l,farthestPixelDistance(g){return Is(g,this.pixelsPerMeter(g.center.lat,g.worldSize))},createTileTransform:(g,l)=>new ks(g,l)},Wm={name:"equirectangular",supportsWorldCopies:!0,center:[0,0],range:[3.5,7],zAxisUnit:"meters",wrap:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project:(g,l)=>({x:.5+g/360,y:.5-l/360,z:0}),unproject(g,l){const b=360*(g-.5),E=Pt(360*(.5-l),-85.051129,io);return new Hi(b,E)},projectTilePoint:(g,l)=>({x:g,y:l,z:0}),locationPoint:(g,l)=>g._coordinatePoint(g.locationCoordinate(l),!1),pixelsPerMeter:(g,l)=>$n(1,g)*l,farthestPixelDistance(g){return Is(g,this.pixelsPerMeter(g.center.lat,g.worldSize))},createTileTransform:(g,l)=>new ks(g,l)};const Da=Math.PI/2;function ec(g){return Math.tan((Da+g)/2)}var Km={name:"lambertConformalConic",range:[3.5,7],zAxisUnit:"meters",center:[0,30],parallels:[30,30],conic:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],initializeConstants(){if(this.constants&&yi(this.parallels,this.constants.parallels))return;const g=pt(this.parallels[0]),l=pt(this.parallels[1]),b=Math.cos(g),E=g===l?Math.sin(g):Math.log(b/Math.cos(l))/Math.log(ec(l)/ec(g)),S=b*Math.pow(ec(g),E)/E;this.constants={n:E,f:S,parallels:this.parallels}},project(g,l){this.initializeConstants(),l=pt(l),g=pt(g-this.center[0]);const b=1e-6,{n:E,f:S}=this.constants;S>0?l<-Da+b&&(l=-Da+b):l>Da-b&&(l=Da-b);const A=S/Math.pow(ec(l),E),D=A*Math.sin(E*g),z=S-A*Math.cos(E*g);return{x:.5*(D/Math.PI+.5),y:1-.5*(z/Math.PI+.5),z:0}},unproject(g,l){this.initializeConstants(),g=(2*g-.5)*Math.PI,l=(2*(1-l)-.5)*Math.PI;const{n:b,f:E}=this.constants,S=E-l,A=Math.sign(S),D=Math.sign(b)*Math.sqrt(g*g+S*S);let z=Math.atan2(g,Math.abs(S))*A;S*b<0&&(z-=Math.PI*Math.sign(g)*A);const $=Pt(xt(z/b)+this.center[0],-180,180),V=Pt(xt(2*Math.atan(Math.pow(E/D,1/b))-Da),-85.051129,io);return new Hi($,V)},projectTilePoint:(g,l)=>({x:g,y:l,z:0}),locationPoint:(g,l)=>g._coordinatePoint(g.locationCoordinate(l),!1),pixelsPerMeter:(g,l)=>$n(1,g)*l,farthestPixelDistance(g){return Is(g,this.pixelsPerMeter(g.center.lat,g.worldSize))},createTileTransform:(g,l)=>new ks(g,l)},Jm={name:"mercator",wrap:!0,requiresDraping:!1,supportsWorldCopies:!0,supportsTerrain:!0,supportsFog:!0,supportsFreeCamera:!0,zAxisUnit:"meters",center:[0,0],project:(g,l)=>({x:_a(g),y:ya(l),z:0}),unproject(g,l){const b=_o(g),E=kn(l);return new Hi(b,E)},projectTilePoint:(g,l)=>({x:g,y:l,z:0}),locationPoint:(g,l)=>g._coordinatePoint(g.locationCoordinate(l),!1),pixelsPerMeter:(g,l)=>$n(1,g)*l,farthestPixelDistance(g){return Is(g,this.pixelsPerMeter(g.center.lat,g.worldSize))},createTileTransform:(g,l)=>new ks(g,l)};const Mf=pt(io);var Qm={name:"naturalEarth",center:[0,0],range:[3.5,7],isReprojectedInTileSpace:!0,zAxisUnit:"meters",unsupportedLayers:["custom"],project(g,l){const b=(l=pt(l))*l,E=b*b;return{x:.5*((g=pt(g))*(.8707-.131979*b+E*(E*(.003971*b-.001529*E)-.013791))/Math.PI+.5),y:1-.5*(l*(1.007226+b*(.015085+E*(.028874*b-.044475-.005916*E)))/Math.PI+1),z:0}},unproject(g,l){g=(2*g-.5)*Math.PI;let b=l=(2*(1-l)-1)*Math.PI,E=25,S=0,A=b*b;do{A=b*b;const $=A*A;S=(b*(1.007226+A*(.015085+$*(.028874*A-.044475-.005916*$)))-l)/(1.007226+A*(.045255+$*(.259866*A-.311325-.005916*11*$))),b=Pt(b-S,-Mf,Mf)}while(Math.abs(S)>1e-6&&--E>0);A=b*b;const D=Pt(xt(g/(.8707+A*(A*(A*A*A*(.003971-.001529*A)-.013791)-.131979))),-180,180),z=xt(b);return new Hi(D,z)},projectTilePoint:(g,l)=>({x:g,y:l,z:0}),locationPoint:(g,l)=>g._coordinatePoint(g.locationCoordinate(l),!1),pixelsPerMeter:(g,l)=>$n(1,g)*l,farthestPixelDistance(g){return Is(g,this.pixelsPerMeter(g.center.lat,g.worldSize))},createTileTransform:(g,l)=>new ks(g,l)};const Sf=pt(io),Af={albers:Ym,equalEarth:Hm,equirectangular:Wm,lambertConformalConic:Km,mercator:Jm,naturalEarth:Qm,winkelTripel:{name:"winkelTripel",center:[0,0],range:[3.5,7],zAxisUnit:"meters",isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project(g,l){l=pt(l),g=pt(g);const b=Math.cos(l),E=2/Math.PI,S=Math.acos(b*Math.cos(g/2)),A=Math.sin(S)/S,D=.5*(g*E+2*b*Math.sin(g/2)/A)||0,z=.5*(l+Math.sin(l)/A)||0;return{x:.5*(D/Math.PI+.5),y:1-.5*(z/Math.PI+1),z:0}},unproject(g,l){let b=g=(2*g-.5)*Math.PI,E=l=(2*(1-l)-1)*Math.PI,S=25;const A=1e-6;let D=0,z=0;do{const $=Math.cos(E),V=Math.sin(E),Z=2*V*$,X=V*V,Y=$*$,ie=Math.cos(b/2),ce=Math.sin(b/2),pe=2*ie*ce,ve=ce*ce,Ae=1-Y*ie*ie,Be=Ae?1/Ae:0,$e=Ae?Math.acos($*ie)*Math.sqrt(1/Ae):0,Ve=.5*(2*$e*$*ce+2*b/Math.PI)-g,Ge=.5*($e*V+E)-l,Xe=.5*Be*(Y*ve+$e*$*ie*X)+1/Math.PI,nt=Be*(pe*Z/4-$e*V*ce),it=.125*Be*(Z*ce-$e*V*Y*pe),bt=.5*Be*(X*ie+$e*ve*$)+.5,mt=nt*it-bt*Xe;D=(Ge*nt-Ve*bt)/mt,z=(Ve*it-Ge*Xe)/mt,b=Pt(b-D,-Math.PI,Math.PI),E=Pt(E-z,-Sf,Sf)}while((Math.abs(D)>A||Math.abs(z)>A)&&--S>0);return new Hi(xt(b),xt(E))},projectTilePoint:(g,l)=>({x:g,y:l,z:0}),locationPoint:(g,l)=>g._coordinatePoint(g.locationCoordinate(l),!1),pixelsPerMeter:(g,l)=>$n(1,g)*l,farthestPixelDistance(g){return Is(g,this.pixelsPerMeter(g.center.lat,g.worldSize))},createTileTransform:(g,l)=>new ks(g,l)}};x.ARRAY_TYPE=te,x.AUTH_ERR_MSG=qe,x.Aabb=Un,x.Actor=class{constructor(g,l,b){this.target=g,this.parent=l,this.mapId=b,this.callbacks={},this.cancelCallbacks={},Ei(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=fr()?g:j,this.scheduler=new Om}send(g,l,b,E,S=!1,A){const D=Math.round(1e18*Math.random()).toString(36).substring(0,10);b&&(b.metadata=A,this.callbacks[D]=b);const z=Mr(this.globalScope)?void 0:[];return this.target.postMessage({id:D,type:g,hasCallback:!!b,targetMapId:E,mustQueue:S,sourceMapId:this.mapId,data:bs(l,z)},z),{cancel:()=>{b&&delete this.callbacks[D],this.target.postMessage({id:D,type:"<cancel>",targetMapId:E,sourceMapId:this.mapId})}}}receive(g){const l=g.data,b=l.id;if(b&&(!l.targetMapId||this.mapId===l.targetMapId))if(l.type==="<cancel>"){const E=this.cancelCallbacks[b];delete this.cancelCallbacks[b],E&&E.cancel()}else if(l.mustQueue||fr()){const E=this.callbacks[b];this.cancelCallbacks[b]=this.scheduler.add(()=>this.processTask(b,l),E&&E.metadata||{type:"message"})}else this.processTask(b,l)}processTask(g,l){if(l.type==="<response>"){const b=this.callbacks[g];delete this.callbacks[g],b&&(l.error?b(eo(l.error)):b(null,eo(l.data)))}else{const b=Mr(this.globalScope)?void 0:[],E=l.hasCallback?(A,D)=>{delete this.cancelCallbacks[g],this.target.postMessage({id:g,type:"<response>",sourceMapId:this.mapId,error:A?bs(A):null,data:bs(D,b)},b)}:A=>{},S=eo(l.data);if(this.parent[l.type])this.parent[l.type](l.sourceMapId,S,E);else if(this.parent.getWorkerSource){const A=l.type.split(".");this.parent.getWorkerSource(l.sourceMapId,A[0],S.source)[A[1]](S,E)}else E(new Error(`Could not find function ${l.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},x.CanonicalTileID=Xh,x.Color=Fi,x.ColorMode=no,x.CullFaceMode=Nn,x.DEMData=Yh,x.DataConstantProperty=Ot,x.DedupedRequest=Ef,x.DepthMode=ka,x.EXTENT=Mi,x.Elevation=class{getAtPointOrZero(g,l=0){return this.getAtPoint(g,l)||0}getAtPoint(g,l,b=!0){l==null&&(l=null);const E=this._source();if(!E||g.y<0||g.y>1)return l;const S=E.getSource().maxzoom,A=1<<S,D=Math.floor(g.x),z=g.x-D,$=new tn(S,D,S,Math.floor(z*A),Math.floor(g.y*A)),V=this.findDEMTileFor($);if(!V||!V.dem)return l;const Z=V.dem,X=1<<V.tileID.canonical.z,Y=(z*X-V.tileID.canonical.x)*Z.dim,ie=(g.y*X-V.tileID.canonical.y)*Z.dim,ce=Math.floor(Y),pe=Math.floor(ie);return(b?this.exaggeration():1)*ji(ji(Z.get(ce,pe),Z.get(ce,pe+1),ie-pe),ji(Z.get(ce+1,pe),Z.get(ce+1,pe+1),ie-pe),Y-ce)}getAtTileOffset(g,l,b){const E=1<<g.canonical.z;return this.getAtPointOrZero(new Sh(g.wrap+(g.canonical.x+l/Mi)/E,(g.canonical.y+b/Mi)/E))}getAtTileOffsetFunc(g,l){return b=>{const E=this.getAtTileOffset(g,b.x,b.y),S=l.upVector(g.canonical,b.x,b.y);return Rt(S,S,E*l.upVectorScale(g.canonical)),S}}getForTilePoints(g,l,b,E){const S=Hh.create(this,g,E);return!!S&&(l.forEach(A=>{A[2]=this.exaggeration()*S.getElevationAt(A[0],A[1],b)}),!0)}getMinMaxForTile(g){const l=this.findDEMTileFor(g);if(!l||!l.dem)return null;const b=l.dem.tree,E=l.tileID,S=1<<g.canonical.z-E.canonical.z;let A=g.canonical.x/S-E.canonical.x,D=g.canonical.y/S-E.canonical.y,z=0;for(let $=0;$<g.canonical.z-E.canonical.z&&!b.leaves[z];$++){A*=2,D*=2;const V=2*Math.floor(D)+Math.floor(A);z=b.childOffsets[z]+V,A%=1,D%=1}return{min:this.exaggeration()*b.minimums[z],max:this.exaggeration()*b.maximums[z]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(g,l,b){throw new Error("Pure virtual method called.")}pointCoordinate(g){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(g){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},x.ErrorEvent=Ls,x.EvaluationParameters=ui,x.Event=Gn,x.Evented=qn,x.Frustum=Bc,x.GLOBE_ZOOM_THRESHOLD_MAX=6,x.GlobeSharedBuffers=_u,x.GlyphManager=Aa,x.ImagePosition=Yc,x.LineAtlas=au,x.LngLat=Hi,x.LngLatBounds=Ts,x.LocalGlyphMode=Jc,x.MAX_MERCATOR_LATITUDE=io,x.MercatorCoordinate=Sh,x.ONE_EM=Ur,x.OverscaledTileID=tn,x.Properties=Fr,x.RGBAImage=bn,x.Ray=class{constructor(g,l){this.pos=g,this.dir=l}intersectsPlane(g,l,b){const E=Nt(l,this.dir);if(Math.abs(E)<1e-6)return!1;const S=((g[0]-this.pos[0])*l[0]+(g[1]-this.pos[1])*l[1]+(g[2]-this.pos[2])*l[2])/E;return b[0]=this.pos[0]+this.dir[0]*S,b[1]=this.pos[1]+this.dir[1]*S,b[2]=this.pos[2]+this.dir[2]*S,!0}closestPointOnSphere(g,l,b){if(function(Y,ie){var ce=Y[0],pe=Y[1],ve=Y[2],Ae=ie[0],Be=ie[1],$e=ie[2];return Math.abs(ce-Ae)<=H*Math.max(1,Math.abs(ce),Math.abs(Ae))&&Math.abs(pe-Be)<=H*Math.max(1,Math.abs(pe),Math.abs(Be))&&Math.abs(ve-$e)<=H*Math.max(1,Math.abs(ve),Math.abs($e))}(this.pos,g)||l===0)return b[0]=b[1]=b[2]=0,!1;const[E,S,A]=this.dir,D=this.pos[0]-g[0],z=this.pos[1]-g[1],$=this.pos[2]-g[2],V=E*E+S*S+A*A,Z=2*(D*E+z*S+$*A),X=Z*Z-4*V*(D*D+z*z+$*$-l*l);if(X<0){const Y=Math.max(-Z/2,0),ie=D+E*Y,ce=z+S*Y,pe=$+A*Y,ve=Math.hypot(ie,ce,pe);return b[0]=ie*l/ve,b[1]=ce*l/ve,b[2]=pe*l/ve,!1}{const Y=(-Z-Math.sqrt(X))/(2*V);if(Y<0){const ie=Math.hypot(D,z,$);return b[0]=D*l/ie,b[1]=z*l/ie,b[2]=$*l/ie,!1}return b[0]=D+E*Y,b[1]=z+S*Y,b[2]=$+A*Y,!0}}},x.RequestManager=class{constructor(g,l,b){this._transformRequestFn=g,this._customAccessToken=l,this._silenceAuthErrors=!!b,this._createSkuToken()}_createSkuToken(){const g=function(){let l="";for(let b=0;b<10;b++)l+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Oe,l].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=g.token,this._skuTokenExpiresAt=g.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(g,l){return this._transformRequestFn&&this._transformRequestFn(g,l)||{url:g}}normalizeStyleURL(g,l){if(!Je(g))return g;const b=kt(g);return b.path=`/styles/v1${b.path}`,this._makeAPIURL(b,this._customAccessToken||l)}normalizeGlyphsURL(g,l){if(!Je(g))return g;const b=kt(g);return b.path=`/fonts/v1${b.path}`,this._makeAPIURL(b,this._customAccessToken||l)}normalizeSourceURL(g,l){if(!Je(g))return g;const b=kt(g);return b.path=`/v4/${b.authority}.json`,b.params.push("secure"),this._makeAPIURL(b,this._customAccessToken||l)}normalizeSpriteURL(g,l,b,E){const S=kt(g);return Je(g)?(S.path=`/styles/v1${S.path}/sprite${l}${b}`,this._makeAPIURL(S,this._customAccessToken||E)):(S.path+=`${l}${b}`,jt(S))}normalizeTileURL(g,l,b){if(this._isSkuTokenExpired()&&this._createSkuToken(),g&&!Je(g))return g;const E=kt(g);E.path=E.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${l||b&&E.authority!=="raster"&&b===512?"@2x":""}${re.supported?".webp":"$1"}`),E.authority==="raster"?E.path=`/${K.RASTER_URL_PREFIX}${E.path}`:(E.path=E.path.replace(/^.+\/v4\//,"/"),E.path=`/${K.TILE_URL_VERSION}${E.path}`);const S=this._customAccessToken||function(A){for(const D of A){const z=D.match(/^access_token=(.*)$/);if(z)return z[1]}return null}(E.params)||K.ACCESS_TOKEN;return K.REQUIRE_ACCESS_TOKEN&&S&&this._skuToken&&E.params.push(`sku=${this._skuToken}`),this._makeAPIURL(E,S)}canonicalizeTileURL(g,l){const b=kt(g);if(!b.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!b.path.match(/\.[\w]+$/))return g;let E="mapbox://";b.path.match(/^\/raster\/v1\//)?E+=`raster/${b.path.replace(`/${K.RASTER_URL_PREFIX}/`,"")}`:E+=`tiles/${b.path.replace(`/${K.TILE_URL_VERSION}/`,"")}`;let S=b.params;return l&&(S=S.filter(A=>!A.match(/^access_token=/))),S.length&&(E+=`?${S.join("&")}`),E}canonicalizeTileset(g,l){const b=!!l&&Je(l),E=[];for(const S of g.tiles||[])Qe(S)?E.push(this.canonicalizeTileURL(S,b)):E.push(S);return E}_makeAPIURL(g,l){const b="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",E=kt(K.API_URL);if(g.protocol=E.protocol,g.authority=E.authority,g.protocol==="http"){const S=g.params.indexOf("secure");S>=0&&g.params.splice(S,1)}if(E.path!=="/"&&(g.path=`${E.path}${g.path}`),!K.REQUIRE_ACCESS_TOKEN)return jt(g);if(l=l||K.ACCESS_TOKEN,!this._silenceAuthErrors){if(!l)throw new Error(`An API access token is required to use Mapbox GL. ${b}`);if(l[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${b}`)}return g.params=g.params.filter(S=>S.indexOf("access_token")===-1),g.params.push(`access_token=${l||""}`),jt(g)}},x.ResourceType=Rs,x.SegmentVector=gr,x.SourceCache=As,x.StencilMode=cu,x.StructArrayLayout1ui2=vh,x.StructArrayLayout2f1f2i16=xc,x.StructArrayLayout2i4=fa,x.StructArrayLayout2ui4=Oo,x.StructArrayLayout3f12=ma,x.StructArrayLayout3ui6=vn,x.StructArrayLayout4i8=pa,x.Texture=Zh,x.Tile=pu,x.Transitionable=Qr,x.Uniform1f=Th,x.Uniform1i=class extends po{constructor(g,l){super(g,l),this.current=0}set(g){this.current!==g&&(this.current=g,this.gl.uniform1i(this.location,g))}},x.Uniform2f=class extends po{constructor(g,l){super(g,l),this.current=[0,0]}set(g){g[0]===this.current[0]&&g[1]===this.current[1]||(this.current=g,this.gl.uniform2f(this.location,g[0],g[1]))}},x.Uniform3f=class extends po{constructor(g,l){super(g,l),this.current=[0,0,0]}set(g){g[0]===this.current[0]&&g[1]===this.current[1]&&g[2]===this.current[2]||(this.current=g,this.gl.uniform3f(this.location,g[0],g[1],g[2]))}},x.Uniform4f=Nu,x.UniformColor=Vu,x.UniformMatrix2f=class extends po{constructor(g,l){super(g,l),this.current=Gf}set(g){for(let l=0;l<4;l++)if(g[l]!==this.current[l]){this.current=g,this.gl.uniformMatrix2fv(this.location,!1,g);break}}},x.UniformMatrix3f=class extends po{constructor(g,l){super(g,l),this.current=jf}set(g){for(let l=0;l<9;l++)if(g[l]!==this.current[l]){this.current=g,this.gl.uniformMatrix3fv(this.location,!1,g);break}}},x.UniformMatrix4f=class extends po{constructor(g,l){super(g,l),this.current=Vf}set(g){if(g[12]!==this.current[12]||g[0]!==this.current[0])return this.current=g,void this.gl.uniformMatrix4fv(this.location,!1,g);for(let l=1;l<16;l++)if(g[l]!==this.current[l]){this.current=g,this.gl.uniformMatrix4fv(this.location,!1,g);break}}},x.UnwrappedTileID=lu,x.ValidationError=Dt,x.VectorTileWorkerSource=class extends qn{constructor(g,l,b,E,S){super(),this.actor=g,this.layerIndex=l,this.availableImages=b,this.loadVectorData=S||Tf,this.loading={},this.loaded={},this.deduped=new Ef(g.scheduler),this.isSpriteLoaded=E,this.scheduler=g.scheduler}loadTile(g,l){const b=g.uid,E=g&&g.request,S=E&&E.collectResourceTiming,A=this.loading[b]=new Zm(g);A.abort=this.loadVectorData(g,(D,z)=>{const $=!this.loading[b];if(delete this.loading[b],$||D||!z)return A.status="done",$||(this.loaded[b]=A),l(D);const V=z.rawData,Z={};z.expires&&(Z.expires=z.expires),z.cacheControl&&(Z.cacheControl=z.cacheControl),A.vectorTile=z.vectorTile||new Ss.VectorTile(new bl(V));const X=()=>{A.parse(A.vectorTile,this.layerIndex,this.availableImages,this.actor,(Y,ie)=>{if(Y||!ie)return l(Y);const ce={};if(S){const pe=Jd(E);pe.length>0&&(ce.resourceTiming=JSON.parse(JSON.stringify(pe)))}l(null,Wt({rawTileData:V.slice(0)},ie,Z,ce))})};this.isSpriteLoaded?X():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(X,{type:"parseTile",isSymbolTile:g.isSymbolTile,zoom:g.tileZoom}):X()}),this.loaded=this.loaded||{},this.loaded[b]=A})}reloadTile(g,l){const b=this.loaded,E=g.uid,S=this;if(b&&b[E]){const A=b[E];A.showCollisionBoxes=g.showCollisionBoxes,A.enableTerrain=!!g.enableTerrain,A.projection=g.projection;const D=(z,$)=>{const V=A.reloadCallback;V&&(delete A.reloadCallback,A.parse(A.vectorTile,S.layerIndex,this.availableImages,S.actor,V)),l(z,$)};A.status==="parsing"?A.reloadCallback=D:A.status==="done"&&(A.vectorTile?A.parse(A.vectorTile,this.layerIndex,this.availableImages,this.actor,D):D())}}abortTile(g,l){const b=g.uid,E=this.loading[b];E&&(E.abort&&E.abort(),delete this.loading[b]),l()}removeTile(g,l){const b=this.loaded,E=g.uid;b&&b[E]&&delete b[E],l()}},x.WritingMode=wn,x.ZoomHistory=I,x.add=Le,x.addDynamicAttributes=iu,x.adjoint=function(g,l){var b=l[0],E=l[1],S=l[2],A=l[3],D=l[4],z=l[5],$=l[6],V=l[7],Z=l[8];return g[0]=D*Z-z*V,g[1]=S*V-E*Z,g[2]=E*z-S*D,g[3]=z*$-A*Z,g[4]=b*Z-S*$,g[5]=S*A-b*z,g[6]=A*V-D*$,g[7]=E*$-b*V,g[8]=b*D-E*A,g},x.asyncAll=vt,x.bezier=He,x.bindAll=Ei,x.boundsAttributes=fu,x.bufferConvexPolygon=function(g,l){const b=[];for(let E=0;E<g.length;E++){const S=ri(E-1,-1,g.length-1),A=ri(E+1,-1,g.length-1),D=g[E],z=g[A],$=g[S].sub(D).unit(),V=z.sub(D).unit(),Z=V.angleWithSep($.x,$.y),X=$.add(V).unit().mult(-1*l/Math.sin(Z/2));b.push(D.add(X))}return b},x.cacheEntryPossiblyAdded=function(g){Ps++,Ps>Ra&&(g.getActor().send("enforceCacheSizeLimit",Pl),Ps=0)},x.calculateGlobeMatrix=bf,x.calculateGlobeMercatorMatrix=function(g){const l=g.worldSize,b=Pt(g.center.lat,-85.051129,io),E=new U(_a(g.center.lng)*l,ya(b)*l),S=$n(1,g.center.lat)*l,A=g.pixelsPerMeter,D=l/(S/g.pixelsPerMeter),z=Q(new Float64Array(16));return se(z,z,[E.x,E.y,0]),le(z,z,[D,D,A]),z},x.clamp=Pt,x.clearTileCache=function(g){const l=j.caches.delete(Lr);g&&l.catch(g).then(()=>g())},x.clipLine=$d,x.clone=function(g){var l=new te(16);return l[0]=g[0],l[1]=g[1],l[2]=g[2],l[3]=g[3],l[4]=g[4],l[5]=g[5],l[6]=g[6],l[7]=g[7],l[8]=g[8],l[9]=g[9],l[10]=g[10],l[11]=g[11],l[12]=g[12],l[13]=g[13],l[14]=g[14],l[15]=g[15],l},x.clone$1=Si,x.collisionCircleLayout=Wp,x.config=K,x.conjugate=function(g,l){return g[0]=-l[0],g[1]=-l[1],g[2]=-l[2],g[3]=l[3],g},x.create=function(){var g=new te(16);return te!=Float32Array&&(g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=0,g[12]=0,g[13]=0,g[14]=0),g[0]=1,g[5]=1,g[10]=1,g[15]=1,g},x.create$1=oe,x.createExpression=ps,x.createLayout=ar,x.createStyleLayer=function(g){return g.type==="custom"?new Rm(g):new Lm[g.type](g)},x.cross=zt,x.degToRad=pt,x.div=function(g,l,b){return g[0]=l[0]/b[0],g[1]=l[1]/b[1],g[2]=l[2]/b[2],g},x.dot=Nt,x.ease=Ht,x.easeCubicInOut=oi,x.emitValidationErrors=mh,x.endsWith=Qt,x.enforceCacheSizeLimit=function(g){Yo(),En&&En.then(l=>{l.keys().then(b=>{for(let E=0;E<b.length-g;E++)l.delete(b[E])})})},x.evaluateSizeForFeature=zh,x.evaluateSizeForZoom=Ea,x.evaluateVariableOffset=Gd,x.evented=Yr,x.exactEquals=function(g,l){return g[0]===l[0]&&g[1]===l[1]&&g[2]===l[2]&&g[3]===l[3]},x.exactEquals$1=function(g,l){return g[0]===l[0]&&g[1]===l[1]&&g[2]===l[2]},x.exported=je,x.exported$1=re,x.extend=Wt,x.extend$1=Zn,x.filterObject=$i,x.fromMat4=function(g,l){return g[0]=l[0],g[1]=l[1],g[2]=l[2],g[3]=l[4],g[4]=l[5],g[5]=l[6],g[6]=l[8],g[7]=l[9],g[8]=l[10],g},x.fromQuat=function(g,l){var b=l[0],E=l[1],S=l[2],A=l[3],D=b+b,z=E+E,$=S+S,V=b*D,Z=E*D,X=E*z,Y=S*D,ie=S*z,ce=S*$,pe=A*D,ve=A*z,Ae=A*$;return g[0]=1-X-ce,g[1]=Z+Ae,g[2]=Y-ve,g[3]=0,g[4]=Z-Ae,g[5]=1-V-ce,g[6]=ie+pe,g[7]=0,g[8]=Y+ve,g[9]=ie-pe,g[10]=1-V-X,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g},x.fromRotation=function(g,l){var b=Math.sin(l),E=Math.cos(l);return g[0]=E,g[1]=b,g[2]=0,g[3]=-b,g[4]=E,g[5]=0,g[6]=0,g[7]=0,g[8]=1,g},x.fromScaling=function(g,l){return g[0]=l[0],g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=l[1],g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=l[2],g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g},x.furthestTileCorner=function(g){const l=Math.round((g+45+360)%360/90)%4;return fi[l]},x.getAABBPointSquareDist=function(g,l,b){let E=0;for(let S=0;S<2;++S){const A=b?b[S]:0;g[S]>A&&(E+=(g[S]-A)*(g[S]-A)),l[S]<A&&(E+=(A-l[S])*(A-l[S]))}return E},x.getAnchorAlignment=Kc,x.getAnchorJustification=eu,x.getBounds=function(g){let l=1/0,b=1/0,E=-1/0,S=-1/0;for(const A of g)l=Math.min(l,A.x),b=Math.min(b,A.y),E=Math.max(E,A.x),S=Math.max(S,A.y);return{min:new U(l,b),max:new U(E,S)}},x.getColumn=function(g,l){return[g[4*l],g[4*l+1],g[4*l+2],g[4*l+3]]},x.getImage=Bl,x.getJSON=function(g,l){return mn(Wt(g,{type:"json"}),l)},x.getMapSessionAPI=jn,x.getPerformanceMeasurement=Jd,x.getProjection=function(g){const l=Af[g.name];if(!l)throw new Error(`Invalid projection name: ${g.name}`);return l.conic?function(b,E){if(E.parallels&&Math.abs(E.parallels[0]+E.parallels[1])<.01){let S=function(A){const D=Math.max(.01,Math.cos(pt(A))),z=1/(2*Math.max(Math.PI*D,1/D));return{wrap:!0,supportsWorldCopies:!0,unsupportedLayers:["custom"],project($,V){const Z=pt($)*D,X=Math.sin(pt(V))/D;return{x:Z*z+.5,y:-X*z+.5,z:0}},unproject($,V){const Z=-(V-.5)/z,X=Pt(xt(($-.5)/z)/D,-180,180),Y=Math.asin(Pt(Z*D,-1,1)),ie=Pt(xt(Y),-85.051129,io);return new Hi(X,ie)}}}(E.parallels[0]);if(E.name==="lambertConformalConic"){const{project:A,unproject:D}=Af.mercator;S={wrap:!0,supportsWorldCopies:!0,project:A,unproject:D}}return Wt({},b,E,S)}return Wt({},b,E)}(l,g):l},x.getRTLTextPluginStatus=cn,x.getReferrer=La,x.getTilePoint=function(g,{x:l,y:b},E=0){return new U(((l-E)*g.scale-g.x)*Mi,(b*g.scale-g.y)*Mi)},x.getTileVec3=function(g,l,b=0){return ge(((l.x-b)*g.scale-g.x)*Mi,(l.y*g.scale-g.y)*Mi,Xu(l.z,l.y))},x.getVideo=function(g,l){const b=j.document.createElement("video");b.muted=!0,b.onloadstart=function(){l(null,b)};for(let E=0;E<g.length;E++){const S=j.document.createElement("source");Rl(g[E])||(b.crossOrigin="Anonymous"),S.src=g[E],b.appendChild(S)}return{cancel:()=>{}}},x.globeBuffersForTileMesh=function(g,l,b,E){const S=g.context,A=g.transform;let D=l.globeGridBuffer,z=l.globePoleBuffer;if(!D){const $=_u.createGridVertices(b.canonical);D=l.globeGridBuffer=S.createVertexBuffer($,_f,!1)}if(!z){const $=_u.createPoleTriangleVertices(E,A.tileSize*E,b.canonical.y===0);z=l.globePoleBuffer=S.createVertexBuffer($,_f,!1)}return[D,z]},x.globeDenormalizeECEF=vf,x.globeMatrixForTile=function(g,l){const b=vf(Kh(g)),E=((S=new Float64Array(16))[0]=(A=l)[0],S[1]=A[1],S[2]=A[2],S[3]=A[3],S[4]=A[4],S[5]=A[5],S[6]=A[6],S[7]=A[7],S[8]=A[8],S[9]=A[9],S[10]=A[10],S[11]=A[11],S[12]=A[12],S[13]=A[13],S[14]=A[14],S[15]=A[15],S);var S,A;return xe(E,E,b),E},x.globePoleMatrixForTile=function(g,l,b){const E=Q(new Float64Array(16)),S=Math.pow(2,g.z),A=(g.x-S/2)/S*Math.PI*2,D=b.point,z=b.worldSize/(b.tileSize*S);return se(E,E,[D.x,D.y,-b.worldSize/Math.PI/2]),le(E,E,[z,z,z]),me(E,E,pt(-b._center.lat)),Re(E,E,pt(-b._center.lng)),Re(E,E,A),l&&le(E,E,[1,-1,1]),E},x.globeTileBounds=Kh,x.globeToMercatorTransition=function(g){return ei(5,6,g)},x.identity=Q,x.identity$1=ni,x.invert=function(g,l){var b=l[0],E=l[1],S=l[2],A=l[3],D=l[4],z=l[5],$=l[6],V=l[7],Z=l[8],X=l[9],Y=l[10],ie=l[11],ce=l[12],pe=l[13],ve=l[14],Ae=l[15],Be=b*z-E*D,$e=b*$-S*D,Ve=b*V-A*D,Ge=E*$-S*z,Xe=E*V-A*z,nt=S*V-A*$,it=Z*pe-X*ce,bt=Z*ve-Y*ce,mt=Z*Ae-ie*ce,rt=X*ve-Y*pe,gt=X*Ae-ie*pe,Et=Y*Ae-ie*ve,lt=Be*Et-$e*gt+Ve*rt+Ge*mt-Xe*bt+nt*it;return lt?(g[0]=(z*Et-$*gt+V*rt)*(lt=1/lt),g[1]=(S*gt-E*Et-A*rt)*lt,g[2]=(pe*nt-ve*Xe+Ae*Ge)*lt,g[3]=(Y*Xe-X*nt-ie*Ge)*lt,g[4]=($*mt-D*Et-V*bt)*lt,g[5]=(b*Et-S*mt+A*bt)*lt,g[6]=(ve*Ve-ce*nt-Ae*$e)*lt,g[7]=(Z*nt-Y*Ve+ie*$e)*lt,g[8]=(D*gt-z*mt+V*it)*lt,g[9]=(E*mt-b*gt-A*it)*lt,g[10]=(ce*Xe-pe*Ve+Ae*Be)*lt,g[11]=(X*Ve-Z*Xe-ie*Be)*lt,g[12]=(z*bt-D*rt-$*it)*lt,g[13]=(b*rt-E*bt+S*it)*lt,g[14]=(pe*$e-ce*Ge-ve*Be)*lt,g[15]=(Z*Ge-X*$e+Y*Be)*lt,g):null},x.isMapAuthenticated=function(g){return Pn.has(g)},x.isMapboxURL=Je,x.latFromMercatorY=kn,x.len=Ut,x.length=he,x.length$1=function(g){return Math.hypot(g[0],g[1],g[2],g[3])},x.loadVectorTile=Tf,x.makeRequest=mn,x.mercatorXfromLng=_a,x.mercatorYfromLat=ya,x.mercatorZfromAltitude=$n,x.mul=xe,x.mul$1=wt,x.multiply=function(g,l,b){var E=l[0],S=l[1],A=l[2],D=l[3],z=l[4],$=l[5],V=l[6],Z=l[7],X=l[8],Y=b[0],ie=b[1],ce=b[2],pe=b[3],ve=b[4],Ae=b[5],Be=b[6],$e=b[7],Ve=b[8];return g[0]=Y*E+ie*D+ce*V,g[1]=Y*S+ie*z+ce*Z,g[2]=Y*A+ie*$+ce*X,g[3]=pe*E+ve*D+Ae*V,g[4]=pe*S+ve*z+Ae*Z,g[5]=pe*A+ve*$+Ae*X,g[6]=Be*E+$e*D+Ve*V,g[7]=Be*S+$e*z+Ve*Z,g[8]=Be*A+$e*$+Ve*X,g},x.multiply$1=_e,x.multiply$2=st,x.nextPowerOfTwo=hi,x.normalize=At,x.normalize$1=function(g,l){var b=l[0],E=l[1],S=l[2],A=l[3],D=b*b+E*E+S*S+A*A;return D>0&&(D=1/Math.sqrt(D)),g[0]=b*D,g[1]=E*D,g[2]=S*D,g[3]=A*D,g},x.number=ji,x.ortho=function(g,l,b,E,S,A,D){var z=1/(l-b),$=1/(E-S),V=1/(A-D);return g[0]=-2*z,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=-2*$,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=2*V,g[11]=0,g[12]=(l+b)*z,g[13]=(S+E)*$,g[14]=(D+A)*V,g[15]=1,g},x.pbf=bl,x.perspective=function(g,l,b,E,S){var A,D=1/Math.tan(l/2);return g[0]=D/b,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,S!=null&&S!==1/0?(g[10]=(S+E)*(A=1/(E-S)),g[14]=2*S*E*A):(g[10]=-1,g[14]=-2*E),g},x.pick=function(g,l){const b={};for(let E=0;E<l.length;E++){const S=l[E];S in g&&(b[S]=g[S])}return b},x.plugin=Bi,x.pointGeometry=U,x.polygonIntersectsBox=Qu,x.polygonIntersectsPolygon=Hu,x.polygonizeBounds=function(g,l,b=0,E=!0){const S=new U(b,b),A=g.sub(S),D=l.add(S),z=[A,new U(D.x,A.y),D,new U(A.x,D.y)];return E&&z.push(A),z},x.posAttributes=Vm,x.postMapLoadEvent=Gi,x.postTurnstileEvent=Xi,x.potpack=Xc,x.prevPowerOfTwo=function(g){return g<=1?1:Math.pow(2,Math.floor(Math.log(g)/Math.LN2))},x.radToDeg=xt,x.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],x.registerForPluginStateChange=function(g){return g({pluginStatus:si,pluginURL:Ti}),Yr.on("pluginStateChange",g),g},x.removeAuthState=function(g){Pn.delete(g)},x.renderColorRamp=Fc,x.rotateX=me,x.rotateX$1=_i,x.rotateY=Re,x.rotateZ=function(g,l,b){var E=Math.sin(b),S=Math.cos(b),A=l[0],D=l[1],z=l[2],$=l[3],V=l[4],Z=l[5],X=l[6],Y=l[7];return l!==g&&(g[8]=l[8],g[9]=l[9],g[10]=l[10],g[11]=l[11],g[12]=l[12],g[13]=l[13],g[14]=l[14],g[15]=l[15]),g[0]=A*S+V*E,g[1]=D*S+Z*E,g[2]=z*S+X*E,g[3]=$*S+Y*E,g[4]=V*S-A*E,g[5]=Z*S-D*E,g[6]=X*S-z*E,g[7]=Y*S-$*E,g},x.rotateZ$1=function(g,l,b){b*=.5;var E=l[0],S=l[1],A=l[2],D=l[3],z=Math.sin(b),$=Math.cos(b);return g[0]=E*$+S*z,g[1]=S*$-E*z,g[2]=A*$+D*z,g[3]=D*$-A*z,g},x.scale=le,x.scale$1=function(g,l,b){return g[0]=l[0]*b,g[1]=l[1]*b,g[2]=l[2]*b,g[3]=l[3]*b,g},x.scale$2=Rt,x.scaleAndAdd=Bt,x.setCacheLimits=function(g,l){Pl=g,Ra=l},x.setColumn=function(g,l,b){g[4*l+0]=b[0],g[4*l+1]=b[1],g[4*l+2]=b[2],g[4*l+3]=b[3]},x.setRTLTextPlugin=function(g,l,b=!1){if(si===Kt||si===ci||si===qi)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ti=je.resolveURL(g),si=Kt,Ji=l,br(),b||xn()},x.smoothstep=ei,x.spec=et,x.storeAuthState=function(g,l){l?Pn.add(g):Pn.delete(g)},x.sub=St,x.subtract=Ze,x.symbolSize=Kp,x.tileAABB=function(g,l,b,E,S,A,D,z,$){if($.name==="globe"){const ie=Kh(new lu(A,new Xh(b,E,S)).canonical).getCorners(),ce=Number.MAX_VALUE,pe=[-ce,-ce,-ce],ve=[ce,ce,ce],Ae=bf(g,l);for(let Be=0;Be<ie.length;Be++)Tt(ie[Be],ie[Be],Ae),Z=ve,X=ie[Be],(V=ve)[0]=Math.min(Z[0],X[0]),V[1]=Math.min(Z[1],X[1]),V[2]=Math.min(Z[2],X[2]),ht(pe,pe,ie[Be]);return new Un(ve,pe)}var V,Z,X;const Y=Ca({z:b,x:E,y:S},$);return new Un([(A+Y.x/Y.scale)*l,l*(Y.y/Y.scale),D],[(A+Y.x2/Y.scale)*l,l*(Y.y2/Y.scale),z])},x.tileTransform=Ca,x.transformMat3=function(g,l,b){var E=l[0],S=l[1],A=l[2];return g[0]=E*b[0]+S*b[3]+A*b[6],g[1]=E*b[1]+S*b[4]+A*b[7],g[2]=E*b[2]+S*b[5]+A*b[8],g},x.transformMat4=Tt,x.transformMat4$1=Vt,x.transformQuat=ii,x.translate=se,x.transpose=function(g,l){if(g===l){var b=l[1],E=l[2],S=l[5];g[1]=l[3],g[2]=l[6],g[3]=b,g[5]=l[7],g[6]=E,g[7]=S}else g[0]=l[0],g[1]=l[3],g[2]=l[6],g[3]=l[1],g[4]=l[4],g[5]=l[7],g[6]=l[2],g[7]=l[5],g[8]=l[8];return g},x.triggerPluginCompletionEvent=ir,x.uniqueId=qt,x.validateCustomStyleLayer=function(g){const l=[],b=g.id;return b===void 0&&l.push({message:`layers.${b}: missing required property "id"`}),g.render===void 0&&l.push({message:`layers.${b}: missing required method "render"`}),g.renderingMode&&g.renderingMode!=="2d"&&g.renderingMode!=="3d"&&l.push({message:`layers.${b}: property "renderingMode" must be either "2d" or "3d"`}),l},x.validateFog=fc,x.validateLight=Bo,x.validateStyle=Ro,x.values=Di,x.vectorTile=Ss,x.version=B,x.warnOnce=Ai,x.window=j,x.wrap=ri}),T(["./shared"],function(x){function B(ae){const K=typeof ae;if(K==="number"||K==="boolean"||K==="string"||ae==null)return JSON.stringify(ae);if(Array.isArray(ae)){let Se="[";for(const De of ae)Se+=`${B(De)},`;return`${Se}]`}const re=Object.keys(ae).sort();let de="{";for(let Se=0;Se<re.length;Se++)de+=`${JSON.stringify(re[Se])}:${B(ae[re[Se]])},`;return`${de}}`}function P(ae){let K="";for(const re of x.refProperties)K+=`/${B(ae[re])}`;return K}class O{constructor(K){this.keyCache={},K&&this.replace(K)}replace(K){this._layerConfigs={},this._layers={},this.update(K,[])}update(K,re){for(const Se of K)this._layerConfigs[Se.id]=Se,(this._layers[Se.id]=x.createStyleLayer(Se)).compileFilter(),this.keyCache[Se.id]&&delete this.keyCache[Se.id];for(const Se of re)delete this.keyCache[Se],delete this._layerConfigs[Se],delete this._layers[Se];this.familiesBySource={};const de=function(Se,De){const Ue={};for(let Oe=0;Oe<Se.length;Oe++){const qe=De&&De[Se[Oe].id]||P(Se[Oe]);De&&(De[Se[Oe].id]=qe);let Je=Ue[qe];Je||(Je=Ue[qe]=[]),Je.push(Se[Oe])}const Ne=[];for(const Oe in Ue)Ne.push(Ue[Oe]);return Ne}(x.values(this._layerConfigs),this.keyCache);for(const Se of de){const De=Se.map(Qe=>this._layers[Qe.id]),Ue=De[0];if(Ue.visibility==="none")continue;const Ne=Ue.source||"";let Oe=this.familiesBySource[Ne];Oe||(Oe=this.familiesBySource[Ne]={});const qe=Ue.sourceLayer||"_geojsonTileLayer";let Je=Oe[qe];Je||(Je=Oe[qe]=[]),Je.push(De)}}}const{ImageBitmap:U}=x.window;class G{loadTile(K,re){const{uid:de,encoding:Se,rawImageData:De,padding:Ue,buildQuadTree:Ne}=K,Oe=U&&De instanceof U?this.getImageData(De,Ue):De;re(null,new x.DEMData(de,Oe,Se,Ue<1,Ne))}getImageData(K,re){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(K.width,K.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=K.width,this.offscreenCanvas.height=K.height,this.offscreenCanvasContext.drawImage(K,0,0,K.width,K.height);const de=this.offscreenCanvasContext.getImageData(-re,-re,K.width+2*re,K.height+2*re);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),new x.RGBAImage({width:de.width,height:de.height},de.data)}}var j=function ae(K,re){var de,Se=K&&K.type;if(Se==="FeatureCollection")for(de=0;de<K.features.length;de++)ae(K.features[de],re);else if(Se==="GeometryCollection")for(de=0;de<K.geometries.length;de++)ae(K.geometries[de],re);else if(Se==="Feature")ae(K.geometry,re);else if(Se==="Polygon")H(K.coordinates,re);else if(Se==="MultiPolygon")for(de=0;de<K.coordinates.length;de++)H(K.coordinates[de],re);return K};function H(ae,K){if(ae.length!==0){te(ae[0],K);for(var re=1;re<ae.length;re++)te(ae[re],!K)}}function te(ae,K){for(var re=0,de=0,Se=0,De=ae.length,Ue=De-1;Se<De;Ue=Se++){var Ne=(ae[Se][0]-ae[Ue][0])*(ae[Ue][1]+ae[Se][1]),Oe=re+Ne;de+=Math.abs(re)>=Math.abs(Ne)?re-Oe+Ne:Ne-Oe+re,re=Oe}re+de>=0!=!!K&&ae.reverse()}const oe=x.vectorTile.VectorTileFeature.prototype.toGeoJSON;class Q{constructor(K){this._feature=K,this.extent=x.EXTENT,this.type=K.type,this.properties=K.tags,"id"in K&&!isNaN(K.id)&&(this.id=parseInt(K.id,10))}loadGeometry(){if(this._feature.type===1){const K=[];for(const re of this._feature.geometry)K.push([new x.pointGeometry(re[0],re[1])]);return K}{const K=[];for(const re of this._feature.geometry){const de=[];for(const Se of re)de.push(new x.pointGeometry(Se[0],Se[1]));K.push(de)}return K}}toGeoJSON(K,re,de){return oe.call(this,K,re,de)}}class _e{constructor(K){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=x.EXTENT,this.length=K.length,this._features=K}feature(K){return new Q(this._features[K])}}var se=x.vectorTile.VectorTileFeature,le=me;function me(ae,K){this.options=K||{},this.features=ae,this.length=ae.length}function Re(ae,K){this.id=typeof ae.id=="number"?ae.id:void 0,this.type=ae.type,this.rawGeometry=ae.type===1?[ae.geometry]:ae.geometry,this.properties=ae.tags,this.extent=K||4096}me.prototype.feature=function(ae){return new Re(this.features[ae],this.options.extent)},Re.prototype.loadGeometry=function(){var ae=this.rawGeometry;this.geometry=[];for(var K=0;K<ae.length;K++){for(var re=ae[K],de=[],Se=0;Se<re.length;Se++)de.push(new x.pointGeometry(re[Se][0],re[Se][1]));this.geometry.push(de)}return this.geometry},Re.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var ae=this.geometry,K=1/0,re=-1/0,de=1/0,Se=-1/0,De=0;De<ae.length;De++)for(var Ue=ae[De],Ne=0;Ne<Ue.length;Ne++){var Oe=Ue[Ne];K=Math.min(K,Oe.x),re=Math.max(re,Oe.x),de=Math.min(de,Oe.y),Se=Math.max(Se,Oe.y)}return[K,de,re,Se]},Re.prototype.toGeoJSON=se.prototype.toGeoJSON;var xe=Me,ue=le;function Me(ae){var K=new x.pbf;return function(re,de){for(var Se in re.layers)de.writeMessage(3,he,re.layers[Se])}(ae,K),K.finish()}function he(ae,K){var re;K.writeVarintField(15,ae.version||1),K.writeStringField(1,ae.name||""),K.writeVarintField(5,ae.extent||4096);var de={keys:[],values:[],keycache:{},valuecache:{}};for(re=0;re<ae.length;re++)de.feature=ae.feature(re),K.writeMessage(2,ge,de);var Se=de.keys;for(re=0;re<Se.length;re++)K.writeStringField(3,Se[re]);var De=de.values;for(re=0;re<De.length;re++)K.writeMessage(4,Rt,De[re])}function ge(ae,K){var re=ae.feature;re.id!==void 0&&K.writeVarintField(1,re.id),K.writeMessage(2,Le,ae),K.writeVarintField(3,re.type),K.writeMessage(4,ht,re)}function Le(ae,K){var re=ae.feature,de=ae.keys,Se=ae.values,De=ae.keycache,Ue=ae.valuecache;for(var Ne in re.properties){var Oe=re.properties[Ne],qe=De[Ne];if(Oe!==null){qe===void 0&&(de.push(Ne),De[Ne]=qe=de.length-1),K.writeVarint(qe);var Je=typeof Oe;Je!=="string"&&Je!=="boolean"&&Je!=="number"&&(Oe=JSON.stringify(Oe));var Qe=Je+":"+Oe,at=Ue[Qe];at===void 0&&(Se.push(Oe),Ue[Qe]=at=Se.length-1),K.writeVarint(at)}}}function Ze(ae,K){return(K<<3)+(7&ae)}function st(ae){return ae<<1^ae>>31}function ht(ae,K){for(var re=ae.loadGeometry(),de=ae.type,Se=0,De=0,Ue=re.length,Ne=0;Ne<Ue;Ne++){var Oe=re[Ne],qe=1;de===1&&(qe=Oe.length),K.writeVarint(Ze(1,qe));for(var Je=de===3?Oe.length-1:Oe.length,Qe=0;Qe<Je;Qe++){Qe===1&&de!==1&&K.writeVarint(Ze(2,Je-1));var at=Oe[Qe].x-Se,kt=Oe[Qe].y-De;K.writeVarint(st(at)),K.writeVarint(st(kt)),Se+=at,De+=kt}de===3&&K.writeVarint(Ze(7,1))}}function Rt(ae,K){var re=typeof ae;re==="string"?K.writeStringField(1,ae):re==="boolean"?K.writeBooleanField(7,ae):re==="number"&&(ae%1!=0?K.writeDoubleField(3,ae):ae<0?K.writeSVarintField(6,ae):K.writeVarintField(5,ae))}function Bt(ae,K,re,de,Se,De){if(Se-de<=re)return;const Ue=de+Se>>1;At(ae,K,Ue,de,Se,De%2),Bt(ae,K,re,de,Ue-1,De+1),Bt(ae,K,re,Ue+1,Se,De+1)}function At(ae,K,re,de,Se,De){for(;Se>de;){if(Se-de>600){const qe=Se-de+1,Je=re-de+1,Qe=Math.log(qe),at=.5*Math.exp(2*Qe/3),kt=.5*Math.sqrt(Qe*at*(qe-at)/qe)*(Je-qe/2<0?-1:1);At(ae,K,re,Math.max(de,Math.floor(re-Je*at/qe+kt)),Math.min(Se,Math.floor(re+(qe-Je)*at/qe+kt)),De)}const Ue=K[2*re+De];let Ne=de,Oe=Se;for(Nt(ae,K,de,re),K[2*Se+De]>Ue&&Nt(ae,K,de,Se);Ne<Oe;){for(Nt(ae,K,Ne,Oe),Ne++,Oe--;K[2*Ne+De]<Ue;)Ne++;for(;K[2*Oe+De]>Ue;)Oe--}K[2*de+De]===Ue?Nt(ae,K,de,Oe):(Oe++,Nt(ae,K,Oe,Se)),Oe<=re&&(de=Oe+1),re<=Oe&&(Se=Oe-1)}}function Nt(ae,K,re,de){zt(ae,re,de),zt(K,2*re,2*de),zt(K,2*re+1,2*de+1)}function zt(ae,K,re){const de=ae[K];ae[K]=ae[re],ae[re]=de}function Tt(ae,K,re,de){const Se=ae-re,De=K-de;return Se*Se+De*De}xe.fromVectorTileJs=Me,xe.fromGeojsonVt=function(ae,K){K=K||{};var re={};for(var de in ae)re[de]=new le(ae[de].features,K),re[de].name=de,re[de].version=K.version,re[de].extent=K.extent;return Me({layers:re})},xe.GeoJSONWrapper=ue;const ii=ae=>ae[0],Mt=ae=>ae[1];class St{constructor(K,re=ii,de=Mt,Se=64,De=Float64Array){this.nodeSize=Se,this.points=K;const Ue=K.length<65536?Uint16Array:Uint32Array,Ne=this.ids=new Ue(K.length),Oe=this.coords=new De(2*K.length);for(let qe=0;qe<K.length;qe++)Ne[qe]=qe,Oe[2*qe]=re(K[qe]),Oe[2*qe+1]=de(K[qe]);Bt(Ne,Oe,Se,0,Ne.length-1,0)}range(K,re,de,Se){return function(De,Ue,Ne,Oe,qe,Je,Qe){const at=[0,De.length-1,0],kt=[];let jt,Zt;for(;at.length;){const Yt=at.pop(),mi=at.pop(),Xi=at.pop();if(mi-Xi<=Qe){for(let Yi=Xi;Yi<=mi;Yi++)jt=Ue[2*Yi],Zt=Ue[2*Yi+1],jt>=Ne&&jt<=qe&&Zt>=Oe&&Zt<=Je&&kt.push(De[Yi]);continue}const Ki=Math.floor((Xi+mi)/2);jt=Ue[2*Ki],Zt=Ue[2*Ki+1],jt>=Ne&&jt<=qe&&Zt>=Oe&&Zt<=Je&&kt.push(De[Ki]);const Gi=(Yt+1)%2;(Yt===0?Ne<=jt:Oe<=Zt)&&(at.push(Xi),at.push(Ki-1),at.push(Gi)),(Yt===0?qe>=jt:Je>=Zt)&&(at.push(Ki+1),at.push(mi),at.push(Gi))}return kt}(this.ids,this.coords,K,re,de,Se,this.nodeSize)}within(K,re,de){return function(Se,De,Ue,Ne,Oe,qe){const Je=[0,Se.length-1,0],Qe=[],at=Oe*Oe;for(;Je.length;){const kt=Je.pop(),jt=Je.pop(),Zt=Je.pop();if(jt-Zt<=qe){for(let Gi=Zt;Gi<=jt;Gi++)Tt(De[2*Gi],De[2*Gi+1],Ue,Ne)<=at&&Qe.push(Se[Gi]);continue}const Yt=Math.floor((Zt+jt)/2),mi=De[2*Yt],Xi=De[2*Yt+1];Tt(mi,Xi,Ue,Ne)<=at&&Qe.push(Se[Yt]);const Ki=(kt+1)%2;(kt===0?Ue-Oe<=mi:Ne-Oe<=Xi)&&(Je.push(Zt),Je.push(Yt-1),Je.push(Ki)),(kt===0?Ue+Oe>=mi:Ne+Oe>=Xi)&&(Je.push(Yt+1),Je.push(jt),Je.push(Ki))}return Qe}(this.ids,this.coords,K,re,de,this.nodeSize)}}const wt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ae=>ae},Ut=Math.fround||(Vt=new Float32Array(1),ae=>(Vt[0]=+ae,Vt[0]));var Vt;class pi{constructor(K){this.options=fi(Object.create(wt),K),this.trees=new Array(this.options.maxZoom+1)}load(K){const{log:re,minZoom:de,maxZoom:Se,nodeSize:De}=this.options;re&&console.time("total time");const Ue=`prepare ${K.length} points`;re&&console.time(Ue),this.points=K;let Ne=[];for(let Oe=0;Oe<K.length;Oe++)K[Oe].geometry&&Ne.push(_i(K[Oe],Oe));this.trees[Se+1]=new St(Ne,oi,He,De,Float32Array),re&&console.timeEnd(Ue);for(let Oe=Se;Oe>=de;Oe--){const qe=+Date.now();Ne=this._cluster(Ne,Oe),this.trees[Oe]=new St(Ne,oi,He,De,Float32Array),re&&console.log("z%d: %d clusters in %dms",Oe,Ne.length,+Date.now()-qe)}return re&&console.timeEnd("total time"),this}getClusters(K,re){let de=((K[0]+180)%360+360)%360-180;const Se=Math.max(-90,Math.min(90,K[1]));let De=K[2]===180?180:((K[2]+180)%360+360)%360-180;const Ue=Math.max(-90,Math.min(90,K[3]));if(K[2]-K[0]>=360)de=-180,De=180;else if(de>De){const Je=this.getClusters([de,Se,180,Ue],re),Qe=this.getClusters([-180,Se,De,Ue],re);return Je.concat(Qe)}const Ne=this.trees[this._limitZoom(re)],Oe=Ne.range(di(de),pt(Ue),di(De),pt(Se)),qe=[];for(const Je of Oe){const Qe=Ne.points[Je];qe.push(Qe.numPoints?yi(Qe):this.points[Qe.index])}return qe}getChildren(K){const re=this._getOriginId(K),de=this._getOriginZoom(K),Se="No cluster with the specified id.",De=this.trees[de];if(!De)throw new Error(Se);const Ue=De.points[re];if(!Ue)throw new Error(Se);const Ne=this.options.radius/(this.options.extent*Math.pow(2,de-1)),Oe=De.within(Ue.x,Ue.y,Ne),qe=[];for(const Je of Oe){const Qe=De.points[Je];Qe.parentId===K&&qe.push(Qe.numPoints?yi(Qe):this.points[Qe.index])}if(qe.length===0)throw new Error(Se);return qe}getLeaves(K,re,de){const Se=[];return this._appendLeaves(Se,K,re=re||10,de=de||0,0),Se}getTile(K,re,de){const Se=this.trees[this._limitZoom(K)],De=Math.pow(2,K),{extent:Ue,radius:Ne}=this.options,Oe=Ne/Ue,qe=(de-Oe)/De,Je=(de+1+Oe)/De,Qe={features:[]};return this._addTileFeatures(Se.range((re-Oe)/De,qe,(re+1+Oe)/De,Je),Se.points,re,de,De,Qe),re===0&&this._addTileFeatures(Se.range(1-Oe/De,qe,1,Je),Se.points,De,de,De,Qe),re===De-1&&this._addTileFeatures(Se.range(0,qe,Oe/De,Je),Se.points,-1,de,De,Qe),Qe.features.length?Qe:null}getClusterExpansionZoom(K){let re=this._getOriginZoom(K)-1;for(;re<=this.options.maxZoom;){const de=this.getChildren(K);if(re++,de.length!==1)break;K=de[0].properties.cluster_id}return re}_appendLeaves(K,re,de,Se,De){const Ue=this.getChildren(re);for(const Ne of Ue){const Oe=Ne.properties;if(Oe&&Oe.cluster?De+Oe.point_count<=Se?De+=Oe.point_count:De=this._appendLeaves(K,Oe.cluster_id,de,Se,De):De<Se?De++:K.push(Ne),K.length===de)break}return De}_addTileFeatures(K,re,de,Se,De,Ue){for(const Ne of K){const Oe=re[Ne],qe=Oe.numPoints;let Je,Qe,at;if(qe)Je=Ri(Oe),Qe=Oe.x,at=Oe.y;else{const Zt=this.points[Oe.index];Je=Zt.properties,Qe=di(Zt.geometry.coordinates[0]),at=pt(Zt.geometry.coordinates[1])}const kt={type:1,geometry:[[Math.round(this.options.extent*(Qe*De-de)),Math.round(this.options.extent*(at*De-Se))]],tags:Je};let jt;qe?jt=Oe.id:this.options.generateId?jt=Oe.index:this.points[Oe.index].id&&(jt=this.points[Oe.index].id),jt!==void 0&&(kt.id=jt),Ue.features.push(kt)}}_limitZoom(K){return Math.max(this.options.minZoom,Math.min(+K,this.options.maxZoom+1))}_cluster(K,re){const de=[],{radius:Se,extent:De,reduce:Ue,minPoints:Ne}=this.options,Oe=Se/(De*Math.pow(2,re));for(let qe=0;qe<K.length;qe++){const Je=K[qe];if(Je.zoom<=re)continue;Je.zoom=re;const Qe=this.trees[re+1],at=Qe.within(Je.x,Je.y,Oe),kt=Je.numPoints||1;let jt=kt;for(const Zt of at){const Yt=Qe.points[Zt];Yt.zoom>re&&(jt+=Yt.numPoints||1)}if(jt>kt&&jt>=Ne){let Zt=Je.x*kt,Yt=Je.y*kt,mi=Ue&&kt>1?this._map(Je,!0):null;const Xi=(qe<<5)+(re+1)+this.points.length;for(const Ki of at){const Gi=Qe.points[Ki];if(Gi.zoom<=re)continue;Gi.zoom=re;const Yi=Gi.numPoints||1;Zt+=Gi.x*Yi,Yt+=Gi.y*Yi,Gi.parentId=Xi,Ue&&(mi||(mi=this._map(Je,!0)),Ue(mi,this._map(Gi)))}Je.parentId=Xi,de.push(ni(Zt/jt,Yt/jt,Xi,jt,mi))}else if(de.push(Je),jt>1)for(const Zt of at){const Yt=Qe.points[Zt];Yt.zoom<=re||(Yt.zoom=re,de.push(Yt))}}return de}_getOriginId(K){return K-this.points.length>>5}_getOriginZoom(K){return(K-this.points.length)%32}_map(K,re){if(K.numPoints)return re?fi({},K.properties):K.properties;const de=this.points[K.index].properties,Se=this.options.map(de);return re&&Se===de?fi({},Se):Se}}function ni(ae,K,re,de,Se){return{x:Ut(ae),y:Ut(K),zoom:1/0,id:re,parentId:-1,numPoints:de,properties:Se}}function _i(ae,K){const[re,de]=ae.geometry.coordinates;return{x:Ut(di(re)),y:Ut(pt(de)),zoom:1/0,index:K,parentId:-1}}function yi(ae){return{type:"Feature",id:ae.id,properties:Ri(ae),geometry:{type:"Point",coordinates:[(K=ae.x,360*(K-.5)),xt(ae.y)]}};var K}function Ri(ae){const K=ae.numPoints,re=K>=1e4?`${Math.round(K/1e3)}k`:K>=1e3?Math.round(K/100)/10+"k":K;return fi(fi({},ae.properties),{cluster:!0,cluster_id:ae.id,point_count:K,point_count_abbreviated:re})}function di(ae){return ae/360+.5}function pt(ae){const K=Math.sin(ae*Math.PI/180),re=.5-.25*Math.log((1+K)/(1-K))/Math.PI;return re<0?0:re>1?1:re}function xt(ae){const K=(180-360*ae)*Math.PI/180;return 360*Math.atan(Math.exp(K))/Math.PI-90}function fi(ae,K){for(const re in K)ae[re]=K[re];return ae}function oi(ae){return ae.x}function He(ae){return ae.y}function Ht(ae,K,re,de){for(var Se,De=de,Ue=re-K>>1,Ne=re-K,Oe=ae[K],qe=ae[K+1],Je=ae[re],Qe=ae[re+1],at=K+3;at<re;at+=3){var kt=Pt(ae[at],ae[at+1],Oe,qe,Je,Qe);if(kt>De)Se=at,De=kt;else if(kt===De){var jt=Math.abs(at-Ue);jt<Ne&&(Se=at,Ne=jt)}}De>de&&(Se-K>3&&Ht(ae,K,Se,de),ae[Se+2]=De,re-Se>3&&Ht(ae,Se,re,de))}function Pt(ae,K,re,de,Se,De){var Ue=Se-re,Ne=De-de;if(Ue!==0||Ne!==0){var Oe=((ae-re)*Ue+(K-de)*Ne)/(Ue*Ue+Ne*Ne);Oe>1?(re=Se,de=De):Oe>0&&(re+=Ue*Oe,de+=Ne*Oe)}return(Ue=ae-re)*Ue+(Ne=K-de)*Ne}function ei(ae,K,re,de){var Se={id:ae===void 0?null:ae,type:K,geometry:re,tags:de,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(De){var Ue=De.geometry,Ne=De.type;if(Ne==="Point"||Ne==="MultiPoint"||Ne==="LineString")ri(De,Ue);else if(Ne==="Polygon"||Ne==="MultiLineString")for(var Oe=0;Oe<Ue.length;Oe++)ri(De,Ue[Oe]);else if(Ne==="MultiPolygon")for(Oe=0;Oe<Ue.length;Oe++)for(var qe=0;qe<Ue[Oe].length;qe++)ri(De,Ue[Oe][qe])}(Se),Se}function ri(ae,K){for(var re=0;re<K.length;re+=3)ae.minX=Math.min(ae.minX,K[re]),ae.minY=Math.min(ae.minY,K[re+1]),ae.maxX=Math.max(ae.maxX,K[re]),ae.maxY=Math.max(ae.maxY,K[re+1])}function vt(ae,K,re,de){if(K.geometry){var Se=K.geometry.coordinates,De=K.geometry.type,Ue=Math.pow(re.tolerance/((1<<re.maxZoom)*re.extent),2),Ne=[],Oe=K.id;if(re.promoteId?Oe=K.properties[re.promoteId]:re.generateId&&(Oe=de||0),De==="Point")Di(Se,Ne);else if(De==="MultiPoint")for(var qe=0;qe<Se.length;qe++)Di(Se[qe],Ne);else if(De==="LineString")Wt(Se,Ne,Ue,!1);else if(De==="MultiLineString"){if(re.lineMetrics){for(qe=0;qe<Se.length;qe++)Wt(Se[qe],Ne=[],Ue,!1),ae.push(ei(Oe,"LineString",Ne,K.properties));return}Gt(Se,Ne,Ue,!1)}else if(De==="Polygon")Gt(Se,Ne,Ue,!0);else{if(De!=="MultiPolygon"){if(De==="GeometryCollection"){for(qe=0;qe<K.geometry.geometries.length;qe++)vt(ae,{id:Oe,geometry:K.geometry.geometries[qe],properties:K.properties},re,de);return}throw new Error("Input data is not a valid GeoJSON object.")}for(qe=0;qe<Se.length;qe++){var Je=[];Gt(Se[qe],Je,Ue,!0),Ne.push(Je)}}ae.push(ei(Oe,De,Ne,K.properties))}}function Di(ae,K){K.push(qt(ae[0])),K.push(It(ae[1])),K.push(0)}function Wt(ae,K,re,de){for(var Se,De,Ue=0,Ne=0;Ne<ae.length;Ne++){var Oe=qt(ae[Ne][0]),qe=It(ae[Ne][1]);K.push(Oe),K.push(qe),K.push(0),Ne>0&&(Ue+=de?(Se*qe-Oe*De)/2:Math.sqrt(Math.pow(Oe-Se,2)+Math.pow(qe-De,2))),Se=Oe,De=qe}var Je=K.length-3;K[2]=1,Ht(K,0,Je,re),K[Je+2]=1,K.size=Math.abs(Ue),K.start=0,K.end=K.size}function Gt(ae,K,re,de){for(var Se=0;Se<ae.length;Se++){var De=[];Wt(ae[Se],De,re,de),K.push(De)}}function qt(ae){return ae/360+.5}function It(ae){var K=Math.sin(ae*Math.PI/180),re=.5-.25*Math.log((1+K)/(1-K))/Math.PI;return re<0?0:re>1?1:re}function hi(ae,K,re,de,Se,De,Ue,Ne){if(de/=K,De>=(re/=K)&&Ue<de)return ae;if(Ue<re||De>=de)return null;for(var Oe=[],qe=0;qe<ae.length;qe++){var Je=ae[qe],Qe=Je.geometry,at=Je.type,kt=Se===0?Je.minX:Je.minY,jt=Se===0?Je.maxX:Je.maxY;if(kt>=re&&jt<de)Oe.push(Je);else if(!(jt<re||kt>=de)){var Zt=[];if(at==="Point"||at==="MultiPoint")xi(Qe,Zt,re,de,Se);else if(at==="LineString")Ei(Qe,Zt,re,de,Se,!1,Ne.lineMetrics);else if(at==="MultiLineString")ai(Qe,Zt,re,de,Se,!1);else if(at==="Polygon")ai(Qe,Zt,re,de,Se,!0);else if(at==="MultiPolygon")for(var Yt=0;Yt<Qe.length;Yt++){var mi=[];ai(Qe[Yt],mi,re,de,Se,!0),mi.length&&Zt.push(mi)}if(Zt.length){if(Ne.lineMetrics&&at==="LineString"){for(Yt=0;Yt<Zt.length;Yt++)Oe.push(ei(Je.id,at,Zt[Yt],Je.tags));continue}at!=="LineString"&&at!=="MultiLineString"||(Zt.length===1?(at="LineString",Zt=Zt[0]):at="MultiLineString"),at!=="Point"&&at!=="MultiPoint"||(at=Zt.length===3?"Point":"MultiPoint"),Oe.push(ei(Je.id,at,Zt,Je.tags))}}}return Oe.length?Oe:null}function xi(ae,K,re,de,Se){for(var De=0;De<ae.length;De+=3){var Ue=ae[De+Se];Ue>=re&&Ue<=de&&(K.push(ae[De]),K.push(ae[De+1]),K.push(ae[De+2]))}}function Ei(ae,K,re,de,Se,De,Ue){for(var Ne,Oe,qe=Qt(ae),Je=Se===0?Si:Zi,Qe=ae.start,at=0;at<ae.length-3;at+=3){var kt=ae[at],jt=ae[at+1],Zt=ae[at+2],Yt=ae[at+3],mi=ae[at+4],Xi=Se===0?kt:jt,Ki=Se===0?Yt:mi,Gi=!1;Ue&&(Ne=Math.sqrt(Math.pow(kt-Yt,2)+Math.pow(jt-mi,2))),Xi<re?Ki>re&&(Oe=Je(qe,kt,jt,Yt,mi,re),Ue&&(qe.start=Qe+Ne*Oe)):Xi>de?Ki<de&&(Oe=Je(qe,kt,jt,Yt,mi,de),Ue&&(qe.start=Qe+Ne*Oe)):$i(qe,kt,jt,Zt),Ki<re&&Xi>=re&&(Oe=Je(qe,kt,jt,Yt,mi,re),Gi=!0),Ki>de&&Xi<=de&&(Oe=Je(qe,kt,jt,Yt,mi,de),Gi=!0),!De&&Gi&&(Ue&&(qe.end=Qe+Ne*Oe),K.push(qe),qe=Qt(ae)),Ue&&(Qe+=Ne)}var Yi=ae.length-3;kt=ae[Yi],jt=ae[Yi+1],Zt=ae[Yi+2],(Xi=Se===0?kt:jt)>=re&&Xi<=de&&$i(qe,kt,jt,Zt),Yi=qe.length-3,De&&Yi>=3&&(qe[Yi]!==qe[0]||qe[Yi+1]!==qe[1])&&$i(qe,qe[0],qe[1],qe[2]),qe.length&&K.push(qe)}function Qt(ae){var K=[];return K.size=ae.size,K.start=ae.start,K.end=ae.end,K}function ai(ae,K,re,de,Se,De){for(var Ue=0;Ue<ae.length;Ue++)Ei(ae[Ue],K,re,de,Se,De,!1)}function $i(ae,K,re,de){ae.push(K),ae.push(re),ae.push(de)}function Si(ae,K,re,de,Se,De){var Ue=(De-K)/(de-K);return ae.push(De),ae.push(re+(Se-re)*Ue),ae.push(1),Ue}function Zi(ae,K,re,de,Se,De){var Ue=(De-re)/(Se-re);return ae.push(K+(de-K)*Ue),ae.push(De),ae.push(1),Ue}function Ai(ae,K){for(var re=[],de=0;de<ae.length;de++){var Se,De=ae[de],Ue=De.type;if(Ue==="Point"||Ue==="MultiPoint"||Ue==="LineString")Se=dr(De.geometry,K);else if(Ue==="MultiLineString"||Ue==="Polygon"){Se=[];for(var Ne=0;Ne<De.geometry.length;Ne++)Se.push(dr(De.geometry[Ne],K))}else if(Ue==="MultiPolygon")for(Se=[],Ne=0;Ne<De.geometry.length;Ne++){for(var Oe=[],qe=0;qe<De.geometry[Ne].length;qe++)Oe.push(dr(De.geometry[Ne][qe],K));Se.push(Oe)}re.push(ei(De.id,Ue,Se,De.tags))}return re}function dr(ae,K){var re=[];re.size=ae.size,ae.start!==void 0&&(re.start=ae.start,re.end=ae.end);for(var de=0;de<ae.length;de+=3)re.push(ae[de]+K,ae[de+1],ae[de+2]);return re}function on(ae,K){if(ae.transformed)return ae;var re,de,Se,De=1<<ae.z,Ue=ae.x,Ne=ae.y;for(re=0;re<ae.features.length;re++){var Oe=ae.features[re],qe=Oe.geometry,Je=Oe.type;if(Oe.geometry=[],Je===1)for(de=0;de<qe.length;de+=2)Oe.geometry.push(fr(qe[de],qe[de+1],K,De,Ue,Ne));else for(de=0;de<qe.length;de++){var Qe=[];for(Se=0;Se<qe[de].length;Se+=2)Qe.push(fr(qe[de][Se],qe[de][Se+1],K,De,Ue,Ne));Oe.geometry.push(Qe)}}return ae.transformed=!0,ae}function fr(ae,K,re,de,Se,De){return[Math.round(re*(ae*de-Se)),Math.round(re*(K*de-De))]}function Rr(ae,K,re,de,Se){for(var De=K===Se.maxZoom?0:Se.tolerance/((1<<K)*Se.extent),Ue={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:re,y:de,z:K,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Ne=0;Ne<ae.length;Ne++){Ue.numFeatures++,Br(Ue,ae[Ne],De,Se);var Oe=ae[Ne].minX,qe=ae[Ne].minY,Je=ae[Ne].maxX,Qe=ae[Ne].maxY;Oe<Ue.minX&&(Ue.minX=Oe),qe<Ue.minY&&(Ue.minY=qe),Je>Ue.maxX&&(Ue.maxX=Je),Qe>Ue.maxY&&(Ue.maxY=Qe)}return Ue}function Br(ae,K,re,de){var Se=K.geometry,De=K.type,Ue=[];if(De==="Point"||De==="MultiPoint")for(var Ne=0;Ne<Se.length;Ne+=3)Ue.push(Se[Ne]),Ue.push(Se[Ne+1]),ae.numPoints++,ae.numSimplified++;else if(De==="LineString")Er(Ue,Se,ae,re,!1,!1);else if(De==="MultiLineString"||De==="Polygon")for(Ne=0;Ne<Se.length;Ne++)Er(Ue,Se[Ne],ae,re,De==="Polygon",Ne===0);else if(De==="MultiPolygon")for(var Oe=0;Oe<Se.length;Oe++){var qe=Se[Oe];for(Ne=0;Ne<qe.length;Ne++)Er(Ue,qe[Ne],ae,re,!0,Ne===0)}if(Ue.length){var Je=K.tags||null;if(De==="LineString"&&de.lineMetrics){for(var Qe in Je={},K.tags)Je[Qe]=K.tags[Qe];Je.mapbox_clip_start=Se.start/Se.size,Je.mapbox_clip_end=Se.end/Se.size}var at={geometry:Ue,type:De==="Polygon"||De==="MultiPolygon"?3:De==="LineString"||De==="MultiLineString"?2:1,tags:Je};K.id!==null&&(at.id=K.id),ae.features.push(at)}}function Er(ae,K,re,de,Se,De){var Ue=de*de;if(de>0&&K.size<(Se?Ue:de))re.numPoints+=K.length/3;else{for(var Ne=[],Oe=0;Oe<K.length;Oe+=3)(de===0||K[Oe+2]>Ue)&&(re.numSimplified++,Ne.push(K[Oe]),Ne.push(K[Oe+1])),re.numPoints++;Se&&function(qe,Je){for(var Qe=0,at=0,kt=qe.length,jt=kt-2;at<kt;jt=at,at+=2)Qe+=(qe[at]-qe[jt])*(qe[at+1]+qe[jt+1]);if(Qe>0===Je)for(at=0,kt=qe.length;at<kt/2;at+=2){var Zt=qe[at],Yt=qe[at+1];qe[at]=qe[kt-2-at],qe[at+1]=qe[kt-1-at],qe[kt-2-at]=Zt,qe[kt-1-at]=Yt}}(Ne,De),ae.push(Ne)}}function vr(ae,K){var re=(K=this.options=function(Se,De){for(var Ue in De)Se[Ue]=De[Ue];return Se}(Object.create(this.options),K)).debug;if(re&&console.time("preprocess data"),K.maxZoom<0||K.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(K.promoteId&&K.generateId)throw new Error("promoteId and generateId cannot be used together.");var de=function(Se,De){var Ue=[];if(Se.type==="FeatureCollection")for(var Ne=0;Ne<Se.features.length;Ne++)vt(Ue,Se.features[Ne],De,Ne);else vt(Ue,Se.type==="Feature"?Se:{geometry:Se},De);return Ue}(ae,K);this.tiles={},this.tileCoords=[],re&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",K.indexMaxZoom,K.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(de=function(Se,De){var Ue=De.buffer/De.extent,Ne=Se,Oe=hi(Se,1,-1-Ue,Ue,0,-1,2,De),qe=hi(Se,1,1-Ue,2+Ue,0,-1,2,De);return(Oe||qe)&&(Ne=hi(Se,1,-Ue,1+Ue,0,-1,2,De)||[],Oe&&(Ne=Ai(Oe,1).concat(Ne)),qe&&(Ne=Ne.concat(Ai(qe,-1)))),Ne}(de,K)).length&&this.splitTile(de,0,0,0),re&&(de.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function $r(ae,K,re){return 32*((1<<ae)*re+K)+ae}function Mr(ae,K){const re=ae.tileID.canonical;if(!this._geoJSONIndex)return K(null,null);const de=this._geoJSONIndex.getTile(re.z,re.x,re.y);if(!de)return K(null,null);const Se=new _e(de.features);let De=xe(Se);De.byteOffset===0&&De.byteLength===De.buffer.byteLength||(De=new Uint8Array(De)),K(null,{vectorTile:Se,rawData:De.buffer})}vr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},vr.prototype.splitTile=function(ae,K,re,de,Se,De,Ue){for(var Ne=[ae,K,re,de],Oe=this.options,qe=Oe.debug;Ne.length;){de=Ne.pop(),re=Ne.pop(),K=Ne.pop(),ae=Ne.pop();var Je=1<<K,Qe=$r(K,re,de),at=this.tiles[Qe];if(!at&&(qe>1&&console.time("creation"),at=this.tiles[Qe]=Rr(ae,K,re,de,Oe),this.tileCoords.push({z:K,x:re,y:de}),qe)){qe>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",K,re,de,at.numFeatures,at.numPoints,at.numSimplified),console.timeEnd("creation"));var kt="z"+K;this.stats[kt]=(this.stats[kt]||0)+1,this.total++}if(at.source=ae,Se){if(K===Oe.maxZoom||K===Se)continue;var jt=1<<Se-K;if(re!==Math.floor(De/jt)||de!==Math.floor(Ue/jt))continue}else if(K===Oe.indexMaxZoom||at.numPoints<=Oe.indexMaxPoints)continue;if(at.source=null,ae.length!==0){qe>1&&console.time("clipping");var Zt,Yt,mi,Xi,Ki,Gi,Yi=.5*Oe.buffer/Oe.extent,jn=.5-Yi,Pn=.5+Yi,Lr=1+Yi;Zt=Yt=mi=Xi=null,Ki=hi(ae,Je,re-Yi,re+Pn,0,at.minX,at.maxX,Oe),Gi=hi(ae,Je,re+jn,re+Lr,0,at.minX,at.maxX,Oe),ae=null,Ki&&(Zt=hi(Ki,Je,de-Yi,de+Pn,1,at.minY,at.maxY,Oe),Yt=hi(Ki,Je,de+jn,de+Lr,1,at.minY,at.maxY,Oe),Ki=null),Gi&&(mi=hi(Gi,Je,de-Yi,de+Pn,1,at.minY,at.maxY,Oe),Xi=hi(Gi,Je,de+jn,de+Lr,1,at.minY,at.maxY,Oe),Gi=null),qe>1&&console.timeEnd("clipping"),Ne.push(Zt||[],K+1,2*re,2*de),Ne.push(Yt||[],K+1,2*re,2*de+1),Ne.push(mi||[],K+1,2*re+1,2*de),Ne.push(Xi||[],K+1,2*re+1,2*de+1)}}},vr.prototype.getTile=function(ae,K,re){var de=this.options,Se=de.extent,De=de.debug;if(ae<0||ae>24)return null;var Ue=1<<ae,Ne=$r(ae,K=(K%Ue+Ue)%Ue,re);if(this.tiles[Ne])return on(this.tiles[Ne],Se);De>1&&console.log("drilling down to z%d-%d-%d",ae,K,re);for(var Oe,qe=ae,Je=K,Qe=re;!Oe&&qe>0;)qe--,Je=Math.floor(Je/2),Qe=Math.floor(Qe/2),Oe=this.tiles[$r(qe,Je,Qe)];return Oe&&Oe.source?(De>1&&console.log("found parent tile z%d-%d-%d",qe,Je,Qe),De>1&&console.time("drilling down"),this.splitTile(Oe.source,qe,Je,Qe,ae,K,re),De>1&&console.timeEnd("drilling down"),this.tiles[Ne]?on(this.tiles[Ne],Se):null):null};class Te extends x.VectorTileWorkerSource{constructor(K,re,de,Se,De){super(K,re,de,Se,Mr),De&&(this.loadGeoJSON=De)}loadData(K,re){const de=K&&K.request,Se=de&&de.collectResourceTiming;this.loadGeoJSON(K,(De,Ue)=>{if(De||!Ue)return re(De);if(typeof Ue!="object")return re(new Error(`Input data given to '${K.source}' is not a valid GeoJSON object.`));{j(Ue,!0);try{if(K.filter){const Oe=x.createExpression(K.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Oe.result==="error")throw new Error(Oe.value.map(Je=>`${Je.key}: ${Je.message}`).join(", "));const qe=Ue.features.filter(Je=>Oe.value.evaluate({zoom:0},Je));Ue={type:"FeatureCollection",features:qe}}this._geoJSONIndex=K.cluster?new pi(function({superclusterOptions:Oe,clusterProperties:qe}){if(!qe||!Oe)return Oe;const Je={},Qe={},at={accumulated:null,zoom:0},kt={properties:null},jt=Object.keys(qe);for(const Zt of jt){const[Yt,mi]=qe[Zt],Xi=x.createExpression(mi),Ki=x.createExpression(typeof Yt=="string"?[Yt,["accumulated"],["get",Zt]]:Yt);Je[Zt]=Xi.value,Qe[Zt]=Ki.value}return Oe.map=Zt=>{kt.properties=Zt;const Yt={};for(const mi of jt)Yt[mi]=Je[mi].evaluate(at,kt);return Yt},Oe.reduce=(Zt,Yt)=>{kt.properties=Yt;for(const mi of jt)at.accumulated=Zt[mi],Zt[mi]=Qe[mi].evaluate(at,kt)},Oe}(K)).load(Ue.features):function(Oe,qe){return new vr(Oe,qe)}(Ue,K.geojsonVtOptions)}catch(Oe){return re(Oe)}this.loaded={};const Ne={};if(Se){const Oe=x.getPerformanceMeasurement(de);Oe&&(Ne.resourceTiming={},Ne.resourceTiming[K.source]=JSON.parse(JSON.stringify(Oe)))}re(null,Ne)}})}reloadTile(K,re){const de=this.loaded;return de&&de[K.uid]?super.reloadTile(K,re):this.loadTile(K,re)}loadGeoJSON(K,re){if(K.request)x.getJSON(K.request,re);else{if(typeof K.data!="string")return re(new Error(`Input data given to '${K.source}' is not a valid GeoJSON object.`));try{return re(null,JSON.parse(K.data))}catch{return re(new Error(`Input data given to '${K.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(K,re){try{re(null,this._geoJSONIndex.getClusterExpansionZoom(K.clusterId))}catch(de){re(de)}}getClusterChildren(K,re){try{re(null,this._geoJSONIndex.getChildren(K.clusterId))}catch(de){re(de)}}getClusterLeaves(K,re){try{re(null,this._geoJSONIndex.getLeaves(K.clusterId,K.limit,K.offset))}catch(de){re(de)}}}class je{constructor(K){this.self=K,this.actor=new x.Actor(K,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=x.getProjection({name:"mercator"}),this.workerSourceTypes={vector:x.VectorTileWorkerSource,geojson:Te},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(re,de)=>{if(this.workerSourceTypes[re])throw new Error(`Worker source with name "${re}" already registered.`);this.workerSourceTypes[re]=de},this.self.registerRTLTextPlugin=re=>{if(x.plugin.isParsed())throw new Error("RTL text plugin already registered.");x.plugin.applyArabicShaping=re.applyArabicShaping,x.plugin.processBidirectionalText=re.processBidirectionalText,x.plugin.processStyledBidirectionalText=re.processStyledBidirectionalText}}clearCaches(K,re,de){delete this.layerIndexes[K],delete this.availableImages[K],delete this.workerSources[K],delete this.demWorkerSources[K],de()}checkIfReady(K,re,de){de()}setReferrer(K,re){this.referrer=re}spriteLoaded(K,re){this.isSpriteLoaded[K]=re;for(const de in this.workerSources[K]){const Se=this.workerSources[K][de];for(const De in Se)Se[De]instanceof x.VectorTileWorkerSource&&(Se[De].isSpriteLoaded=re,Se[De].fire(new x.Event("isSpriteLoaded")))}}setImages(K,re,de){this.availableImages[K]=re;for(const Se in this.workerSources[K]){const De=this.workerSources[K][Se];for(const Ue in De)De[Ue].availableImages=re}de()}enableTerrain(K,re,de){this.terrain=re,de()}setProjection(K,re){this.projections[K]=x.getProjection(re)}setLayers(K,re,de){this.getLayerIndex(K).replace(re),de()}updateLayers(K,re,de){this.getLayerIndex(K).update(re.layers,re.removedIds),de()}loadTile(K,re,de){const Se=this.enableTerrain?x.extend({enableTerrain:this.terrain},re):re;Se.projection=this.projections[K]||this.defaultProjection,this.getWorkerSource(K,re.type,re.source).loadTile(Se,de)}loadDEMTile(K,re,de){const Se=this.enableTerrain?x.extend({buildQuadTree:this.terrain},re):re;this.getDEMWorkerSource(K,re.source).loadTile(Se,de)}reloadTile(K,re,de){const Se=this.enableTerrain?x.extend({enableTerrain:this.terrain},re):re;Se.projection=this.projections[K]||this.defaultProjection,this.getWorkerSource(K,re.type,re.source).reloadTile(Se,de)}abortTile(K,re,de){this.getWorkerSource(K,re.type,re.source).abortTile(re,de)}removeTile(K,re,de){this.getWorkerSource(K,re.type,re.source).removeTile(re,de)}removeSource(K,re,de){if(!this.workerSources[K]||!this.workerSources[K][re.type]||!this.workerSources[K][re.type][re.source])return;const Se=this.workerSources[K][re.type][re.source];delete this.workerSources[K][re.type][re.source],Se.removeSource!==void 0?Se.removeSource(re,de):de()}loadWorkerSource(K,re,de){try{this.self.importScripts(re.url),de()}catch(Se){de(Se.toString())}}syncRTLPluginState(K,re,de){try{x.plugin.setState(re);const Se=x.plugin.getPluginURL();if(x.plugin.isLoaded()&&!x.plugin.isParsed()&&Se!=null){this.self.importScripts(Se);const De=x.plugin.isParsed();de(De?void 0:new Error(`RTL Text Plugin failed to import scripts from ${Se}`),De)}}catch(Se){de(Se.toString())}}getAvailableImages(K){let re=this.availableImages[K];return re||(re=[]),re}getLayerIndex(K){let re=this.layerIndexes[K];return re||(re=this.layerIndexes[K]=new O),re}getWorkerSource(K,re,de){return this.workerSources[K]||(this.workerSources[K]={}),this.workerSources[K][re]||(this.workerSources[K][re]={}),this.workerSources[K][re][de]||(this.workerSources[K][re][de]=new this.workerSourceTypes[re]({send:(Se,De,Ue,Ne,Oe,qe)=>{this.actor.send(Se,De,Ue,K,Oe,qe)},scheduler:this.actor.scheduler},this.getLayerIndex(K),this.getAvailableImages(K),this.isSpriteLoaded[K])),this.workerSources[K][re][de]}getDEMWorkerSource(K,re){return this.demWorkerSources[K]||(this.demWorkerSources[K]={}),this.demWorkerSources[K][re]||(this.demWorkerSources[K][re]=new G),this.demWorkerSources[K][re]}enforceCacheSizeLimit(K,re){x.enforceCacheSizeLimit(re)}getWorkerPerformanceMetrics(K,re,de){de(void 0,void 0)}}return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope&&(self.worker=new je(self)),je}),T(["./shared"],function(x){var B=P;function P(I){return!function(y){return typeof window=="undefined"||typeof document=="undefined"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var C,L,F=new Blob([""],{type:"text/javascript"}),N=URL.createObjectURL(F);try{L=new Worker(N),C=!0}catch{C=!1}return L&&L.terminate(),URL.revokeObjectURL(N),C}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var C=document.createElement("canvas");C.width=C.height=1;var L=C.getContext("2d");if(!L)return!1;var F=L.getImageData(0,0,1,1);return F&&F.width===C.width}()?(O[M=y&&y.failIfMajorPerformanceCaveat]===void 0&&(O[M]=function(C){var L,F=function(N){var q=document.createElement("canvas"),W=Object.create(P.webGLContextAttributes);return W.failIfMajorPerformanceCaveat=N,q.getContext("webgl",W)||q.getContext("experimental-webgl",W)}(C);if(!F)return!1;try{L=F.createShader(F.VERTEX_SHADER)}catch{return!1}return!(!L||F.isContextLost())&&(F.shaderSource(L,"void main() {}"),F.compileShader(L),F.getShaderParameter(L,F.COMPILE_STATUS)===!0)}(M)),O[M]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var M}(I)}var O={};function U(I,y){var M=y[0],C=y[1],L=y[2],F=y[3],N=M*F-L*C;return N?(I[0]=F*(N=1/N),I[1]=-C*N,I[2]=-L*N,I[3]=M*N,I):null}function G(I,y){if(Array.isArray(I)){if(!Array.isArray(y)||I.length!==y.length)return!1;for(let M=0;M<I.length;M++)if(!G(I[M],y[M]))return!1;return!0}if(typeof I=="object"&&I!==null&&y!==null){if(typeof y!="object"||Object.keys(I).length!==Object.keys(y).length)return!1;for(const M in I)if(!G(I[M],y[M]))return!1;return!0}return I===y}P.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const j={create:function(I,y,M){const C=x.window.document.createElement(I);return y!==void 0&&(C.className=y),M&&M.appendChild(C),C},createSVG:function(I,y,M){const C=x.window.document.createElementNS("http://www.w3.org/2000/svg",I);for(const L of Object.keys(y))C.setAttributeNS(null,L,y[L]);return M&&M.appendChild(C),C}},H=x.window.document&&x.window.document.documentElement.style,te=H&&H.userSelect!==void 0?"userSelect":"WebkitUserSelect";let oe;j.disableDrag=function(){H&&te&&(oe=H[te],H[te]="none")},j.enableDrag=function(){H&&te&&(H[te]=oe)};const Q=function(I){I.preventDefault(),I.stopPropagation(),x.window.removeEventListener("click",Q,!0)};function _e(I,y,M){const C=I.offsetWidth===y.width?1:I.offsetWidth/y.width;return new x.pointGeometry((M.clientX-y.left)*C,(M.clientY-y.top)*C)}function se(I){const{userImage:y}=I;return!!(y&&y.render&&y.render())&&(I.data.replace(new Uint8Array(y.data.buffer)),!0)}j.suppressClick=function(){x.window.addEventListener("click",Q,!0),x.window.setTimeout(()=>{x.window.removeEventListener("click",Q,!0)},0)},j.mousePos=function(I,y){const M=I.getBoundingClientRect();return _e(I,M,y)},j.touchPos=function(I,y){const M=I.getBoundingClientRect(),C=[];for(let L=0;L<y.length;L++)C.push(_e(I,M,y[L]));return C},j.mouseButton=function(I){return x.window.InstallTrigger!==void 0&&I.button===2&&I.ctrlKey&&x.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:I.button};class le extends x.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new x.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(y){if(this.loaded!==y&&(this.loaded=y,y)){for(const{ids:M,callback:C}of this.requestors)this._notify(M,C);this.requestors=[]}}getImage(y){return this.images[y]}addImage(y,M){this._validate(y,M)&&(this.images[y]=M)}_validate(y,M){let C=!0;return this._validateStretch(M.stretchX,M.data&&M.data.width)||(this.fire(new x.ErrorEvent(new Error(`Image "${y}" has invalid "stretchX" value`))),C=!1),this._validateStretch(M.stretchY,M.data&&M.data.height)||(this.fire(new x.ErrorEvent(new Error(`Image "${y}" has invalid "stretchY" value`))),C=!1),this._validateContent(M.content,M)||(this.fire(new x.ErrorEvent(new Error(`Image "${y}" has invalid "content" value`))),C=!1),C}_validateStretch(y,M){if(!y)return!0;let C=0;for(const L of y){if(L[0]<C||L[1]<L[0]||M<L[1])return!1;C=L[1]}return!0}_validateContent(y,M){return!(y&&(y.length!==4||y[0]<0||M.data.width<y[0]||y[1]<0||M.data.height<y[1]||y[2]<0||M.data.width<y[2]||y[3]<0||M.data.height<y[3]||y[2]<y[0]||y[3]<y[1]))}updateImage(y,M){M.version=this.images[y].version+1,this.images[y]=M,this.updatedImages[y]=!0}removeImage(y){const M=this.images[y];delete this.images[y],delete this.patterns[y],M.userImage&&M.userImage.onRemove&&M.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(y,M){let C=!0;if(!this.isLoaded())for(const L of y)this.images[L]||(C=!1);this.isLoaded()||C?this._notify(y,M):this.requestors.push({ids:y,callback:M})}_notify(y,M){const C={};for(const L of y){this.images[L]||this.fire(new x.Event("styleimagemissing",{id:L}));const F=this.images[L];F?C[L]={data:F.data.clone(),pixelRatio:F.pixelRatio,sdf:F.sdf,version:F.version,stretchX:F.stretchX,stretchY:F.stretchY,content:F.content,hasRenderCallback:Boolean(F.userImage&&F.userImage.render)}:x.warnOnce(`Image "${L}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}M(null,C)}getPixelSize(){const{width:y,height:M}=this.atlasImage;return{width:y,height:M}}getPattern(y){const M=this.patterns[y],C=this.getImage(y);if(!C)return null;if(M&&M.position.version===C.version)return M.position;if(M)M.position.version=C.version;else{const L={w:C.data.width+2,h:C.data.height+2,x:0,y:0},F=new x.ImagePosition(L,C);this.patterns[y]={bin:L,position:F}}return this._updatePatternAtlas(),this.patterns[y].position}bind(y){const M=y.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new x.Texture(y,this.atlasImage,M.RGBA),this.atlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE)}_updatePatternAtlas(){const y=[];for(const F in this.patterns)y.push(this.patterns[F].bin);const{w:M,h:C}=x.potpack(y),L=this.atlasImage;L.resize({width:M||1,height:C||1});for(const F in this.patterns){const{bin:N}=this.patterns[F],q=N.x+1,W=N.y+1,J=this.images[F].data,ee=J.width,ne=J.height;x.RGBAImage.copy(J,L,{x:0,y:0},{x:q,y:W},{width:ee,height:ne}),x.RGBAImage.copy(J,L,{x:0,y:ne-1},{x:q,y:W-1},{width:ee,height:1}),x.RGBAImage.copy(J,L,{x:0,y:0},{x:q,y:W+ne},{width:ee,height:1}),x.RGBAImage.copy(J,L,{x:ee-1,y:0},{x:q-1,y:W},{width:1,height:ne}),x.RGBAImage.copy(J,L,{x:0,y:0},{x:q+ee,y:W},{width:1,height:ne})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(y){for(const M of y){if(this.callbackDispatchedThisFrame[M])continue;this.callbackDispatchedThisFrame[M]=!0;const C=this.images[M];se(C)&&this.updateImage(M,C)}}}const me=new x.Properties({anchor:new x.DataConstantProperty(x.spec.light.anchor),position:new class{constructor(){this.specification=x.spec.light.position}possiblyEvaluate(I,y){return function([M,C,L]){const F=x.degToRad(C+90),N=x.degToRad(L);return{x:M*Math.cos(F)*Math.sin(N),y:M*Math.sin(F)*Math.sin(N),z:M*Math.cos(N),azimuthal:C,polar:L}}(I.expression.evaluate(y))}interpolate(I,y,M){return{x:x.number(I.x,y.x,M),y:x.number(I.y,y.y,M),z:x.number(I.z,y.z,M),azimuthal:x.number(I.azimuthal,y.azimuthal,M),polar:x.number(I.polar,y.polar,M)}}},color:new x.DataConstantProperty(x.spec.light.color),intensity:new x.DataConstantProperty(x.spec.light.intensity)}),Re="-transition";class xe extends x.Evented{constructor(y){super(),this._transitionable=new x.Transitionable(me),this.setLight(y),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(y,M={}){if(!this._validate(x.validateLight,y,M))for(const C in y){const L=y[C];x.endsWith(C,Re)?this._transitionable.setTransition(C.slice(0,-Re.length),L):this._transitionable.setValue(C,L)}}updateTransitions(y){this._transitioning=this._transitionable.transitioned(y,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(y){this.properties=this._transitioning.possiblyEvaluate(y)}_validate(y,M,C){return(!C||C.validate!==!1)&&x.emitValidationErrors(this,y.call(x.validateStyle,x.extend({value:M,style:{glyphs:!0,sprite:!0},styleSpec:x.spec})))}}const ue=new x.Properties({source:new x.DataConstantProperty(x.spec.terrain.source),exaggeration:new x.DataConstantProperty(x.spec.terrain.exaggeration)}),Me="-transition";class he extends x.Evented{constructor(y,M){super(),this._transitionable=new x.Transitionable(ue),this.set(y),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=M}get(){return this._transitionable.serialize()}set(y){for(const M in y){const C=y[M];x.endsWith(M,Me)?this._transitionable.setTransition(M.slice(0,-Me.length),C):this._transitionable.setValue(M,C)}}updateTransitions(y){this._transitioning=this._transitionable.transitioned(y,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(y){this.properties=this._transitioning.possiblyEvaluate(y)}}function ge(I,y,M,C){const L=x.smoothstep(45,65,M),[F,N]=Le(I,C),q=x.length(y);let W=1-Math.min(1,Math.exp((q-F)/(N-F)*-6));return W*=W*W,W=Math.min(1,1.00747*W),W*L*I.alpha}function Le(I,y){const M=.5/Math.tan(.5*y);return[I.range[0]+M,I.range[1]+M]}const Ze=new x.Properties({range:new x.DataConstantProperty(x.spec.fog.range),color:new x.DataConstantProperty(x.spec.fog.color),"horizon-blend":new x.DataConstantProperty(x.spec.fog["horizon-blend"])}),st="-transition";class ht extends x.Evented{constructor(y,M){super(),this._transitionable=new x.Transitionable(Ze),this.set(y),this._transitioning=this._transitionable.untransitioned(),this._transform=M}get state(){return{range:this.properties.get("range"),horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(y,M={}){if(!this._validate(x.validateFog,y,M))for(const C in y){const L=y[C];x.endsWith(C,st)?this._transitionable.setTransition(C.slice(0,-st.length),L):this._transitionable.setValue(C,L)}}getOpacity(y){if(!this._transform.projection.supportsFog)return 0;const M=this.properties&&this.properties.get("color")||1;return x.smoothstep(45,65,y)*M.a}getOpacityAtLatLng(y,M){return this._transform.projection.supportsFog?function(C,L,F){const N=x.MercatorCoordinate.fromLngLat(L),q=F.elevation?F.elevation.getAtPointOrZero(N):0,W=[N.x,N.y,q];return x.transformMat4(W,W,F.mercatorFogMatrix),ge(C,W,F.pitch,F._fov)}(this.state,y,M):0}getFovAdjustedRange(y){return this._transform.projection.supportsFog?Le(this.state,y):[0,1]}updateTransitions(y){this._transitioning=this._transitionable.transitioned(y,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(y){this.properties=this._transitioning.possiblyEvaluate(y)}_validate(y,M,C){return(!C||C.validate!==!1)&&x.emitValidationErrors(this,y.call(x.validateStyle,x.extend({value:M,style:{glyphs:!0,sprite:!0},styleSpec:x.spec})))}}class Rt{constructor(y,M){this.workerPool=y,this.actors=[],this.currentActor=0,this.id=x.uniqueId();const C=this.workerPool.acquire(this.id);for(let L=0;L<C.length;L++){const F=new Rt.Actor(C[L],M,this.id);F.name=`Worker ${L}`,this.actors.push(F)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(y,M,C){x.asyncAll(this.actors,(L,F)=>{L.send(y,M,F)},C=C||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(y=>{y.remove()}),this.actors=[],this.workerPool.release(this.id)}}function Bt(I,y,M){return y*(x.EXTENT/(I.tileSize*Math.pow(2,M-I.tileID.overscaledZ)))}Rt.Actor=x.Actor;class At{constructor(y,M,C){this.context=y;const L=y.gl;this.buffer=L.createBuffer(),this.dynamicDraw=Boolean(C),this.context.unbindVAO(),y.bindElementBuffer.set(this.buffer),L.bufferData(L.ELEMENT_ARRAY_BUFFER,M.arrayBuffer,this.dynamicDraw?L.DYNAMIC_DRAW:L.STATIC_DRAW),this.dynamicDraw||delete M.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(y){const M=this.context.gl;this.context.unbindVAO(),this.bind(),M.bufferSubData(M.ELEMENT_ARRAY_BUFFER,0,y.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Nt={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class zt{constructor(y,M,C,L){this.length=M.length,this.attributes=C,this.itemSize=M.bytesPerElement,this.dynamicDraw=L,this.context=y;const F=y.gl;this.buffer=F.createBuffer(),y.bindVertexBuffer.set(this.buffer),F.bufferData(F.ARRAY_BUFFER,M.arrayBuffer,this.dynamicDraw?F.DYNAMIC_DRAW:F.STATIC_DRAW),this.dynamicDraw||delete M.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(y){const M=this.context.gl;this.bind(),M.bufferSubData(M.ARRAY_BUFFER,0,y.arrayBuffer)}enableAttributes(y,M){for(let C=0;C<this.attributes.length;C++){const L=M.attributes[this.attributes[C].name];L!==void 0&&y.enableVertexAttribArray(L)}}setVertexAttribPointers(y,M,C){for(let L=0;L<this.attributes.length;L++){const F=this.attributes[L],N=M.attributes[F.name];N!==void 0&&y.vertexAttribPointer(N,F.components,y[Nt[F.type]],!1,this.itemSize,F.offset+this.itemSize*(C||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Tt{constructor(y){this.gl=y.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(y){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ii extends Tt{getDefault(){return x.Color.transparent}set(y){const M=this.current;(y.r!==M.r||y.g!==M.g||y.b!==M.b||y.a!==M.a||this.dirty)&&(this.gl.clearColor(y.r,y.g,y.b,y.a),this.current=y,this.dirty=!1)}}class Mt extends Tt{getDefault(){return 1}set(y){(y!==this.current||this.dirty)&&(this.gl.clearDepth(y),this.current=y,this.dirty=!1)}}class St extends Tt{getDefault(){return 0}set(y){(y!==this.current||this.dirty)&&(this.gl.clearStencil(y),this.current=y,this.dirty=!1)}}class wt extends Tt{getDefault(){return[!0,!0,!0,!0]}set(y){const M=this.current;(y[0]!==M[0]||y[1]!==M[1]||y[2]!==M[2]||y[3]!==M[3]||this.dirty)&&(this.gl.colorMask(y[0],y[1],y[2],y[3]),this.current=y,this.dirty=!1)}}class Ut extends Tt{getDefault(){return!0}set(y){(y!==this.current||this.dirty)&&(this.gl.depthMask(y),this.current=y,this.dirty=!1)}}class Vt extends Tt{getDefault(){return 255}set(y){(y!==this.current||this.dirty)&&(this.gl.stencilMask(y),this.current=y,this.dirty=!1)}}class pi extends Tt{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(y){const M=this.current;(y.func!==M.func||y.ref!==M.ref||y.mask!==M.mask||this.dirty)&&(this.gl.stencilFunc(y.func,y.ref,y.mask),this.current=y,this.dirty=!1)}}class ni extends Tt{getDefault(){const y=this.gl;return[y.KEEP,y.KEEP,y.KEEP]}set(y){const M=this.current;(y[0]!==M[0]||y[1]!==M[1]||y[2]!==M[2]||this.dirty)&&(this.gl.stencilOp(y[0],y[1],y[2]),this.current=y,this.dirty=!1)}}class _i extends Tt{getDefault(){return!1}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;y?M.enable(M.STENCIL_TEST):M.disable(M.STENCIL_TEST),this.current=y,this.dirty=!1}}class yi extends Tt{getDefault(){return[0,1]}set(y){const M=this.current;(y[0]!==M[0]||y[1]!==M[1]||this.dirty)&&(this.gl.depthRange(y[0],y[1]),this.current=y,this.dirty=!1)}}class Ri extends Tt{getDefault(){return!1}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;y?M.enable(M.DEPTH_TEST):M.disable(M.DEPTH_TEST),this.current=y,this.dirty=!1}}class di extends Tt{getDefault(){return this.gl.LESS}set(y){(y!==this.current||this.dirty)&&(this.gl.depthFunc(y),this.current=y,this.dirty=!1)}}class pt extends Tt{getDefault(){return!1}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;y?M.enable(M.BLEND):M.disable(M.BLEND),this.current=y,this.dirty=!1}}class xt extends Tt{getDefault(){const y=this.gl;return[y.ONE,y.ZERO]}set(y){const M=this.current;(y[0]!==M[0]||y[1]!==M[1]||this.dirty)&&(this.gl.blendFunc(y[0],y[1]),this.current=y,this.dirty=!1)}}class fi extends Tt{getDefault(){return x.Color.transparent}set(y){const M=this.current;(y.r!==M.r||y.g!==M.g||y.b!==M.b||y.a!==M.a||this.dirty)&&(this.gl.blendColor(y.r,y.g,y.b,y.a),this.current=y,this.dirty=!1)}}class oi extends Tt{getDefault(){return this.gl.FUNC_ADD}set(y){(y!==this.current||this.dirty)&&(this.gl.blendEquation(y),this.current=y,this.dirty=!1)}}class He extends Tt{getDefault(){return!1}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;y?M.enable(M.CULL_FACE):M.disable(M.CULL_FACE),this.current=y,this.dirty=!1}}class Ht extends Tt{getDefault(){return this.gl.BACK}set(y){(y!==this.current||this.dirty)&&(this.gl.cullFace(y),this.current=y,this.dirty=!1)}}class Pt extends Tt{getDefault(){return this.gl.CCW}set(y){(y!==this.current||this.dirty)&&(this.gl.frontFace(y),this.current=y,this.dirty=!1)}}class ei extends Tt{getDefault(){return null}set(y){(y!==this.current||this.dirty)&&(this.gl.useProgram(y),this.current=y,this.dirty=!1)}}class ri extends Tt{getDefault(){return this.gl.TEXTURE0}set(y){(y!==this.current||this.dirty)&&(this.gl.activeTexture(y),this.current=y,this.dirty=!1)}}class vt extends Tt{getDefault(){const y=this.gl;return[0,0,y.drawingBufferWidth,y.drawingBufferHeight]}set(y){const M=this.current;(y[0]!==M[0]||y[1]!==M[1]||y[2]!==M[2]||y[3]!==M[3]||this.dirty)&&(this.gl.viewport(y[0],y[1],y[2],y[3]),this.current=y,this.dirty=!1)}}class Di extends Tt{getDefault(){return null}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;M.bindFramebuffer(M.FRAMEBUFFER,y),this.current=y,this.dirty=!1}}class Wt extends Tt{getDefault(){return null}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;M.bindRenderbuffer(M.RENDERBUFFER,y),this.current=y,this.dirty=!1}}class Gt extends Tt{getDefault(){return null}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;M.bindTexture(M.TEXTURE_2D,y),this.current=y,this.dirty=!1}}class qt extends Tt{getDefault(){return null}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;M.bindBuffer(M.ARRAY_BUFFER,y),this.current=y,this.dirty=!1}}class It extends Tt{getDefault(){return null}set(y){const M=this.gl;M.bindBuffer(M.ELEMENT_ARRAY_BUFFER,y),this.current=y,this.dirty=!1}}class hi extends Tt{constructor(y){super(y),this.vao=y.extVertexArrayObject}getDefault(){return null}set(y){this.vao&&(y!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(y),this.current=y,this.dirty=!1)}}class xi extends Tt{getDefault(){return 4}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;M.pixelStorei(M.UNPACK_ALIGNMENT,y),this.current=y,this.dirty=!1}}class Ei extends Tt{getDefault(){return!1}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;M.pixelStorei(M.UNPACK_PREMULTIPLY_ALPHA_WEBGL,y),this.current=y,this.dirty=!1}}class Qt extends Tt{getDefault(){return!1}set(y){if(y===this.current&&!this.dirty)return;const M=this.gl;M.pixelStorei(M.UNPACK_FLIP_Y_WEBGL,y),this.current=y,this.dirty=!1}}class ai extends Tt{constructor(y,M){super(y),this.context=y,this.parent=M}getDefault(){return null}}class $i extends ai{setDirty(){this.dirty=!0}set(y){if(y===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const M=this.gl;M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,y,0),this.current=y,this.dirty=!1}}class Si extends ai{attachment(){return this.gl.DEPTH_ATTACHMENT}set(y){if(y===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const M=this.gl;M.framebufferRenderbuffer(M.FRAMEBUFFER,this.attachment(),M.RENDERBUFFER,y),this.current=y,this.dirty=!1}}class Zi extends Si{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class Ai{constructor(y,M,C,L){this.context=y,this.width=M,this.height=C;const F=this.framebuffer=y.gl.createFramebuffer();this.colorAttachment=new $i(y,F),L&&(this.depthAttachment=new Si(y,F))}destroy(){const y=this.context.gl,M=this.colorAttachment.get();if(M&&y.deleteTexture(M),this.depthAttachment){const C=this.depthAttachment.get();C&&y.deleteRenderbuffer(C)}y.deleteFramebuffer(this.framebuffer)}}class dr{constructor(y){this.gl=y,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new ii(this),this.clearDepth=new Mt(this),this.clearStencil=new St(this),this.colorMask=new wt(this),this.depthMask=new Ut(this),this.stencilMask=new Vt(this),this.stencilFunc=new pi(this),this.stencilOp=new ni(this),this.stencilTest=new _i(this),this.depthRange=new yi(this),this.depthTest=new Ri(this),this.depthFunc=new di(this),this.blend=new pt(this),this.blendFunc=new xt(this),this.blendColor=new fi(this),this.blendEquation=new oi(this),this.cullFace=new He(this),this.cullFaceSide=new Ht(this),this.frontFace=new Pt(this),this.program=new ei(this),this.activeTexture=new ri(this),this.viewport=new vt(this),this.bindFramebuffer=new Di(this),this.bindRenderbuffer=new Wt(this),this.bindTexture=new Gt(this),this.bindVertexBuffer=new qt(this),this.bindElementBuffer=new It(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new hi(this),this.pixelStoreUnpack=new xi(this),this.pixelStoreUnpackPremultiplyAlpha=new Ei(this),this.pixelStoreUnpackFlipY=new Qt(this),this.extTextureFilterAnisotropic=y.getExtension("EXT_texture_filter_anisotropic")||y.getExtension("MOZ_EXT_texture_filter_anisotropic")||y.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=y.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extTextureHalfFloat=y.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(y.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=y.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=y.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=y.getParameter(y.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(y,M){return new At(this,y,M)}createVertexBuffer(y,M,C){return new zt(this,y,M,C)}createRenderbuffer(y,M,C){const L=this.gl,F=L.createRenderbuffer();return this.bindRenderbuffer.set(F),L.renderbufferStorage(L.RENDERBUFFER,y,M,C),this.bindRenderbuffer.set(null),F}createFramebuffer(y,M,C){return new Ai(this,y,M,C)}clear({color:y,depth:M,stencil:C}){const L=this.gl;let F=0;y&&(F|=L.COLOR_BUFFER_BIT,this.clearColor.set(y),this.colorMask.set([!0,!0,!0,!0])),M!==void 0&&(F|=L.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(M),this.depthMask.set(!0)),C!==void 0&&(F|=L.STENCIL_BUFFER_BIT,this.clearStencil.set(C),this.stencilMask.set(255)),L.clear(F)}setCullFace(y){y.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(y.mode),this.frontFace.set(y.frontFace))}setDepthMode(y){y.func!==this.gl.ALWAYS||y.mask?(this.depthTest.set(!0),this.depthFunc.set(y.func),this.depthMask.set(y.mask),this.depthRange.set(y.range)):this.depthTest.set(!1)}setStencilMode(y){y.test.func!==this.gl.ALWAYS||y.mask?(this.stencilTest.set(!0),this.stencilMask.set(y.mask),this.stencilOp.set([y.fail,y.depthFail,y.pass]),this.stencilFunc.set({func:y.test.func,ref:y.ref,mask:y.test.mask})):this.stencilTest.set(!1)}setColorMode(y){G(y.blendFunction,x.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(y.blendFunction),this.blendColor.set(y.blendColor)),this.colorMask.set(y.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class on{constructor(y,M,C,L){this.screenBounds=y,this.cameraPoint=M,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=C,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this.screenGeometry.map(F=>L.pointCoordinate3D(F)),this.cameraGeometry=this.bufferedCameraGeometry(0)}static createFromScreenPoints(y,M){let C,L;if(y instanceof x.pointGeometry||typeof y[0]=="number"){const F=x.pointGeometry.convert(y);C=[x.pointGeometry.convert(y)],L=M.isPointAboveHorizon(F)}else{const F=x.pointGeometry.convert(y[0]),N=x.pointGeometry.convert(y[1]);C=[F,N],L=x.polygonizeBounds(F,N).every(q=>M.isPointAboveHorizon(q))}return new on(C,M.getCameraPoint(),L,M)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(y){return x.polygonizeBounds(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],y)}bufferedCameraGeometry(y){const M=this.screenBounds[0],C=this.screenBounds.length===1?this.screenBounds[0].add(new x.pointGeometry(1,1)):this.screenBounds[1],L=x.polygonizeBounds(M,C,0,!1);return this.cameraPoint.y>C.y&&(this.cameraPoint.x>M.x&&this.cameraPoint.x<C.x?L.splice(3,0,this.cameraPoint):this.cameraPoint.x>=C.x?L[2]=this.cameraPoint:this.cameraPoint.x<=M.x&&(L[3]=this.cameraPoint)),x.bufferConvexPolygon(L,y)}containsTile(y,M,C){const L=y.queryPadding+1,F=y.tileID.wrap,N=C?this._bufferedCameraMercator(L,M).map(ye=>x.getTilePoint(y.tileTransform,ye,F)):this._bufferedScreenMercator(L,M).map(ye=>x.getTilePoint(y.tileTransform,ye,F)),q=this.screenGeometryMercator.map(ye=>x.getTileVec3(y.tileTransform,ye,F)),W=q.map(ye=>new x.pointGeometry(ye[0],ye[1])),J=M.getFreeCameraOptions().position||new x.MercatorCoordinate(0,0,0),ee=x.getTileVec3(y.tileTransform,J,F),ne=q.map(ye=>{const Ee=x.sub(ye,ye,ee);return x.normalize(Ee,Ee),new x.Ray(ee,Ee)}),fe=Bt(y,1,M.zoom);if(x.polygonIntersectsBox(N,0,0,x.EXTENT,x.EXTENT))return{queryGeometry:this,tilespaceGeometry:W,tilespaceRays:ne,bufferedTilespaceGeometry:N,bufferedTilespaceBounds:(we=x.getBounds(N),we.min.x=x.clamp(we.min.x,0,x.EXTENT),we.min.y=x.clamp(we.min.y,0,x.EXTENT),we.max.x=x.clamp(we.max.x,0,x.EXTENT),we.max.y=x.clamp(we.max.y,0,x.EXTENT),we),tile:y,tileID:y.tileID,pixelToTileUnitsFactor:fe};var we}_bufferedScreenMercator(y,M){const C=fr(y);if(this._screenRaycastCache[C])return this._screenRaycastCache[C];{const L=this.bufferedScreenGeometry(y).map(F=>M.pointCoordinate3D(F));return this._screenRaycastCache[C]=L,L}}_bufferedCameraMercator(y,M){const C=fr(y);if(this._cameraRaycastCache[C])return this._cameraRaycastCache[C];{const L=this.bufferedCameraGeometry(y).map(F=>M.pointCoordinate3D(F));return this._cameraRaycastCache[C]=L,L}}}function fr(I){return 100*I|0}function Rr(I,y,M){const C=function(L,F){if(L)return M(L);if(F){const N=x.pick(x.extend(F,I),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);F.vector_layers&&(N.vectorLayers=F.vector_layers,N.vectorLayerIds=N.vectorLayers.map(q=>q.id)),N.tiles=y.canonicalizeTileset(N,I.url),M(null,N)}};return I.url?x.getJSON(y.transformRequest(y.normalizeSourceURL(I.url),x.ResourceType.Source),C):x.exported.frame(()=>C(null,I))}class Br{constructor(y,M,C){this.bounds=x.LngLatBounds.convert(this.validateBounds(y)),this.minzoom=M||0,this.maxzoom=C||24}validateBounds(y){return Array.isArray(y)&&y.length===4?[Math.max(-180,y[0]),Math.max(-90,y[1]),Math.min(180,y[2]),Math.min(90,y[3])]:[-180,-90,180,90]}contains(y){const M=Math.pow(2,y.z),C=Math.floor(x.mercatorXfromLng(this.bounds.getWest())*M),L=Math.floor(x.mercatorYfromLat(this.bounds.getNorth())*M),F=Math.ceil(x.mercatorXfromLng(this.bounds.getEast())*M),N=Math.ceil(x.mercatorYfromLat(this.bounds.getSouth())*M);return y.x>=C&&y.x<F&&y.y>=L&&y.y<N}}class Er extends x.Evented{constructor(y,M,C,L){super(),this.id=y,this.dispatcher=C,this.setEventedParent(L),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=x.extend({type:"raster"},M),x.extend(this,x.pick(M,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new x.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=Rr(this._options,this.map._requestManager,(y,M)=>{this._tileJSONRequest=null,this._loaded=!0,y?this.fire(new x.ErrorEvent(y)):M&&(x.extend(this,M),M.bounds&&(this.tileBounds=new Br(M.bounds,this.minzoom,this.maxzoom)),x.postTurnstileEvent(M.tiles),this.fire(new x.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new x.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(y){this.map=y,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return x.extend({},this._options)}hasTile(y){return!this.tileBounds||this.tileBounds.contains(y.canonical)}loadTile(y,M){const C=x.exported.devicePixelRatio>=2,L=this.map._requestManager.normalizeTileURL(y.tileID.canonical.url(this.tiles,this.scheme),C,this.tileSize);y.request=x.getImage(this.map._requestManager.transformRequest(L,x.ResourceType.Tile),(F,N,q,W)=>{if(delete y.request,y.aborted)y.state="unloaded",M(null);else if(F)y.state="errored",M(F);else if(N){this.map._refreshExpiredTiles&&y.setExpiryData({cacheControl:q,expires:W});const J=this.map.painter.context,ee=J.gl;y.texture=this.map.painter.getTileTexture(N.width),y.texture?y.texture.update(N,{useMipmap:!0}):(y.texture=new x.Texture(J,N,ee.RGBA,{useMipmap:!0}),y.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE),J.extTextureFilterAnisotropic&&ee.texParameterf(ee.TEXTURE_2D,J.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,J.extTextureFilterAnisotropicMax)),y.state="loaded",x.cacheEntryPossiblyAdded(this.dispatcher),M(null)}})}abortTile(y,M){y.request&&(y.request.cancel(),delete y.request),M()}unloadTile(y,M){y.texture&&this.map.painter.saveTileTexture(y.texture),M()}hasTransition(){return!1}}let vr;function $r(I,y,M,C,L,F,N,q){const W=[I,M,L,y,C,F,1,1,1],J=[N,q,1],ee=x.adjoint([],W),[ne,fe,we]=x.transformMat3(J,J,x.transpose(ee,ee));return x.multiply(W,[ne,0,0,0,fe,0,0,0,we],W)}class Mr extends x.Evented{constructor(y,M,C,L){super(),this.id=y,this.dispatcher=C,this.coordinates=M.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(L),this.options=M}load(y,M){this._loaded=!1,this.fire(new x.Event("dataloading",{dataType:"source"})),this.url=this.options.url,x.getImage(this.map._requestManager.transformRequest(this.url,x.ResourceType.Image),(C,L)=>{this._loaded=!0,C?this.fire(new x.ErrorEvent(C)):L&&(this.image=x.exported.getImageData(L),this.width=this.image.width,this.height=this.image.height,y&&(this.coordinates=y),M&&M(),this._finishLoading())})}loaded(){return this._loaded}updateImage(y){return this.image&&y.url?(this.options.url=y.url,this.load(y.coordinates,()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new x.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(y){this.map=y,this.load()}setCoordinates(y){this.coordinates=y,delete this._boundsArray;const M=y.map(x.MercatorCoordinate.fromLngLat);return this.tileID=function(C){let L=1/0,F=1/0,N=-1/0,q=-1/0;for(const ne of C)L=Math.min(L,ne.x),F=Math.min(F,ne.y),N=Math.max(N,ne.x),q=Math.max(q,ne.y);const W=Math.max(N-L,q-F),J=Math.max(0,Math.floor(-Math.log(W)/Math.LN2)),ee=Math.pow(2,J);return new x.CanonicalTileID(J,Math.floor((L+N)/2*ee),Math.floor((F+q)/2*ee))}(M),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new x.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){delete this._boundsArray}_makeBoundsArray(){const y=x.tileTransform(this.tileID,this.map.transform.projection),[M,C,L,F]=this.coordinates.map(N=>{const q=y.projection.project(N[0],N[1]);return x.getTilePoint(y,q)._round()});return this.perspectiveTransform=function(N,q,W,J,ee,ne,fe,we,ye,Ee){const ze=$r(0,0,N,0,0,q,N,q),be=$r(W,J,ee,ne,fe,we,ye,Ee);return x.multiply(be,x.adjoint(ze,ze),be),[be[6]/be[8]*N/x.EXTENT,be[7]/be[8]*q/x.EXTENT]}(this.width,this.height,M.x,M.y,C.x,C.y,F.x,F.y,L.x,L.y),this._boundsArray=new x.StructArrayLayout4i8,this._boundsArray.emplaceBack(M.x,M.y,0,0),this._boundsArray.emplaceBack(C.x,C.y,x.EXTENT,0),this._boundsArray.emplaceBack(F.x,F.y,0,x.EXTENT),this._boundsArray.emplaceBack(L.x,L.y,x.EXTENT,x.EXTENT),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const y=this.map.painter.context,M=y.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=y.createVertexBuffer(this._boundsArray,x.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=x.SegmentVector.simpleSegment(0,0,4,2)),this.texture||(this.texture=new x.Texture(y,this.image,M.RGBA),this.texture.bind(M.LINEAR,M.CLAMP_TO_EDGE));for(const C in this.tiles){const L=this.tiles[C];L.state!=="loaded"&&(L.state="loaded",L.texture=this.texture)}}loadTile(y,M){this.tileID&&this.tileID.equals(y.tileID.canonical)?(this.tiles[String(y.tileID.wrap)]=y,y.buckets={},M(null)):(y.state="errored",M(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const Te={vector:class extends x.Evented{constructor(I,y,M,C){if(super(),this.id=I,this.dispatcher=M,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,x.extend(this,x.pick(y,["url","scheme","tileSize","promoteId"])),this._options=x.extend({type:"vector"},y),this._collectResourceTiming=y.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(C),this._tileWorkers={},this._deduped=new x.DedupedRequest}load(){this._loaded=!1,this.fire(new x.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=Rr(this._options,this.map._requestManager,(I,y)=>{this._tileJSONRequest=null,this._loaded=!0,I?this.fire(new x.ErrorEvent(I)):y&&(x.extend(this,y),y.bounds&&(this.tileBounds=new Br(y.bounds,this.minzoom,this.maxzoom)),x.postTurnstileEvent(y.tiles,this.map._requestManager._customAccessToken),this.fire(new x.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new x.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}hasTile(I){return!this.tileBounds||this.tileBounds.contains(I.canonical)}onAdd(I){this.map=I,this.load()}setSourceProperty(I){this._tileJSONRequest&&this._tileJSONRequest.cancel(),I();const y=this.map.style._getSourceCaches(this.id);for(const M of y)M.clearTiles();this.load()}setTiles(I){return this.setSourceProperty(()=>{this._options.tiles=I}),this}setUrl(I){return this.setSourceProperty(()=>{this.url=I,this._options.url=I}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return x.extend({},this._options)}loadTile(I,y){const M=this.map._requestManager.normalizeTileURL(I.tileID.canonical.url(this.tiles,this.scheme)),C={request:this.map._requestManager.transformRequest(M,x.ResourceType.Tile),data:void 0,uid:I.uid,tileID:I.tileID,tileZoom:I.tileZoom,zoom:I.tileID.overscaledZ,tileSize:this.tileSize*I.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:x.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:I.isSymbolTile};if(C.request.collectResourceTiming=this._collectResourceTiming,I.actor&&I.state!=="expired")I.state==="loading"?I.reloadCallback=y:I.request=I.actor.send("reloadTile",C,L.bind(this));else if(I.actor=this._tileWorkers[M]=this._tileWorkers[M]||this.dispatcher.getActor(),this.dispatcher.ready)I.request=I.actor.send("loadTile",C,L.bind(this),void 0,!0);else{const F=x.loadVectorTile.call({deduped:this._deduped},C,(N,q)=>{N||!q?L.call(this,N):(C.data={cacheControl:q.cacheControl,expires:q.expires,rawData:q.rawData.slice(0)},I.actor&&I.actor.send("loadTile",C,L.bind(this),void 0,!0))},!0);I.request={cancel:F}}function L(F,N){return delete I.request,I.aborted?y(null):F&&F.status!==404?y(F):(N&&N.resourceTiming&&(I.resourceTiming=N.resourceTiming),this.map._refreshExpiredTiles&&N&&I.setExpiryData(N),I.loadVectorData(N,this.map.painter),x.cacheEntryPossiblyAdded(this.dispatcher),y(null),void(I.reloadCallback&&(this.loadTile(I,I.reloadCallback),I.reloadCallback=null)))}}abortTile(I){I.request&&(I.request.cancel(),delete I.request),I.actor&&I.actor.send("abortTile",{uid:I.uid,type:this.type,source:this.id})}unloadTile(I){I.unloadVectorData(),I.actor&&I.actor.send("removeTile",{uid:I.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}},raster:Er,"raster-dem":class extends Er{constructor(I,y,M,C){super(I,y,M,C),this.type="raster-dem",this.maxzoom=22,this._options=x.extend({type:"raster-dem"},y),this.encoding=y.encoding||"mapbox"}loadTile(I,y){const M=this.map._requestManager.normalizeTileURL(I.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function C(L,F){L&&(I.state="errored",y(L)),F&&(I.dem=F,I.dem.onDeserialize(),I.needsHillshadePrepare=!0,I.needsDEMTextureUpload=!0,I.state="loaded",y(null))}I.request=x.getImage(this.map._requestManager.transformRequest(M,x.ResourceType.Tile),function(L,F,N,q){if(delete I.request,I.aborted)I.state="unloaded",y(null);else if(L)I.state="errored",y(L);else if(F){this.map._refreshExpiredTiles&&I.setExpiryData({cacheControl:N,expires:q});const W=x.window.ImageBitmap&&F instanceof x.window.ImageBitmap&&(vr==null&&(vr=x.window.OffscreenCanvas&&new x.window.OffscreenCanvas(1,1).getContext("2d")&&typeof x.window.createImageBitmap=="function"),vr),J=1-(F.width-x.prevPowerOfTwo(F.width))/2;J<1||I.neighboringTiles||(I.neighboringTiles=this._getNeighboringTiles(I.tileID));const ee=W?F:x.exported.getImageData(F,J),ne={uid:I.uid,coord:I.tileID,source:this.id,rawImageData:ee,encoding:this.encoding,padding:J};I.actor&&I.state!=="expired"||(I.actor=this.dispatcher.getActor(),I.actor.send("loadDEMTile",ne,C.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(I){const y=I.canonical,M=Math.pow(2,y.z),C=(y.x-1+M)%M,L=y.x===0?I.wrap-1:I.wrap,F=(y.x+1+M)%M,N=y.x+1===M?I.wrap+1:I.wrap,q={};return q[new x.OverscaledTileID(I.overscaledZ,L,y.z,C,y.y).key]={backfilled:!1},q[new x.OverscaledTileID(I.overscaledZ,N,y.z,F,y.y).key]={backfilled:!1},y.y>0&&(q[new x.OverscaledTileID(I.overscaledZ,L,y.z,C,y.y-1).key]={backfilled:!1},q[new x.OverscaledTileID(I.overscaledZ,I.wrap,y.z,y.x,y.y-1).key]={backfilled:!1},q[new x.OverscaledTileID(I.overscaledZ,N,y.z,F,y.y-1).key]={backfilled:!1}),y.y+1<M&&(q[new x.OverscaledTileID(I.overscaledZ,L,y.z,C,y.y+1).key]={backfilled:!1},q[new x.OverscaledTileID(I.overscaledZ,I.wrap,y.z,y.x,y.y+1).key]={backfilled:!1},q[new x.OverscaledTileID(I.overscaledZ,N,y.z,F,y.y+1).key]={backfilled:!1}),q}unloadTile(I){I.demTexture&&this.map.painter.saveTileTexture(I.demTexture),I.fbo&&(I.fbo.destroy(),delete I.fbo),I.dem&&delete I.dem,delete I.neighboringTiles,I.state="unloaded"}},geojson:class extends x.Evented{constructor(I,y,M,C){super(),this.id=I,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=M.getActor(),this.setEventedParent(C),this._data=y.data,this._options=x.extend({},y),this._collectResourceTiming=y.collectResourceTiming,y.maxzoom!==void 0&&(this.maxzoom=y.maxzoom),y.type&&(this.type=y.type),y.attribution&&(this.attribution=y.attribution),this.promoteId=y.promoteId;const L=x.EXTENT/this.tileSize;this.workerOptions=x.extend({source:this.id,cluster:y.cluster||!1,geojsonVtOptions:{buffer:(y.buffer!==void 0?y.buffer:128)*L,tolerance:(y.tolerance!==void 0?y.tolerance:.375)*L,extent:x.EXTENT,maxZoom:this.maxzoom,lineMetrics:y.lineMetrics||!1,generateId:y.generateId||!1},superclusterOptions:{maxZoom:y.clusterMaxZoom!==void 0?y.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,y.clusterMinPoints||2),extent:x.EXTENT,radius:(y.clusterRadius!==void 0?y.clusterRadius:50)*L,log:!1,generateId:y.generateId||!1},clusterProperties:y.clusterProperties,filter:y.filter},y.workerOptions)}onAdd(I){this.map=I,this.setData(this._data)}setData(I){return this._data=I,this._updateWorkerData(),this}getClusterExpansionZoom(I,y){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:I,source:this.id},y),this}getClusterChildren(I,y){return this.actor.send("geojson.getClusterChildren",{clusterId:I,source:this.id},y),this}getClusterLeaves(I,y,M,C){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:I,limit:y,offset:M},C),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new x.Event("dataloading",{dataType:"source"})),this._loaded=!1;const I=x.extend({},this.workerOptions),y=this._data;typeof y=="string"?(I.request=this.map._requestManager.transformRequest(x.exported.resolveURL(y),x.ResourceType.Source),I.request.collectResourceTiming=this._collectResourceTiming):I.data=JSON.stringify(y),this._pendingLoad=this.actor.send(`${this.type}.loadData`,I,(M,C)=>{if(this._loaded=!0,this._pendingLoad=null,M)this.fire(new x.ErrorEvent(M));else{const L={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&C&&C.resourceTiming&&C.resourceTiming[this.id]&&(L.resourceTiming=C.resourceTiming[this.id]),this.fire(new x.Event("data",L)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(I,y){const M=I.actor?"reloadTile":"loadTile";I.actor=this.actor,I.request=this.actor.send(M,{type:this.type,uid:I.uid,tileID:I.tileID,tileZoom:I.tileZoom,zoom:I.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:x.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(C,L)=>(delete I.request,I.unloadVectorData(),I.aborted?y(null):C?y(C):(I.loadVectorData(L,this.map.painter,M==="reloadTile"),y(null))),void 0,M==="loadTile")}abortTile(I){I.request&&(I.request.cancel(),delete I.request),I.aborted=!0}unloadTile(I){I.unloadVectorData(),this.actor.send("removeTile",{uid:I.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return x.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Mr{constructor(I,y,M,C){super(I,y,M,C),this.roundZoom=!0,this.type="video",this.options=y}load(){this._loaded=!1;const I=this.options;this.urls=[];for(const y of I.urls)this.urls.push(this.map._requestManager.transformRequest(y,x.ResourceType.Source).url);x.getVideo(this.urls,(y,M)=>{this._loaded=!0,y?this.fire(new x.ErrorEvent(y)):M&&(this.video=M,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(I){if(this.video){const y=this.video.seekable;I<y.start(0)||I>y.end(0)?this.fire(new x.ErrorEvent(new x.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${y.start(0)} and ${y.end(0)}-second mark.`))):this.video.currentTime=I}}getVideo(){return this.video}onAdd(I){this.map||(this.map=I,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const I=this.map.painter.context,y=I.gl;this.texture?this.video.paused||(this.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE),y.texSubImage2D(y.TEXTURE_2D,0,0,0,y.RGBA,y.UNSIGNED_BYTE,this.video)):(this.texture=new x.Texture(I,this.video,y.RGBA),this.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=I.createVertexBuffer(this._boundsArray,x.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=x.SegmentVector.simpleSegment(0,0,4,2));for(const M in this.tiles){const C=this.tiles[M];C.state!=="loaded"&&(C.state="loaded",C.texture=this.texture)}}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Mr,canvas:class extends Mr{constructor(I,y,M,C){super(I,y,M,C),y.coordinates?Array.isArray(y.coordinates)&&y.coordinates.length===4&&!y.coordinates.some(L=>!Array.isArray(L)||L.length!==2||L.some(F=>typeof F!="number"))||this.fire(new x.ErrorEvent(new x.ValidationError(`sources.${I}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new x.ErrorEvent(new x.ValidationError(`sources.${I}`,null,'missing required property "coordinates"'))),y.animate&&typeof y.animate!="boolean"&&this.fire(new x.ErrorEvent(new x.ValidationError(`sources.${I}`,null,'optional "animate" property must be a boolean value'))),y.canvas?typeof y.canvas=="string"||y.canvas instanceof x.window.HTMLCanvasElement||this.fire(new x.ErrorEvent(new x.ValidationError(`sources.${I}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new x.ErrorEvent(new x.ValidationError(`sources.${I}`,null,'missing required property "canvas"'))),this.options=y,this.animate=y.animate===void 0||y.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof x.window.HTMLCanvasElement?this.options.canvas:x.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new x.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(I){this.map=I,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let I=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,I=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,I=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const y=this.map.painter.context,M=y.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=y.createVertexBuffer(this._boundsArray,x.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=x.SegmentVector.simpleSegment(0,0,4,2)),this.texture?(I||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new x.Texture(y,this.canvas,M.RGBA,{premultiply:!0});for(const C in this.tiles){const L=this.tiles[C];L.state!=="loaded"&&(L.state="loaded",L.texture=this.texture)}}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const I of[this.canvas.width,this.canvas.height])if(isNaN(I)||I<=0)return!0;return!1}}},je=function(I,y,M,C){const L=new Te[y.type](I,y,M,C);if(L.id!==I)throw new Error(`Expected Source id to be ${I} instead of ${L.id}`);return x.bindAll(["load","abort","unload","serialize","prepare"],L),L};function ae(I,y){const M=x.identity([]);return x.scale(M,M,[.5*I.width,.5*-I.height,1]),x.translate(M,M,[1,-1,0]),x.multiply$1(M,M,I.calculateProjMatrix(y.toUnwrapped()))}function K(I,y,M,C,L,F,N,q=!1){const W=I.tilesIn(C,N,q);W.sort(de);const J=[];for(const ne of W)J.push({wrappedTileID:ne.tile.tileID.wrapped().key,queryResults:ne.tile.queryRenderedFeatures(y,M,I._state,ne,L,F,ae(I.transform,ne.tile.tileID),q)});const ee=function(ne){const fe={},we={};for(const ye of ne){const Ee=ye.queryResults,ze=ye.wrappedTileID,be=we[ze]=we[ze]||{};for(const Ce in Ee){const Pe=Ee[Ce],Ie=be[Ce]=be[Ce]||{},ke=fe[Ce]=fe[Ce]||[];for(const Fe of Pe)Ie[Fe.featureIndex]||(Ie[Fe.featureIndex]=!0,ke.push(Fe))}}return fe}(J);for(const ne in ee)ee[ne].forEach(fe=>{const we=fe.feature,ye=I.getFeatureState(we.layer["source-layer"],we.id);we.source=we.layer.source,we.layer["source-layer"]&&(we.sourceLayer=we.layer["source-layer"]),we.state=ye});return ee}function re(I,y){const M=I.getRenderableIds().map(F=>I.getTileByID(F)),C=[],L={};for(let F=0;F<M.length;F++){const N=M[F],q=N.tileID.canonical.key;L[q]||(L[q]=!0,N.querySourceFeatures(C,y))}return C}function de(I,y){const M=I.tileID,C=y.tileID;return M.overscaledZ-C.overscaledZ||M.canonical.y-C.canonical.y||M.wrap-C.wrap||M.canonical.x-C.canonical.x}function Se(){return eo.workerClass!=null?new eo.workerClass:new x.window.Worker(eo.workerUrl)}const De="mapboxgl_preloaded_worker_pool";class Ue{constructor(){this.active={}}acquire(y){if(!this.workers)for(this.workers=[];this.workers.length<Ue.workerCount;)this.workers.push(new Se);return this.active[y]=!0,this.workers.slice()}release(y){delete this.active[y],this.numActive()===0&&(this.workers.forEach(M=>{M.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[De]}numActive(){return Object.keys(this.active).length}}let Ne;function Oe(){return Ne||(Ne=new Ue),Ne}function qe(I,y){const M={};for(const C in I)C!=="ref"&&(M[C]=I[C]);return x.refProperties.forEach(C=>{C in y&&(M[C]=y[C])}),M}function Je(I){I=I.slice();const y=Object.create(null);for(let M=0;M<I.length;M++)y[I[M].id]=I[M];for(let M=0;M<I.length;M++)"ref"in I[M]&&(I[M]=qe(I[M],y[I[M].ref]));return I}Ue.workerCount=2;const Qe={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function at(I,y,M){M.push({command:Qe.addSource,args:[I,y[I]]})}function kt(I,y,M){y.push({command:Qe.removeSource,args:[I]}),M[I]=!0}function jt(I,y,M,C){kt(I,M,C),at(I,y,M)}function Zt(I,y,M){let C;for(C in I[M])if(I[M].hasOwnProperty(C)&&C!=="data"&&!G(I[M][C],y[M][C]))return!1;for(C in y[M])if(y[M].hasOwnProperty(C)&&C!=="data"&&!G(I[M][C],y[M][C]))return!1;return!0}function Yt(I,y,M,C,L,F){let N;for(N in y=y||{},I=I||{})I.hasOwnProperty(N)&&(G(I[N],y[N])||M.push({command:F,args:[C,N,y[N],L]}));for(N in y)y.hasOwnProperty(N)&&!I.hasOwnProperty(N)&&(G(I[N],y[N])||M.push({command:F,args:[C,N,y[N],L]}))}function mi(I){return I.id}function Xi(I,y){return I[y.id]=y,I}class Ki{constructor(y,M){this.reset(y,M)}reset(y,M){this.points=y||[],this._distances=[0];for(let C=1;C<this.points.length;C++)this._distances[C]=this._distances[C-1]+this.points[C].dist(this.points[C-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(M||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(y){if(this.points.length===1)return this.points[0];y=x.clamp(y,0,1);let M=1,C=this._distances[M];const L=y*this.paddedLength+this.padding;for(;C<L&&M<this._distances.length;)C=this._distances[++M];const F=M-1,N=this._distances[F],q=C-N,W=q>0?(L-N)/q:0;return this.points[F].mult(1-W).add(this.points[M].mult(W))}}class Gi{constructor(y,M,C){const L=this.boxCells=[],F=this.circleCells=[];this.xCellCount=Math.ceil(y/C),this.yCellCount=Math.ceil(M/C);for(let N=0;N<this.xCellCount*this.yCellCount;N++)L.push([]),F.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=y,this.height=M,this.xScale=this.xCellCount/y,this.yScale=this.yCellCount/M,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(y,M,C,L,F){this._forEachCell(M,C,L,F,this._insertBoxCell,this.boxUid++),this.boxKeys.push(y),this.bboxes.push(M),this.bboxes.push(C),this.bboxes.push(L),this.bboxes.push(F)}insertCircle(y,M,C,L){this._forEachCell(M-L,C-L,M+L,C+L,this._insertCircleCell,this.circleUid++),this.circleKeys.push(y),this.circles.push(M),this.circles.push(C),this.circles.push(L)}_insertBoxCell(y,M,C,L,F,N){this.boxCells[F].push(N)}_insertCircleCell(y,M,C,L,F,N){this.circleCells[F].push(N)}_query(y,M,C,L,F,N){if(C<0||y>this.width||L<0||M>this.height)return!F&&[];const q=[];if(y<=0&&M<=0&&this.width<=C&&this.height<=L){if(F)return!0;for(let W=0;W<this.boxKeys.length;W++)q.push({key:this.boxKeys[W],x1:this.bboxes[4*W],y1:this.bboxes[4*W+1],x2:this.bboxes[4*W+2],y2:this.bboxes[4*W+3]});for(let W=0;W<this.circleKeys.length;W++){const J=this.circles[3*W],ee=this.circles[3*W+1],ne=this.circles[3*W+2];q.push({key:this.circleKeys[W],x1:J-ne,y1:ee-ne,x2:J+ne,y2:ee+ne})}return N?q.filter(N):q}return this._forEachCell(y,M,C,L,this._queryCell,q,{hitTest:F,seenUids:{box:{},circle:{}}},N),F?q.length>0:q}_queryCircle(y,M,C,L,F){const N=y-C,q=y+C,W=M-C,J=M+C;if(q<0||N>this.width||J<0||W>this.height)return!L&&[];const ee=[];return this._forEachCell(N,W,q,J,this._queryCellCircle,ee,{hitTest:L,circle:{x:y,y:M,radius:C},seenUids:{box:{},circle:{}}},F),L?ee.length>0:ee}query(y,M,C,L,F){return this._query(y,M,C,L,!1,F)}hitTest(y,M,C,L,F){return this._query(y,M,C,L,!0,F)}hitTestCircle(y,M,C,L){return this._queryCircle(y,M,C,!0,L)}_queryCell(y,M,C,L,F,N,q,W){const J=q.seenUids,ee=this.boxCells[F];if(ee!==null){const fe=this.bboxes;for(const we of ee)if(!J.box[we]){J.box[we]=!0;const ye=4*we;if(y<=fe[ye+2]&&M<=fe[ye+3]&&C>=fe[ye+0]&&L>=fe[ye+1]&&(!W||W(this.boxKeys[we]))){if(q.hitTest)return N.push(!0),!0;N.push({key:this.boxKeys[we],x1:fe[ye],y1:fe[ye+1],x2:fe[ye+2],y2:fe[ye+3]})}}}const ne=this.circleCells[F];if(ne!==null){const fe=this.circles;for(const we of ne)if(!J.circle[we]){J.circle[we]=!0;const ye=3*we;if(this._circleAndRectCollide(fe[ye],fe[ye+1],fe[ye+2],y,M,C,L)&&(!W||W(this.circleKeys[we]))){if(q.hitTest)return N.push(!0),!0;{const Ee=fe[ye],ze=fe[ye+1],be=fe[ye+2];N.push({key:this.circleKeys[we],x1:Ee-be,y1:ze-be,x2:Ee+be,y2:ze+be})}}}}}_queryCellCircle(y,M,C,L,F,N,q,W){const J=q.circle,ee=q.seenUids,ne=this.boxCells[F];if(ne!==null){const we=this.bboxes;for(const ye of ne)if(!ee.box[ye]){ee.box[ye]=!0;const Ee=4*ye;if(this._circleAndRectCollide(J.x,J.y,J.radius,we[Ee+0],we[Ee+1],we[Ee+2],we[Ee+3])&&(!W||W(this.boxKeys[ye])))return N.push(!0),!0}}const fe=this.circleCells[F];if(fe!==null){const we=this.circles;for(const ye of fe)if(!ee.circle[ye]){ee.circle[ye]=!0;const Ee=3*ye;if(this._circlesCollide(we[Ee],we[Ee+1],we[Ee+2],J.x,J.y,J.radius)&&(!W||W(this.circleKeys[ye])))return N.push(!0),!0}}}_forEachCell(y,M,C,L,F,N,q,W){const J=this._convertToXCellCoord(y),ee=this._convertToYCellCoord(M),ne=this._convertToXCellCoord(C),fe=this._convertToYCellCoord(L);for(let we=J;we<=ne;we++)for(let ye=ee;ye<=fe;ye++)if(F.call(this,y,M,C,L,this.xCellCount*ye+we,N,q,W))return}_convertToXCellCoord(y){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(y*this.xScale)))}_convertToYCellCoord(y){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(y*this.yScale)))}_circlesCollide(y,M,C,L,F,N){const q=L-y,W=F-M,J=C+N;return J*J>q*q+W*W}_circleAndRectCollide(y,M,C,L,F,N,q){const W=(N-L)/2,J=Math.abs(y-(L+W));if(J>W+C)return!1;const ee=(q-F)/2,ne=Math.abs(M-(F+ee));if(ne>ee+C)return!1;if(J<=W||ne<=ee)return!0;const fe=J-W,we=ne-ee;return fe*fe+we*we<=C*C}}const Yi=Math.tan(85*Math.PI/180);function jn(I,y,M,C,L,F){let N=x.create();if(M){if(L.projection.name==="globe")N=x.calculateGlobeMatrix(L,L.worldSize/L._projectionScaler,[0,0]),x.multiply$1(N,N,x.globeDenormalizeECEF(x.globeTileBounds(y)));else{const q=U([],F);N[0]=q[0],N[1]=q[1],N[4]=q[2],N[5]=q[3]}C||x.rotateZ(N,N,L.angle)}else x.multiply$1(N,L.labelPlaneMatrix,I);return N}function Pn(I,y,M,C,L,F){if(M){if(L.projection.name==="globe"){const N=jn(I,y,M,C,L,F);return x.invert(N,N),x.multiply$1(N,I,N),N}{const N=x.clone(I),q=x.identity([]);return q[0]=F[0],q[1]=F[1],q[4]=F[2],q[5]=F[3],x.multiply$1(N,N,q),C||x.rotateZ(N,N,-L.angle),N}}return L.glCoordMatrix}function Lr(I,y,M=0){const C=[I.x,I.y,M,1];M?x.transformMat4$1(C,C,y):Wo(C,C,y);const L=C[3];return{point:new x.pointGeometry(C[0]/L,C[1]/L),signedDistanceFromCamera:L}}function En(I,y){return Math.min(.5+I/y*.5,1.5)}function Ds(I,y){const M=I[0]/I[3],C=I[1]/I[3];return M>=-y[0]&&M<=y[0]&&C>=-y[1]&&C<=y[1]}function Pl(I,y,M,C,L,F,N,q,W,J){const ee=M.transform,ne=C?I.textSizeData:I.iconSizeData,fe=x.evaluateSizeForZoom(ne,M.transform.zoom),we=[256/M.width*2+1,256/M.height*2+1],ye=C?I.text.dynamicLayoutVertexArray:I.icon.dynamicLayoutVertexArray;ye.clear();const Ee=I.lineVertexArray,ze=C?I.text.placedSymbolArray:I.icon.placedSymbolArray,be=M.transform.width/M.transform.height;let Ce=!1;for(let Pe=0;Pe<ze.length;Pe++){const Ie=ze.get(Pe);if(Ie.writingMode!==x.WritingMode.vertical||Ce||Pe!==0&&ze.get(Pe-1).writingMode===x.WritingMode.horizontal||(Ce=!0),Ie.hidden||Ie.writingMode===x.WritingMode.vertical&&!Ce){mn(Ie.numGlyphs,ye);continue}Ce=!1;const ke=new x.pointGeometry(Ie.tileAnchorX,Ie.tileAnchorY),Fe=W?W(ke):[0,0,0],Ye=ee.projection.projectTilePoint(ke.x,ke.y,J.canonical),Ke=[Ye.x+Fe[0],Ye.y+Fe[1],Ye.z+Fe[2]],yt=[...Ke,1];if(x.transformMat4$1(yt,yt,y),!Ds(yt,we)){mn(Ie.numGlyphs,ye);continue}const dt=En(M.transform.cameraToCenterDistance,yt[3]),ut=x.evaluateSizeForFeature(ne,fe,Ie),tt=N?ut/dt:ut*dt,We=Lr(new x.pointGeometry(Ke[0],Ke[1]),L,Ke[2]);if(We.signedDistanceFromCamera<=0){mn(Ie.numGlyphs,ye);continue}let ct={};const ot=N?null:W,Xt=Ba(Ie,tt,!1,q,y,L,F,I.glyphOffsetArray,Ee,ye,We.point,ke,ct,be,ot,ee.projection,J);Ce=Xt.useVertical,ot&&Xt.needsFlipping&&(ct={}),(Xt.notEnoughRoom||Ce||Xt.needsFlipping&&Ba(Ie,tt,!0,q,y,L,F,I.glyphOffsetArray,Ee,ye,We.point,ke,ct,be,ot,ee.projection,J).notEnoughRoom)&&mn(Ie.numGlyphs,ye)}C?I.text.dynamicLayoutVertexBuffer.updateData(ye):I.icon.dynamicLayoutVertexBuffer.updateData(ye)}function Ra(I,y,M,C,L,F,N,q,W,J,ee,ne,fe,we,ye){const Ee=q.glyphStartIndex+q.numGlyphs,ze=q.lineStartIndex,be=q.lineStartIndex+q.lineLength,Ce=y.getoffsetX(q.glyphStartIndex),Pe=y.getoffsetX(Ee-1),Ie=Ho(I*Ce,M,C,L,F,N,q.segment,ze,be,W,J,ee,ne,fe,!0,we,ye);if(!Ie)return null;const ke=Ho(I*Pe,M,C,L,F,N,q.segment,ze,be,W,J,ee,ne,fe,!0,we,ye);return ke?{first:Ie,last:ke}:null}function Yo(I,y,M,C){return I.writingMode===x.WritingMode.horizontal&&Math.abs(M.y-y.y)>Math.abs(M.x-y.x)*C?{useVertical:!0}:I.writingMode===x.WritingMode.vertical?y.y<M.y?{needsFlipping:!0}:null:I.flipState!==0&&function(L,F,N){const q=(F.x-L.x)*N;return q===0||Math.abs((F.y-L.y)/q)>Yi}(y,M,C)?I.flipState===1?{needsFlipping:!0}:null:y.x>M.x?{needsFlipping:!0}:null}function Ba(I,y,M,C,L,F,N,q,W,J,ee,ne,fe,we,ye,Ee,ze){const be=y/24,Ce=I.lineOffsetX*be,Pe=I.lineOffsetY*be;let Ie;if(I.numGlyphs>1){const ke=I.glyphStartIndex+I.numGlyphs,Fe=I.lineStartIndex,Ye=I.lineStartIndex+I.lineLength,Ke=Ra(be,q,Ce,Pe,M,ee,ne,I,W,F,fe,ye,!1,Ee,ze);if(!Ke)return{notEnoughRoom:!0};const yt=Lr(Ke.first.point,N).point,dt=Lr(Ke.last.point,N).point;if(C&&!M){const ut=Yo(I,yt,dt,we);if(I.flipState=ut&&ut.needsFlipping?1:2,ut)return ut}Ie=[Ke.first];for(let ut=I.glyphStartIndex+1;ut<ke-1;ut++)Ie.push(Ho(be*q.getoffsetX(ut),Ce,Pe,M,ee,ne,I.segment,Fe,Ye,W,F,fe,ye,!1,!1,Ee,ze));Ie.push(Ke.last)}else{if(C&&!M){const Fe=Lr(ne,L).point,Ye=I.lineStartIndex+I.segment+1,Ke=new x.pointGeometry(W.getx(Ye),W.gety(Ye)),yt=Lr(Ke,L),dt=Yo(I,Fe,yt.signedDistanceFromCamera>0?yt.point:Rs(ne,Ke,Fe,1,L,void 0,Ee,ze.canonical),we);if(I.flipState=dt&&dt.needsFlipping?1:2,dt)return dt}const ke=Ho(be*q.getoffsetX(I.glyphStartIndex),Ce,Pe,M,ee,ne,I.segment,I.lineStartIndex,I.lineStartIndex+I.lineLength,W,F,fe,ye,!1,!1,Ee,ze);if(!ke)return{notEnoughRoom:!0};Ie=[ke]}for(const ke of Ie)x.addDynamicAttributes(J,ke.point,ke.angle);return{}}function Ps(I,y,M,C,L){const F=C.projectTilePoint(I.x,I.y,y);if(!L)return Lr(F,M,F.z);const N=L(I);return Lr(new x.pointGeometry(F.x+N[0],F.y+N[1]),M,F.z+N[2])}function Rs(I,y,M,C,L,F,N,q){const W=Ps(I.add(I.sub(y)._unit()),q,L,N,F).point,J=M.sub(W);return M.add(J._mult(C/J.mag()))}function Ho(I,y,M,C,L,F,N,q,W,J,ee,ne,fe,we,ye,Ee,ze){const be=C?I-y:I+y;let Ce=be>0?1:-1,Pe=0;C&&(Ce*=-1,Pe=Math.PI),Ce<0&&(Pe+=Math.PI);let Ie=Ce>0?q+N:q+N+1,ke=L,Fe=L,Ye=0,Ke=0;const yt=Math.abs(be),dt=[],ut=[];let tt=F;const We=()=>{const _t=Ie-Ce;return Ye===0?F:new x.pointGeometry(J.getx(_t),J.gety(_t))},ct=()=>Rs(We(),tt,Fe,yt-Ye+1,ee,fe,Ee,ze.canonical);for(;Ye+Ke<=yt;){if(Ie+=Ce,Ie<q||Ie>=W)return null;if(Fe=ke,dt.push(ke),we&&ut.push(tt||We()),ke=ne[Ie],ke===void 0){tt=new x.pointGeometry(J.getx(Ie),J.gety(Ie));const _t=Ps(tt,ze.canonical,ee,Ee,fe);ke=_t.signedDistanceFromCamera>0?ne[Ie]=_t.point:ct()}else tt=null;Ye+=Ke,Ke=Fe.dist(ke)}ye&&fe&&(tt=tt||new x.pointGeometry(J.getx(Ie),J.gety(Ie)),ne[Ie]=ke=ne[Ie]===void 0?ke:ct(),Ke=Fe.dist(ke));const ot=(yt-Ye)/Ke,Xt=ke.sub(Fe),ti=Xt.mult(ot)._add(Fe);M&&ti._add(Xt._unit()._perp()._mult(M*Ce));const vi=Pe+Math.atan2(ke.y-Fe.y,ke.x-Fe.x);return dt.push(ti),we&&(tt=tt||new x.pointGeometry(J.getx(Ie),J.gety(Ie)),ut.push(function(_t,Kt,ci){const qi=1-ci;return new x.pointGeometry(_t.x*qi+Kt.x*ci,_t.y*qi+Kt.y*ci)}(ut.length>0?ut[ut.length-1]:tt,tt,ot))),{point:ti,angle:vi,path:dt,tilePath:ut}}const La=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function mn(I,y){for(let M=0;M<I;M++){const C=y.length;y.resize(C+4),y.float32.set(La,3*C)}}function Wo(I,y,M){const C=y[0],L=y[1];return I[0]=M[0]*C+M[4]*L+M[12],I[1]=M[1]*C+M[5]*L+M[13],I[3]=M[3]*C+M[7]*L+M[15],I}const Tn=100;class tc{constructor(y,M,C=new Gi(y.width+200,y.height+200,25),L=new Gi(y.width+200,y.height+200,25)){this.transform=y,this.grid=C,this.ignoredGrid=L,this.pitchfactor=Math.cos(y._pitch)*y.cameraToCenterDistance,this.screenRightBoundary=y.width+Tn,this.screenBottomBoundary=y.height+Tn,this.gridRightBoundary=y.width+200,this.gridBottomBoundary=y.height+200,this.fogState=M}placeCollisionBox(y,M,C,L,F,N,q){let W=M.projectedAnchorX,J=M.projectedAnchorY,ee=M.projectedAnchorZ;const ne=M.elevation,fe=M.tileID;if(ne&&fe){const Ie=this.transform.projection.createTileTransform(this.transform,this.transform.worldSize),ke=Ie.upVector(fe.canonical,M.tileAnchorX,M.tileAnchorY),Fe=Ie.upVectorScale(fe.canonical);W+=ke[0]*ne*Fe,J+=ke[1]*ne*Fe,ee+=ke[2]*ne*Fe}const we=this.projectAndGetPerspectiveRatio(N,W,J,ee,M.tileID),ye=F*we.perspectiveRatio,Ee=(M.x1*y+C.x-M.padding)*ye+we.point.x,ze=(M.y1*y+C.y-M.padding)*ye+we.point.y,be=(M.x2*y+C.x+M.padding)*ye+we.point.x,Ce=(M.y2*y+C.y+M.padding)*ye+we.point.y,Pe=we.perspectiveRatio<=.55||we.aboveHorizon;return!this.isInsideGrid(Ee,ze,be,Ce)||!L&&this.grid.hitTest(Ee,ze,be,Ce,q)||Pe?{box:[],offscreen:!1}:{box:[Ee,ze,be,Ce],offscreen:this.isOffscreen(Ee,ze,be,Ce)}}placeCollisionCircles(y,M,C,L,F,N,q,W,J,ee,ne,fe,we,ye){const Ee=[],ze=this.transform.elevation,be=this.transform.projection.createTileTransform(this.transform,this.transform.worldSize),Ce=ze?ze.getAtTileOffsetFunc(ye,be):ot=>[0,0,0],Pe=new x.pointGeometry(M.tileAnchorX,M.tileAnchorY),Ie=this.transform.projection.projectTilePoint(M.tileAnchorX,M.tileAnchorY,ye.canonical),ke=Ce(Pe),Fe=[Ie.x+ke[0],Ie.y+ke[1],Ie.z+ke[2]],Ye=this.projectAndGetPerspectiveRatio(N,Fe[0],Fe[1],Fe[2],ye),{perspectiveRatio:Ke}=Ye,yt=(ee?F/Ke:F*Ke)/x.ONE_EM,dt=Lr(new x.pointGeometry(Fe[0],Fe[1]),q,Fe[2]).point,ut=Ye.signedDistanceFromCamera>0?Ra(yt,L,M.lineOffsetX*yt,M.lineOffsetY*yt,!1,dt,Pe,M,C,q,{},ze&&!ee?Ce:null,ee&&!!ze,this.transform.projection,ye):null;let tt=!1,We=!1,ct=!0;if(ut&&!Ye.aboveHorizon){const ot=.5*fe*Ke+we,Xt=new x.pointGeometry(-100,-100),ti=new x.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),vi=new Ki,_t=ut.first,Kt=ut.last;let ci=[];for(let si=_t.path.length-1;si>=1;si--)ci.push(_t.path[si]);for(let si=1;si<Kt.path.length;si++)ci.push(Kt.path[si]);const qi=2.5*ot;if(W){const si=ci.map(ze?(Ti,ir)=>{const br=Ce(ir<_t.path.length-1?_t.tilePath[_t.path.length-1-ir]:Kt.tilePath[ir-_t.path.length+2]);return Lr(Ti,W,br[2])}:Ti=>Lr(Ti,W));ci=si.some(Ti=>Ti.signedDistanceFromCamera<=0)?[]:si.map(Ti=>Ti.point)}let Ji=[];if(ci.length>0){const si=ci[0].clone(),Ti=ci[0].clone();for(let ir=1;ir<ci.length;ir++)si.x=Math.min(si.x,ci[ir].x),si.y=Math.min(si.y,ci[ir].y),Ti.x=Math.max(Ti.x,ci[ir].x),Ti.y=Math.max(Ti.y,ci[ir].y);Ji=si.x>=Xt.x&&Ti.x<=ti.x&&si.y>=Xt.y&&Ti.y<=ti.y?[ci]:Ti.x<Xt.x||si.x>ti.x||Ti.y<Xt.y||si.y>ti.y?[]:x.clipLine([ci],Xt.x,Xt.y,ti.x,ti.y)}for(const si of Ji){vi.reset(si,.25*ot);let Ti=0;Ti=vi.length<=.5*ot?1:Math.ceil(vi.paddedLength/qi)+1;for(let ir=0;ir<Ti;ir++){const br=ir/Math.max(Ti-1,1),Yr=vi.lerp(br),cn=Yr.x+Tn,xn=Yr.y+Tn;Ee.push(cn,xn,ot,0);const Bi=cn-ot,ui=xn-ot,ki=cn+ot,lr=xn+ot;if(ct=ct&&this.isOffscreen(Bi,ui,ki,lr),We=We||this.isInsideGrid(Bi,ui,ki,lr),!y&&this.grid.hitTestCircle(cn,xn,ot,ne)&&(tt=!0,!J))return{circles:[],offscreen:!1,collisionDetected:tt}}}}return{circles:!J&&tt||!We?[]:Ee,offscreen:ct,collisionDetected:tt}}queryRenderedSymbols(y){if(y.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const M=[];let C=1/0,L=1/0,F=-1/0,N=-1/0;for(const ee of y){const ne=new x.pointGeometry(ee.x+Tn,ee.y+Tn);C=Math.min(C,ne.x),L=Math.min(L,ne.y),F=Math.max(F,ne.x),N=Math.max(N,ne.y),M.push(ne)}const q=this.grid.query(C,L,F,N).concat(this.ignoredGrid.query(C,L,F,N)),W={},J={};for(const ee of q){const ne=ee.key;if(W[ne.bucketInstanceId]===void 0&&(W[ne.bucketInstanceId]={}),W[ne.bucketInstanceId][ne.featureIndex])continue;const fe=[new x.pointGeometry(ee.x1,ee.y1),new x.pointGeometry(ee.x2,ee.y1),new x.pointGeometry(ee.x2,ee.y2),new x.pointGeometry(ee.x1,ee.y2)];x.polygonIntersectsPolygon(M,fe)&&(W[ne.bucketInstanceId][ne.featureIndex]=!0,J[ne.bucketInstanceId]===void 0&&(J[ne.bucketInstanceId]=[]),J[ne.bucketInstanceId].push(ne.featureIndex))}return J}insertCollisionBox(y,M,C,L,F){(M?this.ignoredGrid:this.grid).insert({bucketInstanceId:C,featureIndex:L,collisionGroupID:F},y[0],y[1],y[2],y[3])}insertCollisionCircles(y,M,C,L,F){const N=M?this.ignoredGrid:this.grid,q={bucketInstanceId:C,featureIndex:L,collisionGroupID:F};for(let W=0;W<y.length;W+=4)N.insertCircle(q,y[W],y[W+1],y[W+2])}projectAndGetPerspectiveRatio(y,M,C,L,F){const N=[M,C,L||0,1];let q=!1;if(L||this.transform.pitch>0){x.transformMat4$1(N,N,y);let W=!1;this.fogState&&F&&(W=function(J,ee,ne,fe,we,ye){const Ee=ye.calculateFogTileMatrix(we),ze=[ee,ne,fe];return x.transformMat4(ze,ze,Ee),ge(J,ze,ye.pitch,ye._fov)}(this.fogState,M,C,L||0,F.toUnwrapped(),this.transform)>.9),q=N[2]>N[3]||W}else Wo(N,N,y);return{point:new x.pointGeometry((N[0]/N[3]+1)/2*this.transform.width+Tn,(-N[1]/N[3]+1)/2*this.transform.height+Tn),perspectiveRatio:Math.min(.5+this.transform.cameraToCenterDistance/N[3]*.5,1.5),signedDistanceFromCamera:N[3],aboveHorizon:q}}isOffscreen(y,M,C,L){return C<Tn||y>=this.screenRightBoundary||L<Tn||M>this.screenBottomBoundary}isInsideGrid(y,M,C,L){return C>=0&&y<this.gridRightBoundary&&L>=0&&M<this.gridBottomBoundary}getViewportMatrix(){const y=x.identity([]);return x.translate(y,y,[-100,-100,0]),y}}class Rl{constructor(y,M,C,L){this.opacity=y?Math.max(0,Math.min(1,y.opacity+(y.placed?M:-M))):L&&C?1:0,this.placed=C}isHidden(){return this.opacity===0&&!this.placed}}class bo{constructor(y,M,C,L,F,N=!1){this.text=new Rl(y?y.text:null,M,C,F),this.icon=new Rl(y?y.icon:null,M,L,F),this.clipped=N}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class wo{constructor(y,M,C,L=!1){this.text=y,this.icon=M,this.skipFade=C,this.clipped=L}}class Ko{constructor(){this.invProjMatrix=x.create(),this.viewportMatrix=x.create(),this.circles=[]}}class Bl{constructor(y,M,C,L,F){this.bucketInstanceId=y,this.featureIndex=M,this.sourceLayerIndex=C,this.bucketIndex=L,this.tileID=F}}class Ll{constructor(y){this.crossSourceCollisions=y,this.maxGroupID=0,this.collisionGroups={}}get(y){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[y]){const M=++this.maxGroupID;this.collisionGroups[y]={ID:M,predicate:C=>C.collisionGroupID===M}}return this.collisionGroups[y]}}function Bs(I,y,M,C,L){const{horizontalAlign:F,verticalAlign:N}=x.getAnchorAlignment(I),q=-(F-.5)*y,W=-(N-.5)*M,J=x.evaluateVariableOffset(I,C);return new x.pointGeometry(q+J[0]*L,W+J[1]*L)}function Gn(I,y,M,C,L){const F=new x.pointGeometry(I,y);return M&&F._rotate(C?L:-L),F}class Ls{constructor(y,M,C,L,F){this.transform=y.clone(),this.collisionIndex=new tc(this.transform,F),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=M,this.retainedQueryData={},this.collisionGroups=new Ll(C),this.collisionCircleArrays={},this.prevPlacement=L,L&&(L.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(y,M,C,L){const F=C.getBucket(M),N=C.latestFeatureIndex;if(!F||!N||M.id!==F.layerIds[0])return;const q=F.layers[0].layout,W=C.collisionBoxArray,J=Math.pow(2,this.transform.zoom-C.tileID.overscaledZ),ee=C.tileSize/x.EXTENT,ne=C.tileID.toUnwrapped(),fe=this.transform.calculateProjMatrix(ne),we=q.get("text-pitch-alignment")==="map",ye=q.get("text-rotation-alignment")==="map";M.compileFilter();const Ee=M.dynamicFilter(),ze=M.dynamicFilterNeedsFeature(),be=this.transform.calculatePixelsToTileUnitsMatrix(C),Ce=jn(fe,C.tileID.canonical,we,ye,this.transform,be);let Pe=null;if(we){const Fe=Pn(fe,C.tileID.canonical,we,ye,this.transform,be);Pe=x.multiply$1([],this.transform.labelPlaneMatrix,Fe)}let Ie=null;Ee&&C.latestFeatureIndex&&(Ie={unwrappedTileID:ne,dynamicFilter:Ee,dynamicFilterNeedsFeature:ze,featureIndex:C.latestFeatureIndex}),this.retainedQueryData[F.bucketInstanceId]=new Bl(F.bucketInstanceId,N,F.sourceLayerIndex,F.index,C.tileID);const ke={bucket:F,layout:q,posMatrix:fe,textLabelPlaneMatrix:Ce,labelToScreenMatrix:Pe,clippingData:Ie,scale:J,textPixelRatio:ee,holdingForFade:C.holdingForFade(),collisionBoxArray:W,partiallyEvaluatedTextSize:x.evaluateSizeForZoom(F.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:x.evaluateSizeForZoom(F.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(F.sourceID)};if(L)for(const Fe of F.sortKeyRanges){const{sortKey:Ye,symbolInstanceStart:Ke,symbolInstanceEnd:yt}=Fe;y.push({sortKey:Ye,symbolInstanceStart:Ke,symbolInstanceEnd:yt,parameters:ke})}else y.push({symbolInstanceStart:0,symbolInstanceEnd:F.symbolInstances.length,parameters:ke})}attemptAnchorPlacement(y,M,C,L,F,N,q,W,J,ee,ne,fe,we,ye,Ee,ze,be,Ce){const Pe=[fe.textOffset0,fe.textOffset1],Ie=Bs(y,C,L,Pe,F),ke=this.collisionIndex.placeCollisionBox(F,M,Gn(Ie.x,Ie.y,N,q,this.transform.angle),ne,W,J,ee.predicate);if((!ze||this.collisionIndex.placeCollisionBox(ye.getSymbolInstanceIconSize(Ce,this.transform.zoom,we),ze,Gn(Ie.x,Ie.y,N,q,this.transform.angle),ne,W,J,ee.predicate).box.length!==0)&&ke.box.length>0){let Fe;return this.prevPlacement&&this.prevPlacement.variableOffsets[fe.crossTileID]&&this.prevPlacement.placements[fe.crossTileID]&&this.prevPlacement.placements[fe.crossTileID].text&&(Fe=this.prevPlacement.variableOffsets[fe.crossTileID].anchor),this.variableOffsets[fe.crossTileID]={textOffset:Pe,width:C,height:L,anchor:y,textScale:F,prevAnchor:Fe},this.markUsedJustification(ye,y,fe,Ee),ye.allowVerticalPlacement&&(this.markUsedOrientation(ye,Ee,fe),this.placedOrientations[fe.crossTileID]=Ee),{shift:Ie,placedGlyphBoxes:ke}}}placeLayerBucketPart(y,M,C,L){const{bucket:F,layout:N,posMatrix:q,textLabelPlaneMatrix:W,labelToScreenMatrix:J,clippingData:ee,textPixelRatio:ne,holdingForFade:fe,collisionBoxArray:we,partiallyEvaluatedTextSize:ye,partiallyEvaluatedIconSize:Ee,collisionGroup:ze}=y.parameters,be=N.get("text-optional"),Ce=N.get("icon-optional"),Pe=N.get("text-allow-overlap"),Ie=N.get("icon-allow-overlap"),ke=N.get("text-rotation-alignment")==="map",Fe=N.get("text-pitch-alignment")==="map",Ye=N.get("icon-text-fit")!=="none",Ke=N.get("symbol-z-order")==="viewport-y",yt=Pe&&(Ie||!F.hasIconData()||Ce),dt=Ie&&(Pe||!F.hasTextData()||be);!F.collisionArrays&&we&&F.deserializeCollisionBoxes(we),C&&L&&F.updateCollisionDebugBuffers(this.transform.zoom,we);const ut=(tt,We,ct)=>{if(ee){const Bi={zoom:this.transform.zoom,pitch:this.transform.pitch};let ui=null;if(ee.dynamicFilterNeedsFeature){const ki=this.retainedQueryData[F.bucketInstanceId];ui=ee.featureIndex.loadFeature({featureIndex:tt.featureIndex,bucketIndex:ki.bucketIndex,sourceLayerIndex:ki.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,ee.dynamicFilter)(Bi,ui,this.retainedQueryData[F.bucketInstanceId].tileID.canonical,new x.pointGeometry(tt.tileAnchorX,tt.tileAnchorY),this.transform.calculateDistanceTileData(ee.unwrappedTileID)))return this.placements[tt.crossTileID]=new wo(!1,!1,!1,!0),void(M[tt.crossTileID]=!0)}if(M[tt.crossTileID])return;if(fe)return void(this.placements[tt.crossTileID]=new wo(!1,!1,!1));let ot=!1,Xt=!1,ti=!0,vi=null,_t={box:null,offscreen:null},Kt={box:null,offscreen:null},ci=null,qi=null,Ji=null,si=0,Ti=0,ir=0;ct.textFeatureIndex?si=ct.textFeatureIndex:tt.useRuntimeCollisionCircles&&(si=tt.featureIndex),ct.verticalTextFeatureIndex&&(Ti=ct.verticalTextFeatureIndex);const br=Bi=>{Bi.tileID=this.retainedQueryData[F.bucketInstanceId].tileID,(this.transform.elevation||Bi.elevation)&&(Bi.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[F.bucketInstanceId].tileID,Bi.tileAnchorX,Bi.tileAnchorY):0)},Yr=ct.textBox;if(Yr){br(Yr);const Bi=ki=>{let lr=x.WritingMode.horizontal;if(F.allowVerticalPlacement&&!ki&&this.prevPlacement){const Qr=this.prevPlacement.placedOrientations[tt.crossTileID];Qr&&(this.placedOrientations[tt.crossTileID]=Qr,lr=Qr,this.markUsedOrientation(F,lr,tt))}return lr},ui=(ki,lr)=>{if(F.allowVerticalPlacement&&tt.numVerticalGlyphVertices>0&&ct.verticalTextBox){for(const Qr of F.writingModes)if(Qr===x.WritingMode.vertical?(_t=lr(),Kt=_t):_t=ki(),_t&&_t.box&&_t.box.length)break}else _t=ki()};if(N.get("text-variable-anchor")){let ki=N.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[tt.crossTileID]){const tr=this.prevPlacement.variableOffsets[tt.crossTileID];ki.indexOf(tr.anchor)>0&&(ki=ki.filter(en=>en!==tr.anchor),ki.unshift(tr.anchor))}const lr=(tr,en,ws)=>{const Hr=F.getSymbolInstanceTextSize(ye,tt,this.transform.zoom,We),uo=(tr.x2-tr.x1)*Hr+2*tr.padding,Ot=(tr.y2-tr.y1)*Hr+2*tr.padding,Jt=Ye&&!Ie?en:null;Jt&&br(Jt);let Ir={box:[],offscreen:!1};const fo=Pe?2*ki.length:ki.length;for(let to=0;to<fo;++to){const Fr=this.attemptAnchorPlacement(ki[to%ki.length],tr,uo,Ot,Hr,ke,Fe,ne,q,ze,to>=ki.length,tt,We,F,ws,Jt,ye,Ee);if(Fr&&(Ir=Fr.placedGlyphBoxes,Ir&&Ir.box&&Ir.box.length)){ot=!0,vi=Fr.shift;break}}return Ir};ui(()=>lr(Yr,ct.iconBox,x.WritingMode.horizontal),()=>{const tr=ct.verticalTextBox;return tr&&br(tr),F.allowVerticalPlacement&&!(_t&&_t.box&&_t.box.length)&&tt.numVerticalGlyphVertices>0&&tr?lr(tr,ct.verticalIconBox,x.WritingMode.vertical):{box:null,offscreen:null}}),_t&&(ot=_t.box,ti=_t.offscreen);const Qr=Bi(_t&&_t.box);if(!ot&&this.prevPlacement){const tr=this.prevPlacement.variableOffsets[tt.crossTileID];tr&&(this.variableOffsets[tt.crossTileID]=tr,this.markUsedJustification(F,tr.anchor,tt,Qr))}}else{const ki=(lr,Qr)=>{const tr=F.getSymbolInstanceTextSize(ye,tt,this.transform.zoom,We),en=this.collisionIndex.placeCollisionBox(tr,lr,new x.pointGeometry(0,0),Pe,ne,q,ze.predicate);return en&&en.box&&en.box.length&&(this.markUsedOrientation(F,Qr,tt),this.placedOrientations[tt.crossTileID]=Qr),en};ui(()=>ki(Yr,x.WritingMode.horizontal),()=>{const lr=ct.verticalTextBox;return F.allowVerticalPlacement&&tt.numVerticalGlyphVertices>0&&lr?(br(lr),ki(lr,x.WritingMode.vertical)):{box:null,offscreen:null}}),Bi(_t&&_t.box&&_t.box.length)}}if(ci=_t,ot=ci&&ci.box&&ci.box.length>0,ti=ci&&ci.offscreen,tt.useRuntimeCollisionCircles){const Bi=F.text.placedSymbolArray.get(tt.centerJustifiedTextSymbolIndex>=0?tt.centerJustifiedTextSymbolIndex:tt.verticalPlacedTextSymbolIndex),ui=x.evaluateSizeForFeature(F.textSizeData,ye,Bi),ki=N.get("text-padding");qi=this.collisionIndex.placeCollisionCircles(Pe,Bi,F.lineVertexArray,F.glyphOffsetArray,ui,q,W,J,C,Fe,ze.predicate,tt.collisionCircleDiameter*ui/x.ONE_EM,ki,this.retainedQueryData[F.bucketInstanceId].tileID),ot=Pe||qi.circles.length>0&&!qi.collisionDetected,ti=ti&&qi.offscreen}if(ct.iconFeatureIndex&&(ir=ct.iconFeatureIndex),ct.iconBox){const Bi=ui=>{br(ui);const ki=Ye&&vi?Gn(vi.x,vi.y,ke,Fe,this.transform.angle):new x.pointGeometry(0,0),lr=F.getSymbolInstanceIconSize(Ee,this.transform.zoom,We);return this.collisionIndex.placeCollisionBox(lr,ui,ki,Ie,ne,q,ze.predicate)};Kt&&Kt.box&&Kt.box.length&&ct.verticalIconBox?(Ji=Bi(ct.verticalIconBox),Xt=Ji.box.length>0):(Ji=Bi(ct.iconBox),Xt=Ji.box.length>0),ti=ti&&Ji.offscreen}const cn=be||tt.numHorizontalGlyphVertices===0&&tt.numVerticalGlyphVertices===0,xn=Ce||tt.numIconVertices===0;if(cn||xn?xn?cn||(Xt=Xt&&ot):ot=Xt&&ot:Xt=ot=Xt&&ot,ot&&ci&&ci.box&&this.collisionIndex.insertCollisionBox(ci.box,N.get("text-ignore-placement"),F.bucketInstanceId,Kt&&Kt.box&&Ti?Ti:si,ze.ID),Xt&&Ji&&this.collisionIndex.insertCollisionBox(Ji.box,N.get("icon-ignore-placement"),F.bucketInstanceId,ir,ze.ID),qi&&(ot&&this.collisionIndex.insertCollisionCircles(qi.circles,N.get("text-ignore-placement"),F.bucketInstanceId,si,ze.ID),C)){const Bi=F.bucketInstanceId;let ui=this.collisionCircleArrays[Bi];ui===void 0&&(ui=this.collisionCircleArrays[Bi]=new Ko);for(let ki=0;ki<qi.circles.length;ki+=4)ui.circles.push(qi.circles[ki+0]),ui.circles.push(qi.circles[ki+1]),ui.circles.push(qi.circles[ki+2]),ui.circles.push(qi.collisionDetected?1:0)}this.placements[tt.crossTileID]=new wo(ot||yt,Xt||dt,ti||F.justReloaded),M[tt.crossTileID]=!0};if(Ke){const tt=F.getSortedSymbolIndexes(this.transform.angle);for(let We=tt.length-1;We>=0;--We){const ct=tt[We];ut(F.symbolInstances.get(ct),ct,F.collisionArrays[ct])}}else for(let tt=y.symbolInstanceStart;tt<y.symbolInstanceEnd;tt++)ut(F.symbolInstances.get(tt),tt,F.collisionArrays[tt]);if(C&&F.bucketInstanceId in this.collisionCircleArrays){const tt=this.collisionCircleArrays[F.bucketInstanceId];x.invert(tt.invProjMatrix,q),tt.viewportMatrix=this.collisionIndex.getViewportMatrix()}F.justReloaded=!1}markUsedJustification(y,M,C,L){let F;F=L===x.WritingMode.vertical?C.verticalPlacedTextSymbolIndex:{left:C.leftJustifiedTextSymbolIndex,center:C.centerJustifiedTextSymbolIndex,right:C.rightJustifiedTextSymbolIndex}[x.getAnchorJustification(M)];const N=[C.leftJustifiedTextSymbolIndex,C.centerJustifiedTextSymbolIndex,C.rightJustifiedTextSymbolIndex,C.verticalPlacedTextSymbolIndex];for(const q of N)q>=0&&(y.text.placedSymbolArray.get(q).crossTileID=F>=0&&q!==F?0:C.crossTileID)}markUsedOrientation(y,M,C){const L=M===x.WritingMode.horizontal||M===x.WritingMode.horizontalOnly?M:0,F=M===x.WritingMode.vertical?M:0,N=[C.leftJustifiedTextSymbolIndex,C.centerJustifiedTextSymbolIndex,C.rightJustifiedTextSymbolIndex];for(const q of N)y.text.placedSymbolArray.get(q).placedOrientation=L;C.verticalPlacedTextSymbolIndex&&(y.text.placedSymbolArray.get(C.verticalPlacedTextSymbolIndex).placedOrientation=F)}commit(y){this.commitTime=y,this.zoomAtLastRecencyCheck=this.transform.zoom;const M=this.prevPlacement;let C=!1;this.prevZoomAdjustment=M?M.zoomAdjustment(this.transform.zoom):0;const L=M?M.symbolFadeChange(y):1,F=M?M.opacities:{},N=M?M.variableOffsets:{},q=M?M.placedOrientations:{};for(const W in this.placements){const J=this.placements[W],ee=F[W];ee?(this.opacities[W]=new bo(ee,L,J.text,J.icon,null,J.clipped),C=C||J.text!==ee.text.placed||J.icon!==ee.icon.placed):(this.opacities[W]=new bo(null,L,J.text,J.icon,J.skipFade,J.clipped),C=C||J.text||J.icon)}for(const W in F){const J=F[W];if(!this.opacities[W]){const ee=new bo(J,L,!1,!1);ee.isHidden()||(this.opacities[W]=ee,C=C||J.text.placed||J.icon.placed)}}for(const W in N)this.variableOffsets[W]||!this.opacities[W]||this.opacities[W].isHidden()||(this.variableOffsets[W]=N[W]);for(const W in q)this.placedOrientations[W]||!this.opacities[W]||this.opacities[W].isHidden()||(this.placedOrientations[W]=q[W]);C?this.lastPlacementChangeTime=y:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=M?M.lastPlacementChangeTime:y)}updateLayerOpacities(y,M){const C={};for(const L of M){const F=L.getBucket(y);F&&L.latestFeatureIndex&&y.id===F.layerIds[0]&&this.updateBucketOpacities(F,C,L.collisionBoxArray)}}updateBucketOpacities(y,M,C){y.hasTextData()&&y.text.opacityVertexArray.clear(),y.hasIconData()&&y.icon.opacityVertexArray.clear(),y.hasIconCollisionBoxData()&&y.iconCollisionBox.collisionVertexArray.clear(),y.hasTextCollisionBoxData()&&y.textCollisionBox.collisionVertexArray.clear();const L=y.layers[0].layout,F=!!y.layers[0].dynamicFilter(),N=new bo(null,0,!1,!1,!0),q=L.get("text-allow-overlap"),W=L.get("icon-allow-overlap"),J=L.get("text-variable-anchor"),ee=L.get("text-rotation-alignment")==="map",ne=L.get("text-pitch-alignment")==="map",fe=L.get("icon-text-fit")!=="none",we=new bo(null,0,q&&(W||!y.hasIconData()||L.get("icon-optional")),W&&(q||!y.hasTextData()||L.get("text-optional")),!0);!y.collisionArrays&&C&&(y.hasIconCollisionBoxData()||y.hasTextCollisionBoxData())&&y.deserializeCollisionBoxes(C);const ye=(ze,be,Ce)=>{for(let Pe=0;Pe<be/4;Pe++)ze.opacityVertexArray.emplaceBack(Ce)};let Ee=0;for(let ze=0;ze<y.symbolInstances.length;ze++){const be=y.symbolInstances.get(ze),{numHorizontalGlyphVertices:Ce,numVerticalGlyphVertices:Pe,crossTileID:Ie}=be;let ke=this.opacities[Ie];M[Ie]?ke=N:ke||(ke=we,this.opacities[Ie]=ke),M[Ie]=!0;const Fe=Ce>0||Pe>0,Ye=be.numIconVertices>0,Ke=this.placedOrientations[be.crossTileID],yt=Ke===x.WritingMode.vertical,dt=Ke===x.WritingMode.horizontal||Ke===x.WritingMode.horizontalOnly;if(!Fe&&!Ye||ke.isHidden()||Ee++,Fe){const ut=zs(ke.text);ye(y.text,Ce,yt?Xn:ut),ye(y.text,Pe,dt?Xn:ut);const tt=ke.text.isHidden();[be.rightJustifiedTextSymbolIndex,be.centerJustifiedTextSymbolIndex,be.leftJustifiedTextSymbolIndex].forEach(ot=>{ot>=0&&(y.text.placedSymbolArray.get(ot).hidden=tt||yt?1:0)}),be.verticalPlacedTextSymbolIndex>=0&&(y.text.placedSymbolArray.get(be.verticalPlacedTextSymbolIndex).hidden=tt||dt?1:0);const We=this.variableOffsets[be.crossTileID];We&&this.markUsedJustification(y,We.anchor,be,Ke);const ct=this.placedOrientations[be.crossTileID];ct&&(this.markUsedJustification(y,"left",be,ct),this.markUsedOrientation(y,ct,be))}if(Ye){const ut=zs(ke.icon);be.placedIconSymbolIndex>=0&&(ye(y.icon,be.numIconVertices,yt?Xn:ut),y.icon.placedSymbolArray.get(be.placedIconSymbolIndex).hidden=ke.icon.isHidden()),be.verticalPlacedIconSymbolIndex>=0&&(ye(y.icon,be.numVerticalIconVertices,dt?Xn:ut),y.icon.placedSymbolArray.get(be.verticalPlacedIconSymbolIndex).hidden=ke.icon.isHidden())}if(y.hasIconCollisionBoxData()||y.hasTextCollisionBoxData()){const ut=y.collisionArrays[ze];if(ut){let tt=new x.pointGeometry(0,0),We=!0;if(ut.textBox||ut.verticalTextBox){if(J){const ot=this.variableOffsets[Ie];ot?(tt=Bs(ot.anchor,ot.width,ot.height,ot.textOffset,ot.textScale),ee&&tt._rotate(ne?this.transform.angle:-this.transform.angle)):We=!1}F&&(We=!ke.clipped),ut.textBox&&qn(y.textCollisionBox.collisionVertexArray,ke.text.placed,!We||yt,tt.x,tt.y),ut.verticalTextBox&&qn(y.textCollisionBox.collisionVertexArray,ke.text.placed,!We||dt,tt.x,tt.y)}const ct=We&&Boolean(!dt&&ut.verticalIconBox);ut.iconBox&&qn(y.iconCollisionBox.collisionVertexArray,ke.icon.placed,ct,fe?tt.x:0,fe?tt.y:0),ut.verticalIconBox&&qn(y.iconCollisionBox.collisionVertexArray,ke.icon.placed,!ct,fe?tt.x:0,fe?tt.y:0)}}}if(y.fullyClipped=Ee===0,y.sortFeatures(this.transform.angle),this.retainedQueryData[y.bucketInstanceId]&&(this.retainedQueryData[y.bucketInstanceId].featureSortOrder=y.featureSortOrder),y.hasTextData()&&y.text.opacityVertexBuffer&&y.text.opacityVertexBuffer.updateData(y.text.opacityVertexArray),y.hasIconData()&&y.icon.opacityVertexBuffer&&y.icon.opacityVertexBuffer.updateData(y.icon.opacityVertexArray),y.hasIconCollisionBoxData()&&y.iconCollisionBox.collisionVertexBuffer&&y.iconCollisionBox.collisionVertexBuffer.updateData(y.iconCollisionBox.collisionVertexArray),y.hasTextCollisionBoxData()&&y.textCollisionBox.collisionVertexBuffer&&y.textCollisionBox.collisionVertexBuffer.updateData(y.textCollisionBox.collisionVertexArray),y.bucketInstanceId in this.collisionCircleArrays){const ze=this.collisionCircleArrays[y.bucketInstanceId];y.placementInvProjMatrix=ze.invProjMatrix,y.placementViewportMatrix=ze.viewportMatrix,y.collisionCircleArray=ze.circles,delete this.collisionCircleArrays[y.bucketInstanceId]}}symbolFadeChange(y){return this.fadeDuration===0?1:(y-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(y){return Math.max(0,(this.transform.zoom-y)/1.5)}hasTransitions(y){return this.stale||y-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(y,M){const C=this.zoomAtLastRecencyCheck===M?1-this.zoomAdjustment(M):1;return this.zoomAtLastRecencyCheck=M,this.commitTime+this.fadeDuration*C>y}setStale(){this.stale=!0}}function qn(I,y,M,C,L){I.emplaceBack(y?1:0,M?1:0,C||0,L||0),I.emplaceBack(y?1:0,M?1:0,C||0,L||0),I.emplaceBack(y?1:0,M?1:0,C||0,L||0),I.emplaceBack(y?1:0,M?1:0,C||0,L||0)}const et=Math.pow(2,25),Dt=Math.pow(2,24),zl=Math.pow(2,17),Zn=Math.pow(2,16),cr=Math.pow(2,9),Rn=Math.pow(2,8),Mn=Math.pow(2,1);function zs(I){if(I.opacity===0&&!I.placed)return 0;if(I.opacity===1&&I.placed)return 4294967295;const y=I.placed?1:0,M=Math.floor(127*I.opacity);return M*et+y*Dt+M*zl+y*Zn+M*cr+y*Rn+M*Mn+y}const Xn=0;class Ct{constructor(y){this._sortAcrossTiles=y.layout.get("symbol-z-order")!=="viewport-y"&&y.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(y,M,C,L,F){const N=this._bucketParts;for(;this._currentTileIndex<y.length;)if(M.getBucketParts(N,L,y[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,F())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,N.sort((q,W)=>q.sortKey-W.sortKey));this._currentPartIndex<N.length;){const q=N[this._currentPartIndex];if(M.placeLayerBucketPart(q,this._seenCrossTileIDs,C,q.symbolInstanceStart===0),this._currentPartIndex++,F())return!0}return!1}}class Ii{constructor(y,M,C,L,F,N,q,W){this.placement=new Ls(y,F,N,q,W),this._currentPlacementIndex=M.length-1,this._forceFullPlacement=C,this._showCollisionBoxes=L,this._done=!1}isDone(){return this._done}continuePlacement(y,M,C){const L=x.exported.now(),F=()=>{const N=x.exported.now()-L;return!this._forceFullPlacement&&N>2};for(;this._currentPlacementIndex>=0;){const N=M[y[this._currentPlacementIndex]],q=this.placement.collisionIndex.transform.zoom;if(N.type==="symbol"&&(!N.minzoom||N.minzoom<=q)&&(!N.maxzoom||N.maxzoom>q)){if(this._inProgressLayer||(this._inProgressLayer=new Ct(N)),this._inProgressLayer.continuePlacement(C[N.source],this.placement,this._showCollisionBoxes,N,F))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(y){return this.placement.commit(y),this.placement}}const bi=512/x.EXTENT/2;class Sn{constructor(y,M,C){this.tileID=y,this.indexedSymbolInstances={},this.bucketInstanceId=C;for(let L=0;L<M.length;L++){const F=M.get(L),N=F.key;this.indexedSymbolInstances[N]||(this.indexedSymbolInstances[N]=[]),this.indexedSymbolInstances[N].push({crossTileID:F.crossTileID,coord:this.getScaledCoordinates(F,y)})}}getScaledCoordinates(y,M){const C=bi/Math.pow(2,M.canonical.z-this.tileID.canonical.z);return{x:Math.floor((M.canonical.x*x.EXTENT+y.tileAnchorX)*C),y:Math.floor((M.canonical.y*x.EXTENT+y.tileAnchorY)*C)}}findMatches(y,M,C){const L=this.tileID.canonical.z<M.canonical.z?1:Math.pow(2,this.tileID.canonical.z-M.canonical.z);for(let F=0;F<y.length;F++){const N=y.get(F);if(N.crossTileID)continue;const q=this.indexedSymbolInstances[N.key];if(!q)continue;const W=this.getScaledCoordinates(N,M);for(const J of q)if(Math.abs(J.coord.x-W.x)<=L&&Math.abs(J.coord.y-W.y)<=L&&!C[J.crossTileID]){C[J.crossTileID]=!0,N.crossTileID=J.crossTileID;break}}}}class Eo{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class wi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(y){const M=Math.round((y-this.lng)/360);if(M!==0)for(const C in this.indexes){const L=this.indexes[C],F={};for(const N in L){const q=L[N];q.tileID=q.tileID.unwrapTo(q.tileID.wrap+M),F[q.tileID.key]=q}this.indexes[C]=F}this.lng=y}addBucket(y,M,C){if(this.indexes[y.overscaledZ]&&this.indexes[y.overscaledZ][y.key]){if(this.indexes[y.overscaledZ][y.key].bucketInstanceId===M.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(y.overscaledZ,this.indexes[y.overscaledZ][y.key])}for(let F=0;F<M.symbolInstances.length;F++)M.symbolInstances.get(F).crossTileID=0;this.usedCrossTileIDs[y.overscaledZ]||(this.usedCrossTileIDs[y.overscaledZ]={});const L=this.usedCrossTileIDs[y.overscaledZ];for(const F in this.indexes){const N=this.indexes[F];if(Number(F)>y.overscaledZ)for(const q in N){const W=N[q];W.tileID.isChildOf(y)&&W.findMatches(M.symbolInstances,y,L)}else{const q=N[y.scaledTo(Number(F)).key];q&&q.findMatches(M.symbolInstances,y,L)}}for(let F=0;F<M.symbolInstances.length;F++){const N=M.symbolInstances.get(F);N.crossTileID||(N.crossTileID=C.generate(),L[N.crossTileID]=!0)}return this.indexes[y.overscaledZ]===void 0&&(this.indexes[y.overscaledZ]={}),this.indexes[y.overscaledZ][y.key]=new Sn(y,M.symbolInstances,M.bucketInstanceId),!0}removeBucketCrossTileIDs(y,M){for(const C in M.indexedSymbolInstances)for(const L of M.indexedSymbolInstances[C])delete this.usedCrossTileIDs[y][L.crossTileID]}removeStaleBuckets(y){let M=!1;for(const C in this.indexes){const L=this.indexes[C];for(const F in L)y[L[F].bucketInstanceId]||(this.removeBucketCrossTileIDs(C,L[F]),delete L[F],M=!0)}return M}}class Jo{constructor(){this.layerIndexes={},this.crossTileIDs=new Eo,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(y,M,C,L){let F=this.layerIndexes[y.id];F===void 0&&(F=this.layerIndexes[y.id]=new wi);let N=!1;const q={};L.name!=="globe"&&F.handleWrapJump(C);for(const W of M){const J=W.getBucket(y);J&&y.id===J.layerIds[0]&&(J.bucketInstanceId||(J.bucketInstanceId=++this.maxBucketInstanceId),F.addBucket(W.tileID,J,this.crossTileIDs)&&(N=!0),q[J.bucketInstanceId]=!0)}return F.removeStaleBuckets(q)&&(N=!0),N}pruneUnusedLayers(y){const M={};y.forEach(C=>{M[C]=!0});for(const C in this.layerIndexes)M[C]||delete this.layerIndexes[C]}}const Yn=(I,y)=>x.emitValidationErrors(I,y&&y.filter(M=>M.identifier!=="source.canvas")),Qo=x.pick(Qe,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),sn=x.pick(Qe,["setCenter","setZoom","setBearing","setPitch"]),sr=function(){const I={},y=x.spec.$version;for(const M in x.spec.$root){const C=x.spec.$root[M];if(C.required){let L=null;L=M==="version"?y:C.type==="array"?[]:{},L!=null&&(I[M]=L)}}return I}(),ic={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class Zr extends x.Evented{constructor(y,M={}){super(),this.map=y,this.dispatcher=new Rt(Oe(),this),this.imageManager=new le,this.imageManager.setEventedParent(this),this.glyphManager=new x.GlyphManager(y._requestManager,M.localFontFamily?x.LocalGlyphMode.all:M.localIdeographFontFamily?x.LocalGlyphMode.ideographs:x.LocalGlyphMode.none,M.localFontFamily||M.localIdeographFontFamily),this.lineAtlas=new x.LineAtlas(256,512),this.crossTileSymbolIndex=new Jo,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new x.ZoomHistory,this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",x.getReferrer());const C=this;this._rtlTextPluginCallback=Zr.registerForPluginStateChange(L=>{C.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:L.pluginStatus,pluginURL:L.pluginURL},(F,N)=>{if(x.triggerPluginCompletionEvent(F),N&&N.every(q=>q))for(const q in C._sourceCaches){const W=C._sourceCaches[q],J=W.getSource().type;J!=="vector"&&J!=="geojson"||W.reload()}})}),this.on("data",L=>{if(L.dataType!=="source"||L.sourceDataType!=="metadata")return;const F=this.getSource(L.sourceId);if(F&&F.vectorLayerIds)for(const N in this._layers){const q=this._layers[N];q.source===F.id&&this._validateLayer(q)}})}loadURL(y,M={}){this.fire(new x.Event("dataloading",{dataType:"style"}));const C=typeof M.validate=="boolean"?M.validate:!x.isMapboxURL(y);y=this.map._requestManager.normalizeStyleURL(y,M.accessToken);const L=this.map._requestManager.transformRequest(y,x.ResourceType.Style);this._request=x.getJSON(L,(F,N)=>{this._request=null,F?this.fire(new x.ErrorEvent(F)):N&&this._load(N,C)})}loadJSON(y,M={}){this.fire(new x.Event("dataloading",{dataType:"style"})),this._request=x.exported.frame(()=>{this._request=null,this._load(y,M.validate!==!1)})}loadEmpty(){this.fire(new x.Event("dataloading",{dataType:"style"})),this._load(sr,!1)}_updateLayerCount(y,M){const C=M?1:-1;y.is3D()&&(this._num3DLayers+=C),y.type==="circle"&&(this._numCircleLayers+=C),y.type==="symbol"&&(this._numSymbolLayers+=C)}_load(y,M){if(M&&Yn(this,x.validateStyle(y)))return;this._loaded=!0,this.stylesheet=y,this.updateProjection();for(const L in y.sources)this.addSource(L,y.sources[L],{validate:!1});this._changed=!1,y.sprite?this._loadSprite(y.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(y.glyphs);const C=Je(this.stylesheet.layers);this._order=C.map(L=>L.id),this._layers={},this._serializedLayers={};for(let L of C)L=x.createStyleLayer(L),L.setEventedParent(this,{layer:{id:L.id}}),this._layers[L.id]=L,this._serializedLayers[L.id]=L.serialize(),this._updateLayerCount(L,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new xe(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new x.Event("data",{dataType:"style"})),this.fire(new x.Event("style.load"))}terrainSetForDrapingOnly(){return this.terrain&&this.terrain.drapeRenderMode===0}setProjection(y){y?this.stylesheet.projection=y:delete this.stylesheet.projection,this.updateProjection()}updateProjection(){const y=this.map.transform.projection,M=this.map.transform.setProjection(this.map._runtimeProjection||(this.stylesheet?this.stylesheet.projection:void 0)),C=this.map.transform.projection;if(this._loaded&&(C.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null)),this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),M){if(C.isReprojectedInTileSpace||y.isReprojectedInTileSpace){this.map.painter.clearBackgroundTiles();for(const L in this._sourceCaches)this._sourceCaches[L].clearTiles()}else this._forceSymbolLayerUpdate();this.map._update(!0)}}_loadSprite(y){this._spriteRequest=function(M,C,L){let F,N,q;const W=x.exported.devicePixelRatio>1?"@2x":"";let J=x.getJSON(C.transformRequest(C.normalizeSpriteURL(M,W,".json"),x.ResourceType.SpriteJSON),(fe,we)=>{J=null,q||(q=fe,F=we,ne())}),ee=x.getImage(C.transformRequest(C.normalizeSpriteURL(M,W,".png"),x.ResourceType.SpriteImage),(fe,we)=>{ee=null,q||(q=fe,N=we,ne())});function ne(){if(q)L(q);else if(F&&N){const fe=x.exported.getImageData(N),we={};for(const ye in F){const{width:Ee,height:ze,x:be,y:Ce,sdf:Pe,pixelRatio:Ie,stretchX:ke,stretchY:Fe,content:Ye}=F[ye],Ke=new x.RGBAImage({width:Ee,height:ze});x.RGBAImage.copy(fe,Ke,{x:be,y:Ce},{x:0,y:0},{width:Ee,height:ze}),we[ye]={data:Ke,pixelRatio:Ie,sdf:Pe,stretchX:ke,stretchY:Fe,content:Ye}}L(null,we)}}return{cancel(){J&&(J.cancel(),J=null),ee&&(ee.cancel(),ee=null)}}}(y,this.map._requestManager,(M,C)=>{if(this._spriteRequest=null,M)this.fire(new x.ErrorEvent(M));else if(C)for(const L in C)this.imageManager.addImage(L,C[L]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new x.Event("data",{dataType:"style"}))})}_validateLayer(y){const M=this.getSource(y.source);if(!M)return;const C=y.sourceLayer;C&&(M.type==="geojson"||M.vectorLayerIds&&M.vectorLayerIds.indexOf(C)===-1)&&this.fire(new x.ErrorEvent(new Error(`Source layer "${C}" does not exist on source "${M.id}" as specified by style layer "${y.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const y in this._sourceCaches)if(!this._sourceCaches[y].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(y){const M=[];for(const C of y){const L=this._layers[C];L.type!=="custom"&&M.push(L.serialize())}return M}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const y in this._sourceCaches)if(this._sourceCaches[y].hasTransition())return!0;for(const y in this._layers)if(this._layers[y].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(y){return!!this.terrain&&ic[y.type]}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(y){if(!this._loaded)return;const M=this._changed;if(this._changed){const L=Object.keys(this._updatedLayers),F=Object.keys(this._removedLayers);(L.length||F.length)&&this._updateWorkerLayers(L,F);for(const N in this._updatedSources){const q=this._updatedSources[N];q==="reload"?this._reloadSource(N):q==="clear"&&this._clearSource(N)}this._updateTilesForChangedImages();for(const N in this._updatedPaintProps)this._layers[N].updateTransitions(y);this.light.updateTransitions(y),this.fog&&this.fog.updateTransitions(y),this._resetUpdates()}const C={};for(const L in this._sourceCaches){const F=this._sourceCaches[L];C[L]=F.used,F.used=!1}for(const L of this._order){const F=this._layers[L];if(F.recalculate(y,this._availableImages),!F.isHidden(y.zoom)){const q=this._getLayerSourceCache(F);q&&(q.used=!0)}const N=this.map.painter;if(N){const q=F.getProgramIds();if(!q)continue;const W=F.getProgramConfiguration(y.zoom);for(const J of q)N.useProgram(J,W)}}for(const L in C){const F=this._sourceCaches[L];C[L]!==F.used&&F.getSource().fire(new x.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:F.getSource().id}))}this.light.recalculate(y),this.terrain&&this.terrain.recalculate(y),this.fog&&this.fog.recalculate(y),this.z=y.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),M&&this.fire(new x.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const y=Object.keys(this._changedImages);if(y.length){for(const M in this._sourceCaches)this._sourceCaches[M].reloadTilesForDependencies(["icons","patterns"],y);this._changedImages={}}}_updateWorkerLayers(y,M){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(y),removedIds:M})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(y){if(this._checkLoaded(),Yn(this,x.validateStyle(y)))return!1;(y=x.clone$1(y)).layers=Je(y.layers);const M=function(L,F){if(!L)return[{command:Qe.setStyle,args:[F]}];let N=[];try{if(!G(L.version,F.version))return[{command:Qe.setStyle,args:[F]}];G(L.center,F.center)||N.push({command:Qe.setCenter,args:[F.center]}),G(L.zoom,F.zoom)||N.push({command:Qe.setZoom,args:[F.zoom]}),G(L.bearing,F.bearing)||N.push({command:Qe.setBearing,args:[F.bearing]}),G(L.pitch,F.pitch)||N.push({command:Qe.setPitch,args:[F.pitch]}),G(L.sprite,F.sprite)||N.push({command:Qe.setSprite,args:[F.sprite]}),G(L.glyphs,F.glyphs)||N.push({command:Qe.setGlyphs,args:[F.glyphs]}),G(L.transition,F.transition)||N.push({command:Qe.setTransition,args:[F.transition]}),G(L.light,F.light)||N.push({command:Qe.setLight,args:[F.light]}),G(L.fog,F.fog)||N.push({command:Qe.setFog,args:[F.fog]}),G(L.projection,F.projection)||N.push({command:Qe.setProjection,args:[F.projection]});const q={},W=[];(function(ne,fe,we,ye){let Ee;for(Ee in fe=fe||{},ne=ne||{})ne.hasOwnProperty(Ee)&&(fe.hasOwnProperty(Ee)||kt(Ee,we,ye));for(Ee in fe)fe.hasOwnProperty(Ee)&&(ne.hasOwnProperty(Ee)?G(ne[Ee],fe[Ee])||(ne[Ee].type==="geojson"&&fe[Ee].type==="geojson"&&Zt(ne,fe,Ee)?we.push({command:Qe.setGeoJSONSourceData,args:[Ee,fe[Ee].data]}):jt(Ee,fe,we,ye)):at(Ee,fe,we))})(L.sources,F.sources,W,q);const J=[];L.layers&&L.layers.forEach(ne=>{q[ne.source]?N.push({command:Qe.removeLayer,args:[ne.id]}):J.push(ne)});let ee=L.terrain;ee&&q[ee.source]&&(N.push({command:Qe.setTerrain,args:[void 0]}),ee=void 0),N=N.concat(W),G(ee,F.terrain)||N.push({command:Qe.setTerrain,args:[F.terrain]}),function(ne,fe,we){fe=fe||[];const ye=(ne=ne||[]).map(mi),Ee=fe.map(mi),ze=ne.reduce(Xi,{}),be=fe.reduce(Xi,{}),Ce=ye.slice(),Pe=Object.create(null);let Ie,ke,Fe,Ye,Ke,yt,dt;for(Ie=0,ke=0;Ie<ye.length;Ie++)Fe=ye[Ie],be.hasOwnProperty(Fe)?ke++:(we.push({command:Qe.removeLayer,args:[Fe]}),Ce.splice(Ce.indexOf(Fe,ke),1));for(Ie=0,ke=0;Ie<Ee.length;Ie++)Fe=Ee[Ee.length-1-Ie],Ce[Ce.length-1-Ie]!==Fe&&(ze.hasOwnProperty(Fe)?(we.push({command:Qe.removeLayer,args:[Fe]}),Ce.splice(Ce.lastIndexOf(Fe,Ce.length-ke),1)):ke++,yt=Ce[Ce.length-Ie],we.push({command:Qe.addLayer,args:[be[Fe],yt]}),Ce.splice(Ce.length-Ie,0,Fe),Pe[Fe]=!0);for(Ie=0;Ie<Ee.length;Ie++)if(Fe=Ee[Ie],Ye=ze[Fe],Ke=be[Fe],!Pe[Fe]&&!G(Ye,Ke))if(G(Ye.source,Ke.source)&&G(Ye["source-layer"],Ke["source-layer"])&&G(Ye.type,Ke.type)){for(dt in Yt(Ye.layout,Ke.layout,we,Fe,null,Qe.setLayoutProperty),Yt(Ye.paint,Ke.paint,we,Fe,null,Qe.setPaintProperty),G(Ye.filter,Ke.filter)||we.push({command:Qe.setFilter,args:[Fe,Ke.filter]}),G(Ye.minzoom,Ke.minzoom)&&G(Ye.maxzoom,Ke.maxzoom)||we.push({command:Qe.setLayerZoomRange,args:[Fe,Ke.minzoom,Ke.maxzoom]}),Ye)Ye.hasOwnProperty(dt)&&dt!=="layout"&&dt!=="paint"&&dt!=="filter"&&dt!=="metadata"&&dt!=="minzoom"&&dt!=="maxzoom"&&(dt.indexOf("paint.")===0?Yt(Ye[dt],Ke[dt],we,Fe,dt.slice(6),Qe.setPaintProperty):G(Ye[dt],Ke[dt])||we.push({command:Qe.setLayerProperty,args:[Fe,dt,Ke[dt]]}));for(dt in Ke)Ke.hasOwnProperty(dt)&&!Ye.hasOwnProperty(dt)&&dt!=="layout"&&dt!=="paint"&&dt!=="filter"&&dt!=="metadata"&&dt!=="minzoom"&&dt!=="maxzoom"&&(dt.indexOf("paint.")===0?Yt(Ye[dt],Ke[dt],we,Fe,dt.slice(6),Qe.setPaintProperty):G(Ye[dt],Ke[dt])||we.push({command:Qe.setLayerProperty,args:[Fe,dt,Ke[dt]]}))}else we.push({command:Qe.removeLayer,args:[Fe]}),yt=Ce[Ce.lastIndexOf(Fe)+1],we.push({command:Qe.addLayer,args:[Ke,yt]})}(J,F.layers,N)}catch(q){console.warn("Unable to compute style diff:",q),N=[{command:Qe.setStyle,args:[F]}]}return N}(this.serialize(),y).filter(L=>!(L.command in sn));if(M.length===0)return!1;const C=M.filter(L=>!(L.command in Qo));if(C.length>0)throw new Error(`Unimplemented: ${C.map(L=>L.command).join(", ")}.`);return M.forEach(L=>{L.command!=="setTransition"&&this[L.command].apply(this,L.args)}),this.stylesheet=y,this.updateProjection(),!0}addImage(y,M){if(this.getImage(y))return this.fire(new x.ErrorEvent(new Error("An image with this name already exists.")));this.imageManager.addImage(y,M),this._afterImageUpdated(y)}updateImage(y,M){this.imageManager.updateImage(y,M)}getImage(y){return this.imageManager.getImage(y)}removeImage(y){if(!this.getImage(y))return this.fire(new x.ErrorEvent(new Error("No image with this name exists.")));this.imageManager.removeImage(y),this._afterImageUpdated(y)}_afterImageUpdated(y){this._availableImages=this.imageManager.listImages(),this._changedImages[y]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new x.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(y,M,C={}){if(this._checkLoaded(),this.getSource(y)!==void 0)throw new Error("There is already a source with this ID");if(!M.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(M).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(M.type)>=0&&this._validate(x.validateStyle.source,`sources.${y}`,M,null,C))return;this.map&&this.map._collectResourceTiming&&(M.collectResourceTiming=!0);const L=je(y,M,this.dispatcher,this);L.setEventedParent(this,()=>({isSourceLoaded:this.loaded(),source:L.serialize(),sourceId:y}));const F=N=>{const q=(N?"symbol:":"other:")+y,W=this._sourceCaches[q]=new x.SourceCache(q,L,N);(N?this._symbolSourceCaches:this._otherSourceCaches)[y]=W,W.style=this,W.onAdd(this.map)};F(!1),M.type!=="vector"&&M.type!=="geojson"||F(!0),L.onAdd&&L.onAdd(this.map),this._changed=!0}removeSource(y){this._checkLoaded();const M=this.getSource(y);if(M===void 0)throw new Error("There is no source with this ID");for(const L in this._layers)if(this._layers[L].source===y)return this.fire(new x.ErrorEvent(new Error(`Source "${y}" cannot be removed while layer "${L}" is using it.`)));if(this.terrain&&this.terrain.get().source===y)return this.fire(new x.ErrorEvent(new Error(`Source "${y}" cannot be removed while terrain is using it.`)));const C=this._getSourceCaches(y);for(const L of C)delete this._sourceCaches[L.id],delete this._updatedSources[L.id],L.fire(new x.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:L.getSource().id})),L.setEventedParent(null),L.clearTiles();delete this._otherSourceCaches[y],delete this._symbolSourceCaches[y],M.setEventedParent(null),M.onRemove&&M.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(y,M){this._checkLoaded(),this.getSource(y).setData(M),this._changed=!0}getSource(y){const M=this._getSourceCache(y);return M&&M.getSource()}addLayer(y,M,C={}){this._checkLoaded();const L=y.id;if(this.getLayer(L))return void this.fire(new x.ErrorEvent(new Error(`Layer with id "${L}" already exists on this map`)));let F;if(y.type==="custom"){if(Yn(this,x.validateCustomStyleLayer(y)))return;F=x.createStyleLayer(y)}else{if(typeof y.source=="object"&&(this.addSource(L,y.source),y=x.clone$1(y),y=x.extend(y,{source:L})),this._validate(x.validateStyle.layer,`layers.${L}`,y,{arrayIndex:-1},C))return;F=x.createStyleLayer(y),this._validateLayer(F),F.setEventedParent(this,{layer:{id:L}}),this._serializedLayers[F.id]=F.serialize(),this._updateLayerCount(F,!0)}const N=M?this._order.indexOf(M):this._order.length;if(M&&N===-1)return void this.fire(new x.ErrorEvent(new Error(`Layer with id "${M}" does not exist on this map.`)));this._order.splice(N,0,L),this._layerOrderChanged=!0,this._layers[L]=F;const q=this._getLayerSourceCache(F);if(this._removedLayers[L]&&F.source&&q&&F.type!=="custom"){const W=this._removedLayers[L];delete this._removedLayers[L],W.type!==F.type?this._updatedSources[F.source]="clear":(this._updatedSources[F.source]="reload",q.pause())}this._updateLayer(F),F.onAdd&&F.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(y,M){if(this._checkLoaded(),this._changed=!0,!this._layers[y])return void this.fire(new x.ErrorEvent(new Error(`The layer '${y}' does not exist in the map's style and cannot be moved.`)));if(y===M)return;const C=this._order.indexOf(y);this._order.splice(C,1);const L=M?this._order.indexOf(M):this._order.length;M&&L===-1?this.fire(new x.ErrorEvent(new Error(`Layer with id "${M}" does not exist on this map.`))):(this._order.splice(L,0,y),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(y){this._checkLoaded();const M=this._layers[y];if(!M)return void this.fire(new x.ErrorEvent(new Error(`The layer '${y}' does not exist in the map's style and cannot be removed.`)));M.setEventedParent(null),this._updateLayerCount(M,!1);const C=this._order.indexOf(y);this._order.splice(C,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[y]=M,delete this._layers[y],delete this._serializedLayers[y],delete this._updatedLayers[y],delete this._updatedPaintProps[y],M.onRemove&&M.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(y){return this._layers[y]}hasLayer(y){return y in this._layers}hasLayerType(y){for(const M in this._layers)if(this._layers[M].type===y)return!0;return!1}setLayerZoomRange(y,M,C){this._checkLoaded();const L=this.getLayer(y);L?L.minzoom===M&&L.maxzoom===C||(M!=null&&(L.minzoom=M),C!=null&&(L.maxzoom=C),this._updateLayer(L)):this.fire(new x.ErrorEvent(new Error(`The layer '${y}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(y,M,C={}){this._checkLoaded();const L=this.getLayer(y);if(L){if(!G(L.filter,M))return M==null?(L.filter=void 0,void this._updateLayer(L)):void(this._validate(x.validateStyle.filter,`layers.${L.id}.filter`,M,{layerType:L.type},C)||(L.filter=x.clone$1(M),this._updateLayer(L)))}else this.fire(new x.ErrorEvent(new Error(`The layer '${y}' does not exist in the map's style and cannot be filtered.`)))}getFilter(y){return x.clone$1(this.getLayer(y).filter)}setLayoutProperty(y,M,C,L={}){this._checkLoaded();const F=this.getLayer(y);F?G(F.getLayoutProperty(M),C)||(F.setLayoutProperty(M,C,L),this._updateLayer(F)):this.fire(new x.ErrorEvent(new Error(`The layer '${y}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(y,M){const C=this.getLayer(y);if(C)return C.getLayoutProperty(M);this.fire(new x.ErrorEvent(new Error(`The layer '${y}' does not exist in the map's style.`)))}setPaintProperty(y,M,C,L={}){this._checkLoaded();const F=this.getLayer(y);F?G(F.getPaintProperty(M),C)||(F.setPaintProperty(M,C,L)&&this._updateLayer(F),this._changed=!0,this._updatedPaintProps[y]=!0):this.fire(new x.ErrorEvent(new Error(`The layer '${y}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(y,M){return this.getLayer(y).getPaintProperty(M)}setFeatureState(y,M){this._checkLoaded();const C=y.source,L=y.sourceLayer,F=this.getSource(C);if(F===void 0)return void this.fire(new x.ErrorEvent(new Error(`The source '${C}' does not exist in the map's style.`)));const N=F.type;if(N==="geojson"&&L)return void this.fire(new x.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(N==="vector"&&!L)return void this.fire(new x.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));y.id===void 0&&this.fire(new x.ErrorEvent(new Error("The feature id parameter must be provided.")));const q=this._getSourceCaches(C);for(const W of q)W.setFeatureState(L,y.id,M)}removeFeatureState(y,M){this._checkLoaded();const C=y.source,L=this.getSource(C);if(L===void 0)return void this.fire(new x.ErrorEvent(new Error(`The source '${C}' does not exist in the map's style.`)));const F=L.type,N=F==="vector"?y.sourceLayer:void 0;if(F==="vector"&&!N)return void this.fire(new x.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(M&&typeof y.id!="string"&&typeof y.id!="number")return void this.fire(new x.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const q=this._getSourceCaches(C);for(const W of q)W.removeFeatureState(N,y.id,M)}getFeatureState(y){this._checkLoaded();const M=y.source,C=y.sourceLayer,L=this.getSource(M);if(L!==void 0){if(L.type!=="vector"||C)return y.id===void 0&&this.fire(new x.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(M)[0].getFeatureState(C,y.id);this.fire(new x.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new x.ErrorEvent(new Error(`The source '${M}' does not exist in the map's style.`)))}getTransition(){return x.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const y={};for(const M in this._sourceCaches){const C=this._sourceCaches[M].getSource();y[C.id]||(y[C.id]=C.serialize())}return x.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.stylesheet.terrain,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:y,layers:this._serializeLayers(this._order)},M=>M!==void 0)}_updateLayer(y){this._updatedLayers[y.id]=!0;const M=this._getLayerSourceCache(y);y.source&&!this._updatedSources[y.source]&&M&&M.getSource().type!=="raster"&&(this._updatedSources[y.source]="reload",M.pause()),this._changed=!0,y.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(y){const M=N=>this._layers[N].type==="fill-extrusion",C={},L=[];for(let N=this._order.length-1;N>=0;N--){const q=this._order[N];if(M(q)){C[q]=N;for(const W of y){const J=W[q];if(J)for(const ee of J)L.push(ee)}}}L.sort((N,q)=>q.intersectionZ-N.intersectionZ);const F=[];for(let N=this._order.length-1;N>=0;N--){const q=this._order[N];if(M(q))for(let W=L.length-1;W>=0;W--){const J=L[W].feature;if(C[J.layer.id]<N)break;F.push(J),L.pop()}else for(const W of y){const J=W[q];if(J)for(const ee of J)F.push(ee.feature)}}return F}queryRenderedFeatures(y,M,C){M&&M.filter&&this._validate(x.validateStyle.filter,"queryRenderedFeatures.filter",M.filter,null,M);const L={};if(M&&M.layers){if(!Array.isArray(M.layers))return this.fire(new x.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const W of M.layers){const J=this._layers[W];if(!J)return this.fire(new x.ErrorEvent(new Error(`The layer '${W}' does not exist in the map's style and cannot be queried for features.`))),[];L[J.source]=!0}}const F=[];M.availableImages=this._availableImages;const N=M&&M.layers?M.layers.some(W=>{const J=this.getLayer(W);return J&&J.is3D()}):this.has3DLayers(),q=on.createFromScreenPoints(y,C);for(const W in this._sourceCaches){const J=this._sourceCaches[W].getSource().id;M.layers&&!L[J]||F.push(K(this._sourceCaches[W],this._layers,this._serializedLayers,q,M,C,N,!!this.map._showQueryGeometry))}return this.placement&&F.push(function(W,J,ee,ne,fe,we,ye){const Ee={},ze=we.queryRenderedSymbols(ne),be=[];for(const Ce of Object.keys(ze).map(Number))be.push(ye[Ce]);be.sort(de);for(const Ce of be){const Pe=Ce.featureIndex.lookupSymbolFeatures(ze[Ce.bucketInstanceId],J,Ce.bucketIndex,Ce.sourceLayerIndex,fe.filter,fe.layers,fe.availableImages,W);for(const Ie in Pe){const ke=Ee[Ie]=Ee[Ie]||[],Fe=Pe[Ie];Fe.sort((Ye,Ke)=>{const yt=Ce.featureSortOrder;if(yt){const dt=yt.indexOf(Ye.featureIndex);return yt.indexOf(Ke.featureIndex)-dt}return Ke.featureIndex-Ye.featureIndex});for(const Ye of Fe)ke.push(Ye)}}for(const Ce in Ee)Ee[Ce].forEach(Pe=>{const Ie=Pe.feature,ke=ee(W[Ce]).getFeatureState(Ie.layer["source-layer"],Ie.id);Ie.source=Ie.layer.source,Ie.layer["source-layer"]&&(Ie.sourceLayer=Ie.layer["source-layer"]),Ie.state=ke});return Ee}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),q.screenGeometry,M,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(F)}querySourceFeatures(y,M){M&&M.filter&&this._validate(x.validateStyle.filter,"querySourceFeatures.filter",M.filter,null,M);const C=this._getSourceCaches(y);let L=[];for(const F of C)L=L.concat(re(F,M));return L}addSourceType(y,M,C){return Zr.getSourceType(y)?C(new Error(`A source type called "${y}" already exists.`)):(Zr.setSourceType(y,M),M.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:y,url:M.workerSourceURL},C):C(null,null))}getLight(){return this.light.getLight()}setLight(y,M={}){this._checkLoaded();const C=this.light.getLight();let L=!1;for(const N in y)if(!G(y[N],C[N])){L=!0;break}if(!L)return;const F={now:x.exported.now(),transition:x.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(y,M),this.light.updateTransitions(F)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(y,M=1){if(this._checkLoaded(),!y)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(M===1){if(typeof y.source=="object"){const C="terrain-dem-src";this.addSource(C,y.source),y=x.clone$1(y),y=x.extend(y,{source:C})}if(this._validate(x.validateStyle.terrain,"terrain",y))return}if(!this.terrain||this.terrain&&M!==this.terrain.drapeRenderMode)this._createTerrain(y,M);else{const C=this.terrain,L=C.get();for(const F in y)if(!G(y[F],L[F])){C.set(y),this.stylesheet.terrain=y;const N={now:x.exported.now(),transition:x.extend({duration:0},this.stylesheet.transition)};C.updateTransitions(N);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(y){const M=this.fog=new ht(y,this.map.transform);this.stylesheet.fog=y;const C={now:x.exported.now(),transition:x.extend({duration:0},this.stylesheet.transition)};M.updateTransitions(C)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const y of this.map._markers)y._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(y){if(this._checkLoaded(),!y)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const M=this.fog,C=M.get();for(const L in y)if(!G(y[L],C[L])){M.set(y),this.stylesheet.fog=y;const F={now:x.exported.now(),transition:x.extend({duration:0},this.stylesheet.transition)};M.updateTransitions(F);break}}else this._createFog(y);this._markersNeedUpdate=!0}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const y=this._order.filter(C=>this.isLayerDraped(this._layers[C])),M=this._order.filter(C=>!this.isLayerDraped(this._layers[C]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...y),this._drapedFirstOrder.push(...M)}_createTerrain(y,M){const C=this.terrain=new he(y,M);this.stylesheet.terrain=y,this.dispatcher.broadcast("enableTerrain",!0),this._force3DLayerUpdate();const L={now:x.exported.now(),transition:x.extend({duration:0},this.stylesheet.transition)};C.updateTransitions(L)}_force3DLayerUpdate(){for(const y in this._layers){const M=this._layers[y];M.type==="fill-extrusion"&&this._updateLayer(M)}}_forceSymbolLayerUpdate(){for(const y in this._layers){const M=this._layers[y];M.type==="symbol"&&this._updateLayer(M)}}_validate(y,M,C,L,F={}){return(!F||F.validate!==!1)&&Yn(this,y.call(x.validateStyle,x.extend({key:M,style:this.serialize(),value:C,styleSpec:x.spec},L)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),x.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const y in this._layers)this._layers[y].setEventedParent(null);for(const y in this._sourceCaches)this._sourceCaches[y].clearTiles(),this._sourceCaches[y].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(y){const M=this._getSourceCaches(y);for(const C of M)C.clearTiles()}_reloadSource(y){const M=this._getSourceCaches(y);for(const C of M)C.resume(),C.reload()}_updateSources(y){for(const M in this._sourceCaches)this._sourceCaches[M].update(y)}_generateCollisionBoxes(){for(const y in this._sourceCaches){const M=this._sourceCaches[y];M.resume(),M.reload()}}_updatePlacement(y,M,C,L,F=!1){let N=!1,q=!1;const W={};for(const J of this._order){const ee=this._layers[J];if(ee.type!=="symbol")continue;if(!W[ee.source]){const fe=this._getLayerSourceCache(ee);if(!fe)continue;W[ee.source]=fe.getRenderableIds(!0).map(we=>fe.getTileByID(we)).sort((we,ye)=>ye.tileID.overscaledZ-we.tileID.overscaledZ||(we.tileID.isLessThan(ye.tileID)?-1:1))}const ne=this.crossTileSymbolIndex.addLayer(ee,W[ee.source],y.center.lng,y.projection);N=N||ne}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),F=F||this._layerOrderChanged||C===0,this._layerOrderChanged&&this.fire(new x.Event("neworder")),(F||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(x.exported.now(),y.zoom))&&(this.pauseablePlacement=new Ii(y,this._order,F,M,C,L,this.placement,this.fog&&y.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,W),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(x.exported.now()),q=!0),N&&this.pauseablePlacement.placement.setStale()),q||N)for(const J of this._order){const ee=this._layers[J];ee.type==="symbol"&&this.placement.updateLayerOpacities(ee,W[ee.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(x.exported.now())}_releaseSymbolFadeTiles(){for(const y in this._sourceCaches)this._sourceCaches[y].releaseSymbolFadeTiles()}getImages(y,M,C){this.imageManager.getImages(M.icons,C),this._updateTilesForChangedImages();const L=F=>{F&&F.setDependencies(M.tileID.key,M.type,M.icons)};L(this._otherSourceCaches[M.source]),L(this._symbolSourceCaches[M.source])}getGlyphs(y,M,C){this.glyphManager.getGlyphs(M.stacks,C)}getResource(y,M,C){return x.makeRequest(M,C)}_getSourceCache(y){return this._otherSourceCaches[y]}_getLayerSourceCache(y){return y.type==="symbol"?this._symbolSourceCaches[y.source]:this._otherSourceCaches[y.source]}_getSourceCaches(y){const M=[];return this._otherSourceCaches[y]&&M.push(this._otherSourceCaches[y]),this._symbolSourceCaches[y]&&M.push(this._symbolSourceCaches[y]),M}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Zr.getSourceType=function(I){return Te[I]},Zr.setSourceType=function(I,y){Te[I]=y},Zr.registerForPluginStateChange=x.registerForPluginStateChange;var Fs=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}
#endif`,To="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}";let Mo={},So={};Mo=gi("",`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform sampler2D u_dem;uniform sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {return currentElevation(apos);}
#endif
float unpack_depth(vec4 rgba_depth)
{const vec4 bit_shift=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,!0),So=gi(`#ifdef FOG
uniform float u_fog_temporal_offset;float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,`#ifdef FOG
uniform mat4 u_fog_matrix;vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,!0);const Fi=gi(`
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef TERRAIN
highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(256.0*256.0*256.0,256.0*256.0,256.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/256.0,1.0/256.0,1.0/256.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#endif`,`
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {
#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)
return mix(globe,mercator,t);
#else
return globe;
#endif
}
#ifdef PROJECTION_GLOBE_VIEW
mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),Os=Fs;var za={background:gi(`uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:gi(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:gi(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
vec2 scaled_extrude=extrude*a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=scaled_extrude.x*surface_vectors[0]+scaled_extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);vec4 world_center=vec4(pos,1);
#else 
mat3 surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);vec4 world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
#if defined(SCALE_WITH_MAP) && defined(PROJECTION_GLOBE_VIEW)
view_scale*=a_scale;
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);vec4 occlusion_world_center=vec4(circle_center,cantilevered_height,1);vec4 occlusion_projected_center=u_matrix*occlusion_world_center;
#else
vec4 occlusion_world_center=world_center;vec4 occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:gi("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:gi(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
extrude*=a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
vec3 pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:gi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:gi("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:gi("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:gi("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",`attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;
#endif
varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:gi(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:gi(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:gi(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:gi(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:gi(`varying vec4 v_color;void main() {vec4 color=v_color;
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 pos=vec3(pos_nx.xy,h);
#else
vec3 pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(pos.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionPattern:gi(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 p=vec3(pos_nx.xy,h);
#else
vec3 p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),hillshadePrepare:gi(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:gi(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:gi(`uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
#ifdef RENDER_LINE_GRADIENT
vec4 out_color=texture2D(u_gradient_image,v_uv);
#else
vec4 out_color=color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef RENDER_LINE_ALPHA_DISCARD
if (alpha < u_alpha_discard_threshold) {discard;}
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#ifdef RENDER_LINE_GRADIENT
attribute vec3 a_packed;
#else
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_GRADIENT
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];float a_linesofar=a_packed[2];highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);
#endif
#ifdef RENDER_LINE_DASH
float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:gi(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:gi(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:gi(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}`),symbolSDF:gi(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}`),symbolTextAndIcon:gi(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}`),terrainRaster:gi(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
void main() {vec4 color=texture2D(u_image0,v_pos0);
#ifdef FOG
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
const float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;
#ifdef TERRAIN_WIREFRAME
elevation+=u_skirt_height*u_skirt_height*wireframeOffset;
#endif
vec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
}`),terrainDepth:gi(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:gi(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,To),skyboxGradient:gi(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,To),skyboxCapture:gi(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:gi(`uniform sampler2D u_image0;varying vec2 v_pos0;void main() {gl_FragColor=texture2D(u_image0,v_pos0);
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_proj_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;attribute vec3 a_globe_pos;attribute vec2 a_merc_pos;attribute vec2 a_uv;varying vec2 v_pos0;const float wireframeOffset=1e3;void main() {v_pos0=a_uv;vec2 uv=a_uv*EXTENT;vec4 up_vector=vec4(elevationVector(uv),1.0);float height=elevation(uv);
#ifdef TERRAIN_WIREFRAME
height+=wireframeOffset;
#endif
vec4 globe=u_globe_matrix*vec4(a_globe_pos+up_vector.xyz*height,1.0);vec4 mercator=vec4(0.0);if (u_zoom_transition > 0.0) {mercator=vec4(a_merc_pos,height,1.0);mercator.xy-=u_merc_center;mercator.x=wrap(mercator.x,-0.5,0.5);mercator=u_merc_matrix*mercator;}vec3 position=mix(globe.xyz,mercator.xyz,u_zoom_transition);gl_Position=u_proj_matrix*vec4(position,1.0);}`),globeAtmosphere:gi(`uniform vec2 u_center;uniform float u_radius;uniform vec2 u_screen_size;uniform float u_opacity;uniform highp float u_fadeout_range;uniform vec3 u_start_color;uniform vec3 u_end_color;uniform float u_pixel_ratio;void main() {highp vec2 fragCoord=gl_FragCoord.xy/u_pixel_ratio;fragCoord.y=u_screen_size.y-fragCoord.y;float distFromCenter=length(fragCoord-u_center);float normDistFromCenter=length(fragCoord-u_center)/u_radius;if (normDistFromCenter < 1.0)
discard;float t=clamp(1.0-sqrt(normDistFromCenter-1.0)/u_fadeout_range,0.0,1.0);vec3 color=mix(u_start_color,u_end_color,1.0-t);gl_FragColor=vec4(color*t*u_opacity,u_opacity);}`,"attribute vec3 a_pos;void main() {gl_Position=vec4(a_pos,1.0);}")};function gi(I,y,M){const C=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,L=/uniform (highp |mediump |lowp )?([\w]+) ([\w]+)([\s]*)([\w]*)/g,F=y.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),N=I.match(L),q=y.match(L),W=Fs.match(L);let J=q?q.concat(N):N;M||(Mo.staticUniforms&&(J=Mo.staticUniforms.concat(J)),So.staticUniforms&&(J=So.staticUniforms.concat(J))),J&&(J=J.concat(W));const ee={};return{fragmentSource:I=I.replace(C,(ne,fe,we,ye,Ee)=>(ee[Ee]=!0,fe==="define"?`
#ifndef HAS_UNIFORM_u_${Ee}
varying ${we} ${ye} ${Ee};
#else
uniform ${we} ${ye} u_${Ee};
#endif
`:`
#ifdef HAS_UNIFORM_u_${Ee}
    ${we} ${ye} ${Ee} = u_${Ee};
#endif
`)),vertexSource:y=y.replace(C,(ne,fe,we,ye,Ee)=>{const ze=ye==="float"?"vec2":"vec4",be=Ee.match(/color/)?"color":ze;return ee[Ee]?fe==="define"?`
#ifndef HAS_UNIFORM_u_${Ee}
uniform lowp float u_${Ee}_t;
attribute ${we} ${ze} a_${Ee};
varying ${we} ${ye} ${Ee};
#else
uniform ${we} ${ye} u_${Ee};
#endif
`:be==="vec4"?`
#ifndef HAS_UNIFORM_u_${Ee}
    ${Ee} = a_${Ee};
#else
    ${we} ${ye} ${Ee} = u_${Ee};
#endif
`:`
#ifndef HAS_UNIFORM_u_${Ee}
    ${Ee} = unpack_mix_${be}(a_${Ee}, u_${Ee}_t);
#else
    ${we} ${ye} ${Ee} = u_${Ee};
#endif
`:fe==="define"?`
#ifndef HAS_UNIFORM_u_${Ee}
uniform lowp float u_${Ee}_t;
attribute ${we} ${ze} a_${Ee};
#else
uniform ${we} ${ye} u_${Ee};
#endif
`:be==="vec4"?`
#ifndef HAS_UNIFORM_u_${Ee}
    ${we} ${ye} ${Ee} = a_${Ee};
#else
    ${we} ${ye} ${Ee} = u_${Ee};
#endif
`:`
#ifndef HAS_UNIFORM_u_${Ee}
    ${we} ${ye} ${Ee} = unpack_mix_${be}(a_${Ee}, u_${Ee}_t);
#else
    ${we} ${ye} ${Ee} = u_${Ee};
#endif
`}),staticAttributes:F,staticUniforms:J}}class an{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(y,M,C,L,F,N,q,W){this.context=y;let J=this.boundPaintVertexBuffers.length!==L.length;for(let ee=0;!J&&ee<L.length;ee++)this.boundPaintVertexBuffers[ee]!==L[ee]&&(J=!0);y.extVertexArrayObject&&this.vao&&this.boundProgram===M&&this.boundLayoutVertexBuffer===C&&!J&&this.boundIndexBuffer===F&&this.boundVertexOffset===N&&this.boundDynamicVertexBuffer===q&&this.boundDynamicVertexBuffer2===W?(y.bindVertexArrayOES.set(this.vao),q&&q.bind(),F&&F.dynamicDraw&&F.bind(),W&&W.bind()):this.freshBind(M,C,L,F,N,q,W)}freshBind(y,M,C,L,F,N,q){let W;const J=y.numAttributes,ee=this.context,ne=ee.gl;if(ee.extVertexArrayObject)this.vao&&this.destroy(),this.vao=ee.extVertexArrayObject.createVertexArrayOES(),ee.bindVertexArrayOES.set(this.vao),W=0,this.boundProgram=y,this.boundLayoutVertexBuffer=M,this.boundPaintVertexBuffers=C,this.boundIndexBuffer=L,this.boundVertexOffset=F,this.boundDynamicVertexBuffer=N,this.boundDynamicVertexBuffer2=q;else{W=ee.currentNumAttributes||0;for(let fe=J;fe<W;fe++)ne.disableVertexAttribArray(fe)}M.enableAttributes(ne,y);for(const fe of C)fe.enableAttributes(ne,y);N&&N.enableAttributes(ne,y),q&&q.enableAttributes(ne,y),M.bind(),M.setVertexAttribPointers(ne,y,F);for(const fe of C)fe.bind(),fe.setVertexAttribPointers(ne,y,F);N&&(N.bind(),N.setVertexAttribPointers(ne,y,F)),L&&L.bind(),q&&(q.bind(),q.setVertexAttribPointers(ne,y,F)),ee.currentNumAttributes=J}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function Fl(I,y){const M=Math.pow(2,y.canonical.z),C=y.canonical.y;return[new x.MercatorCoordinate(0,C/M).toLngLat().lat,new x.MercatorCoordinate(0,(C+1)/M).toLngLat().lat]}function $s(I,y,M,C,L,F,N){const q=I.context,W=q.gl,J=M.fbo;if(!J)return;I.prepareDrawTile(y);const ee=I.useProgram("hillshade");q.activeTexture.set(W.TEXTURE0),W.bindTexture(W.TEXTURE_2D,J.colorAttachment.get());const ne=((Ee,ze,be,Ce)=>{const Pe=be.paint.get("hillshade-shadow-color"),Ie=be.paint.get("hillshade-highlight-color"),ke=be.paint.get("hillshade-accent-color");let Fe=be.paint.get("hillshade-illumination-direction")*(Math.PI/180);be.paint.get("hillshade-illumination-anchor")==="viewport"&&(Fe-=Ee.transform.angle);const Ye=!Ee.options.moving;return{u_matrix:Ce||Ee.transform.calculateProjMatrix(ze.tileID.toUnwrapped(),Ye),u_image:0,u_latrange:Fl(0,ze.tileID),u_light:[be.paint.get("hillshade-exaggeration"),Fe],u_shadow:Pe,u_highlight:Ie,u_accent:ke}})(I,M,C,I.terrain?y.projMatrix:null);I.prepareDrawProgram(q,ee,y.toUnwrapped());const{tileBoundsBuffer:fe,tileBoundsIndexBuffer:we,tileBoundsSegments:ye}=I.getTileBoundsBuffers(M);ee.draw(q,W.TRIANGLES,L,F,N,x.CullFaceMode.disabled,ne,C.id,fe,we,ye)}function pr(I,y,M){if(!y.needsDEMTextureUpload)return;const C=I.context,L=C.gl;C.pixelStoreUnpackPremultiplyAlpha.set(!1),y.demTexture=y.demTexture||I.getTileTexture(M.stride);const F=M.getPixels();y.demTexture?y.demTexture.update(F,{premultiply:!1}):y.demTexture=new x.Texture(C,F,L.RGBA,{premultiply:!1}),y.needsDEMTextureUpload=!1}function es(I,y,M,C,L,F){const N=I.context,q=N.gl;if(!y.dem)return;const W=y.dem;if(N.activeTexture.set(q.TEXTURE1),pr(I,y,W),!y.demTexture)return;y.demTexture.bind(q.NEAREST,q.CLAMP_TO_EDGE);const J=W.dim;N.activeTexture.set(q.TEXTURE0);let ee=y.fbo;if(!ee){const ye=new x.Texture(N,{width:J,height:J,data:null},q.RGBA);ye.bind(q.LINEAR,q.CLAMP_TO_EDGE),ee=y.fbo=N.createFramebuffer(J,J,!0),ee.colorAttachment.set(ye.texture)}N.bindFramebuffer.set(ee.framebuffer),N.viewport.set([0,0,J,J]);const{tileBoundsBuffer:ne,tileBoundsIndexBuffer:fe,tileBoundsSegments:we}=I.getMercatorTileBoundsBuffers();I.useProgram("hillshadePrepare").draw(N,q.TRIANGLES,C,L,F,x.CullFaceMode.disabled,((ye,Ee)=>{const ze=Ee.stride,be=x.create();return x.ortho(be,0,x.EXTENT,-x.EXTENT,0,0,1),x.translate(be,be,[0,-x.EXTENT,0]),{u_matrix:be,u_image:1,u_dimension:[ze,ze],u_zoom:ye.overscaledZ,u_unpack:Ee.unpackVector}})(y.tileID,W),M.id,ne,fe,we),y.needsHillshadePrepare=!1}const Hn=(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_image0:new x.Uniform1i(I,y.u_image0),u_skirt_height:new x.Uniform1f(I,y.u_skirt_height)}),Sr=(I,y)=>({u_matrix:I,u_image0:0,u_skirt_height:y}),Us=(I,y,M,C,L)=>({u_proj_matrix:Float32Array.from(I),u_globe_matrix:y,u_merc_matrix:M,u_zoom_transition:C,u_merc_center:L,u_image0:0});function ln(I,y){return I!=null&&y!=null&&!(!I.hasData()||!y.hasData())&&I.demTexture!=null&&y.demTexture!=null&&I.tileID.key!==y.tileID.key}const An=new class{constructor(){this.operations={}}newMorphing(I,y,M,C,L){if(I in this.operations){const F=this.operations[I];F.to.tileID.key!==M.tileID.key&&(F.queued=M)}else this.operations[I]={startTime:C,phase:0,duration:L,from:y,to:M,queued:null}}getMorphValuesForProxy(I){if(!(I in this.operations))return null;const y=this.operations[I];return{from:y.from,to:y.to,phase:y.phase}}update(I){for(const y in this.operations){const M=this.operations[y];for(M.phase=(I-M.startTime)/M.duration;M.phase>=1||!this._validOp(M);)if(!this._nextOp(M,I)){delete this.operations[y];break}}}_nextOp(I,y){return!!I.queued&&(I.from=I.to,I.to=I.queued,I.queued=null,I.phase=0,I.startTime=y,!0)}_validOp(I){return I.from.hasData()&&I.to.hasData()}},lo={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function rc(I,y){const M=1<<I.z;return!y&&(I.x===0||I.x===M-1)||I.y===0||I.y===M-1}const In=I=>({u_matrix:I});function Ol(I,y,M,C,L){if(L>0){const F=x.exported.now(),N=(F-I.timeAdded)/L,q=y?(F-y.timeAdded)/L:-1,W=M.getSource(),J=C.coveringZoomLevel({tileSize:W.tileSize,roundZoom:W.roundZoom}),ee=!y||Math.abs(y.tileID.overscaledZ-J)>Math.abs(I.tileID.overscaledZ-J),ne=ee&&I.refreshedUponExpiration?1:x.clamp(ee?N:1-q,0,1);return I.refreshedUponExpiration&&N>=1&&(I.refreshedUponExpiration=!1),y?{opacity:1,mix:1-ne}:{opacity:ne,mix:0}}return{opacity:1,mix:0}}class $l extends x.SourceCache{constructor(y){const M={type:"raster-dem",maxzoom:y.transform.maxZoom},C=new Rt(Oe(),null),L=je("mock-dem",M,C,y.style);super("mock-dem",L,!1),L.setEventedParent(this),this._sourceLoaded=!0}_loadTile(y,M){y.state="loaded",M(null)}}class Jr extends x.SourceCache{constructor(y){const M=je("proxy",{type:"geojson",maxzoom:y.transform.maxZoom},new Rt(Oe(),null),y.style);super("proxy",M,!1),M.setEventedParent(this),this.map=this.getSource().map=y,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(y,M,C){if(y.freezeTileCoverage)return;this.transform=y;const L=y.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((F,N)=>{if(F[N.key]="",!this._tiles[N.key]){const q=new x.Tile(N,this._source.tileSize*N.overscaleFactor(),y.tileZoom);q.state="loaded",this._tiles[N.key]=q}return F},{});for(const F in this._tiles)F in L||(this.freeFBO(F),this._tiles[F].unloadVectorData(),delete this._tiles[F])}freeFBO(y){const M=this.proxyCachedFBO[y];if(M!==void 0){const C=Object.values(M);this.renderCachePool.push(...C),delete this.proxyCachedFBO[y]}}deallocRenderCache(){this.renderCache.forEach(y=>y.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class ts extends x.OverscaledTileID{constructor(y,M,C){super(y.overscaledZ,y.wrap,y.canonical.z,y.canonical.x,y.canonical.y),this.proxyTileKey=M,this.projMatrix=C}}class Wn extends x.Elevation{constructor(y,M){super(),this.painter=y,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[C,L,F]=function(W){const J=new x.StructArrayLayout4i8,ee=new x.StructArrayLayout3ui6,ne=131;J.reserve(17161),ee.reserve(33800);const fe=x.EXTENT/128,we=x.EXTENT+fe/2,ye=we+fe;for(let ze=-fe;ze<ye;ze+=fe)for(let be=-fe;be<ye;be+=fe){const Ce=be<0||be>we||ze<0||ze>we?24575:0,Pe=x.clamp(Math.round(be),0,x.EXTENT),Ie=x.clamp(Math.round(ze),0,x.EXTENT);J.emplaceBack(Pe+Ce,Ie,Pe,Ie)}const Ee=(ze,be)=>{const Ce=be*ne+ze;ee.emplaceBack(Ce+1,Ce,Ce+ne),ee.emplaceBack(Ce+ne,Ce+ne+1,Ce+1)};for(let ze=1;ze<129;ze++)for(let be=1;be<129;be++)Ee(be,ze);return[0,129].forEach(ze=>{for(let be=0;be<130;be++)Ee(be,ze),Ee(ze,be)}),[J,ee,32768]}(),N=y.context;this.gridBuffer=N.createVertexBuffer(C,x.boundsAttributes.members),this.gridIndexBuffer=N.createIndexBuffer(L),this.gridSegments=x.SegmentVector.simpleSegment(0,0,C.length,L.length),this.gridNoSkirtSegments=x.SegmentVector.simpleSegment(0,0,C.length,F),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Jr(M.map),this.orthoMatrix=x.create(),x.ortho(this.orthoMatrix,0,x.EXTENT,0,x.EXTENT,0,1);const q=N.gl;this._overlapStencilMode=new x.StencilMode({func:q.GEQUAL,mask:255},0,255,q.KEEP,q.KEEP,q.REPLACE),this._previousZoom=y.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=M,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new $l(M.map)}set style(y){y.on("data",this._onStyleDataEvent.bind(this)),y.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=y,this._checkRenderCacheEfficiency()}update(y,M,C){if(y&&y.terrain){this._style!==y&&(this.style=y),this.enabled=!0;const L=y.terrain.properties;this.sourceCache=y.terrain.drapeRenderMode===0?this._mockSourceCache:y._getSourceCache(L.get("source")),this._exaggeration=L.get("exaggeration");const F=()=>{this.sourceCache.used&&x.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const N=this.getScaledDemTileSize();this.sourceCache.update(M,N,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,F(),this._initializing=!0),F(),M.updateElevation(!C),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(M),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(y){this._findCoveringTileCache[y]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const y=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||y.efficiency!==100&&x.warnOnce(`Terrain render cache efficiency is not optimal (${y.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${y.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(y){y.coord&&y.dataType==="source"?this._clearRenderCacheForTile(y.sourceCacheId,y.coord):y.dataType==="style"&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const y in this._style._sourceCaches)this._style._sourceCaches[y].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(y=>y.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture)}_source(){return this.enabled?this.sourceCache:null}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const y=2*this.proxySourceCache.getSource().tileSize;return[y,y]}set useVertexMorphing(y){this._useVertexMorphing=y}updateTileBinding(y){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const M=this.proxySourceCache,C=this.painter.transform;this._initializing&&(this._initializing=C._centerAltitude===0&&this.getAtPointOrZero(x.MercatorCoordinate.fromLngLat(C.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const L=this.proxyCoords=M.getIds().map(W=>{const J=M.getTileByID(W).tileID;return J.projMatrix=C.calculateProjMatrix(J.toUnwrapped()),J});(function(W,J){const ee=J.transform.pointCoordinate(J.transform.getCameraPoint()),ne=new x.pointGeometry(ee.x,ee.y);W.sort((fe,we)=>{if(we.overscaledZ-fe.overscaledZ)return we.overscaledZ-fe.overscaledZ;const ye=new x.pointGeometry(fe.canonical.x+(1<<fe.canonical.z)*fe.wrap,fe.canonical.y),Ee=new x.pointGeometry(we.canonical.x+(1<<we.canonical.z)*we.wrap,we.canonical.y),ze=ne.mult(1<<fe.canonical.z);return ze.x-=.5,ze.y-=.5,ze.distSqr(ye)-ze.distSqr(Ee)})})(L,this.painter),this._previousZoom=C.zoom;const F=this.proxyToSource||{};this.proxyToSource={},L.forEach(W=>{this.proxyToSource[W.key]={}}),this.terrainTileForTile={};const N=this._style._sourceCaches;for(const W in N){const J=N[W];if(!J.used||(J!==this.sourceCache&&this.resetTileLookupCache(J.id),this._setupProxiedCoordsForOrtho(J,y[W],F),J.usedForTerrain))continue;const ee=y[W];J.getSource().reparseOverscaled&&this._assignTerrainTiles(ee)}this.proxiedCoords[M.id]=L.map(W=>new ts(W,W.key,this.orthoMatrix)),this._assignTerrainTiles(L),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(F),this.renderingToTexture=!1,this._updateTimestamp=x.exported.now();const q={};this._visibleDemTiles=[];for(const W of this.proxyCoords){const J=this.terrainTileForTile[W.key];if(!J)continue;const ee=J.tileID.key;ee in q||(this._visibleDemTiles.push(J),q[ee]=ee)}}_assignTerrainTiles(y){this._initializing||y.forEach(M=>{if(this.terrainTileForTile[M.key])return;const C=this._findTileCoveringTileID(M,this.sourceCache);C&&(this.terrainTileForTile[M.key]=C)})}_prepareDEMTextures(){const y=this.painter.context,M=y.gl;for(const C in this.terrainTileForTile){const L=this.terrainTileForTile[C],F=L.dem;!F||L.demTexture&&!L.needsDEMTextureUpload||(y.activeTexture.set(M.TEXTURE1),pr(this.painter,L,F))}}_prepareDemTileUniforms(y,M,C,L){if(!M||M.demTexture==null)return!1;const F=y.tileID.canonical,N=Math.pow(2,M.tileID.canonical.z-F.z),q=L||"";return C[`u_dem_tl${q}`]=[F.x*N%1,F.y*N%1],C[`u_dem_scale${q}`]=N,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const y=this.painter.context,M=y.gl;if(!this._emptyDepthBufferTexture){const C={width:1,height:1,data:new Uint8Array([255,255,255,255])};this._emptyDepthBufferTexture=new x.Texture(y,C,M.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let y=0;const M=this._visibleDemTiles.reduce((C,L)=>{if(!L.dem)return C;const F=L.dem.tree.minimums[0];return F>0&&y++,C+F},0);return y?M/y:0}_updateEmptyDEMTexture(){const y=this.painter.context,M=y.gl;y.activeTexture.set(M.TEXTURE2);const C=this._getLoadedAreaMinimum(),L={width:1,height:1,data:new Uint8Array(x.DEMData.pack(C,this.sourceCache.getSource().encoding))};this._emptyDEMTextureDirty=!1;let F=this._emptyDEMTexture;return F?F.update(L,{premultiply:!1}):F=this._emptyDEMTexture=new x.Texture(y,L,M.RGBA,{premultiply:!1}),F}setupElevationDraw(y,M,C){const L=this.painter.context,F=L.gl,N=(q=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:x.DEMData.getUnpackVector(q),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0,u_tile_tl_up:[0,0,1],u_tile_tr_up:[0,0,1],u_tile_br_up:[0,0,1],u_tile_bl_up:[0,0,1],u_tile_up_scale:1});var q;N.u_dem_size=this.sourceCache.getSource().tileSize,N.u_exaggeration=this.exaggeration();const W=this.painter.transform,J=W.projection.createTileTransform(W,W.worldSize),ee=y.tileID.canonical;N.u_tile_tl_up=J.upVector(ee,0,0),N.u_tile_tr_up=J.upVector(ee,x.EXTENT,0),N.u_tile_br_up=J.upVector(ee,x.EXTENT,x.EXTENT),N.u_tile_bl_up=J.upVector(ee,0,x.EXTENT),N.u_tile_up_scale=J.upVectorScale(ee);let ne=null,fe=null,we=1;if(C&&C.morphing&&this._useVertexMorphing){const ye=C.morphing.srcDemTile,Ee=C.morphing.dstDemTile;we=C.morphing.phase,ye&&Ee&&(this._prepareDemTileUniforms(y,ye,N,"_prev")&&(fe=ye),this._prepareDemTileUniforms(y,Ee,N)&&(ne=Ee))}if(fe&&ne?(L.activeTexture.set(F.TEXTURE2),ne.demTexture.bind(F.NEAREST,F.CLAMP_TO_EDGE,F.NEAREST),L.activeTexture.set(F.TEXTURE4),fe.demTexture.bind(F.NEAREST,F.CLAMP_TO_EDGE,F.NEAREST),N.u_dem_lerp=we):(ne=this.terrainTileForTile[y.tileID.key],L.activeTexture.set(F.TEXTURE2),(this._prepareDemTileUniforms(y,ne,N)?ne.demTexture:this.emptyDEMTexture).bind(F.NEAREST,F.CLAMP_TO_EDGE)),L.activeTexture.set(F.TEXTURE3),C&&C.useDepthForOcclusion?(this._depthTexture.bind(F.NEAREST,F.CLAMP_TO_EDGE),N.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height]):(this.emptyDepthBufferTexture.bind(F.NEAREST,F.CLAMP_TO_EDGE),N.u_depth_size_inv=[1,1]),C&&C.useMeterToDem&&ne){const ye=(1<<ne.tileID.canonical.z)*x.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;N.u_meter_to_dem=ye}C&&C.labelPlaneMatrixInv&&(N.u_label_plane_matrix_inv=C.labelPlaneMatrixInv),M.setTerrainUniformValues(L,N)}renderToBackBuffer(y){const M=this.painter,C=this.painter.context;y.length!==0&&(C.bindFramebuffer.set(null),C.viewport.set([0,0,M.width,M.height]),this.renderingToTexture=!1,function(L,F,N,q,W){if(L.transform.projection.name==="globe")(function(J,ee,ne,fe,we){const ye=J.context,Ee=ye.gl;let ze,be;const Ce=J.options.showTerrainWireframe?2:0,Pe=(ut,tt)=>{if(be===ut)return;const We=[];tt&&We.push(lo[Ce]),We.push(lo[ut]),We.push("PROJECTION_GLOBE_VIEW"),ze=J.useProgram("globeRaster",null,We),be=ut},Ie=J.colorModeForRenderPass(),ke=new x.DepthMode(Ee.LEQUAL,x.DepthMode.ReadWrite,J.depthRangeFor3D);An.update(we);const Fe=J.transform,Ye=x.calculateGlobeMatrix(Fe,Fe.worldSize),Ke=x.calculateGlobeMercatorMatrix(Fe),yt=[x.mercatorXfromLng(Fe.center.lng),x.mercatorYfromLat(Fe.center.lat)],dt=J.globeSharedBuffers;(Ce?[!1,!0]:[!1]).forEach(ut=>{be=-1;const tt=ut?Ee.LINES:Ee.TRIANGLES;for(const We of fe){const ct=ne.getTile(We),ot=Math.pow(2,We.canonical.z),[Xt,ti]=x.globeBuffersForTileMesh(J,ct,We,ot),vi=x.StencilMode.disabled,_t=ee.prevTerrainTileForTile[We.key],Kt=ee.terrainTileForTile[We.key];ln(_t,Kt)&&An.newMorphing(We.key,_t,Kt,we,250),ye.activeTexture.set(Ee.TEXTURE0),ct.texture.bind(Ee.LINEAR,Ee.CLAMP_TO_EDGE);const ci=An.getMorphValuesForProxy(We.key),qi=ci?1:0,Ji={};ci&&x.extend$1(Ji,{morphing:{srcDemTile:ci.from,dstDemTile:ci.to,phase:x.easeCubicInOut(ci.phase)}});const si=x.globeMatrixForTile(We.canonical,Ye),Ti=Us(Fe.projMatrix,si,Ke,x.globeToMercatorTransition(Fe.zoom),yt);if(Pe(qi,ut),ee.setupElevationDraw(ct,ze,Ji),J.prepareDrawProgram(ye,ze,We.toUnwrapped()),dt){const[ir,br]=ut?dt.getWirefameBuffer(J.context):[dt.gridIndexBuffer,dt.gridSegments];ze.draw(ye,tt,ke,vi,Ie,x.CullFaceMode.backCCW,Ti,"globe_raster",Xt,ir,br)}if(!ut){const ir=[We.canonical.y===0?x.globePoleMatrixForTile(We.canonical,!1,Fe):null,We.canonical.y===ot-1?x.globePoleMatrixForTile(We.canonical,!0,Fe):null];for(const br of ir){if(!br)continue;const Yr=Us(Fe.projMatrix,br,br,0,yt);dt&&ze.draw(ye,tt,ke,vi,Ie,x.CullFaceMode.disabled,Yr,"globe_pole_raster",ti,dt.poleIndexBuffer,dt.poleSegments)}}}})})(L,F,N,q,W);else{const J=L.context,ee=J.gl;let ne,fe;const we=L.options.showTerrainWireframe?2:0,ye=(Pe,Ie)=>{if(fe===Pe)return;const ke=[lo[Pe]];Ie&&ke.push(lo[we]),ne=L.useProgram("terrainRaster",null,ke),fe=Pe},Ee=L.colorModeForRenderPass(),ze=new x.DepthMode(ee.LEQUAL,x.DepthMode.ReadWrite,L.depthRangeFor3D);An.update(W);const be=L.transform,Ce=6*Math.pow(1.5,22-be.zoom)*F.exaggeration();(we?[!1,!0]:[!1]).forEach(Pe=>{fe=-1;const Ie=Pe?ee.LINES:ee.TRIANGLES,[ke,Fe]=Pe?F.getWirefameBuffer():[F.gridIndexBuffer,F.gridSegments];for(const Ye of q){const Ke=N.getTile(Ye),yt=x.StencilMode.disabled,dt=F.prevTerrainTileForTile[Ye.key],ut=F.terrainTileForTile[Ye.key];ln(dt,ut)&&An.newMorphing(Ye.key,dt,ut,W,250),J.activeTexture.set(ee.TEXTURE0),Ke.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE,ee.LINEAR_MIPMAP_NEAREST);const tt=An.getMorphValuesForProxy(Ye.key),We=tt?1:0;let ct;tt&&(ct={morphing:{srcDemTile:tt.from,dstDemTile:tt.to,phase:x.easeCubicInOut(tt.phase)}});const ot=Sr(Ye.projMatrix,rc(Ye.canonical,be.renderWorldCopies)?Ce/10:Ce);ye(We,Pe),F.setupElevationDraw(Ke,ne,ct),L.prepareDrawProgram(J,ne,Ye.toUnwrapped()),ne.draw(J,Ie,ze,yt,Ee,x.CullFaceMode.backCCW,ot,"terrain_raster",F.gridBuffer,ke,Fe)}})}}(M,this,this.proxySourceCache,y,this._updateTimestamp),this.renderingToTexture=!0,y.splice(0,y.length))}renderBatch(y){if(this._drapedRenderBatches.length===0)return y+1;this.renderingToTexture=!0;const M=this.painter,C=this.painter.context,L=this.proxySourceCache,F=this.proxiedCoords[L.id],N=this._drapedRenderBatches.shift(),q=[],W=M.style.order;let J=0;for(const ee of F){const ne=L.getTileByID(ee.proxyTileKey),fe=L.proxyCachedFBO[ee.key]?L.proxyCachedFBO[ee.key][y]:void 0,we=fe!==void 0?L.renderCache[fe]:this.pool[J++],ye=fe!==void 0;if(ne.texture=we.tex,ye&&!we.dirty){q.push(ne.tileID);continue}let Ee;C.bindFramebuffer.set(we.fb.framebuffer),this.renderedToTile=!1,we.dirty&&(C.clear({color:x.Color.transparent,stencil:0}),we.dirty=!1);for(let ze=N.start;ze<=N.end;++ze){const be=M.style._layers[W[ze]];if(be.isHidden(M.transform.zoom))continue;const Ce=M.style._getLayerSourceCache(be),Pe=Ce?this.proxyToSource[ee.key][Ce.id]:[ee];if(!Pe)continue;const Ie=Pe;C.viewport.set([0,0,we.fb.width,we.fb.height]),Ee!==(Ce?Ce.id:null)&&(this._setupStencil(we,Pe,be,Ce),Ee=Ce?Ce.id:null),M.renderLayer(M,Ce,be,Ie)}this.renderedToTile?(we.dirty=!0,q.push(ne.tileID)):ye||--J,J===5&&(J=0,this.renderToBackBuffer(q))}return this.renderToBackBuffer(q),this.renderingToTexture=!1,C.bindFramebuffer.set(null),C.viewport.set([0,0,M.width,M.height]),N.end+1}postRender(){}renderCacheEfficiency(y){const M=y.order.length;if(M===0)return{efficiency:100};let C,L=0,F=0,N=!1;for(let q=0;q<M;++q){const W=y._layers[y.order[q]];this._style.isLayerDraped(W)?(N&&++L,++F):N||(N=!0,C=W.id)}return F===0?{efficiency:100}:{efficiency:100*(1-L/F),firstUndrapedLayer:C}}getMinElevationBelowMSL(){let y=0;return this._visibleDemTiles.filter(M=>M.dem).forEach(M=>{y=Math.min(y,M.dem.tree.minimums[0])}),y===0?y:(y-30)*this._exaggeration}raycast(y,M,C){if(!this._visibleDemTiles)return null;const L=this._visibleDemTiles.filter(F=>F.dem).map(F=>{const N=F.tileID,q=Math.pow(2,N.overscaledZ),{x:W,y:J}=N.canonical,ee=W/q,ne=(W+1)/q,fe=J/q,we=(J+1)/q;return{minx:ee,miny:fe,maxx:ne,maxy:we,t:F.dem.tree.raycastRoot(ee,fe,ne,we,y,M,C),tile:F}});L.sort((F,N)=>(F.t!==null?F.t:Number.MAX_VALUE)-(N.t!==null?N.t:Number.MAX_VALUE));for(const F of L){if(F.t==null)return null;const N=F.tile.dem.tree.raycast(F.minx,F.miny,F.maxx,F.maxy,y,M,C);if(N!=null)return N}return null}_createFBO(){const y=this.painter.context,M=y.gl,C=this.drapeBufferSize;y.activeTexture.set(M.TEXTURE0);const L=new x.Texture(y,{width:C[0],height:C[1],data:null},M.RGBA);L.bind(M.LINEAR,M.CLAMP_TO_EDGE);const F=y.createFramebuffer(C[0],C[1],!1);return F.colorAttachment.set(L.texture),F.depthAttachment=new Zi(y,F.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=y.createRenderbuffer(y.gl.DEPTH_STENCIL,C[0],C[1]),this._stencilRef=0,F.depthAttachment.set(this._sharedDepthStencil),y.clear({stencil:0})):F.depthAttachment.set(this._sharedDepthStencil),y.extTextureFilterAnisotropic&&!y.extTextureFilterAnisotropicForceOff&&M.texParameterf(M.TEXTURE_2D,y.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,y.extTextureFilterAnisotropicMax),{fb:F,tex:L,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const y in this._style._sourceCaches)if(this._style._sourceCaches[y].hasTransition())return!0;return this._style.order.some(y=>{const M=this._style._layers[y],C=M.isHidden(this.painter.transform.zoom),L=M.getCrossfadeParameters(),F=!!L&&L.t!==1,N=M.hasTransition();return M.type!=="custom"&&!C&&(F||N)})}_clearRasterFadeFromRenderCache(){let y=!1;for(const M in this._style._sourceCaches)if(this._style._sourceCaches[M]._source instanceof Er){y=!0;break}if(y)for(let M=0;M<this._style.order.length;++M){const C=this._style._layers[this._style.order[M]],L=C.isHidden(this.painter.transform.zoom),F=this._style._getLayerSourceCache(C);if(C.type!=="raster"||L||!F)continue;const N=C.paint.get("raster-fade-duration");for(const q of this.proxyCoords){const W=this.proxyToSource[q.key][F.id];if(W)for(const J of W){const ee=Ol(F.getTile(J),F.findLoadedParent(J,0),F,this.painter.transform,N);(ee.opacity!==1||ee.mix!==0)&&this._clearRenderCacheForTile(F.id,J)}}}}_setupDrapedRenderBatches(){const y=this._style.order,M=y.length;if(M===0)return;const C=[];let L,F=0,N=this._style._layers[y[F]];for(;!this._style.isLayerDraped(N)&&N.isHidden(this.painter.transform.zoom)&&++F<M;)N=this._style._layers[y[F]];for(;F<M;++F){const q=this._style._layers[y[F]];q.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(q)?L===void 0&&(L=F):L!==void 0&&(C.push({start:L,end:F-1}),L=void 0))}L!==void 0&&C.push({start:L,end:F-1}),this._drapedRenderBatches=C}_setupRenderCache(y){const M=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,M.renderCache.length>M.renderCachePool.length){const N=Object.values(M.proxyCachedFBO);M.proxyCachedFBO={};for(let q=0;q<N.length;++q){const W=Object.values(N[q]);M.renderCachePool.push(...W)}}return}this._clearRasterFadeFromRenderCache();const C=this.proxyCoords,L=this._tilesDirty;for(let N=C.length-1;N>=0;N--){const q=C[N];if(M.getTileByID(q.key),M.proxyCachedFBO[q.key]!==void 0){const W=y[q.key],J=this.proxyToSource[q.key];let ee=0;for(const ne in J){const fe=J[ne],we=W[ne];if(!we||we.length!==fe.length||fe.some((ye,Ee)=>ye!==we[Ee]||L[ne]&&L[ne].hasOwnProperty(ye.key))){ee=-1;break}++ee}for(const ne in M.proxyCachedFBO[q.key])M.renderCache[M.proxyCachedFBO[q.key][ne]].dirty=ee<0||ee!==Object.values(W).length}}const F=[...this._drapedRenderBatches];F.sort((N,q)=>q.end-q.start-(N.end-N.start));for(const N of F)for(const q of C){if(M.proxyCachedFBO[q.key])continue;let W=M.renderCachePool.pop();W===void 0&&M.renderCache.length<50&&(W=M.renderCache.length,M.renderCache.push(this._createFBO())),W!==void 0&&(M.proxyCachedFBO[q.key]={},M.proxyCachedFBO[q.key][N.start]=W,M.renderCache[W].dirty=!0)}this._tilesDirty={}}_setupStencil(y,M,C,L){if(!L||!this._sourceTilesOverlap[L.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const F=this.painter.context,N=F.gl;if(M.length<=1)return void(this._overlapStencilType=!1);let q;if(C.isTileClipped())q=M.length,this._overlapStencilMode.test={func:N.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(M[0].overscaledZ>M[M.length-1].overscaledZ))return void(this._overlapStencilType=!1);q=1,this._overlapStencilMode.test={func:N.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+q>255&&(F.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=q,this._overlapStencilMode.ref=this._stencilRef,C.isTileClipped()&&this._renderTileClippingMasks(M,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(y){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[y.key]),this._overlapStencilMode):x.StencilMode.disabled}_renderTileClippingMasks(y,M){const C=this.painter,L=this.painter.context,F=L.gl;C._tileClippingMaskIDs={},L.setColorMode(x.ColorMode.disabled),L.setDepthMode(x.DepthMode.disabled);const N=C.useProgram("clippingMask");for(const q of y){const W=C._tileClippingMaskIDs[q.key]=--M;N.draw(L,F.TRIANGLES,x.DepthMode.disabled,new x.StencilMode({func:F.ALWAYS,mask:0},W,255,F.KEEP,F.KEEP,F.REPLACE),x.ColorMode.disabled,x.CullFaceMode.disabled,In(q.projMatrix),"$clipping",C.tileExtentBuffer,C.quadTriangleIndexBuffer,C.tileExtentSegments)}}pointCoordinate(y){const M=this.painter.transform;if(y.x<0||y.x>M.width||y.y<0||y.y>M.height)return null;const C=[y.x,y.y,1,1];x.transformMat4$1(C,C,M.pixelMatrixInverse),x.scale$1(C,C,1/C[3]),C[0]/=M.worldSize,C[1]/=M.worldSize;const L=M._camera.position,F=x.mercatorZfromAltitude(1,M.center.lat),N=[L[0],L[1],L[2]/F,0],q=x.subtract([],C.slice(0,3),N);x.normalize(q,q);const W=this.raycast(N,q,this._exaggeration);return W!==null&&W?(x.scaleAndAdd(N,N,q,W),N[3]=N[2],N[2]*=F,N):null}drawDepth(){const y=this.painter,M=y.context,C=this.proxySourceCache,L=Math.ceil(y.width),F=Math.ceil(y.height);if(!this._depthFBO||this._depthFBO.width===L&&this._depthFBO.height===F||(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture),!this._depthFBO){const N=M.gl,q=M.createFramebuffer(L,F,!0);M.activeTexture.set(N.TEXTURE0);const W=new x.Texture(M,{width:L,height:F,data:null},N.RGBA);W.bind(N.NEAREST,N.CLAMP_TO_EDGE),q.colorAttachment.set(W.texture);const J=M.createRenderbuffer(M.gl.DEPTH_COMPONENT16,L,F);q.depthAttachment.set(J),this._depthFBO=q,this._depthTexture=W}M.bindFramebuffer.set(this._depthFBO.framebuffer),M.viewport.set([0,0,L,F]),function(N,q,W,J){if(N.transform.projection.name==="globe")return;const ee=N.context,ne=ee.gl;ee.clear({depth:1});const fe=N.useProgram("terrainDepth"),we=new x.DepthMode(ne.LESS,x.DepthMode.ReadWrite,N.depthRangeFor3D);for(const ye of J){const Ee=W.getTile(ye),ze=Sr(ye.projMatrix,0);q.setupElevationDraw(Ee,fe),fe.draw(ee,ne.TRIANGLES,we,x.StencilMode.disabled,x.ColorMode.unblended,x.CullFaceMode.backCCW,ze,"terrain_depth",q.gridBuffer,q.gridIndexBuffer,q.gridNoSkirtSegments)}}(y,this,C,this.proxyCoords)}_setupProxiedCoordsForOrtho(y,M,C){if(y.getSource()instanceof Mr)return this._setupProxiedCoordsForImageSource(y,M,C);this._findCoveringTileCache[y.id]=this._findCoveringTileCache[y.id]||{};const L=this.proxiedCoords[y.id]=[],F=this.proxyCoords;for(let q=0;q<F.length;q++){const W=F[q],J=this._findTileCoveringTileID(W,y);if(J){const ee=this._createProxiedId(W,J,C[W.key]&&C[W.key][y.id]);L.push(ee),this.proxyToSource[W.key][y.id]=[ee]}}let N=!1;for(let q=0;q<M.length;q++){const W=y.getTile(M[q]);if(!W||!W.hasData())continue;const J=this._findTileCoveringTileID(W.tileID,this.proxySourceCache);if(J&&J.tileID.canonical.z!==W.tileID.canonical.z){const ee=this.proxyToSource[J.tileID.key][y.id],ne=this._createProxiedId(J.tileID,W,C[J.tileID.key]&&C[J.tileID.key][y.id]);ee?ee.splice(ee.length-1,0,ne):this.proxyToSource[J.tileID.key][y.id]=[ne],L.push(ne),N=!0}}this._sourceTilesOverlap[y.id]=N}_setupProxiedCoordsForImageSource(y,M,C){if(!y.getSource().loaded())return;const L=this.proxiedCoords[y.id]=[],F=this.proxyCoords,N=y.getSource(),q=new x.pointGeometry(N.tileID.x,N.tileID.y)._div(1<<N.tileID.z),W=N.coordinates.map(x.MercatorCoordinate.fromLngLat).reduce((ee,ne)=>(ee.min.x=Math.min(ee.min.x,ne.x-q.x),ee.min.y=Math.min(ee.min.y,ne.y-q.y),ee.max.x=Math.max(ee.max.x,ne.x-q.x),ee.max.y=Math.max(ee.max.y,ne.y-q.y),ee),{min:new x.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new x.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),J=(ee,ne)=>{const fe=ee.wrap+ee.canonical.x/(1<<ee.canonical.z),we=ee.canonical.y/(1<<ee.canonical.z),ye=x.EXTENT/(1<<ee.canonical.z),Ee=ne.wrap+ne.canonical.x/(1<<ne.canonical.z),ze=ne.canonical.y/(1<<ne.canonical.z);return fe+ye<Ee+W.min.x||fe>Ee+W.max.x||we+ye<ze+W.min.y||we>ze+W.max.y};for(let ee=0;ee<F.length;ee++){const ne=F[ee];for(let fe=0;fe<M.length;fe++){const we=y.getTile(M[fe]);if(!we||!we.hasData()||J(ne,we.tileID))continue;const ye=this._createProxiedId(ne,we,C[ne.key]&&C[ne.key][y.id]),Ee=this.proxyToSource[ne.key][y.id];Ee?Ee.push(ye):this.proxyToSource[ne.key][y.id]=[ye],L.push(ye)}}}_createProxiedId(y,M,C){let L=this.orthoMatrix;if(C){const F=C.find(N=>N.key===M.tileID.key);if(F)return F}if(M.tileID.key!==y.key){const F=y.canonical.z-M.tileID.canonical.z;let N,q,W;L=x.create();const J=M.tileID.wrap-y.wrap<<y.overscaledZ;F>0?(N=x.EXTENT>>F,q=N*((M.tileID.canonical.x<<F)-y.canonical.x+J),W=N*((M.tileID.canonical.y<<F)-y.canonical.y)):(N=x.EXTENT<<-F,q=x.EXTENT*(M.tileID.canonical.x-(y.canonical.x+J<<-F)),W=x.EXTENT*(M.tileID.canonical.y-(y.canonical.y<<-F))),x.ortho(L,0,N,0,N,0,1),x.translate(L,L,[q,W,0])}return new ts(M.tileID,y.key,L)}_findTileCoveringTileID(y,M){let C=M.getTile(y);if(C&&C.hasData())return C;const L=this._findCoveringTileCache[M.id],F=L[y.key];if(C=F?M.getTileByID(F):null,C&&C.hasData()||F===null)return C;let N=C?C.tileID:y,q=N.overscaledZ;const W=M.getSource().minzoom,J=[];if(!F){const ne=M.getSource().maxzoom;if(y.canonical.z>=ne){const fe=y.canonical.z-ne;M.getSource().reparseOverscaled?(q=Math.max(y.canonical.z+2,M.transform.tileZoom),N=new x.OverscaledTileID(q,y.wrap,ne,y.canonical.x>>fe,y.canonical.y>>fe)):fe!==0&&(q=ne,N=new x.OverscaledTileID(q,y.wrap,ne,y.canonical.x>>fe,y.canonical.y>>fe))}N.key!==y.key&&(J.push(N.key),C=M.getTile(N))}const ee=ne=>{J.forEach(fe=>{L[fe]=ne}),J.length=0};for(q-=1;q>=W&&(!C||!C.hasData());q--){C&&ee(C.tileID.key);const ne=N.calculateScaledKey(q);if(C=M.getTileByID(ne),C&&C.hasData())break;const fe=L[ne];if(fe===null)break;fe===void 0?J.push(ne):C=M.getTileByID(fe)}return ee(C?C.tileID.key:null),C&&C.hasData()?C:null}findDEMTileFor(y){return this.enabled?this._findTileCoveringTileID(y,this.sourceCache):null}prepareDrawTile(y){this.renderedToTile=!0}_clearRenderCacheForTile(y,M){let C=this._tilesDirty[y];C||(C=this._tilesDirty[y]={}),C[M.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const y=function(M){let C,L,F;const N=new x.StructArrayLayout2ui4,q=131;for(L=1;L<129;L++){for(C=1;C<129;C++)F=L*q+C,N.emplaceBack(F,F+1),N.emplaceBack(F,F+q),N.emplaceBack(F+1,F+q),L===128&&N.emplaceBack(F+q,F+q+1);N.emplaceBack(F+1,F+1+q)}return N}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(y),this.wireframeSegments=x.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,y.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}function Ns(I){const y=[];for(let M=0;M<I.length;M++){if(I[M]===null)continue;const C=I[M].split(" ");y.push(C.pop())}return y}class is{static cacheKey(y,M,C){let L=`${y}${C?C.cacheKey:""}`;for(const F of M)L+=`/${F}`;return L}constructor(y,M,C,L,F,N){const q=y.gl;this.program=q.createProgram();const W=Ns(C.staticAttributes),J=L?L.getBinderAttributes():[],ee=W.concat(J),ne=C.staticUniforms?Ns(C.staticUniforms):[],fe=L?L.getBinderUniforms():[],we=ne.concat(fe),ye=[];for(const ke of we)ye.indexOf(ke)<0&&ye.push(ke);let Ee=L?L.defines():[];Ee=Ee.concat(N.map(ke=>`#define ${ke}`));const ze=Ee.concat(`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,Os,Fi.fragmentSource,So.fragmentSource,C.fragmentSource).join(`
`),be=Ee.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,Os,Fi.vertexSource,So.vertexSource,Mo.vertexSource,C.vertexSource).join(`
`),Ce=q.createShader(q.FRAGMENT_SHADER);if(q.isContextLost())return void(this.failedToCreate=!0);q.shaderSource(Ce,ze),q.compileShader(Ce),q.attachShader(this.program,Ce);const Pe=q.createShader(q.VERTEX_SHADER);if(q.isContextLost())return void(this.failedToCreate=!0);q.shaderSource(Pe,be),q.compileShader(Pe),q.attachShader(this.program,Pe),this.attributes={};const Ie={};this.numAttributes=ee.length;for(let ke=0;ke<this.numAttributes;ke++)ee[ke]&&(q.bindAttribLocation(this.program,ke,ee[ke]),this.attributes[ee[ke]]=ke);q.linkProgram(this.program),q.deleteShader(Pe),q.deleteShader(Ce);for(let ke=0;ke<ye.length;ke++){const Fe=ye[ke];if(Fe&&!Ie[Fe]){const Ye=q.getUniformLocation(this.program,Fe);Ye&&(Ie[Fe]=Ye)}}this.fixedUniforms=F(y,Ie),this.binderUniforms=L?L.getUniforms(y,Ie):[],N.indexOf("TERRAIN")!==-1&&(this.terrainUniforms=((ke,Fe)=>({u_dem:new x.Uniform1i(ke,Fe.u_dem),u_dem_prev:new x.Uniform1i(ke,Fe.u_dem_prev),u_dem_unpack:new x.Uniform4f(ke,Fe.u_dem_unpack),u_dem_tl:new x.Uniform2f(ke,Fe.u_dem_tl),u_dem_scale:new x.Uniform1f(ke,Fe.u_dem_scale),u_dem_tl_prev:new x.Uniform2f(ke,Fe.u_dem_tl_prev),u_dem_scale_prev:new x.Uniform1f(ke,Fe.u_dem_scale_prev),u_dem_size:new x.Uniform1f(ke,Fe.u_dem_size),u_dem_lerp:new x.Uniform1f(ke,Fe.u_dem_lerp),u_exaggeration:new x.Uniform1f(ke,Fe.u_exaggeration),u_depth:new x.Uniform1i(ke,Fe.u_depth),u_depth_size_inv:new x.Uniform2f(ke,Fe.u_depth_size_inv),u_meter_to_dem:new x.Uniform1f(ke,Fe.u_meter_to_dem),u_label_plane_matrix_inv:new x.UniformMatrix4f(ke,Fe.u_label_plane_matrix_inv),u_tile_tl_up:new x.Uniform3f(ke,Fe.u_tile_tl_up),u_tile_tr_up:new x.Uniform3f(ke,Fe.u_tile_tr_up),u_tile_br_up:new x.Uniform3f(ke,Fe.u_tile_br_up),u_tile_bl_up:new x.Uniform3f(ke,Fe.u_tile_bl_up),u_tile_up_scale:new x.Uniform1f(ke,Fe.u_tile_up_scale)}))(y,Ie)),N.indexOf("FOG")!==-1&&(this.fogUniforms=((ke,Fe)=>({u_fog_matrix:new x.UniformMatrix4f(ke,Fe.u_fog_matrix),u_fog_range:new x.Uniform2f(ke,Fe.u_fog_range),u_fog_color:new x.Uniform4f(ke,Fe.u_fog_color),u_fog_horizon_blend:new x.Uniform1f(ke,Fe.u_fog_horizon_blend),u_fog_temporal_offset:new x.Uniform1f(ke,Fe.u_fog_temporal_offset)}))(y,Ie))}setTerrainUniformValues(y,M){if(!this.terrainUniforms)return;const C=this.terrainUniforms;if(!this.failedToCreate){y.program.set(this.program);for(const L in M)C[L].set(M[L])}}setFogUniformValues(y,M){if(!this.fogUniforms)return;const C=this.fogUniforms;if(!this.failedToCreate){y.program.set(this.program);for(const L in M)C[L].location&&C[L].set(M[L])}}draw(y,M,C,L,F,N,q,W,J,ee,ne,fe,we,ye,Ee,ze){const be=y.gl;if(this.failedToCreate)return;y.program.set(this.program),y.setDepthMode(C),y.setStencilMode(L),y.setColorMode(F),y.setCullFace(N);for(const Pe of Object.keys(this.fixedUniforms))this.fixedUniforms[Pe].set(q[Pe]);ye&&ye.setUniforms(y,this.binderUniforms,fe,{zoom:we});const Ce={[be.LINES]:2,[be.TRIANGLES]:3,[be.LINE_STRIP]:1}[M];for(const Pe of ne.get()){const Ie=Pe.vaos||(Pe.vaos={});(Ie[W]||(Ie[W]=new an)).bind(y,this,J,ye?ye.getPaintVertexBuffers():[],ee,Pe.vertexOffset,Ee,ze),be.drawElements(M,Pe.primitiveLength*Ce,be.UNSIGNED_SHORT,Pe.primitiveOffset*Ce*2)}}}function Ul(I,y,M){const C=1/Bt(M,1,y.transform.tileZoom),L=Math.pow(2,M.tileID.overscaledZ),F=M.tileSize*Math.pow(2,y.transform.tileZoom)/L,N=F*(M.tileID.canonical.x+M.tileID.wrap*L),q=F*M.tileID.canonical.y;return{u_image:0,u_texsize:M.imageAtlasTexture.size,u_scale:[C,I.fromScale,I.toScale],u_fade:I.t,u_pixel_coord_upper:[N>>16,q>>16],u_pixel_coord_lower:[65535&N,65535&q]}}const Nl=(I,y,M,C)=>{const L=y.style.light,F=L.properties.get("position"),N=[F.x,F.y,F.z],q=x.create$1();L.properties.get("anchor")==="viewport"&&(x.fromRotation(q,-y.transform.angle),x.transformMat3(N,N,q));const W=L.properties.get("color");return{u_matrix:I,u_lightpos:N,u_lightintensity:L.properties.get("intensity"),u_lightcolor:[W.r,W.g,W.b],u_vertical_gradient:+M,u_opacity:C}},Fa=(I,y,M,C,L,F,N)=>x.extend(Nl(I,y,M,C),Ul(F,y,N),{u_height_factor:-Math.pow(2,L.overscaledZ)/N.tileSize/8}),Vl=I=>({u_matrix:I}),Oa=(I,y,M,C)=>x.extend(Vl(I),Ul(M,y,C)),nc=(I,y)=>({u_matrix:I,u_world:y}),jl=(I,y,M,C,L)=>x.extend(Oa(I,y,M,C),{u_world:L}),oc=(I,y,M,C)=>{const L=I.transform;let F;return F=C.paint.get("circle-pitch-alignment")==="map"?L.calculatePixelsToTileUnitsMatrix(M):new Float32Array([L.pixelsToGLUnits[0],0,0,L.pixelsToGLUnits[1]]),{u_camera_to_center_distance:L.cameraToCenterDistance,u_matrix:I.translatePosMatrix(y.projMatrix,M,C.paint.get("circle-translate"),C.paint.get("circle-translate-anchor")),u_device_pixel_ratio:x.exported.devicePixelRatio,u_extrude_scale:F}},$a=I=>{const y=[];return I.paint.get("circle-pitch-alignment")==="map"&&y.push("PITCH_WITH_MAP"),I.paint.get("circle-pitch-scale")==="map"&&y.push("SCALE_WITH_MAP"),y},Gl=(I,y,M)=>{const C=x.EXTENT/M.tileSize;return{u_matrix:I,u_camera_to_center_distance:y.cameraToCenterDistance,u_extrude_scale:[y.pixelsToGLUnits[0]/C,y.pixelsToGLUnits[1]/C]}},Ua=(I,y,M=1)=>({u_matrix:I,u_color:y,u_overlay:0,u_overlay_scale:M}),ql=(I,y,M,C)=>({u_matrix:I,u_extrude_scale:Bt(y,1,M),u_intensity:C}),Zl=(I,y,M,C,L,F)=>{const N=I.transform,q=N.calculatePixelsToTileUnitsMatrix(y),W={u_matrix:rs(I,y,M,L),u_pixels_to_tile_units:q,u_device_pixel_ratio:x.exported.devicePixelRatio,u_units_to_pixels:[1/N.pixelsToGLUnits[0],1/N.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:F,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0,u_alpha_discard_threshold:0};if(ns(M)){const J=Ao(y,I.transform);W.u_texsize=y.lineAtlasTexture.size,W.u_scale=[J,C.fromScale,C.toScale],W.u_mix=C.t}return W},ho=(I,y,M,C,L)=>{const F=I.transform,N=Ao(y,F);return{u_matrix:rs(I,y,M,L),u_texsize:y.imageAtlasTexture.size,u_pixels_to_tile_units:F.calculatePixelsToTileUnitsMatrix(y),u_device_pixel_ratio:x.exported.devicePixelRatio,u_image:0,u_scale:[N,C.fromScale,C.toScale],u_fade:C.t,u_units_to_pixels:[1/F.pixelsToGLUnits[0],1/F.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Ao(I,y){return 1/Bt(I,1,y.tileZoom)}function rs(I,y,M,C){return I.translatePosMatrix(C||y.tileID.projMatrix,y,M.paint.get("line-translate"),M.paint.get("line-translate-anchor"))}function ns(I){const y=I.paint.get("line-dasharray").value;return y.value||y.kind!=="constant"}const Vs=(I,y,M,C,L,F)=>{return{u_matrix:I,u_tl_parent:y,u_scale_parent:M,u_fade_t:C.mix,u_opacity:C.opacity*L.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:L.paint.get("raster-brightness-min"),u_brightness_high:L.paint.get("raster-brightness-max"),u_saturation_factor:(q=L.paint.get("raster-saturation"),q>0?1-1/(1.001-q):-q),u_contrast_factor:(N=L.paint.get("raster-contrast"),N>0?1/(1-N):1+N),u_spin_weights:js(L.paint.get("raster-hue-rotate")),u_perspective_transform:F};var N,q};function js(I){I*=Math.PI/180;const y=Math.sin(I),M=Math.cos(I);return[(2*M+1)/3,(-Math.sqrt(3)*y-M+1)/3,(Math.sqrt(3)*y-M+1)/3]}const Gs=(I,y,M,C,L,F,N,q,W,J,ee,ne,fe,we)=>{const ye=L.transform;return{u_is_size_zoom_constant:+(I==="constant"||I==="source"),u_is_size_feature_constant:+(I==="constant"||I==="camera"),u_size_t:y?y.uSizeT:0,u_size:y?y.uSize:0,u_camera_to_center_distance:ye.cameraToCenterDistance,u_pitch:ye.pitch/360*2*Math.PI,u_rotate_symbol:+M,u_aspect_ratio:ye.width/ye.height,u_fade_change:L.options.fadeDuration?L.symbolFadeChange:1,u_matrix:F,u_label_plane_matrix:N,u_coord_matrix:q,u_is_text:+W,u_pitch_with_map:+C,u_texsize:J,u_tile_id:ee,u_zoom_transition:ne,u_inv_rot_matrix:fe,u_merc_center:we,u_texture:0}},os=(I,y,M,C,L,F,N,q,W,J,ee,ne,fe,we,ye)=>{const{cameraToCenterDistance:Ee,_pitch:ze}=L.transform;return x.extend(Gs(I,y,M,C,L,F,N,q,W,J,ne,fe,we,ye),{u_gamma_scale:C?Ee*Math.cos(L.terrain?0:ze):1,u_device_pixel_ratio:x.exported.devicePixelRatio,u_is_halo:+ee})},ss=(I,y,M,C,L,F,N,q,W,J,ee,ne,fe,we)=>x.extend(os(I,y,M,C,L,F,N,q,!0,W,!0,ee,ne,fe,we),{u_texsize_icon:J,u_texture_icon:1}),ji=(I,y,M)=>({u_matrix:I,u_opacity:y,u_color:M}),qs=(I,y,M,C,L,F)=>x.extend(function(N,q,W,J){const ee=W.imageManager.getPattern(N.from.toString()),ne=W.imageManager.getPattern(N.to.toString()),{width:fe,height:we}=W.imageManager.getPixelSize(),ye=Math.pow(2,J.tileID.overscaledZ),Ee=J.tileSize*Math.pow(2,W.transform.tileZoom)/ye,ze=Ee*(J.tileID.canonical.x+J.tileID.wrap*ye),be=Ee*J.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:ee.tl,u_pattern_br_a:ee.br,u_pattern_tl_b:ne.tl,u_pattern_br_b:ne.br,u_texsize:[fe,we],u_mix:q.t,u_pattern_size_a:ee.displaySize,u_pattern_size_b:ne.displaySize,u_scale_a:q.fromScale,u_scale_b:q.toScale,u_tile_units_to_pixels:1/Bt(J,1,W.transform.tileZoom),u_pixel_coord_upper:[ze>>16,be>>16],u_pixel_coord_lower:[65535&ze,65535&be]}}(C,F,M,L),{u_matrix:I,u_opacity:y}),Xl={fillExtrusion:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_lightpos:new x.Uniform3f(I,y.u_lightpos),u_lightintensity:new x.Uniform1f(I,y.u_lightintensity),u_lightcolor:new x.Uniform3f(I,y.u_lightcolor),u_vertical_gradient:new x.Uniform1f(I,y.u_vertical_gradient),u_opacity:new x.Uniform1f(I,y.u_opacity)}),fillExtrusionPattern:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_lightpos:new x.Uniform3f(I,y.u_lightpos),u_lightintensity:new x.Uniform1f(I,y.u_lightintensity),u_lightcolor:new x.Uniform3f(I,y.u_lightcolor),u_vertical_gradient:new x.Uniform1f(I,y.u_vertical_gradient),u_height_factor:new x.Uniform1f(I,y.u_height_factor),u_image:new x.Uniform1i(I,y.u_image),u_texsize:new x.Uniform2f(I,y.u_texsize),u_pixel_coord_upper:new x.Uniform2f(I,y.u_pixel_coord_upper),u_pixel_coord_lower:new x.Uniform2f(I,y.u_pixel_coord_lower),u_scale:new x.Uniform3f(I,y.u_scale),u_fade:new x.Uniform1f(I,y.u_fade),u_opacity:new x.Uniform1f(I,y.u_opacity)}),fill:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix)}),fillPattern:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_image:new x.Uniform1i(I,y.u_image),u_texsize:new x.Uniform2f(I,y.u_texsize),u_pixel_coord_upper:new x.Uniform2f(I,y.u_pixel_coord_upper),u_pixel_coord_lower:new x.Uniform2f(I,y.u_pixel_coord_lower),u_scale:new x.Uniform3f(I,y.u_scale),u_fade:new x.Uniform1f(I,y.u_fade)}),fillOutline:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_world:new x.Uniform2f(I,y.u_world)}),fillOutlinePattern:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_world:new x.Uniform2f(I,y.u_world),u_image:new x.Uniform1i(I,y.u_image),u_texsize:new x.Uniform2f(I,y.u_texsize),u_pixel_coord_upper:new x.Uniform2f(I,y.u_pixel_coord_upper),u_pixel_coord_lower:new x.Uniform2f(I,y.u_pixel_coord_lower),u_scale:new x.Uniform3f(I,y.u_scale),u_fade:new x.Uniform1f(I,y.u_fade)}),circle:(I,y)=>({u_camera_to_center_distance:new x.Uniform1f(I,y.u_camera_to_center_distance),u_extrude_scale:new x.UniformMatrix2f(I,y.u_extrude_scale),u_device_pixel_ratio:new x.Uniform1f(I,y.u_device_pixel_ratio),u_matrix:new x.UniformMatrix4f(I,y.u_matrix)}),collisionBox:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_camera_to_center_distance:new x.Uniform1f(I,y.u_camera_to_center_distance),u_extrude_scale:new x.Uniform2f(I,y.u_extrude_scale)}),collisionCircle:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_inv_matrix:new x.UniformMatrix4f(I,y.u_inv_matrix),u_camera_to_center_distance:new x.Uniform1f(I,y.u_camera_to_center_distance),u_viewport_size:new x.Uniform2f(I,y.u_viewport_size)}),debug:(I,y)=>({u_color:new x.UniformColor(I,y.u_color),u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_overlay:new x.Uniform1i(I,y.u_overlay),u_overlay_scale:new x.Uniform1f(I,y.u_overlay_scale)}),clippingMask:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix)}),heatmap:(I,y)=>({u_extrude_scale:new x.Uniform1f(I,y.u_extrude_scale),u_intensity:new x.Uniform1f(I,y.u_intensity),u_matrix:new x.UniformMatrix4f(I,y.u_matrix)}),heatmapTexture:(I,y)=>({u_image:new x.Uniform1i(I,y.u_image),u_color_ramp:new x.Uniform1i(I,y.u_color_ramp),u_opacity:new x.Uniform1f(I,y.u_opacity)}),hillshade:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_image:new x.Uniform1i(I,y.u_image),u_latrange:new x.Uniform2f(I,y.u_latrange),u_light:new x.Uniform2f(I,y.u_light),u_shadow:new x.UniformColor(I,y.u_shadow),u_highlight:new x.UniformColor(I,y.u_highlight),u_accent:new x.UniformColor(I,y.u_accent)}),hillshadePrepare:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_image:new x.Uniform1i(I,y.u_image),u_dimension:new x.Uniform2f(I,y.u_dimension),u_zoom:new x.Uniform1f(I,y.u_zoom),u_unpack:new x.Uniform4f(I,y.u_unpack)}),line:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_pixels_to_tile_units:new x.UniformMatrix2f(I,y.u_pixels_to_tile_units),u_device_pixel_ratio:new x.Uniform1f(I,y.u_device_pixel_ratio),u_units_to_pixels:new x.Uniform2f(I,y.u_units_to_pixels),u_dash_image:new x.Uniform1i(I,y.u_dash_image),u_gradient_image:new x.Uniform1i(I,y.u_gradient_image),u_image_height:new x.Uniform1f(I,y.u_image_height),u_texsize:new x.Uniform2f(I,y.u_texsize),u_scale:new x.Uniform3f(I,y.u_scale),u_mix:new x.Uniform1f(I,y.u_mix),u_alpha_discard_threshold:new x.Uniform1f(I,y.u_alpha_discard_threshold)}),linePattern:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_texsize:new x.Uniform2f(I,y.u_texsize),u_pixels_to_tile_units:new x.UniformMatrix2f(I,y.u_pixels_to_tile_units),u_device_pixel_ratio:new x.Uniform1f(I,y.u_device_pixel_ratio),u_image:new x.Uniform1i(I,y.u_image),u_units_to_pixels:new x.Uniform2f(I,y.u_units_to_pixels),u_scale:new x.Uniform3f(I,y.u_scale),u_fade:new x.Uniform1f(I,y.u_fade),u_alpha_discard_threshold:new x.Uniform1f(I,y.u_alpha_discard_threshold)}),raster:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_tl_parent:new x.Uniform2f(I,y.u_tl_parent),u_scale_parent:new x.Uniform1f(I,y.u_scale_parent),u_fade_t:new x.Uniform1f(I,y.u_fade_t),u_opacity:new x.Uniform1f(I,y.u_opacity),u_image0:new x.Uniform1i(I,y.u_image0),u_image1:new x.Uniform1i(I,y.u_image1),u_brightness_low:new x.Uniform1f(I,y.u_brightness_low),u_brightness_high:new x.Uniform1f(I,y.u_brightness_high),u_saturation_factor:new x.Uniform1f(I,y.u_saturation_factor),u_contrast_factor:new x.Uniform1f(I,y.u_contrast_factor),u_spin_weights:new x.Uniform3f(I,y.u_spin_weights),u_perspective_transform:new x.Uniform2f(I,y.u_perspective_transform)}),symbolIcon:(I,y)=>({u_is_size_zoom_constant:new x.Uniform1i(I,y.u_is_size_zoom_constant),u_is_size_feature_constant:new x.Uniform1i(I,y.u_is_size_feature_constant),u_size_t:new x.Uniform1f(I,y.u_size_t),u_size:new x.Uniform1f(I,y.u_size),u_camera_to_center_distance:new x.Uniform1f(I,y.u_camera_to_center_distance),u_pitch:new x.Uniform1f(I,y.u_pitch),u_rotate_symbol:new x.Uniform1i(I,y.u_rotate_symbol),u_aspect_ratio:new x.Uniform1f(I,y.u_aspect_ratio),u_fade_change:new x.Uniform1f(I,y.u_fade_change),u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_label_plane_matrix:new x.UniformMatrix4f(I,y.u_label_plane_matrix),u_coord_matrix:new x.UniformMatrix4f(I,y.u_coord_matrix),u_is_text:new x.Uniform1i(I,y.u_is_text),u_pitch_with_map:new x.Uniform1i(I,y.u_pitch_with_map),u_texsize:new x.Uniform2f(I,y.u_texsize),u_tile_id:new x.Uniform3f(I,y.u_tile_id),u_zoom_transition:new x.Uniform1f(I,y.u_zoom_transition),u_inv_rot_matrix:new x.UniformMatrix4f(I,y.u_inv_rot_matrix),u_merc_center:new x.Uniform2f(I,y.u_merc_center),u_texture:new x.Uniform1i(I,y.u_texture)}),symbolSDF:(I,y)=>({u_is_size_zoom_constant:new x.Uniform1i(I,y.u_is_size_zoom_constant),u_is_size_feature_constant:new x.Uniform1i(I,y.u_is_size_feature_constant),u_size_t:new x.Uniform1f(I,y.u_size_t),u_size:new x.Uniform1f(I,y.u_size),u_camera_to_center_distance:new x.Uniform1f(I,y.u_camera_to_center_distance),u_pitch:new x.Uniform1f(I,y.u_pitch),u_rotate_symbol:new x.Uniform1i(I,y.u_rotate_symbol),u_aspect_ratio:new x.Uniform1f(I,y.u_aspect_ratio),u_fade_change:new x.Uniform1f(I,y.u_fade_change),u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_label_plane_matrix:new x.UniformMatrix4f(I,y.u_label_plane_matrix),u_coord_matrix:new x.UniformMatrix4f(I,y.u_coord_matrix),u_is_text:new x.Uniform1i(I,y.u_is_text),u_pitch_with_map:new x.Uniform1i(I,y.u_pitch_with_map),u_texsize:new x.Uniform2f(I,y.u_texsize),u_texture:new x.Uniform1i(I,y.u_texture),u_gamma_scale:new x.Uniform1f(I,y.u_gamma_scale),u_device_pixel_ratio:new x.Uniform1f(I,y.u_device_pixel_ratio),u_tile_id:new x.Uniform3f(I,y.u_tile_id),u_zoom_transition:new x.Uniform1f(I,y.u_zoom_transition),u_inv_rot_matrix:new x.UniformMatrix4f(I,y.u_inv_rot_matrix),u_merc_center:new x.Uniform2f(I,y.u_merc_center),u_is_halo:new x.Uniform1i(I,y.u_is_halo)}),symbolTextAndIcon:(I,y)=>({u_is_size_zoom_constant:new x.Uniform1i(I,y.u_is_size_zoom_constant),u_is_size_feature_constant:new x.Uniform1i(I,y.u_is_size_feature_constant),u_size_t:new x.Uniform1f(I,y.u_size_t),u_size:new x.Uniform1f(I,y.u_size),u_camera_to_center_distance:new x.Uniform1f(I,y.u_camera_to_center_distance),u_pitch:new x.Uniform1f(I,y.u_pitch),u_rotate_symbol:new x.Uniform1i(I,y.u_rotate_symbol),u_aspect_ratio:new x.Uniform1f(I,y.u_aspect_ratio),u_fade_change:new x.Uniform1f(I,y.u_fade_change),u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_label_plane_matrix:new x.UniformMatrix4f(I,y.u_label_plane_matrix),u_coord_matrix:new x.UniformMatrix4f(I,y.u_coord_matrix),u_is_text:new x.Uniform1i(I,y.u_is_text),u_pitch_with_map:new x.Uniform1i(I,y.u_pitch_with_map),u_texsize:new x.Uniform2f(I,y.u_texsize),u_texsize_icon:new x.Uniform2f(I,y.u_texsize_icon),u_texture:new x.Uniform1i(I,y.u_texture),u_texture_icon:new x.Uniform1i(I,y.u_texture_icon),u_gamma_scale:new x.Uniform1f(I,y.u_gamma_scale),u_device_pixel_ratio:new x.Uniform1f(I,y.u_device_pixel_ratio),u_is_halo:new x.Uniform1i(I,y.u_is_halo)}),background:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_opacity:new x.Uniform1f(I,y.u_opacity),u_color:new x.UniformColor(I,y.u_color)}),backgroundPattern:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_opacity:new x.Uniform1f(I,y.u_opacity),u_image:new x.Uniform1i(I,y.u_image),u_pattern_tl_a:new x.Uniform2f(I,y.u_pattern_tl_a),u_pattern_br_a:new x.Uniform2f(I,y.u_pattern_br_a),u_pattern_tl_b:new x.Uniform2f(I,y.u_pattern_tl_b),u_pattern_br_b:new x.Uniform2f(I,y.u_pattern_br_b),u_texsize:new x.Uniform2f(I,y.u_texsize),u_mix:new x.Uniform1f(I,y.u_mix),u_pattern_size_a:new x.Uniform2f(I,y.u_pattern_size_a),u_pattern_size_b:new x.Uniform2f(I,y.u_pattern_size_b),u_scale_a:new x.Uniform1f(I,y.u_scale_a),u_scale_b:new x.Uniform1f(I,y.u_scale_b),u_pixel_coord_upper:new x.Uniform2f(I,y.u_pixel_coord_upper),u_pixel_coord_lower:new x.Uniform2f(I,y.u_pixel_coord_lower),u_tile_units_to_pixels:new x.Uniform1f(I,y.u_tile_units_to_pixels)}),terrainRaster:Hn,terrainDepth:Hn,skybox:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_sun_direction:new x.Uniform3f(I,y.u_sun_direction),u_cubemap:new x.Uniform1i(I,y.u_cubemap),u_opacity:new x.Uniform1f(I,y.u_opacity),u_temporal_offset:new x.Uniform1f(I,y.u_temporal_offset)}),skyboxGradient:(I,y)=>({u_matrix:new x.UniformMatrix4f(I,y.u_matrix),u_color_ramp:new x.Uniform1i(I,y.u_color_ramp),u_center_direction:new x.Uniform3f(I,y.u_center_direction),u_radius:new x.Uniform1f(I,y.u_radius),u_opacity:new x.Uniform1f(I,y.u_opacity),u_temporal_offset:new x.Uniform1f(I,y.u_temporal_offset)}),skyboxCapture:(I,y)=>({u_matrix_3f:new x.UniformMatrix3f(I,y.u_matrix_3f),u_sun_direction:new x.Uniform3f(I,y.u_sun_direction),u_sun_intensity:new x.Uniform1f(I,y.u_sun_intensity),u_color_tint_r:new x.Uniform4f(I,y.u_color_tint_r),u_color_tint_m:new x.Uniform4f(I,y.u_color_tint_m),u_luminance:new x.Uniform1f(I,y.u_luminance)}),globeRaster:(I,y)=>({u_proj_matrix:new x.UniformMatrix4f(I,y.u_proj_matrix),u_globe_matrix:new x.UniformMatrix4f(I,y.u_globe_matrix),u_merc_matrix:new x.UniformMatrix4f(I,y.u_merc_matrix),u_zoom_transition:new x.Uniform1f(I,y.u_zoom_transition),u_merc_center:new x.Uniform2f(I,y.u_merc_center),u_image0:new x.Uniform1i(I,y.u_image0)}),globeAtmosphere:(I,y)=>({u_center:new x.Uniform2f(I,y.u_center),u_radius:new x.Uniform1f(I,y.u_radius),u_screen_size:new x.Uniform2f(I,y.u_screen_size),u_pixel_ratio:new x.Uniform1f(I,y.u_pixel_ratio),u_opacity:new x.Uniform1f(I,y.u_opacity),u_fadeout_range:new x.Uniform1f(I,y.u_fadeout_range),u_start_color:new x.Uniform3f(I,y.u_start_color),u_end_color:new x.Uniform3f(I,y.u_end_color)})};let as;function Na(I,y,M,C,L,F,N){const q=I.context,W=q.gl,J=I.useProgram("collisionBox"),ee=[];let ne=0,fe=0;for(let Pe=0;Pe<C.length;Pe++){const Ie=C[Pe],ke=y.getTile(Ie),Fe=ke.getBucket(M);if(!Fe)continue;let Ye=Ie.projMatrix;L[0]===0&&L[1]===0||(Ye=I.translatePosMatrix(Ie.projMatrix,ke,L,F));const Ke=N?Fe.textCollisionBox:Fe.iconCollisionBox,yt=Fe.collisionCircleArray;if(yt.length>0){const dt=x.create(),ut=Ye;x.mul(dt,Fe.placementInvProjMatrix,I.transform.glCoordMatrix),x.mul(dt,dt,Fe.placementViewportMatrix),ee.push({circleArray:yt,circleOffset:fe,transform:ut,invTransform:dt}),ne+=yt.length/4,fe=ne}Ke&&(I.terrain&&I.terrain.setupElevationDraw(ke,J),J.draw(q,W.LINES,x.DepthMode.disabled,x.StencilMode.disabled,I.colorModeForRenderPass(),x.CullFaceMode.disabled,Gl(Ye,I.transform,ke),M.id,Ke.layoutVertexBuffer,Ke.indexBuffer,Ke.segments,null,I.transform.zoom,null,Ke.collisionVertexBuffer,Ke.collisionVertexBufferExt))}if(!N||!ee.length)return;const we=I.useProgram("collisionCircle"),ye=new x.StructArrayLayout2f1f2i16;ye.resize(4*ne),ye._trim();let Ee=0;for(const Pe of ee)for(let Ie=0;Ie<Pe.circleArray.length/4;Ie++){const ke=4*Ie,Fe=Pe.circleArray[ke+0],Ye=Pe.circleArray[ke+1],Ke=Pe.circleArray[ke+2],yt=Pe.circleArray[ke+3];ye.emplace(Ee++,Fe,Ye,Ke,yt,0),ye.emplace(Ee++,Fe,Ye,Ke,yt,1),ye.emplace(Ee++,Fe,Ye,Ke,yt,2),ye.emplace(Ee++,Fe,Ye,Ke,yt,3)}(!as||as.length<2*ne)&&(as=function(Pe){const Ie=2*Pe,ke=new x.StructArrayLayout3ui6;ke.resize(Ie),ke._trim();for(let Fe=0;Fe<Ie;Fe++){const Ye=6*Fe;ke.uint16[Ye+0]=4*Fe+0,ke.uint16[Ye+1]=4*Fe+1,ke.uint16[Ye+2]=4*Fe+2,ke.uint16[Ye+3]=4*Fe+2,ke.uint16[Ye+4]=4*Fe+3,ke.uint16[Ye+5]=4*Fe+0}return ke}(ne));const ze=q.createIndexBuffer(as,!0),be=q.createVertexBuffer(ye,x.collisionCircleLayout.members,!0);for(const Pe of ee){const Ie={u_matrix:Pe.transform,u_inv_matrix:Pe.invTransform,u_camera_to_center_distance:(Ce=I.transform).cameraToCenterDistance,u_viewport_size:[Ce.width,Ce.height]};we.draw(q,W.TRIANGLES,x.DepthMode.disabled,x.StencilMode.disabled,I.colorModeForRenderPass(),x.CullFaceMode.disabled,Ie,M.id,be,ze,x.SegmentVector.simpleSegment(0,2*Pe.circleOffset,Pe.circleArray.length,Pe.circleArray.length/2),null,I.transform.zoom,null,null,null)}var Ce;be.destroy(),ze.destroy()}const Zs=x.identity(new Float32Array(16));function Yl(I,y,M,C,L,F){const{horizontalAlign:N,verticalAlign:q}=x.getAnchorAlignment(I),W=-(N-.5)*y,J=-(q-.5)*M,ee=x.evaluateVariableOffset(I,C);return new x.pointGeometry((W/L+ee[0])*F,(J/L+ee[1])*F)}function sc(I,y,M,C,L,F,N,q,W,J,ee,ne){const fe=I.text.placedSymbolArray,we=I.text.dynamicLayoutVertexArray,ye=I.icon.dynamicLayoutVertexArray,Ee={},ze=q.projMatrix,be=F.elevation,Ce=be?be.getAtTileOffsetFunc(q,ne):Pe=>[0,0,0];we.clear();for(let Pe=0;Pe<fe.length;Pe++){const Ie=fe.get(Pe),ke=I.allowVerticalPlacement&&!Ie.placedOrientation,Fe=Ie.hidden||!Ie.crossTileID||ke?null:C[Ie.crossTileID];if(Fe){const Ye=new x.pointGeometry(Ie.tileAnchorX,Ie.tileAnchorY),Ke=Ce(Ye),yt=Lr(Ye,M?ze:N,Ke[2]),dt=En(F.cameraToCenterDistance,yt.signedDistanceFromCamera);let ut=L.evaluateSizeForFeature(I.textSizeData,J,Ie)*dt/x.ONE_EM;M&&(ut*=I.tilePixelRatio/W);const{width:tt,height:We,anchor:ct,textOffset:ot,textScale:Xt}=Fe,ti=Yl(ct,tt,We,ot,Xt,ut),vi=M?Lr(Ye.add(ti),N,Ke[2]).point:yt.point.add(y?ti.rotate(-F.angle):ti),_t=I.allowVerticalPlacement&&Ie.placedOrientation===x.WritingMode.vertical?Math.PI/2:0;for(let Kt=0;Kt<Ie.numGlyphs;Kt++)x.addDynamicAttributes(we,vi,_t);ee&&Ie.associatedIconIndex>=0&&(Ee[Ie.associatedIconIndex]={shiftedAnchor:vi,angle:_t})}else mn(Ie.numGlyphs,we)}if(ee){ye.clear();const Pe=I.icon.placedSymbolArray;for(let Ie=0;Ie<Pe.length;Ie++){const ke=Pe.get(Ie);if(ke.hidden)mn(ke.numGlyphs,ye);else{const Fe=Ee[Ie];if(Fe)for(let Ye=0;Ye<ke.numGlyphs;Ye++)x.addDynamicAttributes(ye,Fe.shiftedAnchor,Fe.angle);else mn(ke.numGlyphs,ye)}}I.icon.dynamicLayoutVertexBuffer.updateData(ye)}I.text.dynamicLayoutVertexBuffer.updateData(we)}function ac(I,y,M){return M.iconsInText&&y?"symbolTextAndIcon":I?"symbolSDF":"symbolIcon"}function Xs(I,y,M,C,L,F,N,q,W,J,ee,ne){const fe=I.context,we=fe.gl,ye=I.transform,Ee=ye.projection.createTileTransform(ye,ye.worldSize),ze=q==="map",be=W==="map",Ce=ze&&M.layout.get("symbol-placement")!=="point",Pe=ze&&!be&&!Ce,Ie=M.layout.get("symbol-sort-key").constantOr(1)!==void 0;let ke=!1;const Fe=I.depthModeForSublayer(0,x.DepthMode.ReadOnly),Ye=[x.mercatorXfromLng(ye.center.lng),x.mercatorYfromLat(ye.center.lat)],Ke=M.layout.get("text-variable-anchor"),yt=ye.projection.name==="globe",dt=yt?x.globeToMercatorTransition(ye.zoom):0,ut=[],tt=[];I.terrain&&be&&tt.push("PITCH_WITH_MAP_TERRAIN"),yt&&tt.push("PROJECTION_GLOBE_VIEW"),Ce&&tt.push("PROJECTED_POS_ON_VIEWPORT");for(const We of C){const ct=y.getTile(We),ot=ct.getBucket(M);if(!ot||ot.projection!==ye.projection.name)continue;const Xt=L?ot.text:ot.icon;if(!Xt||ot.fullyClipped||!Xt.segments.get().length)continue;const ti=Xt.programConfigurations.get(M.id),vi=L||ot.sdfIcons,_t=L?ot.textSizeData:ot.iconSizeData,Kt=be||ye.pitch!==0,ci=I.useProgram(ac(vi,L,ot),ti,tt),qi=x.evaluateSizeForZoom(_t,ye.zoom),Ji=[We.canonical.x,We.canonical.y,1<<We.canonical.z];let si,Ti,ir,br,Yr=[0,0],cn=null;if(L){if(Ti=ct.glyphAtlasTexture,ir=we.LINEAR,si=ct.glyphAtlasTexture.size,ot.iconsInText){Yr=ct.imageAtlasTexture.size,cn=ct.imageAtlasTexture;const Ir=_t.kind==="composite"||_t.kind==="camera";br=Kt||I.options.rotating||I.options.zooming||Ir?we.LINEAR:we.NEAREST}}else{const Ir=M.layout.get("icon-size").constantOr(0)!==1||ot.iconsNeedLinear;Ti=ct.imageAtlasTexture,ir=vi||I.options.rotating||I.options.zooming||Ir||Kt?we.LINEAR:we.NEAREST,si=ct.imageAtlasTexture.size}const xn=I.transform.calculatePixelsToTileUnitsMatrix(ct),Bi=jn(We.projMatrix,ct.tileID.canonical,be,ze,I.transform,xn),ui=I.terrain&&be&&Ce?x.invert(new Float32Array(16),Bi):Zs,ki=Pn(We.projMatrix,ct.tileID.canonical,be,ze,I.transform,xn),lr=Ke&&ot.hasTextData(),Qr=M.layout.get("icon-text-fit")!=="none"&&lr&&ot.hasIconData();if(Ce){const Ir=ye.elevation,fo=Ir?Ir.getAtTileOffsetFunc(We,Ee):to=>[0,0,0];Pl(ot,We.projMatrix,I,L,Bi,ki,be,J,fo,We)}const tr=I.translatePosMatrix(We.projMatrix,ct,F,N),en=Ce||L&&Ke||Qr?Zs:Bi,ws=I.translatePosMatrix(ki,ct,F,N,!0),Hr=vi&&M.paint.get(L?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let uo;const Ot=Ee.createInversionMatrix(We.toUnwrapped());uo=vi?ot.iconsInText?ss(_t.kind,qi,Pe,be,I,tr,en,ws,si,Yr,Ji,dt,Ot,Ye):os(_t.kind,qi,Pe,be,I,tr,en,ws,L,si,!0,Ji,dt,Ot,Ye):Gs(_t.kind,qi,Pe,be,I,tr,en,ws,L,si,Ji,dt,Ot,Ye);const Jt={program:ci,buffers:Xt,uniformValues:uo,atlasTexture:Ti,atlasTextureIcon:cn,atlasInterpolation:ir,atlasInterpolationIcon:br,isSDF:vi,hasHalo:Hr,tile:ct,labelPlaneMatrixInv:ui};if(Ie&&ot.canOverlap){ke=!0;const Ir=Xt.segments.get();for(const fo of Ir)ut.push({segments:new x.SegmentVector([fo]),sortKey:fo.sortKey,state:Jt})}else ut.push({segments:Xt.segments,sortKey:0,state:Jt})}ke&&ut.sort((We,ct)=>We.sortKey-ct.sortKey);for(const We of ut){const ct=We.state;if(I.terrain&&I.terrain.setupElevationDraw(ct.tile,ct.program,{useDepthForOcclusion:!yt,labelPlaneMatrixInv:ct.labelPlaneMatrixInv}),fe.activeTexture.set(we.TEXTURE0),ct.atlasTexture.bind(ct.atlasInterpolation,we.CLAMP_TO_EDGE),ct.atlasTextureIcon&&(fe.activeTexture.set(we.TEXTURE1),ct.atlasTextureIcon&&ct.atlasTextureIcon.bind(ct.atlasInterpolationIcon,we.CLAMP_TO_EDGE)),ct.isSDF){const ot=ct.uniformValues;ct.hasHalo&&(ot.u_is_halo=1,Ys(ct.buffers,We.segments,M,I,ct.program,Fe,ee,ne,ot)),ot.u_is_halo=0}Ys(ct.buffers,We.segments,M,I,ct.program,Fe,ee,ne,ct.uniformValues)}}function Ys(I,y,M,C,L,F,N,q,W){const J=C.context;L.draw(J,J.gl.TRIANGLES,F,N,q,x.CullFaceMode.disabled,W,M.id,I.layoutVertexBuffer,I.indexBuffer,y,M.paint,C.transform.zoom,I.programConfigurations.get(M.id),I.dynamicLayoutVertexBuffer,I.opacityVertexBuffer)}function Hs(I,y,M,C,L,F,N){const q=I.context.gl,W=M.paint.get("fill-pattern"),J=W&&W.constantOr(1),ee=M.getCrossfadeParameters();let ne,fe,we,ye,Ee;N?(fe=J&&!M.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ne=q.LINES):(fe=J?"fillPattern":"fill",ne=q.TRIANGLES);for(const ze of C){const be=y.getTile(ze);if(J&&!be.patternsLoaded())continue;const Ce=be.getBucket(M);if(!Ce)continue;I.prepareDrawTile(ze);const Pe=Ce.programConfigurations.get(M.id),Ie=I.useProgram(fe,Pe);J&&(I.context.activeTexture.set(q.TEXTURE0),be.imageAtlasTexture.bind(q.LINEAR,q.CLAMP_TO_EDGE),Pe.updatePaintBuffers(ee));const ke=W.constantOr(null);if(ke&&be.imageAtlas){const Ye=be.imageAtlas,Ke=Ye.patternPositions[ke.to.toString()],yt=Ye.patternPositions[ke.from.toString()];Ke&&yt&&Pe.setConstantPatternPositions(Ke,yt)}const Fe=I.translatePosMatrix(ze.projMatrix,be,M.paint.get("fill-translate"),M.paint.get("fill-translate-anchor"));if(N){ye=Ce.indexBuffer2,Ee=Ce.segments2;const Ye=I.terrain&&I.terrain.renderingToTexture?I.terrain.drapeBufferSize:[q.drawingBufferWidth,q.drawingBufferHeight];we=fe==="fillOutlinePattern"&&J?jl(Fe,I,ee,be,Ye):nc(Fe,Ye)}else ye=Ce.indexBuffer,Ee=Ce.segments,we=J?Oa(Fe,I,ee,be):Vl(Fe);I.prepareDrawProgram(I.context,Ie,ze.toUnwrapped()),Ie.draw(I.context,ne,L,I.stencilModeForClipping(ze),F,x.CullFaceMode.disabled,we,M.id,Ce.layoutVertexBuffer,ye,Ee,M.paint,I.transform.zoom,Pe)}}function ls(I,y,M,C,L,F,N){const q=I.context,W=q.gl,J=M.paint.get("fill-extrusion-pattern"),ee=J.constantOr(1),ne=M.getCrossfadeParameters(),fe=M.paint.get("fill-extrusion-opacity");for(const we of C){const ye=y.getTile(we),Ee=ye.getBucket(M);if(!Ee)continue;const ze=Ee.programConfigurations.get(M.id),be=I.useProgram(ee?"fillExtrusionPattern":"fillExtrusion",ze);if(I.terrain){const Fe=I.terrain;if(!Ee.enableTerrain)continue;if(Fe.setupElevationDraw(ye,be,{useMeterToDem:!0}),Hl(q,y,we,Ee,M,Fe),!Ee.centroidVertexBuffer){const Ye=be.attributes.a_centroid_pos;Ye!==void 0&&W.vertexAttrib2f(Ye,0,0)}}ee&&(I.context.activeTexture.set(W.TEXTURE0),ye.imageAtlasTexture.bind(W.LINEAR,W.CLAMP_TO_EDGE),ze.updatePaintBuffers(ne));const Ce=J.constantOr(null);if(Ce&&ye.imageAtlas){const Fe=ye.imageAtlas,Ye=Fe.patternPositions[Ce.to.toString()],Ke=Fe.patternPositions[Ce.from.toString()];Ye&&Ke&&ze.setConstantPatternPositions(Ye,Ke)}const Pe=I.translatePosMatrix(we.projMatrix,ye,M.paint.get("fill-extrusion-translate"),M.paint.get("fill-extrusion-translate-anchor")),Ie=M.paint.get("fill-extrusion-vertical-gradient"),ke=ee?Fa(Pe,I,Ie,fe,we,ne,ye):Nl(Pe,I,Ie,fe);I.prepareDrawProgram(q,be,we.toUnwrapped()),be.draw(q,q.gl.TRIANGLES,L,F,N,x.CullFaceMode.backCCW,ke,M.id,Ee.layoutVertexBuffer,Ee.indexBuffer,Ee.segments,M.paint,I.transform.zoom,ze,I.terrain?Ee.centroidVertexBuffer:null)}}function Hl(I,y,M,C,L,F){const N=[be=>{let Ce=be.canonical.x-1,Pe=be.wrap;return Ce<0&&(Ce=(1<<be.canonical.z)-1,Pe--),new x.OverscaledTileID(be.overscaledZ,Pe,be.canonical.z,Ce,be.canonical.y)},be=>{let Ce=be.canonical.x+1,Pe=be.wrap;return Ce===1<<be.canonical.z&&(Ce=0,Pe++),new x.OverscaledTileID(be.overscaledZ,Pe,be.canonical.z,Ce,be.canonical.y)},be=>new x.OverscaledTileID(be.overscaledZ,be.wrap,be.canonical.z,be.canonical.x,(be.canonical.y===0?1<<be.canonical.z:be.canonical.y)-1),be=>new x.OverscaledTileID(be.overscaledZ,be.wrap,be.canonical.z,be.canonical.x,be.canonical.y===(1<<be.canonical.z)-1?0:be.canonical.y+1)],q=be=>{const Ce=y.getSource().maxzoom,Pe=Ye=>{const Ke=y.getTileByID(Ye);if(Ke&&Ke.hasData())return Ke.getBucket(L)};let Ie,ke,Fe;return(be.overscaledZ===be.canonical.z||be.overscaledZ>=Ce)&&(Ie=Pe(be.key)),be.overscaledZ>=Ce&&(ke=Pe(be.calculateScaledKey(be.overscaledZ+1))),be.overscaledZ>Ce&&(Fe=Pe(be.calculateScaledKey(be.overscaledZ-1))),Ie||ke||Fe},W=[0,0,0],J=(be,Ce)=>(W[0]=Math.min(be.min.y,Ce.min.y),W[1]=Math.max(be.max.y,Ce.max.y),W[2]=x.EXTENT-Ce.min.x>be.max.x?Ce.min.x-x.EXTENT:be.max.x,W),ee=(be,Ce)=>(W[0]=Math.min(be.min.x,Ce.min.x),W[1]=Math.max(be.max.x,Ce.max.x),W[2]=x.EXTENT-Ce.min.y>be.max.y?Ce.min.y-x.EXTENT:be.max.y,W),ne=[(be,Ce)=>J(be,Ce),(be,Ce)=>J(Ce,be),(be,Ce)=>ee(be,Ce),(be,Ce)=>ee(Ce,be)],fe=new x.pointGeometry(0,0);let we,ye,Ee;const ze=(be,Ce,Pe,Ie,ke)=>{const Fe=[[Ie?Pe:be,Ie?be:Pe,0],[Ie?Pe:Ce,Ie?Ce:Pe,0]],Ye=ke<0?x.EXTENT+ke:ke,Ke=[Ie?Ye:(be+Ce)/2,Ie?(be+Ce)/2:Ye,0];return Pe===0&&ke<0||Pe!==0&&ke>0?F.getForTilePoints(Ee,[Ke],!0,ye):Fe.push(Ke),F.getForTilePoints(M,Fe,!0,we),Math.max(Fe[0][2],Fe[1][2],Ke[2])/F.exaggeration()};for(let be=0;be<4;be++){const Ce=C.borders[be];if(Ce.length===0&&(C.borderDone[be]=!0),C.borderDone[be])continue;const Pe=Ee=N[be](M),Ie=q(Pe);if(!Ie||!Ie.enableTerrain||(ye=F.findDEMTileFor(Pe),!ye||!ye.dem))continue;if(!we){const Ke=F.findDEMTileFor(M);if(!Ke||!Ke.dem)return;we=Ke}const ke=(be<2?1:5)-be,Fe=Ie.borders[ke];let Ye=0;for(let Ke=0;Ke<Ce.length;Ke++){const yt=C.featuresOnBorder[Ce[Ke]],dt=yt.borders[be];let ut;for(;Ye<Fe.length&&(ut=Ie.featuresOnBorder[Fe[Ye]],!(ut.borders[ke][1]>dt[0]+3));)Ie.borderDone[ke]||Ie.encodeCentroid(void 0,ut,!1),Ye++;if(ut&&Ye<Fe.length){const tt=Ye;let We=0;for(;!(ut.borders[ke][0]>dt[1]-3)&&(We++,++Ye!==Fe.length);)ut=Ie.featuresOnBorder[Fe[Ye]];if(ut=Ie.featuresOnBorder[Fe[tt]],yt.intersectsCount()>1||ut.intersectsCount()>1||We!==1){We!==1&&(Ye=tt),C.encodeCentroid(void 0,yt,!1),Ie.borderDone[ke]||Ie.encodeCentroid(void 0,ut,!1);continue}const ct=ne[be](yt,ut),ot=be%2?x.EXTENT-1:0;fe.x=ze(ct[0],Math.min(x.EXTENT-1,ct[1]),ot,be<2,ct[2]),fe.y=0,C.encodeCentroid(fe,yt,!1),Ie.borderDone[ke]||Ie.encodeCentroid(fe,ut,!1)}else C.encodeCentroid(void 0,yt,!1)}C.borderDone[be]=C.needsCentroidUpdate=!0,Ie.borderDone[ke]||(Ie.borderDone[ke]=Ie.needsCentroidUpdate=!0)}(C.needsCentroidUpdate||!C.centroidVertexBuffer&&C.centroidVertexArray.length!==0)&&C.uploadCentroid(I)}const Wl=new x.Color(1,0,0,1),lc=new x.Color(0,1,0,1),hs=new x.Color(0,0,1,1),cs=new x.Color(1,0,1,1),Kl=new x.Color(0,1,1,1);function Xr(I,y,M,C){co(I,0,y+M/2,I.transform.width,M,C)}function Ws(I,y,M,C){co(I,y-M/2,0,M,I.transform.height,C)}function co(I,y,M,C,L,F){const N=I.context,q=N.gl;q.enable(q.SCISSOR_TEST),q.scissor(y*x.exported.devicePixelRatio,M*x.exported.devicePixelRatio,C*x.exported.devicePixelRatio,L*x.exported.devicePixelRatio),N.clear({color:F}),q.disable(q.SCISSOR_TEST)}function Ks(I,y,M){const C=I.context,L=C.gl,F=M.projMatrix,N=I.useProgram("debug"),q=y.getTileByID(M.key);I.terrain&&I.terrain.setupElevationDraw(q,N);const W=x.DepthMode.disabled,J=x.StencilMode.disabled,ee=I.colorModeForRenderPass(),ne="$debug";C.activeTexture.set(L.TEXTURE0),I.emptyTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),q._makeDebugTileBoundsBuffers(I.context,I.transform.projection);const fe=q._tileDebugBuffer||I.debugBuffer,we=q._tileDebugIndexBuffer||I.debugIndexBuffer,ye=q._tileDebugSegments||I.debugSegments;N.draw(C,L.LINE_STRIP,W,J,ee,x.CullFaceMode.disabled,Ua(F,x.Color.red),ne,fe,we,ye);const Ee=q.latestRawTileData,ze=Math.floor((Ee&&Ee.byteLength||0)/1024),be=y.getTile(M).tileSize,Ce=512/Math.min(be,512)*(M.overscaledZ/I.transform.zoom)*.5;let Pe=M.canonical.toString();M.overscaledZ!==M.canonical.z&&(Pe+=` => ${M.overscaledZ}`),function(Ie,ke){Ie.initDebugOverlayCanvas();const Fe=Ie.debugOverlayCanvas,Ye=Ie.context.gl,Ke=Ie.debugOverlayCanvas.getContext("2d");Ke.clearRect(0,0,Fe.width,Fe.height),Ke.shadowColor="white",Ke.shadowBlur=2,Ke.lineWidth=1.5,Ke.strokeStyle="white",Ke.textBaseline="top",Ke.font="bold 36px Open Sans, sans-serif",Ke.fillText(ke,5,5),Ke.strokeText(ke,5,5),Ie.debugOverlayTexture.update(Fe),Ie.debugOverlayTexture.bind(Ye.LINEAR,Ye.CLAMP_TO_EDGE)}(I,`${Pe} ${ze}kb`),N.draw(C,L.TRIANGLES,W,J,x.ColorMode.alphaBlended,x.CullFaceMode.disabled,Ua(F,x.Color.transparent,Ce),ne,I.debugBuffer,I.quadTriangleIndexBuffer,I.debugSegments)}const Va=x.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:ja}=Va;function gn(I,y,M,C){I.emplaceBack(y,M,C)}class Js{constructor(y){this.vertexArray=new x.StructArrayLayout3f12,this.indices=new x.StructArrayLayout3ui6,gn(this.vertexArray,-1,-1,1),gn(this.vertexArray,1,-1,1),gn(this.vertexArray,-1,1,1),gn(this.vertexArray,1,1,1),gn(this.vertexArray,-1,-1,-1),gn(this.vertexArray,1,-1,-1),gn(this.vertexArray,-1,1,-1),gn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=y.createVertexBuffer(this.vertexArray,ja),this.indexBuffer=y.createIndexBuffer(this.indices),this.segment=x.SegmentVector.simpleSegment(0,0,36,12)}}function Kn(I,y,M,C,L,F){const N=I.gl,q=y.paint.get("sky-atmosphere-color"),W=y.paint.get("sky-atmosphere-halo-color"),J=y.paint.get("sky-atmosphere-sun-intensity"),ee=((ne,fe,we,ye,Ee)=>({u_matrix_3f:ne,u_sun_direction:fe,u_sun_intensity:we,u_color_tint_r:[ye.r,ye.g,ye.b,ye.a],u_color_tint_m:[Ee.r,Ee.g,Ee.b,Ee.a],u_luminance:5e-5}))(x.fromMat4([],C),L,J,q,W);N.framebufferTexture2D(N.FRAMEBUFFER,N.COLOR_ATTACHMENT0,N.TEXTURE_CUBE_MAP_POSITIVE_X+F,y.skyboxTexture,0),M.draw(I,N.TRIANGLES,x.DepthMode.disabled,x.StencilMode.disabled,x.ColorMode.unblended,x.CullFaceMode.frontCW,ee,"skyboxCapture",y.skyboxGeometry.vertexBuffer,y.skyboxGeometry.indexBuffer,y.skyboxGeometry.segment)}const us={symbol:function(I,y,M,C,L){if(I.renderPass!=="translucent")return;const F=x.StencilMode.disabled,N=I.colorModeForRenderPass();M.layout.get("text-variable-anchor")&&function(q,W,J,ee,ne,fe,we){const ye=W.transform,Ee=ne==="map",ze=fe==="map",be=ye.projection.createTileTransform(ye,ye.worldSize);for(const Ce of q){const Pe=ee.getTile(Ce),Ie=Pe.getBucket(J);if(!Ie||Ie.projection!==ye.projection.name||!Ie.text||!Ie.text.segments.get().length)continue;const ke=x.evaluateSizeForZoom(Ie.textSizeData,ye.zoom),Fe=W.transform.calculatePixelsToTileUnitsMatrix(Pe),Ye=jn(Ce.projMatrix,Pe.tileID.canonical,ze,Ee,W.transform,Fe),Ke=J.layout.get("icon-text-fit")!=="none"&&Ie.hasIconData();if(ke){const yt=Math.pow(2,ye.zoom-Pe.tileID.overscaledZ);sc(Ie,Ee,ze,we,x.symbolSize,ye,Ye,Ce,yt,ke,Ke,be)}}}(C,I,M,y,M.layout.get("text-rotation-alignment"),M.layout.get("text-pitch-alignment"),L),M.paint.get("icon-opacity").constantOr(1)!==0&&Xs(I,y,M,C,!1,M.paint.get("icon-translate"),M.paint.get("icon-translate-anchor"),M.layout.get("icon-rotation-alignment"),M.layout.get("icon-pitch-alignment"),M.layout.get("icon-keep-upright"),F,N),M.paint.get("text-opacity").constantOr(1)!==0&&Xs(I,y,M,C,!0,M.paint.get("text-translate"),M.paint.get("text-translate-anchor"),M.layout.get("text-rotation-alignment"),M.layout.get("text-pitch-alignment"),M.layout.get("text-keep-upright"),F,N),y.map.showCollisionBoxes&&(Na(I,y,M,C,M.paint.get("text-translate"),M.paint.get("text-translate-anchor"),!0),Na(I,y,M,C,M.paint.get("icon-translate"),M.paint.get("icon-translate-anchor"),!1))},circle:function(I,y,M,C){if(I.renderPass!=="translucent")return;const L=M.paint.get("circle-opacity"),F=M.paint.get("circle-stroke-width"),N=M.paint.get("circle-stroke-opacity"),q=M.layout.get("circle-sort-key").constantOr(1)!==void 0;if(L.constantOr(1)===0&&(F.constantOr(1)===0||N.constantOr(1)===0))return;const W=I.context,J=W.gl,ee=I.depthModeForSublayer(0,x.DepthMode.ReadOnly),ne=x.StencilMode.disabled,fe=I.colorModeForRenderPass(),we=[];for(let Ee=0;Ee<C.length;Ee++){const ze=C[Ee],be=y.getTile(ze),Ce=be.getBucket(M);if(!Ce)continue;const Pe=Ce.programConfigurations.get(M.id),Ie=$a(M),ke={programConfiguration:Pe,program:I.useProgram("circle",Pe,Ie),layoutVertexBuffer:Ce.layoutVertexBuffer,indexBuffer:Ce.indexBuffer,uniformValues:oc(I,ze,be,M),tile:be};if(q){const Fe=Ce.segments.get();for(const Ye of Fe)we.push({segments:new x.SegmentVector([Ye]),sortKey:Ye.sortKey,state:ke})}else we.push({segments:Ce.segments,sortKey:0,state:ke})}q&&we.sort((Ee,ze)=>Ee.sortKey-ze.sortKey);const ye={useDepthForOcclusion:I.transform.projection.name!=="globe"};for(const Ee of we){const{programConfiguration:ze,program:be,layoutVertexBuffer:Ce,indexBuffer:Pe,uniformValues:Ie,tile:ke}=Ee.state,Fe=Ee.segments;I.terrain&&I.terrain.setupElevationDraw(ke,be,ye),I.prepareDrawProgram(W,be,ke.tileID.toUnwrapped()),be.draw(W,J.TRIANGLES,ee,ne,fe,x.CullFaceMode.disabled,Ie,M.id,Ce,Pe,Fe,M.paint,I.transform.zoom,ze)}},heatmap:function(I,y,M,C){if(M.paint.get("heatmap-opacity")!==0)if(I.renderPass==="offscreen"){const L=I.context,F=L.gl,N=x.StencilMode.disabled,q=new x.ColorMode([F.ONE,F.ONE],x.Color.transparent,[!0,!0,!0,!0]);(function(W,J,ee){const ne=W.gl;W.activeTexture.set(ne.TEXTURE1),W.viewport.set([0,0,J.width/4,J.height/4]);let fe=ee.heatmapFbo;if(fe)ne.bindTexture(ne.TEXTURE_2D,fe.colorAttachment.get()),W.bindFramebuffer.set(fe.framebuffer);else{const we=ne.createTexture();ne.bindTexture(ne.TEXTURE_2D,we),ne.texParameteri(ne.TEXTURE_2D,ne.TEXTURE_WRAP_S,ne.CLAMP_TO_EDGE),ne.texParameteri(ne.TEXTURE_2D,ne.TEXTURE_WRAP_T,ne.CLAMP_TO_EDGE),ne.texParameteri(ne.TEXTURE_2D,ne.TEXTURE_MIN_FILTER,ne.LINEAR),ne.texParameteri(ne.TEXTURE_2D,ne.TEXTURE_MAG_FILTER,ne.LINEAR),fe=ee.heatmapFbo=W.createFramebuffer(J.width/4,J.height/4,!1),function(ye,Ee,ze,be){const Ce=ye.gl;Ce.texImage2D(Ce.TEXTURE_2D,0,Ce.RGBA,Ee.width/4,Ee.height/4,0,Ce.RGBA,ye.extRenderToTextureHalfFloat?ye.extTextureHalfFloat.HALF_FLOAT_OES:Ce.UNSIGNED_BYTE,null),be.colorAttachment.set(ze)}(W,J,we,fe)}})(L,I,M),L.clear({color:x.Color.transparent});for(let W=0;W<C.length;W++){const J=C[W];if(y.hasRenderableParent(J))continue;const ee=y.getTile(J),ne=ee.getBucket(M);if(!ne)continue;const fe=ne.programConfigurations.get(M.id),we=I.useProgram("heatmap",fe),{zoom:ye}=I.transform;I.terrain&&I.terrain.setupElevationDraw(ee,we),I.prepareDrawProgram(L,we,J.toUnwrapped()),we.draw(L,F.TRIANGLES,x.DepthMode.disabled,N,q,x.CullFaceMode.disabled,ql(J.projMatrix,ee,ye,M.paint.get("heatmap-intensity")),M.id,ne.layoutVertexBuffer,ne.indexBuffer,ne.segments,M.paint,I.transform.zoom,fe)}L.viewport.set([0,0,I.width,I.height])}else I.renderPass==="translucent"&&(I.context.setColorMode(I.colorModeForRenderPass()),function(L,F){const N=L.context,q=N.gl,W=F.heatmapFbo;if(!W)return;N.activeTexture.set(q.TEXTURE0),q.bindTexture(q.TEXTURE_2D,W.colorAttachment.get()),N.activeTexture.set(q.TEXTURE1);let J=F.colorRampTexture;J||(J=F.colorRampTexture=new x.Texture(N,F.colorRamp,q.RGBA)),J.bind(q.LINEAR,q.CLAMP_TO_EDGE),L.useProgram("heatmapTexture").draw(N,q.TRIANGLES,x.DepthMode.disabled,x.StencilMode.disabled,L.colorModeForRenderPass(),x.CullFaceMode.disabled,((ee,ne,fe,we)=>({u_image:0,u_color_ramp:1,u_opacity:ne.paint.get("heatmap-opacity")}))(0,F),F.id,L.viewportBuffer,L.quadTriangleIndexBuffer,L.viewportSegments,F.paint,L.transform.zoom)}(I,M))},line:function(I,y,M,C){if(I.renderPass!=="translucent")return;const L=M.paint.get("line-opacity"),F=M.paint.get("line-width");if(L.constantOr(1)===0||F.constantOr(1)===0)return;const N=I.depthModeForSublayer(0,x.DepthMode.ReadOnly),q=I.colorModeForRenderPass(),W=M.paint.get("line-dasharray"),J=W.constantOr(1),ee=M.layout.get("line-cap"),ne=M.paint.get("line-pattern"),fe=ne.constantOr(1),we=M.paint.get("line-gradient"),ye=M.getCrossfadeParameters(),Ee=fe?"linePattern":"line",ze=I.context,be=ze.gl,Ce=(Ie=>{const ke=[];ns(Ie)&&ke.push("RENDER_LINE_DASH"),Ie.paint.get("line-gradient")&&ke.push("RENDER_LINE_GRADIENT");const Fe=Ie.paint.get("line-pattern").constantOr(1),Ye=Ie.paint.get("line-opacity").constantOr(1)!==1;return!Fe&&Ye&&ke.push("RENDER_LINE_ALPHA_DISCARD"),ke})(M);let Pe=Ce.includes("RENDER_LINE_ALPHA_DISCARD");I.terrain&&I.terrain.clipOrMaskOverlapStencilType()&&(Pe=!1);for(const Ie of C){const ke=y.getTile(Ie);if(fe&&!ke.patternsLoaded())continue;const Fe=ke.getBucket(M);if(!Fe)continue;I.prepareDrawTile(Ie);const Ye=Fe.programConfigurations.get(M.id),Ke=I.useProgram(Ee,Ye,Ce),yt=ne.constantOr(null);if(yt&&ke.imageAtlas){const ot=ke.imageAtlas,Xt=ot.patternPositions[yt.to.toString()],ti=ot.patternPositions[yt.from.toString()];Xt&&ti&&Ye.setConstantPatternPositions(Xt,ti)}const dt=W.constantOr(null),ut=ee.constantOr(null);if(!fe&&dt&&ut&&ke.lineAtlas){const ot=ke.lineAtlas,Xt=ot.getDash(dt.to,ut),ti=ot.getDash(dt.from,ut);Xt&&ti&&Ye.setConstantPatternPositions(Xt,ti)}const tt=I.terrain?Ie.projMatrix:null,We=fe?ho(I,ke,M,ye,tt):Zl(I,ke,M,ye,tt,Fe.lineClipsArray.length);if(we){const ot=Fe.gradients[M.id];let Xt=ot.texture;if(M.gradientVersion!==ot.version){let ti=256;if(M.stepInterpolant){const vi=y.getSource().maxzoom,_t=Ie.canonical.z===vi?Math.ceil(1<<I.transform.maxZoom-Ie.canonical.z):1;ti=x.clamp(x.nextPowerOfTwo(Fe.maxLineLength/x.EXTENT*1024*_t),256,ze.maxTextureSize)}ot.gradient=x.renderColorRamp({expression:M.gradientExpression(),evaluationKey:"lineProgress",resolution:ti,image:ot.gradient||void 0,clips:Fe.lineClipsArray}),ot.texture?ot.texture.update(ot.gradient):ot.texture=new x.Texture(ze,ot.gradient,be.RGBA),ot.version=M.gradientVersion,Xt=ot.texture}ze.activeTexture.set(be.TEXTURE1),Xt.bind(M.stepInterpolant?be.NEAREST:be.LINEAR,be.CLAMP_TO_EDGE)}J&&(ze.activeTexture.set(be.TEXTURE0),ke.lineAtlasTexture.bind(be.LINEAR,be.REPEAT),Ye.updatePaintBuffers(ye)),fe&&(ze.activeTexture.set(be.TEXTURE0),ke.imageAtlasTexture.bind(be.LINEAR,be.CLAMP_TO_EDGE),Ye.updatePaintBuffers(ye)),I.prepareDrawProgram(ze,Ke,Ie.toUnwrapped());const ct=ot=>{Ke.draw(ze,be.TRIANGLES,N,ot,q,x.CullFaceMode.disabled,We,M.id,Fe.layoutVertexBuffer,Fe.indexBuffer,Fe.segments,M.paint,I.transform.zoom,Ye,Fe.layoutVertexBuffer2)};if(Pe){const ot=I.stencilModeForClipping(Ie).ref;ot===0&&I.terrain&&ze.clear({stencil:0});const Xt={func:be.EQUAL,mask:255};We.u_alpha_discard_threshold=.8,ct(new x.StencilMode(Xt,ot,255,be.KEEP,be.KEEP,be.INVERT)),We.u_alpha_discard_threshold=0,ct(new x.StencilMode(Xt,ot,255,be.KEEP,be.KEEP,be.KEEP))}else ct(I.stencilModeForClipping(Ie))}Pe&&(I.resetStencilClippingMasks(),I.terrain&&ze.clear({stencil:0}))},fill:function(I,y,M,C){const L=M.paint.get("fill-color"),F=M.paint.get("fill-opacity");if(F.constantOr(1)===0)return;const N=I.colorModeForRenderPass(),q=M.paint.get("fill-pattern"),W=I.opaquePassEnabledForLayer()&&!q.constantOr(1)&&L.constantOr(x.Color.transparent).a===1&&F.constantOr(0)===1?"opaque":"translucent";if(I.renderPass===W){const J=I.depthModeForSublayer(1,I.renderPass==="opaque"?x.DepthMode.ReadWrite:x.DepthMode.ReadOnly);Hs(I,y,M,C,J,N,!1)}if(I.renderPass==="translucent"&&M.paint.get("fill-antialias")){const J=I.depthModeForSublayer(M.getPaintProperty("fill-outline-color")?2:0,x.DepthMode.ReadOnly);Hs(I,y,M,C,J,N,!0)}},"fill-extrusion":function(I,y,M,C){const L=M.paint.get("fill-extrusion-opacity");if(L!==0&&I.renderPass==="translucent"){const F=new x.DepthMode(I.context.gl.LEQUAL,x.DepthMode.ReadWrite,I.depthRangeFor3D);if(L!==1||M.paint.get("fill-extrusion-pattern").constantOr(1))ls(I,y,M,C,F,x.StencilMode.disabled,x.ColorMode.disabled),ls(I,y,M,C,F,I.stencilModeFor3D(),I.colorModeForRenderPass()),I.resetStencilClippingMasks();else{const N=I.colorModeForRenderPass();ls(I,y,M,C,F,x.StencilMode.disabled,N)}}},hillshade:function(I,y,M,C){if(I.renderPass!=="offscreen"&&I.renderPass!=="translucent")return;const L=I.context,F=I.depthModeForSublayer(0,x.DepthMode.ReadOnly),N=I.colorModeForRenderPass(),q=I.terrain&&I.terrain.renderingToTexture,[W,J]=I.renderPass!=="translucent"||q?[{},C]:I.stencilConfigForOverlap(C);for(const ee of J){const ne=y.getTile(ee);if(ne.needsHillshadePrepare&&I.renderPass==="offscreen")es(I,ne,M,F,x.StencilMode.disabled,N);else if(I.renderPass==="translucent"){const fe=q&&I.terrain?I.terrain.stencilModeForRTTOverlap(ee):W[ee.overscaledZ];$s(I,ee,ne,M,F,fe,N)}}L.viewport.set([0,0,I.width,I.height]),I.resetStencilClippingMasks()},raster:function(I,y,M,C,L,F){if(I.renderPass!=="translucent"||M.paint.get("raster-opacity")===0||!C.length)return;const N=I.context,q=N.gl,W=y.getSource(),J=I.useProgram("raster"),ee=I.colorModeForRenderPass(),ne=I.terrain&&I.terrain.renderingToTexture,[fe,we]=W instanceof Mr||ne?[{},C]:I.stencilConfigForOverlap(C),ye=we[we.length-1].overscaledZ,Ee=!I.options.moving;for(const ze of we){const be=ne?x.DepthMode.disabled:I.depthModeForSublayer(ze.overscaledZ-ye,M.paint.get("raster-opacity")===1?x.DepthMode.ReadWrite:x.DepthMode.ReadOnly,q.LESS),Ce=ze.toUnwrapped(),Pe=y.getTile(ze);if(ne&&(!Pe||!Pe.hasData()))continue;const Ie=ne?ze.projMatrix:I.transform.calculateProjMatrix(Ce,Ee),ke=I.terrain&&ne?I.terrain.stencilModeForRTTOverlap(ze):fe[ze.overscaledZ],Fe=F?0:M.paint.get("raster-fade-duration");Pe.registerFadeDuration(Fe);const Ye=y.findLoadedParent(ze,0),Ke=Ol(Pe,Ye,y,I.transform,Fe);let yt,dt;I.terrain&&I.terrain.prepareDrawTile(ze);const ut=M.paint.get("raster-resampling")==="nearest"?q.NEAREST:q.LINEAR;N.activeTexture.set(q.TEXTURE0),Pe.texture.bind(ut,q.CLAMP_TO_EDGE),N.activeTexture.set(q.TEXTURE1),Ye?(Ye.texture.bind(ut,q.CLAMP_TO_EDGE),yt=Math.pow(2,Ye.tileID.overscaledZ-Pe.tileID.overscaledZ),dt=[Pe.tileID.canonical.x*yt%1,Pe.tileID.canonical.y*yt%1]):Pe.texture.bind(ut,q.CLAMP_TO_EDGE);const tt=Vs(Ie,dt||[0,0],yt||1,Ke,M,W instanceof Mr?W.perspectiveTransform:[0,0]);if(I.prepareDrawProgram(N,J,Ce),W instanceof Mr)J.draw(N,q.TRIANGLES,be,x.StencilMode.disabled,ee,x.CullFaceMode.disabled,tt,M.id,W.boundsBuffer,I.quadTriangleIndexBuffer,W.boundsSegments);else{const{tileBoundsBuffer:We,tileBoundsIndexBuffer:ct,tileBoundsSegments:ot}=I.getTileBoundsBuffers(Pe);J.draw(N,q.TRIANGLES,be,ke,ee,x.CullFaceMode.disabled,tt,M.id,We,ct,ot)}}I.resetStencilClippingMasks()},background:function(I,y,M,C){const L=M.paint.get("background-color"),F=M.paint.get("background-opacity");if(F===0)return;const N=I.context,q=N.gl,W=I.transform,J=W.tileSize,ee=M.paint.get("background-pattern");if(I.isPatternMissing(ee))return;const ne=!ee&&L.a===1&&F===1&&I.opaquePassEnabledForLayer()?"opaque":"translucent";if(I.renderPass!==ne)return;const fe=x.StencilMode.disabled,we=I.depthModeForSublayer(0,ne==="opaque"?x.DepthMode.ReadWrite:x.DepthMode.ReadOnly),ye=I.colorModeForRenderPass(),Ee=I.useProgram(ee?"backgroundPattern":"background");let ze,be=C;be||(ze=I.getBackgroundTiles(),be=Object.values(ze).map(Pe=>Pe.tileID)),ee&&(N.activeTexture.set(q.TEXTURE0),I.imageManager.bind(I.context));const Ce=M.getCrossfadeParameters();for(const Pe of be){const Ie=Pe.toUnwrapped(),ke=C?Pe.projMatrix:I.transform.calculateProjMatrix(Ie);I.prepareDrawTile(Pe);const Fe=y?y.getTile(Pe):ze?ze[Pe.key]:new x.Tile(Pe,J,W.zoom,I),Ye=ee?qs(ke,F,I,ee,{tileID:Pe,tileSize:J},Ce):ji(ke,F,L);I.prepareDrawProgram(N,Ee,Ie);const{tileBoundsBuffer:Ke,tileBoundsIndexBuffer:yt,tileBoundsSegments:dt}=I.getTileBoundsBuffers(Fe);Ee.draw(N,q.TRIANGLES,we,fe,ye,x.CullFaceMode.disabled,Ye,M.id,Ke,yt,dt)}},sky:function(I,y,M){const C=I.transform,L=C.projection.name==="mercator"||C.projection.name==="globe"?1:x.smoothstep(7,8,C.zoom),F=M.paint.get("sky-opacity")*L;if(F===0)return;const N=I.context,q=M.paint.get("sky-type"),W=new x.DepthMode(N.gl.LEQUAL,x.DepthMode.ReadOnly,[0,1]),J=I.frameCounter/1e3%1;q==="atmosphere"?I.renderPass==="offscreen"?M.needsSkyboxCapture(I)&&(function(ee,ne,fe,we){const ye=ee.context,Ee=ye.gl;let ze=ne.skyboxFbo;if(!ze){ze=ne.skyboxFbo=ye.createFramebuffer(32,32,!1),ne.skyboxGeometry=new Js(ye),ne.skyboxTexture=ye.gl.createTexture(),Ee.bindTexture(Ee.TEXTURE_CUBE_MAP,ne.skyboxTexture),Ee.texParameteri(Ee.TEXTURE_CUBE_MAP,Ee.TEXTURE_WRAP_S,Ee.CLAMP_TO_EDGE),Ee.texParameteri(Ee.TEXTURE_CUBE_MAP,Ee.TEXTURE_WRAP_T,Ee.CLAMP_TO_EDGE),Ee.texParameteri(Ee.TEXTURE_CUBE_MAP,Ee.TEXTURE_MIN_FILTER,Ee.LINEAR),Ee.texParameteri(Ee.TEXTURE_CUBE_MAP,Ee.TEXTURE_MAG_FILTER,Ee.LINEAR);for(let Ie=0;Ie<6;++Ie)Ee.texImage2D(Ee.TEXTURE_CUBE_MAP_POSITIVE_X+Ie,0,Ee.RGBA,32,32,0,Ee.RGBA,Ee.UNSIGNED_BYTE,null)}ye.bindFramebuffer.set(ze.framebuffer),ye.viewport.set([0,0,32,32]);const be=ne.getCenter(ee,!0),Ce=ee.useProgram("skyboxCapture"),Pe=new Float64Array(16);x.identity(Pe),x.rotateY(Pe,Pe,.5*-Math.PI),Kn(ye,ne,Ce,Pe,be,0),x.identity(Pe),x.rotateY(Pe,Pe,.5*Math.PI),Kn(ye,ne,Ce,Pe,be,1),x.identity(Pe),x.rotateX(Pe,Pe,.5*-Math.PI),Kn(ye,ne,Ce,Pe,be,2),x.identity(Pe),x.rotateX(Pe,Pe,.5*Math.PI),Kn(ye,ne,Ce,Pe,be,3),x.identity(Pe),Kn(ye,ne,Ce,Pe,be,4),x.identity(Pe),x.rotateY(Pe,Pe,Math.PI),Kn(ye,ne,Ce,Pe,be,5),ye.viewport.set([0,0,ee.width,ee.height])}(I,M),M.markSkyboxValid(I)):I.renderPass==="sky"&&function(ee,ne,fe,we,ye){const Ee=ee.context,ze=Ee.gl,be=ee.transform,Ce=ee.useProgram("skybox");Ee.activeTexture.set(ze.TEXTURE0),ze.bindTexture(ze.TEXTURE_CUBE_MAP,ne.skyboxTexture);const Pe=((Ie,ke,Fe,Ye,Ke)=>({u_matrix:Ie,u_sun_direction:ke,u_cubemap:0,u_opacity:Ye,u_temporal_offset:Ke}))(be.skyboxMatrix,ne.getCenter(ee,!1),0,we,ye);ee.prepareDrawProgram(Ee,Ce),Ce.draw(Ee,ze.TRIANGLES,fe,x.StencilMode.disabled,ee.colorModeForRenderPass(),x.CullFaceMode.backCW,Pe,"skybox",ne.skyboxGeometry.vertexBuffer,ne.skyboxGeometry.indexBuffer,ne.skyboxGeometry.segment)}(I,M,W,F,J):q==="gradient"&&I.renderPass==="sky"&&function(ee,ne,fe,we,ye){const Ee=ee.context,ze=Ee.gl,be=ee.transform,Ce=ee.useProgram("skyboxGradient");ne.skyboxGeometry||(ne.skyboxGeometry=new Js(Ee)),Ee.activeTexture.set(ze.TEXTURE0);let Pe=ne.colorRampTexture;Pe||(Pe=ne.colorRampTexture=new x.Texture(Ee,ne.colorRamp,ze.RGBA)),Pe.bind(ze.LINEAR,ze.CLAMP_TO_EDGE);const Ie=((ke,Fe,Ye,Ke,yt)=>({u_matrix:ke,u_color_ramp:0,u_center_direction:Fe,u_radius:x.degToRad(Ye),u_opacity:Ke,u_temporal_offset:yt}))(be.skyboxMatrix,ne.getCenter(ee,!1),ne.paint.get("sky-gradient-radius"),we,ye);ee.prepareDrawProgram(Ee,Ce),Ce.draw(Ee,ze.TRIANGLES,fe,x.StencilMode.disabled,ee.colorModeForRenderPass(),x.CullFaceMode.backCW,Ie,"skyboxGradient",ne.skyboxGeometry.vertexBuffer,ne.skyboxGeometry.indexBuffer,ne.skyboxGeometry.segment)}(I,M,W,F,J)},debug:function(I,y,M){for(let C=0;C<M.length;C++)Ks(I,y,M[C])},custom:function(I,y,M){const C=I.context,L=M.implementation;if(I.transform.projection.unsupportedLayers&&I.transform.projection.unsupportedLayers.includes("custom"))x.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.");else if(I.renderPass==="offscreen"){const F=L.prerender;F&&(I.setCustomLayerDefaults(),C.setColorMode(I.colorModeForRenderPass()),F.call(L,C.gl,I.transform.customLayerMatrix()),C.setDirty(),I.setBaseState())}else if(I.renderPass==="translucent"){I.setCustomLayerDefaults(),C.setColorMode(I.colorModeForRenderPass()),C.setStencilMode(x.StencilMode.disabled);const F=L.renderingMode==="3d"?new x.DepthMode(I.context.gl.LEQUAL,x.DepthMode.ReadWrite,I.depthRangeFor3D):I.depthModeForSublayer(0,x.DepthMode.ReadOnly);C.setDepthMode(F),L.render(C.gl,I.transform.customLayerMatrix()),C.setDirty(),I.setBaseState(),C.bindFramebuffer.set(null)}}};class Jl{constructor(y,M){this.context=new dr(y),this.transform=M,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=x.SourceCache.maxUnderzooming+x.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Jo,this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={}}updateTerrain(y,M){const C=!!y&&!!y.terrain&&this.transform.projection.supportsTerrain;if(!(C||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Wn(this,y));const L=this._terrain;this.transform.elevation=C?L:null,L.update(y,this.transform,M)}_updateFog(y){const M=y.fog;if(!M||M.getOpacity(this.transform.pitch)<1||M.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[C,L]=M.getFovAdjustedRange(this.transform._fov);if(C>L)return void(this.transform.fogCullDistSq=null);const F=C+.78*(L-C);this.transform.fogCullDistSq=F*F}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(y,M){if(this.width=y*x.exported.devicePixelRatio,this.height=M*x.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const C of this.style.order)this.style._layers[C].resize()}setup(){const y=this.context,M=new x.StructArrayLayout2i4;M.emplaceBack(0,0),M.emplaceBack(x.EXTENT,0),M.emplaceBack(0,x.EXTENT),M.emplaceBack(x.EXTENT,x.EXTENT),this.tileExtentBuffer=y.createVertexBuffer(M,x.posAttributes.members),this.tileExtentSegments=x.SegmentVector.simpleSegment(0,0,4,2);const C=new x.StructArrayLayout2i4;C.emplaceBack(0,0),C.emplaceBack(x.EXTENT,0),C.emplaceBack(0,x.EXTENT),C.emplaceBack(x.EXTENT,x.EXTENT),this.debugBuffer=y.createVertexBuffer(C,x.posAttributes.members),this.debugSegments=x.SegmentVector.simpleSegment(0,0,4,5);const L=new x.StructArrayLayout2i4;L.emplaceBack(-1,-1),L.emplaceBack(1,-1),L.emplaceBack(-1,1),L.emplaceBack(1,1),this.viewportBuffer=y.createVertexBuffer(L,x.posAttributes.members),this.viewportSegments=x.SegmentVector.simpleSegment(0,0,4,2);const F=new x.StructArrayLayout4i8;F.emplaceBack(0,0,0,0),F.emplaceBack(x.EXTENT,0,x.EXTENT,0),F.emplaceBack(0,x.EXTENT,0,x.EXTENT),F.emplaceBack(x.EXTENT,x.EXTENT,x.EXTENT,x.EXTENT),this.mercatorBoundsBuffer=y.createVertexBuffer(F,x.boundsAttributes.members),this.mercatorBoundsSegments=x.SegmentVector.simpleSegment(0,0,4,2);const N=new x.StructArrayLayout3ui6;N.emplaceBack(0,1,2),N.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=y.createIndexBuffer(N);const q=new x.StructArrayLayout1ui2;for(const J of[0,1,3,2,0])q.emplaceBack(J);this.debugIndexBuffer=y.createIndexBuffer(q),this.emptyTexture=new x.Texture(y,{width:1,height:1,data:new Uint8Array([0,0,0,0])},y.gl.RGBA),this.identityMat=x.create();const W=this.context.gl;this.stencilClearMode=new x.StencilMode({func:W.ALWAYS,mask:0},0,255,W.ZERO,W.ZERO,W.ZERO),this.loadTimeStamps.push(x.window.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(y){return y._makeTileBoundsBuffers(this.context,this.transform.projection),y._tileBoundsBuffer?{tileBoundsBuffer:y._tileBoundsBuffer,tileBoundsIndexBuffer:y._tileBoundsIndexBuffer,tileBoundsSegments:y._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const y=this.context,M=y.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(y,M.TRIANGLES,x.DepthMode.disabled,this.stencilClearMode,x.ColorMode.disabled,x.CullFaceMode.disabled,In(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(y,M,C){if(!M||this.currentStencilSource===M.id||!y.isTileClipped()||!C||C.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let q=!1;for(const W of C)if(this._tileClippingMaskIDs[W.key]===void 0){q=!0;break}if(!q)return}this.currentStencilSource=M.id;const L=this.context,F=L.gl;this.nextStencilID+C.length>256&&this.clearStencil(),L.setColorMode(x.ColorMode.disabled),L.setDepthMode(x.DepthMode.disabled);const N=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const q of C){const W=M.getTile(q),J=this._tileClippingMaskIDs[q.key]=this.nextStencilID++,{tileBoundsBuffer:ee,tileBoundsIndexBuffer:ne,tileBoundsSegments:fe}=this.getTileBoundsBuffers(W);N.draw(L,F.TRIANGLES,x.DepthMode.disabled,new x.StencilMode({func:F.ALWAYS,mask:0},J,255,F.KEEP,F.KEEP,F.REPLACE),x.ColorMode.disabled,x.CullFaceMode.disabled,In(q.projMatrix),"$clipping",ee,ne,fe)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const y=this.nextStencilID++,M=this.context.gl;return new x.StencilMode({func:M.NOTEQUAL,mask:255},y,255,M.KEEP,M.KEEP,M.REPLACE)}stencilModeForClipping(y){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(y);const M=this.context.gl;return new x.StencilMode({func:M.EQUAL,mask:255},this._tileClippingMaskIDs[y.key],0,M.KEEP,M.KEEP,M.REPLACE)}stencilConfigForOverlap(y){const M=this.context.gl,C=y.sort((N,q)=>q.overscaledZ-N.overscaledZ),L=C[C.length-1].overscaledZ,F=C[0].overscaledZ-L+1;if(F>1){this.currentStencilSource=void 0,this.nextStencilID+F>256&&this.clearStencil();const N={};for(let q=0;q<F;q++)N[q+L]=new x.StencilMode({func:M.GEQUAL,mask:255},q+this.nextStencilID,255,M.KEEP,M.KEEP,M.REPLACE);return this.nextStencilID+=F,[N,C]}return[{[L]:x.StencilMode.disabled},C]}colorModeForRenderPass(){const y=this.context.gl;return this._showOverdrawInspector?new x.ColorMode([y.CONSTANT_COLOR,y.ONE],new x.Color(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?x.ColorMode.unblended:x.ColorMode.alphaBlended}depthModeForSublayer(y,M,C){if(!this.opaquePassEnabledForLayer())return x.DepthMode.disabled;const L=1-((1+this.currentLayer)*this.numSublayers+y)*this.depthEpsilon;return new x.DepthMode(C||this.context.gl.LEQUAL,M,[L,L])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(y,M){this.style=y,this.options=M,this.lineAtlas=y.lineAtlas,this.imageManager=y.imageManager,this.glyphManager=y.glyphManager,this.symbolFadeChange=y.placement.symbolFadeChange(x.exported.now()),this.imageManager.beginFrame();const C=this.style.order,L=this.style._sourceCaches;for(const J in L){const ee=L[J];ee.used&&ee.prepare(this.context)}const F={},N={},q={};for(const J in L){const ee=L[J];F[J]=ee.getVisibleCoordinates(),N[J]=F[J].slice().reverse(),q[J]=ee.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let J=0;J<C.length;J++)if(this.style._layers[C[J]].is3D()){this.opaquePassCutoff=J;break}if(this.terrain&&(this.terrain.updateTileBinding(q),this.opaquePassCutoff=0),this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new x.GlobeSharedBuffers(this.context)),!x.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const J of C){const ee=this.style._layers[J],ne=y._getLayerSourceCache(ee);if(!ee.hasOffscreenPass()||ee.isHidden(this.transform.zoom))continue;const fe=ne?N[ne.id]:void 0;(ee.type==="custom"||ee.isSky()||fe&&fe.length)&&this.renderLayer(this,ne,ee,fe)}this.depthRangeFor3D=[0,1-(y.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let W=x.Color.transparent;if(this.style.fog&&this.style.fog.getOpacity(this.transform.pitch)&&(W=this.style.fog.properties.get("color")),this.context.clear({color:M.showOverdrawInspector?x.Color.black:W,depth:1}),this.clearStencil(),this._showOverdrawInspector=M.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=C.length-1;this.currentLayer>=0;this.currentLayer--){const J=this.style._layers[C[this.currentLayer]],ee=y._getLayerSourceCache(J);if(J.isSky())continue;const ne=ee?N[ee.id]:void 0;this._renderTileClippingMasks(J,ee,ne),this.renderLayer(this,ee,J,ne)}if(this.renderPass="sky",(x.globeToMercatorTransition(this.transform.zoom)>0||this.transform.projection.name!=="globe")&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<C.length;this.currentLayer++){const J=this.style._layers[C[this.currentLayer]],ee=y._getLayerSourceCache(J);J.isSky()&&this.renderLayer(this,ee,J,ee?N[ee.id]:void 0)}for(this.transform.projection.name==="globe"&&function(J){const ee=J.context,ne=ee.gl,fe=J.transform,we=new x.DepthMode(ne.LEQUAL,x.DepthMode.ReadOnly,[0,1]),ye=J.useProgram("globeAtmosphere"),Ee=fe._camera.getWorldToCamera(fe.worldSize,1),ze=fe._camera.getCameraToClipPerspective(fe._fov,fe.width/fe.height,fe._nearZ,fe._farZ),be=x.mul([],Ee,x.calculateGlobeMatrix(fe,fe.worldSize)),Ce=x.mul([],fe.labelPlaneMatrix,ze),Pe=x.transformMat4([],[0,0,0],be),Ie=x.add([],Pe,[fe.worldSize/Math.PI/2,0,0]),ke=x.transformMat4([],Pe,Ce),Fe=x.transformMat4([],Ie,Ce),Ye=x.length(x.sub([],Fe,ke)),Ke=1-x.globeToMercatorTransition(fe.zoom),yt={u_center:ke,u_radius:Ye,u_screen_size:[fe.width,fe.height],u_pixel_ratio:x.exported.devicePixelRatio,u_opacity:Ke,u_fadeout_range:2,u_start_color:[1,1,1],u_end_color:[.0118,.7451,.9882]};J.prepareDrawProgram(ee,ye);const dt=J.globeSharedBuffers;dt&&ye.draw(ee,ne.TRIANGLES,we,x.StencilMode.disabled,x.ColorMode.alphaBlended,x.CullFaceMode.backCW,yt,"skybox",dt.atmosphereVertexBuffer,dt.atmosphereIndexBuffer,dt.atmosphereSegments)}(this),this.renderPass="translucent",this.currentLayer=0;this.currentLayer<C.length;){const J=this.style._layers[C[this.currentLayer]],ee=y._getLayerSourceCache(J);if(J.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(J)){if(J.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const ne=ee?(J.type==="symbol"?q:N)[ee.id]:void 0;this._renderTileClippingMasks(J,ee,ee?F[ee.id]:void 0),this.renderLayer(this,ee,J,ne),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry){let J=null;x.values(this.style._layers).forEach(ee=>{const ne=y._getLayerSourceCache(ee);ne&&!ee.isHidden(this.transform.zoom)&&(!J||J.getSource().maxzoom<ne.getSource().maxzoom)&&(J=ne)}),J&&this.options.showTileBoundaries&&us.debug(this,J,J.getVisibleCoordinates())}this.options.showPadding&&function(J){const ee=J.transform.padding;Xr(J,J.transform.height-(ee.top||0),3,Wl),Xr(J,ee.bottom||0,3,lc),Ws(J,ee.left||0,3,hs),Ws(J,J.transform.width-(ee.right||0),3,cs);const ne=J.transform.centerPoint;(function(fe,we,ye,Ee){co(fe,we-1,ye-10,2,20,Ee),co(fe,we-10,ye-1,20,2,Ee)})(J,ne.x,J.transform.height-ne.y,Kl)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(x.window.performance.now()),this.saveCanvasCopy())}renderLayer(y,M,C,L){C.isHidden(this.transform.zoom)||(C.type==="background"||C.type==="sky"||C.type==="custom"||L&&L.length)&&(this.id=C.id,this.gpuTimingStart(C),y.transform.projection.unsupportedLayers&&y.transform.projection.unsupportedLayers.includes(C.type)||us[C.type](y,M,C,L,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(y){if(!this.options.gpuTiming)return;const M=this.context.extTimerQuery;let C=this.gpuTimers[y.id];C||(C=this.gpuTimers[y.id]={calls:0,cpuTime:0,query:M.createQueryEXT()}),C.calls++,M.beginQueryEXT(M.TIME_ELAPSED_EXT,C.query)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const y=this.context.extTimerQuery;y.endQueryEXT(y.TIME_ELAPSED_EXT)}collectGpuTimers(){const y=this.gpuTimers;return this.gpuTimers={},y}queryGpuTimers(y){const M={};for(const C in y){const L=y[C],F=this.context.extTimerQuery,N=F.getQueryObjectEXT(L.query,F.QUERY_RESULT_EXT)/1e6;F.deleteQueryEXT(L.query),M[C]=N}return M}translatePosMatrix(y,M,C,L,F){if(!C[0]&&!C[1])return y;const N=F?L==="map"?this.transform.angle:0:L==="viewport"?-this.transform.angle:0;if(N){const J=Math.sin(N),ee=Math.cos(N);C=[C[0]*ee-C[1]*J,C[0]*J+C[1]*ee]}const q=[F?C[0]:Bt(M,C[0],this.transform.zoom),F?C[1]:Bt(M,C[1],this.transform.zoom),0],W=new Float32Array(16);return x.translate(W,y,q),W}saveTileTexture(y){const M=this._tileTextures[y.size[0]];M?M.push(y):this._tileTextures[y.size[0]]=[y]}getTileTexture(y){const M=this._tileTextures[y];return M&&M.length>0?M.pop():null}isPatternMissing(y){if(!y)return!1;if(!y.from||!y.to)return!0;const M=this.imageManager.getPattern(y.from.toString()),C=this.imageManager.getPattern(y.to.toString());return!M||!C}currentGlobalDefines(){const y=this.terrain&&this.terrain.renderingToTexture,M=this.style&&this.style.fog,C=[];return this.terrain&&!this.terrain.renderingToTexture&&C.push("TERRAIN"),M&&!y&&M.getOpacity(this.transform.pitch)!==0&&C.push("FOG"),y&&C.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&C.push("OVERDRAW_INSPECTOR"),C}useProgram(y,M,C){this.cache=this.cache||{};const L=C||[],F=this.currentGlobalDefines().concat(L),N=is.cacheKey(y,F,M);return this.cache[N]||(this.cache[N]=new is(this.context,y,za[y],M,Xl[y],F)),this.cache[N]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const y=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(y.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=x.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new x.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}prepareDrawTile(y){this.terrain&&this.terrain.prepareDrawTile(y)}prepareDrawProgram(y,M,C){if(this.terrain&&this.terrain.renderingToTexture)return;const L=this.style.fog;if(L){const F=L.getOpacity(this.transform.pitch);F!==0&&M.setFogUniformValues(y,((N,q,W,J)=>{const ee=q.properties.get("color"),ne=N.frameCounter/1e3%1,fe=[ee.r/ee.a,ee.g/ee.a,ee.b/ee.a,J];return{u_fog_matrix:W?N.transform.calculateFogTileMatrix(W):N.identityMat,u_fog_range:q.getFovAdjustedRange(N.transform._fov),u_fog_color:fe,u_fog_horizon_blend:q.properties.get("horizon-blend"),u_fog_temporal_offset:ne}})(this,L,C,F))}}setTileLoadedFlag(y){this.tileLoaded=y}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1}canvasCopy(){const y=this.context.gl,M=y.createTexture();return y.bindTexture(y.TEXTURE_2D,M),y.copyTexImage2D(y.TEXTURE_2D,0,y.RGBA,0,0,y.drawingBufferWidth,y.drawingBufferHeight,0),M}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const y=this.style&&this.style.fog;return!!y&&y.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const y=this._backgroundTiles,M=this._backgroundTiles={},C=this.transform.coveringTiles({tileSize:512});for(const L of C)M[L.key]=y[L.key]||new x.Tile(L,512,this.transform.tileZoom,this);return M}clearBackgroundTiles(){this._backgroundTiles={}}}class Qs{constructor(y=0,M=0,C=0,L=0){if(isNaN(y)||y<0||isNaN(M)||M<0||isNaN(C)||C<0||isNaN(L)||L<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=y,this.bottom=M,this.left=C,this.right=L}interpolate(y,M,C){return M.top!=null&&y.top!=null&&(this.top=x.number(y.top,M.top,C)),M.bottom!=null&&y.bottom!=null&&(this.bottom=x.number(y.bottom,M.bottom,C)),M.left!=null&&y.left!=null&&(this.left=x.number(y.left,M.left,C)),M.right!=null&&y.right!=null&&(this.right=x.number(y.right,M.right,C)),this}getCenter(y,M){const C=x.clamp((this.left+y-this.right)/2,0,y),L=x.clamp((this.top+M-this.bottom)/2,0,M);return new x.pointGeometry(C,L)}equals(y){return this.top===y.top&&this.bottom===y.bottom&&this.left===y.left&&this.right===y.right}clone(){return new Qs(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Jn(I,y){const M=x.getColumn(I,3);x.fromQuat(I,y),x.setColumn(I,3,M)}function Ql(I,y){x.setColumn(I,3,[y[0],y[1],y[2],1])}function Ga(I,y){const M=x.identity$1([]);return x.rotateZ$1(M,M,-y),x.rotateX$1(M,M,-I),M}function qa(I,y){const M=[I[0],I[1],0],C=[y[0],y[1],0];if(x.length(M)>=1e-15){const N=x.normalize([],M);x.scale$2(C,N,x.dot(C,N)),y[0]=C[0],y[1]=C[1]}const L=x.cross([],y,I);if(x.len(L)<1e-15)return null;const F=Math.atan2(-L[1],L[0]);return Ga(Math.atan2(Math.sqrt(I[0]*I[0]+I[1]*I[1]),-I[2]),F)}class eh{constructor(y,M){this.position=y,this.orientation=M}get position(){return this._position}set position(y){this._position=this._renderWorldCopies?function(M){if(!M)return;const C=Array.isArray(M)?new x.MercatorCoordinate(M[0],M[1],M[2]):M;return C.x=x.wrap(C.x,0,1),C}(y):y}lookAtPoint(y,M){if(this.orientation=null,!this.position)return;const C=this._elevation?this._elevation.getAtPointOrZero(x.MercatorCoordinate.fromLngLat(y)):0,L=this.position,F=x.MercatorCoordinate.fromLngLat(y,C),N=[F.x-L.x,F.y-L.y,F.z-L.z];M||(M=[0,0,1]),M[2]=Math.abs(M[2]),this.orientation=qa(N,M)}setPitchBearing(y,M){this.orientation=Ga(x.degToRad(y),x.degToRad(-M))}}class Za{constructor(y,M){this._transform=x.identity([]),this._orientation=x.identity$1([]),M&&(this._orientation=M,Jn(this._transform,this._orientation)),y&&Ql(this._transform,y)}get mercatorPosition(){const y=this.position;return new x.MercatorCoordinate(y[0],y[1],y[2])}get position(){const y=x.getColumn(this._transform,3);return[y[0],y[1],y[2]]}set position(y){Ql(this._transform,y)}get orientation(){return this._orientation}set orientation(y){this._orientation=y,Jn(this._transform,this._orientation)}getPitchBearing(){const y=this.forward(),M=this.right();return{bearing:Math.atan2(-M[1],M[0]),pitch:Math.atan2(Math.sqrt(y[0]*y[0]+y[1]*y[1]),-y[2])}}setPitchBearing(y,M){this._orientation=Ga(y,M),Jn(this._transform,this._orientation)}forward(){const y=x.getColumn(this._transform,2);return[-y[0],-y[1],-y[2]]}up(){const y=x.getColumn(this._transform,1);return[-y[0],-y[1],-y[2]]}right(){const y=x.getColumn(this._transform,0);return[y[0],y[1],y[2]]}getCameraToWorld(y,M){const C=new Float64Array(16);return x.invert(C,this.getWorldToCamera(y,M)),C}getWorldToCameraPosition(y,M,C){const L=this.position;x.scale$2(L,L,-y);const F=new Float64Array(16);return x.fromScaling(F,[C,C,C]),x.translate(F,F,L),F[10]*=M,F}getWorldToCamera(y,M){const C=new Float64Array(16),L=new Float64Array(4),F=this.position;return x.conjugate(L,this._orientation),x.scale$2(F,F,-y),x.fromQuat(C,L),x.translate(C,C,F),C[1]*=-1,C[5]*=-1,C[9]*=-1,C[13]*=-1,C[8]*=M,C[9]*=M,C[10]*=M,C[11]*=M,C}getCameraToClipPerspective(y,M,C,L){const F=new Float64Array(16);return x.perspective(F,y,M,C,L),F}getDistanceToElevation(y){const M=y===0?0:x.mercatorZfromAltitude(y,this.position[1]),C=this.forward();return(M-this.position[2])/C[2]}clone(){return new Za([...this.position],[...this.orientation])}}function th(I,y){const M=ta(I),C=function(F,N,q,W,J){const ee=new x.LngLat(q.lng-180*_n,q.lat),ne=new x.LngLat(q.lng+180*_n,q.lat),fe=F.project(ee.lng,ee.lat),we=F.project(ne.lng,ne.lat),ye=-Math.atan2(we.y-fe.y,we.x-fe.x),Ee=x.MercatorCoordinate.fromLngLat(q);Ee.y=x.clamp(Ee.y,-.999975,.999975);const ze=Ee.toLngLat(),be=F.project(ze.lng,ze.lat),Ce=x.MercatorCoordinate.fromLngLat(ze);Ce.x+=_n;const Pe=Ce.toLngLat(),Ie=F.project(Pe.lng,Pe.lat),ke=Ya(Ie.x-be.x,Ie.y-be.y,ye),Fe=x.MercatorCoordinate.fromLngLat(ze);Fe.y+=_n;const Ye=Fe.toLngLat(),Ke=F.project(Ye.lng,Ye.lat),yt=Ya(Ke.x-be.x,Ke.y-be.y,ye),dt=Math.abs(ke.x)/Math.abs(yt.y),ut=x.identity([]);x.rotateZ(ut,ut,-ye*(1-(J?0:W)));const tt=x.identity([]);return x.scale(tt,tt,[1,1-(1-dt)*W,1]),tt[4]=-yt.x/yt.y*W,x.rotateZ(tt,tt,ye),x.multiply$1(tt,ut,tt),tt}(I.projection,0,I.center,M,y),L=ea(I);return x.scale(C,C,[L,L,1]),C}function ea(I){const y=I.projection,M=ta(I),C=Xa(y,I.center),L=Xa(y,x.LngLat.convert(y.center));return Math.pow(2,C*M+(1-M)*L)}function ta(I){const y=I.projection.range;if(!y)return 0;const M=Math.max(I.width,I.height),C=Math.log(M/1024)/Math.LN2;return x.smoothstep(y[0]+C,y[1]+C,I.zoom)}const _n=1/4e4;function Xa(I,y){const M=x.clamp(y.lat,-x.MAX_MERCATOR_LATITUDE,x.MAX_MERCATOR_LATITUDE),C=new x.LngLat(y.lng-180*_n,M),L=new x.LngLat(y.lng+180*_n,M),F=I.project(C.lng,M),N=I.project(L.lng,M),q=x.MercatorCoordinate.fromLngLat(C),W=x.MercatorCoordinate.fromLngLat(L),J=N.x-F.x,ee=N.y-F.y,ne=W.x-q.x,fe=W.y-q.y,we=Math.sqrt((ne*ne+fe*fe)/(J*J+ee*ee));return Math.log(we)/Math.LN2}function Ya(I,y,M){const C=Math.cos(M),L=Math.sin(M);return{x:I*C-y*L,y:I*L+y*C}}class ds{constructor(y,M,C,L,F){this.tileSize=512,this._renderWorldCopies=F===void 0||F,this._minZoom=y||0,this._maxZoom=M||22,this._minPitch=C==null?0:C,this._maxPitch=L==null?60:L,this.setProjection(),this.setMaxBounds(),this.width=0,this.height=0,this._center=new x.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Qs,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new Za,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._projectionScaler=1,this._horizonShift=.1}clone(){const y=new ds(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return y.setProjection(this.getProjection()),y._elevation=this._elevation,y._centerAltitude=this._centerAltitude,y.tileSize=this.tileSize,y.setMaxBounds(this.getMaxBounds()),y.width=this.width,y.height=this.height,y.cameraElevationReference=this.cameraElevationReference,y._center=this._center,y._setZoom(this.zoom),y._cameraZoom=this._cameraZoom,y.angle=this.angle,y._fov=this._fov,y._pitch=this._pitch,y._nearZ=this._nearZ,y._farZ=this._farZ,y._averageElevation=this._averageElevation,y._unmodified=this._unmodified,y._edgeInsets=this._edgeInsets.clone(),y._camera=this._camera.clone(),y._calcMatrices(),y.freezeTileCoverage=this.freezeTileCoverage,y}get elevation(){return this._elevation}set elevation(y){this._elevation!==y&&(this._elevation=y,y?this._updateCenterElevation()&&this._updateCameraOnTerrain():(this._cameraZoom=null,this._centerAltitude=0),this._calcMatrices())}updateElevation(y){this._terrainEnabled()&&this._cameraZoom==null&&this._updateCenterElevation()&&this._updateCameraOnTerrain(),y&&this._constrainCameraAltitude(),this._calcMatrices()}getProjection(){return x.pick(this.projection,["name","center","parallels"])}setProjection(y){y==null&&(y={name:"mercator"}),this.projectionOptions=y;const M=this.projection?this.getProjection():void 0;return this.projection=x.getProjection(y),!G(M,this.getProjection())&&(this._calcMatrices(),!0)}get minZoom(){return this._minZoom}set minZoom(y){this._minZoom!==y&&(this._minZoom=y,this.zoom=Math.max(this.zoom,y))}get maxZoom(){return this._maxZoom}set maxZoom(y){this._maxZoom!==y&&(this._maxZoom=y,this.zoom=Math.min(this.zoom,y))}get minPitch(){return this._minPitch}set minPitch(y){this._minPitch!==y&&(this._minPitch=y,this.pitch=Math.max(this.pitch,y))}get maxPitch(){return this._maxPitch}set maxPitch(y){this._maxPitch!==y&&(this._maxPitch=y,this.pitch=Math.min(this.pitch,y))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(y){y===void 0?y=!0:y===null&&(y=!1),this._renderWorldCopies=y}get worldSize(){return this.tileSize*this.scale}get cameraWorldSize(){const y=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(y))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.cameraWorldSize)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new x.pointGeometry(this.width,this.height)}get bearing(){return x.wrap(this.rotation,-180,180)}set bearing(y){this.rotation=y}get rotation(){return-this.angle/Math.PI*180}set rotation(y){const M=-y*Math.PI/180;var C;this.angle!==M&&(this._unmodified=!1,this.angle=M,this._calcMatrices(),this.rotationMatrix=(C=new x.ARRAY_TYPE(4),x.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0),C[0]=1,C[3]=1,C),function(L,F,N){var q=F[0],W=F[1],J=F[2],ee=F[3],ne=Math.sin(N),fe=Math.cos(N);L[0]=q*fe+J*ne,L[1]=W*fe+ee*ne,L[2]=q*-ne+J*fe,L[3]=W*-ne+ee*fe}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(y){const M=x.clamp(y,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==M&&(this._unmodified=!1,this._pitch=M,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(y){y=Math.max(.01,Math.min(60,y)),this._fov!==y&&(this._unmodified=!1,this._fov=y/180*Math.PI,this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(y){this._averageElevation=y,this._calcFogMatrices()}get zoom(){return this._zoom}set zoom(y){const M=Math.min(Math.max(y,this.minZoom),this.maxZoom);this._zoom!==M&&(this._unmodified=!1,this._setZoom(M),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._constrain(),this._calcMatrices())}_setZoom(y){this._zoom=y,this.scale=this.zoomScale(y),this.tileZoom=Math.floor(y),this.zoomFraction=y-this.tileZoom}_updateCenterElevation(){if(!this._elevation)return!1;const y=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center),-1);return y===-1?(this._cameraZoom=null,!1):(this._centerAltitude=y,!0)}_updateCameraOnTerrain(){this._cameraZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize)}sampleAverageElevation(){if(!this._elevation)return 0;const y=this._elevation,M=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],C=this.horizonLineFromTop();let L=0,F=0;for(let N=0;N<M.length;N++){const q=new x.pointGeometry(M[N][0]*this.width,C+M[N][1]*(this.height-C)),W=y.pointCoordinate(q);if(!W)continue;const J=1/Math.hypot(W[0]-this._camera.position[0],W[1]-this._camera.position[1]);L+=W[3]*J,F+=J}return F===0?NaN:L/F}get center(){return this._center}set center(y){y.lat===this._center.lat&&y.lng===this._center.lng||(this._unmodified=!1,this._center=y,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCenterElevation()?this._updateCameraOnTerrain():this._cameraZoom=null:this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._cameraZoom==null||!this._elevation)return;const y=this._cameraZoom,M=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),C=this.pixelsPerMeter/this.worldSize*M,L=this._mercatorZfromZoom(y),F=this._mercatorZfromZoom(this._maxZoom),N=Math.max(L-C,F);this._setZoom(this._zoomFromMercatorZ(N))}get padding(){return this._edgeInsets.toJSON()}set padding(y){this._edgeInsets.equals(y)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,y,1),this._calcMatrices())}computeZoomRelativeTo(y){const M=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,y.toAltitude()));let C;C=y.z<this._camera.position[2]?[M.x,M.y,M.z]:[y.x,y.y,y.z];const L=x.length(x.sub([],this._camera.position,C));return x.clamp(this._zoomFromMercatorZ(L),this._minZoom,this._maxZoom)}setFreeCameraOptions(y){if(!this.height||!y.position&&!y.orientation)return;this._updateCameraState();let M=!1;if(y.orientation&&!x.exactEquals(y.orientation,this._camera.orientation)&&(M=this._setCameraOrientation(y.orientation)),y.position){const C=[y.position.x,y.position.y,y.position.z];x.exactEquals$1(C,this._camera.position)||(this._setCameraPosition(C),M=!0)}M&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const y=this._camera.position,M=new eh;return M.position=new x.MercatorCoordinate(y[0],y[1],y[2]),M.orientation=this._camera.orientation,M._elevation=this.elevation,M._renderWorldCopies=this.renderWorldCopies,M}_setCameraOrientation(y){if(!x.length$1(y))return!1;x.normalize$1(y,y);const M=x.transformQuat([],[0,0,-1],y),C=x.transformQuat([],[0,-1,0],y);if(C[2]<0)return!1;const L=qa(M,C);return!!L&&(this._camera.orientation=L,!0)}_setCameraPosition(y){const M=this.zoomScale(this.minZoom)*this.tileSize,C=this.zoomScale(this.maxZoom)*this.tileSize,L=this.cameraToCenterDistance;y[2]=x.clamp(y[2],L/C,L/M),this._camera.position=y}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(y){return this._edgeInsets.equals(y)}interpolatePadding(y,M,C){this._unmodified=!1,this._edgeInsets.interpolate(y,M,C),this._constrain(),this._calcMatrices()}coveringZoomLevel(y){const M=(y.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/y.tileSize));return Math.max(0,M)}getVisibleUnwrappedCoordinates(y){const M=[new x.UnwrappedTileID(0,y)];if(this.renderWorldCopies){const C=this.pointCoordinate(new x.pointGeometry(0,0)),L=this.pointCoordinate(new x.pointGeometry(this.width,0)),F=this.pointCoordinate(new x.pointGeometry(this.width,this.height)),N=this.pointCoordinate(new x.pointGeometry(0,this.height)),q=Math.floor(Math.min(C.x,L.x,F.x,N.x)),W=Math.floor(Math.max(C.x,L.x,F.x,N.x)),J=1;for(let ee=q-J;ee<=W+J;ee++)ee!==0&&M.push(new x.UnwrappedTileID(ee,y))}return M}coveringTiles(y){let M=this.coveringZoomLevel(y);const C=M,L=this.elevation&&!y.isTerrainDEM,F=this.projection.name==="mercator";if(y.minzoom!==void 0&&M<y.minzoom)return[];y.maxzoom!==void 0&&M>y.maxzoom&&(M=y.maxzoom);const N=this.locationCoordinate(this.center),q=1<<M,W=[q*N.x,q*N.y,0],J=x.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,M,this.projection.name!=="globe"),ee=this.pointCoordinate(this.getCameraPoint()),ne=q*x.mercatorZfromAltitude(1,this.center.lat),fe=this._camera.position[2]/x.mercatorZfromAltitude(1,this.center.lat),we=[q*ee.x,q*ee.y,fe],ye=this.cameraToCenterDistance/y.tileSize*(y.roundZoom?1:.502),Ee=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?M:0,ze=y.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,be=y.isTerrainDEM?-ze:this._elevation?this._elevation.getMinElevationBelowMSL():0,Ce=this.projection.isReprojectedInTileSpace?ea(this):1,Pe=We=>{const ot=new x.MercatorCoordinate(We.x+25e-6,We.y,We.z),Xt=new x.MercatorCoordinate(We.x,We.y+25e-6,We.z),ti=We.toLngLat(),vi=ot.toLngLat(),_t=Xt.toLngLat(),Kt=this.locationCoordinate(ti),ci=this.locationCoordinate(vi),qi=this.locationCoordinate(_t),Ji=Math.hypot(ci.x-Kt.x,ci.y-Kt.y),si=Math.hypot(qi.x-Kt.x,qi.y-Kt.y);return Math.sqrt(Ji*si)*Ce/25e-6},Ie=We=>{const ct=ze,ot=be;return{aabb:x.tileAABB(this,q,0,0,0,We,ot,ct,this.projection),zoom:0,x:0,y:0,minZ:ot,maxZ:ct,wrap:We,fullyVisible:!1}},ke=[];let Fe=[];const Ye=M,Ke=y.reparseOverscaled?C:M,yt=We=>We*We,dt=yt((fe-this._centerAltitude)*ne),ut=We=>{if(!this._elevation||!We.tileID||!F)return;const ct=this._elevation.getMinMaxForTile(We.tileID),ot=We.aabb;ct?(ot.min[2]=ct.min,ot.max[2]=ct.max,ot.center[2]=(ot.min[2]+ot.max[2])/2):(We.shouldSplit=tt(We),We.shouldSplit||(ot.min[2]=ot.max[2]=ot.center[2]=this._centerAltitude))},tt=We=>{if(We.zoom<Ee)return!0;if(We.zoom===Ye)return!1;if(We.shouldSplit!=null)return We.shouldSplit;const ct=We.aabb.distanceX(we),ot=We.aabb.distanceY(we);let Xt=dt;L&&(Xt=yt(We.aabb.distanceZ(we)*ne));let ti=1;if(this.projection.isReprojectedInTileSpace&&C<=5){const _t=Math.pow(2,We.zoom),Kt=Pe(new x.MercatorCoordinate((We.x+.5)/_t,(We.y+.5)/_t));ti=Kt>.85?1:Kt}const vi=ct*ct+ot*ot+Xt;return vi<yt((1<<Ye-We.zoom)*ye*ti*((_t,Kt)=>{if(Kt*yt(.707)<_t)return 1;const ci=Math.sqrt(Kt/_t);return ci/(1.4144271570014144+(Math.pow(1.1,ci-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(Xt,dt),vi))};if(this.renderWorldCopies)for(let We=1;We<=3;We++)ke.push(Ie(-We)),ke.push(Ie(We));for(ke.push(Ie(0));ke.length>0;){const We=ke.pop(),ct=We.x,ot=We.y;let Xt=We.fullyVisible;if(!Xt){const ti=We.aabb.intersects(J);if(ti===0)continue;Xt=ti===2}if(We.zoom!==Ye&&tt(We))for(let ti=0;ti<4;ti++){const vi=(ct<<1)+ti%2,_t=(ot<<1)+(ti>>1),Kt={aabb:F?We.aabb.quadrant(ti):x.tileAABB(this,q,We.zoom+1,vi,_t,We.wrap,We.minZ,We.maxZ,this.projection),zoom:We.zoom+1,x:vi,y:_t,wrap:We.wrap,fullyVisible:Xt,tileID:void 0,shouldSplit:void 0,minZ:We.minZ,maxZ:We.maxZ};L&&(Kt.tileID=new x.OverscaledTileID(We.zoom+1===Ye?Ke:We.zoom+1,We.wrap,We.zoom+1,vi,_t),ut(Kt)),ke.push(Kt)}else{const ti=We.zoom===Ye?Ke:We.zoom;if(y.minzoom&&y.minzoom>ti)continue;const vi=W[0]-(.5+ct+(We.wrap<<We.zoom))*(1<<M-We.zoom),_t=W[1]-.5-ot,Kt=We.tileID?We.tileID:new x.OverscaledTileID(ti,We.wrap,We.zoom,ct,ot);Fe.push({tileID:Kt,distanceSq:vi*vi+_t*_t})}}if(this.fogCullDistSq){const We=this.fogCullDistSq,ct=this.horizonLineFromTop();Fe=Fe.filter(ot=>{const Xt=[0,0,0,1],ti=[x.EXTENT,x.EXTENT,0,1],vi=this.calculateFogTileMatrix(ot.tileID.toUnwrapped());x.transformMat4$1(Xt,Xt,vi),x.transformMat4$1(ti,ti,vi);const _t=x.getAABBPointSquareDist(Xt,ti);if(_t===0)return!0;let Kt=!1;const ci=this._elevation;if(ci&&_t>We&&ct!==0){const qi=this.calculateProjMatrix(ot.tileID.toUnwrapped());let Ji;y.isTerrainDEM||(Ji=ci.getMinMaxForTile(ot.tileID)),Ji||(Ji={min:be,max:ze});const si=x.furthestTileCorner(this.rotation),Ti=[si[0]*x.EXTENT,si[1]*x.EXTENT,Ji.max];x.transformMat4(Ti,Ti,qi),Kt=(1-Ti[1])*this.height*.5<ct}return _t<We||Kt})}return Fe.sort((We,ct)=>We.distanceSq-ct.distanceSq).map(We=>We.tileID)}resize(y,M){this.width=y,this.height=M,this.pixelsToGLUnits=[2/y,-2/M],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(y){return Math.pow(2,y)}scaleZoom(y){return Math.log(y)/Math.LN2}project(y){const M=x.clamp(y.lat,-x.MAX_MERCATOR_LATITUDE,x.MAX_MERCATOR_LATITUDE),C=this.projection.project(y.lng,M);return new x.pointGeometry(C.x*this.worldSize,C.y*this.worldSize)}unproject(y){return this.projection.unproject(y.x/this.worldSize,y.y/this.worldSize)}get point(){return this.project(this.center)}setLocationAtPoint(y,M){const C=this.pointCoordinate(M),L=this.pointCoordinate(this.centerPoint),F=this.locationCoordinate(y);this.setLocation(new x.MercatorCoordinate(F.x-(C.x-L.x),F.y-(C.y-L.y)))}setLocation(y){this.center=this.coordinateLocation(y),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(y){return this.projection.locationPoint(this,y)}locationPoint3D(y){return this._coordinatePoint(this.locationCoordinate(y),!0)}pointLocation(y){return this.coordinateLocation(this.pointCoordinate(y))}pointLocation3D(y){return this.coordinateLocation(this.pointCoordinate3D(y))}locationCoordinate(y,M){const C=M?x.mercatorZfromAltitude(M,y.lat):void 0,L=this.projection.project(y.lng,y.lat);return new x.MercatorCoordinate(L.x,L.y,C)}coordinateLocation(y){return this.projection.unproject(y.x,y.y)}pointRayIntersection(y,M){const C=M!=null?M:this._centerAltitude,L=[y.x,y.y,0,1],F=[y.x,y.y,1,1];x.transformMat4$1(L,L,this.pixelMatrixInverse),x.transformMat4$1(F,F,this.pixelMatrixInverse);const N=F[3];x.scale$1(L,L,1/L[3]),x.scale$1(F,F,1/N);const q=L[2],W=F[2];return{p0:L,p1:F,t:q===W?0:(C-q)/(W-q)}}screenPointToMercatorRay(y){const M=[y.x,y.y,0,1],C=[y.x,y.y,1,1];return x.transformMat4$1(M,M,this.pixelMatrixInverse),x.transformMat4$1(C,C,this.pixelMatrixInverse),x.scale$1(M,M,1/M[3]),x.scale$1(C,C,1/C[3]),M[2]=x.mercatorZfromAltitude(M[2],this._center.lat)*this.worldSize,C[2]=x.mercatorZfromAltitude(C[2],this._center.lat)*this.worldSize,x.scale$1(M,M,1/this.worldSize),x.scale$1(C,C,1/this.worldSize),new x.Ray([M[0],M[1],M[2]],x.normalize([],x.sub([],C,M)))}rayIntersectionCoordinate(y){const{p0:M,p1:C,t:L}=y,F=x.mercatorZfromAltitude(M[2],this._center.lat),N=x.mercatorZfromAltitude(C[2],this._center.lat);return new x.MercatorCoordinate(x.number(M[0],C[0],L)/this.worldSize,x.number(M[1],C[1],L)/this.worldSize,x.number(F,N,L))}pointCoordinate(y,M=this._centerAltitude){return this.projection.createTileTransform(this,this.worldSize).pointCoordinate(y.x,y.y,M)}pointCoordinate3D(y){if(!this.elevation)return this.pointCoordinate(y);const M=this.elevation;let C=this.elevation.pointCoordinate(y);if(C)return new x.MercatorCoordinate(C[0],C[1],C[2]);let L=0,F=this.horizonLineFromTop();if(y.y>F)return this.pointCoordinate(y);const N=.02*F,q=y.clone();for(let W=0;W<10&&F-L>N;W++){q.y=x.number(L,F,.66);const J=M.pointCoordinate(q);J?(F=q.y,C=J):L=q.y}return C?new x.MercatorCoordinate(C[0],C[1],C[2]):this.pointCoordinate(y)}isPointAboveHorizon(y){if(this.elevation)return!this.elevation.pointCoordinate(y);{const M=this.horizonLineFromTop();return y.y<M}}_coordinatePoint(y,M){const C=M&&this.elevation?this.elevation.getAtPointOrZero(y,this._centerAltitude):this._centerAltitude,L=[y.x*this.worldSize,y.y*this.worldSize,C+y.toAltitude(),1];return x.transformMat4$1(L,L,this.pixelMatrix),L[3]>0?new x.pointGeometry(L[0]/L[3],L[1]/L[3]):new x.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getBounds(y,M){const C=new x.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),L=new x.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),F=new x.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),N=new x.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let q=this.pointCoordinate(C,y),W=this.pointCoordinate(L,y);const J=this.pointCoordinate(F,M),ee=this.pointCoordinate(N,M),ne=(fe,we)=>(we.y-fe.y)/(we.x-fe.x);return q.y>1&&W.y>=0?q=new x.MercatorCoordinate((1-ee.y)/ne(ee,q)+ee.x,1):q.y<0&&W.y<=1&&(q=new x.MercatorCoordinate(-ee.y/ne(ee,q)+ee.x,0)),W.y>1&&q.y>=0?W=new x.MercatorCoordinate((1-J.y)/ne(J,W)+J.x,1):W.y<0&&q.y<=1&&(W=new x.MercatorCoordinate(-J.y/ne(J,W)+J.x,0)),new x.LngLatBounds().extend(this.coordinateLocation(q)).extend(this.coordinateLocation(W)).extend(this.coordinateLocation(ee)).extend(this.coordinateLocation(J))}_getBounds3D(){const y=this.elevation;if(!y.visibleDemTiles.length)return this._getBounds(0,0);const M=y.visibleDemTiles.reduce((C,L)=>{if(L.dem){const F=L.dem.tree;C.min=Math.min(C.min,F.minimums[0]),C.max=Math.max(C.max,F.maximums[0])}return C},{min:Number.MAX_VALUE,max:0});return this._getBounds(M.min*y.exaggeration(),M.max*y.exaggeration())}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0)}horizonLineFromTop(y=!0){const M=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,C=this.height/2-M*(1-this._horizonShift);return y?Math.max(0,C):C}getMaxBounds(){return this.maxBounds}setMaxBounds(y){this.maxBounds=y,this.minLat=-x.MAX_MERCATOR_LATITUDE,this.maxLat=x.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,y&&(this.minLat=y.getSouth(),this.maxLat=y.getNorth(),this.minLng=y.getWest(),this.maxLng=y.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=x.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=x.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=x.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=x.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(y,M){return this.projection.createTileTransform(this,M).createTileMatrix(y)}calculateDistanceTileData(y){const M=y.key,C=this._distanceTileDataCache;if(C[M])return C[M];const L=y.canonical,F=1/this.height,N=this.cameraWorldSize/this.zoomScale(L.z),q=(L.x+Math.pow(2,L.z)*y.wrap)*N,W=L.y*N,J=this.point,ee=this.angle,ne=Math.sin(-ee),fe=-Math.cos(-ee);return C[M]={bearing:[ne,fe],center:[(J.x-q)*F,(J.y-W)*F],scale:N/x.EXTENT*F},C[M]}calculateFogTileMatrix(y){const M=y.key,C=this._fogTileMatrixCache;if(C[M])return C[M];const L=this.calculatePosMatrix(y,this.cameraWorldSize);return x.multiply$1(L,this.worldToFogMatrix,L),C[M]=new Float32Array(L),C[M]}calculateProjMatrix(y,M=!1){const C=y.key,L=M?this._alignedProjMatrixCache:this._projMatrixCache;if(L[C])return L[C];const F=this.calculatePosMatrix(y,this.worldSize);return x.multiply$1(F,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:M?this.alignedProjMatrix:this.projMatrix,F),L[C]=new Float32Array(F),L[C]}calculatePixelsToTileUnitsMatrix(y){const M=y.tileID.key,C=this._pixelsToTileUnitsCache;if(C[M])return C[M];const L=function(F,N){const{scale:q}=F.tileTransform,W=q*x.EXTENT/(F.tileSize*Math.pow(2,N.zoom-F.tileID.overscaledZ+F.tileID.canonical.z));return J=new Float32Array(4),fe=(ee=N.inverseAdjustmentMatrix)[1],we=ee[2],ye=ee[3],ze=(ne=[W,W])[1],J[0]=ee[0]*(Ee=ne[0]),J[1]=fe*Ee,J[2]=we*ze,J[3]=ye*ze,J;var J,ee,ne,fe,we,ye,Ee,ze}(y,this);return C[M]=L,C[M]}customLayerMatrix(){return this.mercatorMatrix.slice()}recenterOnTerrain(){if(!this._elevation)return;const y=this._elevation;this._updateCameraState();const M=x.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,C=this._computeCameraPosition(M),L=this._camera.forward(),F=x.mercatorZfromAltitude(1,this._center.lat);C[2]/=F,L[2]/=F,x.normalize(L,L);const N=y.raycast(C,L,y.exaggeration());if(N){const q=x.scaleAndAdd([],C,L,N),W=new x.MercatorCoordinate(q[0],q[1],x.mercatorZfromAltitude(q[2],x.latFromMercatorY(q[1]))),J=(W.z+x.length([W.x-C[0],W.y-C[1],W.z-C[2]*F]))*this._projectionScaler;this._cameraZoom=this._zoomFromMercatorZ(J),this._centerAltitude=W.toAltitude(),this._center=this.coordinateLocation(W),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCameraAltitude(){if(!this._elevation)return;const y=this._elevation;this._updateCameraState();const M=x.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,C=this._computeCameraPosition(M),L=y.getAtPointOrZero(new x.MercatorCoordinate(...C)),F=this._minimumHeightOverTerrain()*Math.cos(x.degToRad(this._maxPitch)),N=this._camera.position[2]-this.pixelsPerMeter/this.worldSize*L;if(N<F){const q=this.locationCoordinate(this._center,this._centerAltitude),W=[q.x-C[0],q.y-C[1],q.z-C[2]],J=x.length(W);W[2]-=(F-N)/this._projectionScaler;const ee=x.length(W);if(ee===0)return;x.scale$2(W,W,J/ee*this._projectionScaler),this._camera.position=[q.x-W[0],q.y-W[1],q.z*this._projectionScaler-W[2]],this._camera.orientation=qa(W,this._camera.up()),this._updateStateFromCamera()}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;if(this._constraining=!0,this.projection.isReprojectedInTileSpace){const ne=this.center;return ne.lat=x.clamp(ne.lat,this.minLat,this.maxLat),!this.maxBounds&&this.renderWorldCopies||(ne.lng=x.clamp(ne.lng,this.minLng,this.maxLng)),this.center=ne,void(this._constraining=!1)}const y=this._unmodified,{x:M,y:C}=this.point;let L=0,F=M,N=C;const q=this.width/2,W=this.height/2,J=this.worldMinY*this.scale,ee=this.worldMaxY*this.scale;if(C-W<J&&(N=J+W),C+W>ee&&(N=ee-W),ee-J<this.height&&(L=Math.max(L,this.height/(ee-J)),N=(ee+J)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const ne=this.worldMinX*this.scale,fe=this.worldMaxX*this.scale,we=this.worldSize/2-(ne+fe)/2;F=(M+we+this.worldSize)%this.worldSize-we,F-q<ne&&(F=ne+q),F+q>fe&&(F=fe-q),fe-ne<this.width&&(L=Math.max(L,this.width/(fe-ne)),F=(fe+ne)/2)}F===M&&N===C||(this.center=this.unproject(new x.pointGeometry(F,N))),L&&(this.zoom+=this.scaleZoom(L)),this._constrainCameraAltitude(),this._unmodified=y,this._constraining=!1}_minZoomForBounds(){let y=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(y=Math.max(y,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),y}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const y=this._fov/2,M=this.centerOffset,C=this.pixelsPerMeter;this._projectionScaler=C/(x.mercatorZfromAltitude(1,this.center.lat)*this.worldSize),this.cameraToCenterDistance=.5/Math.tan(y)*this.height*this._projectionScaler,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const L=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?C:1),F=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);F[8]=2*-M.x/this.width,F[9]=2*M.y/this.height;let N=x.mul([],F,L);if(this.projection.isReprojectedInTileSpace){const Ie=this.locationCoordinate(this.center),ke=x.identity([]);x.translate(ke,ke,[Ie.x*this.worldSize,Ie.y*this.worldSize,0]),x.multiply$1(ke,ke,th(this)),x.translate(ke,ke,[-Ie.x*this.worldSize,-Ie.y*this.worldSize,0]),x.multiply$1(N,N,ke),this.inverseAdjustmentMatrix=function(Fe){const Ye=th(Fe,!0);return U([],[Ye[0],Ye[1],Ye[4],Ye[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=x.scale([],N,[this.worldSize,this.worldSize,this.worldSize/C,1]),this.projMatrix=N,this.invProjMatrix=x.invert(new Float64Array(16),this.projMatrix);const q=new Float32Array(16);x.identity(q),x.scale(q,q,[1,-1,1]),x.rotateX(q,q,this._pitch),x.rotateZ(q,q,this.angle);const W=x.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),J=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;W[8]=2*-M.x/this.width,W[9]=2*(M.y+J)/this.height,this.skyboxMatrix=x.multiply$1(q,W,q);const ee=this.point,ne=ee.x,fe=ee.y,we=this.width%2/2,ye=this.height%2/2,Ee=Math.cos(this.angle),ze=Math.sin(this.angle),be=ne-Math.round(ne)+Ee*we+ze*ye,Ce=fe-Math.round(fe)+Ee*ye+ze*we,Pe=new Float64Array(N);if(x.translate(Pe,Pe,[be>.5?be-1:be,Ce>.5?Ce-1:Ce,0]),this.alignedProjMatrix=Pe,N=x.create(),x.scale(N,N,[this.width/2,-this.height/2,1]),x.translate(N,N,[1,-1,0]),this.labelPlaneMatrix=N,N=x.create(),x.scale(N,N,[1,-1,1]),x.translate(N,N,[-1,-1,0]),x.scale(N,N,[2/this.width,2/this.height,1]),this.glCoordMatrix=N,this.pixelMatrix=x.multiply$1(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},N=x.invert(new Float64Array(16),this.pixelMatrix),!N)throw new Error("failed to invert matrix");this.pixelMatrixInverse=N,this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const y=this.cameraWorldSize,M=this.cameraPixelsPerMeter,C=this._camera.position,L=1/this.height,F=[y,y,M];x.scale$2(F,F,L),x.scale$2(C,C,-1),x.multiply$2(C,C,F);const N=x.create();x.translate(N,N,C),x.scale(N,N,F),this.mercatorFogMatrix=N,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(y,M,L)}_computeCameraPosition(y){const M=(y=y||this.pixelsPerMeter)/this.pixelsPerMeter,C=this._camera.forward(),L=this.point,F=this._mercatorZfromZoom(this._cameraZoom?this._cameraZoom:this._zoom)*M-y/this.worldSize*this._centerAltitude;return[L.x/this.worldSize-C[0]*F,L.y/this.worldSize-C[1]*F,y/this.worldSize*this._centerAltitude-C[2]*F]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(y){const M=this._maxCameraBoundsDistance()*Math.cos(this._pitch),C=y[2];let L=1;C>0&&(L=Math.min((M-this._camera.position[2])/C,1)),this._camera.position=x.scaleAndAdd([],this._camera.position,y,L),this._updateStateFromCamera()}_updateStateFromCamera(){const y=this._camera.position,M=this._camera.forward(),{pitch:C,bearing:L}=this._camera.getPitchBearing(),F=x.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._projectionScaler,N=this._mercatorZfromZoom(this._maxZoom)*Math.cos(x.degToRad(this._maxPitch)),q=Math.max((y[2]-F)/Math.cos(C),N),W=this._zoomFromMercatorZ(q);x.scaleAndAdd(y,y,M,q),this._pitch=x.clamp(C,x.degToRad(this.minPitch),x.degToRad(this.maxPitch)),this.angle=x.wrap(L,-Math.PI,Math.PI),this._setZoom(x.clamp(W,this._minZoom,this._maxZoom)),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._center=this.coordinateLocation(new x.MercatorCoordinate(y[0],y[1],y[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(y){return Math.pow(2,y)*this.tileSize}_mercatorZfromZoom(y){return this.cameraToCenterDistance/this._worldSizeFromZoom(y)}_minimumHeightOverTerrain(){const y=Math.min((this._cameraZoom!=null?this._cameraZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(y)}_zoomFromMercatorZ(y){return this.scaleZoom(this.cameraToCenterDistance/(y*this.tileSize))}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(x.warnOnce("Terrain is not yet supported with alternate projections. Use mercator to enable terrain."),1))}anyCornerOffEdge(y,M){const C=Math.min(y.x,M.x),L=Math.max(y.x,M.x),F=Math.min(y.y,M.y),N=Math.max(y.y,M.y);if(F<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const q=[new x.pointGeometry(C,F),new x.pointGeometry(L,N),new x.pointGeometry(C,N),new x.pointGeometry(L,F)],W=this.renderWorldCopies?-3:0,J=this.renderWorldCopies?4:1;for(const ee of q){const ne=this.pointRayIntersection(ee);if(ne.t<0)return!0;const fe=this.rayIntersectionCoordinate(ne);if(fe.x<W||fe.y<0||fe.x>J||fe.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+x.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new x.pointGeometry(0,0),new x.pointGeometry(this.width,this.height))}zoomDeltaToMovement(y,M){const C=x.length(x.sub([],this._camera.position,y)),L=this._zoomFromMercatorZ(C)+M;return C-this._mercatorZfromZoom(L)}getCameraPoint(){const y=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new x.pointGeometry(0,y))}}function Qn(I,y){let M=!1,C=null;const L=()=>{C=null,M&&(I(),C=setTimeout(L,y),M=!1)};return()=>(M=!0,C||L(),C)}class ih{constructor(y){this._hashName=y&&encodeURIComponent(y),x.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Qn(this._updateHashUnthrottled.bind(this),300)}addTo(y){return this._map=y,x.window.addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return x.window.removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(y){const M=this._map.getCenter(),C=Math.round(100*this._map.getZoom())/100,L=Math.ceil((C*Math.LN2+Math.log(512/360/.5))/Math.LN10),F=Math.pow(10,L),N=Math.round(M.lng*F)/F,q=Math.round(M.lat*F)/F,W=this._map.getBearing(),J=this._map.getPitch();let ee="";if(ee+=y?`/${N}/${q}/${C}`:`${C}/${q}/${N}`,(W||J)&&(ee+="/"+Math.round(10*W)/10),J&&(ee+=`/${Math.round(J)}`),this._hashName){const ne=this._hashName;let fe=!1;const we=x.window.location.hash.slice(1).split("&").map(ye=>{const Ee=ye.split("=")[0];return Ee===ne?(fe=!0,`${Ee}=${ee}`):ye}).filter(ye=>ye);return fe||we.push(`${ne}=${ee}`),`#${we.join("&")}`}return`#${ee}`}_getCurrentHash(){const y=x.window.location.hash.replace("#","");if(this._hashName){let M;return y.split("&").map(C=>C.split("=")).forEach(C=>{C[0]===this._hashName&&(M=C)}),(M&&M[1]||"").split("/")}return y.split("/")}_onHashChange(){const y=this._getCurrentHash();if(y.length>=3&&!y.some(M=>isNaN(M))){const M=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(y[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+y[2],+y[1]],zoom:+y[0],bearing:M,pitch:+(y[4]||0)}),!0}return!1}_updateHashUnthrottled(){const y=x.window.location.href.replace(/(#.+)?$/,this.getHashString());x.window.history.replaceState(x.window.history.state,null,y)}}const Bn={linearity:.3,easing:x.bezier(0,0,.3,1)},Io=x.extend({deceleration:2500,maxSpeed:1400},Bn),rh=x.extend({deceleration:20,maxSpeed:1400},Bn),Ha=x.extend({deceleration:1e3,maxSpeed:360},Bn),Ui=x.extend({deceleration:1e3,maxSpeed:90},Bn);class ia{constructor(y){this._map=y,this.clear()}clear(){this._inertiaBuffer=[]}record(y){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:x.exported.now(),settings:y})}_drainInertiaBuffer(){const y=this._inertiaBuffer,M=x.exported.now();for(;y.length>0&&M-y[0].time>160;)y.shift()}_onMoveEnd(y){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const M={zoom:0,bearing:0,pitch:0,pan:new x.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:F}of this._inertiaBuffer)M.zoom+=F.zoomDelta||0,M.bearing+=F.bearingDelta||0,M.pitch+=F.pitchDelta||0,F.panDelta&&M.pan._add(F.panDelta),F.around&&(M.around=F.around),F.pinchAround&&(M.pinchAround=F.pinchAround);const C=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,L={};if(M.pan.mag()){const F=fs(M.pan.mag(),C,x.extend({},Io,y||{}));L.offset=M.pan.mult(F.amount/M.pan.mag()),L.center=this._map.transform.center,ra(L,F)}if(M.zoom){const F=fs(M.zoom,C,rh);L.zoom=this._map.transform.zoom+F.amount,ra(L,F)}if(M.bearing){const F=fs(M.bearing,C,Ha);L.bearing=this._map.transform.bearing+x.clamp(F.amount,-179,179),ra(L,F)}if(M.pitch){const F=fs(M.pitch,C,Ui);L.pitch=this._map.transform.pitch+F.amount,ra(L,F)}if(L.zoom||L.bearing){const F=M.pinchAround===void 0?M.around:M.pinchAround;L.around=F?this._map.unproject(F):this._map.getCenter()}return this.clear(),x.extend(L,{noMoveStart:!0})}}function ra(I,y){(!I.duration||I.duration<y.duration)&&(I.duration=y.duration,I.easing=y.easing)}function fs(I,y,M){const{maxSpeed:C,linearity:L,deceleration:F}=M,N=x.clamp(I*L/(y/1e3),-C,C),q=Math.abs(N)/(F*L);return{easing:M.easing,duration:1e3*q,amount:N*(q/2)}}class zr extends x.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(y,M,C,L={}){const F=j.mousePos(M.getCanvasContainer(),C),N=M.unproject(F);super(y,x.extend({point:F,lngLat:N,originalEvent:C},L)),this._defaultPrevented=!1,this.target=M}}class na extends x.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(y,M,C){const L=y==="touchend"?C.changedTouches:C.touches,F=j.touchPos(M.getCanvasContainer(),L),N=F.map(W=>M.unproject(W)),q=F.reduce((W,J,ee,ne)=>W.add(J.div(ne.length)),new x.pointGeometry(0,0));super(y,{points:F,point:q,lngLats:N,lngLat:M.unproject(q),originalEvent:C}),this._defaultPrevented=!1}}class hc extends x.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(y,M,C){super(y,{originalEvent:C}),this._defaultPrevented=!1}}class nh{constructor(y,M){this._map=y,this._clickTolerance=M.clickTolerance}reset(){delete this._mousedownPos}wheel(y){return this._firePreventable(new hc(y.type,this._map,y))}mousedown(y,M){return this._mousedownPos=M,this._firePreventable(new zr(y.type,this._map,y))}mouseup(y){this._map.fire(new zr(y.type,this._map,y))}preclick(y){const M=x.extend({},y);M.type="preclick",this._map.fire(new zr(M.type,this._map,M))}click(y,M){this._mousedownPos&&this._mousedownPos.dist(M)>=this._clickTolerance||(this.preclick(y),this._map.fire(new zr(y.type,this._map,y)))}dblclick(y){return this._firePreventable(new zr(y.type,this._map,y))}mouseover(y){this._map.fire(new zr(y.type,this._map,y))}mouseout(y){this._map.fire(new zr(y.type,this._map,y))}touchstart(y){return this._firePreventable(new na(y.type,this._map,y))}touchmove(y){this._map.fire(new na(y.type,this._map,y))}touchend(y){this._map.fire(new na(y.type,this._map,y))}touchcancel(y){this._map.fire(new na(y.type,this._map,y))}_firePreventable(y){if(this._map.fire(y),y.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class cc{constructor(y){this._map=y}reset(){this._delayContextMenu=!1,delete this._contextMenuEvent}mousemove(y){this._map.fire(new zr(y.type,this._map,y))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new zr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(y){this._delayContextMenu?this._contextMenuEvent=y:this._map.fire(new zr(y.type,this._map,y)),this._map.listens("contextmenu")&&y.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Wa{constructor(y,M){this._map=y,this._el=y.getCanvasContainer(),this._container=y.getContainer(),this._clickTolerance=M.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(y,M){this.isEnabled()&&y.shiftKey&&y.button===0&&(j.disableDrag(),this._startPos=this._lastPos=M,this._active=!0)}mousemoveWindow(y,M){if(!this._active)return;const C=M;if(this._lastPos.equals(C)||!this._box&&C.dist(this._startPos)<this._clickTolerance)return;const L=this._startPos;this._lastPos=C,this._box||(this._box=j.create("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",y));const F=Math.min(L.x,C.x),N=Math.max(L.x,C.x),q=Math.min(L.y,C.y),W=Math.max(L.y,C.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${F}px,${q}px)`,this._box.style.width=N-F+"px",this._box.style.height=W-q+"px")})}mouseupWindow(y,M){if(!this._active||y.button!==0)return;const C=this._startPos,L=M;if(this.reset(),j.suppressClick(),C.x!==L.x||C.y!==L.y)return this._map.fire(new x.Event("boxzoomend",{originalEvent:y})),{cameraAnimation:F=>F.fitScreenCoordinates(C,L,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",y)}keydown(y){this._active&&y.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",y))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),j.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(y,M){return this._map.fire(new x.Event(y,{originalEvent:M}))}}function ko(I,y){const M={};for(let C=0;C<I.length;C++)M[I[C].identifier]=y[C];return M}class ps{constructor(y){this.reset(),this.numTouches=y.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(y,M,C){(this.centroid||C.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=y.timeStamp),C.length===this.numTouches&&(this.centroid=function(L){const F=new x.pointGeometry(0,0);for(const N of L)F._add(N);return F.div(L.length)}(M),this.touches=ko(C,M)))}touchmove(y,M,C){if(this.aborted||!this.centroid)return;const L=ko(C,M);for(const F in this.touches){const N=this.touches[F],q=L[F];(!q||q.dist(N)>30)&&(this.aborted=!0)}}touchend(y,M,C){if((!this.centroid||y.timeStamp-this.startTime>500)&&(this.aborted=!0),C.length===0){const L=!this.aborted&&this.centroid;if(this.reset(),L)return L}}}class ms{constructor(y){this.singleTap=new ps(y),this.numTaps=y.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(y,M,C){this.singleTap.touchstart(y,M,C)}touchmove(y,M,C){this.singleTap.touchmove(y,M,C)}touchend(y,M,C){const L=this.singleTap.touchend(y,M,C);if(L){const F=y.timeStamp-this.lastTime<500,N=!this.lastTap||this.lastTap.dist(L)<30;if(F&&N||this.reset(),this.count++,this.lastTime=y.timeStamp,this.lastTap=L,this.count===this.numTaps)return this.reset(),L}}}class Ka{constructor(){this._zoomIn=new ms({numTouches:1,numTaps:2}),this._zoomOut=new ms({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(y,M,C){this._zoomIn.touchstart(y,M,C),this._zoomOut.touchstart(y,M,C)}touchmove(y,M,C){this._zoomIn.touchmove(y,M,C),this._zoomOut.touchmove(y,M,C)}touchend(y,M,C){const L=this._zoomIn.touchend(y,M,C),F=this._zoomOut.touchend(y,M,C);return L?(this._active=!0,y.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:N=>N.easeTo({duration:300,zoom:N.getZoom()+1,around:N.unproject(L)},{originalEvent:y})}):F?(this._active=!0,y.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:N=>N.easeTo({duration:300,zoom:N.getZoom()-1,around:N.unproject(F)},{originalEvent:y})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const oh={0:1,2:2};class Co{constructor(y){this.reset(),this._clickTolerance=y.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,delete this._lastPoint,delete this._eventButton}_correctButton(y,M){return!1}_move(y,M){return{}}mousedown(y,M){if(this._lastPoint)return;const C=j.mouseButton(y);this._correctButton(y,C)&&(this._lastPoint=M,this._eventButton=C)}mousemoveWindow(y,M){const C=this._lastPoint;if(C){if(y.preventDefault(),function(L,F){const N=oh[F];return L.buttons===void 0||(L.buttons&N)!==N}(y,this._eventButton))this.reset();else if(this._moved||!(M.dist(C)<this._clickTolerance))return this._moved=!0,this._lastPoint=M,this._move(C,M)}}mouseupWindow(y){this._lastPoint&&j.mouseButton(y)===this._eventButton&&(this._moved&&j.suppressClick(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class oa extends Co{mousedown(y,M){super.mousedown(y,M),this._lastPoint&&(this._active=!0)}_correctButton(y,M){return M===0&&!y.ctrlKey}_move(y,M){return{around:M,panDelta:M.sub(y)}}}class hn extends Co{_correctButton(y,M){return M===0&&y.ctrlKey||M===2}_move(y,M){const C=.8*(M.x-y.x);if(C)return this._active=!0,{bearingDelta:C}}contextmenu(y){y.preventDefault()}}class Ja extends Co{_correctButton(y,M){return M===0&&y.ctrlKey||M===2}_move(y,M){const C=-.5*(M.y-y.y);if(C)return this._active=!0,{pitchDelta:C}}contextmenu(y){y.preventDefault()}}class sh{constructor(y,M){this._map=y,this._el=y.getCanvasContainer(),this._minTouches=1,this._clickTolerance=M.clickTolerance||1,this.reset(),x.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new x.pointGeometry(0,0)}touchstart(y,M,C){return this._calculateTransform(y,M,C)}touchmove(y,M,C){if(this._active&&!(C.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(C.length===1)return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return y.preventDefault(),this._calculateTransform(y,M,C)}}touchend(y,M,C){this._calculateTransform(y,M,C),this._active&&C.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(y,M,C){C.length>0&&(this._active=!0);const L=ko(C,M),F=new x.pointGeometry(0,0),N=new x.pointGeometry(0,0);let q=0;for(const J in L){const ee=L[J],ne=this._touches[J];ne&&(F._add(ee),N._add(ee.sub(ne)),q++,L[J]=ee)}if(this._touches=L,q<this._minTouches||!N.mag())return;const W=N.div(q);return this._sum._add(W),this._sum.mag()<this._clickTolerance?void 0:{around:F.div(q),panDelta:W}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=j.create("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show")},500)}}class sa{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}_start(y){}_move(y,M,C){return{}}touchstart(y,M,C){this._firstTwoTouches||C.length<2||(this._firstTwoTouches=[C[0].identifier,C[1].identifier],this._start([M[0],M[1]]))}touchmove(y,M,C){if(!this._firstTwoTouches)return;y.preventDefault();const[L,F]=this._firstTwoTouches,N=Ln(C,M,L),q=Ln(C,M,F);if(!N||!q)return;const W=this._aroundCenter?null:N.add(q).div(2);return this._move([N,q],W,y)}touchend(y,M,C){if(!this._firstTwoTouches)return;const[L,F]=this._firstTwoTouches,N=Ln(C,M,L),q=Ln(C,M,F);N&&q||(this._active&&j.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(y){this._enabled=!0,this._aroundCenter=!!y&&y.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Ln(I,y,M){for(let C=0;C<I.length;C++)if(I[C].identifier===M)return y[C]}function Qa(I,y){return Math.log(I/y)/Math.LN2}class aa extends sa{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(y){this._startDistance=this._distance=y[0].dist(y[1])}_move(y,M){const C=this._distance;if(this._distance=y[0].dist(y[1]),this._active||!(Math.abs(Qa(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Qa(this._distance,C),pinchAround:M}}}function la(I,y){return 180*I.angleWith(y)/Math.PI}class ha extends sa{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(y){this._startVector=this._vector=y[0].sub(y[1]),this._minDiameter=y[0].dist(y[1])}_move(y,M){const C=this._vector;if(this._vector=y[0].sub(y[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:la(this._vector,C),pinchAround:M}}_isBelowThreshold(y){this._minDiameter=Math.min(this._minDiameter,y.mag());const M=25/(Math.PI*this._minDiameter)*360,C=la(y,this._startVector);return Math.abs(C)<M}}function ca(I){return Math.abs(I.y)>Math.abs(I.x)}class ah extends sa{constructor(y){super(),this._map=y}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}_start(y){this._lastPoints=y,ca(y[0].sub(y[1]))&&(this._valid=!1)}_move(y,M,C){const L=y[0].sub(this._lastPoints[0]),F=y[1].sub(this._lastPoints[1]);if(!(this._map._cooperativeGestures&&C.touches.length<3)&&(this._valid=this.gestureBeginsVertically(L,F,C.timeStamp),this._valid))return this._lastPoints=y,this._active=!0,{pitchDelta:(L.y+F.y)/2*-.5}}gestureBeginsVertically(y,M,C){if(this._valid!==void 0)return this._valid;const L=y.mag()>=2,F=M.mag()>=2;if(!L&&!F)return;if(!L||!F)return this._firstMove===void 0&&(this._firstMove=C),C-this._firstMove<100&&void 0;const N=y.y>0==M.y>0;return ca(y)&&ca(M)&&N}}const Do={panStep:100,bearingStep:15,pitchStep:10};class uc{constructor(){const y=Do;this._panStep=y.panStep,this._bearingStep=y.bearingStep,this._pitchStep=y.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(y){if(y.altKey||y.ctrlKey||y.metaKey)return;let M=0,C=0,L=0,F=0,N=0;switch(y.keyCode){case 61:case 107:case 171:case 187:M=1;break;case 189:case 109:case 173:M=-1;break;case 37:y.shiftKey?C=-1:(y.preventDefault(),F=-1);break;case 39:y.shiftKey?C=1:(y.preventDefault(),F=1);break;case 38:y.shiftKey?L=1:(y.preventDefault(),N=-1);break;case 40:y.shiftKey?L=-1:(y.preventDefault(),N=1);break;default:return}return this._rotationDisabled&&(C=0,L=0),{cameraAnimation:q=>{const W=q.getZoom();q.easeTo({duration:300,easeId:"keyboardHandler",easing:dc,zoom:M?Math.round(W)+M*(y.shiftKey?2:1):W,bearing:q.getBearing()+C*this._bearingStep,pitch:q.getPitch()+L*this._pitchStep,offset:[-F*this._panStep,-N*this._panStep],center:q.getCenter()},{originalEvent:y})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function dc(I){return I*(2-I)}const el=4.000244140625;class ua{constructor(y,M){this._map=y,this._el=y.getCanvasContainer(),this._handler=M,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,x.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert","_isFullscreen"],this)}setZoomRate(y){this._defaultZoomRate=y}setWheelZoomRate(y){this._wheelZoomRate=y}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(y){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!y&&y.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(y){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(y.ctrlKey||y.metaKey||this.isZooming()||this._isFullscreen()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let M=y.deltaMode===x.window.WheelEvent.DOM_DELTA_LINE?40*y.deltaY:y.deltaY;const C=x.exported.now(),L=C-(this._lastWheelEventTime||0);this._lastWheelEventTime=C,M!==0&&M%el==0?this._type="wheel":M!==0&&Math.abs(M)<4?this._type="trackpad":L>400?(this._type=null,this._lastValue=M,this._timeout=setTimeout(this._onTimeout,40,y)):this._type||(this._type=Math.abs(L*M)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,M+=this._lastValue)),y.shiftKey&&M&&(M/=4),this._type&&(this._lastWheelEvent=y,this._delta-=M,this._active||this._start(y)),y.preventDefault()}_onTimeout(y){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(y)}_start(y){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const M=j.mousePos(this._el,y);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:M,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const y=this._map.transform,M=()=>y._terrainEnabled()&&this._aroundCoord?y.computeZoomRelativeTo(this._aroundCoord):y.zoom;if(this._delta!==0){const W=this._type==="wheel"&&Math.abs(this._delta)>el?this._wheelZoomRate:this._defaultZoomRate;let J=2/(1+Math.exp(-Math.abs(this._delta*W)));this._delta<0&&J!==0&&(J=1/J);const ee=M(),ne=Math.pow(2,ee),fe=typeof this._targetZoom=="number"?y.zoomScale(this._targetZoom):ne;this._targetZoom=Math.min(y.maxZoom,Math.max(y.minZoom,y.scaleZoom(fe*J))),this._type==="wheel"&&(this._startZoom=M(),this._easing=this._smoothOutEasing(200)),this._delta=0}const C=typeof this._targetZoom=="number"?this._targetZoom:M(),L=this._startZoom,F=this._easing;let N,q=!1;if(this._type==="wheel"&&L&&F){const W=Math.min((x.exported.now()-this._lastWheelEventTime)/200,1),J=F(W);N=x.number(L,C,J),W<1?this._frameId||(this._frameId=!0):q=!0}else N=C,q=!0;return this._active=!0,q&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!q,zoomDelta:N-M(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(y){let M=x.ease;if(this._prevEase){const C=this._prevEase,L=(x.exported.now()-C.start)/C.duration,F=C.easing(L+.01)-C.easing(L),N=.27/Math.sqrt(F*F+1e-4)*.01,q=Math.sqrt(.0729-N*N);M=x.bezier(N,q,.25,1)}return this._prevEase={start:x.exported.now(),duration:y,easing:M},M}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=j.create("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(x.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_isFullscreen(){return!!x.window.document.fullscreenElement}_showBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show")},200)}}class tl{constructor(y,M){this._clickZoom=y,this._tapZoom=M}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class lh{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(y,M){return y.preventDefault(),{cameraAnimation:C=>{C.easeTo({duration:300,zoom:C.getZoom()+(y.shiftKey?-1:1),around:C.unproject(M)},{originalEvent:y})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class hh{constructor(){this._tap=new ms({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,this._tap.reset()}touchstart(y,M,C){this._swipePoint||(this._tapTime&&y.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?C.length>0&&(this._swipePoint=M[0],this._swipeTouch=C[0].identifier):this._tap.touchstart(y,M,C))}touchmove(y,M,C){if(this._tapTime){if(this._swipePoint){if(C[0].identifier!==this._swipeTouch)return;const L=M[0],F=L.y-this._swipePoint.y;return this._swipePoint=L,y.preventDefault(),this._active=!0,{zoomDelta:F/128}}}else this._tap.touchmove(y,M,C)}touchend(y,M,C){this._tapTime?this._swipePoint&&C.length===0&&this.reset():this._tap.touchend(y,M,C)&&(this._tapTime=y.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class da{constructor(y,M,C){this._el=y,this._mousePan=M,this._touchPan=C}enable(y){this._inertiaOptions=y||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class il{constructor(y,M,C){this._pitchWithRotate=y.pitchWithRotate,this._mouseRotate=M,this._mousePitch=C}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class ch{constructor(y,M,C,L){this._el=y,this._touchZoom=M,this._touchRotate=C,this._tapDragZoom=L,this._rotationDisabled=!1,this._enabled=!0}enable(y){this._touchZoom.enable(y),this._rotationDisabled||this._touchRotate.enable(y),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const gs=I=>I.zoom||I.drag||I.pitch||I.rotate;class uh extends x.Event{}class dh{constructor(){this.constants=[1,1,.01],this.radius=0}setup(y,M){const C=x.sub([],M,y);this.radius=x.length(C[2]<0?x.div([],C,this.constants):[C[0],C[1],0])}projectRay(y){x.div(y,y,this.constants),x.normalize(y,y),x.mul$1(y,y,this.constants);const M=x.scale$2([],y,this.radius);if(M[2]>0){const C=x.scale$2([],[0,0,1],x.dot(M,[0,0,1])),L=x.scale$2([],x.normalize([],[M[0],M[1],0]),this.radius),F=x.add([],M,x.scale$2([],x.sub([],x.add([],L,C),M),2));M[0]=F[0],M[1]=F[1]}return M}}function _s(I){return I.panDelta&&I.panDelta.mag()||I.zoomDelta||I.bearingDelta||I.pitchDelta}class Po{constructor(y,M){this._map=y,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ia(y),this._bearingSnap=M.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new dh,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(M),x.bindAll(["handleEvent","handleWindowEvent"],this);const C=this._el;this._listeners=[[C,"touchstart",{passive:!0}],[C,"touchmove",{passive:!1}],[C,"touchend",void 0],[C,"touchcancel",void 0],[C,"mousedown",void 0],[C,"mousemove",void 0],[C,"mouseup",void 0],[x.window.document,"mousemove",{capture:!0}],[x.window.document,"mouseup",void 0],[C,"mouseover",void 0],[C,"mouseout",void 0],[C,"dblclick",void 0],[C,"click",void 0],[C,"keydown",{capture:!1}],[C,"keyup",void 0],[C,"wheel",{passive:!1}],[C,"contextmenu",void 0],[x.window,"blur",void 0]];for(const[L,F,N]of this._listeners)L.addEventListener(F,L===x.window.document?this.handleWindowEvent:this.handleEvent,N)}destroy(){for(const[y,M,C]of this._listeners)y.removeEventListener(M,y===x.window.document?this.handleWindowEvent:this.handleEvent,C)}_addDefaultHandlers(y){const M=this._map,C=M.getCanvasContainer();this._add("mapEvent",new nh(M,y));const L=M.boxZoom=new Wa(M,y);this._add("boxZoom",L);const F=new Ka,N=new lh;M.doubleClickZoom=new tl(N,F),this._add("tapZoom",F),this._add("clickZoom",N);const q=new hh;this._add("tapDragZoom",q);const W=M.touchPitch=new ah(M);this._add("touchPitch",W);const J=new hn(y),ee=new Ja(y);M.dragRotate=new il(y,J,ee),this._add("mouseRotate",J,["mousePitch"]),this._add("mousePitch",ee,["mouseRotate"]);const ne=new oa(y),fe=new sh(M,y);M.dragPan=new da(C,ne,fe),this._add("mousePan",ne),this._add("touchPan",fe,["touchZoom","touchRotate"]);const we=new ha,ye=new aa;M.touchZoomRotate=new ch(C,ye,we,q),this._add("touchRotate",we,["touchPan","touchZoom"]),this._add("touchZoom",ye,["touchPan","touchRotate"]),this._add("blockableMapEvent",new cc(M));const Ee=M.scrollZoom=new ua(M,this);this._add("scrollZoom",Ee,["mousePan"]);const ze=M.keyboard=new uc;this._add("keyboard",ze);for(const be of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])y.interactive&&y[be]&&M[be].enable(y[be])}_add(y,M,C){this._handlers.push({handlerName:y,handler:M,allowed:C}),this._handlersById[y]=M}stop(y){if(!this._updatingCamera){for(const{handler:M}of this._handlers)M.reset();this._inertia.clear(),this._fireEvents({},{},y),this._changes=[]}}isActive(){for(const{handler:y}of this._handlers)if(y.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(gs(this._eventsInProgress))||this.isZooming()}_blockedByActive(y,M,C){for(const L in y)if(L!==C&&(!M||M.indexOf(L)<0))return!0;return!1}handleWindowEvent(y){this.handleEvent(y,`${y.type}Window`)}_getMapTouches(y){const M=[];for(const C of y)this._el.contains(C.target)&&M.push(C);return M}handleEvent(y,M){this._updatingCamera=!0;const C=y.type==="renderFrame",L=C?void 0:y,F={needsRenderFrame:!1},N={},q={},W=y.touches?this._getMapTouches(y.touches):void 0,J=W?j.touchPos(this._el,W):C?void 0:j.mousePos(this._el,y);for(const{handlerName:fe,handler:we,allowed:ye}of this._handlers){if(!we.isEnabled())continue;let Ee;this._blockedByActive(q,ye,fe)?we.reset():we[M||y.type]&&(Ee=we[M||y.type](y,J,W),this.mergeHandlerResult(F,N,Ee,fe,L),Ee&&Ee.needsRenderFrame&&this._triggerRenderFrame()),(Ee||we.isActive())&&(q[fe]=we)}const ee={};for(const fe in this._previousActiveHandlers)q[fe]||(ee[fe]=L);this._previousActiveHandlers=q,(Object.keys(ee).length||_s(F))&&(this._changes.push([F,N,ee]),this._triggerRenderFrame()),(Object.keys(q).length||_s(F))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ne}=F;ne&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ne(this._map))}mergeHandlerResult(y,M,C,L,F){if(!C)return;x.extend(y,C);const N={handlerName:L,originalEvent:C.originalEvent||F};C.zoomDelta!==void 0&&(M.zoom=N),C.panDelta!==void 0&&(M.drag=N),C.pitchDelta!==void 0&&(M.pitch=N),C.bearingDelta!==void 0&&(M.rotate=N)}_applyChanges(){const y={},M={},C={};for(const[L,F,N]of this._changes)L.panDelta&&(y.panDelta=(y.panDelta||new x.pointGeometry(0,0))._add(L.panDelta)),L.zoomDelta&&(y.zoomDelta=(y.zoomDelta||0)+L.zoomDelta),L.bearingDelta&&(y.bearingDelta=(y.bearingDelta||0)+L.bearingDelta),L.pitchDelta&&(y.pitchDelta=(y.pitchDelta||0)+L.pitchDelta),L.around!==void 0&&(y.around=L.around),L.aroundCoord!==void 0&&(y.aroundCoord=L.aroundCoord),L.pinchAround!==void 0&&(y.pinchAround=L.pinchAround),L.noInertia&&(y.noInertia=L.noInertia),x.extend(M,F),x.extend(C,N);this._updateMapTransform(y,M,C),this._changes=[]}_updateMapTransform(y,M,C){const L=this._map,F=L.transform,N=Ce=>[Ce.x,Ce.y,Ce.z];if((Ce=>{const Pe=this._eventsInProgress.drag;return Pe&&!this._handlersById[Pe.handlerName].isActive()})()&&!_s(y)){const Ce=F.zoom;F.cameraElevationReference="sea",F.recenterOnTerrain(),F.cameraElevationReference="ground",Ce!==F.zoom&&this._map._update(!0)}if(!_s(y))return this._fireEvents(M,C,!0);let{panDelta:q,zoomDelta:W,bearingDelta:J,pitchDelta:ee,around:ne,aroundCoord:fe,pinchAround:we}=y;we!==void 0&&(ne=we),(Ce=>M.drag&&!this._eventsInProgress.drag)()&&ne&&(this._dragOrigin=N(F.pointCoordinate3D(ne)),this._trackingEllipsoid.setup(F._camera.position,this._dragOrigin)),F.cameraElevationReference="sea",L._stop(!0),ne=ne||L.transform.centerPoint,J&&(F.bearing+=J),ee&&(F.pitch+=ee),F._updateCameraState();const ye=[0,0,0];if(q){const Ce=F.pointCoordinate(ne),Pe=F.pointCoordinate(ne.sub(q));Ce&&Pe&&(ye[0]=Pe.x-Ce.x,ye[1]=Pe.y-Ce.y)}const Ee=F.zoom,ze=[0,0,0];if(W){const Ce=N(fe||F.pointCoordinate3D(ne)),Pe={dir:x.normalize([],x.sub([],Ce,F._camera.position))};if(Pe.dir[2]<0){const Ie=F.zoomDeltaToMovement(Ce,W);x.scale$2(ze,Pe.dir,Ie)}}const be=x.add(ye,ye,ze);F._translateCameraConstrained(be),W&&Math.abs(F.zoom-Ee)>1e-4&&F.recenterOnTerrain(),F.cameraElevationReference="ground",this._map._update(),y.noInertia||this._inertia.record(y),this._fireEvents(M,C,!0)}_fireEvents(y,M,C){const L=gs(this._eventsInProgress),F=gs(y),N={};for(const ee in y){const{originalEvent:ne}=y[ee];this._eventsInProgress[ee]||(N[`${ee}start`]=ne),this._eventsInProgress[ee]=y[ee]}!L&&F&&this._fireEvent("movestart",F.originalEvent);for(const ee in N)this._fireEvent(ee,N[ee]);F&&this._fireEvent("move",F.originalEvent);for(const ee in y){const{originalEvent:ne}=y[ee];this._fireEvent(ee,ne)}const q={};let W;for(const ee in this._eventsInProgress){const{handlerName:ne,originalEvent:fe}=this._eventsInProgress[ee];this._handlersById[ne].isActive()||(delete this._eventsInProgress[ee],W=M[ne]||fe,q[`${ee}end`]=W)}for(const ee in q)this._fireEvent(ee,q[ee]);const J=gs(this._eventsInProgress);if(C&&(L||F)&&!J){this._updatingCamera=!0;const ee=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),ne=fe=>fe!==0&&-this._bearingSnap<fe&&fe<this._bearingSnap;ee?(ne(ee.bearing||this._map.getBearing())&&(ee.bearing=0),this._map.easeTo(ee,{originalEvent:W})):(this._map.fire(new x.Event("moveend",{originalEvent:W})),ne(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(y,M){this._map.fire(new x.Event(y,M?{originalEvent:M}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(y=>{delete this._frameId,this.handleEvent(new uh("renderFrame",{timeStamp:y})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const rl="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class fh extends x.Evented{constructor(y,M){super(),this._moving=!1,this._zooming=!1,this.transform=y,this._bearingSnap=M.bearingSnap,x.bindAll(["_renderFrameCallback"],this)}getCenter(){return new x.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(y,M){return this.jumpTo({center:y},M)}panBy(y,M,C){return y=x.pointGeometry.convert(y).mult(-1),this.panTo(this.transform.center,x.extend({offset:y},M),C)}panTo(y,M,C){return this.easeTo(x.extend({center:y},M),C)}getZoom(){return this.transform.zoom}setZoom(y,M){return this.jumpTo({zoom:y},M),this}zoomTo(y,M,C){return this.easeTo(x.extend({zoom:y},M),C)}zoomIn(y,M){return this.zoomTo(this.getZoom()+1,y,M),this}zoomOut(y,M){return this.zoomTo(this.getZoom()-1,y,M),this}getBearing(){return this.transform.bearing}setBearing(y,M){return this.jumpTo({bearing:y},M),this}getPadding(){return this.transform.padding}setPadding(y,M){return this.jumpTo({padding:y},M),this}rotateTo(y,M,C){return this.easeTo(x.extend({bearing:y},M),C)}resetNorth(y,M){return this.rotateTo(0,x.extend({duration:1e3},y),M),this}resetNorthPitch(y,M){return this.easeTo(x.extend({bearing:0,pitch:0,duration:1e3},y),M),this}snapToNorth(y,M){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(y,M):this}getPitch(){return this.transform.pitch}setPitch(y,M){return this.jumpTo({pitch:y},M),this}cameraForBounds(y,M){y=x.LngLatBounds.convert(y);const C=M&&M.bearing||0;return this._cameraForBoxAndBearing(y.getNorthWest(),y.getSouthEast(),C,M)}_extendCameraOptions(y){const M={top:0,bottom:0,right:0,left:0};if(typeof(y=x.extend({padding:M,offset:[0,0],maxZoom:this.transform.maxZoom},y)).padding=="number"){const C=y.padding;y.padding={top:C,bottom:C,right:C,left:C}}return y.padding=x.extend(M,y.padding),y}_cameraForBoxAndBearing(y,M,C,L){const F=this._extendCameraOptions(L),N=this.transform,q=N.padding,W=N.project(x.LngLat.convert(y)),J=N.project(x.LngLat.convert(M)),ee=W.rotate(-x.degToRad(C)),ne=J.rotate(-x.degToRad(C)),fe=new x.pointGeometry(Math.max(ee.x,ne.x),Math.max(ee.y,ne.y)),we=new x.pointGeometry(Math.min(ee.x,ne.x),Math.min(ee.y,ne.y)),ye=fe.sub(we),Ee=(N.width-(q.left+q.right+F.padding.left+F.padding.right))/ye.x,ze=(N.height-(q.top+q.bottom+F.padding.top+F.padding.bottom))/ye.y;if(ze<0||Ee<0)return void x.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const be=Math.min(N.scaleZoom(N.scale*Math.min(Ee,ze)),F.maxZoom),Ce=typeof F.offset.x=="number"?new x.pointGeometry(F.offset.x,F.offset.y):x.pointGeometry.convert(F.offset),Pe=new x.pointGeometry((F.padding.left-F.padding.right)/2,(F.padding.top-F.padding.bottom)/2).rotate(C*Math.PI/180),Ie=Ce.add(Pe).mult(N.scale/N.zoomScale(be));return{center:N.unproject(W.add(J).div(2).sub(Ie)),zoom:be,bearing:C}}_cameraForBox(y,M,C,L,F){const N=this._extendCameraOptions(F);C=C||0,L=L||0,y=x.LngLat.convert(y),M=x.LngLat.convert(M);const q=this.transform.clone();q.padding=N.padding;const W=this.getFreeCameraOptions(),J=new x.LngLat(.5*(y.lng+M.lng),.5*(y.lat+M.lat)),ee=.5*(C+L);if(q._camera.position[2]<x.mercatorZfromAltitude(ee,J.lat))return void x.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");W.lookAtPoint(J),q.setFreeCameraOptions(W);const ne=x.MercatorCoordinate.fromLngLat(y),fe=x.MercatorCoordinate.fromLngLat(M),we=q.pointRayIntersection(q.centerPoint,ee),ye=[(Ee=q.rayIntersectionCoordinate(we)).x,Ee.y,Ee.z];var Ee;const ze=q.screenPointToMercatorRay(q.centerPoint),be=q.projection.name!=="globe";let Ce,Pe=0;do{const Ie=Math.floor(q.zoom),ke=1<<Ie,Fe=Math.min(ke*ne.x,ke*fe.x),Ye=Math.min(ke*ne.y,ke*fe.y),Ke=Math.max(ke*ne.x,ke*fe.x),yt=Math.max(ke*ne.y,ke*fe.y),dt=new x.Aabb([Fe,Ye,C],[Ke,yt,L]),ut=x.Frustum.fromInvProjectionMatrix(q.invProjMatrix,q.worldSize,Ie,be);if(dt.intersects(ut)!==2){Ce&&(q._camera.position=x.scaleAndAdd([],q._camera.position,ze.dir,-Ce),q._updateStateFromCamera());break}const tt=x.sub([],q._camera.position,ye);Ce=.5*x.length(tt),q._camera.position=x.scaleAndAdd([],q._camera.position,ze.dir,Ce);try{q._updateStateFromCamera()}catch{return void x.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}}while(++Pe<10);return{center:q.center,zoom:q.zoom,bearing:q.bearing,pitch:q.pitch}}fitBounds(y,M,C){return this._fitInternal(this.cameraForBounds(y,M),M,C)}_raycastElevationBox(y,M){const C=this.transform.elevation;if(!C)return;const L=new x.pointGeometry(y.x,M.y),F=new x.pointGeometry(M.x,y.y),N=C.pointCoordinate(y);if(!N)return;const q=C.pointCoordinate(M);if(!q)return;const W=C.pointCoordinate(L);if(!W)return;const J=C.pointCoordinate(F);if(!J)return;const ee=new x.MercatorCoordinate(N[0],N[1]).toLngLat(),ne=new x.MercatorCoordinate(q[0],q[1]).toLngLat(),fe=new x.MercatorCoordinate(W[0],W[1]).toLngLat(),we=new x.MercatorCoordinate(J[0],J[1]).toLngLat(),ye=Math.min(ee.lng,Math.min(ne.lng,Math.min(fe.lng,we.lng))),Ee=Math.min(ee.lat,Math.min(ne.lat,Math.min(fe.lat,we.lat))),ze=Math.max(ee.lng,Math.max(ne.lng,Math.max(fe.lng,we.lng))),be=Math.max(ee.lat,Math.max(ne.lat,Math.max(fe.lat,we.lat))),Ce=Math.min(N[3],Math.min(q[3],Math.min(W[3],J[3]))),Pe=Math.max(N[3],Math.max(q[3],Math.max(W[3],J[3])));return{minLngLat:new x.LngLat(ye,Ee),maxLngLat:new x.LngLat(ze,be),minAltitude:Ce,maxAltitude:Pe}}fitScreenCoordinates(y,M,C,L,F){let N,q,W,J;const ee=x.pointGeometry.convert(y),ne=x.pointGeometry.convert(M),fe=this._raycastElevationBox(ee,ne);if(fe)N=fe.minLngLat,q=fe.maxLngLat,W=fe.minAltitude,J=fe.maxAltitude;else{if(this.transform.anyCornerOffEdge(ee,ne))return this;N=this.transform.pointLocation(ee),q=this.transform.pointLocation(ne)}return this._fitInternal(this.transform.pitch===0?this._cameraForBoxAndBearing(this.transform.pointLocation(x.pointGeometry.convert(y)),this.transform.pointLocation(x.pointGeometry.convert(M)),C,L):this._cameraForBox(N,q,W,J,L),L,F)}_fitInternal(y,M,C){return y?(delete(M=x.extend(y,M)).padding,M.linear?this.easeTo(M,C):this.flyTo(M,C)):this}jumpTo(y,M){this.stop();const C=y.preloadOnly?this.transform.clone():this.transform;let L=!1,F=!1,N=!1;return"zoom"in y&&C.zoom!==+y.zoom&&(L=!0,C.zoom=+y.zoom),y.center!==void 0&&(C.center=x.LngLat.convert(y.center)),"bearing"in y&&C.bearing!==+y.bearing&&(F=!0,C.bearing=+y.bearing),"pitch"in y&&C.pitch!==+y.pitch&&(N=!0,C.pitch=+y.pitch),y.padding==null||C.isPaddingEqual(y.padding)||(C.padding=y.padding),y.preloadOnly?(this._preloadTiles(C),this):(this.fire(new x.Event("movestart",M)).fire(new x.Event("move",M)),L&&this.fire(new x.Event("zoomstart",M)).fire(new x.Event("zoom",M)).fire(new x.Event("zoomend",M)),F&&this.fire(new x.Event("rotatestart",M)).fire(new x.Event("rotate",M)).fire(new x.Event("rotateend",M)),N&&this.fire(new x.Event("pitchstart",M)).fire(new x.Event("pitch",M)).fire(new x.Event("pitchend",M)),this.fire(new x.Event("moveend",M)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||x.warnOnce(rl),this.transform.getFreeCameraOptions()}setFreeCameraOptions(y,M){const C=this.transform;if(!C.projection.supportsFreeCamera)return void x.warnOnce(rl);this.stop();const L=C.zoom,F=C.pitch,N=C.bearing;C.setFreeCameraOptions(y);const q=L!==C.zoom,W=F!==C.pitch,J=N!==C.bearing;return this.fire(new x.Event("movestart",M)).fire(new x.Event("move",M)),q&&this.fire(new x.Event("zoomstart",M)).fire(new x.Event("zoom",M)).fire(new x.Event("zoomend",M)),J&&this.fire(new x.Event("rotatestart",M)).fire(new x.Event("rotate",M)).fire(new x.Event("rotateend",M)),W&&this.fire(new x.Event("pitchstart",M)).fire(new x.Event("pitch",M)).fire(new x.Event("pitchend",M)),this.fire(new x.Event("moveend",M)),this}easeTo(y,M){this._stop(!1,y.easeId),((y=x.extend({offset:[0,0],duration:500,easing:x.ease},y)).animate===!1||!y.essential&&x.exported.prefersReducedMotion)&&(y.duration=0);const C=this.transform,L=this.getZoom(),F=this.getBearing(),N=this.getPitch(),q=this.getPadding(),W="zoom"in y?+y.zoom:L,J="bearing"in y?this._normalizeBearing(y.bearing,F):F,ee="pitch"in y?+y.pitch:N,ne="padding"in y?y.padding:C.padding,fe=x.pointGeometry.convert(y.offset);let we=C.centerPoint.add(fe);const ye=C.projection.name==="globe"?C.pointCoordinate(we).toLngLat():C.pointLocation(we),Ee=x.LngLat.convert(y.center||ye);this._normalizeCenter(Ee);const ze=C.project(ye),be=C.project(Ee).sub(ze),Ce=C.zoomScale(W-L);let Pe,Ie;y.around&&(Pe=x.LngLat.convert(y.around),Ie=C.locationPoint(Pe));const ke=this._zooming||W!==L,Fe=this._rotating||F!==J,Ye=this._pitching||ee!==N,Ke=!C.isPaddingEqual(ne),yt=ut=>tt=>{if(ke&&(ut.zoom=x.number(L,W,tt)),Fe&&(ut.bearing=x.number(F,J,tt)),Ye&&(ut.pitch=x.number(N,ee,tt)),Ke&&(ut.interpolatePadding(q,ne,tt),we=ut.centerPoint.add(fe)),Pe)ut.setLocationAtPoint(Pe,Ie);else{const We=ut.zoomScale(ut.zoom-L),ct=W>L?Math.min(2,Ce):Math.max(.5,Ce),ot=Math.pow(ct,1-tt),Xt=ut.unproject(ze.add(be.mult(tt*ot)).mult(We));ut.setLocationAtPoint(ut.renderWorldCopies?Xt.wrap():Xt,we)}return y.preloadOnly||this._fireMoveEvents(M),ut};if(y.preloadOnly){const ut=this._emulate(yt,y.duration,C);return this._preloadTiles(ut),this}const dt={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=ke,this._rotating=Fe,this._pitching=Ye,this._padding=Ke,this._easeId=y.easeId,this._prepareEase(M,y.noMoveStart,dt),this._ease(yt(C),ut=>{C.recenterOnTerrain(),this._afterEase(M,ut)},y),this}_prepareEase(y,M,C={}){this._moving=!0,this.transform.cameraElevationReference="sea",M||C.moving||this.fire(new x.Event("movestart",y)),this._zooming&&!C.zooming&&this.fire(new x.Event("zoomstart",y)),this._rotating&&!C.rotating&&this.fire(new x.Event("rotatestart",y)),this._pitching&&!C.pitching&&this.fire(new x.Event("pitchstart",y))}_fireMoveEvents(y){this.fire(new x.Event("move",y)),this._zooming&&this.fire(new x.Event("zoom",y)),this._rotating&&this.fire(new x.Event("rotate",y)),this._pitching&&this.fire(new x.Event("pitch",y))}_afterEase(y,M){if(this._easeId&&M&&this._easeId===M)return;delete this._easeId,this.transform.cameraElevationReference="ground";const C=this._zooming,L=this._rotating,F=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,C&&this.fire(new x.Event("zoomend",y)),L&&this.fire(new x.Event("rotateend",y)),F&&this.fire(new x.Event("pitchend",y)),this.fire(new x.Event("moveend",y))}flyTo(y,M){if(!y.essential&&x.exported.prefersReducedMotion){const _t=x.pick(y,["center","zoom","bearing","pitch","around"]);return this.jumpTo(_t,M)}this.stop(),y=x.extend({offset:[0,0],speed:1.2,curve:1.42,easing:x.ease},y);const C=this.transform,L=this.getZoom(),F=this.getBearing(),N=this.getPitch(),q=this.getPadding(),W="zoom"in y?x.clamp(+y.zoom,C.minZoom,C.maxZoom):L,J="bearing"in y?this._normalizeBearing(y.bearing,F):F,ee="pitch"in y?+y.pitch:N,ne="padding"in y?y.padding:C.padding,fe=C.zoomScale(W-L),we=x.pointGeometry.convert(y.offset);let ye=C.centerPoint.add(we);const Ee=C.pointLocation(ye),ze=x.LngLat.convert(y.center||Ee);this._normalizeCenter(ze);const be=C.project(Ee),Ce=C.project(ze).sub(be);let Pe=y.curve;const Ie=Math.max(C.width,C.height),ke=Ie/fe,Fe=Ce.mag();if("minZoom"in y){const _t=x.clamp(Math.min(y.minZoom,L,W),C.minZoom,C.maxZoom),Kt=Ie/C.zoomScale(_t-L);Pe=Math.sqrt(Kt/Fe*2)}const Ye=Pe*Pe;function Ke(_t){const Kt=(ke*ke-Ie*Ie+(_t?-1:1)*Ye*Ye*Fe*Fe)/(2*(_t?ke:Ie)*Ye*Fe);return Math.log(Math.sqrt(Kt*Kt+1)-Kt)}function yt(_t){return(Math.exp(_t)-Math.exp(-_t))/2}function dt(_t){return(Math.exp(_t)+Math.exp(-_t))/2}const ut=Ke(0);let tt=function(_t){return dt(ut)/dt(ut+Pe*_t)},We=function(_t){return Ie*((dt(ut)*(yt(Kt=ut+Pe*_t)/dt(Kt))-yt(ut))/Ye)/Fe;var Kt},ct=(Ke(1)-ut)/Pe;if(Math.abs(Fe)<1e-6||!isFinite(ct)){if(Math.abs(Ie-ke)<1e-6)return this.easeTo(y,M);const _t=ke<Ie?-1:1;ct=Math.abs(Math.log(ke/Ie))/Pe,We=function(){return 0},tt=function(Kt){return Math.exp(_t*Pe*Kt)}}y.duration="duration"in y?+y.duration:1e3*ct/("screenSpeed"in y?+y.screenSpeed/Pe:+y.speed),y.maxDuration&&y.duration>y.maxDuration&&(y.duration=0);const ot=F!==J,Xt=ee!==N,ti=!C.isPaddingEqual(ne),vi=_t=>Kt=>{const ci=Kt*ct,qi=1/tt(ci);_t.zoom=Kt===1?W:L+_t.scaleZoom(qi),ot&&(_t.bearing=x.number(F,J,Kt)),Xt&&(_t.pitch=x.number(N,ee,Kt)),ti&&(_t.interpolatePadding(q,ne,Kt),ye=_t.centerPoint.add(we));const Ji=Kt===1?ze:_t.unproject(be.add(Ce.mult(We(ci))).mult(qi));return _t.setLocationAtPoint(_t.renderWorldCopies?Ji.wrap():Ji,ye),_t._updateCenterElevation(),y.preloadOnly||this._fireMoveEvents(M),_t};if(y.preloadOnly){const _t=this._emulate(vi,y.duration,C);return this._preloadTiles(_t),this}return this._zooming=!0,this._rotating=ot,this._pitching=Xt,this._padding=ti,this._prepareEase(M,!1),this._ease(vi(C),()=>this._afterEase(M),y),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(y,M){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const C=this._onEaseEnd;delete this._onEaseEnd,C.call(this,M)}if(!y){const C=this.handlers;C&&C.stop(!1)}return this}_ease(y,M,C){C.animate===!1||C.duration===0?(y(1),M()):(this._easeStart=x.exported.now(),this._easeOptions=C,this._onEaseFrame=y,this._onEaseEnd=M,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const y=Math.min((x.exported.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(y)),y<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(y,M){y=x.wrap(y,-180,180);const C=Math.abs(y-M);return Math.abs(y-360-M)<C&&(y-=360),Math.abs(y+360-M)<C&&(y+=360),y}_normalizeCenter(y){const M=this.transform;if(!M.renderWorldCopies||M.maxBounds)return;const C=y.lng-M.center.lng;y.lng+=C>180?-360:C<-180?360:0}_emulate(y,M,C){const L=Math.ceil(15*M/1e3),F=[],N=y(C.clone());for(let q=0;q<=L;q++){const W=N(q/L);F.push(W.clone())}return F}}class nl{constructor(y={}){this.options=y,x.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(y){const M=this.options&&this.options.compact;return this._map=y,this._container=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=j.create("button","mapboxgl-ctrl-attrib-button",this._container),j.create("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden",!0),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=j.create("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),M&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),M===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(y,M){const C=this._map._getUIString(`AttributionControl.${M}`);y.setAttribute("aria-label",C),y.removeAttribute("title"),y.firstElementChild&&y.firstElementChild.setAttribute("title",C)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let y=this._editLink;y||(y=this._editLink=this._container.querySelector(".mapbox-improve-map"));const M=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||x.config.ACCESS_TOKEN}];if(y){const C=M.reduce((L,F,N)=>(F.value&&(L+=`${F.key}=${F.value}${N<M.length-1?"&":""}`),L),"?");y.href=`${x.config.FEEDBACK_URL}/${C}${this._map._hash?this._map._hash.getHashString(!0):""}`,y.rel="noopener nofollow",this._setElementTitle(y,"MapFeedback")}}_updateData(y){!y||y.sourceDataType!=="metadata"&&y.sourceDataType!=="visibility"&&y.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let y=[];if(this._map.style.stylesheet){const L=this._map.style.stylesheet;this.styleOwner=L.owner,this.styleId=L.id}const M=this._map.style._sourceCaches;for(const L in M){const F=M[L];if(F.used){const N=F.getSource();N.attribution&&y.indexOf(N.attribution)<0&&y.push(N.attribution)}}y.sort((L,F)=>L.length-F.length),y=y.filter((L,F)=>{for(let N=F+1;N<y.length;N++)if(y[N].indexOf(L)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?y=[...this.options.customAttribution,...y]:y.unshift(this.options.customAttribution));const C=y.join(" | ");C!==this._attribHTML&&(this._attribHTML=C,y.length?(this._innerContainer.innerHTML=C,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class ol{constructor(){x.bindAll(["_updateLogo"],this),x.bindAll(["_updateCompact"],this)}onAdd(y){this._map=y,this._container=j.create("div","mapboxgl-ctrl");const M=j.create("a","mapboxgl-ctrl-logo");return M.target="_blank",M.rel="noopener nofollow",M.href="https://www.mapbox.com/",M.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),M.setAttribute("rel","noopener nofollow"),this._container.appendChild(M),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(y){y&&y.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const y=this._map.style._sourceCaches;if(Object.entries(y).length===0)return!0;for(const M in y){const C=y[M].getSource();if(C.hasOwnProperty("mapbox_logo")&&!C.mapbox_logo)return!1}return!0}_updateCompact(){const y=this._container.children;if(y.length){const M=y[0];this._map.getCanvasContainer().offsetWidth<250?M.classList.add("mapboxgl-compact"):M.classList.remove("mapboxgl-compact")}}}class sl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(y){const M=++this._id;return this._queue.push({callback:y,id:M,cancelled:!1}),M}remove(y){const M=this._currentlyRunning,C=M?this._queue.concat(M):this._queue;for(const L of C)if(L.id===y)return void(L.cancelled=!0)}run(y=0){const M=this._currentlyRunning=this._queue;this._queue=[];for(const C of M)if(!C.cancelled&&(C.callback(y),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function al(I,y,M){if(I=new x.LngLat(I.lng,I.lat),y){const C=new x.LngLat(I.lng-360,I.lat),L=new x.LngLat(I.lng+360,I.lat),F=360*Math.ceil(Math.abs(I.lng-M.center.lng)/360),N=M.locationPoint(I).distSqr(y),q=y.x<0||y.y<0||y.x>M.width||y.y>M.height;M.locationPoint(C).distSqr(y)<N&&(q||Math.abs(C.lng-M.center.lng)<F)?I=C:M.locationPoint(L).distSqr(y)<N&&(q||Math.abs(L.lng-M.center.lng)<F)&&(I=L)}for(;Math.abs(I.lng-M.center.lng)>180;){const C=M.locationPoint(I);if(C.x>=0&&C.y>=0&&C.x<=M.width&&C.y<=M.height)break;I.lng>M.center.lng?I.lng-=360:I.lng+=360}return I}const Ar={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class ll extends x.Evented{constructor(y,M){if(super(),(y instanceof x.window.HTMLElement||M)&&(y=x.extend({element:y},M)),x.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=y&&y.anchor||"center",this._color=y&&y.color||"#3FB1CE",this._scale=y&&y.scale||1,this._draggable=y&&y.draggable||!1,this._clickTolerance=y&&y.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=y&&y.rotation||0,this._rotationAlignment=y&&y.rotationAlignment||"auto",this._pitchAlignment=y&&y.pitchAlignment&&y.pitchAlignment!=="auto"?y.pitchAlignment:this._rotationAlignment,this._updateMoving=()=>this._update(!0),y&&y.element)this._element=y.element,this._offset=x.pointGeometry.convert(y&&y.offset||[0,0]);else{this._defaultMarker=!0,this._element=j.create("div");const L=41,F=27,N=j.createSVG("svg",{display:"block",height:L*this._scale+"px",width:F*this._scale+"px",viewBox:`0 0 ${F} ${L}`},this._element),q=j.createSVG("radialGradient",{id:"shadowGradient"},j.createSVG("defs",{},N));j.createSVG("stop",{offset:"10%","stop-opacity":.4},q),j.createSVG("stop",{offset:"100%","stop-opacity":.05},q),j.createSVG("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},N),j.createSVG("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},N),j.createSVG("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},N),j.createSVG("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},N),this._offset=x.pointGeometry.convert(y&&y.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",L=>{L.preventDefault()}),this._element.addEventListener("mousedown",L=>{L.preventDefault()});const C=this._element.classList;for(const L in Ar)C.remove(`mapboxgl-marker-anchor-${L}`);C.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(y){return y===this._map||(this.remove(),this._map=y,y.getCanvasContainer().appendChild(this._element),y.on("move",this._updateMoving),y.on("moveend",this._update),y.on("remove",this._clearFadeTimer),y._addMarker(this),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick)),this}remove(){return this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._updateMoving),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._map.off("remove",this._clearFadeTimer),this._map._removeMarker(this),delete this._map),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(y){return this._lngLat=x.LngLat.convert(y),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(y){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),y){if(!("offset"in y.options)){const L=Math.sqrt(Math.pow(13.5,2)/2);y.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[L,-1*(38.1-13.5+L)],"bottom-right":[-L,-1*(38.1-13.5+L)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=y,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(y){const M=y.code,C=y.charCode||y.keyCode;M!=="Space"&&M!=="Enter"&&C!==32&&C!==13||this.togglePopup()}_onMapClick(y){const M=y.originalEvent.target,C=this._element;this._popup&&(M===C||C.contains(M))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const y=this._popup;return y?(y.isOpen()?(y.remove(),this._element.setAttribute("aria-expanded","false")):(y.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_evaluateOpacity(){const y=this._pos?this._pos.sub(this._transformedOffset()):null;if(!this._withinScreenBounds(y))return void this._clearFadeTimer();const M=this._map.unproject(y);let C=!1;if(this._map.transform._terrainEnabled()&&this._map.getTerrain()){const F=this._map.getFreeCameraOptions();if(F.position){const N=F.position.toLngLat();C=N.distanceTo(M)<.9*N.distanceTo(this._lngLat)}}const L=(1-this._map._queryFogOpacity(M))*(C?.2:1);this._element.style.opacity=`${L}`,this._popup&&this._popup._setOpacity(`${L}`),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_withinScreenBounds(y){const M=this._map.transform;return!!y&&y.x>=0&&y.x<M.width&&y.y>=0&&y.y<M.height}_updateDOM(){const y=this._pos||new x.pointGeometry(0,0),M=this._calculatePitch(),C=this._calculateRotation();this._element.style.transform=`${Ar[this._anchor]} translate(${y.x}px, ${y.y}px) rotateX(${M}deg) rotateZ(${C}deg)`}_calculatePitch(){return this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?0:this._pitchAlignment==="map"?this._map.getPitch():0}_calculateRotation(){return this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?this._rotation:this._rotationAlignment==="map"?this._rotation-this._map.getBearing():0}_update(y){x.window.cancelAnimationFrame(this._updateFrameId),this._map&&(this._map.transform.renderWorldCopies&&(this._lngLat=al(this._lngLat,this._pos,this._map.transform)),this._pos=this._map.project(this._lngLat)._add(this._transformedOffset()),y===!0?this._updateFrameId=x.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),this._map._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),!this._map.getTerrain()&&!this._map.getFog()||this._fadeTimer||(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}_transformedOffset(){if(!this._defaultMarker)return this._offset;const y=this._map.transform,M=this._offset.mult(this._scale);return this._rotationAlignment==="map"&&M._rotate(y.angle),this._pitchAlignment==="map"&&(M.y*=Math.cos(y._pitch)),M}getOffset(){return this._offset}setOffset(y){return this._offset=x.pointGeometry.convert(y),this._update(),this}_onMove(y){if(!this._isDragging){const M=this._clickTolerance||this._map._clickTolerance;this._isDragging=y.point.dist(this._pointerdownPos)>=M}this._isDragging&&(this._pos=y.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new x.Event("dragstart"))),this.fire(new x.Event("drag")))}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new x.Event("dragend")),this._state="inactive"}_addDragHandler(y){this._element.contains(y.originalEvent.target)&&(y.preventDefault(),this._positionDelta=y.point.sub(this._pos).add(this._transformedOffset()),this._pointerdownPos=y.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))}setDraggable(y){return this._draggable=!!y,this._map&&(y?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(y){return this._rotation=y||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(y){return this._rotationAlignment=y||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(y){return this._pitchAlignment=y&&y!=="auto"?y:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}}class zn{constructor(y){this.jumpTo(y)}getValue(y){if(y<=this._startTime)return this._start;if(y>=this._endTime)return this._end;const M=x.easeCubicInOut((y-this._startTime)/(this._endTime-this._startTime));return this._start*(1-M)+this._end*M}isEasing(y){return y>=this._startTime&&y<=this._endTime}jumpTo(y){this._startTime=-1/0,this._endTime=-1/0,this._start=y,this._end=y}easeTo(y,M,C){this._start=this.getValue(M),this._end=y,this._startTime=M,this._endTime=M+C}}const ph={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},{HTMLImageElement:yn,HTMLElement:Ro,ImageBitmap:Bo}=x.window,fc={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function hl(I){I.parentNode&&I.parentNode.removeChild(I)}const pc={showCompass:!0,showZoom:!0,visualizePitch:!1};class mh{constructor(y,M,C=!1){this._clickTolerance=10,this.element=M,this.mouseRotate=new hn({clickTolerance:y.dragRotate._mouseRotate._clickTolerance}),this.map=y,C&&(this.mousePitch=new Ja({clickTolerance:y.dragRotate._mousePitch._clickTolerance})),x.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),M.addEventListener("mousedown",this.mousedown),M.addEventListener("touchstart",this.touchstart,{passive:!1}),M.addEventListener("touchmove",this.touchmove),M.addEventListener("touchend",this.touchend),M.addEventListener("touchcancel",this.reset)}down(y,M){this.mouseRotate.mousedown(y,M),this.mousePitch&&this.mousePitch.mousedown(y,M),j.disableDrag()}move(y,M){const C=this.map,L=this.mouseRotate.mousemoveWindow(y,M);if(L&&L.bearingDelta&&C.setBearing(C.getBearing()+L.bearingDelta),this.mousePitch){const F=this.mousePitch.mousemoveWindow(y,M);F&&F.pitchDelta&&C.setPitch(C.getPitch()+F.pitchDelta)}}off(){const y=this.element;y.removeEventListener("mousedown",this.mousedown),y.removeEventListener("touchstart",this.touchstart,{passive:!1}),y.removeEventListener("touchmove",this.touchmove),y.removeEventListener("touchend",this.touchend),y.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){j.enableDrag(),x.window.removeEventListener("mousemove",this.mousemove),x.window.removeEventListener("mouseup",this.mouseup)}mousedown(y){this.down(x.extend({},y,{ctrlKey:!0,preventDefault:()=>y.preventDefault()}),j.mousePos(this.element,y)),x.window.addEventListener("mousemove",this.mousemove),x.window.addEventListener("mouseup",this.mouseup)}mousemove(y){this.move(y,j.mousePos(this.element,y))}mouseup(y){this.mouseRotate.mouseupWindow(y),this.mousePitch&&this.mousePitch.mouseupWindow(y),this.offTemp()}touchstart(y){y.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=j.touchPos(this.element,y.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>y.preventDefault()},this._startPos))}touchmove(y){y.targetTouches.length!==1?this.reset():(this._lastPos=j.touchPos(this.element,y.targetTouches)[0],this.move({preventDefault:()=>y.preventDefault()},this._lastPos))}touchend(y){y.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const ys={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1};let Vr,xs=0,Lo=!1;const vs={maxWidth:100,unit:"metric"};function Ft(I,y,M){const C=M&&M.maxWidth||100,L=I._containerHeight/2,F=I.unproject([0,L]),N=I.unproject([C,L]),q=F.distanceTo(N);if(M&&M.unit==="imperial"){const W=3.2808*q;W>5280?zo(y,C,W/5280,I._getUIString("ScaleControl.Miles"),I):zo(y,C,W,I._getUIString("ScaleControl.Feet"),I)}else M&&M.unit==="nautical"?zo(y,C,q/1852,I._getUIString("ScaleControl.NauticalMiles"),I):q>=1e3?zo(y,C,q/1e3,I._getUIString("ScaleControl.Kilometers"),I):zo(y,C,q,I._getUIString("ScaleControl.Meters"),I)}function zo(I,y,M,C,L){const F=function(q){const W=Math.pow(10,`${Math.floor(q)}`.length-1);let J=q/W;return J=J>=10?10:J>=5?5:J>=3?3:J>=2?2:J>=1?1:function(ee){const ne=Math.pow(10,Math.ceil(-Math.log(ee)/Math.LN10));return Math.round(ee*ne)/ne}(J),W*J}(M),N=F/M;L._requestDomTask(()=>{I.style.width=y*N+"px",I.innerHTML=`${F}&nbsp;${C}`})}const gh={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},bs=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", "),eo={version:x.version,supported:B,setRTLTextPlugin:x.setRTLTextPlugin,getRTLTextPluginStatus:x.getRTLTextPluginStatus,Map:class extends fh{constructor(I){if((I=x.extend({},fc,I)).minZoom!=null&&I.maxZoom!=null&&I.minZoom>I.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(I.minPitch!=null&&I.maxPitch!=null&&I.minPitch>I.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(I.minPitch!=null&&I.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(I.maxPitch!=null&&I.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new ds(I.minZoom,I.maxZoom,I.minPitch,I.maxPitch,I.renderWorldCopies),I),this._interactive=I.interactive,this._minTileCacheSize=I.minTileCacheSize,this._maxTileCacheSize=I.maxTileCacheSize,this._failIfMajorPerformanceCaveat=I.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=I.preserveDrawingBuffer,this._antialias=I.antialias,this._trackResize=I.trackResize,this._bearingSnap=I.bearingSnap,this._refreshExpiredTiles=I.refreshExpiredTiles,this._fadeDuration=I.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=I.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=I.collectResourceTiming,this._optimizeForTerrain=I.optimizeForTerrain,this._renderTaskQueue=new sl,this._domRenderTaskQueue=new sl,this._controls=[],this._markers=[],this._mapId=x.uniqueId(),this._locale=x.extend({},ph,I.locale),this._clickTolerance=I.clickTolerance,this._cooperativeGestures=I.cooperativeGestures,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevation=new zn(0),this._requestManager=new x.RequestManager(I.transformRequest,I.accessToken,I.testMode),this._silenceAuthErrors=!!I.testMode,typeof I.container=="string"){if(this._container=x.window.document.getElementById(I.container),!this._container)throw new Error(`Container '${I.container}' not found.`)}else{if(!(I.container instanceof Ro))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=I.container}if(this._container.childNodes.length>0&&x.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),I.maxBounds&&this.setMaxBounds(I.maxBounds),x.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),x.window!==void 0&&(x.window.addEventListener("online",this._onWindowOnline,!1),x.window.addEventListener("resize",this._onWindowResize,!1),x.window.addEventListener("orientationchange",this._onWindowResize,!1),x.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new Po(this,I),this._localFontFamily=I.localFontFamily,this._localIdeographFontFamily=I.localIdeographFontFamily,I.style&&this.setStyle(I.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),I.projection&&this.setProjection(I.projection),this._hash=I.hash&&new ih(typeof I.hash=="string"&&I.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:I.center,zoom:I.zoom,bearing:I.bearing,pitch:I.pitch}),I.bounds&&(this.resize(),this.fitBounds(I.bounds,x.extend({},I.fitBoundsOptions,{duration:0})))),this.resize(),I.attributionControl&&this.addControl(new nl({customAttribution:I.customAttribution})),this._logoControl=new ol,this.addControl(this._logoControl,I.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",y=>{this._update(y.dataType==="style"),this.fire(new x.Event(`${y.dataType}data`,y))}),this.on("dataloading",y=>{this.fire(new x.Event(`${y.dataType}dataloading`,y))})}_getMapId(){return this._mapId}addControl(I,y){if(y===void 0&&(y=I.getDefaultPosition?I.getDefaultPosition():"top-right"),!I||!I.onAdd)return this.fire(new x.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const M=I.onAdd(this);this._controls.push(I);const C=this._controlPositions[y];return y.indexOf("bottom")!==-1?C.insertBefore(M,C.firstChild):C.appendChild(M),this}removeControl(I){if(!I||!I.onRemove)return this.fire(new x.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const y=this._controls.indexOf(I);return y>-1&&this._controls.splice(y,1),I.onRemove(this),this}hasControl(I){return this._controls.indexOf(I)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(I){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const y=!this._moving;return y&&this.fire(new x.Event("movestart",I)).fire(new x.Event("move",I)),this.fire(new x.Event("resize",I)),y&&this.fire(new x.Event("moveend",I)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(I){return this.transform.setMaxBounds(x.LngLatBounds.convert(I)),this._update()}setMinZoom(I){if((I=I==null?-2:I)>=-2&&I<=this.transform.maxZoom)return this.transform.minZoom=I,this._update(),this.getZoom()<I?this.setZoom(I):this.fire(new x.Event("zoomstart")).fire(new x.Event("zoom")).fire(new x.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(I){if((I=I==null?22:I)>=this.transform.minZoom)return this.transform.maxZoom=I,this._update(),this.getZoom()>I?this.setZoom(I):this.fire(new x.Event("zoomstart")).fire(new x.Event("zoom")).fire(new x.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(I){if((I=I==null?0:I)<0)throw new Error("minPitch must be greater than or equal to 0");if(I>=0&&I<=this.transform.maxPitch)return this.transform.minPitch=I,this._update(),this.getPitch()<I?this.setPitch(I):this.fire(new x.Event("pitchstart")).fire(new x.Event("pitch")).fire(new x.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(I){if((I=I==null?85:I)>85)throw new Error("maxPitch must be less than or equal to 85");if(I>=this.transform.minPitch)return this.transform.maxPitch=I,this._update(),this.getPitch()>I?this.setPitch(I):this.fire(new x.Event("pitchstart")).fire(new x.Event("pitch")).fire(new x.Event("pitchend")),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(I){return this.transform.renderWorldCopies=I,this._update()}getProjection(){return this.transform.getProjection()}setProjection(I){return this._lazyInitEmptyStyle(),typeof I=="string"&&(I={name:I}),this._runtimeProjection=I,this.style.updateProjection(),this._transitionFromGlobe=!1,this}project(I){return this.transform.locationPoint3D(x.LngLat.convert(I))}unproject(I){return this.transform.pointLocation3D(x.pointGeometry.convert(I))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()}_createDelegatedListener(I,y,M){if(I==="mouseenter"||I==="mouseover"){let C=!1;const L=N=>{const q=y.filter(J=>this.getLayer(J)),W=q.length?this.queryRenderedFeatures(N.point,{layers:q}):[];W.length?C||(C=!0,M.call(this,new zr(I,this,N.originalEvent,{features:W}))):C=!1},F=()=>{C=!1};return{layers:new Set(y),listener:M,delegates:{mousemove:L,mouseout:F}}}if(I==="mouseleave"||I==="mouseout"){let C=!1;const L=N=>{const q=y.filter(W=>this.getLayer(W));(q.length?this.queryRenderedFeatures(N.point,{layers:q}):[]).length?C=!0:C&&(C=!1,M.call(this,new zr(I,this,N.originalEvent)))},F=N=>{C&&(C=!1,M.call(this,new zr(I,this,N.originalEvent)))};return{layers:new Set(y),listener:M,delegates:{mousemove:L,mouseout:F}}}{const C=L=>{const F=y.filter(q=>this.getLayer(q)),N=F.length?this.queryRenderedFeatures(L.point,{layers:F}):[];N.length&&(L.features=N,M.call(this,L),delete L.features)};return{layers:new Set(y),listener:M,delegates:{[I]:C}}}}on(I,y,M){if(M===void 0)return super.on(I,y);Array.isArray(y)||(y=[y]);const C=this._createDelegatedListener(I,y,M);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[I]=this._delegatedListeners[I]||[],this._delegatedListeners[I].push(C);for(const L in C.delegates)this.on(L,C.delegates[L]);return this}once(I,y,M){if(M===void 0)return super.once(I,y);Array.isArray(y)||(y=[y]);const C=this._createDelegatedListener(I,y,M);for(const L in C.delegates)this.once(L,C.delegates[L]);return this}off(I,y,M){if(M===void 0)return super.off(I,y);y=new Set(Array.isArray(y)?y:[y]);const C=(F,N)=>{if(F.size!==N.size)return!1;for(const q of F)if(!N.has(q))return!1;return!0},L=this._delegatedListeners?this._delegatedListeners[I]:void 0;return L&&(F=>{for(let N=0;N<F.length;N++){const q=F[N];if(q.listener===M&&C(q.layers,y)){for(const W in q.delegates)this.off(W,q.delegates[W]);return F.splice(N,1),this}}})(L),this}queryRenderedFeatures(I,y){return this.style?(y!==void 0||I===void 0||I instanceof x.pointGeometry||Array.isArray(I)||(y=I,I=void 0),this.style.queryRenderedFeatures(I=I||[[0,0],[this.transform.width,this.transform.height]],y=y||{},this.transform)):[]}querySourceFeatures(I,y){return this.style.querySourceFeatures(I,y)}queryTerrainElevation(I,y){const M=this.transform.elevation;return M?(y=x.extend({},{exaggerated:!0},y),M.getAtPoint(x.MercatorCoordinate.fromLngLat(I),null,y.exaggerated)):null}setStyle(I,y){return(y=x.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},y)).diff!==!1&&y.localIdeographFontFamily===this._localIdeographFontFamily&&y.localFontFamily===this._localFontFamily&&this.style&&I?(this._diffStyle(I,y),this):(this._localIdeographFontFamily=y.localIdeographFontFamily,this._localFontFamily=y.localFontFamily,this._updateStyle(I,y))}_getUIString(I){const y=this._locale[I];if(y==null)throw new Error(`Missing UI string '${I}'`);return y}_updateStyle(I,y){return this.style&&(this.style.setEventedParent(null),this.style._remove(),delete this.style),I&&(this.style=new Zr(this,y||{}),this.style.setEventedParent(this,{style:this.style}),typeof I=="string"?this.style.loadURL(I):this.style.loadJSON(I)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Zr(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(I,y){if(typeof I=="string"){const M=this._requestManager.normalizeStyleURL(I),C=this._requestManager.transformRequest(M,x.ResourceType.Style);x.getJSON(C,(L,F)=>{L?this.fire(new x.ErrorEvent(L)):F&&this._updateDiff(F,y)})}else typeof I=="object"&&this._updateDiff(I,y)}_updateDiff(I,y){try{this.style.setState(I)&&this._update(!0)}catch(M){x.warnOnce(`Unable to perform style diff: ${M.message||M.error||M}.  Rebuilding the style from scratch.`),this._updateStyle(I,y)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():x.warnOnce("There is no style added to the map.")}addSource(I,y){return this._lazyInitEmptyStyle(),this.style.addSource(I,y),this._update(!0)}isSourceLoaded(I){const y=this.style&&this.style._getSourceCaches(I);if(y.length!==0)return y.every(M=>M.loaded());this.fire(new x.ErrorEvent(new Error(`There is no source with ID '${I}'`)))}areTilesLoaded(){const I=this.style&&this.style._sourceCaches;for(const y in I){const M=I[y]._tiles;for(const C in M){const L=M[C];if(L.state!=="loaded"&&L.state!=="errored")return!1}}return!0}addSourceType(I,y,M){return this._lazyInitEmptyStyle(),this.style.addSourceType(I,y,M)}removeSource(I){return this.style.removeSource(I),this._updateTerrain(),this._update(!0)}getSource(I){return this.style.getSource(I)}addImage(I,y,{pixelRatio:M=1,sdf:C=!1,stretchX:L,stretchY:F,content:N}={}){if(this._lazyInitEmptyStyle(),y instanceof yn||Bo&&y instanceof Bo){const{width:q,height:W,data:J}=x.exported.getImageData(y);this.style.addImage(I,{data:new x.RGBAImage({width:q,height:W},J),pixelRatio:M,stretchX:L,stretchY:F,content:N,sdf:C,version:0})}else{if(y.width===void 0||y.height===void 0)return this.fire(new x.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:q,height:W,data:J}=y,ee=y;this.style.addImage(I,{data:new x.RGBAImage({width:q,height:W},new Uint8Array(J)),pixelRatio:M,stretchX:L,stretchY:F,content:N,sdf:C,version:0,userImage:ee}),ee.onAdd&&ee.onAdd(this,I)}}}updateImage(I,y){const M=this.style.getImage(I);if(!M)return this.fire(new x.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const C=y instanceof yn||Bo&&y instanceof Bo?x.exported.getImageData(y):y,{width:L,height:F,data:N}=C;return L===void 0||F===void 0?this.fire(new x.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`"))):L!==M.data.width||F!==M.data.height?this.fire(new x.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image"))):(M.data.replace(N,!(y instanceof yn||Bo&&y instanceof Bo)),void this.style.updateImage(I,M))}hasImage(I){return I?!!this.style.getImage(I):(this.fire(new x.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(I){this.style.removeImage(I)}loadImage(I,y){x.getImage(this._requestManager.transformRequest(I,x.ResourceType.Image),(M,C)=>{y(M,C instanceof yn?x.exported.getImageData(C):C)})}listImages(){return this.style.listImages()}addLayer(I,y){return this._lazyInitEmptyStyle(),this.style.addLayer(I,y),this._update(!0)}moveLayer(I,y){return this.style.moveLayer(I,y),this._update(!0)}removeLayer(I){return this.style.removeLayer(I),this._update(!0)}getLayer(I){return this.style.getLayer(I)}setLayerZoomRange(I,y,M){return this.style.setLayerZoomRange(I,y,M),this._update(!0)}setFilter(I,y,M={}){return this.style.setFilter(I,y,M),this._update(!0)}getFilter(I){return this.style.getFilter(I)}setPaintProperty(I,y,M,C={}){return this.style.setPaintProperty(I,y,M,C),this._update(!0)}getPaintProperty(I,y){return this.style.getPaintProperty(I,y)}setLayoutProperty(I,y,M,C={}){return this.style.setLayoutProperty(I,y,M,C),this._update(!0)}getLayoutProperty(I,y){return this.style.getLayoutProperty(I,y)}setLight(I,y={}){return this._lazyInitEmptyStyle(),this.style.setLight(I,y),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(I){return this._lazyInitEmptyStyle(),!I&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(I),this._averageElevationLastSampledAt=-1/0,this._update(!0)}_updateProjection(){this.transform.projection.name==="globe"&&this.transform.zoom>=x.GLOBE_ZOOM_THRESHOLD_MAX&&!this._transitionFromGlobe&&(this.setProjection({name:"mercator"}),this._transitionFromGlobe=!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(I){return this._lazyInitEmptyStyle(),this.style.setFog(I),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(I){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(x.LngLat.convert(I),this.transform):0}setFeatureState(I,y){return this.style.setFeatureState(I,y),this._update()}removeFeatureState(I,y){return this.style.removeFeatureState(I,y),this._update()}getFeatureState(I){return this.style.getFeatureState(I)}_updateContainerDimensions(){if(!this._container)return;const I=this._container.getBoundingClientRect().width||400,y=this._container.getBoundingClientRect().height||300;let M,C=this._container;for(;C&&!M;){const L=x.window.getComputedStyle(C).transform;L&&L!=="none"&&(M=L.match(/matrix.*\((.+)\)/)[1].split(", ")),C=C.parentElement}M?(this._containerWidth=M[0]&&M[0]!=="0"?Math.abs(I/M[0]):I,this._containerHeight=M[3]&&M[3]!=="0"?Math.abs(y/M[3]):y):(this._containerWidth=I,this._containerHeight=y)}_detectMissingCSS(){x.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&x.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const I=this._container;I.classList.add("mapboxgl-map"),(this._missingCSSCanary=j.create("div","mapboxgl-canary",I)).style.visibility="hidden",this._detectMissingCSS();const y=this._canvasContainer=j.create("div","mapboxgl-canvas-container",I);this._interactive&&y.classList.add("mapboxgl-interactive"),this._canvas=j.create("canvas","mapboxgl-canvas",y),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const M=this._controlContainer=j.create("div","mapboxgl-control-container",I),C=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(L=>{C[L]=j.create("div",`mapboxgl-ctrl-${L}`,M)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(I,y){const M=x.exported.devicePixelRatio||1;this._canvas.width=M*Math.ceil(I),this._canvas.height=M*Math.ceil(y),this._canvas.style.width=`${I}px`,this._canvas.style.height=`${y}px`}_addMarker(I){this._markers.push(I)}_removeMarker(I){const y=this._markers.indexOf(I);y!==-1&&this._markers.splice(y,1)}_setupPainter(){const I=x.extend({},B.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),y=this._canvas.getContext("webgl",I)||this._canvas.getContext("experimental-webgl",I);y?(x.storeAuthState(y,!0),this.painter=new Jl(y,this.transform),this.on("data",M=>{M.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),x.exported$1.testSupport(y)):this.fire(new x.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(I){I.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new x.Event("webglcontextlost",{originalEvent:I}))}_contextRestored(I){this._setupPainter(),this.resize(),this._update(),this.fire(new x.Event("webglcontextrestored",{originalEvent:I}))}_onMapScroll(I){if(I.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(I){return this.style?(this._styleDirty=this._styleDirty||I,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(I){return this._update(),this._renderTaskQueue.add(I)}_cancelRenderFrame(I){this._renderTaskQueue.remove(I)}_requestDomTask(I){!this.loaded()||this.loaded()&&!this.isMoving()?I():this._domRenderTaskQueue.add(I)}_render(I){let y;const M=this.painter.context.extTimerQuery,C=x.exported.now();this.listens("gpu-timing-frame")&&(y=M.createQueryEXT(),M.beginQueryEXT(M.TIME_ELAPSED_EXT,y));let L=this._updateAverageElevation(C);if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(I),this._domRenderTaskQueue.run(I),this._removed)return;this._updateProjection();let F=!1;const N=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const W=this.transform.zoom,J=this.transform.pitch,ee=x.exported.now();this.style.zoomHistory.update(W,ee);const ne=new x.EvaluationParameters(W,{now:ee,fadeDuration:N,pitch:J,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),fe=ne.crossFadingFactor();fe===1&&fe===this._crossFadingFactor||(F=!0,this._crossFadingFactor=fe),this.style.update(ne)}if(this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0),this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),this.style._updateSources(this.transform),this._forceMarkerUpdate()),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,N,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:N,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),speedIndexTiming:this.speedIndexTiming}),this.fire(new x.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new x.Event("load"))),this.style&&(this.style.hasTransitions()||F)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const W=x.exported.now()-C;M.endQueryEXT(M.TIME_ELAPSED_EXT,y),setTimeout(()=>{const J=M.getQueryObjectEXT(y,M.QUERY_RESULT_EXT)/1e6;M.deleteQueryEXT(y),this.fire(new x.Event("gpu-timing-frame",{cpuTime:W,gpuTime:J}))},50)}if(this.listens("gpu-timing-layer")){const W=this.painter.collectGpuTimers();setTimeout(()=>{const J=this.painter.queryGpuTimers(W);this.fire(new x.Event("gpu-timing-layer",{layerTimes:J}))},50)}const q=this._sourcesDirty||this._styleDirty||this._placementDirty||L;if(q||this._repaint)this.triggerRepaint();else{const W=!this.isMoving()&&this.loaded();if(W&&(L=this._updateAverageElevation(C,!0)),L)this.triggerRepaint();else if(this._triggerFrame(!1),W&&(this.fire(new x.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const J=this._calculateSpeedIndex();this.fire(new x.Event("speedindexcompleted",{speedIndex:J})),this.speedIndexTiming=!1}}return!this._loaded||this._fullyLoaded||q||(this._fullyLoaded=!0,this._authenticate()),this}_forceMarkerUpdate(){for(const I of this._markers)I._update()}_updateAverageElevation(I,y=!1){const M=C=>(this.transform.averageElevation=C,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&M(0);if((y||I-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(I)){const C=this.transform.averageElevation;let L=this.transform.sampleAverageElevation();isNaN(L)?L=0:this._averageElevationLastSampledAt=I;const F=Math.abs(C-L);if(F>1){if(this._isInitialLoad)return this._averageElevation.jumpTo(L),M(L);this._averageElevation.easeTo(L,I,300)}else if(F>1e-4)return this._averageElevation.jumpTo(L),M(L)}return!!this._averageElevation.isEasing(I)&&M(this._averageElevation.getValue(I))}_authenticate(){x.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,I=>{if(I&&(I.message===x.AUTH_ERR_MSG||I.status===401)){const y=this.painter.context.gl;x.storeAuthState(y,!1),this._logoControl instanceof ol&&this._logoControl._updateLogo(),y&&y.clear(y.DEPTH_BUFFER_BIT|y.COLOR_BUFFER_BIT|y.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new x.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),x.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming())}_calculateSpeedIndex(){const I=this.painter.canvasCopy(),y=this.painter.getCanvasCopiesAndTimestamps();y.timeStamps.push(performance.now());const M=this.painter.context.gl,C=M.createFramebuffer();function L(F){M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,F,0);const N=new Uint8Array(M.drawingBufferWidth*M.drawingBufferHeight*4);return M.readPixels(0,0,M.drawingBufferWidth,M.drawingBufferHeight,M.RGBA,M.UNSIGNED_BYTE,N),N}return M.bindFramebuffer(M.FRAMEBUFFER,C),this._canvasPixelComparison(L(I),y.canvasCopies.map(L),y.timeStamps)}_canvasPixelComparison(I,y,M){let C=M[1]-M[0];const L=I.length/4;for(let F=0;F<y.length;F++){const N=y[F];let q=0;for(let W=0;W<N.length;W+=4)N[W]===I[W]&&N[W+1]===I[W+1]&&N[W+2]===I[W+2]&&N[W+3]===I[W+3]&&(q+=1);C+=(M[F+2]-M[F+1])*(1-q/L)}return C}remove(){this._hash&&this._hash.remove();for(const y of this._controls)y.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),x.window!==void 0&&(x.window.removeEventListener("resize",this._onWindowResize,!1),x.window.removeEventListener("orientationchange",this._onWindowResize,!1),x.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),x.window.removeEventListener("online",this._onWindowOnline,!1));const I=this.painter.context.gl.getExtension("WEBGL_lose_context");I&&I.loseContext(),hl(this._canvasContainer),hl(this._controlContainer),hl(this._missingCSSCanary),this._container.classList.remove("mapboxgl-map"),x.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new x.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(I){this._renderNextFrame=this._renderNextFrame||I,this.style&&!this._frame&&(this._frame=x.exported.frame(y=>{const M=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,M&&this._render(y)}))}_preloadTiles(I){const y=this.style&&Object.values(this.style._sourceCaches)||[];return x.asyncAll(y,(M,C)=>M._preloadTiles(I,C),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(I){this._trackResize&&this.resize({originalEvent:I})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(I){this._showTileBoundaries!==I&&(this._showTileBoundaries=I,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(I){this._showTerrainWireframe!==I&&(this._showTerrainWireframe=I,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(I){this._speedIndexTiming!==I&&(this._speedIndexTiming=I,this._update())}get showPadding(){return!!this._showPadding}set showPadding(I){this._showPadding!==I&&(this._showPadding=I,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(I){this._showCollisionBoxes!==I&&(this._showCollisionBoxes=I,I?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(I){this._showOverdrawInspector!==I&&(this._showOverdrawInspector=I,this._update())}get repaint(){return!!this._repaint}set repaint(I){this._repaint!==I&&(this._repaint=I,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(I){this._vertices=I,this._update()}_setCacheLimits(I,y){x.setCacheLimits(I,y)}get version(){return x.version}},NavigationControl:class{constructor(I){this.options=x.extend({},pc,I),this._container=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",y=>y.preventDefault()),this.options.showZoom&&(x.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",y=>this._map.zoomIn({},{originalEvent:y})),j.create("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden",!0),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",y=>this._map.zoomOut({},{originalEvent:y})),j.create("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden",!0)),this.options.showCompass&&(x.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",y=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:y}):this._map.resetNorth({},{originalEvent:y})}),this._compassIcon=j.create("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden",!0))}_updateZoomButtons(){const I=this._map.getZoom(),y=I===this._map.getMaxZoom(),M=I===this._map.getMinZoom();this._zoomInButton.disabled=y,this._zoomOutButton.disabled=M,this._zoomInButton.setAttribute("aria-disabled",y.toString()),this._zoomOutButton.setAttribute("aria-disabled",M.toString())}_rotateCompassArrow(){const I=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._map._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=I)})}onAdd(I){return this._map=I,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new mh(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){this._container.remove(),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(I,y){const M=j.create("button",I,this._container);return M.type="button",M.addEventListener("click",y),M}_setButtonTitle(I,y){const M=this._map._getUIString(`NavigationControl.${y}`);I.setAttribute("aria-label",M),I.firstElementChild&&I.firstElementChild.setAttribute("title",M)}},GeolocateControl:class extends x.Evented{constructor(I){super(),this.options=x.extend({},ys,I),x.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation"],this),this._onDeviceOrientationListener=this._onDeviceOrientation.bind(this),this._updateMarkerRotationThrottled=Qn(this._updateMarkerRotation,20)}onAdd(I){var y;return this._map=I,this._container=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),y=this._setupUI,Vr!==void 0?y(Vr):x.window.navigator.permissions!==void 0?x.window.navigator.permissions.query({name:"geolocation"}).then(M=>{Vr=M.state!=="denied",y(Vr)}):(Vr=!!x.window.navigator.geolocation,y(Vr)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(x.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,xs=0,Lo=!1}_isOutOfMapMaxBounds(I){const y=this._map.getMaxBounds(),M=I.coords;return y&&(M.longitude<y.getWest()||M.longitude>y.getEast()||M.latitude<y.getSouth()||M.latitude>y.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(I){if(this._map){if(this._isOutOfMapMaxBounds(I))return this._setErrorState(),this.fire(new x.Event("outofmaxbounds",I)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=I,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(I),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(I),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new x.Event("geolocate",I)),this._finish()}}_updateCamera(I){const y=new x.LngLat(I.coords.longitude,I.coords.latitude),M=I.coords.accuracy,C=this._map.getBearing(),L=x.extend({bearing:C},this.options.fitBoundsOptions);this._map.fitBounds(y.toBounds(M),L,{geolocateSource:!0})}_updateMarker(I){if(I){const y=new x.LngLat(I.coords.longitude,I.coords.latitude);this._accuracyCircleMarker.setLngLat(y).addTo(this._map),this._userLocationDotMarker.setLngLat(y).addTo(this._map),this._accuracy=I.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const I=this._map._containerHeight/2,y=this._map.unproject([0,I]),M=this._map.unproject([100,I]),C=y.distanceTo(M)/100,L=Math.ceil(2*this._accuracy/C);this._circleElement.style.width=`${L}px`,this._circleElement.style.height=`${L}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(I){if(this._map){if(this.options.trackUserLocation)if(I.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const y=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",y),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",y),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(I.code===3&&Lo)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new x.Event("error",I)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(I){if(this._container.addEventListener("contextmenu",y=>y.preventDefault()),this._geolocateButton=j.create("button","mapboxgl-ctrl-geolocate",this._container),j.create("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden",!0),this._geolocateButton.type="button",I===!1){x.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const y=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",y),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",y)}else{const y=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",y),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",y)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=j.create("div","mapboxgl-user-location"),this._dotElement.appendChild(j.create("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(j.create("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ll({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=j.create("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ll({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",y=>{y.geolocateSource||this._watchState!=="ACTIVE_LOCK"||y.originalEvent&&y.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new x.Event("trackuserlocationend")))})}_onDeviceOrientation(I){this._userLocationDotMarker&&(I.webkitCompassHeading?this._heading=I.webkitCompassHeading:I.absolute===!0&&(this._heading=-1*I.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return x.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new x.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":xs--,Lo=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new x.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new x.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let I;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),xs++,xs>1?(I={maximumAge:6e5,timeout:0},Lo=!0):(I=this.options.positionOptions,Lo=!1),this._geolocationWatchID=x.window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,I),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else x.window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const I=()=>{x.window.addEventListener("ondeviceorientationabsolute"in x.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientationListener)};x.window.DeviceMotionEvent!==void 0&&typeof x.window.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(y=>{y==="granted"&&I()}).catch(console.error):I()}_clearWatch(){x.window.navigator.geolocation.clearWatch(this._geolocationWatchID),x.window.removeEventListener("deviceorientation",this._onDeviceOrientationListener),x.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientationListener),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:nl,ScaleControl:class{constructor(I){this.options=x.extend({},vs,I),x.bindAll(["_onMove","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_onMove(){Ft(this._map,this._container,this.options)}onAdd(I){return this._map=I,this._container=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-scale",I.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._onMove),this._map=void 0}setUnit(I){this.options.unit=I,Ft(this._map,this._container,this.options)}},FullscreenControl:class{constructor(I){this._fullscreen=!1,I&&I.container&&(I.container instanceof x.window.HTMLElement?this._container=I.container:x.warnOnce("Full screen control 'container' must be a DOM element.")),x.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in x.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in x.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(I){return this._map=I,this._container||(this._container=this._map.getContainer()),this._controlContainer=j.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",x.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,x.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!x.window.document.fullscreenEnabled&&!x.window.document.webkitFullscreenEnabled)}_setupUI(){const I=this._fullscreenButton=j.create("button","mapboxgl-ctrl-fullscreen",this._controlContainer);j.create("span","mapboxgl-ctrl-icon",I).setAttribute("aria-hidden",!0),I.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),x.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const I=this._getTitle();this._fullscreenButton.setAttribute("aria-label",I),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",I)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(x.window.document.fullscreenElement||x.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?x.window.document.exitFullscreen?x.window.document.exitFullscreen():x.window.document.webkitCancelFullScreen&&x.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends x.Evented{constructor(I){super(),this.options=x.extend(Object.create(gh),I),x.bindAll(["_update","_onClose","remove","_onMouseMove","_onMouseUp","_onDrag"],this),this._classList=new Set(I&&I.className?I.className.trim().split(/\s+/):[])}addTo(I){return this._map&&this.remove(),this._map=I,this.options.closeOnClick&&this._map.on("preclick",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")):this._map.on("move",this._update),this.fire(new x.Event("open")),this}isOpen(){return!!this._map}remove(){return this._content&&this._content.remove(),this._container&&(this._container.remove(),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),delete this._map),this.fire(new x.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(I){return this._lngLat=x.LngLat.convert(I),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._map._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(I){return this.setDOMContent(x.window.document.createTextNode(I))}setHTML(I){const y=x.window.document.createDocumentFragment(),M=x.window.document.createElement("body");let C;for(M.innerHTML=I;C=M.firstChild,C;)y.appendChild(C);return this.setDOMContent(y)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(I){return this.options.maxWidth=I,this._update(),this}setDOMContent(I){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=j.create("div","mapboxgl-popup-content",this._container);return this._content.appendChild(I),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(I){return this._classList.add(I),this._container&&this._updateClassList(),this}removeClassName(I){return this._classList.delete(I),this._container&&this._updateClassList(),this}setOffset(I){return this.options.offset=I,this._update(),this}toggleClassName(I){let y;return this._classList.delete(I)?y=!1:(this._classList.add(I),y=!0),this._container&&this._updateClassList(),y}_createCloseButton(){this.options.closeButton&&(this._closeButton=j.create("button","mapboxgl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.setAttribute("aria-hidden","true"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_onMouseUp(I){this._update(I.point)}_onMouseMove(I){this._update(I.point)}_onDrag(I){this._update(I.point)}_getAnchor(I){if(this.options.anchor)return this.options.anchor;const y=this._pos,M=this._container.offsetWidth,C=this._container.offsetHeight;let L;return L=y.y+I.bottom.y<C?["top"]:y.y>this._map.transform.height-C?["bottom"]:[],y.x<M/2?L.push("left"):y.x>this._map.transform.width-M/2&&L.push("right"),L.length===0?"bottom":L.join("-")}_updateClassList(){const I=[...this._classList];I.push("mapboxgl-popup"),this._anchor&&I.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&I.push("mapboxgl-popup-track-pointer"),this._container.className=I.join(" ")}_update(I){if(this._map&&(this._lngLat||this._trackPointer)&&this._content){if(this._container||(this._container=j.create("div","mapboxgl-popup",this._map.getContainer()),this._tip=j.create("div","mapboxgl-popup-tip",this._container),this._container.appendChild(this._content)),this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=al(this._lngLat,this._pos,this._map.transform)),!this._trackPointer||I){const y=this._pos=this._trackPointer&&I?I:this._map.project(this._lngLat),M=function(F){if(F||(F=new x.pointGeometry(0,0)),typeof F=="number"){const N=Math.round(Math.sqrt(.5*Math.pow(F,2)));return{center:new x.pointGeometry(0,0),top:new x.pointGeometry(0,F),"top-left":new x.pointGeometry(N,N),"top-right":new x.pointGeometry(-N,N),bottom:new x.pointGeometry(0,-F),"bottom-left":new x.pointGeometry(N,-N),"bottom-right":new x.pointGeometry(-N,-N),left:new x.pointGeometry(F,0),right:new x.pointGeometry(-F,0)}}if(F instanceof x.pointGeometry||Array.isArray(F)){const N=x.pointGeometry.convert(F);return{center:N,top:N,"top-left":N,"top-right":N,bottom:N,"bottom-left":N,"bottom-right":N,left:N,right:N}}return{center:x.pointGeometry.convert(F.center||[0,0]),top:x.pointGeometry.convert(F.top||[0,0]),"top-left":x.pointGeometry.convert(F["top-left"]||[0,0]),"top-right":x.pointGeometry.convert(F["top-right"]||[0,0]),bottom:x.pointGeometry.convert(F.bottom||[0,0]),"bottom-left":x.pointGeometry.convert(F["bottom-left"]||[0,0]),"bottom-right":x.pointGeometry.convert(F["bottom-right"]||[0,0]),left:x.pointGeometry.convert(F.left||[0,0]),right:x.pointGeometry.convert(F.right||[0,0])}}(this.options.offset),C=this._anchor=this._getAnchor(M),L=y.add(M[C]).round();this._map._requestDomTask(()=>{this._container&&C&&(this._container.style.transform=`${Ar[C]} translate(${L.x}px,${L.y}px)`)})}this._updateClassList()}}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const I=this._container.querySelector(bs);I&&I.focus()}_onClose(){this.remove()}_setOpacity(I){this._content&&(this._content.style.opacity=I),this._tip&&(this._tip.style.opacity=I)}},Marker:ll,Style:Zr,LngLat:x.LngLat,LngLatBounds:x.LngLatBounds,Point:x.pointGeometry,MercatorCoordinate:x.MercatorCoordinate,FreeCameraOptions:eh,Evented:x.Evented,config:x.config,prewarm:function(){Oe().acquire(De)},clearPrewarmedResources:function(){const I=Ne;I&&(I.isPreloaded()&&I.numActive()===1?(I.release(De),Ne=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return x.config.ACCESS_TOKEN},set accessToken(I){x.config.ACCESS_TOKEN=I},get baseApiUrl(){return x.config.API_URL},set baseApiUrl(I){x.config.API_URL=I},get workerCount(){return Ue.workerCount},set workerCount(I){Ue.workerCount=I},get maxParallelImageRequests(){return x.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(I){x.config.MAX_PARALLEL_IMAGE_REQUESTS=I},clearStorage(I){x.clearTileCache(I)},workerUrl:"",workerClass:null,setNow:x.exported.setNow,restoreNow:x.exported.restoreNow};return eo});var k=w;return k})})(mapboxGl);var mapboxgl=mapboxGl.exports,d2r=Math.PI/180,r2d=180/Math.PI;function tileToBBOX(d){var h=tile2lon(d[0]+1,d[2]),p=tile2lon(d[0],d[2]),m=tile2lat(d[1]+1,d[2]),w=tile2lat(d[1],d[2]);return[p,m,h,w]}function tileToGeoJSON(d){var h=tileToBBOX(d),p={type:"Polygon",coordinates:[[[h[0],h[3]],[h[0],h[1]],[h[2],h[1]],[h[2],h[3]],[h[0],h[3]]]]};return p}function tile2lon(d,h){return d/Math.pow(2,h)*360-180}function tile2lat(d,h){var p=Math.PI-2*Math.PI*d/Math.pow(2,h);return r2d*Math.atan(.5*(Math.exp(p)-Math.exp(-p)))}function pointToTile(d,h,p){var m=pointToTileFraction(d,h,p);return m[0]=Math.floor(m[0]),m[1]=Math.floor(m[1]),m}function getChildren(d){return[[d[0]*2,d[1]*2,d[2]+1],[d[0]*2+1,d[1]*2,d[2]+1],[d[0]*2+1,d[1]*2+1,d[2]+1],[d[0]*2,d[1]*2+1,d[2]+1]]}function getParent(d){return[d[0]>>1,d[1]>>1,d[2]-1]}function getSiblings(d){return getChildren(getParent(d))}function hasSiblings(d,h){for(var p=getSiblings(d),m=0;m<p.length;m++)if(!hasTile(h,p[m]))return!1;return!0}function hasTile(d,h){for(var p=0;p<d.length;p++)if(tilesEqual(d[p],h))return!0;return!1}function tilesEqual(d,h){return d[0]===h[0]&&d[1]===h[1]&&d[2]===h[2]}function tileToQuadkey(d){for(var h="",p=d[2];p>0;p--){var m=0,w=1<<p-1;(d[0]&w)!==0&&m++,(d[1]&w)!==0&&(m+=2),h+=m.toString()}return h}function quadkeyToTile(d){for(var h=0,p=0,m=d.length,w=m;w>0;w--){var T=1<<w-1,k=+d[m-w];k===1&&(h|=T),k===2&&(p|=T),k===3&&(h|=T,p|=T)}return[h,p,m]}function bboxToTile(d){var h=pointToTile(d[0],d[1],32),p=pointToTile(d[2],d[3],32),m=[h[0],h[1],p[0],p[1]],w=getBboxZoom(m);if(w===0)return[0,0,0];var T=m[0]>>>32-w,k=m[1]>>>32-w;return[T,k,w]}function getBboxZoom(d){for(var h=28,p=0;p<h;p++){var m=1<<32-(p+1);if((d[0]&m)!==(d[2]&m)||(d[1]&m)!==(d[3]&m))return p}return h}function pointToTileFraction(d,h,p){var m=Math.sin(h*d2r),w=Math.pow(2,p),T=w*(d/360+.5),k=w*(.5-.25*Math.log((1+m)/(1-m))/Math.PI);return T=T%w,T<0&&(T=T+w),[T,k,p]}var tilebelt={tileToGeoJSON,tileToBBOX,getChildren,getParent,getSiblings,hasTile,hasSiblings,tilesEqual,tileToQuadkey,quadkeyToTile,pointToTile,bboxToTile,pointToTileFraction};function feature(d,h,p){p===void 0&&(p={});var m={type:"Feature"};return(p.id===0||p.id)&&(m.id=p.id),p.bbox&&(m.bbox=p.bbox),m.properties=h||{},m.geometry=d,m}function polygon(d,h,p){p===void 0&&(p={});for(var m=0,w=d;m<w.length;m++){var T=w[m];if(T.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var k=0;k<T[T.length-1].length;k++)if(T[T.length-1][k]!==T[0][k])throw new Error("First and last Position are not equivalent.")}var x={type:"Polygon",coordinates:d};return feature(x,h,p)}function bboxPolygon(d,h){h===void 0&&(h={});var p=Number(d[0]),m=Number(d[1]),w=Number(d[2]),T=Number(d[3]);if(d.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var k=[p,m],x=[p,T],B=[w,T],P=[w,m];return polygon([[k,P,B,x,k]],h.properties,{bbox:d,id:h.id})}function getTileInfo(d,h,p){let m={},w=Math.floor(p.getZoom()),T=40075016686e-3*Math.abs(Math.cos(h))/Math.pow(2,w),k=T/512,x=tilebelt.pointToTile(d,h,w);m.z=w,m.x=x[0],m.y=x[1],m.long=d,m.lat=h,m.tileWidthInMeters=T,m.metersPerPixel=k,m.polygon_bb=getTileGeoJsonBB(m),m.mapbox_tile_name=m.z+"-"+m.x+"-"+m.y,m.rgbFileName="terrain-rgb-"+m.mapbox_tile_name+".png",m.thirtytwoFile={name:"thirtytwo-"+m.mapbox_tile_name+".png",bitDepth:32},m.sixteenFile={name:"sixteen-"+m.mapbox_tile_name,bitDepth:16},m.landscapeName="";let B=[m.x,m.y,m.z],P=tilebelt.tileToBBOX(B);m.bbox=P;let U=new mapboxgl.LngLatBounds(m.bbox).getCenter();return m.bbox_center=U,m}function getFeaturesFromBB(d,h){if(h){let p=[h.geometry.coordinates[0][4]],m=[h.geometry.coordinates[0][2]];const w=new mapboxgl.LngLat(p[0][0],p[0][1]),T=new mapboxgl.LngLat(m[0][0],m[0][1]),k=d.project(w),x=d.project(T);return d.queryRenderedFeatures([k,x])}}async function loadImageFromArray(d){return await Image$1.load(d)}function getHeightFromRgb(d,h,p){return-1e4+(d*256*256+h*256+p)*.1}function getHeightArray(d){let h=[],p=d.getPixelsArray();for(const m of p){let w=m[0],T=m[1],k=m[2],x=getHeightFromRgb(w,T,k);x=parseFloat(x),h.push(x)}return h}async function downloadTerrainRgb(d){return await(await fetch(d)).arrayBuffer()}async function unrealRemoteControl(d){const h={method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)};return await(await fetch("http://localhost:30010/remote/object/call",h)).json()}async function getMapboxTerrainRgb(d,h,p){let m,w=await fileUtils.fileExists(d,h.rgbFileName),T;return w===!1?m=await downloadTerrainRgb(p):m=await fileUtils.readFileFromDisk(d,h.rgbFileName),idbKeyval.set("rgbImageArrayBuffer",m),T=await loadImageFromArray(m),T}function convertImage(d,h,p,m,w){return new Image$1(d,h,p,{kind:w,bitDepth:m})}function createHeightMapImage(d,h,p){let m={},w=getHeightArray(d);idbKeyval.set("decodedHeightArray",w);let T=convertImage(d.width,d.height,w,h,p);return m.minElevation=T.min[0],m.maxElevation=T.max[0],m.image=T,m.decodedHeightArray=w,m}function getTileGeoJsonBB(d){let h=[d.x,d.y,d.z],p=tilebelt.tileToBBOX(h),m=bboxPolygon(p);return{type:"Feature",geometry:{type:m.geometry.type,coordinates:m.geometry.coordinates}}}var mapUtils={getTileInfo,getFeaturesFromBB,getMapboxTerrainRgb,createHeightMapImage,loadImageFromArray,unrealRemoteControl};function mitt(d){return{all:d=d||new Map,on:function(h,p){var m=d.get(h);m?m.push(p):d.set(h,[p])},off:function(h,p){var m=d.get(h);m&&(p?m.splice(m.indexOf(p)>>>0,1):d.set(h,[]))},emit:function(h,p){var m=d.get(h);m&&m.slice().map(function(w){w(p)}),(m=d.get("*"))&&m.slice().map(function(w){w(h,p)})}}}var emitter=mitt(),immutable=extend$2,hasOwnProperty=Object.prototype.hasOwnProperty;function extend$2(){for(var d={},h=0;h<arguments.length;h++){var p=arguments[h];for(var m in p)hasOwnProperty.call(p,m)&&(d[m]=p[m])}return d}var fuzzy$1={exports:{}};(function(d,h){(function(){var p={};d.exports=p,p.simpleFilter=function(m,w){return w.filter(function(T){return p.test(m,T)})},p.test=function(m,w){return p.match(m,w)!==null},p.match=function(m,w,T){T=T||{};var k=0,x=[],B=w.length,P=0,O=0,U=T.pre||"",G=T.post||"",j=T.caseSensitive&&w||w.toLowerCase(),H;m=T.caseSensitive&&m||m.toLowerCase();for(var te=0;te<B;te++)H=w[te],j[te]===m[k]?(H=U+H+G,k+=1,O+=1+O):O=0,P+=O,x[x.length]=H;return k===m.length?(P=j===m?1/0:P,{rendered:x.join(""),score:P}):null},p.filter=function(m,w,T){return!w||w.length===0?[]:typeof m!="string"?w:(T=T||{},w.reduce(function(k,x,B,P){var O=x;T.extract&&(O=T.extract(x));var U=p.match(m,O,T);return U!=null&&(k[k.length]={string:U.rendered,score:U.score,index:B,original:x}),k},[]).sort(function(k,x){var B=x.score-k.score;return B||k.index-x.index}))}})()})(fuzzy$1);var List$1=function(d){return this.component=d,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,d.el.parentNode.insertBefore(this.wrapper,d.el.nextSibling),this};List$1.prototype.show=function(){this.element.style.display="block"};List$1.prototype.hide=function(){this.element.style.display="none"};List$1.prototype.add=function(d){this.items.push(d)};List$1.prototype.clear=function(){this.items=[],this.active=0};List$1.prototype.isEmpty=function(){return!this.items.length};List$1.prototype.isVisible=function(){return this.element.style.display==="block"};List$1.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var d=0;d<this.items.length;d++)this.drawItem(this.items[d],this.active===d);this.show()};List$1.prototype.drawItem=function(d,h){var p=document.createElement("li"),m=document.createElement("a");h&&(p.className+=" active"),m.innerHTML=d.string,p.appendChild(m),this.element.appendChild(p),p.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),p.addEventListener("mouseup",function(){this.handleMouseUp.call(this,d)}.bind(this))};List$1.prototype.handleMouseUp=function(d){this.selectingListItem=!1,this.component.value(d.original),this.clear(),this.draw()};List$1.prototype.move=function(d){this.active=d,this.draw()};List$1.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};List$1.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};List$1.prototype.drawError=function(d){var h=document.createElement("li");h.innerHTML=d,this.element.appendChild(h),this.show()};var list=List$1,extend$1=immutable,fuzzy=fuzzy$1.exports,List=list,Suggestions$1=function(d,h,p){return p=p||{},this.options=extend$1({minLength:2,limit:5,filter:!0,hideOnBlur:!0},p),this.el=d,this.data=h||[],this.list=new List(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",function(m){this.handleKeyUp(m.keyCode)}.bind(this),!1),this.el.addEventListener("keydown",function(m){this.handleKeyDown(m)}.bind(this)),this.el.addEventListener("focus",function(){this.handleFocus()}.bind(this)),this.el.addEventListener("blur",function(){this.handleBlur()}.bind(this)),this.el.addEventListener("paste",function(m){this.handlePaste(m)}.bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};Suggestions$1.prototype.handleKeyUp=function(d){d===40||d===38||d===27||d===13||d===9||this.handleInputChange(this.el.value)};Suggestions$1.prototype.handleKeyDown=function(d){switch(d.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&d.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};Suggestions$1.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};Suggestions$1.prototype.handlePaste=function(d){if(d.clipboardData)this.handleInputChange(d.clipboardData.getData("Text"));else{var h=this;setTimeout(function(){h.handleInputChange(d.target.value)},100)}};Suggestions$1.prototype.handleInputChange=function(d){if(this.query=this.normalize(d),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates(function(h){for(var p=0;p<h.length&&(this.list.add(h[p]),p!==this.options.limit-1);p++);this.list.draw()}.bind(this))};Suggestions$1.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};Suggestions$1.prototype.update=function(d){this.data=d,this.handleKeyUp()};Suggestions$1.prototype.clear=function(){this.data=[],this.list.clear()};Suggestions$1.prototype.normalize=function(d){return d=d.toLowerCase(),d};Suggestions$1.prototype.match=function(d,h){return d.indexOf(h)>-1};Suggestions$1.prototype.value=function(d){if(this.selected=d,this.el.value=this.getItemValue(d),document.createEvent){var h=document.createEvent("HTMLEvents");h.initEvent("change",!0,!1),this.el.dispatchEvent(h)}else this.el.fireEvent("onchange")};Suggestions$1.prototype.getCandidates=function(d){var h={pre:"<strong>",post:"</strong>",extract:function(m){return this.getItemValue(m)}.bind(this)},p;this.options.filter?(p=fuzzy.filter(this.query,this.data,h),p=p.map(function(m){return{original:m.original,string:this.render(m.original,m.string)}}.bind(this))):p=this.data.map(function(m){var w=this.render(m);return{original:m,string:w}}.bind(this)),d(p)};Suggestions$1.prototype.getItemValue=function(d){return d};Suggestions$1.prototype.render=function(d,h){if(h)return h;for(var p=d.original?this.getItemValue(d.original):this.getItemValue(d),m=this.normalize(p),w=m.lastIndexOf(this.query);w>-1;){var T=w+this.query.length;p=p.slice(0,w)+"<strong>"+p.slice(w,T)+"</strong>"+p.slice(T),w=m.slice(0,w).lastIndexOf(this.query)}return p};Suggestions$1.prototype.renderError=function(d){this.list.drawError(d)};var suggestions$1=Suggestions$1,Suggestions=suggestions$1,suggestions=Suggestions;typeof window!="undefined"&&(window.Suggestions=Suggestions);var FUNC_ERROR_TEXT="Expected a function",NAN=0/0,symbolTag="[object Symbol]",reTrim=/^\s+|\s+$/g,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsOctal=/^0o[0-7]+$/i,freeParseInt=parseInt,freeGlobal=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf=typeof self=="object"&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),objectProto=Object.prototype,objectToString=objectProto.toString,nativeMax=Math.max,nativeMin=Math.min,now=function(){return root.Date.now()};function debounce$1(d,h,p){var m,w,T,k,x,B,P=0,O=!1,U=!1,G=!0;if(typeof d!="function")throw new TypeError(FUNC_ERROR_TEXT);h=toNumber(h)||0,isObject(p)&&(O=!!p.leading,U="maxWait"in p,T=U?nativeMax(toNumber(p.maxWait)||0,h):T,G="trailing"in p?!!p.trailing:G);function j(Re){var xe=m,ue=w;return m=w=void 0,P=Re,k=d.apply(ue,xe),k}function H(Re){return P=Re,x=setTimeout(Q,h),O?j(Re):k}function te(Re){var xe=Re-B,ue=Re-P,Me=h-xe;return U?nativeMin(Me,T-ue):Me}function oe(Re){var xe=Re-B,ue=Re-P;return B===void 0||xe>=h||xe<0||U&&ue>=T}function Q(){var Re=now();if(oe(Re))return _e(Re);x=setTimeout(Q,te(Re))}function _e(Re){return x=void 0,G&&m?j(Re):(m=w=void 0,k)}function se(){x!==void 0&&clearTimeout(x),P=0,m=B=w=x=void 0}function le(){return x===void 0?k:_e(now())}function me(){var Re=now(),xe=oe(Re);if(m=arguments,w=this,B=Re,xe){if(x===void 0)return H(B);if(U)return x=setTimeout(Q,h),j(B)}return x===void 0&&(x=setTimeout(Q,h)),k}return me.cancel=se,me.flush=le,me}function isObject(d){var h=typeof d;return!!d&&(h=="object"||h=="function")}function isObjectLike(d){return!!d&&typeof d=="object"}function isSymbol(d){return typeof d=="symbol"||isObjectLike(d)&&objectToString.call(d)==symbolTag}function toNumber(d){if(typeof d=="number")return d;if(isSymbol(d))return NAN;if(isObject(d)){var h=typeof d.valueOf=="function"?d.valueOf():d;d=isObject(h)?h+"":h}if(typeof d!="string")return d===0?d:+d;d=d.replace(reTrim,"");var p=reIsBinary.test(d);return p||reIsOctal.test(d)?freeParseInt(d.slice(2),p?2:8):reIsBadHex.test(d)?NAN:+d}var lodash_debounce=debounce$1,events$1={exports:{}},R=typeof Reflect=="object"?Reflect:null,ReflectApply=R&&typeof R.apply=="function"?R.apply:function d(h,p,m){return Function.prototype.apply.call(h,p,m)},ReflectOwnKeys;R&&typeof R.ownKeys=="function"?ReflectOwnKeys=R.ownKeys:Object.getOwnPropertySymbols?ReflectOwnKeys=function(h){return Object.getOwnPropertyNames(h).concat(Object.getOwnPropertySymbols(h))}:ReflectOwnKeys=function(h){return Object.getOwnPropertyNames(h)};function ProcessEmitWarning(d){console&&console.warn&&console.warn(d)}var NumberIsNaN=Number.isNaN||function d(h){return h!==h};function EventEmitter$2(){EventEmitter$2.init.call(this)}events$1.exports=EventEmitter$2;events$1.exports.once=once;EventEmitter$2.EventEmitter=EventEmitter$2;EventEmitter$2.prototype._events=void 0;EventEmitter$2.prototype._eventsCount=0;EventEmitter$2.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(d){if(typeof d!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof d)}Object.defineProperty(EventEmitter$2,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(d){if(typeof d!="number"||d<0||NumberIsNaN(d))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+d+".");defaultMaxListeners=d}});EventEmitter$2.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};EventEmitter$2.prototype.setMaxListeners=function d(h){if(typeof h!="number"||h<0||NumberIsNaN(h))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+h+".");return this._maxListeners=h,this};function _getMaxListeners(d){return d._maxListeners===void 0?EventEmitter$2.defaultMaxListeners:d._maxListeners}EventEmitter$2.prototype.getMaxListeners=function d(){return _getMaxListeners(this)};EventEmitter$2.prototype.emit=function d(h){for(var p=[],m=1;m<arguments.length;m++)p.push(arguments[m]);var w=h==="error",T=this._events;if(T!==void 0)w=w&&T.error===void 0;else if(!w)return!1;if(w){var k;if(p.length>0&&(k=p[0]),k instanceof Error)throw k;var x=new Error("Unhandled error."+(k?" ("+k.message+")":""));throw x.context=k,x}var B=T[h];if(B===void 0)return!1;if(typeof B=="function")ReflectApply(B,this,p);else for(var P=B.length,O=arrayClone(B,P),m=0;m<P;++m)ReflectApply(O[m],this,p);return!0};function _addListener(d,h,p,m){var w,T,k;if(checkListener(p),T=d._events,T===void 0?(T=d._events=Object.create(null),d._eventsCount=0):(T.newListener!==void 0&&(d.emit("newListener",h,p.listener?p.listener:p),T=d._events),k=T[h]),k===void 0)k=T[h]=p,++d._eventsCount;else if(typeof k=="function"?k=T[h]=m?[p,k]:[k,p]:m?k.unshift(p):k.push(p),w=_getMaxListeners(d),w>0&&k.length>w&&!k.warned){k.warned=!0;var x=new Error("Possible EventEmitter memory leak detected. "+k.length+" "+String(h)+" listeners added. Use emitter.setMaxListeners() to increase limit");x.name="MaxListenersExceededWarning",x.emitter=d,x.type=h,x.count=k.length,ProcessEmitWarning(x)}return d}EventEmitter$2.prototype.addListener=function d(h,p){return _addListener(this,h,p,!1)};EventEmitter$2.prototype.on=EventEmitter$2.prototype.addListener;EventEmitter$2.prototype.prependListener=function d(h,p){return _addListener(this,h,p,!0)};function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(d,h,p){var m={fired:!1,wrapFn:void 0,target:d,type:h,listener:p},w=onceWrapper.bind(m);return w.listener=p,m.wrapFn=w,w}EventEmitter$2.prototype.once=function d(h,p){return checkListener(p),this.on(h,_onceWrap(this,h,p)),this};EventEmitter$2.prototype.prependOnceListener=function d(h,p){return checkListener(p),this.prependListener(h,_onceWrap(this,h,p)),this};EventEmitter$2.prototype.removeListener=function d(h,p){var m,w,T,k,x;if(checkListener(p),w=this._events,w===void 0)return this;if(m=w[h],m===void 0)return this;if(m===p||m.listener===p)--this._eventsCount===0?this._events=Object.create(null):(delete w[h],w.removeListener&&this.emit("removeListener",h,m.listener||p));else if(typeof m!="function"){for(T=-1,k=m.length-1;k>=0;k--)if(m[k]===p||m[k].listener===p){x=m[k].listener,T=k;break}if(T<0)return this;T===0?m.shift():spliceOne(m,T),m.length===1&&(w[h]=m[0]),w.removeListener!==void 0&&this.emit("removeListener",h,x||p)}return this};EventEmitter$2.prototype.off=EventEmitter$2.prototype.removeListener;EventEmitter$2.prototype.removeAllListeners=function d(h){var p,m,w;if(m=this._events,m===void 0)return this;if(m.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):m[h]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete m[h]),this;if(arguments.length===0){var T=Object.keys(m),k;for(w=0;w<T.length;++w)k=T[w],k!=="removeListener"&&this.removeAllListeners(k);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(p=m[h],typeof p=="function")this.removeListener(h,p);else if(p!==void 0)for(w=p.length-1;w>=0;w--)this.removeListener(h,p[w]);return this};function _listeners(d,h,p){var m=d._events;if(m===void 0)return[];var w=m[h];return w===void 0?[]:typeof w=="function"?p?[w.listener||w]:[w]:p?unwrapListeners(w):arrayClone(w,w.length)}EventEmitter$2.prototype.listeners=function d(h){return _listeners(this,h,!0)};EventEmitter$2.prototype.rawListeners=function d(h){return _listeners(this,h,!1)};EventEmitter$2.listenerCount=function(d,h){return typeof d.listenerCount=="function"?d.listenerCount(h):listenerCount.call(d,h)};EventEmitter$2.prototype.listenerCount=listenerCount;function listenerCount(d){var h=this._events;if(h!==void 0){var p=h[d];if(typeof p=="function")return 1;if(p!==void 0)return p.length}return 0}EventEmitter$2.prototype.eventNames=function d(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(d,h){for(var p=new Array(h),m=0;m<h;++m)p[m]=d[m];return p}function spliceOne(d,h){for(;h+1<d.length;h++)d[h]=d[h+1];d.pop()}function unwrapListeners(d){for(var h=new Array(d.length),p=0;p<h.length;++p)h[p]=d[p].listener||d[p];return h}function once(d,h){return new Promise(function(p,m){function w(k){d.removeListener(h,T),m(k)}function T(){typeof d.removeListener=="function"&&d.removeListener("error",w),p([].slice.call(arguments))}eventTargetAgnosticAddListener(d,h,T,{once:!0}),h!=="error"&&addErrorHandlerIfEventEmitter(d,w,{once:!0})})}function addErrorHandlerIfEventEmitter(d,h,p){typeof d.on=="function"&&eventTargetAgnosticAddListener(d,"error",h,p)}function eventTargetAgnosticAddListener(d,h,p,m){if(typeof d.on=="function")m.once?d.once(h,p):d.on(h,p);else if(typeof d.addEventListener=="function")d.addEventListener(h,function w(T){m.once&&d.removeEventListener(h,w),p(T)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof d)}var exceptions$1={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}};function parseParam(d){var h=d.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return h?{key:h[1],value:h[2]}:null}function parseLink(d){var h=d.match(/<?([^>]*)>(.*)/);if(!h)return null;var p=h[1],m=h[2].split(";"),w=null,T=m.reduce(function(k,x){var B=parseParam(x);return B?B.key==="rel"?(w||(w=B.value),k):(k[B.key]=B.value,k):k},{});return w?{url:p,rel:w,params:T}:null}function parseLinkHeader$1(d){return d?d.split(/,\s*</).reduce(function(h,p){var m=parseLink(p);if(!m)return h;var w=m.rel.split(/\s+/);return w.forEach(function(T){h[T]||(h[T]={url:m.url,params:m.params})}),h},{}):{}}var parseLinkHeader_1=parseLinkHeader$1,parseLinkHeader=parseLinkHeader_1;function MapiResponse$1(d,h){this.request=d,this.headers=h.headers,this.rawBody=h.body,this.statusCode=h.statusCode;try{this.body=JSON.parse(h.body||"{}")}catch{this.body=h.body}this.links=parseLinkHeader(this.headers.link)}MapiResponse$1.prototype.hasNextPage=function d(){return!!this.links.next};MapiResponse$1.prototype.nextPage=function d(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};var mapiResponse=MapiResponse$1,constants$4={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"},constants$3=constants$4;function MapiError$1(d){var h=d.type||constants$3.ERROR_HTTP,p;if(d.body)try{p=JSON.parse(d.body)}catch{p=d.body}else p=null;var m=d.message||null;m||(typeof p=="string"?m=p:p&&typeof p.message=="string"?m=p.message:h===constants$3.ERROR_REQUEST_ABORTED&&(m="Request aborted")),this.message=m,this.type=h,this.statusCode=d.statusCode||null,this.request=d.request,this.body=p}var mapiError=MapiError$1;function parseSingleHeader(d){var h=d.indexOf(":"),p=d.substring(0,h).trim().toLowerCase(),m=d.substring(h+1).trim();return{name:p,value:m}}function parseHeaders$1(d){var h={};return d&&d.trim().split(/[\r|\n]+/).forEach(function(p){var m=parseSingleHeader(p);h[m.name]=m.value}),h}var parseHeaders_1=parseHeaders$1,MapiResponse=mapiResponse,MapiError=mapiError,constants$2=constants$4,parseHeaders=parseHeaders_1,requestsUnderway={};function browserAbort(d){var h=requestsUnderway[d.id];!h||(h.abort(),delete requestsUnderway[d.id])}function createResponse(d,h){return new MapiResponse(d,{body:h.response,headers:parseHeaders(h.getAllResponseHeaders()),statusCode:h.status})}function normalizeBrowserProgressEvent(d){var h=d.total,p=d.loaded,m=100*p/h;return{total:h,transferred:p,percent:m}}function sendRequestXhr(d,h){return new Promise(function(p,m){h.onprogress=function(k){d.emitter.emit(constants$2.EVENT_PROGRESS_DOWNLOAD,normalizeBrowserProgressEvent(k))};var w=d.file;w&&(h.upload.onprogress=function(k){d.emitter.emit(constants$2.EVENT_PROGRESS_UPLOAD,normalizeBrowserProgressEvent(k))}),h.onerror=function(k){m(k)},h.onabort=function(){var k=new MapiError({request:d,type:constants$2.ERROR_REQUEST_ABORTED});m(k)},h.onload=function(){if(delete requestsUnderway[d.id],h.status<200||h.status>=400){var k=new MapiError({request:d,body:h.response,statusCode:h.status});m(k);return}p(h)};var T=d.body;typeof T=="string"?h.send(T):T?h.send(JSON.stringify(T)):w?h.send(w):h.send(),requestsUnderway[d.id]=h}).then(function(p){return createResponse(d,p)})}function createRequestXhr(d,h){var p=d.url(h),m=new window.XMLHttpRequest;return m.open(d.method,p),Object.keys(d.headers).forEach(function(w){m.setRequestHeader(w,d.headers[w])}),m}function browserSend(d){return Promise.resolve().then(function(){var h=createRequestXhr(d,d.client.accessToken);return sendRequestXhr(d,h)})}var browserLayer={browserAbort,sendRequestXhr,browserSend,createRequestXhr},base64$1={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */(function(d,h){(function(p){var m=h,w=d&&d.exports==m&&d,T=typeof commonjsGlobal=="object"&&commonjsGlobal;(T.global===T||T.window===T)&&(p=T);var k=function(H){this.message=H};k.prototype=new Error,k.prototype.name="InvalidCharacterError";var x=function(H){throw new k(H)},B="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",P=/[\t\n\f\r ]/g,O=function(H){H=String(H).replace(P,"");var te=H.length;te%4==0&&(H=H.replace(/==?$/,""),te=H.length),(te%4==1||/[^+a-zA-Z0-9/]/.test(H))&&x("Invalid character: the string to be decoded is not correctly encoded.");for(var oe=0,Q,_e,se="",le=-1;++le<te;)_e=B.indexOf(H.charAt(le)),Q=oe%4?Q*64+_e:_e,oe++%4&&(se+=String.fromCharCode(255&Q>>(-2*oe&6)));return se},U=function(H){H=String(H),/[^\0-\xFF]/.test(H)&&x("The string to be encoded contains characters outside of the Latin1 range.");for(var te=H.length%3,oe="",Q=-1,_e,se,le,me,Re=H.length-te;++Q<Re;)_e=H.charCodeAt(Q)<<16,se=H.charCodeAt(++Q)<<8,le=H.charCodeAt(++Q),me=_e+se+le,oe+=B.charAt(me>>18&63)+B.charAt(me>>12&63)+B.charAt(me>>6&63)+B.charAt(me&63);return te==2?(_e=H.charCodeAt(Q)<<8,se=H.charCodeAt(++Q),me=_e+se,oe+=B.charAt(me>>10)+B.charAt(me>>4&63)+B.charAt(me<<2&63)+"="):te==1&&(me=H.charCodeAt(Q),oe+=B.charAt(me>>2)+B.charAt(me<<4&63)+"=="),oe},G={encode:U,decode:O,version:"0.1.0"};if(m&&!m.nodeType)if(w)w.exports=G;else for(var j in G)G.hasOwnProperty(j)&&(m[j]=G[j]);else p.base64=G})(commonjsGlobal)})(base64$1,base64$1.exports);var base64=base64$1.exports,tokenCache={};function parseToken$2(d){if(tokenCache[d])return tokenCache[d];var h=d.split("."),p=h[0],m=h[1];if(!m)throw new Error("Invalid token");var w=parsePaylod(m),T={usage:p,user:w.u};return has(w,"a")&&(T.authorization=w.a),has(w,"exp")&&(T.expires=w.exp*1e3),has(w,"iat")&&(T.created=w.iat*1e3),has(w,"scopes")&&(T.scopes=w.scopes),has(w,"client")&&(T.client=w.client),has(w,"ll")&&(T.lastLogin=w.ll),has(w,"iu")&&(T.impersonator=w.iu),tokenCache[d]=T,T}function parsePaylod(d){try{return JSON.parse(base64.decode(d))}catch{throw new Error("Invalid token")}}function has(d,h){return Object.prototype.hasOwnProperty.call(d,h)}var parseMapboxToken=parseToken$2,eventemitter3={exports:{}};(function(d){var h=Object.prototype.hasOwnProperty,p="~";function m(){}Object.create&&(m.prototype=Object.create(null),new m().__proto__||(p=!1));function w(B,P,O){this.fn=B,this.context=P,this.once=O||!1}function T(B,P,O,U,G){if(typeof O!="function")throw new TypeError("The listener must be a function");var j=new w(O,U||B,G),H=p?p+P:P;return B._events[H]?B._events[H].fn?B._events[H]=[B._events[H],j]:B._events[H].push(j):(B._events[H]=j,B._eventsCount++),B}function k(B,P){--B._eventsCount===0?B._events=new m:delete B._events[P]}function x(){this._events=new m,this._eventsCount=0}x.prototype.eventNames=function(){var P=[],O,U;if(this._eventsCount===0)return P;for(U in O=this._events)h.call(O,U)&&P.push(p?U.slice(1):U);return Object.getOwnPropertySymbols?P.concat(Object.getOwnPropertySymbols(O)):P},x.prototype.listeners=function(P){var O=p?p+P:P,U=this._events[O];if(!U)return[];if(U.fn)return[U.fn];for(var G=0,j=U.length,H=new Array(j);G<j;G++)H[G]=U[G].fn;return H},x.prototype.listenerCount=function(P){var O=p?p+P:P,U=this._events[O];return U?U.fn?1:U.length:0},x.prototype.emit=function(P,O,U,G,j,H){var te=p?p+P:P;if(!this._events[te])return!1;var oe=this._events[te],Q=arguments.length,_e,se;if(oe.fn){switch(oe.once&&this.removeListener(P,oe.fn,void 0,!0),Q){case 1:return oe.fn.call(oe.context),!0;case 2:return oe.fn.call(oe.context,O),!0;case 3:return oe.fn.call(oe.context,O,U),!0;case 4:return oe.fn.call(oe.context,O,U,G),!0;case 5:return oe.fn.call(oe.context,O,U,G,j),!0;case 6:return oe.fn.call(oe.context,O,U,G,j,H),!0}for(se=1,_e=new Array(Q-1);se<Q;se++)_e[se-1]=arguments[se];oe.fn.apply(oe.context,_e)}else{var le=oe.length,me;for(se=0;se<le;se++)switch(oe[se].once&&this.removeListener(P,oe[se].fn,void 0,!0),Q){case 1:oe[se].fn.call(oe[se].context);break;case 2:oe[se].fn.call(oe[se].context,O);break;case 3:oe[se].fn.call(oe[se].context,O,U);break;case 4:oe[se].fn.call(oe[se].context,O,U,G);break;default:if(!_e)for(me=1,_e=new Array(Q-1);me<Q;me++)_e[me-1]=arguments[me];oe[se].fn.apply(oe[se].context,_e)}}return!0},x.prototype.on=function(P,O,U){return T(this,P,O,U,!1)},x.prototype.once=function(P,O,U){return T(this,P,O,U,!0)},x.prototype.removeListener=function(P,O,U,G){var j=p?p+P:P;if(!this._events[j])return this;if(!O)return k(this,j),this;var H=this._events[j];if(H.fn)H.fn===O&&(!G||H.once)&&(!U||H.context===U)&&k(this,j);else{for(var te=0,oe=[],Q=H.length;te<Q;te++)(H[te].fn!==O||G&&!H[te].once||U&&H[te].context!==U)&&oe.push(H[te]);oe.length?this._events[j]=oe.length===1?oe[0]:oe:k(this,j)}return this},x.prototype.removeAllListeners=function(P){var O;return P?(O=p?p+P:P,this._events[O]&&k(this,O)):(this._events=new m,this._eventsCount=0),this},x.prototype.off=x.prototype.removeListener,x.prototype.addListener=x.prototype.on,x.prefixed=p,x.EventEmitter=x,d.exports=x})(eventemitter3);function encodeArray(d){return d.map(encodeURIComponent).join(",")}function encodeValue(d){return Array.isArray(d)?encodeArray(d):encodeURIComponent(String(d))}function appendQueryParam(d,h,p){if(p===!1||p===null)return d;var m=/\?/.test(d)?"&":"?",w=encodeURIComponent(h);return p!==void 0&&p!==""&&p!==!0&&(w+="="+encodeValue(p)),""+d+m+w}function appendQueryObject(d,h){if(!h)return d;var p=d;return Object.keys(h).forEach(function(m){var w=h[m];w!==void 0&&(Array.isArray(w)&&(w=w.filter(function(T){return T!=null}).join(",")),p=appendQueryParam(p,m,w))}),p}function prependOrigin(d,h){if(!h||d.slice(0,4)==="http")return d;var p=d[0]==="/"?"":"/";return""+h.replace(/\/$/,"")+p+d}function interpolateRouteParams(d,h){return h?d.replace(/\/:([a-zA-Z0-9]+)/g,function(p,m){var w=h[m];if(w===void 0)throw new Error("Unspecified route parameter "+m);var T=encodeValue(w);return"/"+T}):d}var urlUtils$1={appendQueryObject,appendQueryParam,prependOrigin,interpolateRouteParams},parseToken$1=parseMapboxToken,xtend$3=immutable,EventEmitter$1=eventemitter3.exports,urlUtils=urlUtils$1,constants$1=constants$4,requestId=1;function MapiRequest$1(d,h){if(!d)throw new Error("MapiRequest requires a client");if(!h||!h.path||!h.method)throw new Error("MapiRequest requires an options object with path and method properties");var p={};h.body&&(p["content-type"]="application/json");var m=xtend$3(p,h.headers),w=Object.keys(m).reduce(function(T,k){return T[k.toLowerCase()]=m[k],T},{});this.id=requestId++,this._options=h,this.emitter=new EventEmitter$1,this.client=d,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=h.path,this.method=h.method,this.origin=h.origin||d.origin,this.query=h.query||{},this.params=h.params||{},this.body=h.body||null,this.file=h.file||null,this.encoding=h.encoding||"utf8",this.sendFileAs=h.sendFileAs||null,this.headers=w}MapiRequest$1.prototype.url=function d(h){var p=urlUtils.prependOrigin(this.path,this.origin);p=urlUtils.appendQueryObject(p,this.query);var m=this.params,w=h==null?this.client.accessToken:h;if(w){p=urlUtils.appendQueryParam(p,"access_token",w);var T=parseToken$1(w).user;m=xtend$3({ownerId:T},m)}return p=urlUtils.interpolateRouteParams(p,m),p};MapiRequest$1.prototype.send=function d(){var h=this;if(h.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return h.sent=!0,h.client.sendRequest(h).then(function(p){return h.response=p,h.emitter.emit(constants$1.EVENT_RESPONSE,p),p},function(p){throw h.error=p,h.emitter.emit(constants$1.EVENT_ERROR,p),p})};MapiRequest$1.prototype.abort=function d(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};MapiRequest$1.prototype.eachPage=function d(h){var p=this;function m(k){function x(){delete p._nextPageRequest;var B=k.nextPage();B&&(p._nextPageRequest=B,T(B))}h(null,k,x)}function w(k){h(k,null,function(){})}function T(k){k.send().then(m,w)}T(this)};MapiRequest$1.prototype.clone=function d(){return this._extend()};MapiRequest$1.prototype._extend=function d(h){var p=xtend$3(this._options,h);return new MapiRequest$1(this.client,p)};var mapiRequest=MapiRequest$1,parseToken=parseMapboxToken,MapiRequest=mapiRequest,constants=constants$4;function MapiClient$2(d){if(!d||!d.accessToken)throw new Error("Cannot create a client without an access token");parseToken(d.accessToken),this.accessToken=d.accessToken,this.origin=d.origin||constants.API_ORIGIN}MapiClient$2.prototype.createRequest=function d(h){return new MapiRequest(this,h)};var mapiClient=MapiClient$2,browser=browserLayer,MapiClient$1=mapiClient;function BrowserClient(d){MapiClient$1.call(this,d)}BrowserClient.prototype=Object.create(MapiClient$1.prototype);BrowserClient.prototype.constructor=BrowserClient;BrowserClient.prototype.sendRequest=browser.browserSend;BrowserClient.prototype.abortRequest=browser.browserAbort;function createBrowserClient(d){return new BrowserClient(d)}var browserClient=createBrowserClient,client=browserClient,mapboxSdk=client,toString=Object.prototype.toString,isPlainObj=function(d){var h;return toString.call(d)==="[object Object]"&&(h=Object.getPrototypeOf(d),h===null||h===Object.getPrototypeOf({}))},isPlainObject=isPlainObj,xtend$2=immutable,DEFAULT_ERROR_PATH="value",NEWLINE_INDENT=`
  `,v$3={};v$3.assert=function(d,h){return h=h||{},function(p){var m=validate(d,p);if(!!m){var w=processMessage(m,h);throw h.apiName&&(w=h.apiName+": "+w),new Error(w)}}};v$3.shape=function d(h){var p=objectEntries(h);return function(w){var T=validate(v$3.plainObject,w);if(T)return T;for(var k,x,B=[],P=0;P<p.length;P++)k=p[P].key,x=p[P].value,T=validate(x,w[k]),T&&B.push([k].concat(T));return B.length<2?B[0]:function(O){B=B.map(function(j){var H=j[0],te=processMessage(j,O).split(`
`).join(NEWLINE_INDENT);return"- "+H+": "+te});var U=O.path.join("."),G=U===DEFAULT_ERROR_PATH?"":" of "+U;return"The following properties"+G+" have invalid values:"+NEWLINE_INDENT+B.join(NEWLINE_INDENT)}}};v$3.strictShape=function d(h){var p=v$3.shape(h);return function(w){var T=p(w);if(T)return T;var k=Object.keys(w).reduce(function(x,B){return h[B]===void 0&&x.push(B),x},[]);if(k.length!==0)return function(){return"The following keys are invalid: "+k.join(", ")}}};v$3.arrayOf=function d(h){return createArrayValidator(h)};v$3.tuple=function d(){var h=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return createArrayValidator(h)};function createArrayValidator(d){var h=Array.isArray(d),p=function(m){return h?d[m]:d};return function(w){var T=validate(v$3.plainArray,w);if(T)return T;if(h&&w.length!==d.length)return"an array with "+d.length+" items";for(var k=0;k<w.length;k++)if(T=validate(p(k),w[k]),T)return[k].concat(T)}}v$3.required=function d(h){function p(m){return m==null?function(w){return formatErrorMessage(w,isArrayCulprit(w.path)?"cannot be undefined/null.":"is required.")}:h.apply(this,arguments)}return p.__required=!0,p};v$3.oneOfType=function d(){var h=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(m){var w=h.map(function(T){return validate(T,m)}).filter(Boolean);if(w.length===h.length)return w.every(function(T){return T.length===1&&typeof T[0]=="string"})?orList(w.map(function(T){return T[0]})):w.reduce(function(T,k){return k.length>T.length?k:T})}};v$3.equal=function d(h){return function(m){if(m!==h)return JSON.stringify(h)}};v$3.oneOf=function d(){var h=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),p=h.map(function(m){return v$3.equal(m)});return v$3.oneOfType.apply(this,p)};v$3.range=function d(h){var p=h[0],m=h[1];return function(T){var k=validate(v$3.number,T);if(k||T<p||T>m)return"number between "+p+" & "+m+" (inclusive)"}};v$3.any=function d(){};v$3.boolean=function d(h){if(typeof h!="boolean")return"boolean"};v$3.number=function d(h){if(typeof h!="number")return"number"};v$3.plainArray=function d(h){if(!Array.isArray(h))return"array"};v$3.plainObject=function d(h){if(!isPlainObject(h))return"object"};v$3.string=function d(h){if(typeof h!="string")return"string"};v$3.func=function d(h){if(typeof h!="function")return"function"};function validate(d,h){if(!(h==null&&!d.hasOwnProperty("__required"))){var p=d(h);if(p)return Array.isArray(p)?p:[p]}}function processMessage(d,h){var p=d.length,m=d[p-1],w=d.slice(0,p-1);return w.length===0&&(w=[DEFAULT_ERROR_PATH]),h=xtend$2(h,{path:w}),typeof m=="function"?m(h):formatErrorMessage(h,prettifyResult(m))}function orList(d){return d.length<2?d[0]:d.length===2?d.join(" or "):d.slice(0,-1).join(", ")+", or "+d.slice(-1)}function prettifyResult(d){return"must be "+addArticle(d)+"."}function addArticle(d){return/^an? /.test(d)?d:/^[aeiou]/i.test(d)?"an "+d:/^[a-z]/i.test(d)?"a "+d:d}function formatErrorMessage(d,h){var p=isArrayCulprit(d.path),m=d.path.join(".")+" "+h,w=p?"Item at position ":"";return w+m}function isArrayCulprit(d){return typeof d[d.length-1]=="number"||typeof d[0]=="number"}function objectEntries(d){return Object.keys(d||{}).map(function(h){return{key:h,value:d[h]}})}v$3.validate=validate;v$3.processMessage=processMessage;var lib$1=v$3,xtend$1=immutable,v$2=lib$1;function file(d){if(typeof window!="undefined")return d instanceof commonjsGlobal.Blob||d instanceof commonjsGlobal.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof d=="string"||d.pipe!==void 0))return"Filename or Readable stream"}function assertShape(d,h){return v$2.assert(v$2.strictShape(d),h)}function date(d){var h="date";if(typeof d=="boolean")return h;try{var p=new Date(d);if(p.getTime&&isNaN(p.getTime()))return h}catch{return h}}function coordinates(d){return v$2.tuple(v$2.number,v$2.number)(d)}var validator=xtend$1(v$2,{file,date,coordinates,assertShape});function pick$1(d,h){var p=function(m,w){return h.indexOf(m)!==-1&&w!==void 0};return typeof h=="function"&&(p=h),Object.keys(d).filter(function(m){return p(m,d[m])}).reduce(function(m,w){return m[w]=d[w],m},{})}var pick_1=pick$1;function objectMap$1(d,h){return Object.keys(d).reduce(function(p,m){return p[m]=h(m,d[m]),p},{})}var objectMap_1=objectMap$1,objectMap=objectMap_1;function stringifyBoolean(d){return objectMap(d,function(h,p){return typeof p=="boolean"?JSON.stringify(p):p})}var stringifyBooleans$1=stringifyBoolean,MapiClient=mapiClient,createClient=browserClient;function createServiceFactory$1(d){return function(h){var p;MapiClient.prototype.isPrototypeOf(h)?p=h:p=createClient(h);var m=Object.create(d);return m.client=p,m}}var createServiceFactory_1=createServiceFactory$1,xtend=immutable,v$1=validator,pick=pick_1,stringifyBooleans=stringifyBooleans$1,createServiceFactory=createServiceFactory_1,Geocoding={},featureTypes=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Geocoding.forwardGeocode=function(d){v$1.assertShape({query:v$1.required(v$1.string),mode:v$1.oneOf("mapbox.places","mapbox.places-permanent"),countries:v$1.arrayOf(v$1.string),proximity:v$1.coordinates,types:v$1.arrayOf(v$1.oneOf(featureTypes)),autocomplete:v$1.boolean,bbox:v$1.arrayOf(v$1.number),limit:v$1.number,language:v$1.arrayOf(v$1.string),routing:v$1.boolean,fuzzyMatch:v$1.boolean,worldview:v$1.string})(d),d.mode=d.mode||"mapbox.places";var h=stringifyBooleans(xtend({country:d.countries},pick(d,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(d,["mode","query"]),query:h})};Geocoding.reverseGeocode=function(d){v$1.assertShape({query:v$1.required(v$1.coordinates),mode:v$1.oneOf("mapbox.places","mapbox.places-permanent"),countries:v$1.arrayOf(v$1.string),types:v$1.arrayOf(v$1.oneOf(featureTypes)),bbox:v$1.arrayOf(v$1.number),limit:v$1.number,language:v$1.arrayOf(v$1.string),reverseMode:v$1.oneOf("distance","score"),routing:v$1.boolean,worldview:v$1.string})(d),d.mode=d.mode||"mapbox.places";var h=stringifyBooleans(xtend({country:d.countries},pick(d,["country","types","bbox","limit","language","reverseMode","routing","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(d,["mode","query"]),query:h})};var geocoding=createServiceFactory(Geocoding),crypto=self.crypto||self.msCrypto,url="-_",i$1=36;for(;i$1--;)url+=i$1.toString(36);i$1=36;for(;i$1---10;)url+=i$1.toString(36).toUpperCase();var index_browser=function(d){var h="",p=crypto.getRandomValues(new Uint8Array(d||21));for(i$1=d||21;i$1--;)h+=url[p[i$1]&63];return h},nanoid=index_browser;function MapboxEventManager$1(d){this.origin=d.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=d.accessToken,this.version="0.2.0",this.sessionID=this.generateSessionID(),this.userAgent=this.getUserAgent(),this.options=d,this.send=this.send.bind(this),this.countries=d.countries?d.countries.split(","):null,this.types=d.types?d.types.split(","):null,this.bbox=d.bbox?d.bbox:null,this.language=d.language?d.language.split(","):null,this.limit=d.limit?+d.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(d),this.eventQueue=new Array,this.flushInterval=d.flushInterval||1e3,this.maxQueueSize=d.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}MapboxEventManager$1.prototype={select:function(d,h){var p=this.getSelectedIndex(d,h),m=this.getEventPayload("search.select",h);if(m.resultIndex=p,m.resultPlaceName=d.place_name,m.resultId=d.id,!(p===this.lastSentIndex&&m.queryString===this.lastSentInput||p==-1)&&(this.lastSentIndex=p,this.lastSentInput=m.queryString,!!m.queryString))return this.push(m)},start:function(d){var h=this.getEventPayload("search.start",d);if(!!h.queryString)return this.push(h)},keyevent:function(d,h){if(!!d.key&&!(d.metaKey||[9,27,37,39,13,38,40].indexOf(d.keyCode)!==-1)){var p=this.getEventPayload("search.keystroke",h);if(p.lastAction=d.key,!!p.queryString)return this.push(p)}},send:function(d,h){if(!this.enableEventLogging)return h?h():void 0;var p=this.getRequestOptions(d);this.request(p,function(m){if(m)return this.handleError(m,h);if(h)return h()}.bind(this))},getRequestOptions:function(d){Array.isArray(d)||(d=[d]);var h={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(d)};return h},getEventPayload:function(d,h){var p;h.options.proximity?p=[h.options.proximity.longitude,h.options.proximity.latitude]:p=null;var m=h._map?h._map.getZoom():void 0,w={event:d,created:+new Date,sessionIdentifier:this.sessionID,country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:h.options.autocomplete,fuzzyMatch:h.options.fuzzyMatch,proximity:p,limit:h.options.limit,routing:h.options.routing,worldview:h.options.worldview,mapZoom:m,keyboardLocale:this.locale};return d==="search.select"?w.queryString=h.inputString:d!="search.select"&&h._inputEl?w.queryString=h._inputEl.value:w.queryString=h.inputString,w},request:function(d,h){var p=new XMLHttpRequest;p.onreadystatechange=function(){if(this.readyState==4)return this.status==204?h(null):h(this.statusText)},p.open(d.method,d.host+"/"+d.path,!0);for(var m in d.headers){var w=d.headers[m];p.setRequestHeader(m,w)}p.send(d.body)},handleError:function(d,h){if(h)return h(d)},generateSessionID:function(){return nanoid()},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(d,h){if(!!h._typeahead){var p=h._typeahead.data,m=d.id,w=p.map(function(k){return k.id}),T=w.indexOf(m);return T}},shouldEnableLogging:function(d){return!(d.enableEventLogging===!1||d.origin&&d.origin.indexOf("api.mapbox.com")==-1||d.localGeocoder||d.filter)},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(d,h){this.eventQueue.push(d),(this.eventQueue.length>=this.maxQueueSize||h)&&this.flush()},remove:function(){this.flush()}};var events=MapboxEventManager$1,placeholder={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"\u05DC\u05D7\u05E4\u05E9",ja:"\u30B5\u30FC\u30C1",lv:"Mekl\u0113t",pt:"Procurar",sr:"\u041F\u0440\u0435\u0442\u0440\u0430\u0433\u0430",zh:"\u641C\u7D22",cs:"Vyhled\xE1v\xE1n\xED",hu:"Keres\xE9s",ka:"\u10EB\u10D8\u10D4\u10D1\u10D0",nb:"S\xF8ke",sk:"Vyh\u013Ead\xE1vanie",th:"\u0E04\u0E49\u0E19\u0E2B\u0E32",fi:"Hae",is:"Leita",ko:"\uC218\uC0C9",pl:"Szukaj",sl:"Iskanje",fa:"\u062C\u0633\u062A\u062C\u0648",ru:"\u041F\u043E\u0438\u0441\u043A"},localization$1={placeholder},subtag$1={exports:{}};(function(d){(function(h,p,m){d.exports?d.exports=m():h[p]=m()})(commonjsGlobal,"subtag",function(){var h="",p=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function m(B){return B.match(p)||[]}function w(B){return m(B).filter(function(P,O){return P&&O})}function T(B){return B=m(B),{language:B[1]||h,extlang:B[2]||h,script:B[3]||h,region:B[4]||h}}function k(B,P,O){Object.defineProperty(B,P,{value:O,enumerable:!0})}function x(B,P,O){function U(G){return m(G)[B]||h}k(U,"pattern",P),k(T,O,U)}return x(1,/^[a-zA-Z]{2,3}$/,"language"),x(2,/^[a-zA-Z]{3}$/,"extlang"),x(3,/^[a-zA-Z]{4}$/,"script"),x(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),k(T,"split",w),T})})(subtag$1);var Typeahead=suggestions,debounce=lodash_debounce,extend=immutable,EventEmitter=events$1.exports.EventEmitter,exceptions=exceptions$1,MapboxClient=mapboxSdk,mbxGeocoder=geocoding,MapboxEventManager=events,localization=localization$1,subtag=subtag$1.exports;const GEOCODE_REQUEST_TYPE={FORWARD:0,LOCAL:1,REVERSE:2};function MapboxGeocoder(d){this._eventEmitter=new EventEmitter,this.options=extend({},this.options,d),this.inputString="",this.fresh=!0,this.lastSelected=null}MapboxGeocoder.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,getItemValue:function(d){return d.place_name},render:function(d){var h=d.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+h[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+h.splice(1,h.length).join(",")+"</div></div>"}},addTo:function(d){function h(p,m){if(!document.body.contains(m))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const w=p.onAdd();m.appendChild(w)}if(d._controlContainer)d.addControl(this);else if(d instanceof HTMLElement)h(this,d);else if(typeof d=="string"){const p=document.querySelectorAll(d);if(p.length===0)throw new Error("Element ",d,"not found.");if(p.length>1)throw new Error("Geocoder can only be added to a single html element");h(this,p[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(d){if(d&&typeof d!="string"&&(this._map=d),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new MapboxEventManager(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this);var h=this.container=document.createElement("div");h.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var p=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",debounce(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",function(T){this.eventManager.keyevent(T,this)}.bind(this));var m=document.createElement("div");m.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var w=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');return this._clearEl.appendChild(w),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),m.appendChild(this._clearEl),m.appendChild(this._loadingEl),h.appendChild(p),h.appendChild(this._inputEl),h.appendChild(m),this._typeahead=new Typeahead(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit}),this.setRenderFunction(this.options.render),this._typeahead.getItemValue=this.options.getItemValue,this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),h},createIcon:function(d,h){var p=document.createElementNS("http://www.w3.org/2000/svg","svg");if(p.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+d),p.setAttribute("viewBox","0 0 18 18"),p.setAttribute("xml:space","preserve"),p.setAttribute("width",18),p.setAttribute("height",18),"innerHTML"in p)p.innerHTML=h;else{var m=document.createElement("div");m.innerHTML="<svg>"+h.valueOf().toString()+"</svg>";var w=m.firstChild,T=w.firstChild;p.appendChild(T)}return p},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_onPaste:function(d){var h=(d.clipboardData||window.clipboardData).getData("text");h.length>=this.options.minLength&&this._geocode(h)},_onKeyDown:function(d){var h=27,p=9;if(d.keyCode===h&&this.options.clearAndBlurOnEsc)return this._clear(d),this._inputEl.blur();var m=d.target&&d.target.shadowRoot?d.target.shadowRoot.activeElement:d.target,w=m?m.value:"";if(!w)return this.fresh=!0,d.keyCode!==p&&this.clear(d),this._clearEl.style.display="none";d.metaKey||[p,h,37,39,13,38,40].indexOf(d.keyCode)!==-1||m.value.length>=this.options.minLength&&this._geocode(m.value)},_showButton:function(){this._typeahead.selected&&(this._clearEl.style.display="block")},_hideButton:function(){this._typeahead.selected&&(this._clearEl.style.display="none")},_onBlur:function(d){this.options.clearOnBlur&&this._clearOnBlur(d),this.options.collapsed&&this._collapse()},_onChange:function(){var d=this._typeahead.selected;if(d&&JSON.stringify(d)!==this.lastSelected){if(this._clearEl.style.display="none",this.options.flyTo){var h;if(d.properties&&exceptions[d.properties.short_code])h=extend({},this.options.flyTo),this._map&&this._map.fitBounds(exceptions[d.properties.short_code].bbox,h);else if(d.bbox){var p=d.bbox;h=extend({},this.options.flyTo),this._map&&this._map.fitBounds([[p[0],p[1]],[p[2],p[3]]],h)}else{var m={zoom:this.options.zoom};h=extend({},m,this.options.flyTo),d.center?h.center=d.center:d.geometry&&d.geometry.type&&d.geometry.type==="Point"&&d.geometry.coordinates&&(h.center=d.geometry.coordinates),this._map&&this._map.flyTo(h)}}this.options.marker&&this._mapboxgl&&this._handleMarker(d),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(d),this._eventEmitter.emit("result",{result:d}),this.eventManager.select(d,this)}},_requestType:function(d,h){var p;const m=/^[ ]*(-?\d+\.?\d*)[, ]+(-?\d+\.?\d*)[ ]*$/;return d.localGeocoderOnly?p=GEOCODE_REQUEST_TYPE.LOCAL:d.reverseGeocode&&m.test(h)?p=GEOCODE_REQUEST_TYPE.REVERSE:p=GEOCODE_REQUEST_TYPE.FORWARD,p},_setupConfig:function(d,h){const p=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],m=/[\s,]+/;var w=this,T=p.reduce(function(x,B){if(w.options[B]===void 0||w.options[B]===null)return x;["countries","types","language"].indexOf(B)>-1?x[B]=w.options[B].split(m):x[B]=w.options[B];const P=typeof w.options[B].longitude=="number"&&typeof w.options[B].latitude=="number";if(B==="proximity"&&P){const O=w.options[B].longitude,U=w.options[B].latitude;x[B]=[O,U]}return x},{});switch(d){case GEOCODE_REQUEST_TYPE.REVERSE:{var k=h.split(m).map(function(x){return parseFloat(x,10)}).reverse();T.types&&T.types[0],T=extend(T,{query:k,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(x){x in T&&delete T[x]})}break;case GEOCODE_REQUEST_TYPE.FORWARD:/^[ ]*(-?\d+\.?\d*)[, ]+(-?\d+\.?\d*)*[ ]*$/.test(h)&&(h=h.replace(/,/g," ")),T=extend(T,{query:h});break}return T},_geocode:function(d){this.inputString=d,this._loadingEl.style.display="block",this._eventEmitter.emit("loading",{query:d});const h=this._requestType(this.options,d),p=this._setupConfig(h,d);var m;switch(h){case GEOCODE_REQUEST_TYPE.LOCAL:m=Promise.resolve();break;case GEOCODE_REQUEST_TYPE.FORWARD:m=this.geocoderService.forwardGeocode(p).send();break;case GEOCODE_REQUEST_TYPE.REVERSE:m=this.geocoderService.reverseGeocode(p).send();break}var w=this.options.localGeocoder?this.options.localGeocoder(d)||[]:[],T=[],k=null;return m.catch(function(x){k=x}.bind(this)).then(function(x){this._loadingEl.style.display="none";var B={};return x?x.statusCode=="200"&&(B=x.body,B.request=x.request,B.headers=x.headers):B={type:"FeatureCollection",features:[]},B.config=p,this.fresh&&(this.eventManager.start(this),this.fresh=!1),B.features=B.features?w.concat(B.features):w,this.options.externalGeocoder?(T=this.options.externalGeocoder(d,B.features)||[],T.then(function(P){return B.features=B.features?P.concat(B.features):P,B},function(){return B})):B}.bind(this)).then(function(x){if(k)throw k;this.options.filter&&x.features.length&&(x.features=x.features.filter(this.options.filter)),x.features.length?(this._clearEl.style.display="block",this._eventEmitter.emit("results",x),this._typeahead.update(x.features)):(this._clearEl.style.display="none",this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",x))}.bind(this)).catch(function(x){this._loadingEl.style.display="none",w.length&&this.options.localGeocoder||T.length&&this.options.externalGeocoder?(this._clearEl.style.display="block",this._typeahead.update(w)):(this._clearEl.style.display="none",this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:w}),this._eventEmitter.emit("error",{error:x})}.bind(this)),m},_clear:function(d){d&&d.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this._onChange(),this._clearEl.style.display="none",this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(d){this._clear(d),this._inputEl.focus()},_clearOnBlur:function(d){var h=this;d.relatedTarget&&h._clear(d)},_onQueryResult:function(d){var h=d.body;if(!!h.features.length){var p=h.features[0];this._typeahead.selected=p,this._inputEl.value=p.place_name,this._onChange()}},_updateProximity:function(){if(!!this._map)if(this._map.getZoom()>9){var d=this._map.getCenter().wrap();this.setProximity({longitude:d.lng,latitude:d.lat})}else this.setProximity(null)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(d){return this._geocode(d).then(this._onQueryResult),this},_renderError:function(){var d="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(d)},_renderNoResults:function(){var d="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(d)},_renderMessage:function(d){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(d)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var d=this.options.language.split(",")[0],h=subtag.language(d),p=localization.placeholder[h];if(p)return p}return"Search"},setInput:function(d){return this._inputEl.value=d,this._typeahead.selected=null,this._typeahead.clear(),d.length>=this.options.minLength&&this._geocode(d),this},setProximity:function(d){return this.options.proximity=d,this},getProximity:function(){return this.options.proximity},setRenderFunction:function(d){return d&&typeof d=="function"&&(this._typeahead.render=d),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(d){var h=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=d||this.options.language||h,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(d){return this.options.zoom=d,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(d){return this.options.flyTo=d,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(d){return this.placeholder=d||this._getPlaceholderText(),this._inputEl.placeholder=this.placeholder,this._inputEl.setAttribute("aria-label",this.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(d){return this.options.bbox=d,this},getCountries:function(){return this.options.countries},setCountries:function(d){return this.options.countries=d,this},getTypes:function(){return this.options.types},setTypes:function(d){return this.options.types=d,this},getMinLength:function(){return this.options.minLength},setMinLength:function(d){return this.options.minLength=d,this._typeahead&&(this._typeahead.options.minLength=d),this},getLimit:function(){return this.options.limit},setLimit:function(d){return this.options.limit=d,this._typeahead&&(this._typeahead.options.limit=d),this},getFilter:function(){return this.options.filter},setFilter:function(d){return this.options.filter=d,this},setOrigin:function(d){return this.options.origin=d,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAutocomplete:function(d){return this.options.autocomplete=d,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(d){return this.options.fuzzyMatch=d,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(d){return this.options.routing=d,this},getRouting:function(){return this.options.routing},setWorldview:function(d){return this.options.worldview=d,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(d){if(!!this._map){this._removeMarker();var h={color:"#4668F2"},p=extend({},h,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(p),d.center?this.mapMarker.setLngLat(d.center).addTo(this._map):d.geometry&&d.geometry.type&&d.geometry.type==="Point"&&d.geometry.coordinates&&this.mapMarker.setLngLat(d.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(d,h){return this._eventEmitter.on(d,h),this},off:function(d,h){return this._eventEmitter.removeListener(d,h),this.eventManager.remove(),this}};var lib=MapboxGeocoder,mapboxMapViewer_vue_vue_type_style_index_0_lang="";const _sfc_main$4={name:"mapbox-map-viewer",setup(){return{dirHandle:ref(""),style_url:ref(""),access_token:ref(""),mapbox_raster_png_dem:ref(""),mapbox_api_url:ref(""),mapbox_rgb_image_url:ref(""),map:ref(""),threedview:ref(!1),layers:ref(["hillshading","bounding_box","undersea-features-lines","undersea-features-points","undersea-features-points-label","10m-bathymetry-81bsvj"]),layer_type:[{label:"Hillshade",value:"hillshading"},{label:"Bounding Box",value:"bounding_box"},{label:"Undersea Lines",value:"undersea-features-lines"},{label:"Undersea Points",value:"undersea-features-points"},{label:"Undersea Labels",value:"undersea-features-points-label"},{label:"Depth",value:"10m-bathymetry-81bsvj"},{label:"Satellite",value:"satellite"},{label:"3D",value:"3d"}]}},mounted(){},methods:{async changeLayers(d){for(const h of this.layer_type)d.includes(h.value)?h.value!=="3d"?this.map.setLayoutProperty(h.value,"visibility","visible"):this.map.setTerrain({source:"mapbox-3d",exaggeration:1.5}):h.value!=="3d"?this.map.setLayoutProperty(h.value,"visibility","none"):this.map.setTerrain(null)},loadMapSourcesLayers(d){d.addSource("mapbox_terrain_dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1"}),d.addSource("satellite",{type:"raster",url:"mapbox://mapbox.satellite",tileSize:512}),d.addLayer({id:"satellite",source:"satellite",type:"raster",layout:{visibility:"none"}}),d.addLayer({id:"hillshading",source:"mapbox_terrain_dem",type:"hillshade"}),d.addSource("bounding_box_source",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,1],[1,1],[1,0],[0,0]]]}}}),d.addLayer({id:"bounding_box",type:"fill",source:"bounding_box_source",paint:{"fill-color":"#008888","fill-opacity":0}}),d.addSource("bathymetry",{type:"vector",url:"mapbox://mapbox-public.bathymetry"}),d.addLayer({id:"undersea-features-lines",type:"line",source:"bathymetry","source-layer":"undersea-features-lines",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ff69b4","line-width":2}}),d.addLayer({id:"undersea-features-points",type:"circle",source:"bathymetry","source-layer":"undersea-features-points",paint:{"circle-radius":4,"circle-color":"#01fe01"}}),d.addLayer({id:"undersea-features-points-label",type:"symbol",source:"bathymetry","source-layer":"undersea-features-points",layout:{"text-field":"{name}","text-anchor":"top-left","text-size":12}}),d.addSource("10m-bathymetry-81bsvj",{type:"vector",url:"mapbox://mapbox.9tm8dx88"}),d.addSource("mapbox-3d",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:14}),d.addLayer({id:"10m-bathymetry-81bsvj",type:"fill",source:"10m-bathymetry-81bsvj","source-layer":"10m-bathymetry-81bsvj",layout:{},paint:{"fill-outline-color":"hsla(337, 82%, 62%, 0)","fill-color":["interpolate",["cubic-bezier",0,.5,1,.5],["get","DEPTH"],200,"#78bced",9e3,"#15659f"]}},"land-structure-polygon")},async loadMapboxMap(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.mapbox_api_url=await idbKeyval.get("mapbox_api_url"),this.dirHandle=await idbKeyval.get("dirHandle"),this.style_url=await idbKeyval.get("style_url"),this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem");let d=this,h=new mapboxgl.Map({container:"map",trackResize:!0,style:d.style_url,center:[-121.7598,46.876],zoom:9,doubleClickZoom:!0,antialias:!0,boxZoom:!0,failIfMajorPerformanceCaveat:!0});this.map=h;const p=function(k){const x=k.match(/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i);if(!x)return null;function B(G,j){return{center:[G,j],geometry:{type:"Point",coordinates:[G,j]},place_name:"Lat: "+j+" Lng: "+G,place_type:["coordinate"],properties:{},type:"Feature"}}const P=Number(x[1]),O=Number(x[2]),U=[];return(P<-90||P>90)&&U.push(B(P,O)),(O<-90||O>90)&&U.push(B(O,P)),U.length===0&&(U.push(B(P,O)),U.push(B(O,P))),U};h.addControl(new lib({accessToken:this.access_token,mapboxgl,localGeocoder:p,zoom:10,placeholder:"Try: -40, 170 or  Name",reverseGeocode:!0})),h.addControl(new mapboxgl.FullscreenControl({})),h.addControl(new mapboxgl.NavigationControl);const m=100,w=25;function T(k){return k*(2-k)}h.on("style.load",()=>{const k=()=>{h.isStyleLoaded()?d.loadMapSourcesLayers(h):setTimeout(k,200)};k()}),h.on("load",function(){h.getCanvas().focus(),h.getCanvas().addEventListener("keydown",k=>{k.preventDefault(),k.which===87?h.panBy([0,-m],{easing:T}):k.which===83?h.panBy([0,m],{easing:T}):k.which===65?h.easeTo({bearing:h.getBearing()-w,easing:T}):k.which===68&&h.easeTo({bearing:h.getBearing()+w,easing:T})},!0)}),h.on("error",k=>{console.error(k)}),h.on("click",async function(k){let x=await idbKeyval.get("dirHandle");if(await fileUtils.verifyPermission(x,!0)===!1){console.error(`User did not grant permission to '${x.name}'`);return}let B=k.lngLat.lng,P=k.lngLat.lat,O=mapUtils.getTileInfo(B,P,h);idbKeyval.set("tile_info",O),h.getSource("bounding_box_source").setData(O.polygon_bb),h.setPaintProperty("bounding_box","fill-opacity",.45),d.mapbox_rgb_image_url=d.mapbox_api_url+d.mapbox_raster_png_dem+`/${O.z}/${O.x}/${O.y}@2x.pngraw?access_token=`+d.access_token;let U=await mapUtils.getMapboxTerrainRgb(x,O,d.mapbox_rgb_image_url),G=await U.toBuffer();await idbKeyval.set("rgb_image_buffer",G),await fileUtils.writeFileToDisk(x,O.rgbFileName,G);let j=mapUtils.createHeightMapImage(U,32,"GREY");if(await fileUtils.fileExists(x,O.thirtytwoFile.name)===!1){let te=await j.image.toBuffer();await fileUtils.writeFileToDisk(x,O.thirtytwoFile.name,te)}emitter.emit("updatePreviewImage",{dir_handle:x,tile_info:O,preview_image_info:j,map:h})}),h.on("mousemove",k=>{h.getCanvas().style.cursor="pointer";const x=h.queryRenderedFeatures(k.point);for(const B of x)if(Object.keys(B.type).length>0&&Object.keys(B.properties).length>0){let P=B.properties;B.layer,P.DEPTH}})},resizeMap(){this.map.resize()},async geoCodeReverse(d){await lib.reverseGeocode({query:[d.lng,d.lat]}).send().then(function(h){h&&h.body&&h.body.features&&(d.address=h.body.features[0].place_name)})}}},_hoisted_1$4={id:"map"},_hoisted_2$4={class:"row no-wrap q-pa-md"},_hoisted_3$3={class:"column"},_hoisted_4$3=createBaseVNode("u",null,[createBaseVNode("b",null,"Enable Layers")],-1);function _sfc_render$3(d,h,p,m,w,T){const k=resolveComponent("q-option-group"),x=resolveComponent("q-menu"),B=resolveComponent("q-btn"),P=resolveComponent("q-toolbar");return openBlock(),createElementBlock("div",_hoisted_1$4,[createVNode(P,{id:"mb-tbar",class:"bg-primary text-white q-pa-none q-ma-none"},{default:withCtx(()=>[createVNode(B,{color:"info",label:"Map Settings"},{default:withCtx(()=>[createVNode(x,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_2$4,[createBaseVNode("div",_hoisted_3$3,[_hoisted_4$3,createVNode(k,{dense:"",color:"green","checked-icon":"check","unchecked-icon":"clear",options:m.layer_type,type:"toggle",modelValue:m.layers,"onUpdate:modelValue":[h[0]||(h[0]=O=>m.layers=O),T.changeLayers]},null,8,["options","modelValue","onUpdate:modelValue"])])])]),_:1})]),_:1})]),_:1})])}var MapboxMapViewer=_export_sfc(_sfc_main$4,[["render",_sfc_render$3]]);let gdalWorker=new Worker("worker.js");const _sfc_main$3={name:"SideNav",setup(){const d=useQuasar();return{alert:ref(!1),unrealLandscape:ref({label:505,value:505}),landscapeSize:[{label:"8129x8129",value:8129},{label:"4033x4033",value:4033},{label:"2017x2017",value:2017},{label:"1009x1009",value:1009},{label:"512x512-Downloaded-Size",value:512},{label:"505x505",value:505}],url:ref("thirtytwo-9-82-180.png"),tile_info:ref(""),dirHandle:ref(""),preview_image_info:ref(""),rgb_image:ref(""),minmax:ref(""),elevation_range:ref(""),tileWidthInMeters:ref(""),metersPerPixel:ref(""),zscale:ref(""),map:null,data:null,bbinfoalert:ref(!1),exportType:ref("unreal"),landscapeName:ref(""),qt:d,exportOptions:[{label:"Unreal",value:"unreal"},{label:"Normalize",value:"normalize"},{label:"None",value:"none"}]}},async mounted(){emitter.on("updatePreviewImage",d=>{this.data=d,this.updatePreviewImage()}),gdalWorker.onmessage=d=>{this.saveImage(d.data)}},methods:{showBBInfo(){this.tile_info?this.bbinfoalert=!0:this.alert=!0},async sendToUnreal(){if(this.tile_info){this.qt.loading.show(),this.tile_info.landscapeName=this.landscapeName;let d={objectPath:"/Script/EditorScriptingUtilities.Default__EditorLevelLibrary",functionName:"GetAllLevelActors"},h,p="GenerateMapboxLandscape_BP",m=await mapUtils.unrealRemoteControl(d);for(let k of m.ReturnValue)k.includes(p)===!0&&(h=k.split("_").pop());p=p+"_"+h;let w={objectPath:"/Game/Maps/MapboxBrideExample.MapboxBrideExample:PersistentLevel."+p,functionName:"GenMapboxLandscape",parameters:{FileName:this.tile_info.sixteenFile.name+"-LandscapeSize-"+this.tile_info.resolution+".png",LandscapeName:this.tile_info.landscapeName}},T=await mapUtils.unrealRemoteControl(w);console.log(T),this.qt.loading.hide()}else this.alert=!0},async saveImage(d){let h=await idbKeyval.get("dirHandle"),p=new Blob([d],{type:"image/png"});await fileUtils.writeFileToDisk(h,this.tile_info.sixteenFile.name+"-LandscapeSize-"+this.tile_info.resolution+".png",p),this.qt.loading.hide()},updateStats(){this.maxElevation!==""?(this.minmax=this.preview_image_info.minElevation.toFixed(3)+" / "+this.preview_image_info.maxElevation.toFixed(3),this.elevation_range=(this.preview_image_info.maxElevation-this.preview_image_info.minElevation).toFixed(3),this.tileWidthInMeters=this.tile_info.tileWidthInMeters.toFixed(3),this.metersPerPixel=this.tile_info.metersPerPixel.toFixed(3),this.zscale=this.getUnrealZScale(this.preview_image_info.maxElevation).toFixed(3)):this.minmax=""},getUnrealZScale(d){return d*100*.001953125},async writeFiles(d){let h=await idbKeyval.get("dirHandle");await fileUtils.writeFileToDisk(h,this.tile_info.sixteenFile.name+"-LandscapeSize-"+this.tile_info.resolution+".png",d);let p=mapUtils.getFeaturesFromBB(this.map,this.tile_info.polygon_bb),m=JSON.stringify(p),w=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(h,"geojson-"+this.tile_info.mapbox_tile_name+"-"+this.tile_info.resolution+".json",m),await fileUtils.writeFileToDisk(h,"tile_info-"+this.tile_info.mapbox_tile_name+"-"+this.tile_info.resolution+".json",w)},async updatePreviewImage(){this.preview_image_info=await this.data.preview_image_info,this.tile_info=this.data.tile_info,this.map=this.data.map;let d=await this.preview_image_info.image.toBlob();const h=URL.createObjectURL(d);this.url=h,this.updateStats()},async createSixteenHeightMap(){if(this.tile_info){this.qt.loading.show();let d=await idbKeyval.get("dirHandle");if(fileUtils.verifyPermission(d,!0)===!1){console.error(`User did not grant permission to '${d.name}'`);return}if(fileUtils.fileExists(d,this.tile_info.thirtytwoFile)){let p=await idbKeyval.get("rgb_image_buffer");await idbKeyval.get("rgbImageArrayBuffer");let m=await mapUtils.loadImageFromArray(p),w=mapUtils.createHeightMapImage(m,16,"GREY"),T=w.image;this.tile_info.resolution=this.unrealLandscape.value;let k=parseInt(w.minElevation).toString(),x=parseInt(w.maxElevation).toString(),B=await T.toBuffer(),P=this.unrealLandscape.value.toString();switch(this.exportType){case"unreal":let j=["-ot","UInt16","-of","PNG","-scale",k,x,"32768","65535","-outsize",P,P,"-r","lanczos"],H=new File([B],"heightmap.png",{type:"image/png",lastModified:Date.now()}),te=new DataTransfer;te.items.add(H);let oe=te.files,Q={};Q.files=oe,Q.translateOptions=j,gdalWorker.postMessage(Q);break;case"normalize":T=T.level(),await fileUtils.writeFileToDisk(d,this.tile_info.sixteenFile.name+"-LandscapeSize-"+this.tile_info.resolution+".png",T.toBuffer());break;case"none":await fileUtils.writeFileToDisk(d,this.tile_info.sixteenFile.name+"-LandscapeSize-"+this.tile_info.resolution+".png",T.toBuffer());break}let O=mapUtils.getFeaturesFromBB(this.map,this.tile_info.polygon_bb),U=JSON.stringify(O),G=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(d,"geojson-"+this.tile_info.mapbox_tile_name+"-"+this.tile_info.resolution+".json",U),await fileUtils.writeFileToDisk(d,"tile_info-"+this.tile_info.mapbox_tile_name+"-"+this.tile_info.resolution+".json",G)}else this.alert=!0}else this.alert=!0}}},_hoisted_1$3=createBaseVNode("div",{id:"previewTitle",class:"text-h6 bg-primary text-white"},"Preview Image",-1),_hoisted_2$3={class:"row justify-start q-pa-none q-ma-none"},_hoisted_3$2={style:{width:"100%"}},_hoisted_4$2={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_5$1={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_6$1={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_7$1=createTextVNode("Export Type:"),_hoisted_8$1={class:"row justify-betweenq-pt-none q-mt-xs"},_hoisted_9=createBaseVNode("div",{class:"text-h6"},"Alert",-1),_hoisted_10=createTextVNode(" Please select a tile to download first. ");function _sfc_render$2(d,h,p,m,w,T){const k=resolveComponent("q-img"),x=resolveComponent("q-field"),B=resolveComponent("q-item-label"),P=resolveComponent("q-option-group"),O=resolveComponent("q-select"),U=resolveComponent("q-input"),G=resolveComponent("q-btn"),j=resolveComponent("q-card-section"),H=resolveComponent("q-card-actions"),te=resolveComponent("q-card"),oe=resolveComponent("q-dialog"),Q=resolveDirective("close-popup");return openBlock(),createElementBlock(Fragment,null,[_hoisted_1$3,createVNode(k,{src:m.url,height:"150px"},null,8,["src"]),createBaseVNode("div",_hoisted_2$3,[createBaseVNode("div",_hoisted_3$2,[createVNode(x,{dense:"",class:"text-weight-bolder q-pt-none q-mt-xs",label:"Min/Max Elevation","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_4$2,toDisplayString(m.minmax),1)]),_:1}),createVNode(x,{class:"q-pt-none q-mt-xs",dense:"",label:"Tile width in meters","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_5$1,toDisplayString(m.tileWidthInMeters),1)]),_:1}),createVNode(x,{class:"q-pt-none q-mt-xs",dense:"",label:"Unreal Z-Scale",hint:"Input into Unreal Landscape Z scale","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_6$1,toDisplayString(m.zscale),1)]),_:1}),createVNode(B,{class:"q-pt-none q-mt-xs"},{default:withCtx(()=>[_hoisted_7$1]),_:1}),createVNode(P,{class:"q-mt-none q-pt-none",dense:"",inline:"",options:m.exportOptions,type:"radio",modelValue:m.exportType,"onUpdate:modelValue":h[0]||(h[0]=_e=>m.exportType=_e)},null,8,["options","modelValue"]),createVNode(O,{dense:"",class:"q-pt-none q-mt-xs",label:"Landscape Size","transition-show":"scale","transition-hide":"scale",hint:"Unreal Recommended Sizes",outlined:"",modelValue:m.unrealLandscape,"onUpdate:modelValue":h[1]||(h[1]=_e=>m.unrealLandscape=_e),options:m.landscapeSize},null,8,["modelValue","options"])])]),createVNode(x,{class:"q-pt-none q-mt-xs",dense:"",label:"Landscape Name",hint:"Enter Unique Landscape Name"},{default:withCtx(()=>[createVNode(U,{modelValue:m.landscapeName,"onUpdate:modelValue":h[2]||(h[2]=_e=>m.landscapeName=_e)},null,8,["modelValue"])]),_:1}),createBaseVNode("div",_hoisted_8$1,[createVNode(G,{onClick:T.createSixteenHeightMap,dense:"",color:"primary","no-caps":"",label:"Download HeightMap"},null,8,["onClick"]),createVNode(G,{onClick:T.sendToUnreal,dense:"",color:"green",class:"q-ml-xs","no-caps":"",label:"Send To Unreal"},null,8,["onClick"])]),createVNode(oe,{modelValue:m.alert,"onUpdate:modelValue":h[3]||(h[3]=_e=>m.alert=_e)},{default:withCtx(()=>[createVNode(te,null,{default:withCtx(()=>[createVNode(j,null,{default:withCtx(()=>[_hoisted_9]),_:1}),createVNode(j,{class:"q-pt-none"},{default:withCtx(()=>[_hoisted_10]),_:1}),createVNode(H,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(G,{flat:"",label:"OK",color:"primary"},null,512),[[Q]])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}var SideNav=_export_sfc(_sfc_main$3,[["render",_sfc_render$2]]);const _sfc_main$2={props:{},emits:["ok","hide"],methods:{show(){this.$refs.dialog.show()},hide(){this.$refs.dialog.hide()},onDialogHide(){this.$emit("hide")},onOKClick(){this.$emit("ok"),this.hide()},onCancelClick(){this.hide()}}},_hoisted_1$2=createBaseVNode("div",null,[createBaseVNode("div",{class:"text-weight-bold"},"Help Section")],-1),_hoisted_2$2=createBaseVNode("div",{class:""},"TODO:",-1);function _sfc_render$1(d,h,p,m,w,T){const k=resolveComponent("q-space"),x=resolveComponent("q-btn"),B=resolveComponent("q-card-section"),P=resolveComponent("q-separator"),O=resolveComponent("q-card-actions"),U=resolveComponent("q-card"),G=resolveComponent("q-dialog"),j=resolveDirective("close-popup");return openBlock(),createBlock(G,{class:"dialog-plugin",ref:"dialog",onHide:T.onDialogHide},{default:withCtx(()=>[createVNode(U,{style:{width:"600px",height:"600px"}},{default:withCtx(()=>[createVNode(B,{class:"row items-center no-wrap",style:{height:"50px"}},{default:withCtx(()=>[_hoisted_1$2,createVNode(k),withDirectives(createVNode(x,{flat:"",round:"",icon:"close"},null,512),[[j]])]),_:1}),createVNode(P),_hoisted_2$2,createVNode(O,{class:"absolute-bottom",align:"right"},{default:withCtx(()=>[createVNode(x,{color:"primary",label:"OK",onClick:T.onOKClick},null,8,["onClick"]),createVNode(x,{color:"primary",label:"Cancel",onClick:T.onCancelClick},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["onHide"])}var Help=_export_sfc(_sfc_main$2,[["render",_sfc_render$1]]);try{self["workbox:window:6.4.1"]&&_()}catch(d){}function n(d,h){return new Promise(function(p){var m=new MessageChannel;m.port1.onmessage=function(w){p(w.data)},d.postMessage(h,[m.port2])})}function t(d,h){for(var p=0;p<h.length;p++){var m=h[p];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(d,m.key,m)}}function r(d,h){(h==null||h>d.length)&&(h=d.length);for(var p=0,m=new Array(h);p<h;p++)m[p]=d[p];return m}function e(d,h){var p;if(typeof Symbol=="undefined"||d[Symbol.iterator]==null){if(Array.isArray(d)||(p=function(w,T){if(w){if(typeof w=="string")return r(w,T);var k=Object.prototype.toString.call(w).slice(8,-1);return k==="Object"&&w.constructor&&(k=w.constructor.name),k==="Map"||k==="Set"?Array.from(w):k==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(k)?r(w,T):void 0}}(d))||h&&d&&typeof d.length=="number"){p&&(d=p);var m=0;return function(){return m>=d.length?{done:!0}:{done:!1,value:d[m++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}return(p=d[Symbol.iterator]()).next.bind(p)}try{self["workbox:core:6.4.1"]&&_()}catch(d){}var i=function(){var d=this;this.promise=new Promise(function(h,p){d.resolve=h,d.reject=p})};function o(d,h){var p=location.href;return new URL(d,p).href===new URL(h,p).href}var u=function(d,h){this.type=d,Object.assign(this,h)};function a(d,h,p){return p?h?h(d):d:(d&&d.then||(d=Promise.resolve(d)),h?d.then(h):d)}function c(){}var f={type:"SKIP_WAITING"};function s(d,h){if(!h)return d&&d.then?d.then(c):Promise.resolve()}var v=function(d){var h,p;function m(x,B){var P,O;return B===void 0&&(B={}),(P=d.call(this)||this).nn={},P.tn=0,P.rn=new i,P.en=new i,P.on=new i,P.un=0,P.an=new Set,P.cn=function(){var U=P.fn,G=U.installing;P.tn>0||!o(G.scriptURL,P.sn.toString())||performance.now()>P.un+6e4?(P.vn=G,U.removeEventListener("updatefound",P.cn)):(P.hn=G,P.an.add(G),P.rn.resolve(G)),++P.tn,G.addEventListener("statechange",P.ln)},P.ln=function(U){var G=P.fn,j=U.target,H=j.state,te=j===P.vn,oe={sw:j,isExternal:te,originalEvent:U};!te&&P.mn&&(oe.isUpdate=!0),P.dispatchEvent(new u(H,oe)),H==="installed"?P.wn=self.setTimeout(function(){H==="installed"&&G.waiting===j&&P.dispatchEvent(new u("waiting",oe))},200):H==="activating"&&(clearTimeout(P.wn),te||P.en.resolve(j))},P.dn=function(U){var G=P.hn,j=G!==navigator.serviceWorker.controller;P.dispatchEvent(new u("controlling",{isExternal:j,originalEvent:U,sw:G,isUpdate:P.mn})),j||P.on.resolve(G)},P.gn=(O=function(U){var G=U.data,j=U.ports,H=U.source;return a(P.getSW(),function(){P.an.has(H)&&P.dispatchEvent(new u("message",{data:G,originalEvent:U,ports:j,sw:H}))})},function(){for(var U=[],G=0;G<arguments.length;G++)U[G]=arguments[G];try{return Promise.resolve(O.apply(this,U))}catch(j){return Promise.reject(j)}}),P.sn=x,P.nn=B,navigator.serviceWorker.addEventListener("message",P.gn),P}p=d,(h=m).prototype=Object.create(p.prototype),h.prototype.constructor=h,h.__proto__=p;var w,T,k=m.prototype;return k.register=function(x){var B=(x===void 0?{}:x).immediate,P=B!==void 0&&B;try{var O=this;return function(U,G){var j=U();return j&&j.then?j.then(G):G(j)}(function(){if(!P&&document.readyState!=="complete")return s(new Promise(function(U){return window.addEventListener("load",U)}))},function(){return O.mn=Boolean(navigator.serviceWorker.controller),O.yn=O.pn(),a(O.bn(),function(U){O.fn=U,O.yn&&(O.hn=O.yn,O.en.resolve(O.yn),O.on.resolve(O.yn),O.yn.addEventListener("statechange",O.ln,{once:!0}));var G=O.fn.waiting;return G&&o(G.scriptURL,O.sn.toString())&&(O.hn=G,Promise.resolve().then(function(){O.dispatchEvent(new u("waiting",{sw:G,wasWaitingBeforeRegister:!0}))}).then(function(){})),O.hn&&(O.rn.resolve(O.hn),O.an.add(O.hn)),O.fn.addEventListener("updatefound",O.cn),navigator.serviceWorker.addEventListener("controllerchange",O.dn),O.fn})})}catch(U){return Promise.reject(U)}},k.update=function(){try{return this.fn?s(this.fn.update()):void 0}catch(x){return Promise.reject(x)}},k.getSW=function(){return this.hn!==void 0?Promise.resolve(this.hn):this.rn.promise},k.messageSW=function(x){try{return a(this.getSW(),function(B){return n(B,x)})}catch(B){return Promise.reject(B)}},k.messageSkipWaiting=function(){this.fn&&this.fn.waiting&&n(this.fn.waiting,f)},k.pn=function(){var x=navigator.serviceWorker.controller;return x&&o(x.scriptURL,this.sn.toString())?x:void 0},k.bn=function(){try{var x=this;return function(B,P){try{var O=B()}catch(U){return P(U)}return O&&O.then?O.then(void 0,P):O}(function(){return a(navigator.serviceWorker.register(x.sn,x.nn),function(B){return x.un=performance.now(),B})},function(B){throw B})}catch(B){return Promise.reject(B)}},w=m,(T=[{key:"active",get:function(){return this.en.promise}},{key:"controlling",get:function(){return this.on.promise}}])&&t(w.prototype,T),m}(function(){function d(){this.Pn=new Map}var h=d.prototype;return h.addEventListener=function(p,m){this.Sn(p).add(m)},h.removeEventListener=function(p,m){this.Sn(p).delete(m)},h.dispatchEvent=function(p){p.target=this;for(var m,w=e(this.Sn(p.type));!(m=w()).done;)(0,m.value)(p)},h.Sn=function(p){return this.Pn.has(p)||this.Pn.set(p,new Set),this.Pn.get(p)},d}());function registerSW(d={}){const{immediate:h=!1,onNeedRefresh:p,onOfflineReady:m,onRegistered:w,onRegisterError:T}=d;let k;const x=async(B=!0)=>{};return"serviceWorker"in navigator&&(k=new v("/sw.js",{scope:"/",type:"classic"}),k.addEventListener("activated",B=>{B.isUpdate?window.location.reload():m==null||m()}),k.register({immediate:h}).then(B=>{w==null||w(B)}).catch(B=>{T==null||T(B)})),x}function useRegisterSW(d={}){const{immediate:h=!0,onNeedRefresh:p,onOfflineReady:m,onRegistered:w,onRegisterError:T}=d,k=ref(!1),x=ref(!1);return{updateServiceWorker:registerSW({immediate:h,onNeedRefresh(){k.value=!0,p==null||p()},onOfflineReady(){x.value=!0,m==null||m()},onRegistered:w,onRegisterError:T}),offlineReady:x,needRefresh:k}}var ReloadPrompt_vue_vue_type_style_index_0_lang="";const _hoisted_1$1={key:0,class:"pwa-toast",role:"alert"},_hoisted_2$1={class:"message"},_hoisted_3$1={key:0},_hoisted_4$1={key:1},_sfc_main$1=defineComponent({setup(d){const{offlineReady:h,needRefresh:p,updateServiceWorker:m}=useRegisterSW({onRegistered(T){console.log(`SW Registered: ${T}`)}}),w=async()=>{h.value=!1,p.value=!1};return(T,k)=>unref(h)||unref(p)?(openBlock(),createElementBlock("div",_hoisted_1$1,[createBaseVNode("div",_hoisted_2$1,[unref(h)?(openBlock(),createElementBlock("span",_hoisted_3$1," App ready to work offline ")):(openBlock(),createElementBlock("span",_hoisted_4$1," New content available, click on reload button to update. "))]),unref(p)?(openBlock(),createElementBlock("button",{key:0,onClick:k[0]||(k[0]=x=>unref(m)())}," Reload ")):createCommentVNode("",!0),createBaseVNode("button",{onClick:w}," Close ")])):createCommentVNode("",!0)}}),_sfc_main={setup(){const d=useQuasar();return{showDialog(){d.dialog({component:Help,componentProps:{text:"something"}}).onOk(()=>{}).onCancel(()=>{}).onDismiss(()=>{})},data_path:"",selectedTab:ref("map"),dirHandle:ref(""),dirName:ref(""),style_url:ref(""),access_token:ref(""),mapbox_api_url:ref(""),mapbox_raster_png_dem:ref(""),showPwaBtn:!0,isPwd:ref(!0),drawerLeft:ref(!1),createFolder:ref(!1)}},mounted:async function(){await idbKeyval.get("pwa-installed")&&(this.showPwaBtn=!1),await this.loadUserData(),this.isRequiredSettings()===!0&&await this.loadMap(),window.addEventListener("appinstalled",this.pwaInstalled)},methods:{pwaInstalled(){idbKeyval.set("pwa-installed",!0),this.showPwaBtn=!1},async installPWA(){console.log(window.installEvent),window.installEvent.prompt(),window.installEvent=null},resizeMap(){this.$refs.mapBoxViewer.resizeMap()},changeDrawer(){this.drawerLeft=!this.drawerLeft},async loadMap(){this.selectedTab="map",await this.$nextTick(()=>{this.$refs.mapBoxViewer.loadMapboxMap()})},isRequiredSettings(){return this.access_token&&this.style_url&&this.dirName?!0:(this.redirectToSettings(),!1)},redirectToSettings(){this.selectedTab="settings",Notify.create({color:"negative",textColor:"white",icon:"report_problem",message:"Please fill out the required fields!",position:"top"})},async openDirectory(){let d;try{d=await fileUtils.getDirHandle()}catch(h){if(h.name==="AbortError")return;console.error("An error occured trying to open the file.",h)}!d||(idbKeyval.set("dirHandle",d),this.dirName=d.name)},saveUserSettings(){idbKeyval.set("access_token",this.access_token),idbKeyval.set("style_url",this.style_url),idbKeyval.set("mapbox_api_url",this.mapbox_api_url),idbKeyval.set("mapbox_raster_png_dem",this.mapbox_raster_png_dem),idbKeyval.set("create_folder",this.createFolder),this.isRequiredSettings()===!0&&this.loadMap()},async loadUserData(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken||"",this.style_url=await idbKeyval.get("style_url")||"mapbox://styles/mapbox/streets-v11",this.mapbox_api_url=await idbKeyval.get("mapbox_api_url")||"https://api.mapbox.com/v4/",this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem")||"mapbox.mapbox-terrain-dem-v1";let d=await idbKeyval.get("dirHandle")||"";this.createFolder=await idbKeyval.get("create_folder")||"",this.dirHandle=d,this.dirName=d.name}},components:{MapboxMapViewer,SideNav,Help,ReloadPrompt:_sfc_main$1}},_hoisted_1={class:"row q-pa-xs full-height"},_hoisted_2=createTextVNode(" See: "),_hoisted_3=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/access-token/",target:"_blank"},"Mapbox access token docs",-1),_hoisted_4=createTextVNode(" See: "),_hoisted_5=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/style-url/",target:"_blank"},"Mapbox style url docs",-1),_hoisted_6={class:"q-pa-none row items-start"},_hoisted_7={class:"col q-pa-none"},_hoisted_8=createBaseVNode("br",null,null,-1);function _sfc_render(d,h,p,m,w,T){const k=resolveComponent("q-header"),x=resolveComponent("ReloadPrompt"),B=resolveComponent("side-nav"),P=resolveComponent("q-card"),O=resolveComponent("q-drawer"),U=resolveComponent("q-btn"),G=resolveComponent("q-tab"),j=resolveComponent("q-tabs"),H=resolveComponent("q-separator"),te=resolveComponent("mapbox-map-viewer"),oe=resolveComponent("q-tab-panel"),Q=resolveComponent("q-icon"),_e=resolveComponent("q-input"),se=resolveComponent("q-tab-panels"),le=resolveComponent("q-page"),me=resolveComponent("q-page-container"),Re=resolveComponent("q-layout");return openBlock(),createBlock(Re,{view:"lHr lpr lfr"},{default:withCtx(()=>[createVNode(k,{dense:"",elevated:"",class:"bg-primary text-white","height-hint":"98"}),createVNode(x),createVNode(O,{dense:"","show-if-above":"",modelValue:m.drawerLeft,"onUpdate:modelValue":h[0]||(h[0]=xe=>m.drawerLeft=xe),side:"left",onHide:T.resizeMap,class:"no-margin no-padding"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1,[createVNode(P,{class:"col q-pl-xs"},{default:withCtx(()=>[createVNode(B)]),_:1})])]),_:1},8,["modelValue","onHide"]),createVNode(me,null,{default:withCtx(()=>[createVNode(le,{class:"row no-margin q-pa-sm"},{default:withCtx(()=>[createVNode(P,{class:"col"},{default:withCtx(()=>[createVNode(j,{dense:"",modelValue:m.selectedTab,"onUpdate:modelValue":h[3]||(h[3]=xe=>m.selectedTab=xe),class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:withCtx(()=>[createVNode(U,{dense:"",flat:"",onClick:T.changeDrawer,round:"",icon:"menu"},null,8,["onClick"]),createVNode(G,{dense:"",name:"map",label:"Map"}),createVNode(G,{dense:"",name:"settings",label:"Settings"}),withDirectives(createVNode(U,{style:{color:"white"},label:"Install as App",class:"q-mr-lg bg-positive",onClick:h[1]||(h[1]=xe=>T.installPWA())},null,512),[[vShow,m.showPwaBtn]]),createVNode(U,{style:{background:"#FF0080",color:"white"},label:"Help",class:"q-mr-lg",onClick:m.showDialog},null,8,["onClick"]),createVNode(U,{dense:"",flat:"",round:"",onClick:h[2]||(h[2]=xe=>d.$q.dark.toggle()),icon:d.$q.dark.isActive?"nights_stay":"wb_sunny"},null,8,["icon"])]),_:1},8,["modelValue"]),createVNode(H),createVNode(se,{class:"q-pa-none q-ma-none","keep-alive":"",modelValue:m.selectedTab,"onUpdate:modelValue":h[12]||(h[12]=xe=>m.selectedTab=xe),animated:""},{default:withCtx(()=>[createVNode(oe,{name:"map",class:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",style:{width:"100%",height:"calc(100vh - 65px)"}},{default:withCtx(()=>[createVNode(te,{class:"col",ref:"mapBoxViewer"},null,512)]),_:1}),createVNode(oe,{lass:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",name:"settings"},{default:withCtx(()=>[_hoisted_2,_hoisted_3,createVNode(_e,{dense:"",modelValue:m.access_token,"onUpdate:modelValue":h[5]||(h[5]=xe=>m.access_token=xe),label:"Mapbox Access Token *",filled:"",type:m.isPwd?"password":"text","lazy-rules":"",hint:"You will need your own access token created from your Mapbox accounts page. The Mapbox free plan is a great choice.",rules:[xe=>xe&&xe.length>0||"Please type something"]},{append:withCtx(()=>[createVNode(Q,{dense:"",name:m.isPwd?"visibility_off":"visibility",class:"cursor-pointer",onClick:h[4]||(h[4]=xe=>m.isPwd=!m.isPwd)},null,8,["name"])]),_:1},8,["modelValue","type","rules"]),_hoisted_4,_hoisted_5,createVNode(_e,{dense:"",class:"q-pb-lg",modelValue:m.style_url,"onUpdate:modelValue":h[6]||(h[6]=xe=>m.style_url=xe),label:"Enter your Mapbox style url *",filled:"","lazy-rules":"",hint:"You can use the default style or you can create your own custom style in Mapbox Studio.",rules:[xe=>xe&&xe.length>0||"Please type something"],type:m.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(_e,{dense:"",class:"q-pb-lg",modelValue:m.mapbox_api_url,"onUpdate:modelValue":h[7]||(h[7]=xe=>m.mapbox_api_url=xe),label:"Mapbox base api url *",filled:"","lazy-rules":"",hint:"",rules:[xe=>xe&&xe.length>0||"Please type something"],type:m.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(_e,{dense:"",class:"q-pb-lg",modelValue:m.mapbox_raster_png_dem,"onUpdate:modelValue":h[8]||(h[8]=xe=>m.mapbox_raster_png_dem=xe),label:"Mapbox Raster Dem Endpoint *",filled:"","lazy-rules":"",hint:"",rules:[xe=>xe&&xe.length>0||"Please type something"],type:m.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createBaseVNode("div",_hoisted_6,[createBaseVNode("div",_hoisted_7,[createVNode(_e,{dense:"",class:"q-pb-none",modelValue:m.dirName,"onUpdate:modelValue":h[9]||(h[9]=xe=>m.dirName=xe),label:"Enter download directory path *",filled:"","lazy-rules":"",rules:[xe=>xe&&xe.length>0||"Please type something"],type:m.isPwd?"":"text"},null,8,["modelValue","rules","type"])]),createVNode(U,{class:"q-pb-none",dense:"",onClick:h[10]||(h[10]=xe=>T.openDirectory()),color:"secondary",label:"Select download folder"})]),_hoisted_8,createVNode(U,{class:"q-pt-none",dense:"",onClick:h[11]||(h[11]=xe=>T.saveUserSettings()),color:"secondary",label:"Save settings"})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})}var MainLayout=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{MainLayout as default};
