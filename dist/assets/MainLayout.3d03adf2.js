var ng=Object.defineProperty;var Bf=Object.getOwnPropertySymbols;var og=Object.prototype.hasOwnProperty,sg=Object.prototype.propertyIsEnumerable;var Rf=(n,t,s)=>t in n?ng(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s,Su=(n,t)=>{for(var s in t||(t={}))og.call(t,s)&&Rf(n,s,t[s]);if(Bf)for(var s of Bf(t))sg.call(t,s)&&Rf(n,s,t[s]);return n};import{_ as _export_sfc,r as ref,a as resolveComponent,o as openBlock,c as createElementBlock,b as createVNode,w as withCtx,d as createBaseVNode,u as useQuasar,e as resolveDirective,t as toDisplayString,f as createTextVNode,g as withDirectives,F as Fragment,h as createBlock,N as Notify}from"./index.14c90aef.js";class Store{constructor(t="unreal-mapbox",s="keyval"){this.storeName=s,this._dbp=new Promise((l,f)=>{const m=indexedDB.open(t,3);m.onerror=()=>f(m.error),m.onsuccess=()=>l(m.result),m.onupgradeneeded=()=>{try{m.result.deleteObjectStore(s)}catch{}m.result.createObjectStore(s)}})}_withIDBStore(t,s){return this._dbp.then(l=>new Promise((f,m)=>{const b=l.transaction(this.storeName,t);b.oncomplete=()=>f(),b.onabort=b.onerror=()=>m(b.error),s(b.objectStore(this.storeName))}))}}let store;function getDefaultStore(){return store||(store=new Store),store}function get(n,t=getDefaultStore()){let s;return t._withIDBStore("readonly",l=>{s=l.get(n)}).then(()=>s.result)}function set(n,t,s=getDefaultStore()){return s._withIDBStore("readwrite",l=>{l.put(t,n)})}function del(n,t=getDefaultStore()){return t._withIDBStore("readwrite",s=>{s.delete(n)})}function clear(n=getDefaultStore()){return n._withIDBStore("readwrite",t=>{t.clear()})}function keys(n=getDefaultStore()){const t=[];return n._withIDBStore("readonly",s=>{(s.openKeyCursor||s.openCursor).call(s).onsuccess=function(){!this.result||(t.push(this.result.key),this.result.continue())}}).then(()=>t)}var idbKeyval={keys,clear,del,set,get};function getFileHandle(){if("showOpenFilePicker"in window)return window.showOpenFilePicker().then(n=>n[0])}function getDirHandle(){if("showDirectoryPicker"in window)return window.showDirectoryPicker().then(n=>n)}async function verifyPermission(n,t){const s={};return t&&(s.writable=!0,s.mode="readwrite"),await n.queryPermission(s)==="granted"||await n.requestPermission(s)==="granted"}async function writeFileToDisk(n,t,s){let f=await(await n.getFileHandle(t,{create:!0})).createWritable();await f.write(s),await f.close()}async function fileExists(n,t){try{return await n.getFileHandle(t),!0}catch(s){if(s.name==="NotFoundError")return!1;if(s.name==="NotAllowedError")return console.log("Please select directory to verify permissions"),!1}}async function readFileFromDisk(n,t){return await(await(await n.getFileHandle(t)).getFile()).arrayBuffer()}var fileUtils={getDirHandle,verifyPermission,writeFileToDisk,fileExists,getFileHandle,readFileFromDisk},commonjsGlobal=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function getAugmentedNamespace(n){if(n.__esModule)return n;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach(function(s){var l=Object.getOwnPropertyDescriptor(n,s);Object.defineProperty(t,s,l.get?l:{enumerable:!0,get:function(){return n[s]}})}),t}function commonjsRequire(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var mapboxGl={exports:{}};(function(n,t){(function(s,l){n.exports=l()})(commonjsGlobal,function(){var s,l,f;function m(h,S){if(!s)s=S;else if(!l)l=S;else{var M="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+s+")(sharedChunk); ("+l+")(sharedChunk); self.onerror = null;",C={};s(C),f=S(C),typeof window!="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(f.workerUrl=window.URL.createObjectURL(new Blob([M],{type:"text/javascript"})))}}m(["exports"],function(h){var S="2.8.1",M=C;function C(u,e,d,p){this.cx=3*u,this.bx=3*(d-u)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(p-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=u,this.p1y=p,this.p2x=d,this.p2y=p}C.prototype.sampleCurveX=function(u){return((this.ax*u+this.bx)*u+this.cx)*u},C.prototype.sampleCurveY=function(u){return((this.ay*u+this.by)*u+this.cy)*u},C.prototype.sampleCurveDerivativeX=function(u){return(3*this.ax*u+2*this.bx)*u+this.cx},C.prototype.solveCurveX=function(u,e){var d,p,_,x,T;for(e===void 0&&(e=1e-6),_=u,T=0;T<8;T++){if(x=this.sampleCurveX(_)-u,Math.abs(x)<e)return _;var A=this.sampleCurveDerivativeX(_);if(Math.abs(A)<1e-6)break;_-=x/A}if((_=u)<(d=0))return d;if(_>(p=1))return p;for(;d<p;){if(x=this.sampleCurveX(_),Math.abs(x-u)<e)return _;u>x?d=_:p=_,_=.5*(p-d)+d}return _},C.prototype.solve=function(u,e){return this.sampleCurveY(this.solveCurveX(u,e))};var L=N;function N(u,e){this.x=u,this.y=e}N.prototype={clone:function(){return new N(this.x,this.y)},add:function(u){return this.clone()._add(u)},sub:function(u){return this.clone()._sub(u)},multByPoint:function(u){return this.clone()._multByPoint(u)},divByPoint:function(u){return this.clone()._divByPoint(u)},mult:function(u){return this.clone()._mult(u)},div:function(u){return this.clone()._div(u)},rotate:function(u){return this.clone()._rotate(u)},rotateAround:function(u,e){return this.clone()._rotateAround(u,e)},matMult:function(u){return this.clone()._matMult(u)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(u){return this.x===u.x&&this.y===u.y},dist:function(u){return Math.sqrt(this.distSqr(u))},distSqr:function(u){var e=u.x-this.x,d=u.y-this.y;return e*e+d*d},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(u){return Math.atan2(this.y-u.y,this.x-u.x)},angleWith:function(u){return this.angleWithSep(u.x,u.y)},angleWithSep:function(u,e){return Math.atan2(this.x*e-this.y*u,this.x*u+this.y*e)},_matMult:function(u){var e=u[2]*this.x+u[3]*this.y;return this.x=u[0]*this.x+u[1]*this.y,this.y=e,this},_add:function(u){return this.x+=u.x,this.y+=u.y,this},_sub:function(u){return this.x-=u.x,this.y-=u.y,this},_mult:function(u){return this.x*=u,this.y*=u,this},_div:function(u){return this.x/=u,this.y/=u,this},_multByPoint:function(u){return this.x*=u.x,this.y*=u.y,this},_divByPoint:function(u){return this.x/=u.x,this.y/=u.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var u=this.y;return this.y=this.x,this.x=-u,this},_rotate:function(u){var e=Math.cos(u),d=Math.sin(u),p=d*this.x+e*this.y;return this.x=e*this.x-d*this.y,this.y=p,this},_rotateAround:function(u,e){var d=Math.cos(u),p=Math.sin(u),_=e.y+p*(this.x-e.x)+d*(this.y-e.y);return this.x=e.x+d*(this.x-e.x)-p*(this.y-e.y),this.y=_,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},N.convert=function(u){return u instanceof N?u:Array.isArray(u)?new N(u[0],u[1]):u};var F=typeof self!="undefined"?self:{};const G=Math.PI/180,H=180/Math.PI;function K(u){return u*G}function X(u){return u*H}const de=[[0,0],[1,0],[1,1],[0,1]];function Q(u){if(u<=0)return 0;if(u>=1)return 1;const e=u*u,d=e*u;return 4*(u<.5?d:3*(u-e)+d-.75)}function ie(u,e,d,p){const _=new M(u,e,d,p);return function(x){return _.solve(x)}}const ce=ie(.25,.1,.25,1);function ge(u,e,d){return Math.min(d,Math.max(e,u))}function be(u,e,d){return(d=ge((d-u)/(e-u),0,1))*d*(3-2*d)}function ne(u,e,d){const p=d-e,_=((u-e)%p+p)%p+e;return _===e?d:_}function ve(u,e,d){if(!u.length)return d(null,[]);let p=u.length;const _=new Array(u.length);let x=null;u.forEach((T,A)=>{e(T,(D,B)=>{D&&(x=D),_[A]=B,--p==0&&d(x,_)})})}function te(u){const e=[];for(const d in u)e.push(u[d]);return e}function he(u,...e){for(const d of e)for(const p in d)u[p]=d[p];return u}let Ie=1;function Oe(){return Ie++}function tt(){return function u(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,u)}()}function it(u){return u<=1?1:Math.pow(2,Math.ceil(Math.log(u)/Math.LN2))}function Ct(u){return!!u&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(u)}function Rt(u,e){u.forEach(d=>{e[d]&&(e[d]=e[d].bind(e))})}function xt(u,e){return u.indexOf(e,u.length-e.length)!==-1}function Vt(u,e,d){const p={};for(const _ in u)p[_]=e.call(d||this,u[_],_,u);return p}function It(u,e,d){const p={};for(const _ in u)e.call(d||this,u[_],_,u)&&(p[_]=u[_]);return p}function Xt(u){return Array.isArray(u)?u.map(Xt):typeof u=="object"&&u?Vt(u,Xt):u}const Jt={};function nt(u){Jt[u]||(typeof console!="undefined"&&console.warn(u),Jt[u]=!0)}function mt(u,e,d){return(d.y-u.y)*(e.x-u.x)>(e.y-u.y)*(d.x-u.x)}function ft(u){let e=0;for(let d,p,_=0,x=u.length,T=x-1;_<x;T=_++)d=u[_],p=u[T],e+=(p.x-d.x)*(d.y+p.y);return e}function Dt(){return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope}function qt(u){const e={};if(u.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(d,p,_,x)=>{const T=_||x;return e[p]=!T||T.toLowerCase(),""}),e["max-age"]){const d=parseInt(e["max-age"],10);isNaN(d)?delete e["max-age"]:e["max-age"]=d}return e}let oi,ti,fi,si,Ot=null;function ai(u){if(Ot==null){const e=u.navigator?u.navigator.userAgent:null;Ot=!!u.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return Ot}function Nt(u){try{const e=F[u];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}}const dt={now:()=>fi!==void 0?fi:F.performance.now(),setNow(u){fi=u},restoreNow(){fi=void 0},frame(u){const e=F.requestAnimationFrame(u);return{cancel:()=>F.cancelAnimationFrame(e)}},getImageData(u,e=0){const{width:d,height:p}=u;si||(si=F.document.createElement("canvas"));const _=si.getContext("2d");if(!_)throw new Error("failed to create canvas 2d context");return(d>si.width||p>si.height)&&(si.width=d,si.height=p),_.clearRect(-e,-e,d+2*e,p+2*e),_.drawImage(u,0,0,d,p),_.getImageData(-e,-e,d+2*e,p+2*e)},resolveURL:u=>(oi||(oi=F.document.createElement("a")),oi.href=u,oi.href),get devicePixelRatio(){return F.devicePixelRatio},get prefersReducedMotion(){return!!F.matchMedia&&(ti==null&&(ti=F.matchMedia("(prefers-reduced-motion: reduce)")),ti.matches)}};let gi;const Et={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(gi==null){const u=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{gi={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):u}catch{gi=u}}return gi},get EVENTS_URL(){return this.API_URL?this.API_URL.indexOf("https://api.mapbox.cn")===0?"https://events.mapbox.cn/events/v2":this.API_URL.indexOf("https://api.mapbox.com")===0?"https://events.mapbox.com/events/v2":null:null},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},je={supported:!1,testSupport:function(u){!Qt&&Wt&&(ni?gt(u):jt=u)}};let jt,Wt,Qt=!1,ni=!1;function gt(u){const e=u.createTexture();u.bindTexture(u.TEXTURE_2D,e);try{if(u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,Wt),u.isContextLost())return;je.supported=!0}catch{}u.deleteTexture(e),Qt=!0}F.document&&(Wt=F.document.createElement("img"),Wt.onload=function(){jt&&gt(jt),jt=null,ni=!0},Wt.onerror=function(){Qt=!0,jt=null},Wt.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Ai="01",ci="NO_ACCESS_TOKEN";function Lt(u){return u.indexOf("mapbox:")===0}function $t(u){return Et.API_URL_REGEX.test(u)}const _t=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function hi(u){const e=u.match(_t);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function _i(u){const e=u.params.length?`?${u.params.join("&")}`:"";return`${u.protocol}://${u.authority}${u.path}${e}`}function wi(u){if(!u)return null;const e=u.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(decodeURIComponent(F.atob(e[1]).split("").map(d=>"%"+("00"+d.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class Ht{constructor(e){this.type=e,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){const d=wi(Et.ACCESS_TOKEN);let p="";return p=d&&d.u?F.btoa(encodeURIComponent(d.u).replace(/%([0-9A-F]{2})/g,(_,x)=>String.fromCharCode(Number("0x"+x)))):Et.ACCESS_TOKEN||"",e?`mapbox.eventData.${e}:${p}`:`mapbox.eventData:${p}`}fetchEventData(){const e=Nt("localStorage"),d=this.getStorageKey(),p=this.getStorageKey("uuid");if(e)try{const _=F.localStorage.getItem(d);_&&(this.eventData=JSON.parse(_));const x=F.localStorage.getItem(p);x&&(this.anonId=x)}catch{nt("Unable to read from LocalStorage")}}saveEventData(){const e=Nt("localStorage"),d=this.getStorageKey(),p=this.getStorageKey("uuid");if(e)try{F.localStorage.setItem(p,this.anonId),Object.keys(this.eventData).length>=1&&F.localStorage.setItem(d,JSON.stringify(this.eventData))}catch{nt("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,d,p,_){if(!Et.EVENTS_URL)return;const x=hi(Et.EVENTS_URL);x.params.push(`access_token=${_||Et.ACCESS_TOKEN||""}`);const T={event:this.type,created:new Date(e).toISOString(),sdkIdentifier:"mapbox-gl-js",sdkVersion:S,skuId:Ai,userId:this.anonId},A=d?he(T,d):T,D={url:_i(x),headers:{"Content-Type":"text/plain"},body:JSON.stringify([A])};this.pendingRequest=Ce(D,B=>{this.pendingRequest=null,p(B),this.saveEventData(),this.processRequests(_)})}queueRequest(e,d){this.queue.push(e),this.processRequests(d)}}const ui=new class extends Ht{constructor(u){super("appUserTurnstile"),this._customAccessToken=u}postTurnstileEvent(u,e){Et.EVENTS_URL&&Et.ACCESS_TOKEN&&Array.isArray(u)&&u.some(d=>Lt(d)||$t(d))&&this.queueRequest(Date.now(),e)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=wi(Et.ACCESS_TOKEN),d=e?e.u:Et.ACCESS_TOKEN;let p=d!==this.eventData.tokenU;Ct(this.anonId)||(this.anonId=tt(),p=!0);const _=this.queue.shift();if(this.eventData.lastSuccess){const x=new Date(this.eventData.lastSuccess),T=new Date(_),A=(_-this.eventData.lastSuccess)/864e5;p=p||A>=1||A<-1||x.getDate()!==T.getDate()}else p=!0;p?this.postEvent(_,{"enabled.telemetry":!1},x=>{x||(this.eventData.lastSuccess=_,this.eventData.tokenU=d)},u):this.processRequests()}},Li=ui.postTurnstileEvent.bind(ui),zi=new class extends Ht{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(u,e,d,p){this.skuToken=e,this.errorCb=p,Et.EVENTS_URL&&(d||Et.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},d):this.errorCb(new Error(ci)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:d}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),Ct(this.anonId)||(this.anonId=tt()),this.postEvent(d,{skuToken:this.skuToken},p=>{p?this.errorCb(p):e&&(this.success[e]=!0)},u))}},Fi=zi.postMapLoadEvent.bind(zi),tr=new class extends Ht{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(u,e,d,p){if(!Et.API_URL||!Et.SESSION_PATH)return;const _=hi(Et.API_URL+Et.SESSION_PATH);_.params.push(`sku=${e||""}`),_.params.push(`access_token=${p||Et.ACCESS_TOKEN||""}`);const x={url:_i(_),headers:{"Content-Type":"text/plain"}};this.pendingRequest=Be(x,T=>{this.pendingRequest=null,d(T),this.saveEventData(),this.processRequests(p)})}getSessionAPI(u,e,d,p){this.skuToken=e,this.errorCb=p,Et.SESSION_PATH&&Et.API_URL&&(d||Et.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},d):this.errorCb(new Error(ci)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:d}=this.queue.shift();e&&this.success[e]||this.getSession(d,this.skuToken,p=>{p?this.errorCb(p):e&&(this.success[e]=!0)},u)}},Br=tr.getSessionAPI.bind(tr),Rr=new Set,Er="mapbox-tiles";let er,ur,mr=500,yr=50;function Sr(){F.caches&&!er&&(er=F.caches.open(Er))}function Lr(u){const e=u.indexOf("?");return e<0?u:u.slice(0,e)}let _e=1/0;const J={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(J);class j extends Error{constructor(e,d,p){d===401&&$t(p)&&(e+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(e),this.status=d,this.url=p}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Y=Dt()?()=>self.worker&&self.worker.referrer:()=>(F.location.protocol==="blob:"?F.parent:F).location.href,le=function(u,e){if(!(/^file:/.test(d=u.url)||/^file:/.test(Y())&&!/^\w+:/.test(d))){if(F.fetch&&F.Request&&F.AbortController&&F.Request.prototype.hasOwnProperty("signal"))return function(p,_){const x=new F.AbortController,T=new F.Request(p.url,{method:p.method||"GET",body:p.body,credentials:p.credentials,headers:p.headers,referrer:Y(),signal:x.signal});let A=!1,D=!1;const B=(O=T.url).indexOf("sku=")>0&&$t(O);var O;p.type==="json"&&T.headers.set("Accept","application/json");const $=(W,re,se)=>{if(D)return;if(W&&W.message!=="SecurityError"&&nt(W),re&&se)return V(re);const fe=Date.now();F.fetch(T).then(xe=>{if(xe.ok){const Ae=B?xe.clone():null;return V(xe,Ae,fe)}return _(new j(xe.statusText,xe.status,p.url))}).catch(xe=>{xe.code!==20&&_(new Error(xe.message))})},V=(W,re,se)=>{(p.type==="arrayBuffer"?W.arrayBuffer():p.type==="json"?W.json():W.text()).then(fe=>{D||(re&&se&&function(xe,Ae,Pe){if(Sr(),!er)return;const Re={status:Ae.status,statusText:Ae.statusText,headers:new F.Headers};Ae.headers.forEach((Xe,We)=>Re.headers.set(We,Xe));const ze=qt(Ae.headers.get("Cache-Control")||"");if(ze["no-store"])return;ze["max-age"]&&Re.headers.set("Expires",new Date(Pe+1e3*ze["max-age"]).toUTCString());const Fe=Re.headers.get("Expires");Fe&&(new Date(Fe).getTime()-Pe<42e4||function(Xe,We){if(ur===void 0)try{new Response(new ReadableStream),ur=!0}catch{ur=!1}ur?We(Xe.body):Xe.blob().then(We)}(Ae,Xe=>{const We=new F.Response(Xe,Re);Sr(),er&&er.then(et=>et.put(Lr(xe.url),We)).catch(et=>nt(et.message))}))}(T,re,se),A=!0,_(null,fe,W.headers.get("Cache-Control"),W.headers.get("Expires")))}).catch(fe=>{D||_(new Error(fe.message))})};return B?function(W,re){if(Sr(),!er)return re(null);const se=Lr(W.url);er.then(fe=>{fe.match(se).then(xe=>{const Ae=function(Pe){if(!Pe)return!1;const Re=new Date(Pe.headers.get("Expires")||0),ze=qt(Pe.headers.get("Cache-Control")||"");return Re>Date.now()&&!ze["no-cache"]}(xe);fe.delete(se),Ae&&fe.put(se,xe.clone()),re(null,xe,Ae)}).catch(re)}).catch(re)}(T,$):$(null,null),{cancel:()=>{D=!0,A||x.abort()}}}(u,e);if(Dt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",u,e,void 0,!0)}var d;return function(p,_){const x=new F.XMLHttpRequest;x.open(p.method||"GET",p.url,!0),p.type==="arrayBuffer"&&(x.responseType="arraybuffer");for(const T in p.headers)x.setRequestHeader(T,p.headers[T]);return p.type==="json"&&(x.responseType="text",x.setRequestHeader("Accept","application/json")),x.withCredentials=p.credentials==="include",x.onerror=()=>{_(new Error(x.statusText))},x.onload=()=>{if((x.status>=200&&x.status<300||x.status===0)&&x.response!==null){let T=x.response;if(p.type==="json")try{T=JSON.parse(x.response)}catch(A){return _(A)}_(null,T,x.getResponseHeader("Cache-Control"),x.getResponseHeader("Expires"))}else _(new j(x.statusText,x.status,p.url))},x.send(p.body),{cancel:()=>x.abort()}}(u,e)},pe=function(u,e){return le(he(u,{type:"arrayBuffer"}),e)},Ce=function(u,e){return le(he(u,{method:"POST"}),e)},Be=function(u,e){return le(he(u,{method:"GET"}),e)};function Le(u){const e=F.document.createElement("a");return e.href=u,e.protocol===F.document.location.protocol&&e.host===F.document.location.host}const De="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Ve,Ke;Ve=[],Ke=0;const ct=function(u,e){if(je.supported&&(u.headers||(u.headers={}),u.headers.accept="image/webp,*/*"),Ke>=Et.MAX_PARALLEL_IMAGE_REQUESTS){const x={requestParameters:u,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Ve.push(x),x}Ke++;let d=!1;const p=()=>{if(!d)for(d=!0,Ke--;Ve.length&&Ke<Et.MAX_PARALLEL_IMAGE_REQUESTS;){const x=Ve.shift(),{requestParameters:T,callback:A,cancelled:D}=x;D||(x.cancel=ct(T,A).cancel)}},_=pe(u,(x,T,A,D)=>{p(),x?e(x):T&&(F.createImageBitmap?function(B,O){const $=new F.Blob([new Uint8Array(B)],{type:"image/png"});F.createImageBitmap($).then(V=>{O(null,V)}).catch(V=>{O(new Error(`Could not load image because of ${V.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(T,(B,O)=>e(B,O,A,D)):function(B,O){const $=new F.Image,V=F.URL;$.onload=()=>{O(null,$),V.revokeObjectURL($.src),$.onload=null,F.requestAnimationFrame(()=>{$.src=De})},$.onerror=()=>O(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const W=new F.Blob([new Uint8Array(B)],{type:"image/png"});$.src=B.byteLength?V.createObjectURL(W):De}(T,(B,O)=>e(B,O,A,D)))});return{cancel:()=>{_.cancel(),p()}}};function Qe(u,e,d){d[u]&&d[u].indexOf(e)!==-1||(d[u]=d[u]||[],d[u].push(e))}function Pt(u,e,d){if(d&&d[u]){const p=d[u].indexOf(e);p!==-1&&d[u].splice(p,1)}}class bt{constructor(e,d={}){he(this,d),this.type=e}}class Bt extends bt{constructor(e,d={}){super("error",he({error:e},d))}}class Yt{on(e,d){return this._listeners=this._listeners||{},Qe(e,d,this._listeners),this}off(e,d){return Pt(e,d,this._listeners),Pt(e,d,this._oneTimeListeners),this}once(e,d){return d?(this._oneTimeListeners=this._oneTimeListeners||{},Qe(e,d,this._oneTimeListeners),this):new Promise(p=>this.once(e,p))}fire(e,d){typeof e=="string"&&(e=new bt(e,d||{}));const p=e.type;if(this.listens(p)){e.target=this;const _=this._listeners&&this._listeners[p]?this._listeners[p].slice():[];for(const A of _)A.call(this,e);const x=this._oneTimeListeners&&this._oneTimeListeners[p]?this._oneTimeListeners[p].slice():[];for(const A of x)Pt(p,A,this._oneTimeListeners),A.call(this,e);const T=this._eventedParent;T&&(he(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),T.fire(e))}else e instanceof Bt&&console.error(e.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,d){return this._eventedParent=e,this._eventedParentData=d,this}}var Ne=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":0.1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function Ei(u,...e){for(const d of e)for(const p in d)u[p]=d[p];return u}function Mt(u){return u instanceof Number||u instanceof String||u instanceof Boolean?u.valueOf():u}function Si(u){if(Array.isArray(u))return u.map(Si);if(u instanceof Object&&!(u instanceof Number||u instanceof String||u instanceof Boolean)){const e={};for(const d in u)e[d]=Si(u[d]);return e}return Mt(u)}class Ii extends Error{constructor(e,d){super(d),this.message=d,this.key=e}}class Zr{constructor(e,d=[]){this.parent=e,this.bindings={};for(const[p,_]of d)this.bindings[p]=_}concat(e){return new Zr(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const _n={kind:"null"},yt={kind:"number"},Ti={kind:"string"},yi={kind:"boolean"},dn={kind:"color"},Zn={kind:"object"},vi={kind:"value"},Xn={kind:"collator"},co={kind:"formatted"},Tr={kind:"resolvedImage"};function Xr(u,e){return{kind:"array",itemType:u,N:e}}function Zi(u){if(u.kind==="array"){const e=Zi(u.itemType);return typeof u.N=="number"?`array<${e}, ${u.N}>`:u.itemType.kind==="value"?"array":`array<${e}>`}return u.kind}const rh=[_n,yt,Ti,yi,dn,co,Zn,Xr(vi),Tr];function Oo(u,e){if(e.kind==="error")return null;if(u.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Oo(u.itemType,e.itemType))&&(typeof u.N!="number"||u.N===e.N))return null}else{if(u.kind===e.kind)return null;if(u.kind==="value"){for(const d of rh)if(!Oo(d,e))return null}}return`Expected ${Zi(u)} but found ${Zi(e)} instead.`}function xs(u,e){return e.some(d=>d.kind===u.kind)}function ho(u,e){return e.some(d=>d==="null"?u===null:d==="array"?Array.isArray(u):d==="object"?u&&!Array.isArray(u)&&typeof u=="object":d===typeof u)}function vs(u){var e={exports:{}};return u(e,e.exports),e.exports}var ga=vs(function(u,e){var d={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function p(A){return(A=Math.round(A))<0?0:A>255?255:A}function _(A){return p(A[A.length-1]==="%"?parseFloat(A)/100*255:parseInt(A))}function x(A){return(D=A[A.length-1]==="%"?parseFloat(A)/100:parseFloat(A))<0?0:D>1?1:D;var D}function T(A,D,B){return B<0?B+=1:B>1&&(B-=1),6*B<1?A+(D-A)*B*6:2*B<1?D:3*B<2?A+(D-A)*(2/3-B)*6:A}try{e.parseCSSColor=function(A){var D,B=A.replace(/ /g,"").toLowerCase();if(B in d)return d[B].slice();if(B[0]==="#")return B.length===4?(D=parseInt(B.substr(1),16))>=0&&D<=4095?[(3840&D)>>4|(3840&D)>>8,240&D|(240&D)>>4,15&D|(15&D)<<4,1]:null:B.length===7&&(D=parseInt(B.substr(1),16))>=0&&D<=16777215?[(16711680&D)>>16,(65280&D)>>8,255&D,1]:null;var O=B.indexOf("("),$=B.indexOf(")");if(O!==-1&&$+1===B.length){var V=B.substr(0,O),W=B.substr(O+1,$-(O+1)).split(","),re=1;switch(V){case"rgba":if(W.length!==4)return null;re=x(W.pop());case"rgb":return W.length!==3?null:[_(W[0]),_(W[1]),_(W[2]),re];case"hsla":if(W.length!==4)return null;re=x(W.pop());case"hsl":if(W.length!==3)return null;var se=(parseFloat(W[0])%360+360)%360/360,fe=x(W[1]),xe=x(W[2]),Ae=xe<=.5?xe*(fe+1):xe+fe-xe*fe,Pe=2*xe-Ae;return[p(255*T(Pe,Ae,se+1/3)),p(255*T(Pe,Ae,se)),p(255*T(Pe,Ae,se-1/3)),re];default:return null}}return null}}catch{}});class Ci{constructor(e,d,p,_=1){this.r=e,this.g=d,this.b=p,this.a=_}static parse(e){if(!e)return;if(e instanceof Ci)return e;if(typeof e!="string")return;const d=ga.parseCSSColor(e);return d?new Ci(d[0]/255*d[3],d[1]/255*d[3],d[2]/255*d[3],d[3]):void 0}toString(){const[e,d,p,_]=this.toArray();return`rgba(${Math.round(e)},${Math.round(d)},${Math.round(p)},${_})`}toArray(){const{r:e,g:d,b:p,a:_}=this;return _===0?[0,0,0,0]:[255*e/_,255*d/_,255*p/_,_]}}Ci.black=new Ci(0,0,0,1),Ci.white=new Ci(1,1,1,1),Ci.transparent=new Ci(0,0,0,0),Ci.red=new Ci(1,0,0,1),Ci.blue=new Ci(0,0,1,1);class uo{constructor(e,d,p){this.sensitivity=e?d?"variant":"case":d?"accent":"base",this.locale=p,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,d){return this.collator.compare(e,d)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class _a{constructor(e,d,p,_,x){this.text=e.normalize?e.normalize():e,this.image=d,this.scale=p,this.fontStack=_,this.textColor=x}}class sr{constructor(e){this.sections=e}static fromString(e){return new sr([new _a(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof sr?e:sr.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const d of this.sections){if(d.image){e.push(["image",d.image.name]);continue}e.push(d.text);const p={};d.fontStack&&(p["text-font"]=["literal",d.fontStack.split(",")]),d.scale&&(p["font-scale"]=d.scale),d.textColor&&(p["text-color"]=["rgba"].concat(d.textColor.toArray())),e.push(p)}return e}}class zr{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new zr({name:e,available:!1}):null}serialize(){return["image",this.name]}}function sn(u,e,d,p){return typeof u=="number"&&u>=0&&u<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof d=="number"&&d>=0&&d<=255?p===void 0||typeof p=="number"&&p>=0&&p<=1?null:`Invalid rgba value [${[u,e,d,p].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof p=="number"?[u,e,d,p]:[u,e,d]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function bs(u){if(u===null||typeof u=="string"||typeof u=="boolean"||typeof u=="number"||u instanceof Ci||u instanceof uo||u instanceof sr||u instanceof zr)return!0;if(Array.isArray(u)){for(const e of u)if(!bs(e))return!1;return!0}if(typeof u=="object"){for(const e in u)if(!bs(u[e]))return!1;return!0}return!1}function ir(u){if(u===null)return _n;if(typeof u=="string")return Ti;if(typeof u=="boolean")return yi;if(typeof u=="number")return yt;if(u instanceof Ci)return dn;if(u instanceof uo)return Xn;if(u instanceof sr)return co;if(u instanceof zr)return Tr;if(Array.isArray(u)){const e=u.length;let d;for(const p of u){const _=ir(p);if(d){if(d===_)continue;d=vi;break}d=_}return Xr(d||vi,e)}return Zn}function yn(u){const e=typeof u;return u===null?"":e==="string"||e==="number"||e==="boolean"?String(u):u instanceof Ci||u instanceof sr||u instanceof zr?u.toString():JSON.stringify(u)}class xn{constructor(e,d){this.type=e,this.value=d}static parse(e,d){if(e.length!==2)return d.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!bs(e[1]))return d.error("invalid value");const p=e[1];let _=ir(p);const x=d.expectedType;return _.kind!=="array"||_.N!==0||!x||x.kind!=="array"||typeof x.N=="number"&&x.N!==0||(_=x),new xn(_,p)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ci?["rgba"].concat(this.value.toArray()):this.value instanceof sr?this.value.serialize():this.value}}class gr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const ya={string:Ti,number:yt,boolean:yi,object:Zn};class an{constructor(e,d){this.type=e,this.args=d}static parse(e,d){if(e.length<2)return d.error("Expected at least one argument.");let p,_=1;const x=e[0];if(x==="array"){let A,D;if(e.length>2){const B=e[1];if(typeof B!="string"||!(B in ya)||B==="object")return d.error('The item type argument of "array" must be one of string, number, boolean',1);A=ya[B],_++}else A=vi;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return d.error('The length argument to "array" must be a positive integer literal',2);D=e[2],_++}p=Xr(A,D)}else p=ya[x];const T=[];for(;_<e.length;_++){const A=d.parse(e[_],_,vi);if(!A)return null;T.push(A)}return new an(p,T)}evaluate(e){for(let d=0;d<this.args.length;d++){const p=this.args[d].evaluate(e);if(!Oo(this.type,ir(p)))return p;if(d===this.args.length-1)throw new gr(`Expected value to be of type ${Zi(this.type)}, but found ${Zi(ir(p))} instead.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,d=[e.kind];if(e.kind==="array"){const p=e.itemType;if(p.kind==="string"||p.kind==="number"||p.kind==="boolean"){d.push(p.kind);const _=e.N;(typeof _=="number"||this.args.length>1)&&d.push(_)}}return d.concat(this.args.map(p=>p.serialize()))}}class fo{constructor(e){this.type=co,this.sections=e}static parse(e,d){if(e.length<2)return d.error("Expected at least one argument.");const p=e[1];if(!Array.isArray(p)&&typeof p=="object")return d.error("First argument must be an image or text section.");const _=[];let x=!1;for(let T=1;T<=e.length-1;++T){const A=e[T];if(x&&typeof A=="object"&&!Array.isArray(A)){x=!1;let D=null;if(A["font-scale"]&&(D=d.parse(A["font-scale"],1,yt),!D))return null;let B=null;if(A["text-font"]&&(B=d.parse(A["text-font"],1,Xr(Ti)),!B))return null;let O=null;if(A["text-color"]&&(O=d.parse(A["text-color"],1,dn),!O))return null;const $=_[_.length-1];$.scale=D,$.font=B,$.textColor=O}else{const D=d.parse(e[T],1,vi);if(!D)return null;const B=D.type.kind;if(B!=="string"&&B!=="value"&&B!=="null"&&B!=="resolvedImage")return d.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");x=!0,_.push({content:D,scale:null,font:null,textColor:null})}}return new fo(_)}evaluate(e){return new sr(this.sections.map(d=>{const p=d.content.evaluate(e);return ir(p)===Tr?new _a("",p,null,null,null):new _a(yn(p),null,d.scale?d.scale.evaluate(e):null,d.font?d.font.evaluate(e).join(","):null,d.textColor?d.textColor.evaluate(e):null)}))}eachChild(e){for(const d of this.sections)e(d.content),d.scale&&e(d.scale),d.font&&e(d.font),d.textColor&&e(d.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const d of this.sections){e.push(d.content.serialize());const p={};d.scale&&(p["font-scale"]=d.scale.serialize()),d.font&&(p["text-font"]=d.font.serialize()),d.textColor&&(p["text-color"]=d.textColor.serialize()),e.push(p)}return e}}class po{constructor(e){this.type=Tr,this.input=e}static parse(e,d){if(e.length!==2)return d.error("Expected two arguments.");const p=d.parse(e[1],1,Ti);return p?new po(p):d.error("No image name provided.")}evaluate(e){const d=this.input.evaluate(e),p=zr.fromString(d);return p&&e.availableImages&&(p.available=e.availableImages.indexOf(d)>-1),p}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const nh={"to-boolean":yi,"to-color":dn,"to-number":yt,"to-string":Ti};class ln{constructor(e,d){this.type=e,this.args=d}static parse(e,d){if(e.length<2)return d.error("Expected at least one argument.");const p=e[0];if((p==="to-boolean"||p==="to-string")&&e.length!==2)return d.error("Expected one argument.");const _=nh[p],x=[];for(let T=1;T<e.length;T++){const A=d.parse(e[T],T,vi);if(!A)return null;x.push(A)}return new ln(_,x)}evaluate(e){if(this.type.kind==="boolean")return Boolean(this.args[0].evaluate(e));if(this.type.kind==="color"){let d,p;for(const _ of this.args){if(d=_.evaluate(e),p=null,d instanceof Ci)return d;if(typeof d=="string"){const x=e.parseColor(d);if(x)return x}else if(Array.isArray(d)&&(p=d.length<3||d.length>4?`Invalid rbga value ${JSON.stringify(d)}: expected an array containing either three or four numeric values.`:sn(d[0],d[1],d[2],d[3]),!p))return new Ci(d[0]/255,d[1]/255,d[2]/255,d[3])}throw new gr(p||`Could not parse color from value '${typeof d=="string"?d:String(JSON.stringify(d))}'`)}if(this.type.kind==="number"){let d=null;for(const p of this.args){if(d=p.evaluate(e),d===null)return 0;const _=Number(d);if(!isNaN(_))return _}throw new gr(`Could not convert ${JSON.stringify(d)} to number.`)}return this.type.kind==="formatted"?sr.fromString(yn(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?zr.fromString(yn(this.args[0].evaluate(e))):yn(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new fo([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new po(this.args[0]).serialize();const e=[`to-${this.type.kind}`];return this.eachChild(d=>{e.push(d.serialize())}),e}}const oh=["Unknown","Point","LineString","Polygon"];class Bl{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&"id"in this.feature&&this.feature.id?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?oh[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,d=this.featureDistanceData.scale,{x:p,y:_}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(p*d-e[0])+this.featureDistanceData.bearing[1]*(_*d-e[1])}return 0}parseColor(e){let d=this._parseColorCache[e];return d||(d=this._parseColorCache[e]=Ci.parse(e)),d}}class Fr{constructor(e,d,p,_){this.name=e,this.type=d,this._evaluate=p,this.args=_}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,d){const p=e[0],_=Fr.definitions[p];if(!_)return d.error(`Unknown expression "${p}". If you wanted a literal array, use ["literal", [...]].`,0);const x=Array.isArray(_)?_[0]:_.type,T=Array.isArray(_)?[[_[1],_[2]]]:_.overloads,A=T.filter(([B])=>!Array.isArray(B)||B.length===e.length-1);let D=null;for(const[B,O]of A){D=new kn(d.registry,d.path,null,d.scope);const $=[];let V=!1;for(let W=1;W<e.length;W++){const re=e[W],se=Array.isArray(B)?B[W-1]:B.type,fe=D.parse(re,1+$.length,se);if(!fe){V=!0;break}$.push(fe)}if(!V)if(Array.isArray(B)&&B.length!==$.length)D.error(`Expected ${B.length} arguments, but found ${$.length} instead.`);else{for(let W=0;W<$.length;W++){const re=Array.isArray(B)?B[W]:B.type,se=$[W];D.concat(W+1).checkSubtype(re,se.type)}if(D.errors.length===0)return new Fr(p,x,O,$)}}if(A.length===1)d.errors.push(...D.errors);else{const B=(A.length?A:T).map(([$])=>{return V=$,Array.isArray(V)?`(${V.map(Zi).join(", ")})`:`(${Zi(V.type)}...)`;var V}).join(" | "),O=[];for(let $=1;$<e.length;$++){const V=d.parse(e[$],1+O.length);if(!V)return null;O.push(Zi(V.type))}d.error(`Expected arguments of type ${B}, but found (${O.join(", ")}) instead.`)}return null}static register(e,d){Fr.definitions=d;for(const p in d)e[p]=Fr}}class ws{constructor(e,d,p){this.type=Xn,this.locale=p,this.caseSensitive=e,this.diacriticSensitive=d}static parse(e,d){if(e.length!==2)return d.error("Expected one argument.");const p=e[1];if(typeof p!="object"||Array.isArray(p))return d.error("Collator options argument must be an object.");const _=d.parse(p["case-sensitive"]!==void 0&&p["case-sensitive"],1,yi);if(!_)return null;const x=d.parse(p["diacritic-sensitive"]!==void 0&&p["diacritic-sensitive"],1,yi);if(!x)return null;let T=null;return p.locale&&(T=d.parse(p.locale,1,Ti),!T)?null:new ws(_,x,T)}evaluate(e){return new uo(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}const In=8192;function xa(u,e){u[0]=Math.min(u[0],e[0]),u[1]=Math.min(u[1],e[1]),u[2]=Math.max(u[2],e[0]),u[3]=Math.max(u[3],e[1])}function Es(u,e){return!(u[0]<=e[0]||u[2]>=e[2]||u[1]<=e[1]||u[3]>=e[3])}function Rl(u,e){const d=(180+u[0])/360,p=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+u[1]*Math.PI/360)))/360,_=Math.pow(2,e.z);return[Math.round(d*_*In),Math.round(p*_*In)]}function Ts(u,e,d){const p=u[0]-e[0],_=u[1]-e[1],x=u[0]-d[0],T=u[1]-d[1];return p*T-x*_==0&&p*x<=0&&_*T<=0}function va(u,e){let d=!1;for(let T=0,A=e.length;T<A;T++){const D=e[T];for(let B=0,O=D.length;B<O-1;B++){if(Ts(u,D[B],D[B+1]))return!1;(_=D[B])[1]>(p=u)[1]!=(x=D[B+1])[1]>p[1]&&p[0]<(x[0]-_[0])*(p[1]-_[1])/(x[1]-_[1])+_[0]&&(d=!d)}}var p,_,x;return d}function sh(u,e){for(let d=0;d<e.length;d++)if(va(u,e[d]))return!0;return!1}function Ll(u,e,d,p){const _=p[0]-d[0],x=p[1]-d[1],T=(u[0]-d[0])*x-_*(u[1]-d[1]),A=(e[0]-d[0])*x-_*(e[1]-d[1]);return T>0&&A<0||T<0&&A>0}function ah(u,e,d){for(const B of d)for(let O=0;O<B.length-1;++O)if((A=[(T=B[O+1])[0]-(x=B[O])[0],T[1]-x[1]])[0]*(D=[(_=e)[0]-(p=u)[0],_[1]-p[1]])[1]-A[1]*D[0]!=0&&Ll(p,_,x,T)&&Ll(x,T,p,_))return!0;var p,_,x,T,A,D;return!1}function zl(u,e){for(let d=0;d<u.length;++d)if(!va(u[d],e))return!1;for(let d=0;d<u.length-1;++d)if(ah(u[d],u[d+1],e))return!1;return!0}function lh(u,e){for(let d=0;d<e.length;d++)if(zl(u,e[d]))return!0;return!1}function Ms(u,e,d){const p=[];for(let _=0;_<u.length;_++){const x=[];for(let T=0;T<u[_].length;T++){const A=Rl(u[_][T],d);xa(e,A),x.push(A)}p.push(x)}return p}function No(u,e,d){const p=[];for(let _=0;_<u.length;_++){const x=Ms(u[_],e,d);p.push(x)}return p}function Fl(u,e,d,p){if(u[0]<d[0]||u[0]>d[2]){const _=.5*p;let x=u[0]-d[0]>_?-p:d[0]-u[0]>_?p:0;x===0&&(x=u[0]-d[2]>_?-p:d[2]-u[0]>_?p:0),u[0]+=x}xa(e,u)}function Ol(u,e,d,p){const _=Math.pow(2,p.z)*In,x=[p.x*In,p.y*In],T=[];if(!u)return T;for(const A of u)for(const D of A){const B=[D.x+x[0],D.y+x[1]];Fl(B,e,d,_),T.push(B)}return T}function Nl(u,e,d,p){const _=Math.pow(2,p.z)*In,x=[p.x*In,p.y*In],T=[];if(!u)return T;for(const D of u){const B=[];for(const O of D){const $=[O.x+x[0],O.y+x[1]];xa(e,$),B.push($)}T.push(B)}if(e[2]-e[0]<=_/2){(A=e)[0]=A[1]=1/0,A[2]=A[3]=-1/0;for(const D of T)for(const B of D)Fl(B,e,d,_)}var A;return T}class Yn{constructor(e,d){this.type=yi,this.geojson=e,this.geometries=d}static parse(e,d){if(e.length!==2)return d.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(bs(e[1])){const p=e[1];if(p.type==="FeatureCollection")for(let _=0;_<p.features.length;++_){const x=p.features[_].geometry.type;if(x==="Polygon"||x==="MultiPolygon")return new Yn(p,p.features[_].geometry)}else if(p.type==="Feature"){const _=p.geometry.type;if(_==="Polygon"||_==="MultiPolygon")return new Yn(p,p.geometry)}else if(p.type==="Polygon"||p.type==="MultiPolygon")return new Yn(p,p)}return d.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(d,p){const _=[1/0,1/0,-1/0,-1/0],x=[1/0,1/0,-1/0,-1/0],T=d.canonicalID();if(!T)return!1;if(p.type==="Polygon"){const A=Ms(p.coordinates,x,T),D=Ol(d.geometry(),_,x,T);if(!Es(_,x))return!1;for(const B of D)if(!va(B,A))return!1}if(p.type==="MultiPolygon"){const A=No(p.coordinates,x,T),D=Ol(d.geometry(),_,x,T);if(!Es(_,x))return!1;for(const B of D)if(!sh(B,A))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(d,p){const _=[1/0,1/0,-1/0,-1/0],x=[1/0,1/0,-1/0,-1/0],T=d.canonicalID();if(!T)return!1;if(p.type==="Polygon"){const A=Ms(p.coordinates,x,T),D=Nl(d.geometry(),_,x,T);if(!Es(_,x))return!1;for(const B of D)if(!zl(B,A))return!1}if(p.type==="MultiPolygon"){const A=No(p.coordinates,x,T),D=Nl(d.geometry(),_,x,T);if(!Es(_,x))return!1;for(const B of D)if(!lh(B,A))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}function Ar(u){if(u instanceof Fr&&(u.name==="get"&&u.args.length===1||u.name==="feature-state"||u.name==="has"&&u.args.length===1||u.name==="properties"||u.name==="geometry-type"||u.name==="id"||/^filter-/.test(u.name))||u instanceof Yn)return!1;let e=!0;return u.eachChild(d=>{e&&!Ar(d)&&(e=!1)}),e}function $o(u){if(u instanceof Fr&&u.name==="feature-state")return!1;let e=!0;return u.eachChild(d=>{e&&!$o(d)&&(e=!1)}),e}function Uo(u,e){if(u instanceof Fr&&e.indexOf(u.name)>=0)return!1;let d=!0;return u.eachChild(p=>{d&&!Uo(p,e)&&(d=!1)}),d}class Wn{constructor(e,d){this.type=d.type,this.name=e,this.boundExpression=d}static parse(e,d){if(e.length!==2||typeof e[1]!="string")return d.error("'var' expression requires exactly one string literal argument.");const p=e[1];return d.scope.has(p)?new Wn(p,d.scope.get(p)):d.error(`Unknown variable "${p}". Make sure "${p}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class kn{constructor(e,d=[],p,_=new Zr,x=[]){this.registry=e,this.path=d,this.key=d.map(T=>`[${T}]`).join(""),this.scope=_,this.errors=x,this.expectedType=p}parse(e,d,p,_,x={}){return d?this.concat(d,p,_)._parse(e,x):this._parse(e,x)}_parse(e,d){function p(_,x,T){return T==="assert"?new an(x,[_]):T==="coerce"?new ln(x,[_]):_}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const _=e[0];if(typeof _!="string")return this.error(`Expression name must be a string, but found ${typeof _} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const x=this.registry[_];if(x){let T=x.parse(e,this);if(!T)return null;if(this.expectedType){const A=this.expectedType,D=T.type;if(A.kind!=="string"&&A.kind!=="number"&&A.kind!=="boolean"&&A.kind!=="object"&&A.kind!=="array"||D.kind!=="value")if(A.kind!=="color"&&A.kind!=="formatted"&&A.kind!=="resolvedImage"||D.kind!=="value"&&D.kind!=="string"){if(this.checkSubtype(A,D))return null}else T=p(T,A,d.typeAnnotation||"coerce");else T=p(T,A,d.typeAnnotation||"assert")}if(!(T instanceof xn)&&T.type.kind!=="resolvedImage"&&Ss(T)){const A=new Bl;try{T=new xn(T.type,T.evaluate(A))}catch(D){return this.error(D.message),null}}return T}return this.error(`Unknown expression "${_}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,d,p){const _=typeof e=="number"?this.path.concat(e):this.path,x=p?this.scope.concat(p):this.scope;return new kn(this.registry,_,d||null,x,this.errors)}error(e,...d){const p=`${this.key}${d.map(_=>`[${_}]`).join("")}`;this.errors.push(new Ii(p,e))}checkSubtype(e,d){const p=Oo(e,d);return p&&this.error(p),p}}function Ss(u){if(u instanceof Wn)return Ss(u.boundExpression);if(u instanceof Fr&&u.name==="error"||u instanceof ws||u instanceof Yn)return!1;const e=u instanceof ln||u instanceof an;let d=!0;return u.eachChild(p=>{d=e?d&&Ss(p):d&&p instanceof xn}),!!d&&Ar(u)&&Uo(u,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function Vo(u,e){const d=u.length-1;let p,_,x=0,T=d,A=0;for(;x<=T;)if(A=Math.floor((x+T)/2),p=u[A],_=u[A+1],p<=e){if(A===d||e<_)return A;x=A+1}else{if(!(p>e))throw new gr("Input is not a number.");T=A-1}return 0}class jo{constructor(e,d,p){this.type=e,this.input=d,this.labels=[],this.outputs=[];for(const[_,x]of p)this.labels.push(_),this.outputs.push(x)}static parse(e,d){if(e.length-1<4)return d.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return d.error("Expected an even number of arguments.");const p=d.parse(e[1],1,yt);if(!p)return null;const _=[];let x=null;d.expectedType&&d.expectedType.kind!=="value"&&(x=d.expectedType);for(let T=1;T<e.length;T+=2){const A=T===1?-1/0:e[T],D=e[T+1],B=T,O=T+1;if(typeof A!="number")return d.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',B);if(_.length&&_[_.length-1][0]>=A)return d.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',B);const $=d.parse(D,O,x);if(!$)return null;x=x||$.type,_.push([A,$])}return new jo(x,p,_)}evaluate(e){const d=this.labels,p=this.outputs;if(d.length===1)return p[0].evaluate(e);const _=this.input.evaluate(e);if(_<=d[0])return p[0].evaluate(e);const x=d.length;return _>=d[x-1]?p[x-1].evaluate(e):p[Vo(d,_)].evaluate(e)}eachChild(e){e(this.input);for(const d of this.outputs)e(d)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let d=0;d<this.labels.length;d++)d>0&&e.push(this.labels[d]),e.push(this.outputs[d].serialize());return e}}function Zt(u,e,d){return u*(1-d)+e*d}var As=Object.freeze({__proto__:null,number:Zt,color:function(u,e,d){return new Ci(Zt(u.r,e.r,d),Zt(u.g,e.g,d),Zt(u.b,e.b,d),Zt(u.a,e.a,d))},array:function(u,e,d){return u.map((p,_)=>Zt(p,e[_],d))}});const $l=.95047,Ul=1.08883,ba=4/29,wa=6/29,Ea=3*wa*wa,Vl=Math.PI/180,jl=180/Math.PI;function Is(u){return u>.008856451679035631?Math.pow(u,1/3):u/Ea+ba}function Cn(u){return u>wa?u*u*u:Ea*(u-ba)}function mo(u){return 255*(u<=.0031308?12.92*u:1.055*Math.pow(u,1/2.4)-.055)}function Ta(u){return(u/=255)<=.04045?u/12.92:Math.pow((u+.055)/1.055,2.4)}function ks(u){const e=Ta(u.r),d=Ta(u.g),p=Ta(u.b),_=Is((.4124564*e+.3575761*d+.1804375*p)/$l),x=Is((.2126729*e+.7151522*d+.072175*p)/1);return{l:116*x-16,a:500*(_-x),b:200*(x-Is((.0193339*e+.119192*d+.9503041*p)/Ul)),alpha:u.a}}function Ma(u){let e=(u.l+16)/116,d=isNaN(u.a)?e:e+u.a/500,p=isNaN(u.b)?e:e-u.b/200;return e=1*Cn(e),d=$l*Cn(d),p=Ul*Cn(p),new Ci(mo(3.2404542*d-1.5371385*e-.4985314*p),mo(-.969266*d+1.8760108*e+.041556*p),mo(.0556434*d-.2040259*e+1.0572252*p),u.alpha)}function ch(u,e,d){const p=e-u;return u+d*(p>180||p<-180?p-360*Math.round(p/360):p)}const Go={forward:ks,reverse:Ma,interpolate:function(u,e,d){return{l:Zt(u.l,e.l,d),a:Zt(u.a,e.a,d),b:Zt(u.b,e.b,d),alpha:Zt(u.alpha,e.alpha,d)}}},qo={forward:function(u){const{l:e,a:d,b:p}=ks(u),_=Math.atan2(p,d)*jl;return{h:_<0?_+360:_,c:Math.sqrt(d*d+p*p),l:e,alpha:u.a}},reverse:function(u){const e=u.h*Vl,d=u.c;return Ma({l:u.l,a:Math.cos(e)*d,b:Math.sin(e)*d,alpha:u.alpha})},interpolate:function(u,e,d){return{h:ch(u.h,e.h,d),c:Zt(u.c,e.c,d),l:Zt(u.l,e.l,d),alpha:Zt(u.alpha,e.alpha,d)}}};var Sa=Object.freeze({__proto__:null,lab:Go,hcl:qo});class Or{constructor(e,d,p,_,x){this.type=e,this.operator=d,this.interpolation=p,this.input=_,this.labels=[],this.outputs=[];for(const[T,A]of x)this.labels.push(T),this.outputs.push(A)}static interpolationFactor(e,d,p,_){let x=0;if(e.name==="exponential")x=Cs(d,e.base,p,_);else if(e.name==="linear")x=Cs(d,1,p,_);else if(e.name==="cubic-bezier"){const T=e.controlPoints;x=new M(T[0],T[1],T[2],T[3]).solve(Cs(d,1,p,_))}return x}static parse(e,d){let[p,_,x,...T]=e;if(!Array.isArray(_)||_.length===0)return d.error("Expected an interpolation type expression.",1);if(_[0]==="linear")_={name:"linear"};else if(_[0]==="exponential"){const B=_[1];if(typeof B!="number")return d.error("Exponential interpolation requires a numeric base.",1,1);_={name:"exponential",base:B}}else{if(_[0]!=="cubic-bezier")return d.error(`Unknown interpolation type ${String(_[0])}`,1,0);{const B=_.slice(1);if(B.length!==4||B.some(O=>typeof O!="number"||O<0||O>1))return d.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);_={name:"cubic-bezier",controlPoints:B}}}if(e.length-1<4)return d.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return d.error("Expected an even number of arguments.");if(x=d.parse(x,2,yt),!x)return null;const A=[];let D=null;p==="interpolate-hcl"||p==="interpolate-lab"?D=dn:d.expectedType&&d.expectedType.kind!=="value"&&(D=d.expectedType);for(let B=0;B<T.length;B+=2){const O=T[B],$=T[B+1],V=B+3,W=B+4;if(typeof O!="number")return d.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',V);if(A.length&&A[A.length-1][0]>=O)return d.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',V);const re=d.parse($,W,D);if(!re)return null;D=D||re.type,A.push([O,re])}return D.kind==="number"||D.kind==="color"||D.kind==="array"&&D.itemType.kind==="number"&&typeof D.N=="number"?new Or(D,p,_,x,A):d.error(`Type ${Zi(D)} is not interpolatable.`)}evaluate(e){const d=this.labels,p=this.outputs;if(d.length===1)return p[0].evaluate(e);const _=this.input.evaluate(e);if(_<=d[0])return p[0].evaluate(e);const x=d.length;if(_>=d[x-1])return p[x-1].evaluate(e);const T=Vo(d,_),A=Or.interpolationFactor(this.interpolation,_,d[T],d[T+1]),D=p[T].evaluate(e),B=p[T+1].evaluate(e);return this.operator==="interpolate"?As[this.type.kind.toLowerCase()](D,B,A):this.operator==="interpolate-hcl"?qo.reverse(qo.interpolate(qo.forward(D),qo.forward(B),A)):Go.reverse(Go.interpolate(Go.forward(D),Go.forward(B),A))}eachChild(e){e(this.input);for(const d of this.outputs)e(d)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const d=[this.operator,e,this.input.serialize()];for(let p=0;p<this.labels.length;p++)d.push(this.labels[p],this.outputs[p].serialize());return d}}function Cs(u,e,d,p){const _=p-d,x=u-d;return _===0?0:e===1?x/_:(Math.pow(e,x)-1)/(Math.pow(e,_)-1)}class Zo{constructor(e,d){this.type=e,this.args=d}static parse(e,d){if(e.length<2)return d.error("Expectected at least one argument.");let p=null;const _=d.expectedType;_&&_.kind!=="value"&&(p=_);const x=[];for(const A of e.slice(1)){const D=d.parse(A,1+x.length,p,void 0,{typeAnnotation:"omit"});if(!D)return null;p=p||D.type,x.push(D)}const T=_&&x.some(A=>Oo(_,A.type));return new Zo(T?vi:p,x)}evaluate(e){let d,p=null,_=0;for(const x of this.args){if(_++,p=x.evaluate(e),p&&p instanceof zr&&!p.available&&(d||(d=p),p=null,_===this.args.length))return d;if(p!==null)break}return p}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(d=>{e.push(d.serialize())}),e}}class Xo{constructor(e,d){this.type=d.type,this.bindings=[].concat(e),this.result=d}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const d of this.bindings)e(d[1]);e(this.result)}static parse(e,d){if(e.length<4)return d.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const p=[];for(let x=1;x<e.length-1;x+=2){const T=e[x];if(typeof T!="string")return d.error(`Expected string, but found ${typeof T} instead.`,x);if(/[^a-zA-Z0-9_]/.test(T))return d.error("Variable names must contain only alphanumeric characters or '_'.",x);const A=d.parse(e[x+1],x+1);if(!A)return null;p.push([T,A])}const _=d.parse(e[e.length-1],e.length-1,d.expectedType,p);return _?new Xo(p,_):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[d,p]of this.bindings)e.push(d,p.serialize());return e.push(this.result.serialize()),e}}class Aa{constructor(e,d,p){this.type=e,this.index=d,this.input=p}static parse(e,d){if(e.length!==3)return d.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const p=d.parse(e[1],1,yt),_=d.parse(e[2],2,Xr(d.expectedType||vi));return p&&_?new Aa(_.type.itemType,p,_):null}evaluate(e){const d=this.index.evaluate(e),p=this.input.evaluate(e);if(d<0)throw new gr(`Array index out of bounds: ${d} < 0.`);if(d>=p.length)throw new gr(`Array index out of bounds: ${d} > ${p.length-1}.`);if(d!==Math.floor(d))throw new gr(`Array index must be an integer, but found ${d} instead.`);return p[d]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Ds{constructor(e,d){this.type=yi,this.needle=e,this.haystack=d}static parse(e,d){if(e.length!==3)return d.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const p=d.parse(e[1],1,vi),_=d.parse(e[2],2,vi);return p&&_?xs(p.type,[yi,Ti,yt,_n,vi])?new Ds(p,_):d.error(`Expected first argument to be of type boolean, string, number or null, but found ${Zi(p.type)} instead`):null}evaluate(e){const d=this.needle.evaluate(e),p=this.haystack.evaluate(e);if(p==null)return!1;if(!ho(d,["boolean","string","number","null"]))throw new gr(`Expected first argument to be of type boolean, string, number or null, but found ${Zi(ir(d))} instead.`);if(!ho(p,["string","array"]))throw new gr(`Expected second argument to be of type array or string, but found ${Zi(ir(p))} instead.`);return p.indexOf(d)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Ps{constructor(e,d,p){this.type=yt,this.needle=e,this.haystack=d,this.fromIndex=p}static parse(e,d){if(e.length<=2||e.length>=5)return d.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const p=d.parse(e[1],1,vi),_=d.parse(e[2],2,vi);if(!p||!_)return null;if(!xs(p.type,[yi,Ti,yt,_n,vi]))return d.error(`Expected first argument to be of type boolean, string, number or null, but found ${Zi(p.type)} instead`);if(e.length===4){const x=d.parse(e[3],3,yt);return x?new Ps(p,_,x):null}return new Ps(p,_)}evaluate(e){const d=this.needle.evaluate(e),p=this.haystack.evaluate(e);if(!ho(d,["boolean","string","number","null"]))throw new gr(`Expected first argument to be of type boolean, string, number or null, but found ${Zi(ir(d))} instead.`);if(!ho(p,["string","array"]))throw new gr(`Expected second argument to be of type array or string, but found ${Zi(ir(p))} instead.`);if(this.fromIndex){const _=this.fromIndex.evaluate(e);return p.indexOf(d,_)}return p.indexOf(d)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Bs{constructor(e,d,p,_,x,T){this.inputType=e,this.type=d,this.input=p,this.cases=_,this.outputs=x,this.otherwise=T}static parse(e,d){if(e.length<5)return d.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return d.error("Expected an even number of arguments.");let p,_;d.expectedType&&d.expectedType.kind!=="value"&&(_=d.expectedType);const x={},T=[];for(let B=2;B<e.length-1;B+=2){let O=e[B];const $=e[B+1];Array.isArray(O)||(O=[O]);const V=d.concat(B);if(O.length===0)return V.error("Expected at least one branch label.");for(const re of O){if(typeof re!="number"&&typeof re!="string")return V.error("Branch labels must be numbers or strings.");if(typeof re=="number"&&Math.abs(re)>Number.MAX_SAFE_INTEGER)return V.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof re=="number"&&Math.floor(re)!==re)return V.error("Numeric branch labels must be integer values.");if(p){if(V.checkSubtype(p,ir(re)))return null}else p=ir(re);if(x[String(re)]!==void 0)return V.error("Branch labels must be unique.");x[String(re)]=T.length}const W=d.parse($,B,_);if(!W)return null;_=_||W.type,T.push(W)}const A=d.parse(e[1],1,vi);if(!A)return null;const D=d.parse(e[e.length-1],e.length-1,_);return D?A.type.kind!=="value"&&d.concat(1).checkSubtype(p,A.type)?null:new Bs(p,_,A,x,T,D):null}evaluate(e){const d=this.input.evaluate(e);return(ir(d)===this.inputType&&this.outputs[this.cases[d]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],d=Object.keys(this.cases).sort(),p=[],_={};for(const T of d){const A=_[this.cases[T]];A===void 0?(_[this.cases[T]]=p.length,p.push([this.cases[T],[T]])):p[A][1].push(T)}const x=T=>this.inputType.kind==="number"?Number(T):T;for(const[T,A]of p)e.push(A.length===1?x(A[0]):A.map(x)),e.push(this.outputs[T].serialize());return e.push(this.otherwise.serialize()),e}}class Rs{constructor(e,d,p){this.type=e,this.branches=d,this.otherwise=p}static parse(e,d){if(e.length<4)return d.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return d.error("Expected an odd number of arguments.");let p;d.expectedType&&d.expectedType.kind!=="value"&&(p=d.expectedType);const _=[];for(let T=1;T<e.length-1;T+=2){const A=d.parse(e[T],T,yi);if(!A)return null;const D=d.parse(e[T+1],T+1,p);if(!D)return null;_.push([A,D]),p=p||D.type}const x=d.parse(e[e.length-1],e.length-1,p);return x?new Rs(p,_,x):null}evaluate(e){for(const[d,p]of this.branches)if(d.evaluate(e))return p.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[d,p]of this.branches)e(d),e(p);e(this.otherwise)}outputDefined(){return this.branches.every(([e,d])=>d.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(d=>{e.push(d.serialize())}),e}}class Ls{constructor(e,d,p,_){this.type=e,this.input=d,this.beginIndex=p,this.endIndex=_}static parse(e,d){if(e.length<=2||e.length>=5)return d.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const p=d.parse(e[1],1,vi),_=d.parse(e[2],2,yt);if(!p||!_)return null;if(!xs(p.type,[Xr(vi),Ti,vi]))return d.error(`Expected first argument to be of type array or string, but found ${Zi(p.type)} instead`);if(e.length===4){const x=d.parse(e[3],3,yt);return x?new Ls(p.type,p,_,x):null}return new Ls(p.type,p,_)}evaluate(e){const d=this.input.evaluate(e),p=this.beginIndex.evaluate(e);if(!ho(d,["string","array"]))throw new gr(`Expected first argument to be of type array or string, but found ${Zi(ir(d))} instead.`);if(this.endIndex){const _=this.endIndex.evaluate(e);return d.slice(p,_)}return d.slice(p)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Gl(u,e){return u==="=="||u==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function ql(u,e,d,p){return p.compare(e,d)===0}function go(u,e,d){const p=u!=="=="&&u!=="!=";return class Lf{constructor(x,T,A){this.type=yi,this.lhs=x,this.rhs=T,this.collator=A,this.hasUntypedArgument=x.type.kind==="value"||T.type.kind==="value"}static parse(x,T){if(x.length!==3&&x.length!==4)return T.error("Expected two or three arguments.");const A=x[0];let D=T.parse(x[1],1,vi);if(!D)return null;if(!Gl(A,D.type))return T.concat(1).error(`"${A}" comparisons are not supported for type '${Zi(D.type)}'.`);let B=T.parse(x[2],2,vi);if(!B)return null;if(!Gl(A,B.type))return T.concat(2).error(`"${A}" comparisons are not supported for type '${Zi(B.type)}'.`);if(D.type.kind!==B.type.kind&&D.type.kind!=="value"&&B.type.kind!=="value")return T.error(`Cannot compare types '${Zi(D.type)}' and '${Zi(B.type)}'.`);p&&(D.type.kind==="value"&&B.type.kind!=="value"?D=new an(B.type,[D]):D.type.kind!=="value"&&B.type.kind==="value"&&(B=new an(D.type,[B])));let O=null;if(x.length===4){if(D.type.kind!=="string"&&B.type.kind!=="string"&&D.type.kind!=="value"&&B.type.kind!=="value")return T.error("Cannot use collator to compare non-string types.");if(O=T.parse(x[3],3,Xn),!O)return null}return new Lf(D,B,O)}evaluate(x){const T=this.lhs.evaluate(x),A=this.rhs.evaluate(x);if(p&&this.hasUntypedArgument){const D=ir(T),B=ir(A);if(D.kind!==B.kind||D.kind!=="string"&&D.kind!=="number")throw new gr(`Expected arguments for "${u}" to be (string, string) or (number, number), but found (${D.kind}, ${B.kind}) instead.`)}if(this.collator&&!p&&this.hasUntypedArgument){const D=ir(T),B=ir(A);if(D.kind!=="string"||B.kind!=="string")return e(x,T,A)}return this.collator?d(x,T,A,this.collator.evaluate(x)):e(x,T,A)}eachChild(x){x(this.lhs),x(this.rhs),this.collator&&x(this.collator)}outputDefined(){return!0}serialize(){const x=[u];return this.eachChild(T=>{x.push(T.serialize())}),x}}}const hh=go("==",function(u,e,d){return e===d},ql),uh=go("!=",function(u,e,d){return e!==d},function(u,e,d,p){return!ql(0,e,d,p)}),Zl=go("<",function(u,e,d){return e<d},function(u,e,d,p){return p.compare(e,d)<0}),dh=go(">",function(u,e,d){return e>d},function(u,e,d,p){return p.compare(e,d)>0}),fh=go("<=",function(u,e,d){return e<=d},function(u,e,d,p){return p.compare(e,d)<=0}),ph=go(">=",function(u,e,d){return e>=d},function(u,e,d,p){return p.compare(e,d)>=0});class Ia{constructor(e,d,p,_,x){this.type=Ti,this.number=e,this.locale=d,this.currency=p,this.minFractionDigits=_,this.maxFractionDigits=x}static parse(e,d){if(e.length!==3)return d.error("Expected two arguments.");const p=d.parse(e[1],1,yt);if(!p)return null;const _=e[2];if(typeof _!="object"||Array.isArray(_))return d.error("NumberFormat options argument must be an object.");let x=null;if(_.locale&&(x=d.parse(_.locale,1,Ti),!x))return null;let T=null;if(_.currency&&(T=d.parse(_.currency,1,Ti),!T))return null;let A=null;if(_["min-fraction-digits"]&&(A=d.parse(_["min-fraction-digits"],1,yt),!A))return null;let D=null;return _["max-fraction-digits"]&&(D=d.parse(_["max-fraction-digits"],1,yt),!D)?null:new Ia(p,x,T,A,D)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class zs{constructor(e){this.type=yt,this.input=e}static parse(e,d){if(e.length!==2)return d.error(`Expected 1 argument, but found ${e.length-1} instead.`);const p=d.parse(e[1],1);return p?p.type.kind!=="array"&&p.type.kind!=="string"&&p.type.kind!=="value"?d.error(`Expected argument of type string or array, but found ${Zi(p.type)} instead.`):new zs(p):null}evaluate(e){const d=this.input.evaluate(e);if(typeof d=="string"||Array.isArray(d))return d.length;throw new gr(`Expected value to be of type string or array, but found ${Zi(ir(d))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(d=>{e.push(d.serialize())}),e}}const Hn={"==":hh,"!=":uh,">":dh,"<":Zl,">=":ph,"<=":fh,array:an,at:Aa,boolean:an,case:Rs,coalesce:Zo,collator:ws,format:fo,image:po,in:Ds,"index-of":Ps,interpolate:Or,"interpolate-hcl":Or,"interpolate-lab":Or,length:zs,let:Xo,literal:xn,match:Bs,number:an,"number-format":Ia,object:an,slice:Ls,step:jo,string:an,"to-boolean":ln,"to-color":ln,"to-number":ln,"to-string":ln,var:Wn,within:Yn};function ka(u,[e,d,p,_]){e=e.evaluate(u),d=d.evaluate(u),p=p.evaluate(u);const x=_?_.evaluate(u):1,T=sn(e,d,p,x);if(T)throw new gr(T);return new Ci(e/255*x,d/255*x,p/255*x,x)}function Xl(u,e){return u in e}function Ca(u,e){const d=e[u];return d===void 0?null:d}function Dn(u){return{type:u}}function Da(u){return{result:"success",value:u}}function Kn(u){return{result:"error",value:u}}function _o(u){return u["property-type"]==="data-driven"||u["property-type"]==="cross-faded-data-driven"}function Yl(u){return!!u.expression&&u.expression.parameters.indexOf("zoom")>-1}function Pa(u){return!!u.expression&&u.expression.interpolated}function Ri(u){return u instanceof Number?"number":u instanceof String?"string":u instanceof Boolean?"boolean":Array.isArray(u)?"array":u===null?"null":typeof u}function Jn(u){return typeof u=="object"&&u!==null&&!Array.isArray(u)}function Wl(u){return u}function Ba(u,e){const d=e.type==="color",p=u.stops&&typeof u.stops[0][0]=="object",_=p||!(p||u.property!==void 0),x=u.type||(Pa(e)?"exponential":"interval");if(d&&((u=Ei({},u)).stops&&(u.stops=u.stops.map(B=>[B[0],Ci.parse(B[1])])),u.default=Ci.parse(u.default?u.default:e.default)),u.colorSpace&&u.colorSpace!=="rgb"&&!Sa[u.colorSpace])throw new Error(`Unknown color space: ${u.colorSpace}`);let T,A,D;if(x==="exponential")T=Ra;else if(x==="interval")T=gh;else if(x==="categorical"){T=mh,A=Object.create(null);for(const B of u.stops)A[B[0]]=B[1];D=typeof u.stops[0][0]}else{if(x!=="identity")throw new Error(`Unknown function type "${x}"`);T=Hl}if(p){const B={},O=[];for(let W=0;W<u.stops.length;W++){const re=u.stops[W],se=re[0].zoom;B[se]===void 0&&(B[se]={zoom:se,type:u.type,property:u.property,default:u.default,stops:[]},O.push(se)),B[se].stops.push([re[0].value,re[1]])}const $=[];for(const W of O)$.push([B[W].zoom,Ba(B[W],e)]);const V={name:"linear"};return{kind:"composite",interpolationType:V,interpolationFactor:Or.interpolationFactor.bind(void 0,V),zoomStops:$.map(W=>W[0]),evaluate:({zoom:W},re)=>Ra({stops:$,base:u.base},e,W).evaluate(W,re)}}if(_){const B=x==="exponential"?{name:"exponential",base:u.base!==void 0?u.base:1}:null;return{kind:"camera",interpolationType:B,interpolationFactor:Or.interpolationFactor.bind(void 0,B),zoomStops:u.stops.map(O=>O[0]),evaluate:({zoom:O})=>T(u,e,O,A,D)}}return{kind:"source",evaluate(B,O){const $=O&&O.properties?O.properties[u.property]:void 0;return $===void 0?Yo(u.default,e.default):T(u,e,$,A,D)}}}function Yo(u,e,d){return u!==void 0?u:e!==void 0?e:d!==void 0?d:void 0}function mh(u,e,d,p,_){return Yo(typeof d===_?p[d]:void 0,u.default,e.default)}function gh(u,e,d){if(Ri(d)!=="number")return Yo(u.default,e.default);const p=u.stops.length;if(p===1||d<=u.stops[0][0])return u.stops[0][1];if(d>=u.stops[p-1][0])return u.stops[p-1][1];const _=Vo(u.stops.map(x=>x[0]),d);return u.stops[_][1]}function Ra(u,e,d){const p=u.base!==void 0?u.base:1;if(Ri(d)!=="number")return Yo(u.default,e.default);const _=u.stops.length;if(_===1||d<=u.stops[0][0])return u.stops[0][1];if(d>=u.stops[_-1][0])return u.stops[_-1][1];const x=Vo(u.stops.map(O=>O[0]),d),T=function(O,$,V,W){const re=W-V,se=O-V;return re===0?0:$===1?se/re:(Math.pow($,se)-1)/(Math.pow($,re)-1)}(d,p,u.stops[x][0],u.stops[x+1][0]),A=u.stops[x][1],D=u.stops[x+1][1];let B=As[e.type]||Wl;if(u.colorSpace&&u.colorSpace!=="rgb"){const O=Sa[u.colorSpace];B=($,V)=>O.reverse(O.interpolate(O.forward($),O.forward(V),T))}return typeof A.evaluate=="function"?{evaluate(...O){const $=A.evaluate.apply(void 0,O),V=D.evaluate.apply(void 0,O);if($!==void 0&&V!==void 0)return B($,V,T)}}:B(A,D,T)}function Hl(u,e,d){return e.type==="color"?d=Ci.parse(d):e.type==="formatted"?d=sr.fromString(d.toString()):e.type==="resolvedImage"?d=zr.fromString(d.toString()):Ri(d)===e.type||e.type==="enum"&&e.values[d]||(d=void 0),Yo(d,u.default,e.default)}Fr.register(Hn,{error:[{kind:"error"},[Ti],(u,[e])=>{throw new gr(e.evaluate(u))}],typeof:[Ti,[vi],(u,[e])=>Zi(ir(e.evaluate(u)))],"to-rgba":[Xr(yt,4),[dn],(u,[e])=>e.evaluate(u).toArray()],rgb:[dn,[yt,yt,yt],ka],rgba:[dn,[yt,yt,yt,yt],ka],has:{type:yi,overloads:[[[Ti],(u,[e])=>Xl(e.evaluate(u),u.properties())],[[Ti,Zn],(u,[e,d])=>Xl(e.evaluate(u),d.evaluate(u))]]},get:{type:vi,overloads:[[[Ti],(u,[e])=>Ca(e.evaluate(u),u.properties())],[[Ti,Zn],(u,[e,d])=>Ca(e.evaluate(u),d.evaluate(u))]]},"feature-state":[vi,[Ti],(u,[e])=>Ca(e.evaluate(u),u.featureState||{})],properties:[Zn,[],u=>u.properties()],"geometry-type":[Ti,[],u=>u.geometryType()],id:[vi,[],u=>u.id()],zoom:[yt,[],u=>u.globals.zoom],pitch:[yt,[],u=>u.globals.pitch||0],"distance-from-center":[yt,[],u=>u.distanceFromCenter()],"heatmap-density":[yt,[],u=>u.globals.heatmapDensity||0],"line-progress":[yt,[],u=>u.globals.lineProgress||0],"sky-radial-progress":[yt,[],u=>u.globals.skyRadialProgress||0],accumulated:[vi,[],u=>u.globals.accumulated===void 0?null:u.globals.accumulated],"+":[yt,Dn(yt),(u,e)=>{let d=0;for(const p of e)d+=p.evaluate(u);return d}],"*":[yt,Dn(yt),(u,e)=>{let d=1;for(const p of e)d*=p.evaluate(u);return d}],"-":{type:yt,overloads:[[[yt,yt],(u,[e,d])=>e.evaluate(u)-d.evaluate(u)],[[yt],(u,[e])=>-e.evaluate(u)]]},"/":[yt,[yt,yt],(u,[e,d])=>e.evaluate(u)/d.evaluate(u)],"%":[yt,[yt,yt],(u,[e,d])=>e.evaluate(u)%d.evaluate(u)],ln2:[yt,[],()=>Math.LN2],pi:[yt,[],()=>Math.PI],e:[yt,[],()=>Math.E],"^":[yt,[yt,yt],(u,[e,d])=>Math.pow(e.evaluate(u),d.evaluate(u))],sqrt:[yt,[yt],(u,[e])=>Math.sqrt(e.evaluate(u))],log10:[yt,[yt],(u,[e])=>Math.log(e.evaluate(u))/Math.LN10],ln:[yt,[yt],(u,[e])=>Math.log(e.evaluate(u))],log2:[yt,[yt],(u,[e])=>Math.log(e.evaluate(u))/Math.LN2],sin:[yt,[yt],(u,[e])=>Math.sin(e.evaluate(u))],cos:[yt,[yt],(u,[e])=>Math.cos(e.evaluate(u))],tan:[yt,[yt],(u,[e])=>Math.tan(e.evaluate(u))],asin:[yt,[yt],(u,[e])=>Math.asin(e.evaluate(u))],acos:[yt,[yt],(u,[e])=>Math.acos(e.evaluate(u))],atan:[yt,[yt],(u,[e])=>Math.atan(e.evaluate(u))],min:[yt,Dn(yt),(u,e)=>Math.min(...e.map(d=>d.evaluate(u)))],max:[yt,Dn(yt),(u,e)=>Math.max(...e.map(d=>d.evaluate(u)))],abs:[yt,[yt],(u,[e])=>Math.abs(e.evaluate(u))],round:[yt,[yt],(u,[e])=>{const d=e.evaluate(u);return d<0?-Math.round(-d):Math.round(d)}],floor:[yt,[yt],(u,[e])=>Math.floor(e.evaluate(u))],ceil:[yt,[yt],(u,[e])=>Math.ceil(e.evaluate(u))],"filter-==":[yi,[Ti,vi],(u,[e,d])=>u.properties()[e.value]===d.value],"filter-id-==":[yi,[vi],(u,[e])=>u.id()===e.value],"filter-type-==":[yi,[Ti],(u,[e])=>u.geometryType()===e.value],"filter-<":[yi,[Ti,vi],(u,[e,d])=>{const p=u.properties()[e.value],_=d.value;return typeof p==typeof _&&p<_}],"filter-id-<":[yi,[vi],(u,[e])=>{const d=u.id(),p=e.value;return typeof d==typeof p&&d<p}],"filter->":[yi,[Ti,vi],(u,[e,d])=>{const p=u.properties()[e.value],_=d.value;return typeof p==typeof _&&p>_}],"filter-id->":[yi,[vi],(u,[e])=>{const d=u.id(),p=e.value;return typeof d==typeof p&&d>p}],"filter-<=":[yi,[Ti,vi],(u,[e,d])=>{const p=u.properties()[e.value],_=d.value;return typeof p==typeof _&&p<=_}],"filter-id-<=":[yi,[vi],(u,[e])=>{const d=u.id(),p=e.value;return typeof d==typeof p&&d<=p}],"filter->=":[yi,[Ti,vi],(u,[e,d])=>{const p=u.properties()[e.value],_=d.value;return typeof p==typeof _&&p>=_}],"filter-id->=":[yi,[vi],(u,[e])=>{const d=u.id(),p=e.value;return typeof d==typeof p&&d>=p}],"filter-has":[yi,[vi],(u,[e])=>e.value in u.properties()],"filter-has-id":[yi,[],u=>u.id()!==null&&u.id()!==void 0],"filter-type-in":[yi,[Xr(Ti)],(u,[e])=>e.value.indexOf(u.geometryType())>=0],"filter-id-in":[yi,[Xr(vi)],(u,[e])=>e.value.indexOf(u.id())>=0],"filter-in-small":[yi,[Ti,Xr(vi)],(u,[e,d])=>d.value.indexOf(u.properties()[e.value])>=0],"filter-in-large":[yi,[Ti,Xr(vi)],(u,[e,d])=>function(p,_,x,T){for(;x<=T;){const A=x+T>>1;if(_[A]===p)return!0;_[A]>p?T=A-1:x=A+1}return!1}(u.properties()[e.value],d.value,0,d.value.length-1)],all:{type:yi,overloads:[[[yi,yi],(u,[e,d])=>e.evaluate(u)&&d.evaluate(u)],[Dn(yi),(u,e)=>{for(const d of e)if(!d.evaluate(u))return!1;return!0}]]},any:{type:yi,overloads:[[[yi,yi],(u,[e,d])=>e.evaluate(u)||d.evaluate(u)],[Dn(yi),(u,e)=>{for(const d of e)if(d.evaluate(u))return!0;return!1}]]},"!":[yi,[yi],(u,[e])=>!e.evaluate(u)],"is-supported-script":[yi,[Ti],(u,[e])=>{const d=u.globals&&u.globals.isSupportedScript;return!d||d(e.evaluate(u))}],upcase:[Ti,[Ti],(u,[e])=>e.evaluate(u).toUpperCase()],downcase:[Ti,[Ti],(u,[e])=>e.evaluate(u).toLowerCase()],concat:[Ti,Dn(vi),(u,e)=>e.map(d=>yn(d.evaluate(u))).join("")],"resolved-locale":[Ti,[Xn],(u,[e])=>e.evaluate(u).resolvedLocale()]});class Fs{constructor(e,d){this.expression=e,this._warningHistory={},this._evaluator=new Bl,this._defaultValue=d?function(p){return p.type==="color"&&Jn(p.default)?new Ci(0,0,0,0):p.type==="color"?Ci.parse(p.default)||null:p.default===void 0?null:p.default}(d):null,this._enumValues=d&&d.type==="enum"?d.values:null}evaluateWithoutErrorHandling(e,d,p,_,x,T,A,D){return this._evaluator.globals=e,this._evaluator.feature=d,this._evaluator.featureState=p,this._evaluator.canonical=_||null,this._evaluator.availableImages=x||null,this._evaluator.formattedSection=T,this._evaluator.featureTileCoord=A||null,this._evaluator.featureDistanceData=D||null,this.expression.evaluate(this._evaluator)}evaluate(e,d,p,_,x,T,A,D){this._evaluator.globals=e,this._evaluator.feature=d||null,this._evaluator.featureState=p||null,this._evaluator.canonical=_||null,this._evaluator.availableImages=x||null,this._evaluator.formattedSection=T||null,this._evaluator.featureTileCoord=A||null,this._evaluator.featureDistanceData=D||null;try{const B=this.expression.evaluate(this._evaluator);if(B==null||typeof B=="number"&&B!=B)return this._defaultValue;if(this._enumValues&&!(B in this._enumValues))throw new gr(`Expected value to be one of ${Object.keys(this._enumValues).map(O=>JSON.stringify(O)).join(", ")}, but found ${JSON.stringify(B)} instead.`);return B}catch(B){return this._warningHistory[B.message]||(this._warningHistory[B.message]=!0,typeof console!="undefined"&&console.warn(B.message)),this._defaultValue}}}function yo(u){return Array.isArray(u)&&u.length>0&&typeof u[0]=="string"&&u[0]in Hn}function Wo(u,e){const d=new kn(Hn,[],e?function(_){const x={color:dn,string:Ti,number:yt,enum:Ti,boolean:yi,formatted:co,resolvedImage:Tr};return _.type==="array"?Xr(x[_.value]||vi,_.length):x[_.type]}(e):void 0),p=d.parse(u,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return p?Da(new Fs(p,e)):Kn(d.errors)}class La{constructor(e,d){this.kind=e,this._styleExpression=d,this.isStateDependent=e!=="constant"&&!$o(d.expression)}evaluateWithoutErrorHandling(e,d,p,_,x,T){return this._styleExpression.evaluateWithoutErrorHandling(e,d,p,_,x,T)}evaluate(e,d,p,_,x,T){return this._styleExpression.evaluate(e,d,p,_,x,T)}}class za{constructor(e,d,p,_){this.kind=e,this.zoomStops=p,this._styleExpression=d,this.isStateDependent=e!=="camera"&&!$o(d.expression),this.interpolationType=_}evaluateWithoutErrorHandling(e,d,p,_,x,T){return this._styleExpression.evaluateWithoutErrorHandling(e,d,p,_,x,T)}evaluate(e,d,p,_,x,T){return this._styleExpression.evaluate(e,d,p,_,x,T)}interpolationFactor(e,d,p){return this.interpolationType?Or.interpolationFactor(this.interpolationType,e,d,p):0}}function Kl(u,e){if((u=Wo(u,e)).result==="error")return u;const d=u.value.expression,p=Ar(d);if(!p&&!_o(e))return Kn([new Ii("","data expressions not supported")]);const _=Uo(d,["zoom","pitch","distance-from-center"]);if(!_&&!Yl(e))return Kn([new Ii("","zoom expressions not supported")]);const x=Ns(d);return x||_?x instanceof Ii?Kn([x]):x instanceof Or&&!Pa(e)?Kn([new Ii("",'"interpolate" expressions cannot be used with this property')]):Da(x?new za(p?"camera":"composite",u.value,x.labels,x instanceof Or?x.interpolation:void 0):new La(p?"constant":"source",u.value)):Kn([new Ii("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Os{constructor(e,d){this._parameters=e,this._specification=d,Ei(this,Ba(this._parameters,this._specification))}static deserialize(e){return new Os(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ns(u){let e=null;if(u instanceof Xo)e=Ns(u.result);else if(u instanceof Zo){for(const d of u.args)if(e=Ns(d),e)break}else(u instanceof jo||u instanceof Or)&&u.input instanceof Fr&&u.input.name==="zoom"&&(e=u);return e instanceof Ii||u.eachChild(d=>{const p=Ns(d);p instanceof Ii?e=p:!e&&p?e=new Ii("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&p&&e!==p&&(e=new Ii("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}class vt{constructor(e,d,p,_){this.message=(e?`${e}: `:"")+p,_&&(this.identifier=_),d!=null&&d.__line__&&(this.line=d.__line__)}}function Yr(u){const e=u.key,d=u.value,p=u.valueSpec||{},_=u.objectElementValidators||{},x=u.style,T=u.styleSpec;let A=[];const D=Ri(d);if(D!=="object")return[new vt(e,d,`object expected, ${D} found`)];for(const B in d){const O=B.split(".")[0],$=p[O]||p["*"];let V;_[O]?V=_[O]:p[O]?V=hr:_["*"]?V=_["*"]:p["*"]&&(V=hr),V?A=A.concat(V({key:(e&&`${e}.`)+B,value:d[B],valueSpec:$,style:x,styleSpec:T,object:d,objectKey:B},d)):A.push(new vt(e,d[B],`unknown property "${B}"`))}for(const B in p)_[B]||p[B].required&&p[B].default===void 0&&d[B]===void 0&&A.push(new vt(e,d,`missing required property "${B}"`));return A}function Ho(u){const e=u.value,d=u.valueSpec,p=u.style,_=u.styleSpec,x=u.key,T=u.arrayElementValidator||hr;if(Ri(e)!=="array")return[new vt(x,e,`array expected, ${Ri(e)} found`)];if(d.length&&e.length!==d.length)return[new vt(x,e,`array length ${d.length} expected, length ${e.length} found`)];if(d["min-length"]&&e.length<d["min-length"])return[new vt(x,e,`array length at least ${d["min-length"]} expected, length ${e.length} found`)];let A={type:d.value,values:d.values,minimum:d.minimum,maximum:d.maximum,function:void 0};_.$version<7&&(A.function=d.function),Ri(d.value)==="object"&&(A=d.value);let D=[];for(let B=0;B<e.length;B++)D=D.concat(T({array:e,arrayIndex:B,value:e[B],valueSpec:A,style:p,styleSpec:_,key:`${x}[${B}]`}));return D}function Jl(u){const e=u.key,d=u.value,p=u.valueSpec;let _=Ri(d);if(_==="number"&&d!=d&&(_="NaN"),_!=="number")return[new vt(e,d,`number expected, ${_} found`)];if("minimum"in p){let x=p.minimum;if(Ri(p.minimum)==="array"&&(x=p.minimum[u.arrayIndex]),d<x)return[new vt(e,d,`${d} is less than the minimum value ${x}`)]}if("maximum"in p){let x=p.maximum;if(Ri(p.maximum)==="array"&&(x=p.maximum[u.arrayIndex]),d>x)return[new vt(e,d,`${d} is greater than the maximum value ${x}`)]}return[]}function Ql(u){const e=u.valueSpec,d=Mt(u.value.type);let p,_,x,T={};const A=d!=="categorical"&&u.value.property===void 0,D=!A,B=Ri(u.value.stops)==="array"&&Ri(u.value.stops[0])==="array"&&Ri(u.value.stops[0][0])==="object",O=Yr({key:u.key,value:u.value,valueSpec:u.styleSpec.function,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{stops:function(W){if(d==="identity")return[new vt(W.key,W.value,'identity function may not have a "stops" property')];let re=[];const se=W.value;return re=re.concat(Ho({key:W.key,value:se,valueSpec:W.valueSpec,style:W.style,styleSpec:W.styleSpec,arrayElementValidator:$})),Ri(se)==="array"&&se.length===0&&re.push(new vt(W.key,se,"array must have at least one stop")),re},default:function(W){return hr({key:W.key,value:W.value,valueSpec:e,style:W.style,styleSpec:W.styleSpec})}}});return d==="identity"&&A&&O.push(new vt(u.key,u.value,'missing required property "property"')),d==="identity"||u.value.stops||O.push(new vt(u.key,u.value,'missing required property "stops"')),d==="exponential"&&u.valueSpec.expression&&!Pa(u.valueSpec)&&O.push(new vt(u.key,u.value,"exponential functions not supported")),u.styleSpec.$version>=8&&(D&&!_o(u.valueSpec)?O.push(new vt(u.key,u.value,"property functions not supported")):A&&!Yl(u.valueSpec)&&O.push(new vt(u.key,u.value,"zoom functions not supported"))),d!=="categorical"&&!B||u.value.property!==void 0||O.push(new vt(u.key,u.value,'"property" property is required')),O;function $(W){let re=[];const se=W.value,fe=W.key;if(Ri(se)!=="array")return[new vt(fe,se,`array expected, ${Ri(se)} found`)];if(se.length!==2)return[new vt(fe,se,`array length 2 expected, length ${se.length} found`)];if(B){if(Ri(se[0])!=="object")return[new vt(fe,se,`object expected, ${Ri(se[0])} found`)];if(se[0].zoom===void 0)return[new vt(fe,se,"object stop key must have zoom")];if(se[0].value===void 0)return[new vt(fe,se,"object stop key must have value")];const xe=Mt(se[0].zoom);if(typeof xe!="number")return[new vt(fe,se[0].zoom,"stop zoom values must be numbers")];if(x&&x>xe)return[new vt(fe,se[0].zoom,"stop zoom values must appear in ascending order")];xe!==x&&(x=xe,_=void 0,T={}),re=re.concat(Yr({key:`${fe}[0]`,value:se[0],valueSpec:{zoom:{}},style:W.style,styleSpec:W.styleSpec,objectElementValidators:{zoom:Jl,value:V}}))}else re=re.concat(V({key:`${fe}[0]`,value:se[0],valueSpec:{},style:W.style,styleSpec:W.styleSpec},se));return yo(Si(se[1]))?re.concat([new vt(`${fe}[1]`,se[1],"expressions are not allowed in function stops.")]):re.concat(hr({key:`${fe}[1]`,value:se[1],valueSpec:e,style:W.style,styleSpec:W.styleSpec}))}function V(W,re){const se=Ri(W.value),fe=Mt(W.value),xe=W.value!==null?W.value:re;if(p){if(se!==p)return[new vt(W.key,xe,`${se} stop domain type must match previous stop domain type ${p}`)]}else p=se;if(se!=="number"&&se!=="string"&&se!=="boolean"&&typeof fe!="number"&&typeof fe!="string"&&typeof fe!="boolean")return[new vt(W.key,xe,"stop domain value must be a number, string, or boolean")];if(se!=="number"&&d!=="categorical"){let Ae=`number expected, ${se} found`;return _o(e)&&d===void 0&&(Ae+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new vt(W.key,xe,Ae)]}return d!=="categorical"||se!=="number"||typeof fe=="number"&&isFinite(fe)&&Math.floor(fe)===fe?d!=="categorical"&&se==="number"&&typeof fe=="number"&&typeof _=="number"&&_!==void 0&&fe<_?[new vt(W.key,xe,"stop domain values must appear in ascending order")]:(_=fe,d==="categorical"&&fe in T?[new vt(W.key,xe,"stop domain values must be unique")]:(T[fe]=!0,[])):[new vt(W.key,xe,`integer expected, found ${String(fe)}`)]}}function xo(u){const e=(u.expressionContext==="property"?Kl:Wo)(Si(u.value),u.valueSpec);if(e.result==="error")return e.value.map(p=>new vt(`${u.key}${p.key}`,u.value,p.message));const d=e.value.expression||e.value._styleExpression.expression;if(u.expressionContext==="property"&&u.propertyKey==="text-font"&&!d.outputDefined())return[new vt(u.key,u.value,`Invalid data expression for "${u.propertyKey}". Output values must be contained as literals within the expression.`)];if(u.expressionContext==="property"&&u.propertyType==="layout"&&!$o(d))return[new vt(u.key,u.value,'"feature-state" data expressions are not supported with layout properties.')];if(u.expressionContext==="filter")return vn(d,u);if(u.expressionContext&&u.expressionContext.indexOf("cluster")===0){if(!Uo(d,["zoom","feature-state"]))return[new vt(u.key,u.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(u.expressionContext==="cluster-initial"&&!Ar(d))return[new vt(u.key,u.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function vn(u,e){const d=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(e.valueSpec&&e.valueSpec.expression)for(const _ of e.valueSpec.expression.parameters)d.delete(_);if(d.size===0)return[];const p=[];return u instanceof Fr&&d.has(u.name)?[new vt(e.key,e.value,`["${u.name}"] expression is not supported in a filter for a ${e.object.type} layer with id: ${e.object.id}`)]:(u.eachChild(_=>{p.push(...vn(_,e))}),p)}function Ko(u){const e=u.key,d=u.value,p=u.valueSpec,_=[];return Array.isArray(p.values)?p.values.indexOf(Mt(d))===-1&&_.push(new vt(e,d,`expected one of [${p.values.join(", ")}], ${JSON.stringify(d)} found`)):Object.keys(p.values).indexOf(Mt(d))===-1&&_.push(new vt(e,d,`expected one of [${Object.keys(p.values).join(", ")}], ${JSON.stringify(d)} found`)),_}function Pn(u){if(u===!0||u===!1)return!0;if(!Array.isArray(u)||u.length===0)return!1;switch(u[0]){case"has":return u.length>=2&&u[1]!=="$id"&&u[1]!=="$type";case"in":return u.length>=3&&(typeof u[1]!="string"||Array.isArray(u[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return u.length!==3||Array.isArray(u[1])||Array.isArray(u[2]);case"any":case"all":for(const e of u.slice(1))if(!Pn(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Bn(u,e="fill"){if(u==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Pn(u)||(u=Jo(u));const d=u;let p=!0;try{p=function(B){if(!Rn(B))return B;let O=Si(B);return ec(O),O=Fa(O),O}(d)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(d,null,2)}
        `)}const _=Ne[`filter_${e}`],x=Wo(p,_);let T=null;if(x.result==="error")throw new Error(x.value.map(B=>`${B.key}: ${B.message}`).join(", "));T=(B,O,$)=>x.value.evaluate(B,O,{},$);let A=null,D=null;if(p!==d){const B=Wo(d,_);if(B.result==="error")throw new Error(B.value.map(O=>`${O.key}: ${O.message}`).join(", "));A=(O,$,V,W,re)=>B.value.evaluate(O,$,{},V,void 0,void 0,W,re),D=!Ar(B.value.expression)}return T=T,{filter:T,dynamicFilter:A||void 0,needGeometry:$s(p),needFeature:!!D}}function Fa(u){if(!Array.isArray(u))return u;const e=function(d){if(tc.has(d[0])){for(let p=1;p<d.length;p++)if(Rn(d[p]))return!0}return d}(u);return e===!0?e:e.map(d=>Fa(d))}function ec(u){let e=!1;const d=[];if(u[0]==="case"){for(let p=1;p<u.length-1;p+=2)e=e||Rn(u[p]),d.push(u[p+1]);d.push(u[u.length-1])}else if(u[0]==="match"){e=e||Rn(u[1]);for(let p=2;p<u.length-1;p+=2)d.push(u[p+1]);d.push(u[u.length-1])}else if(u[0]==="step"){e=e||Rn(u[1]);for(let p=1;p<u.length-1;p+=2)d.push(u[p+1])}e&&(u.length=0,u.push("any",...d));for(let p=1;p<u.length;p++)ec(u[p])}function Rn(u){if(!Array.isArray(u))return!1;if((e=u[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let d=1;d<u.length;d++)if(Rn(u[d]))return!0;return!1}const tc=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Oa(u,e){return u<e?-1:u>e?1:0}function $s(u){if(!Array.isArray(u))return!1;if(u[0]==="within")return!0;for(let e=1;e<u.length;e++)if($s(u[e]))return!0;return!1}function Jo(u){if(!u)return!0;const e=u[0];return u.length<=1?e!=="any":e==="=="?Qo(u[1],u[2],"=="):e==="!="?es(Qo(u[1],u[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Qo(u[1],u[2],e):e==="any"?(d=u.slice(1),["any"].concat(d.map(Jo))):e==="all"?["all"].concat(u.slice(1).map(Jo)):e==="none"?["all"].concat(u.slice(1).map(Jo).map(es)):e==="in"?Na(u[1],u.slice(2)):e==="!in"?es(Na(u[1],u.slice(2))):e==="has"?$a(u[1]):e==="!has"?es($a(u[1])):e!=="within"||u;var d}function Qo(u,e,d){switch(u){case"$type":return[`filter-type-${d}`,e];case"$id":return[`filter-id-${d}`,e];default:return[`filter-${d}`,u,e]}}function Na(u,e){if(e.length===0)return!1;switch(u){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(d=>typeof d!=typeof e[0])?["filter-in-large",u,["literal",e.sort(Oa)]]:["filter-in-small",u,["literal",e]]}}function $a(u){switch(u){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",u]}}function es(u){return["!",u]}function Ln(u){return Pn(Si(u.value))?xo(Ei({},u,{expressionContext:"filter",valueSpec:u.styleSpec[`filter_${u.layerType||"fill"}`]})):Ua(u)}function Ua(u){const e=u.value,d=u.key;if(Ri(e)!=="array")return[new vt(d,e,`array expected, ${Ri(e)} found`)];const p=u.styleSpec;let _,x=[];if(e.length<1)return[new vt(d,e,"filter array must have at least 1 element")];switch(x=x.concat(Ko({key:`${d}[0]`,value:e[0],valueSpec:p.filter_operator,style:u.style,styleSpec:u.styleSpec})),Mt(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&Mt(e[1])==="$type"&&x.push(new vt(d,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&x.push(new vt(d,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(_=Ri(e[1]),_!=="string"&&x.push(new vt(`${d}[1]`,e[1],`string expected, ${_} found`)));for(let T=2;T<e.length;T++)_=Ri(e[T]),Mt(e[1])==="$type"?x=x.concat(Ko({key:`${d}[${T}]`,value:e[T],valueSpec:p.geometry_type,style:u.style,styleSpec:u.styleSpec})):_!=="string"&&_!=="number"&&_!=="boolean"&&x.push(new vt(`${d}[${T}]`,e[T],`string, number, or boolean expected, ${_} found`));break;case"any":case"all":case"none":for(let T=1;T<e.length;T++)x=x.concat(Ua({key:`${d}[${T}]`,value:e[T],style:u.style,styleSpec:u.styleSpec}));break;case"has":case"!has":_=Ri(e[1]),e.length!==2?x.push(new vt(d,e,`filter array for "${e[0]}" operator must have 2 elements`)):_!=="string"&&x.push(new vt(`${d}[1]`,e[1],`string expected, ${_} found`));break;case"within":_=Ri(e[1]),e.length!==2?x.push(new vt(d,e,`filter array for "${e[0]}" operator must have 2 elements`)):_!=="object"&&x.push(new vt(`${d}[1]`,e[1],`object expected, ${_} found`))}return x}function Va(u,e){const d=u.key,p=u.style,_=u.styleSpec,x=u.value,T=u.objectKey,A=_[`${e}_${u.layerType}`];if(!A)return[];const D=T.match(/^(.*)-transition$/);if(e==="paint"&&D&&A[D[1]]&&A[D[1]].transition)return hr({key:d,value:x,valueSpec:_.transition,style:p,styleSpec:_});const B=u.valueSpec||A[T];if(!B)return[new vt(d,x,`unknown property "${T}"`)];let O;if(Ri(x)==="string"&&_o(B)&&!B.tokens&&(O=/^{([^}]+)}$/.exec(x)))return[new vt(d,x,`"${T}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(O[1])} }\`.`)];const $=[];return u.layerType==="symbol"&&(T==="text-field"&&p&&!p.glyphs&&$.push(new vt(d,x,'use of "text-field" requires a style "glyphs" property')),T==="text-font"&&Jn(Si(x))&&Mt(x.type)==="identity"&&$.push(new vt(d,x,'"text-font" does not support identity functions'))),$.concat(hr({key:u.key,value:x,valueSpec:B,style:p,styleSpec:_,expressionContext:"property",propertyType:e,propertyKey:T}))}function Us(u){return Va(u,"paint")}function ja(u){return Va(u,"layout")}function ic(u){let e=[];const d=u.value,p=u.key,_=u.style,x=u.styleSpec;d.type||d.ref||e.push(new vt(p,d,'either "type" or "ref" is required'));let T=Mt(d.type);const A=Mt(d.ref);if(d.id){const D=Mt(d.id);for(let B=0;B<u.arrayIndex;B++){const O=_.layers[B];Mt(O.id)===D&&e.push(new vt(p,d.id,`duplicate layer id "${d.id}", previously used at line ${O.id.__line__}`))}}if("ref"in d){let D;["type","source","source-layer","filter","layout"].forEach(B=>{B in d&&e.push(new vt(p,d[B],`"${B}" is prohibited for ref layers`))}),_.layers.forEach(B=>{Mt(B.id)===A&&(D=B)}),D?D.ref?e.push(new vt(p,d.ref,"ref cannot reference another ref layer")):T=Mt(D.type):typeof A=="string"&&e.push(new vt(p,d.ref,`ref layer "${A}" not found`))}else if(T!=="background"&&T!=="sky")if(d.source){const D=_.sources&&_.sources[d.source],B=D&&Mt(D.type);D?B==="vector"&&T==="raster"?e.push(new vt(p,d.source,`layer "${d.id}" requires a raster source`)):B==="raster"&&T!=="raster"?e.push(new vt(p,d.source,`layer "${d.id}" requires a vector source`)):B!=="vector"||d["source-layer"]?B==="raster-dem"&&T!=="hillshade"?e.push(new vt(p,d.source,"raster-dem source can only be used with layer type 'hillshade'.")):T!=="line"||!d.paint||!d.paint["line-gradient"]||B==="geojson"&&D.lineMetrics||e.push(new vt(p,d,`layer "${d.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new vt(p,d,`layer "${d.id}" must specify a "source-layer"`)):e.push(new vt(p,d.source,`source "${d.source}" not found`))}else e.push(new vt(p,d,'missing required property "source"'));return e=e.concat(Yr({key:p,value:d,valueSpec:x.layer,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{"*":()=>[],type:()=>hr({key:`${p}.type`,value:d.type,valueSpec:x.layer.type,style:u.style,styleSpec:u.styleSpec,object:d,objectKey:"type"}),filter:D=>Ln(Ei({layerType:T},D)),layout:D=>Yr({layer:d,key:D.key,value:D.value,valueSpec:{},style:D.style,styleSpec:D.styleSpec,objectElementValidators:{"*":B=>ja(Ei({layerType:T},B))}}),paint:D=>Yr({layer:d,key:D.key,value:D.value,valueSpec:{},style:D.style,styleSpec:D.styleSpec,objectElementValidators:{"*":B=>Us(Ei({layerType:T},B))}})}})),e}function bn(u){const e=u.value,d=u.key,p=Ri(e);return p!=="string"?[new vt(d,e,`string expected, ${p} found`)]:[]}const rc={promoteId:function({key:u,value:e}){if(Ri(e)==="string")return bn({key:u,value:e});{const d=[];for(const p in e)d.push(...bn({key:`${u}.${p}`,value:e[p]}));return d}}};function nc(u){const e=u.value,d=u.key,p=u.styleSpec,_=u.style;if(!e.type)return[new vt(d,e,'"type" is required')];const x=Mt(e.type);let T;switch(x){case"vector":case"raster":case"raster-dem":return T=Yr({key:d,value:e,valueSpec:p[`source_${x.replace("-","_")}`],style:u.style,styleSpec:p,objectElementValidators:rc}),T;case"geojson":if(T=Yr({key:d,value:e,valueSpec:p.source_geojson,style:_,styleSpec:p,objectElementValidators:rc}),e.cluster)for(const A in e.clusterProperties){const[D,B]=e.clusterProperties[A],O=typeof D=="string"?[D,["accumulated"],["get",A]]:D;T.push(...xo({key:`${d}.${A}.map`,value:B,expressionContext:"cluster-map"})),T.push(...xo({key:`${d}.${A}.reduce`,value:O,expressionContext:"cluster-reduce"}))}return T;case"video":return Yr({key:d,value:e,valueSpec:p.source_video,style:_,styleSpec:p});case"image":return Yr({key:d,value:e,valueSpec:p.source_image,style:_,styleSpec:p});case"canvas":return[new vt(d,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Ko({key:`${d}.type`,value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:_,styleSpec:p})}}function oc(u){const e=u.value,d=u.styleSpec,p=d.light,_=u.style;let x=[];const T=Ri(e);if(e===void 0)return x;if(T!=="object")return x=x.concat([new vt("light",e,`object expected, ${T} found`)]),x;for(const A in e){const D=A.match(/^(.*)-transition$/);x=x.concat(D&&p[D[1]]&&p[D[1]].transition?hr({key:A,value:e[A],valueSpec:d.transition,style:_,styleSpec:d}):p[A]?hr({key:A,value:e[A],valueSpec:p[A],style:_,styleSpec:d}):[new vt(A,e[A],`unknown property "${A}"`)])}return x}function sc(u){const e=u.value,d=u.key,p=u.style,_=u.styleSpec,x=_.terrain;let T=[];const A=Ri(e);if(e===void 0)return T;if(A!=="object")return T=T.concat([new vt("terrain",e,`object expected, ${A} found`)]),T;for(const D in e){const B=D.match(/^(.*)-transition$/);T=T.concat(B&&x[B[1]]&&x[B[1]].transition?hr({key:D,value:e[D],valueSpec:_.transition,style:p,styleSpec:_}):x[D]?hr({key:D,value:e[D],valueSpec:x[D],style:p,styleSpec:_}):[new vt(D,e[D],`unknown property "${D}"`)])}if(e.source){const D=p.sources&&p.sources[e.source],B=D&&Mt(D.type);D?B!=="raster-dem"&&T.push(new vt(d,e.source,`terrain cannot be used with a source of type ${String(B)}, it only be used with a "raster-dem" source type`)):T.push(new vt(d,e.source,`source "${e.source}" not found`))}else T.push(new vt(d,e,'terrain is missing required property "source"'));return T}function ac(u){const e=u.value,d=u.style,p=u.styleSpec,_=p.fog;let x=[];const T=Ri(e);if(e===void 0)return x;if(T!=="object")return x=x.concat([new vt("fog",e,`object expected, ${T} found`)]),x;for(const A in e){const D=A.match(/^(.*)-transition$/);x=x.concat(D&&_[D[1]]&&_[D[1]].transition?hr({key:A,value:e[A],valueSpec:p.transition,style:d,styleSpec:p}):_[A]?hr({key:A,value:e[A],valueSpec:_[A],style:d,styleSpec:p}):[new vt(A,e[A],`unknown property "${A}"`)])}return x}const ts={"*":()=>[],array:Ho,boolean:function(u){const e=u.value,d=u.key,p=Ri(e);return p!=="boolean"?[new vt(d,e,`boolean expected, ${p} found`)]:[]},number:Jl,color:function(u){const e=u.key,d=u.value,p=Ri(d);return p!=="string"?[new vt(e,d,`color expected, ${p} found`)]:ga.parseCSSColor(d)===null?[new vt(e,d,`color expected, "${d}" found`)]:[]},enum:Ko,filter:Ln,function:Ql,layer:ic,object:Yr,source:nc,light:oc,terrain:sc,fog:ac,string:bn,formatted:function(u){return bn(u).length===0?[]:xo(u)},resolvedImage:function(u){return bn(u).length===0?[]:xo(u)},projection:function(u){const e=u.value,d=u.styleSpec,p=d.projection,_=u.style;let x=[];const T=Ri(e);if(T==="object")for(const A in e)x=x.concat(hr({key:A,value:e[A],valueSpec:p[A],style:_,styleSpec:d}));else T!=="string"&&(x=x.concat([new vt("projection",e,`object or string expected, ${T} found`)]));return x}};function hr(u){const e=u.value,d=u.valueSpec,p=u.styleSpec;return d.expression&&Jn(Mt(e))?Ql(u):d.expression&&yo(Si(e))?xo(u):d.type&&ts[d.type]?ts[d.type](u):Yr(Ei({},u,{valueSpec:d.type?p[d.type]:d}))}function Nr(u){const e=u.value,d=u.key,p=bn(u);return p.length||(e.indexOf("{fontstack}")===-1&&p.push(new vt(d,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&p.push(new vt(d,e,'"glyphs" url must include a "{range}" token'))),p}function is(u,e=Ne){return wn(hr({key:"",value:u,valueSpec:e.$root,styleSpec:e,style:u,objectElementValidators:{glyphs:Nr,"*":()=>[]}}))}const _h=u=>wn(Us(u)),yh=u=>wn(ja(u));function wn(u){return u.slice().sort((e,d)=>e.line&&d.line?e.line-d.line:0)}function lc(u,e){let d=!1;if(e&&e.length)for(const p of e)u.fire(new Bt(new Error(p.message))),d=!0;return d}var zn=fn;function fn(u,e,d){var p=this.cells=[];if(u instanceof ArrayBuffer){this.arrayBuffer=u;var _=new Int32Array(this.arrayBuffer);u=_[0],this.d=(e=_[1])+2*(d=_[2]);for(var x=0;x<this.d*this.d;x++){var T=_[3+x],A=_[3+x+1];p.push(T===A?null:_.subarray(T,A))}var D=_[3+p.length+1];this.keys=_.subarray(_[3+p.length],D),this.bboxes=_.subarray(D),this.insert=this._insertReadonly}else{this.d=e+2*d;for(var B=0;B<this.d*this.d;B++)p.push([]);this.keys=[],this.bboxes=[]}this.n=e,this.extent=u,this.padding=d,this.scale=e/u,this.uid=0;var O=d/e*u;this.min=-O,this.max=u+O}fn.prototype.insert=function(u,e,d,p,_){this._forEachCell(e,d,p,_,this._insertCell,this.uid++),this.keys.push(u),this.bboxes.push(e),this.bboxes.push(d),this.bboxes.push(p),this.bboxes.push(_)},fn.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},fn.prototype._insertCell=function(u,e,d,p,_,x){this.cells[_].push(x)},fn.prototype.query=function(u,e,d,p,_){var x=this.min,T=this.max;if(u<=x&&e<=x&&T<=d&&T<=p&&!_)return Array.prototype.slice.call(this.keys);var A=[];return this._forEachCell(u,e,d,p,this._queryCell,A,{},_),A},fn.prototype._queryCell=function(u,e,d,p,_,x,T,A){var D=this.cells[_];if(D!==null)for(var B=this.keys,O=this.bboxes,$=0;$<D.length;$++){var V=D[$];if(T[V]===void 0){var W=4*V;(A?A(O[W+0],O[W+1],O[W+2],O[W+3]):u<=O[W+2]&&e<=O[W+3]&&d>=O[W+0]&&p>=O[W+1])?(T[V]=!0,x.push(B[V])):T[V]=!1}}},fn.prototype._forEachCell=function(u,e,d,p,_,x,T,A){for(var D=this._convertToCellCoord(u),B=this._convertToCellCoord(e),O=this._convertToCellCoord(d),$=this._convertToCellCoord(p),V=D;V<=O;V++)for(var W=B;W<=$;W++){var re=this.d*W+V;if((!A||A(this._convertFromCellCoord(V),this._convertFromCellCoord(W),this._convertFromCellCoord(V+1),this._convertFromCellCoord(W+1)))&&_.call(this,u,e,d,p,re,x,T,A))return}},fn.prototype._convertFromCellCoord=function(u){return(u-this.padding)/this.scale},fn.prototype._convertToCellCoord=function(u){return Math.max(0,Math.min(this.d-1,Math.floor(u*this.scale)+this.padding))},fn.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var u=this.cells,e=3+this.cells.length+1+1,d=0,p=0;p<this.cells.length;p++)d+=this.cells[p].length;var _=new Int32Array(e+d+this.keys.length+this.bboxes.length);_[0]=this.extent,_[1]=this.n,_[2]=this.padding;for(var x=e,T=0;T<u.length;T++){var A=u[T];_[3+T]=x,_.set(A,x),x+=A.length}return _[3+u.length]=x,_.set(this.keys,x),_[3+u.length+1]=x+=this.keys.length,_.set(this.bboxes,x),x+=this.bboxes.length,_.buffer};const Qn={};function Tt(u,e={}){Qn[u.name]={klass:u,omit:e.omit||[]}}Tt(Object),zn.serialize=function(u,e){const d=u.toArrayBuffer();return e&&e.push(d),{buffer:d}},zn.deserialize=function(u){return new zn(u.buffer)},Object.defineProperty(zn,"name",{value:"Grid"}),Tt(zn),Tt(Ci),Tt(Error),Tt(j),Tt(zr),Tt(Os),Tt(Fs,{omit:["_evaluator"]}),Tt(za),Tt(La),Tt(Fr,{omit:["_evaluate"]});for(const u in Hn)Qn[Hn[u].name]||Tt(Hn[u]);function cc(u){return u&&typeof ArrayBuffer!="undefined"&&(u instanceof ArrayBuffer||u.constructor&&u.constructor.name==="ArrayBuffer")}function Vs(u){return F.ImageBitmap&&u instanceof F.ImageBitmap}function rs(u,e){if(u==null||typeof u=="boolean"||typeof u=="number"||typeof u=="string"||u instanceof Boolean||u instanceof Number||u instanceof String||u instanceof Date||u instanceof RegExp)return u;if(cc(u)||Vs(u))return e&&e.push(u),u;if(ArrayBuffer.isView(u)){const d=u;return e&&e.push(d.buffer),d}if(u instanceof F.ImageData)return e&&e.push(u.data.buffer),u;if(Array.isArray(u)){const d=[];for(const p of u)d.push(rs(p,e));return d}if(typeof u=="object"){const d=u.constructor,p=d.name;if(!Qn[p])throw new Error(`can't serialize object of unregistered class ${p}`);const _=d.serialize?d.serialize(u,e):{};if(!d.serialize){for(const x in u)u.hasOwnProperty(x)&&(Qn[p].omit.indexOf(x)>=0||(_[x]=rs(u[x],e)));u instanceof Error&&(_.message=u.message)}if(_.$name)throw new Error("$name property is reserved for worker serialization logic.");return p!=="Object"&&(_.$name=p),_}throw new Error("can't serialize object of type "+typeof u)}function vo(u){if(u==null||typeof u=="boolean"||typeof u=="number"||typeof u=="string"||u instanceof Boolean||u instanceof Number||u instanceof String||u instanceof Date||u instanceof RegExp||cc(u)||Vs(u)||ArrayBuffer.isView(u)||u instanceof F.ImageData)return u;if(Array.isArray(u))return u.map(vo);if(typeof u=="object"){const e=u.$name||"Object",{klass:d}=Qn[e];if(!d)throw new Error(`can't deserialize unregistered class ${e}`);if(d.deserialize)return d.deserialize(u);const p=Object.create(d.prototype);for(const _ of Object.keys(u))_!=="$name"&&(p[_]=vo(u[_]));return p}throw new Error("can't deserialize object of type "+typeof u)}class Ga{constructor(){this.first=!0}update(e,d){const p=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=p,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=p,!0):(this.lastFloorZoom>p?(this.lastIntegerZoom=p+1,this.lastIntegerZoomTime=d):this.lastFloorZoom<p&&(this.lastIntegerZoom=p,this.lastIntegerZoomTime=d),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=p,!0))}}const hc=u=>u>=1536&&u<=1791,js=u=>u>=1872&&u<=1919,ns=u=>u>=2208&&u<=2303,qa=u=>u>=11904&&u<=12031,uc=u=>u>=12032&&u<=12255,Za=u=>u>=12272&&u<=12287,Gs=u=>u>=12288&&u<=12351,os=u=>u>=12352&&u<=12447,qs=u=>u>=12448&&u<=12543,dc=u=>u>=12544&&u<=12591,fc=u=>u>=12704&&u<=12735,pc=u=>u>=12736&&u<=12783,Xa=u=>u>=12784&&u<=12799,mc=u=>u>=12800&&u<=13055,gc=u=>u>=13056&&u<=13311,_c=u=>u>=13312&&u<=19903,Ya=u=>u>=19968&&u<=40959,yc=u=>u>=40960&&u<=42127,xc=u=>u>=42128&&u<=42191,vc=u=>u>=44032&&u<=55215,ss=u=>u>=63744&&u<=64255,Wa=u=>u>=64336&&u<=65023,bc=u=>u>=65040&&u<=65055,bo=u=>u>=65072&&u<=65103,wc=u=>u>=65104&&u<=65135,Zs=u=>u>=65136&&u<=65279,Ha=u=>u>=65280&&u<=65519;function Xs(u){for(const e of u)if(Ys(e.charCodeAt(0)))return!0;return!1}function Ec(u){for(const e of u)if(!Tc(e.charCodeAt(0)))return!1;return!0}function Tc(u){return!(hc(u)||js(u)||ns(u)||Wa(u)||Zs(u))}function Ys(u){return!(u!==746&&u!==747&&(u<4352||!(fc(u)||dc(u)||bo(u)&&!(u>=65097&&u<=65103)||ss(u)||gc(u)||qa(u)||pc(u)||!(!Gs(u)||u>=12296&&u<=12305||u>=12308&&u<=12319||u===12336)||_c(u)||Ya(u)||mc(u)||(e=>e>=12592&&e<=12687)(u)||(e=>e>=43360&&e<=43391)(u)||(e=>e>=55216&&e<=55295)(u)||(e=>e>=4352&&e<=4607)(u)||vc(u)||os(u)||Za(u)||(e=>e>=12688&&e<=12703)(u)||uc(u)||Xa(u)||qs(u)&&u!==12540||!(!Ha(u)||u===65288||u===65289||u===65293||u>=65306&&u<=65310||u===65339||u===65341||u===65343||u>=65371&&u<=65503||u===65507||u>=65512&&u<=65519)||!(!wc(u)||u>=65112&&u<=65118||u>=65123&&u<=65126)||(e=>e>=5120&&e<=5759)(u)||(e=>e>=6320&&e<=6399)(u)||bc(u)||(e=>e>=19904&&e<=19967)(u)||yc(u)||xc(u))))}function Ws(u){return!(Ys(u)||function(e){return!!((d=>d>=128&&d<=255)(e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||(d=>d>=8192&&d<=8303)(e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||(d=>d>=8448&&d<=8527)(e)||(d=>d>=8528&&d<=8591)(e)||(d=>d>=8960&&d<=9215)(e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||(d=>d>=9216&&d<=9279)(e)&&e!==9251||(d=>d>=9280&&d<=9311)(e)||(d=>d>=9312&&d<=9471)(e)||(d=>d>=9632&&d<=9727)(e)||(d=>d>=9728&&d<=9983)(e)&&!(e>=9754&&e<=9759)||(d=>d>=11008&&d<=11263)(e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Gs(e)||qs(e)||(d=>d>=57344&&d<=63743)(e)||bo(e)||wc(e)||Ha(e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(u))}function Hs(u){return u>=1424&&u<=2303||Wa(u)||Zs(u)}function xh(u,e){return!(!e&&Hs(u)||u>=2304&&u<=3583||u>=3840&&u<=4255||(d=>d>=6016&&d<=6143)(u))}function vh(u){for(const e of u)if(Hs(e.charCodeAt(0)))return!0;return!1}const Ka="deferred",as="loading",Ja="loaded";let Qa=null,Ir="unavailable",$r=null;const ls=function(u){u&&typeof u=="string"&&u.indexOf("NetworkError")>-1&&(Ir="error"),Qa&&Qa(u)};function eo(){el.fire(new bt("pluginStateChange",{pluginStatus:Ir,pluginURL:$r}))}const el=new Yt,Ks=function(){return Ir},wo=function(){if(Ir!==Ka||!$r)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Ir=as,eo(),$r&&pe({url:$r},u=>{u?ls(u):(Ir=Ja,eo())})},Wr={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Ir===Ja||Wr.applyArabicShaping!=null,isLoading:()=>Ir===as,setState(u){Ir=u.pluginStatus,$r=u.pluginURL},isParsed:()=>Wr.applyArabicShaping!=null&&Wr.processBidirectionalText!=null&&Wr.processStyledBidirectionalText!=null,getPluginURL:()=>$r};class Vi{constructor(e,d){this.zoom=e,d?(this.now=d.now,this.fadeDuration=d.fadeDuration,this.zoomHistory=d.zoomHistory,this.transition=d.transition,this.pitch=d.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Ga,this.transition={},this.pitch=0)}isSupportedScript(e){return function(d,p){for(const _ of d)if(!xh(_.charCodeAt(0),p))return!1;return!0}(e,Wr.isLoaded())}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,d=e-Math.floor(e),p=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:d+(1-d)*p}:{fromScale:.5,toScale:1,t:1-(1-p)*d}}}class cs{constructor(e,d){this.property=e,this.value=d,this.expression=function(p,_){if(Jn(p))return new Os(p,_);if(yo(p)){const x=Kl(p,_);if(x.result==="error")throw new Error(x.value.map(T=>`${T.key}: ${T.message}`).join(", "));return x.value}{let x=p;return typeof p=="string"&&_.type==="color"&&(x=Ci.parse(p)),{kind:"constant",evaluate:()=>x}}}(d===void 0?e.specification.default:d,e.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,d,p){return this.property.possiblyEvaluate(this,e,d,p)}}class Eo{constructor(e){this.property=e,this.value=new cs(e,void 0)}transitioned(e,d){return new c(this.property,this.value,d,he({},e.transition,this.transition),e.now)}untransitioned(){return new c(this.property,this.value,null,{},0)}}class y{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues)}getValue(e){return Xt(this._values[e].value.value)}setValue(e,d){this._values.hasOwnProperty(e)||(this._values[e]=new Eo(this._values[e].property)),this._values[e].value=new cs(this._values[e].property,d===null?void 0:Xt(d))}getTransition(e){return Xt(this._values[e].transition)}setTransition(e,d){this._values.hasOwnProperty(e)||(this._values[e]=new Eo(this._values[e].property)),this._values[e].transition=Xt(d)||void 0}serialize(){const e={};for(const d of Object.keys(this._values)){const p=this.getValue(d);p!==void 0&&(e[d]=p);const _=this.getTransition(d);_!==void 0&&(e[`${d}-transition`]=_)}return e}transitioned(e,d){const p=new g(this._properties);for(const _ of Object.keys(this._values))p._values[_]=this._values[_].transitioned(e,d._values[_]);return p}untransitioned(){const e=new g(this._properties);for(const d of Object.keys(this._values))e._values[d]=this._values[d].untransitioned();return e}}class c{constructor(e,d,p,_,x){const T=_.delay||0,A=_.duration||0;x=x||0,this.property=e,this.value=d,this.begin=x+T,this.end=this.begin+A,e.specification.transition&&(_.delay||_.duration)&&(this.prior=p)}possiblyEvaluate(e,d,p){const _=e.now||0,x=this.value.possiblyEvaluate(e,d,p),T=this.prior;if(T){if(_>this.end)return this.prior=null,x;if(this.value.isDataDriven())return this.prior=null,x;if(_<this.begin)return T.possiblyEvaluate(e,d,p);{const A=(_-this.begin)/(this.end-this.begin);return this.property.interpolate(T.possiblyEvaluate(e,d,p),x,Q(A))}}return x}}class g{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,d,p){const _=new k(this._properties);for(const x of Object.keys(this._values))_._values[x]=this._values[x].possiblyEvaluate(e,d,p);return _}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class w{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues)}getValue(e){return Xt(this._values[e].value)}setValue(e,d){this._values[e]=new cs(this._values[e].property,d===null?void 0:Xt(d))}serialize(){const e={};for(const d of Object.keys(this._values)){const p=this.getValue(d);p!==void 0&&(e[d]=p)}return e}possiblyEvaluate(e,d,p){const _=new k(this._properties);for(const x of Object.keys(this._values))_._values[x]=this._values[x].possiblyEvaluate(e,d,p);return _}}class I{constructor(e,d,p){this.property=e,this.value=d,this.parameters=p}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,d,p,_){return this.property.evaluate(this.value,this.parameters,e,d,p,_)}}class k{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class P{constructor(e){this.specification=e}possiblyEvaluate(e,d){return e.expression.evaluate(d)}interpolate(e,d,p){const _=As[this.specification.type];return _?_(e,d,p):e}}class z{constructor(e,d){this.specification=e,this.overrides=d}possiblyEvaluate(e,d,p,_){return new I(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(d,null,{},p,_)}:e.expression,d)}interpolate(e,d,p){if(e.value.kind!=="constant"||d.value.kind!=="constant")return e;if(e.value.value===void 0||d.value.value===void 0)return new I(this,{kind:"constant",value:void 0},e.parameters);const _=As[this.specification.type];return _?new I(this,{kind:"constant",value:_(e.value.value,d.value.value,p)},e.parameters):e}evaluate(e,d,p,_,x,T){return e.kind==="constant"?e.value:e.evaluate(d,p,_,x,T)}}class U extends z{possiblyEvaluate(e,d,p,_){if(e.value===void 0)return new I(this,{kind:"constant",value:void 0},d);if(e.expression.kind==="constant"){const x=e.expression.evaluate(d,null,{},p,_),T=e.property.specification.type==="resolvedImage"&&typeof x!="string"?x.name:x,A=this._calculate(T,T,T,d);return new I(this,{kind:"constant",value:A},d)}if(e.expression.kind==="camera"){const x=this._calculate(e.expression.evaluate({zoom:d.zoom-1}),e.expression.evaluate({zoom:d.zoom}),e.expression.evaluate({zoom:d.zoom+1}),d);return new I(this,{kind:"constant",value:x},d)}return new I(this,e.expression,d)}evaluate(e,d,p,_,x,T){if(e.kind==="source"){const A=e.evaluate(d,p,_,x,T);return this._calculate(A,A,A,d)}return e.kind==="composite"?this._calculate(e.evaluate({zoom:Math.floor(d.zoom)-1},p,_),e.evaluate({zoom:Math.floor(d.zoom)},p,_),e.evaluate({zoom:Math.floor(d.zoom)+1},p,_),d):e.value}_calculate(e,d,p,_){return _.zoom>_.zoomHistory.lastIntegerZoom?{from:e,to:d,other:p}:{from:p,to:d,other:e}}interpolate(e){return e}}class q{constructor(e){this.specification=e}possiblyEvaluate(e,d,p,_){if(e.value!==void 0){if(e.expression.kind==="constant"){const x=e.expression.evaluate(d,null,{},p,_);return this._calculate(x,x,x,d)}return this._calculate(e.expression.evaluate(new Vi(Math.floor(d.zoom-1),d)),e.expression.evaluate(new Vi(Math.floor(d.zoom),d)),e.expression.evaluate(new Vi(Math.floor(d.zoom+1),d)),d)}}_calculate(e,d,p,_){return _.zoom>_.zoomHistory.lastIntegerZoom?{from:e,to:d}:{from:p,to:d}}interpolate(e){return e}}class Z{constructor(e){this.specification=e}possiblyEvaluate(e,d,p,_){return!!e.expression.evaluate(d,null,{},p,_)}interpolate(){return!1}}class ee{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const d in e){const p=e[d];p.specification.overridable&&this.overridableProperties.push(d);const _=this.defaultPropertyValues[d]=new cs(p,void 0),x=this.defaultTransitionablePropertyValues[d]=new Eo(p);this.defaultTransitioningPropertyValues[d]=x.untransitioned(),this.defaultPossiblyEvaluatedValues[d]=_.possiblyEvaluate({})}}}function ae(u,e){return 256*(u=ge(Math.floor(u),0,255))+ge(Math.floor(e),0,255)}Tt(z),Tt(P),Tt(U),Tt(q),Tt(Z);const me={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ue{constructor(e,d){this._structArray=e,this._pos1=d*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class oe{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,d){return e._trim(),d&&(e.isTransferred=!0,d.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const d=Object.create(this.prototype);return d.arrayBuffer=e.arrayBuffer,d.length=e.length,d.capacity=e.arrayBuffer.byteLength/d.bytesPerElement,d._refreshViews(),d}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const d=this.uint8;this._refreshViews(),d&&this.uint8.set(d)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Me(u,e=1){let d=0,p=0;return{members:u.map(_=>{const x=me[_.type].BYTES_PER_ELEMENT,T=d=ye(d,Math.max(e,x)),A=_.components||1;return p=Math.max(p,x),d+=x*A,{name:_.name,type:_.type,components:A,offset:T}}),size:ye(d,Math.max(p,e)),alignment:e}}function ye(u,e){return Math.ceil(u/e)*e}class Ee extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,d)}emplace(e,d,p){const _=2*e;return this.int16[_+0]=d,this.int16[_+1]=p,e}}Ee.prototype.bytesPerElement=4,Tt(Ee);class Te extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,d,p){const _=this.length;return this.resize(_+1),this.emplace(_,e,d,p)}emplace(e,d,p,_){const x=3*e;return this.int16[x+0]=d,this.int16[x+1]=p,this.int16[x+2]=_,e}}Te.prototype.bytesPerElement=6,Tt(Te);class Se extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,d,p,_){const x=this.length;return this.resize(x+1),this.emplace(x,e,d,p,_)}emplace(e,d,p,_,x){const T=4*e;return this.int16[T+0]=d,this.int16[T+1]=p,this.int16[T+2]=_,this.int16[T+3]=x,e}}Se.prototype.bytesPerElement=8,Tt(Se);class we extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A){const D=this.length;return this.resize(D+1),this.emplace(D,e,d,p,_,x,T,A)}emplace(e,d,p,_,x,T,A,D){const B=6*e,O=12*e,$=3*e;return this.int16[B+0]=d,this.int16[B+1]=p,this.uint8[O+4]=_,this.uint8[O+5]=x,this.uint8[O+6]=T,this.uint8[O+7]=A,this.float32[$+2]=D,e}}we.prototype.bytesPerElement=12,Tt(we);class ke extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,d,p){const _=this.length;return this.resize(_+1),this.emplace(_,e,d,p)}emplace(e,d,p,_){const x=3*e;return this.float32[x+0]=d,this.float32[x+1]=p,this.float32[x+2]=_,e}}ke.prototype.bytesPerElement=12,Tt(ke);class $e extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A,D,B,O){const $=this.length;return this.resize($+1),this.emplace($,e,d,p,_,x,T,A,D,B,O)}emplace(e,d,p,_,x,T,A,D,B,O,$){const V=10*e;return this.uint16[V+0]=d,this.uint16[V+1]=p,this.uint16[V+2]=_,this.uint16[V+3]=x,this.uint16[V+4]=T,this.uint16[V+5]=A,this.uint16[V+6]=D,this.uint16[V+7]=B,this.uint16[V+8]=O,this.uint16[V+9]=$,e}}$e.prototype.bytesPerElement=20,Tt($e);class qe extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A,D){const B=this.length;return this.resize(B+1),this.emplace(B,e,d,p,_,x,T,A,D)}emplace(e,d,p,_,x,T,A,D,B){const O=8*e;return this.uint16[O+0]=d,this.uint16[O+1]=p,this.uint16[O+2]=_,this.uint16[O+3]=x,this.uint16[O+4]=T,this.uint16[O+5]=A,this.uint16[O+6]=D,this.uint16[O+7]=B,e}}qe.prototype.bytesPerElement=16,Tt(qe);class He extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T){const A=this.length;return this.resize(A+1),this.emplace(A,e,d,p,_,x,T)}emplace(e,d,p,_,x,T,A){const D=6*e;return this.int16[D+0]=d,this.int16[D+1]=p,this.int16[D+2]=_,this.int16[D+3]=x,this.int16[D+4]=T,this.int16[D+5]=A,e}}He.prototype.bytesPerElement=12,Tt(He);class Ye extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe){const xe=this.length;return this.resize(xe+1),this.emplace(xe,e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe)}emplace(e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe,xe){const Ae=16*e;return this.int16[Ae+0]=d,this.int16[Ae+1]=p,this.int16[Ae+2]=_,this.int16[Ae+3]=x,this.uint16[Ae+4]=T,this.uint16[Ae+5]=A,this.uint16[Ae+6]=D,this.uint16[Ae+7]=B,this.int16[Ae+8]=O,this.int16[Ae+9]=$,this.int16[Ae+10]=V,this.int16[Ae+11]=W,this.int16[Ae+12]=re,this.int16[Ae+13]=se,this.int16[Ae+14]=fe,this.int16[Ae+15]=xe,e}}Ye.prototype.bytesPerElement=32,Tt(Ye);class ht extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const d=this.length;return this.resize(d+1),this.emplace(d,e)}emplace(e,d){return this.uint32[1*e+0]=d,e}}ht.prototype.bytesPerElement=4,Tt(ht);class Ue extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A,D,B,O,$,V,W){const re=this.length;return this.resize(re+1),this.emplace(re,e,d,p,_,x,T,A,D,B,O,$,V,W)}emplace(e,d,p,_,x,T,A,D,B,O,$,V,W,re){const se=20*e,fe=10*e;return this.int16[se+0]=d,this.int16[se+1]=p,this.int16[se+2]=_,this.int16[se+3]=x,this.int16[se+4]=T,this.float32[fe+3]=A,this.float32[fe+4]=D,this.float32[fe+5]=B,this.float32[fe+6]=O,this.int16[se+14]=$,this.uint32[fe+8]=V,this.uint16[se+18]=W,this.uint16[se+19]=re,e}}Ue.prototype.bytesPerElement=40,Tt(Ue);class lt extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A){const D=this.length;return this.resize(D+1),this.emplace(D,e,d,p,_,x,T,A)}emplace(e,d,p,_,x,T,A,D){const B=8*e;return this.int16[B+0]=d,this.int16[B+1]=p,this.int16[B+2]=_,this.int16[B+4]=x,this.int16[B+5]=T,this.int16[B+6]=A,this.int16[B+7]=D,e}}lt.prototype.bytesPerElement=16,Tt(lt);class st extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x){const T=this.length;return this.resize(T+1),this.emplace(T,e,d,p,_,x)}emplace(e,d,p,_,x,T){const A=4*e,D=8*e;return this.float32[A+0]=d,this.float32[A+1]=p,this.float32[A+2]=_,this.int16[D+6]=x,this.int16[D+7]=T,e}}st.prototype.bytesPerElement=16,Tt(st);class kt extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,d,p,_){const x=this.length;return this.resize(x+1),this.emplace(x,e,d,p,_)}emplace(e,d,p,_,x){const T=12*e,A=3*e;return this.uint8[T+0]=d,this.uint8[T+1]=p,this.float32[A+1]=_,this.float32[A+2]=x,e}}kt.prototype.bytesPerElement=12,Tt(kt);class Ze extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,d,p){const _=this.length;return this.resize(_+1),this.emplace(_,e,d,p)}emplace(e,d,p,_){const x=3*e;return this.uint16[x+0]=d,this.uint16[x+1]=p,this.uint16[x+2]=_,e}}Ze.prototype.bytesPerElement=6,Tt(Ze);class Ut extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe,xe,Ae,Pe,Re,ze){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe,xe,Ae,Pe,Re,ze)}emplace(e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe,xe,Ae,Pe,Re,ze,Fe){const Xe=30*e,We=15*e,et=60*e;return this.int16[Xe+0]=d,this.int16[Xe+1]=p,this.int16[Xe+2]=_,this.float32[We+2]=x,this.float32[We+3]=T,this.uint16[Xe+8]=A,this.uint16[Xe+9]=D,this.uint32[We+5]=B,this.uint32[We+6]=O,this.uint32[We+7]=$,this.uint16[Xe+16]=V,this.uint16[Xe+17]=W,this.uint16[Xe+18]=re,this.float32[We+10]=se,this.float32[We+11]=fe,this.uint8[et+48]=xe,this.uint8[et+49]=Ae,this.uint8[et+50]=Pe,this.uint32[We+13]=Re,this.int16[Xe+28]=ze,this.uint8[et+58]=Fe,e}}Ut.prototype.bytesPerElement=60,Tt(Ut);class Gt extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe,xe,Ae,Pe,Re,ze,Fe,Xe,We,et,rt,Ge,Je,ot,pt){const at=this.length;return this.resize(at+1),this.emplace(at,e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe,xe,Ae,Pe,Re,ze,Fe,Xe,We,et,rt,Ge,Je,ot,pt)}emplace(e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe,xe,Ae,Pe,Re,ze,Fe,Xe,We,et,rt,Ge,Je,ot,pt,at){const ut=38*e,ii=19*e;return this.int16[ut+0]=d,this.int16[ut+1]=p,this.int16[ut+2]=_,this.float32[ii+2]=x,this.float32[ii+3]=T,this.int16[ut+8]=A,this.int16[ut+9]=D,this.int16[ut+10]=B,this.int16[ut+11]=O,this.int16[ut+12]=$,this.int16[ut+13]=V,this.uint16[ut+14]=W,this.uint16[ut+15]=re,this.uint16[ut+16]=se,this.uint16[ut+17]=fe,this.uint16[ut+18]=xe,this.uint16[ut+19]=Ae,this.uint16[ut+20]=Pe,this.uint16[ut+21]=Re,this.uint16[ut+22]=ze,this.uint16[ut+23]=Fe,this.uint16[ut+24]=Xe,this.uint16[ut+25]=We,this.uint16[ut+26]=et,this.uint16[ut+27]=rt,this.uint16[ut+28]=Ge,this.uint32[ii+15]=Je,this.float32[ii+16]=ot,this.float32[ii+17]=pt,this.float32[ii+18]=at,e}}Gt.prototype.bytesPerElement=76,Tt(Gt);class St extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const d=this.length;return this.resize(d+1),this.emplace(d,e)}emplace(e,d){return this.float32[1*e+0]=d,e}}St.prototype.bytesPerElement=4,Tt(St);class At extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A){const D=this.length;return this.resize(D+1),this.emplace(D,e,d,p,_,x,T,A)}emplace(e,d,p,_,x,T,A,D){const B=7*e;return this.float32[B+0]=d,this.float32[B+1]=p,this.float32[B+2]=_,this.float32[B+3]=x,this.float32[B+4]=T,this.float32[B+5]=A,this.float32[B+6]=D,e}}At.prototype.bytesPerElement=28,Tt(At);class Kt extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x){const T=this.length;return this.resize(T+1),this.emplace(T,e,d,p,_,x)}emplace(e,d,p,_,x,T){const A=5*e;return this.float32[A+0]=d,this.float32[A+1]=p,this.float32[A+2]=_,this.float32[A+3]=x,this.float32[A+4]=T,e}}Kt.prototype.bytesPerElement=20,Tt(Kt);class pi extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,d,p,_){const x=this.length;return this.resize(x+1),this.emplace(x,e,d,p,_)}emplace(e,d,p,_,x){const T=6*e;return this.uint32[3*e+0]=d,this.uint16[T+2]=p,this.uint16[T+3]=_,this.uint16[T+4]=x,e}}pi.prototype.bytesPerElement=12,Tt(pi);class Ft extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,d)}emplace(e,d,p){const _=2*e;return this.uint16[_+0]=d,this.uint16[_+1]=p,e}}Ft.prototype.bytesPerElement=4,Tt(Ft);class ei extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const d=this.length;return this.resize(d+1),this.emplace(d,e)}emplace(e,d){return this.uint16[1*e+0]=d,e}}ei.prototype.bytesPerElement=2,Tt(ei);class ki extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,d)}emplace(e,d,p){const _=2*e;return this.float32[_+0]=d,this.float32[_+1]=p,e}}ki.prototype.bytesPerElement=8,Tt(ki);class Yi extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,d,p,_){const x=this.length;return this.resize(x+1),this.emplace(x,e,d,p,_)}emplace(e,d,p,_,x){const T=4*e;return this.float32[T+0]=d,this.float32[T+1]=p,this.float32[T+2]=_,this.float32[T+3]=x,e}}Yi.prototype.bytesPerElement=16,Tt(Yi);class xr extends oe{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,d,p,_,x,T,A){const D=this.length;return this.resize(D+1),this.emplace(D,e,d,p,_,x,T,A)}emplace(e,d,p,_,x,T,A,D){const B=8*e,O=4*e;return this.int16[B+0]=d,this.int16[B+1]=p,this.int16[B+2]=_,this.int16[B+3]=x,this.int16[B+4]=T,this.int16[B+5]=A,this.float32[O+3]=D,e}}xr.prototype.bytesPerElement=16,Tt(xr);class vr extends ue{get a_pos_30(){return this._structArray.int16[this._pos2+0]}get a_pos_31(){return this._structArray.int16[this._pos2+1]}get a_pos_32(){return this._structArray.int16[this._pos2+2]}get a_pos_normal_30(){return this._structArray.int16[this._pos2+3]}get a_pos_normal_31(){return this._structArray.int16[this._pos2+4]}get a_pos_normal_32(){return this._structArray.int16[this._pos2+5]}}vr.prototype.size=12;class Ur extends He{get(e){return new vr(this,e)}}Tt(Ur);class cn extends ue{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}cn.prototype.size=40;class En extends Ue{get(e){return new cn(this,e)}}Tt(En);class Fn extends ue{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Fn.prototype.size=60;class Tn extends Ut{get(e){return new Fn(this,e)}}Tt(Tn);class Wi extends ue{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(e){this._structArray.uint32[this._pos4+15]=e}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}Wi.prototype.size=76;class Ki extends Gt{get(e){return new Wi(this,e)}}Tt(Ki);class Di extends St{getoffsetX(e){return this.float32[1*e+0]}}Tt(Di);class rr extends Te{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}Tt(rr);class Vr extends ue{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Vr.prototype.size=12;class Xi extends pi{get(e){return new Vr(this,e)}}Tt(Xi);class Hr extends ue{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0]}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1]}}Hr.prototype.size=4;class hs extends Ft{get(e){return new Hr(this,e)}}Tt(hs);class jr extends ue{get a_pos_30(){return this._structArray.int16[this._pos2+0]}get a_pos_31(){return this._structArray.int16[this._pos2+1]}get a_pos_32(){return this._structArray.int16[this._pos2+2]}get a_pos_normal_30(){return this._structArray.int16[this._pos2+3]}get a_pos_normal_31(){return this._structArray.int16[this._pos2+4]}get a_pos_normal_32(){return this._structArray.int16[this._pos2+5]}get a_scale(){return this._structArray.float32[this._pos4+3]}}jr.prototype.size=16;class to extends xr{get(e){return new jr(this,e)}}Tt(to);const Mc=Me([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),tl=Me([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var To=vs(function(u){u.exports=function(e,d){var p,_,x,T,A,D,B,O;for(_=e.length-(p=3&e.length),x=d,A=3432918353,D=461845907,O=0;O<_;)B=255&e.charCodeAt(O)|(255&e.charCodeAt(++O))<<8|(255&e.charCodeAt(++O))<<16|(255&e.charCodeAt(++O))<<24,++O,x=27492+(65535&(T=5*(65535&(x=(x^=B=(65535&(B=(B=(65535&B)*A+(((B>>>16)*A&65535)<<16)&4294967295)<<15|B>>>17))*D+(((B>>>16)*D&65535)<<16)&4294967295)<<13|x>>>19))+((5*(x>>>16)&65535)<<16)&4294967295))+((58964+(T>>>16)&65535)<<16);switch(B=0,p){case 3:B^=(255&e.charCodeAt(O+2))<<16;case 2:B^=(255&e.charCodeAt(O+1))<<8;case 1:x^=B=(65535&(B=(B=(65535&(B^=255&e.charCodeAt(O)))*A+(((B>>>16)*A&65535)<<16)&4294967295)<<15|B>>>17))*D+(((B>>>16)*D&65535)<<16)&4294967295}return x^=e.length,x=2246822507*(65535&(x^=x>>>16))+((2246822507*(x>>>16)&65535)<<16)&4294967295,x=3266489909*(65535&(x^=x>>>13))+((3266489909*(x>>>16)&65535)<<16)&4294967295,(x^=x>>>16)>>>0}}),bh=vs(function(u){u.exports=function(e,d){for(var p,_=e.length,x=d^_,T=0;_>=4;)p=1540483477*(65535&(p=255&e.charCodeAt(T)|(255&e.charCodeAt(++T))<<8|(255&e.charCodeAt(++T))<<16|(255&e.charCodeAt(++T))<<24))+((1540483477*(p>>>16)&65535)<<16),x=1540483477*(65535&x)+((1540483477*(x>>>16)&65535)<<16)^(p=1540483477*(65535&(p^=p>>>24))+((1540483477*(p>>>16)&65535)<<16)),_-=4,++T;switch(_){case 3:x^=(255&e.charCodeAt(T+2))<<16;case 2:x^=(255&e.charCodeAt(T+1))<<8;case 1:x=1540483477*(65535&(x^=255&e.charCodeAt(T)))+((1540483477*(x>>>16)&65535)<<16)}return x=1540483477*(65535&(x^=x>>>13))+((1540483477*(x>>>16)&65535)<<16),(x^=x>>>15)>>>0}}),On=To,il=bh;On.murmur3=To,On.murmur2=il;class Sc{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,d,p,_){this.ids.push(Au(e)),this.positions.push(d,p,_)}getPositions(e){const d=Au(e);let p=0,_=this.ids.length-1;for(;p<_;){const T=p+_>>1;this.ids[T]>=d?_=T:p=T+1}const x=[];for(;this.ids[p]===d;)x.push({index:this.positions[3*p],start:this.positions[3*p+1],end:this.positions[3*p+2]}),p++;return x}static serialize(e,d){const p=new Float64Array(e.ids),_=new Uint32Array(e.positions);return wh(p,_,0,p.length-1),d&&d.push(p.buffer,_.buffer),{ids:p,positions:_}}static deserialize(e){const d=new Sc;return d.ids=e.ids,d.positions=e.positions,d.indexed=!0,d}}function Au(u){const e=+u;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:On(String(u))}function wh(u,e,d,p){for(;d<p;){const _=u[d+p>>1];let x=d-1,T=p+1;for(;;){do x++;while(u[x]<_);do T--;while(u[T]>_);if(x>=T)break;Ac(u,x,T),Ac(e,3*x,3*T),Ac(e,3*x+1,3*T+1),Ac(e,3*x+2,3*T+2)}T-d<p-T?(wh(u,e,d,T),d=T+1):(wh(u,e,T+1,p),p=T)}}function Ac(u,e,d){const p=u[e];u[e]=u[d],u[d]=p}Tt(Sc);class io{constructor(e,d){this.gl=e.gl,this.location=d}}class Ic extends io{constructor(e,d){super(e,d),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class Iu extends io{constructor(e,d){super(e,d),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class ku extends io{constructor(e,d){super(e,d),this.current=Ci.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const zf=new Float32Array(16),Ff=new Float32Array(9),Of=new Float32Array(4);function Eh(u){return[ae(255*u.r,255*u.g),ae(255*u.b,255*u.a)]}class rl{constructor(e,d,p){this.value=e,this.uniformNames=d.map(_=>`u_${_}`),this.type=p}setUniform(e,d,p){e.set(p.constantOr(this.value))}getBinding(e,d,p){return this.type==="color"?new ku(e,d):new Ic(e,d)}}class Js{constructor(e,d){this.uniformNames=d.map(p=>`u_${p}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,d){this.pixelRatioFrom=d.pixelRatio||1,this.pixelRatioTo=e.pixelRatio||1,this.patternFrom=d.tl.concat(d.br),this.patternTo=e.tl.concat(e.br)}setUniform(e,d,p,_){const x=_==="u_pattern_to"||_==="u_dash_to"?this.patternTo:_==="u_pattern_from"||_==="u_dash_from"?this.patternFrom:_==="u_pixel_ratio_to"?this.pixelRatioTo:_==="u_pixel_ratio_from"?this.pixelRatioFrom:null;x&&e.set(x)}getBinding(e,d,p){return p==="u_pattern_from"||p==="u_pattern_to"||p==="u_dash_from"||p==="u_dash_to"?new Iu(e,d):new Ic(e,d)}}class ro{constructor(e,d,p,_){this.expression=e,this.type=p,this.maxValue=0,this.paintVertexAttributes=d.map(x=>({name:`a_${x}`,type:"Float32",components:p==="color"?2:1,offset:0})),this.paintVertexArray=new _}populatePaintArray(e,d,p,_,x,T){const A=this.paintVertexArray.length,D=this.expression.evaluate(new Vi(0),d,{},x,_,T);this.paintVertexArray.resize(e),this._setPaintValue(A,e,D)}updatePaintArray(e,d,p,_,x){const T=this.expression.evaluate({zoom:0},p,_,void 0,x);this._setPaintValue(e,d,T)}_setPaintValue(e,d,p){if(this.type==="color"){const _=Eh(p);for(let x=e;x<d;x++)this.paintVertexArray.emplace(x,_[0],_[1])}else{for(let _=e;_<d;_++)this.paintVertexArray.emplace(_,p);this.maxValue=Math.max(this.maxValue,Math.abs(p))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Mn{constructor(e,d,p,_,x,T){this.expression=e,this.uniformNames=d.map(A=>`u_${A}_t`),this.type=p,this.useIntegerZoom=_,this.zoom=x,this.maxValue=0,this.paintVertexAttributes=d.map(A=>({name:`a_${A}`,type:"Float32",components:p==="color"?4:2,offset:0})),this.paintVertexArray=new T}populatePaintArray(e,d,p,_,x,T){const A=this.expression.evaluate(new Vi(this.zoom),d,{},x,_,T),D=this.expression.evaluate(new Vi(this.zoom+1),d,{},x,_,T),B=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(B,e,A,D)}updatePaintArray(e,d,p,_,x){const T=this.expression.evaluate({zoom:this.zoom},p,_,void 0,x),A=this.expression.evaluate({zoom:this.zoom+1},p,_,void 0,x);this._setPaintValue(e,d,T,A)}_setPaintValue(e,d,p,_){if(this.type==="color"){const x=Eh(p),T=Eh(_);for(let A=e;A<d;A++)this.paintVertexArray.emplace(A,x[0],x[1],T[0],T[1])}else{for(let x=e;x<d;x++)this.paintVertexArray.emplace(x,p,_);this.maxValue=Math.max(this.maxValue,Math.abs(p),Math.abs(_))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,d){const p=this.useIntegerZoom?Math.floor(d.zoom):d.zoom,_=ge(this.expression.interpolationFactor(p,this.zoom,this.zoom+1),0,1);e.set(_)}getBinding(e,d,p){return new Ic(e,d)}}class Mo{constructor(e,d,p,_,x,T,A){this.expression=e,this.type=p,this.useIntegerZoom=_,this.zoom=x,this.layerId=A,this.paintVertexAttributes=(p==="array"?tl:Mc).members;for(let D=0;D<d.length;++D);this.zoomInPaintVertexArray=new T,this.zoomOutPaintVertexArray=new T}populatePaintArray(e,d,p){const _=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(_,e,d.patterns&&d.patterns[this.layerId],p)}updatePaintArray(e,d,p,_,x,T){this._setPaintValues(e,d,p.patterns&&p.patterns[this.layerId],T)}_setPaintValues(e,d,p,_){if(!_||!p)return;const{min:x,mid:T,max:A}=p,D=_[x],B=_[T],O=_[A];if(D&&B&&O)for(let $=e;$<d;$++)this._setPaintValue(this.zoomInPaintVertexArray,$,B,D),this._setPaintValue(this.zoomOutPaintVertexArray,$,B,O)}_setPaintValue(e,d,p,_){e.emplace(d,p.tl[0],p.tl[1],p.br[0],p.br[1],_.tl[0],_.tl[1],_.br[0],_.br[1],p.pixelRatio,_.pixelRatio)}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class So{constructor(e,d,p=()=>!0){this.binders={},this._buffers=[];const _=[];for(const x in e.paint._values){if(!p(x))continue;const T=e.paint.get(x);if(!(T instanceof I&&_o(T.property.specification)))continue;const A=$f(x,e.type),D=T.value,B=T.property.specification.type,O=T.property.useIntegerZoom,$=T.property.specification["property-type"],V=$==="cross-faded"||$==="cross-faded-data-driven",W=String(x)==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant";if(D.kind!=="constant"||W)if(D.kind==="source"||W||V){const re=Cu(x,B,"source");this.binders[x]=V?new Mo(D,A,B,O,d,re,e.id):new ro(D,A,B,re),_.push(`/a_${x}`)}else{const re=Cu(x,B,"composite");this.binders[x]=new Mn(D,A,B,O,d,re),_.push(`/z_${x}`)}else this.binders[x]=V?new Js(D.value,A):new rl(D.value,A,B),_.push(`/u_${x}`)}this.cacheKey=_.sort().join("")}getMaxValue(e){const d=this.binders[e];return d instanceof ro||d instanceof Mn?d.maxValue:0}populatePaintArrays(e,d,p,_,x,T){for(const A in this.binders){const D=this.binders[A];(D instanceof ro||D instanceof Mn||D instanceof Mo)&&D.populatePaintArray(e,d,p,_,x,T)}}setConstantPatternPositions(e,d){for(const p in this.binders){const _=this.binders[p];_ instanceof Js&&_.setConstantPatternPositions(e,d)}}updatePaintArrays(e,d,p,_,x,T){let A=!1;for(const D in e){const B=d.getPositions(D);for(const O of B){const $=p.feature(O.index);for(const V in this.binders){const W=this.binders[V];if((W instanceof ro||W instanceof Mn||W instanceof Mo)&&W.expression.isStateDependent===!0){const re=_.paint.get(V);W.expression=re.value,W.updatePaintArray(O.start,O.end,$,e[D],x,T),A=!0}}}}return A}defines(){const e=[];for(const d in this.binders){const p=this.binders[d];(p instanceof rl||p instanceof Js)&&e.push(...p.uniformNames.map(_=>`#define HAS_UNIFORM_${_}`))}return e}getBinderAttributes(){const e=[];for(const d in this.binders){const p=this.binders[d];if(p instanceof ro||p instanceof Mn||p instanceof Mo)for(let _=0;_<p.paintVertexAttributes.length;_++)e.push(p.paintVertexAttributes[_].name)}return e}getBinderUniforms(){const e=[];for(const d in this.binders){const p=this.binders[d];if(p instanceof rl||p instanceof Js||p instanceof Mn)for(const _ of p.uniformNames)e.push(_)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,d){const p=[];for(const _ in this.binders){const x=this.binders[_];if(x instanceof rl||x instanceof Js||x instanceof Mn){for(const T of x.uniformNames)if(d[T]){const A=x.getBinding(e,d[T],T);p.push({name:T,property:_,binding:A})}}}return p}setUniforms(e,d,p,_){for(const{name:x,property:T,binding:A}of d)this.binders[T].setUniform(A,_,p.get(T),x)}updatePaintBuffers(e){this._buffers=[];for(const d in this.binders){const p=this.binders[d];if(e&&p instanceof Mo){const _=e.fromScale===2?p.zoomInPaintVertexBuffer:p.zoomOutPaintVertexBuffer;_&&this._buffers.push(_)}else(p instanceof ro||p instanceof Mn)&&p.paintVertexBuffer&&this._buffers.push(p.paintVertexBuffer)}}upload(e){for(const d in this.binders){const p=this.binders[d];(p instanceof ro||p instanceof Mn||p instanceof Mo)&&p.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const d=this.binders[e];(d instanceof ro||d instanceof Mn||d instanceof Mo)&&d.destroy()}}}class us{constructor(e,d,p=()=>!0){this.programConfigurations={};for(const _ of e)this.programConfigurations[_.id]=new So(_,d,p);this.needsUpload=!1,this._featureMap=new Sc,this._bufferOffset=0}populatePaintArrays(e,d,p,_,x,T,A){for(const D in this.programConfigurations)this.programConfigurations[D].populatePaintArrays(e,d,_,x,T,A);d.id!==void 0&&this._featureMap.add(d.id,p,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,d,p,_,x){for(const T of p)this.needsUpload=this.programConfigurations[T.id].updatePaintArrays(e,this._featureMap,d,T,_,x)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const d in this.programConfigurations)this.programConfigurations[d].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const Nf={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function $f(u,e){return Nf[u]||[u.replace(`${e}-`,"").replace(/-/g,"_")]}const Uf={"line-pattern":{source:$e,composite:$e},"fill-pattern":{source:$e,composite:$e},"fill-extrusion-pattern":{source:$e,composite:$e},"line-dasharray":{source:qe,composite:qe}},Vf={color:{source:ki,composite:Yi},number:{source:St,composite:ki}};function Cu(u,e,d){const p=Uf[u];return p&&p[d]||Vf[e][d]}Tt(rl),Tt(Js),Tt(ro),Tt(Mo),Tt(Mn),Tt(So,{omit:["_buffers"]}),Tt(us);const kc="-transition";class Sn extends Yt{constructor(e,d){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,e.type!=="custom"&&(this.metadata=(e=e).metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&e.type!=="sky"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),d.layout&&(this._unevaluatedLayout=new w(d.layout)),d.paint)){this._transitionablePaint=new y(d.paint);for(const p in e.paint)this.setPaintProperty(p,e.paint[p],{validate:!1});for(const p in e.layout)this.setLayoutProperty(p,e.layout[p],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new k(d.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,d,p={}){d!=null&&this._validate(yh,`layers.${this.id}.layout.${e}`,e,d,p)||(e!=="visibility"?this._unevaluatedLayout.setValue(e,d):this.visibility=d)}getPaintProperty(e){return xt(e,kc)?this._transitionablePaint.getTransition(e.slice(0,-kc.length)):this._transitionablePaint.getValue(e)}setPaintProperty(e,d,p={}){if(d!=null&&this._validate(_h,`layers.${this.id}.paint.${e}`,e,d,p))return!1;if(xt(e,kc))return this._transitionablePaint.setTransition(e.slice(0,-kc.length),d||void 0),!1;{const _=this._transitionablePaint._values[e],x=_.property.specification["property-type"]==="cross-faded-data-driven",T=_.value.isDataDriven(),A=_.value;this._transitionablePaint.setValue(e,d),this._handleSpecialPaintPropertyUpdate(e);const D=this._transitionablePaint._values[e].value;return D.isDataDriven()||T||x||this._handleOverridablePaintPropertyUpdate(e,A,D)}}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getProgramConfiguration(e){return null}_handleOverridablePaintPropertyUpdate(e,d,p){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,d){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,d)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,d)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),It(e,(d,p)=>!(d===void 0||p==="layout"&&!Object.keys(d).length||p==="paint"&&!Object.keys(d).length))}_validate(e,d,p,_,x={}){return(!x||x.validate!==!1)&&lc(this,e.call(is,{key:d,layerType:this.type,objectKey:p,value:_,styleSpec:Ne,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const d=this.paint.get(e);if(d instanceof I&&_o(d.property.specification)&&(d.value.kind==="source"||d.value.kind==="composite")&&d.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Bn(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const jf=Me([{name:"a_pos",components:2,type:"Int16"}],4),Gf=Me([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"},{name:"a_scale",components:1,type:"Float32"}]);class Ji{constructor(e=[]){this.segments=e}prepareSegment(e,d,p,_){let x=this.segments[this.segments.length-1];return e>Ji.MAX_VERTEX_ARRAY_LENGTH&&nt(`Max vertices per segment is ${Ji.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!x||x.vertexLength+e>Ji.MAX_VERTEX_ARRAY_LENGTH||x.sortKey!==_)&&(x={vertexOffset:d.length,primitiveOffset:p.length,vertexLength:0,primitiveLength:0},_!==void 0&&(x.sortKey=_),this.segments.push(x)),x}get(){return this.segments}destroy(){for(const e of this.segments)for(const d in e.vaos)e.vaos[d].destroy()}static simpleSegment(e,d,p,_){return new Ji([{vertexOffset:e,primitiveOffset:d,vertexLength:p,primitiveLength:_,vaos:{},sortKey:0}])}}Ji.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Tt(Ji);var di=8192;class Ao{constructor(e,d){e&&(d?this.setSouthWest(e).setNorthEast(d):e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof Oi?new Oi(e.lng,e.lat):Oi.convert(e),this}setSouthWest(e){return this._sw=e instanceof Oi?new Oi(e.lng,e.lat):Oi.convert(e),this}extend(e){const d=this._sw,p=this._ne;let _,x;if(e instanceof Oi)_=e,x=e;else{if(!(e instanceof Ao))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(Ao.convert(e)):this.extend(Oi.convert(e)):this;if(_=e._sw,x=e._ne,!_||!x)return this}return d||p?(d.lng=Math.min(_.lng,d.lng),d.lat=Math.min(_.lat,d.lat),p.lng=Math.max(x.lng,p.lng),p.lat=Math.max(x.lat,p.lat)):(this._sw=new Oi(_.lng,_.lat),this._ne=new Oi(x.lng,x.lat)),this}getCenter(){return new Oi((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Oi(this.getWest(),this.getNorth())}getSouthEast(){return new Oi(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:d,lat:p}=Oi.convert(e);let _=this._sw.lng<=d&&d<=this._ne.lng;return this._sw.lng>this._ne.lng&&(_=this._sw.lng>=d&&d>=this._ne.lng),this._sw.lat<=p&&p<=this._ne.lat&&_}static convert(e){return!e||e instanceof Ao?e:new Ao(e)}}const Th=63710088e-1;class Oi{constructor(e,d){if(isNaN(e)||isNaN(d))throw new Error(`Invalid LngLat object: (${e}, ${d})`);if(this.lng=+e,this.lat=+d,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Oi(ne(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const d=Math.PI/180,p=this.lat*d,_=e.lat*d,x=Math.sin(p)*Math.sin(_)+Math.cos(p)*Math.cos(_)*Math.cos((e.lng-this.lng)*d);return Th*Math.acos(Math.min(x,1))}toBounds(e=0){const d=360*e/40075017,p=d/Math.cos(Math.PI/180*this.lat);return new Ao(new Oi(this.lng-p,this.lat-d),new Oi(this.lng+p,this.lat+d))}static convert(e){if(e instanceof Oi)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Oi(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Oi(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const Du=2*Math.PI*Th;function Mh(u){return Du*Math.cos(u*Math.PI/180)}function nl(u){return(180+u)/360}function Qs(u){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+u*Math.PI/360)))/360}function ea(u,e){return u/Mh(e)}function pn(u){return 360*u-180}function br(u){return 360/Math.PI*Math.atan(Math.exp((180-360*u)*Math.PI/180))-90}function Pu(u,e){return u*Mh(br(e))}const Nn=85.051129;class Cc{constructor(e,d,p=0){this.x=+e,this.y=+d,this.z=+p}static fromLngLat(e,d=0){const p=Oi.convert(e);return new Cc(nl(p.lng),Qs(p.lat),ea(d,p.lat))}toLngLat(){return new Oi(pn(this.x),br(this.y))}toAltitude(){return Pu(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Du*(e=br(this.y),1/Math.cos(e*Math.PI/180));var e}}function Sh(u,e,d,p,_,x,T,A,D){const B=(e+p)/2,O=(d+_)/2,$=new L(B,O);A($),function(V,W,re,se,fe,xe){const Ae=re-fe,Pe=se-xe;return Math.abs((se-W)*Ae-(re-V)*Pe)/Math.hypot(Ae,Pe)}($.x,$.y,x.x,x.y,T.x,T.y)>=D?(Sh(u,e,d,B,O,x,$,A,D),Sh(u,B,O,p,_,$,T,A,D)):u.push(T)}function qf(u,e,d){let p=u[0],_=p.x,x=p.y;e(p);const T=[p];for(let A=1;A<u.length;A++){const D=u[A],{x:B,y:O}=D;e(D),Sh(T,_,x,B,O,p,D,e,d),_=B,x=O,p=D}return T}const Ah=Math.pow(2,14)-1,Bu=-Ah-1;function Zf(u,e){const d=Math.round(u.x*e),p=Math.round(u.y*e);return u.x=ge(d,Bu,Ah),u.y=ge(p,Bu,Ah),(d<u.x||d>u.x+1||p<u.y||p>u.y+1)&&nt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),u}function no(u,e,d){const p=u.loadGeometry(),_=u.extent,x=di/_;if(e&&d&&d.projection.isReprojectedInTileSpace){const T=1<<e.z,{scale:A,x:D,y:B,projection:O}=d,$=V=>{const W=pn((e.x+V.x/_)/T),re=br((e.y+V.y/_)/T),se=O.project(W,re);V.x=(se.x*A-D)*_,V.y=(se.y*A-B)*_};for(let V=0;V<p.length;V++)if(u.type!==1)p[V]=qf(p[V],$,1);else{const W=[];for(const re of p[V])re.x<0||re.x>=_||re.y<0||re.y>=_||($(re),W.push(re));p[V]=W}}for(const T of p)for(const A of T)Zf(A,x);return p}function ds(u,e){return{type:u.type,id:u.id,properties:u.properties,geometry:e?no(u):[]}}function Dc(u,e,d,p,_){u.emplaceBack(2*e+(p+1)/2,2*d+(_+1)/2)}function Pc(u,e,d,p){u.emplaceBack(e.x,e.y,e.z,d[0]*16384,d[1]*16384,d[2]*16384,p)}class Ih{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(d=>d.id),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Ee,this.indexArray=new Ze,this.segments=new Ji,this.programConfigurations=new us(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(d=>d.isStateDependent()).map(d=>d.id)}populate(e,d,p,_){const x=this.layers[0],T=[];let A=null;x.type==="circle"&&(A=x.layout.get("circle-sort-key"));for(const{feature:B,id:O,index:$,sourceLayerIndex:V}of e){const W=this.layers[0]._featureFilter.needGeometry,re=ds(B,W);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),re,p))continue;const se=A?A.evaluate(re,{},p):void 0,fe={id:O,properties:B.properties,type:B.type,sourceLayerIndex:V,index:$,geometry:W?re.geometry:no(B,p,_),patterns:{},sortKey:se};T.push(fe)}A&&T.sort((B,O)=>B.sortKey-O.sortKey);let D=null;_.projection.name==="globe"&&(this.globeExtVertexArray=new to,D=_.projection);for(const B of T){const{geometry:O,index:$,sourceLayerIndex:V}=B,W=e[$].feature;this.addFeature(B,O,$,d.availableImages,p,D),d.featureIndex.insert(W,O,$,V,this.index)}}update(e,d,p,_){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,d,this.stateDependentLayers,p,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,jf.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Gf.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,d,p,_,x,T){for(const A of d)for(const D of A){const B=D.x,O=D.y;if(B<0||B>=di||O<0||O>=di)continue;if(T){const W=T.projectTilePoint(B,O,x),re=T.upVector(x,B,O),se=br((O/di+x.y)/(1<<x.z)),fe=T.pixelsPerMeter(se,1)/ea(1,se),xe=this.globeExtVertexArray;Pc(xe,W,re,fe),Pc(xe,W,re,fe),Pc(xe,W,re,fe),Pc(xe,W,re,fe)}const $=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),V=$.vertexLength;Dc(this.layoutVertexArray,B,O,-1,-1),Dc(this.layoutVertexArray,B,O,1,-1),Dc(this.layoutVertexArray,B,O,1,1),Dc(this.layoutVertexArray,B,O,-1,1),this.indexArray.emplaceBack(V,V+1,V+2),this.indexArray.emplaceBack(V,V+3,V+2),$.vertexLength+=4,$.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,p,{},_,x)}}function Ru(u,e){for(let d=0;d<u.length;d++)if(ta(e,u[d]))return!0;for(let d=0;d<e.length;d++)if(ta(u,e[d]))return!0;return!!kh(u,e)}function Xf(u,e,d){return!!ta(u,e)||!!Ch(e,u,d)}function Lu(u,e){if(u.length===1)return Fu(e,u[0]);for(let d=0;d<e.length;d++){const p=e[d];for(let _=0;_<p.length;_++)if(ta(u,p[_]))return!0}for(let d=0;d<u.length;d++)if(Fu(e,u[d]))return!0;for(let d=0;d<e.length;d++)if(kh(u,e[d]))return!0;return!1}function Yf(u,e,d){if(u.length>1){if(kh(u,e))return!0;for(let p=0;p<e.length;p++)if(Ch(e[p],u,d))return!0}for(let p=0;p<u.length;p++)if(Ch(u[p],e,d))return!0;return!1}function kh(u,e){if(u.length===0||e.length===0)return!1;for(let d=0;d<u.length-1;d++){const p=u[d],_=u[d+1];for(let x=0;x<e.length-1;x++)if(Wf(p,_,e[x],e[x+1]))return!0}return!1}function Wf(u,e,d,p){return mt(u,d,p)!==mt(e,d,p)&&mt(u,e,d)!==mt(u,e,p)}function Ch(u,e,d){const p=d*d;if(e.length===1)return u.distSqr(e[0])<p;for(let _=1;_<e.length;_++)if(zu(u,e[_-1],e[_])<p)return!0;return!1}function zu(u,e,d){const p=e.distSqr(d);if(p===0)return u.distSqr(e);const _=((u.x-e.x)*(d.x-e.x)+(u.y-e.y)*(d.y-e.y))/p;return u.distSqr(_<0?e:_>1?d:d.sub(e)._mult(_)._add(e))}function Fu(u,e){let d,p,_,x=!1;for(let T=0;T<u.length;T++){d=u[T];for(let A=0,D=d.length-1;A<d.length;D=A++)p=d[A],_=d[D],p.y>e.y!=_.y>e.y&&e.x<(_.x-p.x)*(e.y-p.y)/(_.y-p.y)+p.x&&(x=!x)}return x}function ta(u,e){let d=!1;for(let p=0,_=u.length-1;p<u.length;_=p++){const x=u[p],T=u[_];x.y>e.y!=T.y>e.y&&e.x<(T.x-x.x)*(e.y-x.y)/(T.y-x.y)+x.x&&(d=!d)}return d}function Ou(u,e,d,p,_){for(const T of u)if(e<=T.x&&d<=T.y&&p>=T.x&&_>=T.y)return!0;const x=[new L(e,d),new L(e,_),new L(p,_),new L(p,d)];if(u.length>2){for(const T of x)if(ta(u,T))return!0}for(let T=0;T<u.length-1;T++)if(Hf(u[T],u[T+1],x))return!0;return!1}function Hf(u,e,d){const p=d[0],_=d[2];if(u.x<p.x&&e.x<p.x||u.x>_.x&&e.x>_.x||u.y<p.y&&e.y<p.y||u.y>_.y&&e.y>_.y)return!1;const x=mt(u,e,d[0]);return x!==mt(u,e,d[1])||x!==mt(u,e,d[2])||x!==mt(u,e,d[3])}function ia(u,e,d){const p=e.paint.get(u).value;return p.kind==="constant"?p.value:d.programConfigurations.get(e.id).getMaxValue(u)}function Bc(u){return Math.sqrt(u[0]*u[0]+u[1]*u[1])}function Nu(u,e,d,p,_){if(!e[0]&&!e[1])return u;const x=L.convert(e)._mult(_);d==="viewport"&&x._rotate(-p);const T=[];for(let A=0;A<u.length;A++)T.push(u[A].sub(x));return T}function $u(u,e,d,p){const _=L.convert(u)._mult(p);return e==="viewport"&&_._rotate(-d),_}Tt(Ih,{omit:["layers"]});const Kf=new ee({"circle-sort-key":new z(Ne.layout_circle["circle-sort-key"])});var Jf={paint:new ee({"circle-radius":new z(Ne.paint_circle["circle-radius"]),"circle-color":new z(Ne.paint_circle["circle-color"]),"circle-blur":new z(Ne.paint_circle["circle-blur"]),"circle-opacity":new z(Ne.paint_circle["circle-opacity"]),"circle-translate":new P(Ne.paint_circle["circle-translate"]),"circle-translate-anchor":new P(Ne.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new P(Ne.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new P(Ne.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new z(Ne.paint_circle["circle-stroke-width"]),"circle-stroke-color":new z(Ne.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new z(Ne.paint_circle["circle-stroke-opacity"])}),layout:Kf},Dh=1e-6,Kr=typeof Float32Array!="undefined"?Float32Array:Array;function Uu(){var u=new Kr(9);return Kr!=Float32Array&&(u[1]=0,u[2]=0,u[3]=0,u[5]=0,u[6]=0,u[7]=0),u[0]=1,u[4]=1,u[8]=1,u}function $n(u){return u[0]=1,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=1,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u}function Ph(u,e,d){var p=e[0],_=e[1],x=e[2],T=e[3],A=e[4],D=e[5],B=e[6],O=e[7],$=e[8],V=e[9],W=e[10],re=e[11],se=e[12],fe=e[13],xe=e[14],Ae=e[15],Pe=d[0],Re=d[1],ze=d[2],Fe=d[3];return u[0]=Pe*p+Re*A+ze*$+Fe*se,u[1]=Pe*_+Re*D+ze*V+Fe*fe,u[2]=Pe*x+Re*B+ze*W+Fe*xe,u[3]=Pe*T+Re*O+ze*re+Fe*Ae,u[4]=(Pe=d[4])*p+(Re=d[5])*A+(ze=d[6])*$+(Fe=d[7])*se,u[5]=Pe*_+Re*D+ze*V+Fe*fe,u[6]=Pe*x+Re*B+ze*W+Fe*xe,u[7]=Pe*T+Re*O+ze*re+Fe*Ae,u[8]=(Pe=d[8])*p+(Re=d[9])*A+(ze=d[10])*$+(Fe=d[11])*se,u[9]=Pe*_+Re*D+ze*V+Fe*fe,u[10]=Pe*x+Re*B+ze*W+Fe*xe,u[11]=Pe*T+Re*O+ze*re+Fe*Ae,u[12]=(Pe=d[12])*p+(Re=d[13])*A+(ze=d[14])*$+(Fe=d[15])*se,u[13]=Pe*_+Re*D+ze*V+Fe*fe,u[14]=Pe*x+Re*B+ze*W+Fe*xe,u[15]=Pe*T+Re*O+ze*re+Fe*Ae,u}function fs(u,e,d){var p,_,x,T,A,D,B,O,$,V,W,re,se=d[0],fe=d[1],xe=d[2];return e===u?(u[12]=e[0]*se+e[4]*fe+e[8]*xe+e[12],u[13]=e[1]*se+e[5]*fe+e[9]*xe+e[13],u[14]=e[2]*se+e[6]*fe+e[10]*xe+e[14],u[15]=e[3]*se+e[7]*fe+e[11]*xe+e[15]):(_=e[1],x=e[2],T=e[3],A=e[4],D=e[5],B=e[6],O=e[7],$=e[8],V=e[9],W=e[10],re=e[11],u[0]=p=e[0],u[1]=_,u[2]=x,u[3]=T,u[4]=A,u[5]=D,u[6]=B,u[7]=O,u[8]=$,u[9]=V,u[10]=W,u[11]=re,u[12]=p*se+A*fe+$*xe+e[12],u[13]=_*se+D*fe+V*xe+e[13],u[14]=x*se+B*fe+W*xe+e[14],u[15]=T*se+O*fe+re*xe+e[15]),u}function Io(u,e,d){var p=d[0],_=d[1],x=d[2];return u[0]=e[0]*p,u[1]=e[1]*p,u[2]=e[2]*p,u[3]=e[3]*p,u[4]=e[4]*_,u[5]=e[5]*_,u[6]=e[6]*_,u[7]=e[7]*_,u[8]=e[8]*x,u[9]=e[9]*x,u[10]=e[10]*x,u[11]=e[11]*x,u[12]=e[12],u[13]=e[13],u[14]=e[14],u[15]=e[15],u}function Bh(u,e,d){var p=Math.sin(d),_=Math.cos(d),x=e[4],T=e[5],A=e[6],D=e[7],B=e[8],O=e[9],$=e[10],V=e[11];return e!==u&&(u[0]=e[0],u[1]=e[1],u[2]=e[2],u[3]=e[3],u[12]=e[12],u[13]=e[13],u[14]=e[14],u[15]=e[15]),u[4]=x*_+B*p,u[5]=T*_+O*p,u[6]=A*_+$*p,u[7]=D*_+V*p,u[8]=B*_-x*p,u[9]=O*_-T*p,u[10]=$*_-A*p,u[11]=V*_-D*p,u}function Rh(u,e,d){var p=Math.sin(d),_=Math.cos(d),x=e[0],T=e[1],A=e[2],D=e[3],B=e[8],O=e[9],$=e[10],V=e[11];return e!==u&&(u[4]=e[4],u[5]=e[5],u[6]=e[6],u[7]=e[7],u[12]=e[12],u[13]=e[13],u[14]=e[14],u[15]=e[15]),u[0]=x*_-B*p,u[1]=T*_-O*p,u[2]=A*_-$*p,u[3]=D*_-V*p,u[8]=x*p+B*_,u[9]=T*p+O*_,u[10]=A*p+$*_,u[11]=D*p+V*_,u}Math.hypot||(Math.hypot=function(){for(var u=0,e=arguments.length;e--;)u+=arguments[e]*arguments[e];return Math.sqrt(u)});var Qf=Ph;function Lh(){var u=new Kr(3);return Kr!=Float32Array&&(u[0]=0,u[1]=0,u[2]=0),u}function Vu(u){var e=new Kr(3);return e[0]=u[0],e[1]=u[1],e[2]=u[2],e}function ju(u){return Math.hypot(u[0],u[1],u[2])}function ol(u,e,d){var p=new Kr(3);return p[0]=u,p[1]=e,p[2]=d,p}function Gu(u,e,d){return u[0]=e[0]+d[0],u[1]=e[1]+d[1],u[2]=e[2]+d[2],u}function qu(u,e,d){return u[0]=e[0]-d[0],u[1]=e[1]-d[1],u[2]=e[2]-d[2],u}function Zu(u,e,d){return u[0]=e[0]*d[0],u[1]=e[1]*d[1],u[2]=e[2]*d[2],u}function zh(u,e,d){return u[0]=Math.min(e[0],d[0]),u[1]=Math.min(e[1],d[1]),u[2]=Math.min(e[2],d[2]),u}function Fh(u,e,d){return u[0]=Math.max(e[0],d[0]),u[1]=Math.max(e[1],d[1]),u[2]=Math.max(e[2],d[2]),u}function sl(u,e,d){return u[0]=e[0]*d,u[1]=e[1]*d,u[2]=e[2]*d,u}function Oh(u,e,d,p){return u[0]=e[0]+d[0]*p,u[1]=e[1]+d[1]*p,u[2]=e[2]+d[2]*p,u}function al(u,e){var d=e[0],p=e[1],_=e[2],x=d*d+p*p+_*_;return x>0&&(x=1/Math.sqrt(x)),u[0]=e[0]*x,u[1]=e[1]*x,u[2]=e[2]*x,u}function ll(u,e){return u[0]*e[0]+u[1]*e[1]+u[2]*e[2]}function Xu(u,e,d){var p=e[0],_=e[1],x=e[2],T=d[0],A=d[1],D=d[2];return u[0]=_*D-x*A,u[1]=x*T-p*D,u[2]=p*A-_*T,u}function ps(u,e,d){var p=e[0],_=e[1],x=e[2],T=d[3]*p+d[7]*_+d[11]*x+d[15];return u[0]=(d[0]*p+d[4]*_+d[8]*x+d[12])/(T=T||1),u[1]=(d[1]*p+d[5]*_+d[9]*x+d[13])/T,u[2]=(d[2]*p+d[6]*_+d[10]*x+d[14])/T,u}function Yu(u,e,d){var p=d[0],_=d[1],x=d[2],T=e[0],A=e[1],D=e[2],B=_*D-x*A,O=x*T-p*D,$=p*A-_*T,V=_*$-x*O,W=x*B-p*$,re=p*O-_*B,se=2*d[3];return O*=se,$*=se,W*=2,re*=2,u[0]=T+(B*=se)+(V*=2),u[1]=A+O+W,u[2]=D+$+re,u}var cl,ra=qu,ep=Zu,tp=ju;function na(u,e,d){var p=e[0],_=e[1],x=e[2],T=e[3];return u[0]=d[0]*p+d[4]*_+d[8]*x+d[12]*T,u[1]=d[1]*p+d[5]*_+d[9]*x+d[13]*T,u[2]=d[2]*p+d[6]*_+d[10]*x+d[14]*T,u[3]=d[3]*p+d[7]*_+d[11]*x+d[15]*T,u}function Wu(){var u=new Kr(4);return Kr!=Float32Array&&(u[0]=0,u[1]=0,u[2]=0),u[3]=1,u}function Hu(u){return u[0]=0,u[1]=0,u[2]=0,u[3]=1,u}function Ku(u,e,d){d*=.5;var p=e[0],_=e[1],x=e[2],T=e[3],A=Math.sin(d),D=Math.cos(d);return u[0]=p*D+T*A,u[1]=_*D+x*A,u[2]=x*D-_*A,u[3]=T*D-p*A,u}Lh(),cl=new Kr(4),Kr!=Float32Array&&(cl[0]=0,cl[1]=0,cl[2]=0,cl[3]=0),Lh(),ol(1,0,0),ol(0,1,0),Wu(),Wu(),Uu();class Nh{constructor(e,d){this.points=e,this.planes=d}static fromInvProjectionMatrix(e,d,p,_){const x=Math.pow(2,p),T=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(D=>{const B=na([],D,e),O=1/B[3]/d*x;return function($,V,W){return $[0]=V[0]*W[0],$[1]=V[1]*W[1],$[2]=V[2]*W[2],$[3]=V[3]*W[3],$}(B,B,[O,O,_?1/B[3]:O,O])}),A=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(D=>{const B=al([],Xu([],ra([],T[D[0]],T[D[1]]),ra([],T[D[2]],T[D[1]]))),O=-ll(B,T[D[1]]);return B.concat(O)});return new Nh(T,A)}}class hn{constructor(e,d){this.min=e,this.max=d,this.center=sl([],Gu([],this.min,this.max),.5)}quadrant(e){const d=[e%2==0,e<2],p=Vu(this.min),_=Vu(this.max);for(let x=0;x<d.length;x++)p[x]=d[x]?this.min[x]:this.center[x],_[x]=d[x]?this.center[x]:this.max[x];return _[2]=this.max[2],new hn(p,_)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,d=this.max;return[[e[0],e[1],e[2]],[d[0],e[1],e[2]],[d[0],d[1],e[2]],[e[0],d[1],e[2]],[e[0],e[1],d[2]],[d[0],e[1],d[2]],[d[0],d[1],d[2]],[e[0],d[1],d[2]]]}intersects(e){const d=this.getCorners();let p=!0;for(let _=0;_<e.planes.length;_++){const x=e.planes[_];let T=0;for(let A=0;A<d.length;A++)T+=ll(x,d[A])+x[3]>=0;if(T===0)return 0;T!==d.length&&(p=!1)}if(p)return 2;for(let _=0;_<3;_++){let x=Number.MAX_VALUE,T=-Number.MAX_VALUE;for(let A=0;A<e.points.length;A++){const D=e.points[A][_]-this.min[_];x=Math.min(x,D),T=Math.max(T,D)}if(T<0||x>this.max[_]-this.min[_])return 0}return 1}}function Ju(u,e,d,p,_,x,T,A,D){if(x&&u.queryGeometry.isAboveHorizon)return!1;x&&(D*=u.pixelToTileUnitsFactor);for(const B of e)for(const O of B){const $=O.add(A),V=_&&d.elevation?d.elevation.exaggeration()*_.getElevationAt($.x,$.y,!0):0,W=x?$:ip($,V,p),re=x?u.tilespaceRays.map(fe=>np(fe,V)):u.queryGeometry.screenGeometry,se=na([],[O.x,O.y,V,1],p);if(!T&&x?D*=se[3]/d.cameraToCenterDistance:T&&!x&&(D*=d.cameraToCenterDistance/se[3]),Xf(re,W,D))return!0}return!1}function ip(u,e,d){const p=na([],[u.x,u.y,e,1],d);return new L(p[0]/p[3],p[1]/p[3])}const Qu=ol(0,0,0),rp=ol(0,0,1);function np(u,e){const d=Lh();return Qu[2]=e,u.intersectsPlane(Qu,rp,d),new L(d[0],d[1])}class ed extends Ih{}function td(u,{width:e,height:d},p,_){if(_){if(_ instanceof Uint8ClampedArray)_=new Uint8Array(_.buffer);else if(_.length!==e*d*p)throw new RangeError("mismatched image size")}else _=new Uint8Array(e*d*p);return u.width=e,u.height=d,u.data=_,u}function id(u,e,d){const{width:p,height:_}=e;p===u.width&&_===u.height||($h(u,e,{x:0,y:0},{x:0,y:0},{width:Math.min(u.width,p),height:Math.min(u.height,_)},d),u.width=p,u.height=_,u.data=e.data)}function $h(u,e,d,p,_,x){if(_.width===0||_.height===0)return e;if(_.width>u.width||_.height>u.height||d.x>u.width-_.width||d.y>u.height-_.height)throw new RangeError("out of range source coordinates for image copy");if(_.width>e.width||_.height>e.height||p.x>e.width-_.width||p.y>e.height-_.height)throw new RangeError("out of range destination coordinates for image copy");const T=u.data,A=e.data;for(let D=0;D<_.height;D++){const B=((d.y+D)*u.width+d.x)*x,O=((p.y+D)*e.width+p.x)*x;for(let $=0;$<_.width*x;$++)A[O+$]=T[B+$]}return e}Tt(ed,{omit:["layers"]});class oo{constructor(e,d){td(this,e,1,d)}resize(e){id(this,new oo(e),1)}clone(){return new oo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,d,p,_,x){$h(e,d,p,_,x,1)}}class Jr{constructor(e,d){td(this,e,4,d)}resize(e){id(this,new Jr(e),4)}replace(e,d){d?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Jr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,d,p,_,x){$h(e,d,p,_,x,4)}}Tt(oo),Tt(Jr);var op={paint:new ee({"heatmap-radius":new z(Ne.paint_heatmap["heatmap-radius"]),"heatmap-weight":new z(Ne.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new P(Ne.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Z(Ne.paint_heatmap["heatmap-color"]),"heatmap-opacity":new P(Ne.paint_heatmap["heatmap-opacity"])})};function Uh(u){const e={},d=u.resolution||256,p=u.clips?u.clips.length:1,_=u.image||new Jr({width:d,height:p}),x=(T,A,D)=>{e[u.evaluationKey]=D;const B=u.expression.evaluate(e);_.data[T+A+0]=Math.floor(255*B.r/B.a),_.data[T+A+1]=Math.floor(255*B.g/B.a),_.data[T+A+2]=Math.floor(255*B.b/B.a),_.data[T+A+3]=Math.floor(255*B.a)};if(u.clips)for(let T=0,A=0;T<p;++T,A+=4*d)for(let D=0,B=0;D<d;D++,B+=4){const O=D/(d-1),{start:$,end:V}=u.clips[T];x(A,B,$*(1-O)+V*O)}else for(let T=0,A=0;T<d;T++,A+=4)x(0,A,T/(d-1));return _}var sp={paint:new ee({"hillshade-illumination-direction":new P(Ne.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new P(Ne.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new P(Ne.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new P(Ne.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new P(Ne.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new P(Ne.paint_hillshade["hillshade-accent-color"])})};const ap=Me([{name:"a_pos",components:2,type:"Int16"}],4),{members:lp}=ap;var Rc=Lc,cp=Lc;function Lc(u,e,d){d=d||2;var p,_,x,T,A,D,B,O=e&&e.length,$=O?e[0]*d:u.length,V=rd(u,0,$,d,!0),W=[];if(!V||V.next===V.prev)return W;if(O&&(V=function(se,fe,xe,Ae){var Pe,Re,ze,Fe=[];for(Pe=0,Re=fe.length;Pe<Re;Pe++)(ze=rd(se,fe[Pe]*Ae,Pe<Re-1?fe[Pe+1]*Ae:se.length,Ae,!1))===ze.next&&(ze.steiner=!0),Fe.push(_p(ze));for(Fe.sort(pp),Pe=0;Pe<Fe.length;Pe++)xe=ko(xe=mp(Fe[Pe],xe),xe.next);return xe}(u,e,V,d)),u.length>80*d){p=x=u[0],_=T=u[1];for(var re=d;re<$;re+=d)(A=u[re])<p&&(p=A),(D=u[re+1])<_&&(_=D),A>x&&(x=A),D>T&&(T=D);B=(B=Math.max(x-p,T-_))!==0?1/B:0}return hl(V,W,d,p,_,B),W}function rd(u,e,d,p,_){var x,T;if(_===Gh(u,e,d,p)>0)for(x=e;x<d;x+=p)T=sd(x,u[x],u[x+1],T);else for(x=d-p;x>=e;x-=p)T=sd(x,u[x],u[x+1],T);return T&&zc(T,T.next)&&(dl(T),T=T.next),T}function ko(u,e){if(!u)return u;e||(e=u);var d,p=u;do if(d=!1,p.steiner||!zc(p,p.next)&&nr(p.prev,p,p.next)!==0)p=p.next;else{if(dl(p),(p=e=p.prev)===p.next)break;d=!0}while(d||p!==e);return e}function hl(u,e,d,p,_,x,T){if(u){!T&&x&&function(O,$,V,W){var re=O;do re.z===null&&(re.z=Vh(re.x,re.y,$,V,W)),re.prevZ=re.prev,re.nextZ=re.next,re=re.next;while(re!==O);re.prevZ.nextZ=null,re.prevZ=null,function(se){var fe,xe,Ae,Pe,Re,ze,Fe,Xe,We=1;do{for(xe=se,se=null,Re=null,ze=0;xe;){for(ze++,Ae=xe,Fe=0,fe=0;fe<We&&(Fe++,Ae=Ae.nextZ);fe++);for(Xe=We;Fe>0||Xe>0&&Ae;)Fe!==0&&(Xe===0||!Ae||xe.z<=Ae.z)?(Pe=xe,xe=xe.nextZ,Fe--):(Pe=Ae,Ae=Ae.nextZ,Xe--),Re?Re.nextZ=Pe:se=Pe,Pe.prevZ=Re,Re=Pe;xe=Ae}Re.nextZ=null,We*=2}while(ze>1)}(re)}(u,p,_,x);for(var A,D,B=u;u.prev!==u.next;)if(A=u.prev,D=u.next,x?up(u,p,_,x):hp(u))e.push(A.i/d),e.push(u.i/d),e.push(D.i/d),dl(u),u=D.next,B=D.next;else if((u=D)===B){T?T===1?hl(u=dp(ko(u),e,d),e,d,p,_,x,2):T===2&&fp(u,e,d,p,_,x):hl(ko(u),e,d,p,_,x,1);break}}}function hp(u){var e=u.prev,d=u,p=u.next;if(nr(e,d,p)>=0)return!1;for(var _=u.next.next;_!==u.prev;){if(oa(e.x,e.y,d.x,d.y,p.x,p.y,_.x,_.y)&&nr(_.prev,_,_.next)>=0)return!1;_=_.next}return!0}function up(u,e,d,p){var _=u.prev,x=u,T=u.next;if(nr(_,x,T)>=0)return!1;for(var A=_.x>x.x?_.x>T.x?_.x:T.x:x.x>T.x?x.x:T.x,D=_.y>x.y?_.y>T.y?_.y:T.y:x.y>T.y?x.y:T.y,B=Vh(_.x<x.x?_.x<T.x?_.x:T.x:x.x<T.x?x.x:T.x,_.y<x.y?_.y<T.y?_.y:T.y:x.y<T.y?x.y:T.y,e,d,p),O=Vh(A,D,e,d,p),$=u.prevZ,V=u.nextZ;$&&$.z>=B&&V&&V.z<=O;){if($!==u.prev&&$!==u.next&&oa(_.x,_.y,x.x,x.y,T.x,T.y,$.x,$.y)&&nr($.prev,$,$.next)>=0||($=$.prevZ,V!==u.prev&&V!==u.next&&oa(_.x,_.y,x.x,x.y,T.x,T.y,V.x,V.y)&&nr(V.prev,V,V.next)>=0))return!1;V=V.nextZ}for(;$&&$.z>=B;){if($!==u.prev&&$!==u.next&&oa(_.x,_.y,x.x,x.y,T.x,T.y,$.x,$.y)&&nr($.prev,$,$.next)>=0)return!1;$=$.prevZ}for(;V&&V.z<=O;){if(V!==u.prev&&V!==u.next&&oa(_.x,_.y,x.x,x.y,T.x,T.y,V.x,V.y)&&nr(V.prev,V,V.next)>=0)return!1;V=V.nextZ}return!0}function dp(u,e,d){var p=u;do{var _=p.prev,x=p.next.next;!zc(_,x)&&nd(_,p,p.next,x)&&ul(_,x)&&ul(x,_)&&(e.push(_.i/d),e.push(p.i/d),e.push(x.i/d),dl(p),dl(p.next),p=u=x),p=p.next}while(p!==u);return ko(p)}function fp(u,e,d,p,_,x){var T=u;do{for(var A=T.next.next;A!==T.prev;){if(T.i!==A.i&&yp(T,A)){var D=od(T,A);return T=ko(T,T.next),D=ko(D,D.next),hl(T,e,d,p,_,x),void hl(D,e,d,p,_,x)}A=A.next}T=T.next}while(T!==u)}function pp(u,e){return u.x-e.x}function mp(u,e){var d=function(x,T){var A,D=T,B=x.x,O=x.y,$=-1/0;do{if(O<=D.y&&O>=D.next.y&&D.next.y!==D.y){var V=D.x+(O-D.y)*(D.next.x-D.x)/(D.next.y-D.y);if(V<=B&&V>$){if($=V,V===B){if(O===D.y)return D;if(O===D.next.y)return D.next}A=D.x<D.next.x?D:D.next}}D=D.next}while(D!==T);if(!A)return null;if(B===$)return A;var W,re=A,se=A.x,fe=A.y,xe=1/0;D=A;do B>=D.x&&D.x>=se&&B!==D.x&&oa(O<fe?B:$,O,se,fe,O<fe?$:B,O,D.x,D.y)&&(W=Math.abs(O-D.y)/(B-D.x),ul(D,x)&&(W<xe||W===xe&&(D.x>A.x||D.x===A.x&&gp(A,D)))&&(A=D,xe=W)),D=D.next;while(D!==re);return A}(u,e);if(!d)return e;var p=od(d,u),_=ko(d,d.next);return ko(p,p.next),e===d?_:e}function gp(u,e){return nr(u.prev,u,e.prev)<0&&nr(e.next,u,u.next)<0}function Vh(u,e,d,p,_){return(u=1431655765&((u=858993459&((u=252645135&((u=16711935&((u=32767*(u-d)*_)|u<<8))|u<<4))|u<<2))|u<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-p)*_)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function _p(u){var e=u,d=u;do(e.x<d.x||e.x===d.x&&e.y<d.y)&&(d=e),e=e.next;while(e!==u);return d}function oa(u,e,d,p,_,x,T,A){return(_-T)*(e-A)-(u-T)*(x-A)>=0&&(u-T)*(p-A)-(d-T)*(e-A)>=0&&(d-T)*(x-A)-(_-T)*(p-A)>=0}function yp(u,e){return u.next.i!==e.i&&u.prev.i!==e.i&&!function(d,p){var _=d;do{if(_.i!==d.i&&_.next.i!==d.i&&_.i!==p.i&&_.next.i!==p.i&&nd(_,_.next,d,p))return!0;_=_.next}while(_!==d);return!1}(u,e)&&(ul(u,e)&&ul(e,u)&&function(d,p){var _=d,x=!1,T=(d.x+p.x)/2,A=(d.y+p.y)/2;do _.y>A!=_.next.y>A&&_.next.y!==_.y&&T<(_.next.x-_.x)*(A-_.y)/(_.next.y-_.y)+_.x&&(x=!x),_=_.next;while(_!==d);return x}(u,e)&&(nr(u.prev,u,e.prev)||nr(u,e.prev,e))||zc(u,e)&&nr(u.prev,u,u.next)>0&&nr(e.prev,e,e.next)>0)}function nr(u,e,d){return(e.y-u.y)*(d.x-e.x)-(e.x-u.x)*(d.y-e.y)}function zc(u,e){return u.x===e.x&&u.y===e.y}function nd(u,e,d,p){var _=Oc(nr(u,e,d)),x=Oc(nr(u,e,p)),T=Oc(nr(d,p,u)),A=Oc(nr(d,p,e));return _!==x&&T!==A||!(_!==0||!Fc(u,d,e))||!(x!==0||!Fc(u,p,e))||!(T!==0||!Fc(d,u,p))||!(A!==0||!Fc(d,e,p))}function Fc(u,e,d){return e.x<=Math.max(u.x,d.x)&&e.x>=Math.min(u.x,d.x)&&e.y<=Math.max(u.y,d.y)&&e.y>=Math.min(u.y,d.y)}function Oc(u){return u>0?1:u<0?-1:0}function ul(u,e){return nr(u.prev,u,u.next)<0?nr(u,e,u.next)>=0&&nr(u,u.prev,e)>=0:nr(u,e,u.prev)<0||nr(u,u.next,e)<0}function od(u,e){var d=new jh(u.i,u.x,u.y),p=new jh(e.i,e.x,e.y),_=u.next,x=e.prev;return u.next=e,e.prev=u,d.next=_,_.prev=d,p.next=d,d.prev=p,x.next=p,p.prev=x,p}function sd(u,e,d,p){var _=new jh(u,e,d);return p?(_.next=p.next,_.prev=p,p.next.prev=_,p.next=_):(_.prev=_,_.next=_),_}function dl(u){u.next.prev=u.prev,u.prev.next=u.next,u.prevZ&&(u.prevZ.nextZ=u.nextZ),u.nextZ&&(u.nextZ.prevZ=u.prevZ)}function jh(u,e,d){this.i=u,this.x=e,this.y=d,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Gh(u,e,d,p){for(var _=0,x=e,T=d-p;x<d;x+=p)_+=(u[T]-u[x])*(u[x+1]+u[T+1]),T=x;return _}function xp(u,e,d,p,_){ad(u,e,d||0,p||u.length-1,_||vp)}function ad(u,e,d,p,_){for(;p>d;){if(p-d>600){var x=p-d+1,T=e-d+1,A=Math.log(x),D=.5*Math.exp(2*A/3),B=.5*Math.sqrt(A*D*(x-D)/x)*(T-x/2<0?-1:1);ad(u,e,Math.max(d,Math.floor(e-T*D/x+B)),Math.min(p,Math.floor(e+(x-T)*D/x+B)),_)}var O=u[e],$=d,V=p;for(fl(u,d,e),_(u[p],O)>0&&fl(u,d,p);$<V;){for(fl(u,$,V),$++,V--;_(u[$],O)<0;)$++;for(;_(u[V],O)>0;)V--}_(u[d],O)===0?fl(u,d,V):fl(u,++V,p),V<=e&&(d=V+1),e<=V&&(p=V-1)}}function fl(u,e,d){var p=u[e];u[e]=u[d],u[d]=p}function vp(u,e){return u<e?-1:u>e?1:0}function qh(u,e){const d=u.length;if(d<=1)return[u];const p=[];let _,x;for(let T=0;T<d;T++){const A=ft(u[T]);A!==0&&(u[T].area=Math.abs(A),x===void 0&&(x=A<0),x===A<0?(_&&p.push(_),_=[u[T]]):_.push(u[T]))}if(_&&p.push(_),e>1)for(let T=0;T<p.length;T++)p[T].length<=e||(xp(p[T],e,1,p[T].length-1,bp),p[T]=p[T].slice(0,e));return p}function bp(u,e){return e.area-u.area}function Zh(u,e,d){const p=d.patternDependencies;let _=!1;for(const x of e){const T=x.paint.get(`${u}-pattern`);T.isConstant()||(_=!0);const A=T.constantOr(null);A&&(_=!0,p[A.to]=!0,p[A.from]=!0)}return _}function Xh(u,e,d,p,_){const x=_.patternDependencies;for(const T of e){const A=T.paint.get(`${u}-pattern`).value;if(A.kind!=="constant"){let D=A.evaluate({zoom:p-1},d,{},_.availableImages),B=A.evaluate({zoom:p},d,{},_.availableImages),O=A.evaluate({zoom:p+1},d,{},_.availableImages);D=D&&D.name?D.name:D,B=B&&B.name?B.name:B,O=O&&O.name?O.name:O,x[D]=!0,x[B]=!0,x[O]=!0,d.patterns[T.id]={min:D,mid:B,max:O}}}return d}Lc.deviation=function(u,e,d,p){var _=e&&e.length,x=Math.abs(Gh(u,0,_?e[0]*d:u.length,d));if(_)for(var T=0,A=e.length;T<A;T++)x-=Math.abs(Gh(u,e[T]*d,T<A-1?e[T+1]*d:u.length,d));var D=0;for(T=0;T<p.length;T+=3){var B=p[T]*d,O=p[T+1]*d,$=p[T+2]*d;D+=Math.abs((u[B]-u[$])*(u[O+1]-u[B+1])-(u[B]-u[O])*(u[$+1]-u[B+1]))}return x===0&&D===0?0:Math.abs((D-x)/x)},Lc.flatten=function(u){for(var e=u[0][0].length,d={vertices:[],holes:[],dimensions:e},p=0,_=0;_<u.length;_++){for(var x=0;x<u[_].length;x++)for(var T=0;T<e;T++)d.vertices.push(u[_][x][T]);_>0&&d.holes.push(p+=u[_-1].length)}return d},Rc.default=cp;class Nc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(d=>d.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Ee,this.indexArray=new Ze,this.indexArray2=new Ft,this.programConfigurations=new us(e.layers,e.zoom),this.segments=new Ji,this.segments2=new Ji,this.stateDependentLayerIds=this.layers.filter(d=>d.isStateDependent()).map(d=>d.id),this.projection=e.projection}populate(e,d,p,_){this.hasPattern=Zh("fill",this.layers,d);const x=this.layers[0].layout.get("fill-sort-key"),T=[];for(const{feature:A,id:D,index:B,sourceLayerIndex:O}of e){const $=this.layers[0]._featureFilter.needGeometry,V=ds(A,$);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),V,p))continue;const W=x?x.evaluate(V,{},p,d.availableImages):void 0,re={id:D,properties:A.properties,type:A.type,sourceLayerIndex:O,index:B,geometry:$?V.geometry:no(A,p,_),patterns:{},sortKey:W};T.push(re)}x&&T.sort((A,D)=>A.sortKey-D.sortKey);for(const A of T){const{geometry:D,index:B,sourceLayerIndex:O}=A;if(this.hasPattern){const $=Xh("fill",this.layers,A,this.zoom,d);this.patternFeatures.push($)}else this.addFeature(A,D,B,p,{},d.availableImages);d.featureIndex.insert(e[B].feature,D,B,O,this.index)}}update(e,d,p,_){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,d,this.stateDependentLayers,p,_)}addFeatures(e,d,p,_,x){for(const T of this.patternFeatures)this.addFeature(T,T.geometry,T.index,d,p,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,lp),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,d,p,_,x,T=[]){for(const A of qh(d,500)){let D=0;for(const re of A)D+=re.length;const B=this.segments.prepareSegment(D,this.layoutVertexArray,this.indexArray),O=B.vertexLength,$=[],V=[];for(const re of A){if(re.length===0)continue;re!==A[0]&&V.push($.length/2);const se=this.segments2.prepareSegment(re.length,this.layoutVertexArray,this.indexArray2),fe=se.vertexLength;this.layoutVertexArray.emplaceBack(re[0].x,re[0].y),this.indexArray2.emplaceBack(fe+re.length-1,fe),$.push(re[0].x),$.push(re[0].y);for(let xe=1;xe<re.length;xe++)this.layoutVertexArray.emplaceBack(re[xe].x,re[xe].y),this.indexArray2.emplaceBack(fe+xe-1,fe+xe),$.push(re[xe].x),$.push(re[xe].y);se.vertexLength+=re.length,se.primitiveLength+=re.length}const W=Rc($,V);for(let re=0;re<W.length;re+=3)this.indexArray.emplaceBack(O+W[re],O+W[re+1],O+W[re+2]);B.vertexLength+=D,B.primitiveLength+=W.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,p,x,T,_)}}Tt(Nc,{omit:["layers","patternFeatures"]});const wp=new ee({"fill-sort-key":new z(Ne.layout_fill["fill-sort-key"])});var Ep={paint:new ee({"fill-antialias":new P(Ne.paint_fill["fill-antialias"]),"fill-opacity":new z(Ne.paint_fill["fill-opacity"]),"fill-color":new z(Ne.paint_fill["fill-color"]),"fill-outline-color":new z(Ne.paint_fill["fill-outline-color"]),"fill-translate":new P(Ne.paint_fill["fill-translate"]),"fill-translate-anchor":new P(Ne.paint_fill["fill-translate-anchor"]),"fill-pattern":new U(Ne.paint_fill["fill-pattern"])}),layout:wp};const Tp=Me([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Mp=Me([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Sp=Me([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Ap}=Tp;var ld=sa;function sa(u,e,d,p,_){this.properties={},this.extent=d,this.type=0,this._pbf=u,this._geometry=-1,this._keys=p,this._values=_,u.readFields(Ip,this,e)}function Ip(u,e,d){u==1?e.id=d.readVarint():u==2?function(p,_){for(var x=p.readVarint()+p.pos;p.pos<x;){var T=_._keys[p.readVarint()],A=_._values[p.readVarint()];_.properties[T]=A}}(d,e):u==3?e.type=d.readVarint():u==4&&(e._geometry=d.pos)}function kp(u){for(var e,d,p=0,_=0,x=u.length,T=x-1;_<x;T=_++)p+=((d=u[T]).x-(e=u[_]).x)*(e.y+d.y);return p}sa.types=["Unknown","Point","LineString","Polygon"],sa.prototype.loadGeometry=function(){var u=this._pbf;u.pos=this._geometry;for(var e,d=u.readVarint()+u.pos,p=1,_=0,x=0,T=0,A=[];u.pos<d;){if(_<=0){var D=u.readVarint();p=7&D,_=D>>3}if(_--,p===1||p===2)x+=u.readSVarint(),T+=u.readSVarint(),p===1&&(e&&A.push(e),e=[]),e.push(new L(x,T));else{if(p!==7)throw new Error("unknown command "+p);e&&e.push(e[0].clone())}}return e&&A.push(e),A},sa.prototype.bbox=function(){var u=this._pbf;u.pos=this._geometry;for(var e=u.readVarint()+u.pos,d=1,p=0,_=0,x=0,T=1/0,A=-1/0,D=1/0,B=-1/0;u.pos<e;){if(p<=0){var O=u.readVarint();d=7&O,p=O>>3}if(p--,d===1||d===2)(_+=u.readSVarint())<T&&(T=_),_>A&&(A=_),(x+=u.readSVarint())<D&&(D=x),x>B&&(B=x);else if(d!==7)throw new Error("unknown command "+d)}return[T,D,A,B]},sa.prototype.toGeoJSON=function(u,e,d){var p,_,x=this.extent*Math.pow(2,d),T=this.extent*u,A=this.extent*e,D=this.loadGeometry(),B=sa.types[this.type];function O(W){for(var re=0;re<W.length;re++){var se=W[re];W[re]=[360*(se.x+T)/x-180,360/Math.PI*Math.atan(Math.exp((180-360*(se.y+A)/x)*Math.PI/180))-90]}}switch(this.type){case 1:var $=[];for(p=0;p<D.length;p++)$[p]=D[p][0];O(D=$);break;case 2:for(p=0;p<D.length;p++)O(D[p]);break;case 3:for(D=function(W){var re=W.length;if(re<=1)return[W];for(var se,fe,xe=[],Ae=0;Ae<re;Ae++){var Pe=kp(W[Ae]);Pe!==0&&(fe===void 0&&(fe=Pe<0),fe===Pe<0?(se&&xe.push(se),se=[W[Ae]]):se.push(W[Ae]))}return se&&xe.push(se),xe}(D),p=0;p<D.length;p++)for(_=0;_<D[p].length;_++)O(D[p][_])}D.length===1?D=D[0]:B="Multi"+B;var V={type:"Feature",geometry:{type:B,coordinates:D},properties:this.properties};return"id"in this&&(V.id=this.id),V};var cd=hd;function hd(u,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=u,this._keys=[],this._values=[],this._features=[],u.readFields(Cp,this,e),this.length=this._features.length}function Cp(u,e,d){u===15?e.version=d.readVarint():u===1?e.name=d.readString():u===5?e.extent=d.readVarint():u===2?e._features.push(d.pos):u===3?e._keys.push(d.readString()):u===4&&e._values.push(function(p){for(var _=null,x=p.readVarint()+p.pos;p.pos<x;){var T=p.readVarint()>>3;_=T===1?p.readString():T===2?p.readFloat():T===3?p.readDouble():T===4?p.readVarint64():T===5?p.readVarint():T===6?p.readSVarint():T===7?p.readBoolean():null}return _}(d))}function Dp(u,e,d){if(u===3){var p=new cd(d,d.readVarint()+d.pos);p.length&&(e[p.name]=p)}}hd.prototype.feature=function(u){if(u<0||u>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[u];var e=this._pbf.readVarint()+this._pbf.pos;return new ld(this._pbf,e,this.extent,this._keys,this._values)};var ms={VectorTile:function(u,e){this.layers=u.readFields(Dp,{},e)},VectorTileFeature:ld,VectorTileLayer:cd};function $c(u,e,d,p){const _=[],x=p===0?(T,A,D,B,O,$)=>{T.push(new L($,D+($-A)/(B-A)*(O-D)))}:(T,A,D,B,O,$)=>{T.push(new L(A+($-D)/(O-D)*(B-A),$))};for(const T of u){const A=[];for(const D of T){if(D.length<=2)continue;const B=[];for(let V=0;V<D.length-1;V++){const W=D[V].x,re=D[V].y,se=D[V+1].x,fe=D[V+1].y,xe=p===0?W:re,Ae=p===0?se:fe;xe<e?Ae>e&&x(B,W,re,se,fe,e):xe>d?Ae<d&&x(B,W,re,se,fe,d):B.push(D[V]),Ae<e&&xe>=e&&x(B,W,re,se,fe,e),Ae>d&&xe<=d&&x(B,W,re,se,fe,d)}let O=D[D.length-1];const $=p===0?O.x:O.y;$>=e&&$<=d&&B.push(O),B.length&&(O=B[B.length-1],B[0].x===O.x&&B[0].y===O.y||B.push(B[0]),A.push(B))}A.length&&_.push(A)}return _}const Pp=ms.VectorTileFeature.types,Bp=Math.pow(2,13);function pl(u,e,d,p,_,x,T,A){u.emplaceBack((e<<1)+T,(d<<1)+x,(Math.floor(p*Bp)<<1)+_,Math.round(A))}function ml(u,e,d){u.emplaceBack(e.x,e.y,e.z,d[0]*16384,d[1]*16384,d[2]*16384)}class ud{constructor(){this.acc=new L(0,0),this.polyCount=[]}startRing(e){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new L(e.x,e.y),this.max=new L(e.x,e.y))}append(e,d){this.currentPolyCount.edges++,this.acc._add(e);const p=this.min,_=this.max;e.x<p.x?p.x=e.x:e.x>_.x&&(_.x=e.x),e.y<p.y?p.y=e.y:e.y>_.y&&(_.y=e.y),((e.x===0||e.x===di)&&e.x===d.x)!=((e.y===0||e.y===di)&&e.y===d.y)&&this.processBorderOverlap(e,d),d.x<0!=e.x<0&&this.addBorderIntersection(0,Zt(d.y,e.y,(0-d.x)/(e.x-d.x))),d.x>di!=e.x>di&&this.addBorderIntersection(1,Zt(d.y,e.y,(di-d.x)/(e.x-d.x))),d.y<0!=e.y<0&&this.addBorderIntersection(2,Zt(d.x,e.x,(0-d.y)/(e.y-d.y))),d.y>di!=e.y>di&&this.addBorderIntersection(3,Zt(d.x,e.x,(di-d.y)/(e.y-d.y)))}addBorderIntersection(e,d){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const p=this.borders[e];d<p[0]&&(p[0]=d),d>p[1]&&(p[1]=d)}processBorderOverlap(e,d){if(e.x===d.x){if(e.y===d.y)return;const p=e.x===0?0:1;this.addBorderIntersection(p,d.y),this.addBorderIntersection(p,e.y)}else{const p=e.y===0?2:3;this.addBorderIntersection(p,d.x),this.addBorderIntersection(p,e.x)}}centroid(){const e=this.polyCount.reduce((d,p)=>d+p.edges,0);return e!==0?this.acc.div(e)._round():new L(0,0)}span(){return new L(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((e,d)=>e+ +(d[0]!==Number.MAX_VALUE),0)}}class gl{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(d=>d.id),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Se,this.centroidVertexArray=new hs,this.indexArray=new Ze,this.programConfigurations=new us(e.layers,e.zoom),this.segments=new Ji,this.stateDependentLayerIds=this.layers.filter(d=>d.isStateDependent()).map(d=>d.id),this.enableTerrain=e.enableTerrain}populate(e,d,p,_){this.features=[],this.hasPattern=Zh("fill-extrusion",this.layers,d),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=function(x){const T=Math.exp(Math.PI*(1-x.y/(1<<x.z)*2));return 80150034*T/(T*T+1)/di/(1<<x.z)}(p);for(const{feature:x,id:T,index:A,sourceLayerIndex:D}of e){const B=this.layers[0]._featureFilter.needGeometry,O=ds(x,B);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),O,p))continue;const $={id:T,sourceLayerIndex:D,index:A,geometry:B?O.geometry:no(x,p,_),properties:x.properties,type:x.type,patterns:{}},V=this.layoutVertexArray.length;this.hasPattern?this.features.push(Xh("fill-extrusion",this.layers,$,this.zoom,d)):this.addFeature($,$.geometry,A,p,{},d.availableImages,_),d.featureIndex.insert(x,$.geometry,A,D,this.index,V)}this.sortBorders()}addFeatures(e,d,p,_,x){for(const T of this.features){const{geometry:A}=T;this.addFeature(T,A,T.index,d,p,_,x)}this.sortBorders()}update(e,d,p,_){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,d,this.stateDependentLayers,p,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Ap),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,Sp.members,!0))),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.centroidVertexArray.length!==0&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,Mp.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,d,p,_,x,T,A){const D=[new L(0,0),new L(di,di)],B=A.projection,O=B.name==="globe",$=this.enableTerrain&&!O?new ud:null;O&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ur);const V=qh(d,500);for(let se=V.length-1;se>=0;se--){const fe=V[se];(fe.length===0||(W=fe[0]).every(xe=>xe.x<=0)||W.every(xe=>xe.x>=di)||W.every(xe=>xe.y<=0)||W.every(xe=>xe.y>=di))&&V.splice(se,1)}var W;let re;if(O){const fe=1<<_.z,xe=pn(_.x/fe),Ae=pn((_.x+1)/fe),Pe=br(_.y/fe),Re=br((_.y+1)/fe);re=function(ze,Fe,Xe,We,et=0,rt){const Ge=[];if(!ze.length||!Xe||!We)return Ge;const Je=(ri,mi)=>{for(const zt of ri)Ge.push({polygon:zt,bounds:mi})},ot=Math.ceil(Math.log2(Xe)),pt=Math.ceil(Math.log2(We)),at=ot-pt,ut=[];for(let ri=0;ri<Math.abs(at);ri++)ut.push(at>0?0:1);for(let ri=0;ri<Math.min(ot,pt);ri++)ut.push(0),ut.push(1);let ii=ze;if(ii=$c(ii,Fe[0].y-et,Fe[1].y+et,1),ii=$c(ii,Fe[0].x-et,Fe[1].x+et,0),!ii.length)return Ge;const xi=[];for(ut.length?xi.push({polygons:ii,bounds:Fe,depth:0}):Je(ii,Fe);xi.length;){const ri=xi.pop(),mi=ri.depth,zt=ut[mi],wt=ri.bounds[0],bi=ri.bounds[1],Pi=zt===0?wt.x:wt.y,ar=zt===0?bi.x:bi.y,ji=rt?rt(zt,Pi,ar):.5*(Pi+ar),lr=$c(ri.polygons,Pi-et,ji+et,zt),Bi=$c(ri.polygons,ji-et,ar+et,zt);if(lr.length){const Mi=[wt,new L(zt===0?ji:bi.x,zt===1?ji:bi.y)];ut.length>mi+1?xi.push({polygons:lr,bounds:Mi,depth:mi+1}):Je(lr,Mi)}if(Bi.length){const Mi=[new L(zt===0?ji:wt.x,zt===1?ji:wt.y),bi];ut.length>mi+1?xi.push({polygons:Bi,bounds:Mi,depth:mi+1}):Je(Bi,Mi)}}return Ge}(V,D,Math.ceil((Ae-xe)/11.25),Math.ceil((Pe-Re)/11.25),1,(ze,Fe,Xe)=>{if(ze===0)return .5*(Fe+Xe);{const We=br((_.y+Fe/di)/fe);return(Qs(.5*(br((_.y+Xe/di)/fe)+We))*fe-_.y)*di}})}else{re=[];for(const se of V)re.push({polygon:se,bounds:D})}for(const se of re){const fe=se.polygon;let xe=0,Ae=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(let Xe=0;Xe<fe.length;Xe++){const We=fe[Xe];if(We.length===0)continue;xe+=We.length;let et=0;$&&$.startRing(We[0]);for(let rt=0;rt<We.length;rt++){const Ge=We[rt];if(rt>=1){const Je=We[rt-1];if(!Rp(Ge,Je,se.bounds)){$&&$.append(Ge,Je),Ae.vertexLength+4>Ji.MAX_VERTEX_ARRAY_LENGTH&&(Ae=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const ot=Ge.sub(Je)._perp(),pt=ot.x/(Math.abs(ot.x)+Math.abs(ot.y)),at=ot.y>0?1:0,ut=Je.dist(Ge);et+ut>32768&&(et=0),pl(this.layoutVertexArray,Ge.x,Ge.y,pt,at,0,0,et),pl(this.layoutVertexArray,Ge.x,Ge.y,pt,at,0,1,et),et+=ut,pl(this.layoutVertexArray,Je.x,Je.y,pt,at,0,0,et),pl(this.layoutVertexArray,Je.x,Je.y,pt,at,0,1,et);const ii=Ae.vertexLength;if(this.indexArray.emplaceBack(ii,ii+2,ii+1),this.indexArray.emplaceBack(ii+1,ii+2,ii+3),Ae.vertexLength+=4,Ae.primitiveLength+=2,O){const xi=this.layoutVertexExtArray,ri=B.projectTilePoint(Ge.x,Ge.y,_),mi=B.projectTilePoint(Je.x,Je.y,_),zt=B.upVector(_,Ge.x,Ge.y),wt=B.upVector(_,Je.x,Je.y);ml(xi,ri,zt),ml(xi,ri,zt),ml(xi,mi,wt),ml(xi,mi,wt)}}}}}if(Ae.vertexLength+xe>Ji.MAX_VERTEX_ARRAY_LENGTH&&(Ae=this.segments.prepareSegment(xe,this.layoutVertexArray,this.indexArray)),Pp[e.type]!=="Polygon")continue;const Pe=[],Re=[],ze=Ae.vertexLength;for(let Xe=0;Xe<fe.length;Xe++){const We=fe[Xe];if(We.length!==0){We!==fe[0]&&Re.push(Pe.length/2);for(let et=0;et<We.length;et++){const rt=We[et];pl(this.layoutVertexArray,rt.x,rt.y,0,0,1,1,0),Pe.push(rt.x),Pe.push(rt.y),$&&$.currentPolyCount.top++,O&&ml(this.layoutVertexExtArray,B.projectTilePoint(rt.x,rt.y,_),B.upVector(_,rt.x,rt.y))}}}const Fe=Rc(Pe,Re);for(let Xe=0;Xe<Fe.length;Xe+=3)this.indexArray.emplaceBack(ze+Fe[Xe],ze+Fe[Xe+2],ze+Fe[Xe+1]);Ae.primitiveLength+=Fe.length/3,Ae.vertexLength+=xe}if($&&$.polyCount.length>0){if($.borders){$.vertexArrayOffset=this.centroidVertexArray.length;const se=$.borders,fe=this.featuresOnBorder.push($)-1;for(let xe=0;xe<4;xe++)se[xe][0]!==Number.MAX_VALUE&&this.borders[xe].push(fe)}this.encodeCentroid($.borders?void 0:$.centroid(),$)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,p,x,T,_)}sortBorders(){for(let e=0;e<4;e++)this.borders[e].sort((d,p)=>this.featuresOnBorder[d].borders[e][0]-this.featuresOnBorder[p].borders[e][0])}encodeCentroid(e,d,p=!0){let _,x;if(e)if(e.y!==0){const A=d.span()._mult(this.tileToMeter);_=(Math.max(e.x,1)<<3)+Math.min(7,Math.round(A.x/10)),x=(Math.max(e.y,1)<<3)+Math.min(7,Math.round(A.y/10))}else _=Math.ceil(7*(e.x+450)),x=0;else _=0,x=+p;let T=p?this.centroidVertexArray.length:d.vertexArrayOffset;for(const A of d.polyCount){p&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*A.edges+A.top);for(let D=0;D<2*A.edges;D++)this.centroidVertexArray.emplace(T++,0,x),this.centroidVertexArray.emplace(T++,_,x);for(let D=0;D<A.top;D++)this.centroidVertexArray.emplace(T++,_,x)}}}function Rp(u,e,d){return u.x===e.x&&(u.x<d[0].x||u.x>d[1].x)||u.y===e.y&&(u.y<d[0].y||u.y>d[1].y)}Tt(gl,{omit:["layers","features"]}),Tt(ud);var Lp={paint:new ee({"fill-extrusion-opacity":new P(Ne["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new z(Ne["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new P(Ne["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new P(Ne["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new U(Ne["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new z(Ne["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new z(Ne["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new P(Ne["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function _l(u,e){return u.x*e.x+u.y*e.y}function dd(u,e){if(u.length===1){let d=0;const p=e[d++];let _;for(;!_||p.equals(_);)if(_=e[d++],!_)return 1/0;for(;d<e.length;d++){const x=e[d],T=u[0],A=_.sub(p),D=x.sub(p),B=T.sub(p),O=_l(A,A),$=_l(A,D),V=_l(D,D),W=_l(B,A),re=_l(B,D),se=O*V-$*$,fe=(V*W-$*re)/se,xe=(O*re-$*W)/se,Ae=p.z*(1-fe-xe)+_.z*fe+x.z*xe;if(isFinite(Ae))return Ae}return 1/0}{let d=1/0;for(const p of e)d=Math.min(d,p.z);return d}}function fd(u){const e=new L(u[0],u[1]);return e.z=u[2],e}function zp(u,e,d,p,_,x,T,A){const D=T*_.getElevationAt(u,e,!0,!0),B=x[0]!==0,O=B?x[1]===0?T*(x[0]/7-450):T*function($,V,W){const re=Math.floor(V[0]/8),se=Math.floor(V[1]/8),fe=10*(V[0]-8*re),xe=10*(V[1]-8*se),Ae=$.getElevationAt(re,se,!0,!0),Pe=$.getMeterToDEM(W),Re=Math.floor(.5*(fe*Pe-1)),ze=Math.floor(.5*(xe*Pe-1)),Fe=$.tileCoordToPixel(re,se),Xe=2*Re+1,We=2*ze+1,et=function(at,ut,ii,xi,ri){return[at.getElevationAtPixel(ut,ii,!0),at.getElevationAtPixel(ut+ri,ii,!0),at.getElevationAtPixel(ut,ii+ri,!0),at.getElevationAtPixel(ut+xi,ii+ri,!0)]}($,Fe.x-Re,Fe.y-ze,Xe,We),rt=Math.abs(et[0]-et[1]),Ge=Math.abs(et[2]-et[3]),Je=Math.abs(et[0]-et[2])+Math.abs(et[1]-et[3]),ot=Math.min(.25,.5*Pe*(rt+Ge)/Xe),pt=Math.min(.25,.5*Pe*Je/We);return Ae+Math.max(ot*fe,pt*xe)}(_,x,A):D;return{base:D+(d===0)?-1:d,top:B?Math.max(O+p,D+d+2):D+p}}const Fp=Me([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:Op}=Fp,Np=Me([{name:"a_packed",components:3,type:"Float32"}]),{members:$p}=Np,Up=ms.VectorTileFeature.types,Vp=Math.cos(Math.PI/180*37.5);class Uc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(d=>d.id),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(d=>{this.gradients[d.id]={}}),this.layoutVertexArray=new we,this.layoutVertexArray2=new ke,this.indexArray=new Ze,this.programConfigurations=new us(e.layers,e.zoom),this.segments=new Ji,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(d=>d.isStateDependent()).map(d=>d.id)}populate(e,d,p,_){this.hasPattern=Zh("line",this.layers,d);const x=this.layers[0].layout.get("line-sort-key"),T=[];for(const{feature:O,id:$,index:V,sourceLayerIndex:W}of e){const re=this.layers[0]._featureFilter.needGeometry,se=ds(O,re);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),se,p))continue;const fe=x?x.evaluate(se,{},p):void 0,xe={id:$,properties:O.properties,type:O.type,sourceLayerIndex:W,index:V,geometry:re?se.geometry:no(O,p,_),patterns:{},sortKey:fe};T.push(xe)}x&&T.sort((O,$)=>O.sortKey-$.sortKey);const{lineAtlas:A,featureIndex:D}=d,B=this.addConstantDashes(A);for(const O of T){const{geometry:$,index:V,sourceLayerIndex:W}=O;if(B&&this.addFeatureDashes(O,A),this.hasPattern){const re=Xh("line",this.layers,O,this.zoom,d);this.patternFeatures.push(re)}else this.addFeature(O,$,V,p,A.positions,d.availableImages);D.insert(e[V].feature,$,V,W,this.index)}}addConstantDashes(e){let d=!1;for(const p of this.layers){const _=p.paint.get("line-dasharray").value,x=p.layout.get("line-cap").value;if(_.kind!=="constant"||x.kind!=="constant")d=!0;else{const T=x.value,A=_.value;if(!A)continue;e.addDash(A.from,T),e.addDash(A.to,T),A.other&&e.addDash(A.other,T)}}return d}addFeatureDashes(e,d){const p=this.zoom;for(const _ of this.layers){const x=_.paint.get("line-dasharray").value,T=_.layout.get("line-cap").value;if(x.kind==="constant"&&T.kind==="constant")continue;let A,D,B,O,$,V;if(x.kind==="constant"){const fe=x.value;if(!fe)continue;A=fe.other||fe.to,D=fe.to,B=fe.from}else A=x.evaluate({zoom:p-1},e),D=x.evaluate({zoom:p},e),B=x.evaluate({zoom:p+1},e);T.kind==="constant"?O=$=V=T.value:(O=T.evaluate({zoom:p-1},e),$=T.evaluate({zoom:p},e),V=T.evaluate({zoom:p+1},e)),d.addDash(A,O),d.addDash(D,$),d.addDash(B,V);const W=d.getKey(A,O),re=d.getKey(D,$),se=d.getKey(B,V);e.patterns[_.id]={min:W,mid:re,max:se}}}update(e,d,p,_){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,d,this.stateDependentLayers,p,_)}addFeatures(e,d,p,_,x){for(const T of this.patternFeatures)this.addFeature(T,T.geometry,T.index,d,p,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,$p)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Op),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,d,p,_,x,T){const A=this.layers[0].layout,D=A.get("line-join").evaluate(e,{}),B=A.get("line-cap").evaluate(e,{}),O=A.get("line-miter-limit"),$=A.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const V of d)this.addLine(V,e,D,B,O,$);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,p,x,T,_)}addLine(e,d,p,_,x,T){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let xe=0;xe<e.length-1;xe++)this.totalDistance+=e[xe].dist(e[xe+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const A=Up[d.type]==="Polygon";let D=e.length;for(;D>=2&&e[D-1].equals(e[D-2]);)D--;let B=0;for(;B<D-1&&e[B].equals(e[B+1]);)B++;if(D<(A?3:2))return;p==="bevel"&&(x=1.05);const O=this.overscaling<=16?122880/(512*this.overscaling):0,$=this.segments.prepareSegment(10*D,this.layoutVertexArray,this.indexArray);let V,W,re,se,fe;this.e1=this.e2=-1,A&&(V=e[D-2],fe=e[B].sub(V)._unit()._perp());for(let xe=B;xe<D;xe++){if(re=xe===D-1?A?e[B+1]:void 0:e[xe+1],re&&e[xe].equals(re))continue;fe&&(se=fe),V&&(W=V),V=e[xe],fe=re?re.sub(V)._unit()._perp():se,se=se||fe;let Ae=se.add(fe);Ae.x===0&&Ae.y===0||Ae._unit();const Pe=se.x*fe.x+se.y*fe.y,Re=Ae.x*fe.x+Ae.y*fe.y,ze=Re!==0?1/Re:1/0,Fe=2*Math.sqrt(2-2*Re),Xe=Re<Vp&&W&&re,We=se.x*fe.y-se.y*fe.x>0;if(Xe&&xe>B){const Ge=V.dist(W);if(Ge>2*O){const Je=V.sub(V.sub(W)._mult(O/Ge)._round());this.updateDistance(W,Je),this.addCurrentVertex(Je,se,0,0,$),W=Je}}const et=W&&re;let rt=et?p:A?"butt":_;if(et&&rt==="round"&&(ze<T?rt="miter":ze<=2&&(rt="fakeround")),rt==="miter"&&ze>x&&(rt="bevel"),rt==="bevel"&&(ze>2&&(rt="flipbevel"),ze<x&&(rt="miter")),W&&this.updateDistance(W,V),rt==="miter")Ae._mult(ze),this.addCurrentVertex(V,Ae,0,0,$);else if(rt==="flipbevel"){if(ze>100)Ae=fe.mult(-1);else{const Ge=ze*se.add(fe).mag()/se.sub(fe).mag();Ae._perp()._mult(Ge*(We?-1:1))}this.addCurrentVertex(V,Ae,0,0,$),this.addCurrentVertex(V,Ae.mult(-1),0,0,$)}else if(rt==="bevel"||rt==="fakeround"){const Ge=-Math.sqrt(ze*ze-1),Je=We?Ge:0,ot=We?0:Ge;if(W&&this.addCurrentVertex(V,se,Je,ot,$),rt==="fakeround"){const pt=Math.round(180*Fe/Math.PI/20);for(let at=1;at<pt;at++){let ut=at/pt;if(ut!==.5){const xi=ut-.5;ut+=ut*xi*(ut-1)*((1.0904+Pe*(Pe*(3.55645-1.43519*Pe)-3.2452))*xi*xi+(.848013+Pe*(.215638*Pe-1.06021)))}const ii=fe.sub(se)._mult(ut)._add(se)._unit()._mult(We?-1:1);this.addHalfVertex(V,ii.x,ii.y,!1,We,0,$)}}re&&this.addCurrentVertex(V,fe,-Je,-ot,$)}else if(rt==="butt")this.addCurrentVertex(V,Ae,0,0,$);else if(rt==="square"){const Ge=W?1:-1;W||this.addCurrentVertex(V,Ae,Ge,Ge,$),this.addCurrentVertex(V,Ae,0,0,$),W&&this.addCurrentVertex(V,Ae,Ge,Ge,$)}else rt==="round"&&(W&&(this.addCurrentVertex(V,se,0,0,$),this.addCurrentVertex(V,se,1,1,$,!0)),re&&(this.addCurrentVertex(V,fe,-1,-1,$,!0),this.addCurrentVertex(V,fe,0,0,$)));if(Xe&&xe<D-1){const Ge=V.dist(re);if(Ge>2*O){const Je=V.add(re.sub(V)._mult(O/Ge)._round());this.updateDistance(V,Je),this.addCurrentVertex(Je,fe,0,0,$),V=Je}}}}addCurrentVertex(e,d,p,_,x,T=!1){const A=d.y*_-d.x,D=-d.y-d.x*_;this.addHalfVertex(e,d.x+d.y*p,d.y-d.x*p,T,!1,p,x),this.addHalfVertex(e,A,D,T,!0,-_,x)}addHalfVertex({x:e,y:d},p,_,x,T,A,D){this.layoutVertexArray.emplaceBack((e<<1)+(x?1:0),(d<<1)+(T?1:0),Math.round(63*p)+128,Math.round(63*_)+128,1+(A===0?0:A<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineSoFar);const B=D.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,B),D.primitiveLength++),T?this.e2=B:this.e1=B}updateScaledDistance(){if(this.lineClips){const e=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(e,d){this.distance+=e.dist(d),this.updateScaledDistance()}}Tt(Uc,{omit:["layers","patternFeatures"]});const jp=new ee({"line-cap":new z(Ne.layout_line["line-cap"]),"line-join":new z(Ne.layout_line["line-join"]),"line-miter-limit":new P(Ne.layout_line["line-miter-limit"]),"line-round-limit":new P(Ne.layout_line["line-round-limit"]),"line-sort-key":new z(Ne.layout_line["line-sort-key"])});var pd={paint:new ee({"line-opacity":new z(Ne.paint_line["line-opacity"]),"line-color":new z(Ne.paint_line["line-color"]),"line-translate":new P(Ne.paint_line["line-translate"]),"line-translate-anchor":new P(Ne.paint_line["line-translate-anchor"]),"line-width":new z(Ne.paint_line["line-width"]),"line-gap-width":new z(Ne.paint_line["line-gap-width"]),"line-offset":new z(Ne.paint_line["line-offset"]),"line-blur":new z(Ne.paint_line["line-blur"]),"line-dasharray":new U(Ne.paint_line["line-dasharray"]),"line-pattern":new U(Ne.paint_line["line-pattern"]),"line-gradient":new Z(Ne.paint_line["line-gradient"])}),layout:jp};const md=new class extends z{possiblyEvaluate(u,e){return e=new Vi(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,zoomHistory:e.zoomHistory,transition:e.transition}),super.possiblyEvaluate(u,e)}evaluate(u,e,d,p){return e=he({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(u,e,d,p)}}(pd.paint.properties["line-width"].specification);function gd(u,e){return e>0?e+2*u:u}md.useIntegerZoom=!0;const Gp=Me([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"},{name:"a_z_tile_anchor",components:4,type:"Int16"}],4),qp=Me([{name:"a_projected_pos",components:3,type:"Float32"}],4);Me([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Zp=Me([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),Xp=Me([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);Me([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const _d=Me([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Yp=Me([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Me([{name:"triangle",components:3,type:"Uint16"}]),Me([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Me([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),Me([{type:"Float32",name:"offsetX"}]),Me([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var wr=24;const Un=128;function Yh(u,e){const{expression:d}=e;if(d.kind==="constant")return{kind:"constant",layoutSize:d.evaluate(new Vi(u+1))};if(d.kind==="source")return{kind:"source"};{const{zoomStops:p,interpolationType:_}=d;let x=0;for(;x<p.length&&p[x]<=u;)x++;x=Math.max(0,x-1);let T=x;for(;T<p.length&&p[T]<u+1;)T++;T=Math.min(p.length-1,T);const A=p[x],D=p[T];return d.kind==="composite"?{kind:"composite",minZoom:A,maxZoom:D,interpolationType:_}:{kind:"camera",minZoom:A,maxZoom:D,minSize:d.evaluate(new Vi(A)),maxSize:d.evaluate(new Vi(D)),interpolationType:_}}}function Vc(u,{uSize:e,uSizeT:d},{lowerSize:p,upperSize:_}){return u.kind==="source"?p/Un:u.kind==="composite"?Zt(p/Un,_/Un,d):e}function aa(u,e){let d=0,p=0;if(u.kind==="constant")p=u.layoutSize;else if(u.kind!=="source"){const{interpolationType:_,minZoom:x,maxZoom:T}=u,A=_?ge(Or.interpolationFactor(_,e,x,T),0,1):0;u.kind==="camera"?p=Zt(u.minSize,u.maxSize,A):d=A}return{uSizeT:d,uSize:p}}var Wp=Object.freeze({__proto__:null,getSizeData:Yh,evaluateSizeForFeature:Vc,evaluateSizeForZoom:aa,SIZE_PACK_FACTOR:Un});function Hp(u,e,d){return u.sections.forEach(p=>{p.text=function(_,x,T){const A=x.layout.get("text-transform").evaluate(T,{});return A==="uppercase"?_=_.toLocaleUpperCase():A==="lowercase"&&(_=_.toLocaleLowerCase()),Wr.applyArabicShaping&&(_=Wr.applyArabicShaping(_)),_}(p.text,e,d)}),u}const yl={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};function Kp(u){return u==="\uFE36"||u==="\uFE48"||u==="\uFE38"||u==="\uFE44"||u==="\uFE42"||u==="\uFE3E"||u==="\uFE3C"||u==="\uFE3A"||u==="\uFE18"||u==="\uFE40"||u==="\uFE10"||u==="\uFE13"||u==="\uFE14"||u==="\uFF40"||u==="\uFFE3"||u==="\uFE11"||u==="\uFE12"}function Jp(u){return u==="\uFE35"||u==="\uFE47"||u==="\uFE37"||u==="\uFE43"||u==="\uFE41"||u==="\uFE3D"||u==="\uFE3B"||u==="\uFE39"||u==="\uFE17"||u==="\uFE3F"}var yd=function(u,e,d,p,_){var x,T,A=8*_-p-1,D=(1<<A)-1,B=D>>1,O=-7,$=d?_-1:0,V=d?-1:1,W=u[e+$];for($+=V,x=W&(1<<-O)-1,W>>=-O,O+=A;O>0;x=256*x+u[e+$],$+=V,O-=8);for(T=x&(1<<-O)-1,x>>=-O,O+=p;O>0;T=256*T+u[e+$],$+=V,O-=8);if(x===0)x=1-B;else{if(x===D)return T?NaN:1/0*(W?-1:1);T+=Math.pow(2,p),x-=B}return(W?-1:1)*T*Math.pow(2,x-p)},xd=function(u,e,d,p,_,x){var T,A,D,B=8*x-_-1,O=(1<<B)-1,$=O>>1,V=_===23?Math.pow(2,-24)-Math.pow(2,-77):0,W=p?0:x-1,re=p?1:-1,se=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(A=isNaN(e)?1:0,T=O):(T=Math.floor(Math.log(e)/Math.LN2),e*(D=Math.pow(2,-T))<1&&(T--,D*=2),(e+=T+$>=1?V/D:V*Math.pow(2,1-$))*D>=2&&(T++,D/=2),T+$>=O?(A=0,T=O):T+$>=1?(A=(e*D-1)*Math.pow(2,_),T+=$):(A=e*Math.pow(2,$-1)*Math.pow(2,_),T=0));_>=8;u[d+W]=255&A,W+=re,A/=256,_-=8);for(T=T<<_|A,B+=_;B>0;u[d+W]=255&T,W+=re,T/=256,B-=8);u[d+W-re]|=128*se},xl=Ui;function Ui(u){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(u)?u:new Uint8Array(u||0),this.pos=0,this.type=0,this.length=this.buf.length}Ui.Varint=0,Ui.Fixed64=1,Ui.Bytes=2,Ui.Fixed32=5;var Wh=4294967296,vd=1/Wh,bd=typeof TextDecoder=="undefined"?null:new TextDecoder("utf8");function so(u){return u.type===Ui.Bytes?u.readVarint()+u.pos:u.pos+1}function la(u,e,d){return d?4294967296*e+(u>>>0):4294967296*(e>>>0)+(u>>>0)}function wd(u,e,d){var p=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));d.realloc(p);for(var _=d.pos-1;_>=u;_--)d.buf[_+p]=d.buf[_]}function Qp(u,e){for(var d=0;d<u.length;d++)e.writeVarint(u[d])}function em(u,e){for(var d=0;d<u.length;d++)e.writeSVarint(u[d])}function tm(u,e){for(var d=0;d<u.length;d++)e.writeFloat(u[d])}function im(u,e){for(var d=0;d<u.length;d++)e.writeDouble(u[d])}function rm(u,e){for(var d=0;d<u.length;d++)e.writeBoolean(u[d])}function nm(u,e){for(var d=0;d<u.length;d++)e.writeFixed32(u[d])}function om(u,e){for(var d=0;d<u.length;d++)e.writeSFixed32(u[d])}function sm(u,e){for(var d=0;d<u.length;d++)e.writeFixed64(u[d])}function am(u,e){for(var d=0;d<u.length;d++)e.writeSFixed64(u[d])}function jc(u,e){return(u[e]|u[e+1]<<8|u[e+2]<<16)+16777216*u[e+3]}function ca(u,e,d){u[d]=e,u[d+1]=e>>>8,u[d+2]=e>>>16,u[d+3]=e>>>24}function Ed(u,e){return(u[e]|u[e+1]<<8|u[e+2]<<16)+(u[e+3]<<24)}function lm(u,e,d){e.glyphs=[],u===1&&d.readMessage(cm,e)}function cm(u,e,d){if(u===3){const{id:p,bitmap:_,width:x,height:T,left:A,top:D,advance:B}=d.readMessage(hm,{});e.glyphs.push({id:p,bitmap:new oo({width:x+6,height:T+6},_),metrics:{width:x,height:T,left:A,top:D,advance:B}})}else u===4?e.ascender=d.readSVarint():u===5&&(e.descender=d.readSVarint())}function hm(u,e,d){u===1?e.id=d.readVarint():u===2?e.bitmap=d.readBytes():u===3?e.width=d.readVarint():u===4?e.height=d.readVarint():u===5?e.left=d.readSVarint():u===6?e.top=d.readSVarint():u===7&&(e.advance=d.readVarint())}function Hh(u){let e=0,d=0;for(const T of u)e+=T.w*T.h,d=Math.max(d,T.w);u.sort((T,A)=>A.h-T.h);const p=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),d),h:1/0}];let _=0,x=0;for(const T of u)for(let A=p.length-1;A>=0;A--){const D=p[A];if(!(T.w>D.w||T.h>D.h)){if(T.x=D.x,T.y=D.y,x=Math.max(x,T.y+T.h),_=Math.max(_,T.x+T.w),T.w===D.w&&T.h===D.h){const B=p.pop();A<p.length&&(p[A]=B)}else T.h===D.h?(D.x+=T.w,D.w-=T.w):T.w===D.w?(D.y+=T.h,D.h-=T.h):(p.push({x:D.x+T.w,y:D.y,w:D.w-T.w,h:T.h}),D.y+=T.h,D.h-=T.h);break}}return{w:_,h:x,fill:e/(_*x)||0}}Ui.prototype={destroy:function(){this.buf=null},readFields:function(u,e,d){for(d=d||this.length;this.pos<d;){var p=this.readVarint(),_=p>>3,x=this.pos;this.type=7&p,u(_,e,this),this.pos===x&&this.skip(p)}return e},readMessage:function(u,e){return this.readFields(u,e,this.readVarint()+this.pos)},readFixed32:function(){var u=jc(this.buf,this.pos);return this.pos+=4,u},readSFixed32:function(){var u=Ed(this.buf,this.pos);return this.pos+=4,u},readFixed64:function(){var u=jc(this.buf,this.pos)+jc(this.buf,this.pos+4)*Wh;return this.pos+=8,u},readSFixed64:function(){var u=jc(this.buf,this.pos)+Ed(this.buf,this.pos+4)*Wh;return this.pos+=8,u},readFloat:function(){var u=yd(this.buf,this.pos,!0,23,4);return this.pos+=4,u},readDouble:function(){var u=yd(this.buf,this.pos,!0,52,8);return this.pos+=8,u},readVarint:function(u){var e,d,p=this.buf;return e=127&(d=p[this.pos++]),d<128?e:(e|=(127&(d=p[this.pos++]))<<7,d<128?e:(e|=(127&(d=p[this.pos++]))<<14,d<128?e:(e|=(127&(d=p[this.pos++]))<<21,d<128?e:function(_,x,T){var A,D,B=T.buf;if(A=(112&(D=B[T.pos++]))>>4,D<128||(A|=(127&(D=B[T.pos++]))<<3,D<128)||(A|=(127&(D=B[T.pos++]))<<10,D<128)||(A|=(127&(D=B[T.pos++]))<<17,D<128)||(A|=(127&(D=B[T.pos++]))<<24,D<128)||(A|=(1&(D=B[T.pos++]))<<31,D<128))return la(_,A,x);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(d=p[this.pos]))<<28,u,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var u=this.readVarint();return u%2==1?(u+1)/-2:u/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var u=this.readVarint()+this.pos,e=this.pos;return this.pos=u,u-e>=12&&bd?function(d,p,_){return bd.decode(d.subarray(p,_))}(this.buf,e,u):function(d,p,_){for(var x="",T=p;T<_;){var A,D,B,O=d[T],$=null,V=O>239?4:O>223?3:O>191?2:1;if(T+V>_)break;V===1?O<128&&($=O):V===2?(192&(A=d[T+1]))==128&&($=(31&O)<<6|63&A)<=127&&($=null):V===3?(D=d[T+2],(192&(A=d[T+1]))==128&&(192&D)==128&&(($=(15&O)<<12|(63&A)<<6|63&D)<=2047||$>=55296&&$<=57343)&&($=null)):V===4&&(D=d[T+2],B=d[T+3],(192&(A=d[T+1]))==128&&(192&D)==128&&(192&B)==128&&(($=(15&O)<<18|(63&A)<<12|(63&D)<<6|63&B)<=65535||$>=1114112)&&($=null)),$===null?($=65533,V=1):$>65535&&($-=65536,x+=String.fromCharCode($>>>10&1023|55296),$=56320|1023&$),x+=String.fromCharCode($),T+=V}return x}(this.buf,e,u)},readBytes:function(){var u=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,u);return this.pos=u,e},readPackedVarint:function(u,e){if(this.type!==Ui.Bytes)return u.push(this.readVarint(e));var d=so(this);for(u=u||[];this.pos<d;)u.push(this.readVarint(e));return u},readPackedSVarint:function(u){if(this.type!==Ui.Bytes)return u.push(this.readSVarint());var e=so(this);for(u=u||[];this.pos<e;)u.push(this.readSVarint());return u},readPackedBoolean:function(u){if(this.type!==Ui.Bytes)return u.push(this.readBoolean());var e=so(this);for(u=u||[];this.pos<e;)u.push(this.readBoolean());return u},readPackedFloat:function(u){if(this.type!==Ui.Bytes)return u.push(this.readFloat());var e=so(this);for(u=u||[];this.pos<e;)u.push(this.readFloat());return u},readPackedDouble:function(u){if(this.type!==Ui.Bytes)return u.push(this.readDouble());var e=so(this);for(u=u||[];this.pos<e;)u.push(this.readDouble());return u},readPackedFixed32:function(u){if(this.type!==Ui.Bytes)return u.push(this.readFixed32());var e=so(this);for(u=u||[];this.pos<e;)u.push(this.readFixed32());return u},readPackedSFixed32:function(u){if(this.type!==Ui.Bytes)return u.push(this.readSFixed32());var e=so(this);for(u=u||[];this.pos<e;)u.push(this.readSFixed32());return u},readPackedFixed64:function(u){if(this.type!==Ui.Bytes)return u.push(this.readFixed64());var e=so(this);for(u=u||[];this.pos<e;)u.push(this.readFixed64());return u},readPackedSFixed64:function(u){if(this.type!==Ui.Bytes)return u.push(this.readSFixed64());var e=so(this);for(u=u||[];this.pos<e;)u.push(this.readSFixed64());return u},skip:function(u){var e=7&u;if(e===Ui.Varint)for(;this.buf[this.pos++]>127;);else if(e===Ui.Bytes)this.pos=this.readVarint()+this.pos;else if(e===Ui.Fixed32)this.pos+=4;else{if(e!==Ui.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(u,e){this.writeVarint(u<<3|e)},realloc:function(u){for(var e=this.length||16;e<this.pos+u;)e*=2;if(e!==this.length){var d=new Uint8Array(e);d.set(this.buf),this.buf=d,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(u){this.realloc(4),ca(this.buf,u,this.pos),this.pos+=4},writeSFixed32:function(u){this.realloc(4),ca(this.buf,u,this.pos),this.pos+=4},writeFixed64:function(u){this.realloc(8),ca(this.buf,-1&u,this.pos),ca(this.buf,Math.floor(u*vd),this.pos+4),this.pos+=8},writeSFixed64:function(u){this.realloc(8),ca(this.buf,-1&u,this.pos),ca(this.buf,Math.floor(u*vd),this.pos+4),this.pos+=8},writeVarint:function(u){(u=+u||0)>268435455||u<0?function(e,d){var p,_;if(e>=0?(p=e%4294967296|0,_=e/4294967296|0):(_=~(-e/4294967296),4294967295^(p=~(-e%4294967296))?p=p+1|0:(p=0,_=_+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");d.realloc(10),function(x,T,A){A.buf[A.pos++]=127&x|128,x>>>=7,A.buf[A.pos++]=127&x|128,x>>>=7,A.buf[A.pos++]=127&x|128,x>>>=7,A.buf[A.pos++]=127&x|128,A.buf[A.pos]=127&(x>>>=7)}(p,0,d),function(x,T){var A=(7&x)<<4;T.buf[T.pos++]|=A|((x>>>=3)?128:0),x&&(T.buf[T.pos++]=127&x|((x>>>=7)?128:0),x&&(T.buf[T.pos++]=127&x|((x>>>=7)?128:0),x&&(T.buf[T.pos++]=127&x|((x>>>=7)?128:0),x&&(T.buf[T.pos++]=127&x|((x>>>=7)?128:0),x&&(T.buf[T.pos++]=127&x)))))}(_,d)}(u,this):(this.realloc(4),this.buf[this.pos++]=127&u|(u>127?128:0),u<=127||(this.buf[this.pos++]=127&(u>>>=7)|(u>127?128:0),u<=127||(this.buf[this.pos++]=127&(u>>>=7)|(u>127?128:0),u<=127||(this.buf[this.pos++]=u>>>7&127))))},writeSVarint:function(u){this.writeVarint(u<0?2*-u-1:2*u)},writeBoolean:function(u){this.writeVarint(Boolean(u))},writeString:function(u){u=String(u),this.realloc(4*u.length),this.pos++;var e=this.pos;this.pos=function(p,_,x){for(var T,A,D=0;D<_.length;D++){if((T=_.charCodeAt(D))>55295&&T<57344){if(!A){T>56319||D+1===_.length?(p[x++]=239,p[x++]=191,p[x++]=189):A=T;continue}if(T<56320){p[x++]=239,p[x++]=191,p[x++]=189,A=T;continue}T=A-55296<<10|T-56320|65536,A=null}else A&&(p[x++]=239,p[x++]=191,p[x++]=189,A=null);T<128?p[x++]=T:(T<2048?p[x++]=T>>6|192:(T<65536?p[x++]=T>>12|224:(p[x++]=T>>18|240,p[x++]=T>>12&63|128),p[x++]=T>>6&63|128),p[x++]=63&T|128)}return x}(this.buf,u,this.pos);var d=this.pos-e;d>=128&&wd(e,d,this),this.pos=e-1,this.writeVarint(d),this.pos+=d},writeFloat:function(u){this.realloc(4),xd(this.buf,u,this.pos,!0,23,4),this.pos+=4},writeDouble:function(u){this.realloc(8),xd(this.buf,u,this.pos,!0,52,8),this.pos+=8},writeBytes:function(u){var e=u.length;this.writeVarint(e),this.realloc(e);for(var d=0;d<e;d++)this.buf[this.pos++]=u[d]},writeRawMessage:function(u,e){this.pos++;var d=this.pos;u(e,this);var p=this.pos-d;p>=128&&wd(d,p,this),this.pos=d-1,this.writeVarint(p),this.pos+=p},writeMessage:function(u,e,d){this.writeTag(u,Ui.Bytes),this.writeRawMessage(e,d)},writePackedVarint:function(u,e){e.length&&this.writeMessage(u,Qp,e)},writePackedSVarint:function(u,e){e.length&&this.writeMessage(u,em,e)},writePackedBoolean:function(u,e){e.length&&this.writeMessage(u,rm,e)},writePackedFloat:function(u,e){e.length&&this.writeMessage(u,tm,e)},writePackedDouble:function(u,e){e.length&&this.writeMessage(u,im,e)},writePackedFixed32:function(u,e){e.length&&this.writeMessage(u,nm,e)},writePackedSFixed32:function(u,e){e.length&&this.writeMessage(u,om,e)},writePackedFixed64:function(u,e){e.length&&this.writeMessage(u,sm,e)},writePackedSFixed64:function(u,e){e.length&&this.writeMessage(u,am,e)},writeBytesField:function(u,e){this.writeTag(u,Ui.Bytes),this.writeBytes(e)},writeFixed32Field:function(u,e){this.writeTag(u,Ui.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(u,e){this.writeTag(u,Ui.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(u,e){this.writeTag(u,Ui.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(u,e){this.writeTag(u,Ui.Fixed64),this.writeSFixed64(e)},writeVarintField:function(u,e){this.writeTag(u,Ui.Varint),this.writeVarint(e)},writeSVarintField:function(u,e){this.writeTag(u,Ui.Varint),this.writeSVarint(e)},writeStringField:function(u,e){this.writeTag(u,Ui.Bytes),this.writeString(e)},writeFloatField:function(u,e){this.writeTag(u,Ui.Fixed32),this.writeFloat(e)},writeDoubleField:function(u,e){this.writeTag(u,Ui.Fixed64),this.writeDouble(e)},writeBooleanField:function(u,e){this.writeVarintField(u,Boolean(e))}};class Kh{constructor(e,{pixelRatio:d,version:p,stretchX:_,stretchY:x,content:T}){this.paddedRect=e,this.pixelRatio=d,this.stretchX=_,this.stretchY=x,this.content=T,this.version=p}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Td{constructor(e,d){const p={},_={};this.haveRenderCallbacks=[];const x=[];this.addImages(e,p,x),this.addImages(d,_,x);const{w:T,h:A}=Hh(x),D=new Jr({width:T||1,height:A||1});for(const B in e){const O=e[B],$=p[B].paddedRect;Jr.copy(O.data,D,{x:0,y:0},{x:$.x+1,y:$.y+1},O.data)}for(const B in d){const O=d[B],$=_[B].paddedRect,V=$.x+1,W=$.y+1,re=O.data.width,se=O.data.height;Jr.copy(O.data,D,{x:0,y:0},{x:V,y:W},O.data),Jr.copy(O.data,D,{x:0,y:se-1},{x:V,y:W-1},{width:re,height:1}),Jr.copy(O.data,D,{x:0,y:0},{x:V,y:W+se},{width:re,height:1}),Jr.copy(O.data,D,{x:re-1,y:0},{x:V-1,y:W},{width:1,height:se}),Jr.copy(O.data,D,{x:0,y:0},{x:V+re,y:W},{width:1,height:se})}this.image=D,this.iconPositions=p,this.patternPositions=_}addImages(e,d,p){for(const _ in e){const x=e[_],T={x:0,y:0,w:x.data.width+2,h:x.data.height+2};p.push(T),d[_]=new Kh(T,x),x.hasRenderCallback&&this.haveRenderCallbacks.push(_)}}patchUpdatedImages(e,d){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(p=>e.hasImage(p)),e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const p in e.updatedImages)this.patchUpdatedImage(this.iconPositions[p],e.getImage(p),d),this.patchUpdatedImage(this.patternPositions[p],e.getImage(p),d)}patchUpdatedImage(e,d,p){if(!e||!d||e.version===d.version)return;e.version=d.version;const[_,x]=e.tl;p.update(d.data,void 0,{x:_,y:x})}}Tt(Kh),Tt(Td);const un={horizontal:1,vertical:2,horizontalOnly:3};class vl{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,d){const p=new vl;return p.scale=e||1,p.fontStack=d,p}static forImage(e){const d=new vl;return d.imageName=e,d}}class ha{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,d){const p=new ha;for(let _=0;_<e.sections.length;_++){const x=e.sections[_];x.image?p.addImageSection(x):p.addTextSection(x,d)}return p}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCharCode(e){return this.text.charCodeAt(e)}verticalizePunctuation(e){this.text=function(d,p){let _="";for(let x=0;x<d.length;x++){const T=d.charCodeAt(x+1)||null,A=d.charCodeAt(x-1)||null;_+=!p&&(T&&Ws(T)&&!yl[d[x+1]]||A&&Ws(A)&&!yl[d[x-1]])||!yl[d[x]]?d[x]:yl[d[x]]}return _}(this.text,e)}trim(){let e=0;for(let p=0;p<this.text.length&&Gc[this.text.charCodeAt(p)];p++)e++;let d=this.text.length;for(let p=this.text.length-1;p>=0&&p>=e&&Gc[this.text.charCodeAt(p)];p--)d--;this.text=this.text.substring(e,d),this.sectionIndex=this.sectionIndex.slice(e,d)}substring(e,d){const p=new ha;return p.text=this.text.substring(e,d),p.sectionIndex=this.sectionIndex.slice(e,d),p.sections=this.sections,p}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,d)=>Math.max(e,this.sections[d].scale),0)}addTextSection(e,d){this.text+=e.text,this.sections.push(vl.forText(e.scale,e.fontStack||d));const p=this.sections.length-1;for(let _=0;_<e.text.length;++_)this.sectionIndex.push(p)}addImageSection(e){const d=e.image?e.image.name:"";if(d.length===0)return void nt("Can't add FormattedSection with an empty image.");const p=this.getNextImageSectionCharCode();p?(this.text+=String.fromCharCode(p),this.sections.push(vl.forImage(d)),this.sectionIndex.push(this.sections.length-1)):nt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Jh(u,e,d,p,_,x,T,A,D,B,O,$,V,W,re,se){const fe=ha.fromFeature(u,_);let xe;$===un.vertical&&fe.verticalizePunctuation(V);const{processBidirectionalText:Ae,processStyledBidirectionalText:Pe}=Wr;if(Ae&&fe.sections.length===1){xe=[];const Fe=Ae(fe.toString(),Qh(fe,B,x,e,p,W,re));for(const Xe of Fe){const We=new ha;We.text=Xe,We.sections=fe.sections;for(let et=0;et<Xe.length;et++)We.sectionIndex.push(0);xe.push(We)}}else if(Pe){xe=[];const Fe=Pe(fe.text,fe.sectionIndex,Qh(fe,B,x,e,p,W,re));for(const Xe of Fe){const We=new ha;We.text=Xe[0],We.sectionIndex=Xe[1],We.sections=fe.sections,xe.push(We)}}else xe=function(Fe,Xe){const We=[],et=Fe.text;let rt=0;for(const Ge of Xe)We.push(Fe.substring(rt,Ge)),rt=Ge;return rt<et.length&&We.push(Fe.substring(rt,et.length)),We}(fe,Qh(fe,B,x,e,p,W,re));const Re=[],ze={positionedLines:Re,text:fe.toString(),top:O[1],bottom:O[1],left:O[0],right:O[0],writingMode:$,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Fe,Xe,We,et,rt,Ge,Je,ot,pt,at,ut,ii){let xi=0,ri=0,mi=0;const zt=ot==="right"?1:ot==="left"?0:.5;let wt=!1;for(const Bi of rt){const Mi=Bi.getSections();for(const Ni of Mi){if(Ni.imageName)continue;const Hi=Xe[Ni.fontStack];if(Hi&&(wt=Hi.ascender!==void 0&&Hi.descender!==void 0,!wt))break}if(!wt)break}let bi=0;for(const Bi of rt){Bi.trim();const Mi=Bi.getMaxScale(),Ni=(Mi-1)*wr,Hi={positionedGlyphs:[],lineOffset:0};Fe.positionedLines[bi]=Hi;const Qi=Hi.positionedGlyphs;let cr=0;if(!Bi.length()){ri+=Ge,++bi;continue}let dr=0,tn=0;for(let $i=0;$i<Bi.length();$i++){const Cr=Bi.getSection($i),rn=Bi.getSectionIndex($i),_r=Bi.getCharCode($i);let fr=Cr.scale,qi=null,Gi=null,qr=null,Dr=wr,or=0;const Pr=!(pt===un.horizontal||!ut&&!Ys(_r)||ut&&(Gc[_r]||(Pi=_r,hc(Pi)||js(Pi)||ns(Pi)||Wa(Pi)||Zs(Pi))));if(Cr.imageName){const Mr=et[Cr.imageName];if(!Mr)continue;qr=Cr.imageName,Fe.iconsInText=Fe.iconsInText||!0,Gi=Mr.paddedRect;const pr=Mr.displaySize;fr=fr*wr/ii,qi={width:pr[0],height:pr[1],left:1,top:-3,advance:Pr?pr[1]:pr[0],localGlyph:!1},or=wt?-qi.height*fr:Mi*wr-17-pr[1]*fr,Dr=qi.advance;const gn=(Pr?pr[0]:pr[1])*fr-wr*Mi;gn>0&&gn>cr&&(cr=gn)}else{const Mr=We[Cr.fontStack];if(!Mr)continue;Mr[_r]&&(Gi=Mr[_r]);const pr=Xe[Cr.fontStack];if(!pr)continue;const gn=pr.glyphs[_r];if(!gn)continue;if(qi=gn.metrics,Dr=_r!==8203?wr:0,wt){const zo=pr.ascender!==void 0?Math.abs(pr.ascender):0,Cl=pr.descender!==void 0?Math.abs(pr.descender):0,Dl=(zo+Cl)*fr;dr<Dl&&(dr=Dl,tn=(zo-Cl)/2*fr),or=-zo*fr}else or=(Mi-fr)*wr-17}Pr?(Fe.verticalizable=!0,Qi.push({glyph:_r,imageName:qr,x:xi,y:ri+or,vertical:Pr,scale:fr,localGlyph:qi.localGlyph,fontStack:Cr.fontStack,sectionIndex:rn,metrics:qi,rect:Gi}),xi+=Dr*fr+at):(Qi.push({glyph:_r,imageName:qr,x:xi,y:ri+or,vertical:Pr,scale:fr,localGlyph:qi.localGlyph,fontStack:Cr.fontStack,sectionIndex:rn,metrics:qi,rect:Gi}),xi+=qi.advance*fr+at)}Qi.length!==0&&(mi=Math.max(xi-at,mi),wt?kd(Qi,zt,cr,tn,Ge*Mi/2):kd(Qi,zt,cr,0,Ge/2)),xi=0;const Gr=Ge*Mi+cr;Hi.lineOffset=Math.max(cr,Ni),ri+=Gr,++bi}var Pi;const ar=ri,{horizontalAlign:ji,verticalAlign:lr}=eu(Je);(function(Bi,Mi,Ni,Hi,Qi,cr){const dr=(Mi-Ni)*Qi,tn=-cr*Hi;for(const Gr of Bi)for(const $i of Gr.positionedGlyphs)$i.x+=dr,$i.y+=tn})(Fe.positionedLines,zt,ji,lr,mi,ar),Fe.top+=-lr*ar,Fe.bottom=Fe.top+ar,Fe.left+=-ji*mi,Fe.right=Fe.left+mi,Fe.hasBaseline=wt}(ze,e,d,p,xe,T,A,D,$,B,V,se),!function(Fe){for(const Xe of Fe)if(Xe.positionedGlyphs.length!==0)return!1;return!0}(Re)&&ze}const Gc={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},um={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Md(u,e,d,p,_,x){if(e.imageName){const T=p[e.imageName];return T?T.displaySize[0]*e.scale*wr/x+_:0}{const T=d[e.fontStack],A=T&&T.glyphs[u];return A?A.metrics.advance*e.scale+_:0}}function Sd(u,e,d,p){const _=Math.pow(u-e,2);return p?u<e?_/2:2*_:_+Math.abs(d)*d}function dm(u,e,d){let p=0;return u===10&&(p-=1e4),d&&(p+=150),u!==40&&u!==65288||(p+=50),e!==41&&e!==65289||(p+=50),p}function Ad(u,e,d,p,_,x){let T=null,A=Sd(e,d,_,x);for(const D of p){const B=Sd(e-D.x,d,_,x)+D.badness;B<=A&&(T=D,A=B)}return{index:u,x:e,priorBreak:T,badness:A}}function Id(u){return u?Id(u.priorBreak).concat(u.index):[]}function Qh(u,e,d,p,_,x,T){if(x!=="point")return[];if(!u)return[];const A=[],D=function(V,W,re,se,fe,xe){let Ae=0;for(let Pe=0;Pe<V.length();Pe++){const Re=V.getSection(Pe);Ae+=Md(V.getCharCode(Pe),Re,se,fe,W,xe)}return Ae/Math.max(1,Math.ceil(Ae/re))}(u,e,d,p,_,T),B=u.text.indexOf("\u200B")>=0;let O=0;for(let V=0;V<u.length();V++){const W=u.getSection(V),re=u.getCharCode(V);if(Gc[re]||(O+=Md(re,W,p,_,e,T)),V<u.length()-1){const se=!(($=re)<11904||!(fc($)||dc($)||bo($)||ss($)||gc($)||qa($)||pc($)||Gs($)||_c($)||Ya($)||mc($)||Ha($)||os($)||Za($)||uc($)||Xa($)||qs($)||bc($)||xc($)||yc($)));(um[re]||se||W.imageName)&&A.push(Ad(V+1,O,D,A,dm(re,u.getCharCode(V+1),se&&B),!1))}}var $;return Id(Ad(u.length(),O,D,A,0,!0))}function eu(u){let e=.5,d=.5;switch(u){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(u){case"bottom":case"bottom-right":case"bottom-left":d=1;break;case"top":case"top-right":case"top-left":d=0}return{horizontalAlign:e,verticalAlign:d}}function kd(u,e,d,p,_){if(!(e||d||p||_))return;const x=u.length-1,T=u[x],A=(T.x+T.metrics.advance*T.scale)*e;for(let D=0;D<=x;D++)u[D].x-=A,u[D].y+=d+p+_}function fm(u,e,d){const{horizontalAlign:p,verticalAlign:_}=eu(d),x=e[0]-u.displaySize[0]*p,T=e[1]-u.displaySize[1]*_;return{image:u,top:T,bottom:T+u.displaySize[1],left:x,right:x+u.displaySize[0]}}function Cd(u,e,d,p,_,x){const T=u.image;let A;if(T.content){const fe=T.content,xe=T.pixelRatio||1;A=[fe[0]/xe,fe[1]/xe,T.displaySize[0]-fe[2]/xe,T.displaySize[1]-fe[3]/xe]}const D=e.left*x,B=e.right*x;let O,$,V,W;d==="width"||d==="both"?(W=_[0]+D-p[3],$=_[0]+B+p[1]):(W=_[0]+(D+B-T.displaySize[0])/2,$=W+T.displaySize[0]);const re=e.top*x,se=e.bottom*x;return d==="height"||d==="both"?(O=_[1]+re-p[0],V=_[1]+se+p[2]):(O=_[1]+(re+se-T.displaySize[1])/2,V=O+T.displaySize[1]),{image:T,top:O,right:$,bottom:V,left:W,collisionPadding:A}}class ao extends L{constructor(e,d,p,_,x){super(e,d),this.angle=_,this.z=p,x!==void 0&&(this.segment=x)}clone(){return new ao(this.x,this.y,this.z,this.angle,this.segment)}}function Dd(u,e,d,p,_){if(e.segment===void 0)return!0;let x=e,T=e.segment+1,A=0;for(;A>-d/2;){if(T--,T<0)return!1;A-=u[T].dist(x),x=u[T]}A+=u[T].dist(u[T+1]),T++;const D=[];let B=0;for(;A<d/2;){const O=u[T],$=u[T+1];if(!$)return!1;let V=u[T-1].angleTo(O)-O.angleTo($);for(V=Math.abs((V+3*Math.PI)%(2*Math.PI)-Math.PI),D.push({distance:A,angleDelta:V}),B+=V;A-D[0].distance>p;)B-=D.shift().angleDelta;if(B>_)return!1;T++,A+=O.dist($)}return!0}function Pd(u){let e=0;for(let d=0;d<u.length-1;d++)e+=u[d].dist(u[d+1]);return e}function Bd(u,e,d){return u?.6*e*d:0}function Rd(u,e){return Math.max(u?u.right-u.left:0,e?e.right-e.left:0)}function pm(u,e,d,p,_,x){const T=Bd(d,_,x),A=Rd(d,p)*x;let D=0;const B=Pd(u)/2;for(let O=0;O<u.length-1;O++){const $=u[O],V=u[O+1],W=$.dist(V);if(D+W>B){const re=(B-D)/W,se=Zt($.x,V.x,re),fe=Zt($.y,V.y,re),xe=new ao(se,fe,0,V.angleTo($),O);return!T||Dd(u,xe,A,T,e)?xe:void 0}D+=W}}function mm(u,e,d,p,_,x,T,A,D){const B=Bd(p,x,T),O=Rd(p,_),$=O*T,V=u[0].x===0||u[0].x===D||u[0].y===0||u[0].y===D;return e-$<e/4&&(e=$+e/4),Ld(u,V?e/2*A%e:(O/2+2*x)*T*A%e,e,B,d,$,V,!1,D)}function Ld(u,e,d,p,_,x,T,A,D){const B=x/2,O=Pd(u);let $=0,V=e-d,W=[];for(let re=0;re<u.length-1;re++){const se=u[re],fe=u[re+1],xe=se.dist(fe),Ae=fe.angleTo(se);for(;V+d<$+xe;){V+=d;const Pe=(V-$)/xe,Re=Zt(se.x,fe.x,Pe),ze=Zt(se.y,fe.y,Pe);if(Re>=0&&Re<D&&ze>=0&&ze<D&&V-B>=0&&V+B<=O){const Fe=new ao(Re,ze,0,Ae,re);Fe._round(),p&&!Dd(u,Fe,x,p,_)||W.push(Fe)}}$+=xe}return A||W.length||T||(W=Ld(u,$/2,d,p,_,x,T,!0,D)),W}function zd(u,e,d,p,_){const x=[];for(let T=0;T<u.length;T++){const A=u[T];let D;for(let B=0;B<A.length-1;B++){let O=A[B],$=A[B+1];O.x<e&&$.x<e||(O.x<e?O=new L(e,O.y+(e-O.x)/($.x-O.x)*($.y-O.y))._round():$.x<e&&($=new L(e,O.y+(e-O.x)/($.x-O.x)*($.y-O.y))._round()),O.y<d&&$.y<d||(O.y<d?O=new L(O.x+(d-O.y)/($.y-O.y)*($.x-O.x),d)._round():$.y<d&&($=new L(O.x+(d-O.y)/($.y-O.y)*($.x-O.x),d)._round()),O.x>=p&&$.x>=p||(O.x>=p?O=new L(p,O.y+(p-O.x)/($.x-O.x)*($.y-O.y))._round():$.x>=p&&($=new L(p,O.y+(p-O.x)/($.x-O.x)*($.y-O.y))._round()),O.y>=_&&$.y>=_||(O.y>=_?O=new L(O.x+(_-O.y)/($.y-O.y)*($.x-O.x),_)._round():$.y>=_&&($=new L(O.x+(_-O.y)/($.y-O.y)*($.x-O.x),_)._round()),D&&O.equals(D[D.length-1])||(D=[O],x.push(D)),D.push($)))))}}return x}Tt(ao);const bl=1e20;function Fd(u,e,d,p,_,x,T,A,D){for(let B=e;B<e+p;B++)Od(u,d*x+B,x,_,T,A,D);for(let B=d;B<d+_;B++)Od(u,B*x+e,1,p,T,A,D)}function Od(u,e,d,p,_,x,T){x[0]=0,T[0]=-bl,T[1]=bl,_[0]=u[e];for(let A=1,D=0,B=0;A<p;A++){_[A]=u[e+A*d];const O=A*A;do{const $=x[D];B=(_[A]-_[$]+O-$*$)/(A-$)/2}while(B<=T[D]&&--D>-1);D++,x[D]=A,T[D]=B,T[D+1]=bl}for(let A=0,D=0;A<p;A++){for(;T[D+1]<A;)D++;const B=x[D],O=A-B;u[e+A*d]=_[B]+O*O}}const tu={none:0,ideographs:1,all:2};class ua{constructor(e,d,p){this.requestManager=e,this.localGlyphMode=d,this.localFontFamily=p,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,d){const p=[];for(const _ in e)for(const x of e[_])p.push({stack:_,id:x});ve(p,({stack:_,id:x},T)=>{let A=this.entries[_];A||(A=this.entries[_]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let D=A.glyphs[x];if(D!==void 0)return void T(null,{stack:_,id:x,glyph:D});if(D=this._tinySDF(A,_,x),D)return A.glyphs[x]=D,void T(null,{stack:_,id:x,glyph:D});const B=Math.floor(x/256);if(256*B>65535)return void T(new Error("glyphs > 65535 not supported"));if(A.ranges[B])return void T(null,{stack:_,id:x,glyph:D});let O=A.requests[B];O||(O=A.requests[B]=[],ua.loadGlyphRange(_,B,this.url,this.requestManager,($,V)=>{if(V){A.ascender=V.ascender,A.descender=V.descender;for(const W in V.glyphs)this._doesCharSupportLocalGlyph(+W)||(A.glyphs[+W]=V.glyphs[+W]);A.ranges[B]=!0}for(const W of O)W($,V);delete A.requests[B]})),O.push(($,V)=>{$?T($):V&&T(null,{stack:_,id:x,glyph:V.glyphs[x]||null})})},(_,x)=>{if(_)d(_);else if(x){const T={};for(const{stack:A,id:D,glyph:B}of x)T[A]===void 0&&(T[A]={}),T[A].glyphs===void 0&&(T[A].glyphs={}),T[A].glyphs[D]=B&&{id:B.id,bitmap:B.bitmap.clone(),metrics:B.metrics},T[A].ascender=this.entries[A].ascender,T[A].descender=this.entries[A].descender;d(null,T)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==tu.none&&(this.localGlyphMode===tu.all?!!this.localFontFamily:!!this.localFontFamily&&(Ya(e)||vc(e)||os(e)||qs(e)||Gs(e)))}_tinySDF(e,d,p){const _=this.localFontFamily;if(!_||!this._doesCharSupportLocalGlyph(p))return;let x=e.tinySDF;if(!x){let se="400";/bold/i.test(d)?se="900":/medium/i.test(d)?se="500":/light/i.test(d)&&(se="200"),x=e.tinySDF=new ua.TinySDF({fontFamily:_,fontWeight:se,fontSize:48,buffer:6,radius:16}),x.fontWeight=se}if(this.localGlyphs[x.fontWeight][p])return this.localGlyphs[x.fontWeight][p];const T=String.fromCharCode(p),{data:A,width:D,height:B,glyphWidth:O,glyphHeight:$,glyphLeft:V,glyphTop:W,glyphAdvance:re}=x.draw(T);return this.localGlyphs[x.fontWeight][p]={id:p,bitmap:new oo({width:D,height:B},A),metrics:{width:O/2,height:$/2,left:V/2,top:W/2-27,advance:re/2,localGlyph:!0}}}}function Nd(u,e,d,p){const _=[],x=u.image,T=x.pixelRatio,A=x.paddedRect.w-2,D=x.paddedRect.h-2,B=u.right-u.left,O=u.bottom-u.top,$=x.stretchX||[[0,A]],V=x.stretchY||[[0,D]],W=(Ge,Je)=>Ge+Je[1]-Je[0],re=$.reduce(W,0),se=V.reduce(W,0),fe=A-re,xe=D-se;let Ae=0,Pe=re,Re=0,ze=se,Fe=0,Xe=fe,We=0,et=xe;if(x.content&&p){const Ge=x.content;Ae=qc($,0,Ge[0]),Re=qc(V,0,Ge[1]),Pe=qc($,Ge[0],Ge[2]),ze=qc(V,Ge[1],Ge[3]),Fe=Ge[0]-Ae,We=Ge[1]-Re,Xe=Ge[2]-Ge[0]-Pe,et=Ge[3]-Ge[1]-ze}const rt=(Ge,Je,ot,pt)=>{const at=Zc(Ge.stretch-Ae,Pe,B,u.left),ut=Xc(Ge.fixed-Fe,Xe,Ge.stretch,re),ii=Zc(Je.stretch-Re,ze,O,u.top),xi=Xc(Je.fixed-We,et,Je.stretch,se),ri=Zc(ot.stretch-Ae,Pe,B,u.left),mi=Xc(ot.fixed-Fe,Xe,ot.stretch,re),zt=Zc(pt.stretch-Re,ze,O,u.top),wt=Xc(pt.fixed-We,et,pt.stretch,se),bi=new L(at,ii),Pi=new L(ri,ii),ar=new L(ri,zt),ji=new L(at,zt),lr=new L(ut/T,xi/T),Bi=new L(mi/T,wt/T),Mi=e*Math.PI/180;if(Mi){const Qi=Math.sin(Mi),cr=Math.cos(Mi),dr=[cr,-Qi,Qi,cr];bi._matMult(dr),Pi._matMult(dr),ji._matMult(dr),ar._matMult(dr)}const Ni=Ge.stretch+Ge.fixed,Hi=Je.stretch+Je.fixed;return{tl:bi,tr:Pi,bl:ji,br:ar,tex:{x:x.paddedRect.x+1+Ni,y:x.paddedRect.y+1+Hi,w:ot.stretch+ot.fixed-Ni,h:pt.stretch+pt.fixed-Hi},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:lr,pixelOffsetBR:Bi,minFontScaleX:Xe/T/B,minFontScaleY:et/T/O,isSDF:d}};if(p&&(x.stretchX||x.stretchY)){const Ge=$d($,fe,re),Je=$d(V,xe,se);for(let ot=0;ot<Ge.length-1;ot++){const pt=Ge[ot],at=Ge[ot+1];for(let ut=0;ut<Je.length-1;ut++)_.push(rt(pt,Je[ut],at,Je[ut+1]))}}else _.push(rt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:A+1},{fixed:0,stretch:D+1}));return _}function qc(u,e,d){let p=0;for(const _ of u)p+=Math.max(e,Math.min(d,_[1]))-Math.max(e,Math.min(d,_[0]));return p}function $d(u,e,d){const p=[{fixed:-1,stretch:0}];for(const[_,x]of u){const T=p[p.length-1];p.push({fixed:_-T.stretch,stretch:T.stretch}),p.push({fixed:_-T.stretch,stretch:T.stretch+(x-_)})}return p.push({fixed:e+1,stretch:d}),p}function Zc(u,e,d,p){return u/e*d+p}function Xc(u,e,d,p){return u-e*d/p}function gm(u,e,d,p){const _=e+u.positionedLines[p].lineOffset;return p===0?d+_/2:d+(_+(e+u.positionedLines[p-1].lineOffset))/2}ua.loadGlyphRange=function(u,e,d,p,_){const x=256*e,T=x+255,A=p.transformRequest(p.normalizeGlyphsURL(d).replace("{fontstack}",u).replace("{range}",`${x}-${T}`),J.Glyphs);pe(A,(D,B)=>{if(D)_(D);else if(B){const O={},$=function(V){return new xl(V).readFields(lm,{})}(B);for(const V of $.glyphs)O[V.id]=V;_(null,{glyphs:O,ascender:$.ascender,descender:$.descender})}})},ua.TinySDF=class{constructor({fontSize:u=24,buffer:e=3,radius:d=8,cutoff:p=.25,fontFamily:_="sans-serif",fontWeight:x="normal",fontStyle:T="normal"}){this.buffer=e,this.cutoff=p,this.radius=d;const A=this.size=u+4*e,D=this._createCanvas(A),B=this.ctx=D.getContext("2d",{willReadFrequently:!0});B.font=`${T} ${x} ${u}px ${_}`,B.textBaseline="alphabetic",B.textAlign="left",B.fillStyle="black",this.gridOuter=new Float64Array(A*A),this.gridInner=new Float64Array(A*A),this.f=new Float64Array(A),this.z=new Float64Array(A+1),this.v=new Uint16Array(A)}_createCanvas(u){const e=document.createElement("canvas");return e.width=e.height=u,e}draw(u){const{width:e,actualBoundingBoxAscent:d,actualBoundingBoxDescent:p,actualBoundingBoxLeft:_,actualBoundingBoxRight:x}=this.ctx.measureText(u),T=Math.floor(d),A=Math.min(this.size-this.buffer,Math.ceil(x-_)),D=Math.min(this.size-this.buffer,Math.ceil(d)+Math.ceil(p)),B=A+2*this.buffer,O=D+2*this.buffer,$=B*O,V=new Uint8ClampedArray($),W={data:V,width:B,height:O,glyphWidth:A,glyphHeight:D,glyphTop:T,glyphLeft:0,glyphAdvance:e};if(A===0||D===0)return W;const{ctx:re,buffer:se,gridInner:fe,gridOuter:xe}=this;re.clearRect(se,se,A,D),re.fillText(u,se,se+T+1);const Ae=re.getImageData(se,se,A,D);xe.fill(bl,0,$),fe.fill(0,0,$);for(let Pe=0;Pe<D;Pe++)for(let Re=0;Re<A;Re++){const ze=Ae.data[4*(Pe*A+Re)+3]/255;if(ze===0)continue;const Fe=(Pe+se)*B+Re+se;if(ze===1)xe[Fe]=0,fe[Fe]=bl;else{const Xe=.5-ze;xe[Fe]=Xe>0?Xe*Xe:0,fe[Fe]=Xe<0?Xe*Xe:0}}Fd(xe,0,0,B,O,B,this.f,this.v,this.z),Fd(fe,se,se,A,D,B,this.f,this.v,this.z);for(let Pe=0;Pe<$;Pe++){const Re=Math.sqrt(xe[Pe])-Math.sqrt(fe[Pe]);V[Pe]=Math.round(255-255*(Re/this.radius+this.cutoff))}return W}};class _m{constructor(e=[],d=ym){if(this.data=e,this.length=this.data.length,this.compare=d,this.length>0)for(let p=(this.length>>1)-1;p>=0;p--)this._down(p)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],d=this.data.pop();return this.length--,this.length>0&&(this.data[0]=d,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:d,compare:p}=this,_=d[e];for(;e>0;){const x=e-1>>1,T=d[x];if(p(_,T)>=0)break;d[e]=T,e=x}d[e]=_}_down(e){const{data:d,compare:p}=this,_=this.length>>1,x=d[e];for(;e<_;){let T=1+(e<<1),A=d[T];const D=T+1;if(D<this.length&&p(d[D],A)<0&&(T=D,A=d[D]),p(A,x)>=0)break;d[e]=A,e=T}d[e]=x}}function ym(u,e){return u<e?-1:u>e?1:0}function xm(u,e=1,d=!1){let p=1/0,_=1/0,x=-1/0,T=-1/0;const A=u[0];for(let W=0;W<A.length;W++){const re=A[W];(!W||re.x<p)&&(p=re.x),(!W||re.y<_)&&(_=re.y),(!W||re.x>x)&&(x=re.x),(!W||re.y>T)&&(T=re.y)}const D=Math.min(x-p,T-_);let B=D/2;const O=new _m([],vm);if(D===0)return new L(p,_);for(let W=p;W<x;W+=D)for(let re=_;re<T;re+=D)O.push(new da(W+B,re+B,B,u));let $=function(W){let re=0,se=0,fe=0;const xe=W[0];for(let Ae=0,Pe=xe.length,Re=Pe-1;Ae<Pe;Re=Ae++){const ze=xe[Ae],Fe=xe[Re],Xe=ze.x*Fe.y-Fe.x*ze.y;se+=(ze.x+Fe.x)*Xe,fe+=(ze.y+Fe.y)*Xe,re+=3*Xe}return new da(se/re,fe/re,0,W)}(u),V=O.length;for(;O.length;){const W=O.pop();(W.d>$.d||!$.d)&&($=W,d&&console.log("found best %d after %d probes",Math.round(1e4*W.d)/1e4,V)),W.max-$.d<=e||(B=W.h/2,O.push(new da(W.p.x-B,W.p.y-B,B,u)),O.push(new da(W.p.x+B,W.p.y-B,B,u)),O.push(new da(W.p.x-B,W.p.y+B,B,u)),O.push(new da(W.p.x+B,W.p.y+B,B,u)),V+=4)}return d&&(console.log(`num probes: ${V}`),console.log(`best distance: ${$.d}`)),$.p}function vm(u,e){return e.max-u.max}function da(u,e,d,p){this.p=new L(u,e),this.h=d,this.d=function(_,x){let T=!1,A=1/0;for(let D=0;D<x.length;D++){const B=x[D];for(let O=0,$=B.length,V=$-1;O<$;V=O++){const W=B[O],re=B[V];W.y>_.y!=re.y>_.y&&_.x<(re.x-W.x)*(_.y-W.y)/(re.y-W.y)+W.x&&(T=!T),A=Math.min(A,zu(_,W,re))}}return(T?1:-1)*Math.sqrt(A)}(this.p,p),this.max=this.d+this.h*Math.SQRT2}const iu=Number.POSITIVE_INFINITY,bm=Math.sqrt(2);function Ud(u,e){return e[1]!==iu?function(d,p,_){let x=0,T=0;switch(p=Math.abs(p),_=Math.abs(_),d){case"top-right":case"top-left":case"top":T=_-7;break;case"bottom-right":case"bottom-left":case"bottom":T=7-_}switch(d){case"top-right":case"bottom-right":case"right":x=-p;break;case"top-left":case"bottom-left":case"left":x=p}return[x,T]}(u,e[0],e[1]):function(d,p){let _=0,x=0;p<0&&(p=0);const T=p/bm;switch(d){case"top-right":case"top-left":x=T-7;break;case"bottom-right":case"bottom-left":x=7-T;break;case"bottom":x=7-p;break;case"top":x=p-7}switch(d){case"top-right":case"bottom-right":_=-T;break;case"top-left":case"bottom-left":_=T;break;case"left":_=p;break;case"right":_=-p}return[_,x]}(u,e[0])}function wm(u,e,d,p,_,x,T,A,D,B){u.createArrays(),u.tilePixelRatio=di/(512*u.overscaling),u.compareText={},u.iconsNeedLinear=!1;const O=u.layers[0].layout,$=u.layers[0]._unevaluatedLayout._values,V={};if(u.textSizeData.kind==="composite"){const{minZoom:se,maxZoom:fe}=u.textSizeData;V.compositeTextSizes=[$["text-size"].possiblyEvaluate(new Vi(se),A),$["text-size"].possiblyEvaluate(new Vi(fe),A)]}if(u.iconSizeData.kind==="composite"){const{minZoom:se,maxZoom:fe}=u.iconSizeData;V.compositeIconSizes=[$["icon-size"].possiblyEvaluate(new Vi(se),A),$["icon-size"].possiblyEvaluate(new Vi(fe),A)]}V.layoutTextSize=$["text-size"].possiblyEvaluate(new Vi(D+1),A),V.layoutIconSize=$["icon-size"].possiblyEvaluate(new Vi(D+1),A),V.textMaxSize=$["text-size"].possiblyEvaluate(new Vi(18),A);const W=O.get("text-rotation-alignment")==="map"&&O.get("symbol-placement")!=="point",re=O.get("text-size");for(const se of u.features){const fe=O.get("text-font").evaluate(se,{},A).join(","),xe=re.evaluate(se,{},A),Ae=V.layoutTextSize.evaluate(se,{},A),Pe=(V.layoutIconSize.evaluate(se,{},A),{horizontal:{},vertical:void 0}),Re=se.text;let ze,Fe=[0,0];if(Re){const et=Re.toString(),rt=O.get("text-letter-spacing").evaluate(se,{},A)*wr,Ge=O.get("text-line-height").evaluate(se,{},A)*wr,Je=Ec(et)?rt:0,ot=O.get("text-anchor").evaluate(se,{},A),pt=O.get("text-variable-anchor");if(!pt){const mi=O.get("text-radial-offset").evaluate(se,{},A);Fe=mi?Ud(ot,[mi*wr,iu]):O.get("text-offset").evaluate(se,{},A).map(zt=>zt*wr)}let at=W?"center":O.get("text-justify").evaluate(se,{},A);const ut=O.get("symbol-placement"),ii=ut==="point",xi=ut==="point"?O.get("text-max-width").evaluate(se,{},A)*wr:0,ri=mi=>{u.allowVerticalPlacement&&Xs(et)&&(Pe.vertical=Jh(Re,e,d,_,fe,xi,Ge,ot,mi,Je,Fe,un.vertical,!0,ut,Ae,xe))};if(!W&&pt){const mi=at==="auto"?pt.map(wt=>ru(wt)):[at];let zt=!1;for(let wt=0;wt<mi.length;wt++){const bi=mi[wt];if(!Pe.horizontal[bi])if(zt)Pe.horizontal[bi]=Pe.horizontal[0];else{const Pi=Jh(Re,e,d,_,fe,xi,Ge,"center",bi,Je,Fe,un.horizontal,!1,ut,Ae,xe);Pi&&(Pe.horizontal[bi]=Pi,zt=Pi.positionedLines.length===1)}}ri("left")}else{if(at==="auto"&&(at=ru(ot)),ii||O.get("text-writing-mode").indexOf("horizontal")>=0||!Xs(et)){const mi=Jh(Re,e,d,_,fe,xi,Ge,ot,at,Je,Fe,un.horizontal,!1,ut,Ae,xe);mi&&(Pe.horizontal[at]=mi)}ri(ut==="point"?"left":at)}}let Xe=!1;if(se.icon&&se.icon.name){const et=p[se.icon.name];et&&(ze=fm(_[se.icon.name],O.get("icon-offset").evaluate(se,{},A),O.get("icon-anchor").evaluate(se,{},A)),Xe=et.sdf,u.sdfIcons===void 0?u.sdfIcons=et.sdf:u.sdfIcons!==et.sdf&&nt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(et.pixelRatio!==u.pixelRatio||O.get("icon-rotate").constantOr(1)!==0)&&(u.iconsNeedLinear=!0))}const We=jd(Pe.horizontal)||Pe.vertical;u.iconsInText||(u.iconsInText=!!We&&We.iconsInText),(We||ze)&&Em(u,se,Pe,ze,p,V,Ae,0,Fe,Xe,T,A,B)}x&&u.generateCollisionDebugBuffers(D,u.collisionBoxArray)}function ru(u){switch(u){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Em(u,e,d,p,_,x,T,A,D,B,O,$,V){let W=x.textMaxSize.evaluate(e,{},$);W===void 0&&(W=T);const re=u.layers[0].layout,se=re.get("icon-offset").evaluate(e,{},$),fe=jd(d.horizontal)||d.vertical,xe=T/24,Ae=u.tilePixelRatio*W/24,Pe=(Ge=u.overscaling,u.zoom>18&&Ge>2&&(Ge>>=1),Math.max(di/(512*Ge),1)*re.get("symbol-spacing")),Re=re.get("text-padding")*u.tilePixelRatio,ze=re.get("icon-padding")*u.tilePixelRatio,Fe=K(re.get("text-max-angle")),Xe=re.get("text-rotation-alignment")==="map"&&re.get("symbol-placement")!=="point",We=re.get("icon-rotation-alignment")==="map"&&re.get("symbol-placement")!=="point",et=re.get("symbol-placement"),rt=Pe/2;var Ge;const Je=re.get("icon-text-fit");let ot;p&&Je!=="none"&&(u.allowVerticalPlacement&&d.vertical&&(ot=Cd(p,d.vertical,Je,re.get("icon-text-fit-padding"),se,xe)),fe&&(p=Cd(p,fe,Je,re.get("icon-text-fit-padding"),se,xe)));const pt=(at,ut,ii)=>{if(ut.x<0||ut.x>=di||ut.y<0||ut.y>=di)return;const{x:xi,y:ri,z:mi}=V.projectTilePoint(ut.x,ut.y,ii),zt=new ao(xi,ri,mi,0,void 0);(function(wt,bi,Pi,ar,ji,lr,Bi,Mi,Ni,Hi,Qi,cr,dr,tn,Gr,$i,Cr,rn,_r,fr,qi,Gi,qr,Dr,or){const Pr=wt.addToLineVertexArray(bi,ar);let Mr,pr,gn,zo,Cl,Dl,Sf,Af=0,If=0,kf=0,Cf=0,vu=-1,bu=-1;const qn={};let Df=On(""),wu=0,Eu=0;if(Ni._unevaluatedLayout.getValue("text-radial-offset")===void 0?[wu,Eu]=Ni.layout.get("text-offset").evaluate(qi,{},or).map(nn=>nn*wr):(wu=Ni.layout.get("text-radial-offset").evaluate(qi,{},or)*wr,Eu=iu),wt.allowVerticalPlacement&&ji.vertical){const nn=ji.vertical;if(Gr)Dl=nu(nn),Mi&&(Sf=nu(Mi));else{const on=Ni.layout.get("text-rotate").evaluate(qi,{},or)+90;gn=Yc(Hi,Pi,bi,Qi,cr,dr,nn,tn,on,$i),Mi&&(zo=Yc(Hi,Pi,bi,Qi,cr,dr,Mi,rn,on))}}if(lr){const nn=Ni.layout.get("icon-rotate").evaluate(qi,{},or),on=Ni.layout.get("icon-text-fit")!=="none",Pl=Nd(lr,nn,qr,on),Mu=Mi?Nd(Mi,nn,qr,on):void 0;pr=Yc(Hi,Pi,bi,Qi,cr,dr,lr,rn,nn),Af=4*Pl.length;const Pf=wt.iconSizeData;let ys=null;Pf.kind==="source"?(ys=[Un*Ni.layout.get("icon-size").evaluate(qi,{},or)],ys[0]>Co&&nt(`${wt.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Pf.kind==="composite"&&(ys=[Un*Gi.compositeIconSizes[0].evaluate(qi,{},or),Un*Gi.compositeIconSizes[1].evaluate(qi,{},or)],(ys[0]>Co||ys[1]>Co)&&nt(`${wt.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),wt.addSymbols(wt.icon,Pl,ys,fr,_r,qi,!1,Pi,bi,Pr.lineStartIndex,Pr.lineLength,-1,Dr,or),vu=wt.icon.placedSymbolArray.length-1,Mu&&(If=4*Mu.length,wt.addSymbols(wt.icon,Mu,ys,fr,_r,qi,un.vertical,Pi,bi,Pr.lineStartIndex,Pr.lineLength,-1,Dr,or),bu=wt.icon.placedSymbolArray.length-1)}for(const nn in ji.horizontal){const on=ji.horizontal[nn];Mr||(Df=On(on.text),Gr?Cl=nu(on):Mr=Yc(Hi,Pi,bi,Qi,cr,dr,on,tn,Ni.layout.get("text-rotate").evaluate(qi,{},or),$i));const Pl=on.positionedLines.length===1;if(kf+=Vd(wt,Pi,bi,on,Bi,Ni,Gr,qi,$i,Pr,ji.vertical?un.horizontal:un.horizontalOnly,Pl?Object.keys(ji.horizontal):[nn],qn,vu,Gi,Dr,or),Pl)break}ji.vertical&&(Cf+=Vd(wt,Pi,bi,ji.vertical,Bi,Ni,Gr,qi,$i,Pr,un.vertical,["vertical"],qn,bu,Gi,Dr,or));let Fo=-1;const Tu=(nn,on)=>nn?Math.max(nn,on):on;Fo=Tu(Cl,Fo),Fo=Tu(Dl,Fo),Fo=Tu(Sf,Fo);const rg=Fo>-1?1:0;wt.glyphOffsetArray.length>=Do.MAX_GLYPHS&&nt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),qi.sortKey!==void 0&&wt.addToSortKeyRanges(wt.symbolInstances.length,qi.sortKey),wt.symbolInstances.emplaceBack(Pi.x,Pi.y,Pi.z,bi.x,bi.y,qn.right>=0?qn.right:-1,qn.center>=0?qn.center:-1,qn.left>=0?qn.left:-1,qn.vertical>=0?qn.vertical:-1,vu,bu,Df,Mr!==void 0?Mr:wt.collisionBoxArray.length,Mr!==void 0?Mr+1:wt.collisionBoxArray.length,gn!==void 0?gn:wt.collisionBoxArray.length,gn!==void 0?gn+1:wt.collisionBoxArray.length,pr!==void 0?pr:wt.collisionBoxArray.length,pr!==void 0?pr+1:wt.collisionBoxArray.length,zo||wt.collisionBoxArray.length,zo?zo+1:wt.collisionBoxArray.length,Qi,kf,Cf,Af,If,rg,0,wu,Eu,Fo)})(u,ut,zt,at,d,p,_,ot,u.layers[0],u.collisionBoxArray,e.index,e.sourceLayerIndex,u.index,Re,Xe,D,0,ze,We,se,e,x,B,O,$)};if(et==="line")for(const at of zd(e.geometry,0,0,di,di)){const ut=mm(at,Pe,Fe,d.vertical||fe,p,24,Ae,u.overscaling,di);for(const ii of ut){const xi=fe;xi&&Tm(u,xi.text,rt,ii)||pt(at,ii,$)}}else if(et==="line-center"){for(const at of e.geometry)if(at.length>1){const ut=pm(at,Fe,d.vertical||fe,p,24,Ae);ut&&pt(at,ut,$)}}else if(e.type==="Polygon")for(const at of qh(e.geometry,0)){const ut=xm(at,16);pt(at[0],new ao(ut.x,ut.y,0,0,void 0),$)}else if(e.type==="LineString")for(const at of e.geometry)pt(at,new ao(at[0].x,at[0].y,0,0,void 0),$);else if(e.type==="Point")for(const at of e.geometry)for(const ut of at)pt([ut],new ao(ut.x,ut.y,0,0,void 0),$)}const Co=32640;function Vd(u,e,d,p,_,x,T,A,D,B,O,$,V,W,re,se,fe){const xe=function(Re,ze,Fe,Xe,We,et,rt,Ge){const Je=[];if(ze.positionedLines.length===0)return Je;const ot=Xe.layout.get("text-rotate").evaluate(et,{})*Math.PI/180,pt=function(ri){const mi=ri[0],zt=ri[1],wt=mi*zt;return wt>0?[mi,-zt]:wt<0?[-mi,zt]:mi===0?[zt,mi]:[zt,-mi]}(Fe);let at=Math.abs(ze.top-ze.bottom);for(const ri of ze.positionedLines)at-=ri.lineOffset;const ut=ze.positionedLines.length,ii=at/ut;let xi=ze.top-Fe[1];for(let ri=0;ri<ut;++ri){const mi=ze.positionedLines[ri];xi=gm(ze,ii,xi,ri);for(const zt of mi.positionedGlyphs){if(!zt.rect)continue;const wt=zt.rect||{};let bi=4,Pi=!0,ar=1,ji=0;if(zt.imageName){const Gi=rt[zt.imageName];if(!Gi)continue;if(Gi.sdf){nt("SDF images are not supported in formatted text and will be ignored.");continue}Pi=!1,ar=Gi.pixelRatio,bi=1/ar}const lr=(We||Ge)&&zt.vertical,Bi=zt.metrics.advance*zt.scale/2,Mi=zt.metrics,Ni=zt.rect;if(Ni===null)continue;Ge&&ze.verticalizable&&(ji=zt.imageName?Bi-zt.metrics.width*zt.scale/2:0);const Hi=We?[zt.x+Bi,zt.y]:[0,0];let Qi=[0,0],cr=[0,0],dr=!1;We||(lr?(cr=[zt.x+Bi+pt[0],zt.y+pt[1]-ji],dr=!0):Qi=[zt.x+Bi+Fe[0],zt.y+Fe[1]-ji]);const tn=Ni.w*zt.scale/(ar*(zt.localGlyph?2:1)),Gr=Ni.h*zt.scale/(ar*(zt.localGlyph?2:1));let $i,Cr,rn,_r;if(lr){const Gi=zt.y-xi,qr=new L(-Bi,Bi-Gi),Dr=-Math.PI/2,or=new L(...cr);$i=new L(-Bi+Qi[0],Qi[1]),$i._rotateAround(Dr,qr)._add(or),$i.x+=-Gi+Bi,$i.y-=(Mi.left-bi)*zt.scale;const Pr=zt.imageName?Mi.advance*zt.scale:wr*zt.scale,Mr=String.fromCharCode(zt.glyph);Kp(Mr)?$i.x+=(1-bi)*zt.scale:Jp(Mr)?$i.x+=Pr-Mi.height*zt.scale+(-bi-1)*zt.scale:$i.x+=zt.imageName||Mi.width+2*bi===Ni.w&&Mi.height+2*bi===Ni.h?(Pr-Gr)/2:(Pr-(Mi.height+2*bi)*zt.scale)/2,Cr=new L($i.x,$i.y-tn),rn=new L($i.x+Gr,$i.y),_r=new L($i.x+Gr,$i.y-tn)}else{const Gi=(Mi.left-bi)*zt.scale-Bi+Qi[0],qr=(-Mi.top-bi)*zt.scale+Qi[1],Dr=Gi+tn,or=qr+Gr;$i=new L(Gi,qr),Cr=new L(Dr,qr),rn=new L(Gi,or),_r=new L(Dr,or)}if(ot){let Gi;Gi=We?new L(0,0):dr?new L(pt[0],pt[1]):new L(Fe[0],Fe[1]),$i._rotateAround(ot,Gi),Cr._rotateAround(ot,Gi),rn._rotateAround(ot,Gi),_r._rotateAround(ot,Gi)}const fr=new L(0,0),qi=new L(0,0);Je.push({tl:$i,tr:Cr,bl:rn,br:_r,tex:wt,writingMode:ze.writingMode,glyphOffset:Hi,sectionIndex:zt.sectionIndex,isSDF:Pi,pixelOffsetTL:fr,pixelOffsetBR:qi,minFontScaleX:0,minFontScaleY:0})}}return Je}(0,p,D,x,T,A,_,u.allowVerticalPlacement),Ae=u.textSizeData;let Pe=null;Ae.kind==="source"?(Pe=[Un*x.layout.get("text-size").evaluate(A,{},fe)],Pe[0]>Co&&nt(`${u.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Ae.kind==="composite"&&(Pe=[Un*re.compositeTextSizes[0].evaluate(A,{},fe),Un*re.compositeTextSizes[1].evaluate(A,{},fe)],(Pe[0]>Co||Pe[1]>Co)&&nt(`${u.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),u.addSymbols(u.text,xe,Pe,D,T,A,O,e,d,B.lineStartIndex,B.lineLength,W,se,fe);for(const Re of $)V[Re]=u.text.placedSymbolArray.length-1;return 4*xe.length}function jd(u){for(const e in u)return u[e];return null}function Yc(u,e,d,p,_,x,T,A,D,B){let O=T.top,$=T.bottom,V=T.left,W=T.right;const re=T.collisionPadding;if(re&&(V-=re[0],O-=re[1],W+=re[2],$+=re[3]),D){const se=new L(V,O),fe=new L(W,O),xe=new L(V,$),Ae=new L(W,$),Pe=K(D);let Re=new L(0,0);B&&(Re=new L(B[0],B[1])),se._rotateAround(Pe,Re),fe._rotateAround(Pe,Re),xe._rotateAround(Pe,Re),Ae._rotateAround(Pe,Re),V=Math.min(se.x,fe.x,xe.x,Ae.x),W=Math.max(se.x,fe.x,xe.x,Ae.x),O=Math.min(se.y,fe.y,xe.y,Ae.y),$=Math.max(se.y,fe.y,xe.y,Ae.y)}return u.emplaceBack(e.x,e.y,e.z,d.x,d.y,V,O,W,$,A,p,_,x),u.length-1}function nu(u){u.collisionPadding&&(u.top-=u.collisionPadding[1],u.bottom+=u.collisionPadding[3]);const e=u.bottom-u.top;return e>0?Math.max(10,e):null}function Tm(u,e,d,p){const _=u.compareText;if(e in _){const x=_[e];for(let T=x.length-1;T>=0;T--)if(p.dist(x[T])<d)return!0}else _[e]=[];return _[e].push(p),!1}const Mm=ms.VectorTileFeature.types,Sm=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Wc(u,e,d,p,_,x,T,A,D,B,O,$,V,W,re,se){const fe=O?Math.min(Co,Math.round(O[0])):0,xe=O?Math.min(Co,Math.round(O[1])):0;u.emplaceBack(e,d,Math.round(32*T),Math.round(32*A),D,B,(fe<<1)+($?1:0),xe,16*V,16*W,256*re,256*se,p,_,x,0)}function ou(u,e,d){u.emplaceBack(e.x,e.y,d),u.emplaceBack(e.x,e.y,d),u.emplaceBack(e.x,e.y,d),u.emplaceBack(e.x,e.y,d)}function Am(u){for(const e of u.sections)if(vh(e.text))return!0;return!1}class su{constructor(e){this.layoutVertexArray=new Ye,this.indexArray=new Ze,this.programConfigurations=e,this.segments=new Ji,this.dynamicLayoutVertexArray=new ke,this.opacityVertexArray=new ht,this.placedSymbolArray=new Tn}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(e,d,p,_){this.isEmpty()||(p&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Gp.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,d),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,qp.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Sm,!0),this.opacityVertexBuffer.itemSize=1),(p||_)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Tt(su);class au{constructor(e,d,p){this.layoutVertexArray=new e,this.layoutAttributes=d,this.indexArray=new p,this.segments=new Ji,this.collisionVertexArray=new kt,this.collisionVertexArrayExt=new ke}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Zp.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,Xp.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Tt(au);class Do{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(T=>T.id),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=$n([]),this.placementViewportMatrix=$n([]);const d=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Yh(this.zoom,d["text-size"]),this.iconSizeData=Yh(this.zoom,d["icon-size"]);const p=this.layers[0].layout,_=p.get("symbol-sort-key"),x=p.get("symbol-z-order");this.canOverlap=p.get("text-allow-overlap")||p.get("icon-allow-overlap")||p.get("text-ignore-placement")||p.get("icon-ignore-placement"),this.sortFeaturesByKey=x!=="viewport-y"&&_.constantOr(1)!==void 0,this.sortFeaturesByY=(x==="viewport-y"||x==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=p.get("text-writing-mode").map(T=>un[T]),this.stateDependentLayerIds=this.layers.filter(T=>T.isStateDependent()).map(T=>T.id),this.sourceID=e.sourceID,this.projection=e.projection}createArrays(){this.text=new su(new us(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new su(new us(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new Di,this.lineVertexArray=new rr,this.symbolInstances=new Ki}calculateGlyphDependencies(e,d,p,_,x){for(let T=0;T<e.length;T++)if(d[e.charCodeAt(T)]=!0,_&&x){const A=yl[e.charAt(T)];A&&(d[A.charCodeAt(0)]=!0)}}populate(e,d,p,_){const x=this.layers[0],T=x.layout,A=T.get("text-font"),D=T.get("text-field"),B=T.get("icon-image"),O=(D.value.kind!=="constant"||D.value.value instanceof sr&&!D.value.value.isEmpty()||D.value.value.toString().length>0)&&(A.value.kind!=="constant"||A.value.value.length>0),$=B.value.kind!=="constant"||!!B.value.value||Object.keys(B.parameters).length>0,V=T.get("symbol-sort-key");if(this.features=[],!O&&!$)return;const W=d.iconDependencies,re=d.glyphDependencies,se=d.availableImages,fe=new Vi(this.zoom);for(const{feature:xe,id:Ae,index:Pe,sourceLayerIndex:Re}of e){const ze=x._featureFilter.needGeometry,Fe=ds(xe,ze);if(!x._featureFilter.filter(fe,Fe,p))continue;let Xe,We;if(ze||(Fe.geometry=no(xe,p,_)),O){const rt=x.getValueAndResolveTokens("text-field",Fe,p,se),Ge=sr.factory(rt);Am(Ge)&&(this.hasRTLText=!0),(!this.hasRTLText||Ks()==="unavailable"||this.hasRTLText&&Wr.isParsed())&&(Xe=Hp(Ge,x,Fe))}if($){const rt=x.getValueAndResolveTokens("icon-image",Fe,p,se);We=rt instanceof zr?rt:zr.fromString(rt)}if(!Xe&&!We)continue;const et=this.sortFeaturesByKey?V.evaluate(Fe,{},p):void 0;if(this.features.push({id:Ae,text:Xe,icon:We,index:Pe,sourceLayerIndex:Re,geometry:Fe.geometry,properties:xe.properties,type:Mm[xe.type],sortKey:et}),We&&(W[We.name]=!0),Xe){const rt=A.evaluate(Fe,{},p).join(","),Ge=T.get("text-rotation-alignment")==="map"&&T.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(un.vertical)>=0;for(const Je of Xe.sections)if(Je.image)W[Je.image.name]=!0;else{const ot=Xs(Xe.toString()),pt=Je.fontStack||rt,at=re[pt]=re[pt]||{};this.calculateGlyphDependencies(Je.text,at,Ge,this.allowVerticalPlacement,ot)}}}T.get("symbol-placement")==="line"&&(this.features=function(xe){const Ae={},Pe={},Re=[];let ze=0;function Fe(rt){Re.push(xe[rt]),ze++}function Xe(rt,Ge,Je){const ot=Pe[rt];return delete Pe[rt],Pe[Ge]=ot,Re[ot].geometry[0].pop(),Re[ot].geometry[0]=Re[ot].geometry[0].concat(Je[0]),ot}function We(rt,Ge,Je){const ot=Ae[Ge];return delete Ae[Ge],Ae[rt]=ot,Re[ot].geometry[0].shift(),Re[ot].geometry[0]=Je[0].concat(Re[ot].geometry[0]),ot}function et(rt,Ge,Je){const ot=Je?Ge[0][Ge[0].length-1]:Ge[0][0];return`${rt}:${ot.x}:${ot.y}`}for(let rt=0;rt<xe.length;rt++){const Ge=xe[rt],Je=Ge.geometry,ot=Ge.text?Ge.text.toString():null;if(!ot){Fe(rt);continue}const pt=et(ot,Je),at=et(ot,Je,!0);if(pt in Pe&&at in Ae&&Pe[pt]!==Ae[at]){const ut=We(pt,at,Je),ii=Xe(pt,at,Re[ut].geometry);delete Ae[pt],delete Pe[at],Pe[et(ot,Re[ii].geometry,!0)]=ii,Re[ut].geometry=null}else pt in Pe?Xe(pt,at,Je):at in Ae?We(pt,at,Je):(Fe(rt),Ae[pt]=ze-1,Pe[at]=ze-1)}return Re.filter(rt=>rt.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((xe,Ae)=>xe.sortKey-Ae.sortKey)}update(e,d,p,_){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,d,this.layers,p,_),this.icon.programConfigurations.updatePaintArrays(e,d,this.layers,p,_))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,d){const p=this.lineVertexArray.length,_=e.segment;if(_!==void 0){let x=e.dist(d[_+1]),T=e.dist(d[_]);const A={};for(let D=_+1;D<d.length;D++)A[D]={x:d[D].x,y:d[D].y,tileUnitDistanceFromAnchor:x},D<d.length-1&&(x+=d[D+1].dist(d[D]));for(let D=_||0;D>=0;D--)A[D]={x:d[D].x,y:d[D].y,tileUnitDistanceFromAnchor:T},D>0&&(T+=d[D-1].dist(d[D]));for(let D=0;D<d.length;D++){const B=A[D];this.lineVertexArray.emplaceBack(B.x,B.y,B.tileUnitDistanceFromAnchor)}}return{lineStartIndex:p,lineLength:this.lineVertexArray.length-p}}addSymbols(e,d,p,_,x,T,A,D,B,O,$,V,W,re){const se=e.indexArray,fe=e.layoutVertexArray,xe=e.segments.prepareSegment(4*d.length,fe,se,this.canOverlap?T.sortKey:void 0),Ae=this.glyphOffsetArray.length,Pe=xe.vertexLength,Re=this.allowVerticalPlacement&&A===un.vertical?Math.PI/2:0,ze=T.text&&T.text.sections;for(let Fe=0;Fe<d.length;Fe++){const{tl:Xe,tr:We,bl:et,br:rt,tex:Ge,pixelOffsetTL:Je,pixelOffsetBR:ot,minFontScaleX:pt,minFontScaleY:at,glyphOffset:ut,isSDF:ii,sectionIndex:xi}=d[Fe],ri=xe.vertexLength,mi=ut[1];Wc(fe,D.x,D.y,D.z,B.x,B.y,Xe.x,mi+Xe.y,Ge.x,Ge.y,p,ii,Je.x,Je.y,pt,at),Wc(fe,D.x,D.y,D.z,B.x,B.y,We.x,mi+We.y,Ge.x+Ge.w,Ge.y,p,ii,ot.x,Je.y,pt,at),Wc(fe,D.x,D.y,D.z,B.x,B.y,et.x,mi+et.y,Ge.x,Ge.y+Ge.h,p,ii,Je.x,ot.y,pt,at),Wc(fe,D.x,D.y,D.z,B.x,B.y,rt.x,mi+rt.y,Ge.x+Ge.w,Ge.y+Ge.h,p,ii,ot.x,ot.y,pt,at),ou(e.dynamicLayoutVertexArray,D,Re),se.emplaceBack(ri,ri+1,ri+2),se.emplaceBack(ri+1,ri+2,ri+3),xe.vertexLength+=4,xe.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ut[0]),Fe!==d.length-1&&xi===d[Fe+1].sectionIndex||e.programConfigurations.populatePaintArrays(fe.length,T,T.index,{},W,re,ze&&ze[xi])}e.placedSymbolArray.emplaceBack(D.x,D.y,D.z,B.x,B.y,Ae,this.glyphOffsetArray.length-Ae,Pe,O,$,B.segment,p?p[0]:0,p?p[1]:0,_[0],_[1],A,0,!1,0,V,0)}_commitLayoutVertex(e,d,p,_,x,T,A){e.emplaceBack(d,p,_,x,T,Math.round(A.x),Math.round(A.y))}_addCollisionDebugVertices(e,d,p,_,x,T,A){const D=p.segments.prepareSegment(4,p.layoutVertexArray,p.indexArray),B=D.vertexLength,O=A.tileAnchorX,$=A.tileAnchorY;for(let W=0;W<4;W++)p.collisionVertexArray.emplaceBack(0,0,0,0);p.collisionVertexArrayExt.emplaceBack(d,-e.padding,-e.padding),p.collisionVertexArrayExt.emplaceBack(d,e.padding,-e.padding),p.collisionVertexArrayExt.emplaceBack(d,e.padding,e.padding),p.collisionVertexArrayExt.emplaceBack(d,-e.padding,e.padding),this._commitLayoutVertex(p.layoutVertexArray,_,x,T,O,$,new L(e.x1,e.y1)),this._commitLayoutVertex(p.layoutVertexArray,_,x,T,O,$,new L(e.x2,e.y1)),this._commitLayoutVertex(p.layoutVertexArray,_,x,T,O,$,new L(e.x2,e.y2)),this._commitLayoutVertex(p.layoutVertexArray,_,x,T,O,$,new L(e.x1,e.y2)),D.vertexLength+=4;const V=p.indexArray;V.emplaceBack(B,B+1),V.emplaceBack(B+1,B+2),V.emplaceBack(B+2,B+3),V.emplaceBack(B+3,B),D.primitiveLength+=4}_addTextDebugCollisionBoxes(e,d,p,_,x,T){for(let A=_;A<x;A++){const D=p.get(A),B=this.getSymbolInstanceTextSize(e,T,d,A);this._addCollisionDebugVertices(D,B,this.textCollisionBox,D.projectedAnchorX,D.projectedAnchorY,D.projectedAnchorZ,T)}}_addIconDebugCollisionBoxes(e,d,p,_,x,T){for(let A=_;A<x;A++){const D=p.get(A),B=this.getSymbolInstanceIconSize(e,d,A);this._addCollisionDebugVertices(D,B,this.iconCollisionBox,D.projectedAnchorX,D.projectedAnchorY,D.projectedAnchorZ,T)}}generateCollisionDebugBuffers(e,d){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new au(lt,_d.members,Ft),this.iconCollisionBox=new au(lt,_d.members,Ft);const p=aa(this.iconSizeData,e),_=aa(this.textSizeData,e);for(let x=0;x<this.symbolInstances.length;x++){const T=this.symbolInstances.get(x);this._addTextDebugCollisionBoxes(_,e,d,T.textBoxStartIndex,T.textBoxEndIndex,T),this._addTextDebugCollisionBoxes(_,e,d,T.verticalTextBoxStartIndex,T.verticalTextBoxEndIndex,T),this._addIconDebugCollisionBoxes(p,e,d,T.iconBoxStartIndex,T.iconBoxEndIndex,T),this._addIconDebugCollisionBoxes(p,e,d,T.verticalIconBoxStartIndex,T.verticalIconBoxEndIndex,T)}}getSymbolInstanceTextSize(e,d,p,_){const x=this.text.placedSymbolArray.get(d.rightJustifiedTextSymbolIndex>=0?d.rightJustifiedTextSymbolIndex:d.centerJustifiedTextSymbolIndex>=0?d.centerJustifiedTextSymbolIndex:d.leftJustifiedTextSymbolIndex>=0?d.leftJustifiedTextSymbolIndex:d.verticalPlacedTextSymbolIndex>=0?d.verticalPlacedTextSymbolIndex:_),T=Vc(this.textSizeData,e,x)/wr;return this.tilePixelRatio*T}getSymbolInstanceIconSize(e,d,p){const _=this.icon.placedSymbolArray.get(p),x=Vc(this.iconSizeData,e,_);return this.tilePixelRatio*x}_commitDebugCollisionVertexUpdate(e,d,p){e.emplaceBack(d,-p,-p),e.emplaceBack(d,p,-p),e.emplaceBack(d,p,p),e.emplaceBack(d,-p,p)}_updateTextDebugCollisionBoxes(e,d,p,_,x,T){for(let A=_;A<x;A++){const D=p.get(A),B=this.getSymbolInstanceTextSize(e,T,d,A);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,B,D.padding)}}_updateIconDebugCollisionBoxes(e,d,p,_,x){for(let T=_;T<x;T++){const A=p.get(T),D=this.getSymbolInstanceIconSize(e,d,T);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,D,A.padding)}}updateCollisionDebugBuffers(e,d){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const p=aa(this.iconSizeData,e),_=aa(this.textSizeData,e);for(let x=0;x<this.symbolInstances.length;x++){const T=this.symbolInstances.get(x);this._updateTextDebugCollisionBoxes(_,e,d,T.textBoxStartIndex,T.textBoxEndIndex,T),this._updateTextDebugCollisionBoxes(_,e,d,T.verticalTextBoxStartIndex,T.verticalTextBoxEndIndex,T),this._updateIconDebugCollisionBoxes(p,e,d,T.iconBoxStartIndex,T.iconBoxEndIndex),this._updateIconDebugCollisionBoxes(p,e,d,T.verticalIconBoxStartIndex,T.verticalIconBoxEndIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,d,p,_,x,T,A,D,B){const O={};for(let $=d;$<p;$++){const V=e.get($);O.textBox={x1:V.x1,y1:V.y1,x2:V.x2,y2:V.y2,padding:V.padding,projectedAnchorX:V.projectedAnchorX,projectedAnchorY:V.projectedAnchorY,projectedAnchorZ:V.projectedAnchorZ,tileAnchorX:V.tileAnchorX,tileAnchorY:V.tileAnchorY},O.textFeatureIndex=V.featureIndex;break}for(let $=_;$<x;$++){const V=e.get($);O.verticalTextBox={x1:V.x1,y1:V.y1,x2:V.x2,y2:V.y2,padding:V.padding,projectedAnchorX:V.projectedAnchorX,projectedAnchorY:V.projectedAnchorY,projectedAnchorZ:V.projectedAnchorZ,tileAnchorX:V.tileAnchorX,tileAnchorY:V.tileAnchorY},O.verticalTextFeatureIndex=V.featureIndex;break}for(let $=T;$<A;$++){const V=e.get($);O.iconBox={x1:V.x1,y1:V.y1,x2:V.x2,y2:V.y2,padding:V.padding,projectedAnchorX:V.projectedAnchorX,projectedAnchorY:V.projectedAnchorY,projectedAnchorZ:V.projectedAnchorZ,tileAnchorX:V.tileAnchorX,tileAnchorY:V.tileAnchorY},O.iconFeatureIndex=V.featureIndex;break}for(let $=D;$<B;$++){const V=e.get($);O.verticalIconBox={x1:V.x1,y1:V.y1,x2:V.x2,y2:V.y2,padding:V.padding,projectedAnchorX:V.projectedAnchorX,projectedAnchorY:V.projectedAnchorY,projectedAnchorZ:V.projectedAnchorZ,tileAnchorX:V.tileAnchorX,tileAnchorY:V.tileAnchorY},O.verticalIconFeatureIndex=V.featureIndex;break}return O}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let d=0;d<this.symbolInstances.length;d++){const p=this.symbolInstances.get(d);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,p.textBoxStartIndex,p.textBoxEndIndex,p.verticalTextBoxStartIndex,p.verticalTextBoxEndIndex,p.iconBoxStartIndex,p.iconBoxEndIndex,p.verticalIconBoxStartIndex,p.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,d){const p=e.placedSymbolArray.get(d),_=p.vertexStartIndex+4*p.numGlyphs;for(let x=p.vertexStartIndex;x<_;x+=4)e.indexArray.emplaceBack(x,x+1,x+2),e.indexArray.emplaceBack(x+1,x+2,x+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const d=Math.sin(e),p=Math.cos(e),_=[],x=[],T=[];for(let A=0;A<this.symbolInstances.length;++A){T.push(A);const D=this.symbolInstances.get(A);_.push(0|Math.round(d*D.tileAnchorX+p*D.tileAnchorY)),x.push(D.featureIndex)}return T.sort((A,D)=>_[A]-_[D]||x[D]-x[A]),T}addToSortKeyRanges(e,d){const p=this.sortKeyRanges[this.sortKeyRanges.length-1];p&&p.sortKey===d?p.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:d,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const d of this.symbolInstanceIndexes){const p=this.symbolInstances.get(d);this.featureSortOrder.push(p.featureIndex),[p.rightJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.leftJustifiedTextSymbolIndex].forEach((_,x,T)=>{_>=0&&T.indexOf(_)===x&&this.addIndicesForPlacedSymbol(this.text,_)}),p.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,p.verticalPlacedTextSymbolIndex),p.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,p.placedIconSymbolIndex),p.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,p.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Tt(Do,{omit:["layers","collisionBoxArray","features","compareText"]}),Do.MAX_GLYPHS=65535,Do.addDynamicAttributes=ou;const Im=new ee({"symbol-placement":new P(Ne.layout_symbol["symbol-placement"]),"symbol-spacing":new P(Ne.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new P(Ne.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new z(Ne.layout_symbol["symbol-sort-key"]),"symbol-z-order":new P(Ne.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new P(Ne.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new P(Ne.layout_symbol["icon-ignore-placement"]),"icon-optional":new P(Ne.layout_symbol["icon-optional"]),"icon-rotation-alignment":new P(Ne.layout_symbol["icon-rotation-alignment"]),"icon-size":new z(Ne.layout_symbol["icon-size"]),"icon-text-fit":new P(Ne.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new P(Ne.layout_symbol["icon-text-fit-padding"]),"icon-image":new z(Ne.layout_symbol["icon-image"]),"icon-rotate":new z(Ne.layout_symbol["icon-rotate"]),"icon-padding":new P(Ne.layout_symbol["icon-padding"]),"icon-keep-upright":new P(Ne.layout_symbol["icon-keep-upright"]),"icon-offset":new z(Ne.layout_symbol["icon-offset"]),"icon-anchor":new z(Ne.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new P(Ne.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new P(Ne.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new P(Ne.layout_symbol["text-rotation-alignment"]),"text-field":new z(Ne.layout_symbol["text-field"]),"text-font":new z(Ne.layout_symbol["text-font"]),"text-size":new z(Ne.layout_symbol["text-size"]),"text-max-width":new z(Ne.layout_symbol["text-max-width"]),"text-line-height":new z(Ne.layout_symbol["text-line-height"]),"text-letter-spacing":new z(Ne.layout_symbol["text-letter-spacing"]),"text-justify":new z(Ne.layout_symbol["text-justify"]),"text-radial-offset":new z(Ne.layout_symbol["text-radial-offset"]),"text-variable-anchor":new P(Ne.layout_symbol["text-variable-anchor"]),"text-anchor":new z(Ne.layout_symbol["text-anchor"]),"text-max-angle":new P(Ne.layout_symbol["text-max-angle"]),"text-writing-mode":new P(Ne.layout_symbol["text-writing-mode"]),"text-rotate":new z(Ne.layout_symbol["text-rotate"]),"text-padding":new P(Ne.layout_symbol["text-padding"]),"text-keep-upright":new P(Ne.layout_symbol["text-keep-upright"]),"text-transform":new z(Ne.layout_symbol["text-transform"]),"text-offset":new z(Ne.layout_symbol["text-offset"]),"text-allow-overlap":new P(Ne.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new P(Ne.layout_symbol["text-ignore-placement"]),"text-optional":new P(Ne.layout_symbol["text-optional"])});var lu={paint:new ee({"icon-opacity":new z(Ne.paint_symbol["icon-opacity"]),"icon-color":new z(Ne.paint_symbol["icon-color"]),"icon-halo-color":new z(Ne.paint_symbol["icon-halo-color"]),"icon-halo-width":new z(Ne.paint_symbol["icon-halo-width"]),"icon-halo-blur":new z(Ne.paint_symbol["icon-halo-blur"]),"icon-translate":new P(Ne.paint_symbol["icon-translate"]),"icon-translate-anchor":new P(Ne.paint_symbol["icon-translate-anchor"]),"text-opacity":new z(Ne.paint_symbol["text-opacity"]),"text-color":new z(Ne.paint_symbol["text-color"],{runtimeType:dn,getOverride:u=>u.textColor,hasOverride:u=>!!u.textColor}),"text-halo-color":new z(Ne.paint_symbol["text-halo-color"]),"text-halo-width":new z(Ne.paint_symbol["text-halo-width"]),"text-halo-blur":new z(Ne.paint_symbol["text-halo-blur"]),"text-translate":new P(Ne.paint_symbol["text-translate"]),"text-translate-anchor":new P(Ne.paint_symbol["text-translate-anchor"])}),layout:Im};class Gd{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:_n,this.defaultValue=e}evaluate(e){if(e.formattedSection){const d=this.defaultValue.property.overrides;if(d&&d.hasOverride(e.formattedSection))return d.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Tt(Gd,{omit:["defaultValue"]});class Hc extends Sn{constructor(e){super(e,lu)}recalculate(e,d){super.recalculate(e,d),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const p=this.layout.get("text-writing-mode");if(p){const _=[];for(const x of p)_.indexOf(x)<0&&_.push(x);this.layout._values["text-writing-mode"]=_}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(e,d,p,_){const x=this.layout.get(e).evaluate(d,{},p,_),T=this._unevaluatedLayout._values[e];return T.isDataDriven()||yo(T.value)||!x?x:function(A,D){return D.replace(/{([^{}]+)}/g,(B,O)=>O in A?String(A[O]):"")}(d.properties,x)}createBucket(e){return new Do(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of lu.paint.overridableProperties){if(!Hc.hasPaintOverride(this.layout,e))continue;const d=this.paint.get(e),p=new Gd(d),_=new Fs(p,d.property.specification);let x=null;x=d.value.kind==="constant"||d.value.kind==="source"?new La("source",_):new za("composite",_,d.value.zoomStops,d.value._interpolationType),this.paint._values[e]=new I(d.property,x,d.parameters)}}_handleOverridablePaintPropertyUpdate(e,d,p){return!(!this.layout||d.isDataDriven()||p.isDataDriven())&&Hc.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,d){const p=e.get("text-field"),_=lu.paint.properties[d];let x=!1;const T=A=>{for(const D of A)if(_.overrides&&_.overrides.hasOverride(D))return void(x=!0)};if(p.value.kind==="constant"&&p.value.value instanceof sr)T(p.value.value.sections);else if(p.value.kind==="source"){const A=B=>{x||(B instanceof xn&&ir(B.value)===co?T(B.value.sections):B instanceof fo?T(B.sections):B.eachChild(A))},D=p.value;D._styleExpression&&A(D._styleExpression.expression)}return x}getProgramConfiguration(e){return new So(this,e)}}var km={paint:new ee({"background-color":new P(Ne.paint_background["background-color"]),"background-pattern":new q(Ne.paint_background["background-pattern"]),"background-opacity":new P(Ne.paint_background["background-opacity"])})},Cm={paint:new ee({"raster-opacity":new P(Ne.paint_raster["raster-opacity"]),"raster-hue-rotate":new P(Ne.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new P(Ne.paint_raster["raster-brightness-min"]),"raster-brightness-max":new P(Ne.paint_raster["raster-brightness-max"]),"raster-saturation":new P(Ne.paint_raster["raster-saturation"]),"raster-contrast":new P(Ne.paint_raster["raster-contrast"]),"raster-resampling":new P(Ne.paint_raster["raster-resampling"]),"raster-fade-duration":new P(Ne.paint_raster["raster-fade-duration"])})};class Dm extends Sn{constructor(e){super(e,{}),this.implementation=e}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}var Pm={paint:new ee({"sky-type":new P(Ne.paint_sky["sky-type"]),"sky-atmosphere-sun":new P(Ne.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new P(Ne.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new P(Ne.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new P(Ne.paint_sky["sky-gradient-radius"]),"sky-gradient":new Z(Ne.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new P(Ne.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new P(Ne.paint_sky["sky-atmosphere-color"]),"sky-opacity":new P(Ne.paint_sky["sky-opacity"])})};function cu(u,e,d){const p=[0,0,1],_=Hu([]);return function(x,T,A){A*=.5;var D=T[0],B=T[1],O=T[2],$=T[3],V=Math.sin(A),W=Math.cos(A);x[0]=D*W-O*V,x[1]=B*W+$*V,x[2]=O*W+D*V,x[3]=$*W-B*V}(_,_,d?-K(u)+Math.PI:K(u)),Ku(_,_,-K(e)),Yu(p,p,_),al(p,p)}const Bm={circle:class extends Sn{constructor(u){super(u,Jf)}createBucket(u){return new Ih(u)}queryRadius(u){const e=u;return ia("circle-radius",this,e)+ia("circle-stroke-width",this,e)+Bc(this.paint.get("circle-translate"))}queryIntersectsFeature(u,e,d,p,_,x,T,A){const D=$u(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),x.angle,u.pixelToTileUnitsFactor),B=this.paint.get("circle-radius").evaluate(e,d)+this.paint.get("circle-stroke-width").evaluate(e,d);return Ju(u,p,x,T,A,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",D,B)}getProgramIds(){return["circle"]}getProgramConfiguration(u){return new So(this,u)}},heatmap:class extends Sn{createBucket(u){return new ed(u)}constructor(u){super(u,op),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(u){u==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Uh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(u){return ia("heatmap-radius",this,u)}queryIntersectsFeature(u,e,d,p,_,x,T,A){const D=this.paint.get("heatmap-radius").evaluate(e,d);return Ju(u,p,x,T,A,!0,!0,new L(0,0),D)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(u){return new So(this,u)}},hillshade:class extends Sn{constructor(u){super(u,sp)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}},fill:class extends Sn{constructor(u){super(u,Ep)}getProgramIds(){const u=this.paint.get("fill-pattern"),e=u&&u.constantOr(1),d=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&d.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),d}getProgramConfiguration(u){return new So(this,u)}recalculate(u,e){super.recalculate(u,e);const d=this.paint._values["fill-outline-color"];d.value.kind==="constant"&&d.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(u){return new Nc(u)}queryRadius(){return Bc(this.paint.get("fill-translate"))}queryIntersectsFeature(u,e,d,p,_,x){return!u.queryGeometry.isAboveHorizon&&Lu(Nu(u.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),x.angle,u.pixelToTileUnitsFactor),p)}isTileClipped(){return!0}},"fill-extrusion":class extends Sn{constructor(u){super(u,Lp)}createBucket(u){return new gl(u)}queryRadius(){return Bc(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(u){return new So(this,u)}queryIntersectsFeature(u,e,d,p,_,x,T,A,D){const B=$u(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),x.angle,u.pixelToTileUnitsFactor),O=this.paint.get("fill-extrusion-height").evaluate(e,d),$=this.paint.get("fill-extrusion-base").evaluate(e,d),V=[0,0],W=A&&x.elevation,re=x.elevation?x.elevation.exaggeration():1,se=u.tile.getBucket(this);if(W&&se instanceof gl){const Ae=se.centroidVertexArray,Pe=D+1;if(Pe<Ae.length){const Re=Ae.get(Pe);V[0]=Re.a_centroid_pos0,V[1]=Re.a_centroid_pos1}}if(V[0]===0&&V[1]===1)return!1;const fe=function(Ae,Pe,Re,ze,Fe,Xe,We,et,rt){return Xe?function(Ge,Je,ot,pt,at,ut,ii,xi,ri){const mi=[],zt=[],wt=[0,0,0,1];for(const bi of Ge){const Pi=[],ar=[];for(const ji of bi){const lr=ji.x+pt.x,Bi=ji.y+pt.y,Mi=zp(lr,Bi,Je,ot,ut,ii,xi,ri);wt[0]=lr,wt[1]=Bi,wt[2]=Mi.base,wt[3]=1,na(wt,wt,at),wt[3]=Math.max(wt[3],1e-5);const Ni=fd([wt[0]/wt[3],wt[1]/wt[3],wt[2]/wt[3]]);wt[0]=lr,wt[1]=Bi,wt[2]=Mi.top,wt[3]=1,na(wt,wt,at),wt[3]=Math.max(wt[3],1e-5);const Hi=fd([wt[0]/wt[3],wt[1]/wt[3],wt[2]/wt[3]]);Pi.push(Ni),ar.push(Hi)}mi.push(Pi),zt.push(ar)}return[mi,zt]}(Ae,Pe,Re,ze,Fe,Xe,We,et,rt):function(Ge,Je,ot,pt,at){const ut=[],ii=[],xi=at[8]*Je,ri=at[9]*Je,mi=at[10]*Je,zt=at[11]*Je,wt=at[8]*ot,bi=at[9]*ot,Pi=at[10]*ot,ar=at[11]*ot;for(const ji of Ge){const lr=[],Bi=[];for(const Mi of ji){const Ni=Mi.x+pt.x,Hi=Mi.y+pt.y,Qi=at[0]*Ni+at[4]*Hi+at[12],cr=at[1]*Ni+at[5]*Hi+at[13],dr=at[2]*Ni+at[6]*Hi+at[14],tn=at[3]*Ni+at[7]*Hi+at[15],Gr=Qi+xi,$i=cr+ri,Cr=dr+mi,rn=Math.max(tn+zt,1e-5),_r=Qi+wt,fr=cr+bi,qi=dr+Pi,Gi=Math.max(tn+ar,1e-5),qr=new L(Gr/rn,$i/rn);qr.z=Cr/rn,lr.push(qr);const Dr=new L(_r/Gi,fr/Gi);Dr.z=qi/Gi,Bi.push(Dr)}ut.push(lr),ii.push(Bi)}return[ut,ii]}(Ae,Pe,Re,ze,Fe)}(p,$,O,B,T,W?A:null,V,re,x.center.lat),xe=u.queryGeometry;return function(Ae,Pe,Re){let ze=1/0;Lu(Re,Pe)&&(ze=dd(Re,Pe[0]));for(let Fe=0;Fe<Pe.length;Fe++){const Xe=Pe[Fe],We=Ae[Fe];for(let et=0;et<Xe.length-1;et++){const rt=Xe[et],Ge=[rt,Xe[et+1],We[et+1],We[et],rt];Ru(Re,Ge)&&(ze=Math.min(ze,dd(Re,Ge)))}}return ze!==1/0&&ze}(fe[0],fe[1],xe.isPointQuery()?xe.screenBounds:xe.screenGeometry)}},line:class extends Sn{constructor(u){super(u,pd),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(u){if(u==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof jo,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(u,e){super.recalculate(u,e),this.paint._values["line-floorwidth"]=md.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,u)}createBucket(u){return new Uc(u)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(u){return new So(this,u)}queryRadius(u){const e=u,d=gd(ia("line-width",this,e),ia("line-gap-width",this,e)),p=ia("line-offset",this,e);return d/2+Math.abs(p)+Bc(this.paint.get("line-translate"))}queryIntersectsFeature(u,e,d,p,_,x){if(u.queryGeometry.isAboveHorizon)return!1;const T=Nu(u.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),x.angle,u.pixelToTileUnitsFactor),A=u.pixelToTileUnitsFactor/2*gd(this.paint.get("line-width").evaluate(e,d),this.paint.get("line-gap-width").evaluate(e,d)),D=this.paint.get("line-offset").evaluate(e,d);return D&&(p=function(B,O){const $=[],V=new L(0,0);for(let W=0;W<B.length;W++){const re=B[W],se=[];for(let fe=0;fe<re.length;fe++){const xe=re[fe-1],Ae=re[fe],Pe=re[fe+1],Re=fe===0?V:Ae.sub(xe)._unit()._perp(),ze=fe===re.length-1?V:Pe.sub(Ae)._unit()._perp(),Fe=Re._add(ze)._unit();Fe._mult(1/(Fe.x*ze.x+Fe.y*ze.y)),se.push(Fe._mult(O)._add(Ae))}$.push(se)}return $}(p,D*u.pixelToTileUnitsFactor)),function(B,O,$){for(let V=0;V<O.length;V++){const W=O[V];if(B.length>=3){for(let re=0;re<W.length;re++)if(ta(B,W[re]))return!0}if(Yf(B,W,$))return!0}return!1}(T,p,A)}isTileClipped(){return!0}},symbol:Hc,background:class extends Sn{constructor(u){super(u,km)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends Sn{constructor(u){super(u,Cm)}getProgramIds(){return["raster"]}},sky:class extends Sn{constructor(u){super(u,Pm),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(u){u==="sky-gradient"?this._updateColorRamp():u!=="sky-atmosphere-sun"&&u!=="sky-atmosphere-halo-color"&&u!=="sky-atmosphere-color"&&u!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Uh({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(u){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=u.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(u,e){if(this.paint.get("sky-type")==="atmosphere"){const p=this.paint.get("sky-atmosphere-sun"),_=!p,x=u.style.light,T=x.properties.get("position");return _&&x.properties.get("anchor")==="viewport"&&nt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),_?cu(T.azimuthal,90-T.polar,e):cu(p[0],90-p[1],e)}const d=this.paint.get("sky-gradient-center");return cu(d[0],90-d[1],e)}is3D(){return!1}isSky(){return!0}markSkyboxValid(u){this._skyboxInvalidated=!1,this._lightPosition=u.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const u=this.paint.get("sky-type");return u==="atmosphere"?["skyboxCapture","skybox"]:u==="gradient"?["skyboxGradient"]:null}}};class wl{constructor(e,d,p,_){this.context=e,this.format=p,this.texture=e.gl.createTexture(),this.update(d,_)}update(e,d,p){const{width:_,height:x}=e,{context:T}=this,{gl:A}=T,{HTMLImageElement:D,HTMLCanvasElement:B,HTMLVideoElement:O,ImageData:$,ImageBitmap:V}=F;if(A.bindTexture(A.TEXTURE_2D,this.texture),T.pixelStoreUnpackFlipY.set(!1),T.pixelStoreUnpack.set(1),T.pixelStoreUnpackPremultiplyAlpha.set(this.format===A.RGBA&&(!d||d.premultiply!==!1)),p||this.size&&this.size[0]===_&&this.size[1]===x){const{x:W,y:re}=p||{x:0,y:0};e instanceof D||e instanceof B||e instanceof O||e instanceof $||V&&e instanceof V?A.texSubImage2D(A.TEXTURE_2D,0,W,re,A.RGBA,A.UNSIGNED_BYTE,e):A.texSubImage2D(A.TEXTURE_2D,0,W,re,_,x,A.RGBA,A.UNSIGNED_BYTE,e.data)}else this.size=[_,x],e instanceof D||e instanceof B||e instanceof O||e instanceof $||V&&e instanceof V?A.texImage2D(A.TEXTURE_2D,0,this.format,this.format,A.UNSIGNED_BYTE,e):A.texImage2D(A.TEXTURE_2D,0,this.format,_,x,0,this.format,A.UNSIGNED_BYTE,e.data);this.useMipmap=Boolean(d&&d.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&A.generateMipmap(A.TEXTURE_2D)}bind(e,d){const{context:p}=this,{gl:_}=p;_.bindTexture(_.TEXTURE_2D,this.texture),e!==this.filter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MAG_FILTER,e),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MIN_FILTER,this.useMipmap?e===_.NEAREST?_.NEAREST_MIPMAP_NEAREST:_.LINEAR_MIPMAP_NEAREST:e),this.filter=e),d!==this.wrap&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,d),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,d),this.wrap=d)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class hu{constructor(e,d){this.width=e,this.height=d,this.nextRow=0,this.image=new oo({width:e,height:d}),this.positions={},this.uploaded=!1}getDash(e,d){const p=this.getKey(e,d);return this.positions[p]}trim(){const e=this.width,d=this.height=it(this.nextRow);this.image.resize({width:e,height:d})}getKey(e,d){return e.join(",")+d}getDashRanges(e,d,p){const _=[];let x=e.length%2==1?-e[e.length-1]*p:0,T=e[0]*p,A=!0;_.push({left:x,right:T,isDash:A,zeroLength:e[0]===0});let D=e[0];for(let B=1;B<e.length;B++){A=!A;const O=e[B];x=D*p,D+=O,T=D*p,_.push({left:x,right:T,isDash:A,zeroLength:O===0})}return _}addRoundDash(e,d,p){const _=d/2;for(let x=-p;x<=p;x++){const T=this.width*(this.nextRow+p+x);let A=0,D=e[A];for(let B=0;B<this.width;B++){B/D.right>1&&(D=e[++A]);const O=Math.abs(B-D.left),$=Math.abs(B-D.right),V=Math.min(O,$);let W;const re=x/p*(_+1);if(D.isDash){const se=_-Math.abs(re);W=Math.sqrt(V*V+se*se)}else W=_-Math.sqrt(V*V+re*re);this.image.data[T+B]=Math.max(0,Math.min(255,W+128))}}}addRegularDash(e,d){for(let D=e.length-1;D>=0;--D){const B=e[D],O=e[D+1];B.zeroLength?e.splice(D,1):O&&O.isDash===B.isDash&&(O.left=B.left,e.splice(D,1))}const p=e[0],_=e[e.length-1];p.isDash===_.isDash&&(p.left=_.left-this.width,_.right=p.right+this.width);const x=this.width*this.nextRow;let T=0,A=e[T];for(let D=0;D<this.width;D++){D/A.right>1&&(A=e[++T]);const B=Math.abs(D-A.left),O=Math.abs(D-A.right),$=Math.min(B,O);this.image.data[x+D]=Math.max(0,Math.min(255,(A.isDash?$:-$)+d+128))}}addDash(e,d){const p=this.getKey(e,d);if(this.positions[p])return this.positions[p];const _=d==="round",x=_?7:0,T=2*x+1;if(this.nextRow+T>this.height)return nt("LineAtlas out of space"),null;e.length===0&&e.push(1);let A=0;for(let O=0;O<e.length;O++)e[O]<0&&(nt("Negative value is found in line dasharray, replacing values with 0"),e[O]=0),A+=e[O];if(A!==0){const O=this.width/A,$=this.getDashRanges(e,this.width,O);_?this.addRoundDash($,O,x):this.addRegularDash($,d==="square"?.5*O:0)}const D=this.nextRow+x;this.nextRow+=T;const B={tl:[D,x],br:[A,0]};return this.positions[p]=B,B}}Tt(hu);class Rm{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel!="undefined"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}const Lm=F.performance;function qd(u){const e=u?u.url.toString():void 0;return Lm.getEntriesByName(e)}class zm{constructor(){this.tasks={},this.taskQueue=[],Rt(["process"],this),this.invoker=new Rm(this.process),this.nextId=0}add(e,d){const p=this.nextId++,_=function({type:x,isSymbolTile:T,zoom:A}){return A=A||0,x==="message"?0:x!=="maybePrepare"||T?x!=="parseTile"||T?x==="parseTile"&&T?300-A:x==="maybePrepare"&&T?400-A:500:200-A:100-A}(d);if(_===0){Dt();try{e()}finally{}return{cancel:()=>{}}}return this.tasks[p]={fn:e,metadata:d,priority:_,id:p},this.taskQueue.push(p),this.invoker.trigger(),{cancel:()=>{delete this.tasks[p]}}}process(){Dt();try{if(this.taskQueue=this.taskQueue.filter(p=>!!this.tasks[p]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const d=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!d)return;d.fn()}finally{}}pick(){let e=null,d=1/0;for(let _=0;_<this.taskQueue.length;_++){const x=this.tasks[this.taskQueue[_]];x.priority<d&&(d=x.priority,e=_)}if(e===null)return null;const p=this.taskQueue[e];return this.taskQueue.splice(e,1),p}remove(){this.invoker.remove()}}const Fm=Me([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_merc_pos",components:2},{type:"Float32",name:"a_uv",components:2}]),Om=Me([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Zd}=Fm,Xd=Me([{name:"a_pos_3",components:3,type:"Int16"}]);var El=Me([{name:"a_pos",type:"Int16",components:2}]);const fa=di/Math.PI/2,Qr=-fa,en=fa,Nm=[new hn([Qr,Qr,Qr],[en,en,en]),new hn([Qr,Qr,Qr],[0,0,en]),new hn([0,Qr,Qr],[en,0,en]),new hn([Qr,0,Qr],[0,en,en]),new hn([0,0,Qr],[en,en,en])];class $m{constructor(e,d,p){this.a=ra([],e,p),this.b=ra([],d,p),this.center=p;const _=al([],this.a),x=al([],this.b);this.angle=Math.acos(ll(_,x))}}function uu(u,e){if(u.angle===0)return null;let d;return d=u.a[e]===0?1/u.angle*.5*Math.PI:1/u.angle*Math.atan(u.b[e]/u.a[e]/Math.sin(u.angle)-1/Math.tan(u.angle)),d<0||d>1?null:function(p,_,x,T){const A=Math.sin(x);return p*(Math.sin((1-T)*x)/A)+_*(Math.sin(T*x)/A)}(u.a[e],u.b[e],u.angle,ge(d,0,1))+u.center[e]}function Tl(u){if(u.z<=1)return Nm[u.z+2*u.y+u.x];const[e,d]=du(u),p=[lo(e[0],e[1]),lo(e[0],d[1]),lo(d[0],e[1]),lo(d[0],d[1])],_=[en,en,en],x=[Qr,Qr,Qr];for(const T of p)_[0]=Math.min(_[0],T[0]),_[1]=Math.min(_[1],T[1]),_[2]=Math.min(_[2],T[2]),x[0]=Math.max(x[0],T[0]),x[1]=Math.max(x[1],T[1]),x[2]=Math.max(x[2],T[2]);return new hn(_,x)}function Um(u,e,d){const p=e/u.worldSize,_=(Je,ot)=>{sl(Je,Je,p),sl(ot,ot,p)},x=Number.MAX_VALUE,T=[-x,-x,-x],A=[x,x,x],D=Jd(u);if(d.z<=1){const Je=Tl(d).getCorners();for(let ot=0;ot<Je.length;ot++)ps(Je[ot],Je[ot],D),zh(A,A,Je[ot]),Fh(T,T,Je[ot]);return _(A,T),new hn(A,T)}const[B,O]=du(d),$=new Ao;$.setSouthWest([B[1],O[0]]),$.setNorthEast([O[1],B[0]]);const V=[lo($.getSouth(),$.getWest()),lo($.getSouth(),$.getEast()),lo($.getNorth(),$.getEast()),lo($.getNorth(),$.getWest())];for(let Je=0;Je<V.length;Je++)ps(V[Je],V[Je],D),zh(A,A,V[Je]),Fh(T,T,V[Je]);if($.contains(u.center))return T[2]=0,_(A,T),new hn(A,T);const W=[D[12],D[13],D[14]],re=u.center.lng,se=ge(u.center.lat,-85.051129,Nn),fe=[nl(re),Qs(se)],xe=$.getCenter().lng,Ae=ge($.getCenter().lat,-85.051129,Nn),Pe=[nl(xe),Qs(Ae)];let Re=new Array(3),ze=0;const Fe=fe[0]-Pe[0],Xe=fe[1]-Pe[1];if(Math.abs(Fe)>Math.abs(Xe))ze=Fe>=0?1:3,Re=W;else{ze=Xe>=0?0:2;const Je=[D[4],D[5],D[6]];let ot;ot=Xe>=0?-Math.sin(K($.getSouth()))*fa:-Math.sin(K($.getNorth()))*fa,Re=Oh(Re,W,Je,ot)}const We=V[ze],et=V[(ze+1)%4],rt=new $m(We,et,Re),Ge=[uu(rt,0)||We[0],uu(rt,1)||We[1],uu(rt,2)||We[2]];return A[2]=Math.min(We[2],et[2]),zh(A,A,Ge),Fh(T,T,Ge),_(A,T),new hn(A,T)}function du(u){const e=1<<u.z,d=u.x/e,p=(u.x+1)/e,_=(u.y+1)/e;return[[br(u.y/e),pn(d)],[br(_),pn(p)]]}function Yd(u,e,d,p=fa){return d=K(d),[u*Math.sin(d)*p,-e*p,u*Math.cos(d)*p]}function lo(u,e,d){return Yd(Math.cos(K(u)),Math.sin(K(u)),e,d)}function Wd(u,e,d){const p=Math.pow(2,d.z),_=(u/di+d.x)/p;return lo(br((e/di+d.y)/p),pn(_))}function fu(u){return 16383/Math.max(...ra([],u.max,u.min))}function Hd(u){const e=$n(new Float64Array(16)),d=fu(u);var p,_;return Io(e,e,[d,d,d]),fs(e,e,((p=[])[0]=-(_=u.min)[0],p[1]=-_[1],p[2]=-_[2],p)),e}function Kd(u,e,d,p,_){const x=function(D){const B=di/(2*Math.PI);return D/(2*Math.PI)/B}(d),T=[u,e,-d/(2*Math.PI)],A=$n(new Float64Array(16));return fs(A,A,T),Io(A,A,[x,x,x]),Bh(A,A,K(-_)),Rh(A,A,K(-p)),A}function Jd(u){const{x:e,y:d}=u.point,{lng:p,lat:_}=u._center;return Kd(e,d,u.worldSize,p,_)}const Qd=K(85),Vm=Math.cos(Qd),jm=Math.sin(Qd);function ef(u,e,d){var p=2*Math.PI*6378137/256/Math.pow(2,d);return[u*p-2*Math.PI*6378137/2,e*p-2*Math.PI*6378137/2]}class Kc{constructor(e,d,p){this.z=e,this.x=d,this.y=p,this.key=Ml(0,e,e,d,p)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,d){const p=function(x,T,A){var D=ef(256*x,256*(T=Math.pow(2,A)-T-1),A),B=ef(256*(x+1),256*(T+1),A);return D[0]+","+D[1]+","+B[0]+","+B[1]}(this.x,this.y,this.z),_=function(x,T,A){let D,B="";for(let O=x;O>0;O--)D=1<<O-1,B+=(T&D?1:0)+(A&D?2:0);return B}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace("{z}",String(this.z)).replace("{x}",String(this.x)).replace("{y}",String(d==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",_).replace("{bbox-epsg-3857}",p)}toString(){return`${this.z}/${this.x}/${this.y}`}}class tf{constructor(e,d){this.wrap=e,this.canonical=d,this.key=Ml(e,d.z,d.z,d.x,d.y)}}class kr{constructor(e,d,p,_,x){this.overscaledZ=e,this.wrap=d,this.canonical=new Kc(p,+_,+x),this.key=d===0&&e===p?this.canonical.key:Ml(d,e,p,_,x)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const d=this.canonical.z-e;return e>this.canonical.z?new kr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new kr(e,this.wrap,e,this.canonical.x>>d,this.canonical.y>>d)}calculateScaledKey(e,d=!0){if(this.overscaledZ===e&&d)return this.key;if(e>this.canonical.z)return Ml(this.wrap*+d,e,this.canonical.z,this.canonical.x,this.canonical.y);{const p=this.canonical.z-e;return Ml(this.wrap*+d,e,e,this.canonical.x>>p,this.canonical.y>>p)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const d=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>d&&e.canonical.y===this.canonical.y>>d}children(e){if(this.overscaledZ>=e)return[new kr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const d=this.canonical.z+1,p=2*this.canonical.x,_=2*this.canonical.y;return[new kr(d,this.wrap,d,p,_),new kr(d,this.wrap,d,p+1,_),new kr(d,this.wrap,d,p,_+1),new kr(d,this.wrap,d,p+1,_+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new kr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new kr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new tf(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Ml(u,e,d,p,_){const x=1<<Math.min(d,22);let T=x*(_%x)+p%x;return u&&d<22&&(T+=x*x*((u<0?-2*u-1:2*u)%(1<<2*(22-d)))),16*(32*T+d)+(e-d)}function gs(u,e){if(!e.isReprojectedInTileSpace)return{scale:1<<u.z,x:u.x,y:u.y,x2:u.x+1,y2:u.y+1,projection:e};const d=Math.pow(2,-u.z),p=u.x*d,_=(u.x+1)*d,x=u.y*d,T=(u.y+1)*d,A=pn(p),D=pn(_),B=br(x),O=br(T),$=e.project(A,B),V=e.project(D,B),W=e.project(D,O),re=e.project(A,O);let se=Math.min($.x,V.x,W.x,re.x),fe=Math.min($.y,V.y,W.y,re.y),xe=Math.max($.x,V.x,W.x,re.x),Ae=Math.max($.y,V.y,W.y,re.y);const Pe=d/16;function Re(Fe,Xe,We,et,rt,Ge){const Je=(We+rt)/2,ot=(et+Ge)/2,pt=e.project(pn(Je),br(ot)),at=Math.max(0,se-pt.x,fe-pt.y,pt.x-xe,pt.y-Ae);se=Math.min(se,pt.x),xe=Math.max(xe,pt.x),fe=Math.min(fe,pt.y),Ae=Math.max(Ae,pt.y),at>Pe&&(Re(Fe,pt,We,et,Je,ot),Re(pt,Xe,Je,ot,rt,Ge))}Re($,V,p,x,_,x),Re(V,W,_,x,_,T),Re(W,re,_,T,p,T),Re(re,$,p,T,p,x),se-=Pe,fe-=Pe,xe+=Pe,Ae+=Pe;const ze=1/Math.max(xe-se,Ae-fe);return{scale:ze,x:se*ze,y:fe*ze,x2:xe*ze,y2:Ae*ze,projection:e}}Tt(Kc),Tt(kr,{omit:["projMatrix"]});class rf{constructor(e){this._stringToNumber={},this._numberToString=[];for(let d=0;d<e.length;d++){const p=e[d];this._stringToNumber[p]=d,this._numberToString[d]=p}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const Gm=["tile","layer","source","sourceLayer","state"];class nf{constructor(e,d,p,_,x){this.type="Feature",this._vectorTileFeature=e,this._z=d,this._x=p,this._y=_,this.properties=e.properties,this.id=x}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",geometry:this.geometry,properties:this.properties};this.id!==void 0&&(e.id=this.id);for(const d of Gm)this[d]!==void 0&&(e[d]=this[d]);return e}}const mn=32,Vn=33,Po=new Uint16Array(8184);for(let u=0;u<2046;u++){let e=u+2,d=0,p=0,_=0,x=0,T=0,A=0;for(1&e?_=x=T=mn:d=p=A=mn;(e>>=1)>1;){const B=d+_>>1,O=p+x>>1;1&e?(_=d,x=p,d=T,p=A):(d=_,p=x,_=T,x=A),T=B,A=O}const D=4*u;Po[D+0]=d,Po[D+1]=p,Po[D+2]=_,Po[D+3]=x}const jn=new Uint16Array(2178),Bo=new Uint8Array(1089),Jc=new Uint16Array(1089);function of(u){return u===0?-.03125:u===32?.03125:0}var sf=Me([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const af={type:2,extent:di,loadGeometry:()=>[[new L(0,0),new L(8193,0),new L(8193,8193),new L(0,8193),new L(0,0)]]};class pu{constructor(e,d,p,_,x){this.tileID=e,this.uid=Oe(),this.uses=0,this.tileSize=d,this.tileZoom=p,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=x,this.expiredRequestCount=0,this.state="loading",_&&_.transform&&(this.projection=_.transform.projection)}registerFadeDuration(e){const d=e+this.timeAdded;d<dt.now()||this.fadeEndTime&&d<this.fadeEndTime||(this.fadeEndTime=d)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=gs(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(e,d,p){if(this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(_,x){const T={};if(!x)return T;for(const A of _){const D=A.layerIds.map(B=>x.getLayer(B)).filter(Boolean);if(D.length!==0){A.layers=D,A.stateDependentLayerIds&&(A.stateDependentLayers=A.stateDependentLayerIds.map(B=>D.filter(O=>O.id===B)[0]));for(const B of D)T[B.id]=A}}return T}(e.buckets,d.style),this.hasSymbolBuckets=!1;for(const _ in this.buckets){const x=this.buckets[_];if(x instanceof Do){if(this.hasSymbolBuckets=!0,!p)break;x.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const _ in this.buckets){const x=this.buckets[_];if(x instanceof Do&&x.hasRTLText){this.hasRTLText=!0,Wr.isLoading()||Wr.isLoaded()||Ks()!=="deferred"||wo();break}}this.queryPadding=0;for(const _ in this.buckets){const x=this.buckets[_];this.queryPadding=Math.max(this.queryPadding,d.style.getLayer(_).queryRadius(x))}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage),e.lineAtlas&&(this.lineAtlas=e.lineAtlas)}else this.collisionBoxArray=new En}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugIndexBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(e){return this.buckets[e.id]}upload(e){for(const p in this.buckets){const _=this.buckets[p];_.uploadPending()&&_.upload(e)}const d=e.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new wl(e,this.imageAtlas.image,d.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new wl(e,this.glyphAtlasImage,d.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new wl(e,this.lineAtlas.image,d.ALPHA),this.lineAtlas.uploaded=!0)}prepare(e){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture)}queryRenderedFeatures(e,d,p,_,x,T,A,D){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:_,pixelPosMatrix:A,transform:T,params:x,tileTransform:this.tileTransform},e,d,p):{}}querySourceFeatures(e,d){const p=this.latestFeatureIndex;if(!p||!p.rawTileData)return;const _=p.loadVTLayers(),x=d?d.sourceLayer:"",T=_._geojsonTileLayer||_[x];if(!T)return;const A=Bn(d&&d.filter),{z:D,x:B,y:O}=this.tileID.canonical,$={z:D,x:B,y:O};for(let V=0;V<T.length;V++){const W=T.feature(V);if(A.needGeometry){const fe=ds(W,!0);if(!A.filter(new Vi(this.tileID.overscaledZ),fe,this.tileID.canonical))continue}else if(!A.filter(new Vi(this.tileID.overscaledZ),W))continue;const re=p.getId(W,x),se=new nf(W,D,B,O,re);se.tile=$,e.push(se)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(e){const d=this.expirationTime;if(e.cacheControl){const p=qt(e.cacheControl);p["max-age"]&&(this.expirationTime=Date.now()+1e3*p["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const p=Date.now();let _=!1;if(this.expirationTime>p)_=!1;else if(d)if(this.expirationTime<d)_=!0;else{const x=this.expirationTime-d;x?this.expirationTime=p+Math.max(x,3e4):_=!0}else _=!0;_?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(e,d){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(e).length===0||!d)return;const p=this.latestFeatureIndex.loadVTLayers(),_=d.style.listImages();for(const x in this.buckets){if(!d.style.hasLayer(x))continue;const T=this.buckets[x],A=T.layers[0].sourceLayer||"_geojsonTileLayer",D=p[A],B=e[A];if(!D||!B||Object.keys(B).length===0)continue;if(T.update(B,D,_,this.imageAtlas&&this.imageAtlas.patternPositions||{}),T instanceof Uc||T instanceof Nc){const $=d.style._getSourceCache(T.layers[0].source);d._terrain&&d._terrain.enabled&&$&&T.programConfigurations.needsUpload&&d._terrain._clearRenderCacheForTile($.id,this.tileID)}const O=d&&d.style&&d.style.getLayer(x);O&&(this.queryPadding=Math.max(this.queryPadding,O.queryRadius(T)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<dt.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=dt.now()+e}setTexture(e,d){const p=d.context,_=p.gl;this.texture=d.getTileTexture(e.width),this.texture?this.texture.update(e,{useMipmap:!0}):(this.texture=new wl(p,e,_.RGBA,{useMipmap:!0}),this.texture.bind(_.LINEAR,_.CLAMP_TO_EDGE),p.extTextureFilterAnisotropic&&_.texParameterf(_.TEXTURE_2D,p.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,p.extTextureFilterAnisotropicMax))}setDependencies(e,d){const p={};for(const _ of d)p[_]=!0;this.dependencies[e]=p}hasDependency(e,d){for(const p of e){const _=this.dependencies[p];if(_){for(const x of d)if(_[x])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(e,d){if(!d||d.name==="mercator"||this._tileDebugBuffer)return;const p=no(af,this.tileID.canonical,this.tileTransform)[0],_=new Ee,x=new ei;for(let T=0;T<p.length;T++){const{x:A,y:D}=p[T];_.emplaceBack(A,D),x.emplaceBack(T)}x.emplaceBack(0),this._tileDebugIndexBuffer=e.createIndexBuffer(x),this._tileDebugBuffer=e.createVertexBuffer(_,El.members),this._tileDebugSegments=Ji.simpleSegment(0,0,_.length,x.length)}_makeTileBoundsBuffers(e,d){if(this._tileBoundsBuffer||!d||d.name==="mercator")return;const p=no(af,this.tileID.canonical,this.tileTransform)[0];let _,x;if(this.isRaster){const T=function(A,D){const B=gs(A,D),O=Math.pow(2,A.z);for(let fe=0;fe<Vn;fe++)for(let xe=0;xe<Vn;xe++){const Ae=pn((A.x+(xe+of(xe))/mn)/O),Pe=br((A.y+(fe+of(fe))/mn)/O),Re=D.project(Ae,Pe),ze=fe*Vn+xe;jn[2*ze+0]=Math.round((Re.x*B.scale-B.x)*di),jn[2*ze+1]=Math.round((Re.y*B.scale-B.y)*di)}Bo.fill(0),Jc.fill(0);for(let fe=2045;fe>=0;fe--){const xe=4*fe,Ae=Po[xe+0],Pe=Po[xe+1],Re=Po[xe+2],ze=Po[xe+3],Fe=Ae+Re>>1,Xe=Pe+ze>>1,We=Fe+Xe-Pe,et=Xe+Ae-Fe,rt=Pe*Vn+Ae,Ge=ze*Vn+Re,Je=Xe*Vn+Fe,ot=Math.hypot((jn[2*rt+0]+jn[2*Ge+0])/2-jn[2*Je+0],(jn[2*rt+1]+jn[2*Ge+1])/2-jn[2*Je+1])>=16;if(Bo[Je]=Bo[Je]||(ot?1:0),fe<1022){const pt=(Pe+et>>1)*Vn+(Ae+We>>1),at=(ze+et>>1)*Vn+(Re+We>>1);Bo[Je]=Bo[Je]||Bo[pt]||Bo[at]}}const $=new Se,V=new Ze;let W=0;function re(fe,xe){const Ae=xe*Vn+fe;return Jc[Ae]===0&&($.emplaceBack(jn[2*Ae+0],jn[2*Ae+1],fe*di/mn,xe*di/mn),Jc[Ae]=++W),Jc[Ae]-1}function se(fe,xe,Ae,Pe,Re,ze){const Fe=fe+Ae>>1,Xe=xe+Pe>>1;if(Math.abs(fe-Re)+Math.abs(xe-ze)>1&&Bo[Xe*Vn+Fe])se(Re,ze,fe,xe,Fe,Xe),se(Ae,Pe,Re,ze,Fe,Xe);else{const We=re(fe,xe),et=re(Ae,Pe),rt=re(Re,ze);V.emplaceBack(We,et,rt)}}return se(0,0,mn,mn,mn,0),se(mn,mn,0,0,0,mn),{vertices:$,indices:V}}(this.tileID.canonical,d);_=T.vertices,x=T.indices}else{_=new Se,x=new Ze;for(const{x:A,y:D}of p)_.emplaceBack(A,D,0,0);const T=Rc(_.int16,void 0,4);for(let A=0;A<T.length;A+=3)x.emplaceBack(T[A],T[A+1],T[A+2])}this._tileBoundsBuffer=e.createVertexBuffer(_,sf.members),this._tileBoundsIndexBuffer=e.createIndexBuffer(x),this._tileBoundsSegments=Ji.simpleSegment(0,0,_.length,x.length)}_makeGlobeTileDebugBuffers(e,d){if(this._globeTileDebugBorderBuffer||this._globeTileDebugTextBuffer||!d||d.name!=="globe")return;const p=this.tileID.canonical,_=Hd(Tl(p));this._makeGlobeTileDebugBorderBuffer(e,p,_),this._makeGlobeTileDebugTextBuffer(e,p,_)}_makeGlobeTileDebugBorderBuffer(e,d,p){const _=new Ee,x=new ei,T=new Te,A=(B,O,$,V,W)=>{const re=($-B)/(W-1),se=(V-O)/(W-1),fe=_.length;for(let xe=0;xe<W;xe++){const Ae=B+xe*re,Pe=O+xe*se;_.emplaceBack(Ae,Pe);const Re=Wd(Ae,Pe,d),ze=ps(Re,Re,p);T.emplaceBack(ze[0],ze[1],ze[2]),x.emplaceBack(fe+xe)}},D=di;A(0,0,D,0,16),A(D,0,D,D,16),A(D,D,0,D,16),A(0,D,0,0,16),this._tileDebugIndexBuffer=e.createIndexBuffer(x),this._tileDebugBuffer=e.createVertexBuffer(_,El.members),this._globeTileDebugBorderBuffer=e.createVertexBuffer(T,Xd.members),this._tileDebugSegments=Ji.simpleSegment(0,0,_.length,x.length)}_makeGlobeTileDebugTextBuffer(e,d,p){const _=new Ee,x=new Ze,T=new Te,A=25;x.reserve(32),_.reserve(A),T.reserve(A);const D=(B,O)=>A*B+O;for(let B=0;B<A;B++){const O=2048*B;for(let $=0;$<A;$++){const V=2048*$;_.emplaceBack(V,O);const W=Wd(V,O,d),re=ps(W,W,p);T.emplaceBack(re[0],re[1],re[2])}}for(let B=0;B<4;B++)for(let O=0;O<4;O++){const $=D(B,O),V=D(B,O+1),W=D(B+1,O),re=D(B+1,O+1);x.emplaceBack($,V,W),x.emplaceBack(W,V,re)}this._tileDebugTextIndexBuffer=e.createIndexBuffer(x),this._tileDebugTextBuffer=e.createVertexBuffer(_,El.members),this._globeTileDebugTextBuffer=e.createVertexBuffer(T,Xd.members),this._tileDebugTextSegments=Ji.simpleSegment(0,0,A,32)}}class qm{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,d,p){const _=String(d);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][_]=this.stateChanges[e][_]||{},he(this.stateChanges[e][_],p),this.deletedStates[e]===null){this.deletedStates[e]={};for(const x in this.state[e])x!==_&&(this.deletedStates[e][x]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][_]===null){this.deletedStates[e][_]={};for(const x in this.state[e][_])p[x]||(this.deletedStates[e][_][x]=null)}else for(const x in p)this.deletedStates[e]&&this.deletedStates[e][_]&&this.deletedStates[e][_][x]===null&&delete this.deletedStates[e][_][x]}removeFeatureState(e,d,p){if(this.deletedStates[e]===null)return;const _=String(d);if(this.deletedStates[e]=this.deletedStates[e]||{},p&&d!==void 0)this.deletedStates[e][_]!==null&&(this.deletedStates[e][_]=this.deletedStates[e][_]||{},this.deletedStates[e][_][p]=null);else if(d!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][_])for(p in this.deletedStates[e][_]={},this.stateChanges[e][_])this.deletedStates[e][_][p]=null;else this.deletedStates[e][_]=null;else this.deletedStates[e]=null}getState(e,d){const p=String(d),_=he({},(this.state[e]||{})[p],(this.stateChanges[e]||{})[p]);if(this.deletedStates[e]===null)return{};if(this.deletedStates[e]){const x=this.deletedStates[e][d];if(x===null)return{};for(const T in x)delete _[T]}return _}initializeTileState(e,d){e.setFeatureState(this.state,d)}coalesceChanges(e,d){const p={};for(const _ in this.stateChanges){this.state[_]=this.state[_]||{};const x={};for(const T in this.stateChanges[_])this.state[_][T]||(this.state[_][T]={}),he(this.state[_][T],this.stateChanges[_][T]),x[T]=this.state[_][T];p[_]=x}for(const _ in this.deletedStates){this.state[_]=this.state[_]||{};const x={};if(this.deletedStates[_]===null)for(const T in this.state[_])x[T]={},this.state[_][T]={};else for(const T in this.deletedStates[_]){if(this.deletedStates[_][T]===null)this.state[_][T]={};else for(const A of Object.keys(this.deletedStates[_][T]))delete this.state[_][T][A];x[T]=this.state[_][T]}p[_]=p[_]||{},he(p[_],x)}if(this.stateChanges={},this.deletedStates={},Object.keys(p).length!==0)for(const _ in e)e[_].setFeatureState(p,d)}}class lf{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,d){const p=this.toIdx(e,d);return{min:this.minimums[p],max:this.maximums[p]}}isLeaf(e,d){return this.leaves[this.toIdx(e,d)]}toIdx(e,d){return d*this.size+e}}function cf(u,e,d,p){let _=0,x=Number.MAX_VALUE;for(let T=0;T<3;T++)if(Math.abs(p[T])<1e-15){if(d[T]<u[T]||d[T]>e[T])return null}else{const A=1/p[T];let D=(u[T]-d[T])*A,B=(e[T]-d[T])*A;if(D>B){const O=D;D=B,B=O}if(D>_&&(_=D),B<x&&(x=B),_>x)return null}return _}function hf(u,e,d,p,_,x,T,A,D,B,O){const $=p-u,V=_-e,W=x-d,re=T-u,se=A-e,fe=D-d,xe=O[1]*fe-O[2]*se,Ae=O[2]*re-O[0]*fe,Pe=O[0]*se-O[1]*re,Re=$*xe+V*Ae+W*Pe;if(Math.abs(Re)<1e-15)return null;const ze=1/Re,Fe=B[0]-u,Xe=B[1]-e,We=B[2]-d,et=(Fe*xe+Xe*Ae+We*Pe)*ze;if(et<0||et>1)return null;const rt=Xe*W-We*V,Ge=We*$-Fe*W,Je=Fe*V-Xe*$,ot=(O[0]*rt+O[1]*Ge+O[2]*Je)*ze;return ot<0||et+ot>1?null:(re*rt+se*Ge+fe*Je)*ze}function uf(u,e,d){return(u-e)/(d-e)}function df(u,e,d,p,_,x,T,A,D){const B=1<<d,O=x-p,$=T-_,V=(u+1)/B*O+p,W=(e+0)/B*$+_,re=(e+1)/B*$+_;A[0]=(u+0)/B*O+p,A[1]=W,D[0]=V,D[1]=re}class ff{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const d=function(x){const T=Math.ceil(Math.log2(x.dim/8)),A=[];let D=Math.ceil(Math.pow(2,T));const B=1/D,O=(W,re,se,fe,xe)=>{const Ae=fe?1:0,Pe=(W+1)*se-Ae,Re=re*se,ze=(re+1)*se-Ae;xe[0]=W*se,xe[1]=Re,xe[2]=Pe,xe[3]=ze};let $=new lf(D);const V=[];for(let W=0;W<D*D;W++){O(W%D,Math.floor(W/D),B,!1,V);const re=Ro(V[0],V[1],x),se=Ro(V[2],V[1],x),fe=Ro(V[2],V[3],x),xe=Ro(V[0],V[3],x);$.minimums.push(Math.min(re,se,fe,xe)),$.maximums.push(Math.max(re,se,fe,xe)),$.leaves.push(1)}for(A.push($),D/=2;D>=1;D/=2){const W=A[A.length-1];$=new lf(D);for(let re=0;re<D*D;re++){O(re%D,Math.floor(re/D),2,!0,V);const se=W.getElevation(V[0],V[1]),fe=W.getElevation(V[2],V[1]),xe=W.getElevation(V[2],V[3]),Ae=W.getElevation(V[0],V[3]),Pe=W.isLeaf(V[0],V[1]),Re=W.isLeaf(V[2],V[1]),ze=W.isLeaf(V[2],V[3]),Fe=W.isLeaf(V[0],V[3]),Xe=Math.min(se.min,fe.min,xe.min,Ae.min),We=Math.max(se.max,fe.max,xe.max,Ae.max),et=Pe&&Re&&ze&&Fe;$.maximums.push(We),$.minimums.push(Xe),$.leaves.push(We-Xe<=5&&et?1:0)}A.push($)}return A}(this.dem),p=d.length-1,_=d[p];this._addNode(_.minimums[0],_.maximums[0],_.leaves[0]),this._construct(d,0,0,p,0)}raycastRoot(e,d,p,_,x,T,A=1){return cf([e,d,-100],[p,_,this.maximums[0]*A],x,T)}raycast(e,d,p,_,x,T,A=1){if(!this.nodeCount)return null;const D=this.raycastRoot(e,d,p,_,x,T,A);if(D==null)return null;const B=[],O=[],$=[],V=[],W=[{idx:0,t:D,nodex:0,nodey:0,depth:0}];for(;W.length>0;){const{idx:re,t:se,nodex:fe,nodey:xe,depth:Ae}=W.pop();if(this.leaves[re]){df(fe,xe,Ae,e,d,p,_,$,V);const Re=1<<Ae,ze=(fe+0)/Re,Fe=(fe+1)/Re,Xe=(xe+0)/Re,We=(xe+1)/Re,et=Ro(ze,Xe,this.dem)*A,rt=Ro(Fe,Xe,this.dem)*A,Ge=Ro(Fe,We,this.dem)*A,Je=Ro(ze,We,this.dem)*A,ot=hf($[0],$[1],et,V[0],$[1],rt,V[0],V[1],Ge,x,T),pt=hf(V[0],V[1],Ge,$[0],V[1],Je,$[0],$[1],et,x,T),at=Math.min(ot!==null?ot:Number.MAX_VALUE,pt!==null?pt:Number.MAX_VALUE);if(at!==Number.MAX_VALUE)return at;{const ut=Oh([],x,T,se);if(pf(et,rt,Je,Ge,uf(ut[0],$[0],V[0]),uf(ut[1],$[1],V[1]))>=ut[2])return se}continue}let Pe=0;for(let Re=0;Re<this._siblingOffset.length;Re++){df((fe<<1)+this._siblingOffset[Re][0],(xe<<1)+this._siblingOffset[Re][1],Ae+1,e,d,p,_,$,V),$[2]=-100,V[2]=this.maximums[this.childOffsets[re]+Re]*A;const ze=cf($,V,x,T);if(ze!=null){const Fe=ze;B[Re]=Fe;let Xe=!1;for(let We=0;We<Pe&&!Xe;We++)Fe>=B[O[We]]&&(O.splice(We,0,Re),Xe=!0);Xe||(O[Pe]=Re),Pe++}}for(let Re=0;Re<Pe;Re++){const ze=O[Re];W.push({idx:this.childOffsets[re]+ze,t:B[ze],nodex:(fe<<1)+this._siblingOffset[ze][0],nodey:(xe<<1)+this._siblingOffset[ze][1],depth:Ae+1})}}return null}_addNode(e,d,p){return this.minimums.push(e),this.maximums.push(d),this.leaves.push(p),this.childOffsets.push(0),this.nodeCount++}_construct(e,d,p,_,x){if(e[_].isLeaf(d,p)===1)return;this.childOffsets[x]||(this.childOffsets[x]=this.nodeCount);const T=_-1,A=e[T];let D=0,B=0;for(let O=0;O<this._siblingOffset.length;O++){const $=2*d+this._siblingOffset[O][0],V=2*p+this._siblingOffset[O][1],W=A.getElevation($,V),re=A.isLeaf($,V),se=this._addNode(W.min,W.max,re);re&&(D|=1<<O),B||(B=se)}for(let O=0;O<this._siblingOffset.length;O++)D&1<<O||this._construct(e,2*d+this._siblingOffset[O][0],2*p+this._siblingOffset[O][1],T,B+O)}}function pf(u,e,d,p,_,x){return Zt(Zt(u,d,x),Zt(e,p,x),_)}function Ro(u,e,d){const p=d.dim,_=ge(u*p-.5,0,p-1),x=ge(e*p-.5,0,p-1),T=Math.floor(_),A=Math.floor(x),D=Math.min(T+1,p-1),B=Math.min(A+1,p-1);return pf(d.get(T,A),d.get(D,A),d.get(T,B),d.get(D,B),_-T,x-A)}const mf={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class Qc{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,d,p,_=!1,x=!1){if(this.uid=e,d.height!==d.width)throw new RangeError("DEM tiles must be square");if(p&&p!=="mapbox"&&p!=="terrarium")return nt(`"${p}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=d.height;const T=this.dim=d.height-2,A=new Uint32Array(d.data.buffer);if(this.pixels=new Uint8Array(d.data.buffer),this.encoding=p||"mapbox",this.borderReady=_,!_){for(let D=0;D<T;D++)A[this._idx(-1,D)]=A[this._idx(0,D)],A[this._idx(T,D)]=A[this._idx(T-1,D)],A[this._idx(D,-1)]=A[this._idx(D,0)],A[this._idx(D,T)]=A[this._idx(D,T-1)];A[this._idx(-1,-1)]=A[this._idx(0,0)],A[this._idx(T,-1)]=A[this._idx(T-1,0)],A[this._idx(-1,T)]=A[this._idx(0,T-1)],A[this._idx(T,T)]=A[this._idx(T-1,T-1)],x&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new ff(this)}get(e,d,p=!1){p&&(e=ge(e,-1,this.dim),d=ge(d,-1,this.dim));const _=4*this._idx(e,d);return(this.encoding==="terrarium"?this._unpackTerrarium:this._unpackMapbox)(this.pixels[_],this.pixels[_+1],this.pixels[_+2])}static getUnpackVector(e){return mf[e]}get unpackVector(){return mf[this.encoding]}_idx(e,d){if(e<-1||e>=this.dim+1||d<-1||d>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(d+1)*this.stride+(e+1)}_unpackMapbox(e,d,p){return(256*e*256+256*d+p)/10-1e4}_unpackTerrarium(e,d,p){return 256*e+d+p/256-32768}static pack(e,d){const p=[0,0,0,0],_=Qc.getUnpackVector(d);let x=Math.floor((e+_[3])/_[2]);return p[2]=x%256,x=Math.floor(x/256),p[1]=x%256,x=Math.floor(x/256),p[0]=x,p}getPixels(){return new Jr({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,d,p){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let _=d*this.dim,x=d*this.dim+this.dim,T=p*this.dim,A=p*this.dim+this.dim;switch(d){case-1:_=x-1;break;case 1:x=_+1}switch(p){case-1:T=A-1;break;case 1:A=T+1}const D=-d*this.dim,B=-p*this.dim;for(let O=T;O<A;O++)for(let $=_;$<x;$++){const V=4*this._idx($,O),W=4*this._idx($+D,O+B);this.pixels[V+0]=e.pixels[W+0],this.pixels[V+1]=e.pixels[W+1],this.pixels[V+2]=e.pixels[W+2],this.pixels[V+3]=e.pixels[W+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Tt(Qc),Tt(ff,{omit:["dem"]});class Zm{constructor(e,d){this.max=e,this.onRemove=d,this.reset()}reset(){for(const e in this.data)for(const d of this.data[e])d.timeout&&clearTimeout(d.timeout),this.onRemove(d.value);return this.data={},this.order=[],this}add(e,d,p){const _=e.wrapped().key;this.data[_]===void 0&&(this.data[_]=[]);const x={value:d,timeout:void 0};if(p!==void 0&&(x.timeout=setTimeout(()=>{this.remove(e,x)},p)),this.data[_].push(x),this.order.push(_),this.order.length>this.max){const T=this._getAndRemoveByKey(this.order[0]);T&&this.onRemove(T)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const d=this.data[e].shift();return d.timeout&&clearTimeout(d.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),d.value}getByKey(e){const d=this.data[e];return d?d[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,d){if(!this.has(e))return this;const p=e.wrapped().key,_=d===void 0?0:this.data[p].indexOf(d),x=this.data[p][_];return this.data[p].splice(_,1),x.timeout&&clearTimeout(x.timeout),this.data[p].length===0&&delete this.data[p],this.onRemove(x.value),this.order.splice(this.order.indexOf(p),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const d=this._getAndRemoveByKey(this.order[0]);d&&this.onRemove(d)}return this}filter(e){const d=[];for(const p in this.data)for(const _ of this.data[p])e(_.value)||d.push(_);for(const p of d)this.remove(p.value.tileID,p)}}class pa{constructor(e,d,p){this.func=e,this.mask=d,this.range=p}}pa.ReadOnly=!1,pa.ReadWrite=!0,pa.disabled=new pa(519,pa.ReadOnly,[0,1]);const mu=7680;class gu{constructor(e,d,p,_,x,T){this.test=e,this.ref=d,this.mask=p,this.fail=_,this.depthFail=x,this.pass=T}}gu.disabled=new gu({func:519,mask:0},0,0,mu,mu,mu);class Gn{constructor(e,d,p){this.blendFunction=e,this.blendColor=d,this.mask=p}}Gn.Replace=[1,0],Gn.disabled=new Gn(Gn.Replace,Ci.transparent,[!1,!1,!1,!1]),Gn.unblended=new Gn(Gn.Replace,Ci.transparent,[!0,!0,!0,!0]),Gn.alphaBlended=new Gn([1,771],Ci.transparent,[!0,!0,!0,!0]);const _u=1029,yu=2305;class An{constructor(e,d,p){this.enable=e,this.mode=d,this.frontFace=p}}An.disabled=new An(!1,_u,yu),An.backCCW=new An(!0,_u,yu),An.backCW=new An(!0,_u,2304),An.frontCW=new An(!0,1028,2304),An.frontCCW=new An(!0,1028,yu);class _s extends Yt{constructor(e,d,p){super(),this.id=e,this._onlySymbols=p,d.on("data",_=>{_.dataType==="source"&&_.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&_.dataType==="source"&&_.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),d.on("error",()=>{this._sourceErrored=!0}),this._source=d,this._tiles={},this._cache=new Zm(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=d.minTileCacheSize,this._maxTileCacheSize=d.maxTileCacheSize,this._loadedParentTiles={},this._coveredTiles={},this._state=new qm,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(e){this.map=e,this._minTileCacheSize=this._minTileCacheSize===void 0&&e?e._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&e?e._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const e in this._tiles){const d=this._tiles[e];if(d.state!=="loaded"&&d.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,d){return e.isSymbolTile=this._onlySymbols,this._source.loadTile(e,d)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e,()=>{})}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e,()=>{})}serialize(){return this._source.serialize()}prepare(e){if(this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null),this._source.prepareTile)for(const d in this._tiles){const p=this._tiles[d];this._source.prepareTile(p)&&this.map.painter.terrain&&this.map.painter.terrain._clearRenderCacheForTile(this.id,p.tileID),p.upload(e),p.prepare(this.map.style.imageManager)}else for(const d in this._tiles){const p=this._tiles[d];p.upload(e),p.prepare(this.map.style.imageManager)}}getIds(){return te(this._tiles).map(e=>e.tileID).sort(gf).map(e=>e.key)}getRenderableIds(e){const d=[];for(const p in this._tiles)this._isIdRenderable(+p,e)&&d.push(this._tiles[p]);return e?d.sort((p,_)=>{const x=p.tileID,T=_.tileID,A=new L(x.canonical.x,x.canonical.y)._rotate(this.transform.angle),D=new L(T.canonical.x,T.canonical.y)._rotate(this.transform.angle);return x.overscaledZ-T.overscaledZ||D.y-A.y||D.x-A.x}).map(p=>p.tileID.key):d.map(p=>p.tileID).sort(gf).map(p=>p.key)}hasRenderableParent(e){const d=this.findLoadedParent(e,0);return!!d&&this._isIdRenderable(d.tileID.key)}_isIdRenderable(e,d){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(d||!this._tiles[e].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(+e,"reloading")}}_reloadTile(e,d){const p=this._tiles[e];p&&(p.state!=="loading"&&(p.state=d),this._loadTile(p,this._tileLoaded.bind(this,p,e,d)))}_tileLoaded(e,d,p,_){if(_)if(e.state="errored",_.status!==404)this._source.fire(new Bt(_,{tile:e}));else if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const x=this.map.painter.terrain;this.update(this.transform,x.getScaledDemTileSize(),!0),x.resetTileLookupCache(this.id)}else this.update(this.transform);else e.timeAdded=dt.now(),p==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(d,e),this._source.type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),this._source.fire(new bt("data",{dataType:"source",tile:e,coord:e.tileID,sourceCacheId:this.id}))}_backfillDEM(e){const d=this.getRenderableIds();for(let _=0;_<d.length;_++){const x=d[_];if(e.neighboringTiles&&e.neighboringTiles[x]){const T=this.getTileByID(x);p(e,T),p(T,e)}}function p(_,x){if(!_.dem||_.dem.borderReady)return;_.needsHillshadePrepare=!0,_.needsDEMTextureUpload=!0;let T=x.tileID.canonical.x-_.tileID.canonical.x;const A=x.tileID.canonical.y-_.tileID.canonical.y,D=Math.pow(2,_.tileID.canonical.z),B=x.tileID.key;T===0&&A===0||Math.abs(A)>1||(Math.abs(T)>1&&(Math.abs(T+D)===1?T+=D:Math.abs(T-D)===1&&(T-=D)),x.dem&&_.dem&&(_.dem.backfillBorder(x.dem,T,A),_.neighboringTiles&&_.neighboringTiles[B]&&(_.neighboringTiles[B].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,d,p,_){for(const x in this._tiles){let T=this._tiles[x];if(_[x]||!T.hasData()||T.tileID.overscaledZ<=d||T.tileID.overscaledZ>p)continue;let A=T.tileID;for(;T&&T.tileID.overscaledZ>d+1;){const B=T.tileID.scaledTo(T.tileID.overscaledZ-1);T=this._tiles[B.key],T&&T.hasData()&&(A=B)}let D=A;for(;D.overscaledZ>d;)if(D=D.scaledTo(D.overscaledZ-1),e[D.key]){_[A.key]=A;break}}}findLoadedParent(e,d){if(e.key in this._loadedParentTiles){const p=this._loadedParentTiles[e.key];return p&&p.tileID.overscaledZ>=d?p:null}for(let p=e.overscaledZ-1;p>=d;p--){const _=e.scaledTo(p),x=this._getLoadedTile(_);if(x)return x}}_getLoadedTile(e){const d=this._tiles[e.key];return d&&d.hasData()?d:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,d){d=d||this._source.tileSize;const p=Math.ceil(e.width/d)+1,_=Math.ceil(e.height/d)+1,x=Math.floor(p*_*5),T=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,x):x,A=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,T):T;this._cache.setMaxSize(A)}handleWrapJump(e){const d=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,d){const p={};for(const _ in this._tiles){const x=this._tiles[_];x.tileID=x.tileID.unwrapTo(x.tileID.wrap+d),p[x.tileID.key]=x}this._tiles=p;for(const _ in this._timers)clearTimeout(this._timers[_]),delete this._timers[_];for(const _ in this._tiles)this._setTileReloadTimer(+_,this._tiles[_])}}update(e,d,p){if(this.transform=e,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!p)return;let _;this.updateCacheSize(e,d),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?_=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(A=>new kr(A.canonical.z,A.wrap,A.canonical.z,A.canonical.x,A.canonical.y)):(_=e.coveringTiles({tileSize:d||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!p,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(_=_.filter(A=>this._source.hasTile(A)))):_=[];const x=this._updateRetainedTiles(_);if(_f(this._source.type)&&_.length!==0){const A={},D={},B=Object.keys(x);for(const $ of B){const V=x[$],W=this._tiles[$];if(!W||W.fadeEndTime&&W.fadeEndTime<=dt.now())continue;const re=this.findLoadedParent(V,Math.max(V.overscaledZ-_s.maxOverzooming,this._source.minzoom));re&&(this._addTile(re.tileID),A[re.tileID.key]=re.tileID),D[$]=V}const O=_[_.length-1].overscaledZ;for(const $ in this._tiles){const V=this._tiles[$];if(x[$]||!V.hasData())continue;let W=V.tileID;for(;W.overscaledZ>O;){W=W.scaledTo(W.overscaledZ-1);const re=this._tiles[W.key];if(re&&re.hasData()&&D[W.key]){x[$]=V.tileID;break}}}for(const $ in A)x[$]||(this._coveredTiles[$]=!0,x[$]=A[$])}for(const A in x)this._tiles[A].clearFadeHold();const T=function(A,D){const B=[];for(const O in A)O in D||B.push(O);return B}(this._tiles,x);for(const A of T){const D=this._tiles[A];D.hasSymbolBuckets&&!D.holdingForFade()?D.setHoldDuration(this.map._fadeDuration):D.hasSymbolBuckets&&!D.symbolFadeFinished()||this._removeTile(+A)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){const d={};if(e.length===0)return d;const p={},_=e.reduce((B,O)=>Math.min(B,O.overscaledZ),1/0),x=e[0].overscaledZ,T=Math.max(x-_s.maxOverzooming,this._source.minzoom),A=Math.max(x+_s.maxUnderzooming,this._source.minzoom),D={};for(const B of e){const O=this._addTile(B);d[B.key]=B,O.hasData()||_<this._source.maxzoom&&(D[B.key]=B)}this._retainLoadedChildren(D,_,A,d);for(const B of e){let O=this._tiles[B.key];if(O.hasData())continue;if(B.canonical.z>=this._source.maxzoom){const V=B.children(this._source.maxzoom)[0],W=this.getTile(V);if(W&&W.hasData()){d[V.key]=V;continue}}else{const V=B.children(this._source.maxzoom);if(d[V[0].key]&&d[V[1].key]&&d[V[2].key]&&d[V[3].key])continue}let $=O.wasRequested();for(let V=B.overscaledZ-1;V>=T;--V){const W=B.scaledTo(V);if(p[W.key]||(p[W.key]=!0,O=this.getTile(W),!O&&$&&(O=this._addTile(W)),O&&(d[W.key]=W,$=O.wasRequested(),O.hasData())))break}}return d}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const d=[];let p,_=this._tiles[e].tileID;for(;_.overscaledZ>0;){if(_.key in this._loadedParentTiles){p=this._loadedParentTiles[_.key];break}d.push(_.key);const x=_.scaledTo(_.overscaledZ-1);if(p=this._getLoadedTile(x),p)break;_=x}for(const x of d)this._loadedParentTiles[x]=p}}_addTile(e){let d=this._tiles[e.key];if(d)return this._source.prepareTile&&this._source.prepareTile(d),d;d=this._cache.getAndRemove(e),d&&(this._setTileReloadTimer(e.key,d),d.tileID=e,this._state.initializeTileState(d,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,d)));const p=Boolean(d);if(!p){const _=this.map?this.map.painter:null;d=new pu(e,this._source.tileSize*e.overscaleFactor(),this.transform.tileZoom,_,this._isRaster),this._source.prepareTile&&this._source.prepareTile(d)||this._loadTile(d,this._tileLoaded.bind(this,d,e.key,d.state))}return d?(d.uses++,this._tiles[e.key]=d,p||this._source.fire(new bt("dataloading",{tile:d,coord:d.tileID,dataType:"source"})),d):null}_setTileReloadTimer(e,d){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const p=d.getExpiryTimeout();p&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},p))}_removeTile(e){const d=this._tiles[e];d&&(d.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),d.uses>0||(d.hasData()&&d.state!=="reloading"?this._cache.add(d.tileID,d,d.getExpiryTimeout()):(d.aborted=!0,this._abortTile(d),this._unloadTile(d))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(e,d,p){const _=[],x=this.transform;if(!x)return _;for(const T in this._tiles){const A=this._tiles[T];if(p&&A.clearQueryDebugViz(),A.holdingForFade())continue;const D=e.containsTile(A,x,d);D&&_.push(D)}return _}getVisibleCoordinates(e){const d=this.getRenderableIds(e).map(p=>this._tiles[p].tileID);for(const p of d)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped());return d}hasTransition(){if(this._source.hasTransition())return!0;if(_f(this._source.type))for(const e in this._tiles){const d=this._tiles[e];if(d.fadeEndTime!==void 0&&d.fadeEndTime>=dt.now())return!0}return!1}setFeatureState(e,d,p){this._state.updateState(e=e||"_geojsonTileLayer",d,p)}removeFeatureState(e,d,p){this._state.removeFeatureState(e=e||"_geojsonTileLayer",d,p)}getFeatureState(e,d){return this._state.getState(e=e||"_geojsonTileLayer",d)}setDependencies(e,d,p){const _=this._tiles[e];_&&_.setDependencies(d,p)}reloadTilesForDependencies(e,d){for(const p in this._tiles)this._tiles[p].hasDependency(e,d)&&this._reloadTile(+p,"reloading");this._cache.filter(p=>!p.hasDependency(e,d))}_preloadTiles(e,d){const p=new Map,_=Array.isArray(e)?e:[e],x=this.map.painter.terrain,T=this.usedForTerrain&&x?x.getScaledDemTileSize():this._source.tileSize;for(const A of _){const D=A.coveringTiles({tileSize:T,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const B of D)p.set(B.key,B);this.usedForTerrain&&A.updateElevation(!1)}ve(Array.from(p.values()),(A,D)=>{const B=new pu(A,this._source.tileSize*A.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(B,O=>{this._source.type==="raster-dem"&&B.dem&&this._backfillDEM(B),D(O,B)})},d)}}function gf(u,e){const d=Math.abs(2*u.wrap)-+(u.wrap<0),p=Math.abs(2*e.wrap)-+(e.wrap<0);return u.overscaledZ-e.overscaledZ||p-d||e.canonical.y-u.canonical.y||e.canonical.x-u.canonical.x}function _f(u){return u==="raster"||u==="image"||u==="video"}_s.maxOverzooming=10,_s.maxUnderzooming=3;class eh{constructor(e,d,p){this._demTile=e,this._dem=this._demTile.dem,this._scale=d,this._offset=p}static create(e,d,p){const _=p||e.findDEMTileFor(d);if(!_||!_.dem)return;const x=_.dem,T=_.tileID,A=1<<d.canonical.z-T.canonical.z;return new eh(_,_.tileSize/di/A,[(d.canonical.x/A-T.canonical.x)*x.dim,(d.canonical.y/A-T.canonical.y)*x.dim])}tileCoordToPixel(e,d){const p=d*this._scale+this._offset[1],_=Math.floor(e*this._scale+this._offset[0]),x=Math.floor(p);return new L(_,x)}getElevationAt(e,d,p,_){const x=e*this._scale+this._offset[0],T=d*this._scale+this._offset[1],A=Math.floor(x),D=Math.floor(T),B=this._dem;return _=!!_,p?Zt(Zt(B.get(A,D,_),B.get(A,D+1,_),T-D),Zt(B.get(A+1,D,_),B.get(A+1,D+1,_),T-D),x-A):B.get(A,D,_)}getElevationAtPixel(e,d,p){return this._dem.get(e,d,!!p)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*ea(1,e)*this._dem.stride}}class yf{constructor(e,d){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new zn(di,16,0),this.featureIndexArray=new Xi,this.promoteId=d}insert(e,d,p,_,x,T=0){const A=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(p,_,x,T);const D=this.grid;for(let B=0;B<d.length;B++){const O=d[B],$=[1/0,1/0,-1/0,-1/0];for(let V=0;V<O.length;V++){const W=O[V];$[0]=Math.min($[0],W.x),$[1]=Math.min($[1],W.y),$[2]=Math.max($[2],W.x),$[3]=Math.max($[3],W.y)}$[0]<di&&$[1]<di&&$[2]>=0&&$[3]>=0&&D.insert(A,$[0],$[1],$[2],$[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new ms.VectorTile(new xl(this.rawTileData)).layers,this.sourceLayerCoder=new rf(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,d,p,_){this.loadVTLayers();const x=e.params||{},T=Bn(x.filter),A=e.tileResult,D=e.transform,B=A.bufferedTilespaceBounds,O=this.grid.query(B.min.x,B.min.y,B.max.x,B.max.y,(re,se,fe,xe)=>Ou(A.bufferedTilespaceGeometry,re,se,fe,xe));O.sort(Xm);let $=null;D.elevation&&O.length>0&&($=eh.create(D.elevation,this.tileID));const V={};let W;for(let re=0;re<O.length;re++){const se=O[re];if(se===W)continue;W=se;const fe=this.featureIndexArray.get(se);let xe=null;this.loadMatchingFeature(V,fe,T,x.layers,x.availableImages,d,p,_,(Ae,Pe,Re,ze=0)=>(xe||(xe=no(Ae,this.tileID.canonical,e.tileTransform)),Pe.queryIntersectsFeature(A,Ae,Re,xe,this.z,e.transform,e.pixelPosMatrix,$,ze)))}return V}loadMatchingFeature(e,d,p,_,x,T,A,D,B){const{featureIndex:O,bucketIndex:$,sourceLayerIndex:V,layoutVertexArrayOffset:W}=d,re=this.bucketLayerIDs[$];if(_&&!function(Ae,Pe){for(let Re=0;Re<Ae.length;Re++)if(Pe.indexOf(Ae[Re])>=0)return!0;return!1}(_,re))return;const se=this.sourceLayerCoder.decode(V),fe=this.vtLayers[se].feature(O);if(p.needGeometry){const Ae=ds(fe,!0);if(!p.filter(new Vi(this.tileID.overscaledZ),Ae,this.tileID.canonical))return}else if(!p.filter(new Vi(this.tileID.overscaledZ),fe))return;const xe=this.getId(fe,se);for(let Ae=0;Ae<re.length;Ae++){const Pe=re[Ae];if(_&&_.indexOf(Pe)<0)continue;const Re=T[Pe];if(!Re)continue;let ze={};xe!==void 0&&D&&(ze=D.getState(Re.sourceLayer||"_geojsonTileLayer",xe));const Fe=he({},A[Pe]);Fe.paint=xf(Fe.paint,Re.paint,fe,ze,x),Fe.layout=xf(Fe.layout,Re.layout,fe,ze,x);const Xe=!B||B(fe,Re,ze,W);if(!Xe)continue;const We=new nf(fe,this.z,this.x,this.y,xe);We.layer=Fe;let et=e[Pe];et===void 0&&(et=e[Pe]=[]),et.push({featureIndex:O,feature:We,intersectionZ:Xe})}}lookupSymbolFeatures(e,d,p,_,x,T,A,D){const B={};this.loadVTLayers();const O=Bn(x);for(const $ of e)this.loadMatchingFeature(B,{bucketIndex:p,sourceLayerIndex:_,featureIndex:$,layoutVertexArrayOffset:0},O,T,A,D,d);return B}loadFeature(e){const{featureIndex:d,sourceLayerIndex:p}=e;this.loadVTLayers();const _=this.sourceLayerCoder.decode(p),x=this.vtFeatures[_];if(x[d])return x[d];const T=this.vtLayers[_].feature(d);return x[d]=T,T}hasLayer(e){for(const d of this.bucketLayerIDs)for(const p of d)if(e===p)return!0;return!1}getId(e,d){let p=e.id;return this.promoteId&&(p=e.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[d]],typeof p=="boolean"&&(p=Number(p))),p}}function xf(u,e,d,p,_){return Vt(u,(x,T)=>{const A=e instanceof k?e.get(T):null;return A&&A.evaluate?A.evaluate(d,p,_):A})}function Xm(u,e){return e-u}Tt(yf,{omit:["rawTileData","sourceLayerCoder"]});class vf{constructor(e){const d={},p=[];for(const A in e){const D=e[A],B=d[A]={};for(const O in D.glyphs){const $=D.glyphs[+O];if(!$||$.bitmap.width===0||$.bitmap.height===0)continue;const V=$.metrics.localGlyph?2:1,W={x:0,y:0,w:$.bitmap.width+2*V,h:$.bitmap.height+2*V};p.push(W),B[O]=W}}const{w:_,h:x}=Hh(p),T=new oo({width:_||1,height:x||1});for(const A in e){const D=e[A];for(const B in D.glyphs){const O=D.glyphs[+B];if(!O||O.bitmap.width===0||O.bitmap.height===0)continue;const $=d[A][B],V=O.metrics.localGlyph?2:1;oo.copy(O.bitmap,T,{x:0,y:0},{x:$.x+V,y:$.y+V},O.bitmap)}}this.image=T,this.positions=d}}Tt(vf);class Ym{constructor(e){this.tileID=new kr(e.tileID.overscaledZ,e.tileID.wrap,e.tileID.canonical.z,e.tileID.canonical.x,e.tileID.canonical.y),this.tileZoom=e.tileZoom,this.uid=e.uid,this.zoom=e.zoom,this.canonical=e.tileID.canonical,this.pixelRatio=e.pixelRatio,this.tileSize=e.tileSize,this.source=e.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=e.showCollisionBoxes,this.collectResourceTiming=!!e.collectResourceTiming,this.returnDependencies=!!e.returnDependencies,this.promoteId=e.promoteId,this.enableTerrain=!!e.enableTerrain,this.isSymbolTile=e.isSymbolTile,this.tileTransform=gs(e.tileID.canonical,e.projection),this.projection=e.projection}parse(e,d,p,_,x){this.status="parsing",this.data=e,this.collisionBoxArray=new En;const T=new rf(Object.keys(e.layers).sort()),A=new yf(this.tileID,this.promoteId);A.bucketLayerIDs=[];const D={},B=new hu(256,256),O={featureIndex:A,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:B,availableImages:p},$=d.familiesBySource[this.source];for(const ze in $){const Fe=e.layers[ze];if(!Fe)continue;let Xe=!1,We=!1;for(const Ge of $[ze])Ge[0].type==="symbol"?Xe=!0:We=!0;if(this.isSymbolTile===!0&&!Xe||this.isSymbolTile===!1&&!We)continue;Fe.version===1&&nt(`Vector tile source "${this.source}" layer "${ze}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const et=T.encode(ze),rt=[];for(let Ge=0;Ge<Fe.length;Ge++){const Je=Fe.feature(Ge),ot=A.getId(Je,ze);rt.push({feature:Je,id:ot,index:Ge,sourceLayerIndex:et})}for(const Ge of $[ze]){const Je=Ge[0];this.isSymbolTile!==void 0&&Je.type==="symbol"!==this.isSymbolTile||Je.minzoom&&this.zoom<Math.floor(Je.minzoom)||Je.maxzoom&&this.zoom>=Je.maxzoom||Je.visibility!=="none"&&(xu(Ge,this.zoom,p),(D[Je.id]=Je.createBucket({index:A.bucketLayerIDs.length,layers:Ge,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:et,sourceID:this.source,enableTerrain:this.enableTerrain,projection:this.projection.name,availableImages:p})).populate(rt,O,this.tileID.canonical,this.tileTransform),A.bucketLayerIDs.push(Ge.map(ot=>ot.id)))}}let V,W,re,se;B.trim();const fe={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},xe=Vt(O.glyphDependencies,ze=>Object.keys(ze).map(Number));Object.keys(xe).length?_.send("getGlyphs",{uid:this.uid,stacks:xe},(ze,Fe)=>{V||(V=ze,W=Fe,Re.call(this))},void 0,!1,fe):W={};const Ae=Object.keys(O.iconDependencies);Ae.length?_.send("getImages",{icons:Ae,source:this.source,tileID:this.tileID,type:"icons"},(ze,Fe)=>{V||(V=ze,re=Fe,Re.call(this))},void 0,!1,fe):re={};const Pe=Object.keys(O.patternDependencies);function Re(){if(V)return x(V);if(W&&re&&se){const ze=new vf(W),Fe=new Td(re,se);for(const Xe in D){const We=D[Xe];We instanceof Do?(xu(We.layers,this.zoom,p),wm(We,W,ze.positions,re,Fe.iconPositions,this.showCollisionBoxes,p,this.tileID.canonical,this.tileZoom,this.projection)):We.hasPattern&&(We instanceof Uc||We instanceof Nc||We instanceof gl)&&(xu(We.layers,this.zoom,p),We.addFeatures(O,this.tileID.canonical,Fe.patternPositions,p,this.tileTransform))}this.status="done",x(null,{buckets:te(D).filter(Xe=>!Xe.isEmpty()),featureIndex:A,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:ze.image,lineAtlas:B,imageAtlas:Fe,glyphMap:this.returnDependencies?W:null,iconMap:this.returnDependencies?re:null,glyphPositions:this.returnDependencies?ze.positions:null})}}Pe.length?_.send("getImages",{icons:Pe,source:this.source,tileID:this.tileID,type:"patterns"},(ze,Fe)=>{V||(V=ze,se=Fe,Re.call(this))},void 0,!1,fe):se={},Re.call(this)}}function xu(u,e,d){const p=new Vi(e);for(const _ of u)_.recalculate(p,d)}class bf{constructor(e){this.entries={},this.scheduler=e}request(e,d,p,_){const x=this.entries[e]=this.entries[e]||{callbacks:[]};if(x.result){const[T,A]=x.result;return this.scheduler?this.scheduler.add(()=>{_(T,A)},d):_(T,A),()=>{}}return x.callbacks.push(_),x.cancel||(x.cancel=p((T,A)=>{x.result=[T,A];for(const D of x.callbacks)this.scheduler?this.scheduler.add(()=>{D(T,A)},d):D(T,A);setTimeout(()=>delete this.entries[e],3e3)})),()=>{x.result||(x.callbacks=x.callbacks.filter(T=>T!==_),x.callbacks.length||(x.cancel(),delete this.entries[e]))}}}function wf(u,e,d){const p=JSON.stringify(u.request);return u.data&&(this.deduped.entries[p]={result:[null,u.data]}),this.deduped.request(p,{type:"parseTile",isSymbolTile:u.isSymbolTile,zoom:u.tileZoom},_=>{const x=pe(u.request,(T,A,D,B)=>{T?_(T):A&&_(null,{vectorTile:d?void 0:new ms.VectorTile(new xl(A)),rawData:A,cacheControl:D,expires:B})});return()=>{x.cancel(),_()}},e)}const Wm=$n(new Float32Array(16));class Lo{constructor(e){this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,d){return{x:0,y:0,z:0}}unproject(e,d){return new Oi(0,0)}projectTilePoint(e,d,p){return{x:e,y:d,z:0}}locationPoint(e,d){return e._coordinatePoint(e.locationCoordinate(d),!1)}pixelsPerMeter(e,d){return ea(1,e)*d}farthestPixelDistance(e){return function(d,p){const _=d.fovAboveCenter,x=d.elevation?d.elevation.getMinElevationBelowMSL()*p:0,T=(d._camera.position[2]*d.worldSize-x)/Math.cos(d._pitch),A=Math.sin(_)*T/Math.sin(Math.max(Math.PI/2-d._pitch-_,.01)),D=Math.sin(d._pitch)*A+T;return Math.min(1.01*D,T*(1/d._horizonShift))}(e,e.pixelsPerMeter)}pointCoordinate(e,d,p,_){const x=e.horizonLineFromTop(!1),T=new L(d,Math.max(x,p));return e.rayIntersectionCoordinate(e.pointRayIntersection(T,_))}createInversionMatrix(e,d){return Wm}createTileMatrix(e,d,p){let _,x,T;const A=p.canonical,D=$n(new Float64Array(16));if(this.isReprojectedInTileSpace){const B=gs(A,this);_=1,x=B.x+p.wrap*B.scale,T=B.y,Io(D,D,[_/B.scale,_/B.scale,e.pixelsPerMeter/d])}else _=d/e.zoomScale(A.z),x=(A.x+Math.pow(2,A.z)*p.wrap)*_,T=A.y*_;return fs(D,D,[x,T,0]),Io(D,D,[_/di,_/di,1]),D}upVector(e,d,p){return[0,0,1]}upVectorScale(e,d,p){return{metersToTile:1,metersToLabelSpace:1}}}class Hm extends Lo{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,d){return{x:nl(e),y:Qs(d),z:0}}unproject(e,d){const p=pn(e),_=br(d);return new Oi(p,_)}}class Km extends Lo{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[d,p]=this.parallels=e.parallels||[29.5,45.5],_=Math.sin(K(d));this.n=(_+Math.sin(K(p)))/2,this.c=1+_*(2*this.n-_),this.r0=Math.sqrt(this.c)/this.n}project(e,d){const{n:p,c:_,r0:x}=this,T=K(e-this.center[0]),A=K(d),D=Math.sqrt(_-2*p*Math.sin(A))/p;return{x:D*Math.sin(T*p),y:D*Math.cos(T*p)-x,z:0}}unproject(e,d){const{n:p,c:_,r0:x}=this,T=x+d;let A=Math.atan2(e,Math.abs(T))*Math.sign(T);T*p<0&&(A-=Math.PI*Math.sign(e)*Math.sign(T));const D=K(this.center[0])*p;A=ne(A,-Math.PI-D,Math.PI-D);const B=X(A/p)+this.center[0],O=Math.asin(ge((_-(e*e+T*T)*p*p)/(2*p),-1,1)),$=ge(X(O),-85.051129,Nn);return new Oi(B,$)}}const Sl=1.340264,Al=-.081106,Il=893e-6,kl=.003796,th=Math.sqrt(3)/2;class Jm extends Lo{project(e,d){d=d/180*Math.PI,e=e/180*Math.PI;const p=Math.asin(th*Math.sin(d)),_=p*p,x=_*_*_;return{x:.5*(e*Math.cos(p)/(th*(Sl+3*Al*_+x*(7*Il+9*kl*_)))/Math.PI+.5),y:1-.5*(p*(Sl+Al*_+x*(Il+kl*_))/Math.PI+1),z:0}}unproject(e,d){e=(2*e-.5)*Math.PI;let p=d=(2*(1-d)-1)*Math.PI,_=p*p,x=_*_*_;for(let O,$,V,W=0;W<12&&($=p*(Sl+Al*_+x*(Il+kl*_))-d,V=Sl+3*Al*_+x*(7*Il+9*kl*_),O=$/V,p=ge(p-O,-Math.PI/3,Math.PI/3),_=p*p,x=_*_*_,!(Math.abs(O)<1e-12));++W);const T=th*e*(Sl+3*Al*_+x*(7*Il+9*kl*_))/Math.cos(p),A=Math.asin(Math.sin(p)/th),D=ge(180*T/Math.PI,-180,180),B=ge(180*A/Math.PI,-85.051129,Nn);return new Oi(D,B)}}class Qm extends Lo{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,d){return{x:.5+e/360,y:.5-d/360,z:0}}unproject(e,d){const p=360*(e-.5),_=ge(360*(.5-d),-85.051129,Nn);return new Oi(p,_)}}const ma=Math.PI/2;function ih(u){return Math.tan((ma+u)/2)}class eg extends Lo{constructor(e){super(e),this.center=e.center||[0,30];const[d,p]=this.parallels=e.parallels||[30,30],_=K(d),x=K(p),T=Math.cos(_);this.n=_===x?Math.sin(_):Math.log(T/Math.cos(x))/Math.log(ih(x)/ih(_)),this.f=T*Math.pow(ih(_),this.n)/this.n}project(e,d){d=K(d),e=K(e-this.center[0]);const p=1e-6,{n:_,f:x}=this;x>0?d<-ma+p&&(d=-ma+p):d>ma-p&&(d=ma-p);const T=x/Math.pow(ih(d),_),A=T*Math.sin(_*e),D=x-T*Math.cos(_*e);return{x:.5*(A/Math.PI+.5),y:1-.5*(D/Math.PI+.5),z:0}}unproject(e,d){e=(2*e-.5)*Math.PI,d=(2*(1-d)-.5)*Math.PI;const{n:p,f:_}=this,x=_-d,T=Math.sign(x),A=Math.sign(p)*Math.sqrt(e*e+x*x);let D=Math.atan2(e,Math.abs(x))*T;x*p<0&&(D-=Math.PI*Math.sign(e)*T);const B=ge(X(D/p)+this.center[0],-180,180),O=ge(X(2*Math.atan(Math.pow(_/A,1/p))-ma),-85.051129,Nn);return new Oi(B,O)}}const Ef=K(Nn);class tg extends Lo{project(e,d){const p=(d=K(d))*d,_=p*p;return{x:.5*((e=K(e))*(.8707-.131979*p+_*(_*(.003971*p-.001529*_)-.013791))/Math.PI+.5),y:1-.5*(d*(1.007226+p*(.015085+_*(.028874*p-.044475-.005916*_)))/Math.PI+1),z:0}}unproject(e,d){e=(2*e-.5)*Math.PI;let p=d=(2*(1-d)-1)*Math.PI,_=25,x=0,T=p*p;do{T=p*p;const B=T*T;x=(p*(1.007226+T*(.015085+B*(.028874*T-.044475-.005916*B)))-d)/(1.007226+T*(.045255+B*(.259866*T-.311325-.005916*11*B))),p=ge(p-x,-Ef,Ef)}while(Math.abs(x)>1e-6&&--_>0);T=p*p;const A=ge(X(e/(.8707+T*(T*(T*T*T*(.003971-.001529*T)-.013791)-.131979))),-180,180),D=X(p);return new Oi(A,D)}}const Tf=K(Nn);class ig extends Lo{project(e,d){d=K(d),e=K(e);const p=Math.cos(d),_=2/Math.PI,x=Math.acos(p*Math.cos(e/2)),T=Math.sin(x)/x,A=.5*(e*_+2*p*Math.sin(e/2)/T)||0,D=.5*(d+Math.sin(d)/T)||0;return{x:.5*(A/Math.PI+.5),y:1-.5*(D/Math.PI+1),z:0}}unproject(e,d){let p=e=(2*e-.5)*Math.PI,_=d=(2*(1-d)-1)*Math.PI,x=25;const T=1e-6;let A=0,D=0;do{const B=Math.cos(_),O=Math.sin(_),$=2*O*B,V=O*O,W=B*B,re=Math.cos(p/2),se=Math.sin(p/2),fe=2*re*se,xe=se*se,Ae=1-W*re*re,Pe=Ae?1/Ae:0,Re=Ae?Math.acos(B*re)*Math.sqrt(1/Ae):0,ze=.5*(2*Re*B*se+2*p/Math.PI)-e,Fe=.5*(Re*O+_)-d,Xe=.5*Pe*(W*xe+Re*B*re*V)+1/Math.PI,We=Pe*(fe*$/4-Re*O*se),et=.125*Pe*($*se-Re*O*W*fe),rt=.5*Pe*(V*re+Re*xe*B)+.5,Ge=We*et-rt*Xe;A=(Fe*We-ze*rt)/Ge,D=(ze*et-Fe*Xe)/Ge,p=ge(p-A,-Math.PI,Math.PI),_=ge(_-D,-Tf,Tf)}while((Math.abs(A)>T||Math.abs(D)>T)&&--x>0);return new Oi(X(p),X(_))}}class Mf extends Lo{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(K(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,d){const{scale:p,cosPhi:_}=this;return{x:K(e)*_*p+.5,y:-Math.sin(K(d))/_*p+.5,z:0}}unproject(e,d){const{scale:p,cosPhi:_}=this,x=-(d-.5)/p,T=ge(X((e-.5)/p)/_,-180,180),A=Math.asin(ge(x*_,-1,1)),D=ge(X(A),-85.051129,Nn);return new Oi(T,D)}}h.ARRAY_TYPE=Kr,h.AUTH_ERR_MSG=ci,h.Aabb=hn,h.Actor=class{constructor(u,e,d){this.target=u,this.parent=e,this.mapId=d,this.callbacks={},this.cancelCallbacks={},Rt(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=Dt()?u:F,this.scheduler=new zm}send(u,e,d,p,_=!1,x){const T=Math.round(1e18*Math.random()).toString(36).substring(0,10);d&&(d.metadata=x,this.callbacks[T]=d);const A=ai(this.globalScope)?void 0:[];return this.target.postMessage({id:T,type:u,hasCallback:!!d,targetMapId:p,mustQueue:_,sourceMapId:this.mapId,data:rs(e,A)},A),{cancel:()=>{d&&delete this.callbacks[T],this.target.postMessage({id:T,type:"<cancel>",targetMapId:p,sourceMapId:this.mapId})}}}receive(u){const e=u.data,d=e.id;if(d&&(!e.targetMapId||this.mapId===e.targetMapId))if(e.type==="<cancel>"){const p=this.cancelCallbacks[d];delete this.cancelCallbacks[d],p&&p.cancel()}else if(e.mustQueue||Dt()){const p=this.callbacks[d];this.cancelCallbacks[d]=this.scheduler.add(()=>this.processTask(d,e),p&&p.metadata||{type:"message"})}else this.processTask(d,e)}processTask(u,e){if(e.type==="<response>"){const d=this.callbacks[u];delete this.callbacks[u],d&&(e.error?d(vo(e.error)):d(null,vo(e.data)))}else{const d=ai(this.globalScope)?void 0:[],p=e.hasCallback?(x,T)=>{delete this.cancelCallbacks[u],this.target.postMessage({id:u,type:"<response>",sourceMapId:this.mapId,error:x?rs(x):null,data:rs(T,d)},d)}:x=>{},_=vo(e.data);if(this.parent[e.type])this.parent[e.type](e.sourceMapId,_,p);else if(this.parent.getWorkerSource){const x=e.type.split(".");this.parent.getWorkerSource(e.sourceMapId,x[0],_.source)[x[1]](_,p)}else p(new Error(`Could not find function ${e.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},h.CanonicalTileID=Kc,h.Color=Ci,h.ColorMode=Gn,h.CullFaceMode=An,h.DEMData=Qc,h.DataConstantProperty=P,h.DedupedRequest=bf,h.DepthMode=pa,h.EXTENT=di,h.Elevation=class{isDataAvailableAtPoint(u){const e=this._source();if(!e||u.y<0||u.y>1)return!1;const d=e.getSource().maxzoom,p=1<<d,_=Math.floor(u.x),x=Math.floor((u.x-_)*p),T=Math.floor(u.y*p),A=this.findDEMTileFor(new kr(d,_,d,x,T));return!(!A||!A.dem)}getAtPointOrZero(u,e=0){return this.getAtPoint(u,e)||0}getAtPoint(u,e,d=!0){e==null&&(e=null);const p=this._source();if(!p||u.y<0||u.y>1)return e;const _=p.getSource().maxzoom,x=1<<_,T=Math.floor(u.x),A=u.x-T,D=new kr(_,T,_,Math.floor(A*x),Math.floor(u.y*x)),B=this.findDEMTileFor(D);if(!B||!B.dem)return e;const O=B.dem,$=1<<B.tileID.canonical.z,V=(A*$-B.tileID.canonical.x)*O.dim,W=(u.y*$-B.tileID.canonical.y)*O.dim,re=Math.floor(V),se=Math.floor(W);return(d?this.exaggeration():1)*Zt(Zt(O.get(re,se),O.get(re,se+1),W-se),Zt(O.get(re+1,se),O.get(re+1,se+1),W-se),V-re)}getAtTileOffset(u,e,d){const p=1<<u.canonical.z;return this.getAtPointOrZero(new Cc(u.wrap+(u.canonical.x+e/di)/p,(u.canonical.y+d/di)/p))}getAtTileOffsetFunc(u,e,d,p){return _=>{const x=this.getAtTileOffset(u,_.x,_.y),T=p.upVector(u.canonical,_.x,_.y);return sl(T,T,x*p.upVectorScale(u.canonical,e,d).metersToTile),T}}getForTilePoints(u,e,d,p){const _=eh.create(this,u,p);return!!_&&(e.forEach(x=>{x[2]=this.exaggeration()*_.getElevationAt(x[0],x[1],d)}),!0)}getMinMaxForTile(u){const e=this.findDEMTileFor(u);if(!e||!e.dem)return null;const d=e.dem.tree,p=e.tileID,_=1<<u.canonical.z-p.canonical.z;let x=u.canonical.x/_-p.canonical.x,T=u.canonical.y/_-p.canonical.y,A=0;for(let D=0;D<u.canonical.z-p.canonical.z&&!d.leaves[A];D++){x*=2,T*=2;const B=2*Math.floor(T)+Math.floor(x);A=d.childOffsets[A]+B,x%=1,T%=1}return{min:this.exaggeration()*d.minimums[A],max:this.exaggeration()*d.maximums[A]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(u,e,d){throw new Error("Pure virtual method called.")}pointCoordinate(u){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(u){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},h.ErrorEvent=Bt,h.EvaluationParameters=Vi,h.Event=bt,h.Evented=Yt,h.FillExtrusionBucket=gl,h.Frustum=Nh,h.GLOBE_RADIUS=fa,h.GlobeSharedBuffers=class{constructor(u){this._createGrid(u),this._createPoles(u),this._createAtmosphere(u)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const u of this._poleSegments)u.destroy();this._gridSegments.destroy(),this.atmosphereVertexBuffer.destroy(),this.atmosphereIndexBuffer.destroy(),this.atmosphereSegments.destroy(),this._wireframeIndexBuffer&&(this._wireframeIndexBuffer.destroy(),this._wireframeSegments.destroy())}_createGrid(u){const e=new Ee,d=new Ze,p=65;for(let _=0;_<p;_++)for(let x=0;x<p;x++)e.emplaceBack(x,_);for(let _=0;_<64;_++)for(let x=0;x<64;x++){const T=_*p+x;d.emplaceBack(T+1,T,T+p),d.emplaceBack(T+p,T+p+1,T+1)}this._gridBuffer=u.createVertexBuffer(e,El.members),this._gridIndexBuffer=u.createIndexBuffer(d,!0),this._gridSegments=Ji.simpleSegment(0,0,4225,8192)}_createPoles(u){const e=new Ze;for(let _=0;_<=64;_++)e.emplaceBack(0,_+1,_+2);this._poleIndexBuffer=u.createIndexBuffer(e,!0);const d=new At,p=new At;this._poleSegments=[];for(let _=0,x=0;_<5;_++){const T=1<<_,A=512*T/Math.PI/2,D=360/T;d.emplaceBack(0,-A,0,0,0,.5,0),p.emplaceBack(0,-A,0,0,0,.5,1);for(let B=0;B<=64;B++){const O=B/64,$=Zt(0,D,O),[V,W,re]=Yd(Vm,jm,$,A);d.emplaceBack(V,W,re,0,0,O,0),p.emplaceBack(V,W,re,0,0,O,1)}this._poleSegments.push(Ji.simpleSegment(x,0,66,64)),x+=66}this._poleNorthVertexBuffer=u.createVertexBuffer(d,Zd,!1),this._poleSouthVertexBuffer=u.createVertexBuffer(p,Zd,!1)}_createAtmosphere(u){const e=new Kt;e.emplaceBack(-1,1,1,0,0),e.emplaceBack(1,1,1,1,0),e.emplaceBack(1,-1,1,1,1),e.emplaceBack(-1,-1,1,0,1);const d=new Ze;d.emplaceBack(0,1,2),d.emplaceBack(2,3,0),this.atmosphereVertexBuffer=u.createVertexBuffer(e,Om.members),this.atmosphereIndexBuffer=u.createIndexBuffer(d),this.atmosphereSegments=Ji.simpleSegment(0,0,4,2)}getGridBuffers(){return[this._gridBuffer,this._gridIndexBuffer,this._gridSegments]}getPoleBuffers(u){return[this._poleNorthVertexBuffer,this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[u]]}getWirefameBuffers(u){if(!this._wireframeSegments){const e=new Ft,d=64,p=d+1;for(let _=0;_<d;_++)for(let x=0;x<d;x++){const T=_*p+x;e.emplaceBack(T,T+1),e.emplaceBack(T,T+p),e.emplaceBack(T,T+p+1)}this._wireframeIndexBuffer=u.createIndexBuffer(e),this._wireframeSegments=Ji.simpleSegment(0,0,d*d,e.length)}return[this._gridBuffer,this._wireframeIndexBuffer,this._wireframeSegments]}},h.GlyphManager=ua,h.ImagePosition=Kh,h.LineAtlas=hu,h.LngLat=Oi,h.LngLatBounds=Ao,h.LocalGlyphMode=tu,h.MAX_MERCATOR_LATITUDE=Nn,h.MercatorCoordinate=Cc,h.ONE_EM=wr,h.OverscaledTileID=kr,h.Properties=ee,h.RGBAImage=Jr,h.Ray=class{constructor(u,e){this.pos=u,this.dir=e}intersectsPlane(u,e,d){const p=ll(e,this.dir);if(Math.abs(p)<1e-6)return!1;const _=((u[0]-this.pos[0])*e[0]+(u[1]-this.pos[1])*e[1]+(u[2]-this.pos[2])*e[2])/p;return d[0]=this.pos[0]+this.dir[0]*_,d[1]=this.pos[1]+this.dir[1]*_,d[2]=this.pos[2]+this.dir[2]*_,!0}closestPointOnSphere(u,e,d){if(function(V,W){var re=V[0],se=V[1],fe=V[2],xe=W[0],Ae=W[1],Pe=W[2];return Math.abs(re-xe)<=Dh*Math.max(1,Math.abs(re),Math.abs(xe))&&Math.abs(se-Ae)<=Dh*Math.max(1,Math.abs(se),Math.abs(Ae))&&Math.abs(fe-Pe)<=Dh*Math.max(1,Math.abs(fe),Math.abs(Pe))}(this.pos,u)||e===0)return d[0]=d[1]=d[2]=0,!1;const[p,_,x]=this.dir,T=this.pos[0]-u[0],A=this.pos[1]-u[1],D=this.pos[2]-u[2],B=p*p+_*_+x*x,O=2*(T*p+A*_+D*x),$=O*O-4*B*(T*T+A*A+D*D-e*e);if($<0){const V=Math.max(-O/2,0),W=T+p*V,re=A+_*V,se=D+x*V,fe=Math.hypot(W,re,se);return d[0]=W*e/fe,d[1]=re*e/fe,d[2]=se*e/fe,!1}{const V=(-O-Math.sqrt($))/(2*B);if(V<0){const W=Math.hypot(T,A,D);return d[0]=T*e/W,d[1]=A*e/W,d[2]=D*e/W,!1}return d[0]=T+p*V,d[1]=A+_*V,d[2]=D+x*V,!0}}},h.RequestManager=class{constructor(u,e,d){this._transformRequestFn=u,this._customAccessToken=e,this._silenceAuthErrors=!!d,this._createSkuToken()}_createSkuToken(){const u=function(){let e="";for(let d=0;d<10;d++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Ai,e].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=u.token,this._skuTokenExpiresAt=u.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(u,e){return this._transformRequestFn&&this._transformRequestFn(u,e)||{url:u}}normalizeStyleURL(u,e){if(!Lt(u))return u;const d=hi(u);return d.path=`/styles/v1${d.path}`,this._makeAPIURL(d,this._customAccessToken||e)}normalizeGlyphsURL(u,e){if(!Lt(u))return u;const d=hi(u);return d.path=`/fonts/v1${d.path}`,this._makeAPIURL(d,this._customAccessToken||e)}normalizeSourceURL(u,e){if(!Lt(u))return u;const d=hi(u);return d.path=`/v4/${d.authority}.json`,d.params.push("secure"),this._makeAPIURL(d,this._customAccessToken||e)}normalizeSpriteURL(u,e,d,p){const _=hi(u);return Lt(u)?(_.path=`/styles/v1${_.path}/sprite${e}${d}`,this._makeAPIURL(_,this._customAccessToken||p)):(_.path+=`${e}${d}`,_i(_))}normalizeTileURL(u,e,d){if(this._isSkuTokenExpired()&&this._createSkuToken(),u&&!Lt(u))return u;const p=hi(u);p.path=p.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${e||d&&p.authority!=="raster"&&d===512?"@2x":""}${je.supported?".webp":"$1"}`),p.authority==="raster"?p.path=`/${Et.RASTER_URL_PREFIX}${p.path}`:(p.path=p.path.replace(/^.+\/v4\//,"/"),p.path=`/${Et.TILE_URL_VERSION}${p.path}`);const _=this._customAccessToken||function(x){for(const T of x){const A=T.match(/^access_token=(.*)$/);if(A)return A[1]}return null}(p.params)||Et.ACCESS_TOKEN;return Et.REQUIRE_ACCESS_TOKEN&&_&&this._skuToken&&p.params.push(`sku=${this._skuToken}`),this._makeAPIURL(p,_)}canonicalizeTileURL(u,e){const d=hi(u);if(!d.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!d.path.match(/\.[\w]+$/))return u;let p="mapbox://";d.path.match(/^\/raster\/v1\//)?p+=`raster/${d.path.replace(`/${Et.RASTER_URL_PREFIX}/`,"")}`:p+=`tiles/${d.path.replace(`/${Et.TILE_URL_VERSION}/`,"")}`;let _=d.params;return e&&(_=_.filter(x=>!x.match(/^access_token=/))),_.length&&(p+=`?${_.join("&")}`),p}canonicalizeTileset(u,e){const d=!!e&&Lt(e),p=[];for(const _ of u.tiles||[])$t(_)?p.push(this.canonicalizeTileURL(_,d)):p.push(_);return p}_makeAPIURL(u,e){const d="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",p=hi(Et.API_URL);if(u.protocol=p.protocol,u.authority=p.authority,u.protocol==="http"){const _=u.params.indexOf("secure");_>=0&&u.params.splice(_,1)}if(p.path!=="/"&&(u.path=`${p.path}${u.path}`),!Et.REQUIRE_ACCESS_TOKEN)return _i(u);if(e=e||Et.ACCESS_TOKEN,!this._silenceAuthErrors){if(!e)throw new Error(`An API access token is required to use Mapbox GL. ${d}`);if(e[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${d}`)}return u.params=u.params.filter(_=>_.indexOf("access_token")===-1),u.params.push(`access_token=${e||""}`),_i(u)}},h.ResourceType=J,h.SegmentVector=Ji,h.SourceCache=_s,h.StencilMode=gu,h.StructArrayLayout1ui2=ei,h.StructArrayLayout2f1f2i16=st,h.StructArrayLayout2i4=Ee,h.StructArrayLayout2ui4=Ft,h.StructArrayLayout3f12=ke,h.StructArrayLayout3ui6=Ze,h.StructArrayLayout4i8=Se,h.Texture=wl,h.Tile=pu,h.Transitionable=y,h.Uniform1f=Ic,h.Uniform1i=class extends io{constructor(u,e){super(u,e),this.current=0}set(u){this.current!==u&&(this.current=u,this.gl.uniform1i(this.location,u))}},h.Uniform2f=class extends io{constructor(u,e){super(u,e),this.current=[0,0]}set(u){u[0]===this.current[0]&&u[1]===this.current[1]||(this.current=u,this.gl.uniform2f(this.location,u[0],u[1]))}},h.Uniform3f=class extends io{constructor(u,e){super(u,e),this.current=[0,0,0]}set(u){u[0]===this.current[0]&&u[1]===this.current[1]&&u[2]===this.current[2]||(this.current=u,this.gl.uniform3f(this.location,u[0],u[1],u[2]))}},h.Uniform4f=Iu,h.UniformColor=ku,h.UniformMatrix2f=class extends io{constructor(u,e){super(u,e),this.current=Of}set(u){for(let e=0;e<4;e++)if(u[e]!==this.current[e]){this.current=u,this.gl.uniformMatrix2fv(this.location,!1,u);break}}},h.UniformMatrix3f=class extends io{constructor(u,e){super(u,e),this.current=Ff}set(u){for(let e=0;e<9;e++)if(u[e]!==this.current[e]){this.current=u,this.gl.uniformMatrix3fv(this.location,!1,u);break}}},h.UniformMatrix4f=class extends io{constructor(u,e){super(u,e),this.current=zf}set(u){if(u[12]!==this.current[12]||u[0]!==this.current[0])return this.current=u,void this.gl.uniformMatrix4fv(this.location,!1,u);for(let e=1;e<16;e++)if(u[e]!==this.current[e]){this.current=u,this.gl.uniformMatrix4fv(this.location,!1,u);break}}},h.UnwrappedTileID=tf,h.ValidationError=vt,h.VectorTileWorkerSource=class extends Yt{constructor(u,e,d,p,_){super(),this.actor=u,this.layerIndex=e,this.availableImages=d,this.loadVectorData=_||wf,this.loading={},this.loaded={},this.deduped=new bf(u.scheduler),this.isSpriteLoaded=p,this.scheduler=u.scheduler}loadTile(u,e){const d=u.uid,p=u&&u.request,_=p&&p.collectResourceTiming,x=this.loading[d]=new Ym(u);x.abort=this.loadVectorData(u,(T,A)=>{const D=!this.loading[d];if(delete this.loading[d],D||T||!A)return x.status="done",D||(this.loaded[d]=x),e(T);const B=A.rawData,O={};A.expires&&(O.expires=A.expires),A.cacheControl&&(O.cacheControl=A.cacheControl),x.vectorTile=A.vectorTile||new ms.VectorTile(new xl(B));const $=()=>{x.parse(x.vectorTile,this.layerIndex,this.availableImages,this.actor,(V,W)=>{if(V||!W)return e(V);const re={};if(_){const se=qd(p);se.length>0&&(re.resourceTiming=JSON.parse(JSON.stringify(se)))}e(null,he({rawTileData:B.slice(0)},W,O,re))})};this.isSpriteLoaded?$():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add($,{type:"parseTile",isSymbolTile:u.isSymbolTile,zoom:u.tileZoom}):$()}),this.loaded=this.loaded||{},this.loaded[d]=x})}reloadTile(u,e){const d=this.loaded,p=u.uid,_=this;if(d&&d[p]){const x=d[p];x.showCollisionBoxes=u.showCollisionBoxes,x.enableTerrain=!!u.enableTerrain,x.projection=u.projection,x.tileTransform=gs(u.tileID.canonical,u.projection);const T=(A,D)=>{const B=x.reloadCallback;B&&(delete x.reloadCallback,x.parse(x.vectorTile,_.layerIndex,this.availableImages,_.actor,B)),e(A,D)};x.status==="parsing"?x.reloadCallback=T:x.status==="done"&&(x.vectorTile?x.parse(x.vectorTile,this.layerIndex,this.availableImages,this.actor,T):T())}}abortTile(u,e){const d=u.uid,p=this.loading[d];p&&(p.abort&&p.abort(),delete this.loading[d]),e()}removeTile(u,e){const d=this.loaded,p=u.uid;d&&d[p]&&delete d[p],e()}},h.WritingMode=un,h.ZoomHistory=Ga,h.add=Gu,h.addDynamicAttributes=ou,h.adjoint=function(u,e){var d=e[0],p=e[1],_=e[2],x=e[3],T=e[4],A=e[5],D=e[6],B=e[7],O=e[8];return u[0]=T*O-A*B,u[1]=_*B-p*O,u[2]=p*A-_*T,u[3]=A*D-x*O,u[4]=d*O-_*D,u[5]=_*x-d*A,u[6]=x*B-T*D,u[7]=p*D-d*B,u[8]=d*T-p*x,u},h.asyncAll=ve,h.bezier=ie,h.bindAll=Rt,h.boundsAttributes=sf,h.bufferConvexPolygon=function(u,e){const d=[];for(let p=0;p<u.length;p++){const _=ne(p-1,-1,u.length-1),x=ne(p+1,-1,u.length-1),T=u[p],A=u[x],D=u[_].sub(T).unit(),B=A.sub(T).unit(),O=B.angleWithSep(D.x,D.y),$=D.add(B).unit().mult(-1*e/Math.sin(O/2));d.push(T.add($))}return d},h.cacheEntryPossiblyAdded=function(u){_e++,_e>yr&&(u.getActor().send("enforceCacheSizeLimit",mr),_e=0)},h.calculateGlobeLabelMatrix=function(u,e){const{lng:d,lat:p}=u._center,_=Kd(0,0,u.worldSize/u._projectionScaler,d,p);return Ph(_,_,function(x){const T=$n(new Float64Array(16)),A=1/fu(x);return fs(T,T,x.min),Io(T,T,[A,A,A]),T}(Tl(e)))},h.calculateGlobeMatrix=Jd,h.calculateGlobeMercatorMatrix=function(u){const e=u.worldSize,d=u.point,p=ea(1,u.center.lat)*e,_=u.pixelsPerMeter,x=e/(p/u.pixelsPerMeter),T=$n(new Float64Array(16));return fs(T,T,[d.x,d.y,0]),Io(T,T,[x,x,_]),Float32Array.from(T)},h.circumferenceAtLatitude=Mh,h.clamp=ge,h.clearTileCache=function(u){const e=F.caches.delete(Er);u&&e.catch(u).then(()=>u())},h.clipLine=zd,h.clone=function(u){var e=new Kr(16);return e[0]=u[0],e[1]=u[1],e[2]=u[2],e[3]=u[3],e[4]=u[4],e[5]=u[5],e[6]=u[6],e[7]=u[7],e[8]=u[8],e[9]=u[9],e[10]=u[10],e[11]=u[11],e[12]=u[12],e[13]=u[13],e[14]=u[14],e[15]=u[15],e},h.clone$1=Xt,h.collisionCircleLayout=Yp,h.config=Et,h.conjugate=function(u,e){return u[0]=-e[0],u[1]=-e[1],u[2]=-e[2],u[3]=e[3],u},h.create=function(){var u=new Kr(16);return Kr!=Float32Array&&(u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[11]=0,u[12]=0,u[13]=0,u[14]=0),u[0]=1,u[5]=1,u[10]=1,u[15]=1,u},h.create$1=Uu,h.createExpression=Wo,h.createLayout=Me,h.createStyleLayer=function(u){return u.type==="custom"?new Dm(u):new Bm[u.type](u)},h.cross=Xu,h.degToRad=K,h.div=function(u,e,d){return u[0]=e[0]/d[0],u[1]=e[1]/d[1],u[2]=e[2]/d[2],u},h.dot=ll,h.earthRadius=Th,h.ease=ce,h.easeCubicInOut=Q,h.emitValidationErrors=lc,h.endsWith=xt,h.enforceCacheSizeLimit=function(u){Sr(),er&&er.then(e=>{e.keys().then(d=>{for(let p=0;p<d.length-u;p++)e.delete(d[p])})})},h.evaluateSizeForFeature=Vc,h.evaluateSizeForZoom=aa,h.evaluateVariableOffset=Ud,h.evented=el,h.exactEquals=function(u,e){return u[0]===e[0]&&u[1]===e[1]&&u[2]===e[2]&&u[3]===e[3]},h.exactEquals$1=function(u,e){return u[0]===e[0]&&u[1]===e[1]&&u[2]===e[2]},h.exported=dt,h.exported$1=je,h.extend=he,h.extend$1=Ei,h.filterObject=It,h.fromMat4=function(u,e){return u[0]=e[0],u[1]=e[1],u[2]=e[2],u[3]=e[4],u[4]=e[5],u[5]=e[6],u[6]=e[8],u[7]=e[9],u[8]=e[10],u},h.fromQuat=function(u,e){var d=e[0],p=e[1],_=e[2],x=e[3],T=d+d,A=p+p,D=_+_,B=d*T,O=p*T,$=p*A,V=_*T,W=_*A,re=_*D,se=x*T,fe=x*A,xe=x*D;return u[0]=1-$-re,u[1]=O+xe,u[2]=V-fe,u[3]=0,u[4]=O-xe,u[5]=1-B-re,u[6]=W+se,u[7]=0,u[8]=V+fe,u[9]=W-se,u[10]=1-B-$,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u},h.fromRotation=function(u,e){var d=Math.sin(e),p=Math.cos(e);return u[0]=p,u[1]=d,u[2]=0,u[3]=-d,u[4]=p,u[5]=0,u[6]=0,u[7]=0,u[8]=1,u},h.fromScaling=function(u,e){return u[0]=e[0],u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=e[1],u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=e[2],u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u},h.furthestTileCorner=function(u){const e=Math.round((u+45+360)%360/90)%4;return de[e]},h.getAABBPointSquareDist=function(u,e,d){let p=0;for(let _=0;_<2;++_){const x=d?d[_]:0;u[_]>x&&(p+=(u[_]-x)*(u[_]-x)),e[_]<x&&(p+=(x-e[_])*(x-e[_]))}return p},h.getAnchorAlignment=eu,h.getAnchorJustification=ru,h.getBounds=function(u){let e=1/0,d=1/0,p=-1/0,_=-1/0;for(const x of u)e=Math.min(e,x.x),d=Math.min(d,x.y),p=Math.max(p,x.x),_=Math.max(_,x.y);return{min:new L(e,d),max:new L(p,_)}},h.getColumn=function(u,e){return[u[4*e],u[4*e+1],u[4*e+2],u[4*e+3]]},h.getGridMatrix=function(u,e){const[d,p]=e,_=.015625;return[0,(p[1]-d[1])*_,1<<u.z,(p[0]-d[0])*_,0,u.y,d[0],d[1],_]},h.getImage=ct,h.getJSON=function(u,e){return le(he(u,{type:"json"}),e)},h.getMapSessionAPI=Br,h.getPerformanceMeasurement=qd,h.getProjection=function(u){const e=u.parallels,d=!!e&&Math.abs(e[0]+e[1])<.01;switch(u.name){case"mercator":return new Hm(u);case"equirectangular":return new Qm(u);case"naturalEarth":return new tg(u);case"equalEarth":return new Jm(u);case"winkelTripel":return new ig(u);case"albers":return d?new Mf(u):new Km(u);case"lambertConformalConic":return d?new Mf(u):new eg(u)}throw new Error(`Invalid projection name: ${u.name}`)},h.getRTLTextPluginStatus=Ks,h.getReferrer=Y,h.getTilePoint=function(u,{x:e,y:d},p=0){return new L(((e-p)*u.scale-u.x)*di,(d*u.scale-u.y)*di)},h.getTileVec3=function(u,e,d=0){return ol(((e.x-d)*u.scale-u.x)*di,(e.y*u.scale-u.y)*di,Pu(e.z,e.y))},h.getVideo=function(u,e){const d=F.document.createElement("video");d.muted=!0,d.onloadstart=function(){e(null,d)};for(let p=0;p<u.length;p++){const _=F.document.createElement("source");Le(u[p])||(d.crossOrigin="Anonymous"),_.src=u[p],d.appendChild(_)}return{cancel:()=>{}}},h.globeECEFOrigin=function(u,e){const d=[0,0,0];return ps(d,d,Hd(Tl(e.canonical))),ps(d,d,u),d},h.globePixelsToTileUnits=function(u,e){return di/(512*Math.pow(2,u))*fu(Tl(e))},h.globePoleMatrixForTile=function(u,e,d){const p=$n(new Float64Array(16)),_=1<<u,x=360*(e/_-.5),T=d.point,A=d.worldSize/(d.tileSize*_);return fs(p,p,[T.x,T.y,-d.worldSize/Math.PI/2]),Io(p,p,[A,A,A]),Bh(p,p,K(-d._center.lat)),Rh(p,p,K(-d._center.lng+x)),Float32Array.from(p)},h.globeTileLatLngCorners=du,h.globeToMercatorTransition=function(u){return be(5,6,u)},h.identity=$n,h.identity$1=Hu,h.invert=function(u,e){var d=e[0],p=e[1],_=e[2],x=e[3],T=e[4],A=e[5],D=e[6],B=e[7],O=e[8],$=e[9],V=e[10],W=e[11],re=e[12],se=e[13],fe=e[14],xe=e[15],Ae=d*A-p*T,Pe=d*D-_*T,Re=d*B-x*T,ze=p*D-_*A,Fe=p*B-x*A,Xe=_*B-x*D,We=O*se-$*re,et=O*fe-V*re,rt=O*xe-W*re,Ge=$*fe-V*se,Je=$*xe-W*se,ot=V*xe-W*fe,pt=Ae*ot-Pe*Je+Re*Ge+ze*rt-Fe*et+Xe*We;return pt?(u[0]=(A*ot-D*Je+B*Ge)*(pt=1/pt),u[1]=(_*Je-p*ot-x*Ge)*pt,u[2]=(se*Xe-fe*Fe+xe*ze)*pt,u[3]=(V*Fe-$*Xe-W*ze)*pt,u[4]=(D*rt-T*ot-B*et)*pt,u[5]=(d*ot-_*rt+x*et)*pt,u[6]=(fe*Re-re*Xe-xe*Pe)*pt,u[7]=(O*Xe-V*Re+W*Pe)*pt,u[8]=(T*Je-A*rt+B*We)*pt,u[9]=(p*rt-d*Je-x*We)*pt,u[10]=(re*Fe-se*Re+xe*Ae)*pt,u[11]=($*Re-O*Fe-W*Ae)*pt,u[12]=(A*et-T*Ge-D*We)*pt,u[13]=(d*Ge-p*et+_*We)*pt,u[14]=(se*Pe-re*ze-fe*Ae)*pt,u[15]=(O*ze-$*Pe+V*Ae)*pt,u):null},h.isMapAuthenticated=function(u){return Rr.has(u)},h.isMapboxURL=Lt,h.isSafariWithAntialiasingBug=function(u){const e=u.navigator?u.navigator.userAgent:null;return!!ai(u)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},h.latFromMercatorY=br,h.len=tp,h.length=ju,h.length$1=function(u){return Math.hypot(u[0],u[1],u[2],u[3])},h.loadVectorTile=wf,h.makeRequest=le,h.mercatorXfromLng=nl,h.mercatorYfromLat=Qs,h.mercatorZfromAltitude=ea,h.mul=Qf,h.mul$1=ep,h.multiply=function(u,e,d){var p=e[0],_=e[1],x=e[2],T=e[3],A=e[4],D=e[5],B=e[6],O=e[7],$=e[8],V=d[0],W=d[1],re=d[2],se=d[3],fe=d[4],xe=d[5],Ae=d[6],Pe=d[7],Re=d[8];return u[0]=V*p+W*T+re*B,u[1]=V*_+W*A+re*O,u[2]=V*x+W*D+re*$,u[3]=se*p+fe*T+xe*B,u[4]=se*_+fe*A+xe*O,u[5]=se*x+fe*D+xe*$,u[6]=Ae*p+Pe*T+Re*B,u[7]=Ae*_+Pe*A+Re*O,u[8]=Ae*x+Pe*D+Re*$,u},h.multiply$1=Ph,h.multiply$2=Zu,h.nextPowerOfTwo=it,h.normalize=al,h.normalize$1=function(u,e){var d=e[0],p=e[1],_=e[2],x=e[3],T=d*d+p*p+_*_+x*x;return T>0&&(T=1/Math.sqrt(T)),u[0]=d*T,u[1]=p*T,u[2]=_*T,u[3]=x*T,u},h.number=Zt,h.ortho=function(u,e,d,p,_,x,T){var A=1/(e-d),D=1/(p-_),B=1/(x-T);return u[0]=-2*A,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*D,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*B,u[11]=0,u[12]=(e+d)*A,u[13]=(_+p)*D,u[14]=(T+x)*B,u[15]=1,u},h.pbf=xl,h.perspective=function(u,e,d,p,_){var x,T=1/Math.tan(e/2);return u[0]=T/d,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=T,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,_!=null&&_!==1/0?(u[10]=(_+p)*(x=1/(p-_)),u[14]=2*_*p*x):(u[10]=-1,u[14]=-2*p),u},h.pick=function(u,e){const d={};for(let p=0;p<e.length;p++){const _=e[p];_ in u&&(d[_]=u[_])}return d},h.plugin=Wr,h.pointGeometry=L,h.polygonIntersectsBox=Ou,h.polygonIntersectsPolygon=Ru,h.polygonizeBounds=function(u,e,d=0,p=!0){const _=new L(d,d),x=u.sub(_),T=e.add(_),A=[x,new L(T.x,x.y),T,new L(x.x,T.y)];return p&&A.push(x),A},h.posAttributes=El,h.postMapLoadEvent=Fi,h.postTurnstileEvent=Li,h.potpack=Hh,h.prevPowerOfTwo=function(u){return u<=1?1:Math.pow(2,Math.floor(Math.log(u)/Math.LN2))},h.radToDeg=X,h.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],h.registerForPluginStateChange=function(u){return u({pluginStatus:Ir,pluginURL:$r}),el.on("pluginStateChange",u),u},h.removeAuthState=function(u){Rr.delete(u)},h.renderColorRamp=Uh,h.rotateX=Bh,h.rotateX$1=Ku,h.rotateY=Rh,h.rotateZ=function(u,e,d){var p=Math.sin(d),_=Math.cos(d),x=e[0],T=e[1],A=e[2],D=e[3],B=e[4],O=e[5],$=e[6],V=e[7];return e!==u&&(u[8]=e[8],u[9]=e[9],u[10]=e[10],u[11]=e[11],u[12]=e[12],u[13]=e[13],u[14]=e[14],u[15]=e[15]),u[0]=x*_+B*p,u[1]=T*_+O*p,u[2]=A*_+$*p,u[3]=D*_+V*p,u[4]=B*_-x*p,u[5]=O*_-T*p,u[6]=$*_-A*p,u[7]=V*_-D*p,u},h.rotateZ$1=function(u,e,d){d*=.5;var p=e[0],_=e[1],x=e[2],T=e[3],A=Math.sin(d),D=Math.cos(d);return u[0]=p*D+_*A,u[1]=_*D-p*A,u[2]=x*D+T*A,u[3]=T*D-x*A,u},h.scale=Io,h.scale$1=function(u,e,d){return u[0]=e[0]*d,u[1]=e[1]*d,u[2]=e[2]*d,u[3]=e[3]*d,u},h.scale$2=sl,h.scaleAndAdd=Oh,h.setCacheLimits=function(u,e){mr=u,yr=e},h.setColumn=function(u,e,d){u[4*e+0]=d[0],u[4*e+1]=d[1],u[4*e+2]=d[2],u[4*e+3]=d[3]},h.setRTLTextPlugin=function(u,e,d=!1){if(Ir===Ka||Ir===as||Ir===Ja)throw new Error("setRTLTextPlugin cannot be called multiple times.");$r=dt.resolveURL(u),Ir=Ka,Qa=e,eo(),d||wo()},h.smoothstep=be,h.spec=Ne,h.storeAuthState=function(u,e){e?Rr.add(u):Rr.delete(u)},h.sub=ra,h.subtract=qu,h.symbolSize=Wp,h.tileAABB=function(u,e,d,p,_,x,T,A,D){if(D.name==="globe")return Um(u,e,new Kc(d,p,_));const B=gs({z:d,x:p,y:_},D);return new hn([(x+B.x/B.scale)*e,e*(B.y/B.scale),T],[(x+B.x2/B.scale)*e,e*(B.y2/B.scale),A])},h.tileTransform=gs,h.transformMat3=function(u,e,d){var p=e[0],_=e[1],x=e[2];return u[0]=p*d[0]+_*d[3]+x*d[6],u[1]=p*d[1]+_*d[4]+x*d[7],u[2]=p*d[2]+_*d[5]+x*d[8],u},h.transformMat4=ps,h.transformMat4$1=na,h.transformQuat=Yu,h.translate=fs,h.transpose=function(u,e){if(u===e){var d=e[1],p=e[2],_=e[5];u[1]=e[3],u[2]=e[6],u[3]=d,u[5]=e[7],u[6]=p,u[7]=_}else u[0]=e[0],u[1]=e[3],u[2]=e[6],u[3]=e[1],u[4]=e[4],u[5]=e[7],u[6]=e[2],u[7]=e[5],u[8]=e[8];return u},h.triggerPluginCompletionEvent=ls,h.uniqueId=Oe,h.validateCustomStyleLayer=function(u){const e=[],d=u.id;return d===void 0&&e.push({message:`layers.${d}: missing required property "id"`}),u.render===void 0&&e.push({message:`layers.${d}: missing required method "render"`}),u.renderingMode&&u.renderingMode!=="2d"&&u.renderingMode!=="3d"&&e.push({message:`layers.${d}: property "renderingMode" must be either "2d" or "3d"`}),e},h.validateFilter=u=>wn(Ln(u)),h.validateFog=u=>wn(ac(u)),h.validateLayer=u=>wn(ic(u)),h.validateLight=u=>wn(oc(u)),h.validateSource=u=>wn(nc(u)),h.validateStyle=is,h.validateTerrain=u=>wn(sc(u)),h.values=te,h.vectorTile=ms,h.version=S,h.warnOnce=nt,h.window=F,h.wrap=ne}),m(["./shared"],function(h){function S(J){if(typeof J=="number"||typeof J=="boolean"||typeof J=="string"||J==null)return JSON.stringify(J);if(Array.isArray(J)){let Y="[";for(const le of J)Y+=`${S(le)},`;return`${Y}]`}let j="{";for(const Y of Object.keys(J).sort())j+=`${Y}:${S(J[Y])},`;return`${j}}`}function M(J){let j="";for(const Y of h.refProperties)j+=`/${S(J[Y])}`;return j}class C{constructor(j){this.keyCache={},j&&this.replace(j)}replace(j){this._layerConfigs={},this._layers={},this.update(j,[])}update(j,Y){for(const pe of j)this._layerConfigs[pe.id]=pe,(this._layers[pe.id]=h.createStyleLayer(pe)).compileFilter(),this.keyCache[pe.id]&&delete this.keyCache[pe.id];for(const pe of Y)delete this.keyCache[pe],delete this._layerConfigs[pe],delete this._layers[pe];this.familiesBySource={};const le=function(pe,Ce){const Be={};for(let De=0;De<pe.length;De++){const Ve=Ce&&Ce[pe[De].id]||M(pe[De]);Ce&&(Ce[pe[De].id]=Ve);let Ke=Be[Ve];Ke||(Ke=Be[Ve]=[]),Ke.push(pe[De])}const Le=[];for(const De in Be)Le.push(Be[De]);return Le}(h.values(this._layerConfigs),this.keyCache);for(const pe of le){const Ce=pe.map(ct=>this._layers[ct.id]),Be=Ce[0];if(Be.visibility==="none")continue;const Le=Be.source||"";let De=this.familiesBySource[Le];De||(De=this.familiesBySource[Le]={});const Ve=Be.sourceLayer||"_geojsonTileLayer";let Ke=De[Ve];Ke||(Ke=De[Ve]=[]),Ke.push(Ce)}}}class L{loadTile(j,Y){const{uid:le,encoding:pe,rawImageData:Ce,padding:Be,buildQuadTree:Le}=j,De=h.window.ImageBitmap&&Ce instanceof h.window.ImageBitmap?this.getImageData(Ce,Be):Ce;Y(null,new h.DEMData(le,De,pe,Be<1,Le))}getImageData(j,Y){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(j.width,j.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=j.width,this.offscreenCanvas.height=j.height,this.offscreenCanvasContext.drawImage(j,0,0,j.width,j.height);const le=this.offscreenCanvasContext.getImageData(-Y,-Y,j.width+2*Y,j.height+2*Y);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),le}}var N=function J(j,Y){var le,pe=j&&j.type;if(pe==="FeatureCollection")for(le=0;le<j.features.length;le++)J(j.features[le],Y);else if(pe==="GeometryCollection")for(le=0;le<j.geometries.length;le++)J(j.geometries[le],Y);else if(pe==="Feature")J(j.geometry,Y);else if(pe==="Polygon")F(j.coordinates,Y);else if(pe==="MultiPolygon")for(le=0;le<j.coordinates.length;le++)F(j.coordinates[le],Y);return j};function F(J,j){if(J.length!==0){G(J[0],j);for(var Y=1;Y<J.length;Y++)G(J[Y],!j)}}function G(J,j){for(var Y=0,le=0,pe=0,Ce=J.length,Be=Ce-1;pe<Ce;Be=pe++){var Le=(J[pe][0]-J[Be][0])*(J[Be][1]+J[pe][1]),De=Y+Le;le+=Math.abs(Y)>=Math.abs(Le)?Y-De+Le:Le-De+Y,Y=De}Y+le>=0!=!!j&&J.reverse()}const H=h.vectorTile.VectorTileFeature.prototype.toGeoJSON;class K{constructor(j){this._feature=j,this.extent=h.EXTENT,this.type=j.type,this.properties=j.tags,"id"in j&&!isNaN(j.id)&&(this.id=parseInt(j.id,10))}loadGeometry(){if(this._feature.type===1){const j=[];for(const Y of this._feature.geometry)j.push([new h.pointGeometry(Y[0],Y[1])]);return j}{const j=[];for(const Y of this._feature.geometry){const le=[];for(const pe of Y)le.push(new h.pointGeometry(pe[0],pe[1]));j.push(le)}return j}}toGeoJSON(j,Y,le){return H.call(this,j,Y,le)}}class X{constructor(j){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=h.EXTENT,this.length=j.length,this._features=j}feature(j){return new K(this._features[j])}}var de=h.vectorTile.VectorTileFeature,Q=ie;function ie(J,j){this.options=j||{},this.features=J,this.length=J.length}function ce(J,j){this.id=typeof J.id=="number"?J.id:void 0,this.type=J.type,this.rawGeometry=J.type===1?[J.geometry]:J.geometry,this.properties=J.tags,this.extent=j||4096}ie.prototype.feature=function(J){return new ce(this.features[J],this.options.extent)},ce.prototype.loadGeometry=function(){var J=this.rawGeometry;this.geometry=[];for(var j=0;j<J.length;j++){for(var Y=J[j],le=[],pe=0;pe<Y.length;pe++)le.push(new h.pointGeometry(Y[pe][0],Y[pe][1]));this.geometry.push(le)}return this.geometry},ce.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var J=this.geometry,j=1/0,Y=-1/0,le=1/0,pe=-1/0,Ce=0;Ce<J.length;Ce++)for(var Be=J[Ce],Le=0;Le<Be.length;Le++){var De=Be[Le];j=Math.min(j,De.x),Y=Math.max(Y,De.x),le=Math.min(le,De.y),pe=Math.max(pe,De.y)}return[j,le,Y,pe]},ce.prototype.toGeoJSON=de.prototype.toGeoJSON;var ge=ne,be=Q;function ne(J){var j=new h.pbf;return function(Y,le){for(var pe in Y.layers)le.writeMessage(3,ve,Y.layers[pe])}(J,j),j.finish()}function ve(J,j){var Y;j.writeVarintField(15,J.version||1),j.writeStringField(1,J.name||""),j.writeVarintField(5,J.extent||4096);var le={keys:[],values:[],keycache:{},valuecache:{}};for(Y=0;Y<J.length;Y++)le.feature=J.feature(Y),j.writeMessage(2,te,le);var pe=le.keys;for(Y=0;Y<pe.length;Y++)j.writeStringField(3,pe[Y]);var Ce=le.values;for(Y=0;Y<Ce.length;Y++)j.writeMessage(4,it,Ce[Y])}function te(J,j){var Y=J.feature;Y.id!==void 0&&j.writeVarintField(1,Y.id),j.writeMessage(2,he,J),j.writeVarintField(3,Y.type),j.writeMessage(4,tt,Y)}function he(J,j){var Y=J.feature,le=J.keys,pe=J.values,Ce=J.keycache,Be=J.valuecache;for(var Le in Y.properties){var De=Y.properties[Le],Ve=Ce[Le];if(De!==null){Ve===void 0&&(le.push(Le),Ce[Le]=Ve=le.length-1),j.writeVarint(Ve);var Ke=typeof De;Ke!=="string"&&Ke!=="boolean"&&Ke!=="number"&&(De=JSON.stringify(De));var ct=Ke+":"+De,Qe=Be[ct];Qe===void 0&&(pe.push(De),Be[ct]=Qe=pe.length-1),j.writeVarint(Qe)}}}function Ie(J,j){return(j<<3)+(7&J)}function Oe(J){return J<<1^J>>31}function tt(J,j){for(var Y=J.loadGeometry(),le=J.type,pe=0,Ce=0,Be=Y.length,Le=0;Le<Be;Le++){var De=Y[Le],Ve=1;le===1&&(Ve=De.length),j.writeVarint(Ie(1,Ve));for(var Ke=le===3?De.length-1:De.length,ct=0;ct<Ke;ct++){ct===1&&le!==1&&j.writeVarint(Ie(2,Ke-1));var Qe=De[ct].x-pe,Pt=De[ct].y-Ce;j.writeVarint(Oe(Qe)),j.writeVarint(Oe(Pt)),pe+=Qe,Ce+=Pt}le===3&&j.writeVarint(Ie(7,1))}}function it(J,j){var Y=typeof J;Y==="string"?j.writeStringField(1,J):Y==="boolean"?j.writeBooleanField(7,J):Y==="number"&&(J%1!=0?j.writeDoubleField(3,J):J<0?j.writeSVarintField(6,J):j.writeVarintField(5,J))}function Ct(J,j,Y,le,pe,Ce){if(pe-le<=Y)return;const Be=le+pe>>1;Rt(J,j,Be,le,pe,Ce%2),Ct(J,j,Y,le,Be-1,Ce+1),Ct(J,j,Y,Be+1,pe,Ce+1)}function Rt(J,j,Y,le,pe,Ce){for(;pe>le;){if(pe-le>600){const Ve=pe-le+1,Ke=Y-le+1,ct=Math.log(Ve),Qe=.5*Math.exp(2*ct/3),Pt=.5*Math.sqrt(ct*Qe*(Ve-Qe)/Ve)*(Ke-Ve/2<0?-1:1);Rt(J,j,Y,Math.max(le,Math.floor(Y-Ke*Qe/Ve+Pt)),Math.min(pe,Math.floor(Y+(Ve-Ke)*Qe/Ve+Pt)),Ce)}const Be=j[2*Y+Ce];let Le=le,De=pe;for(xt(J,j,le,Y),j[2*pe+Ce]>Be&&xt(J,j,le,pe);Le<De;){for(xt(J,j,Le,De),Le++,De--;j[2*Le+Ce]<Be;)Le++;for(;j[2*De+Ce]>Be;)De--}j[2*le+Ce]===Be?xt(J,j,le,De):(De++,xt(J,j,De,pe)),De<=Y&&(le=De+1),Y<=De&&(pe=De-1)}}function xt(J,j,Y,le){Vt(J,Y,le),Vt(j,2*Y,2*le),Vt(j,2*Y+1,2*le+1)}function Vt(J,j,Y){const le=J[j];J[j]=J[Y],J[Y]=le}function It(J,j,Y,le){const pe=J-Y,Ce=j-le;return pe*pe+Ce*Ce}ge.fromVectorTileJs=ne,ge.fromGeojsonVt=function(J,j){j=j||{};var Y={};for(var le in J)Y[le]=new Q(J[le].features,j),Y[le].name=le,Y[le].version=j.version,Y[le].extent=j.extent;return ne({layers:Y})},ge.GeoJSONWrapper=be;const Xt=J=>J[0],Jt=J=>J[1];class nt{constructor(j,Y=Xt,le=Jt,pe=64,Ce=Float64Array){this.nodeSize=pe,this.points=j;const Be=j.length<65536?Uint16Array:Uint32Array,Le=this.ids=new Be(j.length),De=this.coords=new Ce(2*j.length);for(let Ve=0;Ve<j.length;Ve++)Le[Ve]=Ve,De[2*Ve]=Y(j[Ve]),De[2*Ve+1]=le(j[Ve]);Ct(Le,De,pe,0,Le.length-1,0)}range(j,Y,le,pe){return function(Ce,Be,Le,De,Ve,Ke,ct){const Qe=[0,Ce.length-1,0],Pt=[];let bt,Bt;for(;Qe.length;){const Yt=Qe.pop(),Ne=Qe.pop(),Ei=Qe.pop();if(Ne-Ei<=ct){for(let Ii=Ei;Ii<=Ne;Ii++)bt=Be[2*Ii],Bt=Be[2*Ii+1],bt>=Le&&bt<=Ve&&Bt>=De&&Bt<=Ke&&Pt.push(Ce[Ii]);continue}const Mt=Math.floor((Ei+Ne)/2);bt=Be[2*Mt],Bt=Be[2*Mt+1],bt>=Le&&bt<=Ve&&Bt>=De&&Bt<=Ke&&Pt.push(Ce[Mt]);const Si=(Yt+1)%2;(Yt===0?Le<=bt:De<=Bt)&&(Qe.push(Ei),Qe.push(Mt-1),Qe.push(Si)),(Yt===0?Ve>=bt:Ke>=Bt)&&(Qe.push(Mt+1),Qe.push(Ne),Qe.push(Si))}return Pt}(this.ids,this.coords,j,Y,le,pe,this.nodeSize)}within(j,Y,le){return function(pe,Ce,Be,Le,De,Ve){const Ke=[0,pe.length-1,0],ct=[],Qe=De*De;for(;Ke.length;){const Pt=Ke.pop(),bt=Ke.pop(),Bt=Ke.pop();if(bt-Bt<=Ve){for(let Si=Bt;Si<=bt;Si++)It(Ce[2*Si],Ce[2*Si+1],Be,Le)<=Qe&&ct.push(pe[Si]);continue}const Yt=Math.floor((Bt+bt)/2),Ne=Ce[2*Yt],Ei=Ce[2*Yt+1];It(Ne,Ei,Be,Le)<=Qe&&ct.push(pe[Yt]);const Mt=(Pt+1)%2;(Pt===0?Be-De<=Ne:Le-De<=Ei)&&(Ke.push(Bt),Ke.push(Yt-1),Ke.push(Mt)),(Pt===0?Be+De>=Ne:Le+De>=Ei)&&(Ke.push(Yt+1),Ke.push(bt),Ke.push(Mt))}return ct}(this.ids,this.coords,j,Y,le,this.nodeSize)}}const mt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:J=>J},ft=Math.fround||(Dt=new Float32Array(1),J=>(Dt[0]=+J,Dt[0]));var Dt;class qt{constructor(j){this.options=dt(Object.create(mt),j),this.trees=new Array(this.options.maxZoom+1)}load(j){const{log:Y,minZoom:le,maxZoom:pe,nodeSize:Ce}=this.options;Y&&console.time("total time");const Be=`prepare ${j.length} points`;Y&&console.time(Be),this.points=j;let Le=[];for(let De=0;De<j.length;De++)j[De].geometry&&Le.push(ti(j[De],De));this.trees[pe+1]=new nt(Le,gi,Et,Ce,Float32Array),Y&&console.timeEnd(Be);for(let De=pe;De>=le;De--){const Ve=+Date.now();Le=this._cluster(Le,De),this.trees[De]=new nt(Le,gi,Et,Ce,Float32Array),Y&&console.log("z%d: %d clusters in %dms",De,Le.length,+Date.now()-Ve)}return Y&&console.timeEnd("total time"),this}getClusters(j,Y){let le=((j[0]+180)%360+360)%360-180;const pe=Math.max(-90,Math.min(90,j[1]));let Ce=j[2]===180?180:((j[2]+180)%360+360)%360-180;const Be=Math.max(-90,Math.min(90,j[3]));if(j[2]-j[0]>=360)le=-180,Ce=180;else if(le>Ce){const Ke=this.getClusters([le,pe,180,Be],Y),ct=this.getClusters([-180,pe,Ce,Be],Y);return Ke.concat(ct)}const Le=this.trees[this._limitZoom(Y)],De=Le.range(Ot(le),ai(Be),Ot(Ce),ai(pe)),Ve=[];for(const Ke of De){const ct=Le.points[Ke];Ve.push(ct.numPoints?fi(ct):this.points[ct.index])}return Ve}getChildren(j){const Y=this._getOriginId(j),le=this._getOriginZoom(j),pe="No cluster with the specified id.",Ce=this.trees[le];if(!Ce)throw new Error(pe);const Be=Ce.points[Y];if(!Be)throw new Error(pe);const Le=this.options.radius/(this.options.extent*Math.pow(2,le-1)),De=Ce.within(Be.x,Be.y,Le),Ve=[];for(const Ke of De){const ct=Ce.points[Ke];ct.parentId===j&&Ve.push(ct.numPoints?fi(ct):this.points[ct.index])}if(Ve.length===0)throw new Error(pe);return Ve}getLeaves(j,Y,le){const pe=[];return this._appendLeaves(pe,j,Y=Y||10,le=le||0,0),pe}getTile(j,Y,le){const pe=this.trees[this._limitZoom(j)],Ce=Math.pow(2,j),{extent:Be,radius:Le}=this.options,De=Le/Be,Ve=(le-De)/Ce,Ke=(le+1+De)/Ce,ct={features:[]};return this._addTileFeatures(pe.range((Y-De)/Ce,Ve,(Y+1+De)/Ce,Ke),pe.points,Y,le,Ce,ct),Y===0&&this._addTileFeatures(pe.range(1-De/Ce,Ve,1,Ke),pe.points,Ce,le,Ce,ct),Y===Ce-1&&this._addTileFeatures(pe.range(0,Ve,De/Ce,Ke),pe.points,-1,le,Ce,ct),ct.features.length?ct:null}getClusterExpansionZoom(j){let Y=this._getOriginZoom(j)-1;for(;Y<=this.options.maxZoom;){const le=this.getChildren(j);if(Y++,le.length!==1)break;j=le[0].properties.cluster_id}return Y}_appendLeaves(j,Y,le,pe,Ce){const Be=this.getChildren(Y);for(const Le of Be){const De=Le.properties;if(De&&De.cluster?Ce+De.point_count<=pe?Ce+=De.point_count:Ce=this._appendLeaves(j,De.cluster_id,le,pe,Ce):Ce<pe?Ce++:j.push(Le),j.length===le)break}return Ce}_addTileFeatures(j,Y,le,pe,Ce,Be){for(const Le of j){const De=Y[Le],Ve=De.numPoints;let Ke,ct,Qe;if(Ve)Ke=si(De),ct=De.x,Qe=De.y;else{const Bt=this.points[De.index];Ke=Bt.properties,ct=Ot(Bt.geometry.coordinates[0]),Qe=ai(Bt.geometry.coordinates[1])}const Pt={type:1,geometry:[[Math.round(this.options.extent*(ct*Ce-le)),Math.round(this.options.extent*(Qe*Ce-pe))]],tags:Ke};let bt;Ve?bt=De.id:this.options.generateId?bt=De.index:this.points[De.index].id&&(bt=this.points[De.index].id),bt!==void 0&&(Pt.id=bt),Be.features.push(Pt)}}_limitZoom(j){return Math.max(this.options.minZoom,Math.min(+j,this.options.maxZoom+1))}_cluster(j,Y){const le=[],{radius:pe,extent:Ce,reduce:Be,minPoints:Le}=this.options,De=pe/(Ce*Math.pow(2,Y));for(let Ve=0;Ve<j.length;Ve++){const Ke=j[Ve];if(Ke.zoom<=Y)continue;Ke.zoom=Y;const ct=this.trees[Y+1],Qe=ct.within(Ke.x,Ke.y,De),Pt=Ke.numPoints||1;let bt=Pt;for(const Bt of Qe){const Yt=ct.points[Bt];Yt.zoom>Y&&(bt+=Yt.numPoints||1)}if(bt>Pt&&bt>=Le){let Bt=Ke.x*Pt,Yt=Ke.y*Pt,Ne=Be&&Pt>1?this._map(Ke,!0):null;const Ei=(Ve<<5)+(Y+1)+this.points.length;for(const Mt of Qe){const Si=ct.points[Mt];if(Si.zoom<=Y)continue;Si.zoom=Y;const Ii=Si.numPoints||1;Bt+=Si.x*Ii,Yt+=Si.y*Ii,Si.parentId=Ei,Be&&(Ne||(Ne=this._map(Ke,!0)),Be(Ne,this._map(Si)))}Ke.parentId=Ei,le.push(oi(Bt/bt,Yt/bt,Ei,bt,Ne))}else if(le.push(Ke),bt>1)for(const Bt of Qe){const Yt=ct.points[Bt];Yt.zoom<=Y||(Yt.zoom=Y,le.push(Yt))}}return le}_getOriginId(j){return j-this.points.length>>5}_getOriginZoom(j){return(j-this.points.length)%32}_map(j,Y){if(j.numPoints)return Y?dt({},j.properties):j.properties;const le=this.points[j.index].properties,pe=this.options.map(le);return Y&&pe===le?dt({},pe):pe}}function oi(J,j,Y,le,pe){return{x:ft(J),y:ft(j),zoom:1/0,id:Y,parentId:-1,numPoints:le,properties:pe}}function ti(J,j){const[Y,le]=J.geometry.coordinates;return{x:ft(Ot(Y)),y:ft(ai(le)),zoom:1/0,index:j,parentId:-1}}function fi(J){return{type:"Feature",id:J.id,properties:si(J),geometry:{type:"Point",coordinates:[(j=J.x,360*(j-.5)),Nt(J.y)]}};var j}function si(J){const j=J.numPoints,Y=j>=1e4?`${Math.round(j/1e3)}k`:j>=1e3?Math.round(j/100)/10+"k":j;return dt(dt({},J.properties),{cluster:!0,cluster_id:J.id,point_count:j,point_count_abbreviated:Y})}function Ot(J){return J/360+.5}function ai(J){const j=Math.sin(J*Math.PI/180),Y=.5-.25*Math.log((1+j)/(1-j))/Math.PI;return Y<0?0:Y>1?1:Y}function Nt(J){const j=(180-360*J)*Math.PI/180;return 360*Math.atan(Math.exp(j))/Math.PI-90}function dt(J,j){for(const Y in j)J[Y]=j[Y];return J}function gi(J){return J.x}function Et(J){return J.y}function je(J,j,Y,le){for(var pe,Ce=le,Be=Y-j>>1,Le=Y-j,De=J[j],Ve=J[j+1],Ke=J[Y],ct=J[Y+1],Qe=j+3;Qe<Y;Qe+=3){var Pt=jt(J[Qe],J[Qe+1],De,Ve,Ke,ct);if(Pt>Ce)pe=Qe,Ce=Pt;else if(Pt===Ce){var bt=Math.abs(Qe-Be);bt<Le&&(pe=Qe,Le=bt)}}Ce>le&&(pe-j>3&&je(J,j,pe,le),J[pe+2]=Ce,Y-pe>3&&je(J,pe,Y,le))}function jt(J,j,Y,le,pe,Ce){var Be=pe-Y,Le=Ce-le;if(Be!==0||Le!==0){var De=((J-Y)*Be+(j-le)*Le)/(Be*Be+Le*Le);De>1?(Y=pe,le=Ce):De>0&&(Y+=Be*De,le+=Le*De)}return(Be=J-Y)*Be+(Le=j-le)*Le}function Wt(J,j,Y,le){var pe={id:J===void 0?null:J,type:j,geometry:Y,tags:le,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Ce){var Be=Ce.geometry,Le=Ce.type;if(Le==="Point"||Le==="MultiPoint"||Le==="LineString")Qt(Ce,Be);else if(Le==="Polygon"||Le==="MultiLineString")for(var De=0;De<Be.length;De++)Qt(Ce,Be[De]);else if(Le==="MultiPolygon")for(De=0;De<Be.length;De++)for(var Ve=0;Ve<Be[De].length;Ve++)Qt(Ce,Be[De][Ve])}(pe),pe}function Qt(J,j){for(var Y=0;Y<j.length;Y+=3)J.minX=Math.min(J.minX,j[Y]),J.minY=Math.min(J.minY,j[Y+1]),J.maxX=Math.max(J.maxX,j[Y]),J.maxY=Math.max(J.maxY,j[Y+1])}function ni(J,j,Y,le){if(j.geometry){var pe=j.geometry.coordinates,Ce=j.geometry.type,Be=Math.pow(Y.tolerance/((1<<Y.maxZoom)*Y.extent),2),Le=[],De=j.id;if(Y.promoteId?De=j.properties[Y.promoteId]:Y.generateId&&(De=le||0),Ce==="Point")gt(pe,Le);else if(Ce==="MultiPoint")for(var Ve=0;Ve<pe.length;Ve++)gt(pe[Ve],Le);else if(Ce==="LineString")Ai(pe,Le,Be,!1);else if(Ce==="MultiLineString"){if(Y.lineMetrics){for(Ve=0;Ve<pe.length;Ve++)Ai(pe[Ve],Le=[],Be,!1),J.push(Wt(De,"LineString",Le,j.properties));return}ci(pe,Le,Be,!1)}else if(Ce==="Polygon")ci(pe,Le,Be,!0);else{if(Ce!=="MultiPolygon"){if(Ce==="GeometryCollection"){for(Ve=0;Ve<j.geometry.geometries.length;Ve++)ni(J,{id:De,geometry:j.geometry.geometries[Ve],properties:j.properties},Y,le);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Ve=0;Ve<pe.length;Ve++){var Ke=[];ci(pe[Ve],Ke,Be,!0),Le.push(Ke)}}J.push(Wt(De,Ce,Le,j.properties))}}function gt(J,j){j.push(Lt(J[0])),j.push($t(J[1])),j.push(0)}function Ai(J,j,Y,le){for(var pe,Ce,Be=0,Le=0;Le<J.length;Le++){var De=Lt(J[Le][0]),Ve=$t(J[Le][1]);j.push(De),j.push(Ve),j.push(0),Le>0&&(Be+=le?(pe*Ve-De*Ce)/2:Math.sqrt(Math.pow(De-pe,2)+Math.pow(Ve-Ce,2))),pe=De,Ce=Ve}var Ke=j.length-3;j[2]=1,je(j,0,Ke,Y),j[Ke+2]=1,j.size=Math.abs(Be),j.start=0,j.end=j.size}function ci(J,j,Y,le){for(var pe=0;pe<J.length;pe++){var Ce=[];Ai(J[pe],Ce,Y,le),j.push(Ce)}}function Lt(J){return J/360+.5}function $t(J){var j=Math.sin(J*Math.PI/180),Y=.5-.25*Math.log((1+j)/(1-j))/Math.PI;return Y<0?0:Y>1?1:Y}function _t(J,j,Y,le,pe,Ce,Be,Le){if(le/=j,Ce>=(Y/=j)&&Be<le)return J;if(Be<Y||Ce>=le)return null;for(var De=[],Ve=0;Ve<J.length;Ve++){var Ke=J[Ve],ct=Ke.geometry,Qe=Ke.type,Pt=pe===0?Ke.minX:Ke.minY,bt=pe===0?Ke.maxX:Ke.maxY;if(Pt>=Y&&bt<le)De.push(Ke);else if(!(bt<Y||Pt>=le)){var Bt=[];if(Qe==="Point"||Qe==="MultiPoint")hi(ct,Bt,Y,le,pe);else if(Qe==="LineString")_i(ct,Bt,Y,le,pe,!1,Le.lineMetrics);else if(Qe==="MultiLineString")Ht(ct,Bt,Y,le,pe,!1);else if(Qe==="Polygon")Ht(ct,Bt,Y,le,pe,!0);else if(Qe==="MultiPolygon")for(var Yt=0;Yt<ct.length;Yt++){var Ne=[];Ht(ct[Yt],Ne,Y,le,pe,!0),Ne.length&&Bt.push(Ne)}if(Bt.length){if(Le.lineMetrics&&Qe==="LineString"){for(Yt=0;Yt<Bt.length;Yt++)De.push(Wt(Ke.id,Qe,Bt[Yt],Ke.tags));continue}Qe!=="LineString"&&Qe!=="MultiLineString"||(Bt.length===1?(Qe="LineString",Bt=Bt[0]):Qe="MultiLineString"),Qe!=="Point"&&Qe!=="MultiPoint"||(Qe=Bt.length===3?"Point":"MultiPoint"),De.push(Wt(Ke.id,Qe,Bt,Ke.tags))}}}return De.length?De:null}function hi(J,j,Y,le,pe){for(var Ce=0;Ce<J.length;Ce+=3){var Be=J[Ce+pe];Be>=Y&&Be<=le&&(j.push(J[Ce]),j.push(J[Ce+1]),j.push(J[Ce+2]))}}function _i(J,j,Y,le,pe,Ce,Be){for(var Le,De,Ve=wi(J),Ke=pe===0?Li:zi,ct=J.start,Qe=0;Qe<J.length-3;Qe+=3){var Pt=J[Qe],bt=J[Qe+1],Bt=J[Qe+2],Yt=J[Qe+3],Ne=J[Qe+4],Ei=pe===0?Pt:bt,Mt=pe===0?Yt:Ne,Si=!1;Be&&(Le=Math.sqrt(Math.pow(Pt-Yt,2)+Math.pow(bt-Ne,2))),Ei<Y?Mt>Y&&(De=Ke(Ve,Pt,bt,Yt,Ne,Y),Be&&(Ve.start=ct+Le*De)):Ei>le?Mt<le&&(De=Ke(Ve,Pt,bt,Yt,Ne,le),Be&&(Ve.start=ct+Le*De)):ui(Ve,Pt,bt,Bt),Mt<Y&&Ei>=Y&&(De=Ke(Ve,Pt,bt,Yt,Ne,Y),Si=!0),Mt>le&&Ei<=le&&(De=Ke(Ve,Pt,bt,Yt,Ne,le),Si=!0),!Ce&&Si&&(Be&&(Ve.end=ct+Le*De),j.push(Ve),Ve=wi(J)),Be&&(ct+=Le)}var Ii=J.length-3;Pt=J[Ii],bt=J[Ii+1],Bt=J[Ii+2],(Ei=pe===0?Pt:bt)>=Y&&Ei<=le&&ui(Ve,Pt,bt,Bt),Ii=Ve.length-3,Ce&&Ii>=3&&(Ve[Ii]!==Ve[0]||Ve[Ii+1]!==Ve[1])&&ui(Ve,Ve[0],Ve[1],Ve[2]),Ve.length&&j.push(Ve)}function wi(J){var j=[];return j.size=J.size,j.start=J.start,j.end=J.end,j}function Ht(J,j,Y,le,pe,Ce){for(var Be=0;Be<J.length;Be++)_i(J[Be],j,Y,le,pe,Ce,!1)}function ui(J,j,Y,le){J.push(j),J.push(Y),J.push(le)}function Li(J,j,Y,le,pe,Ce){var Be=(Ce-j)/(le-j);return J.push(Ce),J.push(Y+(pe-Y)*Be),J.push(1),Be}function zi(J,j,Y,le,pe,Ce){var Be=(Ce-Y)/(pe-Y);return J.push(j+(le-j)*Be),J.push(Ce),J.push(1),Be}function Fi(J,j){for(var Y=[],le=0;le<J.length;le++){var pe,Ce=J[le],Be=Ce.type;if(Be==="Point"||Be==="MultiPoint"||Be==="LineString")pe=tr(Ce.geometry,j);else if(Be==="MultiLineString"||Be==="Polygon"){pe=[];for(var Le=0;Le<Ce.geometry.length;Le++)pe.push(tr(Ce.geometry[Le],j))}else if(Be==="MultiPolygon")for(pe=[],Le=0;Le<Ce.geometry.length;Le++){for(var De=[],Ve=0;Ve<Ce.geometry[Le].length;Ve++)De.push(tr(Ce.geometry[Le][Ve],j));pe.push(De)}Y.push(Wt(Ce.id,Be,pe,Ce.tags))}return Y}function tr(J,j){var Y=[];Y.size=J.size,J.start!==void 0&&(Y.start=J.start,Y.end=J.end);for(var le=0;le<J.length;le+=3)Y.push(J[le]+j,J[le+1],J[le+2]);return Y}function Br(J,j){if(J.transformed)return J;var Y,le,pe,Ce=1<<J.z,Be=J.x,Le=J.y;for(Y=0;Y<J.features.length;Y++){var De=J.features[Y],Ve=De.geometry,Ke=De.type;if(De.geometry=[],Ke===1)for(le=0;le<Ve.length;le+=2)De.geometry.push(Rr(Ve[le],Ve[le+1],j,Ce,Be,Le));else for(le=0;le<Ve.length;le++){var ct=[];for(pe=0;pe<Ve[le].length;pe+=2)ct.push(Rr(Ve[le][pe],Ve[le][pe+1],j,Ce,Be,Le));De.geometry.push(ct)}}return J.transformed=!0,J}function Rr(J,j,Y,le,pe,Ce){return[Math.round(Y*(J*le-pe)),Math.round(Y*(j*le-Ce))]}function Er(J,j,Y,le,pe){for(var Ce=j===pe.maxZoom?0:pe.tolerance/((1<<j)*pe.extent),Be={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:Y,y:le,z:j,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Le=0;Le<J.length;Le++){Be.numFeatures++,er(Be,J[Le],Ce,pe);var De=J[Le].minX,Ve=J[Le].minY,Ke=J[Le].maxX,ct=J[Le].maxY;De<Be.minX&&(Be.minX=De),Ve<Be.minY&&(Be.minY=Ve),Ke>Be.maxX&&(Be.maxX=Ke),ct>Be.maxY&&(Be.maxY=ct)}return Be}function er(J,j,Y,le){var pe=j.geometry,Ce=j.type,Be=[];if(Ce==="Point"||Ce==="MultiPoint")for(var Le=0;Le<pe.length;Le+=3)Be.push(pe[Le]),Be.push(pe[Le+1]),J.numPoints++,J.numSimplified++;else if(Ce==="LineString")ur(Be,pe,J,Y,!1,!1);else if(Ce==="MultiLineString"||Ce==="Polygon")for(Le=0;Le<pe.length;Le++)ur(Be,pe[Le],J,Y,Ce==="Polygon",Le===0);else if(Ce==="MultiPolygon")for(var De=0;De<pe.length;De++){var Ve=pe[De];for(Le=0;Le<Ve.length;Le++)ur(Be,Ve[Le],J,Y,!0,Le===0)}if(Be.length){var Ke=j.tags||null;if(Ce==="LineString"&&le.lineMetrics){for(var ct in Ke={},j.tags)Ke[ct]=j.tags[ct];Ke.mapbox_clip_start=pe.start/pe.size,Ke.mapbox_clip_end=pe.end/pe.size}var Qe={geometry:Be,type:Ce==="Polygon"||Ce==="MultiPolygon"?3:Ce==="LineString"||Ce==="MultiLineString"?2:1,tags:Ke};j.id!==null&&(Qe.id=j.id),J.features.push(Qe)}}function ur(J,j,Y,le,pe,Ce){var Be=le*le;if(le>0&&j.size<(pe?Be:le))Y.numPoints+=j.length/3;else{for(var Le=[],De=0;De<j.length;De+=3)(le===0||j[De+2]>Be)&&(Y.numSimplified++,Le.push(j[De]),Le.push(j[De+1])),Y.numPoints++;pe&&function(Ve,Ke){for(var ct=0,Qe=0,Pt=Ve.length,bt=Pt-2;Qe<Pt;bt=Qe,Qe+=2)ct+=(Ve[Qe]-Ve[bt])*(Ve[Qe+1]+Ve[bt+1]);if(ct>0===Ke)for(Qe=0,Pt=Ve.length;Qe<Pt/2;Qe+=2){var Bt=Ve[Qe],Yt=Ve[Qe+1];Ve[Qe]=Ve[Pt-2-Qe],Ve[Qe+1]=Ve[Pt-1-Qe],Ve[Pt-2-Qe]=Bt,Ve[Pt-1-Qe]=Yt}}(Le,Ce),J.push(Le)}}function mr(J,j){var Y=(j=this.options=function(pe,Ce){for(var Be in Ce)pe[Be]=Ce[Be];return pe}(Object.create(this.options),j)).debug;if(Y&&console.time("preprocess data"),j.maxZoom<0||j.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(j.promoteId&&j.generateId)throw new Error("promoteId and generateId cannot be used together.");var le=function(pe,Ce){var Be=[];if(pe.type==="FeatureCollection")for(var Le=0;Le<pe.features.length;Le++)ni(Be,pe.features[Le],Ce,Le);else ni(Be,pe.type==="Feature"?pe:{geometry:pe},Ce);return Be}(J,j);this.tiles={},this.tileCoords=[],Y&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",j.indexMaxZoom,j.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(le=function(pe,Ce){var Be=Ce.buffer/Ce.extent,Le=pe,De=_t(pe,1,-1-Be,Be,0,-1,2,Ce),Ve=_t(pe,1,1-Be,2+Be,0,-1,2,Ce);return(De||Ve)&&(Le=_t(pe,1,-Be,1+Be,0,-1,2,Ce)||[],De&&(Le=Fi(De,1).concat(Le)),Ve&&(Le=Le.concat(Fi(Ve,-1)))),Le}(le,j)).length&&this.splitTile(le,0,0,0),Y&&(le.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function yr(J,j,Y){return 32*((1<<J)*Y+j)+J}function Sr(J,j){const Y=J.tileID.canonical;if(!this._geoJSONIndex)return j(null,null);const le=this._geoJSONIndex.getTile(Y.z,Y.x,Y.y);if(!le)return j(null,null);const pe=new X(le.features);let Ce=ge(pe);Ce.byteOffset===0&&Ce.byteLength===Ce.buffer.byteLength||(Ce=new Uint8Array(Ce)),j(null,{vectorTile:pe,rawData:Ce.buffer})}mr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},mr.prototype.splitTile=function(J,j,Y,le,pe,Ce,Be){for(var Le=[J,j,Y,le],De=this.options,Ve=De.debug;Le.length;){le=Le.pop(),Y=Le.pop(),j=Le.pop(),J=Le.pop();var Ke=1<<j,ct=yr(j,Y,le),Qe=this.tiles[ct];if(!Qe&&(Ve>1&&console.time("creation"),Qe=this.tiles[ct]=Er(J,j,Y,le,De),this.tileCoords.push({z:j,x:Y,y:le}),Ve)){Ve>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",j,Y,le,Qe.numFeatures,Qe.numPoints,Qe.numSimplified),console.timeEnd("creation"));var Pt="z"+j;this.stats[Pt]=(this.stats[Pt]||0)+1,this.total++}if(Qe.source=J,pe){if(j===De.maxZoom||j===pe)continue;var bt=1<<pe-j;if(Y!==Math.floor(Ce/bt)||le!==Math.floor(Be/bt))continue}else if(j===De.indexMaxZoom||Qe.numPoints<=De.indexMaxPoints)continue;if(Qe.source=null,J.length!==0){Ve>1&&console.time("clipping");var Bt,Yt,Ne,Ei,Mt,Si,Ii=.5*De.buffer/De.extent,Zr=.5-Ii,_n=.5+Ii,yt=1+Ii;Bt=Yt=Ne=Ei=null,Mt=_t(J,Ke,Y-Ii,Y+_n,0,Qe.minX,Qe.maxX,De),Si=_t(J,Ke,Y+Zr,Y+yt,0,Qe.minX,Qe.maxX,De),J=null,Mt&&(Bt=_t(Mt,Ke,le-Ii,le+_n,1,Qe.minY,Qe.maxY,De),Yt=_t(Mt,Ke,le+Zr,le+yt,1,Qe.minY,Qe.maxY,De),Mt=null),Si&&(Ne=_t(Si,Ke,le-Ii,le+_n,1,Qe.minY,Qe.maxY,De),Ei=_t(Si,Ke,le+Zr,le+yt,1,Qe.minY,Qe.maxY,De),Si=null),Ve>1&&console.timeEnd("clipping"),Le.push(Bt||[],j+1,2*Y,2*le),Le.push(Yt||[],j+1,2*Y,2*le+1),Le.push(Ne||[],j+1,2*Y+1,2*le),Le.push(Ei||[],j+1,2*Y+1,2*le+1)}}},mr.prototype.getTile=function(J,j,Y){var le=this.options,pe=le.extent,Ce=le.debug;if(J<0||J>24)return null;var Be=1<<J,Le=yr(J,j=(j%Be+Be)%Be,Y);if(this.tiles[Le])return Br(this.tiles[Le],pe);Ce>1&&console.log("drilling down to z%d-%d-%d",J,j,Y);for(var De,Ve=J,Ke=j,ct=Y;!De&&Ve>0;)Ve--,Ke=Math.floor(Ke/2),ct=Math.floor(ct/2),De=this.tiles[yr(Ve,Ke,ct)];return De&&De.source?(Ce>1&&console.log("found parent tile z%d-%d-%d",Ve,Ke,ct),Ce>1&&console.time("drilling down"),this.splitTile(De.source,Ve,Ke,ct,J,j,Y),Ce>1&&console.timeEnd("drilling down"),this.tiles[Le]?Br(this.tiles[Le],pe):null):null};class Lr extends h.VectorTileWorkerSource{constructor(j,Y,le,pe,Ce){super(j,Y,le,pe,Sr),Ce&&(this.loadGeoJSON=Ce)}loadData(j,Y){const le=j&&j.request,pe=le&&le.collectResourceTiming;this.loadGeoJSON(j,(Ce,Be)=>{if(Ce||!Be)return Y(Ce);if(typeof Be!="object")return Y(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`));{N(Be,!0);try{if(j.filter){const De=h.createExpression(j.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(De.result==="error")throw new Error(De.value.map(Ke=>`${Ke.key}: ${Ke.message}`).join(", "));const Ve=Be.features.filter(Ke=>De.value.evaluate({zoom:0},Ke));Be={type:"FeatureCollection",features:Ve}}this._geoJSONIndex=j.cluster?new qt(function({superclusterOptions:De,clusterProperties:Ve}){if(!Ve||!De)return De;const Ke={},ct={},Qe={accumulated:null,zoom:0},Pt={properties:null},bt=Object.keys(Ve);for(const Bt of bt){const[Yt,Ne]=Ve[Bt],Ei=h.createExpression(Ne),Mt=h.createExpression(typeof Yt=="string"?[Yt,["accumulated"],["get",Bt]]:Yt);Ke[Bt]=Ei.value,ct[Bt]=Mt.value}return De.map=Bt=>{Pt.properties=Bt;const Yt={};for(const Ne of bt)Yt[Ne]=Ke[Ne].evaluate(Qe,Pt);return Yt},De.reduce=(Bt,Yt)=>{Pt.properties=Yt;for(const Ne of bt)Qe.accumulated=Bt[Ne],Bt[Ne]=ct[Ne].evaluate(Qe,Pt)},De}(j)).load(Be.features):function(De,Ve){return new mr(De,Ve)}(Be,j.geojsonVtOptions)}catch(De){return Y(De)}this.loaded={};const Le={};if(pe){const De=h.getPerformanceMeasurement(le);De&&(Le.resourceTiming={},Le.resourceTiming[j.source]=JSON.parse(JSON.stringify(De)))}Y(null,Le)}})}reloadTile(j,Y){const le=this.loaded;return le&&le[j.uid]?super.reloadTile(j,Y):this.loadTile(j,Y)}loadGeoJSON(j,Y){if(j.request)h.getJSON(j.request,Y);else{if(typeof j.data!="string")return Y(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`));try{return Y(null,JSON.parse(j.data))}catch{return Y(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(j,Y){try{Y(null,this._geoJSONIndex.getClusterExpansionZoom(j.clusterId))}catch(le){Y(le)}}getClusterChildren(j,Y){try{Y(null,this._geoJSONIndex.getChildren(j.clusterId))}catch(le){Y(le)}}getClusterLeaves(j,Y){try{Y(null,this._geoJSONIndex.getLeaves(j.clusterId,j.limit,j.offset))}catch(le){Y(le)}}}class _e{constructor(j){this.self=j,this.actor=new h.Actor(j,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=h.getProjection({name:"mercator"}),this.workerSourceTypes={vector:h.VectorTileWorkerSource,geojson:Lr},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(Y,le)=>{if(this.workerSourceTypes[Y])throw new Error(`Worker source with name "${Y}" already registered.`);this.workerSourceTypes[Y]=le},this.self.registerRTLTextPlugin=Y=>{if(h.plugin.isParsed())throw new Error("RTL text plugin already registered.");h.plugin.applyArabicShaping=Y.applyArabicShaping,h.plugin.processBidirectionalText=Y.processBidirectionalText,h.plugin.processStyledBidirectionalText=Y.processStyledBidirectionalText}}clearCaches(j,Y,le){delete this.layerIndexes[j],delete this.availableImages[j],delete this.workerSources[j],delete this.demWorkerSources[j],le()}checkIfReady(j,Y,le){le()}setReferrer(j,Y){this.referrer=Y}spriteLoaded(j,Y){this.isSpriteLoaded[j]=Y;for(const le in this.workerSources[j]){const pe=this.workerSources[j][le];for(const Ce in pe)pe[Ce]instanceof h.VectorTileWorkerSource&&(pe[Ce].isSpriteLoaded=Y,pe[Ce].fire(new h.Event("isSpriteLoaded")))}}setImages(j,Y,le){this.availableImages[j]=Y;for(const pe in this.workerSources[j]){const Ce=this.workerSources[j][pe];for(const Be in Ce)Ce[Be].availableImages=Y}le()}enableTerrain(j,Y,le){this.terrain=Y,le()}setProjection(j,Y){this.projections[j]=h.getProjection(Y)}setLayers(j,Y,le){this.getLayerIndex(j).replace(Y),le()}updateLayers(j,Y,le){this.getLayerIndex(j).update(Y.layers,Y.removedIds),le()}loadTile(j,Y,le){const pe=this.enableTerrain?h.extend({enableTerrain:this.terrain},Y):Y;pe.projection=this.projections[j]||this.defaultProjection,this.getWorkerSource(j,Y.type,Y.source).loadTile(pe,le)}loadDEMTile(j,Y,le){const pe=this.enableTerrain?h.extend({buildQuadTree:this.terrain},Y):Y;this.getDEMWorkerSource(j,Y.source).loadTile(pe,le)}reloadTile(j,Y,le){const pe=this.enableTerrain?h.extend({enableTerrain:this.terrain},Y):Y;pe.projection=this.projections[j]||this.defaultProjection,this.getWorkerSource(j,Y.type,Y.source).reloadTile(pe,le)}abortTile(j,Y,le){this.getWorkerSource(j,Y.type,Y.source).abortTile(Y,le)}removeTile(j,Y,le){this.getWorkerSource(j,Y.type,Y.source).removeTile(Y,le)}removeSource(j,Y,le){if(!this.workerSources[j]||!this.workerSources[j][Y.type]||!this.workerSources[j][Y.type][Y.source])return;const pe=this.workerSources[j][Y.type][Y.source];delete this.workerSources[j][Y.type][Y.source],pe.removeSource!==void 0?pe.removeSource(Y,le):le()}loadWorkerSource(j,Y,le){try{this.self.importScripts(Y.url),le()}catch(pe){le(pe.toString())}}syncRTLPluginState(j,Y,le){try{h.plugin.setState(Y);const pe=h.plugin.getPluginURL();if(h.plugin.isLoaded()&&!h.plugin.isParsed()&&pe!=null){this.self.importScripts(pe);const Ce=h.plugin.isParsed();le(Ce?void 0:new Error(`RTL Text Plugin failed to import scripts from ${pe}`),Ce)}}catch(pe){le(pe.toString())}}getAvailableImages(j){let Y=this.availableImages[j];return Y||(Y=[]),Y}getLayerIndex(j){let Y=this.layerIndexes[j];return Y||(Y=this.layerIndexes[j]=new C),Y}getWorkerSource(j,Y,le){return this.workerSources[j]||(this.workerSources[j]={}),this.workerSources[j][Y]||(this.workerSources[j][Y]={}),this.workerSources[j][Y][le]||(this.workerSources[j][Y][le]=new this.workerSourceTypes[Y]({send:(pe,Ce,Be,Le,De,Ve)=>{this.actor.send(pe,Ce,Be,j,De,Ve)},scheduler:this.actor.scheduler},this.getLayerIndex(j),this.getAvailableImages(j),this.isSpriteLoaded[j])),this.workerSources[j][Y][le]}getDEMWorkerSource(j,Y){return this.demWorkerSources[j]||(this.demWorkerSources[j]={}),this.demWorkerSources[j][Y]||(this.demWorkerSources[j][Y]=new L),this.demWorkerSources[j][Y]}enforceCacheSizeLimit(j,Y){h.enforceCacheSizeLimit(Y)}getWorkerPerformanceMetrics(j,Y,le){le(void 0,void 0)}}return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope&&(self.worker=new _e(self)),_e}),m(["./shared"],function(h){var S=M;function M(y){return!function(c){return typeof window=="undefined"||typeof document=="undefined"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var w,I,k=new Blob([""],{type:"text/javascript"}),P=URL.createObjectURL(k);try{I=new Worker(P),w=!0}catch{w=!1}return I&&I.terminate(),URL.revokeObjectURL(P),w}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var w=document.createElement("canvas");w.width=w.height=1;var I=w.getContext("2d");if(!I)return!1;var k=I.getImageData(0,0,1,1);return k&&k.width===w.width}()?(C[g=c&&c.failIfMajorPerformanceCaveat]===void 0&&(C[g]=function(w){var I,k=function(P){var z=document.createElement("canvas"),U=Object.create(M.webGLContextAttributes);return U.failIfMajorPerformanceCaveat=P,z.getContext("webgl",U)||z.getContext("experimental-webgl",U)}(w);if(!k)return!1;try{I=k.createShader(k.VERTEX_SHADER)}catch{return!1}return!(!I||k.isContextLost())&&(k.shaderSource(I,"void main() {}"),k.compileShader(I),k.getShaderParameter(I,k.COMPILE_STATUS)===!0)}(g)),C[g]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var g}(y)}var C={};function L(y,c){if(Array.isArray(y)){if(!Array.isArray(c)||y.length!==c.length)return!1;for(let g=0;g<y.length;g++)if(!L(y[g],c[g]))return!1;return!0}if(typeof y=="object"&&y!==null&&c!==null){if(typeof c!="object"||Object.keys(y).length!==Object.keys(c).length)return!1;for(const g in y)if(!L(y[g],c[g]))return!1;return!0}return y===c}function N(y,c,g){const w=h.window.document.createElement(y);return c!==void 0&&(w.className=c),g&&g.appendChild(w),w}function F(y,c,g){const w=h.window.document.createElementNS("http://www.w3.org/2000/svg",y);for(const I of Object.keys(c))w.setAttributeNS(null,I,c[I]);return g&&g.appendChild(w),w}M.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const G=h.window.document&&h.window.document.documentElement.style,H=G&&G.userSelect!==void 0?"userSelect":"WebkitUserSelect";let K;function X(){G&&H&&(K=G[H],G[H]="none")}function de(){G&&H&&(G[H]=K)}function Q(y){y.preventDefault(),y.stopPropagation(),h.window.removeEventListener("click",Q,!0)}function ie(){h.window.addEventListener("click",Q,!0),h.window.setTimeout(()=>{h.window.removeEventListener("click",Q,!0)},0)}function ce(y,c){const g=y.getBoundingClientRect();return ne(y,g,c)}function ge(y,c){const g=y.getBoundingClientRect(),w=[];for(let I=0;I<c.length;I++)w.push(ne(y,g,c[I]));return w}function be(y){return h.window.InstallTrigger!==void 0&&y.button===2&&y.ctrlKey&&h.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:y.button}function ne(y,c,g){const w=y.offsetWidth===c.width?1:y.offsetWidth/c.width;return new h.pointGeometry((g.clientX-c.left)*w,(g.clientY-c.top)*w)}function ve(y,c){var g=c[0],w=c[1],I=c[2],k=c[3],P=g*k-I*w;return P?(y[0]=k*(P=1/P),y[1]=-w*P,y[2]=-I*P,y[3]=g*P,y):null}function te(y){const{userImage:c}=y;return!!(c&&c.render&&c.render())&&(y.data.replace(new Uint8Array(c.data.buffer)),!0)}class he extends h.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new h.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(c){if(this.loaded!==c&&(this.loaded=c,c)){for(const{ids:g,callback:w}of this.requestors)this._notify(g,w);this.requestors=[]}}hasImage(c){return!!this.getImage(c)}getImage(c){return this.images[c]}addImage(c,g){this._validate(c,g)&&(this.images[c]=g)}_validate(c,g){let w=!0;return this._validateStretch(g.stretchX,g.data&&g.data.width)||(this.fire(new h.ErrorEvent(new Error(`Image "${c}" has invalid "stretchX" value`))),w=!1),this._validateStretch(g.stretchY,g.data&&g.data.height)||(this.fire(new h.ErrorEvent(new Error(`Image "${c}" has invalid "stretchY" value`))),w=!1),this._validateContent(g.content,g)||(this.fire(new h.ErrorEvent(new Error(`Image "${c}" has invalid "content" value`))),w=!1),w}_validateStretch(c,g){if(!c)return!0;let w=0;for(const I of c){if(I[0]<w||I[1]<I[0]||g<I[1])return!1;w=I[1]}return!0}_validateContent(c,g){return!(c&&(c.length!==4||c[0]<0||g.data.width<c[0]||c[1]<0||g.data.height<c[1]||c[2]<0||g.data.width<c[2]||c[3]<0||g.data.height<c[3]||c[2]<c[0]||c[3]<c[1]))}updateImage(c,g){g.version=this.images[c].version+1,this.images[c]=g,this.updatedImages[c]=!0}removeImage(c){const g=this.images[c];delete this.images[c],delete this.patterns[c],g.userImage&&g.userImage.onRemove&&g.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(c,g){let w=!0;if(!this.isLoaded())for(const I of c)this.images[I]||(w=!1);this.isLoaded()||w?this._notify(c,g):this.requestors.push({ids:c,callback:g})}_notify(c,g){const w={};for(const I of c){this.images[I]||this.fire(new h.Event("styleimagemissing",{id:I}));const k=this.images[I];k?w[I]={data:k.data.clone(),pixelRatio:k.pixelRatio,sdf:k.sdf,version:k.version,stretchX:k.stretchX,stretchY:k.stretchY,content:k.content,hasRenderCallback:Boolean(k.userImage&&k.userImage.render)}:h.warnOnce(`Image "${I}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}g(null,w)}getPixelSize(){const{width:c,height:g}=this.atlasImage;return{width:c,height:g}}getPattern(c){const g=this.patterns[c],w=this.getImage(c);if(!w)return null;if(g&&g.position.version===w.version)return g.position;if(g)g.position.version=w.version;else{const I={w:w.data.width+2,h:w.data.height+2,x:0,y:0},k=new h.ImagePosition(I,w);this.patterns[c]={bin:I,position:k}}return this._updatePatternAtlas(),this.patterns[c].position}bind(c){const g=c.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new h.Texture(c,this.atlasImage,g.RGBA),this.atlasTexture.bind(g.LINEAR,g.CLAMP_TO_EDGE)}_updatePatternAtlas(){const c=[];for(const k in this.patterns)c.push(this.patterns[k].bin);const{w:g,h:w}=h.potpack(c),I=this.atlasImage;I.resize({width:g||1,height:w||1});for(const k in this.patterns){const{bin:P}=this.patterns[k],z=P.x+1,U=P.y+1,q=this.images[k].data,Z=q.width,ee=q.height;h.RGBAImage.copy(q,I,{x:0,y:0},{x:z,y:U},{width:Z,height:ee}),h.RGBAImage.copy(q,I,{x:0,y:ee-1},{x:z,y:U-1},{width:Z,height:1}),h.RGBAImage.copy(q,I,{x:0,y:0},{x:z,y:U+ee},{width:Z,height:1}),h.RGBAImage.copy(q,I,{x:Z-1,y:0},{x:z-1,y:U},{width:1,height:ee}),h.RGBAImage.copy(q,I,{x:0,y:0},{x:z+Z,y:U},{width:1,height:ee})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(c){for(const g of c){if(this.callbackDispatchedThisFrame[g])continue;this.callbackDispatchedThisFrame[g]=!0;const w=this.images[g];te(w)&&this.updateImage(g,w)}}}const Ie=new h.Properties({anchor:new h.DataConstantProperty(h.spec.light.anchor),position:new class{constructor(){this.specification=h.spec.light.position}possiblyEvaluate(y,c){return function([g,w,I]){const k=h.degToRad(w+90),P=h.degToRad(I);return{x:g*Math.cos(k)*Math.sin(P),y:g*Math.sin(k)*Math.sin(P),z:g*Math.cos(P),azimuthal:w,polar:I}}(y.expression.evaluate(c))}interpolate(y,c,g){return{x:h.number(y.x,c.x,g),y:h.number(y.y,c.y,g),z:h.number(y.z,c.z,g),azimuthal:h.number(y.azimuthal,c.azimuthal,g),polar:h.number(y.polar,c.polar,g)}}},color:new h.DataConstantProperty(h.spec.light.color),intensity:new h.DataConstantProperty(h.spec.light.intensity)}),Oe="-transition";class tt extends h.Evented{constructor(c){super(),this._transitionable=new h.Transitionable(Ie),this.setLight(c),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(c,g={}){if(!this._validate(h.validateLight,c,g))for(const w in c){const I=c[w];h.endsWith(w,Oe)?this._transitionable.setTransition(w.slice(0,-Oe.length),I):this._transitionable.setValue(w,I)}}updateTransitions(c){this._transitioning=this._transitionable.transitioned(c,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(c){this.properties=this._transitioning.possiblyEvaluate(c)}_validate(c,g,w){return(!w||w.validate!==!1)&&h.emitValidationErrors(this,c.call(h.validateStyle,h.extend({value:g,style:{glyphs:!0,sprite:!0},styleSpec:h.spec})))}}const it=new h.Properties({source:new h.DataConstantProperty(h.spec.terrain.source),exaggeration:new h.DataConstantProperty(h.spec.terrain.exaggeration)}),Ct="-transition";class Rt extends h.Evented{constructor(c,g){super(),this._transitionable=new h.Transitionable(it),this.set(c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=g}get(){return this._transitionable.serialize()}set(c){for(const g in c){const w=c[g];h.endsWith(g,Ct)?this._transitionable.setTransition(g.slice(0,-Ct.length),w):this._transitionable.setValue(g,w)}}updateTransitions(c){this._transitioning=this._transitionable.transitioned(c,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(c){this.properties=this._transitioning.possiblyEvaluate(c)}}function xt(y,c,g,w){const I=h.smoothstep(45,65,g),[k,P]=Vt(y,w),z=h.length(c);let U=1-Math.min(1,Math.exp((z-k)/(P-k)*-6));return U*=U*U,U=Math.min(1,1.00747*U),U*I*y.alpha}function Vt(y,c){const g=.5/Math.tan(.5*c);return[y.range[0]+g,y.range[1]+g]}const It=new h.Properties({range:new h.DataConstantProperty(h.spec.fog.range),color:new h.DataConstantProperty(h.spec.fog.color),"horizon-blend":new h.DataConstantProperty(h.spec.fog["horizon-blend"])}),Xt="-transition";class Jt extends h.Evented{constructor(c,g){super(),this._transitionable=new h.Transitionable(It),this.set(c),this._transitioning=this._transitionable.untransitioned(),this._transform=g}get state(){return{range:this.properties.get("range"),horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(c,g={}){if(!this._validate(h.validateFog,c,g))for(const w in c){const I=c[w];h.endsWith(w,Xt)?this._transitionable.setTransition(w.slice(0,-Xt.length),I):this._transitionable.setValue(w,I)}}getOpacity(c){if(!this._transform.projection.supportsFog)return 0;const g=this.properties&&this.properties.get("color")||1;return h.smoothstep(45,65,c)*g.a}getOpacityAtLatLng(c,g){return this._transform.projection.supportsFog?function(w,I,k){const P=h.MercatorCoordinate.fromLngLat(I),z=k.elevation?k.elevation.getAtPointOrZero(P):0,U=[P.x,P.y,z];return h.transformMat4(U,U,k.mercatorFogMatrix),xt(w,U,k.pitch,k._fov)}(this.state,c,g):0}getFovAdjustedRange(c){return this._transform.projection.supportsFog?Vt(this.state,c):[0,1]}updateTransitions(c){this._transitioning=this._transitionable.transitioned(c,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(c){this.properties=this._transitioning.possiblyEvaluate(c)}_validate(c,g,w){return(!w||w.validate!==!1)&&h.emitValidationErrors(this,c.call(h.validateStyle,h.extend({value:g,style:{glyphs:!0,sprite:!0},styleSpec:h.spec})))}}class nt{constructor(c,g){this.workerPool=c,this.actors=[],this.currentActor=0,this.id=h.uniqueId();const w=this.workerPool.acquire(this.id);for(let I=0;I<w.length;I++){const k=new nt.Actor(w[I],g,this.id);k.name=`Worker ${I}`,this.actors.push(k)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(c,g,w){h.asyncAll(this.actors,(I,k)=>{I.send(c,g,k)},w=w||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(c=>{c.remove()}),this.actors=[],this.workerPool.release(this.id)}}function mt(y,c,g){return c*(h.EXTENT/(y.tileSize*Math.pow(2,g-y.tileID.overscaledZ)))}nt.Actor=h.Actor;class ft{constructor(c,g,w,I){this.screenBounds=c,this.cameraPoint=g,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=w,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this.screenGeometry.map(k=>I.pointCoordinate3D(k)),this.cameraGeometry=this.bufferedCameraGeometry(0)}static createFromScreenPoints(c,g){let w,I;if(c instanceof h.pointGeometry||typeof c[0]=="number"){const k=h.pointGeometry.convert(c);w=[h.pointGeometry.convert(c)],I=g.isPointAboveHorizon(k)}else{const k=h.pointGeometry.convert(c[0]),P=h.pointGeometry.convert(c[1]);w=[k,P],I=h.polygonizeBounds(k,P).every(z=>g.isPointAboveHorizon(z))}return new ft(w,g.getCameraPoint(),I,g)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(c){return h.polygonizeBounds(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],c)}bufferedCameraGeometry(c){const g=this.screenBounds[0],w=this.screenBounds.length===1?this.screenBounds[0].add(new h.pointGeometry(1,1)):this.screenBounds[1],I=h.polygonizeBounds(g,w,0,!1);return this.cameraPoint.y>w.y&&(this.cameraPoint.x>g.x&&this.cameraPoint.x<w.x?I.splice(3,0,this.cameraPoint):this.cameraPoint.x>=w.x?I[2]=this.cameraPoint:this.cameraPoint.x<=g.x&&(I[3]=this.cameraPoint)),h.bufferConvexPolygon(I,c)}containsTile(c,g,w){const I=c.queryPadding+1,k=c.tileID.wrap,P=w?this._bufferedCameraMercator(I,g).map(ue=>h.getTilePoint(c.tileTransform,ue,k)):this._bufferedScreenMercator(I,g).map(ue=>h.getTilePoint(c.tileTransform,ue,k)),z=this.screenGeometryMercator.map(ue=>h.getTileVec3(c.tileTransform,ue,k)),U=z.map(ue=>new h.pointGeometry(ue[0],ue[1])),q=g.getFreeCameraOptions().position||new h.MercatorCoordinate(0,0,0),Z=h.getTileVec3(c.tileTransform,q,k),ee=z.map(ue=>{const oe=h.sub(ue,ue,Z);return h.normalize(oe,oe),new h.Ray(Z,oe)}),ae=mt(c,1,g.zoom);if(h.polygonIntersectsBox(P,0,0,h.EXTENT,h.EXTENT))return{queryGeometry:this,tilespaceGeometry:U,tilespaceRays:ee,bufferedTilespaceGeometry:P,bufferedTilespaceBounds:(me=h.getBounds(P),me.min.x=h.clamp(me.min.x,0,h.EXTENT),me.min.y=h.clamp(me.min.y,0,h.EXTENT),me.max.x=h.clamp(me.max.x,0,h.EXTENT),me.max.y=h.clamp(me.max.y,0,h.EXTENT),me),tile:c,tileID:c.tileID,pixelToTileUnitsFactor:ae};var me}_bufferedScreenMercator(c,g){const w=Dt(c);if(this._screenRaycastCache[w])return this._screenRaycastCache[w];{const I=this.bufferedScreenGeometry(c).map(k=>g.pointCoordinate3D(k));return this._screenRaycastCache[w]=I,I}}_bufferedCameraMercator(c,g){const w=Dt(c);if(this._cameraRaycastCache[w])return this._cameraRaycastCache[w];{const I=this.bufferedCameraGeometry(c).map(k=>g.pointCoordinate3D(k));return this._cameraRaycastCache[w]=I,I}}}function Dt(y){return 100*y|0}function qt(y,c,g){const w=function(I,k){if(I)return g(I);if(k){const P=h.pick(h.extend(k,y),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);k.vector_layers&&(P.vectorLayers=k.vector_layers,P.vectorLayerIds=P.vectorLayers.map(z=>z.id)),P.tiles=c.canonicalizeTileset(P,y.url),g(null,P)}};return y.url?h.getJSON(c.transformRequest(c.normalizeSourceURL(y.url),h.ResourceType.Source),w):h.exported.frame(()=>w(null,y))}class oi{constructor(c,g,w){this.bounds=h.LngLatBounds.convert(this.validateBounds(c)),this.minzoom=g||0,this.maxzoom=w||24}validateBounds(c){return Array.isArray(c)&&c.length===4?[Math.max(-180,c[0]),Math.max(-90,c[1]),Math.min(180,c[2]),Math.min(90,c[3])]:[-180,-90,180,90]}contains(c){const g=Math.pow(2,c.z),w=Math.floor(h.mercatorXfromLng(this.bounds.getWest())*g),I=Math.floor(h.mercatorYfromLat(this.bounds.getNorth())*g),k=Math.ceil(h.mercatorXfromLng(this.bounds.getEast())*g),P=Math.ceil(h.mercatorYfromLat(this.bounds.getSouth())*g);return c.x>=w&&c.x<k&&c.y>=I&&c.y<P}}class ti{constructor(c,g,w){this.context=c;const I=c.gl;this.buffer=I.createBuffer(),this.dynamicDraw=Boolean(w),this.context.unbindVAO(),c.bindElementBuffer.set(this.buffer),I.bufferData(I.ELEMENT_ARRAY_BUFFER,g.arrayBuffer,this.dynamicDraw?I.DYNAMIC_DRAW:I.STATIC_DRAW),this.dynamicDraw||g.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(c){const g=this.context.gl;this.context.unbindVAO(),this.bind(),g.bufferSubData(g.ELEMENT_ARRAY_BUFFER,0,c.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const fi={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class si{constructor(c,g,w,I){this.length=g.length,this.attributes=w,this.itemSize=g.bytesPerElement,this.dynamicDraw=I,this.context=c;const k=c.gl;this.buffer=k.createBuffer(),c.bindVertexBuffer.set(this.buffer),k.bufferData(k.ARRAY_BUFFER,g.arrayBuffer,this.dynamicDraw?k.DYNAMIC_DRAW:k.STATIC_DRAW),this.dynamicDraw||g.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(c){const g=this.context.gl;this.bind(),g.bufferSubData(g.ARRAY_BUFFER,0,c.arrayBuffer)}enableAttributes(c,g){for(let w=0;w<this.attributes.length;w++){const I=g.attributes[this.attributes[w].name];I!==void 0&&c.enableVertexAttribArray(I)}}setVertexAttribPointers(c,g,w){for(let I=0;I<this.attributes.length;I++){const k=this.attributes[I],P=g.attributes[k.name];P!==void 0&&c.vertexAttribPointer(P,k.components,c[fi[k.type]],!1,this.itemSize,k.offset+this.itemSize*(w||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Ot{constructor(c){this.gl=c.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(c){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ai extends Ot{getDefault(){return h.Color.transparent}set(c){const g=this.current;(c.r!==g.r||c.g!==g.g||c.b!==g.b||c.a!==g.a||this.dirty)&&(this.gl.clearColor(c.r,c.g,c.b,c.a),this.current=c,this.dirty=!1)}}class Nt extends Ot{getDefault(){return 1}set(c){(c!==this.current||this.dirty)&&(this.gl.clearDepth(c),this.current=c,this.dirty=!1)}}class dt extends Ot{getDefault(){return 0}set(c){(c!==this.current||this.dirty)&&(this.gl.clearStencil(c),this.current=c,this.dirty=!1)}}class gi extends Ot{getDefault(){return[!0,!0,!0,!0]}set(c){const g=this.current;(c[0]!==g[0]||c[1]!==g[1]||c[2]!==g[2]||c[3]!==g[3]||this.dirty)&&(this.gl.colorMask(c[0],c[1],c[2],c[3]),this.current=c,this.dirty=!1)}}class Et extends Ot{getDefault(){return!0}set(c){(c!==this.current||this.dirty)&&(this.gl.depthMask(c),this.current=c,this.dirty=!1)}}class je extends Ot{getDefault(){return 255}set(c){(c!==this.current||this.dirty)&&(this.gl.stencilMask(c),this.current=c,this.dirty=!1)}}class jt extends Ot{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(c){const g=this.current;(c.func!==g.func||c.ref!==g.ref||c.mask!==g.mask||this.dirty)&&(this.gl.stencilFunc(c.func,c.ref,c.mask),this.current=c,this.dirty=!1)}}class Wt extends Ot{getDefault(){const c=this.gl;return[c.KEEP,c.KEEP,c.KEEP]}set(c){const g=this.current;(c[0]!==g[0]||c[1]!==g[1]||c[2]!==g[2]||this.dirty)&&(this.gl.stencilOp(c[0],c[1],c[2]),this.current=c,this.dirty=!1)}}class Qt extends Ot{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;c?g.enable(g.STENCIL_TEST):g.disable(g.STENCIL_TEST),this.current=c,this.dirty=!1}}class ni extends Ot{getDefault(){return[0,1]}set(c){const g=this.current;(c[0]!==g[0]||c[1]!==g[1]||this.dirty)&&(this.gl.depthRange(c[0],c[1]),this.current=c,this.dirty=!1)}}class gt extends Ot{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;c?g.enable(g.DEPTH_TEST):g.disable(g.DEPTH_TEST),this.current=c,this.dirty=!1}}class Ai extends Ot{getDefault(){return this.gl.LESS}set(c){(c!==this.current||this.dirty)&&(this.gl.depthFunc(c),this.current=c,this.dirty=!1)}}class ci extends Ot{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;c?g.enable(g.BLEND):g.disable(g.BLEND),this.current=c,this.dirty=!1}}class Lt extends Ot{getDefault(){const c=this.gl;return[c.ONE,c.ZERO]}set(c){const g=this.current;(c[0]!==g[0]||c[1]!==g[1]||this.dirty)&&(this.gl.blendFunc(c[0],c[1]),this.current=c,this.dirty=!1)}}class $t extends Ot{getDefault(){return h.Color.transparent}set(c){const g=this.current;(c.r!==g.r||c.g!==g.g||c.b!==g.b||c.a!==g.a||this.dirty)&&(this.gl.blendColor(c.r,c.g,c.b,c.a),this.current=c,this.dirty=!1)}}class _t extends Ot{getDefault(){return this.gl.FUNC_ADD}set(c){(c!==this.current||this.dirty)&&(this.gl.blendEquation(c),this.current=c,this.dirty=!1)}}class hi extends Ot{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;c?g.enable(g.CULL_FACE):g.disable(g.CULL_FACE),this.current=c,this.dirty=!1}}class _i extends Ot{getDefault(){return this.gl.BACK}set(c){(c!==this.current||this.dirty)&&(this.gl.cullFace(c),this.current=c,this.dirty=!1)}}class wi extends Ot{getDefault(){return this.gl.CCW}set(c){(c!==this.current||this.dirty)&&(this.gl.frontFace(c),this.current=c,this.dirty=!1)}}class Ht extends Ot{getDefault(){return null}set(c){(c!==this.current||this.dirty)&&(this.gl.useProgram(c),this.current=c,this.dirty=!1)}}class ui extends Ot{getDefault(){return this.gl.TEXTURE0}set(c){(c!==this.current||this.dirty)&&(this.gl.activeTexture(c),this.current=c,this.dirty=!1)}}class Li extends Ot{getDefault(){const c=this.gl;return[0,0,c.drawingBufferWidth,c.drawingBufferHeight]}set(c){const g=this.current;(c[0]!==g[0]||c[1]!==g[1]||c[2]!==g[2]||c[3]!==g[3]||this.dirty)&&(this.gl.viewport(c[0],c[1],c[2],c[3]),this.current=c,this.dirty=!1)}}class zi extends Ot{getDefault(){return null}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;g.bindFramebuffer(g.FRAMEBUFFER,c),this.current=c,this.dirty=!1}}class Fi extends Ot{getDefault(){return null}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;g.bindRenderbuffer(g.RENDERBUFFER,c),this.current=c,this.dirty=!1}}class tr extends Ot{getDefault(){return null}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;g.bindTexture(g.TEXTURE_2D,c),this.current=c,this.dirty=!1}}class Br extends Ot{getDefault(){return null}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;g.bindBuffer(g.ARRAY_BUFFER,c),this.current=c,this.dirty=!1}}class Rr extends Ot{getDefault(){return null}set(c){const g=this.gl;g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,c),this.current=c,this.dirty=!1}}class Er extends Ot{constructor(c){super(c),this.vao=c.extVertexArrayObject}getDefault(){return null}set(c){this.vao&&(c!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(c),this.current=c,this.dirty=!1)}}class er extends Ot{getDefault(){return 4}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;g.pixelStorei(g.UNPACK_ALIGNMENT,c),this.current=c,this.dirty=!1}}class ur extends Ot{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;g.pixelStorei(g.UNPACK_PREMULTIPLY_ALPHA_WEBGL,c),this.current=c,this.dirty=!1}}class mr extends Ot{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const g=this.gl;g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,c),this.current=c,this.dirty=!1}}class yr extends Ot{constructor(c,g){super(c),this.context=c,this.parent=g}getDefault(){return null}}class Sr extends yr{setDirty(){this.dirty=!0}set(c){if(c===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const g=this.gl;g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,c,0),this.current=c,this.dirty=!1}}class Lr extends yr{attachment(){return this.gl.DEPTH_ATTACHMENT}set(c){if(c===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const g=this.gl;g.framebufferRenderbuffer(g.FRAMEBUFFER,this.attachment(),g.RENDERBUFFER,c),this.current=c,this.dirty=!1}}class _e extends Lr{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class J{constructor(c,g,w,I){this.context=c,this.width=g,this.height=w;const k=this.framebuffer=c.gl.createFramebuffer();this.colorAttachment=new Sr(c,k),I&&(this.depthAttachment=new Lr(c,k))}destroy(){const c=this.context.gl,g=this.colorAttachment.get();if(g&&c.deleteTexture(g),this.depthAttachment){const w=this.depthAttachment.get();w&&c.deleteRenderbuffer(w)}c.deleteFramebuffer(this.framebuffer)}}class j{constructor(c){this.gl=c,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new ai(this),this.clearDepth=new Nt(this),this.clearStencil=new dt(this),this.colorMask=new gi(this),this.depthMask=new Et(this),this.stencilMask=new je(this),this.stencilFunc=new jt(this),this.stencilOp=new Wt(this),this.stencilTest=new Qt(this),this.depthRange=new ni(this),this.depthTest=new gt(this),this.depthFunc=new Ai(this),this.blend=new ci(this),this.blendFunc=new Lt(this),this.blendColor=new $t(this),this.blendEquation=new _t(this),this.cullFace=new hi(this),this.cullFaceSide=new _i(this),this.frontFace=new wi(this),this.program=new Ht(this),this.activeTexture=new ui(this),this.viewport=new Li(this),this.bindFramebuffer=new zi(this),this.bindRenderbuffer=new Fi(this),this.bindTexture=new tr(this),this.bindVertexBuffer=new Br(this),this.bindElementBuffer=new Rr(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new Er(this),this.pixelStoreUnpack=new er(this),this.pixelStoreUnpackPremultiplyAlpha=new ur(this),this.pixelStoreUnpackFlipY=new mr(this),this.extTextureFilterAnisotropic=c.getExtension("EXT_texture_filter_anisotropic")||c.getExtension("MOZ_EXT_texture_filter_anisotropic")||c.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=c.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extTextureHalfFloat=c.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(c.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=c.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=c.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=c.getParameter(c.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(c,g){return new ti(this,c,g)}createVertexBuffer(c,g,w){return new si(this,c,g,w)}createRenderbuffer(c,g,w){const I=this.gl,k=I.createRenderbuffer();return this.bindRenderbuffer.set(k),I.renderbufferStorage(I.RENDERBUFFER,c,g,w),this.bindRenderbuffer.set(null),k}createFramebuffer(c,g,w){return new J(this,c,g,w)}clear({color:c,depth:g,stencil:w}){const I=this.gl;let k=0;c&&(k|=I.COLOR_BUFFER_BIT,this.clearColor.set(c),this.colorMask.set([!0,!0,!0,!0])),g!==void 0&&(k|=I.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(g),this.depthMask.set(!0)),w!==void 0&&(k|=I.STENCIL_BUFFER_BIT,this.clearStencil.set(w),this.stencilMask.set(255)),I.clear(k)}setCullFace(c){c.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(c.mode),this.frontFace.set(c.frontFace))}setDepthMode(c){c.func!==this.gl.ALWAYS||c.mask?(this.depthTest.set(!0),this.depthFunc.set(c.func),this.depthMask.set(c.mask),this.depthRange.set(c.range)):this.depthTest.set(!1)}setStencilMode(c){c.test.func!==this.gl.ALWAYS||c.mask?(this.stencilTest.set(!0),this.stencilMask.set(c.mask),this.stencilOp.set([c.fail,c.depthFail,c.pass]),this.stencilFunc.set({func:c.test.func,ref:c.ref,mask:c.test.mask})):this.stencilTest.set(!1)}setColorMode(c){L(c.blendFunction,h.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(c.blendFunction),this.blendColor.set(c.blendColor)),this.colorMask.set(c.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class Y extends h.Evented{constructor(c,g,w,I){super(),this.id=c,this.dispatcher=w,this.setEventedParent(I),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=h.extend({type:"raster"},g),h.extend(this,h.pick(g,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new h.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=qt(this._options,this.map._requestManager,(c,g)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new h.ErrorEvent(c)):g&&(h.extend(this,g),g.bounds&&(this.tileBounds=new oi(g.bounds,this.minzoom,this.maxzoom)),h.postTurnstileEvent(g.tiles),this.fire(new h.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new h.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(c){this.map=c,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return h.extend({},this._options)}hasTile(c){return!this.tileBounds||this.tileBounds.contains(c.canonical)}loadTile(c,g){const w=h.exported.devicePixelRatio>=2,I=this.map._requestManager.normalizeTileURL(c.tileID.canonical.url(this.tiles,this.scheme),w,this.tileSize);c.request=h.getImage(this.map._requestManager.transformRequest(I,h.ResourceType.Tile),(k,P,z,U)=>(delete c.request,c.aborted?(c.state="unloaded",g(null)):k?(c.state="errored",g(k)):P?(this.map._refreshExpiredTiles&&c.setExpiryData({cacheControl:z,expires:U}),c.setTexture(P,this.map.painter),c.state="loaded",h.cacheEntryPossiblyAdded(this.dispatcher),void g(null)):g(null)))}static loadTileData(c,g,w){c.setTexture(g,w)}static unloadTileData(c,g){c.texture&&g.saveTileTexture(c.texture)}abortTile(c,g){c.request&&(c.request.cancel(),delete c.request),g()}unloadTile(c,g){c.texture&&this.map.painter.saveTileTexture(c.texture),g()}hasTransition(){return!1}}let le;function pe(y,c,g,w,I,k,P,z){const U=[y,g,I,c,w,k,1,1,1],q=[P,z,1],Z=h.adjoint([],U),[ee,ae,me]=h.transformMat3(q,q,h.transpose(Z,Z));return h.multiply(U,[ee,0,0,0,ae,0,0,0,me],U)}class Ce extends h.Evented{constructor(c,g,w,I){super(),this.id=c,this.dispatcher=w,this.coordinates=g.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(I),this.options=g}load(c){this._loaded=!1,this.fire(new h.Event("dataloading",{dataType:"source"})),this.url=this.options.url,h.getImage(this.map._requestManager.transformRequest(this.url,h.ResourceType.Image),(g,w)=>{if(this._loaded=!0,g)this.fire(new h.ErrorEvent(g));else if(w){const{HTMLImageElement:I}=h.window;this.image=w instanceof I?h.exported.getImageData(w):w,this.width=this.image.width,this.height=this.image.height,c&&(this.coordinates=c),this._finishLoading()}})}loaded(){return this._loaded}updateImage(c){return this.image&&c.url?(this.options.url=c.url,this.load(c.coordinates),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new h.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(c){this.map=c,this.load()}onRemove(){this.texture&&this.texture.destroy()}setCoordinates(c){this.coordinates=c,this._boundsArray=void 0;const g=c.map(h.MercatorCoordinate.fromLngLat);return this.tileID=function(w){let I=1/0,k=1/0,P=-1/0,z=-1/0;for(const ee of w)I=Math.min(I,ee.x),k=Math.min(k,ee.y),P=Math.max(P,ee.x),z=Math.max(z,ee.y);const U=Math.max(P-I,z-k),q=Math.max(0,Math.floor(-Math.log(U)/Math.LN2)),Z=Math.pow(2,q);return new h.CanonicalTileID(q,Math.floor((I+P)/2*Z),Math.floor((k+z)/2*Z))}(g),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new h.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(c){for(const U in this.tiles){const q=this.tiles[U];q.state!=="loaded"&&(q.state="loaded",q.texture=this.texture)}if(this._boundsArray)return;const g=h.tileTransform(this.tileID,this.map.transform.projection),[w,I,k,P]=this.coordinates.map(U=>{const q=g.projection.project(U[0],U[1]);return h.getTilePoint(g,q)._round()});this.perspectiveTransform=function(U,q,Z,ee,ae,me,ue,oe,Me,ye){const Ee=pe(0,0,U,0,0,q,U,q),Te=pe(Z,ee,ae,me,ue,oe,Me,ye);return h.multiply(Te,h.adjoint(Ee,Ee),Te),[Te[6]/Te[8]*U/h.EXTENT,Te[7]/Te[8]*q/h.EXTENT]}(this.width,this.height,w.x,w.y,I.x,I.y,P.x,P.y,k.x,k.y);const z=this._boundsArray=new h.StructArrayLayout4i8;z.emplaceBack(w.x,w.y,0,0),z.emplaceBack(I.x,I.y,h.EXTENT,0),z.emplaceBack(P.x,P.y,0,h.EXTENT),z.emplaceBack(k.x,k.y,h.EXTENT,h.EXTENT),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=c.createVertexBuffer(z,h.boundsAttributes.members),this.boundsSegments=h.SegmentVector.simpleSegment(0,0,4,2)}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const c=this.map.painter.context,g=c.gl;this.texture?this.texture.update(this.image):(this.texture=new h.Texture(c,this.image,g.RGBA),this.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE)),this._prepareData(c)}loadTile(c,g){this.tileID&&this.tileID.equals(c.tileID.canonical)?(this.tiles[String(c.tileID.wrap)]=c,c.buckets={},g(null)):(c.state="errored",g(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const Be={vector:class extends h.Evented{constructor(y,c,g,w){if(super(),this.id=y,this.dispatcher=g,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,h.extend(this,h.pick(c,["url","scheme","tileSize","promoteId"])),this._options=h.extend({type:"vector"},c),this._collectResourceTiming=c.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(w),this._tileWorkers={},this._deduped=new h.DedupedRequest}load(){this._loaded=!1,this.fire(new h.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=qt(this._options,this.map._requestManager,(y,c)=>{this._tileJSONRequest=null,this._loaded=!0,y?this.fire(new h.ErrorEvent(y)):c&&(h.extend(this,c),c.bounds&&(this.tileBounds=new oi(c.bounds,this.minzoom,this.maxzoom)),h.postTurnstileEvent(c.tiles,this.map._requestManager._customAccessToken),this.fire(new h.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new h.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}hasTile(y){return!this.tileBounds||this.tileBounds.contains(y.canonical)}onAdd(y){this.map=y,this.load()}setSourceProperty(y){this._tileJSONRequest&&this._tileJSONRequest.cancel(),y();const c=this.map.style._getSourceCaches(this.id);for(const g of c)g.clearTiles();this.load()}setTiles(y){return this.setSourceProperty(()=>{this._options.tiles=y}),this}setUrl(y){return this.setSourceProperty(()=>{this.url=y,this._options.url=y}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return h.extend({},this._options)}loadTile(y,c){const g=this.map._requestManager.normalizeTileURL(y.tileID.canonical.url(this.tiles,this.scheme)),w={request:this.map._requestManager.transformRequest(g,h.ResourceType.Tile),data:void 0,uid:y.uid,tileID:y.tileID,tileZoom:y.tileZoom,zoom:y.tileID.overscaledZ,tileSize:this.tileSize*y.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:h.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:y.isSymbolTile};if(w.request.collectResourceTiming=this._collectResourceTiming,y.actor&&y.state!=="expired")y.state==="loading"?y.reloadCallback=c:y.request=y.actor.send("reloadTile",w,I.bind(this));else if(y.actor=this._tileWorkers[g]=this._tileWorkers[g]||this.dispatcher.getActor(),this.dispatcher.ready)y.request=y.actor.send("loadTile",w,I.bind(this),void 0,!0);else{const k=h.loadVectorTile.call({deduped:this._deduped},w,(P,z)=>{P||!z?I.call(this,P):(w.data={cacheControl:z.cacheControl,expires:z.expires,rawData:z.rawData.slice(0)},y.actor&&y.actor.send("loadTile",w,I.bind(this),void 0,!0))},!0);y.request={cancel:k}}function I(k,P){return delete y.request,y.aborted?c(null):k&&k.status!==404?c(k):(P&&P.resourceTiming&&(y.resourceTiming=P.resourceTiming),this.map._refreshExpiredTiles&&P&&y.setExpiryData(P),y.loadVectorData(P,this.map.painter),h.cacheEntryPossiblyAdded(this.dispatcher),c(null),void(y.reloadCallback&&(this.loadTile(y,y.reloadCallback),y.reloadCallback=null)))}}abortTile(y){y.request&&(y.request.cancel(),delete y.request),y.actor&&y.actor.send("abortTile",{uid:y.uid,type:this.type,source:this.id})}unloadTile(y){y.unloadVectorData(),y.actor&&y.actor.send("removeTile",{uid:y.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}},raster:Y,"raster-dem":class extends Y{constructor(y,c,g,w){super(y,c,g,w),this.type="raster-dem",this.maxzoom=22,this._options=h.extend({type:"raster-dem"},c),this.encoding=c.encoding||"mapbox"}loadTile(y,c){const g=this.map._requestManager.normalizeTileURL(y.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function w(I,k){I&&(y.state="errored",c(I)),k&&(y.dem=k,y.dem.onDeserialize(),y.needsHillshadePrepare=!0,y.needsDEMTextureUpload=!0,y.state="loaded",c(null))}y.request=h.getImage(this.map._requestManager.transformRequest(g,h.ResourceType.Tile),function(I,k,P,z){if(delete y.request,y.aborted)y.state="unloaded",c(null);else if(I)y.state="errored",c(I);else if(k){this.map._refreshExpiredTiles&&y.setExpiryData({cacheControl:P,expires:z});const U=h.window.ImageBitmap&&k instanceof h.window.ImageBitmap&&(le==null&&(le=h.window.OffscreenCanvas&&new h.window.OffscreenCanvas(1,1).getContext("2d")&&typeof h.window.createImageBitmap=="function"),le),q=1-(k.width-h.prevPowerOfTwo(k.width))/2;q<1||y.neighboringTiles||(y.neighboringTiles=this._getNeighboringTiles(y.tileID));const Z=U?k:h.exported.getImageData(k,q),ee={uid:y.uid,coord:y.tileID,source:this.id,rawImageData:Z,encoding:this.encoding,padding:q};y.actor&&y.state!=="expired"||(y.actor=this.dispatcher.getActor(),y.actor.send("loadDEMTile",ee,w.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(y){const c=y.canonical,g=Math.pow(2,c.z),w=(c.x-1+g)%g,I=c.x===0?y.wrap-1:y.wrap,k=(c.x+1+g)%g,P=c.x+1===g?y.wrap+1:y.wrap,z={};return z[new h.OverscaledTileID(y.overscaledZ,I,c.z,w,c.y).key]={backfilled:!1},z[new h.OverscaledTileID(y.overscaledZ,P,c.z,k,c.y).key]={backfilled:!1},c.y>0&&(z[new h.OverscaledTileID(y.overscaledZ,I,c.z,w,c.y-1).key]={backfilled:!1},z[new h.OverscaledTileID(y.overscaledZ,y.wrap,c.z,c.x,c.y-1).key]={backfilled:!1},z[new h.OverscaledTileID(y.overscaledZ,P,c.z,k,c.y-1).key]={backfilled:!1}),c.y+1<g&&(z[new h.OverscaledTileID(y.overscaledZ,I,c.z,w,c.y+1).key]={backfilled:!1},z[new h.OverscaledTileID(y.overscaledZ,y.wrap,c.z,c.x,c.y+1).key]={backfilled:!1},z[new h.OverscaledTileID(y.overscaledZ,P,c.z,k,c.y+1).key]={backfilled:!1}),z}unloadTile(y){y.demTexture&&this.map.painter.saveTileTexture(y.demTexture),y.fbo&&(y.fbo.destroy(),delete y.fbo),y.dem&&delete y.dem,delete y.neighboringTiles,y.state="unloaded"}},geojson:class extends h.Evented{constructor(y,c,g,w){super(),this.id=y,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=g.getActor(),this.setEventedParent(w),this._data=c.data,this._options=h.extend({},c),this._collectResourceTiming=c.collectResourceTiming,c.maxzoom!==void 0&&(this.maxzoom=c.maxzoom),c.type&&(this.type=c.type),c.attribution&&(this.attribution=c.attribution),this.promoteId=c.promoteId;const I=h.EXTENT/this.tileSize;this.workerOptions=h.extend({source:this.id,cluster:c.cluster||!1,geojsonVtOptions:{buffer:(c.buffer!==void 0?c.buffer:128)*I,tolerance:(c.tolerance!==void 0?c.tolerance:.375)*I,extent:h.EXTENT,maxZoom:this.maxzoom,lineMetrics:c.lineMetrics||!1,generateId:c.generateId||!1},superclusterOptions:{maxZoom:c.clusterMaxZoom!==void 0?c.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,c.clusterMinPoints||2),extent:h.EXTENT,radius:(c.clusterRadius!==void 0?c.clusterRadius:50)*I,log:!1,generateId:c.generateId||!1},clusterProperties:c.clusterProperties,filter:c.filter},c.workerOptions)}onAdd(y){this.map=y,this.setData(this._data)}setData(y){return this._data=y,this._updateWorkerData(),this}getClusterExpansionZoom(y,c){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:y,source:this.id},c),this}getClusterChildren(y,c){return this.actor.send("geojson.getClusterChildren",{clusterId:y,source:this.id},c),this}getClusterLeaves(y,c,g,w){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:y,limit:c,offset:g},w),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new h.Event("dataloading",{dataType:"source"})),this._loaded=!1;const y=h.extend({},this.workerOptions),c=this._data;typeof c=="string"?(y.request=this.map._requestManager.transformRequest(h.exported.resolveURL(c),h.ResourceType.Source),y.request.collectResourceTiming=this._collectResourceTiming):y.data=JSON.stringify(c),this._pendingLoad=this.actor.send(`${this.type}.loadData`,y,(g,w)=>{if(this._loaded=!0,this._pendingLoad=null,g)this.fire(new h.ErrorEvent(g));else{const I={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&w&&w.resourceTiming&&w.resourceTiming[this.id]&&(I.resourceTiming=w.resourceTiming[this.id]),this.fire(new h.Event("data",I)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(y,c){const g=y.actor?"reloadTile":"loadTile";y.actor=this.actor,y.request=this.actor.send(g,{type:this.type,uid:y.uid,tileID:y.tileID,tileZoom:y.tileZoom,zoom:y.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:h.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(w,I)=>(delete y.request,y.unloadVectorData(),y.aborted?c(null):w?c(w):(y.loadVectorData(I,this.map.painter,g==="reloadTile"),c(null))),void 0,g==="loadTile")}abortTile(y){y.request&&(y.request.cancel(),delete y.request),y.aborted=!0}unloadTile(y){y.unloadVectorData(),this.actor.send("removeTile",{uid:y.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return h.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Ce{constructor(y,c,g,w){super(y,c,g,w),this.roundZoom=!0,this.type="video",this.options=c}load(){this._loaded=!1;const y=this.options;this.urls=[];for(const c of y.urls)this.urls.push(this.map._requestManager.transformRequest(c,h.ResourceType.Source).url);h.getVideo(this.urls,(c,g)=>{this._loaded=!0,c?this.fire(new h.ErrorEvent(c)):g&&(this.video=g,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(y){if(this.video){const c=this.video.seekable;y<c.start(0)||y>c.end(0)?this.fire(new h.ErrorEvent(new h.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${c.start(0)} and ${c.end(0)}-second mark.`))):this.video.currentTime=y}}getVideo(){return this.video}onAdd(y){this.map||(this.map=y,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const y=this.map.painter.context,c=y.gl;this.texture?this.video.paused||(this.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE),c.texSubImage2D(c.TEXTURE_2D,0,0,0,c.RGBA,c.UNSIGNED_BYTE,this.video)):(this.texture=new h.Texture(y,this.video,c.RGBA),this.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(y)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Ce,canvas:class extends Ce{constructor(y,c,g,w){super(y,c,g,w),c.coordinates?Array.isArray(c.coordinates)&&c.coordinates.length===4&&!c.coordinates.some(I=>!Array.isArray(I)||I.length!==2||I.some(k=>typeof k!="number"))||this.fire(new h.ErrorEvent(new h.ValidationError(`sources.${y}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new h.ErrorEvent(new h.ValidationError(`sources.${y}`,null,'missing required property "coordinates"'))),c.animate&&typeof c.animate!="boolean"&&this.fire(new h.ErrorEvent(new h.ValidationError(`sources.${y}`,null,'optional "animate" property must be a boolean value'))),c.canvas?typeof c.canvas=="string"||c.canvas instanceof h.window.HTMLCanvasElement||this.fire(new h.ErrorEvent(new h.ValidationError(`sources.${y}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new h.ErrorEvent(new h.ValidationError(`sources.${y}`,null,'missing required property "canvas"'))),this.options=c,this.animate=c.animate===void 0||c.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof h.window.HTMLCanvasElement?this.options.canvas:h.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new h.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(y){this.map=y,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let y=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,y=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,y=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const c=this.map.painter.context;this.texture?(y||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new h.Texture(c,this.canvas,c.gl.RGBA,{premultiply:!0}),this._prepareData(c)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const y of[this.canvas.width,this.canvas.height])if(isNaN(y)||y<=0)return!0;return!1}},custom:class extends h.Evented{constructor(y,c,g,w){super(),this.id=y,this.type="custom",this._dataType="raster",this._dispatcher=g,this._implementation=c,this.setEventedParent(w),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new h.ErrorEvent(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new h.ErrorEvent(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new oi(this._implementation.bounds,this.minzoom,this.maxzoom)),c.update=this._update.bind(this),c.coveringTiles=this._coveringTiles.bind(this),h.extend(this,h.pick(c,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return h.pick(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new h.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new h.Event("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(y){this._map=y,this._loaded=!1,this.fire(new h.Event("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(y),this.load()}onRemove(y){this._implementation.onRemove&&this._implementation.onRemove(y)}hasTile(y){if(this._implementation.hasTile){const{x:c,y:g,z:w}=y.canonical;return this._implementation.hasTile({x:c,y:g,z:w})}return!this.tileBounds||this.tileBounds.contains(y.canonical)}loadTile(y,c){const{x:g,y:w,z:I}=y.tileID.canonical,k=new h.window.AbortController,P=this._implementation.loadTile({x:g,y:w,z:I},{signal:k.signal});if(!P)return this.loadTileData(y,{width:this.tileSize,height:this.tileSize,data:null}),y.state="loaded",c(null);P.cancel=()=>k.abort(),y.request=P.then(function(z){return delete y.request,y.aborted?(y.state="unloaded",c(null)):z?function(U){return U instanceof h.window.ImageData||U instanceof h.window.ImageBitmap||U instanceof h.window.HTMLCanvasElement}(z)?(this.loadTileData(y,z),y.state="loaded",void c(null)):(y.state="errored",c(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`))):(this.loadTileData(y,{width:this.tileSize,height:this.tileSize,data:null}),y.state="loaded",c(null))}.bind(this)).catch(z=>{z.code!==20&&(y.state="errored",c(z))})}loadTileData(y,c){Y.loadTileData(y,c,this._map.painter)}unloadTileData(y){Y.unloadTileData(y,this._map.painter)}prepareTile(y){if(!this._implementation.prepareTile)return null;const{x:c,y:g,z:w}=y.tileID.canonical,I=this._implementation.prepareTile({x:c,y:g,z:w});return I?(this.loadTileData(y,I),y.state="loaded",I):null}unloadTile(y,c){if(this.unloadTileData(y),this._implementation.unloadTile){const{x:g,y:w,z:I}=y.tileID.canonical;this._implementation.unloadTile({x:g,y:w,z:I})}c()}abortTile(y,c){y.request&&y.request.cancel&&(y.request.cancel(),delete y.request),c()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(y=>({x:y.canonical.x,y:y.canonical.y,z:y.canonical.z}))}_update(){this.fire(new h.Event("data",{dataType:"source",sourceDataType:"content"}))}}},Le=function(y,c,g,w){const I=new Be[c.type](y,c,g,w);if(I.id!==y)throw new Error(`Expected Source id to be ${y} instead of ${I.id}`);return h.bindAll(["load","abort","unload","serialize","prepare"],I),I};function De(y,c){const g=h.identity([]);return h.scale(g,g,[.5*y.width,.5*-y.height,1]),h.translate(g,g,[1,-1,0]),h.multiply$1(g,g,y.calculateProjMatrix(c.toUnwrapped())),Float32Array.from(g)}function Ve(y,c,g,w,I,k,P,z=!1){const U=y.tilesIn(w,P,z);U.sort(ct);const q=[];for(const ee of U)q.push({wrappedTileID:ee.tile.tileID.wrapped().key,queryResults:ee.tile.queryRenderedFeatures(c,g,y._state,ee,I,k,De(y.transform,ee.tile.tileID),z)});const Z=function(ee){const ae={},me={};for(const ue of ee){const oe=ue.queryResults,Me=ue.wrappedTileID,ye=me[Me]=me[Me]||{};for(const Ee in oe){const Te=oe[Ee],Se=ye[Ee]=ye[Ee]||{},we=ae[Ee]=ae[Ee]||[];for(const ke of Te)Se[ke.featureIndex]||(Se[ke.featureIndex]=!0,we.push(ke))}}return ae}(q);for(const ee in Z)Z[ee].forEach(ae=>{const me=ae.feature,ue=me.layer;ue&&ue.type!=="background"&&ue.type!=="sky"&&(me.source=ue.source,ue["source-layer"]&&(me.sourceLayer=ue["source-layer"]),me.state=me.id!==void 0?y.getFeatureState(ue["source-layer"],me.id):{})});return Z}function Ke(y,c){const g=y.getRenderableIds().map(k=>y.getTileByID(k)),w=[],I={};for(let k=0;k<g.length;k++){const P=g[k],z=P.tileID.canonical.key;I[z]||(I[z]=!0,P.querySourceFeatures(w,c))}return w}function ct(y,c){const g=y.tileID,w=c.tileID;return g.overscaledZ-w.overscaledZ||g.canonical.y-w.canonical.y||g.wrap-w.wrap||g.canonical.x-w.canonical.x}function Qe(){return Eo.workerClass!=null?new Eo.workerClass:new h.window.Worker(Eo.workerUrl)}const Pt="mapboxgl_preloaded_worker_pool";class bt{constructor(){this.active={}}acquire(c){if(!this.workers)for(this.workers=[];this.workers.length<bt.workerCount;)this.workers.push(new Qe);return this.active[c]=!0,this.workers.slice()}release(c){delete this.active[c],this.numActive()===0&&(this.workers.forEach(g=>{g.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Pt]}numActive(){return Object.keys(this.active).length}}let Bt;function Yt(){return Bt||(Bt=new bt),Bt}function Ne(y,c){const g={};for(const w in y)w!=="ref"&&(g[w]=y[w]);return h.refProperties.forEach(w=>{w in c&&(g[w]=c[w])}),g}function Ei(y){y=y.slice();const c=Object.create(null);for(let g=0;g<y.length;g++)c[y[g].id]=y[g];for(let g=0;g<y.length;g++)"ref"in y[g]&&(y[g]=Ne(y[g],c[y[g].ref]));return y}bt.workerCount=2;const Mt={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function Si(y,c,g){g.push({command:Mt.addSource,args:[y,c[y]]})}function Ii(y,c,g){c.push({command:Mt.removeSource,args:[y]}),g[y]=!0}function Zr(y,c,g,w){Ii(y,g,w),Si(y,c,g)}function _n(y,c,g){let w;for(w in y[g])if(y[g].hasOwnProperty(w)&&w!=="data"&&!L(y[g][w],c[g][w]))return!1;for(w in c[g])if(c[g].hasOwnProperty(w)&&w!=="data"&&!L(y[g][w],c[g][w]))return!1;return!0}function yt(y,c,g,w,I,k){let P;for(P in c=c||{},y=y||{})y.hasOwnProperty(P)&&(L(y[P],c[P])||g.push({command:k,args:[w,P,c[P],I]}));for(P in c)c.hasOwnProperty(P)&&!y.hasOwnProperty(P)&&(L(y[P],c[P])||g.push({command:k,args:[w,P,c[P],I]}))}function Ti(y){return y.id}function yi(y,c){return y[c.id]=c,y}class dn{constructor(c,g){this.reset(c,g)}reset(c,g){this.points=c||[],this._distances=[0];for(let w=1;w<this.points.length;w++)this._distances[w]=this._distances[w-1]+this.points[w].dist(this.points[w-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(g||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(c){if(this.points.length===1)return this.points[0];c=h.clamp(c,0,1);let g=1,w=this._distances[g];const I=c*this.paddedLength+this.padding;for(;w<I&&g<this._distances.length;)w=this._distances[++g];const k=g-1,P=this._distances[k],z=w-P,U=z>0?(I-P)/z:0;return this.points[k].mult(1-U).add(this.points[g].mult(U))}}class Zn{constructor(c,g,w){const I=this.boxCells=[],k=this.circleCells=[];this.xCellCount=Math.ceil(c/w),this.yCellCount=Math.ceil(g/w);for(let P=0;P<this.xCellCount*this.yCellCount;P++)I.push([]),k.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=c,this.height=g,this.xScale=this.xCellCount/c,this.yScale=this.yCellCount/g,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(c,g,w,I,k){this._forEachCell(g,w,I,k,this._insertBoxCell,this.boxUid++),this.boxKeys.push(c),this.bboxes.push(g),this.bboxes.push(w),this.bboxes.push(I),this.bboxes.push(k)}insertCircle(c,g,w,I){this._forEachCell(g-I,w-I,g+I,w+I,this._insertCircleCell,this.circleUid++),this.circleKeys.push(c),this.circles.push(g),this.circles.push(w),this.circles.push(I)}_insertBoxCell(c,g,w,I,k,P){this.boxCells[k].push(P)}_insertCircleCell(c,g,w,I,k,P){this.circleCells[k].push(P)}_query(c,g,w,I,k,P){if(w<0||c>this.width||I<0||g>this.height)return!k&&[];const z=[];if(c<=0&&g<=0&&this.width<=w&&this.height<=I){if(k)return!0;for(let U=0;U<this.boxKeys.length;U++)z.push({key:this.boxKeys[U],x1:this.bboxes[4*U],y1:this.bboxes[4*U+1],x2:this.bboxes[4*U+2],y2:this.bboxes[4*U+3]});for(let U=0;U<this.circleKeys.length;U++){const q=this.circles[3*U],Z=this.circles[3*U+1],ee=this.circles[3*U+2];z.push({key:this.circleKeys[U],x1:q-ee,y1:Z-ee,x2:q+ee,y2:Z+ee})}return P?z.filter(P):z}return this._forEachCell(c,g,w,I,this._queryCell,z,{hitTest:k,seenUids:{box:{},circle:{}}},P),k?z.length>0:z}_queryCircle(c,g,w,I,k){const P=c-w,z=c+w,U=g-w,q=g+w;if(z<0||P>this.width||q<0||U>this.height)return!I&&[];const Z=[];return this._forEachCell(P,U,z,q,this._queryCellCircle,Z,{hitTest:I,circle:{x:c,y:g,radius:w},seenUids:{box:{},circle:{}}},k),I?Z.length>0:Z}query(c,g,w,I,k){return this._query(c,g,w,I,!1,k)}hitTest(c,g,w,I,k){return this._query(c,g,w,I,!0,k)}hitTestCircle(c,g,w,I){return this._queryCircle(c,g,w,!0,I)}_queryCell(c,g,w,I,k,P,z,U){const q=z.seenUids,Z=this.boxCells[k];if(Z!==null){const ae=this.bboxes;for(const me of Z)if(!q.box[me]){q.box[me]=!0;const ue=4*me;if(c<=ae[ue+2]&&g<=ae[ue+3]&&w>=ae[ue+0]&&I>=ae[ue+1]&&(!U||U(this.boxKeys[me]))){if(z.hitTest)return P.push(!0),!0;P.push({key:this.boxKeys[me],x1:ae[ue],y1:ae[ue+1],x2:ae[ue+2],y2:ae[ue+3]})}}}const ee=this.circleCells[k];if(ee!==null){const ae=this.circles;for(const me of ee)if(!q.circle[me]){q.circle[me]=!0;const ue=3*me;if(this._circleAndRectCollide(ae[ue],ae[ue+1],ae[ue+2],c,g,w,I)&&(!U||U(this.circleKeys[me]))){if(z.hitTest)return P.push(!0),!0;{const oe=ae[ue],Me=ae[ue+1],ye=ae[ue+2];P.push({key:this.circleKeys[me],x1:oe-ye,y1:Me-ye,x2:oe+ye,y2:Me+ye})}}}}}_queryCellCircle(c,g,w,I,k,P,z,U){const q=z.circle,Z=z.seenUids,ee=this.boxCells[k];if(ee!==null){const me=this.bboxes;for(const ue of ee)if(!Z.box[ue]){Z.box[ue]=!0;const oe=4*ue;if(this._circleAndRectCollide(q.x,q.y,q.radius,me[oe+0],me[oe+1],me[oe+2],me[oe+3])&&(!U||U(this.boxKeys[ue])))return P.push(!0),!0}}const ae=this.circleCells[k];if(ae!==null){const me=this.circles;for(const ue of ae)if(!Z.circle[ue]){Z.circle[ue]=!0;const oe=3*ue;if(this._circlesCollide(me[oe],me[oe+1],me[oe+2],q.x,q.y,q.radius)&&(!U||U(this.circleKeys[ue])))return P.push(!0),!0}}}_forEachCell(c,g,w,I,k,P,z,U){const q=this._convertToXCellCoord(c),Z=this._convertToYCellCoord(g),ee=this._convertToXCellCoord(w),ae=this._convertToYCellCoord(I);for(let me=q;me<=ee;me++)for(let ue=Z;ue<=ae;ue++)if(k.call(this,c,g,w,I,this.xCellCount*ue+me,P,z,U))return}_convertToXCellCoord(c){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(c*this.xScale)))}_convertToYCellCoord(c){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(c*this.yScale)))}_circlesCollide(c,g,w,I,k,P){const z=I-c,U=k-g,q=w+P;return q*q>z*z+U*U}_circleAndRectCollide(c,g,w,I,k,P,z){const U=(P-I)/2,q=Math.abs(c-(I+U));if(q>U+w)return!1;const Z=(z-k)/2,ee=Math.abs(g-(k+Z));if(ee>Z+w)return!1;if(q<=U||ee<=Z)return!0;const ae=q-U,me=ee-Z;return ae*ae+me*me<=w*w}}const vi=Math.tan(85*Math.PI/180);function Xn(y,c,g,w,I,k){const P=h.create();if(g){if(I.projection.name==="globe")h.multiply$1(P,P,h.calculateGlobeLabelMatrix(I,c));else{const z=ve([],k);P[0]=z[0],P[1]=z[1],P[4]=z[2],P[5]=z[3]}w||h.rotateZ(P,P,I.angle)}else h.multiply$1(P,I.labelPlaneMatrix,y);return P}function co(y,c,g,w,I,k){if(g){if(I.projection.name==="globe"){const P=Xn(y,c,g,w,I,k);return h.invert(P,P),h.multiply$1(P,y,P),P}{const P=h.clone(y),z=h.identity([]);return z[0]=k[0],z[1]=k[1],z[4]=k[2],z[5]=k[3],h.multiply$1(P,P,z),w||h.rotateZ(P,P,-I.angle),P}}return I.glCoordMatrix}function Tr(y,c,g=0){const w=[y.x,y.y,g,1];g?h.transformMat4$1(w,w,c):zr(w,w,c);const I=w[3];return{point:new h.pointGeometry(w[0]/I,w[1]/I),signedDistanceFromCamera:I}}function Xr(y,c){const g=[y[0],y[1],y[2],1];h.transformMat4$1(g,g,c);const w=g[3];return{point:new h.pointGeometry(g[0]/w,g[1]/w),signedDistanceFromCamera:w}}function Zi(y,c){return Math.min(.5+y/c*.5,1.5)}function rh(y,c){const g=y[0]/y[3],w=y[1]/y[3];return g>=-c[0]&&g<=c[0]&&w>=-c[1]&&w<=c[1]}function Oo(y,c,g,w,I,k,P,z,U,q){const Z=g.transform,ee=w?y.textSizeData:y.iconSizeData,ae=h.evaluateSizeForZoom(ee,g.transform.zoom),me=[256/g.width*2+1,256/g.height*2+1],ue=w?y.text.dynamicLayoutVertexArray:y.icon.dynamicLayoutVertexArray;ue.clear();const oe=y.lineVertexArray,Me=w?y.text.placedSymbolArray:y.icon.placedSymbolArray,ye=g.transform.width/g.transform.height;let Ee=!1;for(let Te=0;Te<Me.length;Te++){const Se=Me.get(Te);if(Se.writingMode!==h.WritingMode.vertical||Ee||Te!==0&&Me.get(Te-1).writingMode===h.WritingMode.horizontal||(Ee=!0),(Se.hidden||Se.writingMode===h.WritingMode.vertical)&&!Ee){sr(Se.numGlyphs,ue);continue}Ee=!1;const we=new h.pointGeometry(Se.tileAnchorX,Se.tileAnchorY),ke=U?U(we):[0,0,0],$e=Z.projection.projectTilePoint(we.x,we.y,q.canonical),qe=[$e.x+ke[0],$e.y+ke[1],$e.z+ke[2]],He=[...qe,1];if(h.transformMat4$1(He,He,c),!rh(He,me)){sr(Se.numGlyphs,ue);continue}const Ye=Zi(g.transform.cameraToCenterDistance,He[3]),ht=h.evaluateSizeForFeature(ee,ae,Se),Ue=P?ht/Ye:ht*Ye,lt=Tr(new h.pointGeometry(qe[0],qe[1]),I,qe[2]);if(lt.signedDistanceFromCamera<=0){sr(Se.numGlyphs,ue);continue}let st={};const kt=P?null:U,Ze=vs(Se,Ue,!1,z,c,I,k,y.glyphOffsetArray,oe,ue,lt.point,we,st,ye,kt,Z.projection,q);Ee=Ze.useVertical,kt&&Ze.needsFlipping&&(st={}),(Ze.notEnoughRoom||Ee||Ze.needsFlipping&&vs(Se,Ue,!0,z,c,I,k,y.glyphOffsetArray,oe,ue,lt.point,we,st,ye,kt,Z.projection,q).notEnoughRoom)&&sr(Se.numGlyphs,ue)}w?y.text.dynamicLayoutVertexBuffer.updateData(ue):y.icon.dynamicLayoutVertexBuffer.updateData(ue)}function xs(y,c,g,w,I,k,P,z,U,q,Z,ee,ae,me,ue){const oe=z.glyphStartIndex+z.numGlyphs,Me=z.lineStartIndex,ye=z.lineStartIndex+z.lineLength,Ee=c.getoffsetX(z.glyphStartIndex),Te=c.getoffsetX(oe-1),Se=uo(y*Ee,g,w,I,k,P,z.segment,Me,ye,U,q,Z,ee,ae,!0,me,ue);if(!Se)return null;const we=uo(y*Te,g,w,I,k,P,z.segment,Me,ye,U,q,Z,ee,ae,!0,me,ue);return we?{first:Se,last:we}:null}function ho(y,c,g,w){return y.writingMode===h.WritingMode.horizontal&&Math.abs(g.y-c.y)>Math.abs(g.x-c.x)*w?{useVertical:!0}:y.writingMode===h.WritingMode.vertical?c.y<g.y?{needsFlipping:!0}:null:y.flipState!==0&&function(I,k,P){const z=(k.x-I.x)*P;return z===0||Math.abs((k.y-I.y)/z)>vi}(c,g,w)?y.flipState===1?{needsFlipping:!0}:null:c.x>g.x?{needsFlipping:!0}:null}function vs(y,c,g,w,I,k,P,z,U,q,Z,ee,ae,me,ue,oe,Me){const ye=c/24,Ee=y.lineOffsetX*ye,Te=y.lineOffsetY*ye;let Se;if(y.numGlyphs>1){const we=y.glyphStartIndex+y.numGlyphs,ke=y.lineStartIndex,$e=y.lineStartIndex+y.lineLength,qe=xs(ye,z,Ee,Te,g,Z,ee,y,U,k,ae,ue,!1,oe,Me);if(!qe)return{notEnoughRoom:!0};const He=Tr(qe.first.point,P).point,Ye=Tr(qe.last.point,P).point;if(w&&!g){const ht=ho(y,He,Ye,me);if(y.flipState=ht&&ht.needsFlipping?1:2,ht)return ht}Se=[qe.first];for(let ht=y.glyphStartIndex+1;ht<we-1;ht++)Se.push(uo(ye*z.getoffsetX(ht),Ee,Te,g,Z,ee,y.segment,ke,$e,U,k,ae,ue,!1,!1,oe,Me));Se.push(qe.last)}else{if(w&&!g){const ke=Tr(ee,I).point,$e=y.lineStartIndex+y.segment+1,qe=new h.pointGeometry(U.getx($e),U.gety($e)),He=Tr(qe,I),Ye=ho(y,ke,He.signedDistanceFromCamera>0?He.point:Ci(ee,qe,ke,1,I,void 0,oe,Me.canonical),me);if(y.flipState=Ye&&Ye.needsFlipping?1:2,Ye)return Ye}const we=uo(ye*z.getoffsetX(y.glyphStartIndex),Ee,Te,g,Z,ee,y.segment,y.lineStartIndex,y.lineStartIndex+y.lineLength,U,k,ae,ue,!1,!1,oe,Me);if(!we)return{notEnoughRoom:!0};Se=[we]}for(const we of Se)h.addDynamicAttributes(q,we.point,we.angle);return{}}function ga(y,c,g,w,I){const k=w.projectTilePoint(y.x,y.y,c);if(!I)return Tr(k,g,k.z);const P=I(y);return Tr(new h.pointGeometry(k.x+P[0],k.y+P[1]),g,k.z+P[2])}function Ci(y,c,g,w,I,k,P,z){const U=ga(y.add(y.sub(c)._unit()),z,I,P,k).point,q=g.sub(U);return g.add(q._mult(w/q.mag()))}function uo(y,c,g,w,I,k,P,z,U,q,Z,ee,ae,me,ue,oe,Me){const ye=w?y-c:y+c;let Ee=ye>0?1:-1,Te=0;w&&(Ee*=-1,Te=Math.PI),Ee<0&&(Te+=Math.PI);let Se=Ee>0?z+P:z+P+1,we=I,ke=I,$e=0,qe=0;const He=Math.abs(ye),Ye=[],ht=[];let Ue=k;const lt=()=>{const St=Se-Ee;return $e===0?k:new h.pointGeometry(q.getx(St),q.gety(St))},st=()=>Ci(lt(),Ue,ke,He-$e+1,Z,ae,oe,Me.canonical);for(;$e+qe<=He;){if(Se+=Ee,Se<z||Se>=U)return null;if(ke=we,Ye.push(we),me&&ht.push(Ue||lt()),we=ee[Se],we===void 0){Ue=new h.pointGeometry(q.getx(Se),q.gety(Se));const St=ga(Ue,Me.canonical,Z,oe,ae);we=St.signedDistanceFromCamera>0?ee[Se]=St.point:st()}else Ue=null;$e+=qe,qe=ke.dist(we)}ue&&ae&&(Ue=Ue||new h.pointGeometry(q.getx(Se),q.gety(Se)),ee[Se]=we=ee[Se]===void 0?we:st(),qe=ke.dist(we));const kt=(He-$e)/qe,Ze=we.sub(ke),Ut=Ze.mult(kt)._add(ke);g&&Ut._add(Ze._unit()._perp()._mult(g*Ee));const Gt=Te+Math.atan2(we.y-ke.y,we.x-ke.x);return Ye.push(Ut),me&&(Ue=Ue||new h.pointGeometry(q.getx(Se),q.gety(Se)),ht.push(function(St,At,Kt){const pi=1-Kt;return new h.pointGeometry(St.x*pi+At.x*Kt,St.y*pi+At.y*Kt)}(ht.length>0?ht[ht.length-1]:Ue,Ue,kt))),{point:Ut,angle:Gt,path:Ye,tilePath:ht}}const _a=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function sr(y,c){for(let g=0;g<y;g++){const w=c.length;c.resize(w+4),c.float32.set(_a,3*w)}}function zr(y,c,g){const w=c[0],I=c[1];return y[0]=g[0]*w+g[4]*I+g[12],y[1]=g[1]*w+g[5]*I+g[13],y[3]=g[3]*w+g[7]*I+g[15],y}const sn=100;class bs{constructor(c,g,w=new Zn(c.width+200,c.height+200,25),I=new Zn(c.width+200,c.height+200,25)){this.transform=c,this.grid=w,this.ignoredGrid=I,this.pitchfactor=Math.cos(c._pitch)*c.cameraToCenterDistance,this.screenRightBoundary=c.width+sn,this.screenBottomBoundary=c.height+sn,this.gridRightBoundary=c.width+200,this.gridBottomBoundary=c.height+200,this.fogState=g}placeCollisionBox(c,g,w,I,k,P,z){let U=g.projectedAnchorX,q=g.projectedAnchorY,Z=g.projectedAnchorZ;const ee=g.elevation,ae=g.tileID;if(ee&&ae){const Se=this.transform.projection.upVector(ae.canonical,g.tileAnchorX,g.tileAnchorY),we=this.transform.projection.upVectorScale(ae.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;U+=Se[0]*ee*we,q+=Se[1]*ee*we,Z+=Se[2]*ee*we}const me=this.projectAndGetPerspectiveRatio(P,[U,q,Z],g.tileID,this.transform.projection.name==="globe"||!!ee||this.transform.pitch>0),ue=k*me.perspectiveRatio,oe=(g.x1*c+w.x-g.padding)*ue+me.point.x,Me=(g.y1*c+w.y-g.padding)*ue+me.point.y,ye=(g.x2*c+w.x+g.padding)*ue+me.point.x,Ee=(g.y2*c+w.y+g.padding)*ue+me.point.y,Te=me.perspectiveRatio<=.55||me.occluded;return!this.isInsideGrid(oe,Me,ye,Ee)||!I&&this.grid.hitTest(oe,Me,ye,Ee,z)||Te?{box:[],offscreen:!1,occluded:me.occluded}:{box:[oe,Me,ye,Ee],offscreen:this.isOffscreen(oe,Me,ye,Ee),occluded:!1}}placeCollisionCircles(c,g,w,I,k,P,z,U,q,Z,ee,ae,me,ue){const oe=[],Me=this.transform.elevation,ye=Me?Me.getAtTileOffsetFunc(ue,this.transform.center.lat,this.transform.worldSize,this.transform.projection):st=>[0,0,0],Ee=new h.pointGeometry(g.tileAnchorX,g.tileAnchorY),Te=this.transform.projection.projectTilePoint(g.tileAnchorX,g.tileAnchorY,ue.canonical),Se=ye(Ee),we=[Te.x+Se[0],Te.y+Se[1],Te.z+Se[2]],ke=this.projectAndGetPerspectiveRatio(P,[we[0],we[1],we[2]],ue,this.transform.projection.name==="globe"||!!Me||this.transform.pitch>0),{perspectiveRatio:$e}=ke,qe=(Z?k/$e:k*$e)/h.ONE_EM,He=Tr(new h.pointGeometry(we[0],we[1]),z,we[2]).point,Ye=ke.signedDistanceFromCamera>0?xs(qe,I,g.lineOffsetX*qe,g.lineOffsetY*qe,!1,He,Ee,g,w,z,{},Me&&!Z?ye:null,Z&&!!Me,this.transform.projection,ue):null;let ht=!1,Ue=!1,lt=!0;if(Ye&&!ke.occluded){const st=.5*ae*$e+me,kt=new h.pointGeometry(-100,-100),Ze=new h.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),Ut=new dn,Gt=Ye.first,St=Ye.last;let At=[];for(let Ft=Gt.path.length-1;Ft>=1;Ft--)At.push(Gt.path[Ft]);for(let Ft=1;Ft<St.path.length;Ft++)At.push(St.path[Ft]);const Kt=2.5*st;if(U){const Ft=At.map(Me?(ei,ki)=>{const Yi=ye(ki<Gt.path.length-1?Gt.tilePath[Gt.path.length-1-ki]:St.tilePath[ki-Gt.path.length+2]);return Tr(ei,U,Yi[2])}:ei=>Tr(ei,U));At=Ft.some(ei=>ei.signedDistanceFromCamera<=0)?[]:Ft.map(ei=>ei.point)}let pi=[];if(At.length>0){const Ft=At[0].clone(),ei=At[0].clone();for(let ki=1;ki<At.length;ki++)Ft.x=Math.min(Ft.x,At[ki].x),Ft.y=Math.min(Ft.y,At[ki].y),ei.x=Math.max(ei.x,At[ki].x),ei.y=Math.max(ei.y,At[ki].y);pi=Ft.x>=kt.x&&ei.x<=Ze.x&&Ft.y>=kt.y&&ei.y<=Ze.y?[At]:ei.x<kt.x||Ft.x>Ze.x||ei.y<kt.y||Ft.y>Ze.y?[]:h.clipLine([At],kt.x,kt.y,Ze.x,Ze.y)}for(const Ft of pi){Ut.reset(Ft,.25*st);let ei=0;ei=Ut.length<=.5*st?1:Math.ceil(Ut.paddedLength/Kt)+1;for(let ki=0;ki<ei;ki++){const Yi=ki/Math.max(ei-1,1),xr=Ut.lerp(Yi),vr=xr.x+sn,Ur=xr.y+sn;oe.push(vr,Ur,st,0);const cn=vr-st,En=Ur-st,Fn=vr+st,Tn=Ur+st;if(lt=lt&&this.isOffscreen(cn,En,Fn,Tn),Ue=Ue||this.isInsideGrid(cn,En,Fn,Tn),!c&&this.grid.hitTestCircle(vr,Ur,st,ee)&&(ht=!0,!q))return{circles:[],offscreen:!1,collisionDetected:ht,occluded:!1}}}}return{circles:!q&&ht||!Ue?[]:oe,offscreen:lt,collisionDetected:ht,occluded:ke.occluded}}queryRenderedSymbols(c){if(c.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const g=[];let w=1/0,I=1/0,k=-1/0,P=-1/0;for(const Z of c){const ee=new h.pointGeometry(Z.x+sn,Z.y+sn);w=Math.min(w,ee.x),I=Math.min(I,ee.y),k=Math.max(k,ee.x),P=Math.max(P,ee.y),g.push(ee)}const z=this.grid.query(w,I,k,P).concat(this.ignoredGrid.query(w,I,k,P)),U={},q={};for(const Z of z){const ee=Z.key;if(U[ee.bucketInstanceId]===void 0&&(U[ee.bucketInstanceId]={}),U[ee.bucketInstanceId][ee.featureIndex])continue;const ae=[new h.pointGeometry(Z.x1,Z.y1),new h.pointGeometry(Z.x2,Z.y1),new h.pointGeometry(Z.x2,Z.y2),new h.pointGeometry(Z.x1,Z.y2)];h.polygonIntersectsPolygon(g,ae)&&(U[ee.bucketInstanceId][ee.featureIndex]=!0,q[ee.bucketInstanceId]===void 0&&(q[ee.bucketInstanceId]=[]),q[ee.bucketInstanceId].push(ee.featureIndex))}return q}insertCollisionBox(c,g,w,I,k){(g?this.ignoredGrid:this.grid).insert({bucketInstanceId:w,featureIndex:I,collisionGroupID:k},c[0],c[1],c[2],c[3])}insertCollisionCircles(c,g,w,I,k){const P=g?this.ignoredGrid:this.grid,z={bucketInstanceId:w,featureIndex:I,collisionGroupID:k};for(let U=0;U<c.length;U+=4)P.insertCircle(z,c[U],c[U+1],c[U+2])}projectAndGetPerspectiveRatio(c,g,w,I){const k=[g[0],g[1],g[2],1];let P=!1;return g[2]||this.transform.pitch>0?(h.transformMat4$1(k,k,c),this.fogState&&w&&(P=function(z,U,q,Z,ee,ae){const me=ae.calculateFogTileMatrix(ee),ue=[U,q,Z];return h.transformMat4(ue,ue,me),xt(z,ue,ae.pitch,ae._fov)}(this.fogState,g[0],g[1],g[2],w.toUnwrapped(),this.transform)>.9)):zr(k,k,c),{point:new h.pointGeometry((k[0]/k[3]+1)/2*this.transform.width+sn,(-k[1]/k[3]+1)/2*this.transform.height+sn),perspectiveRatio:Math.min(.5+this.transform.cameraToCenterDistance/k[3]*.5,1.5),signedDistanceFromCamera:k[3],occluded:I&&k[2]>k[3]||P}}isOffscreen(c,g,w,I){return w<sn||c>=this.screenRightBoundary||I<sn||g>this.screenBottomBoundary}isInsideGrid(c,g,w,I){return w>=0&&c<this.gridRightBoundary&&I>=0&&g<this.gridBottomBoundary}getViewportMatrix(){const c=h.identity([]);return h.translate(c,c,[-100,-100,0]),c}}class ir{constructor(c,g,w,I){this.opacity=c?Math.max(0,Math.min(1,c.opacity+(c.placed?g:-g))):I&&w?1:0,this.placed=w}isHidden(){return this.opacity===0&&!this.placed}}class yn{constructor(c,g,w,I,k,P=!1){this.text=new ir(c?c.text:null,g,w,k),this.icon=new ir(c?c.icon:null,g,I,k),this.clipped=P}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class xn{constructor(c,g,w,I=!1){this.text=c,this.icon=g,this.skipFade=w,this.clipped=I}}class gr{constructor(){this.invProjMatrix=h.create(),this.viewportMatrix=h.create(),this.circles=[]}}class ya{constructor(c,g,w,I,k){this.bucketInstanceId=c,this.featureIndex=g,this.sourceLayerIndex=w,this.bucketIndex=I,this.tileID=k}}class an{constructor(c){this.crossSourceCollisions=c,this.maxGroupID=0,this.collisionGroups={}}get(c){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[c]){const g=++this.maxGroupID;this.collisionGroups[c]={ID:g,predicate:w=>w.collisionGroupID===g}}return this.collisionGroups[c]}}function fo(y,c,g,w,I){const{horizontalAlign:k,verticalAlign:P}=h.getAnchorAlignment(y),z=-(k-.5)*c,U=-(P-.5)*g,q=h.evaluateVariableOffset(y,w);return new h.pointGeometry(z+q[0]*I,U+q[1]*I)}function po(y,c,g,w,I){const k=new h.pointGeometry(y,c);return g&&k._rotate(w?I:-I),k}class nh{constructor(c,g,w,I,k){this.transform=c.clone(),this.collisionIndex=new bs(this.transform,k),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=g,this.retainedQueryData={},this.collisionGroups=new an(w),this.collisionCircleArrays={},this.prevPlacement=I,I&&(I.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(c,g,w,I){const k=w.getBucket(g),P=w.latestFeatureIndex;if(!k||!P||g.id!==k.layerIds[0])return;const z=k.layers[0].layout,U=w.collisionBoxArray,q=Math.pow(2,this.transform.zoom-w.tileID.overscaledZ),Z=w.tileSize/h.EXTENT,ee=w.tileID.toUnwrapped(),ae=this.transform.calculateProjMatrix(ee),me=z.get("text-pitch-alignment")==="map",ue=z.get("text-rotation-alignment")==="map";g.compileFilter();const oe=g.dynamicFilter(),Me=g.dynamicFilterNeedsFeature(),ye=this.transform.calculatePixelsToTileUnitsMatrix(w),Ee=Xn(ae,w.tileID.canonical,me,ue,this.transform,ye);let Te=null;if(me){const ke=co(ae,w.tileID.canonical,me,ue,this.transform,ye);Te=h.multiply$1([],this.transform.labelPlaneMatrix,ke)}let Se=null;oe&&w.latestFeatureIndex&&(Se={unwrappedTileID:ee,dynamicFilter:oe,dynamicFilterNeedsFeature:Me,featureIndex:w.latestFeatureIndex}),this.retainedQueryData[k.bucketInstanceId]=new ya(k.bucketInstanceId,P,k.sourceLayerIndex,k.index,w.tileID);const we={bucket:k,layout:z,posMatrix:ae,textLabelPlaneMatrix:Ee,labelToScreenMatrix:Te,clippingData:Se,scale:q,textPixelRatio:Z,holdingForFade:w.holdingForFade(),collisionBoxArray:U,partiallyEvaluatedTextSize:h.evaluateSizeForZoom(k.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:h.evaluateSizeForZoom(k.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(k.sourceID)};if(I)for(const ke of k.sortKeyRanges){const{sortKey:$e,symbolInstanceStart:qe,symbolInstanceEnd:He}=ke;c.push({sortKey:$e,symbolInstanceStart:qe,symbolInstanceEnd:He,parameters:we})}else c.push({symbolInstanceStart:0,symbolInstanceEnd:k.symbolInstances.length,parameters:we})}attemptAnchorPlacement(c,g,w,I,k,P,z,U,q,Z,ee,ae,me,ue,oe,Me,ye,Ee){const Te=[ae.textOffset0,ae.textOffset1],Se=fo(c,w,I,Te,k),we=this.collisionIndex.placeCollisionBox(k,g,po(Se.x,Se.y,P,z,this.transform.angle),ee,U,q,Z.predicate);if((!Me||this.collisionIndex.placeCollisionBox(ue.getSymbolInstanceIconSize(Ee,this.transform.zoom,me),Me,po(Se.x,Se.y,P,z,this.transform.angle),ee,U,q,Z.predicate).box.length!==0)&&we.box.length>0){let ke;return this.prevPlacement&&this.prevPlacement.variableOffsets[ae.crossTileID]&&this.prevPlacement.placements[ae.crossTileID]&&this.prevPlacement.placements[ae.crossTileID].text&&(ke=this.prevPlacement.variableOffsets[ae.crossTileID].anchor),this.variableOffsets[ae.crossTileID]={textOffset:Te,width:w,height:I,anchor:c,textScale:k,prevAnchor:ke},this.markUsedJustification(ue,c,ae,oe),ue.allowVerticalPlacement&&(this.markUsedOrientation(ue,oe,ae),this.placedOrientations[ae.crossTileID]=oe),{shift:Se,placedGlyphBoxes:we}}}placeLayerBucketPart(c,g,w,I){const{bucket:k,layout:P,posMatrix:z,textLabelPlaneMatrix:U,labelToScreenMatrix:q,clippingData:Z,textPixelRatio:ee,holdingForFade:ae,collisionBoxArray:me,partiallyEvaluatedTextSize:ue,partiallyEvaluatedIconSize:oe,collisionGroup:Me}=c.parameters,ye=P.get("text-optional"),Ee=P.get("icon-optional"),Te=P.get("text-allow-overlap"),Se=P.get("icon-allow-overlap"),we=P.get("text-rotation-alignment")==="map",ke=P.get("text-pitch-alignment")==="map",$e=P.get("icon-text-fit")!=="none",qe=P.get("symbol-z-order")==="viewport-y";let He=Te&&(Se||!k.hasIconData()||Ee),Ye=Se&&(Te||!k.hasTextData()||ye);!k.collisionArrays&&me&&k.deserializeCollisionBoxes(me),w&&I&&k.updateCollisionDebugBuffers(this.transform.zoom,me);const ht=(Ue,lt,st)=>{if(Z){const Wi={zoom:this.transform.zoom,pitch:this.transform.pitch};let Ki=null;if(Z.dynamicFilterNeedsFeature){const Di=this.retainedQueryData[k.bucketInstanceId];Ki=Z.featureIndex.loadFeature({featureIndex:Ue.featureIndex,bucketIndex:Di.bucketIndex,sourceLayerIndex:Di.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,Z.dynamicFilter)(Wi,Ki,this.retainedQueryData[k.bucketInstanceId].tileID.canonical,new h.pointGeometry(Ue.tileAnchorX,Ue.tileAnchorY),this.transform.calculateDistanceTileData(Z.unwrappedTileID)))return this.placements[Ue.crossTileID]=new xn(!1,!1,!1,!0),void(g[Ue.crossTileID]=!0)}if(g[Ue.crossTileID])return;if(ae)return void(this.placements[Ue.crossTileID]=new xn(!1,!1,!1));let kt=!1,Ze=!1,Ut=!0,Gt=!1,St=!1,At=null,Kt={box:null,offscreen:null,occluded:null},pi={box:null,offscreen:null,occluded:null},Ft=null,ei=null,ki=null,Yi=0,xr=0,vr=0;st.textFeatureIndex?Yi=st.textFeatureIndex:Ue.useRuntimeCollisionCircles&&(Yi=Ue.featureIndex),st.verticalTextFeatureIndex&&(xr=st.verticalTextFeatureIndex);const Ur=Wi=>{Wi.tileID=this.retainedQueryData[k.bucketInstanceId].tileID,(this.transform.elevation||Wi.elevation)&&(Wi.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[k.bucketInstanceId].tileID,Wi.tileAnchorX,Wi.tileAnchorY):0)},cn=st.textBox;if(cn){Ur(cn);const Wi=Di=>{let rr=h.WritingMode.horizontal;if(k.allowVerticalPlacement&&!Di&&this.prevPlacement){const Vr=this.prevPlacement.placedOrientations[Ue.crossTileID];Vr&&(this.placedOrientations[Ue.crossTileID]=Vr,rr=Vr,this.markUsedOrientation(k,rr,Ue))}return rr},Ki=(Di,rr)=>{if(k.allowVerticalPlacement&&Ue.numVerticalGlyphVertices>0&&st.verticalTextBox){for(const Vr of k.writingModes)if(Vr===h.WritingMode.vertical?(Kt=rr(),pi=Kt):Kt=Di(),Kt&&Kt.box&&Kt.box.length)break}else Kt=Di()};if(P.get("text-variable-anchor")){let Di=P.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Ue.crossTileID]){const Xi=this.prevPlacement.variableOffsets[Ue.crossTileID];Di.indexOf(Xi.anchor)>0&&(Di=Di.filter(Hr=>Hr!==Xi.anchor),Di.unshift(Xi.anchor))}const rr=(Xi,Hr,hs)=>{const jr=k.getSymbolInstanceTextSize(ue,Ue,this.transform.zoom,lt),to=(Xi.x2-Xi.x1)*jr+2*Xi.padding,Mc=(Xi.y2-Xi.y1)*jr+2*Xi.padding,tl=$e&&!Se?Hr:null;tl&&Ur(tl);let To={box:[],offscreen:!1,occluded:!1};const bh=Te?2*Di.length:Di.length;for(let On=0;On<bh;++On){const il=this.attemptAnchorPlacement(Di[On%Di.length],Xi,to,Mc,jr,we,ke,ee,z,Me,On>=Di.length,Ue,lt,k,hs,tl,ue,oe);if(il&&(To=il.placedGlyphBoxes,To&&To.box&&To.box.length)){kt=!0,At=il.shift;break}}return To};Ki(()=>rr(cn,st.iconBox,h.WritingMode.horizontal),()=>{const Xi=st.verticalTextBox;return Xi&&Ur(Xi),k.allowVerticalPlacement&&!(Kt&&Kt.box&&Kt.box.length)&&Ue.numVerticalGlyphVertices>0&&Xi?rr(Xi,st.verticalIconBox,h.WritingMode.vertical):{box:null,offscreen:null,occluded:null}}),Kt&&(kt=Kt.box,Ut=Kt.offscreen,Gt=Kt.occluded);const Vr=Wi(Kt&&Kt.box);if(!kt&&this.prevPlacement){const Xi=this.prevPlacement.variableOffsets[Ue.crossTileID];Xi&&(this.variableOffsets[Ue.crossTileID]=Xi,this.markUsedJustification(k,Xi.anchor,Ue,Vr))}}else{const Di=(rr,Vr)=>{const Xi=k.getSymbolInstanceTextSize(ue,Ue,this.transform.zoom,lt),Hr=this.collisionIndex.placeCollisionBox(Xi,rr,new h.pointGeometry(0,0),Te,ee,z,Me.predicate);return Hr&&Hr.box&&Hr.box.length&&(this.markUsedOrientation(k,Vr,Ue),this.placedOrientations[Ue.crossTileID]=Vr),Hr};Ki(()=>Di(cn,h.WritingMode.horizontal),()=>{const rr=st.verticalTextBox;return k.allowVerticalPlacement&&Ue.numVerticalGlyphVertices>0&&rr?(Ur(rr),Di(rr,h.WritingMode.vertical)):{box:null,offscreen:null,occluded:null}}),Wi(Kt&&Kt.box&&Kt.box.length)}}if(Ft=Kt,kt=Ft&&Ft.box&&Ft.box.length>0,Ut=Ft&&Ft.offscreen,Gt=Ft&&Ft.occluded,Ue.useRuntimeCollisionCircles){const Wi=k.text.placedSymbolArray.get(Ue.centerJustifiedTextSymbolIndex>=0?Ue.centerJustifiedTextSymbolIndex:Ue.verticalPlacedTextSymbolIndex),Ki=h.evaluateSizeForFeature(k.textSizeData,ue,Wi),Di=P.get("text-padding");ei=this.collisionIndex.placeCollisionCircles(Te,Wi,k.lineVertexArray,k.glyphOffsetArray,Ki,z,U,q,w,ke,Me.predicate,Ue.collisionCircleDiameter*Ki/h.ONE_EM,Di,this.retainedQueryData[k.bucketInstanceId].tileID),kt=Te||ei.circles.length>0&&!ei.collisionDetected,Ut=Ut&&ei.offscreen,Gt=ei.occluded}if(st.iconFeatureIndex&&(vr=st.iconFeatureIndex),st.iconBox){const Wi=Ki=>{Ur(Ki);const Di=$e&&At?po(At.x,At.y,we,ke,this.transform.angle):new h.pointGeometry(0,0),rr=k.getSymbolInstanceIconSize(oe,this.transform.zoom,lt);return this.collisionIndex.placeCollisionBox(rr,Ki,Di,Se,ee,z,Me.predicate)};pi&&pi.box&&pi.box.length&&st.verticalIconBox?(ki=Wi(st.verticalIconBox),Ze=ki.box.length>0):(ki=Wi(st.iconBox),Ze=ki.box.length>0),Ut=Ut&&ki.offscreen,St=ki.occluded}const En=ye||Ue.numHorizontalGlyphVertices===0&&Ue.numVerticalGlyphVertices===0,Fn=Ee||Ue.numIconVertices===0;if(En||Fn?Fn?En||(Ze=Ze&&kt):kt=Ze&&kt:Ze=kt=Ze&&kt,kt&&Ft&&Ft.box&&this.collisionIndex.insertCollisionBox(Ft.box,P.get("text-ignore-placement"),k.bucketInstanceId,pi&&pi.box&&xr?xr:Yi,Me.ID),Ze&&ki&&this.collisionIndex.insertCollisionBox(ki.box,P.get("icon-ignore-placement"),k.bucketInstanceId,vr,Me.ID),ei&&(kt&&this.collisionIndex.insertCollisionCircles(ei.circles,P.get("text-ignore-placement"),k.bucketInstanceId,Yi,Me.ID),w)){const Wi=k.bucketInstanceId;let Ki=this.collisionCircleArrays[Wi];Ki===void 0&&(Ki=this.collisionCircleArrays[Wi]=new gr);for(let Di=0;Di<ei.circles.length;Di+=4)Ki.circles.push(ei.circles[Di+0]),Ki.circles.push(ei.circles[Di+1]),Ki.circles.push(ei.circles[Di+2]),Ki.circles.push(ei.collisionDetected?1:0)}const Tn=this.transform.projection.name!=="globe";He=He&&(Tn||!Gt),Ye=Ye&&(Tn||!St),this.placements[Ue.crossTileID]=new xn(kt||He,Ze||Ye,Ut||k.justReloaded),g[Ue.crossTileID]=!0};if(qe){const Ue=k.getSortedSymbolIndexes(this.transform.angle);for(let lt=Ue.length-1;lt>=0;--lt){const st=Ue[lt];ht(k.symbolInstances.get(st),st,k.collisionArrays[st])}}else for(let Ue=c.symbolInstanceStart;Ue<c.symbolInstanceEnd;Ue++)ht(k.symbolInstances.get(Ue),Ue,k.collisionArrays[Ue]);if(w&&k.bucketInstanceId in this.collisionCircleArrays){const Ue=this.collisionCircleArrays[k.bucketInstanceId];h.invert(Ue.invProjMatrix,z),Ue.viewportMatrix=this.collisionIndex.getViewportMatrix()}k.justReloaded=!1}markUsedJustification(c,g,w,I){let k;k=I===h.WritingMode.vertical?w.verticalPlacedTextSymbolIndex:{left:w.leftJustifiedTextSymbolIndex,center:w.centerJustifiedTextSymbolIndex,right:w.rightJustifiedTextSymbolIndex}[h.getAnchorJustification(g)];const P=[w.leftJustifiedTextSymbolIndex,w.centerJustifiedTextSymbolIndex,w.rightJustifiedTextSymbolIndex,w.verticalPlacedTextSymbolIndex];for(const z of P)z>=0&&(c.text.placedSymbolArray.get(z).crossTileID=k>=0&&z!==k?0:w.crossTileID)}markUsedOrientation(c,g,w){const I=g===h.WritingMode.horizontal||g===h.WritingMode.horizontalOnly?g:0,k=g===h.WritingMode.vertical?g:0,P=[w.leftJustifiedTextSymbolIndex,w.centerJustifiedTextSymbolIndex,w.rightJustifiedTextSymbolIndex];for(const z of P)c.text.placedSymbolArray.get(z).placedOrientation=I;w.verticalPlacedTextSymbolIndex&&(c.text.placedSymbolArray.get(w.verticalPlacedTextSymbolIndex).placedOrientation=k)}commit(c){this.commitTime=c,this.zoomAtLastRecencyCheck=this.transform.zoom;const g=this.prevPlacement;let w=!1;this.prevZoomAdjustment=g?g.zoomAdjustment(this.transform.zoom):0;const I=g?g.symbolFadeChange(c):1,k=g?g.opacities:{},P=g?g.variableOffsets:{},z=g?g.placedOrientations:{};for(const U in this.placements){const q=this.placements[U],Z=k[U];Z?(this.opacities[U]=new yn(Z,I,q.text,q.icon,null,q.clipped),w=w||q.text!==Z.text.placed||q.icon!==Z.icon.placed):(this.opacities[U]=new yn(null,I,q.text,q.icon,q.skipFade,q.clipped),w=w||q.text||q.icon)}for(const U in k){const q=k[U];if(!this.opacities[U]){const Z=new yn(q,I,!1,!1);Z.isHidden()||(this.opacities[U]=Z,w=w||q.text.placed||q.icon.placed)}}for(const U in P)this.variableOffsets[U]||!this.opacities[U]||this.opacities[U].isHidden()||(this.variableOffsets[U]=P[U]);for(const U in z)this.placedOrientations[U]||!this.opacities[U]||this.opacities[U].isHidden()||(this.placedOrientations[U]=z[U]);w?this.lastPlacementChangeTime=c:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=g?g.lastPlacementChangeTime:c)}updateLayerOpacities(c,g){const w={};for(const I of g){const k=I.getBucket(c);k&&I.latestFeatureIndex&&c.id===k.layerIds[0]&&this.updateBucketOpacities(k,w,I.collisionBoxArray)}}updateBucketOpacities(c,g,w){c.hasTextData()&&c.text.opacityVertexArray.clear(),c.hasIconData()&&c.icon.opacityVertexArray.clear(),c.hasIconCollisionBoxData()&&c.iconCollisionBox.collisionVertexArray.clear(),c.hasTextCollisionBoxData()&&c.textCollisionBox.collisionVertexArray.clear();const I=c.layers[0].layout,k=!!c.layers[0].dynamicFilter(),P=new yn(null,0,!1,!1,!0),z=I.get("text-allow-overlap"),U=I.get("icon-allow-overlap"),q=I.get("text-variable-anchor"),Z=I.get("text-rotation-alignment")==="map",ee=I.get("text-pitch-alignment")==="map",ae=I.get("icon-text-fit")!=="none",me=new yn(null,0,z&&(U||!c.hasIconData()||I.get("icon-optional")),U&&(z||!c.hasTextData()||I.get("text-optional")),!0);!c.collisionArrays&&w&&(c.hasIconCollisionBoxData()||c.hasTextCollisionBoxData())&&c.deserializeCollisionBoxes(w);const ue=(Me,ye,Ee)=>{for(let Te=0;Te<ye/4;Te++)Me.opacityVertexArray.emplaceBack(Ee)};let oe=0;for(let Me=0;Me<c.symbolInstances.length;Me++){const ye=c.symbolInstances.get(Me),{numHorizontalGlyphVertices:Ee,numVerticalGlyphVertices:Te,crossTileID:Se}=ye;let we=this.opacities[Se];g[Se]?we=P:we||(we=me,this.opacities[Se]=we),g[Se]=!0;const ke=Ee>0||Te>0,$e=ye.numIconVertices>0,qe=this.placedOrientations[ye.crossTileID],He=qe===h.WritingMode.vertical,Ye=qe===h.WritingMode.horizontal||qe===h.WritingMode.horizontalOnly;if(!ke&&!$e||we.isHidden()||oe++,ke){const ht=Rl(we.text);ue(c.text,Ee,He?Ts:ht),ue(c.text,Te,Ye?Ts:ht);const Ue=we.text.isHidden();[ye.rightJustifiedTextSymbolIndex,ye.centerJustifiedTextSymbolIndex,ye.leftJustifiedTextSymbolIndex].forEach(kt=>{kt>=0&&(c.text.placedSymbolArray.get(kt).hidden=Ue||He?1:0)}),ye.verticalPlacedTextSymbolIndex>=0&&(c.text.placedSymbolArray.get(ye.verticalPlacedTextSymbolIndex).hidden=Ue||Ye?1:0);const lt=this.variableOffsets[ye.crossTileID];lt&&this.markUsedJustification(c,lt.anchor,ye,qe);const st=this.placedOrientations[ye.crossTileID];st&&(this.markUsedJustification(c,"left",ye,st),this.markUsedOrientation(c,st,ye))}if($e){const ht=Rl(we.icon);ye.placedIconSymbolIndex>=0&&(ue(c.icon,ye.numIconVertices,He?Ts:ht),c.icon.placedSymbolArray.get(ye.placedIconSymbolIndex).hidden=we.icon.isHidden()),ye.verticalPlacedIconSymbolIndex>=0&&(ue(c.icon,ye.numVerticalIconVertices,Ye?Ts:ht),c.icon.placedSymbolArray.get(ye.verticalPlacedIconSymbolIndex).hidden=we.icon.isHidden())}if(c.hasIconCollisionBoxData()||c.hasTextCollisionBoxData()){const ht=c.collisionArrays[Me];if(ht){let Ue=new h.pointGeometry(0,0),lt=!0;if(ht.textBox||ht.verticalTextBox){if(q){const kt=this.variableOffsets[Se];kt?(Ue=fo(kt.anchor,kt.width,kt.height,kt.textOffset,kt.textScale),Z&&Ue._rotate(ee?this.transform.angle:-this.transform.angle)):lt=!1}k&&(lt=!we.clipped),ht.textBox&&ln(c.textCollisionBox.collisionVertexArray,we.text.placed,!lt||He,Ue.x,Ue.y),ht.verticalTextBox&&ln(c.textCollisionBox.collisionVertexArray,we.text.placed,!lt||Ye,Ue.x,Ue.y)}const st=lt&&Boolean(!Ye&&ht.verticalIconBox);ht.iconBox&&ln(c.iconCollisionBox.collisionVertexArray,we.icon.placed,st,ae?Ue.x:0,ae?Ue.y:0),ht.verticalIconBox&&ln(c.iconCollisionBox.collisionVertexArray,we.icon.placed,!st,ae?Ue.x:0,ae?Ue.y:0)}}}if(c.fullyClipped=oe===0,c.sortFeatures(this.transform.angle),this.retainedQueryData[c.bucketInstanceId]&&(this.retainedQueryData[c.bucketInstanceId].featureSortOrder=c.featureSortOrder),c.hasTextData()&&c.text.opacityVertexBuffer&&c.text.opacityVertexBuffer.updateData(c.text.opacityVertexArray),c.hasIconData()&&c.icon.opacityVertexBuffer&&c.icon.opacityVertexBuffer.updateData(c.icon.opacityVertexArray),c.hasIconCollisionBoxData()&&c.iconCollisionBox.collisionVertexBuffer&&c.iconCollisionBox.collisionVertexBuffer.updateData(c.iconCollisionBox.collisionVertexArray),c.hasTextCollisionBoxData()&&c.textCollisionBox.collisionVertexBuffer&&c.textCollisionBox.collisionVertexBuffer.updateData(c.textCollisionBox.collisionVertexArray),c.bucketInstanceId in this.collisionCircleArrays){const Me=this.collisionCircleArrays[c.bucketInstanceId];c.placementInvProjMatrix=Me.invProjMatrix,c.placementViewportMatrix=Me.viewportMatrix,c.collisionCircleArray=Me.circles,delete this.collisionCircleArrays[c.bucketInstanceId]}}symbolFadeChange(c){return this.fadeDuration===0?1:(c-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(c){return Math.max(0,(this.transform.zoom-c)/1.5)}hasTransitions(c){return this.stale||c-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(c,g){const w=this.zoomAtLastRecencyCheck===g?1-this.zoomAdjustment(g):1;return this.zoomAtLastRecencyCheck=g,this.commitTime+this.fadeDuration*w>c}setStale(){this.stale=!0}}function ln(y,c,g,w,I){y.emplaceBack(c?1:0,g?1:0,w||0,I||0),y.emplaceBack(c?1:0,g?1:0,w||0,I||0),y.emplaceBack(c?1:0,g?1:0,w||0,I||0),y.emplaceBack(c?1:0,g?1:0,w||0,I||0)}const oh=Math.pow(2,25),Bl=Math.pow(2,24),Fr=Math.pow(2,17),ws=Math.pow(2,16),In=Math.pow(2,9),xa=Math.pow(2,8),Es=Math.pow(2,1);function Rl(y){if(y.opacity===0&&!y.placed)return 0;if(y.opacity===1&&y.placed)return 4294967295;const c=y.placed?1:0,g=Math.floor(127*y.opacity);return g*oh+c*Bl+g*Fr+c*ws+g*In+c*xa+g*Es+c}const Ts=0;class va{constructor(c){this._sortAcrossTiles=c.layout.get("symbol-z-order")!=="viewport-y"&&c.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(c,g,w,I,k){const P=this._bucketParts;for(;this._currentTileIndex<c.length;)if(g.getBucketParts(P,I,c[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,k())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,P.sort((z,U)=>z.sortKey-U.sortKey));this._currentPartIndex<P.length;){const z=P[this._currentPartIndex];if(g.placeLayerBucketPart(z,this._seenCrossTileIDs,w,z.symbolInstanceStart===0),this._currentPartIndex++,k())return!0}return!1}}class sh{constructor(c,g,w,I,k,P,z,U){this.placement=new nh(c,k,P,z,U),this._currentPlacementIndex=g.length-1,this._forceFullPlacement=w,this._showCollisionBoxes=I,this._done=!1}isDone(){return this._done}continuePlacement(c,g,w){const I=h.exported.now(),k=()=>{const P=h.exported.now()-I;return!this._forceFullPlacement&&P>2};for(;this._currentPlacementIndex>=0;){const P=g[c[this._currentPlacementIndex]],z=this.placement.collisionIndex.transform.zoom;if(P.type==="symbol"&&(!P.minzoom||P.minzoom<=z)&&(!P.maxzoom||P.maxzoom>z)){if(this._inProgressLayer||(this._inProgressLayer=new va(P)),this._inProgressLayer.continuePlacement(w[P.source],this.placement,this._showCollisionBoxes,P,k))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(c){return this.placement.commit(c),this.placement}}const Ll=512/h.EXTENT/2;class ah{constructor(c,g,w){this.tileID=c,this.indexedSymbolInstances={},this.bucketInstanceId=w;for(let I=0;I<g.length;I++){const k=g.get(I),P=k.key;this.indexedSymbolInstances[P]||(this.indexedSymbolInstances[P]=[]),this.indexedSymbolInstances[P].push({crossTileID:k.crossTileID,coord:this.getScaledCoordinates(k,c)})}}getScaledCoordinates(c,g){const w=Ll/Math.pow(2,g.canonical.z-this.tileID.canonical.z);return{x:Math.floor((g.canonical.x*h.EXTENT+c.tileAnchorX)*w),y:Math.floor((g.canonical.y*h.EXTENT+c.tileAnchorY)*w)}}findMatches(c,g,w){const I=this.tileID.canonical.z<g.canonical.z?1:Math.pow(2,this.tileID.canonical.z-g.canonical.z);for(let k=0;k<c.length;k++){const P=c.get(k);if(P.crossTileID)continue;const z=this.indexedSymbolInstances[P.key];if(!z)continue;const U=this.getScaledCoordinates(P,g);for(const q of z)if(Math.abs(q.coord.x-U.x)<=I&&Math.abs(q.coord.y-U.y)<=I&&!w[q.crossTileID]){w[q.crossTileID]=!0,P.crossTileID=q.crossTileID;break}}}}class zl{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class lh{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(c){const g=Math.round((c-this.lng)/360);if(g!==0)for(const w in this.indexes){const I=this.indexes[w],k={};for(const P in I){const z=I[P];z.tileID=z.tileID.unwrapTo(z.tileID.wrap+g),k[z.tileID.key]=z}this.indexes[w]=k}this.lng=c}addBucket(c,g,w){if(this.indexes[c.overscaledZ]&&this.indexes[c.overscaledZ][c.key]){if(this.indexes[c.overscaledZ][c.key].bucketInstanceId===g.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(c.overscaledZ,this.indexes[c.overscaledZ][c.key])}for(let k=0;k<g.symbolInstances.length;k++)g.symbolInstances.get(k).crossTileID=0;this.usedCrossTileIDs[c.overscaledZ]||(this.usedCrossTileIDs[c.overscaledZ]={});const I=this.usedCrossTileIDs[c.overscaledZ];for(const k in this.indexes){const P=this.indexes[k];if(Number(k)>c.overscaledZ)for(const z in P){const U=P[z];U.tileID.isChildOf(c)&&U.findMatches(g.symbolInstances,c,I)}else{const z=P[c.scaledTo(Number(k)).key];z&&z.findMatches(g.symbolInstances,c,I)}}for(let k=0;k<g.symbolInstances.length;k++){const P=g.symbolInstances.get(k);P.crossTileID||(P.crossTileID=w.generate(),I[P.crossTileID]=!0)}return this.indexes[c.overscaledZ]===void 0&&(this.indexes[c.overscaledZ]={}),this.indexes[c.overscaledZ][c.key]=new ah(c,g.symbolInstances,g.bucketInstanceId),!0}removeBucketCrossTileIDs(c,g){for(const w in g.indexedSymbolInstances)for(const I of g.indexedSymbolInstances[w])delete this.usedCrossTileIDs[c][I.crossTileID]}removeStaleBuckets(c){let g=!1;for(const w in this.indexes){const I=this.indexes[w];for(const k in I)c[I[k].bucketInstanceId]||(this.removeBucketCrossTileIDs(w,I[k]),delete I[k],g=!0)}return g}}class Ms{constructor(){this.layerIndexes={},this.crossTileIDs=new zl,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(c,g,w,I){let k=this.layerIndexes[c.id];k===void 0&&(k=this.layerIndexes[c.id]=new lh);let P=!1;const z={};I.name!=="globe"&&k.handleWrapJump(w);for(const U of g){const q=U.getBucket(c);q&&c.id===q.layerIds[0]&&(q.bucketInstanceId||(q.bucketInstanceId=++this.maxBucketInstanceId),k.addBucket(U.tileID,q,this.crossTileIDs)&&(P=!0),z[q.bucketInstanceId]=!0)}return k.removeStaleBuckets(z)&&(P=!0),P}pruneUnusedLayers(c){const g={};c.forEach(w=>{g[w]=!0});for(const w in this.layerIndexes)g[w]||delete this.layerIndexes[w]}}const No=(y,c)=>h.emitValidationErrors(y,c&&c.filter(g=>g.identifier!=="source.canvas")),Fl=h.pick(Mt,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Ol=h.pick(Mt,["setCenter","setZoom","setBearing","setPitch"]),Nl={version:8,layers:[],sources:{}},Yn={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class Ar extends h.Evented{constructor(c,g={}){super(),this.map=c,this.dispatcher=new nt(Yt(),this),this.imageManager=new he,this.imageManager.setEventedParent(this),this.glyphManager=new h.GlyphManager(c._requestManager,g.localFontFamily?h.LocalGlyphMode.all:g.localIdeographFontFamily?h.LocalGlyphMode.ideographs:h.LocalGlyphMode.none,g.localFontFamily||g.localIdeographFontFamily),this.lineAtlas=new h.LineAtlas(256,512),this.crossTileSymbolIndex=new Ms,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new h.ZoomHistory,this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",h.getReferrer());const w=this;this._rtlTextPluginCallback=Ar.registerForPluginStateChange(I=>{w.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:I.pluginStatus,pluginURL:I.pluginURL},(k,P)=>{if(h.triggerPluginCompletionEvent(k),P&&P.every(z=>z))for(const z in w._sourceCaches){const U=w._sourceCaches[z],q=U.getSource().type;q!=="vector"&&q!=="geojson"||U.reload()}})}),this.on("data",I=>{if(I.dataType!=="source"||I.sourceDataType!=="metadata")return;const k=this.getSource(I.sourceId);if(k&&k.vectorLayerIds)for(const P in this._layers){const z=this._layers[P];z.source===k.id&&this._validateLayer(z)}})}loadURL(c,g={}){this.fire(new h.Event("dataloading",{dataType:"style"}));const w=typeof g.validate=="boolean"?g.validate:!h.isMapboxURL(c);c=this.map._requestManager.normalizeStyleURL(c,g.accessToken);const I=this.map._requestManager.transformRequest(c,h.ResourceType.Style);this._request=h.getJSON(I,(k,P)=>{this._request=null,k?this.fire(new h.ErrorEvent(k)):P&&this._load(P,w)})}loadJSON(c,g={}){this.fire(new h.Event("dataloading",{dataType:"style"})),this._request=h.exported.frame(()=>{this._request=null,this._load(c,g.validate!==!1)})}loadEmpty(){this.fire(new h.Event("dataloading",{dataType:"style"})),this._load(Nl,!1)}_updateLayerCount(c,g){const w=g?1:-1;c.is3D()&&(this._num3DLayers+=w),c.type==="circle"&&(this._numCircleLayers+=w),c.type==="symbol"&&(this._numSymbolLayers+=w)}_load(c,g){if(g&&No(this,h.validateStyle(c)))return;this._loaded=!0,this.stylesheet=c,this._updateMapProjection();for(const I in c.sources)this.addSource(I,c.sources[I],{validate:!1});this._changed=!1,c.sprite?this._loadSprite(c.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(c.glyphs);const w=Ei(this.stylesheet.layers);this._order=w.map(I=>I.id),this._layers={},this._serializedLayers={};for(let I of w)I=h.createStyleLayer(I),I.setEventedParent(this,{layer:{id:I.id}}),this._layers[I.id]=I,this._serializedLayers[I.id]=I.serialize(),this._updateLayerCount(I,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new tt(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new h.Event("data",{dataType:"style"})),this.fire(new h.Event("style.load"))}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}setProjection(c){c?this.stylesheet.projection=c:delete this.stylesheet.projection,this.map._explicitProjection||this.map._updateProjection()}_updateMapProjection(){this.map._explicitProjection?this.applyProjectionUpdate():this.map._updateProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_loadSprite(c){this._spriteRequest=function(g,w,I){let k,P,z;const U=h.exported.devicePixelRatio>1?"@2x":"";let q=h.getJSON(w.transformRequest(w.normalizeSpriteURL(g,U,".json"),h.ResourceType.SpriteJSON),(ae,me)=>{q=null,z||(z=ae,k=me,ee())}),Z=h.getImage(w.transformRequest(w.normalizeSpriteURL(g,U,".png"),h.ResourceType.SpriteImage),(ae,me)=>{Z=null,z||(z=ae,P=me,ee())});function ee(){if(z)I(z);else if(k&&P){const ae=h.exported.getImageData(P),me={};for(const ue in k){const{width:oe,height:Me,x:ye,y:Ee,sdf:Te,pixelRatio:Se,stretchX:we,stretchY:ke,content:$e}=k[ue],qe=new h.RGBAImage({width:oe,height:Me});h.RGBAImage.copy(ae,qe,{x:ye,y:Ee},{x:0,y:0},{width:oe,height:Me}),me[ue]={data:qe,pixelRatio:Se,sdf:Te,stretchX:we,stretchY:ke,content:$e}}I(null,me)}}return{cancel(){q&&(q.cancel(),q=null),Z&&(Z.cancel(),Z=null)}}}(c,this.map._requestManager,(g,w)=>{if(this._spriteRequest=null,g)this.fire(new h.ErrorEvent(g));else if(w)for(const I in w)this.imageManager.addImage(I,w[I]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new h.Event("data",{dataType:"style"}))})}_validateLayer(c){const g=this.getSource(c.source);if(!g)return;const w=c.sourceLayer;w&&(g.type==="geojson"||g.vectorLayerIds&&g.vectorLayerIds.indexOf(w)===-1)&&this.fire(new h.ErrorEvent(new Error(`Source layer "${w}" does not exist on source "${g.id}" as specified by style layer "${c.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const c in this._sourceCaches)if(!this._sourceCaches[c].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(c){const g=[];for(const w of c){const I=this._layers[w];I.type!=="custom"&&g.push(I.serialize())}return g}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const c in this._sourceCaches)if(this._sourceCaches[c].hasTransition())return!0;for(const c in this._layers)if(this._layers[c].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(c){return!!this.terrain&&Yn[c.type]}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(c){if(!this._loaded)return;const g=this._changed;if(this._changed){const I=Object.keys(this._updatedLayers),k=Object.keys(this._removedLayers);(I.length||k.length)&&this._updateWorkerLayers(I,k);for(const P in this._updatedSources){const z=this._updatedSources[P];z==="reload"?this._reloadSource(P):z==="clear"&&this._clearSource(P)}this._updateTilesForChangedImages();for(const P in this._updatedPaintProps)this._layers[P].updateTransitions(c);this.light.updateTransitions(c),this.fog&&this.fog.updateTransitions(c),this._resetUpdates()}const w={};for(const I in this._sourceCaches){const k=this._sourceCaches[I];w[I]=k.used,k.used=!1}for(const I of this._order){const k=this._layers[I];if(k.recalculate(c,this._availableImages),!k.isHidden(c.zoom)){const z=this._getLayerSourceCache(k);z&&(z.used=!0)}const P=this.map.painter;if(P){const z=k.getProgramIds();if(!z)continue;const U=k.getProgramConfiguration(c.zoom);for(const q of z)P.useProgram(q,U)}}for(const I in w){const k=this._sourceCaches[I];w[I]!==k.used&&k.getSource().fire(new h.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:k.getSource().id}))}this.light.recalculate(c),this.terrain&&this.terrain.recalculate(c),this.fog&&this.fog.recalculate(c),this.z=c.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),g&&this.fire(new h.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const c=Object.keys(this._changedImages);if(c.length){for(const g in this._sourceCaches)this._sourceCaches[g].reloadTilesForDependencies(["icons","patterns"],c);this._changedImages={}}}_updateWorkerLayers(c,g){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(c),removedIds:g})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(c){if(this._checkLoaded(),No(this,h.validateStyle(c)))return!1;(c=h.clone$1(c)).layers=Ei(c.layers);const g=function(I,k){if(!I)return[{command:Mt.setStyle,args:[k]}];let P=[];try{if(!L(I.version,k.version))return[{command:Mt.setStyle,args:[k]}];L(I.center,k.center)||P.push({command:Mt.setCenter,args:[k.center]}),L(I.zoom,k.zoom)||P.push({command:Mt.setZoom,args:[k.zoom]}),L(I.bearing,k.bearing)||P.push({command:Mt.setBearing,args:[k.bearing]}),L(I.pitch,k.pitch)||P.push({command:Mt.setPitch,args:[k.pitch]}),L(I.sprite,k.sprite)||P.push({command:Mt.setSprite,args:[k.sprite]}),L(I.glyphs,k.glyphs)||P.push({command:Mt.setGlyphs,args:[k.glyphs]}),L(I.transition,k.transition)||P.push({command:Mt.setTransition,args:[k.transition]}),L(I.light,k.light)||P.push({command:Mt.setLight,args:[k.light]}),L(I.fog,k.fog)||P.push({command:Mt.setFog,args:[k.fog]}),L(I.projection,k.projection)||P.push({command:Mt.setProjection,args:[k.projection]});const z={},U=[];(function(ee,ae,me,ue){let oe;for(oe in ae=ae||{},ee=ee||{})ee.hasOwnProperty(oe)&&(ae.hasOwnProperty(oe)||Ii(oe,me,ue));for(oe in ae)ae.hasOwnProperty(oe)&&(ee.hasOwnProperty(oe)?L(ee[oe],ae[oe])||(ee[oe].type==="geojson"&&ae[oe].type==="geojson"&&_n(ee,ae,oe)?me.push({command:Mt.setGeoJSONSourceData,args:[oe,ae[oe].data]}):Zr(oe,ae,me,ue)):Si(oe,ae,me))})(I.sources,k.sources,U,z);const q=[];I.layers&&I.layers.forEach(ee=>{ee.source&&z[ee.source]?P.push({command:Mt.removeLayer,args:[ee.id]}):q.push(ee)});let Z=I.terrain;Z&&z[Z.source]&&(P.push({command:Mt.setTerrain,args:[void 0]}),Z=void 0),P=P.concat(U),L(Z,k.terrain)||P.push({command:Mt.setTerrain,args:[k.terrain]}),function(ee,ae,me){ae=ae||[];const ue=(ee=ee||[]).map(Ti),oe=ae.map(Ti),Me=ee.reduce(yi,{}),ye=ae.reduce(yi,{}),Ee=ue.slice(),Te=Object.create(null);let Se,we,ke,$e,qe,He,Ye;for(Se=0,we=0;Se<ue.length;Se++)ke=ue[Se],ye.hasOwnProperty(ke)?we++:(me.push({command:Mt.removeLayer,args:[ke]}),Ee.splice(Ee.indexOf(ke,we),1));for(Se=0,we=0;Se<oe.length;Se++)ke=oe[oe.length-1-Se],Ee[Ee.length-1-Se]!==ke&&(Me.hasOwnProperty(ke)?(me.push({command:Mt.removeLayer,args:[ke]}),Ee.splice(Ee.lastIndexOf(ke,Ee.length-we),1)):we++,He=Ee[Ee.length-Se],me.push({command:Mt.addLayer,args:[ye[ke],He]}),Ee.splice(Ee.length-Se,0,ke),Te[ke]=!0);for(Se=0;Se<oe.length;Se++)if(ke=oe[Se],$e=Me[ke],qe=ye[ke],!Te[ke]&&!L($e,qe))if(L($e.source,qe.source)&&L($e["source-layer"],qe["source-layer"])&&L($e.type,qe.type)){for(Ye in yt($e.layout,qe.layout,me,ke,null,Mt.setLayoutProperty),yt($e.paint,qe.paint,me,ke,null,Mt.setPaintProperty),L($e.filter,qe.filter)||me.push({command:Mt.setFilter,args:[ke,qe.filter]}),L($e.minzoom,qe.minzoom)&&L($e.maxzoom,qe.maxzoom)||me.push({command:Mt.setLayerZoomRange,args:[ke,qe.minzoom,qe.maxzoom]}),$e)$e.hasOwnProperty(Ye)&&Ye!=="layout"&&Ye!=="paint"&&Ye!=="filter"&&Ye!=="metadata"&&Ye!=="minzoom"&&Ye!=="maxzoom"&&(Ye.indexOf("paint.")===0?yt($e[Ye],qe[Ye],me,ke,Ye.slice(6),Mt.setPaintProperty):L($e[Ye],qe[Ye])||me.push({command:Mt.setLayerProperty,args:[ke,Ye,qe[Ye]]}));for(Ye in qe)qe.hasOwnProperty(Ye)&&!$e.hasOwnProperty(Ye)&&Ye!=="layout"&&Ye!=="paint"&&Ye!=="filter"&&Ye!=="metadata"&&Ye!=="minzoom"&&Ye!=="maxzoom"&&(Ye.indexOf("paint.")===0?yt($e[Ye],qe[Ye],me,ke,Ye.slice(6),Mt.setPaintProperty):L($e[Ye],qe[Ye])||me.push({command:Mt.setLayerProperty,args:[ke,Ye,qe[Ye]]}))}else me.push({command:Mt.removeLayer,args:[ke]}),He=Ee[Ee.lastIndexOf(ke)+1],me.push({command:Mt.addLayer,args:[qe,He]})}(q,k.layers,P)}catch(z){console.warn("Unable to compute style diff:",z),P=[{command:Mt.setStyle,args:[k]}]}return P}(this.serialize(),c).filter(I=>!(I.command in Ol));if(g.length===0)return!1;const w=g.filter(I=>!(I.command in Fl));if(w.length>0)throw new Error(`Unimplemented: ${w.map(I=>I.command).join(", ")}.`);return g.forEach(I=>{I.command!=="setTransition"&&this[I.command].apply(this,I.args)}),this.stylesheet=c,this._updateMapProjection(),!0}addImage(c,g){return this.getImage(c)?this.fire(new h.ErrorEvent(new Error("An image with this name already exists."))):(this.imageManager.addImage(c,g),this._afterImageUpdated(c),this)}updateImage(c,g){this.imageManager.updateImage(c,g)}getImage(c){return this.imageManager.getImage(c)}removeImage(c){return this.getImage(c)?(this.imageManager.removeImage(c),this._afterImageUpdated(c),this):this.fire(new h.ErrorEvent(new Error("No image with this name exists.")))}_afterImageUpdated(c){this._availableImages=this.imageManager.listImages(),this._changedImages[c]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new h.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(c,g,w={}){if(this._checkLoaded(),this.getSource(c)!==void 0)throw new Error("There is already a source with this ID");if(!g.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(g).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(g.type)>=0&&this._validate(h.validateSource,`sources.${c}`,g,null,w))return;this.map&&this.map._collectResourceTiming&&(g.collectResourceTiming=!0);const I=Le(c,g,this.dispatcher,this);I.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(c),source:I.serialize(),sourceId:c}));const k=P=>{const z=(P?"symbol:":"other:")+c,U=this._sourceCaches[z]=new h.SourceCache(z,I,P);(P?this._symbolSourceCaches:this._otherSourceCaches)[c]=U,U.style=this,U.onAdd(this.map)};k(!1),g.type!=="vector"&&g.type!=="geojson"||k(!0),I.onAdd&&I.onAdd(this.map),this._changed=!0}removeSource(c){this._checkLoaded();const g=this.getSource(c);if(!g)throw new Error("There is no source with this ID");for(const I in this._layers)if(this._layers[I].source===c)return this.fire(new h.ErrorEvent(new Error(`Source "${c}" cannot be removed while layer "${I}" is using it.`)));if(this.terrain&&this.terrain.get().source===c)return this.fire(new h.ErrorEvent(new Error(`Source "${c}" cannot be removed while terrain is using it.`)));const w=this._getSourceCaches(c);for(const I of w)delete this._sourceCaches[I.id],delete this._updatedSources[I.id],I.fire(new h.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:I.getSource().id})),I.setEventedParent(null),I.clearTiles();return delete this._otherSourceCaches[c],delete this._symbolSourceCaches[c],g.setEventedParent(null),g.onRemove&&g.onRemove(this.map),this._changed=!0,this}setGeoJSONSourceData(c,g){this._checkLoaded(),this.getSource(c).setData(g),this._changed=!0}getSource(c){const g=this._getSourceCache(c);return g&&g.getSource()}addLayer(c,g,w={}){this._checkLoaded();const I=c.id;if(this.getLayer(I))return void this.fire(new h.ErrorEvent(new Error(`Layer with id "${I}" already exists on this map`)));let k;if(c.type==="custom"){if(No(this,h.validateCustomStyleLayer(c)))return;k=h.createStyleLayer(c)}else{if(typeof c.source=="object"&&(this.addSource(I,c.source),c=h.clone$1(c),c=h.extend(c,{source:I})),this._validate(h.validateLayer,`layers.${I}`,c,{arrayIndex:-1},w))return;k=h.createStyleLayer(c),this._validateLayer(k),k.setEventedParent(this,{layer:{id:I}}),this._serializedLayers[k.id]=k.serialize(),this._updateLayerCount(k,!0)}const P=g?this._order.indexOf(g):this._order.length;if(g&&P===-1)return void this.fire(new h.ErrorEvent(new Error(`Layer with id "${g}" does not exist on this map.`)));this._order.splice(P,0,I),this._layerOrderChanged=!0,this._layers[I]=k;const z=this._getLayerSourceCache(k);if(this._removedLayers[I]&&k.source&&z&&k.type!=="custom"){const U=this._removedLayers[I];delete this._removedLayers[I],U.type!==k.type?this._updatedSources[k.source]="clear":(this._updatedSources[k.source]="reload",z.pause())}this._updateLayer(k),k.onAdd&&k.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(c,g){if(this._checkLoaded(),this._changed=!0,!this._layers[c])return void this.fire(new h.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be moved.`)));if(c===g)return;const w=this._order.indexOf(c);this._order.splice(w,1);const I=g?this._order.indexOf(g):this._order.length;g&&I===-1?this.fire(new h.ErrorEvent(new Error(`Layer with id "${g}" does not exist on this map.`))):(this._order.splice(I,0,c),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(c){this._checkLoaded();const g=this._layers[c];if(!g)return void this.fire(new h.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be removed.`)));g.setEventedParent(null),this._updateLayerCount(g,!1);const w=this._order.indexOf(c);this._order.splice(w,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[c]=g,delete this._layers[c],delete this._serializedLayers[c],delete this._updatedLayers[c],delete this._updatedPaintProps[c],g.onRemove&&g.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(c){return this._layers[c]}hasLayer(c){return c in this._layers}hasLayerType(c){for(const g in this._layers)if(this._layers[g].type===c)return!0;return!1}setLayerZoomRange(c,g,w){this._checkLoaded();const I=this.getLayer(c);I?I.minzoom===g&&I.maxzoom===w||(g!=null&&(I.minzoom=g),w!=null&&(I.maxzoom=w),this._updateLayer(I)):this.fire(new h.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(c,g,w={}){this._checkLoaded();const I=this.getLayer(c);if(I){if(!L(I.filter,g))return g==null?(I.filter=void 0,void this._updateLayer(I)):void(this._validate(h.validateFilter,`layers.${I.id}.filter`,g,{layerType:I.type},w)||(I.filter=h.clone$1(g),this._updateLayer(I)))}else this.fire(new h.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be filtered.`)))}getFilter(c){const g=this.getLayer(c);return g&&h.clone$1(g.filter)}setLayoutProperty(c,g,w,I={}){this._checkLoaded();const k=this.getLayer(c);k?L(k.getLayoutProperty(g),w)||(k.setLayoutProperty(g,w,I),this._updateLayer(k)):this.fire(new h.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(c,g){const w=this.getLayer(c);if(w)return w.getLayoutProperty(g);this.fire(new h.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style.`)))}setPaintProperty(c,g,w,I={}){this._checkLoaded();const k=this.getLayer(c);k?L(k.getPaintProperty(g),w)||(k.setPaintProperty(g,w,I)&&this._updateLayer(k),this._changed=!0,this._updatedPaintProps[c]=!0):this.fire(new h.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(c,g){const w=this.getLayer(c);return w&&w.getPaintProperty(g)}setFeatureState(c,g){this._checkLoaded();const w=c.source,I=c.sourceLayer,k=this.getSource(w);if(!k)return void this.fire(new h.ErrorEvent(new Error(`The source '${w}' does not exist in the map's style.`)));const P=k.type;if(P==="geojson"&&I)return void this.fire(new h.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(P==="vector"&&!I)return void this.fire(new h.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));c.id===void 0&&this.fire(new h.ErrorEvent(new Error("The feature id parameter must be provided.")));const z=this._getSourceCaches(w);for(const U of z)U.setFeatureState(I,c.id,g)}removeFeatureState(c,g){this._checkLoaded();const w=c.source,I=this.getSource(w);if(!I)return void this.fire(new h.ErrorEvent(new Error(`The source '${w}' does not exist in the map's style.`)));const k=I.type,P=k==="vector"?c.sourceLayer:void 0;if(k==="vector"&&!P)return void this.fire(new h.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(g&&typeof c.id!="string"&&typeof c.id!="number")return void this.fire(new h.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const z=this._getSourceCaches(w);for(const U of z)U.removeFeatureState(P,c.id,g)}getFeatureState(c){this._checkLoaded();const g=c.source,w=c.sourceLayer,I=this.getSource(g);if(I){if(I.type!=="vector"||w)return c.id===void 0&&this.fire(new h.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(g)[0].getFeatureState(w,c.id);this.fire(new h.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new h.ErrorEvent(new Error(`The source '${g}' does not exist in the map's style.`)))}getTransition(){return h.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const c={};for(const g in this._sourceCaches){const w=this._sourceCaches[g].getSource();c[w.id]||(c[w.id]=w.serialize())}return h.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.stylesheet.terrain,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:c,layers:this._serializeLayers(this._order)},g=>g!==void 0)}_updateLayer(c){this._updatedLayers[c.id]=!0;const g=this._getLayerSourceCache(c);c.source&&!this._updatedSources[c.source]&&g&&g.getSource().type!=="raster"&&(this._updatedSources[c.source]="reload",g.pause()),this._changed=!0,c.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(c){const g=P=>this._layers[P].type==="fill-extrusion",w={},I=[];for(let P=this._order.length-1;P>=0;P--){const z=this._order[P];if(g(z)){w[z]=P;for(const U of c){const q=U[z];if(q)for(const Z of q)I.push(Z)}}}I.sort((P,z)=>z.intersectionZ-P.intersectionZ);const k=[];for(let P=this._order.length-1;P>=0;P--){const z=this._order[P];if(g(z))for(let U=I.length-1;U>=0;U--){const q=I[U].feature;if(w[q.layer.id]<P)break;k.push(q),I.pop()}else for(const U of c){const q=U[z];if(q)for(const Z of q)k.push(Z.feature)}}return k}queryRenderedFeatures(c,g,w){g&&g.filter&&this._validate(h.validateFilter,"queryRenderedFeatures.filter",g.filter,null,g);const I={};if(g&&g.layers){if(!Array.isArray(g.layers))return this.fire(new h.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const U of g.layers){const q=this._layers[U];if(!q)return this.fire(new h.ErrorEvent(new Error(`The layer '${U}' does not exist in the map's style and cannot be queried for features.`))),[];I[q.source]=!0}}const k=[];g.availableImages=this._availableImages;const P=g&&g.layers?g.layers.some(U=>{const q=this.getLayer(U);return q&&q.is3D()}):this.has3DLayers(),z=ft.createFromScreenPoints(c,w);for(const U in this._sourceCaches){const q=this._sourceCaches[U].getSource().id;g.layers&&!I[q]||k.push(Ve(this._sourceCaches[U],this._layers,this._serializedLayers,z,g,w,P,!!this.map._showQueryGeometry))}return this.placement&&k.push(function(U,q,Z,ee,ae,me,ue){const oe={},Me=me.queryRenderedSymbols(ee),ye=[];for(const Ee of Object.keys(Me).map(Number))ye.push(ue[Ee]);ye.sort(ct);for(const Ee of ye){const Te=Ee.featureIndex.lookupSymbolFeatures(Me[Ee.bucketInstanceId],q,Ee.bucketIndex,Ee.sourceLayerIndex,ae.filter,ae.layers,ae.availableImages,U);for(const Se in Te){const we=oe[Se]=oe[Se]||[],ke=Te[Se];ke.sort(($e,qe)=>{const He=Ee.featureSortOrder;if(He){const Ye=He.indexOf($e.featureIndex);return He.indexOf(qe.featureIndex)-Ye}return qe.featureIndex-$e.featureIndex});for(const $e of ke)we.push($e)}}for(const Ee in oe)oe[Ee].forEach(Te=>{const Se=Te.feature,we=Z(U[Ee]).getFeatureState(Se.layer["source-layer"],Se.id);Se.source=Se.layer.source,Se.layer["source-layer"]&&(Se.sourceLayer=Se.layer["source-layer"]),Se.state=we});return oe}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),z.screenGeometry,g,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(k)}querySourceFeatures(c,g){g&&g.filter&&this._validate(h.validateFilter,"querySourceFeatures.filter",g.filter,null,g);const w=this._getSourceCaches(c);let I=[];for(const k of w)I=I.concat(Ke(k,g));return I}addSourceType(c,g,w){return Ar.getSourceType(c)?w(new Error(`A source type called "${c}" already exists.`)):(Ar.setSourceType(c,g),g.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:c,url:g.workerSourceURL},w):w(null,null))}getLight(){return this.light.getLight()}setLight(c,g={}){this._checkLoaded();const w=this.light.getLight();let I=!1;for(const P in c)if(!L(c[P],w[P])){I=!0;break}if(!I)return;const k={now:h.exported.now(),transition:h.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(c,g),this.light.updateTransitions(k)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(c,g=1){if(this._checkLoaded(),!c)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(g===1){if(typeof c.source=="object"){const w="terrain-dem-src";this.addSource(w,c.source),c=h.clone$1(c),c=h.extend(c,{source:w})}if(this._validate(h.validateTerrain,"terrain",c))return}if(!this.terrain||this.terrain&&g!==this.terrain.drapeRenderMode)this._createTerrain(c,g);else{const w=this.terrain,I=w.get();for(const k in c)if(!L(c[k],I[k])){w.set(c),this.stylesheet.terrain=c;const P={now:h.exported.now(),transition:h.extend({duration:0},this.stylesheet.transition)};w.updateTransitions(P);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(c){const g=this.fog=new Jt(c,this.map.transform);this.stylesheet.fog=c;const w={now:h.exported.now(),transition:h.extend({duration:0},this.stylesheet.transition)};g.updateTransitions(w)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const c of this.map._markers)c._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(c){if(this._checkLoaded(),!c)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const g=this.fog,w=g.get();for(const I in c)if(!L(c[I],w[I])){g.set(c),this.stylesheet.fog=c;const k={now:h.exported.now(),transition:h.extend({duration:0},this.stylesheet.transition)};g.updateTransitions(k);break}}else this._createFog(c);this._markersNeedUpdate=!0}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const c=this._order.filter(w=>this.isLayerDraped(this._layers[w])),g=this._order.filter(w=>!this.isLayerDraped(this._layers[w]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...c),this._drapedFirstOrder.push(...g)}_createTerrain(c,g){const w=this.terrain=new Rt(c,g);this.stylesheet.terrain=c,this.dispatcher.broadcast("enableTerrain",!this.terrainSetForDrapingOnly()),this._force3DLayerUpdate();const I={now:h.exported.now(),transition:h.extend({duration:0},this.stylesheet.transition)};w.updateTransitions(I)}_force3DLayerUpdate(){for(const c in this._layers){const g=this._layers[c];g.type==="fill-extrusion"&&this._updateLayer(g)}}_forceSymbolLayerUpdate(){for(const c in this._layers){const g=this._layers[c];g.type==="symbol"&&this._updateLayer(g)}}_validate(c,g,w,I,k={}){return(!k||k.validate!==!1)&&No(this,c.call(h.validateStyle,h.extend({key:g,style:this.serialize(),value:w,styleSpec:h.spec},I)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),h.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const c in this._layers)this._layers[c].setEventedParent(null);for(const c in this._sourceCaches)this._sourceCaches[c].clearTiles(),this._sourceCaches[c].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(c){const g=this._getSourceCaches(c);for(const w of g)w.clearTiles()}_reloadSource(c){const g=this._getSourceCaches(c);for(const w of g)w.resume(),w.reload()}_updateSources(c){for(const g in this._sourceCaches)this._sourceCaches[g].update(c)}_generateCollisionBoxes(){for(const c in this._sourceCaches){const g=this._sourceCaches[c];g.resume(),g.reload()}}_updatePlacement(c,g,w,I,k=!1){let P=!1,z=!1;const U={};for(const q of this._order){const Z=this._layers[q];if(Z.type!=="symbol")continue;if(!U[Z.source]){const ae=this._getLayerSourceCache(Z);if(!ae)continue;U[Z.source]=ae.getRenderableIds(!0).map(me=>ae.getTileByID(me)).sort((me,ue)=>ue.tileID.overscaledZ-me.tileID.overscaledZ||(me.tileID.isLessThan(ue.tileID)?-1:1))}const ee=this.crossTileSymbolIndex.addLayer(Z,U[Z.source],c.center.lng,c.projection);P=P||ee}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),k=k||this._layerOrderChanged||w===0,this._layerOrderChanged&&this.fire(new h.Event("neworder")),(k||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(h.exported.now(),c.zoom))&&(this.pauseablePlacement=new sh(c,this._order,k,g,w,I,this.placement,this.fog&&c.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,U),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(h.exported.now()),z=!0),P&&this.pauseablePlacement.placement.setStale()),z||P)for(const q of this._order){const Z=this._layers[q];Z.type==="symbol"&&this.placement.updateLayerOpacities(Z,U[Z.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(h.exported.now())}_releaseSymbolFadeTiles(){for(const c in this._sourceCaches)this._sourceCaches[c].releaseSymbolFadeTiles()}getImages(c,g,w){this.imageManager.getImages(g.icons,w),this._updateTilesForChangedImages();const I=k=>{k&&k.setDependencies(g.tileID.key,g.type,g.icons)};I(this._otherSourceCaches[g.source]),I(this._symbolSourceCaches[g.source])}getGlyphs(c,g,w){this.glyphManager.getGlyphs(g.stacks,w)}getResource(c,g,w){return h.makeRequest(g,w)}_getSourceCache(c){return this._otherSourceCaches[c]}_getLayerSourceCache(c){return c.type==="symbol"?this._symbolSourceCaches[c.source]:this._otherSourceCaches[c.source]}_getSourceCaches(c){const g=[];return this._otherSourceCaches[c]&&g.push(this._otherSourceCaches[c]),this._symbolSourceCaches[c]&&g.push(this._symbolSourceCaches[c]),g}_isSourceCacheLoaded(c){const g=this._getSourceCaches(c);return g.length===0?(this.fire(new h.ErrorEvent(new Error(`There is no source with ID '${c}'`))),!1):g.every(w=>w.loaded())}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Ar.getSourceType=function(y){return Be[y]},Ar.setSourceType=function(y,c){Be[y]=c},Ar.registerForPluginStateChange=h.registerForPluginStateChange;var $o=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#define HALF_PI PI/2.0
#define QUARTER_PI PI/4.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}
#endif`,Uo="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}";let Wn={},kn={};Wn=Zt("",`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform sampler2D u_dem;uniform sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {return currentElevation(apos);}
#endif
float unpack_depth(vec4 rgba_depth)
{const vec4 bit_shift=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,!0),kn=Zt(`#ifdef FOG
uniform float u_fog_temporal_offset;float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,`#ifdef FOG
uniform mat4 u_fog_matrix;vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,!0);const Ss=Zt(`
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef TERRAIN
highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(256.0*256.0*256.0,256.0*256.0,256.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/256.0,1.0/256.0,1.0/256.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#endif`,`
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),Vo=$o;var jo={background:Zt(`uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Zt(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:Zt(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
vec2 scaled_extrude=extrude*a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=scaled_extrude.x*surface_vectors[0]+scaled_extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);vec4 world_center=vec4(pos,1);
#else 
mat3 surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);vec4 world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
#if defined(SCALE_WITH_MAP) && defined(PROJECTION_GLOBE_VIEW)
view_scale*=a_scale;
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);vec4 occlusion_world_center=vec4(circle_center,cantilevered_height,1);vec4 occlusion_projected_center=u_matrix*occlusion_world_center;
#else
vec4 occlusion_world_center=world_center;vec4 occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Zt("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Zt(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
extrude*=a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
vec3 pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Zt(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Zt("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Zt("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Zt("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",`attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;
#endif
varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:Zt(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:Zt(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Zt(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Zt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Zt(`varying vec4 v_color;void main() {vec4 color=v_color;
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 pos=vec3(pos_nx.xy,h);
#else
vec3 pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(pos.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionPattern:Zt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 p=vec3(pos_nx.xy,h);
#else
vec3 p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),hillshadePrepare:Zt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Zt(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Zt(`uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
#ifdef RENDER_LINE_GRADIENT
vec4 out_color=texture2D(u_gradient_image,v_uv);
#else
vec4 out_color=color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef RENDER_LINE_ALPHA_DISCARD
if (alpha < u_alpha_discard_threshold) {discard;}
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#ifdef RENDER_LINE_GRADIENT
attribute vec3 a_packed;
#else
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_GRADIENT
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];float a_linesofar=a_packed[2];highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);
#endif
#ifdef RENDER_LINE_DASH
float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:Zt(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:Zt(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:Zt(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchor_z=a_z_tile_anchor.x;vec2 tile_anchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchor_z)+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;float globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
vec3 world_pos=vec3(a_pos,anchor_z)+h;float globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point=u_matrix*vec4(a_pos+vec2(1,0),anchor_z,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchor_z),mercator_pos,u_zoom_transition);
#else
vec3 proj_pos=vec3(a_projected_pos.xy,anchor_z);
#endif
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}`),symbolSDF:Zt(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchor_z=a_z_tile_anchor.x;vec2 tile_anchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchor_z)+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;float globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
vec3 world_pos=vec3(a_pos,anchor_z)+h;float globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point=u_matrix*vec4(a_pos+vec2(1,0),anchor_z,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchor_z),mercator_pos,u_zoom_transition);
#else
vec3 proj_pos=vec3(a_projected_pos.xy,anchor_z);
#endif
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}`),symbolTextAndIcon:Zt(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchor_z=a_z_tile_anchor.x;vec2 tile_anchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchor_z)+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;float globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
vec3 world_pos=vec3(a_pos,anchor_z)+h;float globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),anchor_z,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchor_z),mercator_pos,u_zoom_transition);
#else
vec3 proj_pos=vec3(a_projected_pos.xy,anchor_z);
#endif
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}`),terrainRaster:Zt(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
void main() {vec4 color=texture2D(u_image0,v_pos0);
#ifdef FOG
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
const float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;
#ifdef TERRAIN_WIREFRAME
elevation+=u_skirt_height*u_skirt_height*wireframeOffset;
#endif
vec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
}`),terrainDepth:Zt(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:Zt(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Uo),skyboxGradient:Zt(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Uo),skyboxCapture:Zt(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Zt(`uniform sampler2D u_image0;varying vec2 v_pos0;void main() {gl_FragColor=texture2D(u_image0,v_pos0);
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_proj_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;
#ifdef GLOBE_POLES
attribute vec3 a_globe_pos;attribute vec2 a_merc_pos;attribute vec2 a_uv;
#else
attribute vec2 a_pos;
#endif
varying vec2 v_pos0;const float wireframeOffset=1e3;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 merc_pos=a_merc_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idy=u_grid_matrix[1][2];float S=u_grid_matrix[2][2];vec3 latLng=u_grid_matrix*vec3(a_pos,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=a_pos[0]*S;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;uv=uv*EXTENT;vec4 up_vector=vec4(elevationVector(uv),1.0);float height=elevation(uv);
#ifdef TERRAIN_WIREFRAME
height+=wireframeOffset;
#endif
vec4 globe=u_globe_matrix*vec4(globe_pos+up_vector.xyz*height,1.0);vec4 mercator=vec4(0.0);if (u_zoom_transition > 0.0) {mercator=vec4(merc_pos,height,1.0);mercator.xy-=u_merc_center;mercator.x=wrap(mercator.x,-0.5,0.5);mercator=u_merc_matrix*mercator;}vec3 position=mix(globe.xyz,mercator.xyz,u_zoom_transition);gl_Position=u_proj_matrix*vec4(position,1.0);}`),globeAtmosphere:Zt(`uniform float u_opacity;uniform highp float u_fadeout_range;uniform vec3 u_start_color;uniform vec3 u_end_color;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;varying highp vec3 v_ray_dir;void main() {highp vec3 dir=normalize(v_ray_dir);highp vec3 closest_point=abs(dot(u_globe_pos,dir))*dir;float norm_dist_from_center=length(closest_point-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 1.0)
discard;float t=clamp(1.0-sqrt(norm_dist_from_center-1.0)/u_fadeout_range,0.0,1.0);vec3 color=mix(u_start_color,u_end_color,1.0-t);gl_FragColor=vec4(color*t*u_opacity,u_opacity);}`,"attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;varying highp vec3 v_ray_dir;void main() {v_ray_dir=mix(mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);gl_Position=vec4(a_pos,1.0);}")};function Zt(y,c,g){const w=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,I=/uniform (highp |mediump |lowp )?([\w]+) ([\w]+)([\s]*)([\w]*)/g,k=c.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),P=y.match(I),z=c.match(I),U=$o.match(I);let q=z?z.concat(P):P;g||(Wn.staticUniforms&&(q=Wn.staticUniforms.concat(q)),kn.staticUniforms&&(q=kn.staticUniforms.concat(q))),q&&(q=q.concat(U));const Z={};return{fragmentSource:y=y.replace(w,(ee,ae,me,ue,oe)=>(Z[oe]=!0,ae==="define"?`
#ifndef HAS_UNIFORM_u_${oe}
varying ${me} ${ue} ${oe};
#else
uniform ${me} ${ue} u_${oe};
#endif
`:`
#ifdef HAS_UNIFORM_u_${oe}
    ${me} ${ue} ${oe} = u_${oe};
#endif
`)),vertexSource:c=c.replace(w,(ee,ae,me,ue,oe)=>{const Me=ue==="float"?"vec2":"vec4",ye=oe.match(/color/)?"color":Me;return Z[oe]?ae==="define"?`
#ifndef HAS_UNIFORM_u_${oe}
uniform lowp float u_${oe}_t;
attribute ${me} ${Me} a_${oe};
varying ${me} ${ue} ${oe};
#else
uniform ${me} ${ue} u_${oe};
#endif
`:ye==="vec4"?`
#ifndef HAS_UNIFORM_u_${oe}
    ${oe} = a_${oe};
#else
    ${me} ${ue} ${oe} = u_${oe};
#endif
`:`
#ifndef HAS_UNIFORM_u_${oe}
    ${oe} = unpack_mix_${ye}(a_${oe}, u_${oe}_t);
#else
    ${me} ${ue} ${oe} = u_${oe};
#endif
`:ae==="define"?`
#ifndef HAS_UNIFORM_u_${oe}
uniform lowp float u_${oe}_t;
attribute ${me} ${Me} a_${oe};
#else
uniform ${me} ${ue} u_${oe};
#endif
`:ye==="vec4"?`
#ifndef HAS_UNIFORM_u_${oe}
    ${me} ${ue} ${oe} = a_${oe};
#else
    ${me} ${ue} ${oe} = u_${oe};
#endif
`:`
#ifndef HAS_UNIFORM_u_${oe}
    ${me} ${ue} ${oe} = unpack_mix_${ye}(a_${oe}, u_${oe}_t);
#else
    ${me} ${ue} ${oe} = u_${oe};
#endif
`}),staticAttributes:k,staticUniforms:q}}class As{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(c,g,w,I,k,P,z,U){this.context=c;let q=this.boundPaintVertexBuffers.length!==I.length;for(let Z=0;!q&&Z<I.length;Z++)this.boundPaintVertexBuffers[Z]!==I[Z]&&(q=!0);c.extVertexArrayObject&&this.vao&&this.boundProgram===g&&this.boundLayoutVertexBuffer===w&&!q&&this.boundIndexBuffer===k&&this.boundVertexOffset===P&&this.boundDynamicVertexBuffer===z&&this.boundDynamicVertexBuffer2===U?(c.bindVertexArrayOES.set(this.vao),z&&z.bind(),k&&k.dynamicDraw&&k.bind(),U&&U.bind()):this.freshBind(g,w,I,k,P,z,U)}freshBind(c,g,w,I,k,P,z){let U;const q=c.numAttributes,Z=this.context,ee=Z.gl;if(Z.extVertexArrayObject)this.vao&&this.destroy(),this.vao=Z.extVertexArrayObject.createVertexArrayOES(),Z.bindVertexArrayOES.set(this.vao),U=0,this.boundProgram=c,this.boundLayoutVertexBuffer=g,this.boundPaintVertexBuffers=w,this.boundIndexBuffer=I,this.boundVertexOffset=k,this.boundDynamicVertexBuffer=P,this.boundDynamicVertexBuffer2=z;else{U=Z.currentNumAttributes||0;for(let ae=q;ae<U;ae++)ee.disableVertexAttribArray(ae)}g.enableAttributes(ee,c);for(const ae of w)ae.enableAttributes(ee,c);P&&P.enableAttributes(ee,c),z&&z.enableAttributes(ee,c),g.bind(),g.setVertexAttribPointers(ee,c,k);for(const ae of w)ae.bind(),ae.setVertexAttribPointers(ee,c,k);P&&(P.bind(),P.setVertexAttribPointers(ee,c,k)),I&&I.bind(),z&&(z.bind(),z.setVertexAttribPointers(ee,c,k)),Z.currentNumAttributes=q}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function $l(y,c){const g=Math.pow(2,c.canonical.z),w=c.canonical.y;return[new h.MercatorCoordinate(0,w/g).toLngLat().lat,new h.MercatorCoordinate(0,(w+1)/g).toLngLat().lat]}function Ul(y,c,g,w,I,k,P){const z=y.context,U=z.gl,q=g.fbo;if(!q)return;y.prepareDrawTile();const Z=y.useProgram("hillshade");z.activeTexture.set(U.TEXTURE0),U.bindTexture(U.TEXTURE_2D,q.colorAttachment.get());const ee=((oe,Me,ye,Ee)=>{const Te=ye.paint.get("hillshade-shadow-color"),Se=ye.paint.get("hillshade-highlight-color"),we=ye.paint.get("hillshade-accent-color");let ke=ye.paint.get("hillshade-illumination-direction")*(Math.PI/180);ye.paint.get("hillshade-illumination-anchor")==="viewport"&&(ke-=oe.transform.angle);const $e=!oe.options.moving;return{u_matrix:Ee||oe.transform.calculateProjMatrix(Me.tileID.toUnwrapped(),$e),u_image:0,u_latrange:$l(0,Me.tileID),u_light:[ye.paint.get("hillshade-exaggeration"),ke],u_shadow:Te,u_highlight:Se,u_accent:we}})(y,g,w,y.terrain?c.projMatrix:null);y.prepareDrawProgram(z,Z,c.toUnwrapped());const{tileBoundsBuffer:ae,tileBoundsIndexBuffer:me,tileBoundsSegments:ue}=y.getTileBoundsBuffers(g);Z.draw(z,U.TRIANGLES,I,k,P,h.CullFaceMode.disabled,ee,w.id,ae,me,ue)}function ba(y,c,g){if(!c.needsDEMTextureUpload)return;const w=y.context,I=w.gl;w.pixelStoreUnpackPremultiplyAlpha.set(!1),c.demTexture=c.demTexture||y.getTileTexture(g.stride);const k=g.getPixels();c.demTexture?c.demTexture.update(k,{premultiply:!1}):c.demTexture=new h.Texture(w,k,I.RGBA,{premultiply:!1}),c.needsDEMTextureUpload=!1}function wa(y,c,g,w,I,k){const P=y.context,z=P.gl;if(!c.dem)return;const U=c.dem;if(P.activeTexture.set(z.TEXTURE1),ba(y,c,U),!c.demTexture)return;c.demTexture.bind(z.NEAREST,z.CLAMP_TO_EDGE);const q=U.dim;P.activeTexture.set(z.TEXTURE0);let Z=c.fbo;if(!Z){const ue=new h.Texture(P,{width:q,height:q,data:null},z.RGBA);ue.bind(z.LINEAR,z.CLAMP_TO_EDGE),Z=c.fbo=P.createFramebuffer(q,q,!0),Z.colorAttachment.set(ue.texture)}P.bindFramebuffer.set(Z.framebuffer),P.viewport.set([0,0,q,q]);const{tileBoundsBuffer:ee,tileBoundsIndexBuffer:ae,tileBoundsSegments:me}=y.getMercatorTileBoundsBuffers();y.useProgram("hillshadePrepare").draw(P,z.TRIANGLES,w,I,k,h.CullFaceMode.disabled,((ue,oe)=>{const Me=oe.stride,ye=h.create();return h.ortho(ye,0,h.EXTENT,-h.EXTENT,0,0,1),h.translate(ye,ye,[0,-h.EXTENT,0]),{u_matrix:ye,u_image:1,u_dimension:[Me,Me],u_zoom:ue.overscaledZ,u_unpack:oe.unpackVector}})(c.tileID,U),g.id,ee,ae,me),c.needsHillshadePrepare=!1}const Ea=(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_image0:new h.Uniform1i(y,c.u_image0),u_skirt_height:new h.Uniform1f(y,c.u_skirt_height)}),Vl=(y,c)=>({u_matrix:y,u_image0:0,u_skirt_height:c}),jl=(y,c,g,w,I,k)=>({u_proj_matrix:Float32Array.from(y),u_globe_matrix:c,u_merc_matrix:g,u_zoom_transition:w,u_merc_center:I,u_image0:0,u_grid_matrix:k?Float32Array.from(k):new Float32Array(9)});function Is(y,c){return y!=null&&c!=null&&!(!y.hasData()||!c.hasData())&&y.demTexture!=null&&c.demTexture!=null&&y.tileID.key!==c.tileID.key}const Cn=new class{constructor(){this.operations={}}newMorphing(y,c,g,w,I){if(y in this.operations){const k=this.operations[y];k.to.tileID.key!==g.tileID.key&&(k.queued=g)}else this.operations[y]={startTime:w,phase:0,duration:I,from:c,to:g,queued:null}}getMorphValuesForProxy(y){if(!(y in this.operations))return null;const c=this.operations[y];return{from:c.from,to:c.to,phase:c.phase}}update(y){for(const c in this.operations){const g=this.operations[c];for(g.phase=(y-g.startTime)/g.duration;g.phase>=1||!this._validOp(g);)if(!this._nextOp(g,y)){delete this.operations[c];break}}}_nextOp(y,c){return!!y.queued&&(y.from=y.to,y.to=y.queued,y.queued=null,y.phase=0,y.startTime=c,!0)}_validOp(y){return y.from.hasData()&&y.to.hasData()}},mo={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function Ta(y,c){const g=1<<y.z;return!c&&(y.x===0||y.x===g-1)||y.y===0||y.y===g-1}const ks=y=>({u_matrix:y});function Ma(y,c,g,w,I){if(I>0){const k=h.exported.now(),P=(k-y.timeAdded)/I,z=c?(k-c.timeAdded)/I:-1,U=g.getSource(),q=w.coveringZoomLevel({tileSize:U.tileSize,roundZoom:U.roundZoom}),Z=!c||Math.abs(c.tileID.overscaledZ-q)>Math.abs(y.tileID.overscaledZ-q),ee=Z&&y.refreshedUponExpiration?1:h.clamp(Z?P:1-z,0,1);return y.refreshedUponExpiration&&P>=1&&(y.refreshedUponExpiration=!1),c?{opacity:1,mix:1-ee}:{opacity:ee,mix:0}}return{opacity:1,mix:0}}const ch=2*h.mercatorZfromAltitude(1,0)*h.GLOBE_RADIUS*Math.PI;class Go extends h.SourceCache{constructor(c){const g={type:"raster-dem",maxzoom:c.transform.maxZoom},w=new nt(Yt(),null),I=Le("mock-dem",g,w,c.style);super("mock-dem",I,!1),I.setEventedParent(this),this._sourceLoaded=!0}_loadTile(c,g){c.state="loaded",g(null)}}class qo extends h.SourceCache{constructor(c){const g=Le("proxy",{type:"geojson",maxzoom:c.transform.maxZoom},new nt(Yt(),null),c.style);super("proxy",g,!1),g.setEventedParent(this),this.map=this.getSource().map=c,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(c,g,w){if(c.freezeTileCoverage)return;this.transform=c;const I=c.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((k,P)=>{if(k[P.key]="",!this._tiles[P.key]){const z=new h.Tile(P,this._source.tileSize*P.overscaleFactor(),c.tileZoom);z.state="loaded",this._tiles[P.key]=z}return k},{});for(const k in this._tiles)k in I||(this.freeFBO(k),this._tiles[k].unloadVectorData(),delete this._tiles[k])}freeFBO(c){const g=this.proxyCachedFBO[c];if(g!==void 0){const w=Object.values(g);this.renderCachePool.push(...w),delete this.proxyCachedFBO[c]}}deallocRenderCache(){this.renderCache.forEach(c=>c.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Sa extends h.OverscaledTileID{constructor(c,g,w){super(c.overscaledZ,c.wrap,c.canonical.z,c.canonical.x,c.canonical.y),this.proxyTileKey=g,this.projMatrix=w}}class Or extends h.Elevation{constructor(c,g){super(),this.painter=c,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[w,I,k]=function(U){const q=new h.StructArrayLayout4i8,Z=new h.StructArrayLayout3ui6,ee=131;q.reserve(17161),Z.reserve(33800);const ae=h.EXTENT/128,me=h.EXTENT+ae/2,ue=me+ae;for(let Me=-ae;Me<ue;Me+=ae)for(let ye=-ae;ye<ue;ye+=ae){const Ee=ye<0||ye>me||Me<0||Me>me?24575:0,Te=h.clamp(Math.round(ye),0,h.EXTENT),Se=h.clamp(Math.round(Me),0,h.EXTENT);q.emplaceBack(Te+Ee,Se,Te,Se)}const oe=(Me,ye)=>{const Ee=ye*ee+Me;Z.emplaceBack(Ee+1,Ee,Ee+ee),Z.emplaceBack(Ee+ee,Ee+ee+1,Ee+1)};for(let Me=1;Me<129;Me++)for(let ye=1;ye<129;ye++)oe(ye,Me);return[0,129].forEach(Me=>{for(let ye=0;ye<130;ye++)oe(ye,Me),oe(Me,ye)}),[q,Z,32768]}(),P=c.context;this.gridBuffer=P.createVertexBuffer(w,h.boundsAttributes.members),this.gridIndexBuffer=P.createIndexBuffer(I),this.gridSegments=h.SegmentVector.simpleSegment(0,0,w.length,I.length),this.gridNoSkirtSegments=h.SegmentVector.simpleSegment(0,0,w.length,k),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new qo(g.map),this.orthoMatrix=h.create(),h.ortho(this.orthoMatrix,0,h.EXTENT,0,h.EXTENT,0,1);const z=P.gl;this._overlapStencilMode=new h.StencilMode({func:z.GEQUAL,mask:255},0,255,z.KEEP,z.KEEP,z.REPLACE),this._previousZoom=c.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=g,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Go(g.map)}set style(c){c.on("data",this._onStyleDataEvent.bind(this)),c.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=c,this._checkRenderCacheEfficiency()}update(c,g,w){if(c&&c.terrain){this._style!==c&&(this.style=c),this.enabled=!0;const I=c.terrain.properties;this.sourceCache=c.terrain.drapeRenderMode===0?this._mockSourceCache:c._getSourceCache(I.get("source")),this._exaggeration=I.get("exaggeration");const k=()=>{this.sourceCache.used&&h.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const P=this.getScaledDemTileSize();this.sourceCache.update(g,P,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,k(),this._initializing=!0),k(),g.updateElevation(!w),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(g),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(c){this._findCoveringTileCache[c]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const c=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||c.efficiency!==100&&h.warnOnce(`Terrain render cache efficiency is not optimal (${c.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${c.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(c){c.coord&&c.dataType==="source"?this._clearRenderCacheForTile(c.sourceCacheId,c.coord):c.dataType==="style"&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const c in this._style._sourceCaches)this._style._sourceCaches[c].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(c=>c.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0)}_source(){return this.enabled?this.sourceCache:null}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const c=2*this.proxySourceCache.getSource().tileSize;return[c,c]}set useVertexMorphing(c){this._useVertexMorphing=c}updateTileBinding(c){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const g=this.proxySourceCache,w=this.painter.transform;this._initializing&&(this._initializing=w._centerAltitude===0&&this.getAtPointOrZero(h.MercatorCoordinate.fromLngLat(w.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const I=this.proxyCoords=g.getIds().map(U=>{const q=g.getTileByID(U).tileID;return q.projMatrix=w.calculateProjMatrix(q.toUnwrapped()),q});(function(U,q){const Z=q.transform.pointCoordinate(q.transform.getCameraPoint()),ee=new h.pointGeometry(Z.x,Z.y);U.sort((ae,me)=>{if(me.overscaledZ-ae.overscaledZ)return me.overscaledZ-ae.overscaledZ;const ue=new h.pointGeometry(ae.canonical.x+(1<<ae.canonical.z)*ae.wrap,ae.canonical.y),oe=new h.pointGeometry(me.canonical.x+(1<<me.canonical.z)*me.wrap,me.canonical.y),Me=ee.mult(1<<ae.canonical.z);return Me.x-=.5,Me.y-=.5,Me.distSqr(ue)-Me.distSqr(oe)})})(I,this.painter),this._previousZoom=w.zoom;const k=this.proxyToSource||{};this.proxyToSource={},I.forEach(U=>{this.proxyToSource[U.key]={}}),this.terrainTileForTile={};const P=this._style._sourceCaches;for(const U in P){const q=P[U];if(!q.used||(q!==this.sourceCache&&this.resetTileLookupCache(q.id),this._setupProxiedCoordsForOrtho(q,c[U],k),q.usedForTerrain))continue;const Z=c[U];q.getSource().reparseOverscaled&&this._assignTerrainTiles(Z)}this.proxiedCoords[g.id]=I.map(U=>new Sa(U,U.key,this.orthoMatrix)),this._assignTerrainTiles(I),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(k),this.renderingToTexture=!1,this._updateTimestamp=h.exported.now();const z={};this._visibleDemTiles=[];for(const U of this.proxyCoords){const q=this.terrainTileForTile[U.key];if(!q)continue;const Z=q.tileID.key;Z in z||(this._visibleDemTiles.push(q),z[Z]=Z)}}_assignTerrainTiles(c){this._initializing||c.forEach(g=>{if(this.terrainTileForTile[g.key])return;const w=this._findTileCoveringTileID(g,this.sourceCache);w&&(this.terrainTileForTile[g.key]=w)})}_prepareDEMTextures(){const c=this.painter.context,g=c.gl;for(const w in this.terrainTileForTile){const I=this.terrainTileForTile[w],k=I.dem;!k||I.demTexture&&!I.needsDEMTextureUpload||(c.activeTexture.set(g.TEXTURE1),ba(this.painter,I,k))}}_prepareDemTileUniforms(c,g,w,I){if(!g||g.demTexture==null)return!1;const k=c.tileID.canonical,P=Math.pow(2,g.tileID.canonical.z-k.z),z=I||"";return w[`u_dem_tl${z}`]=[k.x*P%1,k.y*P%1],w[`u_dem_scale${z}`]=P,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const c=this.painter.context,g=c.gl;if(!this._emptyDepthBufferTexture){const w=new h.RGBAImage({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new h.Texture(c,w,g.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let c=0;const g=this._visibleDemTiles.reduce((w,I)=>{if(!I.dem)return w;const k=I.dem.tree.minimums[0];return k>0&&c++,w+k},0);return c?g/c:0}_updateEmptyDEMTexture(){const c=this.painter.context,g=c.gl;c.activeTexture.set(g.TEXTURE2);const w=this._getLoadedAreaMinimum(),I=new h.RGBAImage({width:1,height:1},new Uint8Array(h.DEMData.pack(w,this.sourceCache.getSource().encoding)));this._emptyDEMTextureDirty=!1;let k=this._emptyDEMTexture;return k?k.update(I,{premultiply:!1}):k=this._emptyDEMTexture=new h.Texture(c,I,g.RGBA,{premultiply:!1}),k}setupElevationDraw(c,g,w){const I=this.painter.context,k=I.gl,P=(z=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:h.DEMData.getUnpackVector(z),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0,u_tile_tl_up:[0,0,1],u_tile_tr_up:[0,0,1],u_tile_br_up:[0,0,1],u_tile_bl_up:[0,0,1],u_tile_up_scale:1});var z;P.u_dem_size=this.sourceCache.getSource().tileSize,P.u_exaggeration=this.exaggeration();const U=this.painter.transform,q=U.projection,Z=c.tileID.canonical;P.u_tile_tl_up=q.upVector(Z,0,0),P.u_tile_tr_up=q.upVector(Z,h.EXTENT,0),P.u_tile_br_up=q.upVector(Z,h.EXTENT,h.EXTENT),P.u_tile_bl_up=q.upVector(Z,0,h.EXTENT),P.u_tile_up_scale=w&&w.useDenormalizedUpVectorScale?ch:q.upVectorScale(Z,U.center.lat,U.worldSize).metersToTile;let ee=null,ae=null,me=1;if(w&&w.morphing&&this._useVertexMorphing){const ue=w.morphing.srcDemTile,oe=w.morphing.dstDemTile;me=w.morphing.phase,ue&&oe&&(this._prepareDemTileUniforms(c,ue,P,"_prev")&&(ae=ue),this._prepareDemTileUniforms(c,oe,P)&&(ee=oe))}if(ae&&ee?(I.activeTexture.set(k.TEXTURE2),ee.demTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE,k.NEAREST),I.activeTexture.set(k.TEXTURE4),ae.demTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE,k.NEAREST),P.u_dem_lerp=me):(ee=this.terrainTileForTile[c.tileID.key],I.activeTexture.set(k.TEXTURE2),(this._prepareDemTileUniforms(c,ee,P)?ee.demTexture:this.emptyDEMTexture).bind(k.NEAREST,k.CLAMP_TO_EDGE)),I.activeTexture.set(k.TEXTURE3),w&&w.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE),this._depthFBO&&(P.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE),P.u_depth_size_inv=[1,1]),w&&w.useMeterToDem&&ee){const ue=(1<<ee.tileID.canonical.z)*h.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;P.u_meter_to_dem=ue}w&&w.labelPlaneMatrixInv&&(P.u_label_plane_matrix_inv=w.labelPlaneMatrixInv),g.setTerrainUniformValues(I,P)}renderToBackBuffer(c){const g=this.painter,w=this.painter.context;c.length!==0&&(w.bindFramebuffer.set(null),w.viewport.set([0,0,g.width,g.height]),this.renderingToTexture=!1,function(I,k,P,z,U){if(I.transform.projection.name==="globe")(function(q,Z,ee,ae,me){const ue=q.context,oe=ue.gl;let Me,ye;const Ee=q.options.showTerrainWireframe?2:0,Te=(Ye,ht)=>{if(ye===Ye)return;const Ue=[mo[Ye],"PROJECTION_GLOBE_VIEW"];ht&&Ue.push(mo[Ee]),Me=q.useProgram("globeRaster",null,Ue),ye=Ye},Se=q.colorModeForRenderPass(),we=new h.DepthMode(oe.LEQUAL,h.DepthMode.ReadWrite,q.depthRangeFor3D);Cn.update(me);const ke=q.transform,$e=h.calculateGlobeMercatorMatrix(ke),qe=[h.mercatorXfromLng(ke.center.lng),h.mercatorYfromLat(ke.center.lat)],He=q.globeSharedBuffers;if((Ee?[!1,!0]:[!1]).forEach(Ye=>{ye=-1;const ht=Ye?oe.LINES:oe.TRIANGLES;for(const Ue of ae){const lt=ee.getTile(Ue),st=h.StencilMode.disabled,kt=Z.prevTerrainTileForTile[Ue.key],Ze=Z.terrainTileForTile[Ue.key];Is(kt,Ze)&&Cn.newMorphing(Ue.key,kt,Ze,me,250),ue.activeTexture.set(oe.TEXTURE0),lt.texture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE);const Ut=Cn.getMorphValuesForProxy(Ue.key),Gt=Ut?1:0,St={useDenormalizedUpVectorScale:!0};Ut&&h.extend$1(St,{morphing:{srcDemTile:Ut.from,dstDemTile:Ut.to,phase:h.easeCubicInOut(Ut.phase)}});const At=Float32Array.from(ke.globeMatrix),Kt=h.globeTileLatLngCorners(Ue.canonical),pi=h.getGridMatrix(Ue.canonical,Kt),Ft=jl(ke.projMatrix,At,$e,h.globeToMercatorTransition(ke.zoom),qe,pi);if(Te(Gt,Ye),Z.setupElevationDraw(lt,Me,St),q.prepareDrawProgram(ue,Me,Ue.toUnwrapped()),He){const[ei,ki,Yi]=Ye?He.getWirefameBuffers(q.context):He.getGridBuffers();Me.draw(ue,ht,we,st,Se,h.CullFaceMode.backCCW,Ft,"globe_raster",ei,ki,Yi)}}}),He){Me=q.useProgram("globeRaster",null,["GLOBE_POLES","PROJECTION_GLOBE_VIEW"]);for(const Ye of ae){const{x:ht,y:Ue,z:lt}=Ye.canonical,st=Ue===0,kt=Ue===(1<<lt)-1,[Ze,Ut,Gt,St]=He.getPoleBuffers(lt);if(St&&(st||kt)){const At=ee.getTile(Ye);ue.activeTexture.set(oe.TEXTURE0),At.texture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE);let Kt=h.globePoleMatrixForTile(lt,ht,ke);const pi=(Ft,ei)=>Ft.draw(ue,oe.TRIANGLES,we,h.StencilMode.disabled,Se,h.CullFaceMode.disabled,jl(ke.projMatrix,Kt,Kt,0,qe),"globe_pole_raster",ei,Gt,St);Z.setupElevationDraw(At,Me,{}),q.prepareDrawProgram(ue,Me,Ye.toUnwrapped()),st&&pi(Me,Ze),kt&&(Kt=h.scale(h.create(),Kt,[1,-1,1]),pi(Me,Ut))}}}})(I,k,P,z,U);else{const q=I.context,Z=q.gl;let ee,ae;const me=I.options.showTerrainWireframe?2:0,ue=(Te,Se)=>{if(ae===Te)return;const we=[mo[Te]];Se&&we.push(mo[me]),ee=I.useProgram("terrainRaster",null,we),ae=Te},oe=I.colorModeForRenderPass(),Me=new h.DepthMode(Z.LEQUAL,h.DepthMode.ReadWrite,I.depthRangeFor3D);Cn.update(U);const ye=I.transform,Ee=6*Math.pow(1.5,22-ye.zoom)*k.exaggeration();(me?[!1,!0]:[!1]).forEach(Te=>{ae=-1;const Se=Te?Z.LINES:Z.TRIANGLES,[we,ke]=Te?k.getWirefameBuffer():[k.gridIndexBuffer,k.gridSegments];for(const $e of z){const qe=P.getTile($e),He=h.StencilMode.disabled,Ye=k.prevTerrainTileForTile[$e.key],ht=k.terrainTileForTile[$e.key];Is(Ye,ht)&&Cn.newMorphing($e.key,Ye,ht,U,250),q.activeTexture.set(Z.TEXTURE0),qe.texture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE,Z.LINEAR_MIPMAP_NEAREST);const Ue=Cn.getMorphValuesForProxy($e.key),lt=Ue?1:0;let st;Ue&&(st={morphing:{srcDemTile:Ue.from,dstDemTile:Ue.to,phase:h.easeCubicInOut(Ue.phase)}});const kt=Vl($e.projMatrix,Ta($e.canonical,ye.renderWorldCopies)?Ee/10:Ee);ue(lt,Te),k.setupElevationDraw(qe,ee,st),I.prepareDrawProgram(q,ee,$e.toUnwrapped()),ee.draw(q,Se,Me,He,oe,h.CullFaceMode.backCCW,kt,"terrain_raster",k.gridBuffer,we,ke)}})}}(g,this,this.proxySourceCache,c,this._updateTimestamp),this.renderingToTexture=!0,c.splice(0,c.length))}renderBatch(c){if(this._drapedRenderBatches.length===0)return c+1;this.renderingToTexture=!0;const g=this.painter,w=this.painter.context,I=this.proxySourceCache,k=this.proxiedCoords[I.id],P=this._drapedRenderBatches.shift(),z=[],U=g.style.order;let q=0;for(const Z of k){const ee=I.getTileByID(Z.proxyTileKey),ae=I.proxyCachedFBO[Z.key]?I.proxyCachedFBO[Z.key][c]:void 0,me=ae!==void 0?I.renderCache[ae]:this.pool[q++],ue=ae!==void 0;if(ee.texture=me.tex,ue&&!me.dirty){z.push(ee.tileID);continue}let oe;w.bindFramebuffer.set(me.fb.framebuffer),this.renderedToTile=!1,me.dirty&&(w.clear({color:h.Color.transparent,stencil:0}),me.dirty=!1);for(let Me=P.start;Me<=P.end;++Me){const ye=g.style._layers[U[Me]];if(ye.isHidden(g.transform.zoom))continue;const Ee=g.style._getLayerSourceCache(ye),Te=Ee?this.proxyToSource[Z.key][Ee.id]:[Z];if(!Te)continue;const Se=Te;w.viewport.set([0,0,me.fb.width,me.fb.height]),oe!==(Ee?Ee.id:null)&&(this._setupStencil(me,Te,ye,Ee),oe=Ee?Ee.id:null),g.renderLayer(g,Ee,ye,Se)}this.renderedToTile?(me.dirty=!0,z.push(ee.tileID)):ue||--q,q===5&&(q=0,this.renderToBackBuffer(z))}return this.renderToBackBuffer(z),this.renderingToTexture=!1,w.bindFramebuffer.set(null),w.viewport.set([0,0,g.width,g.height]),P.end+1}postRender(){}renderCacheEfficiency(c){const g=c.order.length;if(g===0)return{efficiency:100};let w,I=0,k=0,P=!1;for(let z=0;z<g;++z){const U=c._layers[c.order[z]];this._style.isLayerDraped(U)?(P&&++I,++k):P||(P=!0,w=U.id)}return k===0?{efficiency:100}:{efficiency:100*(1-I/k),firstUndrapedLayer:w}}getMinElevationBelowMSL(){let c=0;return this._visibleDemTiles.filter(g=>g.dem).forEach(g=>{c=Math.min(c,g.dem.tree.minimums[0])}),c===0?c:(c-30)*this._exaggeration}raycast(c,g,w){if(!this._visibleDemTiles)return null;const I=this._visibleDemTiles.filter(k=>k.dem).map(k=>{const P=k.tileID,z=Math.pow(2,P.overscaledZ),{x:U,y:q}=P.canonical,Z=U/z,ee=(U+1)/z,ae=q/z,me=(q+1)/z;return{minx:Z,miny:ae,maxx:ee,maxy:me,t:k.dem.tree.raycastRoot(Z,ae,ee,me,c,g,w),tile:k}});I.sort((k,P)=>(k.t!==null?k.t:Number.MAX_VALUE)-(P.t!==null?P.t:Number.MAX_VALUE));for(const k of I){if(k.t==null)return null;const P=k.tile.dem.tree.raycast(k.minx,k.miny,k.maxx,k.maxy,c,g,w);if(P!=null)return P}return null}_createFBO(){const c=this.painter.context,g=c.gl,w=this.drapeBufferSize;c.activeTexture.set(g.TEXTURE0);const I=new h.Texture(c,{width:w[0],height:w[1],data:null},g.RGBA);I.bind(g.LINEAR,g.CLAMP_TO_EDGE);const k=c.createFramebuffer(w[0],w[1],!1);return k.colorAttachment.set(I.texture),k.depthAttachment=new _e(c,k.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=c.createRenderbuffer(c.gl.DEPTH_STENCIL,w[0],w[1]),this._stencilRef=0,k.depthAttachment.set(this._sharedDepthStencil),c.clear({stencil:0})):k.depthAttachment.set(this._sharedDepthStencil),c.extTextureFilterAnisotropic&&!c.extTextureFilterAnisotropicForceOff&&g.texParameterf(g.TEXTURE_2D,c.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.extTextureFilterAnisotropicMax),{fb:k,tex:I,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const c in this._style._sourceCaches)if(this._style._sourceCaches[c].hasTransition())return!0;return this._style.order.some(c=>{const g=this._style._layers[c],w=g.isHidden(this.painter.transform.zoom),I=g.getCrossfadeParameters(),k=!!I&&I.t!==1,P=g.hasTransition();return g.type!=="custom"&&!w&&(k||P)})}_clearRasterFadeFromRenderCache(){let c=!1;for(const g in this._style._sourceCaches)if(this._style._sourceCaches[g]._source instanceof Y){c=!0;break}if(c)for(let g=0;g<this._style.order.length;++g){const w=this._style._layers[this._style.order[g]],I=w.isHidden(this.painter.transform.zoom),k=this._style._getLayerSourceCache(w);if(w.type!=="raster"||I||!k)continue;const P=w.paint.get("raster-fade-duration");for(const z of this.proxyCoords){const U=this.proxyToSource[z.key][k.id];if(U)for(const q of U){const Z=Ma(k.getTile(q),k.findLoadedParent(q,0),k,this.painter.transform,P);(Z.opacity!==1||Z.mix!==0)&&this._clearRenderCacheForTile(k.id,q)}}}}_setupDrapedRenderBatches(){const c=this._style.order,g=c.length;if(g===0)return;const w=[];let I,k=0,P=this._style._layers[c[k]];for(;!this._style.isLayerDraped(P)&&P.isHidden(this.painter.transform.zoom)&&++k<g;)P=this._style._layers[c[k]];for(;k<g;++k){const z=this._style._layers[c[k]];z.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(z)?I===void 0&&(I=k):I!==void 0&&(w.push({start:I,end:k-1}),I=void 0))}I!==void 0&&w.push({start:I,end:k-1}),this._drapedRenderBatches=w}_setupRenderCache(c){const g=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,g.renderCache.length>g.renderCachePool.length){const P=Object.values(g.proxyCachedFBO);g.proxyCachedFBO={};for(let z=0;z<P.length;++z){const U=Object.values(P[z]);g.renderCachePool.push(...U)}}return}this._clearRasterFadeFromRenderCache();const w=this.proxyCoords,I=this._tilesDirty;for(let P=w.length-1;P>=0;P--){const z=w[P];if(g.getTileByID(z.key),g.proxyCachedFBO[z.key]!==void 0){const U=c[z.key],q=this.proxyToSource[z.key];let Z=0;for(const ee in q){const ae=q[ee],me=U[ee];if(!me||me.length!==ae.length||ae.some((ue,oe)=>ue!==me[oe]||I[ee]&&I[ee].hasOwnProperty(ue.key))){Z=-1;break}++Z}for(const ee in g.proxyCachedFBO[z.key])g.renderCache[g.proxyCachedFBO[z.key][ee]].dirty=Z<0||Z!==Object.values(U).length}}const k=[...this._drapedRenderBatches];k.sort((P,z)=>z.end-z.start-(P.end-P.start));for(const P of k)for(const z of w){if(g.proxyCachedFBO[z.key])continue;let U=g.renderCachePool.pop();U===void 0&&g.renderCache.length<50&&(U=g.renderCache.length,g.renderCache.push(this._createFBO())),U!==void 0&&(g.proxyCachedFBO[z.key]={},g.proxyCachedFBO[z.key][P.start]=U,g.renderCache[U].dirty=!0)}this._tilesDirty={}}_setupStencil(c,g,w,I){if(!I||!this._sourceTilesOverlap[I.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const k=this.painter.context,P=k.gl;if(g.length<=1)return void(this._overlapStencilType=!1);let z;if(w.isTileClipped())z=g.length,this._overlapStencilMode.test={func:P.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(g[0].overscaledZ>g[g.length-1].overscaledZ))return void(this._overlapStencilType=!1);z=1,this._overlapStencilMode.test={func:P.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+z>255&&(k.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=z,this._overlapStencilMode.ref=this._stencilRef,w.isTileClipped()&&this._renderTileClippingMasks(g,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(c){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs.get(c.key)||0),this._overlapStencilMode):h.StencilMode.disabled}_renderTileClippingMasks(c,g){const w=this.painter,I=this.painter.context,k=I.gl;w._tileClippingMaskIDs.clear(),I.setColorMode(h.ColorMode.disabled),I.setDepthMode(h.DepthMode.disabled);const P=w.useProgram("clippingMask");for(const z of c){const U=--g;w._tileClippingMaskIDs.set(z.key,U),P.draw(I,k.TRIANGLES,h.DepthMode.disabled,new h.StencilMode({func:k.ALWAYS,mask:0},U,255,k.KEEP,k.KEEP,k.REPLACE),h.ColorMode.disabled,h.CullFaceMode.disabled,ks(z.projMatrix),"$clipping",w.tileExtentBuffer,w.quadTriangleIndexBuffer,w.tileExtentSegments)}}pointCoordinate(c){const g=this.painter.transform;if(c.x<0||c.x>g.width||c.y<0||c.y>g.height)return null;const w=[c.x,c.y,1,1];h.transformMat4$1(w,w,g.pixelMatrixInverse),h.scale$1(w,w,1/w[3]),w[0]/=g.worldSize,w[1]/=g.worldSize;const I=g._camera.position,k=h.mercatorZfromAltitude(1,g.center.lat),P=[I[0],I[1],I[2]/k,0],z=h.subtract([],w.slice(0,3),P);h.normalize(z,z);const U=this.raycast(P,z,this._exaggeration);return U!==null&&U?(h.scaleAndAdd(P,P,z,U),P[3]=P[2],P[2]*=k,P):null}drawDepth(){const c=this.painter,g=c.context,w=this.proxySourceCache,I=Math.ceil(c.width),k=Math.ceil(c.height);if(!this._depthFBO||this._depthFBO.width===I&&this._depthFBO.height===k||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const P=g.gl,z=g.createFramebuffer(I,k,!0);g.activeTexture.set(P.TEXTURE0);const U=new h.Texture(g,{width:I,height:k,data:null},P.RGBA);U.bind(P.NEAREST,P.CLAMP_TO_EDGE),z.colorAttachment.set(U.texture);const q=g.createRenderbuffer(g.gl.DEPTH_COMPONENT16,I,k);z.depthAttachment.set(q),this._depthFBO=z,this._depthTexture=U}g.bindFramebuffer.set(this._depthFBO.framebuffer),g.viewport.set([0,0,I,k]),function(P,z,U,q){if(P.transform.projection.name==="globe")return;const Z=P.context,ee=Z.gl;Z.clear({depth:1});const ae=P.useProgram("terrainDepth"),me=new h.DepthMode(ee.LESS,h.DepthMode.ReadWrite,P.depthRangeFor3D);for(const ue of q){const oe=U.getTile(ue),Me=Vl(ue.projMatrix,0);z.setupElevationDraw(oe,ae),ae.draw(Z,ee.TRIANGLES,me,h.StencilMode.disabled,h.ColorMode.unblended,h.CullFaceMode.backCCW,Me,"terrain_depth",z.gridBuffer,z.gridIndexBuffer,z.gridNoSkirtSegments)}}(c,this,w,this.proxyCoords)}_setupProxiedCoordsForOrtho(c,g,w){if(c.getSource()instanceof Ce)return this._setupProxiedCoordsForImageSource(c,g,w);this._findCoveringTileCache[c.id]=this._findCoveringTileCache[c.id]||{};const I=this.proxiedCoords[c.id]=[],k=this.proxyCoords;for(let z=0;z<k.length;z++){const U=k[z],q=this._findTileCoveringTileID(U,c);if(q){const Z=this._createProxiedId(U,q,w[U.key]&&w[U.key][c.id]);I.push(Z),this.proxyToSource[U.key][c.id]=[Z]}}let P=!1;for(let z=0;z<g.length;z++){const U=c.getTile(g[z]);if(!U||!U.hasData())continue;const q=this._findTileCoveringTileID(U.tileID,this.proxySourceCache);if(q&&q.tileID.canonical.z!==U.tileID.canonical.z){const Z=this.proxyToSource[q.tileID.key][c.id],ee=this._createProxiedId(q.tileID,U,w[q.tileID.key]&&w[q.tileID.key][c.id]);Z?Z.splice(Z.length-1,0,ee):this.proxyToSource[q.tileID.key][c.id]=[ee],I.push(ee),P=!0}}this._sourceTilesOverlap[c.id]=P}_setupProxiedCoordsForImageSource(c,g,w){if(!c.getSource().loaded())return;const I=this.proxiedCoords[c.id]=[],k=this.proxyCoords,P=c.getSource(),z=new h.pointGeometry(P.tileID.x,P.tileID.y)._div(1<<P.tileID.z),U=P.coordinates.map(h.MercatorCoordinate.fromLngLat).reduce((Z,ee)=>(Z.min.x=Math.min(Z.min.x,ee.x-z.x),Z.min.y=Math.min(Z.min.y,ee.y-z.y),Z.max.x=Math.max(Z.max.x,ee.x-z.x),Z.max.y=Math.max(Z.max.y,ee.y-z.y),Z),{min:new h.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new h.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),q=(Z,ee)=>{const ae=Z.wrap+Z.canonical.x/(1<<Z.canonical.z),me=Z.canonical.y/(1<<Z.canonical.z),ue=h.EXTENT/(1<<Z.canonical.z),oe=ee.wrap+ee.canonical.x/(1<<ee.canonical.z),Me=ee.canonical.y/(1<<ee.canonical.z);return ae+ue<oe+U.min.x||ae>oe+U.max.x||me+ue<Me+U.min.y||me>Me+U.max.y};for(let Z=0;Z<k.length;Z++){const ee=k[Z];for(let ae=0;ae<g.length;ae++){const me=c.getTile(g[ae]);if(!me||!me.hasData()||q(ee,me.tileID))continue;const ue=this._createProxiedId(ee,me,w[ee.key]&&w[ee.key][c.id]),oe=this.proxyToSource[ee.key][c.id];oe?oe.push(ue):this.proxyToSource[ee.key][c.id]=[ue],I.push(ue)}}}_createProxiedId(c,g,w){let I=this.orthoMatrix;if(w){const k=w.find(P=>P.key===g.tileID.key);if(k)return k}if(g.tileID.key!==c.key){const k=c.canonical.z-g.tileID.canonical.z;let P,z,U;I=h.create();const q=g.tileID.wrap-c.wrap<<c.overscaledZ;k>0?(P=h.EXTENT>>k,z=P*((g.tileID.canonical.x<<k)-c.canonical.x+q),U=P*((g.tileID.canonical.y<<k)-c.canonical.y)):(P=h.EXTENT<<-k,z=h.EXTENT*(g.tileID.canonical.x-(c.canonical.x+q<<-k)),U=h.EXTENT*(g.tileID.canonical.y-(c.canonical.y<<-k))),h.ortho(I,0,P,0,P,0,1),h.translate(I,I,[z,U,0])}return new Sa(g.tileID,c.key,I)}_findTileCoveringTileID(c,g){let w=g.getTile(c);if(w&&w.hasData())return w;const I=this._findCoveringTileCache[g.id],k=I[c.key];if(w=k?g.getTileByID(k):null,w&&w.hasData()||k===null)return w;let P=w?w.tileID:c,z=P.overscaledZ;const U=g.getSource().minzoom,q=[];if(!k){const ee=g.getSource().maxzoom;if(c.canonical.z>=ee){const ae=c.canonical.z-ee;g.getSource().reparseOverscaled?(z=Math.max(c.canonical.z+2,g.transform.tileZoom),P=new h.OverscaledTileID(z,c.wrap,ee,c.canonical.x>>ae,c.canonical.y>>ae)):ae!==0&&(z=ee,P=new h.OverscaledTileID(z,c.wrap,ee,c.canonical.x>>ae,c.canonical.y>>ae))}P.key!==c.key&&(q.push(P.key),w=g.getTile(P))}const Z=ee=>{q.forEach(ae=>{I[ae]=ee}),q.length=0};for(z-=1;z>=U&&(!w||!w.hasData());z--){w&&Z(w.tileID.key);const ee=P.calculateScaledKey(z);if(w=g.getTileByID(ee),w&&w.hasData())break;const ae=I[ee];if(ae===null)break;ae===void 0?q.push(ee):w=g.getTileByID(ae)}return Z(w?w.tileID.key:null),w&&w.hasData()?w:null}findDEMTileFor(c){return this.enabled?this._findTileCoveringTileID(c,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(c,g){let w=this._tilesDirty[c];w||(w=this._tilesDirty[c]={}),w[g.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const c=function(g){let w=0;const I=new h.StructArrayLayout2ui4,k=131;for(let P=1;P<129;P++){for(let z=1;z<129;z++)w=P*k+z,I.emplaceBack(w,w+1),I.emplaceBack(w,w+k),I.emplaceBack(w+1,w+k),P===128&&I.emplaceBack(w+k,w+k+1);I.emplaceBack(w+1,w+1+k)}return I}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(c),this.wireframeSegments=h.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,c.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}function Cs(y){const c=[];for(let g=0;g<y.length;g++){if(y[g]===null)continue;const w=y[g].split(" ");c.push(w.pop())}return c}class Zo{static cacheKey(c,g,w){let I=`${c}${w?w.cacheKey:""}`;for(const k of g)I+=`/${k}`;return I}constructor(c,g,w,I,k,P){const z=c.gl;this.program=z.createProgram();const U=Cs(w.staticAttributes),q=I?I.getBinderAttributes():[],Z=U.concat(q),ee=w.staticUniforms?Cs(w.staticUniforms):[],ae=I?I.getBinderUniforms():[],me=ee.concat(ae),ue=[];for(const we of me)ue.indexOf(we)<0&&ue.push(we);let oe=I?I.defines():[];oe=oe.concat(P.map(we=>`#define ${we}`));const Me=oe.concat(`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,Vo,Ss.fragmentSource,kn.fragmentSource,w.fragmentSource).join(`
`),ye=oe.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,Vo,Ss.vertexSource,kn.vertexSource,Wn.vertexSource,w.vertexSource).join(`
`),Ee=z.createShader(z.FRAGMENT_SHADER);if(z.isContextLost())return void(this.failedToCreate=!0);z.shaderSource(Ee,Me),z.compileShader(Ee),z.attachShader(this.program,Ee);const Te=z.createShader(z.VERTEX_SHADER);if(z.isContextLost())return void(this.failedToCreate=!0);z.shaderSource(Te,ye),z.compileShader(Te),z.attachShader(this.program,Te),this.attributes={};const Se={};this.numAttributes=Z.length;for(let we=0;we<this.numAttributes;we++)Z[we]&&(z.bindAttribLocation(this.program,we,Z[we]),this.attributes[Z[we]]=we);z.linkProgram(this.program),z.deleteShader(Te),z.deleteShader(Ee);for(let we=0;we<ue.length;we++){const ke=ue[we];if(ke&&!Se[ke]){const $e=z.getUniformLocation(this.program,ke);$e&&(Se[ke]=$e)}}this.fixedUniforms=k(c,Se),this.binderUniforms=I?I.getUniforms(c,Se):[],P.indexOf("TERRAIN")!==-1&&(this.terrainUniforms=((we,ke)=>({u_dem:new h.Uniform1i(we,ke.u_dem),u_dem_prev:new h.Uniform1i(we,ke.u_dem_prev),u_dem_unpack:new h.Uniform4f(we,ke.u_dem_unpack),u_dem_tl:new h.Uniform2f(we,ke.u_dem_tl),u_dem_scale:new h.Uniform1f(we,ke.u_dem_scale),u_dem_tl_prev:new h.Uniform2f(we,ke.u_dem_tl_prev),u_dem_scale_prev:new h.Uniform1f(we,ke.u_dem_scale_prev),u_dem_size:new h.Uniform1f(we,ke.u_dem_size),u_dem_lerp:new h.Uniform1f(we,ke.u_dem_lerp),u_exaggeration:new h.Uniform1f(we,ke.u_exaggeration),u_depth:new h.Uniform1i(we,ke.u_depth),u_depth_size_inv:new h.Uniform2f(we,ke.u_depth_size_inv),u_meter_to_dem:new h.Uniform1f(we,ke.u_meter_to_dem),u_label_plane_matrix_inv:new h.UniformMatrix4f(we,ke.u_label_plane_matrix_inv),u_tile_tl_up:new h.Uniform3f(we,ke.u_tile_tl_up),u_tile_tr_up:new h.Uniform3f(we,ke.u_tile_tr_up),u_tile_br_up:new h.Uniform3f(we,ke.u_tile_br_up),u_tile_bl_up:new h.Uniform3f(we,ke.u_tile_bl_up),u_tile_up_scale:new h.Uniform1f(we,ke.u_tile_up_scale)}))(c,Se)),P.indexOf("FOG")!==-1&&(this.fogUniforms=((we,ke)=>({u_fog_matrix:new h.UniformMatrix4f(we,ke.u_fog_matrix),u_fog_range:new h.Uniform2f(we,ke.u_fog_range),u_fog_color:new h.Uniform4f(we,ke.u_fog_color),u_fog_horizon_blend:new h.Uniform1f(we,ke.u_fog_horizon_blend),u_fog_temporal_offset:new h.Uniform1f(we,ke.u_fog_temporal_offset)}))(c,Se))}setTerrainUniformValues(c,g){if(!this.terrainUniforms)return;const w=this.terrainUniforms;if(!this.failedToCreate){c.program.set(this.program);for(const I in g)w[I].set(g[I])}}setFogUniformValues(c,g){if(!this.fogUniforms)return;const w=this.fogUniforms;if(!this.failedToCreate){c.program.set(this.program);for(const I in g)w[I].location&&w[I].set(g[I])}}draw(c,g,w,I,k,P,z,U,q,Z,ee,ae,me,ue,oe,Me){const ye=c.gl;if(this.failedToCreate)return;c.program.set(this.program),c.setDepthMode(w),c.setStencilMode(I),c.setColorMode(k),c.setCullFace(P);for(const Te of Object.keys(this.fixedUniforms))this.fixedUniforms[Te].set(z[Te]);ue&&ue.setUniforms(c,this.binderUniforms,ae,{zoom:me});const Ee={[ye.LINES]:2,[ye.TRIANGLES]:3,[ye.LINE_STRIP]:1}[g];for(const Te of ee.get()){const Se=Te.vaos||(Te.vaos={});(Se[U]||(Se[U]=new As)).bind(c,this,q,ue?ue.getPaintVertexBuffers():[],Z,Te.vertexOffset,oe,Me),ye.drawElements(g,Te.primitiveLength*Ee,ye.UNSIGNED_SHORT,Te.primitiveOffset*Ee*2)}}}function Xo(y,c,g){const w=1/mt(g,1,c.transform.tileZoom),I=Math.pow(2,g.tileID.overscaledZ),k=g.tileSize*Math.pow(2,c.transform.tileZoom)/I,P=k*(g.tileID.canonical.x+g.tileID.wrap*I),z=k*g.tileID.canonical.y;return{u_image:0,u_texsize:g.imageAtlasTexture.size,u_scale:[w,y.fromScale,y.toScale],u_fade:y.t,u_pixel_coord_upper:[P>>16,z>>16],u_pixel_coord_lower:[65535&P,65535&z]}}const Aa=h.create(),Ds=(y,c,g,w,I,k,P,z,U)=>{const q=c.style.light,Z=q.properties.get("position"),ee=[Z.x,Z.y,Z.z],ae=h.create$1();q.properties.get("anchor")==="viewport"&&(h.fromRotation(ae,-c.transform.angle),h.transformMat3(ee,ee,ae));const me=q.properties.get("color"),ue=c.transform,oe={u_matrix:y,u_lightpos:ee,u_lightintensity:q.properties.get("intensity"),u_lightcolor:[me.r,me.g,me.b],u_vertical_gradient:+g,u_opacity:w,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Aa,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0};return ue.projection.name==="globe"&&(oe.u_tile_id=[I.canonical.x,I.canonical.y,1<<I.canonical.z],oe.u_zoom_transition=P,oe.u_inv_rot_matrix=U,oe.u_merc_center=z,oe.u_up_dir=ue.projection.upVector(new h.CanonicalTileID(0,0,0),z[0]*h.EXTENT,z[1]*h.EXTENT),oe.u_height_lift=k),oe},Ps=(y,c,g,w,I,k,P,z,U,q,Z)=>{const ee=Ds(y,c,g,w,I,z,U,q,Z),ae={u_height_factor:-Math.pow(2,I.overscaledZ)/P.tileSize/8};return h.extend(ee,Xo(k,c,P),ae)},Bs=y=>({u_matrix:y}),Rs=(y,c,g,w)=>h.extend(Bs(y),Xo(g,c,w)),Ls=(y,c)=>({u_matrix:y,u_world:c}),Gl=(y,c,g,w,I)=>h.extend(Rs(y,c,g,w),{u_world:I}),ql=h.create(),go=(y,c,g,w,I,k)=>{const P=y.transform,z=P.projection.name==="globe";let U;if(k.paint.get("circle-pitch-alignment")==="map")if(z){const Z=h.globePixelsToTileUnits(P.zoom,c.canonical);U=Float32Array.from([Z,0,0,Z])}else U=P.calculatePixelsToTileUnitsMatrix(g);else U=new Float32Array([P.pixelsToGLUnits[0],0,0,P.pixelsToGLUnits[1]]);const q={u_camera_to_center_distance:P.cameraToCenterDistance,u_matrix:y.translatePosMatrix(c.projMatrix,g,k.paint.get("circle-translate"),k.paint.get("circle-translate-anchor")),u_device_pixel_ratio:h.exported.devicePixelRatio,u_extrude_scale:U,u_inv_rot_matrix:ql,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};return z&&(q.u_inv_rot_matrix=w,q.u_merc_center=I,q.u_tile_id=[c.canonical.x,c.canonical.y,1<<c.canonical.z],q.u_zoom_transition=h.globeToMercatorTransition(P.zoom),q.u_up_dir=P.projection.upVector(c.canonical,I[0],I[1])),q},hh=y=>{const c=[];return y.paint.get("circle-pitch-alignment")==="map"&&c.push("PITCH_WITH_MAP"),y.paint.get("circle-pitch-scale")==="map"&&c.push("SCALE_WITH_MAP"),c},uh=(y,c,g)=>{const w=h.EXTENT/g.tileSize;return{u_matrix:y,u_camera_to_center_distance:c.cameraToCenterDistance,u_extrude_scale:[c.pixelsToGLUnits[0]/w,c.pixelsToGLUnits[1]/w]}},Zl=(y,c,g=1)=>({u_matrix:y,u_color:c,u_overlay:0,u_overlay_scale:g}),dh=h.create(),fh=(y,c,g,w,I,k,P)=>{const z=y.transform,U=z.projection.name==="globe",q=U?h.globePixelsToTileUnits(z.zoom,c.canonical):mt(g,1,k),Z={u_matrix:c.projMatrix,u_extrude_scale:q,u_intensity:P,u_inv_rot_matrix:dh,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};return U&&(Z.u_inv_rot_matrix=w,Z.u_merc_center=I,Z.u_tile_id=[c.canonical.x,c.canonical.y,1<<c.canonical.z],Z.u_zoom_transition=h.globeToMercatorTransition(z.zoom),Z.u_up_dir=z.projection.upVector(c.canonical,I[0],I[1])),Z},ph=(y,c,g,w,I,k,P)=>{const z=y.transform,U=z.calculatePixelsToTileUnitsMatrix(c),q={u_matrix:Hn(y,c,g,I),u_pixels_to_tile_units:U,u_device_pixel_ratio:P,u_units_to_pixels:[1/z.pixelsToGLUnits[0],1/z.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:k,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0,u_alpha_discard_threshold:0};if(ka(g)){const Z=zs(c,y.transform);q.u_texsize=c.lineAtlasTexture.size,q.u_scale=[Z,w.fromScale,w.toScale],q.u_mix=w.t}return q},Ia=(y,c,g,w,I,k)=>{const P=y.transform,z=zs(c,P);return{u_matrix:Hn(y,c,g,I),u_texsize:c.imageAtlasTexture.size,u_pixels_to_tile_units:P.calculatePixelsToTileUnitsMatrix(c),u_device_pixel_ratio:k,u_image:0,u_scale:[z,w.fromScale,w.toScale],u_fade:w.t,u_units_to_pixels:[1/P.pixelsToGLUnits[0],1/P.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function zs(y,c){return 1/mt(y,1,c.tileZoom)}function Hn(y,c,g,w){return y.translatePosMatrix(w||c.tileID.projMatrix,c,g.paint.get("line-translate"),g.paint.get("line-translate-anchor"))}function ka(y){const c=y.paint.get("line-dasharray").value;return c.value||c.kind!=="constant"}const Xl=(y,c,g,w,I,k)=>{return{u_matrix:y,u_tl_parent:c,u_scale_parent:g,u_fade_t:w.mix,u_opacity:w.opacity*I.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:I.paint.get("raster-brightness-min"),u_brightness_high:I.paint.get("raster-brightness-max"),u_saturation_factor:(z=I.paint.get("raster-saturation"),z>0?1-1/(1.001-z):-z),u_contrast_factor:(P=I.paint.get("raster-contrast"),P>0?1/(1-P):1+P),u_spin_weights:Ca(I.paint.get("raster-hue-rotate")),u_perspective_transform:k};var P,z};function Ca(y){y*=Math.PI/180;const c=Math.sin(y),g=Math.cos(y);return[(2*g+1)/3,(-Math.sqrt(3)*c-g+1)/3,(Math.sqrt(3)*c-g+1)/3]}const Dn=h.create(),Da=(y,c,g,w,I,k,P,z,U,q,Z,ee,ae,me)=>{const ue=I.transform,oe={u_is_size_zoom_constant:+(y==="constant"||y==="source"),u_is_size_feature_constant:+(y==="constant"||y==="camera"),u_size_t:c?c.uSizeT:0,u_size:c?c.uSize:0,u_camera_to_center_distance:ue.cameraToCenterDistance,u_rotate_symbol:+g,u_aspect_ratio:ue.width/ue.height,u_fade_change:I.options.fadeDuration?I.symbolFadeChange:1,u_matrix:k,u_label_plane_matrix:P,u_coord_matrix:z,u_is_text:+U,u_pitch_with_map:+w,u_texsize:q,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Dn,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Dn};return ue.projection.name==="globe"&&(oe.u_tile_id=[Z.canonical.x,Z.canonical.y,1<<Z.canonical.z],oe.u_zoom_transition=ee,oe.u_inv_rot_matrix=me,oe.u_merc_center=ae,oe.u_camera_forward=ue._camera.forward(),oe.u_ecef_origin=h.globeECEFOrigin(ue.globeMatrix,Z.toUnwrapped()),oe.u_tile_matrix=Float32Array.from(ue.globeMatrix)),oe},Kn=(y,c,g,w,I,k,P,z,U,q,Z,ee,ae,me,ue)=>{const{cameraToCenterDistance:oe,_pitch:Me}=I.transform;return h.extend(Da(y,c,g,w,I,k,P,z,U,q,ee,ae,me,ue),{u_gamma_scale:w?oe*Math.cos(I.terrain?0:Me):1,u_device_pixel_ratio:h.exported.devicePixelRatio,u_is_halo:+Z})},_o=(y,c,g,w,I,k,P,z,U,q,Z,ee,ae,me)=>h.extend(Kn(y,c,g,w,I,k,P,z,!0,U,!0,Z,ee,ae,me),{u_texsize_icon:q,u_texture_icon:1}),Yl=(y,c,g)=>({u_matrix:y,u_opacity:c,u_color:g}),Pa=(y,c,g,w,I,k)=>h.extend(function(P,z,U,q){const Z=U.imageManager.getPattern(P.from.toString()),ee=U.imageManager.getPattern(P.to.toString()),{width:ae,height:me}=U.imageManager.getPixelSize(),ue=Math.pow(2,q.tileID.overscaledZ),oe=q.tileSize*Math.pow(2,U.transform.tileZoom)/ue,Me=oe*(q.tileID.canonical.x+q.tileID.wrap*ue),ye=oe*q.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:Z.tl,u_pattern_br_a:Z.br,u_pattern_tl_b:ee.tl,u_pattern_br_b:ee.br,u_texsize:[ae,me],u_mix:z.t,u_pattern_size_a:Z.displaySize,u_pattern_size_b:ee.displaySize,u_scale_a:z.fromScale,u_scale_b:z.toScale,u_tile_units_to_pixels:1/mt(q,1,U.transform.tileZoom),u_pixel_coord_upper:[Me>>16,ye>>16],u_pixel_coord_lower:[65535&Me,65535&ye]}}(w,k,g,I),{u_matrix:y,u_opacity:c}),Ri={fillExtrusion:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_lightpos:new h.Uniform3f(y,c.u_lightpos),u_lightintensity:new h.Uniform1f(y,c.u_lightintensity),u_lightcolor:new h.Uniform3f(y,c.u_lightcolor),u_vertical_gradient:new h.Uniform1f(y,c.u_vertical_gradient),u_opacity:new h.Uniform1f(y,c.u_opacity),u_tile_id:new h.Uniform3f(y,c.u_tile_id),u_zoom_transition:new h.Uniform1f(y,c.u_zoom_transition),u_inv_rot_matrix:new h.UniformMatrix4f(y,c.u_inv_rot_matrix),u_merc_center:new h.Uniform2f(y,c.u_merc_center),u_up_dir:new h.Uniform3f(y,c.u_up_dir),u_height_lift:new h.Uniform1f(y,c.u_height_lift)}),fillExtrusionPattern:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_lightpos:new h.Uniform3f(y,c.u_lightpos),u_lightintensity:new h.Uniform1f(y,c.u_lightintensity),u_lightcolor:new h.Uniform3f(y,c.u_lightcolor),u_vertical_gradient:new h.Uniform1f(y,c.u_vertical_gradient),u_height_factor:new h.Uniform1f(y,c.u_height_factor),u_tile_id:new h.Uniform3f(y,c.u_tile_id),u_zoom_transition:new h.Uniform1f(y,c.u_zoom_transition),u_inv_rot_matrix:new h.UniformMatrix4f(y,c.u_inv_rot_matrix),u_merc_center:new h.Uniform2f(y,c.u_merc_center),u_up_dir:new h.Uniform3f(y,c.u_up_dir),u_height_lift:new h.Uniform1f(y,c.u_height_lift),u_image:new h.Uniform1i(y,c.u_image),u_texsize:new h.Uniform2f(y,c.u_texsize),u_pixel_coord_upper:new h.Uniform2f(y,c.u_pixel_coord_upper),u_pixel_coord_lower:new h.Uniform2f(y,c.u_pixel_coord_lower),u_scale:new h.Uniform3f(y,c.u_scale),u_fade:new h.Uniform1f(y,c.u_fade),u_opacity:new h.Uniform1f(y,c.u_opacity)}),fill:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix)}),fillPattern:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_image:new h.Uniform1i(y,c.u_image),u_texsize:new h.Uniform2f(y,c.u_texsize),u_pixel_coord_upper:new h.Uniform2f(y,c.u_pixel_coord_upper),u_pixel_coord_lower:new h.Uniform2f(y,c.u_pixel_coord_lower),u_scale:new h.Uniform3f(y,c.u_scale),u_fade:new h.Uniform1f(y,c.u_fade)}),fillOutline:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_world:new h.Uniform2f(y,c.u_world)}),fillOutlinePattern:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_world:new h.Uniform2f(y,c.u_world),u_image:new h.Uniform1i(y,c.u_image),u_texsize:new h.Uniform2f(y,c.u_texsize),u_pixel_coord_upper:new h.Uniform2f(y,c.u_pixel_coord_upper),u_pixel_coord_lower:new h.Uniform2f(y,c.u_pixel_coord_lower),u_scale:new h.Uniform3f(y,c.u_scale),u_fade:new h.Uniform1f(y,c.u_fade)}),circle:(y,c)=>({u_camera_to_center_distance:new h.Uniform1f(y,c.u_camera_to_center_distance),u_extrude_scale:new h.UniformMatrix2f(y,c.u_extrude_scale),u_device_pixel_ratio:new h.Uniform1f(y,c.u_device_pixel_ratio),u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_inv_rot_matrix:new h.UniformMatrix4f(y,c.u_inv_rot_matrix),u_merc_center:new h.Uniform2f(y,c.u_merc_center),u_tile_id:new h.Uniform3f(y,c.u_tile_id),u_zoom_transition:new h.Uniform1f(y,c.u_zoom_transition),u_up_dir:new h.Uniform3f(y,c.u_up_dir)}),collisionBox:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_camera_to_center_distance:new h.Uniform1f(y,c.u_camera_to_center_distance),u_extrude_scale:new h.Uniform2f(y,c.u_extrude_scale)}),collisionCircle:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_inv_matrix:new h.UniformMatrix4f(y,c.u_inv_matrix),u_camera_to_center_distance:new h.Uniform1f(y,c.u_camera_to_center_distance),u_viewport_size:new h.Uniform2f(y,c.u_viewport_size)}),debug:(y,c)=>({u_color:new h.UniformColor(y,c.u_color),u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_overlay:new h.Uniform1i(y,c.u_overlay),u_overlay_scale:new h.Uniform1f(y,c.u_overlay_scale)}),clippingMask:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix)}),heatmap:(y,c)=>({u_extrude_scale:new h.Uniform1f(y,c.u_extrude_scale),u_intensity:new h.Uniform1f(y,c.u_intensity),u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_inv_rot_matrix:new h.UniformMatrix4f(y,c.u_inv_rot_matrix),u_merc_center:new h.Uniform2f(y,c.u_merc_center),u_tile_id:new h.Uniform3f(y,c.u_tile_id),u_zoom_transition:new h.Uniform1f(y,c.u_zoom_transition),u_up_dir:new h.Uniform3f(y,c.u_up_dir)}),heatmapTexture:(y,c)=>({u_image:new h.Uniform1i(y,c.u_image),u_color_ramp:new h.Uniform1i(y,c.u_color_ramp),u_opacity:new h.Uniform1f(y,c.u_opacity)}),hillshade:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_image:new h.Uniform1i(y,c.u_image),u_latrange:new h.Uniform2f(y,c.u_latrange),u_light:new h.Uniform2f(y,c.u_light),u_shadow:new h.UniformColor(y,c.u_shadow),u_highlight:new h.UniformColor(y,c.u_highlight),u_accent:new h.UniformColor(y,c.u_accent)}),hillshadePrepare:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_image:new h.Uniform1i(y,c.u_image),u_dimension:new h.Uniform2f(y,c.u_dimension),u_zoom:new h.Uniform1f(y,c.u_zoom),u_unpack:new h.Uniform4f(y,c.u_unpack)}),line:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_pixels_to_tile_units:new h.UniformMatrix2f(y,c.u_pixels_to_tile_units),u_device_pixel_ratio:new h.Uniform1f(y,c.u_device_pixel_ratio),u_units_to_pixels:new h.Uniform2f(y,c.u_units_to_pixels),u_dash_image:new h.Uniform1i(y,c.u_dash_image),u_gradient_image:new h.Uniform1i(y,c.u_gradient_image),u_image_height:new h.Uniform1f(y,c.u_image_height),u_texsize:new h.Uniform2f(y,c.u_texsize),u_scale:new h.Uniform3f(y,c.u_scale),u_mix:new h.Uniform1f(y,c.u_mix),u_alpha_discard_threshold:new h.Uniform1f(y,c.u_alpha_discard_threshold)}),linePattern:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_texsize:new h.Uniform2f(y,c.u_texsize),u_pixels_to_tile_units:new h.UniformMatrix2f(y,c.u_pixels_to_tile_units),u_device_pixel_ratio:new h.Uniform1f(y,c.u_device_pixel_ratio),u_image:new h.Uniform1i(y,c.u_image),u_units_to_pixels:new h.Uniform2f(y,c.u_units_to_pixels),u_scale:new h.Uniform3f(y,c.u_scale),u_fade:new h.Uniform1f(y,c.u_fade),u_alpha_discard_threshold:new h.Uniform1f(y,c.u_alpha_discard_threshold)}),raster:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_tl_parent:new h.Uniform2f(y,c.u_tl_parent),u_scale_parent:new h.Uniform1f(y,c.u_scale_parent),u_fade_t:new h.Uniform1f(y,c.u_fade_t),u_opacity:new h.Uniform1f(y,c.u_opacity),u_image0:new h.Uniform1i(y,c.u_image0),u_image1:new h.Uniform1i(y,c.u_image1),u_brightness_low:new h.Uniform1f(y,c.u_brightness_low),u_brightness_high:new h.Uniform1f(y,c.u_brightness_high),u_saturation_factor:new h.Uniform1f(y,c.u_saturation_factor),u_contrast_factor:new h.Uniform1f(y,c.u_contrast_factor),u_spin_weights:new h.Uniform3f(y,c.u_spin_weights),u_perspective_transform:new h.Uniform2f(y,c.u_perspective_transform)}),symbolIcon:(y,c)=>({u_is_size_zoom_constant:new h.Uniform1i(y,c.u_is_size_zoom_constant),u_is_size_feature_constant:new h.Uniform1i(y,c.u_is_size_feature_constant),u_size_t:new h.Uniform1f(y,c.u_size_t),u_size:new h.Uniform1f(y,c.u_size),u_camera_to_center_distance:new h.Uniform1f(y,c.u_camera_to_center_distance),u_rotate_symbol:new h.Uniform1i(y,c.u_rotate_symbol),u_aspect_ratio:new h.Uniform1f(y,c.u_aspect_ratio),u_fade_change:new h.Uniform1f(y,c.u_fade_change),u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_label_plane_matrix:new h.UniformMatrix4f(y,c.u_label_plane_matrix),u_coord_matrix:new h.UniformMatrix4f(y,c.u_coord_matrix),u_is_text:new h.Uniform1i(y,c.u_is_text),u_pitch_with_map:new h.Uniform1i(y,c.u_pitch_with_map),u_texsize:new h.Uniform2f(y,c.u_texsize),u_tile_id:new h.Uniform3f(y,c.u_tile_id),u_zoom_transition:new h.Uniform1f(y,c.u_zoom_transition),u_inv_rot_matrix:new h.UniformMatrix4f(y,c.u_inv_rot_matrix),u_merc_center:new h.Uniform2f(y,c.u_merc_center),u_camera_forward:new h.Uniform3f(y,c.u_camera_forward),u_tile_matrix:new h.UniformMatrix4f(y,c.u_tile_matrix),u_ecef_origin:new h.Uniform3f(y,c.u_ecef_origin),u_texture:new h.Uniform1i(y,c.u_texture)}),symbolSDF:(y,c)=>({u_is_size_zoom_constant:new h.Uniform1i(y,c.u_is_size_zoom_constant),u_is_size_feature_constant:new h.Uniform1i(y,c.u_is_size_feature_constant),u_size_t:new h.Uniform1f(y,c.u_size_t),u_size:new h.Uniform1f(y,c.u_size),u_camera_to_center_distance:new h.Uniform1f(y,c.u_camera_to_center_distance),u_rotate_symbol:new h.Uniform1i(y,c.u_rotate_symbol),u_aspect_ratio:new h.Uniform1f(y,c.u_aspect_ratio),u_fade_change:new h.Uniform1f(y,c.u_fade_change),u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_label_plane_matrix:new h.UniformMatrix4f(y,c.u_label_plane_matrix),u_coord_matrix:new h.UniformMatrix4f(y,c.u_coord_matrix),u_is_text:new h.Uniform1i(y,c.u_is_text),u_pitch_with_map:new h.Uniform1i(y,c.u_pitch_with_map),u_texsize:new h.Uniform2f(y,c.u_texsize),u_texture:new h.Uniform1i(y,c.u_texture),u_gamma_scale:new h.Uniform1f(y,c.u_gamma_scale),u_device_pixel_ratio:new h.Uniform1f(y,c.u_device_pixel_ratio),u_tile_id:new h.Uniform3f(y,c.u_tile_id),u_zoom_transition:new h.Uniform1f(y,c.u_zoom_transition),u_inv_rot_matrix:new h.UniformMatrix4f(y,c.u_inv_rot_matrix),u_merc_center:new h.Uniform2f(y,c.u_merc_center),u_camera_forward:new h.Uniform3f(y,c.u_camera_forward),u_tile_matrix:new h.UniformMatrix4f(y,c.u_tile_matrix),u_ecef_origin:new h.Uniform3f(y,c.u_ecef_origin),u_is_halo:new h.Uniform1i(y,c.u_is_halo)}),symbolTextAndIcon:(y,c)=>({u_is_size_zoom_constant:new h.Uniform1i(y,c.u_is_size_zoom_constant),u_is_size_feature_constant:new h.Uniform1i(y,c.u_is_size_feature_constant),u_size_t:new h.Uniform1f(y,c.u_size_t),u_size:new h.Uniform1f(y,c.u_size),u_camera_to_center_distance:new h.Uniform1f(y,c.u_camera_to_center_distance),u_rotate_symbol:new h.Uniform1i(y,c.u_rotate_symbol),u_aspect_ratio:new h.Uniform1f(y,c.u_aspect_ratio),u_fade_change:new h.Uniform1f(y,c.u_fade_change),u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_label_plane_matrix:new h.UniformMatrix4f(y,c.u_label_plane_matrix),u_coord_matrix:new h.UniformMatrix4f(y,c.u_coord_matrix),u_is_text:new h.Uniform1i(y,c.u_is_text),u_pitch_with_map:new h.Uniform1i(y,c.u_pitch_with_map),u_texsize:new h.Uniform2f(y,c.u_texsize),u_texsize_icon:new h.Uniform2f(y,c.u_texsize_icon),u_texture:new h.Uniform1i(y,c.u_texture),u_texture_icon:new h.Uniform1i(y,c.u_texture_icon),u_gamma_scale:new h.Uniform1f(y,c.u_gamma_scale),u_device_pixel_ratio:new h.Uniform1f(y,c.u_device_pixel_ratio),u_is_halo:new h.Uniform1i(y,c.u_is_halo)}),background:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_opacity:new h.Uniform1f(y,c.u_opacity),u_color:new h.UniformColor(y,c.u_color)}),backgroundPattern:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_opacity:new h.Uniform1f(y,c.u_opacity),u_image:new h.Uniform1i(y,c.u_image),u_pattern_tl_a:new h.Uniform2f(y,c.u_pattern_tl_a),u_pattern_br_a:new h.Uniform2f(y,c.u_pattern_br_a),u_pattern_tl_b:new h.Uniform2f(y,c.u_pattern_tl_b),u_pattern_br_b:new h.Uniform2f(y,c.u_pattern_br_b),u_texsize:new h.Uniform2f(y,c.u_texsize),u_mix:new h.Uniform1f(y,c.u_mix),u_pattern_size_a:new h.Uniform2f(y,c.u_pattern_size_a),u_pattern_size_b:new h.Uniform2f(y,c.u_pattern_size_b),u_scale_a:new h.Uniform1f(y,c.u_scale_a),u_scale_b:new h.Uniform1f(y,c.u_scale_b),u_pixel_coord_upper:new h.Uniform2f(y,c.u_pixel_coord_upper),u_pixel_coord_lower:new h.Uniform2f(y,c.u_pixel_coord_lower),u_tile_units_to_pixels:new h.Uniform1f(y,c.u_tile_units_to_pixels)}),terrainRaster:Ea,terrainDepth:Ea,skybox:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_sun_direction:new h.Uniform3f(y,c.u_sun_direction),u_cubemap:new h.Uniform1i(y,c.u_cubemap),u_opacity:new h.Uniform1f(y,c.u_opacity),u_temporal_offset:new h.Uniform1f(y,c.u_temporal_offset)}),skyboxGradient:(y,c)=>({u_matrix:new h.UniformMatrix4f(y,c.u_matrix),u_color_ramp:new h.Uniform1i(y,c.u_color_ramp),u_center_direction:new h.Uniform3f(y,c.u_center_direction),u_radius:new h.Uniform1f(y,c.u_radius),u_opacity:new h.Uniform1f(y,c.u_opacity),u_temporal_offset:new h.Uniform1f(y,c.u_temporal_offset)}),skyboxCapture:(y,c)=>({u_matrix_3f:new h.UniformMatrix3f(y,c.u_matrix_3f),u_sun_direction:new h.Uniform3f(y,c.u_sun_direction),u_sun_intensity:new h.Uniform1f(y,c.u_sun_intensity),u_color_tint_r:new h.Uniform4f(y,c.u_color_tint_r),u_color_tint_m:new h.Uniform4f(y,c.u_color_tint_m),u_luminance:new h.Uniform1f(y,c.u_luminance)}),globeRaster:(y,c)=>({u_proj_matrix:new h.UniformMatrix4f(y,c.u_proj_matrix),u_globe_matrix:new h.UniformMatrix4f(y,c.u_globe_matrix),u_merc_matrix:new h.UniformMatrix4f(y,c.u_merc_matrix),u_zoom_transition:new h.Uniform1f(y,c.u_zoom_transition),u_merc_center:new h.Uniform2f(y,c.u_merc_center),u_image0:new h.Uniform1i(y,c.u_image0),u_grid_matrix:new h.UniformMatrix3f(y,c.u_grid_matrix)}),globeAtmosphere:(y,c)=>({u_frustum_tl:new h.Uniform3f(y,c.u_frustum_tl),u_frustum_tr:new h.Uniform3f(y,c.u_frustum_tr),u_frustum_br:new h.Uniform3f(y,c.u_frustum_br),u_frustum_bl:new h.Uniform3f(y,c.u_frustum_bl),u_globe_pos:new h.Uniform3f(y,c.u_globe_pos),u_globe_radius:new h.Uniform1f(y,c.u_globe_radius),u_opacity:new h.Uniform1f(y,c.u_opacity),u_fadeout_range:new h.Uniform1f(y,c.u_fadeout_range),u_start_color:new h.Uniform3f(y,c.u_start_color),u_end_color:new h.Uniform3f(y,c.u_end_color)})};let Jn;function Wl(y,c,g,w,I,k,P){const z=y.context,U=z.gl,q=y.useProgram("collisionBox"),Z=[];let ee=0,ae=0;for(let Te=0;Te<w.length;Te++){const Se=w[Te],we=c.getTile(Se),ke=we.getBucket(g);if(!ke)continue;let $e=Se.projMatrix;I[0]===0&&I[1]===0||($e=y.translatePosMatrix(Se.projMatrix,we,I,k));const qe=P?ke.textCollisionBox:ke.iconCollisionBox,He=ke.collisionCircleArray;if(He.length>0){const Ye=h.create(),ht=$e;h.mul(Ye,ke.placementInvProjMatrix,y.transform.glCoordMatrix),h.mul(Ye,Ye,ke.placementViewportMatrix),Z.push({circleArray:He,circleOffset:ae,transform:ht,invTransform:Ye}),ee+=He.length/4,ae=ee}qe&&(y.terrain&&y.terrain.setupElevationDraw(we,q),q.draw(z,U.LINES,h.DepthMode.disabled,h.StencilMode.disabled,y.colorModeForRenderPass(),h.CullFaceMode.disabled,uh($e,y.transform,we),g.id,qe.layoutVertexBuffer,qe.indexBuffer,qe.segments,null,y.transform.zoom,null,qe.collisionVertexBuffer,qe.collisionVertexBufferExt))}if(!P||!Z.length)return;const me=y.useProgram("collisionCircle"),ue=new h.StructArrayLayout2f1f2i16;ue.resize(4*ee),ue._trim();let oe=0;for(const Te of Z)for(let Se=0;Se<Te.circleArray.length/4;Se++){const we=4*Se,ke=Te.circleArray[we+0],$e=Te.circleArray[we+1],qe=Te.circleArray[we+2],He=Te.circleArray[we+3];ue.emplace(oe++,ke,$e,qe,He,0),ue.emplace(oe++,ke,$e,qe,He,1),ue.emplace(oe++,ke,$e,qe,He,2),ue.emplace(oe++,ke,$e,qe,He,3)}(!Jn||Jn.length<2*ee)&&(Jn=function(Te){const Se=2*Te,we=new h.StructArrayLayout3ui6;we.resize(Se),we._trim();for(let ke=0;ke<Se;ke++){const $e=6*ke;we.uint16[$e+0]=4*ke+0,we.uint16[$e+1]=4*ke+1,we.uint16[$e+2]=4*ke+2,we.uint16[$e+3]=4*ke+2,we.uint16[$e+4]=4*ke+3,we.uint16[$e+5]=4*ke+0}return we}(ee));const Me=z.createIndexBuffer(Jn,!0),ye=z.createVertexBuffer(ue,h.collisionCircleLayout.members,!0);for(const Te of Z){const Se={u_matrix:Te.transform,u_inv_matrix:Te.invTransform,u_camera_to_center_distance:(Ee=y.transform).cameraToCenterDistance,u_viewport_size:[Ee.width,Ee.height]};me.draw(z,U.TRIANGLES,h.DepthMode.disabled,h.StencilMode.disabled,y.colorModeForRenderPass(),h.CullFaceMode.disabled,Se,g.id,ye,Me,h.SegmentVector.simpleSegment(0,2*Te.circleOffset,Te.circleArray.length,Te.circleArray.length/2),null,y.transform.zoom,null,null,null)}var Ee;ye.destroy(),Me.destroy()}const Ba=h.create();function Yo(y,c,g,w,I,k){const{horizontalAlign:P,verticalAlign:z}=h.getAnchorAlignment(y),U=-(P-.5)*c,q=-(z-.5)*g,Z=h.evaluateVariableOffset(y,w);return new h.pointGeometry((U/I+Z[0])*k,(q/I+Z[1])*k)}function mh(y,c,g,w,I,k,P,z,U,q,Z,ee){const ae=y.text.placedSymbolArray,me=y.text.dynamicLayoutVertexArray,ue=y.icon.dynamicLayoutVertexArray,oe={},Me=z.projMatrix,ye=k.elevation,Ee=ee.upVectorScale(z.canonical,k.center.lat,k.worldSize);me.clear();for(let Te=0;Te<ae.length;Te++){const Se=ae.get(Te),we=y.allowVerticalPlacement&&!Se.placedOrientation,ke=Se.hidden||!Se.crossTileID||we?null:w[Se.crossTileID];if(ke){const $e=new h.pointGeometry(Se.tileAnchorX,Se.tileAnchorY),qe=ee.upVector(z.canonical,$e.x,$e.y),He=ye?ye.getAtTileOffset(z,$e.x,$e.y):0,Ye=Xr([Se.projectedAnchorX+He*qe[0]*Ee.metersToTile,Se.projectedAnchorY+He*qe[1]*Ee.metersToTile,Se.projectedAnchorZ+He*qe[2]*Ee.metersToTile],g?Me:P),ht=Zi(k.cameraToCenterDistance,Ye.signedDistanceFromCamera);let Ue=I.evaluateSizeForFeature(y.textSizeData,q,Se)*ht/h.ONE_EM;g&&(Ue*=y.tilePixelRatio/U);const{width:lt,height:st,anchor:kt,textOffset:Ze,textScale:Ut}=ke,Gt=Yo(kt,lt,st,Ze,Ut,Ue),St=g?Tr($e.add(Gt),P,He*Ee.metersToLabelSpace).point:Ye.point.add(c?Gt.rotate(-k.angle):Gt),At=y.allowVerticalPlacement&&Se.placedOrientation===h.WritingMode.vertical?Math.PI/2:0;for(let Kt=0;Kt<Se.numGlyphs;Kt++)h.addDynamicAttributes(me,St,At);Z&&Se.associatedIconIndex>=0&&(oe[Se.associatedIconIndex]={shiftedAnchor:St,angle:At})}else sr(Se.numGlyphs,me)}if(Z){ue.clear();const Te=y.icon.placedSymbolArray;for(let Se=0;Se<Te.length;Se++){const we=Te.get(Se);if(we.hidden)sr(we.numGlyphs,ue);else{const ke=oe[Se];if(ke)for(let $e=0;$e<we.numGlyphs;$e++)h.addDynamicAttributes(ue,ke.shiftedAnchor,ke.angle);else sr(we.numGlyphs,ue)}}y.icon.dynamicLayoutVertexBuffer.updateData(ue)}y.text.dynamicLayoutVertexBuffer.updateData(me)}function gh(y,c,g){return g.iconsInText&&c?"symbolTextAndIcon":y?"symbolSDF":"symbolIcon"}function Ra(y,c,g,w,I,k,P,z,U,q,Z,ee){const ae=y.context,me=ae.gl,ue=y.transform,oe=z==="map",Me=U==="map",ye=oe&&g.layout.get("symbol-placement")!=="point",Ee=oe&&!Me&&!ye,Te=g.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Se=!1;const we=y.depthModeForSublayer(0,h.DepthMode.ReadOnly),ke=[h.mercatorXfromLng(ue.center.lng),h.mercatorYfromLat(ue.center.lat)],$e=g.layout.get("text-variable-anchor"),qe=ue.projection.name==="globe",He=qe?h.globeToMercatorTransition(ue.zoom):0,Ye=[],ht=[];y.terrain&&Me&&ht.push("PITCH_WITH_MAP_TERRAIN"),qe&&ht.push("PROJECTION_GLOBE_VIEW");for(const Ue of w){const lt=c.getTile(Ue),st=lt.getBucket(g);if(!st||st.projection!==ue.projection.name)continue;const kt=I?st.text:st.icon;if(!kt||st.fullyClipped||!kt.segments.get().length)continue;const Ze=kt.programConfigurations.get(g.id),Ut=I||st.sdfIcons,Gt=I?st.textSizeData:st.iconSizeData,St=Me||ue.pitch!==0,At=h.evaluateSizeForZoom(Gt,ue.zoom);let Kt,pi,Ft,ei,ki=[0,0],Yi=null;if(I){if(pi=lt.glyphAtlasTexture,Ft=me.LINEAR,Kt=lt.glyphAtlasTexture.size,st.iconsInText){ki=lt.imageAtlasTexture.size,Yi=lt.imageAtlasTexture;const jr=Gt.kind==="composite"||Gt.kind==="camera";ei=St||y.options.rotating||y.options.zooming||jr?me.LINEAR:me.NEAREST}}else{const jr=g.layout.get("icon-size").constantOr(0)!==1||st.iconsNeedLinear;pi=lt.imageAtlasTexture,Ft=Ut||y.options.rotating||y.options.zooming||jr||St?me.LINEAR:me.NEAREST,Kt=lt.imageAtlasTexture.size}const xr=y.transform.calculatePixelsToTileUnitsMatrix(lt),vr=Xn(Ue.projMatrix,lt.tileID.canonical,Me,oe,y.transform,xr),Ur=y.terrain&&Me&&ye?h.invert(h.create(),vr):Ba,cn=co(Ue.projMatrix,lt.tileID.canonical,Me,oe,y.transform,xr),En=$e&&st.hasTextData(),Fn=g.layout.get("icon-text-fit")!=="none"&&En&&st.hasIconData();if(ye){const jr=ue.elevation,to=jr?jr.getAtTileOffsetFunc(Ue,ue.center.lat,ue.worldSize,ue.projection):Mc=>[0,0,0];Oo(st,Ue.projMatrix,y,I,vr,cn,Me,q,to,Ue)}const Tn=ye||I&&$e||Fn,Wi=y.translatePosMatrix(Ue.projMatrix,lt,k,P),Ki=Tn?Ba:vr,Di=y.translatePosMatrix(cn,lt,k,P,!0),rr=ue.projection.createInversionMatrix(ue,Ue.canonical),Vr=Tn?ht.concat(["PROJECTED_POS_ON_VIEWPORT"]):ht,Xi=Ut&&g.paint.get(I?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Hr;Hr=Ut?st.iconsInText?_o(Gt.kind,At,Ee,Me,y,Wi,Ki,Di,Kt,ki,Ue,He,ke,rr):Kn(Gt.kind,At,Ee,Me,y,Wi,Ki,Di,I,Kt,!0,Ue,He,ke,rr):Da(Gt.kind,At,Ee,Me,y,Wi,Ki,Di,I,Kt,Ue,He,ke,rr);const hs={program:y.useProgram(gh(Ut,I,st),Ze,Vr),buffers:kt,uniformValues:Hr,atlasTexture:pi,atlasTextureIcon:Yi,atlasInterpolation:Ft,atlasInterpolationIcon:ei,isSDF:Ut,hasHalo:Xi,tile:lt,labelPlaneMatrixInv:Ur};if(Te&&st.canOverlap){Se=!0;const jr=kt.segments.get();for(const to of jr)Ye.push({segments:new h.SegmentVector([to]),sortKey:to.sortKey,state:hs})}else Ye.push({segments:kt.segments,sortKey:0,state:hs})}Se&&Ye.sort((Ue,lt)=>Ue.sortKey-lt.sortKey);for(const Ue of Ye){const lt=Ue.state;if(y.terrain&&y.terrain.setupElevationDraw(lt.tile,lt.program,{useDepthForOcclusion:!qe,labelPlaneMatrixInv:lt.labelPlaneMatrixInv}),ae.activeTexture.set(me.TEXTURE0),lt.atlasTexture.bind(lt.atlasInterpolation,me.CLAMP_TO_EDGE),lt.atlasTextureIcon&&(ae.activeTexture.set(me.TEXTURE1),lt.atlasTextureIcon&&lt.atlasTextureIcon.bind(lt.atlasInterpolationIcon,me.CLAMP_TO_EDGE)),lt.isSDF){const st=lt.uniformValues;lt.hasHalo&&(st.u_is_halo=1,Hl(lt.buffers,Ue.segments,g,y,lt.program,we,Z,ee,st)),st.u_is_halo=0}Hl(lt.buffers,Ue.segments,g,y,lt.program,we,Z,ee,lt.uniformValues)}}function Hl(y,c,g,w,I,k,P,z,U){const q=w.context;I.draw(q,q.gl.TRIANGLES,k,P,z,h.CullFaceMode.disabled,U,g.id,y.layoutVertexBuffer,y.indexBuffer,c,g.paint,w.transform.zoom,y.programConfigurations.get(g.id),y.dynamicLayoutVertexBuffer,y.opacityVertexBuffer)}function Fs(y,c,g,w,I,k,P){const z=y.context.gl,U=g.paint.get("fill-pattern"),q=U&&U.constantOr(1),Z=g.getCrossfadeParameters();let ee,ae,me,ue,oe;P?(ae=q&&!g.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ee=z.LINES):(ae=q?"fillPattern":"fill",ee=z.TRIANGLES);for(const Me of w){const ye=c.getTile(Me);if(q&&!ye.patternsLoaded())continue;const Ee=ye.getBucket(g);if(!Ee)continue;y.prepareDrawTile();const Te=Ee.programConfigurations.get(g.id),Se=y.useProgram(ae,Te);q&&(y.context.activeTexture.set(z.TEXTURE0),ye.imageAtlasTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),Te.updatePaintBuffers(Z));const we=U.constantOr(null);if(we&&ye.imageAtlas){const $e=ye.imageAtlas,qe=$e.patternPositions[we.to.toString()],He=$e.patternPositions[we.from.toString()];qe&&He&&Te.setConstantPatternPositions(qe,He)}const ke=y.translatePosMatrix(Me.projMatrix,ye,g.paint.get("fill-translate"),g.paint.get("fill-translate-anchor"));if(P){ue=Ee.indexBuffer2,oe=Ee.segments2;const $e=y.terrain&&y.terrain.renderingToTexture?y.terrain.drapeBufferSize:[z.drawingBufferWidth,z.drawingBufferHeight];me=ae==="fillOutlinePattern"&&q?Gl(ke,y,Z,ye,$e):Ls(ke,$e)}else ue=Ee.indexBuffer,oe=Ee.segments,me=q?Rs(ke,y,Z,ye):Bs(ke);y.prepareDrawProgram(y.context,Se,Me.toUnwrapped()),Se.draw(y.context,ee,I,y.stencilModeForClipping(Me),k,h.CullFaceMode.disabled,me,g.id,Ee.layoutVertexBuffer,ue,oe,g.paint,y.transform.zoom,Te)}}function yo(y,c,g,w,I,k,P){const z=y.context,U=z.gl,q=y.transform,Z=g.paint.get("fill-extrusion-pattern"),ee=Z.constantOr(1),ae=g.getCrossfadeParameters(),me=g.paint.get("fill-extrusion-opacity"),ue=function(Te){if(Te.projection.name!=="globe")return 0;const Se=Math.PI/32,we=Math.tan(Se),ke=h.earthRadius;return ke*Math.sqrt(1+2*we*we)-ke}(q),oe=q.projection.name==="globe",Me=oe?h.globeToMercatorTransition(q.zoom):0,ye=[h.mercatorXfromLng(q.center.lng),h.mercatorYfromLat(q.center.lat)],Ee=[];oe&&Ee.push("PROJECTION_GLOBE_VIEW");for(const Te of w){const Se=c.getTile(Te),we=Se.getBucket(g);if(!we||we.projection!==q.projection.name)continue;const ke=we.programConfigurations.get(g.id),$e=y.useProgram(ee?"fillExtrusionPattern":"fillExtrusion",ke,Ee);if(y.terrain){const lt=y.terrain;if(y.style.terrainSetForDrapingOnly())lt.setupElevationDraw(Se,$e,{useMeterToDem:!0});else{if(!we.enableTerrain)continue;if(lt.setupElevationDraw(Se,$e,{useMeterToDem:!0}),Wo(z,c,Te,we,g,lt),!we.centroidVertexBuffer){const st=$e.attributes.a_centroid_pos;st!==void 0&&U.vertexAttrib2f(st,0,0)}}}ee&&(y.context.activeTexture.set(U.TEXTURE0),Se.imageAtlasTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE),ke.updatePaintBuffers(ae));const qe=Z.constantOr(null);if(qe&&Se.imageAtlas){const lt=Se.imageAtlas,st=lt.patternPositions[qe.to.toString()],kt=lt.patternPositions[qe.from.toString()];st&&kt&&ke.setConstantPatternPositions(st,kt)}const He=y.translatePosMatrix(Te.projMatrix,Se,g.paint.get("fill-extrusion-translate"),g.paint.get("fill-extrusion-translate-anchor")),Ye=q.projection.createInversionMatrix(q,Te.canonical),ht=g.paint.get("fill-extrusion-vertical-gradient"),Ue=ee?Ps(He,y,ht,me,Te,ae,Se,ue,Me,ye,Ye):Ds(He,y,ht,me,Te,ue,Me,ye,Ye);y.prepareDrawProgram(z,$e,Te.toUnwrapped()),$e.draw(z,z.gl.TRIANGLES,I,k,P,h.CullFaceMode.backCCW,Ue,g.id,we.layoutVertexBuffer,we.indexBuffer,we.segments,g.paint,y.transform.zoom,ke,y.terrain?we.centroidVertexBuffer:null,oe?we.layoutVertexExtBuffer:null)}}function Wo(y,c,g,w,I,k){const P=[ye=>{let Ee=ye.canonical.x-1,Te=ye.wrap;return Ee<0&&(Ee=(1<<ye.canonical.z)-1,Te--),new h.OverscaledTileID(ye.overscaledZ,Te,ye.canonical.z,Ee,ye.canonical.y)},ye=>{let Ee=ye.canonical.x+1,Te=ye.wrap;return Ee===1<<ye.canonical.z&&(Ee=0,Te++),new h.OverscaledTileID(ye.overscaledZ,Te,ye.canonical.z,Ee,ye.canonical.y)},ye=>new h.OverscaledTileID(ye.overscaledZ,ye.wrap,ye.canonical.z,ye.canonical.x,(ye.canonical.y===0?1<<ye.canonical.z:ye.canonical.y)-1),ye=>new h.OverscaledTileID(ye.overscaledZ,ye.wrap,ye.canonical.z,ye.canonical.x,ye.canonical.y===(1<<ye.canonical.z)-1?0:ye.canonical.y+1)],z=ye=>{const Ee=c.getSource().minzoom,Te=we=>{const ke=c.getTileByID(we);if(ke&&ke.hasData())return ke.getBucket(I)},Se=[0,-1,1];for(const we of Se){if(ye.overscaledZ+we<Ee)continue;const ke=Te(ye.calculateScaledKey(ye.overscaledZ+we));if(ke)return ke}},U=[0,0,0],q=(ye,Ee)=>(U[0]=Math.min(ye.min.y,Ee.min.y),U[1]=Math.max(ye.max.y,Ee.max.y),U[2]=h.EXTENT-Ee.min.x>ye.max.x?Ee.min.x-h.EXTENT:ye.max.x,U),Z=(ye,Ee)=>(U[0]=Math.min(ye.min.x,Ee.min.x),U[1]=Math.max(ye.max.x,Ee.max.x),U[2]=h.EXTENT-Ee.min.y>ye.max.y?Ee.min.y-h.EXTENT:ye.max.y,U),ee=[(ye,Ee)=>q(ye,Ee),(ye,Ee)=>q(Ee,ye),(ye,Ee)=>Z(ye,Ee),(ye,Ee)=>Z(Ee,ye)],ae=new h.pointGeometry(0,0);let me,ue,oe;const Me=(ye,Ee,Te,Se,we)=>{const ke=[[Se?Te:ye,Se?ye:Te,0],[Se?Te:Ee,Se?Ee:Te,0]],$e=we<0?h.EXTENT+we:we,qe=[Se?$e:(ye+Ee)/2,Se?(ye+Ee)/2:$e,0];return Te===0&&we<0||Te!==0&&we>0?k.getForTilePoints(oe,[qe],!0,ue):ke.push(qe),k.getForTilePoints(g,ke,!0,me),Math.max(ke[0][2],ke[1][2],qe[2])/k.exaggeration()};for(let ye=0;ye<4;ye++){const Ee=(ye<2?1:5)-ye,Te=w.borders[ye];if(Te.length===0)continue;const Se=oe=P[ye](g),we=z(Se);if(!(we&&we instanceof h.FillExtrusionBucket&&we.enableTerrain)||w.borderDoneWithNeighborZ[ye]===we.canonical.z&&we.borderDoneWithNeighborZ[Ee]===w.canonical.z||(ue=k.findDEMTileFor(Se),!ue||!ue.dem))continue;if(!me){const He=k.findDEMTileFor(g);if(!He||!He.dem)return;me=He}const ke=we.borders[Ee];let $e=0;const qe=we.borderDoneWithNeighborZ[Ee]!==w.canonical.z;if(w.canonical.z===we.canonical.z){for(let He=0;He<Te.length;He++){const Ye=w.featuresOnBorder[Te[He]],ht=Ye.borders[ye];let Ue;for(;$e<ke.length&&(Ue=we.featuresOnBorder[ke[$e]],!(Ue.borders[Ee][1]>ht[0]+3));)qe&&we.encodeCentroid(void 0,Ue,!1),$e++;if(Ue&&$e<ke.length){const lt=$e;let st=0;for(;!(Ue.borders[Ee][0]>ht[1]-3)&&(st++,++$e!==ke.length);)Ue=we.featuresOnBorder[ke[$e]];if(Ue=we.featuresOnBorder[ke[lt]],Ye.intersectsCount()>1||Ue.intersectsCount()>1||st!==1){st!==1&&($e=lt),w.encodeCentroid(void 0,Ye,!1),qe&&we.encodeCentroid(void 0,Ue,!1);continue}const kt=ee[ye](Ye,Ue),Ze=ye%2?h.EXTENT-1:0;ae.x=Me(kt[0],Math.min(h.EXTENT-1,kt[1]),Ze,ye<2,kt[2]),ae.y=0,w.encodeCentroid(ae,Ye,!1),qe&&we.encodeCentroid(ae,Ue,!1)}else w.encodeCentroid(void 0,Ye,!1)}w.borderDoneWithNeighborZ[ye]=we.canonical.z,w.needsCentroidUpdate=!0,qe&&(we.borderDoneWithNeighborZ[Ee]=w.canonical.z,we.needsCentroidUpdate=!0)}else{for(const He of Te)w.encodeCentroid(void 0,w.featuresOnBorder[He],!1);if(qe){for(const He of ke)we.encodeCentroid(void 0,we.featuresOnBorder[He],!1);we.borderDoneWithNeighborZ[Ee]=w.canonical.z,we.needsCentroidUpdate=!0}w.borderDoneWithNeighborZ[ye]=we.canonical.z,w.needsCentroidUpdate=!0}}(w.needsCentroidUpdate||!w.centroidVertexBuffer&&w.centroidVertexArray.length!==0)&&w.uploadCentroid(y)}const La=new h.Color(1,0,0,1),za=new h.Color(0,1,0,1),Kl=new h.Color(0,0,1,1),Os=new h.Color(1,0,1,1),Ns=new h.Color(0,1,1,1);function vt(y,c,g,w){Ho(y,0,c+g/2,y.transform.width,g,w)}function Yr(y,c,g,w){Ho(y,c-g/2,0,g,y.transform.height,w)}function Ho(y,c,g,w,I,k){const P=y.context,z=P.gl;z.enable(z.SCISSOR_TEST),z.scissor(c*h.exported.devicePixelRatio,g*h.exported.devicePixelRatio,w*h.exported.devicePixelRatio,I*h.exported.devicePixelRatio),P.clear({color:k}),z.disable(z.SCISSOR_TEST)}function Jl(y,c,g){const w=y.context,I=w.gl,k=y.transform.projection.name==="globe",P=g.projMatrix,z=y.useProgram("debug",null,k?["PROJECTION_GLOBE_VIEW"]:null),U=c.getTileByID(g.key);y.terrain&&y.terrain.setupElevationDraw(U,z);const q=h.DepthMode.disabled,Z=h.StencilMode.disabled,ee=y.colorModeForRenderPass(),ae="$debug";w.activeTexture.set(I.TEXTURE0),y.emptyTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),k?U._makeGlobeTileDebugBuffers(y.context,y.transform.projection):U._makeDebugTileBoundsBuffers(y.context,y.transform.projection);const me=U._tileDebugBuffer||y.debugBuffer,ue=U._tileDebugIndexBuffer||y.debugIndexBuffer,oe=U._tileDebugSegments||y.debugSegments;z.draw(w,I.LINE_STRIP,q,Z,ee,h.CullFaceMode.disabled,Zl(P,h.Color.red),ae,me,ue,oe,null,null,null,U._globeTileDebugBorderBuffer);const Me=U.latestRawTileData,ye=Math.floor((Me&&Me.byteLength||0)/1024),Ee=c.getTile(g).tileSize,Te=512/Math.min(Ee,512)*(g.overscaledZ/y.transform.zoom)*.5;let Se=g.canonical.toString();g.overscaledZ!==g.canonical.z&&(Se+=` => ${g.overscaledZ}`),function(qe,He){qe.initDebugOverlayCanvas();const Ye=qe.debugOverlayCanvas,ht=qe.context.gl,Ue=qe.debugOverlayCanvas.getContext("2d");Ue.clearRect(0,0,Ye.width,Ye.height),Ue.shadowColor="white",Ue.shadowBlur=2,Ue.lineWidth=1.5,Ue.strokeStyle="white",Ue.textBaseline="top",Ue.font="bold 36px Open Sans, sans-serif",Ue.fillText(He,5,5),Ue.strokeText(He,5,5),qe.debugOverlayTexture.update(Ye),qe.debugOverlayTexture.bind(ht.LINEAR,ht.CLAMP_TO_EDGE)}(y,`${Se} ${ye}kb`);const we=U._tileDebugTextBuffer||y.debugBuffer,ke=U._tileDebugTextIndexBuffer||y.quadTriangleIndexBuffer,$e=U._tileDebugTextSegments||y.debugSegments;z.draw(w,I.TRIANGLES,q,Z,h.ColorMode.alphaBlended,h.CullFaceMode.disabled,Zl(P,h.Color.transparent,Te),ae,we,ke,$e,null,null,null,U._globeTileDebugTextBuffer)}const Ql=h.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:xo}=Ql;function vn(y,c,g,w){y.emplaceBack(c,g,w)}class Ko{constructor(c){this.vertexArray=new h.StructArrayLayout3f12,this.indices=new h.StructArrayLayout3ui6,vn(this.vertexArray,-1,-1,1),vn(this.vertexArray,1,-1,1),vn(this.vertexArray,-1,1,1),vn(this.vertexArray,1,1,1),vn(this.vertexArray,-1,-1,-1),vn(this.vertexArray,1,-1,-1),vn(this.vertexArray,-1,1,-1),vn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=c.createVertexBuffer(this.vertexArray,xo),this.indexBuffer=c.createIndexBuffer(this.indices),this.segment=h.SegmentVector.simpleSegment(0,0,36,12)}}function Pn(y,c,g,w,I,k){const P=y.gl,z=c.paint.get("sky-atmosphere-color"),U=c.paint.get("sky-atmosphere-halo-color"),q=c.paint.get("sky-atmosphere-sun-intensity"),Z=((ee,ae,me,ue,oe)=>({u_matrix_3f:ee,u_sun_direction:ae,u_sun_intensity:me,u_color_tint_r:[ue.r,ue.g,ue.b,ue.a],u_color_tint_m:[oe.r,oe.g,oe.b,oe.a],u_luminance:5e-5}))(h.fromMat4(h.create$1(),w),I,q,z,U);P.framebufferTexture2D(P.FRAMEBUFFER,P.COLOR_ATTACHMENT0,P.TEXTURE_CUBE_MAP_POSITIVE_X+k,c.skyboxTexture,0),g.draw(y,P.TRIANGLES,h.DepthMode.disabled,h.StencilMode.disabled,h.ColorMode.unblended,h.CullFaceMode.frontCW,Z,"skyboxCapture",c.skyboxGeometry.vertexBuffer,c.skyboxGeometry.indexBuffer,c.skyboxGeometry.segment)}function Bn(y,c){return h.transformMat4(y,y,c)}const Fa={symbol:function(y,c,g,w,I){if(y.renderPass!=="translucent")return;const k=h.StencilMode.disabled,P=y.colorModeForRenderPass();g.layout.get("text-variable-anchor")&&function(z,U,q,Z,ee,ae,me){const ue=U.transform,oe=ee==="map",Me=ae==="map";for(const ye of z){const Ee=Z.getTile(ye),Te=Ee.getBucket(q);if(!Te||Te.projection!==ue.projection.name||!Te.text||!Te.text.segments.get().length)continue;const Se=h.evaluateSizeForZoom(Te.textSizeData,ue.zoom),we=U.transform.calculatePixelsToTileUnitsMatrix(Ee),ke=Xn(ye.projMatrix,Ee.tileID.canonical,Me,oe,U.transform,we),$e=q.layout.get("icon-text-fit")!=="none"&&Te.hasIconData();if(Se){const qe=Math.pow(2,ue.zoom-Ee.tileID.overscaledZ);mh(Te,oe,Me,me,h.symbolSize,ue,ke,ye,qe,Se,$e,ue.projection)}}}(w,y,g,c,g.layout.get("text-rotation-alignment"),g.layout.get("text-pitch-alignment"),I),g.paint.get("icon-opacity").constantOr(1)!==0&&Ra(y,c,g,w,!1,g.paint.get("icon-translate"),g.paint.get("icon-translate-anchor"),g.layout.get("icon-rotation-alignment"),g.layout.get("icon-pitch-alignment"),g.layout.get("icon-keep-upright"),k,P),g.paint.get("text-opacity").constantOr(1)!==0&&Ra(y,c,g,w,!0,g.paint.get("text-translate"),g.paint.get("text-translate-anchor"),g.layout.get("text-rotation-alignment"),g.layout.get("text-pitch-alignment"),g.layout.get("text-keep-upright"),k,P),c.map.showCollisionBoxes&&(Wl(y,c,g,w,g.paint.get("text-translate"),g.paint.get("text-translate-anchor"),!0),Wl(y,c,g,w,g.paint.get("icon-translate"),g.paint.get("icon-translate-anchor"),!1))},circle:function(y,c,g,w){if(y.renderPass!=="translucent")return;const I=g.paint.get("circle-opacity"),k=g.paint.get("circle-stroke-width"),P=g.paint.get("circle-stroke-opacity"),z=g.layout.get("circle-sort-key").constantOr(1)!==void 0;if(I.constantOr(1)===0&&(k.constantOr(1)===0||P.constantOr(1)===0))return;const U=y.context,q=U.gl,Z=y.transform,ee=y.depthModeForSublayer(0,h.DepthMode.ReadOnly),ae=h.StencilMode.disabled,me=y.colorModeForRenderPass(),ue=Z.projection.name==="globe",oe=[h.mercatorXfromLng(Z.center.lng),h.mercatorYfromLat(Z.center.lat)],Me=[];for(let Ee=0;Ee<w.length;Ee++){const Te=w[Ee],Se=c.getTile(Te),we=Se.getBucket(g);if(!we)continue;const ke=we.programConfigurations.get(g.id),$e=hh(g);ue&&$e.push("PROJECTION_GLOBE_VIEW");const qe=y.useProgram("circle",ke,$e),He=we.layoutVertexBuffer,Ye=we.globeExtVertexBuffer,ht=we.indexBuffer,Ue=Z.projection.createInversionMatrix(Z,Te.canonical),lt={programConfiguration:ke,program:qe,layoutVertexBuffer:He,globeExtVertexBuffer:Ye,indexBuffer:ht,uniformValues:go(y,Te,Se,Ue,oe,g),tile:Se};if(z){const st=we.segments.get();for(const kt of st)Me.push({segments:new h.SegmentVector([kt]),sortKey:kt.sortKey,state:lt})}else Me.push({segments:we.segments,sortKey:0,state:lt})}z&&Me.sort((Ee,Te)=>Ee.sortKey-Te.sortKey);const ye={useDepthForOcclusion:!ue};for(const Ee of Me){const{programConfiguration:Te,program:Se,layoutVertexBuffer:we,globeExtVertexBuffer:ke,indexBuffer:$e,uniformValues:qe,tile:He}=Ee.state,Ye=Ee.segments;y.terrain&&y.terrain.setupElevationDraw(He,Se,ye),y.prepareDrawProgram(U,Se,He.tileID.toUnwrapped()),Se.draw(U,q.TRIANGLES,ee,ae,me,h.CullFaceMode.disabled,qe,g.id,we,$e,Ye,g.paint,Z.zoom,Te,ue?ke:null)}},heatmap:function(y,c,g,w){if(g.paint.get("heatmap-opacity")!==0)if(y.renderPass==="offscreen"){const I=y.context,k=I.gl,P=h.StencilMode.disabled,z=new h.ColorMode([k.ONE,k.ONE],h.Color.transparent,[!0,!0,!0,!0]);(function(ae,me,ue){const oe=ae.gl;ae.activeTexture.set(oe.TEXTURE1),ae.viewport.set([0,0,me.width/4,me.height/4]);let Me=ue.heatmapFbo;if(Me)oe.bindTexture(oe.TEXTURE_2D,Me.colorAttachment.get()),ae.bindFramebuffer.set(Me.framebuffer);else{const ye=oe.createTexture();oe.bindTexture(oe.TEXTURE_2D,ye),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_WRAP_S,oe.CLAMP_TO_EDGE),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_WRAP_T,oe.CLAMP_TO_EDGE),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_MIN_FILTER,oe.LINEAR),oe.texParameteri(oe.TEXTURE_2D,oe.TEXTURE_MAG_FILTER,oe.LINEAR),Me=ue.heatmapFbo=ae.createFramebuffer(me.width/4,me.height/4,!1),function(Ee,Te,Se,we){const ke=Ee.gl;ke.texImage2D(ke.TEXTURE_2D,0,ke.RGBA,Te.width/4,Te.height/4,0,ke.RGBA,Ee.extRenderToTextureHalfFloat?Ee.extTextureHalfFloat.HALF_FLOAT_OES:ke.UNSIGNED_BYTE,null),we.colorAttachment.set(Se)}(ae,me,ye,Me)}})(I,y,g),I.clear({color:h.Color.transparent});const U=y.transform,q=U.projection.name==="globe",Z=q?["PROJECTION_GLOBE_VIEW"]:null,ee=[h.mercatorXfromLng(U.center.lng),h.mercatorYfromLat(U.center.lat)];for(let ae=0;ae<w.length;ae++){const me=w[ae];if(c.hasRenderableParent(me))continue;const ue=c.getTile(me),oe=ue.getBucket(g);if(!oe)continue;const Me=oe.programConfigurations.get(g.id),ye=y.useProgram("heatmap",Me,Z),{zoom:Ee}=y.transform;y.terrain&&y.terrain.setupElevationDraw(ue,ye),y.prepareDrawProgram(I,ye,me.toUnwrapped());const Te=U.projection.createInversionMatrix(U,me.canonical);ye.draw(I,k.TRIANGLES,h.DepthMode.disabled,P,z,h.CullFaceMode.disabled,fh(y,me,ue,Te,ee,Ee,g.paint.get("heatmap-intensity")),g.id,oe.layoutVertexBuffer,oe.indexBuffer,oe.segments,g.paint,y.transform.zoom,Me,q?oe.globeExtVertexBuffer:null)}I.viewport.set([0,0,y.width,y.height])}else y.renderPass==="translucent"&&(y.context.setColorMode(y.colorModeForRenderPass()),function(I,k){const P=I.context,z=P.gl,U=k.heatmapFbo;if(!U)return;P.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_2D,U.colorAttachment.get()),P.activeTexture.set(z.TEXTURE1);let q=k.colorRampTexture;q||(q=k.colorRampTexture=new h.Texture(P,k.colorRamp,z.RGBA)),q.bind(z.LINEAR,z.CLAMP_TO_EDGE),I.useProgram("heatmapTexture").draw(P,z.TRIANGLES,h.DepthMode.disabled,h.StencilMode.disabled,I.colorModeForRenderPass(),h.CullFaceMode.disabled,((Z,ee,ae,me)=>({u_image:0,u_color_ramp:1,u_opacity:ee.paint.get("heatmap-opacity")}))(0,k),k.id,I.viewportBuffer,I.quadTriangleIndexBuffer,I.viewportSegments,k.paint,I.transform.zoom)}(y,g))},line:function(y,c,g,w){if(y.renderPass!=="translucent")return;const I=g.paint.get("line-opacity"),k=g.paint.get("line-width");if(I.constantOr(1)===0||k.constantOr(1)===0)return;const P=y.depthModeForSublayer(0,h.DepthMode.ReadOnly),z=y.colorModeForRenderPass(),U=y.terrain&&y.terrain.renderingToTexture?1:h.exported.devicePixelRatio,q=g.paint.get("line-dasharray"),Z=q.constantOr(1),ee=g.layout.get("line-cap"),ae=g.paint.get("line-pattern"),me=ae.constantOr(1),ue=g.paint.get("line-gradient"),oe=g.getCrossfadeParameters(),Me=me?"linePattern":"line",ye=y.context,Ee=ye.gl,Te=(we=>{const ke=[];ka(we)&&ke.push("RENDER_LINE_DASH"),we.paint.get("line-gradient")&&ke.push("RENDER_LINE_GRADIENT");const $e=we.paint.get("line-pattern").constantOr(1),qe=we.paint.get("line-opacity").constantOr(1)!==1;return!$e&&qe&&ke.push("RENDER_LINE_ALPHA_DISCARD"),ke})(g);let Se=Te.includes("RENDER_LINE_ALPHA_DISCARD");y.terrain&&y.terrain.clipOrMaskOverlapStencilType()&&(Se=!1);for(const we of w){const ke=c.getTile(we);if(me&&!ke.patternsLoaded())continue;const $e=ke.getBucket(g);if(!$e)continue;y.prepareDrawTile();const qe=$e.programConfigurations.get(g.id),He=y.useProgram(Me,qe,Te),Ye=ae.constantOr(null);if(Ye&&ke.imageAtlas){const Ze=ke.imageAtlas,Ut=Ze.patternPositions[Ye.to.toString()],Gt=Ze.patternPositions[Ye.from.toString()];Ut&&Gt&&qe.setConstantPatternPositions(Ut,Gt)}const ht=q.constantOr(null),Ue=ee.constantOr(null);if(!me&&ht&&Ue&&ke.lineAtlas){const Ze=ke.lineAtlas,Ut=Ze.getDash(ht.to,Ue),Gt=Ze.getDash(ht.from,Ue);Ut&&Gt&&qe.setConstantPatternPositions(Ut,Gt)}const lt=y.terrain?we.projMatrix:null,st=me?Ia(y,ke,g,oe,lt,U):ph(y,ke,g,oe,lt,$e.lineClipsArray.length,U);if(ue){const Ze=$e.gradients[g.id];let Ut=Ze.texture;if(g.gradientVersion!==Ze.version){let Gt=256;if(g.stepInterpolant){const St=c.getSource().maxzoom,At=we.canonical.z===St?Math.ceil(1<<y.transform.maxZoom-we.canonical.z):1;Gt=h.clamp(h.nextPowerOfTwo($e.maxLineLength/h.EXTENT*1024*At),256,ye.maxTextureSize)}Ze.gradient=h.renderColorRamp({expression:g.gradientExpression(),evaluationKey:"lineProgress",resolution:Gt,image:Ze.gradient||void 0,clips:$e.lineClipsArray}),Ze.texture?Ze.texture.update(Ze.gradient):Ze.texture=new h.Texture(ye,Ze.gradient,Ee.RGBA),Ze.version=g.gradientVersion,Ut=Ze.texture}ye.activeTexture.set(Ee.TEXTURE1),Ut.bind(g.stepInterpolant?Ee.NEAREST:Ee.LINEAR,Ee.CLAMP_TO_EDGE)}Z&&(ye.activeTexture.set(Ee.TEXTURE0),ke.lineAtlasTexture.bind(Ee.LINEAR,Ee.REPEAT),qe.updatePaintBuffers(oe)),me&&(ye.activeTexture.set(Ee.TEXTURE0),ke.imageAtlasTexture.bind(Ee.LINEAR,Ee.CLAMP_TO_EDGE),qe.updatePaintBuffers(oe)),y.prepareDrawProgram(ye,He,we.toUnwrapped());const kt=Ze=>{He.draw(ye,Ee.TRIANGLES,P,Ze,z,h.CullFaceMode.disabled,st,g.id,$e.layoutVertexBuffer,$e.indexBuffer,$e.segments,g.paint,y.transform.zoom,qe,$e.layoutVertexBuffer2)};if(Se){const Ze=y.stencilModeForClipping(we).ref;Ze===0&&y.terrain&&ye.clear({stencil:0});const Ut={func:Ee.EQUAL,mask:255};st.u_alpha_discard_threshold=.8,kt(new h.StencilMode(Ut,Ze,255,Ee.KEEP,Ee.KEEP,Ee.INVERT)),st.u_alpha_discard_threshold=0,kt(new h.StencilMode(Ut,Ze,255,Ee.KEEP,Ee.KEEP,Ee.KEEP))}else kt(y.stencilModeForClipping(we))}Se&&(y.resetStencilClippingMasks(),y.terrain&&ye.clear({stencil:0}))},fill:function(y,c,g,w){const I=g.paint.get("fill-color"),k=g.paint.get("fill-opacity");if(k.constantOr(1)===0)return;const P=y.colorModeForRenderPass(),z=g.paint.get("fill-pattern"),U=y.opaquePassEnabledForLayer()&&!z.constantOr(1)&&I.constantOr(h.Color.transparent).a===1&&k.constantOr(0)===1?"opaque":"translucent";if(y.renderPass===U){const q=y.depthModeForSublayer(1,y.renderPass==="opaque"?h.DepthMode.ReadWrite:h.DepthMode.ReadOnly);Fs(y,c,g,w,q,P,!1)}if(y.renderPass==="translucent"&&g.paint.get("fill-antialias")){const q=y.depthModeForSublayer(g.getPaintProperty("fill-outline-color")?2:0,h.DepthMode.ReadOnly);Fs(y,c,g,w,q,P,!0)}},"fill-extrusion":function(y,c,g,w){const I=g.paint.get("fill-extrusion-opacity");if(I!==0&&y.renderPass==="translucent"){const k=new h.DepthMode(y.context.gl.LEQUAL,h.DepthMode.ReadWrite,y.depthRangeFor3D);if(I!==1||g.paint.get("fill-extrusion-pattern").constantOr(1))yo(y,c,g,w,k,h.StencilMode.disabled,h.ColorMode.disabled),yo(y,c,g,w,k,y.stencilModeFor3D(),y.colorModeForRenderPass()),y.resetStencilClippingMasks();else{const P=y.colorModeForRenderPass();yo(y,c,g,w,k,h.StencilMode.disabled,P)}}},hillshade:function(y,c,g,w){if(y.renderPass!=="offscreen"&&y.renderPass!=="translucent")return;const I=y.context,k=y.depthModeForSublayer(0,h.DepthMode.ReadOnly),P=y.colorModeForRenderPass(),z=y.terrain&&y.terrain.renderingToTexture,[U,q]=y.renderPass!=="translucent"||z?[{},w]:y.stencilConfigForOverlap(w);for(const Z of q){const ee=c.getTile(Z);if(ee.needsHillshadePrepare&&y.renderPass==="offscreen")wa(y,ee,g,k,h.StencilMode.disabled,P);else if(y.renderPass==="translucent"){const ae=z&&y.terrain?y.terrain.stencilModeForRTTOverlap(Z):U[Z.overscaledZ];Ul(y,Z,ee,g,k,ae,P)}}I.viewport.set([0,0,y.width,y.height]),y.resetStencilClippingMasks()},raster:function(y,c,g,w,I,k){if(y.renderPass!=="translucent"||g.paint.get("raster-opacity")===0||!w.length)return;const P=y.context,z=P.gl,U=c.getSource(),q=y.useProgram("raster"),Z=y.colorModeForRenderPass(),ee=y.terrain&&y.terrain.renderingToTexture,[ae,me]=U instanceof Ce||ee?[{},w]:y.stencilConfigForOverlap(w),ue=me[me.length-1].overscaledZ,oe=!y.options.moving;for(const Me of me){const ye=ee?h.DepthMode.disabled:y.depthModeForSublayer(Me.overscaledZ-ue,g.paint.get("raster-opacity")===1?h.DepthMode.ReadWrite:h.DepthMode.ReadOnly,z.LESS),Ee=Me.toUnwrapped(),Te=c.getTile(Me);if(ee&&(!Te||!Te.hasData()))continue;const Se=ee?Me.projMatrix:y.transform.calculateProjMatrix(Ee,oe),we=y.terrain&&ee?y.terrain.stencilModeForRTTOverlap(Me):ae[Me.overscaledZ],ke=k?0:g.paint.get("raster-fade-duration");Te.registerFadeDuration(ke);const $e=c.findLoadedParent(Me,0),qe=Ma(Te,$e,c,y.transform,ke);let He,Ye;y.terrain&&y.terrain.prepareDrawTile();const ht=g.paint.get("raster-resampling")==="nearest"?z.NEAREST:z.LINEAR;P.activeTexture.set(z.TEXTURE0),Te.texture.bind(ht,z.CLAMP_TO_EDGE),P.activeTexture.set(z.TEXTURE1),$e?($e.texture.bind(ht,z.CLAMP_TO_EDGE),He=Math.pow(2,$e.tileID.overscaledZ-Te.tileID.overscaledZ),Ye=[Te.tileID.canonical.x*He%1,Te.tileID.canonical.y*He%1]):Te.texture.bind(ht,z.CLAMP_TO_EDGE);const Ue=Xl(Se,Ye||[0,0],He||1,qe,g,U instanceof Ce?U.perspectiveTransform:[0,0]);if(y.prepareDrawProgram(P,q,Ee),U instanceof Ce)U.boundsBuffer&&U.boundsSegments&&q.draw(P,z.TRIANGLES,ye,h.StencilMode.disabled,Z,h.CullFaceMode.disabled,Ue,g.id,U.boundsBuffer,y.quadTriangleIndexBuffer,U.boundsSegments);else{const{tileBoundsBuffer:lt,tileBoundsIndexBuffer:st,tileBoundsSegments:kt}=y.getTileBoundsBuffers(Te);q.draw(P,z.TRIANGLES,ye,we,Z,h.CullFaceMode.disabled,Ue,g.id,lt,st,kt)}}y.resetStencilClippingMasks()},background:function(y,c,g,w){const I=g.paint.get("background-color"),k=g.paint.get("background-opacity");if(k===0)return;const P=y.context,z=P.gl,U=y.transform,q=U.tileSize,Z=g.paint.get("background-pattern");if(y.isPatternMissing(Z))return;const ee=!Z&&I.a===1&&k===1&&y.opaquePassEnabledForLayer()?"opaque":"translucent";if(y.renderPass!==ee)return;const ae=h.StencilMode.disabled,me=y.depthModeForSublayer(0,ee==="opaque"?h.DepthMode.ReadWrite:h.DepthMode.ReadOnly),ue=y.colorModeForRenderPass(),oe=y.useProgram(Z?"backgroundPattern":"background");let Me,ye=w;ye||(Me=y.getBackgroundTiles(),ye=Object.values(Me).map(Te=>Te.tileID)),Z&&(P.activeTexture.set(z.TEXTURE0),y.imageManager.bind(y.context));const Ee=g.getCrossfadeParameters();for(const Te of ye){const Se=Te.toUnwrapped(),we=w?Te.projMatrix:y.transform.calculateProjMatrix(Se);y.prepareDrawTile();const ke=c?c.getTile(Te):Me?Me[Te.key]:new h.Tile(Te,q,U.zoom,y),$e=Z?Pa(we,k,y,Z,{tileID:Te,tileSize:q},Ee):Yl(we,k,I);y.prepareDrawProgram(P,oe,Se);const{tileBoundsBuffer:qe,tileBoundsIndexBuffer:He,tileBoundsSegments:Ye}=y.getTileBoundsBuffers(ke);oe.draw(P,z.TRIANGLES,me,ae,ue,h.CullFaceMode.disabled,$e,g.id,qe,He,Ye)}},sky:function(y,c,g){const w=y.transform,I=w.projection.name==="mercator"||w.projection.name==="globe"?1:h.smoothstep(7,8,w.zoom),k=g.paint.get("sky-opacity")*I;if(k===0)return;const P=y.context,z=g.paint.get("sky-type"),U=new h.DepthMode(P.gl.LEQUAL,h.DepthMode.ReadOnly,[0,1]),q=y.frameCounter/1e3%1;z==="atmosphere"?y.renderPass==="offscreen"?g.needsSkyboxCapture(y)&&(function(Z,ee,ae,me){const ue=Z.context,oe=ue.gl;let Me=ee.skyboxFbo;if(!Me){Me=ee.skyboxFbo=ue.createFramebuffer(32,32,!1),ee.skyboxGeometry=new Ko(ue),ee.skyboxTexture=ue.gl.createTexture(),oe.bindTexture(oe.TEXTURE_CUBE_MAP,ee.skyboxTexture),oe.texParameteri(oe.TEXTURE_CUBE_MAP,oe.TEXTURE_WRAP_S,oe.CLAMP_TO_EDGE),oe.texParameteri(oe.TEXTURE_CUBE_MAP,oe.TEXTURE_WRAP_T,oe.CLAMP_TO_EDGE),oe.texParameteri(oe.TEXTURE_CUBE_MAP,oe.TEXTURE_MIN_FILTER,oe.LINEAR),oe.texParameteri(oe.TEXTURE_CUBE_MAP,oe.TEXTURE_MAG_FILTER,oe.LINEAR);for(let Se=0;Se<6;++Se)oe.texImage2D(oe.TEXTURE_CUBE_MAP_POSITIVE_X+Se,0,oe.RGBA,32,32,0,oe.RGBA,oe.UNSIGNED_BYTE,null)}ue.bindFramebuffer.set(Me.framebuffer),ue.viewport.set([0,0,32,32]);const ye=ee.getCenter(Z,!0),Ee=Z.useProgram("skyboxCapture"),Te=new Float64Array(16);h.identity(Te),h.rotateY(Te,Te,.5*-Math.PI),Pn(ue,ee,Ee,Te,ye,0),h.identity(Te),h.rotateY(Te,Te,.5*Math.PI),Pn(ue,ee,Ee,Te,ye,1),h.identity(Te),h.rotateX(Te,Te,.5*-Math.PI),Pn(ue,ee,Ee,Te,ye,2),h.identity(Te),h.rotateX(Te,Te,.5*Math.PI),Pn(ue,ee,Ee,Te,ye,3),h.identity(Te),Pn(ue,ee,Ee,Te,ye,4),h.identity(Te),h.rotateY(Te,Te,Math.PI),Pn(ue,ee,Ee,Te,ye,5),ue.viewport.set([0,0,Z.width,Z.height])}(y,g),g.markSkyboxValid(y)):y.renderPass==="sky"&&function(Z,ee,ae,me,ue){const oe=Z.context,Me=oe.gl,ye=Z.transform,Ee=Z.useProgram("skybox");oe.activeTexture.set(Me.TEXTURE0),Me.bindTexture(Me.TEXTURE_CUBE_MAP,ee.skyboxTexture);const Te=((Se,we,ke,$e,qe)=>({u_matrix:Se,u_sun_direction:we,u_cubemap:0,u_opacity:$e,u_temporal_offset:qe}))(ye.skyboxMatrix,ee.getCenter(Z,!1),0,me,ue);Z.prepareDrawProgram(oe,Ee),Ee.draw(oe,Me.TRIANGLES,ae,h.StencilMode.disabled,Z.colorModeForRenderPass(),h.CullFaceMode.backCW,Te,"skybox",ee.skyboxGeometry.vertexBuffer,ee.skyboxGeometry.indexBuffer,ee.skyboxGeometry.segment)}(y,g,U,k,q):z==="gradient"&&y.renderPass==="sky"&&function(Z,ee,ae,me,ue){const oe=Z.context,Me=oe.gl,ye=Z.transform,Ee=Z.useProgram("skyboxGradient");ee.skyboxGeometry||(ee.skyboxGeometry=new Ko(oe)),oe.activeTexture.set(Me.TEXTURE0);let Te=ee.colorRampTexture;Te||(Te=ee.colorRampTexture=new h.Texture(oe,ee.colorRamp,Me.RGBA)),Te.bind(Me.LINEAR,Me.CLAMP_TO_EDGE);const Se=((we,ke,$e,qe,He)=>({u_matrix:we,u_color_ramp:0,u_center_direction:ke,u_radius:h.degToRad($e),u_opacity:qe,u_temporal_offset:He}))(ye.skyboxMatrix,ee.getCenter(Z,!1),ee.paint.get("sky-gradient-radius"),me,ue);Z.prepareDrawProgram(oe,Ee),Ee.draw(oe,Me.TRIANGLES,ae,h.StencilMode.disabled,Z.colorModeForRenderPass(),h.CullFaceMode.backCW,Se,"skyboxGradient",ee.skyboxGeometry.vertexBuffer,ee.skyboxGeometry.indexBuffer,ee.skyboxGeometry.segment)}(y,g,U,k,q)},debug:function(y,c,g){for(let w=0;w<g.length;w++)Jl(y,c,g[w])},custom:function(y,c,g){const w=y.context,I=g.implementation;if(y.transform.projection.unsupportedLayers&&y.transform.projection.unsupportedLayers.includes("custom"))h.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.");else if(y.renderPass==="offscreen"){const k=I.prerender;k&&(y.setCustomLayerDefaults(),w.setColorMode(y.colorModeForRenderPass()),k.call(I,w.gl,y.transform.customLayerMatrix()),w.setDirty(),y.setBaseState())}else if(y.renderPass==="translucent"){y.setCustomLayerDefaults(),w.setColorMode(y.colorModeForRenderPass()),w.setStencilMode(h.StencilMode.disabled);const k=I.renderingMode==="3d"?new h.DepthMode(y.context.gl.LEQUAL,h.DepthMode.ReadWrite,y.depthRangeFor3D):y.depthModeForSublayer(0,h.DepthMode.ReadOnly);w.setDepthMode(k),I.render(w.gl,y.transform.customLayerMatrix()),w.setDirty(),y.setBaseState(),w.bindFramebuffer.set(null)}}};class ec{constructor(c,g){this.context=new j(c),this.transform=g,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=h.SourceCache.maxUnderzooming+h.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Ms,this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this._tileClippingMaskIDs=new Map,this._skippedStencilTileIDs=new Set}updateTerrain(c,g){const w=!!c&&!!c.terrain&&this.transform.projection.supportsTerrain;if(!(w||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Or(this,c));const I=this._terrain;this.transform.elevation=w?I:null,I.update(c,this.transform,g)}_updateFog(c){const g=c.fog;if(!g||g.getOpacity(this.transform.pitch)<1||g.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[w,I]=g.getFovAdjustedRange(this.transform._fov);if(w>I)return void(this.transform.fogCullDistSq=null);const k=w+.78*(I-w);this.transform.fogCullDistSq=k*k}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(c,g){if(this.width=c*h.exported.devicePixelRatio,this.height=g*h.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const w of this.style.order)this.style._layers[w].resize()}setup(){const c=this.context,g=new h.StructArrayLayout2i4;g.emplaceBack(0,0),g.emplaceBack(h.EXTENT,0),g.emplaceBack(0,h.EXTENT),g.emplaceBack(h.EXTENT,h.EXTENT),this.tileExtentBuffer=c.createVertexBuffer(g,h.posAttributes.members),this.tileExtentSegments=h.SegmentVector.simpleSegment(0,0,4,2);const w=new h.StructArrayLayout2i4;w.emplaceBack(0,0),w.emplaceBack(h.EXTENT,0),w.emplaceBack(0,h.EXTENT),w.emplaceBack(h.EXTENT,h.EXTENT),this.debugBuffer=c.createVertexBuffer(w,h.posAttributes.members),this.debugSegments=h.SegmentVector.simpleSegment(0,0,4,5);const I=new h.StructArrayLayout2i4;I.emplaceBack(-1,-1),I.emplaceBack(1,-1),I.emplaceBack(-1,1),I.emplaceBack(1,1),this.viewportBuffer=c.createVertexBuffer(I,h.posAttributes.members),this.viewportSegments=h.SegmentVector.simpleSegment(0,0,4,2);const k=new h.StructArrayLayout4i8;k.emplaceBack(0,0,0,0),k.emplaceBack(h.EXTENT,0,h.EXTENT,0),k.emplaceBack(0,h.EXTENT,0,h.EXTENT),k.emplaceBack(h.EXTENT,h.EXTENT,h.EXTENT,h.EXTENT),this.mercatorBoundsBuffer=c.createVertexBuffer(k,h.boundsAttributes.members),this.mercatorBoundsSegments=h.SegmentVector.simpleSegment(0,0,4,2);const P=new h.StructArrayLayout3ui6;P.emplaceBack(0,1,2),P.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=c.createIndexBuffer(P);const z=new h.StructArrayLayout1ui2;for(const q of[0,1,3,2,0])z.emplaceBack(q);this.debugIndexBuffer=c.createIndexBuffer(z),this.emptyTexture=new h.Texture(c,new h.RGBAImage({width:1,height:1},Uint8Array.of(0,0,0,0)),c.gl.RGBA),this.identityMat=h.create();const U=this.context.gl;this.stencilClearMode=new h.StencilMode({func:U.ALWAYS,mask:0},0,255,U.ZERO,U.ZERO,U.ZERO),this.loadTimeStamps.push(h.window.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(c){return c._makeTileBoundsBuffers(this.context,this.transform.projection),c._tileBoundsBuffer?{tileBoundsBuffer:c._tileBoundsBuffer,tileBoundsIndexBuffer:c._tileBoundsIndexBuffer,tileBoundsSegments:c._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const c=this.context,g=c.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs.clear(),this._skippedStencilTileIDs.clear(),this.useProgram("clippingMask").draw(c,g.TRIANGLES,h.DepthMode.disabled,this.stencilClearMode,h.ColorMode.disabled,h.CullFaceMode.disabled,ks(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs.clear(),this._skippedStencilTileIDs.clear())}_renderTileClippingMasks(c,g,w){if(!g||this.currentStencilSource===g.id||!c.isTileClipped()||!w||w.length===0)return;const I=[];let k=!1;if(this._tileClippingMaskIDs&&!this.terrain){for(const Z of w)if(this._tileClippingMaskIDs.has(Z.key)||(k=!0),this._skippedStencilTileIDs.has(Z.key)){if(!g.getTile(Z).getBucket(c))continue;this._skippedStencilTileIDs.delete(Z.key),I.push(Z)}if(!k&&I.length===0)return}const P=this.context,z=P.gl;P.setColorMode(h.ColorMode.disabled),P.setDepthMode(h.DepthMode.disabled);const U=this.useProgram("clippingMask"),q=Z=>{const ee=g.getTile(Z),{tileBoundsBuffer:ae,tileBoundsIndexBuffer:me,tileBoundsSegments:ue}=this.getTileBoundsBuffers(ee);U.draw(P,z.TRIANGLES,h.DepthMode.disabled,new h.StencilMode({func:z.GREATER,mask:255},this._tileClippingMaskIDs.get(Z.key)||0,255,z.KEEP,z.KEEP,z.REPLACE),h.ColorMode.disabled,h.CullFaceMode.disabled,ks(Z.projMatrix),"$clipping",ae,me,ue)};if(!k&&I.length>0)for(const Z of I)q(Z);else{(this._tileClippingMaskIDs.size===0||this.nextStencilID+w.length>256)&&this.clearStencil(),this._tileClippingMaskIDs.clear(),this._skippedStencilTileIDs.clear();for(const Z of w)this._tileClippingMaskIDs.set(Z.key,this.nextStencilID++),g.getTile(Z).getBucket(c)?q(Z):this._skippedStencilTileIDs.add(Z.key)}this._skippedStencilTileIDs.size===0&&(this.currentStencilSource=g.id)}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const c=this.nextStencilID++,g=this.context.gl;return new h.StencilMode({func:g.NOTEQUAL,mask:255},c,255,g.KEEP,g.KEEP,g.REPLACE)}stencilModeForClipping(c){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(c);const g=this.context.gl;return new h.StencilMode({func:g.EQUAL,mask:255},this._tileClippingMaskIDs.get(c.key)||0,0,g.KEEP,g.KEEP,g.REPLACE)}stencilConfigForOverlap(c){const g=this.context.gl,w=c.sort((P,z)=>z.overscaledZ-P.overscaledZ),I=w[w.length-1].overscaledZ,k=w[0].overscaledZ-I+1;if(k>1){this.currentStencilSource=void 0,this.nextStencilID+k>256&&this.clearStencil();const P={};for(let z=0;z<k;z++)P[z+I]=new h.StencilMode({func:g.GEQUAL,mask:255},z+this.nextStencilID,255,g.KEEP,g.KEEP,g.REPLACE);return this.nextStencilID+=k,[P,w]}return[{[I]:h.StencilMode.disabled},w]}colorModeForRenderPass(){const c=this.context.gl;return this._showOverdrawInspector?new h.ColorMode([c.CONSTANT_COLOR,c.ONE],new h.Color(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?h.ColorMode.unblended:h.ColorMode.alphaBlended}depthModeForSublayer(c,g,w){if(!this.opaquePassEnabledForLayer())return h.DepthMode.disabled;const I=1-((1+this.currentLayer)*this.numSublayers+c)*this.depthEpsilon;return new h.DepthMode(w||this.context.gl.LEQUAL,g,[I,I])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(c,g){this.style=c,this.options=g,this.lineAtlas=c.lineAtlas,this.imageManager=c.imageManager,this.glyphManager=c.glyphManager,this.symbolFadeChange=c.placement.symbolFadeChange(h.exported.now()),this.imageManager.beginFrame();const w=this.style.order,I=this.style._sourceCaches;for(const q in I){const Z=I[q];Z.used&&Z.prepare(this.context)}const k={},P={},z={};for(const q in I){const Z=I[q];k[q]=Z.getVisibleCoordinates(),P[q]=k[q].slice().reverse(),z[q]=Z.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let q=0;q<w.length;q++)if(this.style._layers[w[q]].is3D()){this.opaquePassCutoff=q;break}if(this.terrain&&(this.terrain.updateTileBinding(z),this.opaquePassCutoff=0),this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new h.GlobeSharedBuffers(this.context)),!h.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const q of w){const Z=this.style._layers[q],ee=c._getLayerSourceCache(Z);if(!Z.hasOffscreenPass()||Z.isHidden(this.transform.zoom))continue;const ae=ee?P[ee.id]:void 0;(Z.type==="custom"||Z.isSky()||ae&&ae.length)&&this.renderLayer(this,ee,Z,ae)}this.depthRangeFor3D=[0,1-(c.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let U=h.Color.transparent;if(this.style.fog&&this.style.fog.getOpacity(this.transform.pitch)&&(U=this.style.fog.properties.get("color")),this.context.clear({color:g.showOverdrawInspector?h.Color.black:U,depth:1}),this.clearStencil(),this._showOverdrawInspector=g.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=w.length-1;this.currentLayer>=0;this.currentLayer--){const q=this.style._layers[w[this.currentLayer]],Z=c._getLayerSourceCache(q);if(q.isSky())continue;const ee=Z?P[Z.id]:void 0;this._renderTileClippingMasks(q,Z,ee),this.renderLayer(this,Z,q,ee)}if(this.renderPass="sky",(h.globeToMercatorTransition(this.transform.zoom)>0||this.transform.projection.name!=="globe")&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<w.length;this.currentLayer++){const q=this.style._layers[w[this.currentLayer]],Z=c._getLayerSourceCache(q);q.isSky()&&this.renderLayer(this,Z,q,Z?P[Z.id]:void 0)}for(this.transform.projection.name==="globe"&&function(q){const Z=q.context,ee=Z.gl,ae=q.transform,me=new h.DepthMode(ee.LEQUAL,h.DepthMode.ReadOnly,[0,1]),ue=q.useProgram("globeAtmosphere"),oe=ae.centerOffset,Me=ae._camera.getCameraToClipPerspective(ae._fov,ae.width/ae.height,ae._nearZ,ae._farZ);Me[8]=2*-oe.x/ae.width,Me[9]=2*oe.y/ae.height;const ye=h.invert([],Me),Ee=h.mul([],ye,ae.projMatrix),Te={u_frustum_tl:Bn([-1,1,1],ye),u_frustum_tr:Bn([1,1,1],ye),u_frustum_br:Bn([1,-1,1],ye),u_frustum_bl:Bn([-1,-1,1],ye),u_globe_pos:Bn([ae.globeMatrix[12],ae.globeMatrix[13],ae.globeMatrix[14]],Ee),u_globe_radius:ae.worldSize/2/Math.PI-1,u_opacity:1-h.globeToMercatorTransition(ae.zoom),u_fadeout_range:2,u_start_color:[1,1,1],u_end_color:[.0118,.7451,.9882]};q.prepareDrawProgram(Z,ue);const Se=q.globeSharedBuffers;Se&&ue.draw(Z,ee.TRIANGLES,me,h.StencilMode.disabled,h.ColorMode.alphaBlended,h.CullFaceMode.backCW,Te,"skybox",Se.atmosphereVertexBuffer,Se.atmosphereIndexBuffer,Se.atmosphereSegments)}(this),this.renderPass="translucent",this.currentLayer=0;this.currentLayer<w.length;){const q=this.style._layers[w[this.currentLayer]],Z=c._getLayerSourceCache(q);if(q.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(q)){if(q.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const ee=Z?(q.type==="symbol"?z:P)[Z.id]:void 0;this._renderTileClippingMasks(q,Z,Z?k[Z.id]:void 0),this.renderLayer(this,Z,q,ee),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry){let q=null;h.values(this.style._layers).forEach(Z=>{const ee=c._getLayerSourceCache(Z);ee&&!Z.isHidden(this.transform.zoom)&&(!q||q.getSource().maxzoom<ee.getSource().maxzoom)&&(q=ee)}),q&&this.options.showTileBoundaries&&Fa.debug(this,q,q.getVisibleCoordinates())}this.options.showPadding&&function(q){const Z=q.transform.padding;vt(q,q.transform.height-(Z.top||0),3,La),vt(q,Z.bottom||0,3,za),Yr(q,Z.left||0,3,Kl),Yr(q,q.transform.width-(Z.right||0),3,Os);const ee=q.transform.centerPoint;(function(ae,me,ue,oe){Ho(ae,me-1,ue-10,2,20,oe),Ho(ae,me-10,ue-1,20,2,oe)})(q,ee.x,q.transform.height-ee.y,Ns)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(h.window.performance.now()),this.saveCanvasCopy())}renderLayer(c,g,w,I){w.isHidden(this.transform.zoom)||(w.type==="background"||w.type==="sky"||w.type==="custom"||I&&I.length)&&(this.id=w.id,this.gpuTimingStart(w),c.transform.projection.unsupportedLayers&&c.transform.projection.unsupportedLayers.includes(w.type)||Fa[w.type](c,g,w,I,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(c){if(!this.options.gpuTiming)return;const g=this.context.extTimerQuery;let w=this.gpuTimers[c.id];w||(w=this.gpuTimers[c.id]={calls:0,cpuTime:0,query:g.createQueryEXT()}),w.calls++,g.beginQueryEXT(g.TIME_ELAPSED_EXT,w.query)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const c=this.context.extTimerQuery;c.endQueryEXT(c.TIME_ELAPSED_EXT)}collectGpuTimers(){const c=this.gpuTimers;return this.gpuTimers={},c}queryGpuTimers(c){const g={};for(const w in c){const I=c[w],k=this.context.extTimerQuery,P=k.getQueryObjectEXT(I.query,k.QUERY_RESULT_EXT)/1e6;k.deleteQueryEXT(I.query),g[w]=P}return g}translatePosMatrix(c,g,w,I,k){if(!w[0]&&!w[1])return c;const P=k?I==="map"?this.transform.angle:0:I==="viewport"?-this.transform.angle:0;if(P){const q=Math.sin(P),Z=Math.cos(P);w=[w[0]*Z-w[1]*q,w[0]*q+w[1]*Z]}const z=[k?w[0]:mt(g,w[0],this.transform.zoom),k?w[1]:mt(g,w[1],this.transform.zoom),0],U=new Float32Array(16);return h.translate(U,c,z),U}saveTileTexture(c){const g=this._tileTextures[c.size[0]];g?g.push(c):this._tileTextures[c.size[0]]=[c]}getTileTexture(c){const g=this._tileTextures[c];return g&&g.length>0?g.pop():null}isPatternMissing(c){if(!c)return!1;if(!c.from||!c.to)return!0;const g=this.imageManager.getPattern(c.from.toString()),w=this.imageManager.getPattern(c.to.toString());return!g||!w}currentGlobalDefines(){const c=this.terrain&&this.terrain.renderingToTexture,g=this.style&&this.style.fog,w=[];return this.terrain&&!this.terrain.renderingToTexture&&w.push("TERRAIN"),g&&!c&&g.getOpacity(this.transform.pitch)!==0&&w.push("FOG"),c&&w.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&w.push("OVERDRAW_INSPECTOR"),w}useProgram(c,g,w){this.cache=this.cache||{};const I=w||[],k=this.currentGlobalDefines().concat(I),P=Zo.cacheKey(c,k,g);return this.cache[P]||(this.cache[P]=new Zo(this.context,c,jo[c],g,Ri[c],k)),this.cache[P]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const c=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(c.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=h.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new h.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}prepareDrawProgram(c,g,w){if(this.terrain&&this.terrain.renderingToTexture)return;const I=this.style.fog;if(I){const k=I.getOpacity(this.transform.pitch);k!==0&&g.setFogUniformValues(c,((P,z,U,q)=>{const Z=z.properties.get("color"),ee=P.frameCounter/1e3%1,ae=[Z.r/Z.a,Z.g/Z.a,Z.b/Z.a,q];return{u_fog_matrix:U?P.transform.calculateFogTileMatrix(U):P.identityMat,u_fog_range:z.getFovAdjustedRange(P.transform._fov),u_fog_color:ae,u_fog_horizon_blend:z.properties.get("horizon-blend"),u_fog_temporal_offset:ee}})(this,I,w,k))}}setTileLoadedFlag(c){this.tileLoaded=c}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1}canvasCopy(){const c=this.context.gl,g=c.createTexture();return c.bindTexture(c.TEXTURE_2D,g),c.copyTexImage2D(c.TEXTURE_2D,0,c.RGBA,0,0,c.drawingBufferWidth,c.drawingBufferHeight,0),g}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const c=this.style&&this.style.fog;return!!c&&c.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const c=this._backgroundTiles,g=this._backgroundTiles={},w=this.transform.coveringTiles({tileSize:512});for(const I of w)g[I.key]=c[I.key]||new h.Tile(I,512,this.transform.tileZoom,this);return g}clearBackgroundTiles(){this._backgroundTiles={}}}class Rn{constructor(c=0,g=0,w=0,I=0){if(isNaN(c)||c<0||isNaN(g)||g<0||isNaN(w)||w<0||isNaN(I)||I<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=c,this.bottom=g,this.left=w,this.right=I}interpolate(c,g,w){return g.top!=null&&c.top!=null&&(this.top=h.number(c.top,g.top,w)),g.bottom!=null&&c.bottom!=null&&(this.bottom=h.number(c.bottom,g.bottom,w)),g.left!=null&&c.left!=null&&(this.left=h.number(c.left,g.left,w)),g.right!=null&&c.right!=null&&(this.right=h.number(c.right,g.right,w)),this}getCenter(c,g){const w=h.clamp((this.left+c-this.right)/2,0,c),I=h.clamp((this.top+g-this.bottom)/2,0,g);return new h.pointGeometry(w,I)}equals(c){return this.top===c.top&&this.bottom===c.bottom&&this.left===c.left&&this.right===c.right}clone(){return new Rn(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function tc(y,c){const g=h.getColumn(y,3);h.fromQuat(y,c),h.setColumn(y,3,g)}function Oa(y,c){const g=h.identity$1([]);return h.rotateZ$1(g,g,-c),h.rotateX$1(g,g,-y),g}function $s(y,c){const g=[y[0],y[1],0],w=[c[0],c[1],0];if(h.length(g)>=1e-15){const P=h.normalize([],g);h.scale$2(w,P,h.dot(w,P)),c[0]=w[0],c[1]=w[1]}const I=h.cross([],c,y);if(h.len(I)<1e-15)return null;const k=Math.atan2(-I[1],I[0]);return Oa(Math.atan2(Math.sqrt(y[0]*y[0]+y[1]*y[1]),-y[2]),k)}class Jo{constructor(c,g){this.position=c,this.orientation=g}get position(){return this._position}set position(c){if(c){const g=c instanceof h.MercatorCoordinate?c:new h.MercatorCoordinate(c[0],c[1],c[2]);this._renderWorldCopies&&(g.x=h.wrap(g.x,0,1)),this._position=g}else this._position=null}lookAtPoint(c,g){if(this.orientation=null,!this.position)return;const w=this._elevation?this._elevation.getAtPointOrZero(h.MercatorCoordinate.fromLngLat(c)):0,I=this.position,k=h.MercatorCoordinate.fromLngLat(c,w),P=[k.x-I.x,k.y-I.y,k.z-I.z];g||(g=[0,0,1]),g[2]=Math.abs(g[2]),this.orientation=$s(P,g)}setPitchBearing(c,g){this.orientation=Oa(h.degToRad(c),h.degToRad(-g))}}class Qo{constructor(c,g){this._transform=h.identity([]),this.orientation=g,this.position=c}get mercatorPosition(){const c=this.position;return new h.MercatorCoordinate(c[0],c[1],c[2])}get position(){const c=h.getColumn(this._transform,3);return[c[0],c[1],c[2]]}set position(c){var g;c&&h.setColumn(this._transform,3,[(g=c)[0],g[1],g[2],1])}get orientation(){return this._orientation}set orientation(c){this._orientation=c||h.identity$1([]),c&&tc(this._transform,this._orientation)}getPitchBearing(){const c=this.forward(),g=this.right();return{bearing:Math.atan2(-g[1],g[0]),pitch:Math.atan2(Math.sqrt(c[0]*c[0]+c[1]*c[1]),-c[2])}}setPitchBearing(c,g){this._orientation=Oa(c,g),tc(this._transform,this._orientation)}forward(){const c=h.getColumn(this._transform,2);return[-c[0],-c[1],-c[2]]}up(){const c=h.getColumn(this._transform,1);return[-c[0],-c[1],-c[2]]}right(){const c=h.getColumn(this._transform,0);return[c[0],c[1],c[2]]}getCameraToWorld(c,g){const w=new Float64Array(16);return h.invert(w,this.getWorldToCamera(c,g)),w}getWorldToCameraPosition(c,g,w){const I=this.position;h.scale$2(I,I,-c);const k=new Float64Array(16);return h.fromScaling(k,[w,w,w]),h.translate(k,k,I),k[10]*=g,k}getWorldToCamera(c,g){const w=new Float64Array(16),I=new Float64Array(4),k=this.position;return h.conjugate(I,this._orientation),h.scale$2(k,k,-c),h.fromQuat(w,I),h.translate(w,w,k),w[1]*=-1,w[5]*=-1,w[9]*=-1,w[13]*=-1,w[8]*=g,w[9]*=g,w[10]*=g,w[11]*=g,w}getCameraToClipPerspective(c,g,w,I){const k=new Float64Array(16);return h.perspective(k,c,g,w,I),k}getDistanceToElevation(c){const g=c===0?0:h.mercatorZfromAltitude(c,this.position[1]),w=this.forward();return(g-this.position[2])/w[2]}clone(){return new Qo([...this.position],[...this.orientation])}}function Na(y,c){const g=es(y),w=function(k,P,z,U,q){const Z=new h.LngLat(z.lng-180*Ln,z.lat),ee=new h.LngLat(z.lng+180*Ln,z.lat),ae=k.project(Z.lng,Z.lat),me=k.project(ee.lng,ee.lat),ue=-Math.atan2(me.y-ae.y,me.x-ae.x),oe=h.MercatorCoordinate.fromLngLat(z);oe.y=h.clamp(oe.y,-.999975,.999975);const Me=oe.toLngLat(),ye=k.project(Me.lng,Me.lat),Ee=h.MercatorCoordinate.fromLngLat(Me);Ee.x+=Ln;const Te=Ee.toLngLat(),Se=k.project(Te.lng,Te.lat),we=Va(Se.x-ye.x,Se.y-ye.y,ue),ke=h.MercatorCoordinate.fromLngLat(Me);ke.y+=Ln;const $e=ke.toLngLat(),qe=k.project($e.lng,$e.lat),He=Va(qe.x-ye.x,qe.y-ye.y,ue),Ye=Math.abs(we.x)/Math.abs(He.y),ht=h.identity([]);h.rotateZ(ht,ht,-ue*(1-(q?0:U)));const Ue=h.identity([]);return h.scale(Ue,Ue,[1,1-(1-Ye)*U,1]),Ue[4]=-He.x/He.y*U,h.rotateZ(Ue,Ue,ue),h.multiply$1(Ue,ht,Ue),Ue}(y.projection,0,y.center,g,c),I=$a(y);return h.scale(w,w,[I,I,1]),w}function $a(y){const c=y.projection,g=es(y),w=Ua(c,y.center),I=Ua(c,h.LngLat.convert(c.center));return Math.pow(2,w*g+(1-g)*I)}function es(y){const c=y.projection.range;if(!c)return 0;const g=Math.max(y.width,y.height),w=Math.log(g/1024)/Math.LN2;return h.smoothstep(c[0]+w,c[1]+w,y.zoom)}const Ln=1/4e4;function Ua(y,c){const g=h.clamp(c.lat,-h.MAX_MERCATOR_LATITUDE,h.MAX_MERCATOR_LATITUDE),w=new h.LngLat(c.lng-180*Ln,g),I=new h.LngLat(c.lng+180*Ln,g),k=y.project(w.lng,g),P=y.project(I.lng,g),z=h.MercatorCoordinate.fromLngLat(w),U=h.MercatorCoordinate.fromLngLat(I),q=P.x-k.x,Z=P.y-k.y,ee=U.x-z.x,ae=U.y-z.y,me=Math.sqrt((ee*ee+ae*ae)/(q*q+Z*Z));return Math.log(me)/Math.LN2}function Va(y,c,g){const w=Math.cos(g),I=Math.sin(g);return{x:y*w-c*I,y:y*I+c*w}}class Us{constructor(c,g,w,I,k,P,z){this.tileSize=512,this._renderWorldCopies=k===void 0||k,this._minZoom=c||0,this._maxZoom=g||22,this._minPitch=w==null?0:w,this._maxPitch=I==null?60:I,this.setProjection(P),this.setMaxBounds(z),this.width=0,this.height=0,this._center=new h.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Rn,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new Qo,this._centerAltitude=0,this._centerAltitudeValidForExaggeration=0,this._averageElevation=0,this.cameraElevationReference="ground",this._projectionScaler=1,this._horizonShift=.1}clone(){const c=new Us(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return c._elevation=this._elevation,c._centerAltitude=this._centerAltitude,c._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,c.tileSize=this.tileSize,c.width=this.width,c.height=this.height,c.cameraElevationReference=this.cameraElevationReference,c._center=this._center,c._setZoom(this.zoom),c._seaLevelZoom=this._seaLevelZoom,c.angle=this.angle,c._fov=this._fov,c._pitch=this._pitch,c._nearZ=this._nearZ,c._farZ=this._farZ,c._averageElevation=this._averageElevation,c._unmodified=this._unmodified,c._edgeInsets=this._edgeInsets.clone(),c._camera=this._camera.clone(),c._calcMatrices(),c.freezeTileCoverage=this.freezeTileCoverage,c}get elevation(){return this._elevation}set elevation(c){this._elevation!==c&&(this._elevation=c,this._updateCameraOnTerrain(),this._calcMatrices())}updateElevation(c){const g=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||g)&&this._updateCameraOnTerrain(),(c||g)&&this._constrainCameraAltitude(),this._calcMatrices()}getProjection(){return h.pick(this.projection,["name","center","parallels"])}setProjection(c){c==null&&(c={name:"mercator"}),this.projectionOptions=c;const g=this.projection?this.getProjection():void 0;this.projection=h.getProjection(c);const w=this.getProjection();return L(g,w)?null:(this._calcMatrices(),w)}get minZoom(){return this._minZoom}set minZoom(c){this._minZoom!==c&&(this._minZoom=c,this.zoom=Math.max(this.zoom,c))}get maxZoom(){return this._maxZoom}set maxZoom(c){this._maxZoom!==c&&(this._maxZoom=c,this.zoom=Math.min(this.zoom,c))}get minPitch(){return this._minPitch}set minPitch(c){this._minPitch!==c&&(this._minPitch=c,this.pitch=Math.max(this.pitch,c))}get maxPitch(){return this._maxPitch}set maxPitch(c){this._maxPitch!==c&&(this._maxPitch=c,this.pitch=Math.min(this.pitch,c))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(c){c===void 0?c=!0:c===null&&(c=!1),this._renderWorldCopies=c}get worldSize(){return this.tileSize*this.scale}get cameraWorldSize(){const c=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(c))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.cameraWorldSize)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new h.pointGeometry(this.width,this.height)}get bearing(){return h.wrap(this.rotation,-180,180)}set bearing(c){this.rotation=c}get rotation(){return-this.angle/Math.PI*180}set rotation(c){const g=-c*Math.PI/180;var w;this.angle!==g&&(this._unmodified=!1,this.angle=g,this._calcMatrices(),this.rotationMatrix=(w=new h.ARRAY_TYPE(4),h.ARRAY_TYPE!=Float32Array&&(w[1]=0,w[2]=0),w[0]=1,w[3]=1,w),function(I,k,P){var z=k[0],U=k[1],q=k[2],Z=k[3],ee=Math.sin(P),ae=Math.cos(P);I[0]=z*ae+q*ee,I[1]=U*ae+Z*ee,I[2]=z*-ee+q*ae,I[3]=U*-ee+Z*ae}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(c){const g=h.clamp(c,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==g&&(this._unmodified=!1,this._pitch=g,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(c){c=Math.max(.01,Math.min(60,c)),this._fov!==c&&(this._unmodified=!1,this._fov=c/180*Math.PI,this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(c){this._averageElevation=c,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(c){const g=Math.min(Math.max(c,this.minZoom),this.maxZoom);this._zoom!==g&&(this._unmodified=!1,this._setZoom(g),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(c){this._zoom=c,this.scale=this.zoomScale(c),this.tileZoom=Math.floor(c),this.zoomFraction=c-this.tileZoom}_updateCameraOnTerrain(){if(!this._elevation||!this._elevation.isDataAvailableAtPoint(this.locationCoordinate(this.center)))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=0);const c=this._elevation;this._centerAltitude=c.getAtPointOrZero(this.locationCoordinate(this.center)),this._centerAltitudeValidForExaggeration=c.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const c=this._elevation,g=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],w=this.horizonLineFromTop();let I=0,k=0;for(let P=0;P<g.length;P++){const z=new h.pointGeometry(g[P][0]*this.width,w+g[P][1]*(this.height-w)),U=c.pointCoordinate(z);if(!U)continue;const q=1/Math.hypot(U[0]-this._camera.position[0],U[1]-this._camera.position[1]);I+=U[3]*q,k+=q}return k===0?NaN:I/k}get center(){return this._center}set center(c){c.lat===this._center.lat&&c.lng===this._center.lng||(this._unmodified=!1,this._center=c,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const c=this._seaLevelZoom,g=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),w=this.pixelsPerMeter/this.worldSize*g,I=this._mercatorZfromZoom(c),k=this._mercatorZfromZoom(this._maxZoom),P=Math.max(I-w,k);this._setZoom(this._zoomFromMercatorZ(P))}get padding(){return this._edgeInsets.toJSON()}set padding(c){this._edgeInsets.equals(c)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,c,1),this._calcMatrices())}computeZoomRelativeTo(c){const g=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,c.toAltitude()));let w;w=c.z<this._camera.position[2]?[g.x,g.y,g.z]:[c.x,c.y,c.z];const I=h.length(h.sub([],this._camera.position,w));return h.clamp(this._zoomFromMercatorZ(I),this._minZoom,this._maxZoom)}setFreeCameraOptions(c){if(!this.height||!c.position&&!c.orientation)return;this._updateCameraState();let g=!1;if(c.orientation&&!h.exactEquals(c.orientation,this._camera.orientation)&&(g=this._setCameraOrientation(c.orientation)),c.position){const w=[c.position.x,c.position.y,c.position.z];h.exactEquals$1(w,this._camera.position)||(this._setCameraPosition(w),g=!0)}g&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const c=this._camera.position,g=new Jo;return g.position=new h.MercatorCoordinate(c[0],c[1],c[2]),g.orientation=this._camera.orientation,g._elevation=this.elevation,g._renderWorldCopies=this.renderWorldCopies,g}_setCameraOrientation(c){if(!h.length$1(c))return!1;h.normalize$1(c,c);const g=h.transformQuat([],[0,0,-1],c),w=h.transformQuat([],[0,-1,0],c);if(w[2]<0)return!1;const I=$s(g,w);return!!I&&(this._camera.orientation=I,!0)}_setCameraPosition(c){const g=this.zoomScale(this.minZoom)*this.tileSize,w=this.zoomScale(this.maxZoom)*this.tileSize,I=this.cameraToCenterDistance;c[2]=h.clamp(c[2],I/w,I/g),this._camera.position=c}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(c){return this._edgeInsets.equals(c)}interpolatePadding(c,g,w){this._unmodified=!1,this._edgeInsets.interpolate(c,g,w),this._constrain(),this._calcMatrices()}coveringZoomLevel(c){const g=(c.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/c.tileSize));return Math.max(0,g)}getVisibleUnwrappedCoordinates(c){const g=[new h.UnwrappedTileID(0,c)];if(this.renderWorldCopies){const w=this.pointCoordinate(new h.pointGeometry(0,0)),I=this.pointCoordinate(new h.pointGeometry(this.width,0)),k=this.pointCoordinate(new h.pointGeometry(this.width,this.height)),P=this.pointCoordinate(new h.pointGeometry(0,this.height)),z=Math.floor(Math.min(w.x,I.x,k.x,P.x)),U=Math.floor(Math.max(w.x,I.x,k.x,P.x)),q=1;for(let Z=z-q;Z<=U+q;Z++)Z!==0&&g.push(new h.UnwrappedTileID(Z,c))}return g}coveringTiles(c){let g=this.coveringZoomLevel(c);const w=g,I=this.elevation&&!c.isTerrainDEM,k=this.projection.name==="mercator";if(c.minzoom!==void 0&&g<c.minzoom)return[];c.maxzoom!==void 0&&g>c.maxzoom&&(g=c.maxzoom);const P=this.locationCoordinate(this.center),z=this.center.lat,U=1<<g,q=[U*P.x,U*P.y,0],Z=this.projection.name==="globe",ee=!Z,ae=h.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,g,ee),me=Z?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),ue=U*h.mercatorZfromAltitude(1,this.center.lat),oe=this._camera.position[2]/h.mercatorZfromAltitude(1,this.center.lat),Me=[U*me.x,U*me.y,oe*(ee?1:ue)],ye=this.cameraToCenterDistance/c.tileSize*(c.roundZoom?1:.502),Ee=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?g:0,Te=c.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,Se=c.isTerrainDEM?-Te:this._elevation?this._elevation.getMinElevationBelowMSL():0,we=this.projection.isReprojectedInTileSpace?$a(this):1,ke=Ze=>{const Gt=new h.MercatorCoordinate(Ze.x+25e-6,Ze.y,Ze.z),St=new h.MercatorCoordinate(Ze.x,Ze.y+25e-6,Ze.z),At=Ze.toLngLat(),Kt=Gt.toLngLat(),pi=St.toLngLat(),Ft=this.locationCoordinate(At),ei=this.locationCoordinate(Kt),ki=this.locationCoordinate(pi),Yi=Math.hypot(ei.x-Ft.x,ei.y-Ft.y),xr=Math.hypot(ki.x-Ft.x,ki.y-Ft.y);return Math.sqrt(Yi*xr)*we/25e-6},$e=Ze=>{const Ut=Te,Gt=Se;return{aabb:h.tileAABB(this,U,0,0,0,Ze,Gt,Ut,this.projection),zoom:0,x:0,y:0,minZ:Gt,maxZ:Ut,wrap:Ze,fullyVisible:!1}},qe=[];let He=[];const Ye=g,ht=c.reparseOverscaled?w:g,Ue=Ze=>Ze*Ze,lt=Ue((oe-this._centerAltitude)*ue),st=Ze=>{if(!this._elevation||!Ze.tileID||!k)return;const Ut=this._elevation.getMinMaxForTile(Ze.tileID),Gt=Ze.aabb;Ut?(Gt.min[2]=Ut.min,Gt.max[2]=Ut.max,Gt.center[2]=(Gt.min[2]+Gt.max[2])/2):(Ze.shouldSplit=kt(Ze),Ze.shouldSplit||(Gt.min[2]=Gt.max[2]=Gt.center[2]=this._centerAltitude))},kt=Ze=>{if(Ze.zoom<Ee)return!0;if(Ze.zoom===Ye)return!1;if(Ze.shouldSplit!=null)return Ze.shouldSplit;const Ut=Ze.aabb.distanceX(Me),Gt=Ze.aabb.distanceY(Me);let St=lt,At=1;if(Z){St=Ue(Ze.aabb.distanceZ(Me));const pi=Math.pow(2,Ze.zoom),Ft=h.latFromMercatorY((Ze.y+1)/pi),ei=h.latFromMercatorY(Ze.y/pi),ki=Math.min(Math.max(z,Ft),ei),Yi=h.circumferenceAtLatitude(ki)/h.circumferenceAtLatitude(z);At=Math.min(Yi,1)}else if(I&&(St=Ue(Ze.aabb.distanceZ(Me)*ue)),this.projection.isReprojectedInTileSpace&&w<=5){const pi=Math.pow(2,Ze.zoom),Ft=ke(new h.MercatorCoordinate((Ze.x+.5)/pi,(Ze.y+.5)/pi));At=Ft>.85?1:Ft}const Kt=Ut*Ut+Gt*Gt+St;return Kt<Ue((1<<Ye-Ze.zoom)*ye*At*((pi,Ft)=>{if(Ft*Ue(.707)<pi)return 1;const ei=Math.sqrt(Ft/pi);return ei/(1.4144271570014144+(Math.pow(1.1,ei-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(St,lt),Kt))};if(this.renderWorldCopies)for(let Ze=1;Ze<=3;Ze++)qe.push($e(-Ze)),qe.push($e(Ze));for(qe.push($e(0));qe.length>0;){const Ze=qe.pop(),Ut=Ze.x,Gt=Ze.y;let St=Ze.fullyVisible;if(!St){const At=Ze.aabb.intersects(ae);if(At===0)continue;St=At===2}if(Ze.zoom!==Ye&&kt(Ze))for(let At=0;At<4;At++){const Kt=(Ut<<1)+At%2,pi=(Gt<<1)+(At>>1),Ft={aabb:k?Ze.aabb.quadrant(At):h.tileAABB(this,U,Ze.zoom+1,Kt,pi,Ze.wrap,Ze.minZ,Ze.maxZ,this.projection),zoom:Ze.zoom+1,x:Kt,y:pi,wrap:Ze.wrap,fullyVisible:St,tileID:void 0,shouldSplit:void 0,minZ:Ze.minZ,maxZ:Ze.maxZ};I&&!Z&&(Ft.tileID=new h.OverscaledTileID(Ze.zoom+1===Ye?ht:Ze.zoom+1,Ze.wrap,Ze.zoom+1,Kt,pi),st(Ft)),qe.push(Ft)}else{const At=Ze.zoom===Ye?ht:Ze.zoom;if(c.minzoom&&c.minzoom>At)continue;const Kt=q[0]-(.5+Ut+(Ze.wrap<<Ze.zoom))*(1<<g-Ze.zoom),pi=q[1]-.5-Gt,Ft=Ze.tileID?Ze.tileID:new h.OverscaledTileID(At,Ze.wrap,Ze.zoom,Ut,Gt);He.push({tileID:Ft,distanceSq:Kt*Kt+pi*pi})}}if(this.fogCullDistSq){const Ze=this.fogCullDistSq,Ut=this.horizonLineFromTop();He=He.filter(Gt=>{const St=[0,0,0,1],At=[h.EXTENT,h.EXTENT,0,1],Kt=this.calculateFogTileMatrix(Gt.tileID.toUnwrapped());h.transformMat4$1(St,St,Kt),h.transformMat4$1(At,At,Kt);const pi=h.getAABBPointSquareDist(St,At);if(pi===0)return!0;let Ft=!1;const ei=this._elevation;if(ei&&pi>Ze&&Ut!==0){const ki=this.calculateProjMatrix(Gt.tileID.toUnwrapped());let Yi;c.isTerrainDEM||(Yi=ei.getMinMaxForTile(Gt.tileID)),Yi||(Yi={min:Se,max:Te});const xr=h.furthestTileCorner(this.rotation),vr=[xr[0]*h.EXTENT,xr[1]*h.EXTENT,Yi.max];h.transformMat4(vr,vr,ki),Ft=(1-vr[1])*this.height*.5<Ut}return pi<Ze||Ft})}return He.sort((Ze,Ut)=>Ze.distanceSq-Ut.distanceSq).map(Ze=>Ze.tileID)}resize(c,g){this.width=c,this.height=g,this.pixelsToGLUnits=[2/c,-2/g],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(c){return Math.pow(2,c)}scaleZoom(c){return Math.log(c)/Math.LN2}project(c){const g=h.clamp(c.lat,-h.MAX_MERCATOR_LATITUDE,h.MAX_MERCATOR_LATITUDE),w=this.projection.project(c.lng,g);return new h.pointGeometry(w.x*this.worldSize,w.y*this.worldSize)}unproject(c){return this.projection.unproject(c.x/this.worldSize,c.y/this.worldSize)}get point(){return this.project(this.center)}setLocationAtPoint(c,g){let w,I;const k=this.centerPoint;if(this.projection.name==="globe"){const z=this.worldSize;w=(g.x-k.x)/z,I=(g.y-k.y)/z}else{const z=this.pointCoordinate(g),U=this.pointCoordinate(k);w=z.x-U.x,I=z.y-U.y}const P=this.locationCoordinate(c);this.setLocation(new h.MercatorCoordinate(P.x-w,P.y-I))}setLocation(c){this.center=this.coordinateLocation(c),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(c){return this.projection.locationPoint(this,c)}locationPoint3D(c){return this._coordinatePoint(this.locationCoordinate(c),!0)}pointLocation(c){return this.coordinateLocation(this.pointCoordinate(c))}pointLocation3D(c){return this.coordinateLocation(this.pointCoordinate3D(c))}locationCoordinate(c,g){const w=g?h.mercatorZfromAltitude(g,c.lat):void 0,I=this.projection.project(c.lng,c.lat);return new h.MercatorCoordinate(I.x,I.y,w)}coordinateLocation(c){return this.projection.unproject(c.x,c.y)}pointRayIntersection(c,g){const w=g!=null?g:this._centerAltitude,I=[c.x,c.y,0,1],k=[c.x,c.y,1,1];h.transformMat4$1(I,I,this.pixelMatrixInverse),h.transformMat4$1(k,k,this.pixelMatrixInverse);const P=k[3];h.scale$1(I,I,1/I[3]),h.scale$1(k,k,1/P);const z=I[2],U=k[2];return{p0:I,p1:k,t:z===U?0:(w-z)/(U-z)}}screenPointToMercatorRay(c){const g=[c.x,c.y,0,1],w=[c.x,c.y,1,1];return h.transformMat4$1(g,g,this.pixelMatrixInverse),h.transformMat4$1(w,w,this.pixelMatrixInverse),h.scale$1(g,g,1/g[3]),h.scale$1(w,w,1/w[3]),g[2]=h.mercatorZfromAltitude(g[2],this._center.lat)*this.worldSize,w[2]=h.mercatorZfromAltitude(w[2],this._center.lat)*this.worldSize,h.scale$1(g,g,1/this.worldSize),h.scale$1(w,w,1/this.worldSize),new h.Ray([g[0],g[1],g[2]],h.normalize([],h.sub([],w,g)))}rayIntersectionCoordinate(c){const{p0:g,p1:w,t:I}=c,k=h.mercatorZfromAltitude(g[2],this._center.lat),P=h.mercatorZfromAltitude(w[2],this._center.lat);return new h.MercatorCoordinate(h.number(g[0],w[0],I)/this.worldSize,h.number(g[1],w[1],I)/this.worldSize,h.number(k,P,I))}pointCoordinate(c,g=this._centerAltitude){return this.projection.pointCoordinate(this,c.x,c.y,g)}pointCoordinate3D(c){if(!this.elevation)return this.pointCoordinate(c);const g=this.elevation;let w=this.elevation.pointCoordinate(c);if(w)return new h.MercatorCoordinate(w[0],w[1],w[2]);let I=0,k=this.horizonLineFromTop();if(c.y>k)return this.pointCoordinate(c);const P=.02*k,z=c.clone();for(let U=0;U<10&&k-I>P;U++){z.y=h.number(I,k,.66);const q=g.pointCoordinate(z);q?(k=z.y,w=q):I=z.y}return w?new h.MercatorCoordinate(w[0],w[1],w[2]):this.pointCoordinate(c)}isPointAboveHorizon(c){if(this.elevation)return!this.elevation.pointCoordinate(c);{const g=this.horizonLineFromTop();return c.y<g}}_coordinatePoint(c,g){const w=g&&this.elevation?this.elevation.getAtPointOrZero(c,this._centerAltitude):this._centerAltitude,I=[c.x*this.worldSize,c.y*this.worldSize,w+c.toAltitude(),1];return h.transformMat4$1(I,I,this.pixelMatrix),I[3]>0?new h.pointGeometry(I[0]/I[3],I[1]/I[3]):new h.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getBounds(c,g){const w=new h.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),I=new h.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),k=new h.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),P=new h.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let z=this.pointCoordinate(w,c),U=this.pointCoordinate(I,c);const q=this.pointCoordinate(k,g),Z=this.pointCoordinate(P,g),ee=(ae,me)=>(me.y-ae.y)/(me.x-ae.x);return z.y>1&&U.y>=0?z=new h.MercatorCoordinate((1-Z.y)/ee(Z,z)+Z.x,1):z.y<0&&U.y<=1&&(z=new h.MercatorCoordinate(-Z.y/ee(Z,z)+Z.x,0)),U.y>1&&z.y>=0?U=new h.MercatorCoordinate((1-q.y)/ee(q,U)+q.x,1):U.y<0&&z.y<=1&&(U=new h.MercatorCoordinate(-q.y/ee(q,U)+q.x,0)),new h.LngLatBounds().extend(this.coordinateLocation(z)).extend(this.coordinateLocation(U)).extend(this.coordinateLocation(Z)).extend(this.coordinateLocation(q))}_getBounds3D(){const c=this.elevation;if(!c.visibleDemTiles.length)return this._getBounds(0,0);const g=c.visibleDemTiles.reduce((w,I)=>{if(I.dem){const k=I.dem.tree;w.min=Math.min(w.min,k.minimums[0]),w.max=Math.max(w.max,k.maximums[0])}return w},{min:Number.MAX_VALUE,max:0});return this._getBounds(g.min*c.exaggeration(),g.max*c.exaggeration())}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0)}horizonLineFromTop(c=!0){const g=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,w=this.height/2-g*(1-this._horizonShift);return c?Math.max(0,w):w}getMaxBounds(){return this.maxBounds}setMaxBounds(c){this.maxBounds=c,this.minLat=-h.MAX_MERCATOR_LATITUDE,this.maxLat=h.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,c&&(this.minLat=c.getSouth(),this.maxLat=c.getNorth(),this.minLng=c.getWest(),this.maxLng=c.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=h.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=h.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=h.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=h.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(c,g){return this.projection.createTileMatrix(this,g,c)}calculateDistanceTileData(c){const g=c.key,w=this._distanceTileDataCache;if(w[g])return w[g];const I=c.canonical,k=1/this.height,P=this.cameraWorldSize/this.zoomScale(I.z),z=(I.x+Math.pow(2,I.z)*c.wrap)*P,U=I.y*P,q=this.point,Z=this.angle,ee=Math.sin(-Z),ae=-Math.cos(-Z);return w[g]={bearing:[ee,ae],center:[(q.x-z)*k,(q.y-U)*k],scale:P/h.EXTENT*k},w[g]}calculateFogTileMatrix(c){const g=c.key,w=this._fogTileMatrixCache;if(w[g])return w[g];const I=this.calculatePosMatrix(c,this.cameraWorldSize);return h.multiply$1(I,this.worldToFogMatrix,I),w[g]=new Float32Array(I),w[g]}calculateProjMatrix(c,g=!1){const w=c.key,I=g?this._alignedProjMatrixCache:this._projMatrixCache;if(I[w])return I[w];const k=this.calculatePosMatrix(c,this.worldSize);return h.multiply$1(k,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:g?this.alignedProjMatrix:this.projMatrix,k),I[w]=new Float32Array(k),I[w]}calculatePixelsToTileUnitsMatrix(c){const g=c.tileID.key,w=this._pixelsToTileUnitsCache;if(w[g])return w[g];const I=function(k,P){const{scale:z}=k.tileTransform,U=z*h.EXTENT/(k.tileSize*Math.pow(2,P.zoom-k.tileID.overscaledZ+k.tileID.canonical.z));return q=new Float32Array(4),ae=(Z=P.inverseAdjustmentMatrix)[1],me=Z[2],ue=Z[3],Me=(ee=[U,U])[1],q[0]=Z[0]*(oe=ee[0]),q[1]=ae*oe,q[2]=me*Me,q[3]=ue*Me,q;var q,Z,ee,ae,me,ue,oe,Me}(c,this);return w[g]=I,w[g]}customLayerMatrix(){return this.mercatorMatrix.slice()}recenterOnTerrain(){if(!this._elevation)return;const c=this._elevation;this._updateCameraState();const g=h.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,w=this._computeCameraPosition(g),I=this._camera.forward(),k=h.mercatorZfromAltitude(1,this._center.lat);w[2]/=k,I[2]/=k,h.normalize(I,I);const P=c.raycast(w,I,c.exaggeration());if(P){const z=h.scaleAndAdd([],w,I,P),U=new h.MercatorCoordinate(z[0],z[1],h.mercatorZfromAltitude(z[2],h.latFromMercatorY(z[1]))),q=(U.z+h.length([U.x-w[0],U.y-w[1],U.z-w[2]*k]))*this._projectionScaler;this._seaLevelZoom=this._zoomFromMercatorZ(q),this._centerAltitude=U.toAltitude(),this._center=this.coordinateLocation(U),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCameraAltitude(){if(!this._elevation)return;const c=this._elevation;this._updateCameraState();const g=h.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,w=this._computeCameraPosition(g),I=c.getAtPointOrZero(new h.MercatorCoordinate(...w)),k=this._minimumHeightOverTerrain()*Math.cos(h.degToRad(this._maxPitch)),P=this._camera.position[2]-this.pixelsPerMeter/this.worldSize*I;if(P<k){const z=this.locationCoordinate(this._center,this._centerAltitude),U=[z.x-w[0],z.y-w[1],z.z-w[2]],q=h.length(U);U[2]-=(k-P)/this._projectionScaler;const Z=h.length(U);if(Z===0)return;h.scale$2(U,U,q/Z*this._projectionScaler),this._camera.position=[z.x-U[0],z.y-U[1],z.z*this._projectionScaler-U[2]],this._camera.orientation=$s(U,this._camera.up()),this._updateStateFromCamera()}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;if(this._constraining=!0,this.projection.isReprojectedInTileSpace){const ee=this.center;return ee.lat=h.clamp(ee.lat,this.minLat,this.maxLat),!this.maxBounds&&this.renderWorldCopies||(ee.lng=h.clamp(ee.lng,this.minLng,this.maxLng)),this.center=ee,void(this._constraining=!1)}const c=this._unmodified,{x:g,y:w}=this.point;let I=0,k=g,P=w;const z=this.width/2,U=this.height/2,q=this.worldMinY*this.scale,Z=this.worldMaxY*this.scale;if(w-U<q&&(P=q+U),w+U>Z&&(P=Z-U),Z-q<this.height&&(I=Math.max(I,this.height/(Z-q)),P=(Z+q)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const ee=this.worldMinX*this.scale,ae=this.worldMaxX*this.scale,me=this.worldSize/2-(ee+ae)/2;k=(g+me+this.worldSize)%this.worldSize-me,k-z<ee&&(k=ee+z),k+z>ae&&(k=ae-z),ae-ee<this.width&&(I=Math.max(I,this.width/(ae-ee)),k=(ae+ee)/2)}k===g&&P===w||(this.center=this.unproject(new h.pointGeometry(k,P))),I&&(this.zoom+=this.scaleZoom(I)),this._constrainCameraAltitude(),this._unmodified=c,this._constraining=!1}_minZoomForBounds(){let c=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(c=Math.max(c,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),c}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const c=this._fov/2,g=this.centerOffset,w=this.pixelsPerMeter;this._projectionScaler=w/(h.mercatorZfromAltitude(1,this.center.lat)*this.worldSize),this.cameraToCenterDistance=.5/Math.tan(c)*this.height*this._projectionScaler,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const I=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?w:1),k=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);k[8]=2*-g.x/this.width,k[9]=2*g.y/this.height;let P=h.mul([],k,I);if(this.projection.isReprojectedInTileSpace){const Se=this.locationCoordinate(this.center),we=h.identity([]);h.translate(we,we,[Se.x*this.worldSize,Se.y*this.worldSize,0]),h.multiply$1(we,we,Na(this)),h.translate(we,we,[-Se.x*this.worldSize,-Se.y*this.worldSize,0]),h.multiply$1(P,P,we),this.inverseAdjustmentMatrix=function(ke){const $e=Na(ke,!0);return ve([],[$e[0],$e[1],$e[4],$e[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=h.scale([],P,[this.worldSize,this.worldSize,this.worldSize/w,1]),this.projMatrix=P,this.invProjMatrix=h.invert(new Float64Array(16),this.projMatrix);const z=new Float32Array(16);h.identity(z),h.scale(z,z,[1,-1,1]),h.rotateX(z,z,this._pitch),h.rotateZ(z,z,this.angle);const U=h.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),q=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;U[8]=2*-g.x/this.width,U[9]=2*(g.y+q)/this.height,this.skyboxMatrix=h.multiply$1(z,U,z);const Z=this.point,ee=Z.x,ae=Z.y,me=this.width%2/2,ue=this.height%2/2,oe=Math.cos(this.angle),Me=Math.sin(this.angle),ye=ee-Math.round(ee)+oe*me+Me*ue,Ee=ae-Math.round(ae)+oe*ue+Me*me,Te=new Float64Array(P);if(h.translate(Te,Te,[ye>.5?ye-1:ye,Ee>.5?Ee-1:Ee,0]),this.alignedProjMatrix=Te,P=h.create(),h.scale(P,P,[this.width/2,-this.height/2,1]),h.translate(P,P,[1,-1,0]),this.labelPlaneMatrix=P,P=h.create(),h.scale(P,P,[1,-1,1]),h.translate(P,P,[-1,-1,0]),h.scale(P,P,[2/this.width,2/this.height,1]),this.glCoordMatrix=P,this.pixelMatrix=h.multiply$1(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},P=h.invert(new Float64Array(16),this.pixelMatrix),!P)throw new Error("failed to invert matrix");this.pixelMatrixInverse=P,this.globeMatrix=this.projection.name==="globe"?h.calculateGlobeMatrix(this):P,this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const c=this.cameraWorldSize,g=this.cameraPixelsPerMeter,w=this._camera.position,I=1/this.height,k=[c,c,g];h.scale$2(k,k,I),h.scale$2(w,w,-1),h.multiply$2(w,w,k);const P=h.create();h.translate(P,P,w),h.scale(P,P,k),this.mercatorFogMatrix=P,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(c,g,I)}_computeCameraPosition(c){const g=(c=c||this.pixelsPerMeter)/this.pixelsPerMeter,w=this._camera.forward(),I=this.point,k=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*g-c/this.worldSize*this._centerAltitude;return[I.x/this.worldSize-w[0]*k,I.y/this.worldSize-w[1]*k,c/this.worldSize*this._centerAltitude-w[2]*k]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(c){const g=this._maxCameraBoundsDistance()*Math.cos(this._pitch),w=c[2];let I=1;w>0&&(I=Math.min((g-this._camera.position[2])/w,1)),this._camera.position=h.scaleAndAdd([],this._camera.position,c,I),this._updateStateFromCamera(),this.projection.wrap&&(this.center=this.center.wrap())}_updateStateFromCamera(){const c=this._camera.position,g=this._camera.forward(),{pitch:w,bearing:I}=this._camera.getPitchBearing(),k=h.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._projectionScaler,P=this._mercatorZfromZoom(this._maxZoom)*Math.cos(h.degToRad(this._maxPitch)),z=Math.max((c[2]-k)/Math.cos(w),P),U=this._zoomFromMercatorZ(z);h.scaleAndAdd(c,c,g,z),this._pitch=h.clamp(w,h.degToRad(this.minPitch),h.degToRad(this.maxPitch)),this.angle=h.wrap(I,-Math.PI,Math.PI),this._setZoom(h.clamp(U,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new h.MercatorCoordinate(c[0],c[1],c[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(c){return Math.pow(2,c)*this.tileSize}_mercatorZfromZoom(c){return this.cameraToCenterDistance/this._worldSizeFromZoom(c)}_minimumHeightOverTerrain(){const c=Math.min((this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(c)}_zoomFromMercatorZ(c){return this.scaleZoom(this.cameraToCenterDistance/(c*this.tileSize))}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(h.warnOnce("Terrain is not yet supported with alternate projections. Use mercator to enable terrain."),1))}anyCornerOffEdge(c,g){const w=Math.min(c.x,g.x),I=Math.max(c.x,g.x),k=Math.min(c.y,g.y),P=Math.max(c.y,g.y);if(k<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const z=[new h.pointGeometry(w,k),new h.pointGeometry(I,P),new h.pointGeometry(w,P),new h.pointGeometry(I,k)],U=this.renderWorldCopies?-3:0,q=this.renderWorldCopies?4:1;for(const Z of z){const ee=this.pointRayIntersection(Z);if(ee.t<0)return!0;const ae=this.rayIntersectionCoordinate(ee);if(ae.x<U||ae.y<0||ae.x>q||ae.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+h.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new h.pointGeometry(0,0),new h.pointGeometry(this.width,this.height))}zoomDeltaToMovement(c,g){const w=h.length(h.sub([],this._camera.position,c)),I=this._zoomFromMercatorZ(w)+g;return w-this._mercatorZfromZoom(I)}getCameraPoint(){const c=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new h.pointGeometry(0,c))}}function ja(y,c){let g=!1,w=null;const I=()=>{w=null,g&&(y(),w=setTimeout(I,c),g=!1)};return()=>(g=!0,w||I(),w)}class ic{constructor(c){this._hashName=c&&encodeURIComponent(c),h.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=ja(this._updateHashUnthrottled.bind(this),300)}addTo(c){return this._map=c,h.window.addEventListener("hashchange",this._onHashChange,!1),c.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),h.window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(c){const g=this._map;if(!g)return"";const w=g.getCenter(),I=Math.round(100*g.getZoom())/100,k=Math.ceil((I*Math.LN2+Math.log(512/360/.5))/Math.LN10),P=Math.pow(10,k),z=Math.round(w.lng*P)/P,U=Math.round(w.lat*P)/P,q=g.getBearing(),Z=g.getPitch();let ee="";if(ee+=c?`/${z}/${U}/${I}`:`${I}/${U}/${z}`,(q||Z)&&(ee+="/"+Math.round(10*q)/10),Z&&(ee+=`/${Math.round(Z)}`),this._hashName){const ae=this._hashName;let me=!1;const ue=h.window.location.hash.slice(1).split("&").map(oe=>{const Me=oe.split("=")[0];return Me===ae?(me=!0,`${Me}=${ee}`):oe}).filter(oe=>oe);return me||ue.push(`${ae}=${ee}`),`#${ue.join("&")}`}return`#${ee}`}_getCurrentHash(){const c=h.window.location.hash.replace("#","");if(this._hashName){let g;return c.split("&").map(w=>w.split("=")).forEach(w=>{w[0]===this._hashName&&(g=w)}),(g&&g[1]||"").split("/")}return c.split("/")}_onHashChange(){const c=this._map;if(!c)return!1;const g=this._getCurrentHash();if(g.length>=3&&!g.some(w=>isNaN(w))){const w=c.dragRotate.isEnabled()&&c.touchZoomRotate.isEnabled()?+(g[3]||0):c.getBearing();return c.jumpTo({center:[+g[2],+g[1]],zoom:+g[0],bearing:w,pitch:+(g[4]||0)}),!0}return!1}_updateHashUnthrottled(){const c=h.window.location.href.replace(/(#.+)?$/,this.getHashString());h.window.history.replaceState(h.window.history.state,null,c)}}const bn={linearity:.3,easing:h.bezier(0,0,.3,1)},rc=h.extend({deceleration:2500,maxSpeed:1400},bn),nc=h.extend({deceleration:20,maxSpeed:1400},bn),oc=h.extend({deceleration:1e3,maxSpeed:360},bn),sc=h.extend({deceleration:1e3,maxSpeed:90},bn);class ac{constructor(c){this._map=c,this.clear()}clear(){this._inertiaBuffer=[]}record(c){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:h.exported.now(),settings:c})}_drainInertiaBuffer(){const c=this._inertiaBuffer,g=h.exported.now();for(;c.length>0&&g-c[0].time>160;)c.shift()}_onMoveEnd(c){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const g={zoom:0,bearing:0,pitch:0,pan:new h.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:k}of this._inertiaBuffer)g.zoom+=k.zoomDelta||0,g.bearing+=k.bearingDelta||0,g.pitch+=k.pitchDelta||0,k.panDelta&&g.pan._add(k.panDelta),k.around&&(g.around=k.around),k.pinchAround&&(g.pinchAround=k.pinchAround);const w=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,I={};if(g.pan.mag()){const k=hr(g.pan.mag(),w,h.extend({},rc,c||{}));I.offset=g.pan.mult(k.amount/g.pan.mag()),I.center=this._map.transform.center,ts(I,k)}if(g.zoom){const k=hr(g.zoom,w,nc);I.zoom=this._map.transform.zoom+k.amount,ts(I,k)}if(g.bearing){const k=hr(g.bearing,w,oc);I.bearing=this._map.transform.bearing+h.clamp(k.amount,-179,179),ts(I,k)}if(g.pitch){const k=hr(g.pitch,w,sc);I.pitch=this._map.transform.pitch+k.amount,ts(I,k)}if(I.zoom||I.bearing){const k=g.pinchAround===void 0?g.around:g.pinchAround;I.around=k?this._map.unproject(k):this._map.getCenter()}return this.clear(),I.noMoveStart=!0,I}}function ts(y,c){(!y.duration||y.duration<c.duration)&&(y.duration=c.duration,y.easing=c.easing)}function hr(y,c,g){const{maxSpeed:w,linearity:I,deceleration:k}=g,P=h.clamp(y*I/(c/1e3),-w,w),z=Math.abs(P)/(k*I);return{easing:g.easing,duration:1e3*z,amount:P*(z/2)}}class Nr extends h.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(c,g,w,I={}){const k=ce(g.getCanvasContainer(),w),P=g.unproject(k);super(c,h.extend({point:k,lngLat:P,originalEvent:w},I)),this._defaultPrevented=!1,this.target=g}}class is extends h.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(c,g,w){const I=c==="touchend"?w.changedTouches:w.touches,k=ge(g.getCanvasContainer(),I),P=k.map(U=>g.unproject(U)),z=k.reduce((U,q,Z,ee)=>U.add(q.div(ee.length)),new h.pointGeometry(0,0));super(c,{points:k,point:z,lngLats:P,lngLat:g.unproject(z),originalEvent:w}),this._defaultPrevented=!1}}class _h extends h.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(c,g,w){super(c,{originalEvent:w}),this._defaultPrevented=!1}}class yh{constructor(c,g){this._map=c,this._clickTolerance=g.clickTolerance}reset(){this._mousedownPos=void 0}wheel(c){return this._firePreventable(new _h(c.type,this._map,c))}mousedown(c,g){return this._mousedownPos=g,this._firePreventable(new Nr(c.type,this._map,c))}mouseup(c){this._map.fire(new Nr(c.type,this._map,c))}preclick(c){const g=h.extend({},c);g.type="preclick",this._map.fire(new Nr(g.type,this._map,g))}click(c,g){this._mousedownPos&&this._mousedownPos.dist(g)>=this._clickTolerance||(this.preclick(c),this._map.fire(new Nr(c.type,this._map,c)))}dblclick(c){return this._firePreventable(new Nr(c.type,this._map,c))}mouseover(c){this._map.fire(new Nr(c.type,this._map,c))}mouseout(c){this._map.fire(new Nr(c.type,this._map,c))}touchstart(c){return this._firePreventable(new is(c.type,this._map,c))}touchmove(c){this._map.fire(new is(c.type,this._map,c))}touchend(c){this._map.fire(new is(c.type,this._map,c))}touchcancel(c){this._map.fire(new is(c.type,this._map,c))}_firePreventable(c){if(this._map.fire(c),c.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class wn{constructor(c){this._map=c}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(c){this._map.fire(new Nr(c.type,this._map,c))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Nr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(c){this._delayContextMenu?this._contextMenuEvent=c:this._map.fire(new Nr(c.type,this._map,c)),this._map.listens("contextmenu")&&c.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class lc{constructor(c,g){this._map=c,this._el=c.getCanvasContainer(),this._container=c.getContainer(),this._clickTolerance=g.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(c,g){this.isEnabled()&&c.shiftKey&&c.button===0&&(X(),this._startPos=this._lastPos=g,this._active=!0)}mousemoveWindow(c,g){if(!this._active)return;const w=g;if(this._lastPos.equals(w)||!this._box&&w.dist(this._startPos)<this._clickTolerance)return;const I=this._startPos;this._lastPos=w,this._box||(this._box=N("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",c));const k=Math.min(I.x,w.x),P=Math.max(I.x,w.x),z=Math.min(I.y,w.y),U=Math.max(I.y,w.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${k}px,${z}px)`,this._box.style.width=P-k+"px",this._box.style.height=U-z+"px")})}mouseupWindow(c,g){if(!this._active||c.button!==0)return;const w=this._startPos,I=g;if(this.reset(),ie(),w.x!==I.x||w.y!==I.y)return this._map.fire(new h.Event("boxzoomend",{originalEvent:c})),{cameraAnimation:k=>k.fitScreenCoordinates(w,I,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",c)}keydown(c){this._active&&c.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",c))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),de(),delete this._startPos,delete this._lastPos}_fireEvent(c,g){return this._map.fire(new h.Event(c,{originalEvent:g}))}}function zn(y,c){const g={};for(let w=0;w<y.length;w++)g[y[w].identifier]=c[w];return g}class fn{constructor(c){this.reset(),this.numTouches=c.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(c,g,w){(this.centroid||w.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=c.timeStamp),w.length===this.numTouches&&(this.centroid=function(I){const k=new h.pointGeometry(0,0);for(const P of I)k._add(P);return k.div(I.length)}(g),this.touches=zn(w,g)))}touchmove(c,g,w){if(this.aborted||!this.centroid)return;const I=zn(w,g);for(const k in this.touches){const P=this.touches[k],z=I[k];(!z||z.dist(P)>30)&&(this.aborted=!0)}}touchend(c,g,w){if((!this.centroid||c.timeStamp-this.startTime>500)&&(this.aborted=!0),w.length===0){const I=!this.aborted&&this.centroid;if(this.reset(),I)return I}}}class Qn{constructor(c){this.singleTap=new fn(c),this.numTaps=c.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(c,g,w){this.singleTap.touchstart(c,g,w)}touchmove(c,g,w){this.singleTap.touchmove(c,g,w)}touchend(c,g,w){const I=this.singleTap.touchend(c,g,w);if(I){const k=c.timeStamp-this.lastTime<500,P=!this.lastTap||this.lastTap.dist(I)<30;if(k&&P||this.reset(),this.count++,this.lastTime=c.timeStamp,this.lastTap=I,this.count===this.numTaps)return this.reset(),I}}}class Tt{constructor(){this._zoomIn=new Qn({numTouches:1,numTaps:2}),this._zoomOut=new Qn({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(c,g,w){this._zoomIn.touchstart(c,g,w),this._zoomOut.touchstart(c,g,w)}touchmove(c,g,w){this._zoomIn.touchmove(c,g,w),this._zoomOut.touchmove(c,g,w)}touchend(c,g,w){const I=this._zoomIn.touchend(c,g,w),k=this._zoomOut.touchend(c,g,w);return I?(this._active=!0,c.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:P=>P.easeTo({duration:300,zoom:P.getZoom()+1,around:P.unproject(I)},{originalEvent:c})}):k?(this._active=!0,c.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:P=>P.easeTo({duration:300,zoom:P.getZoom()-1,around:P.unproject(k)},{originalEvent:c})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const cc={0:1,2:2};class Vs{constructor(c){this.reset(),this._clickTolerance=c.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(c,g){return!1}_move(c,g){return{}}mousedown(c,g){if(this._lastPoint)return;const w=be(c);this._correctButton(c,w)&&(this._lastPoint=g,this._eventButton=w)}mousemoveWindow(c,g){const w=this._lastPoint;if(w){if(c.preventDefault(),this._eventButton!=null&&function(I,k){const P=cc[k];return I.buttons===void 0||(I.buttons&P)!==P}(c,this._eventButton))this.reset();else if(this._moved||!(g.dist(w)<this._clickTolerance))return this._moved=!0,this._lastPoint=g,this._move(w,g)}}mouseupWindow(c){this._lastPoint&&be(c)===this._eventButton&&(this._moved&&ie(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class rs extends Vs{mousedown(c,g){super.mousedown(c,g),this._lastPoint&&(this._active=!0)}_correctButton(c,g){return g===0&&!c.ctrlKey}_move(c,g){return{around:g,panDelta:g.sub(c)}}}class vo extends Vs{_correctButton(c,g){return g===0&&c.ctrlKey||g===2}_move(c,g){const w=.8*(g.x-c.x);if(w)return this._active=!0,{bearingDelta:w}}contextmenu(c){c.preventDefault()}}class Ga extends Vs{_correctButton(c,g){return g===0&&c.ctrlKey||g===2}_move(c,g){const w=-.5*(g.y-c.y);if(w)return this._active=!0,{pitchDelta:w}}contextmenu(c){c.preventDefault()}}class hc{constructor(c,g){this._map=c,this._el=c.getCanvasContainer(),this._minTouches=1,this._clickTolerance=g.clickTolerance||1,this.reset(),h.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new h.pointGeometry(0,0)}touchstart(c,g,w){return this._calculateTransform(c,g,w)}touchmove(c,g,w){if(this._active&&!(w.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(w.length===1)return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return c.preventDefault(),this._calculateTransform(c,g,w)}}touchend(c,g,w){this._calculateTransform(c,g,w),this._active&&w.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(c,g,w){w.length>0&&(this._active=!0);const I=zn(w,g),k=new h.pointGeometry(0,0),P=new h.pointGeometry(0,0);let z=0;for(const q in I){const Z=I[q],ee=this._touches[q];ee&&(k._add(Z),P._add(Z.sub(ee)),z++,I[q]=Z)}if(this._touches=I,z<this._minTouches||!P.mag())return;const U=P.div(z);return this._sum._add(U),this._sum.mag()<this._clickTolerance?void 0:{around:k.div(z),panDelta:U}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=N("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show")},500)}}class js{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(c){}_move(c,g,w){return{}}touchstart(c,g,w){this._firstTwoTouches||w.length<2||(this._firstTwoTouches=[w[0].identifier,w[1].identifier],this._start([g[0],g[1]]))}touchmove(c,g,w){const I=this._firstTwoTouches;if(!I)return;c.preventDefault();const[k,P]=I,z=ns(w,g,k),U=ns(w,g,P);if(!z||!U)return;const q=this._aroundCenter?null:z.add(U).div(2);return this._move([z,U],q,c)}touchend(c,g,w){if(!this._firstTwoTouches)return;const[I,k]=this._firstTwoTouches,P=ns(w,g,I),z=ns(w,g,k);P&&z||(this._active&&ie(),this.reset())}touchcancel(){this.reset()}enable(c){this._enabled=!0,this._aroundCenter=!!c&&c.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function ns(y,c,g){for(let w=0;w<y.length;w++)if(y[w].identifier===g)return c[w]}function qa(y,c){return Math.log(y/c)/Math.LN2}class uc extends js{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(c){this._startDistance=this._distance=c[0].dist(c[1])}_move(c,g){const w=this._distance;if(this._distance=c[0].dist(c[1]),this._active||!(Math.abs(qa(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:qa(this._distance,w),pinchAround:g}}}function Za(y,c){return 180*y.angleWith(c)/Math.PI}class Gs extends js{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(c){this._startVector=this._vector=c[0].sub(c[1]),this._minDiameter=c[0].dist(c[1])}_move(c,g){const w=this._vector;if(this._vector=c[0].sub(c[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:Za(this._vector,w),pinchAround:g}}_isBelowThreshold(c){this._minDiameter=Math.min(this._minDiameter,c.mag());const g=25/(Math.PI*this._minDiameter)*360,w=Za(c,this._startVector);return Math.abs(w)<g}}function os(y){return Math.abs(y.y)>Math.abs(y.x)}class qs extends js{constructor(c){super(),this._map=c}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(c){this._lastPoints=c,os(c[0].sub(c[1]))&&(this._valid=!1)}_move(c,g,w){const I=this._lastPoints;if(!I)return;const k=c[0].sub(I[0]),P=c[1].sub(I[1]);return this._map._cooperativeGestures&&w.touches.length<3||(this._valid=this.gestureBeginsVertically(k,P,w.timeStamp),!this._valid)?void 0:(this._lastPoints=c,this._active=!0,{pitchDelta:(k.y+P.y)/2*-.5})}gestureBeginsVertically(c,g,w){if(this._valid!==void 0)return this._valid;const I=c.mag()>=2,k=g.mag()>=2;if(!I&&!k)return;if(!I||!k)return this._firstMove==null&&(this._firstMove=w),w-this._firstMove<100&&void 0;const P=c.y>0==g.y>0;return os(c)&&os(g)&&P}}const dc={panStep:100,bearingStep:15,pitchStep:10};class fc{constructor(){const c=dc;this._panStep=c.panStep,this._bearingStep=c.bearingStep,this._pitchStep=c.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(c){if(c.altKey||c.ctrlKey||c.metaKey)return;let g=0,w=0,I=0,k=0,P=0;switch(c.keyCode){case 61:case 107:case 171:case 187:g=1;break;case 189:case 109:case 173:g=-1;break;case 37:c.shiftKey?w=-1:(c.preventDefault(),k=-1);break;case 39:c.shiftKey?w=1:(c.preventDefault(),k=1);break;case 38:c.shiftKey?I=1:(c.preventDefault(),P=-1);break;case 40:c.shiftKey?I=-1:(c.preventDefault(),P=1);break;default:return}return this._rotationDisabled&&(w=0,I=0),{cameraAnimation:z=>{const U=z.getZoom();z.easeTo({duration:300,easeId:"keyboardHandler",easing:pc,zoom:g?Math.round(U)+g*(c.shiftKey?2:1):U,bearing:z.getBearing()+w*this._bearingStep,pitch:z.getPitch()+I*this._pitchStep,offset:[-k*this._panStep,-P*this._panStep],center:z.getCenter()},{originalEvent:c})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function pc(y){return y*(2-y)}const Xa=4.000244140625;class mc{constructor(c,g){this._map=c,this._el=c.getCanvasContainer(),this._handler=g,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,h.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert","_isFullscreen"],this)}setZoomRate(c){this._defaultZoomRate=c}setWheelZoomRate(c){this._wheelZoomRate=c}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(c){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!c&&c.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(c){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(c.ctrlKey||c.metaKey||this.isZooming()||this._isFullscreen()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let g=c.deltaMode===h.window.WheelEvent.DOM_DELTA_LINE?40*c.deltaY:c.deltaY;const w=h.exported.now(),I=w-(this._lastWheelEventTime||0);this._lastWheelEventTime=w,g!==0&&g%Xa==0?this._type="wheel":g!==0&&Math.abs(g)<4?this._type="trackpad":I>400?(this._type=null,this._lastValue=g,this._timeout=setTimeout(this._onTimeout,40,c)):this._type||(this._type=Math.abs(I*g)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,g+=this._lastValue)),c.shiftKey&&g&&(g/=4),this._type&&(this._lastWheelEvent=c,this._delta-=g,this._active||this._start(c)),c.preventDefault()}_onTimeout(c){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(c)}_start(c){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const g=ce(this._el,c);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:g,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const c=this._map.transform,g=()=>c._terrainEnabled()&&this._aroundCoord?c.computeZoomRelativeTo(this._aroundCoord):c.zoom;if(this._delta!==0){const U=this._type==="wheel"&&Math.abs(this._delta)>Xa?this._wheelZoomRate:this._defaultZoomRate;let q=2/(1+Math.exp(-Math.abs(this._delta*U)));this._delta<0&&q!==0&&(q=1/q);const Z=g(),ee=Math.pow(2,Z),ae=typeof this._targetZoom=="number"?c.zoomScale(this._targetZoom):ee;this._targetZoom=Math.min(c.maxZoom,Math.max(c.minZoom,c.scaleZoom(ae*q))),this._type==="wheel"&&(this._startZoom=g(),this._easing=this._smoothOutEasing(200)),this._delta=0}const w=typeof this._targetZoom=="number"?this._targetZoom:g(),I=this._startZoom,k=this._easing;let P,z=!1;if(this._type==="wheel"&&I&&k){const U=Math.min((h.exported.now()-this._lastWheelEventTime)/200,1),q=k(U);P=h.number(I,w,q),U<1?this._frameId||(this._frameId=!0):z=!0}else P=w,z=!0;return this._active=!0,z&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!z,zoomDelta:P-g(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(c){let g=h.ease;if(this._prevEase){const w=this._prevEase,I=(h.exported.now()-w.start)/w.duration,k=w.easing(I+.01)-w.easing(I),P=.27/Math.sqrt(k*k+1e-4)*.01,z=Math.sqrt(.0729-P*P);g=h.bezier(P,z,.25,1)}return this._prevEase={start:h.exported.now(),duration:c,easing:g},g}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=N("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(h.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_isFullscreen(){return!!h.window.document.fullscreenElement||!!h.window.document.webkitFullscreenElement}_showBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show")},200)}}class gc{constructor(c,g){this._clickZoom=c,this._tapZoom=g}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class _c{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(c,g){return c.preventDefault(),{cameraAnimation:w=>{w.easeTo({duration:300,zoom:w.getZoom()+(c.shiftKey?-1:1),around:w.unproject(g)},{originalEvent:c})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ya{constructor(){this._tap=new Qn({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(c,g,w){this._swipePoint||(this._tapTime&&c.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?w.length>0&&(this._swipePoint=g[0],this._swipeTouch=w[0].identifier):this._tap.touchstart(c,g,w))}touchmove(c,g,w){if(this._tapTime){if(this._swipePoint){if(w[0].identifier!==this._swipeTouch)return;const I=g[0],k=I.y-this._swipePoint.y;return this._swipePoint=I,c.preventDefault(),this._active=!0,{zoomDelta:k/128}}}else this._tap.touchmove(c,g,w)}touchend(c,g,w){this._tapTime?this._swipePoint&&w.length===0&&this.reset():this._tap.touchend(c,g,w)&&(this._tapTime=c.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class yc{constructor(c,g,w){this._el=c,this._mousePan=g,this._touchPan=w}enable(c){this._inertiaOptions=c||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class xc{constructor(c,g,w){this._pitchWithRotate=c.pitchWithRotate,this._mouseRotate=g,this._mousePitch=w}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class vc{constructor(c,g,w,I){this._el=c,this._touchZoom=g,this._touchRotate=w,this._tapDragZoom=I,this._rotationDisabled=!1,this._enabled=!0}enable(c){this._touchZoom.enable(c),this._rotationDisabled||this._touchRotate.enable(c),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const ss=y=>y.zoom||y.drag||y.pitch||y.rotate;class Wa extends h.Event{}class bc{constructor(){this.constants=[1,1,.01],this.radius=0}setup(c,g){const w=h.sub([],g,c);this.radius=h.length(w[2]<0?h.div([],w,this.constants):[w[0],w[1],0])}projectRay(c){h.div(c,c,this.constants),h.normalize(c,c),h.mul$1(c,c,this.constants);const g=h.scale$2([],c,this.radius);if(g[2]>0){const w=h.scale$2([],[0,0,1],h.dot(g,[0,0,1])),I=h.scale$2([],h.normalize([],[g[0],g[1],0]),this.radius),k=h.add([],g,h.scale$2([],h.sub([],h.add([],I,w),g),2));g[0]=k[0],g[1]=k[1]}return g}}function bo(y){return y.panDelta&&y.panDelta.mag()||y.zoomDelta||y.bearingDelta||y.pitchDelta}class wc{constructor(c,g){this._map=c,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ac(c),this._bearingSnap=g.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new bc,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(g),h.bindAll(["handleEvent","handleWindowEvent"],this);const w=this._el;this._listeners=[[w,"touchstart",{passive:!0}],[w,"touchmove",{passive:!1}],[w,"touchend",void 0],[w,"touchcancel",void 0],[w,"mousedown",void 0],[w,"mousemove",void 0],[w,"mouseup",void 0],[h.window.document,"mousemove",{capture:!0}],[h.window.document,"mouseup",void 0],[w,"mouseover",void 0],[w,"mouseout",void 0],[w,"dblclick",void 0],[w,"click",void 0],[w,"keydown",{capture:!1}],[w,"keyup",void 0],[w,"wheel",{passive:!1}],[w,"contextmenu",void 0],[h.window,"blur",void 0]];for(const[I,k,P]of this._listeners)I.addEventListener(k,I===h.window.document?this.handleWindowEvent:this.handleEvent,P)}destroy(){for(const[c,g,w]of this._listeners)c.removeEventListener(g,c===h.window.document?this.handleWindowEvent:this.handleEvent,w)}_addDefaultHandlers(c){const g=this._map,w=g.getCanvasContainer();this._add("mapEvent",new yh(g,c));const I=g.boxZoom=new lc(g,c);this._add("boxZoom",I);const k=new Tt,P=new _c;g.doubleClickZoom=new gc(P,k),this._add("tapZoom",k),this._add("clickZoom",P);const z=new Ya;this._add("tapDragZoom",z);const U=g.touchPitch=new qs(g);this._add("touchPitch",U);const q=new vo(c),Z=new Ga(c);g.dragRotate=new xc(c,q,Z),this._add("mouseRotate",q,["mousePitch"]),this._add("mousePitch",Z,["mouseRotate"]);const ee=new rs(c),ae=new hc(g,c);g.dragPan=new yc(w,ee,ae),this._add("mousePan",ee),this._add("touchPan",ae,["touchZoom","touchRotate"]);const me=new Gs,ue=new uc;g.touchZoomRotate=new vc(w,ue,me,z),this._add("touchRotate",me,["touchPan","touchZoom"]),this._add("touchZoom",ue,["touchPan","touchRotate"]),this._add("blockableMapEvent",new wn(g));const oe=g.scrollZoom=new mc(g,this);this._add("scrollZoom",oe,["mousePan"]);const Me=g.keyboard=new fc;this._add("keyboard",Me);for(const ye of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])c.interactive&&c[ye]&&g[ye].enable(c[ye])}_add(c,g,w){this._handlers.push({handlerName:c,handler:g,allowed:w}),this._handlersById[c]=g}stop(c){if(!this._updatingCamera){for(const{handler:g}of this._handlers)g.reset();this._inertia.clear(),this._fireEvents({},{},c),this._changes=[]}}isActive(){for(const{handler:c}of this._handlers)if(c.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!ss(this._eventsInProgress)||this.isZooming()}_blockedByActive(c,g,w){for(const I in c)if(I!==w&&(!g||g.indexOf(I)<0))return!0;return!1}handleWindowEvent(c){this.handleEvent(c,`${c.type}Window`)}_getMapTouches(c){const g=[];for(const w of c)this._el.contains(w.target)&&g.push(w);return g}handleEvent(c,g){this._updatingCamera=!0;const w=c.type==="renderFrame",I=w?void 0:c,k={needsRenderFrame:!1},P={},z={},U=c.touches?this._getMapTouches(c.touches):void 0,q=U?ge(this._el,U):w?void 0:ce(this._el,c);for(const{handlerName:ae,handler:me,allowed:ue}of this._handlers){if(!me.isEnabled())continue;let oe;this._blockedByActive(z,ue,ae)?me.reset():me[g||c.type]&&(oe=me[g||c.type](c,q,U),this.mergeHandlerResult(k,P,oe,ae,I),oe&&oe.needsRenderFrame&&this._triggerRenderFrame()),(oe||me.isActive())&&(z[ae]=me)}const Z={};for(const ae in this._previousActiveHandlers)z[ae]||(Z[ae]=I);this._previousActiveHandlers=z,(Object.keys(Z).length||bo(k))&&(this._changes.push([k,P,Z]),this._triggerRenderFrame()),(Object.keys(z).length||bo(k))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ee}=k;ee&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ee(this._map))}mergeHandlerResult(c,g,w,I,k){if(!w)return;h.extend(c,w);const P={handlerName:I,originalEvent:w.originalEvent||k};w.zoomDelta!==void 0&&(g.zoom=P),w.panDelta!==void 0&&(g.drag=P),w.pitchDelta!==void 0&&(g.pitch=P),w.bearingDelta!==void 0&&(g.rotate=P)}_applyChanges(){const c={},g={},w={};for(const[I,k,P]of this._changes)I.panDelta&&(c.panDelta=(c.panDelta||new h.pointGeometry(0,0))._add(I.panDelta)),I.zoomDelta&&(c.zoomDelta=(c.zoomDelta||0)+I.zoomDelta),I.bearingDelta&&(c.bearingDelta=(c.bearingDelta||0)+I.bearingDelta),I.pitchDelta&&(c.pitchDelta=(c.pitchDelta||0)+I.pitchDelta),I.around!==void 0&&(c.around=I.around),I.aroundCoord!==void 0&&(c.aroundCoord=I.aroundCoord),I.pinchAround!==void 0&&(c.pinchAround=I.pinchAround),I.noInertia&&(c.noInertia=I.noInertia),h.extend(g,k),h.extend(w,P);this._updateMapTransform(c,g,w),this._changes=[]}_updateMapTransform(c,g,w){const I=this._map,k=I.transform,P=Ee=>[Ee.x,Ee.y,Ee.z];if((Ee=>{const Te=this._eventsInProgress.drag;return Te&&!this._handlersById[Te.handlerName].isActive()})()&&!bo(c)){const Ee=k.zoom;k.cameraElevationReference="sea",k.recenterOnTerrain(),k.cameraElevationReference="ground",Ee!==k.zoom&&this._map._update(!0)}if(!bo(c))return void this._fireEvents(g,w,!0);let{panDelta:z,zoomDelta:U,bearingDelta:q,pitchDelta:Z,around:ee,aroundCoord:ae,pinchAround:me}=c;me!==void 0&&(ee=me),(Ee=>g.drag&&!this._eventsInProgress.drag)()&&ee&&(this._dragOrigin=P(k.pointCoordinate3D(ee)),this._trackingEllipsoid.setup(k._camera.position,this._dragOrigin)),k.cameraElevationReference="sea",I._stop(!0),ee=ee||I.transform.centerPoint,q&&(k.bearing+=q),Z&&(k.pitch+=Z),k._updateCameraState();const ue=[0,0,0];if(z){const Ee=k.pointCoordinate(ee);if(k.projection.name==="globe"){const Te=h.latFromMercatorY(Ee.y),Se=k.center.lat,we=Math.min(h.mercatorZfromAltitude(1,Te)/h.mercatorZfromAltitude(1,Se),2);z=z.rotate(-k.angle),ue[0]=-z.x/k.worldSize*we,ue[1]=-z.y/k.worldSize*we}else{const Te=k.pointCoordinate(ee.sub(z));Ee&&Te&&(ue[0]=Te.x-Ee.x,ue[1]=Te.y-Ee.y)}}const oe=k.zoom,Me=[0,0,0];if(U){const Ee=P(ae||k.pointCoordinate3D(ee)),Te={dir:h.normalize([],h.sub([],Ee,k._camera.position))};if(Te.dir[2]<0){const Se=k.zoomDeltaToMovement(Ee,U);h.scale$2(Me,Te.dir,Se)}}const ye=h.add(ue,ue,Me);k._translateCameraConstrained(ye),U&&Math.abs(k.zoom-oe)>1e-4&&k.recenterOnTerrain(),k.cameraElevationReference="ground",this._map._update(),c.noInertia||this._inertia.record(c),this._fireEvents(g,w,!0)}_fireEvents(c,g,w){const I=ss(this._eventsInProgress),k=ss(c),P={};for(const Z in c){const{originalEvent:ee}=c[Z];this._eventsInProgress[Z]||(P[`${Z}start`]=ee),this._eventsInProgress[Z]=c[Z]}!I&&k&&this._fireEvent("movestart",k.originalEvent);for(const Z in P)this._fireEvent(Z,P[Z]);k&&this._fireEvent("move",k.originalEvent);for(const Z in c){const{originalEvent:ee}=c[Z];this._fireEvent(Z,ee)}const z={};let U;for(const Z in this._eventsInProgress){const{handlerName:ee,originalEvent:ae}=this._eventsInProgress[Z];this._handlersById[ee].isActive()||(delete this._eventsInProgress[Z],U=g[ee]||ae,z[`${Z}end`]=U)}for(const Z in z)this._fireEvent(Z,z[Z]);const q=ss(this._eventsInProgress);if(w&&(I||k)&&!q){this._updatingCamera=!0;const Z=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),ee=ae=>ae!==0&&-this._bearingSnap<ae&&ae<this._bearingSnap;Z?(ee(Z.bearing||this._map.getBearing())&&(Z.bearing=0),this._map.easeTo(Z,{originalEvent:U})):(this._map.fire(new h.Event("moveend",{originalEvent:U})),ee(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(c,g){this._map.fire(new h.Event(c,g?{originalEvent:g}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(c=>{this._frameId=void 0,this.handleEvent(new Wa("renderFrame",{timeStamp:c})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Zs="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Ha extends h.Evented{constructor(c,g){super(),this._moving=!1,this._zooming=!1,this.transform=c,this._bearingSnap=g.bearingSnap,h.bindAll(["_renderFrameCallback"],this)}getCenter(){return new h.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(c,g){return this.jumpTo({center:c},g)}panBy(c,g,w){return c=h.pointGeometry.convert(c).mult(-1),this.panTo(this.transform.center,h.extend({offset:c},g),w)}panTo(c,g,w){return this.easeTo(h.extend({center:c},g),w)}getZoom(){return this.transform.zoom}setZoom(c,g){return this.jumpTo({zoom:c},g),this}zoomTo(c,g,w){return this.easeTo(h.extend({zoom:c},g),w)}zoomIn(c,g){return this.zoomTo(this.getZoom()+1,c,g),this}zoomOut(c,g){return this.zoomTo(this.getZoom()-1,c,g),this}getBearing(){return this.transform.bearing}setBearing(c,g){return this.jumpTo({bearing:c},g),this}getPadding(){return this.transform.padding}setPadding(c,g){return this.jumpTo({padding:c},g),this}rotateTo(c,g,w){return this.easeTo(h.extend({bearing:c},g),w)}resetNorth(c,g){return this.rotateTo(0,h.extend({duration:1e3},c),g),this}resetNorthPitch(c,g){return this.easeTo(h.extend({bearing:0,pitch:0,duration:1e3},c),g),this}snapToNorth(c,g){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(c,g):this}getPitch(){return this.transform.pitch}setPitch(c,g){return this.jumpTo({pitch:c},g),this}cameraForBounds(c,g){c=h.LngLatBounds.convert(c);const w=g&&g.bearing||0;return this._cameraForBoxAndBearing(c.getNorthWest(),c.getSouthEast(),w,g)}_extendCameraOptions(c){const g={top:0,bottom:0,right:0,left:0};if(typeof(c=h.extend({padding:g,offset:[0,0],maxZoom:this.transform.maxZoom},c)).padding=="number"){const w=c.padding;c.padding={top:w,bottom:w,right:w,left:w}}return c.padding=h.extend(g,c.padding),c}_cameraForBoxAndBearing(c,g,w,I){const k=this._extendCameraOptions(I),P=this.transform,z=P.padding,U=P.project(h.LngLat.convert(c)),q=P.project(h.LngLat.convert(g)),Z=new h.pointGeometry(U.x,q.y),ee=new h.pointGeometry(q.x,U.y),ae=-h.degToRad(w),me=U.rotate(ae),ue=q.rotate(ae),oe=Z.rotate(ae),Me=ee.rotate(ae),ye=new h.pointGeometry(Math.max(me.x,ue.x,oe.x,Me.x),Math.max(me.y,ue.y,oe.y,Me.y)),Ee=new h.pointGeometry(Math.min(me.x,ue.x,oe.x,Me.x),Math.min(me.y,ue.y,oe.y,Me.y)),Te=ye.sub(Ee),Se=(P.width-((z.left||0)+(z.right||0)+k.padding.left+k.padding.right))/Te.x,we=(P.height-((z.top||0)+(z.bottom||0)+k.padding.top+k.padding.bottom))/Te.y;if(we<0||Se<0)return void h.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const ke=Math.min(P.scaleZoom(P.scale*Math.min(Se,we)),k.maxZoom),$e=typeof k.offset.x=="number"&&typeof k.offset.y=="number"?new h.pointGeometry(k.offset.x,k.offset.y):h.pointGeometry.convert(k.offset),qe=new h.pointGeometry((k.padding.left-k.padding.right)/2,(k.padding.top-k.padding.bottom)/2).rotate(w*Math.PI/180),He=$e.add(qe).mult(P.scale/P.zoomScale(ke));return{center:P.unproject(U.add(q).div(2).sub(He)),zoom:ke,bearing:w}}_cameraForBox(c,g,w,I,k){const P=this._extendCameraOptions(k);w=w||0,I=I||0,c=h.LngLat.convert(c),g=h.LngLat.convert(g);const z=this.transform.clone();z.padding=P.padding;const U=this.getFreeCameraOptions(),q=new h.LngLat(.5*(c.lng+g.lng),.5*(c.lat+g.lat)),Z=.5*(w+I);if(z._camera.position[2]<h.mercatorZfromAltitude(Z,q.lat))return void h.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");U.lookAtPoint(q),z.setFreeCameraOptions(U);const ee=h.MercatorCoordinate.fromLngLat(c),ae=h.MercatorCoordinate.fromLngLat(g),me=z.pointRayIntersection(z.centerPoint,Z),ue=[(oe=z.rayIntersectionCoordinate(me)).x,oe.y,oe.z];var oe;const Me=z.screenPointToMercatorRay(z.centerPoint),ye=z.projection.name!=="globe";let Ee,Te=0;do{const Se=Math.floor(z.zoom),we=1<<Se,ke=Math.min(we*ee.x,we*ae.x),$e=Math.min(we*ee.y,we*ae.y),qe=Math.max(we*ee.x,we*ae.x),He=Math.max(we*ee.y,we*ae.y),Ye=new h.Aabb([ke,$e,w],[qe,He,I]),ht=h.Frustum.fromInvProjectionMatrix(z.invProjMatrix,z.worldSize,Se,ye);if(Ye.intersects(ht)!==2){Ee&&(z._camera.position=h.scaleAndAdd([],z._camera.position,Me.dir,-Ee),z._updateStateFromCamera());break}const Ue=h.sub([],z._camera.position,ue);Ee=.5*h.length(Ue),z._camera.position=h.scaleAndAdd([],z._camera.position,Me.dir,Ee);try{z._updateStateFromCamera()}catch{return void h.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}}while(++Te<10);return{center:z.center,zoom:z.zoom,bearing:z.bearing,pitch:z.pitch}}fitBounds(c,g,w){return this._fitInternal(this.cameraForBounds(c,g),g,w)}_raycastElevationBox(c,g){const w=this.transform.elevation;if(!w)return;const I=new h.pointGeometry(c.x,g.y),k=new h.pointGeometry(g.x,c.y),P=w.pointCoordinate(c);if(!P)return;const z=w.pointCoordinate(g);if(!z)return;const U=w.pointCoordinate(I);if(!U)return;const q=w.pointCoordinate(k);if(!q)return;const Z=new h.MercatorCoordinate(P[0],P[1]).toLngLat(),ee=new h.MercatorCoordinate(z[0],z[1]).toLngLat(),ae=new h.MercatorCoordinate(U[0],U[1]).toLngLat(),me=new h.MercatorCoordinate(q[0],q[1]).toLngLat(),ue=Math.min(Z.lng,Math.min(ee.lng,Math.min(ae.lng,me.lng))),oe=Math.min(Z.lat,Math.min(ee.lat,Math.min(ae.lat,me.lat))),Me=Math.max(Z.lng,Math.max(ee.lng,Math.max(ae.lng,me.lng))),ye=Math.max(Z.lat,Math.max(ee.lat,Math.max(ae.lat,me.lat))),Ee=Math.min(P[3],Math.min(z[3],Math.min(U[3],q[3]))),Te=Math.max(P[3],Math.max(z[3],Math.max(U[3],q[3])));return{minLngLat:new h.LngLat(ue,oe),maxLngLat:new h.LngLat(Me,ye),minAltitude:Ee,maxAltitude:Te}}fitScreenCoordinates(c,g,w,I,k){let P,z,U,q;const Z=h.pointGeometry.convert(c),ee=h.pointGeometry.convert(g),ae=this._raycastElevationBox(Z,ee);if(ae)P=ae.minLngLat,z=ae.maxLngLat,U=ae.minAltitude,q=ae.maxAltitude;else{if(this.transform.anyCornerOffEdge(Z,ee))return this;P=this.transform.pointLocation(Z),z=this.transform.pointLocation(ee)}return this._fitInternal(this.transform.pitch===0?this._cameraForBoxAndBearing(this.transform.pointLocation(h.pointGeometry.convert(c)),this.transform.pointLocation(h.pointGeometry.convert(g)),w,I):this._cameraForBox(P,z,U,q,I),I,k)}_fitInternal(c,g,w){return c?(delete(g=h.extend(c,g)).padding,g.linear?this.easeTo(g,w):this.flyTo(g,w)):this}jumpTo(c,g){this.stop();const w=c.preloadOnly?this.transform.clone():this.transform;let I=!1,k=!1,P=!1;return"zoom"in c&&w.zoom!==+c.zoom&&(I=!0,w.zoom=+c.zoom),c.center!==void 0&&(w.center=h.LngLat.convert(c.center)),"bearing"in c&&w.bearing!==+c.bearing&&(k=!0,w.bearing=+c.bearing),"pitch"in c&&w.pitch!==+c.pitch&&(P=!0,w.pitch=+c.pitch),c.padding==null||w.isPaddingEqual(c.padding)||(w.padding=c.padding),c.preloadOnly?(this._preloadTiles(w),this):(this.fire(new h.Event("movestart",g)).fire(new h.Event("move",g)),I&&this.fire(new h.Event("zoomstart",g)).fire(new h.Event("zoom",g)).fire(new h.Event("zoomend",g)),k&&this.fire(new h.Event("rotatestart",g)).fire(new h.Event("rotate",g)).fire(new h.Event("rotateend",g)),P&&this.fire(new h.Event("pitchstart",g)).fire(new h.Event("pitch",g)).fire(new h.Event("pitchend",g)),this.fire(new h.Event("moveend",g)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||h.warnOnce(Zs),this.transform.getFreeCameraOptions()}setFreeCameraOptions(c,g){const w=this.transform;if(!w.projection.supportsFreeCamera)return h.warnOnce(Zs),this;this.stop();const I=w.zoom,k=w.pitch,P=w.bearing;w.setFreeCameraOptions(c);const z=I!==w.zoom,U=k!==w.pitch,q=P!==w.bearing;return this.fire(new h.Event("movestart",g)).fire(new h.Event("move",g)),z&&this.fire(new h.Event("zoomstart",g)).fire(new h.Event("zoom",g)).fire(new h.Event("zoomend",g)),q&&this.fire(new h.Event("rotatestart",g)).fire(new h.Event("rotate",g)).fire(new h.Event("rotateend",g)),U&&this.fire(new h.Event("pitchstart",g)).fire(new h.Event("pitch",g)).fire(new h.Event("pitchend",g)),this.fire(new h.Event("moveend",g)),this}easeTo(c,g){this._stop(!1,c.easeId),((c=h.extend({offset:[0,0],duration:500,easing:h.ease},c)).animate===!1||!c.essential&&h.exported.prefersReducedMotion)&&(c.duration=0);const w=this.transform,I=this.getZoom(),k=this.getBearing(),P=this.getPitch(),z=this.getPadding(),U="zoom"in c?+c.zoom:I,q="bearing"in c?this._normalizeBearing(c.bearing,k):k,Z="pitch"in c?+c.pitch:P,ee="padding"in c?c.padding:w.padding,ae=h.pointGeometry.convert(c.offset);let me,ue,oe;if(w.projection.name==="globe"){const He=h.MercatorCoordinate.fromLngLat(w.center),Ye=ae.rotate(-w.angle);He.x+=Ye.x/w.worldSize,He.y+=Ye.y/w.worldSize;const ht=He.toLngLat(),Ue=h.LngLat.convert(c.center||ht);this._normalizeCenter(Ue),me=w.centerPoint.add(Ye),ue=new h.pointGeometry(He.x,He.y).mult(w.worldSize),oe=new h.pointGeometry(h.mercatorXfromLng(Ue.lng),h.mercatorYfromLat(Ue.lat)).mult(w.worldSize).sub(ue)}else{me=w.centerPoint.add(ae);const He=w.pointLocation(me),Ye=h.LngLat.convert(c.center||He);this._normalizeCenter(Ye),ue=w.project(He),oe=w.project(Ye).sub(ue)}const Me=w.zoomScale(U-I);let ye,Ee;c.around&&(ye=h.LngLat.convert(c.around),Ee=w.locationPoint(ye));const Te=this._zooming||U!==I,Se=this._rotating||k!==q,we=this._pitching||Z!==P,ke=!w.isPaddingEqual(ee),$e=He=>Ye=>{if(Te&&(He.zoom=h.number(I,U,Ye)),Se&&(He.bearing=h.number(k,q,Ye)),we&&(He.pitch=h.number(P,Z,Ye)),ke&&(He.interpolatePadding(z,ee,Ye),me=He.centerPoint.add(ae)),ye)He.setLocationAtPoint(ye,Ee);else{const ht=He.zoomScale(He.zoom-I),Ue=U>I?Math.min(2,Me):Math.max(.5,Me),lt=Math.pow(Ue,1-Ye),st=He.unproject(ue.add(oe.mult(Ye*lt)).mult(ht));He.setLocationAtPoint(He.renderWorldCopies?st.wrap():st,me)}return c.preloadOnly||this._fireMoveEvents(g),He};if(c.preloadOnly){const He=this._emulate($e,c.duration,w);return this._preloadTiles(He),this}const qe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Te,this._rotating=Se,this._pitching=we,this._padding=ke,this._easeId=c.easeId,this._prepareEase(g,c.noMoveStart,qe),this._ease($e(w),He=>{w.recenterOnTerrain(),this._afterEase(g,He)},c),this}_prepareEase(c,g,w={}){this._moving=!0,this.transform.cameraElevationReference="sea",g||w.moving||this.fire(new h.Event("movestart",c)),this._zooming&&!w.zooming&&this.fire(new h.Event("zoomstart",c)),this._rotating&&!w.rotating&&this.fire(new h.Event("rotatestart",c)),this._pitching&&!w.pitching&&this.fire(new h.Event("pitchstart",c))}_fireMoveEvents(c){this.fire(new h.Event("move",c)),this._zooming&&this.fire(new h.Event("zoom",c)),this._rotating&&this.fire(new h.Event("rotate",c)),this._pitching&&this.fire(new h.Event("pitch",c))}_afterEase(c,g){if(this._easeId&&g&&this._easeId===g)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const w=this._zooming,I=this._rotating,k=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,w&&this.fire(new h.Event("zoomend",c)),I&&this.fire(new h.Event("rotateend",c)),k&&this.fire(new h.Event("pitchend",c)),this.fire(new h.Event("moveend",c))}flyTo(c,g){if(!c.essential&&h.exported.prefersReducedMotion){const St=h.pick(c,["center","zoom","bearing","pitch","around"]);return this.jumpTo(St,g)}this.stop(),c=h.extend({offset:[0,0],speed:1.2,curve:1.42,easing:h.ease},c);const w=this.transform,I=this.getZoom(),k=this.getBearing(),P=this.getPitch(),z=this.getPadding(),U="zoom"in c?h.clamp(+c.zoom,w.minZoom,w.maxZoom):I,q="bearing"in c?this._normalizeBearing(c.bearing,k):k,Z="pitch"in c?+c.pitch:P,ee="padding"in c?c.padding:w.padding,ae=w.zoomScale(U-I),me=h.pointGeometry.convert(c.offset);let ue=w.centerPoint.add(me);const oe=w.pointLocation(ue),Me=h.LngLat.convert(c.center||oe);this._normalizeCenter(Me);const ye=w.project(oe),Ee=w.project(Me).sub(ye);let Te=c.curve;const Se=Math.max(w.width,w.height),we=Se/ae,ke=Ee.mag();if("minZoom"in c){const St=h.clamp(Math.min(c.minZoom,I,U),w.minZoom,w.maxZoom),At=Se/w.zoomScale(St-I);Te=Math.sqrt(At/ke*2)}const $e=Te*Te;function qe(St){const At=(we*we-Se*Se+(St?-1:1)*$e*$e*ke*ke)/(2*(St?we:Se)*$e*ke);return Math.log(Math.sqrt(At*At+1)-At)}function He(St){return(Math.exp(St)-Math.exp(-St))/2}function Ye(St){return(Math.exp(St)+Math.exp(-St))/2}const ht=qe(0);let Ue=function(St){return Ye(ht)/Ye(ht+Te*St)},lt=function(St){return Se*((Ye(ht)*(He(At=ht+Te*St)/Ye(At))-He(ht))/$e)/ke;var At},st=(qe(1)-ht)/Te;if(Math.abs(ke)<1e-6||!isFinite(st)){if(Math.abs(Se-we)<1e-6)return this.easeTo(c,g);const St=we<Se?-1:1;st=Math.abs(Math.log(we/Se))/Te,lt=function(){return 0},Ue=function(At){return Math.exp(St*Te*At)}}c.duration="duration"in c?+c.duration:1e3*st/("screenSpeed"in c?+c.screenSpeed/Te:+c.speed),c.maxDuration&&c.duration>c.maxDuration&&(c.duration=0);const kt=k!==q,Ze=Z!==P,Ut=!w.isPaddingEqual(ee),Gt=St=>At=>{const Kt=At*st,pi=1/Ue(Kt);St.zoom=At===1?U:I+St.scaleZoom(pi),kt&&(St.bearing=h.number(k,q,At)),Ze&&(St.pitch=h.number(P,Z,At)),Ut&&(St.interpolatePadding(z,ee,At),ue=St.centerPoint.add(me));const Ft=At===1?Me:St.unproject(ye.add(Ee.mult(lt(Kt))).mult(pi));return St.setLocationAtPoint(St.renderWorldCopies?Ft.wrap():Ft,ue),St._updateCameraOnTerrain(),c.preloadOnly||this._fireMoveEvents(g),St};if(c.preloadOnly){const St=this._emulate(Gt,c.duration,w);return this._preloadTiles(St),this}return this._zooming=!0,this._rotating=kt,this._pitching=Ze,this._padding=Ut,this._prepareEase(g,!1),this._ease(Gt(w),()=>this._afterEase(g),c),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(c,g){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const w=this._onEaseEnd;this._onEaseEnd=void 0,w.call(this,g)}if(!c){const w=this.handlers;w&&w.stop(!1)}return this}_ease(c,g,w){w.animate===!1||w.duration===0?(c(1),g()):(this._easeStart=h.exported.now(),this._easeOptions=w,this._onEaseFrame=c,this._onEaseEnd=g,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const c=Math.min((h.exported.now()-this._easeStart)/this._easeOptions.duration,1),g=this._onEaseFrame;g&&g(this._easeOptions.easing(c)),c<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(c,g){c=h.wrap(c,-180,180);const w=Math.abs(c-g);return Math.abs(c-360-g)<w&&(c-=360),Math.abs(c+360-g)<w&&(c+=360),c}_normalizeCenter(c){const g=this.transform;if(!g.renderWorldCopies||g.maxBounds)return;const w=c.lng-g.center.lng;c.lng+=w>180?-360:w<-180?360:0}_emulate(c,g,w){const I=Math.ceil(15*g/1e3),k=[],P=c(w.clone());for(let z=0;z<=I;z++){const U=P(z/I);k.push(U.clone())}return k}}class Xs{constructor(c={}){this.options=c,h.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(c){const g=this.options&&this.options.compact;return this._map=c,this._container=N("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=N("button","mapboxgl-ctrl-attrib-button",this._container),N("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=N("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),g&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),g===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(c,g){const w=this._map._getUIString(`AttributionControl.${g}`);c.setAttribute("aria-label",w),c.removeAttribute("title"),c.firstElementChild&&c.firstElementChild.setAttribute("title",w)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let c=this._editLink;c||(c=this._editLink=this._container.querySelector(".mapbox-improve-map"));const g=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||h.config.ACCESS_TOKEN}];if(c){const w=g.reduce((I,k,P)=>(k.value&&(I+=`${k.key}=${k.value}${P<g.length-1?"&":""}`),I),"?");c.href=`${h.config.FEEDBACK_URL}/${w}${this._map._hash?this._map._hash.getHashString(!0):""}`,c.rel="noopener nofollow",this._setElementTitle(c,"MapFeedback")}}_updateData(c){!c||c.sourceDataType!=="metadata"&&c.sourceDataType!=="visibility"&&c.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let c=[];if(this._map.style.stylesheet){const I=this._map.style.stylesheet;this.styleOwner=I.owner,this.styleId=I.id}const g=this._map.style._sourceCaches;for(const I in g){const k=g[I];if(k.used){const P=k.getSource();P.attribution&&c.indexOf(P.attribution)<0&&c.push(P.attribution)}}c.sort((I,k)=>I.length-k.length),c=c.filter((I,k)=>{for(let P=k+1;P<c.length;P++)if(c[P].indexOf(I)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?c=[...this.options.customAttribution,...c]:c.unshift(this.options.customAttribution));const w=c.join(" | ");w!==this._attribHTML&&(this._attribHTML=w,c.length?(this._innerContainer.innerHTML=w,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Ec{constructor(){h.bindAll(["_updateLogo","_updateCompact"],this)}onAdd(c){this._map=c,this._container=N("div","mapboxgl-ctrl");const g=N("a","mapboxgl-ctrl-logo");return g.target="_blank",g.rel="noopener nofollow",g.href="https://www.mapbox.com/",g.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),g.setAttribute("rel","noopener nofollow"),this._container.appendChild(g),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(c){c&&c.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const c=this._map.style._sourceCaches;if(Object.entries(c).length===0)return!0;for(const g in c){const w=c[g].getSource();if(w.hasOwnProperty("mapbox_logo")&&!w.mapbox_logo)return!1}return!0}_updateCompact(){const c=this._container.children;if(c.length){const g=c[0];this._map.getCanvasContainer().offsetWidth<250?g.classList.add("mapboxgl-compact"):g.classList.remove("mapboxgl-compact")}}}class Tc{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(c){const g=++this._id;return this._queue.push({callback:c,id:g,cancelled:!1}),g}remove(c){const g=this._currentlyRunning,w=g?this._queue.concat(g):this._queue;for(const I of w)if(I.id===c)return void(I.cancelled=!0)}run(c=0){const g=this._currentlyRunning=this._queue;this._queue=[];for(const w of g)if(!w.cancelled&&(w.callback(c),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Ys(y,c,g){if(y=new h.LngLat(y.lng,y.lat),c){const w=new h.LngLat(y.lng-360,y.lat),I=new h.LngLat(y.lng+360,y.lat),k=360*Math.ceil(Math.abs(y.lng-g.center.lng)/360),P=g.locationPoint(y).distSqr(c),z=c.x<0||c.y<0||c.x>g.width||c.y>g.height;g.locationPoint(w).distSqr(c)<P&&(z||Math.abs(w.lng-g.center.lng)<k)?y=w:g.locationPoint(I).distSqr(c)<P&&(z||Math.abs(I.lng-g.center.lng)<k)&&(y=I)}for(;Math.abs(y.lng-g.center.lng)>180;){const w=g.locationPoint(y);if(w.x>=0&&w.y>=0&&w.x<=g.width&&w.y<=g.height)break;y.lng>g.center.lng?y.lng-=360:y.lng+=360}return y}const Ws={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Hs extends h.Evented{constructor(c,g){if(super(),(c instanceof h.window.HTMLElement||g)&&(c=h.extend({element:c},g)),h.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=c&&c.anchor||"center",this._color=c&&c.color||"#3FB1CE",this._scale=c&&c.scale||1,this._draggable=c&&c.draggable||!1,this._clickTolerance=c&&c.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=c&&c.rotation||0,this._rotationAlignment=c&&c.rotationAlignment||"auto",this._pitchAlignment=c&&c.pitchAlignment&&c.pitchAlignment!=="auto"?c.pitchAlignment:this._rotationAlignment,this._updateMoving=()=>this._update(!0),c&&c.element)this._element=c.element,this._offset=h.pointGeometry.convert(c&&c.offset||[0,0]);else{this._defaultMarker=!0,this._element=N("div");const I=41,k=27,P=F("svg",{display:"block",height:I*this._scale+"px",width:k*this._scale+"px",viewBox:`0 0 ${k} ${I}`},this._element),z=F("radialGradient",{id:"shadowGradient"},F("defs",{},P));F("stop",{offset:"10%","stop-opacity":.4},z),F("stop",{offset:"100%","stop-opacity":.05},z),F("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},P),F("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},P),F("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},P),F("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},P),this._offset=h.pointGeometry.convert(c&&c.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",I=>{I.preventDefault()}),this._element.addEventListener("mousedown",I=>{I.preventDefault()});const w=this._element.classList;for(const I in Ws)w.remove(`mapboxgl-marker-anchor-${I}`);w.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(c){return c===this._map||(this.remove(),this._map=c,c.getCanvasContainer().appendChild(this._element),c.on("move",this._updateMoving),c.on("moveend",this._update),c.on("remove",this._clearFadeTimer),c._addMarker(this),this.setDraggable(this._draggable),this._update(),c.on("click",this._onMapClick)),this}remove(){const c=this._map;return c&&(c.off("click",this._onMapClick),c.off("move",this._updateMoving),c.off("moveend",this._update),c.off("mousedown",this._addDragHandler),c.off("touchstart",this._addDragHandler),c.off("mouseup",this._onUp),c.off("touchend",this._onUp),c.off("mousemove",this._onMove),c.off("touchmove",this._onMove),c.off("remove",this._clearFadeTimer),c._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(c){return this._lngLat=h.LngLat.convert(c),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(c){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),c){if(!("offset"in c.options)){const I=Math.sqrt(Math.pow(13.5,2)/2);c.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[I,-1*(38.1-13.5+I)],"bottom-right":[-I,-1*(38.1-13.5+I)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=c,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(c){const g=c.code,w=c.charCode||c.keyCode;g!=="Space"&&g!=="Enter"&&w!==32&&w!==13||this.togglePopup()}_onMapClick(c){const g=c.originalEvent.target,w=this._element;this._popup&&(g===w||w.contains(g))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const c=this._popup;return c?(c.isOpen()?(c.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(c.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_evaluateOpacity(){const c=this._map;if(!c)return;const g=this._pos;if(!g||g.x<0||g.x>c.transform.width||g.y<0||g.y>c.transform.height)return void this._clearFadeTimer();const w=c.unproject(g);let I=!1;if(c.transform._terrainEnabled()&&c.getTerrain()){const P=c.getFreeCameraOptions();if(P.position){const z=P.position.toLngLat();I=z.distanceTo(w)<.9*z.distanceTo(this._lngLat)}}const k=(1-c._queryFogOpacity(w))*(I?.2:1);this._element.style.opacity=`${k}`,this._popup&&this._popup._setOpacity(`${k}`),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const c=this._pos;if(!c)return;const g=this._offset.mult(this._scale),w=this._calculatePitch(),I=this._calculateRotation();this._element.style.transform=`
            translate(${c.x}px, ${c.y}px) ${Ws[this._anchor]}
            rotateX(${w}deg) rotateZ(${I}deg)
            translate(${g.x}px, ${g.y}px)
        `}_calculatePitch(){return this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?0:this._map&&this._pitchAlignment==="map"?this._map.getPitch():0}_calculateRotation(){return this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?this._rotation:this._map&&this._rotationAlignment==="map"?this._rotation-this._map.getBearing():0}_update(c){h.window.cancelAnimationFrame(this._updateFrameId);const g=this._map;g&&(g.transform.renderWorldCopies&&(this._lngLat=Ys(this._lngLat,this._pos,g.transform)),this._pos=g.project(this._lngLat),c===!0?this._updateFrameId=h.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),g._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),!g.getTerrain()&&!g.getFog()||this._fadeTimer||(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(c){return this._offset=h.pointGeometry.convert(c),this._update(),this}_onMove(c){const g=this._map;if(g){if(!this._isDragging){const w=this._clickTolerance||g._clickTolerance;this._isDragging=c.point.dist(this._pointerdownPos)>=w}this._isDragging&&(this._pos=c.point.sub(this._positionDelta),this._lngLat=g.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new h.Event("dragstart"))),this.fire(new h.Event("drag")))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const c=this._map;c&&(c.off("mousemove",this._onMove),c.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new h.Event("dragend")),this._state="inactive"}_addDragHandler(c){const g=this._map;g&&this._element.contains(c.originalEvent.target)&&(c.preventDefault(),this._positionDelta=c.point.sub(this._pos),this._pointerdownPos=c.point,this._state="pending",g.on("mousemove",this._onMove),g.on("touchmove",this._onMove),g.once("mouseup",this._onUp),g.once("touchend",this._onUp))}setDraggable(c){this._draggable=!!c;const g=this._map;return g&&(c?(g.on("mousedown",this._addDragHandler),g.on("touchstart",this._addDragHandler)):(g.off("mousedown",this._addDragHandler),g.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(c){return this._rotation=c||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(c){return this._rotationAlignment=c||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(c){return this._pitchAlignment=c&&c!=="auto"?c:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}}class xh{constructor(c){this.jumpTo(c)}getValue(c){if(c<=this._startTime)return this._start;if(c>=this._endTime)return this._end;const g=h.easeCubicInOut((c-this._startTime)/(this._endTime-this._startTime));return this._start*(1-g)+this._end*g}isEasing(c){return c>=this._startTime&&c<=this._endTime}jumpTo(c){this._startTime=-1/0,this._endTime=-1/0,this._start=c,this._end=c}easeTo(c,g,w){this._start=this.getValue(g),this._end=c,this._startTime=g,this._endTime=g+w}}const vh={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},Ka={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function as(y){y.parentNode&&y.parentNode.removeChild(y)}const Ja={showCompass:!0,showZoom:!0,visualizePitch:!1};class Qa{constructor(c,g,w=!1){this._clickTolerance=10,this.element=g,this.mouseRotate=new vo({clickTolerance:c.dragRotate._mouseRotate._clickTolerance}),this.map=c,w&&(this.mousePitch=new Ga({clickTolerance:c.dragRotate._mousePitch._clickTolerance})),h.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),g.addEventListener("mousedown",this.mousedown),g.addEventListener("touchstart",this.touchstart,{passive:!1}),g.addEventListener("touchmove",this.touchmove),g.addEventListener("touchend",this.touchend),g.addEventListener("touchcancel",this.reset)}down(c,g){this.mouseRotate.mousedown(c,g),this.mousePitch&&this.mousePitch.mousedown(c,g),X()}move(c,g){const w=this.map,I=this.mouseRotate.mousemoveWindow(c,g),k=I&&I.bearingDelta;if(k&&w.setBearing(w.getBearing()+k),this.mousePitch){const P=this.mousePitch.mousemoveWindow(c,g),z=P&&P.pitchDelta;z&&w.setPitch(w.getPitch()+z)}}off(){const c=this.element;c.removeEventListener("mousedown",this.mousedown),c.removeEventListener("touchstart",this.touchstart,{passive:!1}),c.removeEventListener("touchmove",this.touchmove),c.removeEventListener("touchend",this.touchend),c.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){de(),h.window.removeEventListener("mousemove",this.mousemove),h.window.removeEventListener("mouseup",this.mouseup)}mousedown(c){this.down(h.extend({},c,{ctrlKey:!0,preventDefault:()=>c.preventDefault()}),ce(this.element,c)),h.window.addEventListener("mousemove",this.mousemove),h.window.addEventListener("mouseup",this.mouseup)}mousemove(c){this.move(c,ce(this.element,c))}mouseup(c){this.mouseRotate.mouseupWindow(c),this.mousePitch&&this.mousePitch.mouseupWindow(c),this.offTemp()}touchstart(c){c.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=ge(this.element,c.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>c.preventDefault()},this._startPos))}touchmove(c){c.targetTouches.length!==1?this.reset():(this._lastPos=ge(this.element,c.targetTouches)[0],this.move({preventDefault:()=>c.preventDefault()},this._lastPos))}touchend(c){c.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const Ir={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1};let $r,ls=0,eo=!1;const el={maxWidth:100,unit:"metric"};function Ks(y,c,g){const w=g&&g.maxWidth||100,I=y._containerHeight/2,k=y._containerWidth/2-w/2,P=y.unproject([k,I]),z=y.unproject([k+w,I]),U=P.distanceTo(z);if(g&&g.unit==="imperial"){const q=3.2808*U;q>5280?wo(c,w,q/5280,y._getUIString("ScaleControl.Miles"),y):wo(c,w,q,y._getUIString("ScaleControl.Feet"),y)}else g&&g.unit==="nautical"?wo(c,w,U/1852,y._getUIString("ScaleControl.NauticalMiles"),y):U>=1e3?wo(c,w,U/1e3,y._getUIString("ScaleControl.Kilometers"),y):wo(c,w,U,y._getUIString("ScaleControl.Meters"),y)}function wo(y,c,g,w,I){const k=function(z){const U=Math.pow(10,`${Math.floor(z)}`.length-1);let q=z/U;return q=q>=10?10:q>=5?5:q>=3?3:q>=2?2:q>=1?1:function(Z){const ee=Math.pow(10,Math.ceil(-Math.log(Z)/Math.LN10));return Math.round(Z*ee)/ee}(q),U*q}(g),P=k/g;I._requestDomTask(()=>{y.style.width=c*P+"px",y.innerHTML=`${k}&nbsp;${w}`})}const Wr={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Vi=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function cs(y=new h.pointGeometry(0,0),c="bottom"){if(typeof y=="number"){const g=Math.round(Math.sqrt(.5*Math.pow(y,2)));switch(c){case"top":return new h.pointGeometry(0,y);case"top-left":return new h.pointGeometry(g,g);case"top-right":return new h.pointGeometry(-g,g);case"bottom":return new h.pointGeometry(0,-y);case"bottom-left":return new h.pointGeometry(g,-g);case"bottom-right":return new h.pointGeometry(-g,-g);case"left":return new h.pointGeometry(y,0);case"right":return new h.pointGeometry(-y,0)}return new h.pointGeometry(0,0)}return y instanceof h.pointGeometry||Array.isArray(y)?h.pointGeometry.convert(y):h.pointGeometry.convert(y[c]||[0,0])}const Eo={version:h.version,supported:S,setRTLTextPlugin:h.setRTLTextPlugin,getRTLTextPluginStatus:h.getRTLTextPluginStatus,Map:class extends Ha{constructor(y){if((y=h.extend({},Ka,y)).minZoom!=null&&y.maxZoom!=null&&y.minZoom>y.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(y.minPitch!=null&&y.maxPitch!=null&&y.minPitch>y.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(y.minPitch!=null&&y.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(y.maxPitch!=null&&y.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(y.antialias&&h.isSafariWithAntialiasingBug(h.window)&&(y.antialias=!1,h.warnOnce("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Us(y.minZoom,y.maxZoom,y.minPitch,y.maxPitch,y.renderWorldCopies),y),this._interactive=y.interactive,this._minTileCacheSize=y.minTileCacheSize,this._maxTileCacheSize=y.maxTileCacheSize,this._failIfMajorPerformanceCaveat=y.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=y.preserveDrawingBuffer,this._antialias=y.antialias,this._trackResize=y.trackResize,this._bearingSnap=y.bearingSnap,this._refreshExpiredTiles=y.refreshExpiredTiles,this._fadeDuration=y.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=y.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=y.collectResourceTiming,this._optimizeForTerrain=y.optimizeForTerrain,this._renderTaskQueue=new Tc,this._domRenderTaskQueue=new Tc,this._controls=[],this._markers=[],this._mapId=h.uniqueId(),this._locale=h.extend({},vh,y.locale),this._clickTolerance=y.clickTolerance,this._cooperativeGestures=y.cooperativeGestures,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new xh(0),this._explicitProjection=null,this._requestManager=new h.RequestManager(y.transformRequest,y.accessToken,y.testMode),this._silenceAuthErrors=!!y.testMode,typeof y.container=="string"){if(this._container=h.window.document.getElementById(y.container),!this._container)throw new Error(`Container '${y.container}' not found.`)}else{if(!(y.container instanceof h.window.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=y.container}if(this._container.childNodes.length>0&&h.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),y.maxBounds&&this.setMaxBounds(y.maxBounds),h.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),h.window!==void 0&&(h.window.addEventListener("online",this._onWindowOnline,!1),h.window.addEventListener("resize",this._onWindowResize,!1),h.window.addEventListener("orientationchange",this._onWindowResize,!1),h.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new wc(this,y),this._localFontFamily=y.localFontFamily,this._localIdeographFontFamily=y.localIdeographFontFamily,y.style&&this.setStyle(y.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),y.projection&&this.setProjection(y.projection),this._hash=y.hash&&new ic(typeof y.hash=="string"&&y.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:y.center,zoom:y.zoom,bearing:y.bearing,pitch:y.pitch}),y.bounds&&(this.resize(),this.fitBounds(y.bounds,h.extend({},y.fitBoundsOptions,{duration:0})))),this.resize(),y.attributionControl&&this.addControl(new Xs({customAttribution:y.customAttribution})),this._logoControl=new Ec,this.addControl(this._logoControl,y.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",c=>{this._update(c.dataType==="style"),this.fire(new h.Event(`${c.dataType}data`,c))}),this.on("dataloading",c=>{this.fire(new h.Event(`${c.dataType}dataloading`,c))})}_getMapId(){return this._mapId}addControl(y,c){if(c===void 0&&(c=y.getDefaultPosition?y.getDefaultPosition():"top-right"),!y||!y.onAdd)return this.fire(new h.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const g=y.onAdd(this);this._controls.push(y);const w=this._controlPositions[c];return c.indexOf("bottom")!==-1?w.insertBefore(g,w.firstChild):w.appendChild(g),this}removeControl(y){if(!y||!y.onRemove)return this.fire(new h.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const c=this._controls.indexOf(y);return c>-1&&this._controls.splice(c,1),y.onRemove(this),this}hasControl(y){return this._controls.indexOf(y)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(y){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const c=!this._moving;return c&&this.fire(new h.Event("movestart",y)).fire(new h.Event("move",y)),this.fire(new h.Event("resize",y)),c&&this.fire(new h.Event("moveend",y)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(y){return this.transform.setMaxBounds(h.LngLatBounds.convert(y)),this._update()}setMinZoom(y){if((y=y==null?-2:y)>=-2&&y<=this.transform.maxZoom)return this.transform.minZoom=y,this._update(),this.getZoom()<y?this.setZoom(y):this.fire(new h.Event("zoomstart")).fire(new h.Event("zoom")).fire(new h.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(y){if((y=y==null?22:y)>=this.transform.minZoom)return this.transform.maxZoom=y,this._update(),this.getZoom()>y?this.setZoom(y):this.fire(new h.Event("zoomstart")).fire(new h.Event("zoom")).fire(new h.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(y){if((y=y==null?0:y)<0)throw new Error("minPitch must be greater than or equal to 0");if(y>=0&&y<=this.transform.maxPitch)return this.transform.minPitch=y,this._update(),this.getPitch()<y?this.setPitch(y):this.fire(new h.Event("pitchstart")).fire(new h.Event("pitch")).fire(new h.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(y){if((y=y==null?85:y)>85)throw new Error("maxPitch must be less than or equal to 85");if(y>=this.transform.minPitch)return this.transform.maxPitch=y,this._update(),this.getPitch()>y?this.setPitch(y):this.fire(new h.Event("pitchstart")).fire(new h.Event("pitch")).fire(new h.Event("pitchend")),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(y){return this.transform.renderWorldCopies=y,this._update()}getProjection(){return this._explicitProjection?this._explicitProjection:this.style&&this.style.stylesheet&&this.style.stylesheet.projection?this.style.stylesheet.projection:{name:"mercator",center:[0,0]}}setProjection(y){return this._lazyInitEmptyStyle(),y?typeof y=="string"&&(y={name:y}):y=null,this._updateProjection(y)}_updateProjection(y){y===null&&(this._explicitProjection=null);const c=y||this.getProjection(),g=this.transform.setProjection(c);if(y&&(this._explicitProjection=this.transform.getProjection()),g){this.painter.clearBackgroundTiles();for(const w in this.style._sourceCaches)this.style._sourceCaches[w].clearTiles();this.style.applyProjectionUpdate(),this._update(!0)}return this}project(y){return this.transform.locationPoint3D(h.LngLat.convert(y))}unproject(y){return this.transform.pointLocation3D(h.pointGeometry.convert(y))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_createDelegatedListener(y,c,g){if(y==="mouseenter"||y==="mouseover"){let w=!1;const I=P=>{const z=c.filter(q=>this.getLayer(q)),U=z.length?this.queryRenderedFeatures(P.point,{layers:z}):[];U.length?w||(w=!0,g.call(this,new Nr(y,this,P.originalEvent,{features:U}))):w=!1},k=()=>{w=!1};return{layers:new Set(c),listener:g,delegates:{mousemove:I,mouseout:k}}}if(y==="mouseleave"||y==="mouseout"){let w=!1;const I=P=>{const z=c.filter(U=>this.getLayer(U));(z.length?this.queryRenderedFeatures(P.point,{layers:z}):[]).length?w=!0:w&&(w=!1,g.call(this,new Nr(y,this,P.originalEvent)))},k=P=>{w&&(w=!1,g.call(this,new Nr(y,this,P.originalEvent)))};return{layers:new Set(c),listener:g,delegates:{mousemove:I,mouseout:k}}}{const w=I=>{const k=c.filter(z=>this.getLayer(z)),P=k.length?this.queryRenderedFeatures(I.point,{layers:k}):[];P.length&&(I.features=P,g.call(this,I),delete I.features)};return{layers:new Set(c),listener:g,delegates:{[y]:w}}}}on(y,c,g){if(g===void 0)return super.on(y,c);Array.isArray(c)||(c=[c]);const w=this._createDelegatedListener(y,c,g);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[y]=this._delegatedListeners[y]||[],this._delegatedListeners[y].push(w);for(const I in w.delegates)this.on(I,w.delegates[I]);return this}once(y,c,g){if(g===void 0)return super.once(y,c);Array.isArray(c)||(c=[c]);const w=this._createDelegatedListener(y,c,g);for(const I in w.delegates)this.once(I,w.delegates[I]);return this}off(y,c,g){if(g===void 0)return super.off(y,c);c=new Set(Array.isArray(c)?c:[c]);const w=(k,P)=>{if(k.size!==P.size)return!1;for(const z of k)if(!P.has(z))return!1;return!0},I=this._delegatedListeners?this._delegatedListeners[y]:void 0;return I&&(k=>{for(let P=0;P<k.length;P++){const z=k[P];if(z.listener===g&&w(z.layers,c)){for(const U in z.delegates)this.off(U,z.delegates[U]);return k.splice(P,1),this}}})(I),this}queryRenderedFeatures(y,c){return this.style?(c!==void 0||y===void 0||y instanceof h.pointGeometry||Array.isArray(y)||(c=y,y=void 0),this.style.queryRenderedFeatures(y=y||[[0,0],[this.transform.width,this.transform.height]],c=c||{},this.transform)):[]}querySourceFeatures(y,c){return this.style.querySourceFeatures(y,c)}queryTerrainElevation(y,c){const g=this.transform.elevation;return g?(c=h.extend({},{exaggerated:!0},c),g.getAtPoint(h.MercatorCoordinate.fromLngLat(y),null,c.exaggerated)):null}setStyle(y,c){return(c=h.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},c)).diff!==!1&&c.localIdeographFontFamily===this._localIdeographFontFamily&&c.localFontFamily===this._localFontFamily&&this.style&&y?(this._diffStyle(y,c),this):(this._localIdeographFontFamily=c.localIdeographFontFamily,this._localFontFamily=c.localFontFamily,this._updateStyle(y,c))}_getUIString(y){const c=this._locale[y];if(c==null)throw new Error(`Missing UI string '${y}'`);return c}_updateStyle(y,c){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),y&&(this.style=new Ar(this,c||{}),this.style.setEventedParent(this,{style:this.style}),typeof y=="string"?this.style.loadURL(y):this.style.loadJSON(y)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Ar(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(y,c){if(typeof y=="string"){const g=this._requestManager.normalizeStyleURL(y),w=this._requestManager.transformRequest(g,h.ResourceType.Style);h.getJSON(w,(I,k)=>{I?this.fire(new h.ErrorEvent(I)):k&&this._updateDiff(k,c)})}else typeof y=="object"&&this._updateDiff(y,c)}_updateDiff(y,c){try{this.style.setState(y)&&this._update(!0)}catch(g){h.warnOnce(`Unable to perform style diff: ${g.message||g.error||g}.  Rebuilding the style from scratch.`),this._updateStyle(y,c)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(h.warnOnce("There is no style added to the map."),!1)}addSource(y,c){return this._lazyInitEmptyStyle(),this.style.addSource(y,c),this._update(!0)}isSourceLoaded(y){return!!this.style&&this.style._isSourceCacheLoaded(y)}areTilesLoaded(){const y=this.style&&this.style._sourceCaches;for(const c in y){const g=y[c]._tiles;for(const w in g){const I=g[w];if(I.state!=="loaded"&&I.state!=="errored")return!1}}return!0}addSourceType(y,c,g){this._lazyInitEmptyStyle(),this.style.addSourceType(y,c,g)}removeSource(y){return this.style.removeSource(y),this._updateTerrain(),this._update(!0)}getSource(y){return this.style.getSource(y)}addImage(y,c,{pixelRatio:g=1,sdf:w=!1,stretchX:I,stretchY:k,content:P}={}){if(this._lazyInitEmptyStyle(),c instanceof h.window.HTMLImageElement||h.window.ImageBitmap&&c instanceof h.window.ImageBitmap){const{width:z,height:U,data:q}=h.exported.getImageData(c);this.style.addImage(y,{data:new h.RGBAImage({width:z,height:U},q),pixelRatio:g,stretchX:I,stretchY:k,content:P,sdf:w,version:0})}else if(c.width===void 0||c.height===void 0)this.fire(new h.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:z,height:U}=c,q=c;this.style.addImage(y,{data:new h.RGBAImage({width:z,height:U},new Uint8Array(q.data)),pixelRatio:g,stretchX:I,stretchY:k,content:P,sdf:w,version:0,userImage:q}),q.onAdd&&q.onAdd(this,y)}}updateImage(y,c){const g=this.style.getImage(y);if(!g)return void this.fire(new h.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const w=c instanceof h.window.HTMLImageElement||h.window.ImageBitmap&&c instanceof h.window.ImageBitmap?h.exported.getImageData(c):c,{width:I,height:k}=w;I!==void 0&&k!==void 0?I===g.data.width&&k===g.data.height?(g.data.replace(w.data,!(c instanceof h.window.HTMLImageElement||h.window.ImageBitmap&&c instanceof h.window.ImageBitmap)),this.style.updateImage(y,g)):this.fire(new h.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image"))):this.fire(new h.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(y){return y?!!this.style.getImage(y):(this.fire(new h.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(y){this.style.removeImage(y)}loadImage(y,c){h.getImage(this._requestManager.transformRequest(y,h.ResourceType.Image),(g,w)=>{c(g,w instanceof h.window.HTMLImageElement?h.exported.getImageData(w):w)})}listImages(){return this.style.listImages()}addLayer(y,c){return this._lazyInitEmptyStyle(),this.style.addLayer(y,c),this._update(!0)}moveLayer(y,c){return this.style.moveLayer(y,c),this._update(!0)}removeLayer(y){return this.style.removeLayer(y),this._update(!0)}getLayer(y){return this.style.getLayer(y)}setLayerZoomRange(y,c,g){return this.style.setLayerZoomRange(y,c,g),this._update(!0)}setFilter(y,c,g={}){return this.style.setFilter(y,c,g),this._update(!0)}getFilter(y){return this.style.getFilter(y)}setPaintProperty(y,c,g,w={}){return this.style.setPaintProperty(y,c,g,w),this._update(!0)}getPaintProperty(y,c){return this.style.getPaintProperty(y,c)}setLayoutProperty(y,c,g,w={}){return this.style.setLayoutProperty(y,c,g,w),this._update(!0)}getLayoutProperty(y,c){return this.style.getLayoutProperty(y,c)}setLight(y,c={}){return this._lazyInitEmptyStyle(),this.style.setLight(y,c),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(y){return this._lazyInitEmptyStyle(),!y&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(y),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(y){return this._lazyInitEmptyStyle(),this.style.setFog(y),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(y){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(h.LngLat.convert(y),this.transform):0}setFeatureState(y,c){return this.style.setFeatureState(y,c),this._update()}removeFeatureState(y,c){return this.style.removeFeatureState(y,c),this._update()}getFeatureState(y){return this.style.getFeatureState(y)}_updateContainerDimensions(){if(!this._container)return;const y=this._container.getBoundingClientRect().width||400,c=this._container.getBoundingClientRect().height||300;let g,w,I,k=this._container;for(;k&&(!w||!I);){const P=h.window.getComputedStyle(k).transform;P&&P!=="none"&&(g=P.match(/matrix.*\((.+)\)/)[1].split(", "),g[0]&&g[0]!=="0"&&g[0]!=="1"&&(w=g[0]),g[3]&&g[3]!=="0"&&g[3]!=="1"&&(I=g[3])),k=k.parentElement}this._containerWidth=w?Math.abs(y/w):y,this._containerHeight=I?Math.abs(c/I):c}_detectMissingCSS(){h.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&h.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const y=this._container;y.classList.add("mapboxgl-map"),(this._missingCSSCanary=N("div","mapboxgl-canary",y)).style.visibility="hidden",this._detectMissingCSS();const c=this._canvasContainer=N("div","mapboxgl-canvas-container",y);this._interactive&&c.classList.add("mapboxgl-interactive"),this._canvas=N("canvas","mapboxgl-canvas",c),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const g=this._controlContainer=N("div","mapboxgl-control-container",y),w=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(I=>{w[I]=N("div",`mapboxgl-ctrl-${I}`,g)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(y,c){const g=h.exported.devicePixelRatio||1;this._canvas.width=g*Math.ceil(y),this._canvas.height=g*Math.ceil(c),this._canvas.style.width=`${y}px`,this._canvas.style.height=`${c}px`}_addMarker(y){this._markers.push(y)}_removeMarker(y){const c=this._markers.indexOf(y);c!==-1&&this._markers.splice(c,1)}_setupPainter(){const y=h.extend({},S.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),c=this._canvas.getContext("webgl",y)||this._canvas.getContext("experimental-webgl",y);c?(h.storeAuthState(c,!0),this.painter=new ec(c,this.transform),this.on("data",g=>{g.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),h.exported$1.testSupport(c)):this.fire(new h.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(y){y.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new h.Event("webglcontextlost",{originalEvent:y}))}_contextRestored(y){this._setupPainter(),this.resize(),this._update(),this.fire(new h.Event("webglcontextrestored",{originalEvent:y}))}_onMapScroll(y){if(y.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(y){return this.style?(this._styleDirty=this._styleDirty||y,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(y){return this._update(),this._renderTaskQueue.add(y)}_cancelRenderFrame(y){this._renderTaskQueue.remove(y)}_requestDomTask(y){!this.loaded()||this.loaded()&&!this.isMoving()?y():this._domRenderTaskQueue.add(y)}_render(y){let c;const g=this.painter.context.extTimerQuery,w=h.exported.now();if(this.listens("gpu-timing-frame")&&(c=g.createQueryEXT(),g.beginQueryEXT(g.TIME_ELAPSED_EXT,c)),this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(y),this._domRenderTaskQueue.run(y),this._removed)return;let I=!1;const k=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const U=this.transform.zoom,q=this.transform.pitch,Z=h.exported.now();this.style.zoomHistory.update(U,Z);const ee=new h.EvaluationParameters(U,{now:Z,fadeDuration:k,pitch:q,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),ae=ee.crossFadingFactor();ae===1&&ae===this._crossFadingFactor||(I=!0,this._crossFadingFactor=ae),this.style.update(ee)}this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let P=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),P=this._updateAverageElevation(w),this.style._updateSources(this.transform),this._forceMarkerUpdate()):P=this._updateAverageElevation(w),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,k,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:k,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),speedIndexTiming:this.speedIndexTiming}),this.fire(new h.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new h.Event("load"))),this.style&&(this.style.hasTransitions()||I)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const U=h.exported.now()-w;g.endQueryEXT(g.TIME_ELAPSED_EXT,c),setTimeout(()=>{const q=g.getQueryObjectEXT(c,g.QUERY_RESULT_EXT)/1e6;g.deleteQueryEXT(c),this.fire(new h.Event("gpu-timing-frame",{cpuTime:U,gpuTime:q}))},50)}if(this.listens("gpu-timing-layer")){const U=this.painter.collectGpuTimers();setTimeout(()=>{const q=this.painter.queryGpuTimers(U);this.fire(new h.Event("gpu-timing-layer",{layerTimes:q}))},50)}const z=this._sourcesDirty||this._styleDirty||this._placementDirty||P;if(z||this._repaint)this.triggerRepaint();else{const U=!this.isMoving()&&this.loaded();if(U&&(P=this._updateAverageElevation(w,!0)),P)this.triggerRepaint();else if(this._triggerFrame(!1),U&&(this.fire(new h.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const q=this._calculateSpeedIndex();this.fire(new h.Event("speedindexcompleted",{speedIndex:q})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||z||(this._fullyLoaded=!0,this._authenticate())}_forceMarkerUpdate(){for(const y of this._markers)y._update()}_updateAverageElevation(y,c=!1){const g=w=>(this.transform.averageElevation=w,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&g(0);if((c||y-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(y)){const w=this.transform.averageElevation;let I=this.transform.sampleAverageElevation(),k=!1;this.transform.elevation&&(k=this.transform.elevation.exaggeration()!==this._averageElevationExaggeration,this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(I)?I=0:this._averageElevationLastSampledAt=y;const P=Math.abs(w-I);if(P>1){if(this._isInitialLoad||k)return this._averageElevation.jumpTo(I),g(I);this._averageElevation.easeTo(I,y,300)}else if(P>1e-4)return this._averageElevation.jumpTo(I),g(I)}return!!this._averageElevation.isEasing(y)&&g(this._averageElevation.getValue(y))}_authenticate(){h.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,y=>{if(y&&(y.message===h.AUTH_ERR_MSG||y.status===401)){const c=this.painter.context.gl;h.storeAuthState(c,!1),this._logoControl instanceof Ec&&this._logoControl._updateLogo(),c&&c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT|c.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new h.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),h.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming())}_calculateSpeedIndex(){const y=this.painter.canvasCopy(),c=this.painter.getCanvasCopiesAndTimestamps();c.timeStamps.push(performance.now());const g=this.painter.context.gl,w=g.createFramebuffer();function I(k){g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,k,0);const P=new Uint8Array(g.drawingBufferWidth*g.drawingBufferHeight*4);return g.readPixels(0,0,g.drawingBufferWidth,g.drawingBufferHeight,g.RGBA,g.UNSIGNED_BYTE,P),P}return g.bindFramebuffer(g.FRAMEBUFFER,w),this._canvasPixelComparison(I(y),c.canvasCopies.map(I),c.timeStamps)}_canvasPixelComparison(y,c,g){let w=g[1]-g[0];const I=y.length/4;for(let k=0;k<c.length;k++){const P=c[k];let z=0;for(let U=0;U<P.length;U+=4)P[U]===y[U]&&P[U+1]===y[U+1]&&P[U+2]===y[U+2]&&P[U+3]===y[U+3]&&(z+=1);w+=(g[k+2]-g[k+1])*(1-z/I)}return w}remove(){this._hash&&this._hash.remove();for(const c of this._controls)c.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),h.window!==void 0&&(h.window.removeEventListener("resize",this._onWindowResize,!1),h.window.removeEventListener("orientationchange",this._onWindowResize,!1),h.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),h.window.removeEventListener("online",this._onWindowOnline,!1));const y=this.painter.context.gl.getExtension("WEBGL_lose_context");y&&y.loseContext(),as(this._canvasContainer),as(this._controlContainer),as(this._missingCSSCanary),this._container.classList.remove("mapboxgl-map"),h.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new h.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(y){this._renderNextFrame=this._renderNextFrame||y,this.style&&!this._frame&&(this._frame=h.exported.frame(c=>{const g=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,g&&this._render(c)}))}_preloadTiles(y){const c=this.style?Object.values(this.style._sourceCaches):[];return h.asyncAll(c,(g,w)=>g._preloadTiles(y,w),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(y){this._trackResize&&this.resize({originalEvent:y})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(y){this._showTileBoundaries!==y&&(this._showTileBoundaries=y,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(y){this._showTerrainWireframe!==y&&(this._showTerrainWireframe=y,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(y){this._speedIndexTiming!==y&&(this._speedIndexTiming=y,this._update())}get showPadding(){return!!this._showPadding}set showPadding(y){this._showPadding!==y&&(this._showPadding=y,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(y){this._showCollisionBoxes!==y&&(this._showCollisionBoxes=y,y?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(y){this._showOverdrawInspector!==y&&(this._showOverdrawInspector=y,this._update())}get repaint(){return!!this._repaint}set repaint(y){this._repaint!==y&&(this._repaint=y,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(y){this._vertices=y,this._update()}_setCacheLimits(y,c){h.setCacheLimits(y,c)}get version(){return h.version}},NavigationControl:class{constructor(y){this.options=h.extend({},Ja,y),this._container=N("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",c=>c.preventDefault()),this.options.showZoom&&(h.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",c=>{this._map&&this._map.zoomIn({},{originalEvent:c})}),N("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",c=>{this._map&&this._map.zoomOut({},{originalEvent:c})}),N("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(h.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",c=>{const g=this._map;g&&(this.options.visualizePitch?g.resetNorthPitch({},{originalEvent:c}):g.resetNorth({},{originalEvent:c}))}),this._compassIcon=N("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const y=this._map;if(!y)return;const c=y.getZoom(),g=c===y.getMaxZoom(),w=c===y.getMinZoom();this._zoomInButton.disabled=g,this._zoomOutButton.disabled=w,this._zoomInButton.setAttribute("aria-disabled",g.toString()),this._zoomOutButton.setAttribute("aria-disabled",w.toString())}_rotateCompassArrow(){const y=this._map;if(!y)return;const c=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(y.transform.pitch*(Math.PI/180)),.5)}) rotateX(${y.transform.pitch}deg) rotateZ(${y.transform.angle*(180/Math.PI)}deg)`:`rotate(${y.transform.angle*(180/Math.PI)}deg)`;y._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=c)})}onAdd(y){return this._map=y,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),y.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&y.on("pitch",this._rotateCompassArrow),y.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Qa(y,this._compass,this.options.visualizePitch)),this._container}onRemove(){const y=this._map;y&&(this._container.remove(),this.options.showZoom&&y.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&y.off("pitch",this._rotateCompassArrow),y.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(y,c){const g=N("button",y,this._container);return g.type="button",g.addEventListener("click",c),g}_setButtonTitle(y,c){if(!this._map)return;const g=this._map._getUIString(`NavigationControl.${c}`);y.setAttribute("aria-label",g),y.firstElementChild&&y.firstElementChild.setAttribute("title",g)}},GeolocateControl:class extends h.Evented{constructor(y){super(),this.options=h.extend({},Ir,y),h.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=ja(this._updateMarkerRotation,20)}onAdd(y){var c;return this._map=y,this._container=N("div","mapboxgl-ctrl mapboxgl-ctrl-group"),c=this._setupUI,$r!==void 0?c($r):h.window.navigator.permissions!==void 0?h.window.navigator.permissions.query({name:"geolocation"}).then(g=>{$r=g.state!=="denied",c($r)}):($r=!!h.window.navigator.geolocation,c($r)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(h.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,ls=0,eo=!1}_isOutOfMapMaxBounds(y){const c=this._map.getMaxBounds(),g=y.coords;return!!c&&(g.longitude<c.getWest()||g.longitude>c.getEast()||g.latitude<c.getSouth()||g.latitude>c.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(y){if(this._map){if(this._isOutOfMapMaxBounds(y))return this._setErrorState(),this.fire(new h.Event("outofmaxbounds",y)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=y,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(y),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(y),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new h.Event("geolocate",y)),this._finish()}}_updateCamera(y){const c=new h.LngLat(y.coords.longitude,y.coords.latitude),g=y.coords.accuracy,w=this._map.getBearing(),I=h.extend({bearing:w},this.options.fitBoundsOptions);this._map.fitBounds(c.toBounds(g),I,{geolocateSource:!0})}_updateMarker(y){if(y){const c=new h.LngLat(y.coords.longitude,y.coords.latitude);this._accuracyCircleMarker.setLngLat(c).addTo(this._map),this._userLocationDotMarker.setLngLat(c).addTo(this._map),this._accuracy=y.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const y=this._map._containerHeight/2,c=this._map.unproject([0,y]),g=this._map.unproject([100,y]),w=c.distanceTo(g)/100,I=Math.ceil(2*this._accuracy/w);this._circleElement.style.width=`${I}px`,this._circleElement.style.height=`${I}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(y){if(this._map){if(this.options.trackUserLocation)if(y.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const c=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",c),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",c),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(y.code===3&&eo)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new h.Event("error",y)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(y){if(this._container.addEventListener("contextmenu",c=>c.preventDefault()),this._geolocateButton=N("button","mapboxgl-ctrl-geolocate",this._container),N("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",y===!1){h.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const c=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",c),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",c)}else{const c=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",c),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",c)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=N("div","mapboxgl-user-location"),this._dotElement.appendChild(N("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(N("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Hs({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=N("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Hs({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",c=>{c.geolocateSource||this._watchState!=="ACTIVE_LOCK"||c.originalEvent&&c.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new h.Event("trackuserlocationend")))})}_onDeviceOrientation(y){this._userLocationDotMarker&&(y.webkitCompassHeading?this._heading=y.webkitCompassHeading:y.absolute===!0&&(this._heading=-1*y.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return h.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new h.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":ls--,eo=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new h.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new h.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let y;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),ls++,ls>1?(y={maximumAge:6e5,timeout:0},eo=!0):(y=this.options.positionOptions,eo=!1),this._geolocationWatchID=h.window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,y),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else h.window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const y=()=>{h.window.addEventListener("ondeviceorientationabsolute"in h.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};h.window.DeviceMotionEvent!==void 0&&typeof h.window.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(c=>{c==="granted"&&y()}).catch(console.error):y()}_clearWatch(){h.window.navigator.geolocation.clearWatch(this._geolocationWatchID),h.window.removeEventListener("deviceorientation",this._onDeviceOrientation),h.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Xs,ScaleControl:class{constructor(y){this.options=h.extend({},el,y),h.bindAll(["_onMove","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_onMove(){Ks(this._map,this._container,this.options)}onAdd(y){return this._map=y,this._container=N("div","mapboxgl-ctrl mapboxgl-ctrl-scale",y.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._onMove),this._map=void 0}setUnit(y){this.options.unit=y,Ks(this._map,this._container,this.options)}},FullscreenControl:class{constructor(y){this._fullscreen=!1,y&&y.container&&(y.container instanceof h.window.HTMLElement?this._container=y.container:h.warnOnce("Full screen control 'container' must be a DOM element.")),h.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in h.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in h.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(y){return this._map=y,this._container||(this._container=this._map.getContainer()),this._controlContainer=N("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",h.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,h.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!h.window.document.fullscreenEnabled&&!h.window.document.webkitFullscreenEnabled)}_setupUI(){const y=this._fullscreenButton=N("button","mapboxgl-ctrl-fullscreen",this._controlContainer);N("span","mapboxgl-ctrl-icon",y).setAttribute("aria-hidden","true"),y.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),h.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const y=this._getTitle();this._fullscreenButton.setAttribute("aria-label",y),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",y)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(h.window.document.fullscreenElement||h.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?h.window.document.exitFullscreen?h.window.document.exitFullscreen():h.window.document.webkitCancelFullScreen&&h.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends h.Evented{constructor(y){super(),this.options=h.extend(Object.create(Wr),y),h.bindAll(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(y&&y.className?y.className.trim().split(/\s+/):[])}addTo(y){return this._map&&this.remove(),this._map=y,this.options.closeOnClick&&y.on("preclick",this._onClose),this.options.closeOnMove&&y.on("move",this._onClose),y.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(y.on("mousemove",this._onMouseEvent),y.on("mouseup",this._onMouseEvent),y._canvasContainer.classList.add("mapboxgl-track-pointer")):y.on("move",this._update),this.fire(new h.Event("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const y=this._map;return y&&(y.off("move",this._update),y.off("move",this._onClose),y.off("preclick",this._onClose),y.off("click",this._onClose),y.off("remove",this.remove),y.off("mousemove",this._onMouseEvent),y.off("mouseup",this._onMouseEvent),y.off("drag",this._onMouseEvent),this._map=void 0),this.fire(new h.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(y){this._lngLat=h.LngLat.convert(y),this._pos=null,this._trackPointer=!1,this._update();const c=this._map;return c&&(c.on("move",this._update),c.off("mousemove",this._onMouseEvent),c._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const y=this._map;return y&&(y.off("move",this._update),y.on("mousemove",this._onMouseEvent),y.on("drag",this._onMouseEvent),y._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(y){return this.setDOMContent(h.window.document.createTextNode(y))}setHTML(y){const c=h.window.document.createDocumentFragment(),g=h.window.document.createElement("body");let w;for(g.innerHTML=y;w=g.firstChild,w;)c.appendChild(w);return this.setDOMContent(c)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(y){return this.options.maxWidth=y,this._update(),this}setDOMContent(y){let c=this._content;if(c)for(;c.hasChildNodes();)c.firstChild&&c.removeChild(c.firstChild);else c=this._content=N("div","mapboxgl-popup-content",this._container||void 0);if(c.appendChild(y),this.options.closeButton){const g=this._closeButton=N("button","mapboxgl-popup-close-button",c);g.type="button",g.setAttribute("aria-label","Close popup"),g.setAttribute("aria-hidden","true"),g.innerHTML="&#215;",g.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(y){return this._classList.add(y),this._updateClassList(),this}removeClassName(y){return this._classList.delete(y),this._updateClassList(),this}setOffset(y){return this.options.offset=y,this._update(),this}toggleClassName(y){let c;return this._classList.delete(y)?c=!1:(this._classList.add(y),c=!0),this._updateClassList(),c}_onMouseEvent(y){this._update(y.point)}_getAnchor(y){if(this.options.anchor)return this.options.anchor;const c=this._map,g=this._container,w=this._pos;if(!c||!g||!w)return"bottom";const I=g.offsetWidth,k=g.offsetHeight,P=w.x<I/2,z=w.x>c.transform.width-I/2;if(w.y+y<k)return P?"top-left":z?"top-right":"top";if(w.y>c.transform.height-k){if(P)return"bottom-left";if(z)return"bottom-right"}return P?"left":z?"right":"bottom"}_updateClassList(){const y=this._container;if(!y)return;const c=[...this._classList];c.push("mapboxgl-popup"),this._anchor&&c.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&c.push("mapboxgl-popup-track-pointer"),y.className=c.join(" ")}_update(y){const c=this._map,g=this._content;if(!c||!this._lngLat&&!this._trackPointer||!g)return;let w=this._container;if(w||(w=this._container=N("div","mapboxgl-popup",c.getContainer()),this._tip=N("div","mapboxgl-popup-tip",w),w.appendChild(g)),this.options.maxWidth&&w.style.maxWidth!==this.options.maxWidth&&(w.style.maxWidth=this.options.maxWidth),c.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Ys(this._lngLat,this._pos,c.transform)),!this._trackPointer||y){const I=this._pos=this._trackPointer&&y?y:c.project(this._lngLat),k=cs(this.options.offset),P=this._anchor=this._getAnchor(k.y),z=cs(this.options.offset,P),U=I.add(z).round();c._requestDomTask(()=>{this._container&&P&&(this._container.style.transform=`${Ws[P]} translate(${U.x}px,${U.y}px)`)})}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const y=this._container.querySelector(Vi);y&&y.focus()}_onClose(){this.remove()}_setOpacity(y){this._content&&(this._content.style.opacity=y),this._tip&&(this._tip.style.opacity=y)}},Marker:Hs,Style:Ar,LngLat:h.LngLat,LngLatBounds:h.LngLatBounds,Point:h.pointGeometry,MercatorCoordinate:h.MercatorCoordinate,FreeCameraOptions:Jo,Evented:h.Evented,config:h.config,prewarm:function(){Yt().acquire(Pt)},clearPrewarmedResources:function(){const y=Bt;y&&(y.isPreloaded()&&y.numActive()===1?(y.release(Pt),Bt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return h.config.ACCESS_TOKEN},set accessToken(y){h.config.ACCESS_TOKEN=y},get baseApiUrl(){return h.config.API_URL},set baseApiUrl(y){h.config.API_URL=y},get workerCount(){return bt.workerCount},set workerCount(y){bt.workerCount=y},get maxParallelImageRequests(){return h.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(y){h.config.MAX_PARALLEL_IMAGE_REQUESTS=y},clearStorage(y){h.clearTileCache(y)},workerUrl:"",workerClass:null,setNow:h.exported.setNow,restoreNow:h.exported.restoreNow};return Eo});var b=f;return b})})(mapboxGl);var mapboxgl=mapboxGl.exports,d2r=Math.PI/180,r2d=180/Math.PI;function tileToBBOX(n){var t=tile2lon(n[0]+1,n[2]),s=tile2lon(n[0],n[2]),l=tile2lat(n[1]+1,n[2]),f=tile2lat(n[1],n[2]);return[s,l,t,f]}function tileToGeoJSON(n){var t=tileToBBOX(n),s={type:"Polygon",coordinates:[[[t[0],t[3]],[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]]]]};return s}function tile2lon(n,t){return n/Math.pow(2,t)*360-180}function tile2lat(n,t){var s=Math.PI-2*Math.PI*n/Math.pow(2,t);return r2d*Math.atan(.5*(Math.exp(s)-Math.exp(-s)))}function pointToTile(n,t,s){var l=pointToTileFraction(n,t,s);return l[0]=Math.floor(l[0]),l[1]=Math.floor(l[1]),l}function getChildren(n){return[[n[0]*2,n[1]*2,n[2]+1],[n[0]*2+1,n[1]*2,n[2]+1],[n[0]*2+1,n[1]*2+1,n[2]+1],[n[0]*2,n[1]*2+1,n[2]+1]]}function getParent(n){return[n[0]>>1,n[1]>>1,n[2]-1]}function getSiblings(n){return getChildren(getParent(n))}function hasSiblings(n,t){for(var s=getSiblings(n),l=0;l<s.length;l++)if(!hasTile(t,s[l]))return!1;return!0}function hasTile(n,t){for(var s=0;s<n.length;s++)if(tilesEqual(n[s],t))return!0;return!1}function tilesEqual(n,t){return n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]}function tileToQuadkey(n){for(var t="",s=n[2];s>0;s--){var l=0,f=1<<s-1;(n[0]&f)!==0&&l++,(n[1]&f)!==0&&(l+=2),t+=l.toString()}return t}function quadkeyToTile(n){for(var t=0,s=0,l=n.length,f=l;f>0;f--){var m=1<<f-1,b=+n[l-f];b===1&&(t|=m),b===2&&(s|=m),b===3&&(t|=m,s|=m)}return[t,s,l]}function bboxToTile(n){var t=pointToTile(n[0],n[1],32),s=pointToTile(n[2],n[3],32),l=[t[0],t[1],s[0],s[1]],f=getBboxZoom(l);if(f===0)return[0,0,0];var m=l[0]>>>32-f,b=l[1]>>>32-f;return[m,b,f]}function getBboxZoom(n){for(var t=28,s=0;s<t;s++){var l=1<<32-(s+1);if((n[0]&l)!==(n[2]&l)||(n[1]&l)!==(n[3]&l))return s}return t}function pointToTileFraction(n,t,s){var l=Math.sin(t*d2r),f=Math.pow(2,s),m=f*(n/360+.5),b=f*(.5-.25*Math.log((1+l)/(1-l))/Math.PI);return m=m%f,m<0&&(m=m+f),[m,b,s]}var tilebelt={tileToGeoJSON,tileToBBOX,getChildren,getParent,getSiblings,hasTile,hasSiblings,tilesEqual,tileToQuadkey,quadkeyToTile,pointToTile,bboxToTile,pointToTileFraction};function feature(n,t,s){s===void 0&&(s={});var l={type:"Feature"};return(s.id===0||s.id)&&(l.id=s.id),s.bbox&&(l.bbox=s.bbox),l.properties=t||{},l.geometry=n,l}function polygon(n,t,s){s===void 0&&(s={});for(var l=0,f=n;l<f.length;l++){var m=f[l];if(m.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var b=0;b<m[m.length-1].length;b++)if(m[m.length-1][b]!==m[0][b])throw new Error("First and last Position are not equivalent.")}var h={type:"Polygon",coordinates:n};return feature(h,t,s)}function bboxPolygon(n,t){t===void 0&&(t={});var s=Number(n[0]),l=Number(n[1]),f=Number(n[2]),m=Number(n[3]);if(n.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var b=[s,l],h=[s,m],S=[f,m],M=[f,l];return polygon([[b,M,S,h,b]],t.properties,{bbox:n,id:t.id})}const bitMethods={getBit(n){return this.data[getSlot(n)]&1<<getShift(n)?1:0},setBit(n){this.data[getSlot(n)]|=1<<getShift(n)},clearBit(n){this.data[getSlot(n)]&=~(1<<getShift(n))},toggleBit(n){this.data[getSlot(n)]^=1<<getShift(n)},getBitXY(n,t){return n>=this.width||t>=this.height?0:this.getBit(t*this.width+n)},setBitXY(n,t){this.setBit(t*this.width+n)},clearBitXY(n,t){this.clearBit(t*this.width+n)},toggleBitXY(n,t){this.toggleBit(t*this.width+n)}};function getSlot(n){return n>>3}function getShift(n){return 7-(n&7)}function setBitMethods(n){for(const t in bitMethods)n.prototype[t]=bitMethods[t]}function checkProcessable(n,t={}){let{bitDepth:s,alpha:l,colorModel:f,components:m,channels:b}=t;if(typeof n!="string"||n.length===0)throw new TypeError("processName must be a string");if(s&&(Array.isArray(s)||(s=[s]),!s.includes(this.bitDepth)))throw new TypeError(`The process: ${n} can only be applied if bit depth is in: ${s}`);if(l&&(Array.isArray(l)||(l=[l]),!l.includes(this.alpha)))throw new TypeError(`The process: ${n} can only be applied if alpha is in: ${l}`);if(f&&(Array.isArray(f)||(f=[f]),!f.includes(this.colorModel)))throw new TypeError(`The process: ${n} can only be applied if color model is in: ${f}`);if(m&&(Array.isArray(m)||(m=[m]),!m.includes(this.components))){let h=`The process: ${n} can only be applied if the number of components is in: ${m}`;throw m.length===1&&m[0]===1?new TypeError(`${h}.\rYou should transform your image using "image.grey()" before applying the algorithm.`):new TypeError(h)}if(b&&(Array.isArray(b)||(b=[b]),!b.includes(this.channels)))throw new TypeError(`The process: ${n} can only be applied if the number of channels is in: ${b}`)}function createBlob(n,t){n=n||[],t=t||{},typeof t=="string"&&(t={type:t});try{return new Blob(n,t)}catch(m){if(m.name!=="TypeError")throw m;for(var s=typeof BlobBuilder!="undefined"?BlobBuilder:typeof MSBlobBuilder!="undefined"?MSBlobBuilder:typeof MozBlobBuilder!="undefined"?MozBlobBuilder:WebKitBlobBuilder,l=new s,f=0;f<n.length;f+=1)l.append(n[f]);return l.getBlob(t.type)}}function dataURLToBlob(n){var t=n.match(/data:([^;]+)/)[1],s=n.replace(/^[^,]+,/,""),l=binaryStringToArrayBuffer(atob(s));return createBlob([l],{type:t})}function canvasToBlob(n,t,s){return typeof n.toBlob=="function"?new Promise(function(l){n.toBlob(l,t,s)}):Promise.resolve(dataURLToBlob(n.toDataURL(t,s)))}function binaryStringToArrayBuffer(n){for(var t=n.length,s=new ArrayBuffer(t),l=new Uint8Array(s),f=-1;++f<t;)l[f]=n.charCodeAt(f);return s}var utf8$1={exports:{}};/*! https://mths.be/utf8js v2.1.2 by @mathias */(function(n,t){(function(s){var l=t,f=n&&n.exports==l&&n,m=typeof commonjsGlobal=="object"&&commonjsGlobal;(m.global===m||m.window===m)&&(s=m);var b=String.fromCharCode;function h(be){for(var ne=[],ve=0,te=be.length,he,Ie;ve<te;)he=be.charCodeAt(ve++),he>=55296&&he<=56319&&ve<te?(Ie=be.charCodeAt(ve++),(Ie&64512)==56320?ne.push(((he&1023)<<10)+(Ie&1023)+65536):(ne.push(he),ve--)):ne.push(he);return ne}function S(be){for(var ne=be.length,ve=-1,te,he="";++ve<ne;)te=be[ve],te>65535&&(te-=65536,he+=b(te>>>10&1023|55296),te=56320|te&1023),he+=b(te);return he}function M(be){if(be>=55296&&be<=57343)throw Error("Lone surrogate U+"+be.toString(16).toUpperCase()+" is not a scalar value")}function C(be,ne){return b(be>>ne&63|128)}function L(be){if((be&4294967168)==0)return b(be);var ne="";return(be&4294965248)==0?ne=b(be>>6&31|192):(be&4294901760)==0?(M(be),ne=b(be>>12&15|224),ne+=C(be,6)):(be&4292870144)==0&&(ne=b(be>>18&7|240),ne+=C(be,12),ne+=C(be,6)),ne+=b(be&63|128),ne}function N(be){for(var ne=h(be),ve=ne.length,te=-1,he,Ie="";++te<ve;)he=ne[te],Ie+=L(he);return Ie}function F(){if(X>=K)throw Error("Invalid byte index");var be=H[X]&255;if(X++,(be&192)==128)return be&63;throw Error("Invalid continuation byte")}function G(){var be,ne,ve,te,he;if(X>K)throw Error("Invalid byte index");if(X==K)return!1;if(be=H[X]&255,X++,(be&128)==0)return be;if((be&224)==192){if(ne=F(),he=(be&31)<<6|ne,he>=128)return he;throw Error("Invalid continuation byte")}if((be&240)==224){if(ne=F(),ve=F(),he=(be&15)<<12|ne<<6|ve,he>=2048)return M(he),he;throw Error("Invalid continuation byte")}if((be&248)==240&&(ne=F(),ve=F(),te=F(),he=(be&7)<<18|ne<<12|ve<<6|te,he>=65536&&he<=1114111))return he;throw Error("Invalid UTF-8 detected")}var H,K,X;function de(be){H=h(be),K=H.length,X=0;for(var ne=[],ve;(ve=G())!==!1;)ne.push(ve);return S(ne)}var Q={version:"2.1.2",encode:N,decode:de};if(l&&!l.nodeType)if(f)f.exports=Q;else{var ie={},ce=ie.hasOwnProperty;for(var ge in Q)ce.call(Q,ge)&&(l[ge]=Q[ge])}else s.utf8=Q})(commonjsGlobal)})(utf8$1,utf8$1.exports);const utf8=utf8$1.exports,defaultByteLength$3=1024*8,charArray$1=[];class IOBuffer$6{constructor(t,s){s=s||{};var l=!1;t===void 0&&(t=defaultByteLength$3),typeof t=="number"?t=new ArrayBuffer(t):(l=!0,this._lastWrittenByte=t.byteLength);const f=s.offset?s.offset>>>0:0;let m=t.byteLength-f,b=f;t.buffer&&(t.byteLength!==t.buffer.byteLength&&(b=t.byteOffset+f),t=t.buffer),l?this._lastWrittenByte=m:this._lastWrittenByte=0,this.buffer=t,this.length=m,this.byteLength=m,this.byteOffset=b,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,b,m),this._mark=0,this._marks=[]}available(t){return t===void 0&&(t=1),this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t){return t===void 0&&(t=1),this.offset+=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(t===void 0)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t){if(t===void 0&&(t=1),!this.available(t)){const l=(this.offset+t)*2,f=new Uint8Array(l);f.set(new Uint8Array(this.buffer)),this.buffer=f.buffer,this.length=this.byteLength=l,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t){t===void 0&&(t=1);for(var s=new Uint8Array(t),l=0;l<t;l++)s[l]=this.readByte();return s}readInt16(){var t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){var t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){var t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){var t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){var t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){var t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t){t===void 0&&(t=1),charArray$1.length=t;for(var s=0;s<t;s++)charArray$1[s]=this.readChar();return charArray$1.join("")}readUtf8(t){t===void 0&&(t=1);const s=this.readChars(t);return utf8.decode(s)}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(var s=0;s<t.length;s++)this._data.setUint8(this.offset++,t[s]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(var s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));return this}writeUtf8(t){const s=utf8.encode(t);return this.writeChars(s)}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}getBuffer(){return typeof Buffer!="undefined"?Buffer.from(this.toArray()):this.toArray()}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}}var IOBuffer_1$1=IOBuffer$6,constants$7={BITMAPV5HEADER:{LogicalColorSpace:{LCS_CALIBRATED_RGB:0,LCS_sRGB:1934772034,LCS_WINDOWS_COLOR_SPACE:1466527264},Compression:{BI_RGB:0,BI_RLE8:1,BI_RLE4:2,BI_BITFIELDS:3,BI_JPEG:4,BI_PNG:5,BI_CMYK:11,BI_CMYKRLE8:12,BI_CMYKRLE4:13},GamutMappingIntent:{LCS_GM_ABS_COLORIMETRIC:8,LCS_GM_BUSINESS:1,LCS_GM_GRAPHICS:2,LCS_GM_IMAGES:4}}};const IOBuffer$5=IOBuffer_1$1,constants$6=constants$7,tableLeft=[];for(var i$5=0;i$5<=8;i$5++)tableLeft.push(255<<i$5);var encode$5=function(n){if(n.bitDepth!==1)throw new Error("Only bitDepth of 1 is supported");if(!n.height||!n.width)throw new Error("ImageData width and height are required");if(n.components!==1)throw new Error("Only 1 component is supported");if(n.channels!==1)throw new Error("Only 1 channel is supported");var t=new IOBuffer$5;t.skip(14),writeBitmapV5Header(t,n),writeColorTable(t,n);const s=t.offset;return writePixelArray(t,n),t.rewind(),writeBitmapFileHeader(t,s),t.getBuffer()};function writePixelArray(n,t){const s=Math.floor((t.bitDepth*t.width+31)/32)*4,l=Math.ceil(t.bitDepth*t.width/8),f=s-l,m=t.bitDepth*t.width%8,b=m===0?0:8-m,h=s*t.height;var S,M;const C=new IOBuffer$5(t.data);let L=0,N=0,F=8;n.mark(),M=C.readUint8();for(var G=t.height-1;G>=0;G--){const K=G===0;n.reset(),n.skip(G*s);for(var H=0;H<l;H++){const X=H===l-1;N<=b&&X?(n.writeByte(M<<N),(b===0||b===N)&&!K&&(S=M,M=C.readByte())):N===0?(S=M,M=C.readUint8(),n.writeByte(S)):(S=M,M=C.readUint8(),n.writeByte(S<<N&tableLeft[N]|M>>F)),X?(L+=m||8,n.skip(f),N=L%8,F=8-N):L+=8}}s>l&&(n.reset(),n.skip(h-1),n.writeUint8(0))}function writeColorTable(n,t){t.bitDepth>8||n.writeUint32(0).writeUint32(16777215)}function writeBitmapFileHeader(n,t){n.writeChars("BM"),n.writeInt32(n._lastWrittenByte),n.writeUint16(0),n.writeUint16(0),n.writeUint32(t)}function writeBitmapV5Header(n,t){n.writeUint32(124).writeInt32(t.width).writeInt32(t.height).writeUint16(1).writeUint16(t.bitDepth).writeUint32(constants$6.BITMAPV5HEADER.Compression.BI_RGB).writeUint32(t.width*t.height*t.bitDepth).writeInt32(0).writeInt32(0).writeUint32(Math.pow(2,t.bitDepth)).writeUint32(Math.pow(2,t.bitDepth)).writeUint32(4278190080).writeUint32(16711680).writeUint32(65280).writeUint32(255).writeUint32(constants$6.BITMAPV5HEADER.LogicalColorSpace.LCS_sRGB).skip(36).skip(12).writeUint32(constants$6.BITMAPV5HEADER.GamutMappingIntent.LCS_GM_IMAGES).skip(12)}var encode$4=encode$5;(function(n){if(n.TextEncoder&&n.TextDecoder)return!1;function t(l="utf-8"){if(l!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${l}') is invalid.`)}Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),t.prototype.encode=function(l,f={stream:!1}){if(f.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let m=0;const b=l.length;let h=0,S=Math.max(32,b+(b>>1)+7),M=new Uint8Array(S>>3<<3);for(;m<b;){let C=l.charCodeAt(m++);if(C>=55296&&C<=56319){if(m<b){const L=l.charCodeAt(m);(L&64512)===56320&&(++m,C=((C&1023)<<10)+(L&1023)+65536)}if(C>=55296&&C<=56319)continue}if(h+4>M.length){S+=8,S*=1+m/l.length*2,S=S>>3<<3;const L=new Uint8Array(S);L.set(M),M=L}if((C&4294967168)===0){M[h++]=C;continue}else if((C&4294965248)===0)M[h++]=C>>6&31|192;else if((C&4294901760)===0)M[h++]=C>>12&15|224,M[h++]=C>>6&63|128;else if((C&4292870144)===0)M[h++]=C>>18&7|240,M[h++]=C>>12&63|128,M[h++]=C>>6&63|128;else continue;M[h++]=C&63|128}return M.slice(0,h)};function s(l="utf-8",f={fatal:!1}){if(l!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${l}') is invalid.`);if(f.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(s.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(s.prototype,"fatal",{value:!1}),Object.defineProperty(s.prototype,"ignoreBOM",{value:!1}),s.prototype.decode=function(l,f={stream:!1}){if(f.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const m=new Uint8Array(l);let b=0;const h=m.length,S=[];for(;b<h;){const M=m[b++];if(M===0)break;if((M&128)===0)S.push(M);else if((M&224)===192){const C=m[b++]&63;S.push((M&31)<<6|C)}else if((M&240)===224){const C=m[b++]&63,L=m[b++]&63;S.push((M&31)<<12|C<<6|L)}else if((M&248)===240){const C=m[b++]&63,L=m[b++]&63,N=m[b++]&63;let F=(M&7)<<18|C<<12|L<<6|N;F>65535&&(F-=65536,S.push(F>>>10&1023|55296),F=56320|F&1023),S.push(F)}}return String.fromCharCode.apply(null,S)},n.TextEncoder=t,n.TextDecoder=s})(typeof window!="undefined"?window:typeof self!="undefined"?self:globalThis);const decoder$2=new TextDecoder("utf-8");function decode$6(n){return decoder$2.decode(n)}const encoder$2=new TextEncoder;function encode$3(n){return encoder$2.encode(n)}const defaultByteLength$2=1024*8;class IOBuffer$4{constructor(t=defaultByteLength$2,s={}){let l=!1;typeof t=="number"?t=new ArrayBuffer(t):(l=!0,this.lastWrittenByte=t.byteLength);const f=s.offset?s.offset>>>0:0,m=t.byteLength-f;let b=f;(ArrayBuffer.isView(t)||t instanceof IOBuffer$4)&&(t.byteLength!==t.buffer.byteLength&&(b=t.byteOffset+f),t=t.buffer),l?this.lastWrittenByte=m:this.lastWrittenByte=0,this.buffer=t,this.length=m,this.byteLength=m,this.byteOffset=b,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,b,m),this._mark=0,this._marks=[]}available(t=1){return this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t=1){return this.offset+=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(t===void 0)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t=1){if(!this.available(t)){const l=(this.offset+t)*2,f=new Uint8Array(l);f.set(new Uint8Array(this.buffer)),this.buffer=f.buffer,this.length=this.byteLength=l,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t=1){const s=new Uint8Array(t);for(let l=0;l<t;l++)s[l]=this.readByte();return s}readInt16(){const t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){const t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){const t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){const t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){const t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){const t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readBigInt64(){const t=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,t}readBigUint64(){const t=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t=1){let s="";for(let l=0;l<t;l++)s+=this.readChar();return s}readUtf8(t=1){return decode$6(this.readBytes(t))}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(let s=0;s<t.length;s++)this._data.setUint8(this.offset++,t[s]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(t){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(t){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(let s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));return this}writeUtf8(t){return this.writeBytes(encode$3(t))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}/*! pako 2.0.4 https://github.com/nodeca/pako @license (MIT AND Zlib) */const Z_FIXED$1=4,Z_BINARY=0,Z_TEXT=1,Z_UNKNOWN$1=2;function zero$1(n){let t=n.length;for(;--t>=0;)n[t]=0}const STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,MIN_MATCH$1=3,MAX_MATCH$1=258,LENGTH_CODES$1=29,LITERALS$1=256,L_CODES$1=LITERALS$1+1+LENGTH_CODES$1,D_CODES$1=30,BL_CODES$1=19,HEAP_SIZE$1=2*L_CODES$1+1,MAX_BITS$1=15,Buf_size=16,MAX_BL_BITS=7,END_BLOCK=256,REP_3_6=16,REPZ_3_10=17,REPZ_11_138=18,extra_lbits=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),extra_dbits=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),extra_blbits=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),bl_order=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),DIST_CODE_LEN=512,static_ltree=new Array((L_CODES$1+2)*2);zero$1(static_ltree);const static_dtree=new Array(D_CODES$1*2);zero$1(static_dtree);const _dist_code=new Array(DIST_CODE_LEN);zero$1(_dist_code);const _length_code=new Array(MAX_MATCH$1-MIN_MATCH$1+1);zero$1(_length_code);const base_length=new Array(LENGTH_CODES$1);zero$1(base_length);const base_dist=new Array(D_CODES$1);zero$1(base_dist);function StaticTreeDesc(n,t,s,l,f){this.static_tree=n,this.extra_bits=t,this.extra_base=s,this.elems=l,this.max_length=f,this.has_stree=n&&n.length}let static_l_desc,static_d_desc,static_bl_desc;function TreeDesc(n,t){this.dyn_tree=n,this.max_code=0,this.stat_desc=t}const d_code=n=>n<256?_dist_code[n]:_dist_code[256+(n>>>7)],put_short=(n,t)=>{n.pending_buf[n.pending++]=t&255,n.pending_buf[n.pending++]=t>>>8&255},send_bits=(n,t,s)=>{n.bi_valid>Buf_size-s?(n.bi_buf|=t<<n.bi_valid&65535,put_short(n,n.bi_buf),n.bi_buf=t>>Buf_size-n.bi_valid,n.bi_valid+=s-Buf_size):(n.bi_buf|=t<<n.bi_valid&65535,n.bi_valid+=s)},send_code=(n,t,s)=>{send_bits(n,s[t*2],s[t*2+1])},bi_reverse=(n,t)=>{let s=0;do s|=n&1,n>>>=1,s<<=1;while(--t>0);return s>>>1},bi_flush=n=>{n.bi_valid===16?(put_short(n,n.bi_buf),n.bi_buf=0,n.bi_valid=0):n.bi_valid>=8&&(n.pending_buf[n.pending++]=n.bi_buf&255,n.bi_buf>>=8,n.bi_valid-=8)},gen_bitlen=(n,t)=>{const s=t.dyn_tree,l=t.max_code,f=t.stat_desc.static_tree,m=t.stat_desc.has_stree,b=t.stat_desc.extra_bits,h=t.stat_desc.extra_base,S=t.stat_desc.max_length;let M,C,L,N,F,G,H=0;for(N=0;N<=MAX_BITS$1;N++)n.bl_count[N]=0;for(s[n.heap[n.heap_max]*2+1]=0,M=n.heap_max+1;M<HEAP_SIZE$1;M++)C=n.heap[M],N=s[s[C*2+1]*2+1]+1,N>S&&(N=S,H++),s[C*2+1]=N,!(C>l)&&(n.bl_count[N]++,F=0,C>=h&&(F=b[C-h]),G=s[C*2],n.opt_len+=G*(N+F),m&&(n.static_len+=G*(f[C*2+1]+F)));if(H!==0){do{for(N=S-1;n.bl_count[N]===0;)N--;n.bl_count[N]--,n.bl_count[N+1]+=2,n.bl_count[S]--,H-=2}while(H>0);for(N=S;N!==0;N--)for(C=n.bl_count[N];C!==0;)L=n.heap[--M],!(L>l)&&(s[L*2+1]!==N&&(n.opt_len+=(N-s[L*2+1])*s[L*2],s[L*2+1]=N),C--)}},gen_codes=(n,t,s)=>{const l=new Array(MAX_BITS$1+1);let f=0,m,b;for(m=1;m<=MAX_BITS$1;m++)l[m]=f=f+s[m-1]<<1;for(b=0;b<=t;b++){let h=n[b*2+1];h!==0&&(n[b*2]=bi_reverse(l[h]++,h))}},tr_static_init=()=>{let n,t,s,l,f;const m=new Array(MAX_BITS$1+1);for(s=0,l=0;l<LENGTH_CODES$1-1;l++)for(base_length[l]=s,n=0;n<1<<extra_lbits[l];n++)_length_code[s++]=l;for(_length_code[s-1]=l,f=0,l=0;l<16;l++)for(base_dist[l]=f,n=0;n<1<<extra_dbits[l];n++)_dist_code[f++]=l;for(f>>=7;l<D_CODES$1;l++)for(base_dist[l]=f<<7,n=0;n<1<<extra_dbits[l]-7;n++)_dist_code[256+f++]=l;for(t=0;t<=MAX_BITS$1;t++)m[t]=0;for(n=0;n<=143;)static_ltree[n*2+1]=8,n++,m[8]++;for(;n<=255;)static_ltree[n*2+1]=9,n++,m[9]++;for(;n<=279;)static_ltree[n*2+1]=7,n++,m[7]++;for(;n<=287;)static_ltree[n*2+1]=8,n++,m[8]++;for(gen_codes(static_ltree,L_CODES$1+1,m),n=0;n<D_CODES$1;n++)static_dtree[n*2+1]=5,static_dtree[n*2]=bi_reverse(n,5);static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS$1+1,L_CODES$1,MAX_BITS$1),static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES$1,MAX_BITS$1),static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES$1,MAX_BL_BITS)},init_block=n=>{let t;for(t=0;t<L_CODES$1;t++)n.dyn_ltree[t*2]=0;for(t=0;t<D_CODES$1;t++)n.dyn_dtree[t*2]=0;for(t=0;t<BL_CODES$1;t++)n.bl_tree[t*2]=0;n.dyn_ltree[END_BLOCK*2]=1,n.opt_len=n.static_len=0,n.last_lit=n.matches=0},bi_windup=n=>{n.bi_valid>8?put_short(n,n.bi_buf):n.bi_valid>0&&(n.pending_buf[n.pending++]=n.bi_buf),n.bi_buf=0,n.bi_valid=0},copy_block=(n,t,s,l)=>{bi_windup(n),l&&(put_short(n,s),put_short(n,~s)),n.pending_buf.set(n.window.subarray(t,t+s),n.pending),n.pending+=s},smaller=(n,t,s,l)=>{const f=t*2,m=s*2;return n[f]<n[m]||n[f]===n[m]&&l[t]<=l[s]},pqdownheap=(n,t,s)=>{const l=n.heap[s];let f=s<<1;for(;f<=n.heap_len&&(f<n.heap_len&&smaller(t,n.heap[f+1],n.heap[f],n.depth)&&f++,!smaller(t,l,n.heap[f],n.depth));)n.heap[s]=n.heap[f],s=f,f<<=1;n.heap[s]=l},compress_block=(n,t,s)=>{let l,f,m=0,b,h;if(n.last_lit!==0)do l=n.pending_buf[n.d_buf+m*2]<<8|n.pending_buf[n.d_buf+m*2+1],f=n.pending_buf[n.l_buf+m],m++,l===0?send_code(n,f,t):(b=_length_code[f],send_code(n,b+LITERALS$1+1,t),h=extra_lbits[b],h!==0&&(f-=base_length[b],send_bits(n,f,h)),l--,b=d_code(l),send_code(n,b,s),h=extra_dbits[b],h!==0&&(l-=base_dist[b],send_bits(n,l,h)));while(m<n.last_lit);send_code(n,END_BLOCK,t)},build_tree=(n,t)=>{const s=t.dyn_tree,l=t.stat_desc.static_tree,f=t.stat_desc.has_stree,m=t.stat_desc.elems;let b,h,S=-1,M;for(n.heap_len=0,n.heap_max=HEAP_SIZE$1,b=0;b<m;b++)s[b*2]!==0?(n.heap[++n.heap_len]=S=b,n.depth[b]=0):s[b*2+1]=0;for(;n.heap_len<2;)M=n.heap[++n.heap_len]=S<2?++S:0,s[M*2]=1,n.depth[M]=0,n.opt_len--,f&&(n.static_len-=l[M*2+1]);for(t.max_code=S,b=n.heap_len>>1;b>=1;b--)pqdownheap(n,s,b);M=m;do b=n.heap[1],n.heap[1]=n.heap[n.heap_len--],pqdownheap(n,s,1),h=n.heap[1],n.heap[--n.heap_max]=b,n.heap[--n.heap_max]=h,s[M*2]=s[b*2]+s[h*2],n.depth[M]=(n.depth[b]>=n.depth[h]?n.depth[b]:n.depth[h])+1,s[b*2+1]=s[h*2+1]=M,n.heap[1]=M++,pqdownheap(n,s,1);while(n.heap_len>=2);n.heap[--n.heap_max]=n.heap[1],gen_bitlen(n,t),gen_codes(s,S,n.bl_count)},scan_tree=(n,t,s)=>{let l,f=-1,m,b=t[0*2+1],h=0,S=7,M=4;for(b===0&&(S=138,M=3),t[(s+1)*2+1]=65535,l=0;l<=s;l++)m=b,b=t[(l+1)*2+1],!(++h<S&&m===b)&&(h<M?n.bl_tree[m*2]+=h:m!==0?(m!==f&&n.bl_tree[m*2]++,n.bl_tree[REP_3_6*2]++):h<=10?n.bl_tree[REPZ_3_10*2]++:n.bl_tree[REPZ_11_138*2]++,h=0,f=m,b===0?(S=138,M=3):m===b?(S=6,M=3):(S=7,M=4))},send_tree=(n,t,s)=>{let l,f=-1,m,b=t[0*2+1],h=0,S=7,M=4;for(b===0&&(S=138,M=3),l=0;l<=s;l++)if(m=b,b=t[(l+1)*2+1],!(++h<S&&m===b)){if(h<M)do send_code(n,m,n.bl_tree);while(--h!==0);else m!==0?(m!==f&&(send_code(n,m,n.bl_tree),h--),send_code(n,REP_3_6,n.bl_tree),send_bits(n,h-3,2)):h<=10?(send_code(n,REPZ_3_10,n.bl_tree),send_bits(n,h-3,3)):(send_code(n,REPZ_11_138,n.bl_tree),send_bits(n,h-11,7));h=0,f=m,b===0?(S=138,M=3):m===b?(S=6,M=3):(S=7,M=4)}},build_bl_tree=n=>{let t;for(scan_tree(n,n.dyn_ltree,n.l_desc.max_code),scan_tree(n,n.dyn_dtree,n.d_desc.max_code),build_tree(n,n.bl_desc),t=BL_CODES$1-1;t>=3&&n.bl_tree[bl_order[t]*2+1]===0;t--);return n.opt_len+=3*(t+1)+5+5+4,t},send_all_trees=(n,t,s,l)=>{let f;for(send_bits(n,t-257,5),send_bits(n,s-1,5),send_bits(n,l-4,4),f=0;f<l;f++)send_bits(n,n.bl_tree[bl_order[f]*2+1],3);send_tree(n,n.dyn_ltree,t-1),send_tree(n,n.dyn_dtree,s-1)},detect_data_type=n=>{let t=4093624447,s;for(s=0;s<=31;s++,t>>>=1)if(t&1&&n.dyn_ltree[s*2]!==0)return Z_BINARY;if(n.dyn_ltree[9*2]!==0||n.dyn_ltree[10*2]!==0||n.dyn_ltree[13*2]!==0)return Z_TEXT;for(s=32;s<LITERALS$1;s++)if(n.dyn_ltree[s*2]!==0)return Z_TEXT;return Z_BINARY};let static_init_done=!1;const _tr_init$1=n=>{static_init_done||(tr_static_init(),static_init_done=!0),n.l_desc=new TreeDesc(n.dyn_ltree,static_l_desc),n.d_desc=new TreeDesc(n.dyn_dtree,static_d_desc),n.bl_desc=new TreeDesc(n.bl_tree,static_bl_desc),n.bi_buf=0,n.bi_valid=0,init_block(n)},_tr_stored_block$1=(n,t,s,l)=>{send_bits(n,(STORED_BLOCK<<1)+(l?1:0),3),copy_block(n,t,s,!0)},_tr_align$1=n=>{send_bits(n,STATIC_TREES<<1,3),send_code(n,END_BLOCK,static_ltree),bi_flush(n)},_tr_flush_block$1=(n,t,s,l)=>{let f,m,b=0;n.level>0?(n.strm.data_type===Z_UNKNOWN$1&&(n.strm.data_type=detect_data_type(n)),build_tree(n,n.l_desc),build_tree(n,n.d_desc),b=build_bl_tree(n),f=n.opt_len+3+7>>>3,m=n.static_len+3+7>>>3,m<=f&&(f=m)):f=m=s+5,s+4<=f&&t!==-1?_tr_stored_block$1(n,t,s,l):n.strategy===Z_FIXED$1||m===f?(send_bits(n,(STATIC_TREES<<1)+(l?1:0),3),compress_block(n,static_ltree,static_dtree)):(send_bits(n,(DYN_TREES<<1)+(l?1:0),3),send_all_trees(n,n.l_desc.max_code+1,n.d_desc.max_code+1,b+1),compress_block(n,n.dyn_ltree,n.dyn_dtree)),init_block(n),l&&bi_windup(n)},_tr_tally$1=(n,t,s)=>(n.pending_buf[n.d_buf+n.last_lit*2]=t>>>8&255,n.pending_buf[n.d_buf+n.last_lit*2+1]=t&255,n.pending_buf[n.l_buf+n.last_lit]=s&255,n.last_lit++,t===0?n.dyn_ltree[s*2]++:(n.matches++,t--,n.dyn_ltree[(_length_code[s]+LITERALS$1+1)*2]++,n.dyn_dtree[d_code(t)*2]++),n.last_lit===n.lit_bufsize-1);var _tr_init_1=_tr_init$1,_tr_stored_block_1=_tr_stored_block$1,_tr_flush_block_1=_tr_flush_block$1,_tr_tally_1=_tr_tally$1,_tr_align_1=_tr_align$1,trees={_tr_init:_tr_init_1,_tr_stored_block:_tr_stored_block_1,_tr_flush_block:_tr_flush_block_1,_tr_tally:_tr_tally_1,_tr_align:_tr_align_1};const adler32=(n,t,s,l)=>{let f=n&65535|0,m=n>>>16&65535|0,b=0;for(;s!==0;){b=s>2e3?2e3:s,s-=b;do f=f+t[l++]|0,m=m+f|0;while(--b);f%=65521,m%=65521}return f|m<<16|0};var adler32_1=adler32;const makeTable=()=>{let n,t=[];for(var s=0;s<256;s++){n=s;for(var l=0;l<8;l++)n=n&1?3988292384^n>>>1:n>>>1;t[s]=n}return t},crcTable$1=new Uint32Array(makeTable()),crc32=(n,t,s,l)=>{const f=crcTable$1,m=l+s;n^=-1;for(let b=l;b<m;b++)n=n>>>8^f[(n^t[b])&255];return n^-1};var crc32_1=crc32,messages={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},constants$2$1={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init,_tr_stored_block,_tr_flush_block,_tr_tally,_tr_align}=trees,{Z_NO_FLUSH:Z_NO_FLUSH$2,Z_PARTIAL_FLUSH,Z_FULL_FLUSH:Z_FULL_FLUSH$1,Z_FINISH:Z_FINISH$3,Z_BLOCK:Z_BLOCK$1,Z_OK:Z_OK$3,Z_STREAM_END:Z_STREAM_END$3,Z_STREAM_ERROR:Z_STREAM_ERROR$2,Z_DATA_ERROR:Z_DATA_ERROR$2,Z_BUF_ERROR:Z_BUF_ERROR$1,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$1,Z_FILTERED,Z_HUFFMAN_ONLY,Z_RLE,Z_FIXED,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY$1,Z_UNKNOWN,Z_DEFLATED:Z_DEFLATED$2}=constants$2$1,MAX_MEM_LEVEL=9,MAX_WBITS$1=15,DEF_MEM_LEVEL=8,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,MIN_MATCH=3,MAX_MATCH=258,MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1,PRESET_DICT=32,INIT_STATE=42,EXTRA_STATE=69,NAME_STATE=73,COMMENT_STATE=91,HCRC_STATE=103,BUSY_STATE=113,FINISH_STATE=666,BS_NEED_MORE=1,BS_BLOCK_DONE=2,BS_FINISH_STARTED=3,BS_FINISH_DONE=4,OS_CODE=3,err=(n,t)=>(n.msg=messages[t],t),rank=n=>(n<<1)-(n>4?9:0),zero=n=>{let t=n.length;for(;--t>=0;)n[t]=0};let HASH_ZLIB=(n,t,s)=>(t<<n.hash_shift^s)&n.hash_mask,HASH=HASH_ZLIB;const flush_pending=n=>{const t=n.state;let s=t.pending;s>n.avail_out&&(s=n.avail_out),s!==0&&(n.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+s),n.next_out),n.next_out+=s,t.pending_out+=s,n.total_out+=s,n.avail_out-=s,t.pending-=s,t.pending===0&&(t.pending_out=0))},flush_block_only=(n,t)=>{_tr_flush_block(n,n.block_start>=0?n.block_start:-1,n.strstart-n.block_start,t),n.block_start=n.strstart,flush_pending(n.strm)},put_byte=(n,t)=>{n.pending_buf[n.pending++]=t},putShortMSB=(n,t)=>{n.pending_buf[n.pending++]=t>>>8&255,n.pending_buf[n.pending++]=t&255},read_buf=(n,t,s,l)=>{let f=n.avail_in;return f>l&&(f=l),f===0?0:(n.avail_in-=f,t.set(n.input.subarray(n.next_in,n.next_in+f),s),n.state.wrap===1?n.adler=adler32_1(n.adler,t,f,s):n.state.wrap===2&&(n.adler=crc32_1(n.adler,t,f,s)),n.next_in+=f,n.total_in+=f,f)},longest_match=(n,t)=>{let s=n.max_chain_length,l=n.strstart,f,m,b=n.prev_length,h=n.nice_match;const S=n.strstart>n.w_size-MIN_LOOKAHEAD?n.strstart-(n.w_size-MIN_LOOKAHEAD):0,M=n.window,C=n.w_mask,L=n.prev,N=n.strstart+MAX_MATCH;let F=M[l+b-1],G=M[l+b];n.prev_length>=n.good_match&&(s>>=2),h>n.lookahead&&(h=n.lookahead);do if(f=t,!(M[f+b]!==G||M[f+b-1]!==F||M[f]!==M[l]||M[++f]!==M[l+1])){l+=2,f++;do;while(M[++l]===M[++f]&&M[++l]===M[++f]&&M[++l]===M[++f]&&M[++l]===M[++f]&&M[++l]===M[++f]&&M[++l]===M[++f]&&M[++l]===M[++f]&&M[++l]===M[++f]&&l<N);if(m=MAX_MATCH-(N-l),l=N-MAX_MATCH,m>b){if(n.match_start=t,b=m,m>=h)break;F=M[l+b-1],G=M[l+b]}}while((t=L[t&C])>S&&--s!==0);return b<=n.lookahead?b:n.lookahead},fill_window=n=>{const t=n.w_size;let s,l,f,m,b;do{if(m=n.window_size-n.lookahead-n.strstart,n.strstart>=t+(t-MIN_LOOKAHEAD)){n.window.set(n.window.subarray(t,t+t),0),n.match_start-=t,n.strstart-=t,n.block_start-=t,l=n.hash_size,s=l;do f=n.head[--s],n.head[s]=f>=t?f-t:0;while(--l);l=t,s=l;do f=n.prev[--s],n.prev[s]=f>=t?f-t:0;while(--l);m+=t}if(n.strm.avail_in===0)break;if(l=read_buf(n.strm,n.window,n.strstart+n.lookahead,m),n.lookahead+=l,n.lookahead+n.insert>=MIN_MATCH)for(b=n.strstart-n.insert,n.ins_h=n.window[b],n.ins_h=HASH(n,n.ins_h,n.window[b+1]);n.insert&&(n.ins_h=HASH(n,n.ins_h,n.window[b+MIN_MATCH-1]),n.prev[b&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=b,b++,n.insert--,!(n.lookahead+n.insert<MIN_MATCH)););}while(n.lookahead<MIN_LOOKAHEAD&&n.strm.avail_in!==0)},deflate_stored=(n,t)=>{let s=65535;for(s>n.pending_buf_size-5&&(s=n.pending_buf_size-5);;){if(n.lookahead<=1){if(fill_window(n),n.lookahead===0&&t===Z_NO_FLUSH$2)return BS_NEED_MORE;if(n.lookahead===0)break}n.strstart+=n.lookahead,n.lookahead=0;const l=n.block_start+s;if((n.strstart===0||n.strstart>=l)&&(n.lookahead=n.strstart-l,n.strstart=l,flush_block_only(n,!1),n.strm.avail_out===0)||n.strstart-n.block_start>=n.w_size-MIN_LOOKAHEAD&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}return n.insert=0,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):(n.strstart>n.block_start&&(flush_block_only(n,!1),n.strm.avail_out===0),BS_NEED_MORE)},deflate_fast=(n,t)=>{let s,l;for(;;){if(n.lookahead<MIN_LOOKAHEAD){if(fill_window(n),n.lookahead<MIN_LOOKAHEAD&&t===Z_NO_FLUSH$2)return BS_NEED_MORE;if(n.lookahead===0)break}if(s=0,n.lookahead>=MIN_MATCH&&(n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+MIN_MATCH-1]),s=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart),s!==0&&n.strstart-s<=n.w_size-MIN_LOOKAHEAD&&(n.match_length=longest_match(n,s)),n.match_length>=MIN_MATCH)if(l=_tr_tally(n,n.strstart-n.match_start,n.match_length-MIN_MATCH),n.lookahead-=n.match_length,n.match_length<=n.max_lazy_match&&n.lookahead>=MIN_MATCH){n.match_length--;do n.strstart++,n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+MIN_MATCH-1]),s=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart;while(--n.match_length!==0);n.strstart++}else n.strstart+=n.match_length,n.match_length=0,n.ins_h=n.window[n.strstart],n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+1]);else l=_tr_tally(n,0,n.window[n.strstart]),n.lookahead--,n.strstart++;if(l&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}return n.insert=n.strstart<MIN_MATCH-1?n.strstart:MIN_MATCH-1,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):n.last_lit&&(flush_block_only(n,!1),n.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_slow=(n,t)=>{let s,l,f;for(;;){if(n.lookahead<MIN_LOOKAHEAD){if(fill_window(n),n.lookahead<MIN_LOOKAHEAD&&t===Z_NO_FLUSH$2)return BS_NEED_MORE;if(n.lookahead===0)break}if(s=0,n.lookahead>=MIN_MATCH&&(n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+MIN_MATCH-1]),s=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart),n.prev_length=n.match_length,n.prev_match=n.match_start,n.match_length=MIN_MATCH-1,s!==0&&n.prev_length<n.max_lazy_match&&n.strstart-s<=n.w_size-MIN_LOOKAHEAD&&(n.match_length=longest_match(n,s),n.match_length<=5&&(n.strategy===Z_FILTERED||n.match_length===MIN_MATCH&&n.strstart-n.match_start>4096)&&(n.match_length=MIN_MATCH-1)),n.prev_length>=MIN_MATCH&&n.match_length<=n.prev_length){f=n.strstart+n.lookahead-MIN_MATCH,l=_tr_tally(n,n.strstart-1-n.prev_match,n.prev_length-MIN_MATCH),n.lookahead-=n.prev_length-1,n.prev_length-=2;do++n.strstart<=f&&(n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+MIN_MATCH-1]),s=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart);while(--n.prev_length!==0);if(n.match_available=0,n.match_length=MIN_MATCH-1,n.strstart++,l&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}else if(n.match_available){if(l=_tr_tally(n,0,n.window[n.strstart-1]),l&&flush_block_only(n,!1),n.strstart++,n.lookahead--,n.strm.avail_out===0)return BS_NEED_MORE}else n.match_available=1,n.strstart++,n.lookahead--}return n.match_available&&(l=_tr_tally(n,0,n.window[n.strstart-1]),n.match_available=0),n.insert=n.strstart<MIN_MATCH-1?n.strstart:MIN_MATCH-1,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):n.last_lit&&(flush_block_only(n,!1),n.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_rle=(n,t)=>{let s,l,f,m;const b=n.window;for(;;){if(n.lookahead<=MAX_MATCH){if(fill_window(n),n.lookahead<=MAX_MATCH&&t===Z_NO_FLUSH$2)return BS_NEED_MORE;if(n.lookahead===0)break}if(n.match_length=0,n.lookahead>=MIN_MATCH&&n.strstart>0&&(f=n.strstart-1,l=b[f],l===b[++f]&&l===b[++f]&&l===b[++f])){m=n.strstart+MAX_MATCH;do;while(l===b[++f]&&l===b[++f]&&l===b[++f]&&l===b[++f]&&l===b[++f]&&l===b[++f]&&l===b[++f]&&l===b[++f]&&f<m);n.match_length=MAX_MATCH-(m-f),n.match_length>n.lookahead&&(n.match_length=n.lookahead)}if(n.match_length>=MIN_MATCH?(s=_tr_tally(n,1,n.match_length-MIN_MATCH),n.lookahead-=n.match_length,n.strstart+=n.match_length,n.match_length=0):(s=_tr_tally(n,0,n.window[n.strstart]),n.lookahead--,n.strstart++),s&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}return n.insert=0,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):n.last_lit&&(flush_block_only(n,!1),n.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_huff=(n,t)=>{let s;for(;;){if(n.lookahead===0&&(fill_window(n),n.lookahead===0)){if(t===Z_NO_FLUSH$2)return BS_NEED_MORE;break}if(n.match_length=0,s=_tr_tally(n,0,n.window[n.strstart]),n.lookahead--,n.strstart++,s&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}return n.insert=0,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):n.last_lit&&(flush_block_only(n,!1),n.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE};function Config(n,t,s,l,f){this.good_length=n,this.max_lazy=t,this.nice_length=s,this.max_chain=l,this.func=f}const configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],lm_init=n=>{n.window_size=2*n.w_size,zero(n.head),n.max_lazy_match=configuration_table[n.level].max_lazy,n.good_match=configuration_table[n.level].good_length,n.nice_match=configuration_table[n.level].nice_length,n.max_chain_length=configuration_table[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=MIN_MATCH-1,n.match_available=0,n.ins_h=0};function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Z_DEFLATED$2,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(HEAP_SIZE*2),this.dyn_dtree=new Uint16Array((2*D_CODES+1)*2),this.bl_tree=new Uint16Array((2*BL_CODES+1)*2),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(MAX_BITS+1),this.heap=new Uint16Array(2*L_CODES+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*L_CODES+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const deflateResetKeep=n=>{if(!n||!n.state)return err(n,Z_STREAM_ERROR$2);n.total_in=n.total_out=0,n.data_type=Z_UNKNOWN;const t=n.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?INIT_STATE:BUSY_STATE,n.adler=t.wrap===2?0:1,t.last_flush=Z_NO_FLUSH$2,_tr_init(t),Z_OK$3},deflateReset=n=>{const t=deflateResetKeep(n);return t===Z_OK$3&&lm_init(n.state),t},deflateSetHeader=(n,t)=>!n||!n.state||n.state.wrap!==2?Z_STREAM_ERROR$2:(n.state.gzhead=t,Z_OK$3),deflateInit2=(n,t,s,l,f,m)=>{if(!n)return Z_STREAM_ERROR$2;let b=1;if(t===Z_DEFAULT_COMPRESSION$1&&(t=6),l<0?(b=0,l=-l):l>15&&(b=2,l-=16),f<1||f>MAX_MEM_LEVEL||s!==Z_DEFLATED$2||l<8||l>15||t<0||t>9||m<0||m>Z_FIXED)return err(n,Z_STREAM_ERROR$2);l===8&&(l=9);const h=new DeflateState;return n.state=h,h.strm=n,h.wrap=b,h.gzhead=null,h.w_bits=l,h.w_size=1<<h.w_bits,h.w_mask=h.w_size-1,h.hash_bits=f+7,h.hash_size=1<<h.hash_bits,h.hash_mask=h.hash_size-1,h.hash_shift=~~((h.hash_bits+MIN_MATCH-1)/MIN_MATCH),h.window=new Uint8Array(h.w_size*2),h.head=new Uint16Array(h.hash_size),h.prev=new Uint16Array(h.w_size),h.lit_bufsize=1<<f+6,h.pending_buf_size=h.lit_bufsize*4,h.pending_buf=new Uint8Array(h.pending_buf_size),h.d_buf=1*h.lit_bufsize,h.l_buf=(1+2)*h.lit_bufsize,h.level=t,h.strategy=m,h.method=s,deflateReset(n)},deflateInit=(n,t)=>deflateInit2(n,t,Z_DEFLATED$2,MAX_WBITS$1,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY$1),deflate$2=(n,t)=>{let s,l;if(!n||!n.state||t>Z_BLOCK$1||t<0)return n?err(n,Z_STREAM_ERROR$2):Z_STREAM_ERROR$2;const f=n.state;if(!n.output||!n.input&&n.avail_in!==0||f.status===FINISH_STATE&&t!==Z_FINISH$3)return err(n,n.avail_out===0?Z_BUF_ERROR$1:Z_STREAM_ERROR$2);f.strm=n;const m=f.last_flush;if(f.last_flush=t,f.status===INIT_STATE)if(f.wrap===2)n.adler=0,put_byte(f,31),put_byte(f,139),put_byte(f,8),f.gzhead?(put_byte(f,(f.gzhead.text?1:0)+(f.gzhead.hcrc?2:0)+(f.gzhead.extra?4:0)+(f.gzhead.name?8:0)+(f.gzhead.comment?16:0)),put_byte(f,f.gzhead.time&255),put_byte(f,f.gzhead.time>>8&255),put_byte(f,f.gzhead.time>>16&255),put_byte(f,f.gzhead.time>>24&255),put_byte(f,f.level===9?2:f.strategy>=Z_HUFFMAN_ONLY||f.level<2?4:0),put_byte(f,f.gzhead.os&255),f.gzhead.extra&&f.gzhead.extra.length&&(put_byte(f,f.gzhead.extra.length&255),put_byte(f,f.gzhead.extra.length>>8&255)),f.gzhead.hcrc&&(n.adler=crc32_1(n.adler,f.pending_buf,f.pending,0)),f.gzindex=0,f.status=EXTRA_STATE):(put_byte(f,0),put_byte(f,0),put_byte(f,0),put_byte(f,0),put_byte(f,0),put_byte(f,f.level===9?2:f.strategy>=Z_HUFFMAN_ONLY||f.level<2?4:0),put_byte(f,OS_CODE),f.status=BUSY_STATE);else{let b=Z_DEFLATED$2+(f.w_bits-8<<4)<<8,h=-1;f.strategy>=Z_HUFFMAN_ONLY||f.level<2?h=0:f.level<6?h=1:f.level===6?h=2:h=3,b|=h<<6,f.strstart!==0&&(b|=PRESET_DICT),b+=31-b%31,f.status=BUSY_STATE,putShortMSB(f,b),f.strstart!==0&&(putShortMSB(f,n.adler>>>16),putShortMSB(f,n.adler&65535)),n.adler=1}if(f.status===EXTRA_STATE)if(f.gzhead.extra){for(s=f.pending;f.gzindex<(f.gzhead.extra.length&65535)&&!(f.pending===f.pending_buf_size&&(f.gzhead.hcrc&&f.pending>s&&(n.adler=crc32_1(n.adler,f.pending_buf,f.pending-s,s)),flush_pending(n),s=f.pending,f.pending===f.pending_buf_size));)put_byte(f,f.gzhead.extra[f.gzindex]&255),f.gzindex++;f.gzhead.hcrc&&f.pending>s&&(n.adler=crc32_1(n.adler,f.pending_buf,f.pending-s,s)),f.gzindex===f.gzhead.extra.length&&(f.gzindex=0,f.status=NAME_STATE)}else f.status=NAME_STATE;if(f.status===NAME_STATE)if(f.gzhead.name){s=f.pending;do{if(f.pending===f.pending_buf_size&&(f.gzhead.hcrc&&f.pending>s&&(n.adler=crc32_1(n.adler,f.pending_buf,f.pending-s,s)),flush_pending(n),s=f.pending,f.pending===f.pending_buf_size)){l=1;break}f.gzindex<f.gzhead.name.length?l=f.gzhead.name.charCodeAt(f.gzindex++)&255:l=0,put_byte(f,l)}while(l!==0);f.gzhead.hcrc&&f.pending>s&&(n.adler=crc32_1(n.adler,f.pending_buf,f.pending-s,s)),l===0&&(f.gzindex=0,f.status=COMMENT_STATE)}else f.status=COMMENT_STATE;if(f.status===COMMENT_STATE)if(f.gzhead.comment){s=f.pending;do{if(f.pending===f.pending_buf_size&&(f.gzhead.hcrc&&f.pending>s&&(n.adler=crc32_1(n.adler,f.pending_buf,f.pending-s,s)),flush_pending(n),s=f.pending,f.pending===f.pending_buf_size)){l=1;break}f.gzindex<f.gzhead.comment.length?l=f.gzhead.comment.charCodeAt(f.gzindex++)&255:l=0,put_byte(f,l)}while(l!==0);f.gzhead.hcrc&&f.pending>s&&(n.adler=crc32_1(n.adler,f.pending_buf,f.pending-s,s)),l===0&&(f.status=HCRC_STATE)}else f.status=HCRC_STATE;if(f.status===HCRC_STATE&&(f.gzhead.hcrc?(f.pending+2>f.pending_buf_size&&flush_pending(n),f.pending+2<=f.pending_buf_size&&(put_byte(f,n.adler&255),put_byte(f,n.adler>>8&255),n.adler=0,f.status=BUSY_STATE)):f.status=BUSY_STATE),f.pending!==0){if(flush_pending(n),n.avail_out===0)return f.last_flush=-1,Z_OK$3}else if(n.avail_in===0&&rank(t)<=rank(m)&&t!==Z_FINISH$3)return err(n,Z_BUF_ERROR$1);if(f.status===FINISH_STATE&&n.avail_in!==0)return err(n,Z_BUF_ERROR$1);if(n.avail_in!==0||f.lookahead!==0||t!==Z_NO_FLUSH$2&&f.status!==FINISH_STATE){let b=f.strategy===Z_HUFFMAN_ONLY?deflate_huff(f,t):f.strategy===Z_RLE?deflate_rle(f,t):configuration_table[f.level].func(f,t);if((b===BS_FINISH_STARTED||b===BS_FINISH_DONE)&&(f.status=FINISH_STATE),b===BS_NEED_MORE||b===BS_FINISH_STARTED)return n.avail_out===0&&(f.last_flush=-1),Z_OK$3;if(b===BS_BLOCK_DONE&&(t===Z_PARTIAL_FLUSH?_tr_align(f):t!==Z_BLOCK$1&&(_tr_stored_block(f,0,0,!1),t===Z_FULL_FLUSH$1&&(zero(f.head),f.lookahead===0&&(f.strstart=0,f.block_start=0,f.insert=0))),flush_pending(n),n.avail_out===0))return f.last_flush=-1,Z_OK$3}return t!==Z_FINISH$3?Z_OK$3:f.wrap<=0?Z_STREAM_END$3:(f.wrap===2?(put_byte(f,n.adler&255),put_byte(f,n.adler>>8&255),put_byte(f,n.adler>>16&255),put_byte(f,n.adler>>24&255),put_byte(f,n.total_in&255),put_byte(f,n.total_in>>8&255),put_byte(f,n.total_in>>16&255),put_byte(f,n.total_in>>24&255)):(putShortMSB(f,n.adler>>>16),putShortMSB(f,n.adler&65535)),flush_pending(n),f.wrap>0&&(f.wrap=-f.wrap),f.pending!==0?Z_OK$3:Z_STREAM_END$3)},deflateEnd=n=>{if(!n||!n.state)return Z_STREAM_ERROR$2;const t=n.state.status;return t!==INIT_STATE&&t!==EXTRA_STATE&&t!==NAME_STATE&&t!==COMMENT_STATE&&t!==HCRC_STATE&&t!==BUSY_STATE&&t!==FINISH_STATE?err(n,Z_STREAM_ERROR$2):(n.state=null,t===BUSY_STATE?err(n,Z_DATA_ERROR$2):Z_OK$3)},deflateSetDictionary=(n,t)=>{let s=t.length;if(!n||!n.state)return Z_STREAM_ERROR$2;const l=n.state,f=l.wrap;if(f===2||f===1&&l.status!==INIT_STATE||l.lookahead)return Z_STREAM_ERROR$2;if(f===1&&(n.adler=adler32_1(n.adler,t,s,0)),l.wrap=0,s>=l.w_size){f===0&&(zero(l.head),l.strstart=0,l.block_start=0,l.insert=0);let S=new Uint8Array(l.w_size);S.set(t.subarray(s-l.w_size,s),0),t=S,s=l.w_size}const m=n.avail_in,b=n.next_in,h=n.input;for(n.avail_in=s,n.next_in=0,n.input=t,fill_window(l);l.lookahead>=MIN_MATCH;){let S=l.strstart,M=l.lookahead-(MIN_MATCH-1);do l.ins_h=HASH(l,l.ins_h,l.window[S+MIN_MATCH-1]),l.prev[S&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=S,S++;while(--M);l.strstart=S,l.lookahead=MIN_MATCH-1,fill_window(l)}return l.strstart+=l.lookahead,l.block_start=l.strstart,l.insert=l.lookahead,l.lookahead=0,l.match_length=l.prev_length=MIN_MATCH-1,l.match_available=0,n.next_in=b,n.input=h,n.avail_in=m,l.wrap=f,Z_OK$3};var deflateInit_1=deflateInit,deflateInit2_1=deflateInit2,deflateReset_1=deflateReset,deflateResetKeep_1=deflateResetKeep,deflateSetHeader_1=deflateSetHeader,deflate_2$1=deflate$2,deflateEnd_1=deflateEnd,deflateSetDictionary_1=deflateSetDictionary,deflateInfo="pako deflate (from Nodeca project)",deflate_1$2={deflateInit:deflateInit_1,deflateInit2:deflateInit2_1,deflateReset:deflateReset_1,deflateResetKeep:deflateResetKeep_1,deflateSetHeader:deflateSetHeader_1,deflate:deflate_2$1,deflateEnd:deflateEnd_1,deflateSetDictionary:deflateSetDictionary_1,deflateInfo};const _has=(n,t)=>Object.prototype.hasOwnProperty.call(n,t);var assign=function(n){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const s=t.shift();if(!!s){if(typeof s!="object")throw new TypeError(s+"must be non-object");for(const l in s)_has(s,l)&&(n[l]=s[l])}}return n},flattenChunks=n=>{let t=0;for(let l=0,f=n.length;l<f;l++)t+=n[l].length;const s=new Uint8Array(t);for(let l=0,f=0,m=n.length;l<m;l++){let b=n[l];s.set(b,f),f+=b.length}return s},common={assign,flattenChunks};let STR_APPLY_UIA_OK=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{STR_APPLY_UIA_OK=!1}const _utf8len=new Uint8Array(256);for(let n=0;n<256;n++)_utf8len[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=n=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(n);let t,s,l,f,m,b=n.length,h=0;for(f=0;f<b;f++)s=n.charCodeAt(f),(s&64512)===55296&&f+1<b&&(l=n.charCodeAt(f+1),(l&64512)===56320&&(s=65536+(s-55296<<10)+(l-56320),f++)),h+=s<128?1:s<2048?2:s<65536?3:4;for(t=new Uint8Array(h),m=0,f=0;m<h;f++)s=n.charCodeAt(f),(s&64512)===55296&&f+1<b&&(l=n.charCodeAt(f+1),(l&64512)===56320&&(s=65536+(s-55296<<10)+(l-56320),f++)),s<128?t[m++]=s:s<2048?(t[m++]=192|s>>>6,t[m++]=128|s&63):s<65536?(t[m++]=224|s>>>12,t[m++]=128|s>>>6&63,t[m++]=128|s&63):(t[m++]=240|s>>>18,t[m++]=128|s>>>12&63,t[m++]=128|s>>>6&63,t[m++]=128|s&63);return t};const buf2binstring=(n,t)=>{if(t<65534&&n.subarray&&STR_APPLY_UIA_OK)return String.fromCharCode.apply(null,n.length===t?n:n.subarray(0,t));let s="";for(let l=0;l<t;l++)s+=String.fromCharCode(n[l]);return s};var buf2string=(n,t)=>{const s=t||n.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(n.subarray(0,t));let l,f;const m=new Array(s*2);for(f=0,l=0;l<s;){let b=n[l++];if(b<128){m[f++]=b;continue}let h=_utf8len[b];if(h>4){m[f++]=65533,l+=h-1;continue}for(b&=h===2?31:h===3?15:7;h>1&&l<s;)b=b<<6|n[l++]&63,h--;if(h>1){m[f++]=65533;continue}b<65536?m[f++]=b:(b-=65536,m[f++]=55296|b>>10&1023,m[f++]=56320|b&1023)}return buf2binstring(m,f)},utf8border=(n,t)=>{t=t||n.length,t>n.length&&(t=n.length);let s=t-1;for(;s>=0&&(n[s]&192)===128;)s--;return s<0||s===0?t:s+_utf8len[n[s]]>t?s:t},strings={string2buf,buf2string,utf8border};function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var zstream=ZStream;const toString$1$1=Object.prototype.toString,{Z_NO_FLUSH:Z_NO_FLUSH$1,Z_SYNC_FLUSH,Z_FULL_FLUSH,Z_FINISH:Z_FINISH$2,Z_OK:Z_OK$2,Z_STREAM_END:Z_STREAM_END$2,Z_DEFAULT_COMPRESSION,Z_DEFAULT_STRATEGY,Z_DEFLATED:Z_DEFLATED$1}=constants$2$1;function Deflate$1(n){this.options=common.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED$1,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY},n||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let s=deflate_1$2.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(s!==Z_OK$2)throw new Error(messages[s]);if(t.header&&deflate_1$2.deflateSetHeader(this.strm,t.header),t.dictionary){let l;if(typeof t.dictionary=="string"?l=strings.string2buf(t.dictionary):toString$1$1.call(t.dictionary)==="[object ArrayBuffer]"?l=new Uint8Array(t.dictionary):l=t.dictionary,s=deflate_1$2.deflateSetDictionary(this.strm,l),s!==Z_OK$2)throw new Error(messages[s]);this._dict_set=!0}}Deflate$1.prototype.push=function(n,t){const s=this.strm,l=this.options.chunkSize;let f,m;if(this.ended)return!1;for(t===~~t?m=t:m=t===!0?Z_FINISH$2:Z_NO_FLUSH$1,typeof n=="string"?s.input=strings.string2buf(n):toString$1$1.call(n)==="[object ArrayBuffer]"?s.input=new Uint8Array(n):s.input=n,s.next_in=0,s.avail_in=s.input.length;;){if(s.avail_out===0&&(s.output=new Uint8Array(l),s.next_out=0,s.avail_out=l),(m===Z_SYNC_FLUSH||m===Z_FULL_FLUSH)&&s.avail_out<=6){this.onData(s.output.subarray(0,s.next_out)),s.avail_out=0;continue}if(f=deflate_1$2.deflate(s,m),f===Z_STREAM_END$2)return s.next_out>0&&this.onData(s.output.subarray(0,s.next_out)),f=deflate_1$2.deflateEnd(this.strm),this.onEnd(f),this.ended=!0,f===Z_OK$2;if(s.avail_out===0){this.onData(s.output);continue}if(m>0&&s.next_out>0){this.onData(s.output.subarray(0,s.next_out)),s.avail_out=0;continue}if(s.avail_in===0)break}return!0};Deflate$1.prototype.onData=function(n){this.chunks.push(n)};Deflate$1.prototype.onEnd=function(n){n===Z_OK$2&&(this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};function deflate$1(n,t){const s=new Deflate$1(t);if(s.push(n,!0),s.err)throw s.msg||messages[s.err];return s.result}function deflateRaw$1(n,t){return t=t||{},t.raw=!0,deflate$1(n,t)}function gzip$1(n,t){return t=t||{},t.gzip=!0,deflate$1(n,t)}var Deflate_1$1=Deflate$1,deflate_2=deflate$1,deflateRaw_1$1=deflateRaw$1,gzip_1$1=gzip$1,constants$1$1=constants$2$1,deflate_1$1={Deflate:Deflate_1$1,deflate:deflate_2,deflateRaw:deflateRaw_1$1,gzip:gzip_1$1,constants:constants$1$1};const BAD$1=30,TYPE$1=12;var inffast=function(t,s){let l,f,m,b,h,S,M,C,L,N,F,G,H,K,X,de,Q,ie,ce,ge,be,ne,ve,te;const he=t.state;l=t.next_in,ve=t.input,f=l+(t.avail_in-5),m=t.next_out,te=t.output,b=m-(s-t.avail_out),h=m+(t.avail_out-257),S=he.dmax,M=he.wsize,C=he.whave,L=he.wnext,N=he.window,F=he.hold,G=he.bits,H=he.lencode,K=he.distcode,X=(1<<he.lenbits)-1,de=(1<<he.distbits)-1;e:do{G<15&&(F+=ve[l++]<<G,G+=8,F+=ve[l++]<<G,G+=8),Q=H[F&X];t:for(;;){if(ie=Q>>>24,F>>>=ie,G-=ie,ie=Q>>>16&255,ie===0)te[m++]=Q&65535;else if(ie&16){ce=Q&65535,ie&=15,ie&&(G<ie&&(F+=ve[l++]<<G,G+=8),ce+=F&(1<<ie)-1,F>>>=ie,G-=ie),G<15&&(F+=ve[l++]<<G,G+=8,F+=ve[l++]<<G,G+=8),Q=K[F&de];i:for(;;){if(ie=Q>>>24,F>>>=ie,G-=ie,ie=Q>>>16&255,ie&16){if(ge=Q&65535,ie&=15,G<ie&&(F+=ve[l++]<<G,G+=8,G<ie&&(F+=ve[l++]<<G,G+=8)),ge+=F&(1<<ie)-1,ge>S){t.msg="invalid distance too far back",he.mode=BAD$1;break e}if(F>>>=ie,G-=ie,ie=m-b,ge>ie){if(ie=ge-ie,ie>C&&he.sane){t.msg="invalid distance too far back",he.mode=BAD$1;break e}if(be=0,ne=N,L===0){if(be+=M-ie,ie<ce){ce-=ie;do te[m++]=N[be++];while(--ie);be=m-ge,ne=te}}else if(L<ie){if(be+=M+L-ie,ie-=L,ie<ce){ce-=ie;do te[m++]=N[be++];while(--ie);if(be=0,L<ce){ie=L,ce-=ie;do te[m++]=N[be++];while(--ie);be=m-ge,ne=te}}}else if(be+=L-ie,ie<ce){ce-=ie;do te[m++]=N[be++];while(--ie);be=m-ge,ne=te}for(;ce>2;)te[m++]=ne[be++],te[m++]=ne[be++],te[m++]=ne[be++],ce-=3;ce&&(te[m++]=ne[be++],ce>1&&(te[m++]=ne[be++]))}else{be=m-ge;do te[m++]=te[be++],te[m++]=te[be++],te[m++]=te[be++],ce-=3;while(ce>2);ce&&(te[m++]=te[be++],ce>1&&(te[m++]=te[be++]))}}else if((ie&64)===0){Q=K[(Q&65535)+(F&(1<<ie)-1)];continue i}else{t.msg="invalid distance code",he.mode=BAD$1;break e}break}}else if((ie&64)===0){Q=H[(Q&65535)+(F&(1<<ie)-1)];continue t}else if(ie&32){he.mode=TYPE$1;break e}else{t.msg="invalid literal/length code",he.mode=BAD$1;break e}break}}while(l<f&&m<h);ce=G>>3,l-=ce,G-=ce<<3,F&=(1<<G)-1,t.next_in=l,t.next_out=m,t.avail_in=l<f?5+(f-l):5-(l-f),t.avail_out=m<h?257+(h-m):257-(m-h),he.hold=F,he.bits=G};const MAXBITS=15,ENOUGH_LENS$1=852,ENOUGH_DISTS$1=592,CODES$1=0,LENS$1=1,DISTS$1=2,lbase=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),lext=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),dbase=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),dext=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),inflate_table=(n,t,s,l,f,m,b,h)=>{const S=h.bits;let M=0,C=0,L=0,N=0,F=0,G=0,H=0,K=0,X=0,de=0,Q,ie,ce,ge,be,ne=null,ve=0,te;const he=new Uint16Array(MAXBITS+1),Ie=new Uint16Array(MAXBITS+1);let Oe=null,tt=0,it,Ct,Rt;for(M=0;M<=MAXBITS;M++)he[M]=0;for(C=0;C<l;C++)he[t[s+C]]++;for(F=S,N=MAXBITS;N>=1&&he[N]===0;N--);if(F>N&&(F=N),N===0)return f[m++]=1<<24|64<<16|0,f[m++]=1<<24|64<<16|0,h.bits=1,0;for(L=1;L<N&&he[L]===0;L++);for(F<L&&(F=L),K=1,M=1;M<=MAXBITS;M++)if(K<<=1,K-=he[M],K<0)return-1;if(K>0&&(n===CODES$1||N!==1))return-1;for(Ie[1]=0,M=1;M<MAXBITS;M++)Ie[M+1]=Ie[M]+he[M];for(C=0;C<l;C++)t[s+C]!==0&&(b[Ie[t[s+C]]++]=C);if(n===CODES$1?(ne=Oe=b,te=19):n===LENS$1?(ne=lbase,ve-=257,Oe=lext,tt-=257,te=256):(ne=dbase,Oe=dext,te=-1),de=0,C=0,M=L,be=m,G=F,H=0,ce=-1,X=1<<F,ge=X-1,n===LENS$1&&X>ENOUGH_LENS$1||n===DISTS$1&&X>ENOUGH_DISTS$1)return 1;for(;;){it=M-H,b[C]<te?(Ct=0,Rt=b[C]):b[C]>te?(Ct=Oe[tt+b[C]],Rt=ne[ve+b[C]]):(Ct=32+64,Rt=0),Q=1<<M-H,ie=1<<G,L=ie;do ie-=Q,f[be+(de>>H)+ie]=it<<24|Ct<<16|Rt|0;while(ie!==0);for(Q=1<<M-1;de&Q;)Q>>=1;if(Q!==0?(de&=Q-1,de+=Q):de=0,C++,--he[M]===0){if(M===N)break;M=t[s+b[C]]}if(M>F&&(de&ge)!==ce){for(H===0&&(H=F),be+=L,G=M-H,K=1<<G;G+H<N&&(K-=he[G+H],!(K<=0));)G++,K<<=1;if(X+=1<<G,n===LENS$1&&X>ENOUGH_LENS$1||n===DISTS$1&&X>ENOUGH_DISTS$1)return 1;ce=de&ge,f[ce]=F<<24|G<<16|be-m|0}}return de!==0&&(f[be+de]=M-H<<24|64<<16|0),h.bits=F,0};var inftrees=inflate_table;const CODES=0,LENS=1,DISTS=2,{Z_FINISH:Z_FINISH$1,Z_BLOCK,Z_TREES,Z_OK:Z_OK$1,Z_STREAM_END:Z_STREAM_END$1,Z_NEED_DICT:Z_NEED_DICT$1,Z_STREAM_ERROR:Z_STREAM_ERROR$1,Z_DATA_ERROR:Z_DATA_ERROR$1,Z_MEM_ERROR:Z_MEM_ERROR$1,Z_BUF_ERROR,Z_DEFLATED}=constants$2$1,HEAD=1,FLAGS=2,TIME=3,OS=4,EXLEN=5,EXTRA=6,NAME=7,COMMENT=8,HCRC=9,DICTID=10,DICT=11,TYPE=12,TYPEDO=13,STORED=14,COPY_=15,COPY=16,TABLE=17,LENLENS=18,CODELENS=19,LEN_=20,LEN=21,LENEXT=22,DIST=23,DISTEXT=24,MATCH=25,LIT=26,CHECK=27,LENGTH=28,DONE=29,BAD=30,MEM=31,SYNC=32,ENOUGH_LENS=852,ENOUGH_DISTS=592,MAX_WBITS=15,DEF_WBITS=MAX_WBITS,zswap32=n=>(n>>>24&255)+(n>>>8&65280)+((n&65280)<<8)+((n&255)<<24);function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const inflateResetKeep=n=>{if(!n||!n.state)return Z_STREAM_ERROR$1;const t=n.state;return n.total_in=n.total_out=t.total=0,n.msg="",t.wrap&&(n.adler=t.wrap&1),t.mode=HEAD,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(ENOUGH_LENS),t.distcode=t.distdyn=new Int32Array(ENOUGH_DISTS),t.sane=1,t.back=-1,Z_OK$1},inflateReset=n=>{if(!n||!n.state)return Z_STREAM_ERROR$1;const t=n.state;return t.wsize=0,t.whave=0,t.wnext=0,inflateResetKeep(n)},inflateReset2=(n,t)=>{let s;if(!n||!n.state)return Z_STREAM_ERROR$1;const l=n.state;return t<0?(s=0,t=-t):(s=(t>>4)+1,t<48&&(t&=15)),t&&(t<8||t>15)?Z_STREAM_ERROR$1:(l.window!==null&&l.wbits!==t&&(l.window=null),l.wrap=s,l.wbits=t,inflateReset(n))},inflateInit2=(n,t)=>{if(!n)return Z_STREAM_ERROR$1;const s=new InflateState;n.state=s,s.window=null;const l=inflateReset2(n,t);return l!==Z_OK$1&&(n.state=null),l},inflateInit=n=>inflateInit2(n,DEF_WBITS);let virgin=!0,lenfix,distfix;const fixedtables=n=>{if(virgin){lenfix=new Int32Array(512),distfix=new Int32Array(32);let t=0;for(;t<144;)n.lens[t++]=8;for(;t<256;)n.lens[t++]=9;for(;t<280;)n.lens[t++]=7;for(;t<288;)n.lens[t++]=8;for(inftrees(LENS,n.lens,0,288,lenfix,0,n.work,{bits:9}),t=0;t<32;)n.lens[t++]=5;inftrees(DISTS,n.lens,0,32,distfix,0,n.work,{bits:5}),virgin=!1}n.lencode=lenfix,n.lenbits=9,n.distcode=distfix,n.distbits=5},updatewindow=(n,t,s,l)=>{let f;const m=n.state;return m.window===null&&(m.wsize=1<<m.wbits,m.wnext=0,m.whave=0,m.window=new Uint8Array(m.wsize)),l>=m.wsize?(m.window.set(t.subarray(s-m.wsize,s),0),m.wnext=0,m.whave=m.wsize):(f=m.wsize-m.wnext,f>l&&(f=l),m.window.set(t.subarray(s-l,s-l+f),m.wnext),l-=f,l?(m.window.set(t.subarray(s-l,s),0),m.wnext=l,m.whave=m.wsize):(m.wnext+=f,m.wnext===m.wsize&&(m.wnext=0),m.whave<m.wsize&&(m.whave+=f))),0},inflate$2=(n,t)=>{let s,l,f,m,b,h,S,M,C,L,N,F,G,H,K=0,X,de,Q,ie,ce,ge,be,ne;const ve=new Uint8Array(4);let te,he;const Ie=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!n||!n.state||!n.output||!n.input&&n.avail_in!==0)return Z_STREAM_ERROR$1;s=n.state,s.mode===TYPE&&(s.mode=TYPEDO),b=n.next_out,f=n.output,S=n.avail_out,m=n.next_in,l=n.input,h=n.avail_in,M=s.hold,C=s.bits,L=h,N=S,ne=Z_OK$1;e:for(;;)switch(s.mode){case HEAD:if(s.wrap===0){s.mode=TYPEDO;break}for(;C<16;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if(s.wrap&2&&M===35615){s.check=0,ve[0]=M&255,ve[1]=M>>>8&255,s.check=crc32_1(s.check,ve,2,0),M=0,C=0,s.mode=FLAGS;break}if(s.flags=0,s.head&&(s.head.done=!1),!(s.wrap&1)||(((M&255)<<8)+(M>>8))%31){n.msg="incorrect header check",s.mode=BAD;break}if((M&15)!==Z_DEFLATED){n.msg="unknown compression method",s.mode=BAD;break}if(M>>>=4,C-=4,be=(M&15)+8,s.wbits===0)s.wbits=be;else if(be>s.wbits){n.msg="invalid window size",s.mode=BAD;break}s.dmax=1<<s.wbits,n.adler=s.check=1,s.mode=M&512?DICTID:TYPE,M=0,C=0;break;case FLAGS:for(;C<16;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if(s.flags=M,(s.flags&255)!==Z_DEFLATED){n.msg="unknown compression method",s.mode=BAD;break}if(s.flags&57344){n.msg="unknown header flags set",s.mode=BAD;break}s.head&&(s.head.text=M>>8&1),s.flags&512&&(ve[0]=M&255,ve[1]=M>>>8&255,s.check=crc32_1(s.check,ve,2,0)),M=0,C=0,s.mode=TIME;case TIME:for(;C<32;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}s.head&&(s.head.time=M),s.flags&512&&(ve[0]=M&255,ve[1]=M>>>8&255,ve[2]=M>>>16&255,ve[3]=M>>>24&255,s.check=crc32_1(s.check,ve,4,0)),M=0,C=0,s.mode=OS;case OS:for(;C<16;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}s.head&&(s.head.xflags=M&255,s.head.os=M>>8),s.flags&512&&(ve[0]=M&255,ve[1]=M>>>8&255,s.check=crc32_1(s.check,ve,2,0)),M=0,C=0,s.mode=EXLEN;case EXLEN:if(s.flags&1024){for(;C<16;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}s.length=M,s.head&&(s.head.extra_len=M),s.flags&512&&(ve[0]=M&255,ve[1]=M>>>8&255,s.check=crc32_1(s.check,ve,2,0)),M=0,C=0}else s.head&&(s.head.extra=null);s.mode=EXTRA;case EXTRA:if(s.flags&1024&&(F=s.length,F>h&&(F=h),F&&(s.head&&(be=s.head.extra_len-s.length,s.head.extra||(s.head.extra=new Uint8Array(s.head.extra_len)),s.head.extra.set(l.subarray(m,m+F),be)),s.flags&512&&(s.check=crc32_1(s.check,l,F,m)),h-=F,m+=F,s.length-=F),s.length))break e;s.length=0,s.mode=NAME;case NAME:if(s.flags&2048){if(h===0)break e;F=0;do be=l[m+F++],s.head&&be&&s.length<65536&&(s.head.name+=String.fromCharCode(be));while(be&&F<h);if(s.flags&512&&(s.check=crc32_1(s.check,l,F,m)),h-=F,m+=F,be)break e}else s.head&&(s.head.name=null);s.length=0,s.mode=COMMENT;case COMMENT:if(s.flags&4096){if(h===0)break e;F=0;do be=l[m+F++],s.head&&be&&s.length<65536&&(s.head.comment+=String.fromCharCode(be));while(be&&F<h);if(s.flags&512&&(s.check=crc32_1(s.check,l,F,m)),h-=F,m+=F,be)break e}else s.head&&(s.head.comment=null);s.mode=HCRC;case HCRC:if(s.flags&512){for(;C<16;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if(M!==(s.check&65535)){n.msg="header crc mismatch",s.mode=BAD;break}M=0,C=0}s.head&&(s.head.hcrc=s.flags>>9&1,s.head.done=!0),n.adler=s.check=0,s.mode=TYPE;break;case DICTID:for(;C<32;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}n.adler=s.check=zswap32(M),M=0,C=0,s.mode=DICT;case DICT:if(s.havedict===0)return n.next_out=b,n.avail_out=S,n.next_in=m,n.avail_in=h,s.hold=M,s.bits=C,Z_NEED_DICT$1;n.adler=s.check=1,s.mode=TYPE;case TYPE:if(t===Z_BLOCK||t===Z_TREES)break e;case TYPEDO:if(s.last){M>>>=C&7,C-=C&7,s.mode=CHECK;break}for(;C<3;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}switch(s.last=M&1,M>>>=1,C-=1,M&3){case 0:s.mode=STORED;break;case 1:if(fixedtables(s),s.mode=LEN_,t===Z_TREES){M>>>=2,C-=2;break e}break;case 2:s.mode=TABLE;break;case 3:n.msg="invalid block type",s.mode=BAD}M>>>=2,C-=2;break;case STORED:for(M>>>=C&7,C-=C&7;C<32;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if((M&65535)!==(M>>>16^65535)){n.msg="invalid stored block lengths",s.mode=BAD;break}if(s.length=M&65535,M=0,C=0,s.mode=COPY_,t===Z_TREES)break e;case COPY_:s.mode=COPY;case COPY:if(F=s.length,F){if(F>h&&(F=h),F>S&&(F=S),F===0)break e;f.set(l.subarray(m,m+F),b),h-=F,m+=F,S-=F,b+=F,s.length-=F;break}s.mode=TYPE;break;case TABLE:for(;C<14;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if(s.nlen=(M&31)+257,M>>>=5,C-=5,s.ndist=(M&31)+1,M>>>=5,C-=5,s.ncode=(M&15)+4,M>>>=4,C-=4,s.nlen>286||s.ndist>30){n.msg="too many length or distance symbols",s.mode=BAD;break}s.have=0,s.mode=LENLENS;case LENLENS:for(;s.have<s.ncode;){for(;C<3;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}s.lens[Ie[s.have++]]=M&7,M>>>=3,C-=3}for(;s.have<19;)s.lens[Ie[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,te={bits:s.lenbits},ne=inftrees(CODES,s.lens,0,19,s.lencode,0,s.work,te),s.lenbits=te.bits,ne){n.msg="invalid code lengths set",s.mode=BAD;break}s.have=0,s.mode=CODELENS;case CODELENS:for(;s.have<s.nlen+s.ndist;){for(;K=s.lencode[M&(1<<s.lenbits)-1],X=K>>>24,de=K>>>16&255,Q=K&65535,!(X<=C);){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if(Q<16)M>>>=X,C-=X,s.lens[s.have++]=Q;else{if(Q===16){for(he=X+2;C<he;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if(M>>>=X,C-=X,s.have===0){n.msg="invalid bit length repeat",s.mode=BAD;break}be=s.lens[s.have-1],F=3+(M&3),M>>>=2,C-=2}else if(Q===17){for(he=X+3;C<he;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}M>>>=X,C-=X,be=0,F=3+(M&7),M>>>=3,C-=3}else{for(he=X+7;C<he;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}M>>>=X,C-=X,be=0,F=11+(M&127),M>>>=7,C-=7}if(s.have+F>s.nlen+s.ndist){n.msg="invalid bit length repeat",s.mode=BAD;break}for(;F--;)s.lens[s.have++]=be}}if(s.mode===BAD)break;if(s.lens[256]===0){n.msg="invalid code -- missing end-of-block",s.mode=BAD;break}if(s.lenbits=9,te={bits:s.lenbits},ne=inftrees(LENS,s.lens,0,s.nlen,s.lencode,0,s.work,te),s.lenbits=te.bits,ne){n.msg="invalid literal/lengths set",s.mode=BAD;break}if(s.distbits=6,s.distcode=s.distdyn,te={bits:s.distbits},ne=inftrees(DISTS,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,te),s.distbits=te.bits,ne){n.msg="invalid distances set",s.mode=BAD;break}if(s.mode=LEN_,t===Z_TREES)break e;case LEN_:s.mode=LEN;case LEN:if(h>=6&&S>=258){n.next_out=b,n.avail_out=S,n.next_in=m,n.avail_in=h,s.hold=M,s.bits=C,inffast(n,N),b=n.next_out,f=n.output,S=n.avail_out,m=n.next_in,l=n.input,h=n.avail_in,M=s.hold,C=s.bits,s.mode===TYPE&&(s.back=-1);break}for(s.back=0;K=s.lencode[M&(1<<s.lenbits)-1],X=K>>>24,de=K>>>16&255,Q=K&65535,!(X<=C);){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if(de&&(de&240)===0){for(ie=X,ce=de,ge=Q;K=s.lencode[ge+((M&(1<<ie+ce)-1)>>ie)],X=K>>>24,de=K>>>16&255,Q=K&65535,!(ie+X<=C);){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}M>>>=ie,C-=ie,s.back+=ie}if(M>>>=X,C-=X,s.back+=X,s.length=Q,de===0){s.mode=LIT;break}if(de&32){s.back=-1,s.mode=TYPE;break}if(de&64){n.msg="invalid literal/length code",s.mode=BAD;break}s.extra=de&15,s.mode=LENEXT;case LENEXT:if(s.extra){for(he=s.extra;C<he;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}s.length+=M&(1<<s.extra)-1,M>>>=s.extra,C-=s.extra,s.back+=s.extra}s.was=s.length,s.mode=DIST;case DIST:for(;K=s.distcode[M&(1<<s.distbits)-1],X=K>>>24,de=K>>>16&255,Q=K&65535,!(X<=C);){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if((de&240)===0){for(ie=X,ce=de,ge=Q;K=s.distcode[ge+((M&(1<<ie+ce)-1)>>ie)],X=K>>>24,de=K>>>16&255,Q=K&65535,!(ie+X<=C);){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}M>>>=ie,C-=ie,s.back+=ie}if(M>>>=X,C-=X,s.back+=X,de&64){n.msg="invalid distance code",s.mode=BAD;break}s.offset=Q,s.extra=de&15,s.mode=DISTEXT;case DISTEXT:if(s.extra){for(he=s.extra;C<he;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}s.offset+=M&(1<<s.extra)-1,M>>>=s.extra,C-=s.extra,s.back+=s.extra}if(s.offset>s.dmax){n.msg="invalid distance too far back",s.mode=BAD;break}s.mode=MATCH;case MATCH:if(S===0)break e;if(F=N-S,s.offset>F){if(F=s.offset-F,F>s.whave&&s.sane){n.msg="invalid distance too far back",s.mode=BAD;break}F>s.wnext?(F-=s.wnext,G=s.wsize-F):G=s.wnext-F,F>s.length&&(F=s.length),H=s.window}else H=f,G=b-s.offset,F=s.length;F>S&&(F=S),S-=F,s.length-=F;do f[b++]=H[G++];while(--F);s.length===0&&(s.mode=LEN);break;case LIT:if(S===0)break e;f[b++]=s.length,S--,s.mode=LEN;break;case CHECK:if(s.wrap){for(;C<32;){if(h===0)break e;h--,M|=l[m++]<<C,C+=8}if(N-=S,n.total_out+=N,s.total+=N,N&&(n.adler=s.check=s.flags?crc32_1(s.check,f,N,b-N):adler32_1(s.check,f,N,b-N)),N=S,(s.flags?M:zswap32(M))!==s.check){n.msg="incorrect data check",s.mode=BAD;break}M=0,C=0}s.mode=LENGTH;case LENGTH:if(s.wrap&&s.flags){for(;C<32;){if(h===0)break e;h--,M+=l[m++]<<C,C+=8}if(M!==(s.total&4294967295)){n.msg="incorrect length check",s.mode=BAD;break}M=0,C=0}s.mode=DONE;case DONE:ne=Z_STREAM_END$1;break e;case BAD:ne=Z_DATA_ERROR$1;break e;case MEM:return Z_MEM_ERROR$1;case SYNC:default:return Z_STREAM_ERROR$1}return n.next_out=b,n.avail_out=S,n.next_in=m,n.avail_in=h,s.hold=M,s.bits=C,(s.wsize||N!==n.avail_out&&s.mode<BAD&&(s.mode<CHECK||t!==Z_FINISH$1))&&updatewindow(n,n.output,n.next_out,N-n.avail_out),L-=n.avail_in,N-=n.avail_out,n.total_in+=L,n.total_out+=N,s.total+=N,s.wrap&&N&&(n.adler=s.check=s.flags?crc32_1(s.check,f,N,n.next_out-N):adler32_1(s.check,f,N,n.next_out-N)),n.data_type=s.bits+(s.last?64:0)+(s.mode===TYPE?128:0)+(s.mode===LEN_||s.mode===COPY_?256:0),(L===0&&N===0||t===Z_FINISH$1)&&ne===Z_OK$1&&(ne=Z_BUF_ERROR),ne},inflateEnd=n=>{if(!n||!n.state)return Z_STREAM_ERROR$1;let t=n.state;return t.window&&(t.window=null),n.state=null,Z_OK$1},inflateGetHeader=(n,t)=>{if(!n||!n.state)return Z_STREAM_ERROR$1;const s=n.state;return(s.wrap&2)===0?Z_STREAM_ERROR$1:(s.head=t,t.done=!1,Z_OK$1)},inflateSetDictionary=(n,t)=>{const s=t.length;let l,f,m;return!n||!n.state||(l=n.state,l.wrap!==0&&l.mode!==DICT)?Z_STREAM_ERROR$1:l.mode===DICT&&(f=1,f=adler32_1(f,t,s,0),f!==l.check)?Z_DATA_ERROR$1:(m=updatewindow(n,t,s,s),m?(l.mode=MEM,Z_MEM_ERROR$1):(l.havedict=1,Z_OK$1))};var inflateReset_1=inflateReset,inflateReset2_1=inflateReset2,inflateResetKeep_1=inflateResetKeep,inflateInit_1=inflateInit,inflateInit2_1=inflateInit2,inflate_2$1=inflate$2,inflateEnd_1=inflateEnd,inflateGetHeader_1=inflateGetHeader,inflateSetDictionary_1=inflateSetDictionary,inflateInfo="pako inflate (from Nodeca project)",inflate_1$2={inflateReset:inflateReset_1,inflateReset2:inflateReset2_1,inflateResetKeep:inflateResetKeep_1,inflateInit:inflateInit_1,inflateInit2:inflateInit2_1,inflate:inflate_2$1,inflateEnd:inflateEnd_1,inflateGetHeader:inflateGetHeader_1,inflateSetDictionary:inflateSetDictionary_1,inflateInfo};function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var gzheader=GZheader;const toString$3=Object.prototype.toString,{Z_NO_FLUSH,Z_FINISH,Z_OK,Z_STREAM_END,Z_NEED_DICT,Z_STREAM_ERROR,Z_DATA_ERROR,Z_MEM_ERROR}=constants$2$1;function Inflate$1(n){this.options=common.assign({chunkSize:1024*64,windowBits:15,to:""},n||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),t.windowBits>=0&&t.windowBits<16&&!(n&&n.windowBits)&&(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(t.windowBits&15)===0&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let s=inflate_1$2.inflateInit2(this.strm,t.windowBits);if(s!==Z_OK)throw new Error(messages[s]);if(this.header=new gzheader,inflate_1$2.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=strings.string2buf(t.dictionary):toString$3.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(s=inflate_1$2.inflateSetDictionary(this.strm,t.dictionary),s!==Z_OK)))throw new Error(messages[s])}Inflate$1.prototype.push=function(n,t){const s=this.strm,l=this.options.chunkSize,f=this.options.dictionary;let m,b,h;if(this.ended)return!1;for(t===~~t?b=t:b=t===!0?Z_FINISH:Z_NO_FLUSH,toString$3.call(n)==="[object ArrayBuffer]"?s.input=new Uint8Array(n):s.input=n,s.next_in=0,s.avail_in=s.input.length;;){for(s.avail_out===0&&(s.output=new Uint8Array(l),s.next_out=0,s.avail_out=l),m=inflate_1$2.inflate(s,b),m===Z_NEED_DICT&&f&&(m=inflate_1$2.inflateSetDictionary(s,f),m===Z_OK?m=inflate_1$2.inflate(s,b):m===Z_DATA_ERROR&&(m=Z_NEED_DICT));s.avail_in>0&&m===Z_STREAM_END&&s.state.wrap>0&&n[s.next_in]!==0;)inflate_1$2.inflateReset(s),m=inflate_1$2.inflate(s,b);switch(m){case Z_STREAM_ERROR:case Z_DATA_ERROR:case Z_NEED_DICT:case Z_MEM_ERROR:return this.onEnd(m),this.ended=!0,!1}if(h=s.avail_out,s.next_out&&(s.avail_out===0||m===Z_STREAM_END))if(this.options.to==="string"){let S=strings.utf8border(s.output,s.next_out),M=s.next_out-S,C=strings.buf2string(s.output,S);s.next_out=M,s.avail_out=l-M,M&&s.output.set(s.output.subarray(S,S+M),0),this.onData(C)}else this.onData(s.output.length===s.next_out?s.output:s.output.subarray(0,s.next_out));if(!(m===Z_OK&&h===0)){if(m===Z_STREAM_END)return m=inflate_1$2.inflateEnd(this.strm),this.onEnd(m),this.ended=!0,!0;if(s.avail_in===0)break}}return!0};Inflate$1.prototype.onData=function(n){this.chunks.push(n)};Inflate$1.prototype.onEnd=function(n){n===Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};function inflate$1(n,t){const s=new Inflate$1(t);if(s.push(n),s.err)throw s.msg||messages[s.err];return s.result}function inflateRaw$1(n,t){return t=t||{},t.raw=!0,inflate$1(n,t)}var Inflate_1$1=Inflate$1,inflate_2=inflate$1,inflateRaw_1$1=inflateRaw$1,ungzip$1=inflate$1,constants$5=constants$2$1,inflate_1$1={Inflate:Inflate_1$1,inflate:inflate_2,inflateRaw:inflateRaw_1$1,ungzip:ungzip$1,constants:constants$5};const{Deflate,deflate,deflateRaw,gzip}=deflate_1$1,{Inflate,inflate,inflateRaw,ungzip}=inflate_1$1;var deflate_1=deflate,Inflate_1=Inflate,inflate_1=inflate;const pngSignature=[137,80,78,71,13,10,26,10],crcTable=[];for(let n=0;n<256;n++){let t=n;for(let s=0;s<8;s++)t&1?t=3988292384^t>>>1:t=t>>>1;crcTable[n]=t}const initialCrc=4294967295;function updateCrc(n,t,s){let l=n;for(let f=0;f<s;f++)l=crcTable[(l^t[f])&255]^l>>>8;return l}function crc(n,t){return(updateCrc(initialCrc,n,t)^initialCrc)>>>0}var ColorType;(function(n){n[n.UNKNOWN=-1]="UNKNOWN",n[n.GREYSCALE=0]="GREYSCALE",n[n.TRUECOLOUR=2]="TRUECOLOUR",n[n.INDEXED_COLOUR=3]="INDEXED_COLOUR",n[n.GREYSCALE_ALPHA=4]="GREYSCALE_ALPHA",n[n.TRUECOLOUR_ALPHA=6]="TRUECOLOUR_ALPHA"})(ColorType||(ColorType={}));var CompressionMethod;(function(n){n[n.UNKNOWN=-1]="UNKNOWN",n[n.DEFLATE=0]="DEFLATE"})(CompressionMethod||(CompressionMethod={}));var FilterMethod;(function(n){n[n.UNKNOWN=-1]="UNKNOWN",n[n.ADAPTIVE=0]="ADAPTIVE"})(FilterMethod||(FilterMethod={}));var InterlaceMethod;(function(n){n[n.UNKNOWN=-1]="UNKNOWN",n[n.NO_INTERLACE=0]="NO_INTERLACE",n[n.ADAM7=1]="ADAM7"})(InterlaceMethod||(InterlaceMethod={}));const empty=new Uint8Array(0),NULL="\0",uint16=new Uint16Array([255]),uint8=new Uint8Array(uint16.buffer),osIsLittleEndian=uint8[0]===255;class PngDecoder extends IOBuffer$4{constructor(t,s={}){super(t);const{checkCrc:l=!1}=s;this._checkCrc=l,this._inflator=new Inflate_1,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._end=!1,this._hasPalette=!1,this._palette=[],this._compressionMethod=CompressionMethod.UNKNOWN,this._filterMethod=FilterMethod.UNKNOWN,this._interlaceMethod=InterlaceMethod.UNKNOWN,this._colorType=-1,this.setBigEndian()}decode(){for(this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(let t=0;t<pngSignature.length;t++)if(this.readUint8()!==pngSignature[t])throw new Error(`wrong PNG signature. Byte at ${t} should be ${pngSignature[t]}.`)}decodeChunk(){const t=this.readUint32(),s=this.readChars(4),l=this.offset;switch(s){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(t);break;case"IDAT":this.decodeIDAT(t);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(t);break;case"iCCP":this.decodeiCCP(t);break;case"tEXt":this.decodetEXt(t);break;case"pHYs":this.decodepHYs();break;default:this.skip(t);break}if(this.offset-l!==t)throw new Error(`Length mismatch while decoding chunk ${s}`);if(this._checkCrc){const f=this.readUint32(),m=t+4,b=crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-m-4,m),m);if(b!==f)throw new Error(`CRC mismatch for chunk ${s}. Expected ${f}, found ${b}`)}else this.skip(4)}decodeIHDR(){const t=this._png;t.width=this.readUint32(),t.height=this.readUint32(),t.depth=checkBitDepth(this.readUint8());const s=this.readUint8();this._colorType=s;let l;switch(s){case ColorType.GREYSCALE:l=1;break;case ColorType.TRUECOLOUR:l=3;break;case ColorType.INDEXED_COLOUR:l=1;break;case ColorType.GREYSCALE_ALPHA:l=2;break;case ColorType.TRUECOLOUR_ALPHA:l=4;break;default:throw new Error(`Unknown color type: ${s}`)}if(this._png.channels=l,this._compressionMethod=this.readUint8(),this._compressionMethod!==CompressionMethod.DEFLATE)throw new Error(`Unsupported compression method: ${this._compressionMethod}`);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodePLTE(t){if(t%3!==0)throw new RangeError(`PLTE field length must be a multiple of 3. Got ${t}`);const s=t/3;this._hasPalette=!0;const l=[];this._palette=l;for(let f=0;f<s;f++)l.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(t){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,t)),this.skip(t)}decodetRNS(t){if(this._colorType===3){if(t>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${t} vs ${this._palette.length})`);let s=0;for(;s<t;s++){const l=this.readByte();this._palette[s].push(l)}for(;s<this._palette.length;s++)this._palette[s].push(255)}}decodeiCCP(t){let s="",l;for(;(l=this.readChar())!==NULL;)s+=l;const f=this.readUint8();if(f!==CompressionMethod.DEFLATE)throw new Error(`Unsupported iCCP compression method: ${f}`);const m=this.readBytes(t-s.length-2);this._png.iccEmbeddedProfile={name:s,profile:inflate_1(m)}}decodetEXt(t){let s="",l;for(;(l=this.readChar())!==NULL;)s+=l;this._png.text[s]=this.readChars(t-s.length-1)}decodepHYs(){const t=this.readUint32(),s=this.readUint32(),l=this.readByte();this._png.resolution={x:t,y:s,unit:l}}decodeImage(){if(this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);const t=this._inflator.result;if(this._filterMethod!==FilterMethod.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod===InterlaceMethod.NO_INTERLACE)this.decodeInterlaceNull(t);else throw new Error(`Interlace method ${this._interlaceMethod} not supported`)}decodeInterlaceNull(t){const s=this._png.height,l=this._png.channels*this._png.depth/8,f=this._png.width*l,m=new Uint8Array(this._png.height*f);let b=empty,h=0,S,M;for(let C=0;C<s;C++){switch(S=t.subarray(h+1,h+1+f),M=m.subarray(C*f,(C+1)*f),t[h]){case 0:unfilterNone(S,M,f);break;case 1:unfilterSub(S,M,f,l);break;case 2:unfilterUp(S,M,b,f);break;case 3:unfilterAverage(S,M,b,f,l);break;case 4:unfilterPaeth(S,M,b,f,l);break;default:throw new Error(`Unsupported filter: ${t[h]}`)}b=M,h+=f+1}if(this._hasPalette&&(this._png.palette=this._palette),this._png.depth===16){const C=new Uint16Array(m.buffer);if(osIsLittleEndian)for(let L=0;L<C.length;L++)C[L]=swap16(C[L]);this._png.data=C}else this._png.data=m}}function unfilterNone(n,t,s){for(let l=0;l<s;l++)t[l]=n[l]}function unfilterSub(n,t,s,l){let f=0;for(;f<l;f++)t[f]=n[f];for(;f<s;f++)t[f]=n[f]+t[f-l]&255}function unfilterUp(n,t,s,l){let f=0;if(s.length===0)for(;f<l;f++)t[f]=n[f];else for(;f<l;f++)t[f]=n[f]+s[f]&255}function unfilterAverage(n,t,s,l,f){let m=0;if(s.length===0){for(;m<f;m++)t[m]=n[m];for(;m<l;m++)t[m]=n[m]+(t[m-f]>>1)&255}else{for(;m<f;m++)t[m]=n[m]+(s[m]>>1)&255;for(;m<l;m++)t[m]=n[m]+(t[m-f]+s[m]>>1)&255}}function unfilterPaeth(n,t,s,l,f){let m=0;if(s.length===0){for(;m<f;m++)t[m]=n[m];for(;m<l;m++)t[m]=n[m]+t[m-f]&255}else{for(;m<f;m++)t[m]=n[m]+s[m]&255;for(;m<l;m++)t[m]=n[m]+paethPredictor(t[m-f],s[m],s[m-f])&255}}function paethPredictor(n,t,s){const l=n+t-s,f=Math.abs(l-n),m=Math.abs(l-t),b=Math.abs(l-s);return f<=m&&f<=b?n:m<=b?t:s}function swap16(n){return(n&255)<<8|n>>8&255}function checkBitDepth(n){if(n!==1&&n!==2&&n!==4&&n!==8&&n!==16)throw new Error(`invalid bit depth: ${n}`);return n}const defaultZlibOptions={level:3};class PngEncoder extends IOBuffer$4{constructor(t,s={}){super(),this._colorType=ColorType.UNKNOWN,this._zlibOptions=Object.assign({},defaultZlibOptions,s.zlib),this._png=this._checkData(t),this.setBigEndian()}encode(){return this.encodeSignature(),this.encodeIHDR(),this.encodeData(),this.encodeIEND(),this.toArray()}encodeSignature(){this.writeBytes(pngSignature)}encodeIHDR(){this.writeUint32(13),this.writeChars("IHDR"),this.writeUint32(this._png.width),this.writeUint32(this._png.height),this.writeByte(this._png.depth),this.writeByte(this._colorType),this.writeByte(CompressionMethod.DEFLATE),this.writeByte(FilterMethod.ADAPTIVE),this.writeByte(InterlaceMethod.NO_INTERLACE),this.writeCrc(17)}encodeIEND(){this.writeUint32(0),this.writeChars("IEND"),this.writeCrc(4)}encodeIDAT(t){this.writeUint32(t.length),this.writeChars("IDAT"),this.writeBytes(t),this.writeCrc(t.length+4)}encodeData(){const{width:t,height:s,channels:l,depth:f,data:m}=this._png,b=l*t,h=new IOBuffer$4().setBigEndian();let S=0;for(let L=0;L<s;L++)if(h.writeByte(0),f===8)S=writeDataBytes(m,h,b,S);else if(f===16)S=writeDataUint16(m,h,b,S);else throw new Error("unreachable");const M=h.toArray(),C=deflate_1(M,this._zlibOptions);this.encodeIDAT(C)}_checkData(t){const{colorType:s,channels:l,depth:f}=getColorType(t),m={width:checkInteger(t.width,"width"),height:checkInteger(t.height,"height"),channels:l,data:t.data,depth:f,text:{}};this._colorType=s;const b=m.width*m.height*l;if(m.data.length!==b)throw new RangeError(`wrong data size. Found ${m.data.length}, expected ${b}`);return m}writeCrc(t){this.writeUint32(crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-t,t),t))}}function checkInteger(n,t){if(Number.isInteger(n)&&n>0)return n;throw new TypeError(`${t} must be a positive integer`)}function getColorType(n){const{channels:t=4,depth:s=8}=n;if(t!==4&&t!==3&&t!==2&&t!==1)throw new RangeError(`unsupported number of channels: ${t}`);if(s!==8&&s!==16)throw new RangeError(`unsupported bit depth: ${s}`);const l={channels:t,depth:s,colorType:ColorType.UNKNOWN};switch(t){case 4:l.colorType=ColorType.TRUECOLOUR_ALPHA;break;case 3:l.colorType=ColorType.TRUECOLOUR;break;case 1:l.colorType=ColorType.GREYSCALE;break;case 2:l.colorType=ColorType.GREYSCALE_ALPHA;break;default:throw new Error("unsupported number of channels")}return l}function writeDataBytes(n,t,s,l){for(let f=0;f<s;f++)t.writeByte(n[l++]);return l}function writeDataUint16(n,t,s,l){for(let f=0;f<s;f++)t.writeUint16(n[l++]);return l}var ResolutionUnitSpecifier;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.METRE=1]="METRE"})(ResolutionUnitSpecifier||(ResolutionUnitSpecifier={}));function decodePng(n,t){return new PngDecoder(n,t).decode()}function encodePng$1(n,t){return new PngEncoder(n,t).encode()}var encoder$1={exports:{}};(function(n){function t(l){var f=Math.floor,m=new Array(64),b=new Array(64),h=new Array(64),S=new Array(64),M,C,L,N,F=new Array(65535),G=new Array(65535),H=new Array(64),K=new Array(64),X=[],de=0,Q=7,ie=new Array(64),ce=new Array(64),ge=new Array(64),be=new Array(256),ne=new Array(2048),ve,te=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],he=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],Ie=[0,1,2,3,4,5,6,7,8,9,10,11],Oe=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],tt=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],it=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],Ct=[0,1,2,3,4,5,6,7,8,9,10,11],Rt=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],xt=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function Vt(je){for(var jt=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],Wt=0;Wt<64;Wt++){var Qt=f((jt[Wt]*je+50)/100);Qt<1?Qt=1:Qt>255&&(Qt=255),m[te[Wt]]=Qt}for(var ni=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],gt=0;gt<64;gt++){var Ai=f((ni[gt]*je+50)/100);Ai<1?Ai=1:Ai>255&&(Ai=255),b[te[gt]]=Ai}for(var ci=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],Lt=0,$t=0;$t<8;$t++)for(var _t=0;_t<8;_t++)h[Lt]=1/(m[te[Lt]]*ci[$t]*ci[_t]*8),S[Lt]=1/(b[te[Lt]]*ci[$t]*ci[_t]*8),Lt++}function It(je,jt){for(var Wt=0,Qt=0,ni=new Array,gt=1;gt<=16;gt++){for(var Ai=1;Ai<=je[gt];Ai++)ni[jt[Qt]]=[],ni[jt[Qt]][0]=Wt,ni[jt[Qt]][1]=gt,Qt++,Wt++;Wt*=2}return ni}function Xt(){M=It(he,Ie),C=It(it,Ct),L=It(Oe,tt),N=It(Rt,xt)}function Jt(){for(var je=1,jt=2,Wt=1;Wt<=15;Wt++){for(var Qt=je;Qt<jt;Qt++)G[32767+Qt]=Wt,F[32767+Qt]=[],F[32767+Qt][1]=Wt,F[32767+Qt][0]=Qt;for(var ni=-(jt-1);ni<=-je;ni++)G[32767+ni]=Wt,F[32767+ni]=[],F[32767+ni][1]=Wt,F[32767+ni][0]=jt-1+ni;je<<=1,jt<<=1}}function nt(){for(var je=0;je<256;je++)ne[je]=19595*je,ne[je+256>>0]=38470*je,ne[je+512>>0]=7471*je+32768,ne[je+768>>0]=-11059*je,ne[je+1024>>0]=-21709*je,ne[je+1280>>0]=32768*je+8421375,ne[je+1536>>0]=-27439*je,ne[je+1792>>0]=-5329*je}function mt(je){for(var jt=je[0],Wt=je[1]-1;Wt>=0;)jt&1<<Wt&&(de|=1<<Q),Wt--,Q--,Q<0&&(de==255?(ft(255),ft(0)):ft(de),Q=7,de=0)}function ft(je){X.push(je)}function Dt(je){ft(je>>8&255),ft(je&255)}function qt(je,jt){var Wt,Qt,ni,gt,Ai,ci,Lt,$t,_t=0,hi,_i=8,wi=64;for(hi=0;hi<_i;++hi){Wt=je[_t],Qt=je[_t+1],ni=je[_t+2],gt=je[_t+3],Ai=je[_t+4],ci=je[_t+5],Lt=je[_t+6],$t=je[_t+7];var Ht=Wt+$t,ui=Wt-$t,Li=Qt+Lt,zi=Qt-Lt,Fi=ni+ci,tr=ni-ci,Br=gt+Ai,Rr=gt-Ai,Er=Ht+Br,er=Ht-Br,ur=Li+Fi,mr=Li-Fi;je[_t]=Er+ur,je[_t+4]=Er-ur;var yr=(mr+er)*.707106781;je[_t+2]=er+yr,je[_t+6]=er-yr,Er=Rr+tr,ur=tr+zi,mr=zi+ui;var Sr=(Er-mr)*.382683433,Lr=.5411961*Er+Sr,_e=1.306562965*mr+Sr,J=ur*.707106781,j=ui+J,Y=ui-J;je[_t+5]=Y+Lr,je[_t+3]=Y-Lr,je[_t+1]=j+_e,je[_t+7]=j-_e,_t+=8}for(_t=0,hi=0;hi<_i;++hi){Wt=je[_t],Qt=je[_t+8],ni=je[_t+16],gt=je[_t+24],Ai=je[_t+32],ci=je[_t+40],Lt=je[_t+48],$t=je[_t+56];var le=Wt+$t,pe=Wt-$t,Ce=Qt+Lt,Be=Qt-Lt,Le=ni+ci,De=ni-ci,Ve=gt+Ai,Ke=gt-Ai,ct=le+Ve,Qe=le-Ve,Pt=Ce+Le,bt=Ce-Le;je[_t]=ct+Pt,je[_t+32]=ct-Pt;var Bt=(bt+Qe)*.707106781;je[_t+16]=Qe+Bt,je[_t+48]=Qe-Bt,ct=Ke+De,Pt=De+Be,bt=Be+pe;var Yt=(ct-bt)*.382683433,Ne=.5411961*ct+Yt,Ei=1.306562965*bt+Yt,Mt=Pt*.707106781,Si=pe+Mt,Ii=pe-Mt;je[_t+40]=Ii+Ne,je[_t+24]=Ii-Ne,je[_t+8]=Si+Ei,je[_t+56]=Si-Ei,_t++}var Zr;for(hi=0;hi<wi;++hi)Zr=je[hi]*jt[hi],H[hi]=Zr>0?Zr+.5|0:Zr-.5|0;return H}function oi(){Dt(65504),Dt(16),ft(74),ft(70),ft(73),ft(70),ft(0),ft(1),ft(1),ft(0),Dt(1),Dt(1),ft(0),ft(0)}function ti(je){if(!!je){Dt(65505),je[0]===69&&je[1]===120&&je[2]===105&&je[3]===102?Dt(je.length+2):(Dt(je.length+5+2),ft(69),ft(120),ft(105),ft(102),ft(0));for(var jt=0;jt<je.length;jt++)ft(je[jt])}}function fi(je,jt){Dt(65472),Dt(17),ft(8),Dt(jt),Dt(je),ft(3),ft(1),ft(17),ft(0),ft(2),ft(17),ft(1),ft(3),ft(17),ft(1)}function si(){Dt(65499),Dt(132),ft(0);for(var je=0;je<64;je++)ft(m[je]);ft(1);for(var jt=0;jt<64;jt++)ft(b[jt])}function Ot(){Dt(65476),Dt(418),ft(0);for(var je=0;je<16;je++)ft(he[je+1]);for(var jt=0;jt<=11;jt++)ft(Ie[jt]);ft(16);for(var Wt=0;Wt<16;Wt++)ft(Oe[Wt+1]);for(var Qt=0;Qt<=161;Qt++)ft(tt[Qt]);ft(1);for(var ni=0;ni<16;ni++)ft(it[ni+1]);for(var gt=0;gt<=11;gt++)ft(Ct[gt]);ft(17);for(var Ai=0;Ai<16;Ai++)ft(Rt[Ai+1]);for(var ci=0;ci<=161;ci++)ft(xt[ci])}function ai(){Dt(65498),Dt(12),ft(3),ft(1),ft(0),ft(2),ft(17),ft(3),ft(17),ft(0),ft(63),ft(0)}function Nt(je,jt,Wt,Qt,ni){for(var gt=ni[0],Ai=ni[240],ci,Lt=16,$t=63,_t=64,hi=qt(je,jt),_i=0;_i<_t;++_i)K[te[_i]]=hi[_i];var wi=K[0]-Wt;Wt=K[0],wi==0?mt(Qt[0]):(ci=32767+wi,mt(Qt[G[ci]]),mt(F[ci]));for(var Ht=63;Ht>0&&K[Ht]==0;Ht--);if(Ht==0)return mt(gt),Wt;for(var ui=1,Li;ui<=Ht;){for(var zi=ui;K[ui]==0&&ui<=Ht;++ui);var Fi=ui-zi;if(Fi>=Lt){Li=Fi>>4;for(var tr=1;tr<=Li;++tr)mt(Ai);Fi=Fi&15}ci=32767+K[ui],mt(ni[(Fi<<4)+G[ci]]),mt(F[ci]),ui++}return Ht!=$t&&mt(gt),Wt}function dt(){for(var je=String.fromCharCode,jt=0;jt<256;jt++)be[jt]=je(jt)}this.encode=function(je,jt){new Date().getTime(),jt&&gi(jt),X=new Array,de=0,Q=7,Dt(65496),oi(),ti(je.exifBuffer),si(),fi(je.width,je.height),Ot(),ai();var Wt=0,Qt=0,ni=0;de=0,Q=7,this.encode.displayName="_encode_";for(var gt=je.data,Ai=je.width,ci=je.height,Lt=Ai*4,$t,_t=0,hi,_i,wi,Ht,ui,Li,zi,Fi;_t<ci;){for($t=0;$t<Lt;){for(Ht=Lt*_t+$t,ui=Ht,Li=-1,zi=0,Fi=0;Fi<64;Fi++)zi=Fi>>3,Li=(Fi&7)*4,ui=Ht+zi*Lt+Li,_t+zi>=ci&&(ui-=Lt*(_t+1+zi-ci)),$t+Li>=Lt&&(ui-=$t+Li-Lt+4),hi=gt[ui++],_i=gt[ui++],wi=gt[ui++],ie[Fi]=(ne[hi]+ne[_i+256>>0]+ne[wi+512>>0]>>16)-128,ce[Fi]=(ne[hi+768>>0]+ne[_i+1024>>0]+ne[wi+1280>>0]>>16)-128,ge[Fi]=(ne[hi+1280>>0]+ne[_i+1536>>0]+ne[wi+1792>>0]>>16)-128;Wt=Nt(ie,h,Wt,M,L),Qt=Nt(ce,S,Qt,C,N),ni=Nt(ge,S,ni,C,N),$t+=32}_t+=8}if(Q>=0){var tr=[];tr[1]=Q+1,tr[0]=(1<<Q+1)-1,mt(tr)}return Dt(65497),Buffer.from(X)};function gi(je){if(je<=0&&(je=1),je>100&&(je=100),ve!=je){var jt=0;je<50?jt=Math.floor(5e3/je):jt=Math.floor(200-je*2),Vt(jt),ve=je}}function Et(){var je=new Date().getTime();l||(l=50),dt(),Xt(),Jt(),nt(),gi(l),new Date().getTime()-je}Et()}n.exports=s;function s(l,f){typeof f=="undefined"&&(f=50);var m=new t(f),b=m.encode(l,f);return{data:b,width:l.width,height:l.height}}})(encoder$1);var decoder$1={exports:{}};(function(n){var t=function(){var f=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),m=4017,b=799,h=3406,S=2276,M=1567,C=3784,L=5793,N=2896;function F(){}function G(ce,ge){for(var be=0,ne=[],ve,te,he=16;he>0&&!ce[he-1];)he--;ne.push({children:[],index:0});var Ie=ne[0],Oe;for(ve=0;ve<he;ve++){for(te=0;te<ce[ve];te++){for(Ie=ne.pop(),Ie.children[Ie.index]=ge[be];Ie.index>0;){if(ne.length===0)throw new Error("Could not recreate Huffman Table");Ie=ne.pop()}for(Ie.index++,ne.push(Ie);ne.length<=ve;)ne.push(Oe={children:[],index:0}),Ie.children[Ie.index]=Oe.children,Ie=Oe;be++}ve+1<he&&(ne.push(Oe={children:[],index:0}),Ie.children[Ie.index]=Oe.children,Ie=Oe)}return ne[0].children}function H(ce,ge,be,ne,ve,te,he,Ie,Oe,tt){be.precision,be.samplesPerLine,be.scanLines;var it=be.mcusPerLine,Ct=be.progressive;be.maxH,be.maxV;var Rt=ge,xt=0,Vt=0;function It(){if(Vt>0)return Vt--,xt>>Vt&1;if(xt=ce[ge++],xt==255){var Lt=ce[ge++];if(Lt)throw new Error("unexpected marker: "+(xt<<8|Lt).toString(16))}return Vt=7,xt>>>7}function Xt(Lt){for(var $t=Lt,_t;(_t=It())!==null;){if($t=$t[_t],typeof $t=="number")return $t;if(typeof $t!="object")throw new Error("invalid huffman sequence")}return null}function Jt(Lt){for(var $t=0;Lt>0;){var _t=It();if(_t===null)return;$t=$t<<1|_t,Lt--}return $t}function nt(Lt){var $t=Jt(Lt);return $t>=1<<Lt-1?$t:$t+(-1<<Lt)+1}function mt(Lt,$t){var _t=Xt(Lt.huffmanTableDC),hi=_t===0?0:nt(_t);$t[0]=Lt.pred+=hi;for(var _i=1;_i<64;){var wi=Xt(Lt.huffmanTableAC),Ht=wi&15,ui=wi>>4;if(Ht===0){if(ui<15)break;_i+=16;continue}_i+=ui;var Li=f[_i];$t[Li]=nt(Ht),_i++}}function ft(Lt,$t){var _t=Xt(Lt.huffmanTableDC),hi=_t===0?0:nt(_t)<<Oe;$t[0]=Lt.pred+=hi}function Dt(Lt,$t){$t[0]|=It()<<Oe}var qt=0;function oi(Lt,$t){if(qt>0){qt--;return}for(var _t=te,hi=he;_t<=hi;){var _i=Xt(Lt.huffmanTableAC),wi=_i&15,Ht=_i>>4;if(wi===0){if(Ht<15){qt=Jt(Ht)+(1<<Ht)-1;break}_t+=16;continue}_t+=Ht;var ui=f[_t];$t[ui]=nt(wi)*(1<<Oe),_t++}}var ti=0,fi;function si(Lt,$t){for(var _t=te,hi=he,_i=0;_t<=hi;){var wi=f[_t],Ht=$t[wi]<0?-1:1;switch(ti){case 0:var ui=Xt(Lt.huffmanTableAC),Li=ui&15,_i=ui>>4;if(Li===0)_i<15?(qt=Jt(_i)+(1<<_i),ti=4):(_i=16,ti=1);else{if(Li!==1)throw new Error("invalid ACn encoding");fi=nt(Li),ti=_i?2:3}continue;case 1:case 2:$t[wi]?$t[wi]+=(It()<<Oe)*Ht:(_i--,_i===0&&(ti=ti==2?3:0));break;case 3:$t[wi]?$t[wi]+=(It()<<Oe)*Ht:($t[wi]=fi<<Oe,ti=0);break;case 4:$t[wi]&&($t[wi]+=(It()<<Oe)*Ht);break}_t++}ti===4&&(qt--,qt===0&&(ti=0))}function Ot(Lt,$t,_t,hi,_i){var wi=_t/it|0,Ht=_t%it,ui=wi*Lt.v+hi,Li=Ht*Lt.h+_i;Lt.blocks[ui]===void 0&&tt.tolerantDecoding||$t(Lt,Lt.blocks[ui][Li])}function ai(Lt,$t,_t){var hi=_t/Lt.blocksPerLine|0,_i=_t%Lt.blocksPerLine;Lt.blocks[hi]===void 0&&tt.tolerantDecoding||$t(Lt,Lt.blocks[hi][_i])}var Nt=ne.length,dt,gi,Et,je,jt,Wt;Ct?te===0?Wt=Ie===0?ft:Dt:Wt=Ie===0?oi:si:Wt=mt;var Qt=0,ni,gt;Nt==1?gt=ne[0].blocksPerLine*ne[0].blocksPerColumn:gt=it*be.mcusPerColumn,ve||(ve=gt);for(var Ai,ci;Qt<gt;){for(gi=0;gi<Nt;gi++)ne[gi].pred=0;if(qt=0,Nt==1)for(dt=ne[0],jt=0;jt<ve;jt++)ai(dt,Wt,Qt),Qt++;else for(jt=0;jt<ve;jt++){for(gi=0;gi<Nt;gi++)for(dt=ne[gi],Ai=dt.h,ci=dt.v,Et=0;Et<ci;Et++)for(je=0;je<Ai;je++)Ot(dt,Wt,Qt,Et,je);if(Qt++,Qt===gt)break}if(Qt===gt)do{if(ce[ge]===255&&ce[ge+1]!==0)break;ge+=1}while(ge<ce.length-2);if(Vt=0,ni=ce[ge]<<8|ce[ge+1],ni<65280)throw new Error("marker was not found");if(ni>=65488&&ni<=65495)ge+=2;else break}return ge-Rt}function K(ce,ge){var be=[],ne=ge.blocksPerLine,ve=ge.blocksPerColumn,te=ne<<3,he=new Int32Array(64),Ie=new Uint8Array(64);function Oe(Jt,nt,mt){var ft=ge.quantizationTable,Dt,qt,oi,ti,fi,si,Ot,ai,Nt,dt=mt,gi;for(gi=0;gi<64;gi++)dt[gi]=Jt[gi]*ft[gi];for(gi=0;gi<8;++gi){var Et=8*gi;if(dt[1+Et]==0&&dt[2+Et]==0&&dt[3+Et]==0&&dt[4+Et]==0&&dt[5+Et]==0&&dt[6+Et]==0&&dt[7+Et]==0){Nt=L*dt[0+Et]+512>>10,dt[0+Et]=Nt,dt[1+Et]=Nt,dt[2+Et]=Nt,dt[3+Et]=Nt,dt[4+Et]=Nt,dt[5+Et]=Nt,dt[6+Et]=Nt,dt[7+Et]=Nt;continue}Dt=L*dt[0+Et]+128>>8,qt=L*dt[4+Et]+128>>8,oi=dt[2+Et],ti=dt[6+Et],fi=N*(dt[1+Et]-dt[7+Et])+128>>8,ai=N*(dt[1+Et]+dt[7+Et])+128>>8,si=dt[3+Et]<<4,Ot=dt[5+Et]<<4,Nt=Dt-qt+1>>1,Dt=Dt+qt+1>>1,qt=Nt,Nt=oi*C+ti*M+128>>8,oi=oi*M-ti*C+128>>8,ti=Nt,Nt=fi-Ot+1>>1,fi=fi+Ot+1>>1,Ot=Nt,Nt=ai+si+1>>1,si=ai-si+1>>1,ai=Nt,Nt=Dt-ti+1>>1,Dt=Dt+ti+1>>1,ti=Nt,Nt=qt-oi+1>>1,qt=qt+oi+1>>1,oi=Nt,Nt=fi*S+ai*h+2048>>12,fi=fi*h-ai*S+2048>>12,ai=Nt,Nt=si*b+Ot*m+2048>>12,si=si*m-Ot*b+2048>>12,Ot=Nt,dt[0+Et]=Dt+ai,dt[7+Et]=Dt-ai,dt[1+Et]=qt+Ot,dt[6+Et]=qt-Ot,dt[2+Et]=oi+si,dt[5+Et]=oi-si,dt[3+Et]=ti+fi,dt[4+Et]=ti-fi}for(gi=0;gi<8;++gi){var je=gi;if(dt[8+je]==0&&dt[16+je]==0&&dt[24+je]==0&&dt[32+je]==0&&dt[40+je]==0&&dt[48+je]==0&&dt[56+je]==0){Nt=L*mt[gi+0]+8192>>14,dt[0+je]=Nt,dt[8+je]=Nt,dt[16+je]=Nt,dt[24+je]=Nt,dt[32+je]=Nt,dt[40+je]=Nt,dt[48+je]=Nt,dt[56+je]=Nt;continue}Dt=L*dt[0+je]+2048>>12,qt=L*dt[32+je]+2048>>12,oi=dt[16+je],ti=dt[48+je],fi=N*(dt[8+je]-dt[56+je])+2048>>12,ai=N*(dt[8+je]+dt[56+je])+2048>>12,si=dt[24+je],Ot=dt[40+je],Nt=Dt-qt+1>>1,Dt=Dt+qt+1>>1,qt=Nt,Nt=oi*C+ti*M+2048>>12,oi=oi*M-ti*C+2048>>12,ti=Nt,Nt=fi-Ot+1>>1,fi=fi+Ot+1>>1,Ot=Nt,Nt=ai+si+1>>1,si=ai-si+1>>1,ai=Nt,Nt=Dt-ti+1>>1,Dt=Dt+ti+1>>1,ti=Nt,Nt=qt-oi+1>>1,qt=qt+oi+1>>1,oi=Nt,Nt=fi*S+ai*h+2048>>12,fi=fi*h-ai*S+2048>>12,ai=Nt,Nt=si*b+Ot*m+2048>>12,si=si*m-Ot*b+2048>>12,Ot=Nt,dt[0+je]=Dt+ai,dt[56+je]=Dt-ai,dt[8+je]=qt+Ot,dt[48+je]=qt-Ot,dt[16+je]=oi+si,dt[40+je]=oi-si,dt[24+je]=ti+fi,dt[32+je]=ti-fi}for(gi=0;gi<64;++gi){var jt=128+(dt[gi]+8>>4);nt[gi]=jt<0?0:jt>255?255:jt}}ie(te*ve*8);for(var tt,it,Ct=0;Ct<ve;Ct++){var Rt=Ct<<3;for(tt=0;tt<8;tt++)be.push(new Uint8Array(te));for(var xt=0;xt<ne;xt++){Oe(ge.blocks[Ct][xt],Ie,he);var Vt=0,It=xt<<3;for(it=0;it<8;it++){var Xt=be[Rt+it];for(tt=0;tt<8;tt++)Xt[It+tt]=Ie[Vt++]}}}return be}function X(ce){return ce<0?0:ce>255?255:ce}F.prototype={load:function(ge){var be=new XMLHttpRequest;be.open("GET",ge,!0),be.responseType="arraybuffer",be.onload=function(){var ne=new Uint8Array(be.response||be.mozResponseArrayBuffer);this.parse(ne),this.onload&&this.onload()}.bind(this),be.send(null)},parse:function(ge){var be=this.opts.maxResolutionInMP*1e3*1e3,ne=0;ge.length;function ve(){var Ht=ge[ne]<<8|ge[ne+1];return ne+=2,Ht}function te(){var Ht=ve(),ui=ge.subarray(ne,ne+Ht-2);return ne+=ui.length,ui}function he(Ht){var ui=0,Li=0,zi,Fi;for(Fi in Ht.components)Ht.components.hasOwnProperty(Fi)&&(zi=Ht.components[Fi],ui<zi.h&&(ui=zi.h),Li<zi.v&&(Li=zi.v));var tr=Math.ceil(Ht.samplesPerLine/8/ui),Br=Math.ceil(Ht.scanLines/8/Li);for(Fi in Ht.components)if(Ht.components.hasOwnProperty(Fi)){zi=Ht.components[Fi];var Rr=Math.ceil(Math.ceil(Ht.samplesPerLine/8)*zi.h/ui),Er=Math.ceil(Math.ceil(Ht.scanLines/8)*zi.v/Li),er=tr*zi.h,ur=Br*zi.v,mr=ur*er,yr=[];ie(mr*256);for(var Sr=0;Sr<ur;Sr++){for(var Lr=[],_e=0;_e<er;_e++)Lr.push(new Int32Array(64));yr.push(Lr)}zi.blocksPerLine=Rr,zi.blocksPerColumn=Er,zi.blocks=yr}Ht.maxH=ui,Ht.maxV=Li,Ht.mcusPerLine=tr,Ht.mcusPerColumn=Br}var Ie=null,Oe=null,tt,it,Ct=[],Rt=[],xt=[],Vt=[],It=ve(),Xt=-1;if(this.comments=[],It!=65496)throw new Error("SOI not found");for(It=ve();It!=65497;){var Jt,nt;switch(It){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var mt=te();if(It===65534){var ft=String.fromCharCode.apply(null,mt);this.comments.push(ft)}It===65504&&mt[0]===74&&mt[1]===70&&mt[2]===73&&mt[3]===70&&mt[4]===0&&(Ie={version:{major:mt[5],minor:mt[6]},densityUnits:mt[7],xDensity:mt[8]<<8|mt[9],yDensity:mt[10]<<8|mt[11],thumbWidth:mt[12],thumbHeight:mt[13],thumbData:mt.subarray(14,14+3*mt[12]*mt[13])}),It===65505&&mt[0]===69&&mt[1]===120&&mt[2]===105&&mt[3]===102&&mt[4]===0&&(this.exifBuffer=mt.subarray(5,mt.length)),It===65518&&mt[0]===65&&mt[1]===100&&mt[2]===111&&mt[3]===98&&mt[4]===101&&mt[5]===0&&(Oe={version:mt[6],flags0:mt[7]<<8|mt[8],flags1:mt[9]<<8|mt[10],transformCode:mt[11]});break;case 65499:for(var Dt=ve(),qt=Dt+ne-2;ne<qt;){var oi=ge[ne++];ie(256);var ti=new Int32Array(64);if(oi>>4===0)for(nt=0;nt<64;nt++){var fi=f[nt];ti[fi]=ge[ne++]}else if(oi>>4===1)for(nt=0;nt<64;nt++){var fi=f[nt];ti[fi]=ve()}else throw new Error("DQT: invalid table spec");Ct[oi&15]=ti}break;case 65472:case 65473:case 65474:ve(),tt={},tt.extended=It===65473,tt.progressive=It===65474,tt.precision=ge[ne++],tt.scanLines=ve(),tt.samplesPerLine=ve(),tt.components={},tt.componentsOrder=[];var si=tt.scanLines*tt.samplesPerLine;if(si>be){var Ot=Math.ceil((si-be)/1e6);throw new Error(`maxResolutionInMP limit exceeded by ${Ot}MP`)}var ai=ge[ne++],Nt;for(Jt=0;Jt<ai;Jt++){Nt=ge[ne];var dt=ge[ne+1]>>4,gi=ge[ne+1]&15,Et=ge[ne+2];tt.componentsOrder.push(Nt),tt.components[Nt]={h:dt,v:gi,quantizationIdx:Et},ne+=3}he(tt),Rt.push(tt);break;case 65476:var je=ve();for(Jt=2;Jt<je;){var jt=ge[ne++],Wt=new Uint8Array(16),Qt=0;for(nt=0;nt<16;nt++,ne++)Qt+=Wt[nt]=ge[ne];ie(16+Qt);var ni=new Uint8Array(Qt);for(nt=0;nt<Qt;nt++,ne++)ni[nt]=ge[ne];Jt+=17+Qt,(jt>>4===0?Vt:xt)[jt&15]=G(Wt,ni)}break;case 65501:ve(),it=ve();break;case 65500:ve(),ve();break;case 65498:ve();var gt=ge[ne++],Ai=[],ci;for(Jt=0;Jt<gt;Jt++){ci=tt.components[ge[ne++]];var Lt=ge[ne++];ci.huffmanTableDC=Vt[Lt>>4],ci.huffmanTableAC=xt[Lt&15],Ai.push(ci)}var $t=ge[ne++],_t=ge[ne++],hi=ge[ne++],_i=H(ge,ne,tt,Ai,it,$t,_t,hi>>4,hi&15,this.opts);ne+=_i;break;case 65535:ge[ne]!==255&&ne--;break;default:if(ge[ne-3]==255&&ge[ne-2]>=192&&ge[ne-2]<=254){ne-=3;break}else if(It===224||It==225){if(Xt!==-1)throw new Error(`first unknown JPEG marker at offset ${Xt.toString(16)}, second unknown JPEG marker ${It.toString(16)} at offset ${(ne-1).toString(16)}`);Xt=ne-1;const Ht=ve();if(ge[ne+Ht-2]===255){ne+=Ht-2;break}}throw new Error("unknown JPEG marker "+It.toString(16))}It=ve()}if(Rt.length!=1)throw new Error("only single frame JPEGs supported");for(var Jt=0;Jt<Rt.length;Jt++){var wi=Rt[Jt].components;for(var nt in wi)wi[nt].quantizationTable=Ct[wi[nt].quantizationIdx],delete wi[nt].quantizationIdx}this.width=tt.samplesPerLine,this.height=tt.scanLines,this.jfif=Ie,this.adobe=Oe,this.components=[];for(var Jt=0;Jt<tt.componentsOrder.length;Jt++){var ci=tt.components[tt.componentsOrder[Jt]];this.components.push({lines:K(tt,ci),scaleX:ci.h/tt.maxH,scaleY:ci.v/tt.maxV})}},getData:function(ge,be){var ne=this.width/ge,ve=this.height/be,te,he,Ie,Oe,tt,it,Ct,Rt,xt,Vt,It=0,Xt,Jt,nt,mt,ft,Dt,qt,oi,ti,fi,si,Ot=ge*be*this.components.length;ie(Ot);var ai=new Uint8Array(Ot);switch(this.components.length){case 1:for(te=this.components[0],Vt=0;Vt<be;Vt++)for(tt=te.lines[0|Vt*te.scaleY*ve],xt=0;xt<ge;xt++)Xt=tt[0|xt*te.scaleX*ne],ai[It++]=Xt;break;case 2:for(te=this.components[0],he=this.components[1],Vt=0;Vt<be;Vt++)for(tt=te.lines[0|Vt*te.scaleY*ve],it=he.lines[0|Vt*he.scaleY*ve],xt=0;xt<ge;xt++)Xt=tt[0|xt*te.scaleX*ne],ai[It++]=Xt,Xt=it[0|xt*he.scaleX*ne],ai[It++]=Xt;break;case 3:for(si=!0,this.adobe&&this.adobe.transformCode?si=!0:typeof this.opts.colorTransform!="undefined"&&(si=!!this.opts.colorTransform),te=this.components[0],he=this.components[1],Ie=this.components[2],Vt=0;Vt<be;Vt++)for(tt=te.lines[0|Vt*te.scaleY*ve],it=he.lines[0|Vt*he.scaleY*ve],Ct=Ie.lines[0|Vt*Ie.scaleY*ve],xt=0;xt<ge;xt++)si?(Xt=tt[0|xt*te.scaleX*ne],Jt=it[0|xt*he.scaleX*ne],nt=Ct[0|xt*Ie.scaleX*ne],oi=X(Xt+1.402*(nt-128)),ti=X(Xt-.3441363*(Jt-128)-.71413636*(nt-128)),fi=X(Xt+1.772*(Jt-128))):(oi=tt[0|xt*te.scaleX*ne],ti=it[0|xt*he.scaleX*ne],fi=Ct[0|xt*Ie.scaleX*ne]),ai[It++]=oi,ai[It++]=ti,ai[It++]=fi;break;case 4:if(!this.adobe)throw new Error("Unsupported color mode (4 components)");for(si=!1,this.adobe&&this.adobe.transformCode?si=!0:typeof this.opts.colorTransform!="undefined"&&(si=!!this.opts.colorTransform),te=this.components[0],he=this.components[1],Ie=this.components[2],Oe=this.components[3],Vt=0;Vt<be;Vt++)for(tt=te.lines[0|Vt*te.scaleY*ve],it=he.lines[0|Vt*he.scaleY*ve],Ct=Ie.lines[0|Vt*Ie.scaleY*ve],Rt=Oe.lines[0|Vt*Oe.scaleY*ve],xt=0;xt<ge;xt++)si?(Xt=tt[0|xt*te.scaleX*ne],Jt=it[0|xt*he.scaleX*ne],nt=Ct[0|xt*Ie.scaleX*ne],mt=Rt[0|xt*Oe.scaleX*ne],ft=255-X(Xt+1.402*(nt-128)),Dt=255-X(Xt-.3441363*(Jt-128)-.71413636*(nt-128)),qt=255-X(Xt+1.772*(Jt-128))):(ft=tt[0|xt*te.scaleX*ne],Dt=it[0|xt*he.scaleX*ne],qt=Ct[0|xt*Ie.scaleX*ne],mt=Rt[0|xt*Oe.scaleX*ne]),ai[It++]=255-ft,ai[It++]=255-Dt,ai[It++]=255-qt,ai[It++]=255-mt;break;default:throw new Error("Unsupported color mode")}return ai},copyToImageData:function(ge,be){var ne=ge.width,ve=ge.height,te=ge.data,he=this.getData(ne,ve),Ie=0,Oe=0,tt,it,Ct,Rt,xt,Vt,It,Xt,Jt;switch(this.components.length){case 1:for(it=0;it<ve;it++)for(tt=0;tt<ne;tt++)Ct=he[Ie++],te[Oe++]=Ct,te[Oe++]=Ct,te[Oe++]=Ct,be&&(te[Oe++]=255);break;case 3:for(it=0;it<ve;it++)for(tt=0;tt<ne;tt++)It=he[Ie++],Xt=he[Ie++],Jt=he[Ie++],te[Oe++]=It,te[Oe++]=Xt,te[Oe++]=Jt,be&&(te[Oe++]=255);break;case 4:for(it=0;it<ve;it++)for(tt=0;tt<ne;tt++)xt=he[Ie++],Vt=he[Ie++],Ct=he[Ie++],Rt=he[Ie++],It=255-X(xt*(1-Rt/255)+Rt),Xt=255-X(Vt*(1-Rt/255)+Rt),Jt=255-X(Ct*(1-Rt/255)+Rt),te[Oe++]=It,te[Oe++]=Xt,te[Oe++]=Jt,be&&(te[Oe++]=255);break;default:throw new Error("Unsupported color mode")}}};var de=0,Q=0;function ie(ce=0){var ge=de+ce;if(ge>Q){var be=Math.ceil((ge-Q)/1024/1024);throw new Error(`maxMemoryUsageInMB limit exceeded by at least ${be}MB`)}de=ge}return F.resetMaxMemoryUsage=function(ce){de=0,Q=ce},F.getBytesAllocated=function(){return de},F.requestMemoryAllocation=ie,F}();n.exports=s;function s(l,f={}){var m={colorTransform:void 0,useTArray:!1,formatAsRGBA:!0,tolerantDecoding:!0,maxResolutionInMP:100,maxMemoryUsageInMB:512},b=Su(Su({},m),f),h=new Uint8Array(l),S=new t;S.opts=b,t.resetMaxMemoryUsage(b.maxMemoryUsageInMB*1024*1024),S.parse(h);var M=b.formatAsRGBA?4:3,C=S.width*S.height*M;try{t.requestMemoryAllocation(C);var L={width:S.width,height:S.height,exifBuffer:S.exifBuffer,data:b.useTArray?new Uint8Array(C):Buffer.alloc(C)};S.comments.length>0&&(L.comments=S.comments)}catch(N){throw N instanceof RangeError?new Error("Could not allocate enough memory for the image. Required: "+C):N}return S.copyToImageData(L,b.formatAsRGBA),L}})(decoder$1);var encode$2=encoder$1.exports,decode$5=decoder$1.exports,jpegJs={encode:encode$2,decode:decode$5};let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=new Uint8Array(256);for(let n=0;n<chars.length;n++)lookup[chars.charCodeAt(n)]=n;function encode$1(n){let t,s=n.length,l="";for(t=0;t<s;t+=3)l+=chars[n[t]>>2],l+=chars[(n[t]&3)<<4|n[t+1]>>4],l+=chars[(n[t+1]&15)<<2|n[t+2]>>6],l+=chars[n[t+2]&63];return s%3===2?l=`${l.substring(0,l.length-1)}=`:s%3===1&&(l=`${l.substring(0,l.length-2)}==`),l}function decode$4(n){let t=n.length*.75,s=n.length,l=0,f,m,b,h;n[n.length-1]==="="&&(t--,n[n.length-2]==="="&&t--);const S=new Uint8Array(t);for(let M=0;M<s;M+=4)f=lookup[n.charCodeAt(M)],m=lookup[n.charCodeAt(M+1)],b=lookup[n.charCodeAt(M+2)],h=lookup[n.charCodeAt(M+3)],S[l++]=f<<2|m>>4,S[l++]=(m&15)<<4|b>>2,S[l++]=(b&3)<<6|h&63;return S}function toBase64URL(n,t){const s=encode$1(n);return`data:${t};base64,${s}`}const ImageData=self.ImageData,DOMImage=self.Image;function createCanvas(n,t){let s=self.document.createElement("canvas");return s.width=n,s.height=t,s}function fetchBinary(n,{withCredentials:t=!1}={}){return new Promise(function(s,l){let f=new self.XMLHttpRequest;f.open("GET",n,!0),f.responseType="arraybuffer",f.withCredentials=t,f.onload=function(m){this.status!==200?l(m):s(this.response)},f.onerror=l,f.send()})}function createWriteStream(){throw new Error("createWriteStream does not exist in the browser")}function writeFile(){throw new Error("writeFile does not exist in the browser")}function getType(n){return n.includes("/")||(n=`image/${n}`),n}function encodeJpeg(n,t={}){const s={width:n.width,height:n.height,data:n.getRGBAData()};return jpegJs.encode(s,t.quality).data}function encodePng(n,t){const s={width:n.width,height:n.height,channels:n.channels,depth:n.bitDepth,data:n.data};return(s.depth===1||s.depth===32)&&(s.depth=8,s.channels=4,s.data=n.getRGBAData()),encodePng$1(s,t)}const exportMethods={save(n,t={}){const{useCanvas:s=!1,encoder:l=void 0}=t;let{format:f}=t;if(!f){const m=/\.(?<format>[a-zA-Z]+)$/.exec(n);m&&(f=m.groups.format.toLowerCase())}if(!f)throw new Error("file format not provided");return new Promise((m,b)=>{let h,S;switch(f.toLowerCase()){case"png":{s?h=this.getCanvas().pngStream():S=encodePng(this,l);break}case"jpg":case"jpeg":s?h=this.getCanvas().jpegStream():S=encodeJpeg(this,l);break;case"bmp":S=encode$4(this,l);break;default:throw new RangeError(`invalid output format: ${f}`)}if(h){let M=createWriteStream();M.on("finish",m),M.on("error",b),h.pipe(M)}else S&&writeFile()})},toDataURL(n="image/png",t={}){typeof n=="object"&&(t=n,n="image/png");const{useCanvas:s=!1,encoder:l=void 0}=t;n=getType(n);function f(m,b){const h=m(b,l);return toBase64URL(h,n)}return n==="image/bmp"?f(encode$4,this):n==="image/png"&&!s?f(encodePng,this):n==="image/jpeg"&&!s?f(encodeJpeg,this):this.getCanvas().toDataURL(n)},toBuffer(n={}){const{format:t="png",encoder:s=void 0}=n;switch(t.toLowerCase()){case"png":return encodePng(this,s);case"jpeg":case"jpg":return encodeJpeg(this,s);case"bmp":return encode$4(this,s);default:throw new RangeError(`invalid output format: ${t}`)}},toBase64(n="image/png",t={}){if(t.async)return this.toDataURL(n,t).then(function(s){return s.substring(s.indexOf(",")+1)});{const s=this.toDataURL(n,t);return s.substring(s.indexOf(",")+1)}},toBlob(n="image/png",t=.8){return canvasToBlob(this.getCanvas(),n,t)},getCanvas(){const n=new ImageData(this.getRGBAData({clamped:!0}),this.width,this.height);let t=createCanvas(this.width,this.height);return t.getContext("2d").putImageData(n,0,0),t}};function setExportMethods(n){for(const t in exportMethods)n.prototype[t]=exportMethods[t]}var hasOwn$1={exports:{}};const name="has-own",version="1.0.1",description="A safer .hasOwnProperty() - hasOwn(name, obj)",main="index.js",scripts={test:"make test"},author="Aaron Heckmann <aaron.heckmann+github@gmail.com>",license="MIT",repository={type:"git",url:"git://github.com/aheckmann/has-own.git"},homepage="https://github.com/aheckmann/has-own/",devDependencies={mocha:"^6.2.2"};var require$$0$3={name,version,description,main,scripts,author,license,repository,homepage,devDependencies};(function(n,t){var s=Object.prototype.hasOwnProperty;n.exports=t=function(f,m){return s.call(m,f)},t.version=require$$0$3.version})(hasOwn$1,hasOwn$1.exports);var hasOwn=hasOwn$1.exports;let computedPropertyDescriptor$1={configurable:!0,enumerable:!1,get:void 0};function extendMethod(n,t,s={}){let{inPlace:l=!1,returnThis:f=!0,partialArgs:m=[]}=s;return l?Image$1.prototype[n]=function(...b){this.computed=null;let h=t.apply(this,[...m,...b]);return f?this:h}:Image$1.prototype[n]=function(...b){return t.apply(this,[...m,...b])},Image$1}function extendProperty(n,t,s={}){let{partialArgs:l=[]}=s;return computedPropertyDescriptor$1.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(n,this.computed))return this.computed[n];let f=t.apply(this,l);return this.computed[n]=f,f},Object.defineProperty(Image$1.prototype,n,computedPropertyDescriptor$1),Image$1}const GREY$1="GREY",RGB$1="RGB",HSL="HSL",HSV="HSV",CMYK$1="CMYK";var ColorModel=Object.freeze(Object.defineProperty({__proto__:null,GREY:GREY$1,RGB:RGB$1,HSL,HSV,CMYK:CMYK$1},Symbol.toStringTag,{value:"Module"}));function getRGBAData(n={}){const{clamped:t}=n;this.checkProcessable("getRGBAData",{components:[1,3],bitDepth:[1,8,16,32]});const s=this.width*this.height*4;let l=t?new Uint8ClampedArray(s):new Uint8Array(s);return this.bitDepth===1?fillDataFromBinary(this,l):this.bitDepth===32?(this.checkProcessable("getRGBAData",{alpha:0}),this.components===1?fillDataFromGrey32(this,l):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB32(this,l))):this.components===1?fillDataFromGrey(this,l):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB(this,l)),this.alpha===1?(this.checkProcessable("getRGBAData",{bitDepth:[8,16]}),copyAlpha(this,l)):fillAlpha(this,l),l}function fillDataFromBinary(n,t){for(let s=0;s<n.size;s++){const l=n.getBit(s);t[s*4]=l*255,t[s*4+1]=l*255,t[s*4+2]=l*255}}function fillDataFromGrey32(n,t){const s=n.min[0],f=n.max[0]-s;for(let m=0;m<n.size;m++){const b=Math.floor(255*(n.data[m]-s)/f);t[m*4]=b,t[m*4+1]=b,t[m*4+2]=b}}function fillDataFromRGB32(n,t){const s=Math.min(...n.min),f=Math.max(...n.max)-s;for(let m=0;m<n.size;m++){const b=Math.floor(255*(n.data[m*3]-s)/f),h=Math.floor(255*(n.data[m*3+1]-s)/f),S=Math.floor(255*(n.data[m*3+2]-s)/f);t[m*4]=b,t[m*4+1]=h,t[m*4+2]=S}}function fillDataFromGrey(n,t){for(let s=0;s<n.size;s++)t[s*4]=n.data[s*n.channels]>>>n.bitDepth-8,t[s*4+1]=n.data[s*n.channels]>>>n.bitDepth-8,t[s*4+2]=n.data[s*n.channels]>>>n.bitDepth-8}function fillDataFromRGB(n,t){for(let s=0;s<n.size;s++)t[s*4]=n.data[s*n.channels]>>>n.bitDepth-8,t[s*4+1]=n.data[s*n.channels+1]>>>n.bitDepth-8,t[s*4+2]=n.data[s*n.channels+2]>>>n.bitDepth-8}function copyAlpha(n,t){for(let s=0;s<n.size;s++)t[s*4+3]=n.data[s*n.channels+n.components]>>n.bitDepth-8}function fillAlpha(n,t){for(let s=0;s<n.size;s++)t[s*4+3]=255}const BINARY="BINARY",GREY="GREY",GREYA="GREYA",RGB="RGB",RGBA="RGBA",CMYK="CMYK",CMYKA="CMYKA",kinds={};kinds[BINARY]={components:1,alpha:0,bitDepth:1,colorModel:GREY$1};kinds[GREYA]={components:1,alpha:1,bitDepth:8,colorModel:GREY$1};kinds[GREY]={components:1,alpha:0,bitDepth:8,colorModel:GREY$1};kinds[RGBA]={components:3,alpha:1,bitDepth:8,colorModel:RGB$1};kinds[RGB]={components:3,alpha:0,bitDepth:8,colorModel:RGB$1};kinds[CMYK]={components:4,alpha:0,bitDepth:8,colorModel:CMYK$1};kinds[CMYKA]={components:4,alpha:1,bitDepth:8,colorModel:CMYK$1};function getKind(n){const t=kinds[n];if(!t)throw new RangeError(`invalid image kind: ${n}`);return t}const validBitDepth=[1,8,16,32];function verifyKindDefinition(n){const{components:t,alpha:s,bitDepth:l,colorModel:f}=n;if(!Number.isInteger(t)||t<=0)throw new RangeError(`invalid components: ${t}. Must be a positive integer`);if(s!==0&&s!==1&&typeof s!="boolean")throw new TypeError(`invalid alpha: ${s}: must be a boolean, 0 or 1`);if(!validBitDepth.includes(l))throw new RangeError(`invalid bitDepth: ${l}. Must be one of ${validBitDepth.join(", ")}`);if(!ColorModel[f])throw new RangeError(`invalid colorModel: ${f}. Must be one of ${Object.keys(ColorModel).join(", ")}`)}function getTheoreticalPixelArraySize(n,t,s){let l=t*n;return s===1&&(l=Math.ceil(l/8)),l}function createPixelArray(n,t,s,l,f,m){const b=l*n;let h;switch(f){case 1:h=new Uint8Array(Math.ceil(b/8));break;case 8:h=new Uint8Array(b);break;case 16:h=new Uint16Array(b);break;case 32:h=new Float32Array(b);break;default:throw new Error(`Cannot create pixel array for bit depth ${f}`)}if(s)for(let S=t;S<h.length;S+=l)h[S]=m;return h}const defaultByteLength$1=1024*8,charArray=[];class IOBuffer$3{constructor(t,s){s=s||{},t===void 0&&(t=defaultByteLength$1),typeof t=="number"&&(t=new ArrayBuffer(t));let l=t.byteLength;const f=s.offset?s.offset>>>0:0;t.buffer&&(l=t.byteLength-f,t.byteLength!==t.buffer.byteLength?t=t.buffer.slice(t.byteOffset+f,t.byteOffset+t.byteLength):f?t=t.buffer.slice(f):t=t.buffer),this.buffer=t,this.length=l,this.byteLength=l,this.byteOffset=0,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer),this._increment=l||defaultByteLength$1,this._mark=0}available(t){return t===void 0&&(t=1),this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){this.littleEndian=!0}isBigEndian(){return!this.littleEndian}setBigEndian(){this.littleEndian=!1}skip(t){t===void 0&&(t=1),this.offset+=t}seek(t){this.offset=t}mark(){this._mark=this.offset}reset(){this.offset=this._mark}rewind(){this.offset=0}ensureAvailable(t){if(t===void 0&&(t=1),!this.available(t)){const s=this._increment+this._increment;this._increment=s;const l=this.length+s,f=new Uint8Array(l);f.set(new Uint8Array(this.buffer)),this.buffer=f.buffer,this.length=l,this._data=new DataView(this.buffer)}}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t){t===void 0&&(t=1);for(var s=new Uint8Array(t),l=0;l<t;l++)s[l]=this.readByte();return s}readInt16(){var t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){var t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){var t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){var t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){var t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){var t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t){t===void 0&&(t=1),charArray.length=t;for(var s=0;s<t;s++)charArray[s]=this.readChar();return charArray.join("")}writeBoolean(t){this.writeUint8(t?255:0)}writeInt8(t){this.ensureAvailable(1),this._data.setInt8(this.offset++,t)}writeUint8(t){this.ensureAvailable(1),this._data.setUint8(this.offset++,t)}writeByte(t){this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(var s=0;s<t.length;s++)this._data.setUint8(this.offset++,t[s])}writeInt16(t){this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2}writeUint16(t){this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2}writeInt32(t){this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4}writeUint32(t){this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4}writeFloat32(t){this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4}writeFloat64(t){this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8}writeChar(t){this.writeUint8(t.charCodeAt(0))}writeChars(t){for(var s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s))}toArray(){return new Uint8Array(this.buffer,0,this.offset)}}var IOBuffer_1=IOBuffer$3,src$4={};const tagsById$5={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName$5={};for(var i$4 in tagsById$5)tagsByName$5[tagsById$5[i$4]]=i$4;var standard$1={tagsById:tagsById$5,tagsByName:tagsByName$5};const tagsById$4={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$4={};for(var i$3 in tagsById$4)tagsByName$4[tagsById$4[i$3]]=i$3;var exif$1={tagsById:tagsById$4,tagsByName:tagsByName$4};const tagsById$3={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$3={};for(var i$2 in tagsById$3)tagsByName$3[tagsById$3[i$2]]=i$2;var gps$1={tagsById:tagsById$3,tagsByName:tagsByName$3};const tags$1={standard:standard$1,exif:exif$1,gps:gps$1};class IFD$2{constructor(t){if(!t)throw new Error("missing kind");this.data=null,this.fields=new Map,this.kind=t,this._map=null}get(t){if(typeof t=="number")return this.fields.get(t);if(typeof t=="string")return this.fields.get(tags$1[this.kind].tagsByName[t]);throw new Error("expected a number or string")}get map(){if(!this._map){this._map={};const s=tags$1[this.kind].tagsById;for(var t of this.fields.keys())s[t]&&(this._map[s[t]]=this.fields.get(t))}return this._map}}var ifd=IFD$2;const Ifd=ifd,dateTimeRegex$1=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd$1 extends Ifd{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){var t=new Date,s=dateTimeRegex$1.exec(this.dateTime);return t.setFullYear(s[1],s[2]-1,s[3]),t.setHours(s[4],s[5],s[6]),t}get newSubfileType(){return this.get(254)}get imageWidth(){return this.get(256)}get imageLength(){return this.get(257)}get bitsPerSample(){return this.get(258)}get compression(){return this.get(259)||1}get type(){return this.get(262)}get fillOrder(){return this.get(266)||1}get documentName(){return this.get(269)}get imageDescription(){return this.get(270)}get stripOffsets(){return alwaysArray$1(this.get(273))}get orientation(){return this.get(274)}get samplesPerPixel(){return this.get(277)}get rowsPerStrip(){return this.get(278)}get stripByteCounts(){return alwaysArray$1(this.get(279))}get minSampleValue(){return this.get(280)||0}get maxSampleValue(){return this.get(281)||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get(282)}get yResolution(){return this.get(283)}get planarConfiguration(){return this.get(284)||1}get resolutionUnit(){return this.get(296)||2}get dateTime(){return this.get(306)}get predictor(){return this.get(317)||1}get sampleFormat(){return this.get(339)||1}get sMinSampleValue(){return this.get(340)||this.minSampleValue}get sMaxSampleValue(){return this.get(341)||this.maxSampleValue}}function alwaysArray$1(n){return typeof n=="number"?[n]:n}var tiffIfd=TiffIfd$1,ifdValue={},types$1=new Map([[1,[1,readByte$1]],[2,[1,readASCII$1]],[3,[2,readShort$1]],[4,[4,readLong$1]],[5,[8,readRational$1]],[6,[1,readSByte$1]],[7,[1,readByte$1]],[8,[2,readSShort$1]],[9,[4,readSLong$1]],[10,[8,readSRational$1]],[11,[4,readFloat$1]],[12,[8,readDouble$1]]]);ifdValue.getByteLength=function(n,t){return types$1.get(n)[0]*t};ifdValue.readData=function(n,t,s){return types$1.get(t)[1](n,s)};function readByte$1(n,t){if(t===1)return n.readUint8();for(var s=new Uint8Array(t),l=0;l<t;l++)s[l]=n.readUint8();return s}function readASCII$1(n,t){for(var s=[],l="",f=0;f<t;f++){var m=String.fromCharCode(n.readUint8());m==="\0"?(s.push(l),l=""):l+=m}return s.length===1?s[0]:s}function readShort$1(n,t){if(t===1)return n.readUint16();for(var s=new Uint16Array(t),l=0;l<t;l++)s[l]=n.readUint16();return s}function readLong$1(n,t){if(t===1)return n.readUint32();for(var s=new Uint32Array(t),l=0;l<t;l++)s[l]=n.readUint32();return s}function readRational$1(n,t){if(t===1)return n.readUint32()/n.readUint32();for(var s=new Array(t),l=0;l<t;l++)s[l]=n.readUint32()/n.readUint32();return s}function readSByte$1(n,t){if(t===1)return n.readInt8();for(var s=new Int8Array(t),l=0;l<t;l++)s[l]=n.readInt8();return s}function readSShort$1(n,t){if(t===1)return n.readInt16();for(var s=new Int16Array(t),l=0;l<t;l++)s[l]=n.readInt16();return s}function readSLong$1(n,t){if(t===1)return n.readInt32();for(var s=new Int32Array(t),l=0;l<t;l++)s[l]=n.readInt32();return s}function readSRational$1(n,t){if(t===1)return n.readInt32()/n.readInt32();for(var s=new Array(t),l=0;l<t;l++)s[l]=n.readInt32()/n.readInt32();return s}function readFloat$1(n,t){if(t===1)return n.readFloat32();for(var s=new Float32Array(t),l=0;l<t;l++)s[l]=n.readFloat32();return s}function readDouble$1(n,t){if(t===1)return n.readFloat64();for(var s=new Float64Array(t),l=0;l<t;l++)s[l]=n.readFloat64();return s}const IOBuffer$2=IOBuffer_1,IFD$1=ifd,TiffIFD=tiffIfd,IFDValue=ifdValue,defaultOptions$d={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder$2 extends IOBuffer$2{constructor(t,s){super(t,s),this._nextIFD=0}decode(t){t=Object.assign({},defaultOptions$d,t);const s=[];for(this.decodeHeader();this._nextIFD;)if(s.push(this.decodeIFD(t)),t.onlyFirst)return s[0];return s}decodeHeader(){let t=this.readUint16();if(t===18761)this.setLittleEndian();else if(t===19789)this.setBigEndian();else throw new Error("invalid byte order: 0x"+t.toString(16));if(t=this.readUint16(),t!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(t){this.seek(this._nextIFD);var s;t.kind?s=new IFD$1(t.kind):s=new TiffIFD;const l=this.readUint16();for(var f=0;f<l;f++)this.decodeIFDEntry(s);return t.ignoreImageData||this.decodeImageData(s),this._nextIFD=this.readUint32(),s}decodeIFDEntry(t){const s=this.offset,l=this.readUint16(),f=this.readUint16(),m=this.readUint32();if(f<1||f>12){this.skip(4);return}IFDValue.getByteLength(f,m)>4&&this.seek(this.readUint32());const h=IFDValue.readData(this,f,m);if(t.fields.set(l,h),l===34665||l===34853){let S=this.offset,M;l===34665?M="exif":l===34853&&(M="gps"),this._nextIFD=h,t[M]=this.decodeIFD({kind:M,ignoreImageData:!0}),this.offset=S}this.seek(s),this.skip(12)}decodeImageData(t){const s=t.orientation;switch(s&&s!==1&&unsupported$1("orientation",s),t.type){case 1:case 2:this.readStripData(t);break;default:unsupported$1("image type",t.type);break}}readStripData(t){const s=t.width,l=t.height,f=validateBitDepth(t.bitsPerSample),m=t.sampleFormat;let b=s*l;const h=getDataArray$1(b,1,f,m),S=t.compression,C=t.rowsPerStrip*s,L=t.stripOffsets,N=t.stripByteCounts;for(var F=0,G=0;G<L.length;G++){var H=this.getStripData(S,L[G],N[G]),K=b>C?C:b;b-=K,f===8?F=fill8bit$1(h,H,F,K):f===16?F=fill16bit$1(h,H,F,K,this.isLittleEndian()):f===32&&m===3?F=fillFloat32$1(h,H,F,K,this.isLittleEndian()):unsupported$1("bitDepth",f)}t.data=h}getStripData(t,s,l){switch(t){case 1:return new DataView(this.buffer,s,l);case 2:case 32773:return unsupported$1("Compression",t);default:throw new Error("invalid compression: "+t)}}}var tiffDecoder=TIFFDecoder$2;function getDataArray$1(n,t,s,l){return s===8?new Uint8Array(n*t):s===16?new Uint16Array(n*t):s===32&&l===3?new Float32Array(n*t):unsupported$1("bit depth / sample format",s+" / "+l)}function fill8bit$1(n,t,s,l){for(var f=0;f<l;f++)n[s++]=t.getUint8(f);return s}function fill16bit$1(n,t,s,l,f){for(var m=0;m<l*2;m+=2)n[s++]=t.getUint16(m,f);return s}function fillFloat32$1(n,t,s,l,f){for(var m=0;m<l*4;m+=4)n[s++]=t.getFloat32(m,f);return s}function unsupported$1(n,t){throw new Error("Unsupported "+n+": "+t)}function validateBitDepth(n){if(n.length){const s=n;n=s[0];for(var t=0;t<s.length;t++)s[t]!==n&&unsupported$1("bit depth",s)}return n}const TIFFDecoder$1=tiffDecoder;var decode$3=function(t,s){return new TIFFDecoder$1(t,s).decode(s)};src$4.decode=decode$3;const IOBuffer$1=IOBuffer_1,tiff=src$4;function decode$2(n){const t=new IOBuffer$1(n),s={};if(t.setBigEndian(),t.readUint16()!==65496)throw new Error("SOI marker not found. Not a valid JPEG file");if(t.readUint16()===65505){t.readUint16();const m=t.readBytes(6);if(m[0]===69&&m[1]===120&&m[2]===105&&m[3]===102&&m[4]===0&&m[5]===0){const b=tiff.decode(t,{onlyFirst:!0,ignoreImageData:!0,offset:t.offset});s.exif=b}}return s}var decode_1=decode$2,decode$1=decode_1,imageType$2={exports:{}},fileType$1={exports:{}};(function(module){const toBytes=n=>[...n].map(t=>t.charCodeAt(0)),xpiZipFilename=toBytes("META-INF/mozilla.rsa"),oxmlContentTypes=toBytes("[Content_Types].xml"),oxmlRels=toBytes("_rels/.rels");function readUInt64LE(n,t=0){let s=n[t],l=1,f=0;for(;++f<8;)l*=256,s+=n[t+f]*l;return s}const fileType=n=>{if(!(n instanceof Uint8Array||n instanceof ArrayBuffer||Buffer.isBuffer(n)))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`Buffer\` or \`ArrayBuffer\`, got \`${typeof n}\``);const t=n instanceof Uint8Array?n:new Uint8Array(n);if(!(t&&t.length>1))return null;const s=(f,m)=>{m=Object.assign({offset:0},m);for(let b=0;b<f.length;b++)if(m.mask){if(f[b]!==(m.mask[b]&t[b+m.offset]))return!1}else if(f[b]!==t[b+m.offset])return!1;return!0},l=(f,m)=>s(toBytes(f),m);if(s([255,216,255]))return{ext:"jpg",mime:"image/jpeg"};if(s([137,80,78,71,13,10,26,10]))return{ext:"png",mime:"image/png"};if(s([71,73,70]))return{ext:"gif",mime:"image/gif"};if(s([87,69,66,80],{offset:8}))return{ext:"webp",mime:"image/webp"};if(s([70,76,73,70]))return{ext:"flif",mime:"image/flif"};if((s([73,73,42,0])||s([77,77,0,42]))&&s([67,82],{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(s([73,73,42,0])||s([77,77,0,42]))return{ext:"tif",mime:"image/tiff"};if(s([66,77]))return{ext:"bmp",mime:"image/bmp"};if(s([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(s([56,66,80,83]))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(s([80,75,3,4])){if(s([109,105,109,101,116,121,112,101,97,112,112,108,105,99,97,116,105,111,110,47,101,112,117,98,43,122,105,112],{offset:30}))return{ext:"epub",mime:"application/epub+zip"};if(s(xpiZipFilename,{offset:30}))return{ext:"xpi",mime:"application/x-xpinstall"};if(l("mimetypeapplication/vnd.oasis.opendocument.text",{offset:30}))return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};if(l("mimetypeapplication/vnd.oasis.opendocument.spreadsheet",{offset:30}))return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};if(l("mimetypeapplication/vnd.oasis.opendocument.presentation",{offset:30}))return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};const f=(S,M=0)=>S.findIndex((C,L,N)=>L>=M&&N[L]===80&&N[L+1]===75&&N[L+2]===3&&N[L+3]===4);let m=0,b=!1,h=null;do{const S=m+30;if(b||(b=s(oxmlContentTypes,{offset:S})||s(oxmlRels,{offset:S})),h||(l("word/",{offset:S})?h={ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}:l("ppt/",{offset:S})?h={ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}:l("xl/",{offset:S})&&(h={ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),b&&h)return h;m=f(t,S)}while(m>=0);if(h)return h}if(s([80,75])&&(t[2]===3||t[2]===5||t[2]===7)&&(t[3]===4||t[3]===6||t[3]===8))return{ext:"zip",mime:"application/zip"};if(s([117,115,116,97,114],{offset:257}))return{ext:"tar",mime:"application/x-tar"};if(s([82,97,114,33,26,7])&&(t[6]===0||t[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(s([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(s([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(s([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(s([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(s([51,103,112,53])||s([0,0,0])&&s([102,116,121,112],{offset:4})&&(s([109,112,52,49],{offset:8})||s([109,112,52,50],{offset:8})||s([105,115,111,109],{offset:8})||s([105,115,111,50],{offset:8})||s([109,109,112,52],{offset:8})||s([77,52,86],{offset:8})||s([100,97,115,104],{offset:8})))return{ext:"mp4",mime:"video/mp4"};if(s([77,84,104,100]))return{ext:"mid",mime:"audio/midi"};if(s([26,69,223,163])){const f=t.subarray(4,4100),m=f.findIndex((b,h,S)=>S[h]===66&&S[h+1]===130);if(m!==-1){const b=m+3,h=S=>[...S].every((M,C)=>f[b+C]===M.charCodeAt(0));if(h("matroska"))return{ext:"mkv",mime:"video/x-matroska"};if(h("webm"))return{ext:"webm",mime:"video/webm"}}}if(s([0,0,0,20,102,116,121,112,113,116,32,32])||s([102,114,101,101],{offset:4})||s([102,116,121,112,113,116,32,32],{offset:4})||s([109,100,97,116],{offset:4})||s([109,111,111,118],{offset:4})||s([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(s([82,73,70,70])){if(s([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(s([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/vnd.wave"};if(s([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(s([48,38,178,117,142,102,207,17,166,217])){let f=30;do{const m=readUInt64LE(t,f+16);if(s([145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101],{offset:f})){if(s([64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43],{offset:f+24}))return{ext:"wma",mime:"audio/x-ms-wma"};if(s([192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43],{offset:f+24}))return{ext:"wmv",mime:"video/x-ms-asf"};break}f+=m}while(f+24<=t.length);return{ext:"asf",mime:"application/vnd.ms-asf"}}if(s([0,0,1,186])||s([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(s([102,116,121,112,51,103],{offset:4}))return{ext:"3gp",mime:"video/3gpp"};for(let f=0;f<2&&f<t.length-16;f++){if(s([73,68,51],{offset:f})||s([255,226],{offset:f,mask:[255,226]}))return{ext:"mp3",mime:"audio/mpeg"};if(s([255,228],{offset:f,mask:[255,228]}))return{ext:"mp2",mime:"audio/mpeg"};if(s([255,248],{offset:f,mask:[255,252]}))return{ext:"mp2",mime:"audio/mpeg"};if(s([255,240],{offset:f,mask:[255,252]}))return{ext:"mp4",mime:"audio/mpeg"}}if(s([102,116,121,112,77,52,65],{offset:4}))return{ext:"m4a",mime:"audio/mp4"};if(s([79,112,117,115,72,101,97,100],{offset:28}))return{ext:"opus",mime:"audio/opus"};if(s([79,103,103,83]))return s([128,116,104,101,111,114,97],{offset:28})?{ext:"ogv",mime:"video/ogg"}:s([1,118,105,100,101,111,0],{offset:28})?{ext:"ogm",mime:"video/ogg"}:s([127,70,76,65,67],{offset:28})?{ext:"oga",mime:"audio/ogg"}:s([83,112,101,101,120,32,32],{offset:28})?{ext:"spx",mime:"audio/ogg"}:s([1,118,111,114,98,105,115],{offset:28})?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"};if(s([102,76,97,67]))return{ext:"flac",mime:"audio/x-flac"};if(s([77,65,67,32]))return{ext:"ape",mime:"audio/ape"};if(s([119,118,112,107]))return{ext:"wv",mime:"audio/wavpack"};if(s([35,33,65,77,82,10]))return{ext:"amr",mime:"audio/amr"};if(s([37,80,68,70]))return{ext:"pdf",mime:"application/pdf"};if(s([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if((t[0]===67||t[0]===70)&&s([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(s([123,92,114,116,102]))return{ext:"rtf",mime:"application/rtf"};if(s([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(s([119,79,70,70])&&(s([0,1,0,0],{offset:4})||s([79,84,84,79],{offset:4})))return{ext:"woff",mime:"font/woff"};if(s([119,79,70,50])&&(s([0,1,0,0],{offset:4})||s([79,84,84,79],{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(s([76,80],{offset:34})&&(s([0,0,1],{offset:8})||s([1,0,2],{offset:8})||s([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(s([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(s([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(s([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(s([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(s([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(s([37,33]))return{ext:"ps",mime:"application/postscript"};if(s([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(s([83,81,76,105]))return{ext:"sqlite",mime:"application/x-sqlite3"};if(s([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(s([67,114,50,52]))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(s([77,83,67,70])||s([73,83,99,40]))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(s([33,60,97,114,99,104,62,10,100,101,98,105,97,110,45,98,105,110,97,114,121]))return{ext:"deb",mime:"application/x-deb"};if(s([33,60,97,114,99,104,62]))return{ext:"ar",mime:"application/x-unix-archive"};if(s([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(s([31,160])||s([31,157]))return{ext:"Z",mime:"application/x-compress"};if(s([76,90,73,80]))return{ext:"lz",mime:"application/x-lzip"};if(s([208,207,17,224,161,177,26,225]))return{ext:"msi",mime:"application/x-msi"};if(s([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(s([71],{offset:4})&&(s([71],{offset:192})||s([71],{offset:196})))return{ext:"mts",mime:"video/mp2t"};if(s([66,76,69,78,68,69,82]))return{ext:"blend",mime:"application/x-blender"};if(s([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(s([0,0,0,12,106,80,32,32,13,10,135,10])){if(s([106,112,50,32],{offset:20}))return{ext:"jp2",mime:"image/jp2"};if(s([106,112,120,32],{offset:20}))return{ext:"jpx",mime:"image/jpx"};if(s([106,112,109,32],{offset:20}))return{ext:"jpm",mime:"image/jpm"};if(s([109,106,112,50],{offset:20}))return{ext:"mj2",mime:"image/mj2"}}if(s([70,79,82,77]))return{ext:"aif",mime:"audio/aiff"};if(l("<?xml "))return{ext:"xml",mime:"application/xml"};if(s([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(s([102,116,121,112],{offset:4})){if(s([109,105,102,49],{offset:8}))return{ext:"heic",mime:"image/heif"};if(s([109,115,102,49],{offset:8}))return{ext:"heic",mime:"image/heif-sequence"};if(s([104,101,105,99],{offset:8})||s([104,101,105,120],{offset:8}))return{ext:"heic",mime:"image/heic"};if(s([104,101,118,99],{offset:8})||s([104,101,118,120],{offset:8}))return{ext:"heic",mime:"image/heic-sequence"}}return s([171,75,84,88,32,49,49,187,13,10,26,10])?{ext:"ktx",mime:"image/ktx"}:s([68,73,67,77],{offset:128})?{ext:"dcm",mime:"application/dicom"}:s([77,80,43])?{ext:"mpc",mime:"audio/x-musepack"}:s([77,80,67,75])?{ext:"mpc",mime:"audio/x-musepack"}:s([66,69,71,73,78,58])?{ext:"ics",mime:"text/calendar"}:s([103,108,84,70,2,0,0,0])?{ext:"glb",mime:"model/gltf-binary"}:s([212,195,178,161])||s([161,178,195,212])?{ext:"pcap",mime:"application/vnd.tcpdump.pcap"}:null};module.exports=fileType,module.exports.default=fileType,Object.defineProperty(fileType,"minimumBytes",{value:4100}),module.exports.stream=readableStream=>new Promise((resolve,reject)=>{const stream=eval("require")("stream");readableStream.once("readable",()=>{const n=new stream.PassThrough,t=readableStream.read(module.exports.minimumBytes)||readableStream.read();try{n.fileType=fileType(t)}catch(s){reject(s)}readableStream.unshift(t),stream.pipeline?resolve(stream.pipeline(readableStream,n,()=>{})):resolve(readableStream.pipe(n))})})})(fileType$1);const fileType=fileType$1.exports,imageExts=new Set(["jpg","png","gif","webp","flif","cr2","tif","bmp","jxr","psd","ico","bpg","jp2","jpm","jpx","heic","cur","dcm"]),imageType=n=>{const t=fileType(n);return imageExts.has(t&&t.ext)?t:null};imageType$2.exports=imageType;imageType$2.exports.default=imageType;Object.defineProperty(imageType,"minimumBytes",{value:fileType.minimumBytes});var imageType$1=imageType$2.exports;(function(n){if(n.TextEncoder&&n.TextDecoder)return!1;function t(l="utf-8"){if(l!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${l}') is invalid.`)}Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),t.prototype.encode=function(l,f={stream:!1}){if(f.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let m=0;const b=l.length;let h=0,S=Math.max(32,b+(b>>1)+7),M=new Uint8Array(S>>3<<3);for(;m<b;){let C=l.charCodeAt(m++);if(C>=55296&&C<=56319){if(m<b){const L=l.charCodeAt(m);(L&64512)===56320&&(++m,C=((C&1023)<<10)+(L&1023)+65536)}if(C>=55296&&C<=56319)continue}if(h+4>M.length){S+=8,S*=1+m/l.length*2,S=S>>3<<3;const L=new Uint8Array(S);L.set(M),M=L}if((C&4294967168)===0){M[h++]=C;continue}else if((C&4294965248)===0)M[h++]=C>>6&31|192;else if((C&4294901760)===0)M[h++]=C>>12&15|224,M[h++]=C>>6&63|128;else if((C&4292870144)===0)M[h++]=C>>18&7|240,M[h++]=C>>12&63|128,M[h++]=C>>6&63|128;else continue;M[h++]=C&63|128}return M.slice(0,h)};function s(l="utf-8",f={fatal:!1}){if(l!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${l}') is invalid.`);if(f.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(s.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(s.prototype,"fatal",{value:!1}),Object.defineProperty(s.prototype,"ignoreBOM",{value:!1}),s.prototype.decode=function(l,f={stream:!1}){if(f.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const m=new Uint8Array(l);let b=0;const h=m.length,S=[];for(;b<h;){const M=m[b++];if(M===0)break;if((M&128)===0)S.push(M);else if((M&224)===192){const C=m[b++]&63;S.push((M&31)<<6|C)}else if((M&240)===224){const C=m[b++]&63,L=m[b++]&63;S.push((M&31)<<12|C<<6|L)}else if((M&248)===240){const C=m[b++]&63,L=m[b++]&63,N=m[b++]&63;let F=(M&7)<<18|C<<12|L<<6|N;F>65535&&(F-=65536,S.push(F>>>10&1023|55296),F=56320|F&1023),S.push(F)}}return String.fromCharCode.apply(null,S)},n.TextEncoder=t,n.TextDecoder=s})(typeof window!="undefined"?window:typeof self!="undefined"?self:globalThis);const decoder=new TextDecoder("utf-8");function decode(n){return decoder.decode(n)}const encoder=new TextEncoder;function encode(n){return encoder.encode(n)}const defaultByteLength=1024*8;class IOBuffer{constructor(t=defaultByteLength,s={}){let l=!1;typeof t=="number"?t=new ArrayBuffer(t):(l=!0,this.lastWrittenByte=t.byteLength);const f=s.offset?s.offset>>>0:0,m=t.byteLength-f;let b=f;(ArrayBuffer.isView(t)||t instanceof IOBuffer)&&(t.byteLength!==t.buffer.byteLength&&(b=t.byteOffset+f),t=t.buffer),l?this.lastWrittenByte=m:this.lastWrittenByte=0,this.buffer=t,this.length=m,this.byteLength=m,this.byteOffset=b,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,b,m),this._mark=0,this._marks=[]}available(t=1){return this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t=1){return this.offset+=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(t===void 0)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t=1){if(!this.available(t)){const l=(this.offset+t)*2,f=new Uint8Array(l);f.set(new Uint8Array(this.buffer)),this.buffer=f.buffer,this.length=this.byteLength=l,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t=1){const s=new Uint8Array(t);for(let l=0;l<t;l++)s[l]=this.readByte();return s}readInt16(){const t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){const t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){const t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){const t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){const t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){const t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readBigInt64(){const t=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,t}readBigUint64(){const t=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t=1){let s="";for(let l=0;l<t;l++)s+=this.readChar();return s}readUtf8(t=1){return decode(this.readBytes(t))}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(let s=0;s<t.length;s++)this._data.setUint8(this.offset++,t[s]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(t){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(t){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(let s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));return this}writeUtf8(t){return this.writeBytes(encode(t))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}function guessStripByteCounts(n){if(n.compression!==1)throw new Error("missing mandatory StripByteCounts field in compressed image");const t=n.rowsPerStrip*n.width*n.samplesPerPixel*(n.bitsPerSample/8);return new Array(n.stripOffsets.length).fill(t)}function applyHorizontalDifferencing8Bit(n,t,s){let l=0;for(;l<n.length;){for(let f=s;f<t*s;f+=s)for(let m=0;m<s;m++)n[l+f+m]=n[l+f+m]+n[l+f-(s-m)]&255;l+=t*s}}function applyHorizontalDifferencing16Bit(n,t,s){let l=0;for(;l<n.length;){for(let f=s;f<t*s;f+=s)for(let m=0;m<s;m++)n[l+f+m]=n[l+f+m]+n[l+f-(s-m)]&65535;l+=t*s}}const tagsById$2={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$2={};for(let n in tagsById$2)tagsByName$2[tagsById$2[n]]=Number(n);var exif=Object.freeze(Object.defineProperty({__proto__:null,tagsById:tagsById$2,tagsByName:tagsByName$2},Symbol.toStringTag,{value:"Module"}));const tagsById$1={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$1={};for(let n in tagsById$1)tagsByName$1[tagsById$1[n]]=Number(n);var gps=Object.freeze(Object.defineProperty({__proto__:null,tagsById:tagsById$1,tagsByName:tagsByName$1},Symbol.toStringTag,{value:"Module"}));const tagsById={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName={};for(let n in tagsById)tagsByName[tagsById[n]]=Number(n);var standard=Object.freeze(Object.defineProperty({__proto__:null,tagsById,tagsByName},Symbol.toStringTag,{value:"Module"}));const tags={standard,exif,gps};class IFD{constructor(t){if(!t)throw new Error("missing kind");this.data=new Uint8Array,this.fields=new Map,this.kind=t,this._hasMap=!1,this._map={}}get(t){if(typeof t=="number")return this.fields.get(t);if(typeof t=="string")return this.fields.get(tags[this.kind].tagsByName[t]);throw new Error("expected a number or string")}get map(){if(!this._hasMap){const t=tags[this.kind].tagsById;for(let s of this.fields.keys())t[s]&&(this._map[t[s]]=this.fields.get(s));this._hasMap=!0}return this._map}}let types=new Map([[1,[1,readByte]],[2,[1,readASCII]],[3,[2,readShort]],[4,[4,readLong]],[5,[8,readRational]],[6,[1,readSByte]],[7,[1,readByte]],[8,[2,readSShort]],[9,[4,readSLong]],[10,[8,readSRational]],[11,[4,readFloat]],[12,[8,readDouble]]]);function getByteLength(n,t){const s=types.get(n);if(!s)throw new Error(`type not found: ${n}`);return s[0]*t}function readData(n,t,s){const l=types.get(t);if(!l)throw new Error(`type not found: ${t}`);return l[1](n,s)}function readByte(n,t){if(t===1)return n.readUint8();let s=new Uint8Array(t);for(let l=0;l<t;l++)s[l]=n.readUint8();return s}function readASCII(n,t){let s=[],l="";for(let f=0;f<t;f++){let m=String.fromCharCode(n.readUint8());m==="\0"?(s.push(l),l=""):l+=m}return s.length===1?s[0]:s}function readShort(n,t){if(t===1)return n.readUint16();let s=new Uint16Array(t);for(let l=0;l<t;l++)s[l]=n.readUint16();return s}function readLong(n,t){if(t===1)return n.readUint32();let s=new Uint32Array(t);for(let l=0;l<t;l++)s[l]=n.readUint32();return s}function readRational(n,t){if(t===1)return n.readUint32()/n.readUint32();let s=new Array(t);for(let l=0;l<t;l++)s[l]=n.readUint32()/n.readUint32();return s}function readSByte(n,t){if(t===1)return n.readInt8();let s=new Int8Array(t);for(let l=0;l<t;l++)s[l]=n.readInt8();return s}function readSShort(n,t){if(t===1)return n.readInt16();let s=new Int16Array(t);for(let l=0;l<t;l++)s[l]=n.readInt16();return s}function readSLong(n,t){if(t===1)return n.readInt32();let s=new Int32Array(t);for(let l=0;l<t;l++)s[l]=n.readInt32();return s}function readSRational(n,t){if(t===1)return n.readInt32()/n.readInt32();let s=new Array(t);for(let l=0;l<t;l++)s[l]=n.readInt32()/n.readInt32();return s}function readFloat(n,t){if(t===1)return n.readFloat32();let s=new Float32Array(t);for(let l=0;l<t;l++)s[l]=n.readFloat32();return s}function readDouble(n,t){if(t===1)return n.readFloat64();let s=new Float64Array(t);for(let l=0;l<t;l++)s[l]=n.readFloat64();return s}const CLEAR_CODE=256,EOI_CODE=257,TABLE_START=258,MIN_BIT_LENGTH=9;let stringTable=[];function initializeStringTable(){if(stringTable.length===0){for(let t=0;t<256;t++)stringTable.push([t]);const n=[];for(let t=256;t<4096;t++)stringTable.push(n)}}const andTable=[511,1023,2047,4095],bitJumps=[0,0,0,0,0,0,0,0,0,511,1023,2047,4095];class LzwDecoder{constructor(t){this.nextData=0,this.nextBits=0,this.bytePointer=0,this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH,this.stripArray=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),this.outData=new IOBuffer(t.byteLength),this.initializeTable()}decode(){let t=0,s=0;for(;(t=this.getNextCode())!==EOI_CODE;)if(t===CLEAR_CODE){if(this.initializeTable(),t=this.getNextCode(),t===EOI_CODE)break;this.writeString(this.stringFromCode(t)),s=t}else if(this.isInTable(t))this.writeString(this.stringFromCode(t)),this.addStringToTable(this.stringFromCode(s).concat(this.stringFromCode(t)[0])),s=t;else{const f=this.stringFromCode(s).concat(this.stringFromCode(s)[0]);this.writeString(f),this.addStringToTable(f),s=t}const l=this.outData.toArray();return new DataView(l.buffer,l.byteOffset,l.byteLength)}initializeTable(){initializeStringTable(),this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH}writeString(t){this.outData.writeBytes(t)}stringFromCode(t){return stringTable[t]}isInTable(t){return t<this.tableLength}addStringToTable(t){if(stringTable[this.tableLength++]=t,stringTable.length>4096)throw stringTable=[],new Error("LZW decoding error. Please open an issue at https://github.com/image-js/tiff/issues/new/choose (include a test image).");this.tableLength===bitJumps[this.currentBitLength]&&this.currentBitLength++}getNextCode(){this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8,this.nextBits<this.currentBitLength&&(this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8);const t=this.nextData>>this.nextBits-this.currentBitLength&andTable[this.currentBitLength-9];return this.nextBits-=this.currentBitLength,this.bytePointer>this.stripArray.length?257:t}}function decompressLzw(n){return new LzwDecoder(n).decode()}const dateTimeRegex=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd extends IFD{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){let t=new Date,s=dateTimeRegex.exec(this.dateTime);if(s===null)throw new Error(`invalid dateTime: ${this.dateTime}`);return t.setFullYear(Number(s[1]),Number(s[2])-1,Number(s[3])),t.setHours(Number(s[4]),Number(s[5]),Number(s[6])),t}get newSubfileType(){return this.get("NewSubfileType")}get imageWidth(){return this.get("ImageWidth")}get imageLength(){return this.get("ImageLength")}get bitsPerSample(){const t=this.get("BitsPerSample");return t&&typeof t!="number"?t[0]:t}get alpha(){const t=this.extraSamples;return t?t[0]!==0:!1}get associatedAlpha(){const t=this.extraSamples;return t?t[0]===1:!1}get extraSamples(){return alwaysArray(this.get("ExtraSamples"))}get compression(){return this.get("Compression")||1}get type(){return this.get("PhotometricInterpretation")}get fillOrder(){return this.get("FillOrder")||1}get documentName(){return this.get("DocumentName")}get imageDescription(){return this.get("ImageDescription")}get stripOffsets(){return alwaysArray(this.get("StripOffsets"))}get orientation(){return this.get("Orientation")}get samplesPerPixel(){return this.get("SamplesPerPixel")||1}get rowsPerStrip(){return this.get("RowsPerStrip")}get stripByteCounts(){return alwaysArray(this.get("StripByteCounts"))}get minSampleValue(){return this.get("MinSampleValue")||0}get maxSampleValue(){return this.get("MaxSampleValue")||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get("XResolution")}get yResolution(){return this.get("YResolution")}get planarConfiguration(){return this.get("PlanarConfiguration")||1}get resolutionUnit(){return this.get("ResolutionUnit")||2}get dateTime(){return this.get("DateTime")}get predictor(){return this.get("Predictor")||1}get sampleFormat(){return this.get("SampleFormat")||1}get sMinSampleValue(){return this.get("SMinSampleValue")||this.minSampleValue}get sMaxSampleValue(){return this.get("SMaxSampleValue")||this.maxSampleValue}get palette(){const t=2**this.bitsPerSample,s=this.get("ColorMap");if(!s)return;if(s.length!==3*t)throw new Error(`ColorMap size must be ${t}`);const l=[];for(let f=0;f<t;f++)l.push([s[f],s[f+t],s[f+2*t]]);return l}}function alwaysArray(n){return typeof n=="number"?[n]:n}function decompressZlib(n){const t=new Uint8Array(n.buffer,n.byteOffset,n.byteLength),s=inflate_1(t);return new DataView(s.buffer,s.byteOffset,s.byteLength)}const defaultOptions$c={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder extends IOBuffer{constructor(t){super(t),this._nextIFD=0}get isMultiPage(){let t=0;for(this.decodeHeader();this._nextIFD;)if(t++,this.decodeIFD({ignoreImageData:!0},!0),t===2)return!0;if(t===1)return!1;throw unsupported("ifdCount",t)}get pageCount(){let t=0;for(this.decodeHeader();this._nextIFD;)t++,this.decodeIFD({ignoreImageData:!0},!0);if(t>0)return t;throw unsupported("ifdCount",t)}decode(t={}){t=Object.assign({},defaultOptions$c,t);const s=[];for(this.decodeHeader();this._nextIFD;)if(s.push(this.decodeIFD(t,!0)),t.onlyFirst)return[s[0]];return s}decodeHeader(){const t=this.readUint16();if(t===18761)this.setLittleEndian();else if(t===19789)this.setBigEndian();else throw new Error(`invalid byte order: 0x${t.toString(16)}`);if(this.readUint16()!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(t,s){this.seek(this._nextIFD);let l;if(s)l=new TiffIfd;else{if(!t.kind)throw new Error("kind is missing");l=new IFD(t.kind)}const f=this.readUint16();for(let m=0;m<f;m++)this.decodeIFDEntry(l);if(!t.ignoreImageData){if(!(l instanceof TiffIfd))throw new Error("must be a tiff ifd");this.decodeImageData(l)}return this._nextIFD=this.readUint32(),l}decodeIFDEntry(t){const s=this.offset,l=this.readUint16(),f=this.readUint16(),m=this.readUint32();if(f<1||f>12){this.skip(4);return}getByteLength(f,m)>4&&this.seek(this.readUint32());const h=readData(this,f,m);if(t.fields.set(l,h),l===34665||l===34853){let S=this.offset,M="exif";l===34665?M="exif":l===34853&&(M="gps"),this._nextIFD=h,t[M]=this.decodeIFD({kind:M,ignoreImageData:!0},!1),this.offset=S}this.seek(s),this.skip(12)}decodeImageData(t){const s=t.orientation;if(s&&s!==1)throw unsupported("orientation",s);switch(t.type){case 0:case 1:case 2:case 3:this.readStripData(t);break;default:throw unsupported("image type",t.type)}if(this.applyPredictor(t),this.convertAlpha(t),t.type===0){const l=t.bitsPerSample,f=Math.pow(2,l)-1;for(let m=0;m<t.data.length;m++)t.data[m]=f-t.data[m]}}readStripData(t){const s=t.width,l=t.height,f=t.bitsPerSample,m=t.sampleFormat,b=s*l*t.samplesPerPixel,h=getDataArray(b,f,m),M=t.rowsPerStrip*s*t.samplesPerPixel,C=t.stripOffsets,L=t.stripByteCounts||guessStripByteCounts(t);let N=b,F=0;for(let G=0;G<C.length;G++){let H=new DataView(this.buffer,this.byteOffset+C[G],L[G]),K=N>M?M:N;N-=K;let X=H;switch(t.compression){case 1:break;case 5:{X=decompressLzw(H);break}case 8:{X=decompressZlib(H);break}case 2:throw unsupported("Compression","CCITT Group 3");case 32773:throw unsupported("Compression","PackBits");default:throw unsupported("Compression",t.compression)}F=this.fillUncompressed(f,m,h,X,F,K)}t.data=h}fillUncompressed(t,s,l,f,m,b){if(t===8)return fill8bit(l,f,m,b);if(t===16)return fill16bit(l,f,m,b,this.isLittleEndian());if(t===32&&s===3)return fillFloat32(l,f,m,b,this.isLittleEndian());throw unsupported("bitDepth",t)}applyPredictor(t){const s=t.bitsPerSample;switch(t.predictor){case 1:break;case 2:{if(s===8)applyHorizontalDifferencing8Bit(t.data,t.width,t.components);else if(s===16)applyHorizontalDifferencing16Bit(t.data,t.width,t.components);else throw new Error(`Horizontal differencing is only supported for images with a bit depth of ${s}`);break}default:throw new Error(`invalid predictor: ${t.predictor}`)}}convertAlpha(t){if(t.alpha&&t.associatedAlpha){const{data:s,components:l,maxSampleValue:f}=t;for(let m=0;m<s.length;m+=l){const b=s[m+l-1];for(let h=0;h<l-1;h++)s[m+h]=Math.round(s[m+h]*f/b)}}}}function getDataArray(n,t,s){if(t===8)return new Uint8Array(n);if(t===16)return new Uint16Array(n);if(t===32&&s===3)return new Float32Array(n);throw unsupported("bit depth / sample format",`${t} / ${s}`)}function fill8bit(n,t,s,l){for(let f=0;f<l;f++)n[s++]=t.getUint8(f);return s}function fill16bit(n,t,s,l,f){for(let m=0;m<l*2;m+=2)n[s++]=t.getUint16(m,f);return s}function fillFloat32(n,t,s,l,f){for(let m=0;m<l*4;m+=4)n[s++]=t.getFloat32(m,f);return s}function unsupported(n,t){return new Error(`Unsupported ${n}: ${t}`)}function decodeTIFF(n,t){return new TIFFDecoder(n).decode(t)}function matchAndCrop(n={}){let{algorithm:t="matchToPrevious",ignoreBorder:s=[0,0]}=n;this.checkProcessable("matchAndCrop",{bitDepth:[8,16]});let l=t==="matchToPrevious",f=this[0],m=[];m[0]={position:[0,0],image:this[0]};let b=[0,0];for(let N=1;N<this.length;N++){let F=f.getBestMatch(this[N],{border:s});m[N]={position:[F[0]+b[0],F[1]+b[1]],image:this[N]},l&&(b[0]+=F[0],b[1]+=F[1],f=this[N])}let h=0,S=0,M=0,C=0;for(let N=0;N<m.length;N++){let F=m[N];F.position[0]>h&&(h=F.position[0]),F.position[0]<S&&(S=F.position[0]),F.position[1]>M&&(M=F.position[1]),F.position[1]<C&&(C=F.position[1])}S=0-S,C=0-C;for(let N=0;N<m.length;N++){let F=m[N];F.crop=F.image.crop({x:h-F.position[0],y:M-F.position[1],width:f.width-S-h,height:f.height-C-M})}let L=[];for(let N=0;N<m.length;N++)L[N]=m[N].crop;return new Stack(L)}function min$2(){this.checkProcessable("min",{bitDepth:[8,16]});let n=this[0].min;for(let t=1;t<this.length;t++)for(let s=0;s<n.length;s++)n[s]=Math.min(n[s],this[t].min[s]);return n}function max$2(){this.checkProcessable("min",{bitDepth:[8,16]});let n=this[0].max;for(let t=1;t<this.length;t++)for(let s=0;s<n.length;s++)n[s]=Math.max(n[s],this[t].max[s]);return n}function median$2(n){let t=n.reduce((b,h)=>b+h);if(t===0)throw new Error("unreachable");let s=0,l=0,f=t/2,m;for(;;){if(n[s]>0){if(m!==void 0)return(m+s)/2;if(l+=n[s],l>f)return s;l===f&&(m=s)}s++}}function mean$2(n){let t=0,s=0;for(let l=0;l<n.length;l++)t+=n[l],s+=n[l]*l;return t===0?0:s/t}function median$1(){this.checkProcessable("median",{bitDepth:[8,16]});let n=this.getHistograms({maxSlots:this[0].maxValue+1}),t=new Array(n.length);for(let s=0;s<n.length;s++){let l=n[s];t[s]=median$2(l)}return t}function histogram(n){this.checkProcessable("min",{bitDepth:[8,16]});let t=this[0].getHistogram(n);for(let s=1;s<this.length;s++){let l=this[s].getHistogram(n);for(let f=0;f<t.length;f++)t[f]+=l[f]}return t}function histograms(n){this.checkProcessable("min",{bitDepth:[8,16]});let t=this[0].getHistograms(n),s=t[0].length;for(let l=1;l<this.length;l++){let f=this[l].getHistograms(n);for(let m=0;m<t.length;m++)for(let b=0;b<s;b++)t[m][b]+=f[m][b]}return t}function averageImage(){this.checkProcessable("averageImage",{bitDepth:[8,16]});let n=new Uint32Array(this[0].data.length);for(let l=0;l<this.length;l++){let f=this[l];for(let m=0;m<this[0].data.length;m++)n[m]+=f.data[m]}let t=Image$1.createFrom(this[0]),s=t.data;for(let l=0;l<this[0].data.length;l++)s[l]=n[l]/this.length;return t}function maxImage(){this.checkProcessable("max",{bitDepth:[8,16]});let n=Image$1.createFrom(this[0]);n.data.fill(0);for(const t of this)for(let s=0;s<n.data.length;s++)n.data[s]=Math.max(t.data[s],n.data[s]);return n}function minImage(){this.checkProcessable("max",{bitDepth:[8,16]});let n=Image$1.createFrom(this[0]);n.data.fill(n.maxValue);for(const t of this)for(let s=0;s<n.data.length;s++)n.data[s]=Math.min(t.data[s],n.data[s]);return n}function extend$5(n){n.extendMethod("matchAndCrop",matchAndCrop),n.extendMethod("getMin",min$2),n.extendMethod("getMax",max$2),n.extendMethod("getMedian",median$1),n.extendMethod("getHistogram",histogram),n.extendMethod("getHistograms",histograms),n.extendMethod("getAverage",averageImage),n.extendMethod("getAverageImage",averageImage),n.extendMethod("getMaxImage",maxImage),n.extendMethod("getMinImage",minImage)}let computedPropertyDescriptor={configurable:!0,enumerable:!1,get:void 0};class Stack extends Array{constructor(t){if(Array.isArray(t)){super(t.length);for(let s=0;s<t.length;s++)this[s]=t[s]}else typeof t=="number"?super(t):super();this.computed=null}static load(t){return Promise.all(t.map(Image$1.load)).then(s=>new Stack(s))}static extendMethod(t,s,l={}){let{inPlace:f=!1,returnThis:m=!0,partialArgs:b=[]}=l;return f?Stack.prototype[t]=function(...h){this.computed=null;let S=s.apply(this,[...b,...h]);return m?this:S}:Stack.prototype[t]=function(...h){return s.apply(this,[...b,...h])},Stack}static extendProperty(t,s,l={}){let{partialArgs:f=[]}=l;return computedPropertyDescriptor.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(t,this.computed))return this.computed[t];let m=s.apply(this,f);return this.computed[t]=m,m},Object.defineProperty(Stack.prototype,t,computedPropertyDescriptor),Stack}checkProcessable(t,s={}){if(typeof t!="string")throw new TypeError("checkProcessable requires as first parameter the processName (a string)");if(this.size===0)throw new TypeError(`The process: ${t} can not be applied on an empty stack`);this[0].checkProcessable(t,s);for(let l=1;l<this.length;l++){if((s.sameSize===void 0||s.sameSize)&&this[0].width!==this[l].width)throw new TypeError(`The process: ${t} can not be applied if width is not identical in all images`);if((s.sameSize===void 0||s.sameSize)&&this[0].height!==this[l].height)throw new TypeError(`The process: ${t} can not be applied if height is not identical in all images`);if((s.sameAlpha===void 0||s.sameAlpha)&&this[0].alpha!==this[l].alpha)throw new TypeError(`The process: ${t} can not be applied if alpha is not identical in all images`);if((s.sameBitDepth===void 0||s.sameBitDepth)&&this[0].bitDepth!==this[l].bitDepth)throw new TypeError(`The process: ${t} can not be applied if bitDepth is not identical in all images`);if((s.sameColorModel===void 0||s.sameColorModel)&&this[0].colorModel!==this[l].colorModel)throw new TypeError(`The process: ${t} can not be applied if colorModel is not identical in all images`);if((s.sameNumberChannels===void 0||s.sameNumberChannels)&&this[0].channels!==this[l].channels)throw new TypeError(`The process: ${t} can not be applied if channels is not identical in all images`)}}}Array[Symbol.species]||(Stack.prototype.map=function(n,t){if(typeof n!="function")throw new TypeError(`${n} is not a function`);let s=new Stack(this.length);for(let l=0;l<this.length;l++)s[l]=n.call(t,this[l],l,this);return s});extend$5(Stack);const isDataURL=/^data:[a-z]+\/(?:[a-z]+);base64,/;function load(n,t){if(typeof n=="string")return loadURL(n,t);if(n instanceof ArrayBuffer)return Promise.resolve(loadBinary(new Uint8Array(n),void 0,t&&t.ignorePalette));if(n.buffer)return Promise.resolve(loadBinary(n,void 0,t&&t.ignorePalette));throw new Error('argument to "load" must be a string or buffer.')}function loadBinary(n,t,s){const l=imageType$1(n);if(l)switch(l.mime){case"image/png":return loadPNG(n);case"image/jpeg":return loadJPEG(n);case"image/tiff":return loadTIFF(n,s);default:return loadGeneric(f(l.mime))}return loadGeneric(f("application/octet-stream"));function f(m){return t||toBase64URL(n,m)}}function loadURL(n,t){const s=n.slice(0,64).match(isDataURL);let l;return s!==null?l=Promise.resolve(decode$4(n.slice(s[0].length))):l=fetchBinary(n,t),l.then(f=>{const m=new Uint8Array(f);return loadBinary(m,s?n:void 0,t&&t.ignorePalette)})}function loadPNG(n){const t=decodePng(n);let s=t.channels,l,f=0;return s===2||s===4?(l=s-1,f=1):l=s,t.palette?loadPNGFromPalette(t):new Image$1(t.width,t.height,t.data,{components:l,alpha:f,bitDepth:t.depth})}function loadPNGFromPalette(n){const t=n.width*n.height,s=n.palette[0].length,l=new Uint8Array(t*s),f=8/n.depth,m=n.depth<8?f:1,b=parseInt("1".repeat(n.depth),2),h=s===4;let S=0;for(let M=0;M<t;M++){const C=Math.floor(M/m);let L=n.data[C];n.depth<8&&(L=L>>>n.depth*(f-1-M%f)&b);const N=n.palette[L];l[S++]=N[0],l[S++]=N[1],l[S++]=N[2],h&&(l[S++]=N[3])}return new Image$1(n.width,n.height,l,{components:3,alpha:h,bitDepth:8})}function loadJPEG(n){const t=decode$1(n);let s;t.exif&&(s=getMetadata(t.exif));const l=jpegJs.decode(n,{useTArray:!0,maxMemoryUsageInMB:1024});let f=new Image$1(l.width,l.height,l.data,{meta:s});if(s&&s.tiff.tags.Orientation){const m=s.tiff.tags.Orientation;m>2&&(f=f.rotate({3:180,4:180,5:90,6:90,7:270,8:270}[m])),[2,4,5,7].includes(m)&&(f=f.flipX())}return f}function loadTIFF(n,t){let s=decodeTIFF(n);return s.length===1?getImageFromIFD(s[0],t):new Stack(s.map(function(l){return getImageFromIFD(l,t)}))}function getMetadata(n){const t={tiff:{fields:n.fields,tags:n.map}};return n.exif&&(t.exif=n.exif),n.gps&&(t.gps=n.gps),t}function getImageFromIFD(n,t){if(!t&&n.type===3){const s=new Uint16Array(3*n.width*n.height),l=n.palette;let f=0;for(let m=0;m<n.data.length;m++){const b=n.data[m],h=l[b];s[f++]=h[0],s[f++]=h[1],s[f++]=h[2]}return new Image$1(n.width,n.height,s,{components:3,alpha:n.alpha,colorModel:RGB$1,bitDepth:16,meta:getMetadata(n)})}else return new Image$1(n.width,n.height,n.data,{components:n.type===2?3:1,alpha:n.alpha,colorModel:n.type===2?RGB$1:GREY$1,bitDepth:n.bitsPerSample.length?n.bitsPerSample[0]:n.bitsPerSample,meta:getMetadata(n)})}function loadGeneric(n,t){return t=t||{},new Promise(function(s,l){let f=new DOMImage;f.onload=function(){let m=f.width,b=f.height,S=createCanvas(m,b).getContext("2d");S.drawImage(f,0,0,m,b);let M=S.getImageData(0,0,m,b).data;s(new Image$1(m,b,M,t))},f.onerror=function(){l(new Error(`Could not load ${n}`))},f.src=n})}const valueMethods={getValueXY(n,t,s){return this.data[(t*this.width+n)*this.channels+s]},setValueXY(n,t,s,l){return this.data[(t*this.width+n)*this.channels+s]=l,this.computed=null,this},getValue(n,t){return this.data[n*this.channels+t]},setValue(n,t,s){return this.data[n*this.channels+t]=s,this.computed=null,this},getPixelXY(n,t){return this.getPixel(t*this.width+n)},setPixelXY(n,t,s){return this.setPixel(t*this.width+n,s)},getPixel(n){const t=new Array(this.channels),s=n*this.channels;for(let l=0;l<this.channels;l++)t[l]=this.data[s+l];return t},setPixel(n,t){const s=n*this.channels;for(let l=0;l<t.length;l++)this.data[s+l]=t[l];return this.computed=null,this}};function setValueMethods(n){for(const t in valueMethods)n.prototype[t]=valueMethods[t]}function getImageParameters(n){return{width:n.width,height:n.height,components:n.components,alpha:n.alpha,colorModel:n.colorModel,bitDepth:n.bitDepth}}function getOutputImage(n,t,s,l={}){const{out:f}=t;if(f===void 0)return l.copy?n.clone():Image$1.createFrom(n,s);{if(!Image$1.isImage(f))throw new TypeError("out must be an Image object");const m=Object.assign(getImageParameters(n),s);for(const b in m)if(f[b]!==m[b])throw new RangeError(`cannot use out. Its ${b} must be "${m[b]}" (found "${f[b]}")`);return f}}function getOutputImageOrInPlace(n,t,s){if(t.inPlace!==void 0&&typeof t.inPlace!="boolean")throw new TypeError("inPlace option must be a boolean");if(t.inPlace){if(t.out!==void 0)throw new TypeError("out option must not be set if inPlace option is true");return n}return getOutputImage(n,t,null,s)}function abs(n={}){this.checkProcessable("abs",{bitDepth:[32]});const t=getOutputImageOrInPlace(this,n);return absolute(this,t),t}function absolute(n,t){for(let s=0;s<n.data.length;s++)t.data[s]=Math.abs(n.data[s])}function copyAlphaChannel(n,t){if(n.alpha===1&&t.alpha===1)for(let s=0;s<n.size;s++)t.data[s*t.channels+t.components]=n.data[s*n.channels+n.components]}function invert(n={}){this.checkProcessable("invert",{bitDepth:[1,8,16]});const t=getOutputImageOrInPlace(this,n);return this.bitDepth===1?invertBinary(this,t):(invertColor(this,t),this!==t&&copyAlphaChannel(this,t)),t}function invertBinary(n,t){for(let s=0;s<n.data.length;s++)t.data[s]=~n.data[s]}function invertColor(n,t){for(let s=0;s<n.data.length;s+=n.channels)for(let l=0;l<n.components;l++)t.data[s+l]=n.maxValue-n.data[s+l]}function flipX(){this.checkProcessable("flipX",{bitDepth:[8,16]});for(let n=0;n<this.height;n++){let t=n*this.width*this.channels;for(let s=0;s<Math.floor(this.width/2);s++){let l=s*this.channels+t,f=(this.width-s-1)*this.channels+t;for(let m=0;m<this.channels;m++){let b=this.data[l+m];this.data[l+m]=this.data[f+m],this.data[f+m]=b}}}return this}function flipY(){this.checkProcessable("flipY",{bitDepth:[8,16]});for(let n=0;n<Math.floor(this.height/2);n++)for(let t=0;t<this.width;t++){let s=t*this.channels+n*this.width*this.channels,l=t*this.channels+(this.height-1-n)*this.channels*this.width;for(let f=0;f<this.channels;f++){let m=this.data[s+f];this.data[s+f]=this.data[l+f],this.data[l+f]=m}}return this}function blurFilter(n={}){const{radius:t=1}=n;if(t<1)throw new Error("radius must be greater than 1");const s=2*t+1,l=new Array(s);for(let f=0;f<s;f++){l[f]=new Array(s);for(let m=0;m<s;m++)l[f][m]=1/(s*s)}return this.convolution(l)}var medianQuickselect_min={exports:{}};(function(n){(function(){function t(f){for(var m=0,b=f.length-1,h=void 0,S=void 0,M=void 0,C=l(m,b);;){if(b<=m)return f[C];if(b==m+1)return f[m]>f[b]&&s(f,m,b),f[C];for(h=l(m,b),f[h]>f[b]&&s(f,h,b),f[m]>f[b]&&s(f,m,b),f[h]>f[m]&&s(f,h,m),s(f,h,m+1),S=m+1,M=b;;){do S++;while(f[m]>f[S]);do M--;while(f[M]>f[m]);if(M<S)break;s(f,S,M)}s(f,m,M),M<=C&&(m=S),M>=C&&(b=M-1)}}var s=function(m,b,h){var S;return S=[m[h],m[b]],m[b]=S[0],m[h]=S[1],S},l=function(m,b){return~~((m+b)/2)};n.exports?n.exports=t:window.median=t})()})(medianQuickselect_min);var quickSelectMedian=medianQuickselect_min.exports;function validateArrayOfChannels(n,t={}){let{channels:s,allowAlpha:l,defaultAlpha:f}=t;return typeof l!="boolean"&&(l=!0),typeof s=="undefined"?allChannels(n,f):validateChannels(n,s,l)}function allChannels(n,t){let s=t?n.channels:n.components,l=new Array(s);for(let f=0;f<s;f++)l[f]=f;return l}function validateChannels(n,t,s){Array.isArray(t)||(t=[t]);for(let l=0;l<t.length;l++)t[l]=validateChannel(n,t[l],s);return t}function validateChannel(n,t,s=!0){if(t===void 0)throw new RangeError(`validateChannel : the channel has to be >=0 and <${n.channels}`);if(typeof t=="string"){switch(n.colorModel){case GREY$1:break;case RGB$1:if("rgb".includes(t))switch(t){case"r":t=0;break;case"g":t=1;break;case"b":t=2;break}break;case HSL:if("hsl".includes(t))switch(t){case"h":t=0;break;case"s":t=1;break;case"l":t=2;break}break;case HSV:if("hsv".includes(t))switch(t){case"h":t=0;break;case"s":t=1;break;case"v":t=2;break}break;case CMYK$1:if("cmyk".includes(t))switch(t){case"c":t=0;break;case"m":t=1;break;case"y":t=2;break;case"k":t=3;break}break;default:throw new Error(`Unexpected color model: ${n.colorModel}`)}if(t==="a"){if(!n.alpha)throw new Error("validateChannel : the image does not contain alpha channel");t=n.components}if(typeof t=="string")throw new Error(`validateChannel : undefined channel: ${t}`)}if(t>=n.channels)throw new RangeError(`validateChannel : the channel has to be >=0 and <${n.channels}`);if(!s&&t>=n.components)throw new RangeError("validateChannel : alpha channel may not be selected");return t}function medianFilter(n={}){let{radius:t=1,border:s="copy",channels:l}=n;if(this.checkProcessable("medianFilter",{bitDepth:[8,16]}),t<1)throw new Error("radius must be greater than 0");l=validateArrayOfChannels(this,l);let f=t,m=t,b=Image$1.createFrom(this),h=(f*2+1)*(m*2+1),S=new Array(h);for(let M=0;M<l.length;M++){let C=l[M];for(let L=m;L<this.height-m;L++)for(let N=f;N<this.width-f;N++){let F=0;for(let H=-m;H<=m;H++)for(let K=-f;K<=f;K++){let X=((L+H)*this.width+N+K)*this.channels+C;S[F++]=this.data[X]}let G=(L*this.width+N)*this.channels+C;b.data[G]=quickSelectMedian(S)}}if(this.alpha&&!l.includes(this.channels))for(let M=this.components;M<this.data.length;M=M+this.channels)b.data[M]=this.data[M];return b.setBorder({size:[f,m],algorithm:s}),b}function gaussianFilter(n={}){let{radius:t=1,sigma:s,channels:l,border:f="copy"}=n;this.checkProcessable("gaussian",{bitDepth:[8,16]});const m=getKernel(t,s);return this.convolution([m,m],{border:f,channels:l,algorithm:"separable"})}function getKernel(n,t){const s=n*2+1,l=new Array(s),f=t||((s-1)*.5-1)*.3+.8,m=-.5/(f*f);let b=0;for(let h=0;h<s;h++){const S=h-n,M=Math.exp(m*S*S);l[h]=M,b+=M}for(let h=0;h<s;h++)l[h]/=b;return l}const SOBEL_X=[[-1,0,1],[-2,0,2],[-1,0,1]],SOBEL_Y=[[-1,-2,-1],[0,0,0],[1,2,1]],SCHARR_X=[[3,0,-3],[10,0,-10],[3,0,-3]],SCHARR_Y=[[3,10,3],[0,0,0],[-3,-10,-3]];var src$3={},fftlib={};(function(n){(function(){var t;t=n;var s={release:"0.3.0",date:"2013-03"};t.toString=function(){return"version "+s.release+", released "+s.date};for(var l=0,f=null,m=null,b={init:function(M){if(M!==0&&(M&M-1)===0)l=M,b._initArray(),b._makeBitReversalTable(),b._makeCosSinTable();else throw new Error("init: radix-2 required")},fft1d:function(M,C){b.fft(M,C,1)},ifft1d:function(M,C){var L=1/l;b.fft(M,C,-1);for(var N=0;N<l;N++)M[N]*=L,C[N]*=L},bt1d:function(M,C){b.fft(M,C,-1)},fft2d:function(M,C){for(var L=[],N=[],F=0,G=0;G<l;G++){F=G*l;for(var H=0;H<l;H++)L[H]=M[H+F],N[H]=C[H+F];b.fft1d(L,N);for(var K=0;K<l;K++)M[K+F]=L[K],C[K+F]=N[K]}for(var X=0;X<l;X++){for(var de=0;de<l;de++)F=X+de*l,L[de]=M[F],N[de]=C[F];b.fft1d(L,N);for(var Q=0;Q<l;Q++)F=X+Q*l,M[F]=L[Q],C[F]=N[Q]}},ifft2d:function(M,C){for(var L=[],N=[],F=0,G=0;G<l;G++){F=G*l;for(var H=0;H<l;H++)L[H]=M[H+F],N[H]=C[H+F];b.ifft1d(L,N);for(var K=0;K<l;K++)M[K+F]=L[K],C[K+F]=N[K]}for(var X=0;X<l;X++){for(var de=0;de<l;de++)F=X+de*l,L[de]=M[F],N[de]=C[F];b.ifft1d(L,N);for(var Q=0;Q<l;Q++)F=X+Q*l,M[F]=L[Q],C[F]=N[Q]}},fft:function(M,C,L){for(var N,F,G,H,K,X,de,Q,ie,ce=l>>2,ge=0;ge<l;ge++)H=f[ge],ge<H&&(K=M[ge],M[ge]=M[H],M[H]=K,K=C[ge],C[ge]=C[H],C[H]=K);for(var be=1;be<l;be<<=1){F=0,N=l/(be<<1);for(var ne=0;ne<be;ne++){X=m[F+ce],de=L*m[F];for(var ve=ne;ve<l;ve+=be<<1)G=ve+be,Q=X*M[G]+de*C[G],ie=X*C[G]-de*M[G],M[G]=M[ve]-Q,M[ve]+=Q,C[G]=C[ve]-ie,C[ve]+=ie;F+=N}}},_initArray:function(){typeof Uint32Array!="undefined"?f=new Uint32Array(l):f=[],typeof Float64Array!="undefined"?m=new Float64Array(l*1.25):m=[]},_paddingZero:function(){},_makeBitReversalTable:function(){var M=0,C=0,L=0;for(f[0]=0;++M<l;){for(L=l>>1;L<=C;)C-=L,L>>=1;C+=L,f[M]=C}},_makeCosSinTable:function(){var M=l>>1,C=l>>2,L=l>>3,N=M+C,F=Math.sin(Math.PI/l),G=2*F*F,H=Math.sqrt(G*(2-G)),K=m[C]=1,X=m[0]=0;F=2*G;for(var de=1;de<L;de++)K-=G,G+=F*K,X+=H,H-=F*X,m[de]=X,m[C-de]=K;L!==0&&(m[L]=Math.sqrt(.5));for(var Q=0;Q<C;Q++)m[M-Q]=m[Q];for(var ie=0;ie<N;ie++)m[ie+M]=-m[ie]}},h=["init","fft1d","ifft1d","fft2d","ifft2d"],S=0;S<h.length;S++)t[h[S]]=b[h[S]];return t.bt=b.bt1d,t.fft=b.fft1d,t.ifft=b.ifft1d,t}).call(commonjsGlobal)})(fftlib);var FFT=fftlib,FFTUtils$1={DEBUG:!1,ifft2DArray:function(n,t,s){var l=new Array(t*s),f=t/2,m=(s-1)*2;FFT.init(f);for(var b={re:new Array(f),im:new Array(f)},h=0;h<s;h++){for(var S=f-1;S>=0;S--)b.re[S]=n[S*2*s+h],b.im[S]=n[(S*2+1)*s+h];FFT.bt(b.re,b.im);for(var S=f-1;S>=0;S--)l[S*2*s+h]=b.re[S],l[(S*2+1)*s+h]=b.im[S]}var M=new Array(f*m);FFT.init(m);for(var C={re:new Array(m),im:new Array(m)},L=m*f,S=0;S<t;S+=2){C.re[0]=l[S*s],C.im[0]=l[(S+1)*s];for(var h=1;h<s;h++)C.re[h]=l[S*s+h],C.im[h]=l[(S+1)*s+h],C.re[m-h]=l[S*s+h],C.im[m-h]=-l[(S+1)*s+h];FFT.bt(C.re,C.im);for(var N=S/2*m,h=m-1;h>=0;h--)M[N+h]=C.re[h]/L}return M},fft2DArray:function(n,t,s,l){Object.assign({},{inplace:!0});var f=s/2+1,m=t*2,b=new Array(m*f);FFT.init(s);for(var h={re:new Array(s),im:new Array(s)},S={re:new Array(s),im:new Array(s)},M={re:new Array(s),im:new Array(s)},C,L,N,F,G,H=0;H<t/2;H++){C=H*2*s,h.re=n.slice(C,C+s),C=(H*2+1)*s,h.im=n.slice(C,C+s),FFT.fft1d(h.re,h.im),this.reconstructTwoRealFFT(h,S,M),L=H*4*f,N=(H*4+1)*f,F=(H*4+2)*f,G=(H*4+3)*f;for(var K=f-1;K>=0;K--)b[L+K]=S.re[K],b[N+K]=S.im[K],b[F+K]=M.re[K],b[G+K]=M.im[K]}S=null,M=null;var X=new Array(m*f);FFT.init(t);for(var de={re:new Array(t),im:new Array(t)},Q=f-1;Q>=0;Q--){for(var H=t-1;H>=0;H--)de.re[H]=b[H*2*f+Q],de.im[H]=b[(H*2+1)*f+Q],isNaN(de.re[H])&&(de.re[H]=0),isNaN(de.im[H])&&(de.im[H]=0);FFT.fft1d(de.re,de.im);for(var H=t-1;H>=0;H--)X[H*2*f+Q]=de.re[H],X[(H*2+1)*f+Q]=de.im[H]}return X},reconstructTwoRealFFT:function(n,t,s){var l=n.re.length;t.re[0]=n.re[0],t.im[0]=0,s.re[0]=n.im[0],s.im[0]=0;for(var f,m,b,h,S,M=l/2;M>0;M--)S=l-M,f=.5*(n.re[M]-n.re[S]),m=.5*(n.re[M]+n.re[S]),b=.5*(n.im[M]-n.im[S]),h=.5*(n.im[M]+n.im[S]),t.re[M]=m,t.im[M]=b,t.re[S]=m,t.im[S]=-b,s.re[M]=h,s.im[M]=-f,s.re[S]=h,s.im[S]=f},convolute2DI:function(n,t,s,l){for(var f,m,b=0;b<s/2;b++)for(var h=0;h<l;h++)f=n[b*2*l+h]*t[b*2*l+h]-n[(b*2+1)*l+h]*t[(b*2+1)*l+h],m=n[b*2*l+h]*t[(b*2+1)*l+h]+n[(b*2+1)*l+h]*t[b*2*l+h],n[b*2*l+h]=f,n[(b*2+1)*l+h]=m},convolute:function(n,t,s,l,f){for(var m=new Array(l*s),b=0;b<s*l;b++)m[b]=n[b];m=this.fft2DArray(m,s,l);for(var h=t.length,S=t[0].length,M=new Array(l*s),b=0;b<l*s;b++)M[b]=0;for(var C,L,N=Math.floor((h-1)/2),F=Math.floor((S-1)/2),G=0;G<h;G++){C=(G-N+s)%s;for(var H=0;H<S;H++)L=(H-F+l)%l,M[C*l+L]=t[G][H]}M=this.fft2DArray(M,s,l);var K=s*2,X=l/2+1;return this.convolute2DI(m,M,K,X),this.ifft2DArray(m,K,X)},toRadix2:function(n,t,s){var l,f,m,b,h=s,S=t;if(!(s!==0&&(s&s-1)===0)){for(h=0;s>>++h!=0;);h=1<<h}if(!(t!==0&&(t&t-1)===0)){for(S=0;t>>++S!=0;);S=1<<S}if(S==t&&h==s)return{data:n,rows:t,cols:s};var M=new Array(S*h),C=Math.floor((S-t)/2)-t,L=Math.floor((h-s)/2)-s;for(l=0;l<S;l++)for(m=l*h,b=(l-C)%t*s,f=0;f<h;f++)M[m+f]=n[b+(f-L)%s];return{data:M,rows:S,cols:h}},crop:function(n,t,s,l,f,m){if(t==l&&s==f)return n;Object.assign({},m);var b=new Array(f*l),h=Math.floor((t-l)/2),S=Math.floor((s-f)/2),M,C,L,N;for(L=0;L<l;L++)for(M=L*f,C=(L+h)*s,N=0;N<f;N++)b[M+N]=n[C+(N+S)];return b}},FFTUtils_1=FFTUtils$1;src$3.FFTUtils=FFTUtils_1;src$3.FFT=fftlib;var FFTUtils=src$3.FFTUtils;function convolutionFFT(n,t,s){var l=matrix2Array(n),f=l.data,m=Object.assign({normalize:!1,divisor:1,rows:l.rows,cols:l.cols},s),b,h;if(m.rows&&m.cols)b=m.rows,h=m.cols;else throw new Error("Invalid number of rows or columns "+b+" "+h);var S=m.divisor,M,C,L=t.length,N=t[0].length;if(m.normalize)for(S=0,M=0;M<L;M++)for(C=0;C<N;C++)S+=t[M][C];if(S===0)throw new RangeError("convolution: The divisor is equal to zero");var F=FFTUtils.toRadix2(f,b,h),G=FFTUtils.convolute(F.data,t,F.rows,F.cols);if(G=FFTUtils.crop(G,F.rows,F.cols,b,h),S!=0&&S!=1)for(M=0;M<G.length;M++)G[M]/=S;return G}function convolutionDirect(n,t,s){var l=matrix2Array(n),f=l.data,m=Object.assign({normalize:!1,divisor:1,rows:l.rows,cols:l.cols},s),b,h;if(m.rows&&m.cols)b=m.rows,h=m.cols;else throw new Error("Invalid number of rows or columns "+b+" "+h);var S=m.divisor,M=t.length,C=t[0].length,L,N,F,G,H,K,X,de,Q;if(m.normalize)for(S=0,L=0;L<M;L++)for(N=0;N<C;N++)S+=t[L][N];if(S===0)throw new RangeError("convolution: The divisor is equal to zero");var ie=new Array(b*h),ce=Math.floor(M/2),ge=Math.floor(C/2);for(G=0;G<b;G++)for(F=0;F<h;F++){for(K=0,N=0;N<M;N++)for(L=0;L<C;L++)X=t[M-N-1][C-L-1],de=(G+N-ce+b)%b,Q=(F+L-ge+h)%h,H=de*h+Q,K+=f[H]*X;H=G*h+F,ie[H]=K/S}return ie}function LoG(n,t,s){var l=1e3;s&&s.factor&&(l=s.factor);var f=new Array(t),m,b,h,S;l*=-1;var M=(t-1)/2,C=2*n*n;for(m=0;m<t;m++)for(f[m]=new Array(t),S=(m-M)*(m-M),b=0;b<t;b++)h=-((b-M)*(b-M)+S)/C,f[m][b]=Math.round(l*(1+h)*Math.exp(h));return f}function matrix2Array(n){var t=n,s,l;if(typeof n[0]!="number"){s=n.length,l=n[0].length,t=new Array(s*l);for(var f=0;f<s;f++)for(var m=0;m<l;m++)t[f*l+m]=n[f][m]}else{var b=Math.sqrt(n.length);Number.isInteger(b)&&(s=b,l=b)}return{data:t,rows:s,cols:l}}var src$2={fft:convolutionFFT,direct:convolutionDirect,kernelFactory:{LoG},matrix2Array},_isFinite=Number.isFinite||function(n){return!(typeof n!="number"||n!==n||n===1/0||n===-1/0)},isFinite$1=_isFinite,isInteger=Number.isInteger||function(n){return typeof n=="number"&&isFinite$1(n)&&Math.floor(n)===n};function validateKernel(n){let t,s;if(Array.isArray(n))if(Array.isArray(n[0])){if((n.length&1)===0||(n[0].length&1)===0)throw new RangeError("validateKernel: Kernel rows and columns should be odd numbers");t=Math.floor(n.length/2),s=Math.floor(n[0].length/2)}else{let l=Math.sqrt(n.length);if(isInteger(l))s=t=Math.floor(Math.sqrt(n.length)/2);else throw new RangeError("validateKernel: Kernel array should be a square");let f=new Array(l);for(let m=0;m<l;m++){f[m]=new Array(l);for(let b=0;b<l;b++)f[m][b]=n[m*l+b]}n=f}else throw new Error(`validateKernel: Invalid Kernel: ${n}`);return{kernel:n,kWidth:s,kHeight:t}}function clamp(n,t){return Math.round(Math.min(Math.max(n,0),t.maxValue))}function directConvolution(n,t,s){if(s===void 0){const m=n.length+t.length-1;s=new Array(m)}fill(s);for(var l=0;l<n.length;l++)for(var f=0;f<t.length;f++)s[l+f]+=n[l]*t[f];return s}function fill(n){for(var t=0;t<n.length;t++)n[t]=0}function convolutionSeparable(n,t,s,l){const f=new Array(n.length);let m,b,h,S;S=t[1],h=(S.length-1)/2,b=new Array(s+S.length-1),m=new Array(s);for(let M=0;M<l;M++){for(let C=0;C<s;C++)m[C]=n[M*s+C];directConvolution(m,S,b);for(let C=0;C<s;C++)f[M*s+C]=b[h+C]}S=t[0],h=(S.length-1)/2,b=new Array(l+S.length-1),m=new Array(l);for(let M=0;M<s;M++){for(let C=0;C<l;C++)m[C]=f[C*s+M];directConvolution(m,S,b);for(let C=0;C<l;C++)f[C*s+M]=b[h+C]}return f}const toString$2=Object.prototype.toString;function isAnyArray(n){return toString$2.call(n).endsWith("Array]")}function max$1(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(n))throw new TypeError("input must be an array");if(n.length===0)throw new TypeError("input must not be empty");var s=t.fromIndex,l=s===void 0?0:s,f=t.toIndex,m=f===void 0?n.length:f;if(l<0||l>=n.length||!Number.isInteger(l))throw new Error("fromIndex must be a positive integer smaller than length");if(m<=l||m>n.length||!Number.isInteger(m))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var b=n[l],h=l+1;h<m;h++)n[h]>b&&(b=n[h]);return b}function min$1(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(n))throw new TypeError("input must be an array");if(n.length===0)throw new TypeError("input must not be empty");var s=t.fromIndex,l=s===void 0?0:s,f=t.toIndex,m=f===void 0?n.length:f;if(l<0||l>=n.length||!Number.isInteger(l))throw new Error("fromIndex must be a positive integer smaller than length");if(m<=l||m>n.length||!Number.isInteger(m))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var b=n[l],h=l+1;h<m;h++)n[h]<b&&(b=n[h]);return b}function rescale(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(isAnyArray(n)){if(n.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var s;if(t.output!==void 0){if(!isAnyArray(t.output))throw new TypeError("output option must be an array if specified");s=t.output}else s=new Array(n.length);var l=min$1(n),f=max$1(n);if(l===f)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var m=t.min,b=m===void 0?t.autoMinMax?l:0:m,h=t.max,S=h===void 0?t.autoMinMax?f:1:h;if(b>=S)throw new RangeError("min option must be smaller than max option");for(var M=(S-b)/(f-l),C=0;C<n.length;C++)s[C]=(n[C]-l)*M+b;return s}const indent=" ".repeat(2),indentData=" ".repeat(4);function inspectMatrix(){return inspectMatrixWithOptions(this)}function inspectMatrixWithOptions(n,t={}){const{maxRows:s=15,maxColumns:l=10,maxNumSize:f=8}=t;return`${n.constructor.name} {
${indent}[
${indentData}${inspectData(n,s,l,f)}
${indent}]
${indent}rows: ${n.rows}
${indent}columns: ${n.columns}
}`}function inspectData(n,t,s,l){const{rows:f,columns:m}=n,b=Math.min(f,t),h=Math.min(m,s),S=[];for(let M=0;M<b;M++){let C=[];for(let L=0;L<h;L++)C.push(formatNumber(n.get(M,L),l));S.push(`${C.join(" ")}`)}return h!==m&&(S[S.length-1]+=` ... ${m-s} more columns`),b!==f&&S.push(`... ${f-t} more rows`),S.join(`
${indentData}`)}function formatNumber(n,t){const s=String(n);if(s.length<=t)return s.padEnd(t," ");const l=n.toPrecision(t-2);if(l.length<=t)return l;const f=n.toExponential(t-2),m=f.indexOf("e"),b=f.slice(m);return f.slice(0,t-b.length)+b}function installMathOperations(n,t){n.prototype.add=function(l){return typeof l=="number"?this.addS(l):this.addM(l)},n.prototype.addS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)+l);return this},n.prototype.addM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)+l.get(f,m));return this},n.add=function(l,f){return new t(l).add(f)},n.prototype.sub=function(l){return typeof l=="number"?this.subS(l):this.subM(l)},n.prototype.subS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)-l);return this},n.prototype.subM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)-l.get(f,m));return this},n.sub=function(l,f){return new t(l).sub(f)},n.prototype.subtract=n.prototype.sub,n.prototype.subtractS=n.prototype.subS,n.prototype.subtractM=n.prototype.subM,n.subtract=n.sub,n.prototype.mul=function(l){return typeof l=="number"?this.mulS(l):this.mulM(l)},n.prototype.mulS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)*l);return this},n.prototype.mulM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)*l.get(f,m));return this},n.mul=function(l,f){return new t(l).mul(f)},n.prototype.multiply=n.prototype.mul,n.prototype.multiplyS=n.prototype.mulS,n.prototype.multiplyM=n.prototype.mulM,n.multiply=n.mul,n.prototype.div=function(l){return typeof l=="number"?this.divS(l):this.divM(l)},n.prototype.divS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)/l);return this},n.prototype.divM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)/l.get(f,m));return this},n.div=function(l,f){return new t(l).div(f)},n.prototype.divide=n.prototype.div,n.prototype.divideS=n.prototype.divS,n.prototype.divideM=n.prototype.divM,n.divide=n.div,n.prototype.mod=function(l){return typeof l=="number"?this.modS(l):this.modM(l)},n.prototype.modS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)%l);return this},n.prototype.modM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)%l.get(f,m));return this},n.mod=function(l,f){return new t(l).mod(f)},n.prototype.modulus=n.prototype.mod,n.prototype.modulusS=n.prototype.modS,n.prototype.modulusM=n.prototype.modM,n.modulus=n.mod,n.prototype.and=function(l){return typeof l=="number"?this.andS(l):this.andM(l)},n.prototype.andS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)&l);return this},n.prototype.andM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)&l.get(f,m));return this},n.and=function(l,f){return new t(l).and(f)},n.prototype.or=function(l){return typeof l=="number"?this.orS(l):this.orM(l)},n.prototype.orS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)|l);return this},n.prototype.orM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)|l.get(f,m));return this},n.or=function(l,f){return new t(l).or(f)},n.prototype.xor=function(l){return typeof l=="number"?this.xorS(l):this.xorM(l)},n.prototype.xorS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)^l);return this},n.prototype.xorM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)^l.get(f,m));return this},n.xor=function(l,f){return new t(l).xor(f)},n.prototype.leftShift=function(l){return typeof l=="number"?this.leftShiftS(l):this.leftShiftM(l)},n.prototype.leftShiftS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)<<l);return this},n.prototype.leftShiftM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)<<l.get(f,m));return this},n.leftShift=function(l,f){return new t(l).leftShift(f)},n.prototype.signPropagatingRightShift=function(l){return typeof l=="number"?this.signPropagatingRightShiftS(l):this.signPropagatingRightShiftM(l)},n.prototype.signPropagatingRightShiftS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)>>l);return this},n.prototype.signPropagatingRightShiftM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)>>l.get(f,m));return this},n.signPropagatingRightShift=function(l,f){return new t(l).signPropagatingRightShift(f)},n.prototype.rightShift=function(l){return typeof l=="number"?this.rightShiftS(l):this.rightShiftM(l)},n.prototype.rightShiftS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)>>>l);return this},n.prototype.rightShiftM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,this.get(f,m)>>>l.get(f,m));return this},n.rightShift=function(l,f){return new t(l).rightShift(f)},n.prototype.zeroFillRightShift=n.prototype.rightShift,n.prototype.zeroFillRightShiftS=n.prototype.rightShiftS,n.prototype.zeroFillRightShiftM=n.prototype.rightShiftM,n.zeroFillRightShift=n.rightShift,n.prototype.not=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,~this.get(l,f));return this},n.not=function(l){return new t(l).not()},n.prototype.abs=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.abs(this.get(l,f)));return this},n.abs=function(l){return new t(l).abs()},n.prototype.acos=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.acos(this.get(l,f)));return this},n.acos=function(l){return new t(l).acos()},n.prototype.acosh=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.acosh(this.get(l,f)));return this},n.acosh=function(l){return new t(l).acosh()},n.prototype.asin=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.asin(this.get(l,f)));return this},n.asin=function(l){return new t(l).asin()},n.prototype.asinh=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.asinh(this.get(l,f)));return this},n.asinh=function(l){return new t(l).asinh()},n.prototype.atan=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.atan(this.get(l,f)));return this},n.atan=function(l){return new t(l).atan()},n.prototype.atanh=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.atanh(this.get(l,f)));return this},n.atanh=function(l){return new t(l).atanh()},n.prototype.cbrt=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.cbrt(this.get(l,f)));return this},n.cbrt=function(l){return new t(l).cbrt()},n.prototype.ceil=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.ceil(this.get(l,f)));return this},n.ceil=function(l){return new t(l).ceil()},n.prototype.clz32=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.clz32(this.get(l,f)));return this},n.clz32=function(l){return new t(l).clz32()},n.prototype.cos=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.cos(this.get(l,f)));return this},n.cos=function(l){return new t(l).cos()},n.prototype.cosh=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.cosh(this.get(l,f)));return this},n.cosh=function(l){return new t(l).cosh()},n.prototype.exp=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.exp(this.get(l,f)));return this},n.exp=function(l){return new t(l).exp()},n.prototype.expm1=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.expm1(this.get(l,f)));return this},n.expm1=function(l){return new t(l).expm1()},n.prototype.floor=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.floor(this.get(l,f)));return this},n.floor=function(l){return new t(l).floor()},n.prototype.fround=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.fround(this.get(l,f)));return this},n.fround=function(l){return new t(l).fround()},n.prototype.log=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.log(this.get(l,f)));return this},n.log=function(l){return new t(l).log()},n.prototype.log1p=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.log1p(this.get(l,f)));return this},n.log1p=function(l){return new t(l).log1p()},n.prototype.log10=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.log10(this.get(l,f)));return this},n.log10=function(l){return new t(l).log10()},n.prototype.log2=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.log2(this.get(l,f)));return this},n.log2=function(l){return new t(l).log2()},n.prototype.round=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.round(this.get(l,f)));return this},n.round=function(l){return new t(l).round()},n.prototype.sign=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.sign(this.get(l,f)));return this},n.sign=function(l){return new t(l).sign()},n.prototype.sin=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.sin(this.get(l,f)));return this},n.sin=function(l){return new t(l).sin()},n.prototype.sinh=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.sinh(this.get(l,f)));return this},n.sinh=function(l){return new t(l).sinh()},n.prototype.sqrt=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.sqrt(this.get(l,f)));return this},n.sqrt=function(l){return new t(l).sqrt()},n.prototype.tan=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.tan(this.get(l,f)));return this},n.tan=function(l){return new t(l).tan()},n.prototype.tanh=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.tanh(this.get(l,f)));return this},n.tanh=function(l){return new t(l).tanh()},n.prototype.trunc=function(){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.set(l,f,Math.trunc(this.get(l,f)));return this},n.trunc=function(l){return new t(l).trunc()},n.pow=function(l,f){return new t(l).pow(f)},n.prototype.pow=function(l){return typeof l=="number"?this.powS(l):this.powM(l)},n.prototype.powS=function(l){for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,Math.pow(this.get(f,m),l));return this},n.prototype.powM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let f=0;f<this.rows;f++)for(let m=0;m<this.columns;m++)this.set(f,m,Math.pow(this.get(f,m),l.get(f,m)));return this}}function checkRowIndex(n,t,s){let l=s?n.rows:n.rows-1;if(t<0||t>l)throw new RangeError("Row index out of range")}function checkColumnIndex(n,t,s){let l=s?n.columns:n.columns-1;if(t<0||t>l)throw new RangeError("Column index out of range")}function checkRowVector(n,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==n.columns)throw new RangeError("vector size must be the same as the number of columns");return t}function checkColumnVector(n,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==n.rows)throw new RangeError("vector size must be the same as the number of rows");return t}function checkRowIndices(n,t){if(!isAnyArray(t))throw new TypeError("row indices must be an array");for(let s=0;s<t.length;s++)if(t[s]<0||t[s]>=n.rows)throw new RangeError("row indices are out of range")}function checkColumnIndices(n,t){if(!isAnyArray(t))throw new TypeError("column indices must be an array");for(let s=0;s<t.length;s++)if(t[s]<0||t[s]>=n.columns)throw new RangeError("column indices are out of range")}function checkRange(n,t,s,l,f){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(checkNumber("startRow",t),checkNumber("endRow",s),checkNumber("startColumn",l),checkNumber("endColumn",f),t>s||l>f||t<0||t>=n.rows||s<0||s>=n.rows||l<0||l>=n.columns||f<0||f>=n.columns)throw new RangeError("Submatrix indices are out of range")}function newArray$1(n,t=0){let s=[];for(let l=0;l<n;l++)s.push(t);return s}function checkNumber(n,t){if(typeof t!="number")throw new TypeError(`${n} must be a number`)}function checkNonEmpty(n){if(n.isEmpty())throw new Error("Empty matrix has no elements to index")}function sumByRow(n){let t=newArray$1(n.rows);for(let s=0;s<n.rows;++s)for(let l=0;l<n.columns;++l)t[s]+=n.get(s,l);return t}function sumByColumn(n){let t=newArray$1(n.columns);for(let s=0;s<n.rows;++s)for(let l=0;l<n.columns;++l)t[l]+=n.get(s,l);return t}function sumAll(n){let t=0;for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)t+=n.get(s,l);return t}function productByRow(n){let t=newArray$1(n.rows,1);for(let s=0;s<n.rows;++s)for(let l=0;l<n.columns;++l)t[s]*=n.get(s,l);return t}function productByColumn(n){let t=newArray$1(n.columns,1);for(let s=0;s<n.rows;++s)for(let l=0;l<n.columns;++l)t[l]*=n.get(s,l);return t}function productAll(n){let t=1;for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)t*=n.get(s,l);return t}function varianceByRow(n,t,s){const l=n.rows,f=n.columns,m=[];for(let b=0;b<l;b++){let h=0,S=0,M=0;for(let C=0;C<f;C++)M=n.get(b,C)-s[b],h+=M,S+=M*M;t?m.push((S-h*h/f)/(f-1)):m.push((S-h*h/f)/f)}return m}function varianceByColumn(n,t,s){const l=n.rows,f=n.columns,m=[];for(let b=0;b<f;b++){let h=0,S=0,M=0;for(let C=0;C<l;C++)M=n.get(C,b)-s[b],h+=M,S+=M*M;t?m.push((S-h*h/l)/(l-1)):m.push((S-h*h/l)/l)}return m}function varianceAll(n,t,s){const l=n.rows,f=n.columns,m=l*f;let b=0,h=0,S=0;for(let M=0;M<l;M++)for(let C=0;C<f;C++)S=n.get(M,C)-s,b+=S,h+=S*S;return t?(h-b*b/m)/(m-1):(h-b*b/m)/m}function centerByRow(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)-t[s])}function centerByColumn(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)-t[l])}function centerAll(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)-t)}function getScaleByRow(n){const t=[];for(let s=0;s<n.rows;s++){let l=0;for(let f=0;f<n.columns;f++)l+=Math.pow(n.get(s,f),2)/(n.columns-1);t.push(Math.sqrt(l))}return t}function scaleByRow(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)/t[s])}function getScaleByColumn(n){const t=[];for(let s=0;s<n.columns;s++){let l=0;for(let f=0;f<n.rows;f++)l+=Math.pow(n.get(f,s),2)/(n.rows-1);t.push(Math.sqrt(l))}return t}function scaleByColumn(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)/t[l])}function getScaleAll(n){const t=n.size-1;let s=0;for(let l=0;l<n.columns;l++)for(let f=0;f<n.rows;f++)s+=Math.pow(n.get(f,l),2)/t;return Math.sqrt(s)}function scaleAll(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)/t)}class AbstractMatrix{static from1DArray(t,s,l){if(t*s!==l.length)throw new RangeError("data length does not match given dimensions");let m=new Matrix$2(t,s);for(let b=0;b<t;b++)for(let h=0;h<s;h++)m.set(b,h,l[b*s+h]);return m}static rowVector(t){let s=new Matrix$2(1,t.length);for(let l=0;l<t.length;l++)s.set(0,l,t[l]);return s}static columnVector(t){let s=new Matrix$2(t.length,1);for(let l=0;l<t.length;l++)s.set(l,0,t[l]);return s}static zeros(t,s){return new Matrix$2(t,s)}static ones(t,s){return new Matrix$2(t,s).fill(1)}static rand(t,s,l={}){if(typeof l!="object")throw new TypeError("options must be an object");const{random:f=Math.random}=l;let m=new Matrix$2(t,s);for(let b=0;b<t;b++)for(let h=0;h<s;h++)m.set(b,h,f());return m}static randInt(t,s,l={}){if(typeof l!="object")throw new TypeError("options must be an object");const{min:f=0,max:m=1e3,random:b=Math.random}=l;if(!Number.isInteger(f))throw new TypeError("min must be an integer");if(!Number.isInteger(m))throw new TypeError("max must be an integer");if(f>=m)throw new RangeError("min must be smaller than max");let h=m-f,S=new Matrix$2(t,s);for(let M=0;M<t;M++)for(let C=0;C<s;C++){let L=f+Math.round(b()*h);S.set(M,C,L)}return S}static eye(t,s,l){s===void 0&&(s=t),l===void 0&&(l=1);let f=Math.min(t,s),m=this.zeros(t,s);for(let b=0;b<f;b++)m.set(b,b,l);return m}static diag(t,s,l){let f=t.length;s===void 0&&(s=f),l===void 0&&(l=s);let m=Math.min(f,s,l),b=this.zeros(s,l);for(let h=0;h<m;h++)b.set(h,h,t[h]);return b}static min(t,s){t=this.checkMatrix(t),s=this.checkMatrix(s);let l=t.rows,f=t.columns,m=new Matrix$2(l,f);for(let b=0;b<l;b++)for(let h=0;h<f;h++)m.set(b,h,Math.min(t.get(b,h),s.get(b,h)));return m}static max(t,s){t=this.checkMatrix(t),s=this.checkMatrix(s);let l=t.rows,f=t.columns,m=new this(l,f);for(let b=0;b<l;b++)for(let h=0;h<f;h++)m.set(b,h,Math.max(t.get(b,h),s.get(b,h)));return m}static checkMatrix(t){return AbstractMatrix.isMatrix(t)?t:new Matrix$2(t)}static isMatrix(t){return t!=null&&t.klass==="Matrix"}get size(){return this.rows*this.columns}apply(t){if(typeof t!="function")throw new TypeError("callback must be a function");for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t.call(this,s,l);return this}to1DArray(){let t=[];for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t.push(this.get(s,l));return t}to2DArray(){let t=[];for(let s=0;s<this.rows;s++){t.push([]);for(let l=0;l<this.columns;l++)t[s].push(this.get(s,l))}return t}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let t=0;t<this.rows;t++)for(let s=0;s<=t;s++)if(this.get(t,s)!==this.get(s,t))return!1;return!0}return!1}isEchelonForm(){let t=0,s=0,l=-1,f=!0,m=!1;for(;t<this.rows&&f;){for(s=0,m=!1;s<this.columns&&m===!1;)this.get(t,s)===0?s++:this.get(t,s)===1&&s>l?(m=!0,l=s):(f=!1,m=!0);t++}return f}isReducedEchelonForm(){let t=0,s=0,l=-1,f=!0,m=!1;for(;t<this.rows&&f;){for(s=0,m=!1;s<this.columns&&m===!1;)this.get(t,s)===0?s++:this.get(t,s)===1&&s>l?(m=!0,l=s):(f=!1,m=!0);for(let b=s+1;b<this.rows;b++)this.get(t,b)!==0&&(f=!1);t++}return f}echelonForm(){let t=this.clone(),s=0,l=0;for(;s<t.rows&&l<t.columns;){let f=s;for(let m=s;m<t.rows;m++)t.get(m,l)>t.get(f,l)&&(f=m);if(t.get(f,l)===0)l++;else{t.swapRows(s,f);let m=t.get(s,l);for(let b=l;b<t.columns;b++)t.set(s,b,t.get(s,b)/m);for(let b=s+1;b<t.rows;b++){let h=t.get(b,l)/t.get(s,l);t.set(b,l,0);for(let S=l+1;S<t.columns;S++)t.set(b,S,t.get(b,S)-t.get(s,S)*h)}s++,l++}}return t}reducedEchelonForm(){let t=this.echelonForm(),s=t.columns,l=t.rows,f=l-1;for(;f>=0;)if(t.maxRow(f)===0)f--;else{let m=0,b=!1;for(;m<l&&b===!1;)t.get(f,m)===1?b=!0:m++;for(let h=0;h<f;h++){let S=t.get(h,m);for(let M=m;M<s;M++){let C=t.get(h,M)-S*t.get(f,M);t.set(h,M,C)}}f--}return t}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{rows:s=1,columns:l=1}=t;if(!Number.isInteger(s)||s<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(l)||l<=0)throw new TypeError("columns must be a positive integer");let f=new Matrix$2(this.rows*s,this.columns*l);for(let m=0;m<s;m++)for(let b=0;b<l;b++)f.setSubMatrix(this,this.rows*m,this.columns*b);return f}fill(t){for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,t);return this}neg(){return this.mulS(-1)}getRow(t){checkRowIndex(this,t);let s=[];for(let l=0;l<this.columns;l++)s.push(this.get(t,l));return s}getRowVector(t){return Matrix$2.rowVector(this.getRow(t))}setRow(t,s){checkRowIndex(this,t),s=checkRowVector(this,s);for(let l=0;l<this.columns;l++)this.set(t,l,s[l]);return this}swapRows(t,s){checkRowIndex(this,t),checkRowIndex(this,s);for(let l=0;l<this.columns;l++){let f=this.get(t,l);this.set(t,l,this.get(s,l)),this.set(s,l,f)}return this}getColumn(t){checkColumnIndex(this,t);let s=[];for(let l=0;l<this.rows;l++)s.push(this.get(l,t));return s}getColumnVector(t){return Matrix$2.columnVector(this.getColumn(t))}setColumn(t,s){checkColumnIndex(this,t),s=checkColumnVector(this,s);for(let l=0;l<this.rows;l++)this.set(l,t,s[l]);return this}swapColumns(t,s){checkColumnIndex(this,t),checkColumnIndex(this,s);for(let l=0;l<this.rows;l++){let f=this.get(l,t);this.set(l,t,this.get(l,s)),this.set(l,s,f)}return this}addRowVector(t){t=checkRowVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)+t[l]);return this}subRowVector(t){t=checkRowVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)-t[l]);return this}mulRowVector(t){t=checkRowVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)*t[l]);return this}divRowVector(t){t=checkRowVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)/t[l]);return this}addColumnVector(t){t=checkColumnVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)+t[s]);return this}subColumnVector(t){t=checkColumnVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)-t[s]);return this}mulColumnVector(t){t=checkColumnVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)*t[s]);return this}divColumnVector(t){t=checkColumnVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)/t[s]);return this}mulRow(t,s){checkRowIndex(this,t);for(let l=0;l<this.columns;l++)this.set(t,l,this.get(t,l)*s);return this}mulColumn(t,s){checkColumnIndex(this,t);for(let l=0;l<this.rows;l++)this.set(l,t,this.get(l,t)*s);return this}max(t){if(this.isEmpty())return NaN;switch(t){case"row":{const s=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.get(l,f)>s[l]&&(s[l]=this.get(l,f));return s}case"column":{const s=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.get(l,f)>s[f]&&(s[f]=this.get(l,f));return s}case void 0:{let s=this.get(0,0);for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.get(l,f)>s&&(s=this.get(l,f));return s}default:throw new Error(`invalid option: ${t}`)}}maxIndex(){checkNonEmpty(this);let t=this.get(0,0),s=[0,0];for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.get(l,f)>t&&(t=this.get(l,f),s[0]=l,s[1]=f);return s}min(t){if(this.isEmpty())return NaN;switch(t){case"row":{const s=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.get(l,f)<s[l]&&(s[l]=this.get(l,f));return s}case"column":{const s=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.get(l,f)<s[f]&&(s[f]=this.get(l,f));return s}case void 0:{let s=this.get(0,0);for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.get(l,f)<s&&(s=this.get(l,f));return s}default:throw new Error(`invalid option: ${t}`)}}minIndex(){checkNonEmpty(this);let t=this.get(0,0),s=[0,0];for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)this.get(l,f)<t&&(t=this.get(l,f),s[0]=l,s[1]=f);return s}maxRow(t){if(checkRowIndex(this,t),this.isEmpty())return NaN;let s=this.get(t,0);for(let l=1;l<this.columns;l++)this.get(t,l)>s&&(s=this.get(t,l));return s}maxRowIndex(t){checkRowIndex(this,t),checkNonEmpty(this);let s=this.get(t,0),l=[t,0];for(let f=1;f<this.columns;f++)this.get(t,f)>s&&(s=this.get(t,f),l[1]=f);return l}minRow(t){if(checkRowIndex(this,t),this.isEmpty())return NaN;let s=this.get(t,0);for(let l=1;l<this.columns;l++)this.get(t,l)<s&&(s=this.get(t,l));return s}minRowIndex(t){checkRowIndex(this,t),checkNonEmpty(this);let s=this.get(t,0),l=[t,0];for(let f=1;f<this.columns;f++)this.get(t,f)<s&&(s=this.get(t,f),l[1]=f);return l}maxColumn(t){if(checkColumnIndex(this,t),this.isEmpty())return NaN;let s=this.get(0,t);for(let l=1;l<this.rows;l++)this.get(l,t)>s&&(s=this.get(l,t));return s}maxColumnIndex(t){checkColumnIndex(this,t),checkNonEmpty(this);let s=this.get(0,t),l=[0,t];for(let f=1;f<this.rows;f++)this.get(f,t)>s&&(s=this.get(f,t),l[0]=f);return l}minColumn(t){if(checkColumnIndex(this,t),this.isEmpty())return NaN;let s=this.get(0,t);for(let l=1;l<this.rows;l++)this.get(l,t)<s&&(s=this.get(l,t));return s}minColumnIndex(t){checkColumnIndex(this,t),checkNonEmpty(this);let s=this.get(0,t),l=[0,t];for(let f=1;f<this.rows;f++)this.get(f,t)<s&&(s=this.get(f,t),l[0]=f);return l}diag(){let t=Math.min(this.rows,this.columns),s=[];for(let l=0;l<t;l++)s.push(this.get(l,l));return s}norm(t="frobenius"){let s=0;if(t==="max")return this.max();if(t==="frobenius"){for(let l=0;l<this.rows;l++)for(let f=0;f<this.columns;f++)s=s+this.get(l,f)*this.get(l,f);return Math.sqrt(s)}else throw new RangeError(`unknown norm type: ${t}`)}cumulativeSum(){let t=0;for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t+=this.get(s,l),this.set(s,l,t);return this}dot(t){AbstractMatrix.isMatrix(t)&&(t=t.to1DArray());let s=this.to1DArray();if(s.length!==t.length)throw new RangeError("vectors do not have the same size");let l=0;for(let f=0;f<s.length;f++)l+=s[f]*t[f];return l}mmul(t){t=Matrix$2.checkMatrix(t);let s=this.rows,l=this.columns,f=t.columns,m=new Matrix$2(s,f),b=new Float64Array(l);for(let h=0;h<f;h++){for(let S=0;S<l;S++)b[S]=t.get(S,h);for(let S=0;S<s;S++){let M=0;for(let C=0;C<l;C++)M+=this.get(S,C)*b[C];m.set(S,h,M)}}return m}strassen2x2(t){t=Matrix$2.checkMatrix(t);let s=new Matrix$2(2,2);const l=this.get(0,0),f=t.get(0,0),m=this.get(0,1),b=t.get(0,1),h=this.get(1,0),S=t.get(1,0),M=this.get(1,1),C=t.get(1,1),L=(l+M)*(f+C),N=(h+M)*f,F=l*(b-C),G=M*(S-f),H=(l+m)*C,K=(h-l)*(f+b),X=(m-M)*(S+C),de=L+G-H+X,Q=F+H,ie=N+G,ce=L-N+F+K;return s.set(0,0,de),s.set(0,1,Q),s.set(1,0,ie),s.set(1,1,ce),s}strassen3x3(t){t=Matrix$2.checkMatrix(t);let s=new Matrix$2(3,3);const l=this.get(0,0),f=this.get(0,1),m=this.get(0,2),b=this.get(1,0),h=this.get(1,1),S=this.get(1,2),M=this.get(2,0),C=this.get(2,1),L=this.get(2,2),N=t.get(0,0),F=t.get(0,1),G=t.get(0,2),H=t.get(1,0),K=t.get(1,1),X=t.get(1,2),de=t.get(2,0),Q=t.get(2,1),ie=t.get(2,2),ce=(l+f+m-b-h-C-L)*K,ge=(l-b)*(-F+K),be=h*(-N+F+H-K-X-de+ie),ne=(-l+b+h)*(N-F+K),ve=(b+h)*(-N+F),te=l*N,he=(-l+M+C)*(N-G+X),Ie=(-l+M)*(G-X),Oe=(M+C)*(-N+G),tt=(l+f+m-h-S-M-C)*X,it=C*(-N+G+H-K-X-de+Q),Ct=(-m+C+L)*(K+de-Q),Rt=(m-L)*(K-Q),xt=m*de,Vt=(C+L)*(-de+Q),It=(-m+h+S)*(X+de-ie),Xt=(m-S)*(X-ie),Jt=(h+S)*(-de+ie),nt=f*H,mt=S*Q,ft=b*G,Dt=M*F,qt=L*ie,oi=te+xt+nt,ti=ce+ne+ve+te+Ct+xt+Vt,fi=te+he+Oe+tt+xt+It+Jt,si=ge+be+ne+te+xt+It+Xt,Ot=ge+ne+ve+te+mt,ai=xt+It+Xt+Jt+ft,Nt=te+he+Ie+it+Ct+Rt+xt,dt=Ct+Rt+xt+Vt+Dt,gi=te+he+Ie+Oe+qt;return s.set(0,0,oi),s.set(0,1,ti),s.set(0,2,fi),s.set(1,0,si),s.set(1,1,Ot),s.set(1,2,ai),s.set(2,0,Nt),s.set(2,1,dt),s.set(2,2,gi),s}mmulStrassen(t){t=Matrix$2.checkMatrix(t);let s=this.clone(),l=s.rows,f=s.columns,m=t.rows,b=t.columns;f!==m&&console.warn(`Multiplying ${l} x ${f} and ${m} x ${b} matrix: dimensions do not match.`);function h(L,N,F){let G=L.rows,H=L.columns;if(G===N&&H===F)return L;{let K=AbstractMatrix.zeros(N,F);return K=K.setSubMatrix(L,0,0),K}}let S=Math.max(l,m),M=Math.max(f,b);s=h(s,S,M),t=h(t,S,M);function C(L,N,F,G){if(F<=512||G<=512)return L.mmul(N);F%2===1&&G%2===1?(L=h(L,F+1,G+1),N=h(N,F+1,G+1)):F%2===1?(L=h(L,F+1,G),N=h(N,F+1,G)):G%2===1&&(L=h(L,F,G+1),N=h(N,F,G+1));let H=parseInt(L.rows/2,10),K=parseInt(L.columns/2,10),X=L.subMatrix(0,H-1,0,K-1),de=N.subMatrix(0,H-1,0,K-1),Q=L.subMatrix(0,H-1,K,L.columns-1),ie=N.subMatrix(0,H-1,K,N.columns-1),ce=L.subMatrix(H,L.rows-1,0,K-1),ge=N.subMatrix(H,N.rows-1,0,K-1),be=L.subMatrix(H,L.rows-1,K,L.columns-1),ne=N.subMatrix(H,N.rows-1,K,N.columns-1),ve=C(AbstractMatrix.add(X,be),AbstractMatrix.add(de,ne),H,K),te=C(AbstractMatrix.add(ce,be),de,H,K),he=C(X,AbstractMatrix.sub(ie,ne),H,K),Ie=C(be,AbstractMatrix.sub(ge,de),H,K),Oe=C(AbstractMatrix.add(X,Q),ne,H,K),tt=C(AbstractMatrix.sub(ce,X),AbstractMatrix.add(de,ie),H,K),it=C(AbstractMatrix.sub(Q,be),AbstractMatrix.add(ge,ne),H,K),Ct=AbstractMatrix.add(ve,Ie);Ct.sub(Oe),Ct.add(it);let Rt=AbstractMatrix.add(he,Oe),xt=AbstractMatrix.add(te,Ie),Vt=AbstractMatrix.sub(ve,te);Vt.add(he),Vt.add(tt);let It=AbstractMatrix.zeros(2*Ct.rows,2*Ct.columns);return It=It.setSubMatrix(Ct,0,0),It=It.setSubMatrix(Rt,Ct.rows,0),It=It.setSubMatrix(xt,0,Ct.columns),It=It.setSubMatrix(Vt,Ct.rows,Ct.columns),It.subMatrix(0,F-1,0,G-1)}return C(s,t,S,M)}scaleRows(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:s=0,max:l=1}=t;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(l))throw new TypeError("max must be a number");if(s>=l)throw new RangeError("min must be smaller than max");let f=new Matrix$2(this.rows,this.columns);for(let m=0;m<this.rows;m++){const b=this.getRow(m);b.length>0&&rescale(b,{min:s,max:l,output:b}),f.setRow(m,b)}return f}scaleColumns(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:s=0,max:l=1}=t;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(l))throw new TypeError("max must be a number");if(s>=l)throw new RangeError("min must be smaller than max");let f=new Matrix$2(this.rows,this.columns);for(let m=0;m<this.columns;m++){const b=this.getColumn(m);b.length&&rescale(b,{min:s,max:l,output:b}),f.setColumn(m,b)}return f}flipRows(){const t=Math.ceil(this.columns/2);for(let s=0;s<this.rows;s++)for(let l=0;l<t;l++){let f=this.get(s,l),m=this.get(s,this.columns-1-l);this.set(s,l,m),this.set(s,this.columns-1-l,f)}return this}flipColumns(){const t=Math.ceil(this.rows/2);for(let s=0;s<this.columns;s++)for(let l=0;l<t;l++){let f=this.get(l,s),m=this.get(this.rows-1-l,s);this.set(l,s,m),this.set(this.rows-1-l,s,f)}return this}kroneckerProduct(t){t=Matrix$2.checkMatrix(t);let s=this.rows,l=this.columns,f=t.rows,m=t.columns,b=new Matrix$2(s*f,l*m);for(let h=0;h<s;h++)for(let S=0;S<l;S++)for(let M=0;M<f;M++)for(let C=0;C<m;C++)b.set(f*h+M,m*S+C,this.get(h,S)*t.get(M,C));return b}kroneckerSum(t){if(t=Matrix$2.checkMatrix(t),!this.isSquare()||!t.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let s=this.rows,l=t.rows,f=this.kroneckerProduct(Matrix$2.eye(l,l)),m=Matrix$2.eye(s,s).kroneckerProduct(t);return f.add(m)}transpose(){let t=new Matrix$2(this.columns,this.rows);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t.set(l,s,this.get(s,l));return t}sortRows(t=compareNumbers){for(let s=0;s<this.rows;s++)this.setRow(s,this.getRow(s).sort(t));return this}sortColumns(t=compareNumbers){for(let s=0;s<this.columns;s++)this.setColumn(s,this.getColumn(s).sort(t));return this}subMatrix(t,s,l,f){checkRange(this,t,s,l,f);let m=new Matrix$2(s-t+1,f-l+1);for(let b=t;b<=s;b++)for(let h=l;h<=f;h++)m.set(b-t,h-l,this.get(b,h));return m}subMatrixRow(t,s,l){if(s===void 0&&(s=0),l===void 0&&(l=this.columns-1),s>l||s<0||s>=this.columns||l<0||l>=this.columns)throw new RangeError("Argument out of range");let f=new Matrix$2(t.length,l-s+1);for(let m=0;m<t.length;m++)for(let b=s;b<=l;b++){if(t[m]<0||t[m]>=this.rows)throw new RangeError(`Row index out of range: ${t[m]}`);f.set(m,b-s,this.get(t[m],b))}return f}subMatrixColumn(t,s,l){if(s===void 0&&(s=0),l===void 0&&(l=this.rows-1),s>l||s<0||s>=this.rows||l<0||l>=this.rows)throw new RangeError("Argument out of range");let f=new Matrix$2(l-s+1,t.length);for(let m=0;m<t.length;m++)for(let b=s;b<=l;b++){if(t[m]<0||t[m]>=this.columns)throw new RangeError(`Column index out of range: ${t[m]}`);f.set(b-s,m,this.get(b,t[m]))}return f}setSubMatrix(t,s,l){if(t=Matrix$2.checkMatrix(t),t.isEmpty())return this;let f=s+t.rows-1,m=l+t.columns-1;checkRange(this,s,f,l,m);for(let b=0;b<t.rows;b++)for(let h=0;h<t.columns;h++)this.set(s+b,l+h,t.get(b,h));return this}selection(t,s){checkRowIndices(this,t),checkColumnIndices(this,s);let l=new Matrix$2(t.length,s.length);for(let f=0;f<t.length;f++){let m=t[f];for(let b=0;b<s.length;b++){let h=s[b];l.set(f,b,this.get(m,h))}}return l}trace(){let t=Math.min(this.rows,this.columns),s=0;for(let l=0;l<t;l++)s+=this.get(l,l);return s}clone(){let t=new Matrix$2(this.rows,this.columns);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t.set(s,l,this.get(s,l));return t}sum(t){switch(t){case"row":return sumByRow(this);case"column":return sumByColumn(this);case void 0:return sumAll(this);default:throw new Error(`invalid option: ${t}`)}}product(t){switch(t){case"row":return productByRow(this);case"column":return productByColumn(this);case void 0:return productAll(this);default:throw new Error(`invalid option: ${t}`)}}mean(t){const s=this.sum(t);switch(t){case"row":{for(let l=0;l<this.rows;l++)s[l]/=this.columns;return s}case"column":{for(let l=0;l<this.columns;l++)s[l]/=this.rows;return s}case void 0:return s/this.size;default:throw new Error(`invalid option: ${t}`)}}variance(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");const{unbiased:l=!0,mean:f=this.mean(t)}=s;if(typeof l!="boolean")throw new TypeError("unbiased must be a boolean");switch(t){case"row":{if(!isAnyArray(f))throw new TypeError("mean must be an array");return varianceByRow(this,l,f)}case"column":{if(!isAnyArray(f))throw new TypeError("mean must be an array");return varianceByColumn(this,l,f)}case void 0:{if(typeof f!="number")throw new TypeError("mean must be a number");return varianceAll(this,l,f)}default:throw new Error(`invalid option: ${t}`)}}standardDeviation(t,s){typeof t=="object"&&(s=t,t=void 0);const l=this.variance(t,s);if(t===void 0)return Math.sqrt(l);for(let f=0;f<l.length;f++)l[f]=Math.sqrt(l[f]);return l}center(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");const{center:l=this.mean(t)}=s;switch(t){case"row":{if(!isAnyArray(l))throw new TypeError("center must be an array");return centerByRow(this,l),this}case"column":{if(!isAnyArray(l))throw new TypeError("center must be an array");return centerByColumn(this,l),this}case void 0:{if(typeof l!="number")throw new TypeError("center must be a number");return centerAll(this,l),this}default:throw new Error(`invalid option: ${t}`)}}scale(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");let l=s.scale;switch(t){case"row":{if(l===void 0)l=getScaleByRow(this);else if(!isAnyArray(l))throw new TypeError("scale must be an array");return scaleByRow(this,l),this}case"column":{if(l===void 0)l=getScaleByColumn(this);else if(!isAnyArray(l))throw new TypeError("scale must be an array");return scaleByColumn(this,l),this}case void 0:{if(l===void 0)l=getScaleAll(this);else if(typeof l!="number")throw new TypeError("scale must be a number");return scaleAll(this,l),this}default:throw new Error(`invalid option: ${t}`)}}toString(t){return inspectMatrixWithOptions(this,t)}}AbstractMatrix.prototype.klass="Matrix";typeof Symbol!="undefined"&&(AbstractMatrix.prototype[Symbol.for("nodejs.util.inspect.custom")]=inspectMatrix);function compareNumbers(n,t){return n-t}AbstractMatrix.random=AbstractMatrix.rand;AbstractMatrix.randomInt=AbstractMatrix.randInt;AbstractMatrix.diagonal=AbstractMatrix.diag;AbstractMatrix.prototype.diagonal=AbstractMatrix.prototype.diag;AbstractMatrix.identity=AbstractMatrix.eye;AbstractMatrix.prototype.negate=AbstractMatrix.prototype.neg;AbstractMatrix.prototype.tensorProduct=AbstractMatrix.prototype.kroneckerProduct;class Matrix$2 extends AbstractMatrix{constructor(t,s){if(super(),Matrix$2.isMatrix(t))return t.clone();if(Number.isInteger(t)&&t>=0)if(this.data=[],Number.isInteger(s)&&s>=0)for(let l=0;l<t;l++)this.data.push(new Float64Array(s));else throw new TypeError("nColumns must be a positive integer");else if(isAnyArray(t)){const l=t;if(t=l.length,s=t?l[0].length:0,typeof s!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let f=0;f<t;f++){if(l[f].length!==s)throw new RangeError("Inconsistent array dimensions");this.data.push(Float64Array.from(l[f]))}}else throw new TypeError("First argument must be a positive number or an array");this.rows=t,this.columns=s}set(t,s,l){return this.data[t][s]=l,this}get(t,s){return this.data[t][s]}removeRow(t){return checkRowIndex(this,t),this.data.splice(t,1),this.rows-=1,this}addRow(t,s){return s===void 0&&(s=t,t=this.rows),checkRowIndex(this,t,!0),s=Float64Array.from(checkRowVector(this,s)),this.data.splice(t,0,s),this.rows+=1,this}removeColumn(t){checkColumnIndex(this,t);for(let s=0;s<this.rows;s++){const l=new Float64Array(this.columns-1);for(let f=0;f<t;f++)l[f]=this.data[s][f];for(let f=t+1;f<this.columns;f++)l[f-1]=this.data[s][f];this.data[s]=l}return this.columns-=1,this}addColumn(t,s){typeof s=="undefined"&&(s=t,t=this.columns),checkColumnIndex(this,t,!0),s=checkColumnVector(this,s);for(let l=0;l<this.rows;l++){const f=new Float64Array(this.columns+1);let m=0;for(;m<t;m++)f[m]=this.data[l][m];for(f[m++]=s[l];m<this.columns+1;m++)f[m]=this.data[l][m-1];this.data[l]=f}return this.columns+=1,this}}installMathOperations(AbstractMatrix,Matrix$2);class BaseView extends AbstractMatrix{constructor(t,s,l){super(),this.matrix=t,this.rows=s,this.columns=l}}class MatrixColumnView extends BaseView{constructor(t,s){checkColumnIndex(t,s),super(t,t.rows,1),this.column=s}set(t,s,l){return this.matrix.set(t,this.column,l),this}get(t){return this.matrix.get(t,this.column)}}class MatrixColumnSelectionView extends BaseView{constructor(t,s){checkColumnIndices(t,s),super(t,t.rows,s.length),this.columnIndices=s}set(t,s,l){return this.matrix.set(t,this.columnIndices[s],l),this}get(t,s){return this.matrix.get(t,this.columnIndices[s])}}class MatrixFlipColumnView extends BaseView{constructor(t){super(t,t.rows,t.columns)}set(t,s,l){return this.matrix.set(t,this.columns-s-1,l),this}get(t,s){return this.matrix.get(t,this.columns-s-1)}}class MatrixFlipRowView extends BaseView{constructor(t){super(t,t.rows,t.columns)}set(t,s,l){return this.matrix.set(this.rows-t-1,s,l),this}get(t,s){return this.matrix.get(this.rows-t-1,s)}}class MatrixRowView extends BaseView{constructor(t,s){checkRowIndex(t,s),super(t,1,t.columns),this.row=s}set(t,s,l){return this.matrix.set(this.row,s,l),this}get(t,s){return this.matrix.get(this.row,s)}}class MatrixRowSelectionView extends BaseView{constructor(t,s){checkRowIndices(t,s),super(t,s.length,t.columns),this.rowIndices=s}set(t,s,l){return this.matrix.set(this.rowIndices[t],s,l),this}get(t,s){return this.matrix.get(this.rowIndices[t],s)}}class MatrixSelectionView extends BaseView{constructor(t,s,l){checkRowIndices(t,s),checkColumnIndices(t,l),super(t,s.length,l.length),this.rowIndices=s,this.columnIndices=l}set(t,s,l){return this.matrix.set(this.rowIndices[t],this.columnIndices[s],l),this}get(t,s){return this.matrix.get(this.rowIndices[t],this.columnIndices[s])}}class MatrixSubView extends BaseView{constructor(t,s,l,f,m){checkRange(t,s,l,f,m),super(t,l-s+1,m-f+1),this.startRow=s,this.startColumn=f}set(t,s,l){return this.matrix.set(this.startRow+t,this.startColumn+s,l),this}get(t,s){return this.matrix.get(this.startRow+t,this.startColumn+s)}}class MatrixTransposeView$1 extends BaseView{constructor(t){super(t,t.columns,t.rows)}set(t,s,l){return this.matrix.set(s,t,l),this}get(t,s){return this.matrix.get(s,t)}}class WrapperMatrix1D extends AbstractMatrix{constructor(t,s={}){const{rows:l=1}=s;if(t.length%l!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=l,this.columns=t.length/l,this.data=t}set(t,s,l){let f=this._calculateIndex(t,s);return this.data[f]=l,this}get(t,s){let l=this._calculateIndex(t,s);return this.data[l]}_calculateIndex(t,s){return t*this.columns+s}}class WrapperMatrix2D extends AbstractMatrix{constructor(t){super(),this.data=t,this.rows=t.length,this.columns=t[0].length}set(t,s,l){return this.data[t][s]=l,this}get(t,s){return this.data[t][s]}}function wrap(n,t){if(isAnyArray(n))return n[0]&&isAnyArray(n[0])?new WrapperMatrix2D(n):new WrapperMatrix1D(n,t);throw new Error("the argument is not an array")}class LuDecomposition{constructor(t){t=WrapperMatrix2D.checkMatrix(t);let s=t.clone(),l=s.rows,f=s.columns,m=new Float64Array(l),b=1,h,S,M,C,L,N,F,G,H;for(h=0;h<l;h++)m[h]=h;for(G=new Float64Array(l),S=0;S<f;S++){for(h=0;h<l;h++)G[h]=s.get(h,S);for(h=0;h<l;h++){for(H=Math.min(h,S),L=0,M=0;M<H;M++)L+=s.get(h,M)*G[M];G[h]-=L,s.set(h,S,G[h])}for(C=S,h=S+1;h<l;h++)Math.abs(G[h])>Math.abs(G[C])&&(C=h);if(C!==S){for(M=0;M<f;M++)N=s.get(C,M),s.set(C,M,s.get(S,M)),s.set(S,M,N);F=m[C],m[C]=m[S],m[S]=F,b=-b}if(S<l&&s.get(S,S)!==0)for(h=S+1;h<l;h++)s.set(h,S,s.get(h,S)/s.get(S,S))}this.LU=s,this.pivotVector=m,this.pivotSign=b}isSingular(){let t=this.LU,s=t.columns;for(let l=0;l<s;l++)if(t.get(l,l)===0)return!0;return!1}solve(t){t=Matrix$2.checkMatrix(t);let s=this.LU;if(s.rows!==t.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let f=t.columns,m=t.subMatrixRow(this.pivotVector,0,f-1),b=s.columns,h,S,M;for(M=0;M<b;M++)for(h=M+1;h<b;h++)for(S=0;S<f;S++)m.set(h,S,m.get(h,S)-m.get(M,S)*s.get(h,M));for(M=b-1;M>=0;M--){for(S=0;S<f;S++)m.set(M,S,m.get(M,S)/s.get(M,M));for(h=0;h<M;h++)for(S=0;S<f;S++)m.set(h,S,m.get(h,S)-m.get(M,S)*s.get(h,M))}return m}get determinant(){let t=this.LU;if(!t.isSquare())throw new Error("Matrix must be square");let s=this.pivotSign,l=t.columns;for(let f=0;f<l;f++)s*=t.get(f,f);return s}get lowerTriangularMatrix(){let t=this.LU,s=t.rows,l=t.columns,f=new Matrix$2(s,l);for(let m=0;m<s;m++)for(let b=0;b<l;b++)m>b?f.set(m,b,t.get(m,b)):m===b?f.set(m,b,1):f.set(m,b,0);return f}get upperTriangularMatrix(){let t=this.LU,s=t.rows,l=t.columns,f=new Matrix$2(s,l);for(let m=0;m<s;m++)for(let b=0;b<l;b++)m<=b?f.set(m,b,t.get(m,b)):f.set(m,b,0);return f}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function hypotenuse$1(n,t){let s=0;return Math.abs(n)>Math.abs(t)?(s=t/n,Math.abs(n)*Math.sqrt(1+s*s)):t!==0?(s=n/t,Math.abs(t)*Math.sqrt(1+s*s)):0}class QrDecomposition{constructor(t){t=WrapperMatrix2D.checkMatrix(t);let s=t.clone(),l=t.rows,f=t.columns,m=new Float64Array(f),b,h,S,M;for(S=0;S<f;S++){let C=0;for(b=S;b<l;b++)C=hypotenuse$1(C,s.get(b,S));if(C!==0){for(s.get(S,S)<0&&(C=-C),b=S;b<l;b++)s.set(b,S,s.get(b,S)/C);for(s.set(S,S,s.get(S,S)+1),h=S+1;h<f;h++){for(M=0,b=S;b<l;b++)M+=s.get(b,S)*s.get(b,h);for(M=-M/s.get(S,S),b=S;b<l;b++)s.set(b,h,s.get(b,h)+M*s.get(b,S))}}m[S]=-C}this.QR=s,this.Rdiag=m}solve(t){t=Matrix$2.checkMatrix(t);let s=this.QR,l=s.rows;if(t.rows!==l)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let f=t.columns,m=t.clone(),b=s.columns,h,S,M,C;for(M=0;M<b;M++)for(S=0;S<f;S++){for(C=0,h=M;h<l;h++)C+=s.get(h,M)*m.get(h,S);for(C=-C/s.get(M,M),h=M;h<l;h++)m.set(h,S,m.get(h,S)+C*s.get(h,M))}for(M=b-1;M>=0;M--){for(S=0;S<f;S++)m.set(M,S,m.get(M,S)/this.Rdiag[M]);for(h=0;h<M;h++)for(S=0;S<f;S++)m.set(h,S,m.get(h,S)-m.get(M,S)*s.get(h,M))}return m.subMatrix(0,b-1,0,f-1)}isFullRank(){let t=this.QR.columns;for(let s=0;s<t;s++)if(this.Rdiag[s]===0)return!1;return!0}get upperTriangularMatrix(){let t=this.QR,s=t.columns,l=new Matrix$2(s,s),f,m;for(f=0;f<s;f++)for(m=0;m<s;m++)f<m?l.set(f,m,t.get(f,m)):f===m?l.set(f,m,this.Rdiag[f]):l.set(f,m,0);return l}get orthogonalMatrix(){let t=this.QR,s=t.rows,l=t.columns,f=new Matrix$2(s,l),m,b,h,S;for(h=l-1;h>=0;h--){for(m=0;m<s;m++)f.set(m,h,0);for(f.set(h,h,1),b=h;b<l;b++)if(t.get(h,h)!==0){for(S=0,m=h;m<s;m++)S+=t.get(m,h)*f.get(m,b);for(S=-S/t.get(h,h),m=h;m<s;m++)f.set(m,b,f.get(m,b)+S*t.get(m,h))}}return f}}class SingularValueDecomposition{constructor(t,s={}){if(t=WrapperMatrix2D.checkMatrix(t),t.isEmpty())throw new Error("Matrix must be non-empty");let l=t.rows,f=t.columns;const{computeLeftSingularVectors:m=!0,computeRightSingularVectors:b=!0,autoTranspose:h=!1}=s;let S=Boolean(m),M=Boolean(b),C=!1,L;if(l<f)if(!h)L=t.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{L=t.transpose(),l=L.rows,f=L.columns,C=!0;let te=S;S=M,M=te}else L=t.clone();let N=Math.min(l,f),F=Math.min(l+1,f),G=new Float64Array(F),H=new Matrix$2(l,N),K=new Matrix$2(f,f),X=new Float64Array(f),de=new Float64Array(l),Q=new Float64Array(F);for(let te=0;te<F;te++)Q[te]=te;let ie=Math.min(l-1,f),ce=Math.max(0,Math.min(f-2,l)),ge=Math.max(ie,ce);for(let te=0;te<ge;te++){if(te<ie){G[te]=0;for(let he=te;he<l;he++)G[te]=hypotenuse$1(G[te],L.get(he,te));if(G[te]!==0){L.get(te,te)<0&&(G[te]=-G[te]);for(let he=te;he<l;he++)L.set(he,te,L.get(he,te)/G[te]);L.set(te,te,L.get(te,te)+1)}G[te]=-G[te]}for(let he=te+1;he<f;he++){if(te<ie&&G[te]!==0){let Ie=0;for(let Oe=te;Oe<l;Oe++)Ie+=L.get(Oe,te)*L.get(Oe,he);Ie=-Ie/L.get(te,te);for(let Oe=te;Oe<l;Oe++)L.set(Oe,he,L.get(Oe,he)+Ie*L.get(Oe,te))}X[he]=L.get(te,he)}if(S&&te<ie)for(let he=te;he<l;he++)H.set(he,te,L.get(he,te));if(te<ce){X[te]=0;for(let he=te+1;he<f;he++)X[te]=hypotenuse$1(X[te],X[he]);if(X[te]!==0){X[te+1]<0&&(X[te]=0-X[te]);for(let he=te+1;he<f;he++)X[he]/=X[te];X[te+1]+=1}if(X[te]=-X[te],te+1<l&&X[te]!==0){for(let he=te+1;he<l;he++)de[he]=0;for(let he=te+1;he<l;he++)for(let Ie=te+1;Ie<f;Ie++)de[he]+=X[Ie]*L.get(he,Ie);for(let he=te+1;he<f;he++){let Ie=-X[he]/X[te+1];for(let Oe=te+1;Oe<l;Oe++)L.set(Oe,he,L.get(Oe,he)+Ie*de[Oe])}}if(M)for(let he=te+1;he<f;he++)K.set(he,te,X[he])}}let be=Math.min(f,l+1);if(ie<f&&(G[ie]=L.get(ie,ie)),l<be&&(G[be-1]=0),ce+1<be&&(X[ce]=L.get(ce,be-1)),X[be-1]=0,S){for(let te=ie;te<N;te++){for(let he=0;he<l;he++)H.set(he,te,0);H.set(te,te,1)}for(let te=ie-1;te>=0;te--)if(G[te]!==0){for(let he=te+1;he<N;he++){let Ie=0;for(let Oe=te;Oe<l;Oe++)Ie+=H.get(Oe,te)*H.get(Oe,he);Ie=-Ie/H.get(te,te);for(let Oe=te;Oe<l;Oe++)H.set(Oe,he,H.get(Oe,he)+Ie*H.get(Oe,te))}for(let he=te;he<l;he++)H.set(he,te,-H.get(he,te));H.set(te,te,1+H.get(te,te));for(let he=0;he<te-1;he++)H.set(he,te,0)}else{for(let he=0;he<l;he++)H.set(he,te,0);H.set(te,te,1)}}if(M)for(let te=f-1;te>=0;te--){if(te<ce&&X[te]!==0)for(let he=te+1;he<f;he++){let Ie=0;for(let Oe=te+1;Oe<f;Oe++)Ie+=K.get(Oe,te)*K.get(Oe,he);Ie=-Ie/K.get(te+1,te);for(let Oe=te+1;Oe<f;Oe++)K.set(Oe,he,K.get(Oe,he)+Ie*K.get(Oe,te))}for(let he=0;he<f;he++)K.set(he,te,0);K.set(te,te,1)}let ne=be-1,ve=Number.EPSILON;for(;be>0;){let te,he;for(te=be-2;te>=-1&&te!==-1;te--){const Ie=Number.MIN_VALUE+ve*Math.abs(G[te]+Math.abs(G[te+1]));if(Math.abs(X[te])<=Ie||Number.isNaN(X[te])){X[te]=0;break}}if(te===be-2)he=4;else{let Ie;for(Ie=be-1;Ie>=te&&Ie!==te;Ie--){let Oe=(Ie!==be?Math.abs(X[Ie]):0)+(Ie!==te+1?Math.abs(X[Ie-1]):0);if(Math.abs(G[Ie])<=ve*Oe){G[Ie]=0;break}}Ie===te?he=3:Ie===be-1?he=1:(he=2,te=Ie)}switch(te++,he){case 1:{let Ie=X[be-2];X[be-2]=0;for(let Oe=be-2;Oe>=te;Oe--){let tt=hypotenuse$1(G[Oe],Ie),it=G[Oe]/tt,Ct=Ie/tt;if(G[Oe]=tt,Oe!==te&&(Ie=-Ct*X[Oe-1],X[Oe-1]=it*X[Oe-1]),M)for(let Rt=0;Rt<f;Rt++)tt=it*K.get(Rt,Oe)+Ct*K.get(Rt,be-1),K.set(Rt,be-1,-Ct*K.get(Rt,Oe)+it*K.get(Rt,be-1)),K.set(Rt,Oe,tt)}break}case 2:{let Ie=X[te-1];X[te-1]=0;for(let Oe=te;Oe<be;Oe++){let tt=hypotenuse$1(G[Oe],Ie),it=G[Oe]/tt,Ct=Ie/tt;if(G[Oe]=tt,Ie=-Ct*X[Oe],X[Oe]=it*X[Oe],S)for(let Rt=0;Rt<l;Rt++)tt=it*H.get(Rt,Oe)+Ct*H.get(Rt,te-1),H.set(Rt,te-1,-Ct*H.get(Rt,Oe)+it*H.get(Rt,te-1)),H.set(Rt,Oe,tt)}break}case 3:{const Ie=Math.max(Math.abs(G[be-1]),Math.abs(G[be-2]),Math.abs(X[be-2]),Math.abs(G[te]),Math.abs(X[te])),Oe=G[be-1]/Ie,tt=G[be-2]/Ie,it=X[be-2]/Ie,Ct=G[te]/Ie,Rt=X[te]/Ie,xt=((tt+Oe)*(tt-Oe)+it*it)/2,Vt=Oe*it*(Oe*it);let It=0;(xt!==0||Vt!==0)&&(xt<0?It=0-Math.sqrt(xt*xt+Vt):It=Math.sqrt(xt*xt+Vt),It=Vt/(xt+It));let Xt=(Ct+Oe)*(Ct-Oe)+It,Jt=Ct*Rt;for(let nt=te;nt<be-1;nt++){let mt=hypotenuse$1(Xt,Jt);mt===0&&(mt=Number.MIN_VALUE);let ft=Xt/mt,Dt=Jt/mt;if(nt!==te&&(X[nt-1]=mt),Xt=ft*G[nt]+Dt*X[nt],X[nt]=ft*X[nt]-Dt*G[nt],Jt=Dt*G[nt+1],G[nt+1]=ft*G[nt+1],M)for(let qt=0;qt<f;qt++)mt=ft*K.get(qt,nt)+Dt*K.get(qt,nt+1),K.set(qt,nt+1,-Dt*K.get(qt,nt)+ft*K.get(qt,nt+1)),K.set(qt,nt,mt);if(mt=hypotenuse$1(Xt,Jt),mt===0&&(mt=Number.MIN_VALUE),ft=Xt/mt,Dt=Jt/mt,G[nt]=mt,Xt=ft*X[nt]+Dt*G[nt+1],G[nt+1]=-Dt*X[nt]+ft*G[nt+1],Jt=Dt*X[nt+1],X[nt+1]=ft*X[nt+1],S&&nt<l-1)for(let qt=0;qt<l;qt++)mt=ft*H.get(qt,nt)+Dt*H.get(qt,nt+1),H.set(qt,nt+1,-Dt*H.get(qt,nt)+ft*H.get(qt,nt+1)),H.set(qt,nt,mt)}X[be-2]=Xt;break}case 4:{if(G[te]<=0&&(G[te]=G[te]<0?-G[te]:0,M))for(let Ie=0;Ie<=ne;Ie++)K.set(Ie,te,-K.get(Ie,te));for(;te<ne&&!(G[te]>=G[te+1]);){let Ie=G[te];if(G[te]=G[te+1],G[te+1]=Ie,M&&te<f-1)for(let Oe=0;Oe<f;Oe++)Ie=K.get(Oe,te+1),K.set(Oe,te+1,K.get(Oe,te)),K.set(Oe,te,Ie);if(S&&te<l-1)for(let Oe=0;Oe<l;Oe++)Ie=H.get(Oe,te+1),H.set(Oe,te+1,H.get(Oe,te)),H.set(Oe,te,Ie);te++}be--;break}}}if(C){let te=K;K=H,H=te}this.m=l,this.n=f,this.s=G,this.U=H,this.V=K}solve(t){let s=t,l=this.threshold,f=this.s.length,m=Matrix$2.zeros(f,f);for(let N=0;N<f;N++)Math.abs(this.s[N])<=l?m.set(N,N,0):m.set(N,N,1/this.s[N]);let b=this.U,h=this.rightSingularVectors,S=h.mmul(m),M=h.rows,C=b.rows,L=Matrix$2.zeros(M,C);for(let N=0;N<M;N++)for(let F=0;F<C;F++){let G=0;for(let H=0;H<f;H++)G+=S.get(N,H)*b.get(F,H);L.set(N,F,G)}return L.mmul(s)}solveForDiagonal(t){return this.solve(Matrix$2.diag(t))}inverse(){let t=this.V,s=this.threshold,l=t.rows,f=t.columns,m=new Matrix$2(l,this.s.length);for(let C=0;C<l;C++)for(let L=0;L<f;L++)Math.abs(this.s[L])>s&&m.set(C,L,t.get(C,L)/this.s[L]);let b=this.U,h=b.rows,S=b.columns,M=new Matrix$2(l,h);for(let C=0;C<l;C++)for(let L=0;L<h;L++){let N=0;for(let F=0;F<S;F++)N+=m.get(C,F)*b.get(L,F);M.set(C,L,N)}return M}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let t=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,s=0,l=this.s;for(let f=0,m=l.length;f<m;f++)l[f]>t&&s++;return s}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return Matrix$2.diag(this.s)}}function inverse(n,t=!1){return n=WrapperMatrix2D.checkMatrix(n),t?new SingularValueDecomposition(n).inverse():solve(n,Matrix$2.eye(n.rows))}function solve(n,t,s=!1){return n=WrapperMatrix2D.checkMatrix(n),t=WrapperMatrix2D.checkMatrix(t),s?new SingularValueDecomposition(n).solve(t):n.isSquare()?new LuDecomposition(n).solve(t):new QrDecomposition(n).solve(t)}function determinant(n){if(n=Matrix$2.checkMatrix(n),n.isSquare()){if(n.columns===0)return 1;let t,s,l,f;if(n.columns===2)return t=n.get(0,0),s=n.get(0,1),l=n.get(1,0),f=n.get(1,1),t*f-s*l;if(n.columns===3){let m,b,h;return m=new MatrixSelectionView(n,[1,2],[1,2]),b=new MatrixSelectionView(n,[1,2],[0,2]),h=new MatrixSelectionView(n,[1,2],[0,1]),t=n.get(0,0),s=n.get(0,1),l=n.get(0,2),t*determinant(m)-s*determinant(b)+l*determinant(h)}else return new LuDecomposition(n).determinant}else throw Error("determinant can only be calculated for a square matrix")}function xrange(n,t){let s=[];for(let l=0;l<n;l++)l!==t&&s.push(l);return s}function dependenciesOneRow(n,t,s,l=1e-9,f=1e-9){if(n>f)return new Array(t.rows+1).fill(0);{let m=t.addRow(s,[0]);for(let b=0;b<m.rows;b++)Math.abs(m.get(b,0))<l&&m.set(b,0,0);return m.to1DArray()}}function linearDependencies(n,t={}){const{thresholdValue:s=1e-9,thresholdError:l=1e-9}=t;n=Matrix$2.checkMatrix(n);let f=n.rows,m=new Matrix$2(f,f);for(let b=0;b<f;b++){let h=Matrix$2.columnVector(n.getRow(b)),S=n.subMatrixRow(xrange(f,b)).transpose(),C=new SingularValueDecomposition(S).solve(h),L=Matrix$2.sub(h,S.mmul(C)).abs().max();m.setRow(b,dependenciesOneRow(L,C,b,s,l))}return m}function pseudoInverse(n,t=Number.EPSILON){if(n=Matrix$2.checkMatrix(n),n.isEmpty())return n.transpose();let s=new SingularValueDecomposition(n,{autoTranspose:!0}),l=s.leftSingularVectors,f=s.rightSingularVectors,m=s.diagonal;for(let b=0;b<m.length;b++)Math.abs(m[b])>t?m[b]=1/m[b]:m[b]=0;return f.mmul(Matrix$2.diag(m).mmul(l.transpose()))}function covariance(n,t=n,s={}){n=new Matrix$2(n);let l=!1;if(typeof t=="object"&&!Matrix$2.isMatrix(t)&&!isAnyArray(t)?(s=t,t=n,l=!0):t=new Matrix$2(t),n.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:f=!0}=s;f&&(n=n.center("column"),l||(t=t.center("column")));const m=n.transpose().mmul(t);for(let b=0;b<m.rows;b++)for(let h=0;h<m.columns;h++)m.set(b,h,m.get(b,h)*(1/(n.rows-1)));return m}function correlation(n,t=n,s={}){n=new Matrix$2(n);let l=!1;if(typeof t=="object"&&!Matrix$2.isMatrix(t)&&!isAnyArray(t)?(s=t,t=n,l=!0):t=new Matrix$2(t),n.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:f=!0,scale:m=!0}=s;f&&(n.center("column"),l||t.center("column")),m&&(n.scale("column"),l||t.scale("column"));const b=n.standardDeviation("column",{unbiased:!0}),h=l?b:t.standardDeviation("column",{unbiased:!0}),S=n.transpose().mmul(t);for(let M=0;M<S.rows;M++)for(let C=0;C<S.columns;C++)S.set(M,C,S.get(M,C)*(1/(b[M]*h[C]))*(1/(n.rows-1)));return S}class EigenvalueDecomposition{constructor(t,s={}){const{assumeSymmetric:l=!1}=s;if(t=WrapperMatrix2D.checkMatrix(t),!t.isSquare())throw new Error("Matrix is not a square matrix");if(t.isEmpty())throw new Error("Matrix must be non-empty");let f=t.columns,m=new Matrix$2(f,f),b=new Float64Array(f),h=new Float64Array(f),S=t,M,C,L=!1;if(l?L=!0:L=t.isSymmetric(),L){for(M=0;M<f;M++)for(C=0;C<f;C++)m.set(M,C,S.get(M,C));tred2(f,h,b,m),tql2(f,h,b,m)}else{let N=new Matrix$2(f,f),F=new Float64Array(f);for(C=0;C<f;C++)for(M=0;M<f;M++)N.set(M,C,S.get(M,C));orthes(f,N,F,m),hqr2(f,h,b,m,N)}this.n=f,this.e=h,this.d=b,this.V=m}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let t=this.n,s=this.e,l=this.d,f=new Matrix$2(t,t),m,b;for(m=0;m<t;m++){for(b=0;b<t;b++)f.set(m,b,0);f.set(m,m,l[m]),s[m]>0?f.set(m,m+1,s[m]):s[m]<0&&f.set(m,m-1,s[m])}return f}}function tred2(n,t,s,l){let f,m,b,h,S,M,C,L;for(S=0;S<n;S++)s[S]=l.get(n-1,S);for(h=n-1;h>0;h--){for(L=0,b=0,M=0;M<h;M++)L=L+Math.abs(s[M]);if(L===0)for(t[h]=s[h-1],S=0;S<h;S++)s[S]=l.get(h-1,S),l.set(h,S,0),l.set(S,h,0);else{for(M=0;M<h;M++)s[M]/=L,b+=s[M]*s[M];for(f=s[h-1],m=Math.sqrt(b),f>0&&(m=-m),t[h]=L*m,b=b-f*m,s[h-1]=f-m,S=0;S<h;S++)t[S]=0;for(S=0;S<h;S++){for(f=s[S],l.set(S,h,f),m=t[S]+l.get(S,S)*f,M=S+1;M<=h-1;M++)m+=l.get(M,S)*s[M],t[M]+=l.get(M,S)*f;t[S]=m}for(f=0,S=0;S<h;S++)t[S]/=b,f+=t[S]*s[S];for(C=f/(b+b),S=0;S<h;S++)t[S]-=C*s[S];for(S=0;S<h;S++){for(f=s[S],m=t[S],M=S;M<=h-1;M++)l.set(M,S,l.get(M,S)-(f*t[M]+m*s[M]));s[S]=l.get(h-1,S),l.set(h,S,0)}}s[h]=b}for(h=0;h<n-1;h++){if(l.set(n-1,h,l.get(h,h)),l.set(h,h,1),b=s[h+1],b!==0){for(M=0;M<=h;M++)s[M]=l.get(M,h+1)/b;for(S=0;S<=h;S++){for(m=0,M=0;M<=h;M++)m+=l.get(M,h+1)*l.get(M,S);for(M=0;M<=h;M++)l.set(M,S,l.get(M,S)-m*s[M])}}for(M=0;M<=h;M++)l.set(M,h+1,0)}for(S=0;S<n;S++)s[S]=l.get(n-1,S),l.set(n-1,S,0);l.set(n-1,n-1,1),t[0]=0}function tql2(n,t,s,l){let f,m,b,h,S,M,C,L,N,F,G,H,K,X,de,Q;for(b=1;b<n;b++)t[b-1]=t[b];t[n-1]=0;let ie=0,ce=0,ge=Number.EPSILON;for(M=0;M<n;M++){for(ce=Math.max(ce,Math.abs(s[M])+Math.abs(t[M])),C=M;C<n&&!(Math.abs(t[C])<=ge*ce);)C++;if(C>M)do{for(f=s[M],L=(s[M+1]-f)/(2*t[M]),N=hypotenuse$1(L,1),L<0&&(N=-N),s[M]=t[M]/(L+N),s[M+1]=t[M]*(L+N),F=s[M+1],m=f-s[M],b=M+2;b<n;b++)s[b]-=m;for(ie=ie+m,L=s[C],G=1,H=G,K=G,X=t[M+1],de=0,Q=0,b=C-1;b>=M;b--)for(K=H,H=G,Q=de,f=G*t[b],m=G*L,N=hypotenuse$1(L,t[b]),t[b+1]=de*N,de=t[b]/N,G=L/N,L=G*s[b]-de*f,s[b+1]=m+de*(G*f+de*s[b]),S=0;S<n;S++)m=l.get(S,b+1),l.set(S,b+1,de*l.get(S,b)+G*m),l.set(S,b,G*l.get(S,b)-de*m);L=-de*Q*K*X*t[M]/F,t[M]=de*L,s[M]=G*L}while(Math.abs(t[M])>ge*ce);s[M]=s[M]+ie,t[M]=0}for(b=0;b<n-1;b++){for(S=b,L=s[b],h=b+1;h<n;h++)s[h]<L&&(S=h,L=s[h]);if(S!==b)for(s[S]=s[b],s[b]=L,h=0;h<n;h++)L=l.get(h,b),l.set(h,b,l.get(h,S)),l.set(h,S,L)}}function orthes(n,t,s,l){let f=0,m=n-1,b,h,S,M,C,L,N;for(L=f+1;L<=m-1;L++){for(N=0,M=L;M<=m;M++)N=N+Math.abs(t.get(M,L-1));if(N!==0){for(S=0,M=m;M>=L;M--)s[M]=t.get(M,L-1)/N,S+=s[M]*s[M];for(h=Math.sqrt(S),s[L]>0&&(h=-h),S=S-s[L]*h,s[L]=s[L]-h,C=L;C<n;C++){for(b=0,M=m;M>=L;M--)b+=s[M]*t.get(M,C);for(b=b/S,M=L;M<=m;M++)t.set(M,C,t.get(M,C)-b*s[M])}for(M=0;M<=m;M++){for(b=0,C=m;C>=L;C--)b+=s[C]*t.get(M,C);for(b=b/S,C=L;C<=m;C++)t.set(M,C,t.get(M,C)-b*s[C])}s[L]=N*s[L],t.set(L,L-1,N*h)}}for(M=0;M<n;M++)for(C=0;C<n;C++)l.set(M,C,M===C?1:0);for(L=m-1;L>=f+1;L--)if(t.get(L,L-1)!==0){for(M=L+1;M<=m;M++)s[M]=t.get(M,L-1);for(C=L;C<=m;C++){for(h=0,M=L;M<=m;M++)h+=s[M]*l.get(M,C);for(h=h/s[L]/t.get(L,L-1),M=L;M<=m;M++)l.set(M,C,l.get(M,C)+h*s[M])}}}function hqr2(n,t,s,l,f){let m=n-1,b=0,h=n-1,S=Number.EPSILON,M=0,C=0,L=0,N=0,F=0,G=0,H=0,K=0,X,de,Q,ie,ce,ge,be,ne,ve,te,he,Ie,Oe,tt,it;for(X=0;X<n;X++)for((X<b||X>h)&&(s[X]=f.get(X,X),t[X]=0),de=Math.max(X-1,0);de<n;de++)C=C+Math.abs(f.get(X,de));for(;m>=b;){for(ie=m;ie>b&&(G=Math.abs(f.get(ie-1,ie-1))+Math.abs(f.get(ie,ie)),G===0&&(G=C),!(Math.abs(f.get(ie,ie-1))<S*G));)ie--;if(ie===m)f.set(m,m,f.get(m,m)+M),s[m]=f.get(m,m),t[m]=0,m--,K=0;else if(ie===m-1){if(be=f.get(m,m-1)*f.get(m-1,m),L=(f.get(m-1,m-1)-f.get(m,m))/2,N=L*L+be,H=Math.sqrt(Math.abs(N)),f.set(m,m,f.get(m,m)+M),f.set(m-1,m-1,f.get(m-1,m-1)+M),ne=f.get(m,m),N>=0){for(H=L>=0?L+H:L-H,s[m-1]=ne+H,s[m]=s[m-1],H!==0&&(s[m]=ne-be/H),t[m-1]=0,t[m]=0,ne=f.get(m,m-1),G=Math.abs(ne)+Math.abs(H),L=ne/G,N=H/G,F=Math.sqrt(L*L+N*N),L=L/F,N=N/F,de=m-1;de<n;de++)H=f.get(m-1,de),f.set(m-1,de,N*H+L*f.get(m,de)),f.set(m,de,N*f.get(m,de)-L*H);for(X=0;X<=m;X++)H=f.get(X,m-1),f.set(X,m-1,N*H+L*f.get(X,m)),f.set(X,m,N*f.get(X,m)-L*H);for(X=b;X<=h;X++)H=l.get(X,m-1),l.set(X,m-1,N*H+L*l.get(X,m)),l.set(X,m,N*l.get(X,m)-L*H)}else s[m-1]=ne+L,s[m]=ne+L,t[m-1]=H,t[m]=-H;m=m-2,K=0}else{if(ne=f.get(m,m),ve=0,be=0,ie<m&&(ve=f.get(m-1,m-1),be=f.get(m,m-1)*f.get(m-1,m)),K===10){for(M+=ne,X=b;X<=m;X++)f.set(X,X,f.get(X,X)-ne);G=Math.abs(f.get(m,m-1))+Math.abs(f.get(m-1,m-2)),ne=ve=.75*G,be=-.4375*G*G}if(K===30&&(G=(ve-ne)/2,G=G*G+be,G>0)){for(G=Math.sqrt(G),ve<ne&&(G=-G),G=ne-be/((ve-ne)/2+G),X=b;X<=m;X++)f.set(X,X,f.get(X,X)-G);M+=G,ne=ve=be=.964}for(K=K+1,ce=m-2;ce>=ie&&(H=f.get(ce,ce),F=ne-H,G=ve-H,L=(F*G-be)/f.get(ce+1,ce)+f.get(ce,ce+1),N=f.get(ce+1,ce+1)-H-F-G,F=f.get(ce+2,ce+1),G=Math.abs(L)+Math.abs(N)+Math.abs(F),L=L/G,N=N/G,F=F/G,!(ce===ie||Math.abs(f.get(ce,ce-1))*(Math.abs(N)+Math.abs(F))<S*(Math.abs(L)*(Math.abs(f.get(ce-1,ce-1))+Math.abs(H)+Math.abs(f.get(ce+1,ce+1))))));)ce--;for(X=ce+2;X<=m;X++)f.set(X,X-2,0),X>ce+2&&f.set(X,X-3,0);for(Q=ce;Q<=m-1&&(tt=Q!==m-1,Q!==ce&&(L=f.get(Q,Q-1),N=f.get(Q+1,Q-1),F=tt?f.get(Q+2,Q-1):0,ne=Math.abs(L)+Math.abs(N)+Math.abs(F),ne!==0&&(L=L/ne,N=N/ne,F=F/ne)),ne!==0);Q++)if(G=Math.sqrt(L*L+N*N+F*F),L<0&&(G=-G),G!==0){for(Q!==ce?f.set(Q,Q-1,-G*ne):ie!==ce&&f.set(Q,Q-1,-f.get(Q,Q-1)),L=L+G,ne=L/G,ve=N/G,H=F/G,N=N/L,F=F/L,de=Q;de<n;de++)L=f.get(Q,de)+N*f.get(Q+1,de),tt&&(L=L+F*f.get(Q+2,de),f.set(Q+2,de,f.get(Q+2,de)-L*H)),f.set(Q,de,f.get(Q,de)-L*ne),f.set(Q+1,de,f.get(Q+1,de)-L*ve);for(X=0;X<=Math.min(m,Q+3);X++)L=ne*f.get(X,Q)+ve*f.get(X,Q+1),tt&&(L=L+H*f.get(X,Q+2),f.set(X,Q+2,f.get(X,Q+2)-L*F)),f.set(X,Q,f.get(X,Q)-L),f.set(X,Q+1,f.get(X,Q+1)-L*N);for(X=b;X<=h;X++)L=ne*l.get(X,Q)+ve*l.get(X,Q+1),tt&&(L=L+H*l.get(X,Q+2),l.set(X,Q+2,l.get(X,Q+2)-L*F)),l.set(X,Q,l.get(X,Q)-L),l.set(X,Q+1,l.get(X,Q+1)-L*N)}}}if(C!==0){for(m=n-1;m>=0;m--)if(L=s[m],N=t[m],N===0)for(ie=m,f.set(m,m,1),X=m-1;X>=0;X--){for(be=f.get(X,X)-L,F=0,de=ie;de<=m;de++)F=F+f.get(X,de)*f.get(de,m);if(t[X]<0)H=be,G=F;else if(ie=X,t[X]===0?f.set(X,m,be!==0?-F/be:-F/(S*C)):(ne=f.get(X,X+1),ve=f.get(X+1,X),N=(s[X]-L)*(s[X]-L)+t[X]*t[X],ge=(ne*G-H*F)/N,f.set(X,m,ge),f.set(X+1,m,Math.abs(ne)>Math.abs(H)?(-F-be*ge)/ne:(-G-ve*ge)/H)),ge=Math.abs(f.get(X,m)),S*ge*ge>1)for(de=X;de<=m;de++)f.set(de,m,f.get(de,m)/ge)}else if(N<0)for(ie=m-1,Math.abs(f.get(m,m-1))>Math.abs(f.get(m-1,m))?(f.set(m-1,m-1,N/f.get(m,m-1)),f.set(m-1,m,-(f.get(m,m)-L)/f.get(m,m-1))):(it=cdiv(0,-f.get(m-1,m),f.get(m-1,m-1)-L,N),f.set(m-1,m-1,it[0]),f.set(m-1,m,it[1])),f.set(m,m-1,0),f.set(m,m,1),X=m-2;X>=0;X--){for(te=0,he=0,de=ie;de<=m;de++)te=te+f.get(X,de)*f.get(de,m-1),he=he+f.get(X,de)*f.get(de,m);if(be=f.get(X,X)-L,t[X]<0)H=be,F=te,G=he;else if(ie=X,t[X]===0?(it=cdiv(-te,-he,be,N),f.set(X,m-1,it[0]),f.set(X,m,it[1])):(ne=f.get(X,X+1),ve=f.get(X+1,X),Ie=(s[X]-L)*(s[X]-L)+t[X]*t[X]-N*N,Oe=(s[X]-L)*2*N,Ie===0&&Oe===0&&(Ie=S*C*(Math.abs(be)+Math.abs(N)+Math.abs(ne)+Math.abs(ve)+Math.abs(H))),it=cdiv(ne*F-H*te+N*he,ne*G-H*he-N*te,Ie,Oe),f.set(X,m-1,it[0]),f.set(X,m,it[1]),Math.abs(ne)>Math.abs(H)+Math.abs(N)?(f.set(X+1,m-1,(-te-be*f.get(X,m-1)+N*f.get(X,m))/ne),f.set(X+1,m,(-he-be*f.get(X,m)-N*f.get(X,m-1))/ne)):(it=cdiv(-F-ve*f.get(X,m-1),-G-ve*f.get(X,m),H,N),f.set(X+1,m-1,it[0]),f.set(X+1,m,it[1]))),ge=Math.max(Math.abs(f.get(X,m-1)),Math.abs(f.get(X,m))),S*ge*ge>1)for(de=X;de<=m;de++)f.set(de,m-1,f.get(de,m-1)/ge),f.set(de,m,f.get(de,m)/ge)}for(X=0;X<n;X++)if(X<b||X>h)for(de=X;de<n;de++)l.set(X,de,f.get(X,de));for(de=n-1;de>=b;de--)for(X=b;X<=h;X++){for(H=0,Q=b;Q<=Math.min(de,h);Q++)H=H+l.get(X,Q)*f.get(Q,de);l.set(X,de,H)}}}function cdiv(n,t,s,l){let f,m;return Math.abs(s)>Math.abs(l)?(f=l/s,m=s+f*l,[(n+f*t)/m,(t-f*n)/m]):(f=s/l,m=l+f*s,[(f*n+t)/m,(f*t-n)/m])}class CholeskyDecomposition{constructor(t){if(t=WrapperMatrix2D.checkMatrix(t),!t.isSymmetric())throw new Error("Matrix is not symmetric");let s=t,l=s.rows,f=new Matrix$2(l,l),m=!0,b,h,S;for(h=0;h<l;h++){let M=0;for(S=0;S<h;S++){let C=0;for(b=0;b<S;b++)C+=f.get(S,b)*f.get(h,b);C=(s.get(h,S)-C)/f.get(S,S),f.set(h,S,C),M=M+C*C}for(M=s.get(h,h)-M,m&=M>0,f.set(h,h,Math.sqrt(Math.max(M,0))),S=h+1;S<l;S++)f.set(h,S,0)}this.L=f,this.positiveDefinite=Boolean(m)}isPositiveDefinite(){return this.positiveDefinite}solve(t){t=WrapperMatrix2D.checkMatrix(t);let s=this.L,l=s.rows;if(t.rows!==l)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let f=t.columns,m=t.clone(),b,h,S;for(S=0;S<l;S++)for(h=0;h<f;h++){for(b=0;b<S;b++)m.set(S,h,m.get(S,h)-m.get(b,h)*s.get(S,b));m.set(S,h,m.get(S,h)/s.get(S,S))}for(S=l-1;S>=0;S--)for(h=0;h<f;h++){for(b=S+1;b<l;b++)m.set(S,h,m.get(S,h)-m.get(b,h)*s.get(b,S));m.set(S,h,m.get(S,h)/s.get(S,S))}return m}get lowerTriangularMatrix(){return this.L}}class nipals{constructor(t,s={}){t=WrapperMatrix2D.checkMatrix(t);let{Y:l}=s;const{scaleScores:f=!1,maxIterations:m=1e3,terminationCriteria:b=1e-10}=s;let h;if(l){if(isAnyArray(l)&&typeof l[0]=="number"?l=Matrix$2.columnVector(l):l=WrapperMatrix2D.checkMatrix(l),l.rows!==t.rows)throw new Error("Y should have the same number of rows as X");h=l.getColumnVector(0)}else h=t.getColumnVector(0);let S=1,M,C,L,N;for(let F=0;F<m&&S>b;F++)L=t.transpose().mmul(h).div(h.transpose().mmul(h).get(0,0)),L=L.div(L.norm()),M=t.mmul(L).div(L.transpose().mmul(L).get(0,0)),F>0&&(S=M.clone().sub(N).pow(2).sum()),N=M.clone(),l?(C=l.transpose().mmul(M).div(M.transpose().mmul(M).get(0,0)),C=C.div(C.norm()),h=l.mmul(C).div(C.transpose().mmul(C).get(0,0))):h=M;if(l){let F=t.transpose().mmul(M).div(M.transpose().mmul(M).get(0,0));F=F.div(F.norm());let G=t.clone().sub(M.clone().mmul(F.transpose())),H=h.transpose().mmul(M).div(M.transpose().mmul(M).get(0,0)),K=l.clone().sub(M.clone().mulS(H.get(0,0)).mmul(C.transpose()));this.t=M,this.p=F.transpose(),this.w=L.transpose(),this.q=C,this.u=h,this.s=M.transpose().mmul(M),this.xResidual=G,this.yResidual=K,this.betas=H}else this.w=L.transpose(),this.s=M.transpose().mmul(M).sqrt(),f?this.t=M.clone().div(this.s.get(0,0)):this.t=M,this.xResidual=t.sub(M.mmul(L.transpose()))}}var src$1=Object.freeze(Object.defineProperty({__proto__:null,AbstractMatrix,default:Matrix$2,Matrix:Matrix$2,wrap,WrapperMatrix1D,WrapperMatrix2D,solve,inverse,determinant,linearDependencies,pseudoInverse,covariance,correlation,SingularValueDecomposition,SVD:SingularValueDecomposition,EigenvalueDecomposition,EVD:EigenvalueDecomposition,CholeskyDecomposition,CHO:CholeskyDecomposition,LuDecomposition,LU:LuDecomposition,QrDecomposition,QR:QrDecomposition,Nipals:nipals,NIPALS:nipals,MatrixColumnView,MatrixColumnSelectionView,MatrixFlipColumnView,MatrixFlipRowView,MatrixRowView,MatrixRowSelectionView,MatrixSelectionView,MatrixSubView,MatrixTransposeView:MatrixTransposeView$1},Symbol.toStringTag,{value:"Module"}));function getSeparatedKernel(n){const t=new SingularValueDecomposition(n,{autoTranspose:!0});if(t.rank!==1)return null;const s=Math.sqrt(t.s[0]),l=t.U.to2DArray().map(m=>m[0]*s),f=t.V.to2DArray().map(m=>m[0]*s);return[l,f]}function convolution(n,t={}){let{channels:s,bitDepth:l,normalize:f=!1,divisor:m=1,border:b="copy",algorithm:h="auto"}=t,S={};l&&(S.bitDepth=l);let M=Image$1.createFrom(this,S);if(s=validateArrayOfChannels(this,s),h!=="separable")({kernel:n}=validateKernel(n));else if(!Array.isArray(n)||n.length!==2)throw new RangeError("separable convolution requires two arrays of numbers to represent the kernel");if(h==="auto"){let ie=getSeparatedKernel(n);ie!==null?(h="separable",n=ie):(n.length>9||n[0].length>9)&&this.width<=4096&&this.height<=4096?h="fft":h="direct"}let C,L;h==="separable"?(C=Math.floor(n[0].length/2),L=Math.floor(n[1].length/2)):(C=Math.floor(n.length/2),L=Math.floor(n[0].length/2));let N=M.isClamped,F=new Array(this.height*this.width),G,H,K,X,de,Q;for(X=0;X<s.length;X++){for(de=s[X],K=0;K<this.height;K++)for(H=0;H<this.width;H++)G=K*this.width+H,F[G]=this.data[G*this.channels+de];if(h==="direct")Q=src$2.direct(F,n,{rows:this.height,cols:this.width,normalize:f,divisor:m});else if(h==="separable"){if(Q=convolutionSeparable(F,n,this.width,this.height),f){m=0;for(let ie=0;ie<n[0].length;ie++)for(let ce=0;ce<n[1].length;ce++)m+=n[0][ie]*n[1][ce]}if(m!==1)for(let ie=0;ie<Q.length;ie++)Q[ie]/=m}else Q=src$2.fft(F,n,{rows:this.height,cols:this.width,normalize:f,divisor:m});for(K=0;K<this.height;K++)for(H=0;H<this.width;H++)G=K*this.width+H,N?M.data[G*this.channels+de]=clamp(Q[G],M):M.data[G*this.channels+de]=Q[G]}if(this.alpha&&!s.includes(this.channels))for(H=this.components;H<this.data.length;H=H+this.channels)M.data[H]=this.data[H];return b!=="periodic"&&M.setBorder({size:[L,C],algorithm:b}),M}function gradientFilter(n={}){let{direction:t="xy",border:s="copy",kernelX:l,kernelY:f,channels:m,bitDepth:b=this.bitDepth}=n;switch(this.checkProcessable("gradientFilter",{bitDepth:[8,16]}),t){case"x":if(!l)throw new Error("kernelX option is missing");return convolution.call(this,l,{channels:m,border:s,bitDepth:b});case"y":if(!f)throw new Error("kernelY option is missing");return convolution.call(this,f,{channels:m,border:s,bitDepth:b});case"xy":{if(!l)throw new Error("kernelX option is missing");if(!f)throw new Error("kernelY option is missing");const h=convolution.call(this,l,{channels:m,border:s,bitDepth:32}),S=convolution.call(this,f,{channels:m,border:s,bitDepth:32});return h.hypotenuse(S,{bitDepth:b,channels:m})}default:throw new Error(`Unknown parameter direction: ${t}`)}}function sobelFilter(n){return gradientFilter.call(this,Object.assign({},n,{kernelX:SOBEL_X,kernelY:SOBEL_Y}))}function scharrFilter(n){return gradientFilter.call(this,Object.assign({},n,{kernelX:SCHARR_X,kernelY:SCHARR_Y}))}var newArray_1=newArray;function newArray(n,t){n=n||0;for(var s=new Array(n),l=0;l<n;l++)s[l]=t;return s}function level(n={}){let{algorithm:t="range",channels:s,min:l=this.min,max:f=this.max}=n;switch(this.checkProcessable("level",{bitDepth:[8,16,32]}),s=validateArrayOfChannels(this,{channels:s}),s.length!==this.channel&&(Array.isArray(l)&&l.length===this.channels&&(l=l.filter((m,b)=>s.includes(b))),Array.isArray(f)&&f.length===this.channels&&(f=f.filter((m,b)=>s.includes(b)))),t){case"range":l<0&&(l=0),f>this.maxValue&&(f=this.maxValue),Array.isArray(l)||(l=newArray_1(s.length,l)),Array.isArray(f)||(f=newArray_1(s.length,f)),processImage(this,l,f,s);break;default:throw new Error(`level: algorithm not implement: ${t}`)}return this}function processImage(n,t,s,l){let f=1e-5,m=new Array(l.length);for(let b=0;b<l.length;b++)t[b]===0&&s[b]===n.maxValue||s[b]===t[b]?m[b]=0:m[b]=(n.maxValue+1-f)/(s[b]-t[b]),t[b]+=(.5-f/2)/m[b];for(let b=0;b<l.length;b++){let h=l[b];if(m[b]!==0)for(let S=0;S<n.data.length;S+=n.channels)n.data[S+h]=Math.min(Math.max(0,(n.data[S+h]-t[b])*m[b]+.5|0),n.maxValue)}}var toString$1=Object.prototype.toString,isArrayType=function n(t){return toString$1.call(t).substr(-6,5)==="Array"};function checkNumberArray(n){if(isNaN(n)){if(n instanceof Image$1)return n.data;if(!isArrayType(n))throw new Error("checkNumberArray: the value should be either a number, array or Image");return n}else{if(n<=0)throw new Error("checkNumberArray: the value must be greater than 0");return n}}function add(n,t={}){let{channels:s}=t;if(this.checkProcessable("add",{bitDepth:[8,16]}),s=validateArrayOfChannels(this,{channels:s}),n=checkNumberArray(n),isNaN(n)){if(this.data.length!==n.length)throw new Error("add: the data size is different");for(let l=0;l<s.length;l++){let f=s[l];for(let m=0;m<this.data.length;m+=this.channels)this.data[m+f]=Math.max(0,Math.min(this.maxValue,this.data[m+f]+n[m+f]>>0))}}else for(let l=0;l<s.length;l++){let f=s[l];for(let m=0;m<this.data.length;m+=this.channels)this.data[m+f]=Math.min(this.maxValue,this.data[m+f]+n>>0)}return this}function subtract(n,t={}){let{channels:s}=t;if(this.checkProcessable("subtract",{bitDepth:[8,16]}),s=validateArrayOfChannels(this,{channels:s}),n=checkNumberArray(n),isNaN(n)){if(this.data.length!==n.length)throw new Error("subtract: the data size is different");for(let l=0;l<s.length;l++){let f=s[l];for(let m=0;m<this.data.length;m+=this.channels)this.data[m+f]=Math.max(0,Math.min(this.maxValue,this.data[m+f]-n[m+f]>>0))}}else for(let l=0;l<s.length;l++){let f=s[l];for(let m=0;m<this.data.length;m+=this.channels)this.data[m+f]=Math.max(0,this.data[m+f]-n>>0)}return this}function subtractImage(n,t={}){let{channels:s,absolute:l=!1}=t;if(this.checkProcessable("subtractImage",{bitDepth:[8,16]}),this.width!==n.width||this.height!==n.height)throw new Error("subtractImage: both images must have the same size");if(this.alpha!==n.alpha||this.bitDepth!==n.bitDepth)throw new Error("subtractImage: both images must have the same alpha and bitDepth");if(this.channels!==n.channels)throw new Error("subtractImage: both images must have the same number of channels");let f=this.clone();s=validateArrayOfChannels(this,{channels:s});for(let m=0;m<s.length;m++){let b=s[m];for(let h=b;h<this.data.length;h+=this.channels){let S=this.data[h]-n.data[h];l?f.data[h]=Math.abs(S):f.data[h]=Math.max(S,0)}}return f}function hypotenuse(n,t={}){let{bitDepth:s=this.bitDepth,channels:l}=t;if(this.checkProcessable("hypotenuse",{bitDepth:[8,16,32]}),this.width!==n.width||this.height!==n.height)throw new Error("hypotenuse: both images must have the same size");if(this.alpha!==n.alpha||this.bitDepth!==n.bitDepth)throw new Error("hypotenuse: both images must have the same alpha and bitDepth");if(this.channels!==n.channels)throw new Error("hypotenuse: both images must have the same number of channels");let f=Image$1.createFrom(this,{bitDepth:s});l=validateArrayOfChannels(this,{channels:l});let m=f.isClamped;for(let b=0;b<l.length;b++){let h=l[b];for(let S=h;S<this.data.length;S+=this.channels){let M=Math.hypot(this.data[S],n.data[S]);m?f.data[S]=Math.min(Math.max(Math.round(M),0),f.maxValue):f.data[S]=M}}return f}function multiply(n,t={}){let{channels:s}=t;if(this.checkProcessable("multiply",{bitDepth:[8,16]}),n<=0)throw new Error("multiply: the value must be greater than 0");if(s=validateArrayOfChannels(this,{channels:s}),n=checkNumberArray(n),isNaN(n)){if(this.data.length!==n.length)throw new Error("multiply: the data size is different");for(let l=0;l<s.length;l++){let f=s[l];for(let m=0;m<this.data.length;m+=this.channels)this.data[m+f]=Math.max(0,Math.min(this.maxValue,this.data[m+f]*n[m+f]>>0))}}else for(let l=0;l<s.length;l++){let f=s[l];for(let m=0;m<this.data.length;m+=this.channels)this.data[m+f]=Math.min(this.maxValue,this.data[m+f]*n>>0)}return this}function divide(n,t={}){let{channels:s}=t;if(this.checkProcessable("divide",{bitDepth:[8,16]}),s=validateArrayOfChannels(this,{channels:s}),n=checkNumberArray(n),isNaN(n)){if(this.data.length!==n.length)throw new Error("divide: the: the data size is different");for(let l=0;l<s.length;l++){let f=s[l];for(let m=0;m<this.data.length;m+=this.channels)this.data[m+f]=Math.max(0,Math.min(this.maxValue,this.data[m+f]/n[m+f]>>0))}}else for(let l=0;l<s.length;l++){let f=s[l];for(let m=0;m<this.data.length;m+=this.channels)this.data[m+f]=Math.min(this.maxValue,this.data[m+f]/n>>0)}return this}class BaseRegression{constructor(){if(new.target===BaseRegression)throw new Error("BaseRegression must be subclassed")}predict(t){if(typeof t=="number")return this._predict(t);if(isAnyArray(t)){const s=[];for(let l=0;l<t.length;l++)s.push(this._predict(t[l]));return s}else throw new TypeError("x must be a number or array")}_predict(){throw new Error("_predict must be implemented")}train(){}toString(){return""}toLaTeX(){return""}score(t,s){if(!isAnyArray(t)||!isAnyArray(s)||t.length!==s.length)throw new Error("x and y must be arrays of the same length");const l=t.length,f=new Array(l);for(let F=0;F<l;F++)f[F]=this._predict(t[F]);let m=0,b=0,h=0,S=0,M=0,C=0,L=0;for(let F=0;F<l;F++)m+=f[F],b+=s[F],M+=f[F]*f[F],C+=s[F]*s[F],L+=f[F]*s[F],s[F]!==0&&(h+=(s[F]-f[F])*(s[F]-f[F])/s[F]),S+=(s[F]-f[F])*(s[F]-f[F]);const N=(l*L-m*b)/Math.sqrt((l*M-m*m)*(l*C-b*b));return{r:N,r2:N*N,chi2:h,rmsd:Math.sqrt(S/l)}}}var require$$0$2=getAugmentedNamespace(src$1);function squaredEuclidean$4(n,t){let s=0;for(let l=0;l<n.length;l++)s+=(n[l]-t[l])*(n[l]-t[l]);return s}function euclidean$2(n,t){return Math.sqrt(squaredEuclidean$4(n,t))}var euclidean$3=Object.freeze(Object.defineProperty({__proto__:null,squaredEuclidean:squaredEuclidean$4,euclidean:euclidean$2},Symbol.toStringTag,{value:"Module"})),require$$0$1=getAugmentedNamespace(euclidean$3);const{squaredEuclidean:squaredEuclidean$3}=require$$0$1,defaultOptions$b={sigma:1};class GaussianKernel$1{constructor(t){t=Object.assign({},defaultOptions$b,t),this.sigma=t.sigma,this.divisor=2*t.sigma*t.sigma}compute(t,s){const l=squaredEuclidean$3(t,s);return Math.exp(-l/this.divisor)}}var gaussianKernel=GaussianKernel$1;const defaultOptions$a={degree:1,constant:1,scale:1};class PolynomialKernel$1{constructor(t){t=Object.assign({},defaultOptions$a,t),this.degree=t.degree,this.constant=t.constant,this.scale=t.scale}compute(t,s){for(var l=0,f=0;f<t.length;f++)l+=t[f]*s[f];return Math.pow(this.scale*l+this.constant,this.degree)}}var polynomialKernel=PolynomialKernel$1;const defaultOptions$9={alpha:.01,constant:-Math.E};class SigmoidKernel$1{constructor(t){t=Object.assign({},defaultOptions$9,t),this.alpha=t.alpha,this.constant=t.constant}compute(t,s){for(var l=0,f=0;f<t.length;f++)l+=t[f]*s[f];return Math.tanh(this.alpha*l+this.constant)}}var sigmoidKernel=SigmoidKernel$1;const defaultOptions$8={sigma:1,degree:1};class ANOVAKernel$1{constructor(t){t=Object.assign({},defaultOptions$8,t),this.sigma=t.sigma,this.degree=t.degree}compute(t,s){for(var l=0,f=Math.min(t.length,s.length),m=1;m<=f;++m)l+=Math.pow(Math.exp(-this.sigma*Math.pow(Math.pow(t[m-1],m)-Math.pow(s[m-1],m),2)),this.degree);return l}}var anovaKernel=ANOVAKernel$1;const{squaredEuclidean:squaredEuclidean$2}=require$$0$1,defaultOptions$7={sigma:1};class CauchyKernel$1{constructor(t){t=Object.assign({},defaultOptions$7,t),this.sigma=t.sigma}compute(t,s){return 1/(1+squaredEuclidean$2(t,s)/(this.sigma*this.sigma))}}var cauchyKernel=CauchyKernel$1;const{euclidean:euclidean$1}=require$$0$1,defaultOptions$6={sigma:1};class ExponentialKernel$1{constructor(t){t=Object.assign({},defaultOptions$6,t),this.sigma=t.sigma,this.divisor=2*t.sigma*t.sigma}compute(t,s){const l=euclidean$1(t,s);return Math.exp(-l/this.divisor)}}var exponentialKernel=ExponentialKernel$1;class HistogramIntersectionKernel{compute(t,s){for(var l=Math.min(t.length,s.length),f=0,m=0;m<l;++m)f+=Math.min(t[m],s[m]);return f}}var histogramIntersectionKernel=HistogramIntersectionKernel;const{euclidean}=require$$0$1,defaultOptions$5={sigma:1};class LaplacianKernel$1{constructor(t){t=Object.assign({},defaultOptions$5,t),this.sigma=t.sigma}compute(t,s){const l=euclidean(t,s);return Math.exp(-l/this.sigma)}}var laplacianKernel=LaplacianKernel$1;const{squaredEuclidean:squaredEuclidean$1}=require$$0$1,defaultOptions$4={constant:1};class MultiquadraticKernel$1{constructor(t){t=Object.assign({},defaultOptions$4,t),this.constant=t.constant}compute(t,s){return Math.sqrt(squaredEuclidean$1(t,s)+this.constant*this.constant)}}var multiquadraticKernel=MultiquadraticKernel$1;const{squaredEuclidean}=require$$0$1,defaultOptions$3={constant:1};class RationalQuadraticKernel{constructor(t){t=Object.assign({},defaultOptions$3,t),this.constant=t.constant}compute(t,s){const l=squaredEuclidean(t,s);return 1-l/(l+this.constant)}}var rationalQuadraticKernel=RationalQuadraticKernel;const{Matrix:Matrix$1,MatrixTransposeView}=require$$0$2,GaussianKernel=gaussianKernel,PolynomialKernel=polynomialKernel,SigmoidKernel=sigmoidKernel,ANOVAKernel=anovaKernel,CauchyKernel=cauchyKernel,ExponentialKernel=exponentialKernel,HistogramKernel=histogramIntersectionKernel,LaplacianKernel=laplacianKernel,MultiquadraticKernel=multiquadraticKernel,RationalKernel=rationalQuadraticKernel,kernelType={gaussian:GaussianKernel,rbf:GaussianKernel,polynomial:PolynomialKernel,poly:PolynomialKernel,anova:ANOVAKernel,cauchy:CauchyKernel,exponential:ExponentialKernel,histogram:HistogramKernel,min:HistogramKernel,laplacian:LaplacianKernel,multiquadratic:MultiquadraticKernel,rational:RationalKernel,sigmoid:SigmoidKernel,mlp:SigmoidKernel};class Kernel{constructor(t,s){if(this.kernelType=t,t!=="linear")if(typeof t=="string"){t=t.toLowerCase();var l=kernelType[t];if(l)this.kernelFunction=new l(s);else throw new Error(`unsupported kernel type: ${t}`)}else if(typeof t=="object"&&typeof t.compute=="function")this.kernelFunction=t;else throw new TypeError("first argument must be a valid kernel type or instance")}compute(t,s){if(t=Matrix$1.checkMatrix(t),s===void 0?s=t:s=Matrix$1.checkMatrix(s),this.kernelType==="linear")return t.mmul(new MatrixTransposeView(s));const l=new Matrix$1(t.rows,s.rows);if(t===s)for(let f=0;f<t.rows;f++)for(let m=f;m<t.rows;m++){const b=this.kernelFunction.compute(t.getRow(f),t.getRow(m));l.set(f,m,b),l.set(m,f,b)}else for(let f=0;f<t.rows;f++)for(let m=0;m<s.rows;m++)l.set(f,m,this.kernelFunction.compute(t.getRow(f),s.getRow(m)));return l}}var kernel=Kernel;const defaultOptions$2={lambda:.1,kernelType:"gaussian",kernelOptions:{},computeCoefficient:!1};class KernelRidgeRegression extends BaseRegression{constructor(t,s,l){if(super(),t===!0)this.alpha=s.alpha,this.inputs=s.inputs,this.kernelType=s.kernelType,this.kernelOptions=s.kernelOptions,this.kernel=new kernel(s.kernelType,s.kernelOptions);else{t=Matrix$2.checkMatrix(t),l=Object.assign({},defaultOptions$2,l);const f=new kernel(l.kernelType,l.kernelOptions),m=f.compute(t),b=t.rows;m.add(Matrix$2.eye(b,b).mul(l.lambda)),this.alpha=solve(m,s),this.inputs=t,this.kernelType=l.kernelType,this.kernelOptions=l.kernelOptions,this.kernel=f}}_predict(t){return this.kernel.compute([t],this.inputs).mmul(this.alpha).getRow(0)}toJSON(){return{name:"kernelRidgeRegression",alpha:this.alpha,inputs:this.inputs,kernelType:this.kernelType,kernelOptions:this.kernelOptions}}static load(t){if(t.name!=="kernelRidgeRegression")throw new TypeError("not a KRR model");return new KernelRidgeRegression(!0,t)}}function background$1(n,t,s){const l=new KernelRidgeRegression(n,t,s),f=new Array(this.size);for(let h=0;h<this.width;h++)for(let S=0;S<this.height;S++)f[S*this.width+h]=[h,S];const m=l.predict(f),b=Image$1.createFrom(this);for(let h=0;h<this.size;h++)b.data[h]=Math.min(this.maxValue,Math.max(0,m[h][0]));return b}function dilate(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("dilate",{bitDepth:[1,8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("dilate: The number of rows and columns of the kernel must be odd");let l=!0;e:for(const m of t)for(const b of m)if(b!==1){l=!1;break e}let f=this;for(let m=0;m<s;m++)if(this.bitDepth===1)if(l){const b=f.clone();f=dilateOnceBinaryOnlyOnes(f,b,t.length,t[0].length)}else{const b=Image$1.createFrom(f);f=dilateOnceBinary(f,b,t)}else if(l){const b=Image$1.createFrom(f);f=dilateOnceGreyOnlyOnes(f,b,t.length,t[0].length)}else{const b=Image$1.createFrom(f);f=dilateOnceGrey(f,b,t)}return f}function dilateOnceGrey(n,t,s){const l=s.length,f=s[0].length;let m=(l-1)/2,b=(f-1)/2;for(let h=0;h<n.height;h++)for(let S=0;S<n.width;S++){let M=0;for(let C=0;C<f;C++)for(let L=0;L<l;L++){if(s[L][C]!==1)continue;let N=L-m+S,F=C-b+h;if(N<0||F<0||N>=n.width||F>=n.height)continue;const G=n.getValueXY(N,F,0);G>M&&(M=G)}t.setValueXY(S,h,0,M)}return t}function dilateOnceGreyOnlyOnes(n,t,s,l){const f=(s-1)/2,m=(l-1)/2,b=[];for(let h=0;h<n.width;h++)b.push(0);for(let h=0;h<n.height;h++){for(let S=0;S<n.width;S++){let M=0;for(let C=Math.max(0,h-m);C<Math.min(n.height,h+m+1);C++){const L=n.getValueXY(S,C,0);L>M&&(M=L)}b[S]=M}for(let S=0;S<n.width;S++){let M=0;for(let C=Math.max(0,S-f);C<Math.min(n.width,S+f+1);C++)b[C]>M&&(M=b[C]);t.setValueXY(S,h,0,M)}}return t}function dilateOnceBinary(n,t,s){const l=s.length,f=s[0].length;let m=(l-1)/2,b=(f-1)/2;for(let h=0;h<n.height;h++)for(let S=0;S<n.width;S++){let M=0;e:for(let C=0;C<f;C++)for(let L=0;L<l;L++){if(s[L][C]!==1)continue;let N=L-m+S,F=C-b+h;if(F<0||N<0||N>=n.width||F>=n.height)continue;if(n.getBitXY(N,F)===1){M=1;break e}}M===1&&t.setBitXY(S,h)}return t}function dilateOnceBinaryOnlyOnes(n,t,s,l){const f=(s-1)/2,m=(l-1)/2,b=[];for(let h=0;h<n.width;h++)b.push(1);for(let h=0;h<n.height;h++){for(let S=0;S<n.width;S++){b[S]=0;for(let M=Math.max(0,h-m);M<Math.min(n.height,h+m+1);M++)if(n.getBitXY(S,M)===1){b[S]=1;break}}for(let S=0;S<n.width;S++)if(t.getBitXY(S,h)!==1){for(let M=Math.max(0,S-f);M<Math.min(n.width,S+f+1);M++)if(b[M]===1){t.setBitXY(S,h);break}}}return t}function erode(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("erode",{bitDepth:[1,8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("erode: The number of rows and columns of the kernel must be odd");let l=!0;e:for(const m of t)for(const b of m)if(b!==1){l=!1;break e}let f=this;for(let m=0;m<s;m++)if(this.bitDepth===1)if(l){const b=f.clone();f=erodeOnceBinaryOnlyOnes(f,b,t.length,t[0].length)}else{const b=Image$1.createFrom(f);f=erodeOnceBinary(f,b,t)}else if(l){const b=Image$1.createFrom(f);f=erodeOnceGreyOnlyOnes(f,b,t.length,t[0].length)}else{const b=Image$1.createFrom(f);f=erodeOnceGrey(f,b,t)}return f}function erodeOnceGrey(n,t,s){const l=s.length,f=s[0].length;let m=(l-1)/2,b=(f-1)/2;for(let h=0;h<n.height;h++)for(let S=0;S<n.width;S++){let M=n.maxValue;for(let C=0;C<f;C++)for(let L=0;L<l;L++){if(s[L][C]!==1)continue;let N=L-m+S,F=C-b+h;if(N<0||F<0||N>=n.width||F>=n.height)continue;const G=n.getValueXY(N,F,0);G<M&&(M=G)}t.setValueXY(S,h,0,M)}return t}function erodeOnceGreyOnlyOnes(n,t,s,l){const f=(s-1)/2,m=(l-1)/2,b=[];for(let h=0;h<n.width;h++)b.push(0);for(let h=0;h<n.height;h++){for(let S=0;S<n.width;S++){let M=n.maxValue;for(let C=Math.max(0,h-m);C<Math.min(n.height,h+m+1);C++){const L=n.getValueXY(S,C,0);L<M&&(M=L)}b[S]=M}for(let S=0;S<n.width;S++){let M=n.maxValue;for(let C=Math.max(0,S-f);C<Math.min(n.width,S+f+1);C++)b[C]<M&&(M=b[C]);t.setValueXY(S,h,0,M)}}return t}function erodeOnceBinary(n,t,s){const l=s.length,f=s[0].length;let m=(l-1)/2,b=(f-1)/2;for(let h=0;h<n.height;h++)for(let S=0;S<n.width;S++){let M=1;e:for(let C=0;C<f;C++)for(let L=0;L<l;L++){if(s[L][C]!==1)continue;let N=L-m+S,F=C-b+h;if(F<0||N<0||N>=n.width||F>=n.height)continue;if(n.getBitXY(N,F)===0){M=0;break e}}M===1&&t.setBitXY(S,h)}return t}function erodeOnceBinaryOnlyOnes(n,t,s,l){const f=(s-1)/2,m=(l-1)/2,b=[];for(let h=0;h<n.width;h++)b.push(0);for(let h=0;h<n.height;h++){for(let S=0;S<n.width;S++){b[S]=1;for(let M=Math.max(0,h-m);M<Math.min(n.height,h+m+1);M++)if(n.getBitXY(S,M)===0){b[S]=0;break}}for(let S=0;S<n.width;S++)if(t.getBitXY(S,h)!==0){for(let M=Math.max(0,S-f);M<Math.min(n.width,S+f+1);M++)if(b[M]===0){t.clearBitXY(S,h);break}}}return t}function open(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("open",{bitDepth:[8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("open: The number of rows and columns of the kernel must be odd");let l=this;for(let f=0;f<s;f++)l=l.erode({kernel:t}),l=l.dilate({kernel:t});return l}function close(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("close",{bitDepth:[1,8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("close: The number of rows and columns of the kernel must be odd");let l=this;for(let f=0;f<s;f++)l=l.dilate({kernel:t}).erode({kernel:t});return l}function topHat(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("topHat",{bitDepth:[8,16],components:1,alpha:0}),t.length%2===0||t[0].length%2===0)throw new TypeError("topHat: The number of rows and columns of the kernel must be odd");let l=this;for(let f=0;f<s;f++)l=l.open({kernel:t}).subtractImage(l,{absolute:!0});return l}function blackHat(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("blackHat",{bitDepth:[8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("blackHat: The number of rows and columns of the kernel must be odd");let l=this;for(let f=0;f<s;f++)l=l.close({kernel:t}).subtractImage(l,{absolute:!0});return l}function morphologicalGradient(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("morphologicalGradient",{bitDepth:[8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("morphologicalGradient: The number of rows and columns of the kernel must be odd");let l=this;for(let f=0;f<s;f++){let m=l.dilate({kernel:t}),b=l.erode({kernel:t});l=m.subtractImage(b,{absolute:!0})}return l}function order4Points(n){let t=0,s=0,l=0,f=0,m=n[0][0],b=0;for(let M=1;M<n.length;M++)n[M][0]<m&&(m=n[M][0],b=M);let h=n[(b+1)%n.length][0],S=(b+1)%n.length;for(let M=1;M<n.length;M++)n[M][0]<h&&M!==b&&(h=n[M][0],S=M);return n[S][1]<n[b][1]?(t=n[S],f=n[b],b!==(S+1)%4?(s=n[(S+1)%4],l=n[(S+2)%4]):(s=n[(S+2)%4],l=n[(S+3)%4])):(f=n[S],t=n[b],S!==(b+1)%4?(s=n[(b+1)%4],l=n[(b+2)%4]):(s=n[(b+2)%4],l=n[(b+3)%4])),[t,s,l,f]}function distance2Points(n,t){return Math.sqrt(Math.pow(n[0]-t[0],2)+Math.pow(n[1]-t[1],2))}function crossVect(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function dotVect(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function computeWidthAndHeigth(n,t,s,l,f,m){let b=Math.max(distance2Points(n,t),distance2Points(l,s)),h=Math.max(distance2Points(n,l),distance2Points(t,s)),S=0,M=0,C=Math.ceil(f/2),L=Math.ceil(m/2),N=b/h,F=[n[0],n[1],1],G=[t[0],t[1],1],H=[l[0],l[1],1],K=[s[0],s[1],1],X=dotVect(crossVect(F,K),H)/dotVect(crossVect(G,K),H),de=dotVect(crossVect(F,K),G)/dotVect(crossVect(H,K),G),Q=[X*G[0]-F[0],X*G[1]-F[1],X*G[2]-F[2]],ie=[de*H[0]-F[0],de*H[1]-F[1],de*H[2]-F[2]],ce=Q[0],ge=Q[1],be=Q[2],ne=ie[0],ve=ie[1],te=ie[2],he=1/(be*te)*(ce*ne-(ce*te+be*ne)*C+be*te*C*C+(ge*ve-(ge*te+be*ve)*L+be*te*L*L));he>=0?he=Math.sqrt(he):he=Math.sqrt(-he);let Ie=new Matrix$2([[he,0,C],[0,he,L],[0,0,1]]),Oe=Ie.transpose(),tt=inverse(Oe),it=inverse(Ie),Ct=Matrix$2.rowVector(Q),Rt=Matrix$2.rowVector(ie),xt=Math.sqrt(dotVect(Ct.mmul(tt).mmul(it).to1DArray(),Q)/dotVect(Rt.mmul(tt).mmul(it).to1DArray(),ie));return xt===0||N===0?(S=Math.ceil(b),M=Math.ceil(h)):xt<N?(S=Math.ceil(b),M=Math.ceil(S/xt)):(M=Math.ceil(h),S=Math.ceil(xt*M)),[S,M]}function projectionPoint(n,t,s,l,f,m,b,h,S,M,C,L){let[N,F]=[(s*n+l*t+f)/(S*n+M*t+1),(m*n+b*t+h)/(S*n+M*t+1)];return C.getValueXY(Math.floor(N),Math.floor(F),L)}function warpingFourPoints(n,t={}){let{calculateRatio:s=!0}=t;if(n.length!==4)throw new Error(`The array pts must have four elements, which are the four corners. Currently, pts have ${n.length} elements`);let[l,f,m,b]=n,h=[l,f,m,b],[S,M,C,L]=order4Points(h),N,F;s?[N,F]=computeWidthAndHeigth(S,M,C,L,this.width,this.height):(N=Math.ceil(Math.max(distance2Points(S,M),distance2Points(L,C))),F=Math.ceil(Math.max(distance2Points(S,L),distance2Points(M,C))));let G=Image$1.createFrom(this,{width:N,height:F}),[H,K]=S,[X,de]=M,[Q,ie]=C,[ce,ge]=L,[be,ne]=[0,0],[ve,te]=[0,N-1],[he,Ie]=[F-1,N-1],[Oe,tt]=[F-1,0],it=new Matrix$2([[be,ne,1,0,0,0,-be*H,-ne*H],[ve,te,1,0,0,0,-ve*X,-te*X],[he,Ie,1,0,0,0,-he*Q,-ne*Q],[Oe,tt,1,0,0,0,-Oe*ce,-tt*ce],[0,0,0,be,ne,1,-be*K,-ne*K],[0,0,0,ve,te,1,-ve*de,-te*de],[0,0,0,he,Ie,1,-he*ie,-Ie*ie],[0,0,0,Oe,tt,1,-Oe*ge,-tt*ge]]),Ct=Matrix$2.columnVector([H,X,Q,ce,K,de,ie,ge]),xt=new SingularValueDecomposition(it).solve(Ct),[Vt,It,Xt,Jt,nt,mt,ft,Dt]=xt.to1DArray(),qt=new Matrix$2(F,N);for(let oi=0;oi<this.channels;oi++){for(let ti=0;ti<F;ti++)for(let fi=0;fi<N;fi++)qt.set(ti,fi,projectionPoint(ti,fi,Vt,It,Xt,Jt,nt,mt,ft,Dt,this,oi));G.setMatrix(qt,{channel:oi})}return G}function crop(n={}){let{x:t=0,y:s=0,width:l=this.width-t,height:f=this.height-s}=n;if(this.checkProcessable("max",{bitDepth:[8,16]}),t=Math.round(t),s=Math.round(s),l=Math.round(l),f=Math.round(f),t>this.width-1||s>this.height-1)throw new RangeError(`crop: origin (x:${t}, y:${s}) out of range (${this.width-1}; ${this.height-1})`);if(l<=0||f<=0)throw new RangeError(`crop: width and height (width:${l}; height:${f}) must be positive numbers`);if(t<0||s<0)throw new RangeError(`crop: x and y (x:${t}, y:${s}) must be positive numbers`);if(l>this.width-t||f>this.height-s)throw new RangeError(`crop: (x: ${t}, y:${s}, width:${l}, height:${f}) size is out of range`);let m=Image$1.createFrom(this,{width:l,height:f,position:[t,s]}),b=l*this.channels,h=s+f,S=0,M=t*this.channels;for(let C=s;C<h;C++){let L=C*this.width*this.channels+M,N=L+b;for(;L<N;L++)m.data[S++]=this.data[L]}return m}function cropAlpha(n={}){this.checkProcessable("cropAlpha",{alpha:1});const{threshold:t=this.maxValue}=n;let s=findLeft(this,t,this.components);if(s===-1)throw new Error("Could not find new dimensions. Threshold may be too high.");let l=findTop(this,t,this.components,s),f=findBottom(this,t,this.components,s),m=findRight(this,t,this.components,s,l,f);return this.crop({x:s,y:l,width:m-s+1,height:f-l+1})}function findLeft(n,t,s){for(let l=0;l<n.width;l++)for(let f=0;f<n.height;f++)if(n.getValueXY(l,f,s)>=t)return l;return-1}function findTop(n,t,s,l){for(let f=0;f<n.height;f++)for(let m=l;m<n.width;m++)if(n.getValueXY(m,f,s)>=t)return f;return-1}function findBottom(n,t,s,l){for(let f=n.height-1;f>=0;f--)for(let m=l;m<n.width;m++)if(n.getValueXY(m,f,s)>=t)return f;return-1}function findRight(n,t,s,l,f,m){for(let b=n.width-1;b>=l;b--)for(let h=f;h<=m;h++)if(n.getValueXY(b,h,s)>=t)return b;return-1}function getFactor(n){if(typeof n=="string"){const t=n[n.length-1];n=parseFloat(n),t==="%"&&(n/=100)}return n}function getThreshold$1(n,t){if(!t)throw Error("getThreshold : the maxValue should be specified");if(typeof n=="string"){if(n[n.length-1]!=="%")throw Error("getThreshold : if the value is a string it must finish by %");return parseFloat(n)/100*t}else{if(typeof n=="number")return n<1?n*t:n;throw Error("getThreshold : the value is not valid")}}function factorDimensions(n,t,s){n=getFactor(n);let l=Math.round(n*t),f=Math.round(n*s);return l<=0&&(l=1),f<=0&&(f=1),{width:l,height:f}}function checkRow(n,t){if(t<0||t>=n.height)throw new RangeError(`row must be included between 0 and ${n.height-1}. Current value: ${t}`)}function checkColumn(n,t){if(t<0||t>=n.width)throw new RangeError(`column must be included between 0 and ${n.width-1}. Current value: ${t}`)}function checkChannel(n,t){if(t<0||t>=n.channels)throw new RangeError(`channel must be included between 0 and ${n.channels-1}. Current value: ${t}`)}const validInterpolations={nearestneighbor:"nearestNeighbor",nearestneighbour:"nearestNeighbor",bilinear:"bilinear"};function checkInterpolation(n){if(typeof n!="string")throw new TypeError("interpolation must be a string");if(n=n.toLowerCase(),!validInterpolations[n])throw new RangeError(`invalid interpolation algorithm: ${n}`);return validInterpolations[n]}function nearestNeighbor(n,t,s){const l=this.width/t,f=this.height/s;if(this.bitDepth>1)for(let m=0;m<t;m++){const b=Math.floor((m+.5)*l);for(let h=0;h<s;h++){const S=Math.floor((h+.5)*f);for(let M=0;M<this.channels;M++)n.setValueXY(m,h,M,this.getValueXY(b,S,M))}}else for(let m=0;m<t;m++){const b=Math.floor((m+.5)*l);for(let h=0;h<s;h++){const S=Math.floor((h+.5)*f);this.getBitXY(b,S)&&n.setBitXY(m,h)}}}function resize(n={}){const{factor:t=1,interpolation:s=validInterpolations.nearestneighbor,preserveAspectRatio:l=!0}=n,f=checkInterpolation(s);let m=n.width,b=n.height;if(m||(b&&l?m=Math.round(b*(this.width/this.height)):m=this.width),b||(l?b=Math.round(m*(this.height/this.width)):b=this.height),{width:m,height:b}=factorDimensions(t,m,b),m===this.width&&b===this.height){const C=this.clone();return C.position=[0,0],C}let h=Math.round((this.width-m)/2),S=Math.round((this.height-b)/2);const M=Image$1.createFrom(this,{width:m,height:b,position:[h,S]});switch(f){case validInterpolations.nearestneighbor:nearestNeighbor.call(this,M,m,b);break;default:throw new Error(`unsupported resize interpolation: ${f}`)}return M}function hsv(){this.checkProcessable("hsv",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let n=Image$1.createFrom(this,{colorModel:HSV}),t=0,s=this.data;for(let l=0;l<s.length;l+=this.channels){let f=s[l],m=s[l+1],b=s[l+2],h=Math.min(f,m,b),S=Math.max(f,m,b),M=S-h,C=0,L=S===0?0:M/S,N=S;if(S!==h){switch(S){case f:C=(m-b)/M+(m<b?6:0);break;case m:C=(b-f)/M+2;break;case b:C=(f-m)/M+4;break;default:throw new Error("unreachable")}C/=6}n.data[t++]=C*this.maxValue,n.data[t++]=L*this.maxValue,n.data[t++]=N,this.alpha&&(n.data[t++]=s[l+3])}return n}function hsl$1(){this.checkProcessable("hsl",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let n=Image$1.createFrom(this,{colorModel:HSL}),t=Math.floor(this.maxValue/2),s=0,l=this.data;for(let f=0;f<l.length;f+=this.channels){let m=l[f],b=l[f+1],h=l[f+2],S=Math.max(m,b,h),M=Math.min(m,b,h),C=0,L=0,N=(S+M)/2;if(S!==M){let F=S-M;switch(L=N>t?F/(2-S-M):F/(S+M),S){case m:C=(b-h)/F+(b<h?6:0);break;case b:C=(h-m)/F+2;break;case h:C=(m-b)/F+4;break;default:throw new Error("unreachable")}C/=6}n.data[s++]=C*this.maxValue,n.data[s++]=L*this.maxValue,n.data[s++]=N,this.alpha&&(n.data[s++]=l[f+3])}return n}function cmyk(){this.checkProcessable("cmyk",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let n=Image$1.createFrom(this,{components:4,colorModel:CMYK$1}),t=0,s=this.data;for(let l=0;l<s.length;l+=this.channels){let f=s[l],m=s[l+1],b=s[l+2],h=Math.min(this.maxValue-f,this.maxValue-m,this.maxValue-b),S=(this.maxValue-f-h)/(1-h/this.maxValue),M=(this.maxValue-m-h)/(1-h/this.maxValue),C=(this.maxValue-b-h)/(1-h/this.maxValue);n.data[t++]=Math.round(S),n.data[t++]=Math.round(M),n.data[t++]=Math.round(C),n.data[t++]=Math.round(h),this.alpha&&(n.data[t++]=s[l+3])}return n}function rgba8(){return new Image$1(this.width,this.height,this.getRGBAData(),{kind:"RGBA",parent:this})}const methods$1={luma709(n,t,s){return n*6966+t*23436+s*2366>>15},luma601(n,t,s){return n*9798+t*19235+s*3735>>15},maximum(n,t,s){return Math.max(n,t,s)},minimum(n,t,s){return Math.min(n,t,s)},average(n,t,s){return(n+t+s)/3>>0},minmax(n,t,s){return(Math.max(n,t,s)+Math.min(n,t,s))/2},red(n){return n},green(n,t){return t},blue(n,t,s){return s},cyan(n,t,s,l){let f=methods$1.black(n,t,s,l);return(l.maxValue-n-f)/(1-f/l.maxValue)>>0},magenta(n,t,s,l){let f=methods$1.black(n,t,s,l);return(l.maxValue-t-f)/(1-f/l.maxValue)>>0},yellow(n,t,s,l){let f=methods$1.black(n,t,s,l);return(l.maxValue-s-f)/(1-f/l.maxValue)>>0},black(n,t,s,l){return Math.min(l.maxValue-n,l.maxValue-t,l.maxValue-s)},hue(n,t,s,l){let f=methods$1.min(n,t,s),m=methods$1.max(n,t,s);if(m===f)return 0;let b=0,h=m-f;switch(m){case n:b=(t-s)/h+(t<s?6:0);break;case t:b=(s-n)/h+2;break;case s:b=(n-t)/h+4;break;default:throw new Error("unreachable")}return b/6*l.maxValue>>0},saturation(n,t,s,l){let f=methods$1.min(n,t,s),m=methods$1.max(n,t,s),b=m-f;return m===0?0:b/m*l.maxValue},lightness(n,t,s){let l=methods$1.min(n,t,s);return(methods$1.max(n,t,s)+l)/2}};Object.defineProperty(methods$1,"luminosity",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"luminance",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"min",{enumerable:!1,value:methods$1.minimum});Object.defineProperty(methods$1,"max",{enumerable:!1,value:methods$1.maximum});Object.defineProperty(methods$1,"brightness",{enumerable:!1,value:methods$1.maximum});const names$1={};Object.keys(methods$1).forEach(n=>{names$1[n]=n});function grey(n={}){let{algorithm:t="luma709",keepAlpha:s=!1,mergeAlpha:l=!0}=n;if(typeof t!="string"&&typeof t!="function")throw new TypeError("algorithm must be a string or a function");this.checkProcessable("grey",{bitDepth:[8,16],alpha:[0,1]}),this.components===1&&(t="red"),s&=this.alpha,l&=this.alpha,s&&(l=!1);let f=getOutputImage(this,n,{components:1,alpha:s,colorModel:GREY$1}),m;if(typeof t=="function")m=t;else if(m=methods$1[t.toLowerCase()],!m)throw new Error(`unsupported grey algorithm: ${t}`);let b=0;for(let h=0;h<this.data.length;h+=this.channels)l?f.data[b++]=clamp(m(this.data[h],this.data[h+1],this.data[h+2],this)*this.data[h+this.components]/this.maxValue,this):(f.data[b++]=clamp(m(this.data[h],this.data[h+1],this.data[h+2],this),this),f.alpha&&(f.data[b++]=this.data[h+this.components]));return f}function huang(n){let t=0;for(let C=0;C<n.length;C++)if(n[C]!==0){t=C;break}let s=n.length-1;for(let C=n.length-1;C>=t;C--)if(n[C]!==0){s=C;break}let l=1/(s-t),f=new Array(n.length),m=0,b=0;for(let C=t;C<n.length;C++)m+=C*n[C],b+=n[C],f[C]=m/b;let h=new Array(n.length);m=b=0;for(let C=s;C>0;C--)m+=C*n[C],b+=n[C],h[C-1]=m/b;let S=-1,M=Number.MAX_VALUE;for(let C=0;C<n.length;C++){let L=0,N;for(let F=0;F<=C;F++)N=1/(1+l*Math.abs(F-f[C])),N<1e-6||N>.999999||(L+=n[F]*(-N*Math.log(N)-(1-N)*Math.log(1-N)));for(let F=C+1;F<n.length;F++)N=1/(1+l*Math.abs(F-h[C])),N<1e-6||N>.999999||(L+=n[F]*(-N*Math.log(N)-(1-N)*Math.log(1-N)));L<M&&(M=L,S=C)}return S}function intermodes(n){let t=n.slice(),s=0;for(;!bimodalTest$1(t);){let f=0,m=0,b=t[0];for(let h=0;h<n.length-1;h++)f=m,m=b,b=t[h+1],t[h]=(f+m+b)/3;if(t[n.length-1]=(m+b)/3,s++,s>1e4)throw new Error("Intermodes Threshold not found after 10000 iterations")}let l=0;for(let f=1;f<n.length-1;f++)t[f-1]<t[f]&&t[f+1]<t[f]&&(l+=f);return Math.floor(l/2)}function bimodalTest$1(n){let t=!1,s=0;for(let l=1;l<n.length-1;l++)if(n[l-1]<n[l]&&n[l+1]<n[l]&&(s++,s>2))return!1;return s===2&&(t=!0),t}function isodata(n){let t,s,l,f,m=0;for(let b=1;b<n.length;b++)if(n[b]>0){m=b+1;break}for(;;){t=0,l=0;for(let b=0;b<m;b++)l=l+n[b],t=t+n[b]*b;f=0,s=0;for(let b=m+1;b<n.length;b++)s+=n[b],f+=n[b]*b;if(l>0&&s>0&&(t/=l,f/=s,m===Math.round((t+f)/2)))break;if(m++,m>n.length-2)throw new Error("Threshold not found")}return m}function li(n,t){let s,l,f,m,b,h,S,M,C,L,N,F;N=.5,L=0;for(let G=0;G<n.length;G++)L+=G*n[G];L/=t,S=L;do{h=S,s=h+.5|0,l=0,m=0;for(let G=0;G<=s;G++)l+=G*n[G],m+=n[G];M=m===0?0:l/m,f=0,b=0;for(let G=s+1;G<n.length;G++)f+=G*n[G],b+=n[G];C=b===0?0:f/b,F=(M-C)/(Math.log(M)-Math.log(C)),F<-Number.EPSILON?S=F-.5|0:S=F+.5|0}while(Math.abs(S-h)>N);return s}function maxEntropy(n,t){let s=new Array(n.length);for(let N=0;N<n.length;N++)s[N]=n[N]/t;let l=new Array(n.length),f=new Array(n.length);l[0]=s[0],f[0]=1-l[0];for(let N=1;N<n.length;N++)l[N]=l[N-1]+s[N],f[N]=1-l[N];let m=0;for(let N=0;N<n.length;N++)if(Math.abs(l[N])>=Number.EPSILON){m=N;break}let b=n.length-1;for(let N=n.length-1;N>=m;N--)if(Math.abs(f[N])>=Number.EPSILON){b=N;break}let h=-1,S,M=Number.MIN_VALUE,C,L;for(let N=m;N<=b;N++){C=0;for(let F=0;F<=N;F++)n[F]!==0&&(C-=s[F]/l[N]*Math.log(s[F]/l[N]));L=0;for(let F=N+1;F<n.length;F++)n[F]!==0&&(L-=s[F]/f[N]*Math.log(s[F]/f[N]));S=C+L,M<S&&(M=S,h=N)}return h}function mean$1(n,t){let s=0;for(let l=0;l<n.length;l++)s+=l*n[l];return Math.floor(s/t)}function minError(n,t){let s,l=-2,f,m,b,h,S,M,C,L,N,F,G,H=0;for(let K=0;K<n.length;K++)H+=K*n[K];for(H/=t,s=H;s!==l;){let K=sumA(n,s),X=sumA(n,n.length-1),de=sumB(n,s),Q=sumB(n,n.length-1),ie=sumC(n,s),ce=sumC(n,n.length-1);if(f=de/K,m=(Q-de)/(X-K),b=K/X,h=(X-K)/X,S=ie/K-f*f,M=(ce-ie)/(X-K)-m*m,C=1/S-1/M,L=f/S-m/M,N=f*f/S-m*m/M+Math.log10(S*(h*h)/(M*(b*b))),F=L*L-C*N,F<0)return s;l=s,G=(L+Math.sqrt(F))/C,isNaN(G)?s=l:s=Math.floor(G)}return s}function sumA(n,t){let s=0;for(let l=0;l<=t;l++)s+=n[l];return s}function sumB(n,t){let s=0;for(let l=0;l<=t;l++)s+=l*n[l];return s}function sumC(n,t){let s=0;for(let l=0;l<=t;l++)s+=l*l*n[l];return s}function minimum(n){if(n.length<2)return 0;let t=0,s=-1,l=-1,f=new Array(n.length);for(let m=0;m<n.length;m++)f[m]=n[m],n[m]>0&&(l=m);for(;!bimodalTest(f);)if(f=smoothed(f),t++,t>1e4)return s;return s=minimumBetweenPeeks(f,l),s}function smoothed(n){let t=new Array(n.length);for(let s=1;s<n.length-1;s++)t[s]=(n[s-1]+n[s]+n[s+1])/3;return t[0]=(n[0]+n[1])/3,t[n.length-1]=(n[n.length-2]+n[n.length-1])/3,t}function minimumBetweenPeeks(n,t){let s;for(let l=1;l<t;l++)if(n[l-1]>n[l]&&n[l+1]>=n[l]){s=l;break}return s}function bimodalTest(n){let t=n.length,s=!1,l=0;for(let f=1;f<t-1;f++)if(n[f-1]<n[f]&&n[f+1]<n[f]&&(l++,l>2))return!1;return l===2&&(s=!0),s}function moments(n,t){let s=1,l=0,f=0,m=0,b=0,h,S,M,C,L,N,F=-1,G=n.length,H=new Array(G);for(let K=0;K<G;K++)H[K]=n[K]/t;for(let K=0;K<G;K++)l+=K*H[K],f+=K*K*H[K],m+=K*K*K*H[K];S=s*f-l*l,M=(-f*f+l*m)/S,C=(s*-m+f*l)/S,L=.5*(-C-Math.sqrt(C*C-4*M)),N=.5*(-C+Math.sqrt(C*C-4*M)),h=(N-l)/(N-L);for(let K=0;K<G;K++)if(b+=H[K],b>h){F=K;break}return F}function otsu(n,t){let s=0,l=0,f=0,m=0,b=0;for(let h=0;h<n.length;h++)b+=h*n[h];for(let h=0;h<n.length;h++){l=l+n[h];const S=t-l;if(l===0||S===0)continue;s=s+h*n[h];const M=(b-s)/S,C=l*S*(s/l-M)*(s/l-M);C>=f&&(m=h,f=C)}return m}function percentile(n){let t=-1,s=.5,l=new Array(n.length),f=partialSum(n,n.length-1),m=1;for(let b=0;b<n.length;b++)l[b]=Math.abs(partialSum(n,b)/f-s),l[b]<m&&(m=l[b],t=b);return t}function partialSum(n,t){let s=0;for(let l=0;l<=t;l++)s+=n[l];return s}function renyiEntropy(n,t){let s,l,f,m=new Array(n.length),b=new Array(n.length),h=new Array(n.length),S=0,M=0,C=0,L=0,N=0,F=0,H=1/(1-.5),X=1/(1-2);for(let ce=0;ce<n.length;ce++)m[ce]=n[ce]/t;b[0]=m[0],h[0]=1-b[0];for(let ce=1;ce<n.length;ce++)b[ce]=b[ce-1]+m[ce],h[ce]=1-b[ce];l=0;for(let ce=0;ce<n.length;ce++)if(Math.abs(b[ce])>=Number.EPSILON){l=ce;break}f=n.length-1;for(let ce=n.length-1;ce>=l;ce--)if(Math.abs(h[ce])>=Number.EPSILON){f=ce;break}for(let ce=l;ce<=f;ce++){let ge=0,be=0,ne=0;for(let it=0;it<=ce;it++)n[it]!==0&&(ge-=m[it]/b[ce]*Math.log(m[it]/b[ce])),be+=Math.sqrt(m[it]/b[ce]),ne+=m[it]*m[it]/(b[ce]*b[ce]);let ve=0,te=0,he=0;for(let it=ce+1;it<n.length;it++)n[it]!==0&&(ve-=m[it]/h[ce]*Math.log(m[it]/h[ce])),te+=Math.sqrt(m[it]/h[ce]),he+=m[it]*m[it]/(h[ce]*h[ce]);let Ie=ge+ve,Oe=H*(be*te>0?Math.log(be*te):0),tt=X*(ne*he>0?Math.log(ne*he):0);Ie>L&&(L=Ie,S=ce),Oe>N&&(N=Oe,M=ce),tt>F&&(F=tt,C=ce)}let de=[S,M,C];de.sort((ce,ge)=>ce-ge);let Q;Math.abs(de[0]-de[1])<=5?Math.abs(de[1]-de[2])<=5?Q=[1,2,1]:Q=[0,1,3]:Math.abs(de[1]-de[2])<=5?Q=[3,1,0]:Q=[1,2,1];let ie=b[de[2]]-b[de[0]];return s=Math.round(de[0]*(b[de[0]]+.25*ie*Q[0])+.25*de[1]*ie*Q[1]+de[2]*(h[de[2]]+.25*ie*Q[2])),s}function shanbhag(n,t){let s=new Array(n.length);for(let F=0;F<n.length;F++)s[F]=n[F]/t;let l=new Array(n.length),f=new Array(n.length);l[0]=s[0],f[0]=1-l[0];for(let F=1;F<n.length;F++)l[F]=l[F-1]+s[F],f[F]=1-l[F];let m=0;for(let F=0;F<n.length;F++)if(Math.abs(l[F])>=Number.EPSILON){m=F;break}let b=n.length-1;for(let F=n.length-1;F>=m;F--)if(Math.abs(f[F])>=Number.EPSILON){b=F;break}let h=-1,S=Number.MAX_VALUE,M,C,L,N;for(let F=m;F<=b;F++){L=0,M=.5/l[F];for(let G=1;G<=F;G++)L-=s[G]*Math.log(1-M*l[G-1]);L*=M,N=0,M=.5/f[F];for(let G=F+1;G<n.length;G++)N-=s[G]*Math.log(1-M*f[G]);N*=M,C=Math.abs(L-N),C<S&&(S=C,h=F)}return h}function triangle$1(n){let t=0,s=0,l=0,f=0;for(let L=0;L<n.length;L++)if(n[L]>0){t=L;break}t>0&&t--;for(let L=n.length-1;L>0;L--)if(n[L]>0){f=L;break}f<n.length-1&&f++;for(let L=0;L<n.length;L++)n[L]>s&&(l=L,s=n[L]);let m=!1;if(l-t<f-l){m=!0;let L=0,N=n.length-1;for(;L<N;){let F=n[L];n[L]=n[N],n[N]=F,L++,N--}t=n.length-1-f,l=n.length-1-l}if(t===l)return t;let b,h,S;b=n[l],h=t-l,S=Math.sqrt(b*b+h*h),b/=S,h/=S,S=b*t+h*n[t];let M=t,C=0;for(let L=t+1;L<=l;L++){let N=b*L+h*n[L]-S;N>C&&(M=L,C=N)}if(M--,m){let L=0,N=n.length-1;for(;L<N;){let F=n[L];n[L]=n[N],n[N]=F,L++,N--}return n.length-1-M}else return M}function yen(n,t){let s=new Array(n.length);for(let M=0;M<n.length;M++)s[M]=n[M]/t;let l=new Array(n.length);l[0]=s[0];for(let M=1;M<n.length;M++)l[M]=l[M-1]+s[M];let f=new Array(n.length);f[0]=s[0]*s[0];for(let M=1;M<n.length;M++)f[M]=f[M-1]+s[M]*s[M];let m=new Array(n.length);m[n.length-1]=0;for(let M=n.length-2;M>=0;M--)m[M]=m[M+1]+s[M+1]*s[M+1];let b=-1,h=Number.MIN_VALUE,S;for(let M=0;M<n.length;M++)S=-1*(f[M]*m[M]>0?Math.log(f[M]*m[M]):0)+2*(l[M]*(1-l[M])>0?Math.log(l[M]*(1-l[M])):0),S>h&&(h=S,b=M);return b}const methods={huang,intermodes,isodata,li,maxentropy:maxEntropy,mean:mean$1,minerror:minError,minimum,moments,otsu,percentile,renyientropy:renyiEntropy,shanbhag,triangle:triangle$1,yen},names={};Object.keys(methods).forEach(n=>{names[n]=n});function getThreshold(n={}){let{algorithm:t=names.otsu}=n;this.checkProcessable("getThreshold",{components:1,bitDepth:[8,16]});let s=methods[t.toLowerCase()];if(s){let l=this.getHistogram();return s(l,this.size)}else throw new Error(`unknown thresholding algorithm: ${t}`)}const THRESHOLD="threshold";function mask(n={}){let{algorithm:t=THRESHOLD,threshold:s=.5,useAlpha:l=!0,invert:f=!1}=n;this.checkProcessable("mask",{components:1,bitDepth:[8,16]}),t===THRESHOLD?s=getThreshold$1(s,this.maxValue):s=getThreshold.call(this,n);let m=new Image$1(this.width,this.height,{kind:"BINARY",parent:this}),b=0;if(this.alpha&&l)for(let h=0;h<this.data.length;h+=this.channels){let S=this.data[h]+(this.maxValue-this.data[h])*(this.maxValue-this.data[h+1])/this.maxValue;(f&&S<=s||!f&&S>=s)&&m.setBit(b),b++}else for(let h=0;h<this.data.length;h+=this.channels)(f&&this.data[h]<=s||!f&&this.data[h]>=s)&&m.setBit(b),b++;return m}function copyImage(n,t,s,l){let f=n.width,m=n.height,b=t.width,h=n.channels;for(let S=0;S<f;S++)for(let M=0;M<m;M++)for(let C=0;C<h;C++){let L=(M*f+S)*h+C,N=((l+M)*b+s+S)*h+C;t.data[N]=n.data[L]}}function pad(n={}){let{size:t=0,algorithm:s="copy",color:l}=n;if(this.checkProcessable("pad",{bitDepth:[8,16]}),s==="set"){if(l.length!==this.channels)throw new Error(`pad: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let S=0;S<l.length;S++)l[S]===0&&(l[S]=.001)}else l=newArray_1(this.channels,null);Array.isArray(t)||(t=[t,t]);let f=this.width+t[0]*2,m=this.height+t[1]*2,b=this.channels,h=Image$1.createFrom(this,{width:f,height:m});copyImage(this,h,t[0],t[1]);for(let S=t[0];S<f-t[0];S++)for(let M=0;M<b;M++){let C=l[M]||h.data[(t[1]*f+S)*b+M];for(let L=0;L<t[1];L++)h.data[(L*f+S)*b+M]=C;C=l[M]||h.data[((m-t[1]-1)*f+S)*b+M];for(let L=m-t[1];L<m;L++)h.data[(L*f+S)*b+M]=C}for(let S=0;S<m;S++)for(let M=0;M<b;M++){let C=l[M]||h.data[(S*f+t[0])*b+M];for(let L=0;L<t[0];L++)h.data[(S*f+L)*b+M]=C;C=l[M]||h.data[(S*f+f-t[0]-1)*b+M];for(let L=f-t[0];L<f;L++)h.data[(S*f+L)*b+M]=C}return h}function colorDepth(n=8){if(this.checkProcessable("colorDepth",{bitDepth:[1,8,16]}),![8,16].includes(n))throw Error("You need to specify the new colorDepth as 8 or 16");if(this.bitDepth===n)return this.clone();let t=Image$1.createFrom(this,{bitDepth:n});switch(n){case 8:if(this.bitDepth===1)for(let s=0;s<this.size;s++)this.getBit(s)&&(t.data[s]=255);else for(let s=0;s<this.data.length;s++)t.data[s]=this.data[s]>>8;break;case 16:if(this.bitDepth===1)for(let s=0;s<this.size;s++)this.getBit(s)&&(t.data[s]=65535);else for(let s=0;s<this.data.length;s++)t.data[s]=this.data[s]<<8|this.data[s];break;default:throw new Error("colorDepth conversion unexpected case")}return t}function rotateFree(n,t={}){const{interpolation:s=validInterpolations.nearestneighbor,width:l=this.width,height:f=this.height}=t;if(typeof n!="number")throw new TypeError("degrees must be a number");const m=checkInterpolation(s),b=n*Math.PI/180,h=Math.floor(Math.abs(l*Math.cos(b))+Math.abs(f*Math.sin(b))),S=Math.floor(Math.abs(f*Math.cos(b))+Math.abs(l*Math.sin(b))),M=Image$1.createFrom(this,{width:h,height:S}),C=Math.cos(-b),L=Math.sin(-b);let N=h/2,F=S/2;h%2===0?(N=N-.5,S%2===0?F=F-.5:F=Math.floor(F)):(N=Math.floor(N),S%2===0?F=F-.5:F=Math.floor(F));const G=Math.floor(l/2-N),H=Math.floor(f/2-F);switch(m){case validInterpolations.nearestneighbor:return rotateNearestNeighbor(this,M,G,H,N,F,C,L);case validInterpolations.bilinear:return rotateBilinear(this,M,G,H,N,F,C,L);default:throw new Error(`unsupported rotate interpolation: ${m}`)}}function rotateNearestNeighbor(n,t,s,l,f,m,b,h){for(let S=0;S<t.width;S+=1)for(let M=0;M<t.height;M+=1)for(let C=0;C<n.channels;C++){let L=Math.round((S-f)*b-(M-m)*h+f)+s,N=Math.round((M-m)*b+(S-f)*h+m)+l;L<0||L>=n.width||N<0||N>=n.height?n.alpha===1&&C===n.channels-1?t.setValueXY(S,M,C,0):t.setValueXY(S,M,C,n.maxValue):t.setValueXY(S,M,C,n.getValueXY(L,N,C))}return t}function rotateBilinear(n,t,s,l,f,m,b,h){let S=n.width*n.channels;for(let M=0;M<t.height;M++)for(let C=0;C<t.width;C++){let L=(C-f)*b-(M-m)*h+f+s,N=(M-m)*b+(C-f)*h+m+l,F=L|0,G=N|0,H=L-F,K=N-G;for(let X=0;X<n.channels;X++)if(L<0||L>=n.width||N<0||N>=n.height)n.alpha===1&&X===n.channels-1?t.setValueXY(C,M,X,0):t.setValueXY(C,M,X,n.maxValue);else{let de=(G*n.width+F)*n.channels+X,Q=n.data[de],ie=n.data[de+n.channels],ce=n.data[de+S],ge=n.data[de+S+n.channels],be=Q+H*(ie-Q)+K*(ce-Q)+H*K*(Q-ie-ce+ge)|0;t.setValueXY(C,M,X,be)}}return t}function rotate$1(n,t){if(typeof n!="number")throw new TypeError("angle must be a number");switch(n<0&&(n=Math.ceil(-n/360)*360+n),n%360){case 0:return this.clone();case 90:return rotateRight.call(this);case 180:return rotate180.call(this);case 270:return rotateLeft.call(this);default:return rotateFree.call(this,n,t)}}function rotateLeft(){const n=Image$1.createFrom(this,{width:this.height,height:this.width}),t=n.height-1;for(let s=0;s<this.height;s++)for(let l=0;l<this.width;l++)for(let f=0;f<this.channels;f++)n.setValueXY(s,t-l,f,this.getValueXY(l,s,f));return n}function rotateRight(){const n=Image$1.createFrom(this,{width:this.height,height:this.width}),t=n.width-1;for(let s=0;s<this.height;s++)for(let l=0;l<this.width;l++)for(let f=0;f<this.channels;f++)n.setValueXY(t-s,l,f,this.getValueXY(l,s,f));return n}function rotate180(){const n=Image$1.createFrom(this),t=n.width-1,s=n.height-1;for(let l=0;l<this.height;l++)for(let f=0;f<this.width;f++)for(let m=0;m<this.channels;m++)n.setValueXY(t-f,s-l,m,this.getValueXY(f,l,m));return n}function insert(n,t={}){const s=getImageParameters(n);this.checkProcessable("insert",s);let{x:l=0,y:f=0}=t;const m=getOutputImageOrInPlace(this,t,{copy:!0}),b=Math.min(m.height,f+n.height),h=Math.min(m.width,l+n.width);if(m.bitDepth===1)for(let S=f;S<b;S++)for(let M=l;M<h;M++)n.getBitXY(M-l,S-f)?m.setBitXY(M,S):m.clearBitXY(M,S);else for(let S=f;S<b;S++)for(let M=l;M<h;M++)m.setPixelXY(M,S,n.getPixelXY(M-l,S-f));return m}function setBorder(n={}){let{size:t=0,algorithm:s="copy",color:l}=n;if(this.checkProcessable("setBorder",{bitDepth:[8,16,32,64]}),s==="set"){if(l.length!==this.channels)throw new Error(`setBorder: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let h=0;h<l.length;h++)l[h]===0&&(l[h]=.001)}else l=newArray_1(this.channels,null);Array.isArray(t)||(t=[t,t]);let f=t[0],m=t[1],b=this.channels;for(let h=f;h<this.width-f;h++)for(let S=0;S<b;S++){let M=l[S]||this.data[(h+this.width*m)*b+S];for(let C=0;C<m;C++)this.data[(C*this.width+h)*b+S]=M;M=l[S]||this.data[(h+this.width*(this.height-m-1))*b+S];for(let C=this.height-m;C<this.height;C++)this.data[(C*this.width+h)*b+S]=M}for(let h=0;h<this.height;h++)for(let S=0;S<b;S++){let M=l[S]||this.data[(h*this.width+f)*b+S];for(let C=0;C<f;C++)this.data[(h*this.width+C)*b+S]=M;M=l[S]||this.data[(h*this.width+this.width-f-1)*b+S];for(let C=this.width-f;C<this.width;C++)this.data[(h*this.width+C)*b+S]=M}return this}function split(n={}){let{preserveAlpha:t=!0}=n;if(this.checkProcessable("split",{bitDepth:[8,16]}),this.components===1)return new Stack([this.clone()]);let s=new Stack,l=this.data;if(this.alpha&&t)for(let f=0;f<this.components;f++){let m=Image$1.createFrom(this,{components:1,alpha:!0,colorModel:GREY$1}),b=0;for(let h=0;h<l.length;h+=this.channels)m.data[b++]=l[h+f],m.data[b++]=l[h+this.components];s.push(m)}else for(let f=0;f<this.channels;f++){let m=Image$1.createFrom(this,{components:1,alpha:!1,colorModel:GREY$1}),b=0;for(let h=0;h<l.length;h+=this.channels)m.data[b++]=l[h+f];s.push(m)}return s}function getChannel(n,t={}){let{keepAlpha:s=!1,mergeAlpha:l=!1}=t;s&=this.alpha,l&=this.alpha,this.checkProcessable("getChannel",{bitDepth:[8,16]}),n=validateChannel(this,n);let f=Image$1.createFrom(this,{components:1,alpha:s,colorModel:GREY$1}),m=0;for(let b=0;b<this.data.length;b+=this.channels)l?f.data[m++]=this.data[b+n]*this.data[b+this.components]/this.maxValue:(f.data[m++]=this.data[b+n],s&&(f.data[m++]=this.data[b+this.components]));return f}function combineChannels(n=defaultCombineMethod,t={}){let{mergeAlpha:s=!1,keepAlpha:l=!1}=t;s&=this.alpha,l&=this.alpha,this.checkProcessable("combineChannels",{bitDepth:[8,16]});let f=Image$1.createFrom(this,{components:1,alpha:l,colorModel:GREY$1}),m=0;for(let b=0;b<this.size;b++){let h=n(this.getPixel(b));s?f.data[m++]=h*this.data[b*this.channels+this.components]/this.maxValue:(f.data[m++]=h,l&&(f.data[m++]=this.data[b*this.channels+this.components]))}return f}function defaultCombineMethod(n){return(n[0]+n[1]+n[2])/3}function setChannel(n,t){if(this.checkProcessable("setChannel",{bitDepth:[8,16]}),t.checkProcessable("setChannel (image parameter check)",{bitDepth:[this.bitDepth],alpha:[0],components:[1]}),t.width!==this.width||t.height!==this.height)throw new Error("Images must have exactly the same width and height");n=validateChannel(this,n);let s=n;for(let l=0;l<t.data.length;l++)this.data[s]=t.data[l],s+=this.channels;return this}function getSimilarity(n,t={}){let{shift:s=[0,0],average:l,channels:f,defaultAlpha:m,normalize:b,border:h=[0,0]}=t;if(this.checkProcessable("getSimilarity",{bitDepth:[8,16]}),Array.isArray(h)||(h=[h,h]),f=validateArrayOfChannels(this,{channels:f,defaultAlpha:m}),this.bitDepth!==n.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==n.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==n.colorModel)throw new Error("Both images must have the same colorModel");typeof l=="undefined"&&(l=!0);let S=Math.max(h[0],-s[0]),M=Math.min(this.width-h[0],this.width-s[0]),C=Math.max(h[1],-s[1]),L=Math.min(this.height-h[1],this.height-s[1]),N=newArray_1(f.length,0);for(let F=0;F<f.length;F++){let G=f[F],H=b?this.sum[G]:Math.max(this.sum[G],n.sum[G]),K=b?n.sum[G]:Math.max(this.sum[G],n.sum[G]);if(H!==0&&K!==0)for(let X=S;X<M;X++)for(let de=C;de<L;de++){let Q=X*this.multiplierX+de*this.multiplierY+G,ie=Q+s[0]*this.multiplierX+s[1]*this.multiplierY;N[F]+=Math.min(this.data[Q]/H,n.data[ie]/K)}}return l?N.reduce((F,G)=>F+G)/N.length:N}function getPixelsGrid(n={}){let{sampling:t=[10,10],painted:s=!1,mask:l}=n;this.checkProcessable("getPixelsGrid",{bitDepth:[8,16],channels:1}),Array.isArray(t)||(t=[t,t]);const f=t[0],m=t[1],b=[],h=[],S=this.width/f,M=this.height/m;let C=Math.floor(S/2);for(let N=0;N<f;N++){let F=Math.floor(M/2);for(let G=0;G<m;G++){let H=Math.round(C),K=Math.round(F);(!l||l.getBitXY(H,K))&&(b.push([H,K]),h.push(this.getPixelXY(H,K))),F+=M}C+=S}const L={xyS:b,zS:h};return s&&(L.painted=this.rgba8().paintPoints(b)),L}function Matrix(n,t,s){const l=new Array(n);for(let f=0;f<n;f++)l[f]=new Array(t);if(s)for(let f=0;f<n;f++)for(let m=0;m<t;m++)l[f][m]=s;return l.width=n,l.height=t,Object.setPrototypeOf(l,Matrix.prototype),l}Matrix.prototype.localMin=function(n,t){let s=this[n][t],l=[n,t];for(let f=Math.max(0,n-1);f<Math.min(this.length,n+2);f++)for(let m=Math.max(0,t-1);m<Math.min(this[0].length,t+2);m++)this[f][m]<s&&(s=this[f][m],l=[f,m]);return{position:l,value:s}};Matrix.prototype.localMax=function(n,t){let s=this[n][t],l=[n,t];for(let f=Math.max(0,n-1);f<Math.min(this.length,n+2);f++)for(let m=Math.max(0,t-1);m<Math.min(this[0].length,t+2);m++)this[f][m]>s&&(s=this[f][m],l=[f,m]);return{position:l,value:s}};Matrix.prototype.localSearch=function(n,t,s){let l=[];for(let f=Math.max(0,n-1);f<Math.min(this.length,n+2);f++)for(let m=Math.max(0,t-1);m<Math.min(this[0].length,t+2);m++)this[f][m]===s&&l.push([f,m]);return l};function getBestMatch(n,t={}){let{border:s}=t;if(this.checkProcessable("getChannel",{bitDepth:[8,16]}),this.bitDepth!==n.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==n.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==n.colorModel)throw new Error("Both images must have the same colorModel");let l=new Matrix(n.width,n.height,-1/0),f=Math.floor(n.width/2),m=Math.floor(n.height/2),b=f,h=m,S=!1;for(;!S;){let M=l.localSearch(f,m,-1/0);for(let L=0;L<M.length;L++){let N=M[L],F=this.getSimilarity(n,{border:s,shift:[b-N[0],h-N[1]]});l[N[0]][N[1]]=F}let C=l.localMax(f,m);C.position[0]!==f||C.position[1]!==m?(f=C.position[0],m=C.position[1]):S=!0}return[f-b,m-h]}function getRow(n,t=0){this.checkProcessable("getRow",{bitDepth:[8,16]}),checkRow(this,n),checkChannel(this,t);let s=new Array(this.width),l=0,f=n*this.width*this.channels+t,m=f+this.width*this.channels;for(let b=f;b<m;b+=this.channels)s[l++]=this.data[b];return s}function getColumn(n,t=0){this.checkProcessable("getColumn",{bitDepth:[8,16]}),checkColumn(this,n),checkChannel(this,t);let s=new Array(this.height),l=0,f=this.width*this.channels;for(let m=t+n*this.channels;m<this.data.length;m+=f)s[l++]=this.data[m];return s}function getMatrix(n={}){let{channel:t}=n;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),t===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");t=0}let s=new Matrix$2(this.height,this.width);for(let l=0;l<this.height;l++)for(let f=0;f<this.width;f++)s.set(l,f,this.getValueXY(f,l,t));return s}function setMatrix(n,t={}){n=new Matrix$2(n);let{channel:s}=t;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),s===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");s=0}if(this.width!==n.columns||this.height!==n.rows)throw new RangeError("The size of the matrix must be equal to the size of the image");for(let l=0;l<this.height;l++)for(let f=0;f<this.width;f++)this.setValueXY(f,l,s,n.get(l,f))}function getPixelsArray(){this.checkProcessable("getPixelsArray",{bitDepth:[8,16,32]});let n=new Array(this.size),t=0;for(let s=0;s<this.data.length;s+=this.channels){let l=new Array(this.components);for(let f=0;f<this.components;f++)l[f]=this.data[s+f];n[t++]=l}return n}function getIntersection(n){let t=this,s=t.getClosestCommonParent(n),l=t.getRelativePosition(s,{defaultFurther:!0}),f=getRelativePositionForAllPixels(t,l),m=n.getRelativePosition(s,{defaultFurther:!0}),b=getRelativePositionForAllPixels(n,m),h=getCommonSurface(f,b),S={whitePixelsMask1:[],whitePixelsMask2:[],commonWhitePixels:[]};for(let M=0;M<h.length;M++){let C=h[M],L=[C[0]-l[0],C[1]-l[1]],N=[C[0]-m[0],C[1]-m[1]],F=t.getBitXY(L[0],L[1]),G=n.getBitXY(N[0],N[1]);F===1&&G===1&&S.commonWhitePixels.push(C)}for(let M=0;M<f.length;M++){let C,L;M!==0&&(C=Math.floor(M/t.width),L=M%t.width),t.getBitXY(C,L)===1&&S.whitePixelsMask1.push(f[M])}for(let M=0;M<b.length;M++){let C=0,L=0;M!==0&&(C=Math.floor(M/n.width),L=M%n.width),n.getBitXY(C,L)===1&&S.whitePixelsMask2.push(b[M])}return S}function getRelativePositionForAllPixels(n,t){let s=[];for(let l=0;l<n.height;l++)for(let f=0;f<n.width;f++){let m=[l,f];s.push([m[0]+t[0],m[1]+t[1]])}return s}function getCommonSurface(n,t){let s=0,l=0,f=[];for(;s<n.length&&l<t.length;)n[s][0]===t[l][0]&&n[s][1]===t[l][1]?(f.push(n[s]),s++,l++):n[s][0]<t[l][0]||n[s][0]===t[l][0]&&n[s][1]<t[l][1]?s++:l++;return f}function getClosestCommonParent(n){let t=getDepth(this),s=getDepth(n),l;if(t>=s?l=getFurthestParent(this,t):l=getFurthestParent(n,s),t===0||s===0)return l;let f=this,m=n;for(;t!==s;)if(t>s){if(f=f.parent,f===null)return l;t=t-1}else{if(m=m.parent,m===null)return l;s=s-1}for(;f!==m&&f!==null&&m!==null;)if(f=f.parent,m=m.parent,f===null||m===null)return l;return f!==m?l:f}function getDepth(n){let t=0,s=n;for(;s.parent!=null;)s=s.parent,t++;return t}function getFurthestParent(n,t){let s=n;for(;t>0;)s=s.parent,t=t-1;return s}const defaultOptions$1={lowThreshold:10,highThreshold:30,gaussianBlur:1.1},Gx=[[-1,0,1],[-2,0,2],[-1,0,1]],Gy=[[-1,-2,-1],[0,0,0],[1,2,1]],convOptions={bitDepth:32,mode:"periodic"};function cannyEdgeDetector(n,t){n.checkProcessable("Canny edge detector",{bitDepth:8,channels:1,components:1}),t=Object.assign({},defaultOptions$1,t);const s=n.width,l=n.height,f=n.maxValue,m={sigma:t.gaussianBlur,radius:3},b=n.gaussianFilter(m),h=b.convolution(Gy,convOptions),S=b.convolution(Gx,convOptions),M=S.hypotenuse(h),C=n.constructor,L=new C(s,l,{kind:"GREY",bitDepth:32}),N=new C(s,l,{kind:"GREY",bitDepth:32}),F=new C(s,l,{kind:"GREY"});for(var G=1;G<s-1;G++)for(var H=1;H<l-1;H++){var K=(Math.round(Math.atan2(S.getValueXY(G,H,0),h.getValueXY(G,H,0))*(5/Math.PI))+5)%5;K===0&&(M.getValueXY(G,H,0)<=M.getValueXY(G,H-1,0)||M.getValueXY(G,H,0)<=M.getValueXY(G,H+1,0))||K===1&&(M.getValueXY(G,H,0)<=M.getValueXY(G-1,H+1,0)||M.getValueXY(G,H,0)<=M.getValueXY(G+1,H-1,0))||K===2&&(M.getValueXY(G,H,0)<=M.getValueXY(G-1,H,0)||M.getValueXY(G,H,0)<=M.getValueXY(G+1,H,0))||K===3&&(M.getValueXY(G,H,0)<=M.getValueXY(G-1,H-1,0)||M.getValueXY(G,H,0)<=M.getValueXY(G+1,H+1,0))||L.setValueXY(G,H,0,M.getValueXY(G,H,0))}for(G=0;G<s*l;++G){var X=L.data[G],de=0;X>t.highThreshold&&(de++,F.data[G]=f),X>t.lowThreshold&&de++,N.data[G]=de}var Q=[];for(G=1;G<s-1;++G)for(H=1;H<l-1;++H){if(N.getValueXY(G,H,0)!==1)continue;e:for(var ie=G-1;ie<G+2;++ie)for(var ce=H-1;ce<H+2;++ce)if(N.getValueXY(ie,ce,0)===2){Q.push([G,H]),F.setValueXY(G,H,0,f);break e}}for(;Q.length>0;){var ge=[];for(G=0;G<Q.length;++G)for(H=-1;H<2;++H)for(ie=-1;ie<2;++ie)if(!(H===0&&ie===0)){var be=Q[G][0]+H,ne=Q[G][1]+ie;N.getValueXY(be,ne,0)===1&&F.getValueXY(be,ne,0)===0&&(ge.push([be,ne]),F.setValueXY(be,ne,0,f))}Q=ge}return F}function cannyEdge(n){return cannyEdgeDetector(this,n)}function extract(n,t={}){let{position:s}=t;if(this.checkProcessable("extract",{bitDepth:[1,8,16]}),!s&&(s=n.getRelativePosition(this),!s))throw new Error("extract : can not extract an image because the relative position can not be determined, try to specify manually the position as an array of 2 elements [x,y].");if(this.bitDepth>1){let l=Image$1.createFrom(this,{width:n.width,height:n.height,alpha:1,position:s,parent:this});for(let f=0;f<n.width;f++)for(let m=0;m<n.height;m++){for(let b=0;b<this.channels;b++){let h=this.getValueXY(f+s[0],m+s[1],b);l.setValueXY(f,m,b,h)}n.getBitXY(f,m)||l.setValueXY(f,m,this.components,0)}return l}else{let l=Image$1.createFrom(this,{width:n.width,height:n.height,position:s,parent:this});for(let f=0;f<n.height;f++)for(let m=0;m<n.width;m++)n.getBitXY(m,f)&&this.getBitXY(m+s[0],f+s[1])&&l.setBitXY(m,f);return l}}var fastList={exports:{}};(function(n,t){(function(){function s(f,m,b){this.next=b,b&&(b.prev=this),this.prev=m,m&&(m.next=this),this.data=f}function l(){if(!(this instanceof l))return new l;this._head=null,this._tail=null,this.length=0}l.prototype={push:function(f){this._tail=new s(f,this._tail,null),this._head||(this._head=this._tail),this.length++},pop:function(){if(this.length!==0){var f=this._tail;return this._tail=f.prev,f.prev&&(f.prev=this._tail.next=null),this.length--,this.length===1?this._head=this._tail:this.length===0&&(this._head=this._tail=null),f.data}},unshift:function(f){this._head=new s(f,null,this._head),this._tail||(this._tail=this._head),this.length++},shift:function(){if(this.length!==0){var f=this._head;return this._head=f.next,f.next&&(f.next=this._head.prev=null),this.length--,this.length===1?this._tail=this._head:this.length===0&&(this._head=this._tail=null),f.data}},item:function(f){f<0&&(f=this.length+f);for(var m=this._head;f-- >0&&m;)m=m.next;return m?m.data:void 0},slice:function(f,m){if(f||(f=0),m||(m=this.length),m<0&&(m=this.length+m),f<0&&(f=this.length+f),m===f)return[];if(m<f)throw new Error("invalid offset: "+f+","+m+" (length="+this.length+")");for(var b=m-f,h=new Array(b),S=0,M=this._head;f-- >0&&M;)M=M.next;for(;S<b&&M;)h[S++]=M.data,M=M.next;return h},drop:function(){l.call(this)},forEach:function(f,m){for(var b=this._head,h=0,S=this.length;h<S&&b;)f.call(m||this,b.data,h,this),b=b.next,h++},map:function(f,m){var b=new l;return this.forEach(function(h,S,M){b.push(f.call(m||M,h,S,M))}),b},filter:function(f,m){var b=new l;return this.forEach(function(h,S,M){f.call(m||M,h,S,M)&&b.push(h)}),b},reduce:function(f,m,b){var h=0,S=this._head,M=this.length;for(m||(h=1,m=S&&S.data,S=S&&S.next);h<M&&S;)m=f.call(b||this,m,S.data,this),h++,S=S.next;return m}},n.exports=l})()})(fastList);var LinkedList=fastList.exports;function floodFill(n={}){const{x:t=0,y:s=0,inPlace:l=!0}=n,f=l?this:Image$1.createFrom(this);if(this.checkProcessable("floodFill",{bitDepth:1}),this.getBitXY(t,s))return f;const b=new LinkedList;for(b.push(new Node(t,s));b.length>0;){const h=b.shift();f.setBitXY(h.x,h.y);for(let S=h.x+1;S<this.width&&(!f.getBitXY(S,h.y)&&!this.getBitXY(S,h.y));S++)f.setBitXY(S,h.y),h.y+1<this.height&&!this.getBitXY(S,h.y+1)&&b.push(new Node(S,h.y+1)),h.y-1>=0&&!this.getBitXY(S,h.y-1)&&b.push(new Node(S,h.y-1));for(let S=h.x-1;S>=0&&(!f.getBitXY(S,h.y)&&!this.getBitXY(S,h.y));S++)f.setBitXY(S,h.y),h.y+1<this.height&&!this.getBitXY(S,h.y+1)&&b.push(new Node(S,h.y+1)),h.y-1>=0&&!this.getBitXY(S,h.y-1)&&b.push(new Node(S,h.y-1))}return f}function Node(n,t){this.x=n,this.y=t}function _extends(){return _extends=Object.assign||function(n){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var l in s)Object.prototype.hasOwnProperty.call(s,l)&&(n[l]=s[l])}return n},_extends.apply(this,arguments)}function hsv2rgb(n,t,s){t=t/100,s=s/100;var l=[],f=s*t,m=n/60,b=f*(1-Math.abs(m%2-1)),h=s-f;return m>=0&&m<1?l=[f,b,0]:m>=1&&m<2?l=[b,f,0]:m>=2&&m<3?l=[0,f,b]:n>=3&&m<4?l=[0,b,f]:n>=4&&m<5?l=[b,0,f]:n>=5&&m<=6?l=[f,0,b]:l=[0,0,0],{r:Math.round(255*(l[0]+h)),g:Math.round(255*(l[1]+h)),b:Math.round(255*(l[2]+h))}}function hsl2hsv(n,t,s){return t*=(s<50?s:100-s)/100,{h:n,s:2*t/(s+t)*100,v:s+t}}function hsl2rgb$1(n,t,s){var l=hsl2hsv(n,t,s);return hsv2rgb(l.h,l.s,l.v)}var colors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]};function parse(n){return named(n)||hex3(n)||hex6(n)||rgb(n)||rgba$1(n)||hsl(n)||hsla(n)}function named(n){var t=colors[n.toLowerCase()];if(!!t)return{r:t[0],g:t[1],b:t[2],a:100}}function rgb(n){var t=n.match(/rgb\(([^)]+)\)/);if(t){var s=t[1].split(/ *, */).map(Number);return{r:s[0],g:s[1],b:s[2],a:100}}}function rgba$1(n){var t=n.match(/rgba\(([^)]+)\)/);if(t){var s=t[1].split(/ *, */).map(Number);return{r:s[0],g:s[1],b:s[2],a:s[3]*100}}}function hex6(n){if(n[0]==="#"&&n.length===7)return{r:parseInt(n.slice(1,3),16),g:parseInt(n.slice(3,5),16),b:parseInt(n.slice(5,7),16),a:100}}function hex3(n){if(n[0]==="#"&&n.length===4)return{r:parseInt(n[1]+n[1],16),g:parseInt(n[2]+n[2],16),b:parseInt(n[3]+n[3],16),a:100}}function hsl(n){var t=n.match(/hsl\(([^)]+)\)/);if(t){var s=t[1].split(/ *, */),l=parseInt(s[0],10),f=parseInt(s[1],10),m=parseInt(s[2],10),b=hsl2rgb$1(l,f,m);return _extends({},b,{a:100})}}function hsla(n){var t=n.match(/hsla\(([^)]+)\)/);if(t){var s=t[1].split(/ *, */),l=parseInt(s[0],10),f=parseInt(s[1],10),m=parseInt(s[2],10),b=parseInt(parseFloat(s[3])*100,10),h=hsl2rgb$1(l,f,m);return _extends({},h,{a:b})}}function css2array(n){let t=parse(n);return[t.r,t.g,t.b,Math.round(t.a*255/100)]}function hue2rgb(n,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?n+(t-n)*6*s:s<1/2?t:s<2/3?n+(t-n)*(2/3-s)*6:n}function hsl2rgb(n,t,s){let l,f,m,b,h,S;return t/=100,s/=100,t===0?b=h=S=s*255:(s<=.5?f=s*(t+1):f=s+t-s*t,l=s*2-f,m=n/360,b=hue2rgb(l,f,m+1/3),h=hue2rgb(l,f,m),S=hue2rgb(l,f,m-1/3)),{r:b,g:h,b:S}}function getDistinctColors(n){let t=new Array(n),s=0;for(let l=0;l<360;l+=360/n){s++;let f=hsl2rgb(l,100,30+s%4*15);t[s-1]=[Math.round(f.r*255),Math.round(f.g*255),Math.round(f.b*255)]}return t}function getRandomColor(){return[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)]}function getColors(n){let{color:t,colors:s,randomColors:l,numberColors:f=50}=n;if(t&&!Array.isArray(t)&&(t=css2array(t)),t)return[t];if(s)return s=s.map(function(m){return Array.isArray(m)?m:css2array(m)}),s;if(l){s=new Array(f);for(let m=0;m<f;m++)s[m]=getRandomColor()}return getDistinctColors(f)}function paintLabels(n,t,s={}){let{color:l="blue",colors:f,font:m="12px Helvetica",rotate:b=0}=s;if(this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1}),!Array.isArray(n))throw Error("paintLabels: labels must be an array");if(!Array.isArray(t))throw Error("paintLabels: positions must be an array");if(l&&!Array.isArray(l)&&(l=css2array(l)),f?f=f.map(function(M){return Array.isArray(M)?M:css2array(M)}):f=[l],n.length!==t.length)throw Error("paintLabels: positions and labels must be arrays from the same size");Array.isArray(m)||(m=[m]),Array.isArray(b)||(b=[b]);let S=this.getCanvas().getContext("2d");for(let M=0;M<n.length;M++){S.save();let C=f[M%f.length];S.fillStyle=`rgba(${C[0]},${C[1]},${C[2]},${C[3]/this.maxValue})`,S.font=m[M%m.length];let L=t[M];S.translate(L[0],L[1]),S.rotate(b[M%b.length]/180*Math.PI),S.fillText(n[M],0,0),S.restore()}return this.data=Uint8Array.from(S.getImageData(0,0,this.width,this.height).data),this}function paintMasks(n,t={}){let{alpha:s=255,labels:l=[],labelsPosition:f=[],labelColor:m="blue",labelFont:b="12px Helvetica"}=t;this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1});let h=getColors(Object.assign({},t,{numberColors:n.length}));Array.isArray(n)||(n=[n]);for(let S=0;S<n.length;S++){let M=n[S],C=h[S%h.length];for(let L=0;L<M.width;L++)for(let N=0;N<M.height;N++)if(M.getBitXY(L,N))for(let F=0;F<Math.min(this.components,C.length);F++)if(s===255)this.setValueXY(L+M.position[0],N+M.position[1],F,C[F]);else{let G=this.getValueXY(L+M.position[0],N+M.position[1],F);G=Math.round((G*(255-s)+C[F]*s)/255),this.setValueXY(L+M.position[0],N+M.position[1],F,G)}}if(Array.isArray(l)&&l.length>0){let M=this.getCanvas().getContext("2d");M.fillStyle=m,M.font=b;for(let C=0;C<Math.min(n.length,l.length);C++){let L=f[C]?f[C]:n[C].position;M.fillText(l[C],L[0],L[1])}this.data=Uint8Array.from(M.getImageData(0,0,this.width,this.height).data)}return this}function zerosMatrix(n,t){let s=new Array(n);for(let l=0;l<n;l++)s[l]=new Array(t).fill(0);return s}const cross=[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],smallCross=[[0,1,0],[1,1,1],[0,1,0]];class Shape{constructor(t={}){let{kind:s="cross",shape:l,size:f,width:m,height:b,filled:h=!0}=t;if(f&&(m=f,b=f),l)switch(l.toLowerCase()){case"square":case"rectangle":this.matrix=rectangle(m,b,{filled:h});break;case"circle":case"ellipse":this.matrix=ellipse(m,b,{filled:h});break;case"triangle":this.matrix=triangle(m,b,{filled:h});break;default:throw new Error(`Shape: unexpected shape: ${l}`)}else if(s)switch(s.toLowerCase()){case"cross":this.matrix=cross;break;case"smallcross":this.matrix=smallCross;break;default:throw new Error(`Shape: unexpected kind: ${s}`)}else throw new Error("Shape: expected a kind or a shape option");this.height=this.matrix.length,this.width=this.matrix[0].length,this.halfHeight=this.height/2>>0,this.halfWidth=this.width/2>>0}getPoints(){let t=this.matrix,s=[];for(let l=0;l<t.length;l++)for(let f=0;f<t[0].length;f++)t[l][f]&&s.push([f-this.halfWidth,l-this.halfHeight]);return s}getMask(){let t=new Image$1(this.width,this.height,{kind:BINARY});for(let s=0;s<this.matrix.length;s++)for(let l=0;l<this.matrix[0].length;l++)this.matrix[s][l]&&t.setBitXY(l,s);return t}}function rectangle(n,t,s){const l=zerosMatrix(t,n);if(s.filled)for(let f=0;f<t;f++)for(let m=0;m<n;m++)l[f][m]=1;else{for(let f of[0,t-1])for(let m=0;m<n;m++)l[f][m]=1;for(let f=0;f<t;f++)for(let m of[0,n-1])l[f][m]=1}return l}function ellipse(n,t,s){const l=zerosMatrix(t,n);let f=1-t%2,m=1-n%2,b=Math.floor((n-1)/2),h=Math.floor((t-1)/2),S=b*b,M=h*h;if(s.filled)for(let C=0;C<=h;C++){let L=Math.floor(Math.sqrt(S-S*C*C/M));for(let N=b-L;N<=b;N++)l[h-C][N]=1,l[h+C+f][N]=1,l[h-C][n-N-1]=1,l[h+C+f][n-N-1]=1}else{for(let C=0;C<=h;C++){let L=Math.floor(Math.sqrt(S-S*C*C/M)),N=b-L;l[h-C][N]=1,l[h+C+f][N]=1,l[h-C][n-N-1]=1,l[h+C+f][n-N-1]=1}for(let C=0;C<=b;C++){let L=Math.floor(Math.sqrt(M-M*C*C/S)),N=h-L;l[N][b-C]=1,l[N][b+C+m]=1,l[t-N-1][b-C]=1,l[t-N-1][b+C+m]=1}}return l}function triangle(n,t,s){if(!s.filled)throw new Error("Non filled triangle is not implemented");const l=zerosMatrix(t,n);for(let f=0;f<t;f++){let m=Math.floor((1-f/t)*n/2);for(let b=m;b<n-m;b++)l[f][b]=1}return l}function paintPoints(n,t={}){let{shape:s}=t;this.checkProcessable("paintPoints",{bitDepth:[8,16]});let l=getColors(Object.assign({},t,{numberColors:n.length})),f=new Shape(s).getPoints(),m=Math.min(this.channels,l[0].length);for(let b=0;b<n.length;b++){let h=l[b%l.length],S=n[b][0],M=n[b][1];for(let C=0;C<f.length;C++){let L=f[C][0],N=f[C][1];if(S+L>=0&&M+N>=0&&S+L<this.width&&M+N<this.height){let F=(S+L+(M+N)*this.width)*this.channels;for(let G=0;G<m;G++)this.data[F+G]=h[G]}}}return this}function paintPolyline(n,t={}){let{color:s=[this.maxValue,0,0],closed:l=!1}=t;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]});let f=Math.min(this.channels,s.length);for(let m=0;m<n.length-1+l;m++){let b=n[m],h=n[(m+1)%n.length],S=h[0]-b[0],M=h[1]-b[1],C=Math.max(Math.abs(S),Math.abs(M)),L=S/C,N=M/C,F=b[0],G=b[1];for(let H=0;H<=C;H++){let K=Math.round(F),X=Math.round(G);if(K>=0&&X>=0&&K<this.width&&X<this.height)if(this.bitDepth===1)this.setBitXY(K,X);else{let de=(K+X*this.width)*this.channels;for(let Q=0;Q<f;Q++)this.data[de+Q]=s[Q]}F=F+L,G=G+N}}return this}function paintPolylines(n,t={}){let s=Object.assign({},t);this.checkProcessable("paintPolylines",{bitDepth:[8,16]});let l=getColors(Object.assign({},t,{numberColors:n.length}));for(let f=0;f<n.length;f++)s.color=l[f%l.length],this.paintPolyline(n[f],s);return this}function paintPolygon(n,t={}){let{color:s=[this.maxValue,0,0],filled:l=!1}=t;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]}),t.closed=!0;let f=deleteDouble(n);if(l===!1)return this.paintPolyline(n,t);{let m=Array(this.height);for(let b=0;b<this.height;b++){m[b]=[];for(let h=0;h<this.width;h++)m[b].push(0)}for(let b=0;b<f.length;b++){const h=lineBetweenTwoPoints(f[b],f[(b+1)%f.length]);for(let S=0;S<this.height;S++)for(let M=0;M<this.width;M++)isAtTheRightOfTheLine(M,S,h,this.height)&&(m[S][M]=m[S][M]===0?1:0)}for(let b=0;b<this.height;b++)for(let h=0;h<this.width;h++)if(m[b][h]===1)if(this.bitDepth===1)this.setBitXY(h,b);else{let S=Math.min(this.channels,s.length),M=(h+b*this.width)*this.channels;for(let C=0;C<S;C++)this.data[M+C]=s[C]}return this.paintPolyline(n,t)}}function deleteDouble(n){let t=[];for(let s=0;s<n.length;s++)if(!(n[s][0]===n[(s+1)%n.length][0]&&n[s][1]===n[(s+1)%n.length][1])){if(n[s][0]===n[(s-1+n.length)%n.length][0]&&n[s][1]===n[(s-1+n.length)%n.length][1])continue;if(n[(s+1)%n.length][0]===n[(s-1+n.length)%n.length][0]&&n[(s-1+n.length)%n.length][1]===n[(s+1)%n.length][1])continue;t.push(n[s])}return t}function lineBetweenTwoPoints(n,t){if(n[0]===t[0])return{a:0,b:n[0],vertical:!0};{const s=(t[1]-n[1])/(t[0]-n[0]),l=n[1]-s*n[0];return{a:s,b:l,vertical:!1}}}function isAtTheRightOfTheLine(n,t,s,l){if(s.vertical===!0)return s.b<=n;if(s.a===0)return!1;{const f=(t-s.b)/s.a;return f<n&&f>=0&&f<=l}}function paintPolygons(n,t={}){let s=Object.assign({},t);this.checkProcessable("paintPolygons",{bitDepth:[8,16]});let l=getColors(Object.assign({},t,{numberColors:n.length}));for(let f=0;f<n.length;f++)s.color=l[f%l.length],this.paintPolygon(n[f],s);return this}function getHistogram(n={}){let{maxSlots:t=256,channel:s,useAlpha:l=!0}=n;if(this.checkProcessable("getHistogram",{bitDepth:[1,8,16]}),s===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");s=0}return getChannelHistogram.call(this,s,{useAlpha:l,maxSlots:t})}function getHistograms(n={}){const{maxSlots:t=256,useAlpha:s=!0}=n;this.checkProcessable("getHistograms",{bitDepth:[8,16]});let l=new Array(s?this.components:this.channels);for(let f=0;f<l.length;f++)l[f]=getChannelHistogram.call(this,f,{useAlpha:s,maxSlots:t});return l}function getChannelHistogram(n,t){let{useAlpha:s,maxSlots:l}=t;if(this.bitDepth===1){let S=[0,0];for(let M=0;M<this.height;M++)for(let C=0;C<this.width;C++){let L=this.getBitXY(M,C);L===0?S[0]+=1:L===1&&(S[1]+=1)}return S}let f=Math.log2(l);if(!isInteger(f))throw new RangeError("maxSlots must be a power of 2, for example: 64, 256, 1024");let m=0;this.bitDepth>f&&(m=this.bitDepth-f);let b=this.data,h=newArray_1(Math.pow(2,Math.min(this.bitDepth,f)),0);if(s&&this.alpha){let S=this.channels-n-1;for(let M=n;M<b.length;M+=this.channels)h[b[M]>>m]+=b[M+S]/this.maxValue}else for(let S=n;S<b.length;S+=this.channels)h[b[S]>>m]++;return h}function getColorHistogram(n={}){let{useAlpha:t=!0,nbSlots:s=512}=n;this.checkProcessable("getColorHistogram",{bitDepth:[8,16],components:[3]});let l=Math.log(s)/Math.log(8);if(l!==Math.floor(l))throw new RangeError("nbSlots must be a power of 8. Usually 8, 64, 512 or 4096");let f=this.bitDepth-l,m=this.data,b=newArray_1(Math.pow(8,l),0),h=Math.pow(2,l*2),S=Math.pow(2,l);for(let M=0;M<m.length;M+=this.channels){let C=(m[M]>>f)*h+(m[M+1]>>f)*S+(m[M+2]>>f);t&&this.alpha?b[C]+=m[M+this.channels-1]/this.maxValue:b[C]++}return b}function min(){this.checkProcessable("min",{bitDepth:[8,16,32]});let n=newArray_1(this.channels,1/0);for(let t=0;t<this.data.length;t+=this.channels)for(let s=0;s<this.channels;s++)this.data[t+s]<n[s]&&(n[s]=this.data[t+s]);return n}function max(){this.checkProcessable("max",{bitDepth:[8,16,32]});let n=newArray_1(this.channels,-1/0);for(let t=0;t<this.data.length;t+=this.channels)for(let s=0;s<this.channels;s++)this.data[t+s]>n[s]&&(n[s]=this.data[t+s]);return n}function sum(){this.checkProcessable("sum",{bitDepth:[8,16]});let n=newArray_1(this.channels,0);for(let t=0;t<this.data.length;t+=this.channels)for(let s=0;s<this.channels;s++)n[s]+=this.data[t+s];return n}function getMoment(n=0,t=0){this.checkProcessable("getMoment",{bitDepth:[1]});let s=0;for(let l=0;l<this.width;l++)for(let f=0;f<this.height;f++)this.getBitXY(l,f)===1&&(s+=l**n*f**t);return s}function localMaxima(n={}){let{mask:t,region:s=3,removeClosePoints:l=0,invert:f=!1,maxEquals:m=2}=n,b=this;this.checkProcessable("localMaxima",{bitDepth:[8,16],components:1}),s*=4;let h=f?0:1,S=[1,0,-1,0,1,1,-1,-1,2,0,-2,0,2,2,-2,-2],M=[0,1,0,-1,1,-1,1,-1,0,2,0,-2,2,-2,2,-2],C=s<=8?1:2,L=[];for(let N=C;N<b.height-C;N++)for(let F=C;F<b.width-C;F++){if(t&&t.getBitXY(F,N)!==h)continue;let G=0,H=0,K=b.data[F+N*b.width];for(let X=0;X<s;X++)f?b.data[F+S[X]+(N+M[X])*b.width]>K&&G++:b.data[F+S[X]+(N+M[X])*b.width]<K&&G++,b.data[F+S[X]+(N+M[X])*b.width]===K&&H++;G+H===s&&H<=m&&L.push([F,N])}if(l>0)for(let N=0;N<L.length;N++)for(let F=N+1;F<L.length;F++)Math.sqrt(Math.pow(L[N][0]-L[F][0],2)+Math.pow(L[N][1]-L[F][1],2))<l&&(L[N][0]=L[N][0]+L[F][0]>>1,L[N][1]=L[N][1]+L[F][1]>>1,L.splice(F,1),F--);return L}function mean(){let n=this.getHistograms({maxSlots:this.maxValue+1}),t=new Array(n.length);for(let s=0;s<n.length;s++){let l=n[s];t[s]=mean$2(l)}return t}function median(){let n=this.getHistograms({maxSlots:this.maxValue+1}),t=new Array(n.length);for(let s=0;s<n.length;s++){let l=n[s];t[s]=median$2(l)}return t}function points(){this.checkProcessable("points",{bitDepth:[1]});const n=[];for(let t=0;t<this.width;t++)for(let s=0;s<this.height;s++)this.getBitXY(t,s)===1&&n.push([t,s]);return n}function extendedPoints(){this.checkProcessable("extendedPoints",{bitDepth:[1]});const n=[];for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++)if(this.getBitXY(s,t)===1)for(n.push([s,t]),this.getBitXY(s+1,t)!==1?(n.push([s+1,t]),n.push([s+1,t+1]),this.getBitXY(s,t+1)!==1&&n.push([s,t+1])):this.getBitXY(s,t+1)!==1&&(n.push([s,t+1]),n.push([s+1,t+1]));s<this.width-2&&this.getBitXY(s+1,t)===1&&this.getBitXY(s+2,t)===1;)s++;return n}function getRelativePosition(n,t={}){if(this===n)return[0,0];let s=[0,0],l=this;for(;l;){if(l===n)return s;l.position&&(s[0]+=l.position[0],s[1]+=l.position[1]),l=l.parent}return t.defaultFurther?s:!1}function countAlphaPixels(n={}){let{alpha:t=1}=n;this.checkProcessable("countAlphaPixels",{bitDepth:[8,16],alpha:1});let s=0;if(t!==void 0){for(let l=this.components;l<this.data.length;l+=this.channels)this.data[l]===t&&s++;return s}else return this.size}function monotoneChainConvexHull$1(n,t={}){t.sorted||n.sort(byXThenY);const s=n.length,l=new Array(s*2);for(var f=0,m=0;m<s;m++){const h=n[m];for(;f>=2&&cw(l[f-2],l[f-1],h)<=0;)f--;l[f++]=h}const b=f+1;for(m=s-2;m>=0;m--){const h=n[m];for(;f>=b&&cw(l[f-2],l[f-1],h)<=0;)f--;l[f++]=h}return l.slice(0,f-1)}function cw(n,t,s){return(t[1]-n[1])*(s[0]-n[0])-(t[0]-n[0])*(s[1]-n[1])}function byXThenY(n,t){return n[0]===t[0]?n[1]-t[1]:n[0]-t[0]}function monotoneChainConvexHull(){return monotoneChainConvexHull$1(this.extendedPoints,{sorted:!1})}function round(n){for(let t=0;t<n.length;t++)n[t][0]=Math.round(n[t][0]),n[t][1]=Math.round(n[t][1]);return n}function difference(n,t){return[n[0]-t[0],n[1]-t[1]]}function normalize(n){let t=Math.sqrt(n[0]**2+n[1]**2);return[n[0]/t,n[1]/t]}function rotate(n,t,s){s===void 0&&(s=new Array(t.length));let l=Math.cos(n),f=Math.sin(n);for(let m=0;m<s.length;++m)s[m]=[l*t[m][0]-f*t[m][1],f*t[m][0]+l*t[m][1]];return s}function perimeter(n){let t=0;for(let s=0;s<n.length;s++){let l=n[s][0],f=n[s][1],m=n[s===n.length-1?0:s+1][0],b=n[s===n.length-1?0:s+1][1];t+=Math.sqrt((m-l)**2+(b-f)**2)}return t}function surface(n){let t=0;for(let s=0;s<n.length;s++){let l=n[s][0],f=n[s===n.length-1?0:s+1][1],m=n[s===n.length-1?0:s+1][0],b=n[s][1];t+=l*f*.5,t-=m*b*.5}return Math.abs(t)}function minMax(n){let t=1/0,s=1/0,l=-1/0,f=-1/0;for(let m=0;m<n.length;m++)n[m][0]<t&&(t=n[m][0]),n[m][0]>l&&(l=n[m][0]),n[m][1]<s&&(s=n[m][1]),n[m][1]>f&&(f=n[m][1]);return[[t,s],[l,f]]}function moveToZeroZero(n,t){t===void 0&&(t=new Array(n.length).fill(0).map(()=>[]));let s=minMax(n),l=s[0][0],f=s[0][1];for(let m=0;m<n.length;m++)t[m][0]=n[m][0]-l,t[m][1]=n[m][1]-f;return t}function minimalBoundingRectangle(n={}){const{originalPoints:t=monotoneChainConvexHull.call(this)}=n;if(t.length===0)return[];if(t.length===1)return[t[0],t[0],t[0],t[0]];const s=new Array(t.length);let l=1/0,f=0,m;for(let b=0;b<s.length;b++){let h=getAngle$1(t[b],t[(b+1)%s.length]);rotate(-h,t,s);let S=s[b][0],M=s[b][1],C=s[(b+1)%s.length][0],L=s[(b+1)%s.length][1],N=!0,F=0,G=0,H=0;for(let Q=0;Q<s.length;Q++){let ie=s[Q][0],ce=s[Q][1],ge=(ie-S)/(C-S);N===!0?(N=!1,F=ge,G=ge):(ge<F&&(F=ge),ge>G&&(G=ge));let be=(-(C-S)*ce+C*M-L*S)/(C-S);Math.abs(be)>Math.abs(H)&&(H=be)}let K=[S+F*(C-S),M],X=[S+G*(C-S),M],de=Math.abs(H*(F-G)*(C-S));de<l&&(f=h,l=de,m=[K,X,[X[0],X[1]-H],[K[0],K[1]-H]])}return rotate(f,m,m),m}function getAngle$1(n,t){let s=difference(t,n),l=normalize(s),f=Math.acos(l[0]);return l[1]<0?-f:f}function extend$4(n){let t={inPlace:!0};n.extendMethod("invert",invert),n.extendMethod("abs",abs),n.extendMethod("level",level,t),n.extendMethod("add",add,t),n.extendMethod("subtract",subtract,t),n.extendMethod("subtractImage",subtractImage),n.extendMethod("multiply",multiply,t),n.extendMethod("divide",divide,t),n.extendMethod("hypotenuse",hypotenuse),n.extendMethod("background",background$1),n.extendMethod("flipX",flipX),n.extendMethod("flipY",flipY),n.extendMethod("blurFilter",blurFilter),n.extendMethod("medianFilter",medianFilter),n.extendMethod("gaussianFilter",gaussianFilter),n.extendMethod("sobelFilter",sobelFilter),n.extendMethod("gradientFilter",gradientFilter),n.extendMethod("scharrFilter",scharrFilter),n.extendMethod("dilate",dilate),n.extendMethod("erode",erode),n.extendMethod("open",open),n.extendMethod("close",close),n.extendMethod("topHat",topHat),n.extendMethod("blackHat",blackHat),n.extendMethod("morphologicalGradient",morphologicalGradient),n.extendMethod("warpingFourPoints",warpingFourPoints),n.extendMethod("crop",crop),n.extendMethod("cropAlpha",cropAlpha),n.extendMethod("resize",resize).extendMethod("scale",resize),n.extendMethod("hsv",hsv),n.extendMethod("hsl",hsl$1),n.extendMethod("cmyk",cmyk),n.extendMethod("rgba8",rgba8),n.extendMethod("grey",grey).extendMethod("gray",grey),n.extendMethod("mask",mask),n.extendMethod("pad",pad),n.extendMethod("colorDepth",colorDepth),n.extendMethod("setBorder",setBorder,t),n.extendMethod("rotate",rotate$1),n.extendMethod("rotateLeft",rotateLeft),n.extendMethod("rotateRight",rotateRight),n.extendMethod("insert",insert),n.extendMethod("getRow",getRow),n.extendMethod("getColumn",getColumn),n.extendMethod("getMatrix",getMatrix),n.extendMethod("setMatrix",setMatrix),n.extendMethod("getPixelsArray",getPixelsArray),n.extendMethod("getIntersection",getIntersection),n.extendMethod("getClosestCommonParent",getClosestCommonParent),n.extendMethod("getThreshold",getThreshold),n.extendMethod("split",split),n.extendMethod("getChannel",getChannel),n.extendMethod("combineChannels",combineChannels),n.extendMethod("setChannel",setChannel),n.extendMethod("getSimilarity",getSimilarity),n.extendMethod("getPixelsGrid",getPixelsGrid),n.extendMethod("getBestMatch",getBestMatch),n.extendMethod("cannyEdge",cannyEdge),n.extendMethod("convolution",convolution),n.extendMethod("extract",extract),n.extendMethod("floodFill",floodFill),n.extendMethod("paintLabels",paintLabels,t),n.extendMethod("paintMasks",paintMasks,t),n.extendMethod("paintPoints",paintPoints,t),n.extendMethod("paintPolyline",paintPolyline,t),n.extendMethod("paintPolylines",paintPolylines,t),n.extendMethod("paintPolygon",paintPolygon,t),n.extendMethod("paintPolygons",paintPolygons,t),n.extendMethod("countAlphaPixels",countAlphaPixels),n.extendMethod("monotoneChainConvexHull",monotoneChainConvexHull),n.extendMethod("minimalBoundingRectangle",minimalBoundingRectangle),n.extendMethod("getHistogram",getHistogram).extendProperty("histogram",getHistogram),n.extendMethod("getHistograms",getHistograms).extendProperty("histograms",getHistograms),n.extendMethod("getColorHistogram",getColorHistogram).extendProperty("colorHistogram",getColorHistogram),n.extendMethod("getMin",min).extendProperty("min",min),n.extendMethod("getMax",max).extendProperty("max",max),n.extendMethod("getSum",sum).extendProperty("sum",sum),n.extendMethod("getMoment",getMoment).extendProperty("moment",getMoment),n.extendMethod("getLocalMaxima",localMaxima),n.extendMethod("getMedian",median).extendProperty("median",median),n.extendMethod("getMean",mean).extendProperty("mean",mean),n.extendMethod("getPoints",points).extendProperty("points",points),n.extendMethod("getExtendedPoints",extendedPoints).extendProperty("extendedPoints",extendedPoints),n.extendMethod("getRelativePosition",getRelativePosition)}var quantities={exports:{}};(function(n,t){(function(s,l){n.exports=l()})(commonjsGlobal,function(){function s(_e){return typeof _e=="string"||_e instanceof String}var l=Number.isFinite||window.isFinite;function f(_e){return l(_e)}function m(_e){return _e}function b(_e){var J={};return _e.filter(function(j){return J.hasOwnProperty(j)?!1:J[j]=!0})}function h(_e,J){if(J.length!==_e.length)return!1;for(var j=0;j<_e.length;j++)if(J[j].compareArray&&!J[j].compareArray(_e[j])||J[j]!==_e[j])return!1;return!0}function S(_e,J){Object.keys(J).forEach(function(j){_e[j]=J[j]})}function M(){for(var _e=1,J=0,j=0;j<arguments.length;j++){var Y=arguments[j];J=J+N(Y),_e*=Y}return J!==0?L(_e,J):_e}function C(_e,J){if(J===0)throw new Error("Divide by zero");var j=Math.pow(10,N(J)),Y=j/(j*J);return M(_e,Y)}function L(_e,J){return Math.round(_e*Math.pow(10,J))/Math.pow(10,J)}function N(_e){if(!isFinite(_e))return 0;for(var J=0;_e%1!==0;)_e*=10,J++;return J}function F(){var _e;if(!this)return _e=Object.create(F.prototype),F.apply(_e,arguments),_e;_e=Error.apply(this,arguments),this.name="QtyError",this.message=_e.message,this.stack=_e.stack}F.prototype=Object.create(Error.prototype,{constructor:{value:F}});function G(_e,J){throw new F("Incompatible units: "+_e+" and "+J)}var H={"<googol>":[["googol"],1e100,"prefix"],"<kibi>":[["Ki","Kibi","kibi"],Math.pow(2,10),"prefix"],"<mebi>":[["Mi","Mebi","mebi"],Math.pow(2,20),"prefix"],"<gibi>":[["Gi","Gibi","gibi"],Math.pow(2,30),"prefix"],"<tebi>":[["Ti","Tebi","tebi"],Math.pow(2,40),"prefix"],"<pebi>":[["Pi","Pebi","pebi"],Math.pow(2,50),"prefix"],"<exi>":[["Ei","Exi","exi"],Math.pow(2,60),"prefix"],"<zebi>":[["Zi","Zebi","zebi"],Math.pow(2,70),"prefix"],"<yebi>":[["Yi","Yebi","yebi"],Math.pow(2,80),"prefix"],"<yotta>":[["Y","Yotta","yotta"],1e24,"prefix"],"<zetta>":[["Z","Zetta","zetta"],1e21,"prefix"],"<exa>":[["E","Exa","exa"],1e18,"prefix"],"<peta>":[["P","Peta","peta"],1e15,"prefix"],"<tera>":[["T","Tera","tera"],1e12,"prefix"],"<giga>":[["G","Giga","giga"],1e9,"prefix"],"<mega>":[["M","Mega","mega"],1e6,"prefix"],"<kilo>":[["k","kilo"],1e3,"prefix"],"<hecto>":[["h","Hecto","hecto"],100,"prefix"],"<deca>":[["da","Deca","deca","deka"],10,"prefix"],"<deci>":[["d","Deci","deci"],.1,"prefix"],"<centi>":[["c","Centi","centi"],.01,"prefix"],"<milli>":[["m","Milli","milli"],.001,"prefix"],"<micro>":[["u","\u03BC","\xB5","Micro","mc","micro"],1e-6,"prefix"],"<nano>":[["n","Nano","nano"],1e-9,"prefix"],"<pico>":[["p","Pico","pico"],1e-12,"prefix"],"<femto>":[["f","Femto","femto"],1e-15,"prefix"],"<atto>":[["a","Atto","atto"],1e-18,"prefix"],"<zepto>":[["z","Zepto","zepto"],1e-21,"prefix"],"<yocto>":[["y","Yocto","yocto"],1e-24,"prefix"],"<1>":[["1","<1>"],1,""],"<meter>":[["m","meter","meters","metre","metres"],1,"length",["<meter>"]],"<inch>":[["in","inch","inches",'"'],.0254,"length",["<meter>"]],"<foot>":[["ft","foot","feet","'"],.3048,"length",["<meter>"]],"<yard>":[["yd","yard","yards"],.9144,"length",["<meter>"]],"<mile>":[["mi","mile","miles"],1609.344,"length",["<meter>"]],"<naut-mile>":[["nmi","naut-mile"],1852,"length",["<meter>"]],"<league>":[["league","leagues"],4828,"length",["<meter>"]],"<furlong>":[["furlong","furlongs"],201.2,"length",["<meter>"]],"<rod>":[["rd","rod","rods"],5.029,"length",["<meter>"]],"<mil>":[["mil","mils"],254e-7,"length",["<meter>"]],"<angstrom>":[["ang","angstrom","angstroms"],1e-10,"length",["<meter>"]],"<fathom>":[["fathom","fathoms"],1.829,"length",["<meter>"]],"<pica>":[["pica","picas"],.00423333333,"length",["<meter>"]],"<point>":[["pt","point","points"],.000352777778,"length",["<meter>"]],"<redshift>":[["z","red-shift","redshift"],1302773e20,"length",["<meter>"]],"<AU>":[["AU","astronomical-unit"],1495979e5,"length",["<meter>"]],"<light-second>":[["ls","light-second"],299792500,"length",["<meter>"]],"<light-minute>":[["lmin","light-minute"],1798755e4,"length",["<meter>"]],"<light-year>":[["ly","light-year"],9460528e9,"length",["<meter>"]],"<parsec>":[["pc","parsec","parsecs"],3085678e10,"length",["<meter>"]],"<datamile>":[["DM","datamile"],1828.8,"length",["<meter>"]],"<kilogram>":[["kg","kilogram","kilograms"],1,"mass",["<kilogram>"]],"<AMU>":[["u","AMU","amu"],1660538921e-36,"mass",["<kilogram>"]],"<dalton>":[["Da","Dalton","Daltons","dalton","daltons"],1660538921e-36,"mass",["<kilogram>"]],"<slug>":[["slug","slugs"],14.5939029,"mass",["<kilogram>"]],"<short-ton>":[["tn","ton","short-ton"],907.18474,"mass",["<kilogram>"]],"<metric-ton>":[["tonne","metric-ton"],1e3,"mass",["<kilogram>"]],"<carat>":[["ct","carat","carats"],2e-4,"mass",["<kilogram>"]],"<pound>":[["lbs","lb","pound","pounds","#"],.45359237,"mass",["<kilogram>"]],"<ounce>":[["oz","ounce","ounces"],.0283495231,"mass",["<kilogram>"]],"<gram>":[["g","gram","grams","gramme","grammes"],.001,"mass",["<kilogram>"]],"<grain>":[["grain","grains","gr"],6479891e-11,"mass",["<kilogram>"]],"<dram>":[["dram","drams","dr"],.0017718452,"mass",["<kilogram>"]],"<stone>":[["stone","stones","st"],6.35029318,"mass",["<kilogram>"]],"<hectare>":[["hectare"],1e4,"area",["<meter>","<meter>"]],"<acre>":[["acre","acres"],4046.85642,"area",["<meter>","<meter>"]],"<sqft>":[["sqft"],1,"area",["<foot>","<foot>"]],"<liter>":[["l","L","liter","liters","litre","litres"],.001,"volume",["<meter>","<meter>","<meter>"]],"<gallon>":[["gal","gallon","gallons"],.0037854118,"volume",["<meter>","<meter>","<meter>"]],"<gallon-imp>":[["galimp","gallon-imp","gallons-imp"],.00454609,"volume",["<meter>","<meter>","<meter>"]],"<quart>":[["qt","quart","quarts"],.00094635295,"volume",["<meter>","<meter>","<meter>"]],"<pint>":[["pt","pint","pints"],.000473176475,"volume",["<meter>","<meter>","<meter>"]],"<pint-imp>":[["ptimp","pint-imp","pints-imp"],.00056826125,"volume",["<meter>","<meter>","<meter>"]],"<cup>":[["cu","cup","cups"],.000236588238,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce>":[["floz","fluid-ounce","fluid-ounces"],295735297e-13,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce-imp>":[["flozimp","floz-imp","fluid-ounce-imp","fluid-ounces-imp"],284130625e-13,"volume",["<meter>","<meter>","<meter>"]],"<tablespoon>":[["tb","tbsp","tbs","tablespoon","tablespoons"],147867648e-13,"volume",["<meter>","<meter>","<meter>"]],"<teaspoon>":[["tsp","teaspoon","teaspoons"],492892161e-14,"volume",["<meter>","<meter>","<meter>"]],"<bushel>":[["bu","bsh","bushel","bushels"],.035239072,"volume",["<meter>","<meter>","<meter>"]],"<oilbarrel>":[["bbl","oilbarrel","oilbarrels","oil-barrel","oil-barrels"],.158987294928,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel>":[["bl","bl-us","beerbarrel","beerbarrels","beer-barrel","beer-barrels"],.1173477658,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel-imp>":[["blimp","bl-imp","beerbarrel-imp","beerbarrels-imp","beer-barrel-imp","beer-barrels-imp"],.16365924,"volume",["<meter>","<meter>","<meter>"]],"<kph>":[["kph"],.277777778,"speed",["<meter>"],["<second>"]],"<mph>":[["mph"],.44704,"speed",["<meter>"],["<second>"]],"<knot>":[["kt","kn","kts","knot","knots"],.514444444,"speed",["<meter>"],["<second>"]],"<fps>":[["fps"],.3048,"speed",["<meter>"],["<second>"]],"<gee>":[["gee"],9.80665,"acceleration",["<meter>"],["<second>","<second>"]],"<Gal>":[["Gal"],.01,"acceleration",["<meter>"],["<second>","<second>"]],"<kelvin>":[["degK","kelvin"],1,"temperature",["<kelvin>"]],"<celsius>":[["degC","celsius","celsius","centigrade"],1,"temperature",["<kelvin>"]],"<fahrenheit>":[["degF","fahrenheit"],5/9,"temperature",["<kelvin>"]],"<rankine>":[["degR","rankine"],5/9,"temperature",["<kelvin>"]],"<temp-K>":[["tempK","temp-K"],1,"temperature",["<temp-K>"]],"<temp-C>":[["tempC","temp-C"],1,"temperature",["<temp-K>"]],"<temp-F>":[["tempF","temp-F"],5/9,"temperature",["<temp-K>"]],"<temp-R>":[["tempR","temp-R"],5/9,"temperature",["<temp-K>"]],"<second>":[["s","sec","secs","second","seconds"],1,"time",["<second>"]],"<minute>":[["min","mins","minute","minutes"],60,"time",["<second>"]],"<hour>":[["h","hr","hrs","hour","hours"],3600,"time",["<second>"]],"<day>":[["d","day","days"],3600*24,"time",["<second>"]],"<week>":[["wk","week","weeks"],7*3600*24,"time",["<second>"]],"<fortnight>":[["fortnight","fortnights"],1209600,"time",["<second>"]],"<year>":[["y","yr","year","years","annum"],31556926,"time",["<second>"]],"<decade>":[["decade","decades"],315569260,"time",["<second>"]],"<century>":[["century","centuries"],3155692600,"time",["<second>"]],"<pascal>":[["Pa","pascal","Pascal"],1,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<bar>":[["bar","bars"],1e5,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<mmHg>":[["mmHg"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inHg>":[["inHg"],3386.3881472,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<torr>":[["torr"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<atm>":[["atm","ATM","atmosphere","atmospheres"],101325,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<psi>":[["psi"],6894.76,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<cmh2o>":[["cmH2O","cmh2o"],98.0638,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inh2o>":[["inH2O","inh2o"],249.082052,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<poise>":[["P","poise"],.1,"viscosity",["<kilogram>"],["<meter>","<second>"]],"<stokes>":[["St","stokes"],1e-4,"viscosity",["<meter>","<meter>"],["<second>"]],"<mole>":[["mol","mole"],1,"substance",["<mole>"]],"<molar>":[["M","molar"],1e3,"concentration",["<mole>"],["<meter>","<meter>","<meter>"]],"<wtpercent>":[["wt%","wtpercent"],10,"concentration",["<kilogram>"],["<meter>","<meter>","<meter>"]],"<katal>":[["kat","katal","Katal"],1,"activity",["<mole>"],["<second>"]],"<unit>":[["U","enzUnit","unit"],16667e-19,"activity",["<mole>"],["<second>"]],"<farad>":[["F","farad","Farad"],1,"capacitance",["<second>","<second>","<second>","<second>","<ampere>","<ampere>"],["<meter>","<meter>","<kilogram>"]],"<coulomb>":[["C","coulomb","Coulomb"],1,"charge",["<ampere>","<second>"]],"<Ah>":[["Ah"],3600,"charge",["<ampere>","<second>"]],"<ampere>":[["A","Ampere","ampere","amp","amps"],1,"current",["<ampere>"]],"<siemens>":[["S","Siemens","siemens"],1,"conductance",["<second>","<second>","<second>","<ampere>","<ampere>"],["<kilogram>","<meter>","<meter>"]],"<henry>":[["H","Henry","henry"],1,"inductance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>","<ampere>"]],"<volt>":[["V","Volt","volt","volts"],1,"potential",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>"]],"<ohm>":[["Ohm","ohm","\u03A9","\u2126"],1,"resistance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>","<ampere>"]],"<weber>":[["Wb","weber","webers"],1,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<tesla>":[["T","tesla","teslas"],1,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<gauss>":[["G","gauss"],1e-4,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<maxwell>":[["Mx","maxwell","maxwells"],1e-8,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<oersted>":[["Oe","oersted","oersteds"],250/Math.PI,"magnetism",["<ampere>"],["<meter>"]],"<joule>":[["J","joule","Joule","joules"],1,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<erg>":[["erg","ergs"],1e-7,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<btu>":[["BTU","btu","BTUs"],1055.056,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<calorie>":[["cal","calorie","calories"],4.184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Calorie>":[["Cal","Calorie","Calories"],4184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<therm-US>":[["th","therm","therms","Therm","therm-US"],105480400,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Wh>":[["Wh"],3600,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<newton>":[["N","Newton","newton"],1,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<dyne>":[["dyn","dyne"],1e-5,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<pound-force>":[["lbf","pound-force"],4.448222,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<hertz>":[["Hz","hertz","Hertz"],1,"frequency",["<1>"],["<second>"]],"<radian>":[["rad","radian","radians"],1,"angle",["<radian>"]],"<degree>":[["deg","degree","degrees"],Math.PI/180,"angle",["<radian>"]],"<gradian>":[["gon","grad","gradian","grads"],Math.PI/200,"angle",["<radian>"]],"<steradian>":[["sr","steradian","steradians"],1,"solid_angle",["<steradian>"]],"<rotation>":[["rotation"],2*Math.PI,"angle",["<radian>"]],"<rpm>":[["rpm"],2*Math.PI/60,"angular_velocity",["<radian>"],["<second>"]],"<byte>":[["B","byte","bytes"],1,"information",["<byte>"]],"<bit>":[["b","bit","bits"],.125,"information",["<byte>"]],"<Bps>":[["Bps"],1,"information_rate",["<byte>"],["<second>"]],"<bps>":[["bps"],.125,"information_rate",["<byte>"],["<second>"]],"<dollar>":[["USD","dollar"],1,"currency",["<dollar>"]],"<cents>":[["cents"],.01,"currency",["<dollar>"]],"<candela>":[["cd","candela"],1,"luminosity",["<candela>"]],"<lumen>":[["lm","lumen"],1,"luminous_power",["<candela>","<steradian>"]],"<lux>":[["lux"],1,"illuminance",["<candela>","<steradian>"],["<meter>","<meter>"]],"<watt>":[["W","watt","watts"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere>":[["VA","volt-ampere"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere-reactive>":[["var","Var","VAr","VAR","volt-ampere-reactive"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<horsepower>":[["hp","horsepower"],745.699872,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<gray>":[["Gy","gray","grays"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<roentgen>":[["R","roentgen"],.00933,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<sievert>":[["Sv","sievert","sieverts"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<becquerel>":[["Bq","becquerel","becquerels"],1,"radiation",["<1>"],["<second>"]],"<curie>":[["Ci","curie","curies"],37e9,"radiation",["<1>"],["<second>"]],"<cpm>":[["cpm"],1/60,"rate",["<count>"],["<second>"]],"<dpm>":[["dpm"],1/60,"rate",["<count>"],["<second>"]],"<bpm>":[["bpm"],1/60,"rate",["<count>"],["<second>"]],"<dot>":[["dot","dots"],1,"resolution",["<each>"]],"<pixel>":[["pixel","px"],1,"resolution",["<each>"]],"<ppi>":[["ppi"],1,"resolution",["<pixel>"],["<inch>"]],"<dpi>":[["dpi"],1,"typography",["<dot>"],["<inch>"]],"<cell>":[["cells","cell"],1,"counting",["<each>"]],"<each>":[["each"],1,"counting",["<each>"]],"<count>":[["count"],1,"counting",["<each>"]],"<base-pair>":[["bp","base-pair"],1,"counting",["<each>"]],"<nucleotide>":[["nt","nucleotide"],1,"counting",["<each>"]],"<molecule>":[["molecule","molecules"],1,"counting",["<1>"]],"<dozen>":[["doz","dz","dozen"],12,"prefix_only",["<each>"]],"<percent>":[["%","percent"],.01,"prefix_only",["<1>"]],"<ppm>":[["ppm"],1e-6,"prefix_only",["<1>"]],"<ppt>":[["ppt"],1e-9,"prefix_only",["<1>"]],"<gross>":[["gr","gross"],144,"prefix_only",["<dozen>","<dozen>"]],"<decibel>":[["dB","decibel","decibels"],1,"logarithmic",["<decibel>"]]},K=["<meter>","<kilogram>","<second>","<mole>","<ampere>","<radian>","<kelvin>","<temp-K>","<byte>","<dollar>","<candela>","<each>","<steradian>","<decibel>"],X="<1>",de=[X];function Q(_e,J){var j=J[1],Y=J[3]||[],le=J[4]||[];if(!f(j))throw new F(_e+": Invalid unit definition. 'scalar' must be a number");Y.forEach(function(pe){if(H[pe]===void 0)throw new F(_e+": Invalid unit definition. Unit "+pe+" in 'numerator' is not recognized")}),le.forEach(function(pe){if(H[pe]===void 0)throw new F(_e+": Invalid unit definition. Unit "+pe+" in 'denominator' is not recognized")})}var ie={},ce={},ge={},be={},ne={};for(var ve in H)if(H.hasOwnProperty(ve)){var te=H[ve];if(te[2]==="prefix"){ie[ve]=te[1];for(var he=0;he<te[0].length;he++)ce[te[0][he]]=ve}else{Q(ve,te),ge[ve]={scalar:te[1],numerator:te[3],denominator:te[4]};for(var Ie=0;Ie<te[0].length;Ie++)be[te[0][Ie]]=ve}ne[ve]=te[0][0]}function Oe(_e){var J,j=[],Y=Object.keys(H);if(typeof _e=="undefined")for(J=0;J<Y.length;J++)["","prefix"].indexOf(H[Y[J]][2])===-1&&j.push(Y[J].substr(1,Y[J].length-2));else{if(this.getKinds().indexOf(_e)===-1)throw new F("Kind not recognized");for(J=0;J<Y.length;J++)H[Y[J]][2]===_e&&j.push(Y[J].substr(1,Y[J].length-2))}return j.sort(function(le,pe){return le.toLowerCase()<pe.toLowerCase()?-1:le.toLowerCase()>pe.toLowerCase()?1:0})}function tt(_e){if(!be[_e])throw new F("Unit not recognized");return H[be[_e]][0]}var it=["length","time","temperature","mass","current","substance","luminosity","currency","information","angle"];function Ct(){if(this.signature)return this.signature;for(var _e=Rt.call(this),J=0;J<_e.length;J++)_e[J]*=Math.pow(20,J);return _e.reduce(function(j,Y){return j+Y},0)}function Rt(){if(!this.isBase())return Rt.call(this.toBase());for(var _e=new Array(it.length),J=0;J<_e.length;J++)_e[J]=0;for(var j,Y,le=0;le<this.numerator.length;le++)(j=H[this.numerator[le]])&&(Y=it.indexOf(j[2]),Y>=0&&(_e[Y]=_e[Y]+1));for(var pe=0;pe<this.denominator.length;pe++)(j=H[this.denominator[pe]])&&(Y=it.indexOf(j[2]),Y>=0&&(_e[Y]=_e[Y]-1));return _e}var xt="[+-]",Vt="\\d+",It=xt+"?"+Vt,Xt="\\."+Vt,Jt="(?:"+Vt+"(?:"+Xt+")?)|(?:"+Xt+")",nt="[Ee]"+It,mt="(?:"+Jt+")(?:"+nt+")?",ft=xt+"?\\s*"+mt,Dt="("+ft+")?\\s*([^/]*)(?:/(.+))?",qt=new RegExp("^"+Dt+"$"),oi="\\^|\\*{2}",ti="[01234]",fi=new RegExp("([^ \\*\\d]+?)(?:"+oi+")?(-?"+ti+"(?![a-zA-Z]))"),si=new RegExp("([^ \\*\\d]+?)(?:"+oi+")?("+ti+"(?![a-zA-Z]))");function Ot(_e){s(_e)||(_e=_e.toString()),_e=_e.trim();var J=qt.exec(_e);if(!J)throw new F(_e+": Quantity not recognized");var j=J[1];j?(j=j.replace(/\s/g,""),this.scalar=parseFloat(j)):this.scalar=1;for(var Y=J[2],le=J[3],pe,Ce,Be;J=fi.exec(Y);){if(pe=parseFloat(J[2]),isNaN(pe))throw new F("Unit exponent is not a number");if(pe===0&&!Et.test(J[1]))throw new F("Unit not recognized");Ce=J[1]+" ",Be="";for(var Le=0;Le<Math.abs(pe);Le++)Be+=Ce;pe>=0?Y=Y.replace(J[0],Be):(le=le?le+Be:Be,Y=Y.replace(J[0],""))}for(;J=si.exec(le);){if(pe=parseFloat(J[2]),isNaN(pe))throw new F("Unit exponent is not a number");if(pe===0&&!Et.test(J[1]))throw new F("Unit not recognized");Ce=J[1]+" ",Be="";for(var De=0;De<pe;De++)Be+=Ce;le=le.replace(J[0],Be)}Y&&(this.numerator=Wt(Y.trim())),le&&(this.denominator=Wt(le.trim()))}var ai=Object.keys(ce).sort(function(_e,J){return J.length-_e.length}).join("|"),Nt=Object.keys(be).sort(function(_e,J){return J.length-_e.length}).join("|"),dt="\\b|$",gi="("+ai+")??("+Nt+")(?:"+dt+")",Et=new RegExp("^\\s*("+gi+"[\\s\\*]*)+$"),je=new RegExp(gi,"g"),jt={};function Wt(_e){var J=jt[_e];if(J)return J;var j,Y=[];if(!Et.test(_e))throw new F("Unit not recognized");for(;j=je.exec(_e);)Y.push(j.slice(1));return Y=Y.map(function(le){return ce[le[0]]?[ce[le[0]],be[le[1]]]:[be[le[1]]]}),Y=Y.reduce(function(le,pe){return le.concat(pe)},[]),Y=Y.filter(function(le){return le}),jt[_e]=Y,Y}function Qt(_e){if(!s(_e))throw new F("Argument should be a string");try{return this(_e)}catch{return null}}function ni(_e){return _e instanceof gt}function gt(_e,J){if(Ai.apply(null,arguments),!ni(this))return new gt(_e,J);if(this.scalar=null,this.baseScalar=null,this.signature=null,this._conversionCache={},this.numerator=de,this.denominator=de,ci(_e)?(this.scalar=_e.scalar,this.numerator=_e.numerator&&_e.numerator.length!==0?_e.numerator:de,this.denominator=_e.denominator&&_e.denominator.length!==0?_e.denominator:de):J?(Ot.call(this,J),this.scalar=_e):Ot.call(this,_e),this.denominator.join("*").indexOf("temp")>=0)throw new F("Cannot divide with temperatures");if(this.numerator.join("*").indexOf("temp")>=0){if(this.numerator.length>1)throw new F("Cannot multiply by temperatures");if(!h(this.denominator,de))throw new F("Cannot divide with temperatures")}if(this.initValue=_e,Lt.call(this),this.isTemperature()&&this.baseScalar<0)throw new F("Temperatures must not be less than absolute zero")}gt.prototype={constructor:gt};function Ai(_e,J){if(J){if(!(f(_e)&&s(J)))throw new F("Only number accepted as initialization value when units are explicitly provided")}else if(!(s(_e)||f(_e)||ni(_e)||ci(_e)))throw new F("Only string, number or quantity accepted as single initialization value")}function ci(_e){return _e&&typeof _e=="object"&&_e.hasOwnProperty("scalar")}function Lt(){if(this.baseScalar)return this.baseScalar;if(this.isBase())this.baseScalar=this.scalar,this.signature=Ct.call(this);else{var _e=this.toBase();this.baseScalar=_e.scalar,this.signature=_e.signature}}var $t={"-312078":"elastance","-312058":"resistance","-312038":"inductance","-152058":"potential","-152040":"magnetism","-152038":"magnetism","-7997":"specific_volume","-79":"snap","-59":"jolt","-39":"acceleration","-38":"radiation","-20":"frequency","-19":"speed","-18":"viscosity","-17":"volumetric_flow","-1":"wavenumber","0":"unitless","1":"length","2":"area","3":"volume","20":"time","400":"temperature","7941":"yank","7942":"power","7959":"pressure","7961":"force","7962":"energy","7979":"viscosity","7981":"momentum","7982":"angular_momentum","7997":"density","7998":"area_density","8000":"mass","152020":"radiation_exposure","159999":"magnetism","160000":"current","160020":"charge","312058":"conductance","312078":"capacitance","3199980":"activity","3199997":"molar_concentration","3200000":"substance","63999998":"illuminance","64000000":"luminous_power","1280000000":"currency","25599999980":"information_rate","25600000000":"information","511999999980":"angular_velocity","512000000000":"angle"};function _t(){return b(Object.keys($t).map(function(_e){return $t[_e]}))}gt.prototype.kind=function(){return $t[this.signature.toString()]},S(gt.prototype,{isDegrees:function(){return(this.signature===null||this.signature===400)&&this.numerator.length===1&&h(this.denominator,de)&&(this.numerator[0].match(/<temp-[CFRK]>/)||this.numerator[0].match(/<(kelvin|celsius|rankine|fahrenheit)>/))},isTemperature:function(){return this.isDegrees()&&this.numerator[0].match(/<temp-[CFRK]>/)}});function hi(_e,J){var j=_e.units(),Y=J.to(j),le=gt(Ht(j));return gt({scalar:_e.scalar-Y.scalar,numerator:le.numerator,denominator:le.denominator})}function _i(_e,J){var j=J.to(Ht(_e.units()));return gt({scalar:_e.scalar-j.scalar,numerator:_e.numerator,denominator:_e.denominator})}function wi(_e,J){var j=J.to(Ht(_e.units()));return gt({scalar:_e.scalar+j.scalar,numerator:_e.numerator,denominator:_e.denominator})}function Ht(_e){if(_e==="tempK")return"degK";if(_e==="tempC")return"degC";if(_e==="tempF")return"degF";if(_e==="tempR")return"degR";throw new F("Unknown type for temp conversion from: "+_e)}function ui(_e,J){var j=Li(_e),Y=J.units(),le;if(Y==="degK")le=j.scalar;else if(Y==="degC")le=j.scalar;else if(Y==="degF")le=j.scalar*9/5;else if(Y==="degR")le=j.scalar*9/5;else throw new F("Unknown type for degree conversion to: "+Y);return gt({scalar:le,numerator:J.numerator,denominator:J.denominator})}function Li(_e){var J=_e.units(),j;if(J.match(/(deg)[CFRK]/))j=_e.baseScalar;else if(J==="tempK")j=_e.scalar;else if(J==="tempC")j=_e.scalar;else if(J==="tempF")j=_e.scalar*5/9;else if(J==="tempR")j=_e.scalar*5/9;else throw new F("Unknown type for temp conversion from: "+J);return gt({scalar:j,numerator:["<kelvin>"],denominator:de})}function zi(_e,J){var j=J.units(),Y;if(j==="tempK")Y=_e.baseScalar;else if(j==="tempC")Y=_e.baseScalar-273.15;else if(j==="tempF")Y=_e.baseScalar*9/5-459.67;else if(j==="tempR")Y=_e.baseScalar*9/5;else throw new F("Unknown type for temp conversion to: "+j);return gt({scalar:Y,numerator:J.numerator,denominator:J.denominator})}function Fi(_e){var J=_e.units(),j;if(J.match(/(deg)[CFRK]/))j=_e.baseScalar;else if(J==="tempK")j=_e.scalar;else if(J==="tempC")j=_e.scalar+273.15;else if(J==="tempF")j=(_e.scalar+459.67)*5/9;else if(J==="tempR")j=_e.scalar*5/9;else throw new F("Unknown type for temp conversion from: "+J);return gt({scalar:j,numerator:["<temp-K>"],denominator:de})}S(gt.prototype,{to:function(_e){var J,j;if(_e==null)return this;if(!s(_e))return this.to(_e.units());if(J=this._conversionCache[_e],J)return J;if(j=gt(_e),j.units()===this.units())return this;if(!this.isCompatible(j))this.isInverse(j)?j=this.inverse().to(_e):G(this.units(),j.units());else if(j.isTemperature())j=zi(this,j);else if(j.isDegrees())j=ui(this,j);else{var Y=C(this.baseScalar,j.baseScalar);j=gt({scalar:Y,numerator:j.numerator,denominator:j.denominator})}return this._conversionCache[_e]=j,j},toBase:function(){if(this.isBase())return this;if(this.isTemperature())return Fi(this);var _e=Br[this.units()];return _e||(_e=Rr(this.numerator,this.denominator),Br[this.units()]=_e),_e.mul(this.scalar)},toFloat:function(){if(this.isUnitless())return this.scalar;throw new F("Can't convert to Float unless unitless.  Use Unit#scalar")},toPrec:function(_e){if(s(_e)&&(_e=gt(_e)),f(_e)&&(_e=gt(_e+" "+this.units())),this.isUnitless()?_e.isUnitless()||G(this.units(),_e.units()):_e=_e.to(this.units()),_e.scalar===0)throw new F("Divide by zero");var J=M(Math.round(this.scalar/_e.scalar),_e.scalar);return gt(J+this.units())}});function tr(_e,J){var j=gt(_e),Y=gt(J);if(j.eq(Y))return m;var le;return j.isTemperature()?le=function(pe){return j.mul(pe).to(Y).scalar}:le=function(pe){return pe*j.baseScalar/Y.baseScalar},function(Ce){var Be,Le,De;if(Array.isArray(Ce)){for(Le=Ce.length,De=[],Be=0;Be<Le;Be++)De.push(le(Ce[Be]));return De}else return le(Ce)}}var Br={};function Rr(_e,J){for(var j=[],Y=[],le=1,pe,Ce=0;Ce<_e.length;Ce++)pe=_e[Ce],ie[pe]?le=M(le,ie[pe]):ge[pe]&&(le*=ge[pe].scalar,ge[pe].numerator&&j.push(ge[pe].numerator),ge[pe].denominator&&Y.push(ge[pe].denominator));for(var Be=0;Be<J.length;Be++)pe=J[Be],ie[pe]?le/=ie[pe]:ge[pe]&&(le/=ge[pe].scalar,ge[pe].numerator&&Y.push(ge[pe].numerator),ge[pe].denominator&&j.push(ge[pe].denominator));return j=j.reduce(function(Le,De){return Le.concat(De)},[]),Y=Y.reduce(function(Le,De){return Le.concat(De)},[]),gt({scalar:le,numerator:j,denominator:Y})}gt.parse=Qt,gt.getUnits=Oe,gt.getAliases=tt,gt.mulSafe=M,gt.divSafe=C,gt.getKinds=_t,gt.swiftConverter=tr,gt.Error=F,S(gt.prototype,{add:function(_e){if(s(_e)&&(_e=gt(_e)),this.isCompatible(_e)||G(this.units(),_e.units()),this.isTemperature()&&_e.isTemperature())throw new F("Cannot add two temperatures");return this.isTemperature()?wi(this,_e):_e.isTemperature()?wi(_e,this):gt({scalar:this.scalar+_e.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},sub:function(_e){if(s(_e)&&(_e=gt(_e)),this.isCompatible(_e)||G(this.units(),_e.units()),this.isTemperature()&&_e.isTemperature())return hi(this,_e);if(this.isTemperature())return _i(this,_e);if(_e.isTemperature())throw new F("Cannot subtract a temperature from a differential degree unit");return gt({scalar:this.scalar-_e.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},mul:function(_e){if(f(_e))return gt({scalar:M(this.scalar,_e),numerator:this.numerator,denominator:this.denominator});if(s(_e)&&(_e=gt(_e)),(this.isTemperature()||_e.isTemperature())&&!(this.isUnitless()||_e.isUnitless()))throw new F("Cannot multiply by temperatures");var J=this,j=_e;J.isCompatible(j)&&J.signature!==400&&(j=j.to(J));var Y=Er(J.numerator,J.denominator,j.numerator,j.denominator);return gt({scalar:M(J.scalar,j.scalar,Y[2]),numerator:Y[0],denominator:Y[1]})},div:function(_e){if(f(_e)){if(_e===0)throw new F("Divide by zero");return gt({scalar:this.scalar/_e,numerator:this.numerator,denominator:this.denominator})}else s(_e)&&(_e=gt(_e));if(_e.scalar===0)throw new F("Divide by zero");if(_e.isTemperature())throw new F("Cannot divide with temperatures");if(this.isTemperature()&&!_e.isUnitless())throw new F("Cannot divide with temperatures");var J=this,j=_e;J.isCompatible(j)&&J.signature!==400&&(j=j.to(J));var Y=Er(J.numerator,J.denominator,j.denominator,j.numerator);return gt({scalar:M(J.scalar,Y[2])/j.scalar,numerator:Y[0],denominator:Y[1]})},inverse:function(){if(this.isTemperature())throw new F("Cannot divide with temperatures");if(this.scalar===0)throw new F("Divide by zero");return gt({scalar:1/this.scalar,numerator:this.denominator,denominator:this.numerator})}});function Er(_e,J,j,Y){function le(Qe){return Qe!==X}_e=_e.filter(le),j=j.filter(le),J=J.filter(le),Y=Y.filter(le);var pe={};function Ce(Qe,Pt){for(var bt,Bt,Yt,Ne=0;Ne<Qe.length;Ne++)if(ie[Qe[Ne]]?(bt=Qe[Ne+1],Bt=Qe[Ne],Yt=ie[Bt],Ne++):(bt=Qe[Ne],Bt=null,Yt=1),bt&&bt!==X)if(pe[bt]){pe[bt][0]+=Pt;var Ei=pe[bt][2]?ie[pe[bt][2]]:1;pe[bt][Pt===1?3:4]*=C(Yt,Ei)}else pe[bt]=[Pt,bt,Bt,1,1]}Ce(_e,1),Ce(J,-1),Ce(j,1),Ce(Y,-1);var Be=[],Le=[],De=1;for(var Ve in pe)if(pe.hasOwnProperty(Ve)){var Ke=pe[Ve],ct;if(Ke[0]>0)for(ct=0;ct<Ke[0];ct++)Be.push(Ke[2]===null?Ke[1]:[Ke[2],Ke[1]]);else if(Ke[0]<0)for(ct=0;ct<-Ke[0];ct++)Le.push(Ke[2]===null?Ke[1]:[Ke[2],Ke[1]]);De*=C(Ke[3],Ke[4])}return Be.length===0&&(Be=de),Le.length===0&&(Le=de),Be=Be.reduce(function(Qe,Pt){return Qe.concat(Pt)},[]),Le=Le.reduce(function(Qe,Pt){return Qe.concat(Pt)},[]),[Be,Le,De]}S(gt.prototype,{eq:function(_e){return this.compareTo(_e)===0},lt:function(_e){return this.compareTo(_e)===-1},lte:function(_e){return this.eq(_e)||this.lt(_e)},gt:function(_e){return this.compareTo(_e)===1},gte:function(_e){return this.eq(_e)||this.gt(_e)},compareTo:function(_e){if(s(_e))return this.compareTo(gt(_e));if(this.isCompatible(_e)||G(this.units(),_e.units()),this.baseScalar<_e.baseScalar)return-1;if(this.baseScalar===_e.baseScalar)return 0;if(this.baseScalar>_e.baseScalar)return 1},same:function(_e){return this.scalar===_e.scalar&&this.units()===_e.units()}}),S(gt.prototype,{isUnitless:function(){return[this.numerator,this.denominator].every(function(_e){return h(_e,de)})},isCompatible:function(_e){return s(_e)?this.isCompatible(gt(_e)):ni(_e)&&_e.signature!==void 0?this.signature===_e.signature:!1},isInverse:function(_e){return this.inverse().isCompatible(_e)},isBase:function(){return this._isBase!==void 0?this._isBase:this.isDegrees()&&this.numerator[0].match(/<(kelvin|temp-K)>/)?(this._isBase=!0,this._isBase):(this.numerator.concat(this.denominator).forEach(function(_e){_e!==X&&K.indexOf(_e)===-1&&(this._isBase=!1)},this),this._isBase===!1?this._isBase:(this._isBase=!0,this._isBase))}});function er(){}er.prototype.get=function(_e){return arguments.length>1&&(_e=Array.apply(null,arguments)),_e.reduce(function(J,j,Y){if(J){var le=J[j];return Y===_e.length-1?le?le.data:void 0:le}},this)},er.prototype.set=function(_e,J){return arguments.length>2&&(_e=Array.prototype.slice.call(arguments,0,-1),J=arguments[arguments.length-1]),_e.reduce(function(j,Y,le){var pe=j[Y];return pe===void 0&&(pe=j[Y]={}),le===_e.length-1?(pe.data=J,J):pe},this)};function ur(_e,J){return(_e+" "+J).trim()}gt.formatter=ur,S(gt.prototype,{units:function(){if(this._units!==void 0)return this._units;var _e=h(this.numerator,de),J=h(this.denominator,de);if(_e&&J)return this._units="",this._units;var j=yr(this.numerator),Y=yr(this.denominator);return this._units=j+(J?"":"/"+Y),this._units},toString:function(_e,J){var j;if(f(_e))j=this.units(),J=_e;else if(s(_e))j=_e;else if(ni(_e))return this.toPrec(_e).toString(J);var Y=this.to(j),le=J!==void 0?L(Y.scalar,J):Y.scalar;return Y=(le+" "+Y.units()).trim(),Y},format:function(_e,J){arguments.length===1&&typeof _e=="function"&&(J=_e,_e=void 0),J=J||gt.formatter;var j=this.to(_e);return J.call(this,j.scalar,j.units())}});var mr=new er;function yr(_e){var J=mr.get(_e);if(J)return J;var j=h(_e,de);return j?J="1":J=Lr(Sr(_e)).join("*"),mr.set(_e,J),J}function Sr(_e){for(var J=[],j,Y,le=0;le<_e.length;le++)j=_e[le],Y=_e[le+1],ie[j]?(J.push(ne[j]+ne[Y]),le++):J.push(ne[j]);return J}function Lr(_e){var J=_e.reduce(function(j,Y){var le=j[Y];return le||j.push(le=j[Y]=[Y,0]),le[1]++,j},[]);return J.map(function(j){return j[0]+(j[1]>1?j[1]:"")})}return gt.version="1.7.6",gt})})(quantities);var Qty=quantities.exports;function deepValue(n,t=""){let s=t.split(".");for(let l of s){if(n[l]===void 0)return;n=n[l]}return n}var orientation={exports:{}},twoProduct_1=twoProduct$1,SPLITTER=+(Math.pow(2,27)+1);function twoProduct$1(n,t,s){var l=n*t,f=SPLITTER*n,m=f-n,b=f-m,h=n-b,S=SPLITTER*t,M=S-t,C=S-M,L=t-C,N=l-b*C,F=N-h*C,G=F-b*L,H=h*L-G;return s?(s[0]=H,s[1]=l,s):[H,l]}var robustSum=linearExpansionSum;function scalarScalar$1(n,t){var s=n+t,l=s-n,f=s-l,m=t-l,b=n-f,h=b+m;return h?[h,s]:[s]}function linearExpansionSum(n,t){var s=n.length|0,l=t.length|0;if(s===1&&l===1)return scalarScalar$1(n[0],t[0]);var f=s+l,m=new Array(f),b=0,h=0,S=0,M=Math.abs,C=n[h],L=M(C),N=t[S],F=M(N),G,H;L<F?(H=C,h+=1,h<s&&(C=n[h],L=M(C))):(H=N,S+=1,S<l&&(N=t[S],F=M(N))),h<s&&L<F||S>=l?(G=C,h+=1,h<s&&(C=n[h],L=M(C))):(G=N,S+=1,S<l&&(N=t[S],F=M(N)));for(var K=G+H,X=K-G,de=H-X,Q=de,ie=K,ce,ge,be,ne,ve;h<s&&S<l;)L<F?(G=C,h+=1,h<s&&(C=n[h],L=M(C))):(G=N,S+=1,S<l&&(N=t[S],F=M(N))),H=Q,K=G+H,X=K-G,de=H-X,de&&(m[b++]=de),ce=ie+K,ge=ce-ie,be=ce-ge,ne=K-ge,ve=ie-be,Q=ve+ne,ie=ce;for(;h<s;)G=C,H=Q,K=G+H,X=K-G,de=H-X,de&&(m[b++]=de),ce=ie+K,ge=ce-ie,be=ce-ge,ne=K-ge,ve=ie-be,Q=ve+ne,ie=ce,h+=1,h<s&&(C=n[h]);for(;S<l;)G=N,H=Q,K=G+H,X=K-G,de=H-X,de&&(m[b++]=de),ce=ie+K,ge=ce-ie,be=ce-ge,ne=K-ge,ve=ie-be,Q=ve+ne,ie=ce,S+=1,S<l&&(N=t[S]);return Q&&(m[b++]=Q),ie&&(m[b++]=ie),b||(m[b++]=0),m.length=b,m}var twoSum$1=fastTwoSum;function fastTwoSum(n,t,s){var l=n+t,f=l-n,m=l-f,b=t-f,h=n-m;return s?(s[0]=h+b,s[1]=l,s):[h+b,l]}var twoProduct=twoProduct_1,twoSum=twoSum$1,robustScale=scaleLinearExpansion;function scaleLinearExpansion(n,t){var s=n.length;if(s===1){var l=twoProduct(n[0],t);return l[0]?l:[l[1]]}var f=new Array(2*s),m=[.1,.1],b=[.1,.1],h=0;twoProduct(n[0],t,m),m[0]&&(f[h++]=m[0]);for(var S=1;S<s;++S){twoProduct(n[S],t,b);var M=m[1];twoSum(M,b[0],m),m[0]&&(f[h++]=m[0]);var C=b[1],L=m[1],N=C+L,F=N-C,G=L-F;m[1]=N,G&&(f[h++]=G)}return m[1]&&(f[h++]=m[1]),h===0&&(f[h++]=0),f.length=h,f}var robustDiff=robustSubtract;function scalarScalar(n,t){var s=n+t,l=s-n,f=s-l,m=t-l,b=n-f,h=b+m;return h?[h,s]:[s]}function robustSubtract(n,t){var s=n.length|0,l=t.length|0;if(s===1&&l===1)return scalarScalar(n[0],-t[0]);var f=s+l,m=new Array(f),b=0,h=0,S=0,M=Math.abs,C=n[h],L=M(C),N=-t[S],F=M(N),G,H;L<F?(H=C,h+=1,h<s&&(C=n[h],L=M(C))):(H=N,S+=1,S<l&&(N=-t[S],F=M(N))),h<s&&L<F||S>=l?(G=C,h+=1,h<s&&(C=n[h],L=M(C))):(G=N,S+=1,S<l&&(N=-t[S],F=M(N)));for(var K=G+H,X=K-G,de=H-X,Q=de,ie=K,ce,ge,be,ne,ve;h<s&&S<l;)L<F?(G=C,h+=1,h<s&&(C=n[h],L=M(C))):(G=N,S+=1,S<l&&(N=-t[S],F=M(N))),H=Q,K=G+H,X=K-G,de=H-X,de&&(m[b++]=de),ce=ie+K,ge=ce-ie,be=ce-ge,ne=K-ge,ve=ie-be,Q=ve+ne,ie=ce;for(;h<s;)G=C,H=Q,K=G+H,X=K-G,de=H-X,de&&(m[b++]=de),ce=ie+K,ge=ce-ie,be=ce-ge,ne=K-ge,ve=ie-be,Q=ve+ne,ie=ce,h+=1,h<s&&(C=n[h]);for(;S<l;)G=N,H=Q,K=G+H,X=K-G,de=H-X,de&&(m[b++]=de),ce=ie+K,ge=ce-ie,be=ce-ge,ne=K-ge,ve=ie-be,Q=ve+ne,ie=ce,S+=1,S<l&&(N=-t[S]);return Q&&(m[b++]=Q),ie&&(m[b++]=ie),b||(m[b++]=0),m.length=b,m}(function(n){var t=twoProduct_1,s=robustSum,l=robustScale,f=robustDiff,m=5,b=11102230246251565e-32,h=(3+16*b)*b,S=(7+56*b)*b;function M(Q,ie,ce,ge){return function(ne,ve,te){var he=Q(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0]))),Ie=Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),Oe=ge(he,Ie);return Oe[Oe.length-1]}}function C(Q,ie,ce,ge){return function(ne,ve,te,he){var Ie=Q(Q(ce(Q(ie(te[1],he[0]),ie(-he[1],te[0])),ve[2]),Q(ce(Q(ie(ve[1],he[0]),ie(-he[1],ve[0])),-te[2]),ce(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),he[2]))),Q(ce(Q(ie(ve[1],he[0]),ie(-he[1],ve[0])),ne[2]),Q(ce(Q(ie(ne[1],he[0]),ie(-he[1],ne[0])),-ve[2]),ce(Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0])),he[2])))),Oe=Q(Q(ce(Q(ie(te[1],he[0]),ie(-he[1],te[0])),ne[2]),Q(ce(Q(ie(ne[1],he[0]),ie(-he[1],ne[0])),-te[2]),ce(Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),he[2]))),Q(ce(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),ne[2]),Q(ce(Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),-ve[2]),ce(Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0])),te[2])))),tt=ge(Ie,Oe);return tt[tt.length-1]}}function L(Q,ie,ce,ge){return function(ne,ve,te,he,Ie){var Oe=Q(Q(Q(ce(Q(ce(Q(ie(he[1],Ie[0]),ie(-Ie[1],he[0])),te[2]),Q(ce(Q(ie(te[1],Ie[0]),ie(-Ie[1],te[0])),-he[2]),ce(Q(ie(te[1],he[0]),ie(-he[1],te[0])),Ie[2]))),ve[3]),Q(ce(Q(ce(Q(ie(he[1],Ie[0]),ie(-Ie[1],he[0])),ve[2]),Q(ce(Q(ie(ve[1],Ie[0]),ie(-Ie[1],ve[0])),-he[2]),ce(Q(ie(ve[1],he[0]),ie(-he[1],ve[0])),Ie[2]))),-te[3]),ce(Q(ce(Q(ie(te[1],Ie[0]),ie(-Ie[1],te[0])),ve[2]),Q(ce(Q(ie(ve[1],Ie[0]),ie(-Ie[1],ve[0])),-te[2]),ce(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),Ie[2]))),he[3]))),Q(ce(Q(ce(Q(ie(te[1],he[0]),ie(-he[1],te[0])),ve[2]),Q(ce(Q(ie(ve[1],he[0]),ie(-he[1],ve[0])),-te[2]),ce(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),he[2]))),-Ie[3]),Q(ce(Q(ce(Q(ie(he[1],Ie[0]),ie(-Ie[1],he[0])),ve[2]),Q(ce(Q(ie(ve[1],Ie[0]),ie(-Ie[1],ve[0])),-he[2]),ce(Q(ie(ve[1],he[0]),ie(-he[1],ve[0])),Ie[2]))),ne[3]),ce(Q(ce(Q(ie(he[1],Ie[0]),ie(-Ie[1],he[0])),ne[2]),Q(ce(Q(ie(ne[1],Ie[0]),ie(-Ie[1],ne[0])),-he[2]),ce(Q(ie(ne[1],he[0]),ie(-he[1],ne[0])),Ie[2]))),-ve[3])))),Q(Q(ce(Q(ce(Q(ie(ve[1],Ie[0]),ie(-Ie[1],ve[0])),ne[2]),Q(ce(Q(ie(ne[1],Ie[0]),ie(-Ie[1],ne[0])),-ve[2]),ce(Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0])),Ie[2]))),he[3]),Q(ce(Q(ce(Q(ie(ve[1],he[0]),ie(-he[1],ve[0])),ne[2]),Q(ce(Q(ie(ne[1],he[0]),ie(-he[1],ne[0])),-ve[2]),ce(Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0])),he[2]))),-Ie[3]),ce(Q(ce(Q(ie(te[1],he[0]),ie(-he[1],te[0])),ve[2]),Q(ce(Q(ie(ve[1],he[0]),ie(-he[1],ve[0])),-te[2]),ce(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),he[2]))),ne[3]))),Q(ce(Q(ce(Q(ie(te[1],he[0]),ie(-he[1],te[0])),ne[2]),Q(ce(Q(ie(ne[1],he[0]),ie(-he[1],ne[0])),-te[2]),ce(Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),he[2]))),-ve[3]),Q(ce(Q(ce(Q(ie(ve[1],he[0]),ie(-he[1],ve[0])),ne[2]),Q(ce(Q(ie(ne[1],he[0]),ie(-he[1],ne[0])),-ve[2]),ce(Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0])),he[2]))),te[3]),ce(Q(ce(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),ne[2]),Q(ce(Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),-ve[2]),ce(Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0])),te[2]))),-he[3]))))),tt=Q(Q(Q(ce(Q(ce(Q(ie(he[1],Ie[0]),ie(-Ie[1],he[0])),te[2]),Q(ce(Q(ie(te[1],Ie[0]),ie(-Ie[1],te[0])),-he[2]),ce(Q(ie(te[1],he[0]),ie(-he[1],te[0])),Ie[2]))),ne[3]),ce(Q(ce(Q(ie(he[1],Ie[0]),ie(-Ie[1],he[0])),ne[2]),Q(ce(Q(ie(ne[1],Ie[0]),ie(-Ie[1],ne[0])),-he[2]),ce(Q(ie(ne[1],he[0]),ie(-he[1],ne[0])),Ie[2]))),-te[3])),Q(ce(Q(ce(Q(ie(te[1],Ie[0]),ie(-Ie[1],te[0])),ne[2]),Q(ce(Q(ie(ne[1],Ie[0]),ie(-Ie[1],ne[0])),-te[2]),ce(Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),Ie[2]))),he[3]),ce(Q(ce(Q(ie(te[1],he[0]),ie(-he[1],te[0])),ne[2]),Q(ce(Q(ie(ne[1],he[0]),ie(-he[1],ne[0])),-te[2]),ce(Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),he[2]))),-Ie[3]))),Q(Q(ce(Q(ce(Q(ie(te[1],Ie[0]),ie(-Ie[1],te[0])),ve[2]),Q(ce(Q(ie(ve[1],Ie[0]),ie(-Ie[1],ve[0])),-te[2]),ce(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),Ie[2]))),ne[3]),ce(Q(ce(Q(ie(te[1],Ie[0]),ie(-Ie[1],te[0])),ne[2]),Q(ce(Q(ie(ne[1],Ie[0]),ie(-Ie[1],ne[0])),-te[2]),ce(Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),Ie[2]))),-ve[3])),Q(ce(Q(ce(Q(ie(ve[1],Ie[0]),ie(-Ie[1],ve[0])),ne[2]),Q(ce(Q(ie(ne[1],Ie[0]),ie(-Ie[1],ne[0])),-ve[2]),ce(Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0])),Ie[2]))),te[3]),ce(Q(ce(Q(ie(ve[1],te[0]),ie(-te[1],ve[0])),ne[2]),Q(ce(Q(ie(ne[1],te[0]),ie(-te[1],ne[0])),-ve[2]),ce(Q(ie(ne[1],ve[0]),ie(-ve[1],ne[0])),te[2]))),-Ie[3])))),it=ge(Oe,tt);return it[it.length-1]}}function N(Q){var ie=Q===3?M:Q===4?C:L;return ie(s,t,l,f)}var F=N(3),G=N(4),H=[function(){return 0},function(){return 0},function(ie,ce){return ce[0]-ie[0]},function(ie,ce,ge){var be=(ie[1]-ge[1])*(ce[0]-ge[0]),ne=(ie[0]-ge[0])*(ce[1]-ge[1]),ve=be-ne,te;if(be>0){if(ne<=0)return ve;te=be+ne}else if(be<0){if(ne>=0)return ve;te=-(be+ne)}else return ve;var he=h*te;return ve>=he||ve<=-he?ve:F(ie,ce,ge)},function(ie,ce,ge,be){var ne=ie[0]-be[0],ve=ce[0]-be[0],te=ge[0]-be[0],he=ie[1]-be[1],Ie=ce[1]-be[1],Oe=ge[1]-be[1],tt=ie[2]-be[2],it=ce[2]-be[2],Ct=ge[2]-be[2],Rt=ve*Oe,xt=te*Ie,Vt=te*he,It=ne*Oe,Xt=ne*Ie,Jt=ve*he,nt=tt*(Rt-xt)+it*(Vt-It)+Ct*(Xt-Jt),mt=(Math.abs(Rt)+Math.abs(xt))*Math.abs(tt)+(Math.abs(Vt)+Math.abs(It))*Math.abs(it)+(Math.abs(Xt)+Math.abs(Jt))*Math.abs(Ct),ft=S*mt;return nt>ft||-nt>ft?nt:G(ie,ce,ge,be)}];function K(Q){var ie=H[Q.length];return ie||(ie=H[Q.length]=N(Q.length)),ie.apply(void 0,Q)}function X(Q,ie,ce,ge,be,ne,ve){return function(he,Ie,Oe,tt,it){switch(arguments.length){case 0:case 1:return 0;case 2:return ge(he,Ie);case 3:return be(he,Ie,Oe);case 4:return ne(he,Ie,Oe,tt);case 5:return ve(he,Ie,Oe,tt,it)}for(var Ct=new Array(arguments.length),Rt=0;Rt<arguments.length;++Rt)Ct[Rt]=arguments[Rt];return Q(Ct)}}function de(){for(;H.length<=m;)H.push(N(H.length));n.exports=X.apply(void 0,[K].concat(H));for(var Q=0;Q<=m;++Q)n.exports[Q]=H[Q]}de()})(orientation);var robustPnp=robustPointInPolygon,orient=orientation.exports;function robustPointInPolygon(n,t){for(var s=t[0],l=t[1],f=n.length,m=1,b=f,h=0,S=f-1;h<b;S=h++){var M=n[h],C=n[S],L=M[1],N=C[1];if(N<L){if(N<l&&l<L){var F=orient(M,C,t);if(F===0)return 0;m^=0<F|0}else if(l===L){var G=n[(h+1)%f],H=G[1];if(L<H){var F=orient(M,C,t);if(F===0)return 0;m^=0<F|0}}}else if(L<N){if(L<l&&l<N){var F=orient(M,C,t);if(F===0)return 0;m^=F<0|0}else if(l===L){var G=n[(h+1)%f],H=G[1];if(H<L){var F=orient(M,C,t);if(F===0)return 0;m^=F<0|0}}}else if(l===L){var K=Math.min(M[0],C[0]),X=Math.max(M[0],C[0]);if(h===0){for(;S>0;){var de=(S+f-1)%f,Q=n[de];if(Q[1]!==l)break;var ie=Q[0];K=Math.min(K,ie),X=Math.max(X,ie),S=de}if(S===0)return K<=s&&s<=X?0:1;b=S+1}for(var ce=n[(S+f-1)%f][1];h+1<b;){var Q=n[h+1];if(Q[1]!==l)break;var ie=Q[0];K=Math.min(K,ie),X=Math.max(X,ie),h+=1}if(K<=s&&s<=X)return 0;var ge=n[(h+1)%f][1];s<K&&ce<l!=ge<l&&(m^=1)}}return 2*m-1}var robustPointInPolygon$1=robustPnp;function feretDiameters(n={}){const{originalPoints:t=monotoneChainConvexHull.call(this)}=n;if(t.length===0)return{min:0,max:0,minLine:[],maxLine:[],aspectRatio:1};if(t.length===1)return{min:1,max:1,minLine:[t[0],t[0]],maxLine:[t[0],t[0]],aspectRatio:1};const s=new Array(t.length);let l=1/0,f=0,m=[];for(let M=0;M<t.length;M++){let C=getAngle(t[M],t[(M+1)%t.length]);rotate(-C,t,s);let L=0,N=[];for(let F=0;F<t.length;F++){let G=Math.abs(s[M][1]-s[F][1]);G>L&&(L=G,N=[],N.push([s[F][0],s[M][1]],[s[F][0],s[F][1]]))}L<l&&(l=L,f=C,m=N)}rotate(f,m,m);let b=0,h=[],S=0;for(let M=0;M<t.length-1;M++)for(let C=M+1;C<t.length;C++){let L=(t[M][0]-t[C][0])**2+(t[M][1]-t[C][1])**2;L>S&&(S=L,b=Math.sqrt(L),h=[t[M],t[C]])}return{min:l,minLine:m,max:b,maxLine:h,aspectRatio:l/b}}function getAngle(n,t){let s=difference(t,n),l=normalize(s),f=Math.acos(l[0]);return l[1]<0?-f:f}class Roi{constructor(t,s){this.map=t,this.id=s,this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.meanX=0,this.meanY=0,this.surface=0,this.computed={}}getMask(t={}){const{scale:s=1,kind:l=""}=t;let f;switch(l){case"contour":f=this.contourMask;break;case"box":f=this.boxMask;break;case"filled":f=this.filledMask;break;case"center":f=this.centerMask;break;case"mbr":f=this.mbrFilledMask;break;case"hull":f=this.convexHullFilledMask;break;case"hullContour":f=this.convexHullMask;break;case"mbrContour":f=this.mbrMask;break;case"feret":f=this.feretMask;break;default:f=this.mask}return s<1&&(f=f.resize({factor:s}),f.parent=this.mask.parent,f.position[0]+=this.minX,f.position[1]+=this.minY),f}get mean(){throw new Error("Roi mean not implemented yet")}get center(){return this.computed.center||(this.computed.center=[this.width/2>>0,this.height/2>>0]),this.computed.center}get ratio(){return this.width/this.height}get width(){return this.maxX-this.minX+1}get height(){return this.maxY-this.minY+1}_computExternalIDs(){let t=this.borderIDs,s=this.borderLengths;this.computed.externalIDs=[],this.computed.externalLengths=[];let l=this.internalIDs;for(let f=0;f<t.length;f++)l.includes(t[f])||(this.computed.externalIDs.push(t[f]),this.computed.externalLengths.push(s[f]))}get externalIDs(){return this.computed.externalIDs?this.computed.externalIDs:(this._computExternalIDs(),this.computed.externalIDs)}get externalLengths(){return this.computed.externalLengths?this.computed.externalLengths:(this._computExternalIDs(),this.computed.externalLengths)}_computeBorderIDs(){let t=getBorders(this);this.computed.borderIDs=t.ids,this.computed.borderLengths=t.lengths}get borderIDs(){return this.computed.borderIDs?this.computed.borderIDs:(this._computeBorderIDs(),this.computed.borderIDs)}get borderLengths(){return this.computed.borderLengths?this.computed.borderLengths:(this._computeBorderIDs(),this.computed.borderLengths)}get boxIDs(){return this.computed.boxIDs||(this.computed.boxIDs=getBoxIDs(this)),this.computed.boxIDs}get internalIDs(){return this.computed.internalIDs||(this.computed.internalIDs=getInternalIDs(this)),this.computed.internalIDs}get box(){return this.computed.box||(this.computed.box=getBox(this)),this.computed.box}get external(){return this.computed.external||(this.computed.external=getExternal(this)),this.computed.external}get holesInfo(){return this.computed.holesInfo||(this.computed.holesInfo=getHolesInfo(this)),this.computed.holesInfo}get border(){return this.computed.border||(this.computed.border=getBorder(this)),this.computed.border}get contourMask(){if(!this.computed.contourMask){let t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let s=0;s<this.width;s++)for(let l=0;l<this.height;l++)this.map.data[s+this.minX+(l+this.minY)*this.map.width]===this.id&&(s>0&&s<this.width-1&&l>0&&l<this.height-1?(this.map.data[s-1+this.minX+(l+this.minY)*this.map.width]!==this.id||this.map.data[s+1+this.minX+(l+this.minY)*this.map.width]!==this.id||this.map.data[s+this.minX+(l-1+this.minY)*this.map.width]!==this.id||this.map.data[s+this.minX+(l+1+this.minY)*this.map.width]!==this.id)&&t.setBitXY(s,l):t.setBitXY(s,l));this.computed.contourMask=t}return this.computed.contourMask}get boxMask(){if(!this.computed.boxMask){let t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let s=0;s<this.width;s++)t.setBitXY(s,0),t.setBitXY(s,this.height-1);for(let s=0;s<this.height;s++)t.setBitXY(0,s),t.setBitXY(this.width-1,s);this.computed.boxMask=t}return this.computed.boxMask}get mask(){if(!this.computed.mask){let t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let s=0;s<this.width;s++)for(let l=0;l<this.height;l++)this.map.data[s+this.minX+(l+this.minY)*this.map.width]===this.id&&t.setBitXY(s,l);this.computed.mask=t}return this.computed.mask}get filledMask(){if(!this.computed.filledMask){let t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let s=0;s<this.width;s++)for(let l=0;l<this.height;l++){let f=s+this.minX+(l+this.minY)*this.map.width;this.internalIDs.includes(this.map.data[f])&&t.setBitXY(s,l)}this.computed.filledMask=t}return this.computed.filledMask}get centerMask(){if(!this.computed.centerMask){let t=new Shape({kind:"smallCross"}).getMask();t.parent=this.map.parent,t.position=[this.minX+this.center[0]-1,this.minY+this.center[1]-1],this.computed.centerMask=t}return this.computed.centerMask}get convexHull(){if(!this.computed.convexHull){const t=[];for(let l=0;l<this.width;l++)for(let f=0;f<this.height;f++)this.map.data[l+this.minX+(f+this.minY)*this.map.width]===this.id&&(l>0&&l<this.width-1&&f>0&&f<this.height-1?(this.map.data[l-1+this.minX+(f+this.minY)*this.map.width]!==this.id||this.map.data[l+1+this.minX+(f+this.minY)*this.map.width]!==this.id||this.map.data[l+this.minX+(f-1+this.minY)*this.map.width]!==this.id||this.map.data[l+this.minX+(f+1+this.minY)*this.map.width]!==this.id)&&(t.push([l,f]),t.push([l+1,f]),t.push([l,f+1]),t.push([l+1,f+1])):(t.push([l,f]),t.push([l+1,f]),t.push([l,f+1]),t.push([l+1,f+1])));const s=monotoneChainConvexHull$1(t);this.computed.convexHull={polyline:s,surface:surface(s),perimeter:perimeter(s)}}return this.computed.convexHull}get convexHullMask(){if(!this.computed.convexHullMask){const t=this.convexHull,s=new Image$1(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});s.paintPolyline(t.polyline,{closed:!0}),this.computed.convexHullMask=s}return this.computed.convexHullMask}get convexHullFilledMask(){if(!this.computed.convexHullFilledMask){const t=this.convexHull,s=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let l=0;l<this.width;l++)for(let f=0;f<this.height;f++)robustPointInPolygon$1(t.polyline,[l,f])!==1&&s.setBitXY(l,f);this.computed.convexHullFilledMask=s}return this.computed.convexHullFilledMask}get mbr(){if(!this.computed.mbr){let t=minimalBoundingRectangle({originalPoints:this.convexHull.polyline});if(t.length===0)this.computed.mbr={width:0,height:0,surface:0,perimeter:0,rectangle:t};else{let s=t[0],l=t[1],f=t[2],m=Math.sqrt((s[0]-l[0])**2+(s[1]-l[1])**2),b=Math.sqrt((f[0]-l[0])**2+(f[1]-l[1])**2);this.computed.mbr={width:m,height:b,elongation:1-m/b,aspectRatio:m/b,surface:m*b,perimeter:(m+b)*2,rectangle:t}}}return this.computed.mbr}get fillRatio(){return this.surface/(this.surface+this.holesInfo.surface)}get feretDiameters(){return this.computed.feretDiameters||(this.computed.feretDiameters=feretDiameters({originalPoints:this.convexHull.polyline})),this.computed.feretDiameters}get eqpc(){return this.computed.eqpc||(this.computed.eqpc=2*Math.sqrt(this.surface/Math.PI)),this.computed.eqpc}get perimeterInfo(){return this.computed.perimeterInfo||(this.computed.perimeterInfo=getPerimeterInfo(this)),this.computed.perimeterInfo}get perimeter(){let t=this.perimeterInfo,s=2-Math.sqrt(2);return t.one+t.two*2+t.three*3+t.four*4-s*(t.two+t.three*2+t.four)}get ped(){return this.computed.ped||(this.computed.ped=this.perimeter/Math.PI),this.computed.ped}get feretMask(){if(!this.computed.feretMask){const t=new Image$1(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});t.paintPolyline(this.feretDiameters.minLine),t.paintPolyline(this.feretDiameters.maxLine),this.computed.feretMask=t}return this.computed.feretMask}get mbrMask(){if(!this.computed.mbrMask){let t=round(this.mbr.rectangle);if(t.length>0){const s=minMax(t),l=new Image$1(s[1][0]-s[0][0]+1,s[1][1]-s[0][1]+1,{kind:BINARY,position:[this.minX+s[0][0],this.minY+s[0][1]],parent:this.map.parent});t=moveToZeroZero(t),l.paintPolyline(t,{closed:!0}),this.computed.mbrMask=l}else this.computed.mbrMask=new Image$1(1,1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent})}return this.computed.mbrMask}get mbrFilledMask(){if(!this.computed.mbrFilledMask){const t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),s=this.mask.minimalBoundingRectangle();for(let l=0;l<this.width;l++)for(let f=0;f<this.height;f++)robustPointInPolygon$1(s,[l,f])!==1&&t.setBitXY(l,f);this.computed.mbrFilledMask=t}return this.computed.mbrFilledMask}get points(){if(!this.computed.points){let t=[];for(let s=0;s<this.height;s++)for(let l=0;l<this.width;l++){let f=(s+this.minY)*this.map.width+l+this.minX;this.map.data[f]===this.id&&t.push([l,s])}this.computed.points=t}return this.computed.points}get maxLengthPoints(){if(!this.computed.maxLengthPoints){let t=0,s;const l=this.points;for(let f=0;f<l.length;f++)for(let m=f+1;m<l.length;m++){let b=Math.pow(l[f][0]-l[m][0],2)+Math.pow(l[f][1]-l[m][1],2);b>=t&&(t=b,s=[l[f],l[m]])}this.computed.maxLengthPoints=s}return this.computed.maxLengthPoints}get maxLength(){if(!this.computed.maxLength){let t=Math.sqrt(Math.pow(this.maxLengthPoints[0][0]-this.maxLengthPoints[1][0],2)+Math.pow(this.maxLengthPoints[0][1]-this.maxLengthPoints[1][1],2));this.computed.maxLength=t}return this.computed.maxLength}get roundness(){return 4*this.surface/(Math.PI*this.feretDiameters.max**2)}get sphericity(){return 2*Math.sqrt(this.surface*Math.PI)/this.perimeter}get solidity(){return this.surface/this.convexHull.surface}get angle(){if(!this.computed.angle){let t=this.maxLengthPoints,s=-Math.atan2(t[0][1]-t[1][1],t[0][0]-t[1][0])*180/Math.PI;this.computed.angle=s}return this.computed.angle}toJSON(){return{id:this.id,minX:this.minX,maxX:this.maxX,minY:this.minY,maxY:this.maxY,meanX:this.meanX,meanY:this.meanY,height:this.height,width:this.width,surface:this.surface,mbrWidth:this.mbr.width,mbrHeight:this.mbr.height,mbrSurface:this.mbr.surface,eqpc:this.eqpc,ped:this.ped,feretDiameterMin:this.feretDiameters.min,feretDiameterMax:this.feretDiameters.max,aspectRatio:this.feretDiameters.aspectRatio,fillRatio:this.fillRatio,sphericity:this.sphericity,roundness:this.roundness,solidity:this.solidity,perimeter:this.perimeter}}}function getBorders(n){let t=n.map,s=t.data,l=new Set,f=new Map,m=new Set,b=[1,0,-1,0],h=[0,1,0,-1];for(let C=n.minX;C<=n.maxX;C++)for(let L=n.minY;L<=n.maxY;L++){let N=C+L*t.width;if(s[N]===n.id)for(let F=0;F<4;F++){let G=C+b[F],H=L+h[F];if(G>=0&&H>=0&&G<t.width&&H<t.height){let K=G+H*t.width;if(s[K]!==n.id&&!m.has(K)){m.add(K),l.add(s[K]);let X=f.get(s[K]);X?f.set(s[K],++X):f.set(s[K],1)}}}}let S=Array.from(l),M=S.map(function(C){return f.get(C)});return{ids:S,lengths:M}}function getBoxIDs(n){let t=new Set,s=n.map,l=s.data;for(let f of[0,n.height-1])for(let m=0;m<n.width;m++){let b=(f+n.minY)*s.width+m+n.minX;if(m-n.minX>0&&l[b]===n.id&&l[b-1]!==n.id){let h=l[b-1];t.add(h)}if(s.width-m-n.minX>1&&l[b]===n.id&&l[b+1]!==n.id){let h=l[b+1];t.add(h)}}for(let f of[0,n.width-1])for(let m=0;m<n.height;m++){let b=(m+n.minY)*s.width+f+n.minX;if(m-n.minY>0&&l[b]===n.id&&l[b-s.width]!==n.id){let h=l[b-s.width];t.add(h)}if(s.height-m-n.minY>1&&l[b]===n.id&&l[b+s.width]!==n.id){let h=l[b+s.width];t.add(h)}}return Array.from(t)}function getBox(n){let t=0,s=n.map,l=s.data,f=[0];n.height>1&&(f[1]=n.height-1);for(let b of f)for(let h=1;h<n.width-1;h++){let S=(b+n.minY)*s.width+h+n.minX;l[S]===n.id&&t++}let m=[0];n.width>1&&(m[1]=n.width-1);for(let b of m)for(let h=0;h<n.height;h++){let S=(h+n.minY)*s.width+b+n.minX;l[S]===n.id&&t++}return t}function getBorder(n){let t=0,s=n.map,l=s.data;for(let f=1;f<n.width-1;f++)for(let m=1;m<n.height-1;m++){let b=(m+n.minY)*s.width+f+n.minX;l[b]===n.id&&(l[b-1]!==n.id||l[b+1]!==n.id||l[b-s.width]!==n.id||l[b+s.width]!==n.id)&&t++}return t+n.box}function getPerimeterInfo(n){let t=n.map,s=t.data,l=0,f=0,m=0,b=0;for(let h=0;h<n.width;h++)for(let S=0;S<n.height;S++){let M=(S+n.minY)*t.width+h+n.minX;if(s[M]===n.id){let C=0;switch((h===0||n.externalIDs.includes(s[M-1]))&&C++,(h===n.width-1||n.externalIDs.includes(s[M+1]))&&C++,(S===0||n.externalIDs.includes(s[M-t.width]))&&C++,(S===n.height-1||n.externalIDs.includes(s[M+t.width]))&&C++,C){case 1:l++;break;case 2:f++;break;case 3:m++;break;case 4:b++;break}}}return{one:l,two:f,three:m,four:b}}function getExternal(n){let t=0,s=n.map,l=s.data;for(let f=1;f<n.width-1;f++)for(let m=1;m<n.height-1;m++){let b=(m+n.minY)*s.width+f+n.minX;l[b]===n.id&&(n.externalIDs.includes(l[b-1])||n.externalIDs.includes(l[b+1])||n.externalIDs.includes(l[b-s.width])||n.externalIDs.includes(l[b+s.width]))&&t++}return t+n.box}function getHolesInfo(n){let t=0,s=n.map.width,l=n.map.data;for(let f=1;f<n.width-1;f++)for(let m=1;m<n.height-1;m++){let b=(m+n.minY)*s+f+n.minX;n.internalIDs.includes(l[b])&&l[b]!==n.id&&t++}return{number:n.internalIDs.length-1,surface:t}}function getInternalIDs(n){let t=[n.id],s=n.map,l=s.data;if(n.height>2)for(let m=0;m<n.width;m++){let b=n.minY*s.width+m+n.minX;if(t.includes(l[b])){let h=l[b+s.width];!t.includes(h)&&!n.boxIDs.includes(h)&&t.push(h)}}let f=new Array(4);for(let m=1;m<n.width-1;m++)for(let b=1;b<n.height-1;b++){let h=(b+n.minY)*s.width+m+n.minX;if(t.includes(l[h])){f[0]=l[h-1],f[1]=l[h+1],f[2]=l[h-s.width],f[3]=l[h+s.width];for(let S=0;S<4;S++){let M=f[S];!t.includes(M)&&!n.boxIDs.includes(M)&&t.push(M)}}}return t}class RoiLayer{constructor(t,s){this.roiMap=t,this.options=s,this.roi=this.createRoi()}createRoi(){let t=this.roiMap.data,s={};this.roiMap.positive=0,this.roiMap.negative=0;for(let h=0;h<t.length;h++)t[h]&&!s[t[h]]&&(s[t[h]]=!0,t[h]>0?this.roiMap.positive++:this.roiMap.negative++);let l={};for(let h in s)l[h]=new Roi(this.roiMap,h*1);let f=this.roiMap.width,m=this.roiMap.height;for(let h=0;h<m;h++)for(let S=0;S<f;S++){let M=h*f+S;if(t[M]!==0){const C=t[M],L=l[C];S<L.minX&&(L.minX=S),S>L.maxX&&(L.maxX=S),h<L.minY&&(L.minY=h),h>L.maxY&&(L.maxY=h),L.meanX+=S,L.meanY+=h,L.surface++}}let b=[];for(let h in s)l[h].meanX/=l[h].surface,l[h].meanY/=l[h].surface,b.push(l[h]);return b}}function commonBorderLength(n){let t=n.data,s=[1,0,-1,0],l=[0,1,0,-1],f=n.minMax,m=-f.min,b=f.max+m,h=[];for(let M=0;M<=b;M++)h.push(Object.create(null));for(let M=0;M<n.width;M++)for(let C=0;C<n.height;C++){let L=M+C*n.width,N=t[L];if(N!==0){let F=Object.create(null),G=!1;for(let H=0;H<4;H++){let K=M+s[H],X=C+l[H];if(K>=0&&X>=0&&K<n.width&&X<n.height){let de=t[K+X*n.width];N!==de&&(G=!0,de!==0&&F[de]===void 0&&(F[de]=!0,h[de+m][N]?h[de+m][N]++:h[de+m][N]=1))}else G=!0}G&&(h[N+m][N]?h[N+m][N]++:h[N+m][N]=1)}}let S={};for(let M=0;M<h.length;M++)Object.keys(h[M]).length>0&&(S[M-m]=h[M]);return S}function mergeRoi(n={}){const{algorithm:t="commonBorderLength",minCommonBorderLength:s=5,maxCommonBorderLength:l=100,minCommonBorderRatio:f=.3,maxCommonBorderRatio:m=1}=n;let b=function(K,X,de){return K[de]>=s&&K[de]<=l};typeof t=="function"&&(b=t),t.toLowerCase()==="commonborderratio"&&(b=function(K,X,de){let Q=Math.min(K[de]/K[X],1);return Q>=f&&Q<=m});const h=this,S=h.commonBorderLength;let M={},C={};for(let K of Object.keys(S)){let X=S[K],de=Object.keys(X);for(let Q of de)if(Q!==K&&b(X,K,Q)){let ie=Q;C[Q]&&(ie=C[Q]);let ce=K;if(C[K]&&(ce=C[K]),Number(ie)!==ce){let ge=Math.min(ie,ce),be=Math.max(ie,ce);if(M[ge]||(M[ge]={}),M[ge][be]=!0,C[be]=ge,M[be]){for(let ne of Object.keys(M[be]))M[ge][ne]=!0,C[ne]=ge;delete M[be]}}}}let L=h.minMax,N=-L.min,F=L.max+N,G=new Array(F+1).fill(0);for(let K of Object.keys(C))G[Number(K)+N]=C[K];let H=h.data;for(let K=0;K<H.length;K++){let X=H[K];if(X!==0){let de=G[X+N];de!==0&&(H[K]=de)}}return h.computed={},h}class RoiMap{constructor(t,s){this.parent=t,this.width=t.width,this.height=t.height,this.data=s,this.negative=0,this.positive=0}get total(){return this.negative+this.positive}get minMax(){let t=Number.MAX_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;for(let l=0;l<this.data.length;l++)this.data[l]<t&&(t=this.data[l]),this.data[l]>s&&(s=this.data[l]);return{min:t,max:s}}get commonBorderLength(){return commonBorderLength(this)}mergeRoi(t={}){return mergeRoi.call(this,t)}mergeRois(t){const s=t[0],l=t.slice(1);for(let f=0;f<this.data.length;f++)l.includes(this.data[f])&&(this.data[f]=s)}rowsInfo(){let t=new Array(this.height),s=0;for(let l=0;l<this.data.length;l+=this.width){let f={row:s,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};t[s++]=f;let m={},b={},h=[],S=this.data[l],M=0;for(let C=l;C<l+this.width;C++){let L=this.data[C];S!==L&&(S=L,h.push(M),M=0),M++,L>0?(f.positivePixel++,m[L]||(m[L]=!0)):L<0?(f.negativePixel++,b[L]||(b[L]=!0)):f.zeroPixel++}h.push(M),f.medianChange=h.sort((C,L)=>C-L)[Math.floor(h.length/2)],f.positiveRoiIDs=Object.keys(m),f.negativeRoiIDs=Object.keys(b),f.positiveRoi=f.positiveRoiIDs.length,f.negativeRoi=f.negativeRoiIDs.length}return t}colsInfo(){let t=new Array(this.width),s=0;for(let l=0;l<this.width;l++){let f={col:s,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};t[s++]=f;let m={},b={},h=[],S=this.data[l],M=0;for(let C=l;C<l+this.data.length;C+=this.width){let L=this.data[C];S!==L&&(S=L,h.push(M),M=0),M++,L>0?(f.positivePixel++,m[L]||(m[L]=!0)):L<0?(f.negativePixel++,b[L]||(b[L]=!0)):f.zeroPixel++}h.push(M),f.medianChange=h.sort((C,L)=>C-L)[Math.floor(h.length/2)],f.positiveRoiIDs=Object.keys(m),f.negativeRoiIDs=Object.keys(b),f.positiveRoi=f.positiveRoiIDs.length,f.negativeRoi=f.negativeRoiIDs.length}return t}}function fromMask(n,t={}){const{allowCorners:s=!1}=t,l=65535;let f=new Int16Array(n.size),m=0,b=0,h=new Uint16Array(l+1),S=new Uint16Array(l+1);for(let C=0;C<n.width;C++)for(let L=0;L<n.height;L++)f[L*n.width+C]===0&&M(C,L);function M(C,L){let N=0,F=0,G=n.getBitXY(C,L),H=G?++m:--b;if(m>32767||b<-32768)throw new Error("Too many regions of interest");for(h[0]=C,S[0]=L;N<=F;){let K=h[N&l],X=S[N&l];if(f[X*n.width+K]=H,K>0&&f[X*n.width+K-1]===0&&n.getBitXY(K-1,X)===G&&(F++,h[F&l]=K-1,S[F&l]=X,f[X*n.width+K-1]=-32768),X>0&&f[(X-1)*n.width+K]===0&&n.getBitXY(K,X-1)===G&&(F++,h[F&l]=K,S[F&l]=X-1,f[(X-1)*n.width+K]=-32768),K<n.width-1&&f[X*n.width+K+1]===0&&n.getBitXY(K+1,X)===G&&(F++,h[F&l]=K+1,S[F&l]=X,f[X*n.width+K+1]=-32768),X<n.height-1&&f[(X+1)*n.width+K]===0&&n.getBitXY(K,X+1)===G&&(F++,h[F&l]=K,S[F&l]=X+1,f[(X+1)*n.width+K]=-32768),s&&(K>0&&X>0&&f[(X-1)*n.width+K-1]===0&&n.getBitXY(K-1,X-1)===G&&(F++,h[F&l]=K-1,S[F&l]=X-1,f[(X-1)*n.width+K-1]=-32768),K<n.width-1&&X>0&&f[(X-1)*n.width+K+1]===0&&n.getBitXY(K+1,X-1)===G&&(F++,h[F&l]=K+1,S[F&l]=X-1,f[(X-1)*n.width+K+1]=-32768),K>0&&X<n.height-1&&f[(X+1)*n.width+K-1]===0&&n.getBitXY(K-1,X+1)===G&&(F++,h[F&l]=K-1,S[F&l]=X+1,f[(X+1)*n.width+K-1]=-32768),K<n.width-1&&X<n.height-1&&f[(X+1)*n.width+K+1]===0&&n.getBitXY(K+1,X+1)===G&&(F++,h[F&l]=K+1,S[F&l]=X+1,f[(X+1)*n.width+K+1]=-32768)),N++,F-N>l)throw new Error("analyseMask can not finish, the array to manage internal data is not big enough.You could improve mask by changing MAX_ARRAY")}}return new RoiMap(n,f)}class DisjointSet{constructor(){this.nodes=new Map}add(t){var s=this.nodes.get(t);return s||(s=new DisjointSetNode(t),this.nodes.set(t,s)),s}union(t,s){const l=this.find(t),f=this.find(s);l!==f&&(l.rank<f.rank?l.parent=f:l.rank>f.rank?f.parent=l:(f.parent=l,l.rank++))}find(t){for(var s=t;s.parent!==null;)s=s.parent;for(var l=t;l.parent!==null;){var f=l;l=l.parent,f.parent=s}return s}connected(t,s){return this.find(t)===this.find(s)}}var DisjointSet_1=DisjointSet;function DisjointSetNode(n){this.value=n,this.parent=null,this.rank=0}var DisjointSet$1=DisjointSet_1;const direction4X=[-1,0],direction4Y=[0,-1],neighbours4=[null,null],direction8X=[-1,-1,0,1],direction8Y=[0,-1,-1,-1],neighbours8=[null,null,null,null];function fromMaskConnectedComponentLabelingAlgorithm(n,t={}){const{allowCorners:s=!1}=t;let l=4;s&&(l=8);let f,m,b;if(l===8)f=direction8X,m=direction8Y,b=neighbours8;else if(l===4)f=direction4X,m=direction4Y,b=neighbours4;else throw new RangeError(`unsupported neighbours count: ${l}`);const h=n.size,S=n.width,M=n.height,C=new Array(h),L=new Uint32Array(h),N=new DisjointSet$1;let F=1;for(let G=0;G<M;G++)for(let H=0;H<S;H++){const K=H+G*S;if(n.getBit(K)){let X=null;for(let de=0;de<b.length;de++){const Q=H+f[de],ie=G+m[de];if(Q>=0&&ie>=0&&Q<S&&ie<M){const ce=Q+ie*S;let ge=C[ce];ge?(b[de]=ge,(!X||b[de].value<X.value)&&(X=b[de])):b[de]=null}}if(!X)C[K]=N.add(F++);else{C[K]=X;for(let de=0;de<b.length;de++)b[de]&&b[de]!==X&&N.union(X,b[de])}}}for(let G=0;G<M;G++)for(let H=0;H<S;H++){const K=H+G*S;n.getBit(K)&&(L[K]=N.find(C[K]).value)}return new RoiMap(n,L)}function fromMaxima(n={}){let{allowCorner:t=!0,onlyTop:s=!1,invert:l=!1}=n,f=this;f.checkProcessable("fromMaxima",{components:[1]});const m=1,b=2;let h=0,S=0,M=new Int16Array(f.size),C=new Int8Array(f.size),L=new Float32Array(f.size),N=1048575,F=new Uint16Array(N+1),G=new Uint16Array(N+1),H=0,K=0,X=new Uint16Array(N+1),de=new Uint16Array(N+1),Q=0,ie=0;for(ce(f);H<K;){let ne=F[H&N],ve=G[H&N];be(ne,ve,b),H++}return new RoiMap(f,M);function ce({maxima:ne=!0}){for(let ve=1;ve<f.height-1;ve++)for(let te=1;te<f.width-1;te++){let he=te+ve*f.width;if(C[he]===0){let Ie=ne?f.data[he]:-f.data[te+ve*f.width];if(f.data[ve*f.width+te-1]>Ie||f.data[ve*f.width+te+1]>Ie||f.data[(ve-1)*f.width+te]>Ie||f.data[(ve+1)*f.width+te]>Ie||t&&(f.data[(ve-1)*f.width+te-1]>Ie||f.data[(ve-1)*f.width+te+1]>Ie||f.data[(ve+1)*f.width+te-1]>Ie||f.data[(ve+1)*f.width+te+1]>Ie))continue;M[he]=ne?++h:--S,ge(te,ve)||(ne?--h:++S)}}}function ge(ne,ve){let te=K;Q=0,ie=1,X[0]=ne,de[0]=ve;let he=!0;for(;Q<ie;){let Ie=X[Q&N],Oe=de[Q&N];he&=be(Ie,Oe,m),Q++}if(!he){for(let Ie=0;Ie<ie;Ie++){let Oe=X[Ie&N],it=de[Ie&N]*f.width+Oe;M[it]=0}K=te}return he}function be(ne,ve,te){let he=M[ve*f.width+ne],Ie=f.data[ve*f.width+ne];for(let Oe=ve-1;Oe<=ve+1;Oe++)for(let tt=ne-1;tt<=ne+1;tt++){let it=Oe*f.width+tt;if(C[it]===0)switch(C[it]=1,L[it]=f.data[it]-Ie,te){case m:if(L[it]===0){if(tt===0||Oe===0||tt===f.width-1||Oe===f.height-1)return!1;M[it]=he,X[ie&N]=tt,de[ie&N]=Oe,ie++}else{if(L[it]>0)return!1;s||(M[it]=he,F[K&N]=tt,G[K&N]=Oe,K++)}break;case b:L[it]<=0&&(M[it]=he,F[K&N]=tt,G[K&N]=Oe,K++);break;default:throw new Error("unreachable")}}return!0}}function fromPoints(n,t={}){let s=new Shape(t),l=new Int16Array(this.size),f=0,m=s.getPoints();for(let b=0;b<n.length;b++){f++;let h=n[b][0],S=n[b][1];for(let M=0;M<m.length;M++){let C=m[M][0],L=m[M][1];h+C>=0&&S+L>=0&&h+C<this.width&&S+L<this.height&&(l[h+C+(S+L)*this.width]=f)}}return new RoiMap(this,l)}var priorityQueue={exports:{}};(function(n,t){(function(s){n.exports=s()})(function(){return function s(l,f,m){function b(M,C){if(!f[M]){if(!l[M]){var L=typeof commonjsRequire=="function"&&commonjsRequire;if(!C&&L)return L(M,!0);if(h)return h(M,!0);var N=new Error("Cannot find module '"+M+"'");throw N.code="MODULE_NOT_FOUND",N}var F=f[M]={exports:{}};l[M][0].call(F.exports,function(G){var H=l[M][1][G];return b(H||G)},F,F.exports,s,l,f,m)}return f[M].exports}for(var h=typeof commonjsRequire=="function"&&commonjsRequire,S=0;S<m.length;S++)b(m[S]);return b}({1:[function(s,l,f){var m,b,h,S,M,C=function(N,F){for(var G in F)L.call(F,G)&&(N[G]=F[G]);function H(){this.constructor=N}return H.prototype=F.prototype,N.prototype=new H,N.__super__=F.prototype,N},L={}.hasOwnProperty;m=s("./PriorityQueue/AbstractPriorityQueue"),b=s("./PriorityQueue/ArrayStrategy"),S=s("./PriorityQueue/BinaryHeapStrategy"),h=s("./PriorityQueue/BHeapStrategy"),M=function(N){C(F,N);function F(G){G||(G={}),G.strategy||(G.strategy=S),G.comparator||(G.comparator=function(H,K){return(H||0)-(K||0)}),F.__super__.constructor.call(this,G)}return F}(m),M.ArrayStrategy=b,M.BinaryHeapStrategy=S,M.BHeapStrategy=h,l.exports=M},{"./PriorityQueue/AbstractPriorityQueue":2,"./PriorityQueue/ArrayStrategy":3,"./PriorityQueue/BHeapStrategy":4,"./PriorityQueue/BinaryHeapStrategy":5}],2:[function(s,l,f){l.exports=function(){function m(b){var h;if((b!=null?b.strategy:void 0)==null)throw"Must pass options.strategy, a strategy";if((b!=null?b.comparator:void 0)==null)throw"Must pass options.comparator, a comparator";this.priv=new b.strategy(b),this.length=(b!=null&&(h=b.initialValues)!=null?h.length:void 0)||0}return m.prototype.queue=function(b){this.length++,this.priv.queue(b)},m.prototype.dequeue=function(b){if(!this.length)throw"Empty queue";return this.length--,this.priv.dequeue()},m.prototype.peek=function(b){if(!this.length)throw"Empty queue";return this.priv.peek()},m.prototype.clear=function(){return this.length=0,this.priv.clear()},m}()},{}],3:[function(s,l,f){var m;m=function(b,h,S){var M,C,L;for(C=0,M=b.length;C<M;)L=C+M>>>1,S(b[L],h)>=0?C=L+1:M=L;return C},l.exports=function(){function b(h){var S;this.options=h,this.comparator=this.options.comparator,this.data=((S=this.options.initialValues)!=null?S.slice(0):void 0)||[],this.data.sort(this.comparator).reverse()}return b.prototype.queue=function(h){var S;S=m(this.data,h,this.comparator),this.data.splice(S,0,h)},b.prototype.dequeue=function(){return this.data.pop()},b.prototype.peek=function(){return this.data[this.data.length-1]},b.prototype.clear=function(){this.data.length=0},b}()},{}],4:[function(s,l,f){l.exports=function(){function m(b){var h,S,M,C,L,N,F,G;for(this.comparator=(b!=null?b.comparator:void 0)||function(H,K){return H-K},this.pageSize=(b!=null?b.pageSize:void 0)||512,this.length=0,F=0;1<<F<this.pageSize;)F+=1;if(1<<F!==this.pageSize)throw"pageSize must be a power of two";for(this._shift=F,this._emptyMemoryPageTemplate=h=[],S=0,L=this.pageSize;0<=L?S<L:S>L;0<=L?++S:--S)h.push(null);if(this._memory=[],this._mask=this.pageSize-1,b.initialValues)for(N=b.initialValues,M=0,C=N.length;M<C;M++)G=N[M],this.queue(G)}return m.prototype.queue=function(b){this.length+=1,this._write(this.length,b),this._bubbleUp(this.length,b)},m.prototype.dequeue=function(){var b,h;return b=this._read(1),h=this._read(this.length),this.length-=1,this.length>0&&(this._write(1,h),this._bubbleDown(1,h)),b},m.prototype.peek=function(){return this._read(1)},m.prototype.clear=function(){this.length=0,this._memory.length=0},m.prototype._write=function(b,h){var S;for(S=b>>this._shift;S>=this._memory.length;)this._memory.push(this._emptyMemoryPageTemplate.slice(0));return this._memory[S][b&this._mask]=h},m.prototype._read=function(b){return this._memory[b>>this._shift][b&this._mask]},m.prototype._bubbleUp=function(b,h){var S,M,C,L;for(S=this.comparator;b>1&&(M=b&this._mask,b<this.pageSize||M>3?C=b&~this._mask|M>>1:M<2?(C=b-this.pageSize>>this._shift,C+=C&~(this._mask>>1),C|=this.pageSize>>1):C=b-2,L=this._read(C),!(S(L,h)<0));)this._write(C,h),this._write(b,L),b=C},m.prototype._bubbleDown=function(b,h){var S,M,C,L,N;for(N=this.comparator;b<this.length;)if(b>this._mask&&!(b&this._mask-1)?S=M=b+2:b&this.pageSize>>1?(S=(b&~this._mask)>>1,S|=b&this._mask>>1,S=S+1<<this._shift,M=S+1):(S=b+(b&this._mask),M=S+1),S!==M&&M<=this.length)if(C=this._read(S),L=this._read(M),N(C,h)<0&&N(C,L)<=0)this._write(S,h),this._write(b,C),b=S;else if(N(L,h)<0)this._write(M,h),this._write(b,L),b=M;else break;else if(S<=this.length)if(C=this._read(S),N(C,h)<0)this._write(S,h),this._write(b,C),b=S;else break;else break},m}()},{}],5:[function(s,l,f){l.exports=function(){function m(b){var h;this.comparator=(b!=null?b.comparator:void 0)||function(S,M){return S-M},this.length=0,this.data=((h=b.initialValues)!=null?h.slice(0):void 0)||[],this._heapify()}return m.prototype._heapify=function(){var b,h,S;if(this.data.length>0)for(b=h=1,S=this.data.length;1<=S?h<S:h>S;b=1<=S?++h:--h)this._bubbleUp(b)},m.prototype.queue=function(b){this.data.push(b),this._bubbleUp(this.data.length-1)},m.prototype.dequeue=function(){var b,h;return h=this.data[0],b=this.data.pop(),this.data.length>0&&(this.data[0]=b,this._bubbleDown(0)),h},m.prototype.peek=function(){return this.data[0]},m.prototype.clear=function(){this.length=0,this.data.length=0},m.prototype._bubbleUp=function(b){for(var h,S;b>0&&(h=b-1>>>1,this.comparator(this.data[b],this.data[h])<0);)S=this.data[h],this.data[h]=this.data[b],this.data[b]=S,b=h},m.prototype._bubbleDown=function(b){var h,S,M,C,L;for(h=this.data.length-1;S=(b<<1)+1,C=S+1,M=b,S<=h&&this.comparator(this.data[S],this.data[M])<0&&(M=S),C<=h&&this.comparator(this.data[C],this.data[M])<0&&(M=C),M!==b;)L=this.data[M],this.data[M]=this.data[b],this.data[b]=L,b=M},m}()},{}]},{},[1])(1)})})(priorityQueue);var PriorityQueue=priorityQueue.exports;const dxs=[1,0,-1,0,1,1,-1,-1],dys=[0,1,0,-1,1,-1,1,-1];function fromWaterShed(n={}){let{points:t,mask:s,image:l,fillMaxValue:f=this.maxValue,invert:m=!1}=n,b=l||this;b.checkProcessable("fromWaterShed",{bitDepth:[8,16],components:1}),m=!m,t||(t=b.getLocalMaxima({invert:m,mask:s}));let h=m?0:1,S=new Int16Array(b.size),M=b.width,C=b.height,L=new PriorityQueue({comparator:(N,F)=>N[2]-F[2],strategy:PriorityQueue.BinaryHeapStrategy});for(let N=0;N<t.length;N++){let F=t[N][0]+t[N][1]*M;S[F]=N+1;let G=b.data[F];(m&&G<=f||!m&&G>=f)&&L.queue([t[N][0],t[N][1],G])}for(;L.length>0;){let N=L.dequeue(),F=N[0]+N[1]*M;for(let G=0;G<4;G++){let H=N[0]+dxs[G],K=N[1]+dys[G];if(H>=0&&K>=0&&H<M&&K<C){let X=H+K*M;if(!s||s.getBit(X)===h){let de=b.data[X];(m&&de<=f||!m&&de>=f)&&S[X]===0&&(S[X]=S[F],L.queue([N[0]+dxs[G],N[1]+dys[G],de]))}}}}return new RoiMap(b,S)}class RoiManager{constructor(t,s={}){this._image=t,this._options=s,this._options.label||(this._options.label="default"),this._layers={},this._painted=null}fromMaxima(t={}){let s=Object.assign({},this._options,t),l=fromMaxima.call(this._image,t);this._layers[s.label]=new RoiLayer(l,s)}fromPoints(t,s={}){let l=Object.assign({},this._options,s),f=fromPoints.call(this._image,t,s);return this._layers[l.label]=new RoiLayer(f,l),this}putMap(t,s={}){let l=new RoiMap(this._image,t),f=Object.assign({},this._options,s);return this._layers[f.label]=new RoiLayer(l,f),this}fromWaterShed(t={}){let s=Object.assign({},this._options,t),l=fromWaterShed.call(this._image,t);this._layers[s.label]=new RoiLayer(l,s)}fromMask(t,s={}){let l=Object.assign({},this._options,s),f=fromMask.call(this._image,t,s);return this._layers[l.label]=new RoiLayer(f,l),this}fromMaskConnectedComponentLabelingAlgorithm(t,s={}){let l=Object.assign({},this._options,s),f=fromMaskConnectedComponentLabelingAlgorithm.call(this._image,t,s);return this._layers[l.label]=new RoiLayer(f,l),this}getMap(t={}){let s=Object.assign({},this._options,t);return this._assertLayerWithLabel(s.label),this._layers[s.label].roiMap}rowsInfo(t={}){return this.getMap(t).rowsInfo()}colsInfo(t={}){return this.getMap(t).rowsInfo()}getRoiIds(t={}){let s=this.getRois(t);if(s){let l=new Array(s.length);for(let f=0;f<s.length;f++)l[f]=s[f].id;return l}throw new Error("ROIs not found")}getRois(t={}){let{label:s=this._options.label,positive:l=!0,negative:f=!0,minSurface:m=0,maxSurface:b=Number.POSITIVE_INFINITY,minWidth:h=0,maxWidth:S=Number.POSITIVE_INFINITY,minHeight:M=0,maxHeight:C=Number.POSITIVE_INFINITY,minRatio:L=0,maxRatio:N=Number.POSITIVE_INFINITY}=t;if(!this._layers[s])throw new Error(`this Roi layer (${s}) does not exist`);const F=this._layers[s].roi,G=[];for(const H of F)(H.id<0&&f||H.id>0&&l)&&H.surface>=m&&H.surface<=b&&H.width>=h&&H.width<=S&&H.height>=M&&H.height<=C&&H.ratio>=L&&H.ratio<=N&&G.push(H);return G}getRoi(t,s={}){const{label:l=this._options.label}=s;if(!this._layers[l])throw new Error(`this Roi layer (${l}) does not exist`);const f=this._layers[l].roi.find(m=>m.id===t);if(!f)throw new Error(`found no Roi with id ${t}`);return f}getMasks(t={}){let s=this.getRois(t),l=new Array(s.length);for(let f=0;f<s.length;f++)l[f]=s[f].getMask(t);return l}getAnalysisMasks(t={}){const{analysisProperty:s}=t;let l=`${s}Mask`,f=this.getRois(t);return f.length===0||!f[0][l]?[]:f.map(m=>m[l])}getData(t={}){let s=Object.assign({},this._options,t);return this._assertLayerWithLabel(s.label),this._layers[s.label].roiMap.data}paint(t={}){let{labelProperty:s,analysisProperty:l}=t;this._painted||(this._painted=this._image.rgba8());let f=this.getMasks(t);if(s){const m=this.getRois(t);t.labels=m.map(M=>deepValue(M,s));const b=Math.max(...t.labels);let h=!1,S=!1;if(s.includes("surface")?h=!0:/(?:perimeter|min|max|external|width|height|length)/.test(s)&&(S=!0),isFinite(b)){let M="";if(t.unit!=="pixel"&&t.pixelSize&&(S||h)){M=h?`${t.unit}^2`:t.unit;let C=h?"m^2":"m",L=h?t.pixelSize**2:t.pixelSize;const N=Qty.swiftConverter(C,M);t.labels=t.labels.map(F=>N(L*F))}b>50?t.labels=t.labels.map(C=>Math.round(C)+M):b>10?t.labels=t.labels.map(C=>C.toFixed(1)+M):t.labels=t.labels.map(C=>C.toFixed(2)+M)}t.labelsPosition=m.map(M=>[M.meanX,M.meanY])}if(this._painted.paintMasks(f,t),l){let m=this.getAnalysisMasks(t);this._painted.paintMasks(m,{color:t.analysisColor,alpha:t.analysisAlpha})}return this._painted}getMask(t={}){let s=new Image$1(this._image.width,this._image.height,{kind:"BINARY"}),l=this.getMasks(t);for(let f=0;f<l.length;f++){let m=l[f];for(let b=0;b<m.width;b++)for(let h=0;h<m.height;h++)m.getBitXY(b,h)&&s.setBitXY(b+m.position[0],h+m.position[1])}return s}resetPainted(t={}){const{image:s}=t;s?this._painted=this.image.rgba8():this._painted=this._image.rgba8()}mergeRoi(t={}){const s=this.getMap(t);return s.mergeRoi(t),this.putMap(s.data,t),this}mergeRois(t,s={}){if(!Array.isArray(t)||t.some(f=>!Number.isInteger(f)))throw new Error("Roi ids must be an array of integers");if(t.length<2)throw new Error("Roi ids must have at least two elements");if(new Set(t).size!==t.length)throw new Error("Roi ids must be all different");t.forEach(f=>this.getRoi(f));const l=this.getMap(s);return l.mergeRois(t),this.putMap(l.data,s),this}findCorrespondingRoi(t,s={}){let l=this.getRois(s),f=[];for(let m=0;m<l.length;m++){let b=l[m],h=b.minX,S=b.minY,M=b.points,C=Math.sign(b.id),L=correspondingRoisInformation(h,S,M,t,C);f.push(L)}return f}_assertLayerWithLabel(t){if(!this._layers[t])throw new Error(`no layer with label ${t}`)}}function correspondingRoisInformation(n,t,s,l,f){let m={id:[],surface:[],roiSurfaceCovered:[],same:0,opposite:0,total:0};for(let b=0;b<s.length;b++){let h=s[b],S=h[0],M=h[1],C=S+n+(M+t)*l.width,L=l.data[C];(L>0||L<0)&&(m.id.includes(L)?m.surface[m.id.indexOf(L)]+=1:(m.id.push(L),m.surface.push(1)))}for(let b=0;b<m.id.length;b++)Math.sign(m.id[b])===f?m.same+=m.surface[b]:m.opposite+=m.surface[b],m.roiSurfaceCovered[b]=m.surface[b]/s.length;return m.total=m.opposite+m.same,m}const objectToString$1=Object.prototype.toString;class Image$1{constructor(t,s,l,f){if(arguments.length===1?(f=t,{width:t,height:s,data:l}=f):l&&!l.length&&(f=l,{data:l}=f),t===void 0&&(t=1),s===void 0&&(s=1),f===void 0&&(f={}),typeof f!="object"||f===null)throw new TypeError("options must be an object");if(!Number.isInteger(t)||t<=0)throw new RangeError("width must be a positive integer");if(!Number.isInteger(s)||s<=0)throw new RangeError("height must be a positive integer");const{kind:m=RGBA}=f;if(typeof m!="string")throw new TypeError("kind must be a string");const b=getKind(m),h=Object.assign({},f);for(const H in b)h[H]===void 0&&(h[H]=b[H]);verifyKindDefinition(h);const{components:S,bitDepth:M,colorModel:C}=h,L=h.alpha+0,N=t*s,F=S+L,G=M===32?Number.MAX_VALUE:2**M-1;if(l===void 0)l=createPixelArray(N,S,L,F,M,G);else{const H=getTheoreticalPixelArraySize(N,F,M);if(l.length!==H)throw new RangeError(`incorrect data size: ${l.length}. Should be ${H}`)}this.width=t,this.height=s,this.data=l,this.size=N,this.components=S,this.alpha=L,this.bitDepth=M,this.maxValue=G,this.colorModel=C,this.channels=F,this.meta=f.meta||{},Object.defineProperty(this,"parent",{enumerable:!1,writable:!0,configurable:!0,value:f.parent||null}),this.position=f.position||[0,0],this.computed=null,this.sizes=[this.width,this.height],this.multiplierX=this.channels,this.multiplierY=this.channels*this.width,this.isClamped=this.bitDepth<32,this.borderSizes=[0,0]}get[Symbol.toStringTag](){return"IJSImage"}static isImage(t){return objectToString$1.call(t)==="[object IJSImage]"}static fromCanvas(t){const l=t.getContext("2d").getImageData(0,0,t.width,t.height);return new Image$1(l.width,l.height,l.data)}static createFrom(t,s){const l=getImageParameters(t);return Object.assign(l,{parent:t,position:[0,0]},s),new Image$1(l)}getRoiManager(t){return new RoiManager(this,t)}clone(){const t=this.data.slice();return new Image$1(this.width,this.height,t,this)}apply(t){for(let s=0;s<this.height;s++)for(let l=0;l<this.width;l++){let f=(s*this.width+l)*this.channels;t.call(this,f)}}}setValueMethods(Image$1);setBitMethods(Image$1);setExportMethods(Image$1);Image$1.prototype.checkProcessable=checkProcessable;Image$1.prototype.getRGBAData=getRGBAData;Image$1.load=load;Image$1.extendMethod=extendMethod;Image$1.extendProperty=extendProperty;extend$4(Image$1);var workerTemplate$1={},worker$1=function(){self.window=self;function n(){this._listeners={}}n.prototype.on=function(s,l){if(this._listeners[s])throw new RangeError("there is already a listener for "+s);if(typeof l!="function")throw new TypeError("callback argument must be a function");this._listeners[s]=l},n.prototype._send=function(s,l,f){f===void 0?f=[]:Array.isArray(f)||(f=[f]),self.postMessage({id:s,data:l},f)},n.prototype._trigger=function(s,l){if(!this._listeners[s])throw new Error("event "+s+" is not defined");this._listeners[s].apply(null,l)};var t=new n;self.onmessage=function(s){switch(s.data.action){case"exec":s.data.args.unshift(function(l,f){t._send(s.data.id,l,f)}),t._trigger(s.data.event,s.data.args);break;case"ping":t._send(s.data.id,"pong");break;default:throw new Error("unexpected action: "+s.data.action)}}},workerStr=worker$1.toString().split('"CODE";');workerTemplate$1.newWorkerURL=function n(t,s){var l=new Blob(["(",workerStr[0],"importScripts.apply(self, "+JSON.stringify(s)+`);
`,"(",t,")();",workerStr[1],")();"],{type:"application/javascript"});return URL.createObjectURL(l)};var workerTemplate=workerTemplate$1,CORES=navigator.hardwareConcurrency||1;function WorkerManager(n,t){if(typeof n!="string"&&typeof n!="function")throw new TypeError("func argument must be a function");if(t===void 0&&(t={}),typeof t!="object"||t===null)throw new TypeError("options argument must be an object");this._workerCode=n.toString(),t.maxWorkers===void 0||t.maxWorkers==="auto"?this._numWorkers=Math.min(CORES-1,1):t.maxWorkers>0?this._numWorkers=Math.min(t.maxWorkers,CORES):this._numWorkers=CORES,this._workers=new Map,this._timeout=t.timeout||0,this._terminateOnError=!!t.terminateOnError;var s=t.deps;typeof s=="string"&&(s=[s]),Array.isArray(s)||(s=void 0),this._id=0,this._terminated=!1,this._working=0,this._waiting=[],this._init(s)}WorkerManager.prototype._init=function(n){for(var t=workerTemplate.newWorkerURL(this._workerCode,n),s=0;s<this._numWorkers;s++){var l=new Worker(t);l.onmessage=this._onmessage.bind(this,l),l.onerror=this._onerror.bind(this,l),l.running=!1,l.id=s,this._workers.set(l,null)}URL.revokeObjectURL(t)};WorkerManager.prototype._onerror=function(n,t){if(!this._terminated){this._working--,n.running=!1;var s=this._workers.get(n);s&&s[1](t.message),this._workers.set(n,null),this._terminateOnError?this.terminate():this._exec()}};WorkerManager.prototype._onmessage=function(n,t){if(!this._terminated){this._working--,n.running=!1;var s=this._workers.get(n);s&&s[0](t.data.data),this._workers.set(n,null),this._exec()}};WorkerManager.prototype._exec=function(){for(var n of this._workers.keys()){if(this._working===this._numWorkers||this._waiting.length===0)return;if(!n.running)for(var t=0;t<this._waiting.length;t++){var s=this._waiting[t];if(!(typeof s[4]=="number"&&s[4]!==n.id)){this._waiting.splice(t,1),n.postMessage({action:"exec",event:s[0],args:s[1]},s[2]),n.running=!0,n.time=Date.now(),this._workers.set(n,s[3]),this._working++;break}}}};WorkerManager.prototype.terminate=function(){if(!this._terminated){for(var n of this._workers)n[0].terminate(),n[1]&&n[1][1](new Error("Terminated"));this._workers.clear(),this._waiting=[],this._working=0,this._terminated=!0}};WorkerManager.prototype.postAll=function(n,t){if(this._terminated)throw new Error("Cannot post (terminated)");var s=[];for(var l of this._workers.keys())s.push(this.post(n,t,[],l.id));return Promise.all(s)};WorkerManager.prototype.post=function(n,t,s,l){t===void 0&&(t=[]),s===void 0&&(s=[]),Array.isArray(t)||(t=[t]),Array.isArray(s)||(s=[s]);var f=this;return new Promise(function(m,b){if(f._terminated)throw new Error("Cannot post (terminated)");f._waiting.push([n,t,s,[m,b],l]),f._exec()})};var src=WorkerManager;const defaultOptions={regression:{kernelType:"polynomial",kernelOptions:{degree:2,constant:1}},threshold:.02,roi:{minSurface:100,positive:!1},sampling:20,include:[]};function run(n,t,s){t=Object.assign({},defaultOptions,t);const l=this.manager;return Array.isArray(n)?Promise.all(n.map(function(f){const m=runOnce(l,f,t);return typeof s=="function"&&m.then(s),m})):runOnce(l,n,t)}function runOnce(n,t,s){return n.post("data",[t,s]).then(function(l){for(let f in l)l[f]=new Image$1(l[f]);return l})}function work(){worker.on("data",function(n,t,s){t=new IJS(t);const l={},f=[],m=t.grey(),b=m.sobelFilter();F("sobel",b);const h=b.level().mask({threshold:s.threshold});F("mask",h);const S=b.getRoiManager();S.fromMask(h);const M=S.getMask(s.roi);F("realMask",M);const C=m.getPixelsGrid({sampling:s.sampling,mask:M}),L=t.getBackground(C.xyS,C.zS,s.regression);F("background",L);const N=t.subtract(L);l.result=N,f.push(N.data.buffer),n(l,f);function F(G,H){s.include.includes(G)&&(l[G]=H,f.push(H.data.buffer))}})}const background={run,work};function extend$3(n){n.extendMethod("background",background)}class Worker$1{constructor(){this._url=null,this._deps=[null]}checkUrl(){if(this._url===null)throw new Error("image worker must be initialized with an URL")}get url(){return this._url}set url(t){if(typeof t!="string")throw new TypeError("worker URL must be a string");this._url=t,this._deps[0]=t}static extendMethod(t,s){let l,f,m={};function b(...h){return l||(this.checkUrl(),f=this.url,l=new src(s.work,{deps:f}),m.manager=l),s.run.call(m,...h)}b.reset=function(){l&&(l.terminate(),l=new src(s.work,{deps:f}),m.manager=l)},Worker$1.prototype[t]=b}}extend$3(Worker$1);new Worker$1;var K0=.9996,E=.00669438,E2=Math.pow(E,2),E3=Math.pow(E,3),E_P2=E/(1-E),M1=1-E/4-3*E2/64-5*E3/256,M2=3*E/8+3*E2/32+45*E3/1024,M3=15*E2/256+45*E3/1024,M4=35*E3/3072,R$1=6378137,ZONE_LETTERS="CDEFGHJKLMNPQRSTUVWXX";function fromLatLon(n,t,s){if(n>84||n<-80)throw new RangeError("latitude out of range (must be between 80 deg S and 84 deg N)");if(t>180||t<-180)throw new RangeError("longitude out of range (must be between 180 deg W and 180 deg E)");var l=toRadians(n),f=Math.sin(l),m=Math.cos(l),b=Math.tan(l),h=Math.pow(b,2),S=Math.pow(b,4),M;s===void 0?M=latLonToZoneNumber(n,t):M=s;var C=latitudeToZoneLetter(n),L=toRadians(t),N=zoneNumberToCentralLongitude(M),F=toRadians(N),G=R$1/Math.sqrt(1-E*f*f),H=E_P2*m*m,K=m*modAngle(L-F),X=Math.pow(K,2),de=Math.pow(K,3),Q=Math.pow(K,4),ie=Math.pow(K,5),ce=Math.pow(K,6),ge=R$1*(M1*l-M2*Math.sin(2*l)+M3*Math.sin(4*l)-M4*Math.sin(6*l)),be=K0*G*(K+de/6*(1-h+H)+ie/120*(5-18*h+S+72*H-58*E_P2))+5e5,ne=K0*(ge+G*b*(X/2+Q/24*(5-h+9*H+4*H*H)+ce/720*(61-58*h+S+600*H-330*E_P2)));return n<0&&(ne+=1e7),{easting:be,northing:ne,zoneNum:M,zoneLetter:C}}function latitudeToZoneLetter(n){return-80<=n&&n<=84?ZONE_LETTERS[Math.floor((n+80)/8)]:null}function latLonToZoneNumber(n,t){if(56<=n&&n<64&&3<=t&&t<12)return 32;if(72<=n&&n<=84&&t>=0){if(t<9)return 31;if(t<21)return 33;if(t<33)return 35;if(t<42)return 37}return Math.floor((t+180)/6)+1}function zoneNumberToCentralLongitude(n){return(n-1)*6-180+3}function toRadians(n){return n*Math.PI/180}function modAngle(n){return(n+Math.PI)%(2*Math.PI)-Math.PI}function getTileInfo(n,t,s){let l={},f=Math.floor(s.getZoom()),m=40075016686e-3*Math.abs(Math.cos(t))/Math.pow(2,f),b=m/512,h=tilebelt.pointToTile(n,t,f);l.z=f,l.x=h[0],l.y=h[1],l.pointLng=n,l.pointLat=t,l.tileWidthInMeters=m,l.metersPerPixel=b,l.mapboxTileName=l.z+"-"+l.x+"-"+l.y,l.tile=[l.x,l.y,l.z],l.bbox=tilebelt.tileToBBOX(l.tile),l.polygon_bb=getTileGeoJsonBB(l.bbox);const S=new mapboxgl.LngLatBounds(l.bbox);l.bboxCT=S.getCenter(),l.bboxSW=S.getSouthWest(),l.bboxNE=S.getNorthEast(),l.bboxNW=S.getNorthWest(),l.bboxSE=S.getSouthEast(),l.originCoordinates=l.bboxNW;let M=converLatLngTotUtm(l.originCoordinates.lat,l.originCoordinates.lng);return l.projected=new mapboxgl.LngLat(l.originCoordinates.lng,l.originCoordinates.lat),l.epsg=getEpsg(l.originCoordinates.lat,l.originCoordinates.lng),l.OriginEasting=M.easting,l.OriginNorthing=M.northing,l.zoneLetter=M.zoneLetter,l.zoneNum=M.zoneNum,l.originLng=l.originCoordinates.lng,l.originLat=l.originCoordinates.lat,l.maxPngValue=65535,l.rgbFileName="terrain-rgb-"+l.mapboxTileName+".png",l.thirtyTwoFileName="thirtytwo-"+l.mapboxTileName+".png",l.tileInfoFileName="tile-info-"+l.mapboxTileName+".json",l.geoJsonFileName="geojson-"+l.mapboxTileName+".json",M=converLatLngTotUtm(l.pointLat,l.pointLng),l.pointNorthing=M.northing,l.pointEasting=M.easting,M=converLatLngTotUtm(l.bboxCT.lat,l.bboxCT.lng),l.ctNorthing=M.northing,l.ctEasting=M.easting,M=converLatLngTotUtm(l.bboxSW.lat,l.bboxSW.lng),l.swNorthing=M.northing,l.swEasting=M.easting,M=converLatLngTotUtm(l.bboxNE.lat,l.bboxNE.lng),l.neNorthing=M.northing,l.neEasting=M.easting,M=converLatLngTotUtm(l.bboxNW.lat,l.bboxNW.lng),l.nwNorthing=M.northing,l.nwEasting=M.easting,M=converLatLngTotUtm(l.bboxSE.lat,l.bboxSE.lng),l.seNorthing=M.northing,l.seEasting=M.easting,l}function getEpsg(n,t){let s=Math.round((183+t)/6),l=0;return n>0?l=32600+s:l=32700+s,l}function converLatLngTotUtm(n,t){return fromLatLon(n,t)}function convertGeoJsonCoordinatesToUTM(n){return n.forEach(t=>{let s=t.geometry.coordinates;traverseArray(s)}),n}function traverseArray(n){let t=0,s,l;n.forEach((f,m)=>{if(Array.isArray(f))traverseArray(f);else{if(t===0&&(s=f),t===1){l=f;let b=converLatLngTotUtm(l,s);n[0]=b.northing,n[1]=b.easting}t=t+1,t===2&&(t=0)}})}function getTileGeoJsonBB(n){let t=bboxPolygon(n);return{type:"Feature",geometry:{type:t.geometry.type,coordinates:t.geometry.coordinates}}}function getFeaturesFromBB(n,t){return t.swPt=n.project(t.bboxSW),t.nePt=n.project(t.bboxNE),t.nwPt=n.project(t.bboxNW),t.sePt=n.project(t.bboxSE),n.queryRenderedFeatures([t.swPt,t.nePt])}async function loadImageFromArray(n){return await Image$1.load(n)}function getHeightFromRgb(n,t,s){return-1e4+(n*256*256+t*256+s)*.1}function getHeightArray(n){let t=[],s=n.getPixelsArray();for(const l of s){let f=l[0],m=l[1],b=l[2],h=getHeightFromRgb(f,m,b);h=parseFloat(h),t.push(h)}return t}async function downloadTerrainRgb(n){return await(await fetch(n)).arrayBuffer()}async function unrealRemoteControl(n,t){const s={method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)};return await(await fetch(t,s)).json()}async function getMapboxTerrainRgb(n,t,s){let l,f=await fileUtils.fileExists(n,t.rgbFileName),m;return f===!1?l=await downloadTerrainRgb(s):l=await fileUtils.readFileFromDisk(n,t.rgbFileName),idbKeyval.set("rgbImageArrayBuffer",l),m=await loadImageFromArray(l),m}function convertImage(n,t,s,l,f){return new Image$1(n,t,s,{kind:f,bitDepth:l})}function createHeightMapImage(n,t,s){let l={},f=getHeightArray(n);idbKeyval.set("decodedHeightArray",f);let m=convertImage(n.width,n.height,f,t,s);return l.minElevation=m.min[0],l.maxElevation=m.max[0],l.image=m,l.decodedHeightArray=f,l}var mapUtils={converLatLngTotUtm,getTileInfo,getFeaturesFromBB,getMapboxTerrainRgb,createHeightMapImage,loadImageFromArray,unrealRemoteControl,convertGeoJsonCoordinatesToUTM};function mitt(n){return{all:n=n||new Map,on:function(t,s){var l=n.get(t);l?l.push(s):n.set(t,[s])},off:function(t,s){var l=n.get(t);l&&(s?l.splice(l.indexOf(s)>>>0,1):n.set(t,[]))},emit:function(t,s){var l=n.get(t);l&&l.slice().map(function(f){f(s)}),(l=n.get("*"))&&l.slice().map(function(f){f(t,s)})}}}var emitter=mitt(),immutable=extend$2,hasOwnProperty=Object.prototype.hasOwnProperty;function extend$2(){for(var n={},t=0;t<arguments.length;t++){var s=arguments[t];for(var l in s)hasOwnProperty.call(s,l)&&(n[l]=s[l])}return n}var fuzzy$1={exports:{}};(function(n,t){(function(){var s={};n.exports=s,s.simpleFilter=function(l,f){return f.filter(function(m){return s.test(l,m)})},s.test=function(l,f){return s.match(l,f)!==null},s.match=function(l,f,m){m=m||{};var b=0,h=[],S=f.length,M=0,C=0,L=m.pre||"",N=m.post||"",F=m.caseSensitive&&f||f.toLowerCase(),G;l=m.caseSensitive&&l||l.toLowerCase();for(var H=0;H<S;H++)G=f[H],F[H]===l[b]?(G=L+G+N,b+=1,C+=1+C):C=0,M+=C,h[h.length]=G;return b===l.length?(M=F===l?1/0:M,{rendered:h.join(""),score:M}):null},s.filter=function(l,f,m){return!f||f.length===0?[]:typeof l!="string"?f:(m=m||{},f.reduce(function(b,h,S,M){var C=h;m.extract&&(C=m.extract(h));var L=s.match(l,C,m);return L!=null&&(b[b.length]={string:L.rendered,score:L.score,index:S,original:h}),b},[]).sort(function(b,h){var S=h.score-b.score;return S||b.index-h.index}))}})()})(fuzzy$1);var List$1=function(n){return this.component=n,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,n.el.parentNode.insertBefore(this.wrapper,n.el.nextSibling),this};List$1.prototype.show=function(){this.element.style.display="block"};List$1.prototype.hide=function(){this.element.style.display="none"};List$1.prototype.add=function(n){this.items.push(n)};List$1.prototype.clear=function(){this.items=[],this.active=0};List$1.prototype.isEmpty=function(){return!this.items.length};List$1.prototype.isVisible=function(){return this.element.style.display==="block"};List$1.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var n=0;n<this.items.length;n++)this.drawItem(this.items[n],this.active===n);this.show()};List$1.prototype.drawItem=function(n,t){var s=document.createElement("li"),l=document.createElement("a");t&&(s.className+=" active"),l.innerHTML=n.string,s.appendChild(l),this.element.appendChild(s),s.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),s.addEventListener("mouseup",function(){this.handleMouseUp.call(this,n)}.bind(this))};List$1.prototype.handleMouseUp=function(n){this.selectingListItem=!1,this.component.value(n.original),this.clear(),this.draw()};List$1.prototype.move=function(n){this.active=n,this.draw()};List$1.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};List$1.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};List$1.prototype.drawError=function(n){var t=document.createElement("li");t.innerHTML=n,this.element.appendChild(t),this.show()};var list=List$1,extend$1=immutable,fuzzy=fuzzy$1.exports,List=list,Suggestions$1=function(n,t,s){return s=s||{},this.options=extend$1({minLength:2,limit:5,filter:!0,hideOnBlur:!0},s),this.el=n,this.data=t||[],this.list=new List(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",function(l){this.handleKeyUp(l.keyCode)}.bind(this),!1),this.el.addEventListener("keydown",function(l){this.handleKeyDown(l)}.bind(this)),this.el.addEventListener("focus",function(){this.handleFocus()}.bind(this)),this.el.addEventListener("blur",function(){this.handleBlur()}.bind(this)),this.el.addEventListener("paste",function(l){this.handlePaste(l)}.bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};Suggestions$1.prototype.handleKeyUp=function(n){n===40||n===38||n===27||n===13||n===9||this.handleInputChange(this.el.value)};Suggestions$1.prototype.handleKeyDown=function(n){switch(n.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&n.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};Suggestions$1.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};Suggestions$1.prototype.handlePaste=function(n){if(n.clipboardData)this.handleInputChange(n.clipboardData.getData("Text"));else{var t=this;setTimeout(function(){t.handleInputChange(n.target.value)},100)}};Suggestions$1.prototype.handleInputChange=function(n){if(this.query=this.normalize(n),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates(function(t){for(var s=0;s<t.length&&(this.list.add(t[s]),s!==this.options.limit-1);s++);this.list.draw()}.bind(this))};Suggestions$1.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};Suggestions$1.prototype.update=function(n){this.data=n,this.handleKeyUp()};Suggestions$1.prototype.clear=function(){this.data=[],this.list.clear()};Suggestions$1.prototype.normalize=function(n){return n=n.toLowerCase(),n};Suggestions$1.prototype.match=function(n,t){return n.indexOf(t)>-1};Suggestions$1.prototype.value=function(n){if(this.selected=n,this.el.value=this.getItemValue(n),document.createEvent){var t=document.createEvent("HTMLEvents");t.initEvent("change",!0,!1),this.el.dispatchEvent(t)}else this.el.fireEvent("onchange")};Suggestions$1.prototype.getCandidates=function(n){var t={pre:"<strong>",post:"</strong>",extract:function(l){return this.getItemValue(l)}.bind(this)},s;this.options.filter?(s=fuzzy.filter(this.query,this.data,t),s=s.map(function(l){return{original:l.original,string:this.render(l.original,l.string)}}.bind(this))):s=this.data.map(function(l){var f=this.render(l);return{original:l,string:f}}.bind(this)),n(s)};Suggestions$1.prototype.getItemValue=function(n){return n};Suggestions$1.prototype.render=function(n,t){if(t)return t;for(var s=n.original?this.getItemValue(n.original):this.getItemValue(n),l=this.normalize(s),f=l.lastIndexOf(this.query);f>-1;){var m=f+this.query.length;s=s.slice(0,f)+"<strong>"+s.slice(f,m)+"</strong>"+s.slice(m),f=l.slice(0,f).lastIndexOf(this.query)}return s};Suggestions$1.prototype.renderError=function(n){this.list.drawError(n)};var suggestions$1=Suggestions$1,Suggestions=suggestions$1,suggestions=Suggestions;typeof window!="undefined"&&(window.Suggestions=Suggestions);var FUNC_ERROR_TEXT="Expected a function",NAN=0/0,symbolTag="[object Symbol]",reTrim=/^\s+|\s+$/g,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsOctal=/^0o[0-7]+$/i,freeParseInt=parseInt,freeGlobal=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf=typeof self=="object"&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),objectProto=Object.prototype,objectToString=objectProto.toString,nativeMax=Math.max,nativeMin=Math.min,now=function(){return root.Date.now()};function debounce$1(n,t,s){var l,f,m,b,h,S,M=0,C=!1,L=!1,N=!0;if(typeof n!="function")throw new TypeError(FUNC_ERROR_TEXT);t=toNumber(t)||0,isObject(s)&&(C=!!s.leading,L="maxWait"in s,m=L?nativeMax(toNumber(s.maxWait)||0,t):m,N="trailing"in s?!!s.trailing:N);function F(ge){var be=l,ne=f;return l=f=void 0,M=ge,b=n.apply(ne,be),b}function G(ge){return M=ge,h=setTimeout(X,t),C?F(ge):b}function H(ge){var be=ge-S,ne=ge-M,ve=t-be;return L?nativeMin(ve,m-ne):ve}function K(ge){var be=ge-S,ne=ge-M;return S===void 0||be>=t||be<0||L&&ne>=m}function X(){var ge=now();if(K(ge))return de(ge);h=setTimeout(X,H(ge))}function de(ge){return h=void 0,N&&l?F(ge):(l=f=void 0,b)}function Q(){h!==void 0&&clearTimeout(h),M=0,l=S=f=h=void 0}function ie(){return h===void 0?b:de(now())}function ce(){var ge=now(),be=K(ge);if(l=arguments,f=this,S=ge,be){if(h===void 0)return G(S);if(L)return h=setTimeout(X,t),F(S)}return h===void 0&&(h=setTimeout(X,t)),b}return ce.cancel=Q,ce.flush=ie,ce}function isObject(n){var t=typeof n;return!!n&&(t=="object"||t=="function")}function isObjectLike(n){return!!n&&typeof n=="object"}function isSymbol(n){return typeof n=="symbol"||isObjectLike(n)&&objectToString.call(n)==symbolTag}function toNumber(n){if(typeof n=="number")return n;if(isSymbol(n))return NAN;if(isObject(n)){var t=typeof n.valueOf=="function"?n.valueOf():n;n=isObject(t)?t+"":t}if(typeof n!="string")return n===0?n:+n;n=n.replace(reTrim,"");var s=reIsBinary.test(n);return s||reIsOctal.test(n)?freeParseInt(n.slice(2),s?2:8):reIsBadHex.test(n)?NAN:+n}var lodash_debounce=debounce$1,events$1={exports:{}},R=typeof Reflect=="object"?Reflect:null,ReflectApply=R&&typeof R.apply=="function"?R.apply:function n(t,s,l){return Function.prototype.apply.call(t,s,l)},ReflectOwnKeys;R&&typeof R.ownKeys=="function"?ReflectOwnKeys=R.ownKeys:Object.getOwnPropertySymbols?ReflectOwnKeys=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:ReflectOwnKeys=function(t){return Object.getOwnPropertyNames(t)};function ProcessEmitWarning(n){console&&console.warn&&console.warn(n)}var NumberIsNaN=Number.isNaN||function n(t){return t!==t};function EventEmitter$2(){EventEmitter$2.init.call(this)}events$1.exports=EventEmitter$2;events$1.exports.once=once;EventEmitter$2.EventEmitter=EventEmitter$2;EventEmitter$2.prototype._events=void 0;EventEmitter$2.prototype._eventsCount=0;EventEmitter$2.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(EventEmitter$2,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(n){if(typeof n!="number"||n<0||NumberIsNaN(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");defaultMaxListeners=n}});EventEmitter$2.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};EventEmitter$2.prototype.setMaxListeners=function n(t){if(typeof t!="number"||t<0||NumberIsNaN(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function _getMaxListeners(n){return n._maxListeners===void 0?EventEmitter$2.defaultMaxListeners:n._maxListeners}EventEmitter$2.prototype.getMaxListeners=function n(){return _getMaxListeners(this)};EventEmitter$2.prototype.emit=function n(t){for(var s=[],l=1;l<arguments.length;l++)s.push(arguments[l]);var f=t==="error",m=this._events;if(m!==void 0)f=f&&m.error===void 0;else if(!f)return!1;if(f){var b;if(s.length>0&&(b=s[0]),b instanceof Error)throw b;var h=new Error("Unhandled error."+(b?" ("+b.message+")":""));throw h.context=b,h}var S=m[t];if(S===void 0)return!1;if(typeof S=="function")ReflectApply(S,this,s);else for(var M=S.length,C=arrayClone(S,M),l=0;l<M;++l)ReflectApply(C[l],this,s);return!0};function _addListener(n,t,s,l){var f,m,b;if(checkListener(s),m=n._events,m===void 0?(m=n._events=Object.create(null),n._eventsCount=0):(m.newListener!==void 0&&(n.emit("newListener",t,s.listener?s.listener:s),m=n._events),b=m[t]),b===void 0)b=m[t]=s,++n._eventsCount;else if(typeof b=="function"?b=m[t]=l?[s,b]:[b,s]:l?b.unshift(s):b.push(s),f=_getMaxListeners(n),f>0&&b.length>f&&!b.warned){b.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+b.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=n,h.type=t,h.count=b.length,ProcessEmitWarning(h)}return n}EventEmitter$2.prototype.addListener=function n(t,s){return _addListener(this,t,s,!1)};EventEmitter$2.prototype.on=EventEmitter$2.prototype.addListener;EventEmitter$2.prototype.prependListener=function n(t,s){return _addListener(this,t,s,!0)};function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(n,t,s){var l={fired:!1,wrapFn:void 0,target:n,type:t,listener:s},f=onceWrapper.bind(l);return f.listener=s,l.wrapFn=f,f}EventEmitter$2.prototype.once=function n(t,s){return checkListener(s),this.on(t,_onceWrap(this,t,s)),this};EventEmitter$2.prototype.prependOnceListener=function n(t,s){return checkListener(s),this.prependListener(t,_onceWrap(this,t,s)),this};EventEmitter$2.prototype.removeListener=function n(t,s){var l,f,m,b,h;if(checkListener(s),f=this._events,f===void 0)return this;if(l=f[t],l===void 0)return this;if(l===s||l.listener===s)--this._eventsCount===0?this._events=Object.create(null):(delete f[t],f.removeListener&&this.emit("removeListener",t,l.listener||s));else if(typeof l!="function"){for(m=-1,b=l.length-1;b>=0;b--)if(l[b]===s||l[b].listener===s){h=l[b].listener,m=b;break}if(m<0)return this;m===0?l.shift():spliceOne(l,m),l.length===1&&(f[t]=l[0]),f.removeListener!==void 0&&this.emit("removeListener",t,h||s)}return this};EventEmitter$2.prototype.off=EventEmitter$2.prototype.removeListener;EventEmitter$2.prototype.removeAllListeners=function n(t){var s,l,f;if(l=this._events,l===void 0)return this;if(l.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):l[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete l[t]),this;if(arguments.length===0){var m=Object.keys(l),b;for(f=0;f<m.length;++f)b=m[f],b!=="removeListener"&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(s=l[t],typeof s=="function")this.removeListener(t,s);else if(s!==void 0)for(f=s.length-1;f>=0;f--)this.removeListener(t,s[f]);return this};function _listeners(n,t,s){var l=n._events;if(l===void 0)return[];var f=l[t];return f===void 0?[]:typeof f=="function"?s?[f.listener||f]:[f]:s?unwrapListeners(f):arrayClone(f,f.length)}EventEmitter$2.prototype.listeners=function n(t){return _listeners(this,t,!0)};EventEmitter$2.prototype.rawListeners=function n(t){return _listeners(this,t,!1)};EventEmitter$2.listenerCount=function(n,t){return typeof n.listenerCount=="function"?n.listenerCount(t):listenerCount.call(n,t)};EventEmitter$2.prototype.listenerCount=listenerCount;function listenerCount(n){var t=this._events;if(t!==void 0){var s=t[n];if(typeof s=="function")return 1;if(s!==void 0)return s.length}return 0}EventEmitter$2.prototype.eventNames=function n(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(n,t){for(var s=new Array(t),l=0;l<t;++l)s[l]=n[l];return s}function spliceOne(n,t){for(;t+1<n.length;t++)n[t]=n[t+1];n.pop()}function unwrapListeners(n){for(var t=new Array(n.length),s=0;s<t.length;++s)t[s]=n[s].listener||n[s];return t}function once(n,t){return new Promise(function(s,l){function f(b){n.removeListener(t,m),l(b)}function m(){typeof n.removeListener=="function"&&n.removeListener("error",f),s([].slice.call(arguments))}eventTargetAgnosticAddListener(n,t,m,{once:!0}),t!=="error"&&addErrorHandlerIfEventEmitter(n,f,{once:!0})})}function addErrorHandlerIfEventEmitter(n,t,s){typeof n.on=="function"&&eventTargetAgnosticAddListener(n,"error",t,s)}function eventTargetAgnosticAddListener(n,t,s,l){if(typeof n.on=="function")l.once?n.once(t,s):n.on(t,s);else if(typeof n.addEventListener=="function")n.addEventListener(t,function f(m){l.once&&n.removeEventListener(t,f),s(m)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var exceptions$1={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}};function parseParam(n){var t=n.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return t?{key:t[1],value:t[2]}:null}function parseLink(n){var t=n.match(/<?([^>]*)>(.*)/);if(!t)return null;var s=t[1],l=t[2].split(";"),f=null,m=l.reduce(function(b,h){var S=parseParam(h);return S?S.key==="rel"?(f||(f=S.value),b):(b[S.key]=S.value,b):b},{});return f?{url:s,rel:f,params:m}:null}function parseLinkHeader$1(n){return n?n.split(/,\s*</).reduce(function(t,s){var l=parseLink(s);if(!l)return t;var f=l.rel.split(/\s+/);return f.forEach(function(m){t[m]||(t[m]={url:l.url,params:l.params})}),t},{}):{}}var parseLinkHeader_1=parseLinkHeader$1,parseLinkHeader=parseLinkHeader_1;function MapiResponse$1(n,t){this.request=n,this.headers=t.headers,this.rawBody=t.body,this.statusCode=t.statusCode;try{this.body=JSON.parse(t.body||"{}")}catch{this.body=t.body}this.links=parseLinkHeader(this.headers.link)}MapiResponse$1.prototype.hasNextPage=function n(){return!!this.links.next};MapiResponse$1.prototype.nextPage=function n(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};var mapiResponse=MapiResponse$1,constants$4={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"},constants$3=constants$4;function MapiError$1(n){var t=n.type||constants$3.ERROR_HTTP,s;if(n.body)try{s=JSON.parse(n.body)}catch{s=n.body}else s=null;var l=n.message||null;l||(typeof s=="string"?l=s:s&&typeof s.message=="string"?l=s.message:t===constants$3.ERROR_REQUEST_ABORTED&&(l="Request aborted")),this.message=l,this.type=t,this.statusCode=n.statusCode||null,this.request=n.request,this.body=s}var mapiError=MapiError$1;function parseSingleHeader(n){var t=n.indexOf(":"),s=n.substring(0,t).trim().toLowerCase(),l=n.substring(t+1).trim();return{name:s,value:l}}function parseHeaders$1(n){var t={};return n&&n.trim().split(/[\r|\n]+/).forEach(function(s){var l=parseSingleHeader(s);t[l.name]=l.value}),t}var parseHeaders_1=parseHeaders$1,MapiResponse=mapiResponse,MapiError=mapiError,constants$2=constants$4,parseHeaders=parseHeaders_1,requestsUnderway={};function browserAbort(n){var t=requestsUnderway[n.id];!t||(t.abort(),delete requestsUnderway[n.id])}function createResponse(n,t){return new MapiResponse(n,{body:t.response,headers:parseHeaders(t.getAllResponseHeaders()),statusCode:t.status})}function normalizeBrowserProgressEvent(n){var t=n.total,s=n.loaded,l=100*s/t;return{total:t,transferred:s,percent:l}}function sendRequestXhr(n,t){return new Promise(function(s,l){t.onprogress=function(b){n.emitter.emit(constants$2.EVENT_PROGRESS_DOWNLOAD,normalizeBrowserProgressEvent(b))};var f=n.file;f&&(t.upload.onprogress=function(b){n.emitter.emit(constants$2.EVENT_PROGRESS_UPLOAD,normalizeBrowserProgressEvent(b))}),t.onerror=function(b){l(b)},t.onabort=function(){var b=new MapiError({request:n,type:constants$2.ERROR_REQUEST_ABORTED});l(b)},t.onload=function(){if(delete requestsUnderway[n.id],t.status<200||t.status>=400){var b=new MapiError({request:n,body:t.response,statusCode:t.status});l(b);return}s(t)};var m=n.body;typeof m=="string"?t.send(m):m?t.send(JSON.stringify(m)):f?t.send(f):t.send(),requestsUnderway[n.id]=t}).then(function(s){return createResponse(n,s)})}function createRequestXhr(n,t){var s=n.url(t),l=new window.XMLHttpRequest;return l.open(n.method,s),Object.keys(n.headers).forEach(function(f){l.setRequestHeader(f,n.headers[f])}),l}function browserSend(n){return Promise.resolve().then(function(){var t=createRequestXhr(n,n.client.accessToken);return sendRequestXhr(n,t)})}var browserLayer={browserAbort,sendRequestXhr,browserSend,createRequestXhr},base64$1={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */(function(n,t){(function(s){var l=t,f=n&&n.exports==l&&n,m=typeof commonjsGlobal=="object"&&commonjsGlobal;(m.global===m||m.window===m)&&(s=m);var b=function(G){this.message=G};b.prototype=new Error,b.prototype.name="InvalidCharacterError";var h=function(G){throw new b(G)},S="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",M=/[\t\n\f\r ]/g,C=function(G){G=String(G).replace(M,"");var H=G.length;H%4==0&&(G=G.replace(/==?$/,""),H=G.length),(H%4==1||/[^+a-zA-Z0-9/]/.test(G))&&h("Invalid character: the string to be decoded is not correctly encoded.");for(var K=0,X,de,Q="",ie=-1;++ie<H;)de=S.indexOf(G.charAt(ie)),X=K%4?X*64+de:de,K++%4&&(Q+=String.fromCharCode(255&X>>(-2*K&6)));return Q},L=function(G){G=String(G),/[^\0-\xFF]/.test(G)&&h("The string to be encoded contains characters outside of the Latin1 range.");for(var H=G.length%3,K="",X=-1,de,Q,ie,ce,ge=G.length-H;++X<ge;)de=G.charCodeAt(X)<<16,Q=G.charCodeAt(++X)<<8,ie=G.charCodeAt(++X),ce=de+Q+ie,K+=S.charAt(ce>>18&63)+S.charAt(ce>>12&63)+S.charAt(ce>>6&63)+S.charAt(ce&63);return H==2?(de=G.charCodeAt(X)<<8,Q=G.charCodeAt(++X),ce=de+Q,K+=S.charAt(ce>>10)+S.charAt(ce>>4&63)+S.charAt(ce<<2&63)+"="):H==1&&(ce=G.charCodeAt(X),K+=S.charAt(ce>>2)+S.charAt(ce<<4&63)+"=="),K},N={encode:L,decode:C,version:"0.1.0"};if(l&&!l.nodeType)if(f)f.exports=N;else for(var F in N)N.hasOwnProperty(F)&&(l[F]=N[F]);else s.base64=N})(commonjsGlobal)})(base64$1,base64$1.exports);var base64=base64$1.exports,tokenCache={};function parseToken$2(n){if(tokenCache[n])return tokenCache[n];var t=n.split("."),s=t[0],l=t[1];if(!l)throw new Error("Invalid token");var f=parsePaylod(l),m={usage:s,user:f.u};return has(f,"a")&&(m.authorization=f.a),has(f,"exp")&&(m.expires=f.exp*1e3),has(f,"iat")&&(m.created=f.iat*1e3),has(f,"scopes")&&(m.scopes=f.scopes),has(f,"client")&&(m.client=f.client),has(f,"ll")&&(m.lastLogin=f.ll),has(f,"iu")&&(m.impersonator=f.iu),tokenCache[n]=m,m}function parsePaylod(n){try{return JSON.parse(base64.decode(n))}catch{throw new Error("Invalid token")}}function has(n,t){return Object.prototype.hasOwnProperty.call(n,t)}var parseMapboxToken=parseToken$2,eventemitter3={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,s="~";function l(){}Object.create&&(l.prototype=Object.create(null),new l().__proto__||(s=!1));function f(S,M,C){this.fn=S,this.context=M,this.once=C||!1}function m(S,M,C,L,N){if(typeof C!="function")throw new TypeError("The listener must be a function");var F=new f(C,L||S,N),G=s?s+M:M;return S._events[G]?S._events[G].fn?S._events[G]=[S._events[G],F]:S._events[G].push(F):(S._events[G]=F,S._eventsCount++),S}function b(S,M){--S._eventsCount===0?S._events=new l:delete S._events[M]}function h(){this._events=new l,this._eventsCount=0}h.prototype.eventNames=function(){var M=[],C,L;if(this._eventsCount===0)return M;for(L in C=this._events)t.call(C,L)&&M.push(s?L.slice(1):L);return Object.getOwnPropertySymbols?M.concat(Object.getOwnPropertySymbols(C)):M},h.prototype.listeners=function(M){var C=s?s+M:M,L=this._events[C];if(!L)return[];if(L.fn)return[L.fn];for(var N=0,F=L.length,G=new Array(F);N<F;N++)G[N]=L[N].fn;return G},h.prototype.listenerCount=function(M){var C=s?s+M:M,L=this._events[C];return L?L.fn?1:L.length:0},h.prototype.emit=function(M,C,L,N,F,G){var H=s?s+M:M;if(!this._events[H])return!1;var K=this._events[H],X=arguments.length,de,Q;if(K.fn){switch(K.once&&this.removeListener(M,K.fn,void 0,!0),X){case 1:return K.fn.call(K.context),!0;case 2:return K.fn.call(K.context,C),!0;case 3:return K.fn.call(K.context,C,L),!0;case 4:return K.fn.call(K.context,C,L,N),!0;case 5:return K.fn.call(K.context,C,L,N,F),!0;case 6:return K.fn.call(K.context,C,L,N,F,G),!0}for(Q=1,de=new Array(X-1);Q<X;Q++)de[Q-1]=arguments[Q];K.fn.apply(K.context,de)}else{var ie=K.length,ce;for(Q=0;Q<ie;Q++)switch(K[Q].once&&this.removeListener(M,K[Q].fn,void 0,!0),X){case 1:K[Q].fn.call(K[Q].context);break;case 2:K[Q].fn.call(K[Q].context,C);break;case 3:K[Q].fn.call(K[Q].context,C,L);break;case 4:K[Q].fn.call(K[Q].context,C,L,N);break;default:if(!de)for(ce=1,de=new Array(X-1);ce<X;ce++)de[ce-1]=arguments[ce];K[Q].fn.apply(K[Q].context,de)}}return!0},h.prototype.on=function(M,C,L){return m(this,M,C,L,!1)},h.prototype.once=function(M,C,L){return m(this,M,C,L,!0)},h.prototype.removeListener=function(M,C,L,N){var F=s?s+M:M;if(!this._events[F])return this;if(!C)return b(this,F),this;var G=this._events[F];if(G.fn)G.fn===C&&(!N||G.once)&&(!L||G.context===L)&&b(this,F);else{for(var H=0,K=[],X=G.length;H<X;H++)(G[H].fn!==C||N&&!G[H].once||L&&G[H].context!==L)&&K.push(G[H]);K.length?this._events[F]=K.length===1?K[0]:K:b(this,F)}return this},h.prototype.removeAllListeners=function(M){var C;return M?(C=s?s+M:M,this._events[C]&&b(this,C)):(this._events=new l,this._eventsCount=0),this},h.prototype.off=h.prototype.removeListener,h.prototype.addListener=h.prototype.on,h.prefixed=s,h.EventEmitter=h,n.exports=h})(eventemitter3);function encodeArray(n){return n.map(encodeURIComponent).join(",")}function encodeValue(n){return Array.isArray(n)?encodeArray(n):encodeURIComponent(String(n))}function appendQueryParam(n,t,s){if(s===!1||s===null)return n;var l=/\?/.test(n)?"&":"?",f=encodeURIComponent(t);return s!==void 0&&s!==""&&s!==!0&&(f+="="+encodeValue(s)),""+n+l+f}function appendQueryObject(n,t){if(!t)return n;var s=n;return Object.keys(t).forEach(function(l){var f=t[l];f!==void 0&&(Array.isArray(f)&&(f=f.filter(function(m){return m!=null}).join(",")),s=appendQueryParam(s,l,f))}),s}function prependOrigin(n,t){if(!t||n.slice(0,4)==="http")return n;var s=n[0]==="/"?"":"/";return""+t.replace(/\/$/,"")+s+n}function interpolateRouteParams(n,t){return t?n.replace(/\/:([a-zA-Z0-9]+)/g,function(s,l){var f=t[l];if(f===void 0)throw new Error("Unspecified route parameter "+l);var m=encodeValue(f);return"/"+m}):n}var urlUtils$1={appendQueryObject,appendQueryParam,prependOrigin,interpolateRouteParams},parseToken$1=parseMapboxToken,xtend$3=immutable,EventEmitter$1=eventemitter3.exports,urlUtils=urlUtils$1,constants$1=constants$4,requestId=1;function MapiRequest$1(n,t){if(!n)throw new Error("MapiRequest requires a client");if(!t||!t.path||!t.method)throw new Error("MapiRequest requires an options object with path and method properties");var s={};t.body&&(s["content-type"]="application/json");var l=xtend$3(s,t.headers),f=Object.keys(l).reduce(function(m,b){return m[b.toLowerCase()]=l[b],m},{});this.id=requestId++,this._options=t,this.emitter=new EventEmitter$1,this.client=n,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=t.path,this.method=t.method,this.origin=t.origin||n.origin,this.query=t.query||{},this.params=t.params||{},this.body=t.body||null,this.file=t.file||null,this.encoding=t.encoding||"utf8",this.sendFileAs=t.sendFileAs||null,this.headers=f}MapiRequest$1.prototype.url=function n(t){var s=urlUtils.prependOrigin(this.path,this.origin);s=urlUtils.appendQueryObject(s,this.query);var l=this.params,f=t==null?this.client.accessToken:t;if(f){s=urlUtils.appendQueryParam(s,"access_token",f);var m=parseToken$1(f).user;l=xtend$3({ownerId:m},l)}return s=urlUtils.interpolateRouteParams(s,l),s};MapiRequest$1.prototype.send=function n(){var t=this;if(t.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return t.sent=!0,t.client.sendRequest(t).then(function(s){return t.response=s,t.emitter.emit(constants$1.EVENT_RESPONSE,s),s},function(s){throw t.error=s,t.emitter.emit(constants$1.EVENT_ERROR,s),s})};MapiRequest$1.prototype.abort=function n(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};MapiRequest$1.prototype.eachPage=function n(t){var s=this;function l(b){function h(){delete s._nextPageRequest;var S=b.nextPage();S&&(s._nextPageRequest=S,m(S))}t(null,b,h)}function f(b){t(b,null,function(){})}function m(b){b.send().then(l,f)}m(this)};MapiRequest$1.prototype.clone=function n(){return this._extend()};MapiRequest$1.prototype._extend=function n(t){var s=xtend$3(this._options,t);return new MapiRequest$1(this.client,s)};var mapiRequest=MapiRequest$1,parseToken=parseMapboxToken,MapiRequest=mapiRequest,constants=constants$4;function MapiClient$2(n){if(!n||!n.accessToken)throw new Error("Cannot create a client without an access token");parseToken(n.accessToken),this.accessToken=n.accessToken,this.origin=n.origin||constants.API_ORIGIN}MapiClient$2.prototype.createRequest=function n(t){return new MapiRequest(this,t)};var mapiClient=MapiClient$2,browser=browserLayer,MapiClient$1=mapiClient;function BrowserClient(n){MapiClient$1.call(this,n)}BrowserClient.prototype=Object.create(MapiClient$1.prototype);BrowserClient.prototype.constructor=BrowserClient;BrowserClient.prototype.sendRequest=browser.browserSend;BrowserClient.prototype.abortRequest=browser.browserAbort;function createBrowserClient(n){return new BrowserClient(n)}var browserClient=createBrowserClient,client=browserClient,mapboxSdk=client,toString=Object.prototype.toString,isPlainObj=function(n){var t;return toString.call(n)==="[object Object]"&&(t=Object.getPrototypeOf(n),t===null||t===Object.getPrototypeOf({}))},isPlainObject=isPlainObj,xtend$2=immutable,DEFAULT_ERROR_PATH="value",NEWLINE_INDENT=`
  `,v$2={};v$2.assert=function(n,t){return t=t||{},function(s){var l=validate(n,s);if(!!l){var f=processMessage(l,t);throw t.apiName&&(f=t.apiName+": "+f),new Error(f)}}};v$2.shape=function n(t){var s=objectEntries(t);return function(f){var m=validate(v$2.plainObject,f);if(m)return m;for(var b,h,S=[],M=0;M<s.length;M++)b=s[M].key,h=s[M].value,m=validate(h,f[b]),m&&S.push([b].concat(m));return S.length<2?S[0]:function(C){S=S.map(function(F){var G=F[0],H=processMessage(F,C).split(`
`).join(NEWLINE_INDENT);return"- "+G+": "+H});var L=C.path.join("."),N=L===DEFAULT_ERROR_PATH?"":" of "+L;return"The following properties"+N+" have invalid values:"+NEWLINE_INDENT+S.join(NEWLINE_INDENT)}}};v$2.strictShape=function n(t){var s=v$2.shape(t);return function(f){var m=s(f);if(m)return m;var b=Object.keys(f).reduce(function(h,S){return t[S]===void 0&&h.push(S),h},[]);if(b.length!==0)return function(){return"The following keys are invalid: "+b.join(", ")}}};v$2.arrayOf=function n(t){return createArrayValidator(t)};v$2.tuple=function n(){var t=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return createArrayValidator(t)};function createArrayValidator(n){var t=Array.isArray(n),s=function(l){return t?n[l]:n};return function(f){var m=validate(v$2.plainArray,f);if(m)return m;if(t&&f.length!==n.length)return"an array with "+n.length+" items";for(var b=0;b<f.length;b++)if(m=validate(s(b),f[b]),m)return[b].concat(m)}}v$2.required=function n(t){function s(l){return l==null?function(f){return formatErrorMessage(f,isArrayCulprit(f.path)?"cannot be undefined/null.":"is required.")}:t.apply(this,arguments)}return s.__required=!0,s};v$2.oneOfType=function n(){var t=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(l){var f=t.map(function(m){return validate(m,l)}).filter(Boolean);if(f.length===t.length)return f.every(function(m){return m.length===1&&typeof m[0]=="string"})?orList(f.map(function(m){return m[0]})):f.reduce(function(m,b){return b.length>m.length?b:m})}};v$2.equal=function n(t){return function(l){if(l!==t)return JSON.stringify(t)}};v$2.oneOf=function n(){var t=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),s=t.map(function(l){return v$2.equal(l)});return v$2.oneOfType.apply(this,s)};v$2.range=function n(t){var s=t[0],l=t[1];return function(m){var b=validate(v$2.number,m);if(b||m<s||m>l)return"number between "+s+" & "+l+" (inclusive)"}};v$2.any=function n(){};v$2.boolean=function n(t){if(typeof t!="boolean")return"boolean"};v$2.number=function n(t){if(typeof t!="number")return"number"};v$2.plainArray=function n(t){if(!Array.isArray(t))return"array"};v$2.plainObject=function n(t){if(!isPlainObject(t))return"object"};v$2.string=function n(t){if(typeof t!="string")return"string"};v$2.func=function n(t){if(typeof t!="function")return"function"};function validate(n,t){if(!(t==null&&!n.hasOwnProperty("__required"))){var s=n(t);if(s)return Array.isArray(s)?s:[s]}}function processMessage(n,t){var s=n.length,l=n[s-1],f=n.slice(0,s-1);return f.length===0&&(f=[DEFAULT_ERROR_PATH]),t=xtend$2(t,{path:f}),typeof l=="function"?l(t):formatErrorMessage(t,prettifyResult(l))}function orList(n){return n.length<2?n[0]:n.length===2?n.join(" or "):n.slice(0,-1).join(", ")+", or "+n.slice(-1)}function prettifyResult(n){return"must be "+addArticle(n)+"."}function addArticle(n){return/^an? /.test(n)?n:/^[aeiou]/i.test(n)?"an "+n:/^[a-z]/i.test(n)?"a "+n:n}function formatErrorMessage(n,t){var s=isArrayCulprit(n.path),l=n.path.join(".")+" "+t,f=s?"Item at position ":"";return f+l}function isArrayCulprit(n){return typeof n[n.length-1]=="number"||typeof n[0]=="number"}function objectEntries(n){return Object.keys(n||{}).map(function(t){return{key:t,value:n[t]}})}v$2.validate=validate;v$2.processMessage=processMessage;var lib$1=v$2,xtend$1=immutable,v$1=lib$1;function file(n){if(typeof window!="undefined")return n instanceof commonjsGlobal.Blob||n instanceof commonjsGlobal.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof n=="string"||n.pipe!==void 0))return"Filename or Readable stream"}function assertShape(n,t){return v$1.assert(v$1.strictShape(n),t)}function date(n){var t="date";if(typeof n=="boolean")return t;try{var s=new Date(n);if(s.getTime&&isNaN(s.getTime()))return t}catch{return t}}function coordinates(n){return v$1.tuple(v$1.number,v$1.number)(n)}var validator=xtend$1(v$1,{file,date,coordinates,assertShape});function pick$1(n,t){var s=function(l,f){return t.indexOf(l)!==-1&&f!==void 0};return typeof t=="function"&&(s=t),Object.keys(n).filter(function(l){return s(l,n[l])}).reduce(function(l,f){return l[f]=n[f],l},{})}var pick_1=pick$1;function objectMap$1(n,t){return Object.keys(n).reduce(function(s,l){return s[l]=t(l,n[l]),s},{})}var objectMap_1=objectMap$1,objectMap=objectMap_1;function stringifyBoolean(n){return objectMap(n,function(t,s){return typeof s=="boolean"?JSON.stringify(s):s})}var stringifyBooleans$1=stringifyBoolean,MapiClient=mapiClient,createClient=browserClient;function createServiceFactory$1(n){return function(t){var s;MapiClient.prototype.isPrototypeOf(t)?s=t:s=createClient(t);var l=Object.create(n);return l.client=s,l}}var createServiceFactory_1=createServiceFactory$1,xtend=immutable,v=validator,pick=pick_1,stringifyBooleans=stringifyBooleans$1,createServiceFactory=createServiceFactory_1,Geocoding={},featureTypes=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Geocoding.forwardGeocode=function(n){v.assertShape({query:v.required(v.string),mode:v.oneOf("mapbox.places","mapbox.places-permanent"),countries:v.arrayOf(v.string),proximity:v.oneOf(v.coordinates,"ip"),types:v.arrayOf(v.oneOf(featureTypes)),autocomplete:v.boolean,bbox:v.arrayOf(v.number),limit:v.number,language:v.arrayOf(v.string),routing:v.boolean,fuzzyMatch:v.boolean,worldview:v.string})(n),n.mode=n.mode||"mapbox.places";var t=stringifyBooleans(xtend({country:n.countries},pick(n,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(n,["mode","query"]),query:t})};Geocoding.reverseGeocode=function(n){v.assertShape({query:v.required(v.coordinates),mode:v.oneOf("mapbox.places","mapbox.places-permanent"),countries:v.arrayOf(v.string),types:v.arrayOf(v.oneOf(featureTypes)),bbox:v.arrayOf(v.number),limit:v.number,language:v.arrayOf(v.string),reverseMode:v.oneOf("distance","score"),routing:v.boolean,worldview:v.string})(n),n.mode=n.mode||"mapbox.places";var t=stringifyBooleans(xtend({country:n.countries},pick(n,["country","types","bbox","limit","language","reverseMode","routing","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(n,["mode","query"]),query:t})};var geocoding=createServiceFactory(Geocoding);let urlAlphabet="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",random=n=>crypto.getRandomValues(new Uint8Array(n)),customRandom=(n,t,s)=>{let l=(2<<Math.log(n.length-1)/Math.LN2)-1,f=-~(1.6*l*t/n.length);return(m=t)=>{let b="";for(;;){let h=s(f),S=f;for(;S--;)if(b+=n[h[S]&l]||"",b.length===m)return b}}},customAlphabet=(n,t=21)=>customRandom(n,t,random),nanoid$1=(n=21)=>crypto.getRandomValues(new Uint8Array(n)).reduce((t,s)=>(s&=63,s<36?t+=s.toString(36):s<62?t+=(s-26).toString(36).toUpperCase():s>62?t+="-":t+="_",t),"");var index_browser=Object.freeze(Object.defineProperty({__proto__:null,nanoid:nanoid$1,customAlphabet,customRandom,urlAlphabet,random},Symbol.toStringTag,{value:"Module"})),require$$0=getAugmentedNamespace(index_browser),nanoid=require$$0.nanoid;function MapboxEventManager$1(n){this.origin=n.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=n.accessToken,this.version="0.2.0",this.sessionID=this.generateSessionID(),this.userAgent=this.getUserAgent(),this.options=n,this.send=this.send.bind(this),this.countries=n.countries?n.countries.split(","):null,this.types=n.types?n.types.split(","):null,this.bbox=n.bbox?n.bbox:null,this.language=n.language?n.language.split(","):null,this.limit=n.limit?+n.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(n),this.eventQueue=new Array,this.flushInterval=n.flushInterval||1e3,this.maxQueueSize=n.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}MapboxEventManager$1.prototype={select:function(n,t){var s=this.getSelectedIndex(n,t),l=this.getEventPayload("search.select",t);if(l.resultIndex=s,l.resultPlaceName=n.place_name,l.resultId=n.id,!(s===this.lastSentIndex&&l.queryString===this.lastSentInput||s==-1)&&(this.lastSentIndex=s,this.lastSentInput=l.queryString,!!l.queryString))return this.push(l)},start:function(n){var t=this.getEventPayload("search.start",n);if(!!t.queryString)return this.push(t)},keyevent:function(n,t){if(!!n.key&&!(n.metaKey||[9,27,37,39,13,38,40].indexOf(n.keyCode)!==-1)){var s=this.getEventPayload("search.keystroke",t);if(s.lastAction=n.key,!!s.queryString)return this.push(s)}},send:function(n,t){if(!this.enableEventLogging)return t?t():void 0;var s=this.getRequestOptions(n);this.request(s,function(l){if(l)return this.handleError(l,t);if(t)return t()}.bind(this))},getRequestOptions:function(n){Array.isArray(n)||(n=[n]);var t={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)};return t},getEventPayload:function(n,t){var s;t.options.proximity?typeof t.options.proximity=="object"?s=[t.options.proximity.longitude,t.options.proximity.latitude]:t.options.proximity==="ip"?s=[999,999]:s=t.options.proximity:s=null;var l=t._map?t._map.getZoom():void 0,f={event:n,created:+new Date,sessionIdentifier:this.sessionID,country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:t.options.autocomplete,fuzzyMatch:t.options.fuzzyMatch,proximity:s,limit:t.options.limit,routing:t.options.routing,worldview:t.options.worldview,mapZoom:l,keyboardLocale:this.locale};return n==="search.select"?f.queryString=t.inputString:n!="search.select"&&t._inputEl?f.queryString=t._inputEl.value:f.queryString=t.inputString,f},request:function(n,t){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(this.readyState==4)return this.status==204?t(null):t(this.statusText)},s.open(n.method,n.host+"/"+n.path,!0);for(var l in n.headers){var f=n.headers[l];s.setRequestHeader(l,f)}s.send(n.body)},handleError:function(n,t){if(t)return t(n)},generateSessionID:function(){return nanoid()},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(n,t){if(!!t._typeahead){var s=t._typeahead.data,l=n.id,f=s.map(function(b){return b.id}),m=f.indexOf(l);return m}},shouldEnableLogging:function(n){return!(n.enableEventLogging===!1||n.origin&&n.origin.indexOf("api.mapbox.com")==-1||n.localGeocoder||n.filter)},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(n,t){this.eventQueue.push(n),(this.eventQueue.length>=this.maxQueueSize||t)&&this.flush()},remove:function(){this.flush()}};var events=MapboxEventManager$1,placeholder={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"\u05DC\u05D7\u05E4\u05E9",ja:"\u30B5\u30FC\u30C1",lv:"Mekl\u0113t",pt:"Procurar",sr:"\u041F\u0440\u0435\u0442\u0440\u0430\u0433\u0430",zh:"\u641C\u7D22",cs:"Vyhled\xE1v\xE1n\xED",hu:"Keres\xE9s",ka:"\u10EB\u10D8\u10D4\u10D1\u10D0",nb:"S\xF8ke",sk:"Vyh\u013Ead\xE1vanie",th:"\u0E04\u0E49\u0E19\u0E2B\u0E32",fi:"Hae",is:"Leita",ko:"\uC218\uC0C9",pl:"Szukaj",sl:"Iskanje",fa:"\u062C\u0633\u062A\u062C\u0648",ru:"\u041F\u043E\u0438\u0441\u043A"},localization$1={placeholder},subtag$1={exports:{}};(function(n){(function(t,s,l){n.exports?n.exports=l():t[s]=l()})(commonjsGlobal,"subtag",function(){var t="",s=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function l(S){return S.match(s)||[]}function f(S){return l(S).filter(function(M,C){return M&&C})}function m(S){return S=l(S),{language:S[1]||t,extlang:S[2]||t,script:S[3]||t,region:S[4]||t}}function b(S,M,C){Object.defineProperty(S,M,{value:C,enumerable:!0})}function h(S,M,C){function L(N){return l(N)[S]||t}b(L,"pattern",M),b(m,C,L)}return h(1,/^[a-zA-Z]{2,3}$/,"language"),h(2,/^[a-zA-Z]{3}$/,"extlang"),h(3,/^[a-zA-Z]{4}$/,"script"),h(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),b(m,"split",f),m})})(subtag$1);function Geolocation$1(){}Geolocation$1.prototype={isSupport:function(){return Boolean(window.navigator.geolocation)},getCurrentPosition:function(){const n={enableHighAccuracy:!0};return new Promise(function(t,s){window.navigator.geolocation.getCurrentPosition(t,s,n)})}};var geolocation=Geolocation$1;function transformFeatureToGeolocationText(n,t){const s=getAddressInfo(n),l=["address","street","place","country"];var f;if(typeof t=="function")return t(s);const m=l.indexOf(t);return m===-1?f=l:f=l.slice(m),f.reduce(function(b,h){return s[h]?(b!==""&&(b=b+", "),b+s[h]):b},"")}function getAddressInfo(n){const t=n.address||"",s=n.text||"",l=n.place_name||"",m={address:l.split(",")[0],houseNumber:t,street:s,placeName:l};return n.context.forEach(function(b){const h=b.id.split(".")[0];m[h]=b.text}),m}var utils$1={transformFeatureToGeolocationText,getAddressInfo},Typeahead=suggestions,debounce=lodash_debounce,extend=immutable,EventEmitter=events$1.exports.EventEmitter,exceptions=exceptions$1,MapboxClient=mapboxSdk,mbxGeocoder=geocoding,MapboxEventManager=events,localization=localization$1,subtag=subtag$1.exports,Geolocation=geolocation,utils=utils$1;const GEOCODE_REQUEST_TYPE={FORWARD:0,LOCAL:1,REVERSE:2};function getFooterNode(){var n=document.createElement("div");return n.className="mapboxgl-ctrl-geocoder--powered-by",n.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',n}function MapboxGeocoder(n){this._eventEmitter=new EventEmitter,this.options=extend({},this.options,n),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new Geolocation}MapboxGeocoder.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",getItemValue:function(n){return n.place_name},render:function(n){var t=n.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+t[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+t.splice(1,t.length).join(",")+"</div></div>"}},addTo:function(n){function t(s,l){if(!document.body.contains(l))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const f=s.onAdd();l.appendChild(f)}if(n._controlContainer)n.addControl(this);else if(n instanceof HTMLElement)t(this,n);else if(typeof n=="string"){const s=document.querySelectorAll(n);if(s.length===0)throw new Error("Element ",n,"not found.");if(s.length>1)throw new Error("Geocoder can only be added to a single html element");t(this,s[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(n){if(n&&typeof n!="string"&&(this._map=n),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new MapboxEventManager(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this);var t=this.container=document.createElement("div");t.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var s=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",debounce(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",function(M){this.eventManager.keyevent(M,this)}.bind(this));var l=document.createElement("div");l.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var f=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(f),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),l.appendChild(this._clearEl),l.appendChild(this._loadingEl),t.appendChild(s),t.appendChild(this._inputEl),t.appendChild(l),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var m=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(m),l.appendChild(this._geolocateEl),this._showGeolocateButton()}var b=this._typeahead=new Typeahead(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit});this.setRenderFunction(this.options.render),b.getItemValue=this.options.getItemValue;var h=b.list.draw,S=this._footerNode=getFooterNode();return b.list.draw=function(){h.call(this),S.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),S.addEventListener("mouseup",function(){this.selectingListItem=!1}.bind(this)),this.element.appendChild(S)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),t},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then(function(n){this._hideLoadingIcon();const t={geometry:{type:"Point",coordinates:[n.coords.longitude,n.coords.latitude]}};this._handleMarker(t),this._fly(t),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(t),this._showClearButton(),this.fresh=!1;const s={limit:1,language:[this.options.language],query:t.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){const l=t.geometry.coordinates[0]+","+t.geometry.coordinates[1];this._setInputValue(l),this._eventEmitter.emit("result",{result:t})}else this.geocoderService.reverseGeocode(s).send().then(function(l){const f=l.body.features[0];if(f){const m=utils.transformFeatureToGeolocationText(f,this.options.addressAccuracy);this._setInputValue(m),f.user_coordinates=t.geometry.coordinates,this._eventEmitter.emit("result",{result:f})}else this._eventEmitter.emit("result",{result:{user_coordinates:t.geometry.coordinates}})}.bind(this))}.bind(this)).catch(function(n){n.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}.bind(this))},createIcon:function(n,t){var s=document.createElementNS("http://www.w3.org/2000/svg","svg");return s.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+n),s.setAttribute("viewBox","0 0 18 18"),s.setAttribute("xml:space","preserve"),s.setAttribute("width",18),s.setAttribute("height",18),s.innerHTML=t,s},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(n){this._inputEl.value=n,setTimeout(function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}.bind(this),1)},_onPaste:function(n){var t=(n.clipboardData||window.clipboardData).getData("text");t.length>=this.options.minLength&&this._geocode(t)},_onKeyDown:function(n){var t=27,s=9;if(n.keyCode===t&&this.options.clearAndBlurOnEsc)return this._clear(n),this._inputEl.blur();var l=n.target&&n.target.shadowRoot?n.target.shadowRoot.activeElement:n.target,f=l?l.value:"";if(!f)return this.fresh=!0,n.keyCode!==s&&this.clear(n),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(n.metaKey||[s,t,37,39,13,38,40].indexOf(n.keyCode)!==-1)&&l.value.length>=this.options.minLength&&this._geocode(l.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(n){this.options.clearOnBlur&&this._clearOnBlur(n),this.options.collapsed&&this._collapse()},_onChange:function(){var n=this._typeahead.selected;n&&JSON.stringify(n)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(n),this.options.marker&&this._mapboxgl&&this._handleMarker(n),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(n),this._eventEmitter.emit("result",{result:n}),this.eventManager.select(n,this))},_fly:function(n){var t;if(n.properties&&exceptions[n.properties.short_code])t=extend({},this.options.flyTo),this._map&&this._map.fitBounds(exceptions[n.properties.short_code].bbox,t);else if(n.bbox){var s=n.bbox;t=extend({},this.options.flyTo),this._map&&this._map.fitBounds([[s[0],s[1]],[s[2],s[3]]],t)}else{var l={zoom:this.options.zoom};t=extend({},l,this.options.flyTo),n.center?t.center=n.center:n.geometry&&n.geometry.type&&n.geometry.type==="Point"&&n.geometry.coordinates&&(t.center=n.geometry.coordinates),this._map&&this._map.flyTo(t)}},_requestType:function(n,t){var s;const l=/^[ ]*(-?\d+\.?\d*)[, ]+(-?\d+\.?\d*)[ ]*$/;return n.localGeocoderOnly?s=GEOCODE_REQUEST_TYPE.LOCAL:n.reverseGeocode&&l.test(t)?s=GEOCODE_REQUEST_TYPE.REVERSE:s=GEOCODE_REQUEST_TYPE.FORWARD,s},_setupConfig:function(n,t){const s=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],l=/[\s,]+/;var f=this,m=s.reduce(function(h,S){if(f.options[S]===void 0||f.options[S]===null)return h;["countries","types","language"].indexOf(S)>-1?h[S]=f.options[S].split(l):h[S]=f.options[S];const M=typeof f.options[S].longitude=="number"&&typeof f.options[S].latitude=="number";if(S==="proximity"&&M){const C=f.options[S].longitude,L=f.options[S].latitude;h[S]=[C,L]}return h},{});switch(n){case GEOCODE_REQUEST_TYPE.REVERSE:{var b=t.split(l).map(function(h){return parseFloat(h,10)});f.options.flipCoordinates||b.reverse(),m.types&&m.types[0],m=extend(m,{query:b,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(h){h in m&&delete m[h]})}break;case GEOCODE_REQUEST_TYPE.FORWARD:/^[ ]*(-?\d+\.?\d*)[, ]+(-?\d+\.?\d*)*[ ]*$/.test(t)&&(t=t.replace(/,/g," ")),m=extend(m,{query:t});break}return m},_geocode:function(n){this.inputString=n,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:n});const t=this._requestType(this.options,n),s=this._setupConfig(t,n);var l;switch(t){case GEOCODE_REQUEST_TYPE.LOCAL:l=Promise.resolve();break;case GEOCODE_REQUEST_TYPE.FORWARD:l=this.geocoderService.forwardGeocode(s).send();break;case GEOCODE_REQUEST_TYPE.REVERSE:l=this.geocoderService.reverseGeocode(s).send();break}var f=this.options.localGeocoder?this.options.localGeocoder(n)||[]:[],m=[],b=null;return l.catch(function(h){b=h}.bind(this)).then(function(h){this._hideLoadingIcon();var S={};return h?h.statusCode=="200"&&(S=h.body,S.request=h.request,S.headers=h.headers):S={type:"FeatureCollection",features:[]},S.config=s,this.fresh&&(this.eventManager.start(this),this.fresh=!1),S.features=S.features?f.concat(S.features):f,this.options.externalGeocoder?(m=this.options.externalGeocoder(n,S.features)||Promise.resolve([]),m.then(function(M){return S.features=S.features?M.concat(S.features):M,S},function(){return S})):S}.bind(this)).then(function(h){if(b)throw b;this.options.filter&&h.features.length&&(h.features=h.features.filter(this.options.filter)),h.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",h),this._typeahead.update(h.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",h))}.bind(this)).catch(function(h){this._hideLoadingIcon(),this._hideAttribution(),f.length&&this.options.localGeocoder||m.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(f)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:f}),this._eventEmitter.emit("error",{error:h})}.bind(this)),l},_clear:function(n){n&&n.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(n){this._clear(n),this._inputEl.focus()},_clearOnBlur:function(n){var t=this;n.relatedTarget&&t._clear(n)},_onQueryResult:function(n){var t=n.body;if(!!t.features.length){var s=t.features[0];this._typeahead.selected=s,this._inputEl.value=s.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var n=this._map.getCenter().wrap();this.setProximity({longitude:n.lng,latitude:n.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(n){return this._geocode(n).then(this._onQueryResult),this},_renderError:function(){var n="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(n)},_renderLocationError:function(){var n="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(n)},_renderNoResults:function(){var n="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(n)},_renderUserDeniedGeolocationError:function(){var n="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(n)},_renderMessage:function(n){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(n)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var n=this.options.language.split(",")[0],t=subtag.language(n),s=localization.placeholder[t];if(s)return s}return"Search"},setInput:function(n){return this._inputEl.value=n,this._typeahead.selected=null,this._typeahead.clear(),n.length>=this.options.minLength&&this._geocode(n),this},setProximity:function(n,t=!0){return this.options.proximity=n,t&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(n){return n&&typeof n=="function"&&(this._typeahead.render=n),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(n){var t=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=n||this.options.language||t,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(n){return this.options.zoom=n,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(n){return this.options.flyTo=n,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(n){return this.placeholder=n||this._getPlaceholderText(),this._inputEl.placeholder=this.placeholder,this._inputEl.setAttribute("aria-label",this.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(n){return this.options.bbox=n,this},getCountries:function(){return this.options.countries},setCountries:function(n){return this.options.countries=n,this},getTypes:function(){return this.options.types},setTypes:function(n){return this.options.types=n,this},getMinLength:function(){return this.options.minLength},setMinLength:function(n){return this.options.minLength=n,this._typeahead&&(this._typeahead.options.minLength=n),this},getLimit:function(){return this.options.limit},setLimit:function(n){return this.options.limit=n,this._typeahead&&(this._typeahead.options.limit=n),this},getFilter:function(){return this.options.filter},setFilter:function(n){return this.options.filter=n,this},setOrigin:function(n){return this.options.origin=n,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(n){return this.options.accessToken=n,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(n){return this.options.autocomplete=n,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(n){return this.options.fuzzyMatch=n,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(n){return this.options.routing=n,this},getRouting:function(){return this.options.routing},setWorldview:function(n){return this.options.worldview=n,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(n){if(!!this._map){this._removeMarker();var t={color:"#4668F2"},s=extend({},t,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(s),n.center?this.mapMarker.setLngLat(n.center).addTo(this._map):n.geometry&&n.geometry.type&&n.geometry.type==="Point"&&n.geometry.coordinates&&this.mapMarker.setLngLat(n.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(n,t){return this._eventEmitter.on(n,t),this},off:function(n,t){return this._eventEmitter.removeListener(n,t),this.eventManager.remove(),this}};var lib=MapboxGeocoder,mapboxMapViewer_vue_vue_type_style_index_0_lang="";let geocoder;const _sfc_main$3={name:"mapbox-map-viewer",setup(){return{dirHandle:ref(""),style_url:ref(""),access_token:ref(""),mapbox_raster_png_dem:ref(""),mapbox_api_url:ref(""),mapbox_rgb_image_url:ref(""),map:ref(""),threedview:ref(!1),layers:ref(["hillshading","bounding_box","undersea-features-lines","undersea-features-points","undersea-features-points-label","10m-bathymetry-81bsvj"]),layer_type:[{label:"Hillshade",value:"hillshading"},{label:"Bounding Box",value:"bounding_box"},{label:"Undersea Lines",value:"undersea-features-lines"},{label:"Undersea Points",value:"undersea-features-points"},{label:"Undersea Labels",value:"undersea-features-points-label"},{label:"Depth",value:"10m-bathymetry-81bsvj"},{label:"Satellite",value:"satellite"},{label:"3D",value:"3d"}]}},mounted(){},methods:{async changeLayers(n){for(const t of this.layer_type)n.includes(t.value)?t.value!=="3d"?this.map.setLayoutProperty(t.value,"visibility","visible"):this.map.setTerrain({source:"mapbox-3d",exaggeration:1.5}):t.value!=="3d"?this.map.setLayoutProperty(t.value,"visibility","none"):this.map.setTerrain(null)},loadMapSourcesLayers(n){n.addSource("mapbox_terrain_dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1"}),n.addSource("satellite",{type:"raster",url:"mapbox://mapbox.satellite",tileSize:512}),n.addLayer({id:"satellite",source:"satellite",type:"raster",layout:{visibility:"none"}}),n.addLayer({id:"hillshading",source:"mapbox_terrain_dem",type:"hillshade"}),n.addSource("bounding_box_source",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,1],[1,1],[1,0],[0,0]]]}}}),n.addLayer({id:"bounding_box",type:"fill",source:"bounding_box_source",paint:{"fill-color":"#008888","fill-opacity":0}}),n.addSource("bathymetry",{type:"vector",url:"mapbox://mapbox-public.bathymetry"}),n.addLayer({id:"undersea-features-lines",type:"line",source:"bathymetry","source-layer":"undersea-features-lines",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ff69b4","line-width":2}}),n.addLayer({id:"undersea-features-points",type:"circle",source:"bathymetry","source-layer":"undersea-features-points",paint:{"circle-radius":4,"circle-color":"#01fe01"}}),n.addLayer({id:"undersea-features-points-label",type:"symbol",source:"bathymetry","source-layer":"undersea-features-points",layout:{"text-field":"{name}","text-anchor":"top-left","text-size":12}}),n.addSource("10m-bathymetry-81bsvj",{type:"vector",url:"mapbox://mapbox.9tm8dx88"}),n.addSource("mapbox-3d",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:14}),n.addLayer({id:"10m-bathymetry-81bsvj",type:"fill",source:"10m-bathymetry-81bsvj","source-layer":"10m-bathymetry-81bsvj",layout:{},paint:{"fill-outline-color":"hsla(337, 82%, 62%, 0)","fill-color":["interpolate",["cubic-bezier",0,.5,1,.5],["get","DEPTH"],200,"#78bced",9e3,"#15659f"]}},"land-structure-polygon")},async loadMapboxMap(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.mapbox_api_url=await idbKeyval.get("mapbox_api_url"),this.dirHandle=await idbKeyval.get("dirHandle"),this.style_url=await idbKeyval.get("style_url"),this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem");let n=this,t=new mapboxgl.Map({container:"map",trackResize:!0,style:n.style_url,center:[-121.7598,46.876],zoom:9,doubleClickZoom:!0,antialias:!0,boxZoom:!0,failIfMajorPerformanceCaveat:!0});this.map=t;const s=function(b){const h=b.match(/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i);if(!h)return null;function S(N,F){return{center:[N,F],geometry:{type:"Point",coordinates:[N,F]},place_name:"Lat: "+F+" Lng: "+N,place_type:["coordinate"],properties:{},type:"Feature"}}const M=Number(h[1]),C=Number(h[2]),L=[];return(M<-90||M>90)&&L.push(S(M,C)),(C<-90||C>90)&&L.push(S(C,M)),L.length===0&&(L.push(S(M,C)),L.push(S(C,M))),L};geocoder=new lib({accessToken:this.access_token,mapboxgl,localGeocoder:s,zoom:10,placeholder:"Try: -40, 170 or  Name",reverseGeocode:!0}),t.addControl(geocoder),t.addControl(new mapboxgl.FullscreenControl({})),t.addControl(new mapboxgl.NavigationControl);const l=100,f=25;function m(b){return b*(2-b)}t.on("style.load",()=>{const b=()=>{t.isStyleLoaded()?n.loadMapSourcesLayers(t):setTimeout(b,200)};b()}),t.on("load",function(){t.getCanvas().focus(),t.getCanvas().addEventListener("keydown",b=>{b.preventDefault(),b.which===87?t.panBy([0,-l],{easing:m}):b.which===83?t.panBy([0,l],{easing:m}):b.which===65?t.easeTo({bearing:t.getBearing()-f,easing:m}):b.which===68&&t.easeTo({bearing:t.getBearing()+f,easing:m})},!0)}),t.on("error",b=>{console.error(b)}),t.on("click",async function(b){let h=await idbKeyval.get("dirHandle");if(await fileUtils.verifyPermission(h,!0)===!1){console.error(`User did not grant permission to '${h.name}'`);return}let S=b.lngLat.lng,M=b.lngLat.lat,C=mapUtils.getTileInfo(S,M,t);idbKeyval.set("tile_info",C),await n.geoCodeReverse(C),t.getSource("bounding_box_source").setData(C.polygon_bb),t.setPaintProperty("bounding_box","fill-opacity",.45),n.mapbox_rgb_image_url=n.mapbox_api_url+n.mapbox_raster_png_dem+`/${C.z}/${C.x}/${C.y}@2x.pngraw?access_token=`+n.access_token;let L=await mapUtils.getMapboxTerrainRgb(h,C,n.mapbox_rgb_image_url),N=await L.toBuffer();await idbKeyval.set("rgb_image_buffer",N),await fileUtils.writeFileToDisk(h,C.rgbFileName,N);let F=mapUtils.createHeightMapImage(L,32,"GREY");if(await fileUtils.fileExists(h,C.thirtyTwoFileName)===!1){let H=await F.image.toBuffer();await fileUtils.writeFileToDisk(h,C.thirtyTwoFileName,H)}emitter.emit("updatePreviewImage",{dir_handle:h,tile_info:C,preview_image_info:F,map:t})}),t.on("mousemove",b=>{t.getCanvas().style.cursor="pointer";const h=t.queryRenderedFeatures(b.point);for(const S of h)if(Object.keys(S.type).length>0&&Object.keys(S.properties).length>0){let M=S.properties;S.layer,M.DEPTH}})},resizeMap(){this.map.resize()},async geoCodeReverse(n){geocoding({accessToken:mapboxgl.accessToken}).reverseGeocode({query:[n.pointLng,n.pointLat]}).send().then(function(s){if(s&&s.body&&s.body.features){n.address=s.body.features[0].place_name;let l=s.body.features[0].context;for(let f of l){let m=f.id;switch(m.substring(0,m.indexOf("."))){case"neighborhood":n.neighborhood=f.text;break;case"postcode":n.postcode=f.text;break;case"locality":n.locality=f.text;break;case"place":n.place=f.text;break;case"district":n.district=f.text;break;case"region":n.region=f.text;break;case"country":n.country=f.text;break}}}})}}},_hoisted_1$3={id:"map"},_hoisted_2$3={class:"row no-wrap q-pa-md"},_hoisted_3$2={class:"column"},_hoisted_4$2=createBaseVNode("u",null,[createBaseVNode("b",null,"Enable Layers")],-1);function _sfc_render$3(n,t,s,l,f,m){const b=resolveComponent("q-option-group"),h=resolveComponent("q-menu"),S=resolveComponent("q-btn"),M=resolveComponent("q-toolbar");return openBlock(),createElementBlock("div",_hoisted_1$3,[createVNode(M,{id:"mb-tbar",class:"bg-primary text-white q-pa-none q-ma-none"},{default:withCtx(()=>[createVNode(S,{color:"info",label:"Map Settings"},{default:withCtx(()=>[createVNode(h,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_2$3,[createBaseVNode("div",_hoisted_3$2,[_hoisted_4$2,createVNode(b,{dense:"",color:"green","checked-icon":"check","unchecked-icon":"clear",options:l.layer_type,type:"toggle",modelValue:l.layers,"onUpdate:modelValue":[t[0]||(t[0]=C=>l.layers=C),m.changeLayers]},null,8,["options","modelValue","onUpdate:modelValue"])])])]),_:1})]),_:1})]),_:1})])}var MapboxMapViewer=_export_sfc(_sfc_main$3,[["render",_sfc_render$3]]);let gdalWorker=new Worker("gdalWorker.js");const _sfc_main$2={name:"SideNav",setup(){const n=useQuasar();return{alert:ref(!1),isDisabled:ref(!1),unrealLandscape:ref({label:505,value:505}),landscapeSize:[{label:"8129x8129",value:8129},{label:"4033x4033",value:4033},{label:"2017x2017",value:2017},{label:"1009x1009",value:1009},{label:"512x512-Downloaded-Size",value:512},{label:"505x505",value:505}],url:ref("thirtytwo-9-82-180.png"),tile_info:ref(""),dirHandle:ref(""),preview_image_info:ref(""),rgb_image:ref(""),map:null,data:null,bbinfoalert:ref(!1),exportType:ref("unreal"),landscapeName:ref(""),unrealMapPath:ref(""),qt:n,otherOptionsModel:ref(["zrange"]),alertMsg:ref(""),otherOptions:[{label:"Zrange-sea level=0",value:"zrange"}],exportOptions:[{label:"Unreal",value:"unreal"},{label:"Normalize",value:"normalize"},{label:"None",value:"none"}]}},async mounted(){emitter.on("updatePreviewImage",n=>{this.data=n,this.updatePreviewImage()}),gdalWorker.onmessage=async n=>{await this.saveImage(n.data)}},methods:{adjustedZscale(){let n=this.getUnrealZScale(this.preview_image_info.maxElevation),t=32767;return this.otherOptionsModel.includes("zrange")?(this.tile_info.startZRange=t,this.tile_info.zscale=(t/n).toFixed(3)):(this.tile_info.startZRange=0,this.tile_info.zscale=n.toFixed(3)),this.tile_info.zscale},otherOptionsModelChange(n){this.otherOptionsModel=n,this.adjustedZscale()},showBBInfo(){this.tile_info?this.bbinfoalert=!0:this.alert=!0},async sendToUnreal(){this.unrealMapPath=await idbKeyval.get("mappath");let n=this.tile_info.sixteenFileName,t=await idbKeyval.get("dirHandle");if(fileUtils.verifyPermission(t,!0)===!1){console.error(`User did not grant permission to '${t.name}'`);return}let s=await fileUtils.fileExists(t,n),l;if(s)if(this.tile_info){console.log("sending"),this.qt.loading.show(),this.tile_info.landscapeName=this.landscapeName;let f="http://localhost:30010/",m="remote/object/call",b={};b={objectPath:"/Script/UnrealEd.Default__EditorActorSubsystem",functionName:"GetAllLevelActors"};let h="",S="Mapbox_BP",M=await mapUtils.unrealRemoteControl(b,f+m);for(let C of M.ReturnValue)C.includes(S)===!0&&(h=C);b={objectPath:h,functionName:"GenerateMapboxLandscape",parameters:{LandscapeName:this.tile_info.landscapeName,LandscapeSize:this.tile_info.resolution.toString(),TileHeightmapFileName:this.tile_info.sixteenFileName,TileGeojsonFileName:this.tile_info.geoJsonFileName,TileInfoFileName:this.tile_info.tileInfoFileName,OriginLng:this.tile_info.originLng.toString(),OriginLat:this.tile_info.originLat.toString(),Epsg:this.tile_info.epsg.toString(),OriginNorthing:this.tile_info.OriginNorthing.toString(),OriginEasting:this.tile_info.OriginEasting.toString(),PointNorthing:this.tile_info.pointNorthing.toString(),PointEasting:this.tile_info.pointEasting.toString()}},l=await mapUtils.unrealRemoteControl(b,f+m),console.log(l),this.qt.loading.hide()}else this.alert=!0;else this.alertMsg="Please download heightmap first",this.alert=!0},async saveImage(n){let t=await idbKeyval.get("dirHandle"),s=new Blob([n],{type:"image/tif"});await fileUtils.writeFileToDisk(t,"test.tif",s),this.qt.loading.hide()},updateStats(){this.preview_image_info.maxElevation!==""?(this.tile_info.MaxElevation=this.preview_image_info.maxElevation,this.tile_info.MinElevation=this.preview_image_info.minElevation,this.tile_info.minmax=this.tile_info.MinElevation.toFixed(3)+" / "+this.tile_info.MaxElevation.toFixed(3),this.tile_info.elevation_range=(this.tile_info.MaxElevation-this.tile_info.MinElevation).toFixed(3),this.tile_info.zscale=this.adjustedZscale()):this.tile_info.minmax=""},getUnrealZScale(n){return n*100*.001953125},async writeFiles(n){let t=await idbKeyval.get("dirHandle");await fileUtils.writeFileToDisk(t,this.tile_info.sixteenFileName,n);let s=mapUtils.getFeaturesFromBB(this.map,this.tile_info),l=JSON.stringify(s),f=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(t,l),await fileUtils.writeFileToDisk(t,this.tile_info.tileInfoFileName,f)},async updatePreviewImage(){this.preview_image_info=await this.data.preview_image_info,this.tile_info=this.data.tile_info,this.map=this.data.map;let n=await this.preview_image_info.image.toBlob();const t=URL.createObjectURL(n);this.url=t,this.updateStats(this.tile_info)},async createSixteenHeightMap(){if(this.tile_info.resolution=this.unrealLandscape.value,this.tile_info.geoJsonFileName="geojson-"+this.tile_info.mapboxTileName+".json",this.tile_info.tileInfoFileName="tile-info-"+this.tile_info.mapboxTileName+".json",this.tile_info.sixteenFileName="sixteen-"+this.tile_info.mapboxTileName+"-LandscapeSize-"+this.tile_info.resolution+".png",this.tile_info){this.qt.loading.show();let n=await idbKeyval.get("dirHandle");if(fileUtils.verifyPermission(n,!0)===!1){console.error(`User did not grant permission to '${n.name}'`);return}if(fileUtils.fileExists(n,this.tile_info.thirtytwoFile)){let s=await idbKeyval.get("rgb_image_buffer"),l=await mapUtils.loadImageFromArray(s),f=mapUtils.createHeightMapImage(l,16,"GREY"),m=f.image,b=parseInt(f.minElevation).toString(),h=parseInt(f.maxElevation).toString(),S=await m.toBuffer();this.tile_info.resampleSize=this.unrealLandscape.value.toString(),this.tile_info.resizeMethod="lanczos",this.tile_info.exportType=this.exportType;let M=mapUtils.converLatLngTotUtm(this.tile_info.originLat,this.tile_info.originLng);switch(this.tile_info.OriginNorthing=M.northing,this.tile_info.OriginEasting=M.easting,this.tile_info.exportType){case"unreal":let G=["-ot","UInt16","-of","PNG","-scale",b,h,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod];G=["-of","GTiff","-a_srs","EPSG:4326","-a_ullr",this.tile_info.bboxNW.lng,this.tile_info.bboxNW.lat,this.tile_info.bboxSE.lng,this.tile_info.bboxSE.lat];let H=new File([S],"heightmap.png",{type:"image/png",lastModified:Date.now()}),K=new DataTransfer;K.items.add(H);let X=K.files,de={};de.files=X,de.translateOptions=G,gdalWorker.postMessage(de);break;case"normalize":m=m.level(),await fileUtils.writeFileToDisk(n,this.tile_info.sixteenFileName,m.toBuffer()),this.qt.loading.hide();break;case"none":await fileUtils.writeFileToDisk(n,this.tile_info.sixteenFileName,m.toBuffer()),this.qt.loading.hide();break}let C=mapUtils.getFeaturesFromBB(this.map,this.tile_info),L=mapUtils.convertGeoJsonCoordinatesToUTM(C),N=JSON.stringify(L),F=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(n,this.tile_info.geoJsonFileName,N),await fileUtils.writeFileToDisk(n,this.tile_info.tileInfoFileName,F)}else this.alertMsg="Please download file first",this.alert=!0}else this.alert=!0}}},_hoisted_1$2=createBaseVNode("div",{id:"previewTitle",class:"text-h6 bg-primary text-white"},"Preview Image",-1),_hoisted_2$2={class:"row justify-start q-pa-none q-ma-none"},_hoisted_3$1={style:{width:"100%"}},_hoisted_4$1={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_5$1={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_6$1=createTextVNode("Export Type:"),_hoisted_7$1={class:"row justify-around q-pt-none q-mt-sm"},_hoisted_8$1={class:"row justify-betweenq-pt-none q-mt-xs"},_hoisted_9=createBaseVNode("div",{class:"text-h6"},[createBaseVNode("u",null,"Coordinates for Unreal LandscapeGen Plugin")],-1),_hoisted_10=createBaseVNode("div",{class:"text-h6"},"Max Latitude:",-1),_hoisted_11=createBaseVNode("div",{class:"text-h6"},"Max Longitude:",-1),_hoisted_12=createBaseVNode("div",{class:"text-h6"}," Min Latitude:",-1),_hoisted_13=createBaseVNode("div",{class:"text-h6"}," Min Longitude:",-1),_hoisted_14=createBaseVNode("div",{class:"text-h6"},"Zoom:",-1),_hoisted_15=createBaseVNode("div",{class:"text-h6"},"Mouse Point Lat:",-1),_hoisted_16=createBaseVNode("div",{class:"text-h6"},"Mouse Point Lng:",-1),_hoisted_17=createBaseVNode("div",{class:"text-h6"},"Mouse Point Northing:",-1),_hoisted_18=createBaseVNode("div",{class:"text-h6"},"Mouse Point Easting:",-1),_hoisted_19=createBaseVNode("div",{class:"text-h6"},"Center Northing:",-1),_hoisted_20=createBaseVNode("div",{class:"text-h6"},"Center Easting:",-1),_hoisted_21=createBaseVNode("div",{class:"text-h6"},"swNorthing:",-1),_hoisted_22=createBaseVNode("div",{class:"text-h6"},"swEasting:",-1),_hoisted_23=createBaseVNode("div",{class:"text-h6"},"neNorthing:",-1),_hoisted_24=createBaseVNode("div",{class:"text-h6"},"neEasting:",-1),_hoisted_25=createBaseVNode("div",{class:"text-h6"},"nwNorthing:",-1),_hoisted_26=createBaseVNode("div",{class:"text-h6"},"nwEasting:",-1),_hoisted_27=createBaseVNode("div",{class:"text-h6"},"seNorthing:",-1),_hoisted_28=createBaseVNode("div",{class:"text-h6"},"seEasting:",-1),_hoisted_29=createBaseVNode("div",{class:"text-h6"},"Alert",-1);function _sfc_render$2(n,t,s,l,f,m){const b=resolveComponent("q-img"),h=resolveComponent("q-field"),S=resolveComponent("q-item-label"),M=resolveComponent("q-option-group"),C=resolveComponent("q-select"),L=resolveComponent("q-input"),N=resolveComponent("q-btn"),F=resolveComponent("q-card-section"),G=resolveComponent("q-card-actions"),H=resolveComponent("q-card"),K=resolveComponent("q-dialog"),X=resolveDirective("close-popup");return openBlock(),createElementBlock(Fragment,null,[_hoisted_1$2,createVNode(b,{src:l.url,height:"150px"},null,8,["src"]),createBaseVNode("div",_hoisted_2$2,[createBaseVNode("div",_hoisted_3$1,[createVNode(h,{dense:"",class:"text-weight-bolder q-pt-none q-mt-xs",label:"Min/Max Elevation","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_4$1,toDisplayString(this.tile_info.minmax),1)]),_:1}),createVNode(h,{class:"q-pt-none q-mt-xs",dense:"",label:"Unreal Z-Scale",hint:"Input into Unreal Landscape Z scale","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_5$1,toDisplayString(this.tile_info.zscale),1)]),_:1}),createVNode(S,{class:"q-pt-none q-mt-xs"},{default:withCtx(()=>[_hoisted_6$1]),_:1}),createVNode(M,{class:"q-mt-none q-pt-none",dense:"",inline:"",options:l.exportOptions,type:"radio",modelValue:l.exportType,"onUpdate:modelValue":t[0]||(t[0]=de=>l.exportType=de)},null,8,["options","modelValue"]),createVNode(M,{class:"q-mt-none q-pt-none",dense:"",inline:"",options:l.otherOptions,"onUpdate:modelValue":[m.otherOptionsModelChange,t[1]||(t[1]=de=>l.otherOptionsModel=de)],type:"checkbox",modelValue:l.otherOptionsModel},null,8,["options","onUpdate:modelValue","modelValue"]),createVNode(C,{dense:"",class:"q-pt-none q-mt-xs",label:"Landscape Size","transition-show":"scale","transition-hide":"scale",hint:"Unreal Recommended Sizes",outlined:"",modelValue:l.unrealLandscape,"onUpdate:modelValue":t[2]||(t[2]=de=>l.unrealLandscape=de),options:l.landscapeSize},null,8,["modelValue","options"])])]),createVNode(h,{class:"q-pt-none q-mt-xs",dense:"",label:"Landscape Name (Optional)",hint:"Enter Unique Landscape Name"},{default:withCtx(()=>[createVNode(L,{modelValue:l.landscapeName,"onUpdate:modelValue":t[3]||(t[3]=de=>l.landscapeName=de)},null,8,["modelValue"])]),_:1}),createBaseVNode("div",_hoisted_7$1,[createVNode(N,{onClick:m.showBBInfo,dense:"",color:"orange","no-caps":"",label:"Show Bounding Box Info"},null,8,["onClick"])]),createBaseVNode("div",_hoisted_8$1,[createVNode(N,{onClick:m.createSixteenHeightMap,dense:"",color:"primary","no-caps":"",label:"Download HeightMap"},null,8,["onClick"]),createVNode(N,{onClick:m.sendToUnreal,disabled:l.isDisabled,dense:"",color:"green",class:"q-ml-xs","no-caps":"",label:"Send To Unreal"},null,8,["onClick","disabled"])]),createVNode(K,{modelValue:l.bbinfoalert,"onUpdate:modelValue":t[4]||(t[4]=de=>l.bbinfoalert=de)},{default:withCtx(()=>[createVNode(H,null,{default:withCtx(()=>[createVNode(F,null,{default:withCtx(()=>[_hoisted_9]),_:1}),createVNode(F,{class:"q-pt-none"},{default:withCtx(()=>[_hoisted_10,createTextVNode(" "+toDisplayString(l.tile_info.bbox[3])+" ",1),_hoisted_11,createTextVNode(" "+toDisplayString(this.tile_info.bbox[0])+" ",1),_hoisted_12,createTextVNode(" "+toDisplayString(l.tile_info.bbox[1])+" ",1),_hoisted_13,createTextVNode(" "+toDisplayString(l.tile_info.bbox[2])+" ",1),_hoisted_14,createTextVNode(" "+toDisplayString(l.tile_info.z)+" ",1),_hoisted_15,createTextVNode(" "+toDisplayString(l.tile_info.pointLat)+" ",1),_hoisted_16,createTextVNode(" "+toDisplayString(l.tile_info.pointLng)+" ",1),_hoisted_17,createTextVNode(" "+toDisplayString(l.tile_info.pointNorthing)+" ",1),_hoisted_18,createTextVNode(" "+toDisplayString(l.tile_info.pointEasting)+" ",1),_hoisted_19,createTextVNode(" "+toDisplayString(l.tile_info.ctNorthing)+" ",1),_hoisted_20,createTextVNode(" "+toDisplayString(l.tile_info.ctEasting)+" ",1),_hoisted_21,createTextVNode(" "+toDisplayString(l.tile_info.swNorthing)+" ",1),_hoisted_22,createTextVNode(" "+toDisplayString(l.tile_info.swEasting)+" ",1),_hoisted_23,createTextVNode(" "+toDisplayString(l.tile_info.neNorthing)+" ",1),_hoisted_24,createTextVNode(" "+toDisplayString(l.tile_info.neEasting)+" ",1),_hoisted_25,createTextVNode(" "+toDisplayString(l.tile_info.nwNorthing)+" ",1),_hoisted_26,createTextVNode(" "+toDisplayString(l.tile_info.nwEasting)+" ",1),_hoisted_27,createTextVNode(" "+toDisplayString(l.tile_info.seNorthing)+" ",1),_hoisted_28,createTextVNode(" "+toDisplayString(l.tile_info.seEasting),1)]),_:1}),createVNode(G,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(N,{flat:"",label:"OK",color:"primary"},null,512),[[X]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),createVNode(K,{modelValue:l.alert,"onUpdate:modelValue":t[5]||(t[5]=de=>l.alert=de)},{default:withCtx(()=>[createVNode(H,null,{default:withCtx(()=>[createVNode(F,null,{default:withCtx(()=>[_hoisted_29]),_:1}),createVNode(F,{class:"q-pt-none"},{default:withCtx(()=>[createTextVNode(toDisplayString(l.alertMsg),1)]),_:1}),createVNode(G,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(N,{flat:"",label:"OK",color:"primary"},null,512),[[X]])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}var SideNav=_export_sfc(_sfc_main$2,[["render",_sfc_render$2]]);const _sfc_main$1={props:{},emits:["ok","hide"],methods:{show(){this.$refs.dialog.show()},hide(){this.$refs.dialog.hide()},onDialogHide(){this.$emit("hide")},onOKClick(){this.$emit("ok"),this.hide()},onCancelClick(){this.hide()}}},_hoisted_1$1=createBaseVNode("div",null,[createBaseVNode("div",{class:"text-weight-bold"},"Help Section")],-1),_hoisted_2$1=createBaseVNode("div",{class:""},"TODO:",-1);function _sfc_render$1(n,t,s,l,f,m){const b=resolveComponent("q-space"),h=resolveComponent("q-btn"),S=resolveComponent("q-card-section"),M=resolveComponent("q-separator"),C=resolveComponent("q-card-actions"),L=resolveComponent("q-card"),N=resolveComponent("q-dialog"),F=resolveDirective("close-popup");return openBlock(),createBlock(N,{class:"dialog-plugin",ref:"dialog",onHide:m.onDialogHide},{default:withCtx(()=>[createVNode(L,{style:{width:"600px",height:"600px"}},{default:withCtx(()=>[createVNode(S,{class:"row items-center no-wrap",style:{height:"50px"}},{default:withCtx(()=>[_hoisted_1$1,createVNode(b),withDirectives(createVNode(h,{flat:"",round:"",icon:"close"},null,512),[[F]])]),_:1}),createVNode(M),_hoisted_2$1,createVNode(C,{class:"absolute-bottom",align:"right"},{default:withCtx(()=>[createVNode(h,{color:"primary",label:"OK",onClick:m.onOKClick},null,8,["onClick"]),createVNode(h,{color:"primary",label:"Cancel",onClick:m.onCancelClick},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["onHide"])}var Help=_export_sfc(_sfc_main$1,[["render",_sfc_render$1]]);/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var r$1=function(){return(r$1=Object.assign||function(n){for(var t,s=1,l=arguments.length;s<l;s++)for(var f in t=arguments[s])Object.prototype.hasOwnProperty.call(t,f)&&(n[f]=t[f]);return n}).apply(this,arguments)};function o$2(n,t,s,l){return new(s||(s=Promise))(function(f,m){function b(M){try{S(l.next(M))}catch(C){m(C)}}function h(M){try{S(l.throw(M))}catch(C){m(C)}}function S(M){var C;M.done?f(M.value):(C=M.value,C instanceof s?C:new s(function(L){L(C)})).then(b,h)}S((l=l.apply(n,t||[])).next())})}function a(n,t){var s,l,f,m,b={label:0,sent:function(){if(1&f[0])throw f[1];return f[1]},trys:[],ops:[]};return m={next:h(0),throw:h(1),return:h(2)},typeof Symbol=="function"&&(m[Symbol.iterator]=function(){return this}),m;function h(S){return function(M){return function(C){if(s)throw new TypeError("Generator is already executing.");for(;b;)try{if(s=1,l&&(f=2&C[0]?l.return:C[0]?l.throw||((f=l.return)&&f.call(l),0):l.next)&&!(f=f.call(l,C[1])).done)return f;switch(l=0,f&&(C=[2&C[0],f.value]),C[0]){case 0:case 1:f=C;break;case 4:return b.label++,{value:C[1],done:!1};case 5:b.label++,l=C[1],C=[0];continue;case 7:C=b.ops.pop(),b.trys.pop();continue;default:if(f=b.trys,!((f=f.length>0&&f[f.length-1])||C[0]!==6&&C[0]!==2)){b=0;continue}if(C[0]===3&&(!f||C[1]>f[0]&&C[1]<f[3])){b.label=C[1];break}if(C[0]===6&&b.label<f[1]){b.label=f[1],f=C;break}if(f&&b.label<f[2]){b.label=f[2],b.ops.push(C);break}f[2]&&b.ops.pop(),b.trys.pop();continue}C=t.call(n,b)}catch(L){C=[6,L],l=0}finally{s=f=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}([S,M])}}}function o$1(n,t){t===void 0&&(t=!1);var s=window.crypto.getRandomValues(new Uint32Array(1))[0],l="_".concat(s);return Object.defineProperty(window,l,{value:function(f){return t&&Reflect.deleteProperty(window,l),n==null?void 0:n(f)},writable:!1,configurable:!0}),s}function r(n,t){return t===void 0&&(t={}),o$2(this,void 0,void 0,function(){return a(this,function(s){return[2,new Promise(function(l,f){var m=o$1(function(h){l(h),Reflect.deleteProperty(window,b)},!0),b=o$1(function(h){f(h),Reflect.deleteProperty(window,m)},!0);window.__TAURI_IPC__(r$1({cmd:n,callback:m,error:b},t))})]})})}function i$1(n,t){return t===void 0&&(t="asset"),navigator.userAgent.includes("Windows")?"https://".concat(t,".localhost/").concat(n):"".concat(t,"://").concat(n)}Object.freeze({__proto__:null,transformCallback:o$1,invoke:r,convertFileSrc:i$1});function o(n){return o$2(this,void 0,void 0,function(){return a(this,function(t){return[2,r("tauri",n)]})})}function i(){return o$2(this,void 0,void 0,function(){return a(this,function(n){return[2,o({__tauriModule:"Cli",message:{cmd:"cliMatches"}})]})})}Object.freeze({__proto__:null,getMatches:i});const _sfc_main={setup(){const n=useQuasar();return{showDialog(){n.dialog({component:Help,componentProps:{text:"something"}}).onOk(()=>{}).onCancel(()=>{}).onDismiss(()=>{})},data_path:"",selectedTab:ref("map"),dirHandle:ref(""),dirName:ref(""),style_url:ref(""),access_token:ref(""),mapbox_api_url:ref(""),mapbox_raster_png_dem:ref(""),showPwaBtn:!0,isPwd:ref(!0),drawerLeft:ref(!1),createFolder:ref(!1)}},mounted:async function(){try{let t=await i();idbKeyval.set("tauriArgs",t)}catch{}await idbKeyval.get("pwa-installed")&&(this.showPwaBtn=!1),await this.loadUserData(),this.isRequiredSettings()===!0&&await this.loadMap(),window.addEventListener("appinstalled",this.pwaInstalled)},methods:{pwaInstalled(){idbKeyval.set("pwa-installed",!0),this.showPwaBtn=!1},async installPWA(){console.log(window.installEvent),window.installEvent.prompt(),window.installEvent=null},resizeMap(){this.$refs.mapBoxViewer.resizeMap()},changeDrawer(){this.drawerLeft=!this.drawerLeft},async loadMap(){this.selectedTab="map",await this.$nextTick(()=>{this.$refs.mapBoxViewer.loadMapboxMap()})},isRequiredSettings(){return this.access_token&&this.style_url&&this.dirName?!0:(this.redirectToSettings(),!1)},redirectToSettings(){this.selectedTab="settings",Notify.create({color:"negative",textColor:"white",icon:"report_problem",message:"Please fill out the required fields!",position:"top"})},async openDirectory(){let n;try{n=await fileUtils.getDirHandle()}catch(t){if(t.name==="AbortError")return;console.error("An error occured trying to open the file.",t)}!n||(idbKeyval.set("dirHandle",n),this.dirName=n.name)},saveUserSettings(){idbKeyval.set("access_token",this.access_token),idbKeyval.set("style_url",this.style_url),idbKeyval.set("mapbox_api_url",this.mapbox_api_url),idbKeyval.set("mapbox_raster_png_dem",this.mapbox_raster_png_dem),idbKeyval.set("create_folder",this.createFolder),this.isRequiredSettings()===!0&&this.loadMap()},async loadUserData(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken||"",this.style_url=await idbKeyval.get("style_url")||"mapbox://styles/mapbox/streets-v11",this.mapbox_api_url=await idbKeyval.get("mapbox_api_url")||"https://api.mapbox.com/v4/",this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem")||"mapbox.mapbox-terrain-dem-v1";let n=await idbKeyval.get("dirHandle")||"";this.createFolder=await idbKeyval.get("create_folder")||"",this.dirHandle=n,this.dirName=n.name}},components:{MapboxMapViewer,SideNav,Help}},_hoisted_1={class:"row q-pa-xs full-height"},_hoisted_2=createTextVNode(" See: "),_hoisted_3=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/access-token/",target:"_blank"},"Mapbox access token docs",-1),_hoisted_4=createTextVNode(" See: "),_hoisted_5=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/style-url/",target:"_blank"},"Mapbox style url docs",-1),_hoisted_6={class:"q-pa-none row items-start"},_hoisted_7={class:"col q-pa-none"},_hoisted_8=createBaseVNode("br",null,null,-1);function _sfc_render(n,t,s,l,f,m){const b=resolveComponent("q-header"),h=resolveComponent("side-nav"),S=resolveComponent("q-card"),M=resolveComponent("q-drawer"),C=resolveComponent("q-btn"),L=resolveComponent("q-tab"),N=resolveComponent("q-tabs"),F=resolveComponent("q-separator"),G=resolveComponent("mapbox-map-viewer"),H=resolveComponent("q-tab-panel"),K=resolveComponent("q-icon"),X=resolveComponent("q-input"),de=resolveComponent("q-tab-panels"),Q=resolveComponent("q-page"),ie=resolveComponent("q-page-container"),ce=resolveComponent("q-layout");return openBlock(),createBlock(ce,{view:"lHr lpr lfr"},{default:withCtx(()=>[createVNode(b,{dense:"",elevated:"",class:"bg-primary text-white","height-hint":"98"}),createVNode(M,{dense:"","show-if-above":"",modelValue:l.drawerLeft,"onUpdate:modelValue":t[0]||(t[0]=ge=>l.drawerLeft=ge),side:"left",onHide:m.resizeMap,class:"no-margin no-padding"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1,[createVNode(S,{class:"col q-pl-xs"},{default:withCtx(()=>[createVNode(h)]),_:1})])]),_:1},8,["modelValue","onHide"]),createVNode(ie,null,{default:withCtx(()=>[createVNode(Q,{class:"row no-margin q-pa-sm"},{default:withCtx(()=>[createVNode(S,{class:"col"},{default:withCtx(()=>[createVNode(N,{dense:"",modelValue:l.selectedTab,"onUpdate:modelValue":t[2]||(t[2]=ge=>l.selectedTab=ge),class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:withCtx(()=>[createVNode(C,{dense:"",flat:"",onClick:m.changeDrawer,round:"",icon:"menu"},null,8,["onClick"]),createVNode(L,{dense:"",name:"map",label:"Map"}),createVNode(L,{dense:"",name:"settings",label:"Settings"}),createVNode(C,{style:{background:"#FF0080",color:"white"},label:"Help",class:"q-mr-lg",onClick:l.showDialog},null,8,["onClick"]),createVNode(C,{dense:"",flat:"",round:"",onClick:t[1]||(t[1]=ge=>n.$q.dark.toggle()),icon:n.$q.dark.isActive?"nights_stay":"wb_sunny"},null,8,["icon"])]),_:1},8,["modelValue"]),createVNode(F),createVNode(de,{class:"q-pa-none q-ma-none","keep-alive":"",modelValue:l.selectedTab,"onUpdate:modelValue":t[11]||(t[11]=ge=>l.selectedTab=ge),animated:""},{default:withCtx(()=>[createVNode(H,{name:"map",class:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",style:{width:"100%",height:"calc(100vh - 65px)"}},{default:withCtx(()=>[createVNode(G,{class:"col",ref:"mapBoxViewer"},null,512)]),_:1}),createVNode(H,{lass:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",name:"settings"},{default:withCtx(()=>[_hoisted_2,_hoisted_3,createVNode(X,{dense:"",modelValue:l.access_token,"onUpdate:modelValue":t[4]||(t[4]=ge=>l.access_token=ge),label:"Mapbox Access Token *",filled:"",type:l.isPwd?"password":"text","lazy-rules":"",hint:"You will need your own access token created from your Mapbox accounts page. The Mapbox free plan is a great choice.",rules:[ge=>ge&&ge.length>0||"Please type something"]},{append:withCtx(()=>[createVNode(K,{dense:"",name:l.isPwd?"visibility_off":"visibility",class:"cursor-pointer",onClick:t[3]||(t[3]=ge=>l.isPwd=!l.isPwd)},null,8,["name"])]),_:1},8,["modelValue","type","rules"]),_hoisted_4,_hoisted_5,createVNode(X,{dense:"",class:"q-pb-lg",modelValue:l.style_url,"onUpdate:modelValue":t[5]||(t[5]=ge=>l.style_url=ge),label:"Enter your Mapbox style url *",filled:"","lazy-rules":"",hint:"You can use the default style or you can create your own custom style in Mapbox Studio.",rules:[ge=>ge&&ge.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(X,{dense:"",class:"q-pb-lg",modelValue:l.mapbox_api_url,"onUpdate:modelValue":t[6]||(t[6]=ge=>l.mapbox_api_url=ge),label:"Mapbox base api url *",filled:"","lazy-rules":"",hint:"",rules:[ge=>ge&&ge.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(X,{dense:"",class:"q-pb-lg",modelValue:l.mapbox_raster_png_dem,"onUpdate:modelValue":t[7]||(t[7]=ge=>l.mapbox_raster_png_dem=ge),label:"Mapbox Raster Dem Endpoint *",filled:"","lazy-rules":"",hint:"",rules:[ge=>ge&&ge.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createBaseVNode("div",_hoisted_6,[createBaseVNode("div",_hoisted_7,[createVNode(X,{dense:"",class:"q-pb-none",modelValue:l.dirName,"onUpdate:modelValue":t[8]||(t[8]=ge=>l.dirName=ge),label:"Enter download directory path *",filled:"","lazy-rules":"",rules:[ge=>ge&&ge.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"])]),createVNode(C,{class:"q-pb-none",dense:"",onClick:t[9]||(t[9]=ge=>m.openDirectory()),color:"secondary",label:"Select download folder"})]),_hoisted_8,createVNode(C,{class:"q-pt-none",dense:"",onClick:t[10]||(t[10]=ge=>m.saveUserSettings()),color:"secondary",label:"Save settings"})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})}var MainLayout=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{MainLayout as default};
