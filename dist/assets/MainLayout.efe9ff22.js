var og=Object.defineProperty;var Rf=Object.getOwnPropertySymbols;var sg=Object.prototype.hasOwnProperty,ag=Object.prototype.propertyIsEnumerable;var Lf=(n,t,s)=>t in n?og(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s,Au=(n,t)=>{for(var s in t||(t={}))sg.call(t,s)&&Lf(n,s,t[s]);if(Rf)for(var s of Rf(t))ag.call(t,s)&&Lf(n,s,t[s]);return n};import{_ as _export_sfc,r as ref,a as resolveComponent,o as openBlock,c as createElementBlock,b as createVNode,w as withCtx,d as createBaseVNode,u as useQuasar,e as resolveDirective,t as toDisplayString,f as createTextVNode,g as withDirectives,F as Fragment,h as createBlock,N as Notify}from"./index.9e9f5d11.js";class Store{constructor(t="unreal-mapbox",s="keyval"){this.storeName=s,this._dbp=new Promise((l,p)=>{const g=indexedDB.open(t,3);g.onerror=()=>p(g.error),g.onsuccess=()=>l(g.result),g.onupgradeneeded=()=>{try{g.result.deleteObjectStore(s)}catch{}g.result.createObjectStore(s)}})}_withIDBStore(t,s){return this._dbp.then(l=>new Promise((p,g)=>{const w=l.transaction(this.storeName,t);w.oncomplete=()=>p(),w.onabort=w.onerror=()=>g(w.error),s(w.objectStore(this.storeName))}))}}let store;function getDefaultStore(){return store||(store=new Store),store}function get(n,t=getDefaultStore()){let s;return t._withIDBStore("readonly",l=>{s=l.get(n)}).then(()=>s.result)}function set(n,t,s=getDefaultStore()){return s._withIDBStore("readwrite",l=>{l.put(t,n)})}function del(n,t=getDefaultStore()){return t._withIDBStore("readwrite",s=>{s.delete(n)})}function clear(n=getDefaultStore()){return n._withIDBStore("readwrite",t=>{t.clear()})}function keys(n=getDefaultStore()){const t=[];return n._withIDBStore("readonly",s=>{(s.openKeyCursor||s.openCursor).call(s).onsuccess=function(){!this.result||(t.push(this.result.key),this.result.continue())}}).then(()=>t)}var idbKeyval={keys,clear,del,set,get};function getFileHandle(){if("showOpenFilePicker"in window)return window.showOpenFilePicker().then(n=>n[0])}function getDirHandle(){if("showDirectoryPicker"in window)return window.showDirectoryPicker().then(n=>n)}async function verifyPermission(n,t){const s={};return t&&(s.writable=!0,s.mode="readwrite"),await n.queryPermission(s)==="granted"||await n.requestPermission(s)==="granted"}async function writeFileToDisk(n,t,s){let p=await(await n.getFileHandle(t,{create:!0})).createWritable();await p.write(s),await p.close()}async function fileExists(n,t){try{return await n.getFileHandle(t),!0}catch(s){if(s.name==="NotFoundError")return!1;if(s.name==="NotAllowedError")return console.log("Please select directory to verify permissions"),!1}}async function readFileFromDisk(n,t){return await(await(await n.getFileHandle(t)).getFile()).arrayBuffer()}var fileUtils={getDirHandle,verifyPermission,writeFileToDisk,fileExists,getFileHandle,readFileFromDisk},commonjsGlobal=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function getAugmentedNamespace(n){if(n.__esModule)return n;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach(function(s){var l=Object.getOwnPropertyDescriptor(n,s);Object.defineProperty(t,s,l.get?l:{enumerable:!0,get:function(){return n[s]}})}),t}function commonjsRequire(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var mapboxGl={exports:{}};(function(n,t){(function(s,l){n.exports=l()})(commonjsGlobal,function(){var s,l,p;function g(u,A){if(!s)s=A;else if(!l)l=A;else{var S="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+s+")(sharedChunk); ("+l+")(sharedChunk); self.onerror = null;",D={};s(D),p=A(D),typeof window!="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(p.workerUrl=window.URL.createObjectURL(new Blob([S],{type:"text/javascript"})))}}g(["exports"],function(u){var A="2.8.2",S=D;function D(d,e,f,m){this.cx=3*d,this.bx=3*(f-d)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(m-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=d,this.p1y=m,this.p2x=f,this.p2y=m}D.prototype.sampleCurveX=function(d){return((this.ax*d+this.bx)*d+this.cx)*d},D.prototype.sampleCurveY=function(d){return((this.ay*d+this.by)*d+this.cy)*d},D.prototype.sampleCurveDerivativeX=function(d){return(3*this.ax*d+2*this.bx)*d+this.cx},D.prototype.solveCurveX=function(d,e){var f,m,y,b,M;for(e===void 0&&(e=1e-6),y=d,M=0;M<8;M++){if(b=this.sampleCurveX(y)-d,Math.abs(b)<e)return y;var I=this.sampleCurveDerivativeX(y);if(Math.abs(I)<1e-6)break;y-=b/I}if((y=d)<(f=0))return f;if(y>(m=1))return m;for(;f<m;){if(b=this.sampleCurveX(y),Math.abs(b-d)<e)return y;d>b?f=y:m=y,y=.5*(m-f)+f}return y},D.prototype.solve=function(d,e){return this.sampleCurveY(this.solveCurveX(d,e))};var z=$;function $(d,e){this.x=d,this.y=e}$.prototype={clone:function(){return new $(this.x,this.y)},add:function(d){return this.clone()._add(d)},sub:function(d){return this.clone()._sub(d)},multByPoint:function(d){return this.clone()._multByPoint(d)},divByPoint:function(d){return this.clone()._divByPoint(d)},mult:function(d){return this.clone()._mult(d)},div:function(d){return this.clone()._div(d)},rotate:function(d){return this.clone()._rotate(d)},rotateAround:function(d,e){return this.clone()._rotateAround(d,e)},matMult:function(d){return this.clone()._matMult(d)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(d){return this.x===d.x&&this.y===d.y},dist:function(d){return Math.sqrt(this.distSqr(d))},distSqr:function(d){var e=d.x-this.x,f=d.y-this.y;return e*e+f*f},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(d){return Math.atan2(this.y-d.y,this.x-d.x)},angleWith:function(d){return this.angleWithSep(d.x,d.y)},angleWithSep:function(d,e){return Math.atan2(this.x*e-this.y*d,this.x*d+this.y*e)},_matMult:function(d){var e=d[2]*this.x+d[3]*this.y;return this.x=d[0]*this.x+d[1]*this.y,this.y=e,this},_add:function(d){return this.x+=d.x,this.y+=d.y,this},_sub:function(d){return this.x-=d.x,this.y-=d.y,this},_mult:function(d){return this.x*=d,this.y*=d,this},_div:function(d){return this.x/=d,this.y/=d,this},_multByPoint:function(d){return this.x*=d.x,this.y*=d.y,this},_divByPoint:function(d){return this.x/=d.x,this.y/=d.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var d=this.y;return this.y=this.x,this.x=-d,this},_rotate:function(d){var e=Math.cos(d),f=Math.sin(d),m=f*this.x+e*this.y;return this.x=e*this.x-f*this.y,this.y=m,this},_rotateAround:function(d,e){var f=Math.cos(d),m=Math.sin(d),y=e.y+m*(this.x-e.x)+f*(this.y-e.y);return this.x=e.x+f*(this.x-e.x)-m*(this.y-e.y),this.y=y,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},$.convert=function(d){return d instanceof $?d:Array.isArray(d)?new $(d[0],d[1]):d};var O=typeof self!="undefined"?self:{};const q=Math.PI/180,K=180/Math.PI;function J(d){return d*q}function Y(d){return d*K}const fe=[[0,0],[1,0],[1,1],[0,1]];function ee(d){if(d<=0)return 0;if(d>=1)return 1;const e=d*d,f=e*d;return 4*(d<.5?f:3*(d-e)+f-.75)}function re(d,e,f,m){const y=new S(d,e,f,m);return function(b){return y.solve(b)}}const he=re(.25,.1,.25,1);function _e(d,e,f){return Math.min(f,Math.max(e,d))}function we(d,e,f){return(f=_e((f-d)/(e-d),0,1))*f*(3-2*f)}function oe(d,e,f){const m=f-e,y=((d-e)%m+m)%m+e;return y===e?f:y}function be(d,e,f){if(!d.length)return f(null,[]);let m=d.length;const y=new Array(d.length);let b=null;d.forEach((M,I)=>{e(M,(P,L)=>{P&&(b=P),y[I]=L,--m==0&&f(b,y)})})}function ie(d){const e=[];for(const f in d)e.push(d[f]);return e}function ue(d,...e){for(const f of e)for(const m in f)d[m]=f[m];return d}let Ce=1;function Ne(){return Ce++}function it(){return function d(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,d)}()}function rt(d){return d<=1?1:Math.pow(2,Math.ceil(Math.log(d)/Math.LN2))}function Pt(d){return!!d&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(d)}function zt(d,e){d.forEach(f=>{e[f]&&(e[f]=e[f].bind(e))})}function vt(d,e){return d.indexOf(e,d.length-e.length)!==-1}function Vt(d,e,f){const m={};for(const y in d)m[y]=e.call(f||this,d[y],y,d);return m}function kt(d,e,f){const m={};for(const y in d)e.call(f||this,d[y],y,d)&&(m[y]=d[y]);return m}function Yt(d){return Array.isArray(d)?d.map(Yt):typeof d=="object"&&d?Vt(d,Yt):d}const Qt={};function ot(d){Qt[d]||(typeof console!="undefined"&&console.warn(d),Qt[d]=!0)}function gt(d,e,f){return(f.y-d.y)*(e.x-d.x)>(e.y-d.y)*(f.x-d.x)}function pt(d){let e=0;for(let f,m,y=0,b=d.length,M=b-1;y<b;M=y++)f=d[y],m=d[M],e+=(m.x-f.x)*(f.y+m.y);return e}function Bt(){return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope}function Zt(d){const e={};if(d.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(f,m,y,b)=>{const M=y||b;return e[m]=!M||M.toLowerCase(),""}),e["max-age"]){const f=parseInt(e["max-age"],10);isNaN(f)?delete e["max-age"]:e["max-age"]=f}return e}let si,ii,pi,ai,Nt=null;function ci(d){if(Nt==null){const e=d.navigator?d.navigator.userAgent:null;Nt=!!d.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return Nt}function $t(d){try{const e=O[d];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}}const ft={now:()=>pi!==void 0?pi:O.performance.now(),setNow(d){pi=d},restoreNow(){pi=void 0},frame(d){const e=O.requestAnimationFrame(d);return{cancel:()=>O.cancelAnimationFrame(e)}},getImageData(d,e=0){const{width:f,height:m}=d;ai||(ai=O.document.createElement("canvas"));const y=ai.getContext("2d");if(!y)throw new Error("failed to create canvas 2d context");return(f>ai.width||m>ai.height)&&(ai.width=f,ai.height=m),y.clearRect(-e,-e,f+2*e,m+2*e),y.drawImage(d,0,0,f,m),y.getImageData(-e,-e,f+2*e,m+2*e)},resolveURL:d=>(si||(si=O.document.createElement("a")),si.href=d,si.href),get devicePixelRatio(){return O.devicePixelRatio},get prefersReducedMotion(){return!!O.matchMedia&&(ii==null&&(ii=O.matchMedia("(prefers-reduced-motion: reduce)")),ii.matches)}};let _i;const Tt={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(_i==null){const d=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{_i={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):d}catch{_i=d}}return _i},get EVENTS_URL(){return this.API_URL?this.API_URL.indexOf("https://api.mapbox.cn")===0?"https://events.mapbox.cn/events/v2":this.API_URL.indexOf("https://api.mapbox.com")===0?"https://events.mapbox.com/events/v2":null:null},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},Ge={supported:!1,testSupport:function(d){!ei&&Ht&&(oi?_t(d):Gt=d)}};let Gt,Ht,ei=!1,oi=!1;function _t(d){const e=d.createTexture();d.bindTexture(d.TEXTURE_2D,e);try{if(d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,Ht),d.isContextLost())return;Ge.supported=!0}catch{}d.deleteTexture(e),ei=!0}O.document&&(Ht=O.document.createElement("img"),Ht.onload=function(){Gt&&_t(Gt),Gt=null,oi=!0},Ht.onerror=function(){ei=!0,Gt=null},Ht.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Ci="01",hi="NO_ACCESS_TOKEN";function Ft(d){return d.indexOf("mapbox:")===0}function Ut(d){return Tt.API_URL_REGEX.test(d)}const yt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function ui(d){const e=d.match(yt);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function yi(d){const e=d.params.length?`?${d.params.join("&")}`:"";return`${d.protocol}://${d.authority}${d.path}${e}`}function Ei(d){if(!d)return null;const e=d.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(decodeURIComponent(O.atob(e[1]).split("").map(f=>"%"+("00"+f.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class Jt{constructor(e){this.type=e,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){const f=Ei(Tt.ACCESS_TOKEN);let m="";return m=f&&f.u?O.btoa(encodeURIComponent(f.u).replace(/%([0-9A-F]{2})/g,(y,b)=>String.fromCharCode(Number("0x"+b)))):Tt.ACCESS_TOKEN||"",e?`mapbox.eventData.${e}:${m}`:`mapbox.eventData:${m}`}fetchEventData(){const e=$t("localStorage"),f=this.getStorageKey(),m=this.getStorageKey("uuid");if(e)try{const y=O.localStorage.getItem(f);y&&(this.eventData=JSON.parse(y));const b=O.localStorage.getItem(m);b&&(this.anonId=b)}catch{ot("Unable to read from LocalStorage")}}saveEventData(){const e=$t("localStorage"),f=this.getStorageKey(),m=this.getStorageKey("uuid");if(e)try{O.localStorage.setItem(m,this.anonId),Object.keys(this.eventData).length>=1&&O.localStorage.setItem(f,JSON.stringify(this.eventData))}catch{ot("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,f,m,y){if(!Tt.EVENTS_URL)return;const b=ui(Tt.EVENTS_URL);b.params.push(`access_token=${y||Tt.ACCESS_TOKEN||""}`);const M={event:this.type,created:new Date(e).toISOString(),sdkIdentifier:"mapbox-gl-js",sdkVersion:A,skuId:Ci,userId:this.anonId},I=f?ue(M,f):M,P={url:yi(b),headers:{"Content-Type":"text/plain"},body:JSON.stringify([I])};this.pendingRequest=ke(P,L=>{this.pendingRequest=null,m(L),this.saveEventData(),this.processRequests(y)})}queueRequest(e,f){this.queue.push(e),this.processRequests(f)}}const di=new class extends Jt{constructor(d){super("appUserTurnstile"),this._customAccessToken=d}postTurnstileEvent(d,e){Tt.EVENTS_URL&&Tt.ACCESS_TOKEN&&Array.isArray(d)&&d.some(f=>Ft(f)||Ut(f))&&this.queueRequest(Date.now(),e)}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=Ei(Tt.ACCESS_TOKEN),f=e?e.u:Tt.ACCESS_TOKEN;let m=f!==this.eventData.tokenU;Pt(this.anonId)||(this.anonId=it(),m=!0);const y=this.queue.shift();if(this.eventData.lastSuccess){const b=new Date(this.eventData.lastSuccess),M=new Date(y),I=(y-this.eventData.lastSuccess)/864e5;m=m||I>=1||I<-1||b.getDate()!==M.getDate()}else m=!0;m?this.postEvent(y,{"enabled.telemetry":!1},b=>{b||(this.eventData.lastSuccess=y,this.eventData.tokenU=f)},d):this.processRequests()}},zi=di.postTurnstileEvent.bind(di),Fi=new class extends Jt{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(d,e,f,m){this.skuToken=e,this.errorCb=m,Tt.EVENTS_URL&&(f||Tt.ACCESS_TOKEN?this.queueRequest({id:d,timestamp:Date.now()},f):this.errorCb(new Error(hi)))}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:f}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),Pt(this.anonId)||(this.anonId=it()),this.postEvent(f,{skuToken:this.skuToken},m=>{m?this.errorCb(m):e&&(this.success[e]=!0)},d))}},Oi=Fi.postMapLoadEvent.bind(Fi),ir=new class extends Jt{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(d,e,f,m){if(!Tt.API_URL||!Tt.SESSION_PATH)return;const y=ui(Tt.API_URL+Tt.SESSION_PATH);y.params.push(`sku=${e||""}`),y.params.push(`access_token=${m||Tt.ACCESS_TOKEN||""}`);const b={url:yi(y),headers:{"Content-Type":"text/plain"}};this.pendingRequest=Re(b,M=>{this.pendingRequest=null,f(M),this.saveEventData(),this.processRequests(m)})}getSessionAPI(d,e,f,m){this.skuToken=e,this.errorCb=m,Tt.SESSION_PATH&&Tt.API_URL&&(f||Tt.ACCESS_TOKEN?this.queueRequest({id:d,timestamp:Date.now()},f):this.errorCb(new Error(hi)))}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:f}=this.queue.shift();e&&this.success[e]||this.getSession(f,this.skuToken,m=>{m?this.errorCb(m):e&&(this.success[e]=!0)},d)}},Rr=ir.getSessionAPI.bind(ir),Lr=new Set,Tr="mapbox-tiles";let tr,dr,gr=500,xr=50;function Ar(){O.caches&&!tr&&(tr=O.caches.open(Tr))}function zr(d){const e=d.indexOf("?");return e<0?d:d.slice(0,e)}let ye=1/0;const Q={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(Q);class G extends Error{constructor(e,f,m){f===401&&Ut(m)&&(e+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(e),this.status=f,this.url=m}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const W=Bt()?()=>self.worker&&self.worker.referrer:()=>(O.location.protocol==="blob:"?O.parent:O).location.href,ce=function(d,e){if(!(/^file:/.test(f=d.url)||/^file:/.test(W())&&!/^\w+:/.test(f))){if(O.fetch&&O.Request&&O.AbortController&&O.Request.prototype.hasOwnProperty("signal"))return function(m,y){const b=new O.AbortController,M=new O.Request(m.url,{method:m.method||"GET",body:m.body,credentials:m.credentials,headers:m.headers,referrer:W(),signal:b.signal});let I=!1,P=!1;const L=(N=M.url).indexOf("sku=")>0&&Ut(N);var N;m.type==="json"&&M.headers.set("Accept","application/json");const U=(H,ne,ae)=>{if(P)return;if(H&&H.message!=="SecurityError"&&ot(H),ne&&ae)return j(ne);const pe=Date.now();O.fetch(M).then(ve=>{if(ve.ok){const Ie=L?ve.clone():null;return j(ve,Ie,pe)}return y(new G(ve.statusText,ve.status,m.url))}).catch(ve=>{ve.code!==20&&y(new Error(ve.message))})},j=(H,ne,ae)=>{(m.type==="arrayBuffer"?H.arrayBuffer():m.type==="json"?H.json():H.text()).then(pe=>{P||(ne&&ae&&function(ve,Ie,Be){if(Ar(),!tr)return;const Le={status:Ie.status,statusText:Ie.statusText,headers:new O.Headers};Ie.headers.forEach((Xe,We)=>Le.headers.set(We,Xe));const Fe=Zt(Ie.headers.get("Cache-Control")||"");if(Fe["no-store"])return;Fe["max-age"]&&Le.headers.set("Expires",new Date(Be+1e3*Fe["max-age"]).toUTCString());const Oe=Le.headers.get("Expires");Oe&&(new Date(Oe).getTime()-Be<42e4||function(Xe,We){if(dr===void 0)try{new Response(new ReadableStream),dr=!0}catch{dr=!1}dr?We(Xe.body):Xe.blob().then(We)}(Ie,Xe=>{const We=new O.Response(Xe,Le);Ar(),tr&&tr.then(tt=>tt.put(zr(ve.url),We)).catch(tt=>ot(tt.message))}))}(M,ne,ae),I=!0,y(null,pe,H.headers.get("Cache-Control"),H.headers.get("Expires")))}).catch(pe=>{P||y(new Error(pe.message))})};return L?function(H,ne){if(Ar(),!tr)return ne(null);const ae=zr(H.url);tr.then(pe=>{pe.match(ae).then(ve=>{const Ie=function(Be){if(!Be)return!1;const Le=new Date(Be.headers.get("Expires")||0),Fe=Zt(Be.headers.get("Cache-Control")||"");return Le>Date.now()&&!Fe["no-cache"]}(ve);pe.delete(ae),Ie&&pe.put(ae,ve.clone()),ne(null,ve,Ie)}).catch(ne)}).catch(ne)}(M,U):U(null,null),{cancel:()=>{P=!0,I||b.abort()}}}(d,e);if(Bt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",d,e,void 0,!0)}var f;return function(m,y){const b=new O.XMLHttpRequest;b.open(m.method||"GET",m.url,!0),m.type==="arrayBuffer"&&(b.responseType="arraybuffer");for(const M in m.headers)b.setRequestHeader(M,m.headers[M]);return m.type==="json"&&(b.responseType="text",b.setRequestHeader("Accept","application/json")),b.withCredentials=m.credentials==="include",b.onerror=()=>{y(new Error(b.statusText))},b.onload=()=>{if((b.status>=200&&b.status<300||b.status===0)&&b.response!==null){let M=b.response;if(m.type==="json")try{M=JSON.parse(b.response)}catch(I){return y(I)}y(null,M,b.getResponseHeader("Cache-Control"),b.getResponseHeader("Expires"))}else y(new G(b.statusText,b.status,m.url))},b.send(m.body),{cancel:()=>b.abort()}}(d,e)},me=function(d,e){return ce(ue(d,{type:"arrayBuffer"}),e)},ke=function(d,e){return ce(ue(d,{method:"POST"}),e)},Re=function(d,e){return ce(ue(d,{method:"GET"}),e)};function ze(d){const e=O.document.createElement("a");return e.href=d,e.protocol===O.document.location.protocol&&e.host===O.document.location.host}const Pe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let je,Ke;je=[],Ke=0;const ut=function(d,e){if(Ge.supported&&(d.headers||(d.headers={}),d.headers.accept="image/webp,*/*"),Ke>=Tt.MAX_PARALLEL_IMAGE_REQUESTS){const b={requestParameters:d,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return je.push(b),b}Ke++;let f=!1;const m=()=>{if(!f)for(f=!0,Ke--;je.length&&Ke<Tt.MAX_PARALLEL_IMAGE_REQUESTS;){const b=je.shift(),{requestParameters:M,callback:I,cancelled:P}=b;P||(b.cancel=ut(M,I).cancel)}},y=me(d,(b,M,I,P)=>{m(),b?e(b):M&&(O.createImageBitmap?function(L,N){const U=new O.Blob([new Uint8Array(L)],{type:"image/png"});O.createImageBitmap(U).then(j=>{N(null,j)}).catch(j=>{N(new Error(`Could not load image because of ${j.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(M,(L,N)=>e(L,N,I,P)):function(L,N){const U=new O.Image,j=O.URL;U.onload=()=>{N(null,U),j.revokeObjectURL(U.src),U.onload=null,O.requestAnimationFrame(()=>{U.src=Pe})},U.onerror=()=>N(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const H=new O.Blob([new Uint8Array(L)],{type:"image/png"});U.src=L.byteLength?j.createObjectURL(H):Pe}(M,(L,N)=>e(L,N,I,P)))});return{cancel:()=>{y.cancel(),m()}}};function et(d,e,f){f[d]&&f[d].indexOf(e)!==-1||(f[d]=f[d]||[],f[d].push(e))}function Rt(d,e,f){if(f&&f[d]){const m=f[d].indexOf(e);m!==-1&&f[d].splice(m,1)}}class wt{constructor(e,f={}){ue(this,f),this.type=e}}class Lt extends wt{constructor(e,f={}){super("error",ue({error:e},f))}}class Wt{on(e,f){return this._listeners=this._listeners||{},et(e,f,this._listeners),this}off(e,f){return Rt(e,f,this._listeners),Rt(e,f,this._oneTimeListeners),this}once(e,f){return f?(this._oneTimeListeners=this._oneTimeListeners||{},et(e,f,this._oneTimeListeners),this):new Promise(m=>this.once(e,m))}fire(e,f){typeof e=="string"&&(e=new wt(e,f||{}));const m=e.type;if(this.listens(m)){e.target=this;const y=this._listeners&&this._listeners[m]?this._listeners[m].slice():[];for(const I of y)I.call(this,e);const b=this._oneTimeListeners&&this._oneTimeListeners[m]?this._oneTimeListeners[m].slice():[];for(const I of b)Rt(m,I,this._oneTimeListeners),I.call(this,e);const M=this._eventedParent;M&&(ue(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),M.fire(e))}else e instanceof Lt&&console.error(e.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,f){return this._eventedParent=e,this._eventedParentData=f,this}}var $e=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":0.1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function Ti(d,...e){for(const f of e)for(const m in f)d[m]=f[m];return d}function St(d){return d instanceof Number||d instanceof String||d instanceof Boolean?d.valueOf():d}function Ai(d){if(Array.isArray(d))return d.map(Ai);if(d instanceof Object&&!(d instanceof Number||d instanceof String||d instanceof Boolean)){const e={};for(const f in d)e[f]=Ai(d[f]);return e}return St(d)}class ki extends Error{constructor(e,f){super(f),this.message=f,this.key=e}}class Xr{constructor(e,f=[]){this.parent=e,this.bindings={};for(const[m,y]of f)this.bindings[m]=y}concat(e){return new Xr(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const yn={kind:"null"},xt={kind:"number"},Mi={kind:"string"},xi={kind:"boolean"},fn={kind:"color"},Xn={kind:"object"},bi={kind:"value"},Yn={kind:"collator"},co={kind:"formatted"},Mr={kind:"resolvedImage"};function Yr(d,e){return{kind:"array",itemType:d,N:e}}function Xi(d){if(d.kind==="array"){const e=Xi(d.itemType);return typeof d.N=="number"?`array<${e}, ${d.N}>`:d.itemType.kind==="value"?"array":`array<${e}>`}return d.kind}const nh=[yn,xt,Mi,xi,fn,co,Xn,Yr(bi),Mr];function No(d,e){if(e.kind==="error")return null;if(d.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!No(d.itemType,e.itemType))&&(typeof d.N!="number"||d.N===e.N))return null}else{if(d.kind===e.kind)return null;if(d.kind==="value"){for(const f of nh)if(!No(f,e))return null}}return`Expected ${Xi(d)} but found ${Xi(e)} instead.`}function vs(d,e){return e.some(f=>f.kind===d.kind)}function ho(d,e){return e.some(f=>f==="null"?d===null:f==="array"?Array.isArray(d):f==="object"?d&&!Array.isArray(d)&&typeof d=="object":f===typeof d)}function bs(d){var e={exports:{}};return d(e,e.exports),e.exports}var _a=bs(function(d,e){var f={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function m(I){return(I=Math.round(I))<0?0:I>255?255:I}function y(I){return m(I[I.length-1]==="%"?parseFloat(I)/100*255:parseInt(I))}function b(I){return(P=I[I.length-1]==="%"?parseFloat(I)/100:parseFloat(I))<0?0:P>1?1:P;var P}function M(I,P,L){return L<0?L+=1:L>1&&(L-=1),6*L<1?I+(P-I)*L*6:2*L<1?P:3*L<2?I+(P-I)*(2/3-L)*6:I}try{e.parseCSSColor=function(I){var P,L=I.replace(/ /g,"").toLowerCase();if(L in f)return f[L].slice();if(L[0]==="#")return L.length===4?(P=parseInt(L.substr(1),16))>=0&&P<=4095?[(3840&P)>>4|(3840&P)>>8,240&P|(240&P)>>4,15&P|(15&P)<<4,1]:null:L.length===7&&(P=parseInt(L.substr(1),16))>=0&&P<=16777215?[(16711680&P)>>16,(65280&P)>>8,255&P,1]:null;var N=L.indexOf("("),U=L.indexOf(")");if(N!==-1&&U+1===L.length){var j=L.substr(0,N),H=L.substr(N+1,U-(N+1)).split(","),ne=1;switch(j){case"rgba":if(H.length!==4)return null;ne=b(H.pop());case"rgb":return H.length!==3?null:[y(H[0]),y(H[1]),y(H[2]),ne];case"hsla":if(H.length!==4)return null;ne=b(H.pop());case"hsl":if(H.length!==3)return null;var ae=(parseFloat(H[0])%360+360)%360/360,pe=b(H[1]),ve=b(H[2]),Ie=ve<=.5?ve*(pe+1):ve+pe-ve*pe,Be=2*ve-Ie;return[m(255*M(Be,Ie,ae+1/3)),m(255*M(Be,Ie,ae)),m(255*M(Be,Ie,ae-1/3)),ne];default:return null}}return null}}catch{}});class Di{constructor(e,f,m,y=1){this.r=e,this.g=f,this.b=m,this.a=y}static parse(e){if(!e)return;if(e instanceof Di)return e;if(typeof e!="string")return;const f=_a.parseCSSColor(e);return f?new Di(f[0]/255*f[3],f[1]/255*f[3],f[2]/255*f[3],f[3]):void 0}toString(){const[e,f,m,y]=this.toArray();return`rgba(${Math.round(e)},${Math.round(f)},${Math.round(m)},${y})`}toArray(){const{r:e,g:f,b:m,a:y}=this;return y===0?[0,0,0,0]:[255*e/y,255*f/y,255*m/y,y]}}Di.black=new Di(0,0,0,1),Di.white=new Di(1,1,1,1),Di.transparent=new Di(0,0,0,0),Di.red=new Di(1,0,0,1),Di.blue=new Di(0,0,1,1);class uo{constructor(e,f,m){this.sensitivity=e?f?"variant":"case":f?"accent":"base",this.locale=m,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,f){return this.collator.compare(e,f)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ya{constructor(e,f,m,y,b){this.text=e.normalize?e.normalize():e,this.image=f,this.scale=m,this.fontStack=y,this.textColor=b}}class ar{constructor(e){this.sections=e}static fromString(e){return new ar([new ya(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof ar?e:ar.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const f of this.sections){if(f.image){e.push(["image",f.image.name]);continue}e.push(f.text);const m={};f.fontStack&&(m["text-font"]=["literal",f.fontStack.split(",")]),f.scale&&(m["font-scale"]=f.scale),f.textColor&&(m["text-color"]=["rgba"].concat(f.textColor.toArray())),e.push(m)}return e}}class Fr{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Fr({name:e,available:!1}):null}serialize(){return["image",this.name]}}function an(d,e,f,m){return typeof d=="number"&&d>=0&&d<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof f=="number"&&f>=0&&f<=255?m===void 0||typeof m=="number"&&m>=0&&m<=1?null:`Invalid rgba value [${[d,e,f,m].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof m=="number"?[d,e,f,m]:[d,e,f]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ws(d){if(d===null||typeof d=="string"||typeof d=="boolean"||typeof d=="number"||d instanceof Di||d instanceof uo||d instanceof ar||d instanceof Fr)return!0;if(Array.isArray(d)){for(const e of d)if(!ws(e))return!1;return!0}if(typeof d=="object"){for(const e in d)if(!ws(d[e]))return!1;return!0}return!1}function rr(d){if(d===null)return yn;if(typeof d=="string")return Mi;if(typeof d=="boolean")return xi;if(typeof d=="number")return xt;if(d instanceof Di)return fn;if(d instanceof uo)return Yn;if(d instanceof ar)return co;if(d instanceof Fr)return Mr;if(Array.isArray(d)){const e=d.length;let f;for(const m of d){const y=rr(m);if(f){if(f===y)continue;f=bi;break}f=y}return Yr(f||bi,e)}return Xn}function xn(d){const e=typeof d;return d===null?"":e==="string"||e==="number"||e==="boolean"?String(d):d instanceof Di||d instanceof ar||d instanceof Fr?d.toString():JSON.stringify(d)}class vn{constructor(e,f){this.type=e,this.value=f}static parse(e,f){if(e.length!==2)return f.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!ws(e[1]))return f.error("invalid value");const m=e[1];let y=rr(m);const b=f.expectedType;return y.kind!=="array"||y.N!==0||!b||b.kind!=="array"||typeof b.N=="number"&&b.N!==0||(y=b),new vn(y,m)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Di?["rgba"].concat(this.value.toArray()):this.value instanceof ar?this.value.serialize():this.value}}class _r{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const xa={string:Mi,number:xt,boolean:xi,object:Xn};class ln{constructor(e,f){this.type=e,this.args=f}static parse(e,f){if(e.length<2)return f.error("Expected at least one argument.");let m,y=1;const b=e[0];if(b==="array"){let I,P;if(e.length>2){const L=e[1];if(typeof L!="string"||!(L in xa)||L==="object")return f.error('The item type argument of "array" must be one of string, number, boolean',1);I=xa[L],y++}else I=bi;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return f.error('The length argument to "array" must be a positive integer literal',2);P=e[2],y++}m=Yr(I,P)}else m=xa[b];const M=[];for(;y<e.length;y++){const I=f.parse(e[y],y,bi);if(!I)return null;M.push(I)}return new ln(m,M)}evaluate(e){for(let f=0;f<this.args.length;f++){const m=this.args[f].evaluate(e);if(!No(this.type,rr(m)))return m;if(f===this.args.length-1)throw new _r(`Expected value to be of type ${Xi(this.type)}, but found ${Xi(rr(m))} instead.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,f=[e.kind];if(e.kind==="array"){const m=e.itemType;if(m.kind==="string"||m.kind==="number"||m.kind==="boolean"){f.push(m.kind);const y=e.N;(typeof y=="number"||this.args.length>1)&&f.push(y)}}return f.concat(this.args.map(m=>m.serialize()))}}class fo{constructor(e){this.type=co,this.sections=e}static parse(e,f){if(e.length<2)return f.error("Expected at least one argument.");const m=e[1];if(!Array.isArray(m)&&typeof m=="object")return f.error("First argument must be an image or text section.");const y=[];let b=!1;for(let M=1;M<=e.length-1;++M){const I=e[M];if(b&&typeof I=="object"&&!Array.isArray(I)){b=!1;let P=null;if(I["font-scale"]&&(P=f.parse(I["font-scale"],1,xt),!P))return null;let L=null;if(I["text-font"]&&(L=f.parse(I["text-font"],1,Yr(Mi)),!L))return null;let N=null;if(I["text-color"]&&(N=f.parse(I["text-color"],1,fn),!N))return null;const U=y[y.length-1];U.scale=P,U.font=L,U.textColor=N}else{const P=f.parse(e[M],1,bi);if(!P)return null;const L=P.type.kind;if(L!=="string"&&L!=="value"&&L!=="null"&&L!=="resolvedImage")return f.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");b=!0,y.push({content:P,scale:null,font:null,textColor:null})}}return new fo(y)}evaluate(e){return new ar(this.sections.map(f=>{const m=f.content.evaluate(e);return rr(m)===Mr?new ya("",m,null,null,null):new ya(xn(m),null,f.scale?f.scale.evaluate(e):null,f.font?f.font.evaluate(e).join(","):null,f.textColor?f.textColor.evaluate(e):null)}))}eachChild(e){for(const f of this.sections)e(f.content),f.scale&&e(f.scale),f.font&&e(f.font),f.textColor&&e(f.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const f of this.sections){e.push(f.content.serialize());const m={};f.scale&&(m["font-scale"]=f.scale.serialize()),f.font&&(m["text-font"]=f.font.serialize()),f.textColor&&(m["text-color"]=f.textColor.serialize()),e.push(m)}return e}}class po{constructor(e){this.type=Mr,this.input=e}static parse(e,f){if(e.length!==2)return f.error("Expected two arguments.");const m=f.parse(e[1],1,Mi);return m?new po(m):f.error("No image name provided.")}evaluate(e){const f=this.input.evaluate(e),m=Fr.fromString(f);return m&&e.availableImages&&(m.available=e.availableImages.indexOf(f)>-1),m}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const oh={"to-boolean":xi,"to-color":fn,"to-number":xt,"to-string":Mi};class cn{constructor(e,f){this.type=e,this.args=f}static parse(e,f){if(e.length<2)return f.error("Expected at least one argument.");const m=e[0];if((m==="to-boolean"||m==="to-string")&&e.length!==2)return f.error("Expected one argument.");const y=oh[m],b=[];for(let M=1;M<e.length;M++){const I=f.parse(e[M],M,bi);if(!I)return null;b.push(I)}return new cn(y,b)}evaluate(e){if(this.type.kind==="boolean")return Boolean(this.args[0].evaluate(e));if(this.type.kind==="color"){let f,m;for(const y of this.args){if(f=y.evaluate(e),m=null,f instanceof Di)return f;if(typeof f=="string"){const b=e.parseColor(f);if(b)return b}else if(Array.isArray(f)&&(m=f.length<3||f.length>4?`Invalid rbga value ${JSON.stringify(f)}: expected an array containing either three or four numeric values.`:an(f[0],f[1],f[2],f[3]),!m))return new Di(f[0]/255,f[1]/255,f[2]/255,f[3])}throw new _r(m||`Could not parse color from value '${typeof f=="string"?f:String(JSON.stringify(f))}'`)}if(this.type.kind==="number"){let f=null;for(const m of this.args){if(f=m.evaluate(e),f===null)return 0;const y=Number(f);if(!isNaN(y))return y}throw new _r(`Could not convert ${JSON.stringify(f)} to number.`)}return this.type.kind==="formatted"?ar.fromString(xn(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Fr.fromString(xn(this.args[0].evaluate(e))):xn(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new fo([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new po(this.args[0]).serialize();const e=[`to-${this.type.kind}`];return this.eachChild(f=>{e.push(f.serialize())}),e}}const sh=["Unknown","Point","LineString","Polygon"];class Rl{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&"id"in this.feature&&this.feature.id?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?sh[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,f=this.featureDistanceData.scale,{x:m,y}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(m*f-e[0])+this.featureDistanceData.bearing[1]*(y*f-e[1])}return 0}parseColor(e){let f=this._parseColorCache[e];return f||(f=this._parseColorCache[e]=Di.parse(e)),f}}class Or{constructor(e,f,m,y){this.name=e,this.type=f,this._evaluate=m,this.args=y}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,f){const m=e[0],y=Or.definitions[m];if(!y)return f.error(`Unknown expression "${m}". If you wanted a literal array, use ["literal", [...]].`,0);const b=Array.isArray(y)?y[0]:y.type,M=Array.isArray(y)?[[y[1],y[2]]]:y.overloads,I=M.filter(([L])=>!Array.isArray(L)||L.length===e.length-1);let P=null;for(const[L,N]of I){P=new kn(f.registry,f.path,null,f.scope);const U=[];let j=!1;for(let H=1;H<e.length;H++){const ne=e[H],ae=Array.isArray(L)?L[H-1]:L.type,pe=P.parse(ne,1+U.length,ae);if(!pe){j=!0;break}U.push(pe)}if(!j)if(Array.isArray(L)&&L.length!==U.length)P.error(`Expected ${L.length} arguments, but found ${U.length} instead.`);else{for(let H=0;H<U.length;H++){const ne=Array.isArray(L)?L[H]:L.type,ae=U[H];P.concat(H+1).checkSubtype(ne,ae.type)}if(P.errors.length===0)return new Or(m,b,N,U)}}if(I.length===1)f.errors.push(...P.errors);else{const L=(I.length?I:M).map(([U])=>{return j=U,Array.isArray(j)?`(${j.map(Xi).join(", ")})`:`(${Xi(j.type)}...)`;var j}).join(" | "),N=[];for(let U=1;U<e.length;U++){const j=f.parse(e[U],1+N.length);if(!j)return null;N.push(Xi(j.type))}f.error(`Expected arguments of type ${L}, but found (${N.join(", ")}) instead.`)}return null}static register(e,f){Or.definitions=f;for(const m in f)e[m]=Or}}class Es{constructor(e,f,m){this.type=Yn,this.locale=m,this.caseSensitive=e,this.diacriticSensitive=f}static parse(e,f){if(e.length!==2)return f.error("Expected one argument.");const m=e[1];if(typeof m!="object"||Array.isArray(m))return f.error("Collator options argument must be an object.");const y=f.parse(m["case-sensitive"]!==void 0&&m["case-sensitive"],1,xi);if(!y)return null;const b=f.parse(m["diacritic-sensitive"]!==void 0&&m["diacritic-sensitive"],1,xi);if(!b)return null;let M=null;return m.locale&&(M=f.parse(m.locale,1,Mi),!M)?null:new Es(y,b,M)}evaluate(e){return new uo(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}const Cn=8192;function va(d,e){d[0]=Math.min(d[0],e[0]),d[1]=Math.min(d[1],e[1]),d[2]=Math.max(d[2],e[0]),d[3]=Math.max(d[3],e[1])}function Ts(d,e){return!(d[0]<=e[0]||d[2]>=e[2]||d[1]<=e[1]||d[3]>=e[3])}function Ll(d,e){const f=(180+d[0])/360,m=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+d[1]*Math.PI/360)))/360,y=Math.pow(2,e.z);return[Math.round(f*y*Cn),Math.round(m*y*Cn)]}function Ms(d,e,f){const m=d[0]-e[0],y=d[1]-e[1],b=d[0]-f[0],M=d[1]-f[1];return m*M-b*y==0&&m*b<=0&&y*M<=0}function ba(d,e){let f=!1;for(let M=0,I=e.length;M<I;M++){const P=e[M];for(let L=0,N=P.length;L<N-1;L++){if(Ms(d,P[L],P[L+1]))return!1;(y=P[L])[1]>(m=d)[1]!=(b=P[L+1])[1]>m[1]&&m[0]<(b[0]-y[0])*(m[1]-y[1])/(b[1]-y[1])+y[0]&&(f=!f)}}var m,y,b;return f}function ah(d,e){for(let f=0;f<e.length;f++)if(ba(d,e[f]))return!0;return!1}function zl(d,e,f,m){const y=m[0]-f[0],b=m[1]-f[1],M=(d[0]-f[0])*b-y*(d[1]-f[1]),I=(e[0]-f[0])*b-y*(e[1]-f[1]);return M>0&&I<0||M<0&&I>0}function lh(d,e,f){for(const L of f)for(let N=0;N<L.length-1;++N)if((I=[(M=L[N+1])[0]-(b=L[N])[0],M[1]-b[1]])[0]*(P=[(y=e)[0]-(m=d)[0],y[1]-m[1]])[1]-I[1]*P[0]!=0&&zl(m,y,b,M)&&zl(b,M,m,y))return!0;var m,y,b,M,I,P;return!1}function Fl(d,e){for(let f=0;f<d.length;++f)if(!ba(d[f],e))return!1;for(let f=0;f<d.length-1;++f)if(lh(d[f],d[f+1],e))return!1;return!0}function ch(d,e){for(let f=0;f<e.length;f++)if(Fl(d,e[f]))return!0;return!1}function Ss(d,e,f){const m=[];for(let y=0;y<d.length;y++){const b=[];for(let M=0;M<d[y].length;M++){const I=Ll(d[y][M],f);va(e,I),b.push(I)}m.push(b)}return m}function $o(d,e,f){const m=[];for(let y=0;y<d.length;y++){const b=Ss(d[y],e,f);m.push(b)}return m}function Ol(d,e,f,m){if(d[0]<f[0]||d[0]>f[2]){const y=.5*m;let b=d[0]-f[0]>y?-m:f[0]-d[0]>y?m:0;b===0&&(b=d[0]-f[2]>y?-m:f[2]-d[0]>y?m:0),d[0]+=b}va(e,d)}function Nl(d,e,f,m){const y=Math.pow(2,m.z)*Cn,b=[m.x*Cn,m.y*Cn],M=[];if(!d)return M;for(const I of d)for(const P of I){const L=[P.x+b[0],P.y+b[1]];Ol(L,e,f,y),M.push(L)}return M}function $l(d,e,f,m){const y=Math.pow(2,m.z)*Cn,b=[m.x*Cn,m.y*Cn],M=[];if(!d)return M;for(const P of d){const L=[];for(const N of P){const U=[N.x+b[0],N.y+b[1]];va(e,U),L.push(U)}M.push(L)}if(e[2]-e[0]<=y/2){(I=e)[0]=I[1]=1/0,I[2]=I[3]=-1/0;for(const P of M)for(const L of P)Ol(L,e,f,y)}var I;return M}class Wn{constructor(e,f){this.type=xi,this.geojson=e,this.geometries=f}static parse(e,f){if(e.length!==2)return f.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(ws(e[1])){const m=e[1];if(m.type==="FeatureCollection")for(let y=0;y<m.features.length;++y){const b=m.features[y].geometry.type;if(b==="Polygon"||b==="MultiPolygon")return new Wn(m,m.features[y].geometry)}else if(m.type==="Feature"){const y=m.geometry.type;if(y==="Polygon"||y==="MultiPolygon")return new Wn(m,m.geometry)}else if(m.type==="Polygon"||m.type==="MultiPolygon")return new Wn(m,m)}return f.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(f,m){const y=[1/0,1/0,-1/0,-1/0],b=[1/0,1/0,-1/0,-1/0],M=f.canonicalID();if(!M)return!1;if(m.type==="Polygon"){const I=Ss(m.coordinates,b,M),P=Nl(f.geometry(),y,b,M);if(!Ts(y,b))return!1;for(const L of P)if(!ba(L,I))return!1}if(m.type==="MultiPolygon"){const I=$o(m.coordinates,b,M),P=Nl(f.geometry(),y,b,M);if(!Ts(y,b))return!1;for(const L of P)if(!ah(L,I))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(f,m){const y=[1/0,1/0,-1/0,-1/0],b=[1/0,1/0,-1/0,-1/0],M=f.canonicalID();if(!M)return!1;if(m.type==="Polygon"){const I=Ss(m.coordinates,b,M),P=$l(f.geometry(),y,b,M);if(!Ts(y,b))return!1;for(const L of P)if(!Fl(L,I))return!1}if(m.type==="MultiPolygon"){const I=$o(m.coordinates,b,M),P=$l(f.geometry(),y,b,M);if(!Ts(y,b))return!1;for(const L of P)if(!ch(L,I))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}function Ir(d){if(d instanceof Or&&(d.name==="get"&&d.args.length===1||d.name==="feature-state"||d.name==="has"&&d.args.length===1||d.name==="properties"||d.name==="geometry-type"||d.name==="id"||/^filter-/.test(d.name))||d instanceof Wn)return!1;let e=!0;return d.eachChild(f=>{e&&!Ir(f)&&(e=!1)}),e}function Uo(d){if(d instanceof Or&&d.name==="feature-state")return!1;let e=!0;return d.eachChild(f=>{e&&!Uo(f)&&(e=!1)}),e}function Vo(d,e){if(d instanceof Or&&e.indexOf(d.name)>=0)return!1;let f=!0;return d.eachChild(m=>{f&&!Vo(m,e)&&(f=!1)}),f}class Hn{constructor(e,f){this.type=f.type,this.name=e,this.boundExpression=f}static parse(e,f){if(e.length!==2||typeof e[1]!="string")return f.error("'var' expression requires exactly one string literal argument.");const m=e[1];return f.scope.has(m)?new Hn(m,f.scope.get(m)):f.error(`Unknown variable "${m}". Make sure "${m}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class kn{constructor(e,f=[],m,y=new Xr,b=[]){this.registry=e,this.path=f,this.key=f.map(M=>`[${M}]`).join(""),this.scope=y,this.errors=b,this.expectedType=m}parse(e,f,m,y,b={}){return f?this.concat(f,m,y)._parse(e,b):this._parse(e,b)}_parse(e,f){function m(y,b,M){return M==="assert"?new ln(b,[y]):M==="coerce"?new cn(b,[y]):y}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const y=e[0];if(typeof y!="string")return this.error(`Expression name must be a string, but found ${typeof y} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const b=this.registry[y];if(b){let M=b.parse(e,this);if(!M)return null;if(this.expectedType){const I=this.expectedType,P=M.type;if(I.kind!=="string"&&I.kind!=="number"&&I.kind!=="boolean"&&I.kind!=="object"&&I.kind!=="array"||P.kind!=="value")if(I.kind!=="color"&&I.kind!=="formatted"&&I.kind!=="resolvedImage"||P.kind!=="value"&&P.kind!=="string"){if(this.checkSubtype(I,P))return null}else M=m(M,I,f.typeAnnotation||"coerce");else M=m(M,I,f.typeAnnotation||"assert")}if(!(M instanceof vn)&&M.type.kind!=="resolvedImage"&&As(M)){const I=new Rl;try{M=new vn(M.type,M.evaluate(I))}catch(P){return this.error(P.message),null}}return M}return this.error(`Unknown expression "${y}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,f,m){const y=typeof e=="number"?this.path.concat(e):this.path,b=m?this.scope.concat(m):this.scope;return new kn(this.registry,y,f||null,b,this.errors)}error(e,...f){const m=`${this.key}${f.map(y=>`[${y}]`).join("")}`;this.errors.push(new ki(m,e))}checkSubtype(e,f){const m=No(e,f);return m&&this.error(m),m}}function As(d){if(d instanceof Hn)return As(d.boundExpression);if(d instanceof Or&&d.name==="error"||d instanceof Es||d instanceof Wn)return!1;const e=d instanceof cn||d instanceof ln;let f=!0;return d.eachChild(m=>{f=e?f&&As(m):f&&m instanceof vn}),!!f&&Ir(d)&&Vo(d,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function jo(d,e){const f=d.length-1;let m,y,b=0,M=f,I=0;for(;b<=M;)if(I=Math.floor((b+M)/2),m=d[I],y=d[I+1],m<=e){if(I===f||e<y)return I;b=I+1}else{if(!(m>e))throw new _r("Input is not a number.");M=I-1}return 0}class Go{constructor(e,f,m){this.type=e,this.input=f,this.labels=[],this.outputs=[];for(const[y,b]of m)this.labels.push(y),this.outputs.push(b)}static parse(e,f){if(e.length-1<4)return f.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return f.error("Expected an even number of arguments.");const m=f.parse(e[1],1,xt);if(!m)return null;const y=[];let b=null;f.expectedType&&f.expectedType.kind!=="value"&&(b=f.expectedType);for(let M=1;M<e.length;M+=2){const I=M===1?-1/0:e[M],P=e[M+1],L=M,N=M+1;if(typeof I!="number")return f.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',L);if(y.length&&y[y.length-1][0]>=I)return f.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',L);const U=f.parse(P,N,b);if(!U)return null;b=b||U.type,y.push([I,U])}return new Go(b,m,y)}evaluate(e){const f=this.labels,m=this.outputs;if(f.length===1)return m[0].evaluate(e);const y=this.input.evaluate(e);if(y<=f[0])return m[0].evaluate(e);const b=f.length;return y>=f[b-1]?m[b-1].evaluate(e):m[jo(f,y)].evaluate(e)}eachChild(e){e(this.input);for(const f of this.outputs)e(f)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let f=0;f<this.labels.length;f++)f>0&&e.push(this.labels[f]),e.push(this.outputs[f].serialize());return e}}function Xt(d,e,f){return d*(1-f)+e*f}var Is=Object.freeze({__proto__:null,number:Xt,color:function(d,e,f){return new Di(Xt(d.r,e.r,f),Xt(d.g,e.g,f),Xt(d.b,e.b,f),Xt(d.a,e.a,f))},array:function(d,e,f){return d.map((m,y)=>Xt(m,e[y],f))}});const Ul=.95047,Vl=1.08883,wa=4/29,Ea=6/29,Ta=3*Ea*Ea,jl=Math.PI/180,Gl=180/Math.PI;function Cs(d){return d>.008856451679035631?Math.pow(d,1/3):d/Ta+wa}function Dn(d){return d>Ea?d*d*d:Ta*(d-wa)}function mo(d){return 255*(d<=.0031308?12.92*d:1.055*Math.pow(d,1/2.4)-.055)}function Ma(d){return(d/=255)<=.04045?d/12.92:Math.pow((d+.055)/1.055,2.4)}function ks(d){const e=Ma(d.r),f=Ma(d.g),m=Ma(d.b),y=Cs((.4124564*e+.3575761*f+.1804375*m)/Ul),b=Cs((.2126729*e+.7151522*f+.072175*m)/1);return{l:116*b-16,a:500*(y-b),b:200*(b-Cs((.0193339*e+.119192*f+.9503041*m)/Vl)),alpha:d.a}}function Sa(d){let e=(d.l+16)/116,f=isNaN(d.a)?e:e+d.a/500,m=isNaN(d.b)?e:e-d.b/200;return e=1*Dn(e),f=Ul*Dn(f),m=Vl*Dn(m),new Di(mo(3.2404542*f-1.5371385*e-.4985314*m),mo(-.969266*f+1.8760108*e+.041556*m),mo(.0556434*f-.2040259*e+1.0572252*m),d.alpha)}function hh(d,e,f){const m=e-d;return d+f*(m>180||m<-180?m-360*Math.round(m/360):m)}const qo={forward:ks,reverse:Sa,interpolate:function(d,e,f){return{l:Xt(d.l,e.l,f),a:Xt(d.a,e.a,f),b:Xt(d.b,e.b,f),alpha:Xt(d.alpha,e.alpha,f)}}},Zo={forward:function(d){const{l:e,a:f,b:m}=ks(d),y=Math.atan2(m,f)*Gl;return{h:y<0?y+360:y,c:Math.sqrt(f*f+m*m),l:e,alpha:d.a}},reverse:function(d){const e=d.h*jl,f=d.c;return Sa({l:d.l,a:Math.cos(e)*f,b:Math.sin(e)*f,alpha:d.alpha})},interpolate:function(d,e,f){return{h:hh(d.h,e.h,f),c:Xt(d.c,e.c,f),l:Xt(d.l,e.l,f),alpha:Xt(d.alpha,e.alpha,f)}}};var Aa=Object.freeze({__proto__:null,lab:qo,hcl:Zo});class Nr{constructor(e,f,m,y,b){this.type=e,this.operator=f,this.interpolation=m,this.input=y,this.labels=[],this.outputs=[];for(const[M,I]of b)this.labels.push(M),this.outputs.push(I)}static interpolationFactor(e,f,m,y){let b=0;if(e.name==="exponential")b=Ds(f,e.base,m,y);else if(e.name==="linear")b=Ds(f,1,m,y);else if(e.name==="cubic-bezier"){const M=e.controlPoints;b=new S(M[0],M[1],M[2],M[3]).solve(Ds(f,1,m,y))}return b}static parse(e,f){let[m,y,b,...M]=e;if(!Array.isArray(y)||y.length===0)return f.error("Expected an interpolation type expression.",1);if(y[0]==="linear")y={name:"linear"};else if(y[0]==="exponential"){const L=y[1];if(typeof L!="number")return f.error("Exponential interpolation requires a numeric base.",1,1);y={name:"exponential",base:L}}else{if(y[0]!=="cubic-bezier")return f.error(`Unknown interpolation type ${String(y[0])}`,1,0);{const L=y.slice(1);if(L.length!==4||L.some(N=>typeof N!="number"||N<0||N>1))return f.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);y={name:"cubic-bezier",controlPoints:L}}}if(e.length-1<4)return f.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return f.error("Expected an even number of arguments.");if(b=f.parse(b,2,xt),!b)return null;const I=[];let P=null;m==="interpolate-hcl"||m==="interpolate-lab"?P=fn:f.expectedType&&f.expectedType.kind!=="value"&&(P=f.expectedType);for(let L=0;L<M.length;L+=2){const N=M[L],U=M[L+1],j=L+3,H=L+4;if(typeof N!="number")return f.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',j);if(I.length&&I[I.length-1][0]>=N)return f.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',j);const ne=f.parse(U,H,P);if(!ne)return null;P=P||ne.type,I.push([N,ne])}return P.kind==="number"||P.kind==="color"||P.kind==="array"&&P.itemType.kind==="number"&&typeof P.N=="number"?new Nr(P,m,y,b,I):f.error(`Type ${Xi(P)} is not interpolatable.`)}evaluate(e){const f=this.labels,m=this.outputs;if(f.length===1)return m[0].evaluate(e);const y=this.input.evaluate(e);if(y<=f[0])return m[0].evaluate(e);const b=f.length;if(y>=f[b-1])return m[b-1].evaluate(e);const M=jo(f,y),I=Nr.interpolationFactor(this.interpolation,y,f[M],f[M+1]),P=m[M].evaluate(e),L=m[M+1].evaluate(e);return this.operator==="interpolate"?Is[this.type.kind.toLowerCase()](P,L,I):this.operator==="interpolate-hcl"?Zo.reverse(Zo.interpolate(Zo.forward(P),Zo.forward(L),I)):qo.reverse(qo.interpolate(qo.forward(P),qo.forward(L),I))}eachChild(e){e(this.input);for(const f of this.outputs)e(f)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const f=[this.operator,e,this.input.serialize()];for(let m=0;m<this.labels.length;m++)f.push(this.labels[m],this.outputs[m].serialize());return f}}function Ds(d,e,f,m){const y=m-f,b=d-f;return y===0?0:e===1?b/y:(Math.pow(e,b)-1)/(Math.pow(e,y)-1)}class Xo{constructor(e,f){this.type=e,this.args=f}static parse(e,f){if(e.length<2)return f.error("Expectected at least one argument.");let m=null;const y=f.expectedType;y&&y.kind!=="value"&&(m=y);const b=[];for(const I of e.slice(1)){const P=f.parse(I,1+b.length,m,void 0,{typeAnnotation:"omit"});if(!P)return null;m=m||P.type,b.push(P)}const M=y&&b.some(I=>No(y,I.type));return new Xo(M?bi:m,b)}evaluate(e){let f,m=null,y=0;for(const b of this.args){if(y++,m=b.evaluate(e),m&&m instanceof Fr&&!m.available&&(f||(f=m),m=null,y===this.args.length))return f;if(m!==null)break}return m}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(f=>{e.push(f.serialize())}),e}}class Yo{constructor(e,f){this.type=f.type,this.bindings=[].concat(e),this.result=f}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const f of this.bindings)e(f[1]);e(this.result)}static parse(e,f){if(e.length<4)return f.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const m=[];for(let b=1;b<e.length-1;b+=2){const M=e[b];if(typeof M!="string")return f.error(`Expected string, but found ${typeof M} instead.`,b);if(/[^a-zA-Z0-9_]/.test(M))return f.error("Variable names must contain only alphanumeric characters or '_'.",b);const I=f.parse(e[b+1],b+1);if(!I)return null;m.push([M,I])}const y=f.parse(e[e.length-1],e.length-1,f.expectedType,m);return y?new Yo(m,y):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[f,m]of this.bindings)e.push(f,m.serialize());return e.push(this.result.serialize()),e}}class Ia{constructor(e,f,m){this.type=e,this.index=f,this.input=m}static parse(e,f){if(e.length!==3)return f.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const m=f.parse(e[1],1,xt),y=f.parse(e[2],2,Yr(f.expectedType||bi));return m&&y?new Ia(y.type.itemType,m,y):null}evaluate(e){const f=this.index.evaluate(e),m=this.input.evaluate(e);if(f<0)throw new _r(`Array index out of bounds: ${f} < 0.`);if(f>=m.length)throw new _r(`Array index out of bounds: ${f} > ${m.length-1}.`);if(f!==Math.floor(f))throw new _r(`Array index must be an integer, but found ${f} instead.`);return m[f]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Ps{constructor(e,f){this.type=xi,this.needle=e,this.haystack=f}static parse(e,f){if(e.length!==3)return f.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const m=f.parse(e[1],1,bi),y=f.parse(e[2],2,bi);return m&&y?vs(m.type,[xi,Mi,xt,yn,bi])?new Ps(m,y):f.error(`Expected first argument to be of type boolean, string, number or null, but found ${Xi(m.type)} instead`):null}evaluate(e){const f=this.needle.evaluate(e),m=this.haystack.evaluate(e);if(m==null)return!1;if(!ho(f,["boolean","string","number","null"]))throw new _r(`Expected first argument to be of type boolean, string, number or null, but found ${Xi(rr(f))} instead.`);if(!ho(m,["string","array"]))throw new _r(`Expected second argument to be of type array or string, but found ${Xi(rr(m))} instead.`);return m.indexOf(f)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Bs{constructor(e,f,m){this.type=xt,this.needle=e,this.haystack=f,this.fromIndex=m}static parse(e,f){if(e.length<=2||e.length>=5)return f.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const m=f.parse(e[1],1,bi),y=f.parse(e[2],2,bi);if(!m||!y)return null;if(!vs(m.type,[xi,Mi,xt,yn,bi]))return f.error(`Expected first argument to be of type boolean, string, number or null, but found ${Xi(m.type)} instead`);if(e.length===4){const b=f.parse(e[3],3,xt);return b?new Bs(m,y,b):null}return new Bs(m,y)}evaluate(e){const f=this.needle.evaluate(e),m=this.haystack.evaluate(e);if(!ho(f,["boolean","string","number","null"]))throw new _r(`Expected first argument to be of type boolean, string, number or null, but found ${Xi(rr(f))} instead.`);if(!ho(m,["string","array"]))throw new _r(`Expected second argument to be of type array or string, but found ${Xi(rr(m))} instead.`);if(this.fromIndex){const y=this.fromIndex.evaluate(e);return m.indexOf(f,y)}return m.indexOf(f)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Rs{constructor(e,f,m,y,b,M){this.inputType=e,this.type=f,this.input=m,this.cases=y,this.outputs=b,this.otherwise=M}static parse(e,f){if(e.length<5)return f.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return f.error("Expected an even number of arguments.");let m,y;f.expectedType&&f.expectedType.kind!=="value"&&(y=f.expectedType);const b={},M=[];for(let L=2;L<e.length-1;L+=2){let N=e[L];const U=e[L+1];Array.isArray(N)||(N=[N]);const j=f.concat(L);if(N.length===0)return j.error("Expected at least one branch label.");for(const ne of N){if(typeof ne!="number"&&typeof ne!="string")return j.error("Branch labels must be numbers or strings.");if(typeof ne=="number"&&Math.abs(ne)>Number.MAX_SAFE_INTEGER)return j.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof ne=="number"&&Math.floor(ne)!==ne)return j.error("Numeric branch labels must be integer values.");if(m){if(j.checkSubtype(m,rr(ne)))return null}else m=rr(ne);if(b[String(ne)]!==void 0)return j.error("Branch labels must be unique.");b[String(ne)]=M.length}const H=f.parse(U,L,y);if(!H)return null;y=y||H.type,M.push(H)}const I=f.parse(e[1],1,bi);if(!I)return null;const P=f.parse(e[e.length-1],e.length-1,y);return P?I.type.kind!=="value"&&f.concat(1).checkSubtype(m,I.type)?null:new Rs(m,y,I,b,M,P):null}evaluate(e){const f=this.input.evaluate(e);return(rr(f)===this.inputType&&this.outputs[this.cases[f]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],f=Object.keys(this.cases).sort(),m=[],y={};for(const M of f){const I=y[this.cases[M]];I===void 0?(y[this.cases[M]]=m.length,m.push([this.cases[M],[M]])):m[I][1].push(M)}const b=M=>this.inputType.kind==="number"?Number(M):M;for(const[M,I]of m)e.push(I.length===1?b(I[0]):I.map(b)),e.push(this.outputs[M].serialize());return e.push(this.otherwise.serialize()),e}}class Ls{constructor(e,f,m){this.type=e,this.branches=f,this.otherwise=m}static parse(e,f){if(e.length<4)return f.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return f.error("Expected an odd number of arguments.");let m;f.expectedType&&f.expectedType.kind!=="value"&&(m=f.expectedType);const y=[];for(let M=1;M<e.length-1;M+=2){const I=f.parse(e[M],M,xi);if(!I)return null;const P=f.parse(e[M+1],M+1,m);if(!P)return null;y.push([I,P]),m=m||P.type}const b=f.parse(e[e.length-1],e.length-1,m);return b?new Ls(m,y,b):null}evaluate(e){for(const[f,m]of this.branches)if(f.evaluate(e))return m.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[f,m]of this.branches)e(f),e(m);e(this.otherwise)}outputDefined(){return this.branches.every(([e,f])=>f.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(f=>{e.push(f.serialize())}),e}}class zs{constructor(e,f,m,y){this.type=e,this.input=f,this.beginIndex=m,this.endIndex=y}static parse(e,f){if(e.length<=2||e.length>=5)return f.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const m=f.parse(e[1],1,bi),y=f.parse(e[2],2,xt);if(!m||!y)return null;if(!vs(m.type,[Yr(bi),Mi,bi]))return f.error(`Expected first argument to be of type array or string, but found ${Xi(m.type)} instead`);if(e.length===4){const b=f.parse(e[3],3,xt);return b?new zs(m.type,m,y,b):null}return new zs(m.type,m,y)}evaluate(e){const f=this.input.evaluate(e),m=this.beginIndex.evaluate(e);if(!ho(f,["string","array"]))throw new _r(`Expected first argument to be of type array or string, but found ${Xi(rr(f))} instead.`);if(this.endIndex){const y=this.endIndex.evaluate(e);return f.slice(m,y)}return f.slice(m)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function ql(d,e){return d==="=="||d==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Zl(d,e,f,m){return m.compare(e,f)===0}function go(d,e,f){const m=d!=="=="&&d!=="!=";return class zf{constructor(b,M,I){this.type=xi,this.lhs=b,this.rhs=M,this.collator=I,this.hasUntypedArgument=b.type.kind==="value"||M.type.kind==="value"}static parse(b,M){if(b.length!==3&&b.length!==4)return M.error("Expected two or three arguments.");const I=b[0];let P=M.parse(b[1],1,bi);if(!P)return null;if(!ql(I,P.type))return M.concat(1).error(`"${I}" comparisons are not supported for type '${Xi(P.type)}'.`);let L=M.parse(b[2],2,bi);if(!L)return null;if(!ql(I,L.type))return M.concat(2).error(`"${I}" comparisons are not supported for type '${Xi(L.type)}'.`);if(P.type.kind!==L.type.kind&&P.type.kind!=="value"&&L.type.kind!=="value")return M.error(`Cannot compare types '${Xi(P.type)}' and '${Xi(L.type)}'.`);m&&(P.type.kind==="value"&&L.type.kind!=="value"?P=new ln(L.type,[P]):P.type.kind!=="value"&&L.type.kind==="value"&&(L=new ln(P.type,[L])));let N=null;if(b.length===4){if(P.type.kind!=="string"&&L.type.kind!=="string"&&P.type.kind!=="value"&&L.type.kind!=="value")return M.error("Cannot use collator to compare non-string types.");if(N=M.parse(b[3],3,Yn),!N)return null}return new zf(P,L,N)}evaluate(b){const M=this.lhs.evaluate(b),I=this.rhs.evaluate(b);if(m&&this.hasUntypedArgument){const P=rr(M),L=rr(I);if(P.kind!==L.kind||P.kind!=="string"&&P.kind!=="number")throw new _r(`Expected arguments for "${d}" to be (string, string) or (number, number), but found (${P.kind}, ${L.kind}) instead.`)}if(this.collator&&!m&&this.hasUntypedArgument){const P=rr(M),L=rr(I);if(P.kind!=="string"||L.kind!=="string")return e(b,M,I)}return this.collator?f(b,M,I,this.collator.evaluate(b)):e(b,M,I)}eachChild(b){b(this.lhs),b(this.rhs),this.collator&&b(this.collator)}outputDefined(){return!0}serialize(){const b=[d];return this.eachChild(M=>{b.push(M.serialize())}),b}}}const uh=go("==",function(d,e,f){return e===f},Zl),dh=go("!=",function(d,e,f){return e!==f},function(d,e,f,m){return!Zl(0,e,f,m)}),Xl=go("<",function(d,e,f){return e<f},function(d,e,f,m){return m.compare(e,f)<0}),fh=go(">",function(d,e,f){return e>f},function(d,e,f,m){return m.compare(e,f)>0}),ph=go("<=",function(d,e,f){return e<=f},function(d,e,f,m){return m.compare(e,f)<=0}),mh=go(">=",function(d,e,f){return e>=f},function(d,e,f,m){return m.compare(e,f)>=0});class Ca{constructor(e,f,m,y,b){this.type=Mi,this.number=e,this.locale=f,this.currency=m,this.minFractionDigits=y,this.maxFractionDigits=b}static parse(e,f){if(e.length!==3)return f.error("Expected two arguments.");const m=f.parse(e[1],1,xt);if(!m)return null;const y=e[2];if(typeof y!="object"||Array.isArray(y))return f.error("NumberFormat options argument must be an object.");let b=null;if(y.locale&&(b=f.parse(y.locale,1,Mi),!b))return null;let M=null;if(y.currency&&(M=f.parse(y.currency,1,Mi),!M))return null;let I=null;if(y["min-fraction-digits"]&&(I=f.parse(y["min-fraction-digits"],1,xt),!I))return null;let P=null;return y["max-fraction-digits"]&&(P=f.parse(y["max-fraction-digits"],1,xt),!P)?null:new Ca(m,b,M,I,P)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Fs{constructor(e){this.type=xt,this.input=e}static parse(e,f){if(e.length!==2)return f.error(`Expected 1 argument, but found ${e.length-1} instead.`);const m=f.parse(e[1],1);return m?m.type.kind!=="array"&&m.type.kind!=="string"&&m.type.kind!=="value"?f.error(`Expected argument of type string or array, but found ${Xi(m.type)} instead.`):new Fs(m):null}evaluate(e){const f=this.input.evaluate(e);if(typeof f=="string"||Array.isArray(f))return f.length;throw new _r(`Expected value to be of type string or array, but found ${Xi(rr(f))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(f=>{e.push(f.serialize())}),e}}const Kn={"==":uh,"!=":dh,">":fh,"<":Xl,">=":mh,"<=":ph,array:ln,at:Ia,boolean:ln,case:Ls,coalesce:Xo,collator:Es,format:fo,image:po,in:Ps,"index-of":Bs,interpolate:Nr,"interpolate-hcl":Nr,"interpolate-lab":Nr,length:Fs,let:Yo,literal:vn,match:Rs,number:ln,"number-format":Ca,object:ln,slice:zs,step:Go,string:ln,"to-boolean":cn,"to-color":cn,"to-number":cn,"to-string":cn,var:Hn,within:Wn};function ka(d,[e,f,m,y]){e=e.evaluate(d),f=f.evaluate(d),m=m.evaluate(d);const b=y?y.evaluate(d):1,M=an(e,f,m,b);if(M)throw new _r(M);return new Di(e/255*b,f/255*b,m/255*b,b)}function Yl(d,e){return d in e}function Da(d,e){const f=e[d];return f===void 0?null:f}function Pn(d){return{type:d}}function Pa(d){return{result:"success",value:d}}function Jn(d){return{result:"error",value:d}}function _o(d){return d["property-type"]==="data-driven"||d["property-type"]==="cross-faded-data-driven"}function Wl(d){return!!d.expression&&d.expression.parameters.indexOf("zoom")>-1}function Ba(d){return!!d.expression&&d.expression.interpolated}function Li(d){return d instanceof Number?"number":d instanceof String?"string":d instanceof Boolean?"boolean":Array.isArray(d)?"array":d===null?"null":typeof d}function Qn(d){return typeof d=="object"&&d!==null&&!Array.isArray(d)}function Hl(d){return d}function Ra(d,e){const f=e.type==="color",m=d.stops&&typeof d.stops[0][0]=="object",y=m||!(m||d.property!==void 0),b=d.type||(Ba(e)?"exponential":"interval");if(f&&((d=Ti({},d)).stops&&(d.stops=d.stops.map(L=>[L[0],Di.parse(L[1])])),d.default=Di.parse(d.default?d.default:e.default)),d.colorSpace&&d.colorSpace!=="rgb"&&!Aa[d.colorSpace])throw new Error(`Unknown color space: ${d.colorSpace}`);let M,I,P;if(b==="exponential")M=La;else if(b==="interval")M=_h;else if(b==="categorical"){M=gh,I=Object.create(null);for(const L of d.stops)I[L[0]]=L[1];P=typeof d.stops[0][0]}else{if(b!=="identity")throw new Error(`Unknown function type "${b}"`);M=Kl}if(m){const L={},N=[];for(let H=0;H<d.stops.length;H++){const ne=d.stops[H],ae=ne[0].zoom;L[ae]===void 0&&(L[ae]={zoom:ae,type:d.type,property:d.property,default:d.default,stops:[]},N.push(ae)),L[ae].stops.push([ne[0].value,ne[1]])}const U=[];for(const H of N)U.push([L[H].zoom,Ra(L[H],e)]);const j={name:"linear"};return{kind:"composite",interpolationType:j,interpolationFactor:Nr.interpolationFactor.bind(void 0,j),zoomStops:U.map(H=>H[0]),evaluate:({zoom:H},ne)=>La({stops:U,base:d.base},e,H).evaluate(H,ne)}}if(y){const L=b==="exponential"?{name:"exponential",base:d.base!==void 0?d.base:1}:null;return{kind:"camera",interpolationType:L,interpolationFactor:Nr.interpolationFactor.bind(void 0,L),zoomStops:d.stops.map(N=>N[0]),evaluate:({zoom:N})=>M(d,e,N,I,P)}}return{kind:"source",evaluate(L,N){const U=N&&N.properties?N.properties[d.property]:void 0;return U===void 0?Wo(d.default,e.default):M(d,e,U,I,P)}}}function Wo(d,e,f){return d!==void 0?d:e!==void 0?e:f!==void 0?f:void 0}function gh(d,e,f,m,y){return Wo(typeof f===y?m[f]:void 0,d.default,e.default)}function _h(d,e,f){if(Li(f)!=="number")return Wo(d.default,e.default);const m=d.stops.length;if(m===1||f<=d.stops[0][0])return d.stops[0][1];if(f>=d.stops[m-1][0])return d.stops[m-1][1];const y=jo(d.stops.map(b=>b[0]),f);return d.stops[y][1]}function La(d,e,f){const m=d.base!==void 0?d.base:1;if(Li(f)!=="number")return Wo(d.default,e.default);const y=d.stops.length;if(y===1||f<=d.stops[0][0])return d.stops[0][1];if(f>=d.stops[y-1][0])return d.stops[y-1][1];const b=jo(d.stops.map(N=>N[0]),f),M=function(N,U,j,H){const ne=H-j,ae=N-j;return ne===0?0:U===1?ae/ne:(Math.pow(U,ae)-1)/(Math.pow(U,ne)-1)}(f,m,d.stops[b][0],d.stops[b+1][0]),I=d.stops[b][1],P=d.stops[b+1][1];let L=Is[e.type]||Hl;if(d.colorSpace&&d.colorSpace!=="rgb"){const N=Aa[d.colorSpace];L=(U,j)=>N.reverse(N.interpolate(N.forward(U),N.forward(j),M))}return typeof I.evaluate=="function"?{evaluate(...N){const U=I.evaluate.apply(void 0,N),j=P.evaluate.apply(void 0,N);if(U!==void 0&&j!==void 0)return L(U,j,M)}}:L(I,P,M)}function Kl(d,e,f){return e.type==="color"?f=Di.parse(f):e.type==="formatted"?f=ar.fromString(f.toString()):e.type==="resolvedImage"?f=Fr.fromString(f.toString()):Li(f)===e.type||e.type==="enum"&&e.values[f]||(f=void 0),Wo(f,d.default,e.default)}Or.register(Kn,{error:[{kind:"error"},[Mi],(d,[e])=>{throw new _r(e.evaluate(d))}],typeof:[Mi,[bi],(d,[e])=>Xi(rr(e.evaluate(d)))],"to-rgba":[Yr(xt,4),[fn],(d,[e])=>e.evaluate(d).toArray()],rgb:[fn,[xt,xt,xt],ka],rgba:[fn,[xt,xt,xt,xt],ka],has:{type:xi,overloads:[[[Mi],(d,[e])=>Yl(e.evaluate(d),d.properties())],[[Mi,Xn],(d,[e,f])=>Yl(e.evaluate(d),f.evaluate(d))]]},get:{type:bi,overloads:[[[Mi],(d,[e])=>Da(e.evaluate(d),d.properties())],[[Mi,Xn],(d,[e,f])=>Da(e.evaluate(d),f.evaluate(d))]]},"feature-state":[bi,[Mi],(d,[e])=>Da(e.evaluate(d),d.featureState||{})],properties:[Xn,[],d=>d.properties()],"geometry-type":[Mi,[],d=>d.geometryType()],id:[bi,[],d=>d.id()],zoom:[xt,[],d=>d.globals.zoom],pitch:[xt,[],d=>d.globals.pitch||0],"distance-from-center":[xt,[],d=>d.distanceFromCenter()],"heatmap-density":[xt,[],d=>d.globals.heatmapDensity||0],"line-progress":[xt,[],d=>d.globals.lineProgress||0],"sky-radial-progress":[xt,[],d=>d.globals.skyRadialProgress||0],accumulated:[bi,[],d=>d.globals.accumulated===void 0?null:d.globals.accumulated],"+":[xt,Pn(xt),(d,e)=>{let f=0;for(const m of e)f+=m.evaluate(d);return f}],"*":[xt,Pn(xt),(d,e)=>{let f=1;for(const m of e)f*=m.evaluate(d);return f}],"-":{type:xt,overloads:[[[xt,xt],(d,[e,f])=>e.evaluate(d)-f.evaluate(d)],[[xt],(d,[e])=>-e.evaluate(d)]]},"/":[xt,[xt,xt],(d,[e,f])=>e.evaluate(d)/f.evaluate(d)],"%":[xt,[xt,xt],(d,[e,f])=>e.evaluate(d)%f.evaluate(d)],ln2:[xt,[],()=>Math.LN2],pi:[xt,[],()=>Math.PI],e:[xt,[],()=>Math.E],"^":[xt,[xt,xt],(d,[e,f])=>Math.pow(e.evaluate(d),f.evaluate(d))],sqrt:[xt,[xt],(d,[e])=>Math.sqrt(e.evaluate(d))],log10:[xt,[xt],(d,[e])=>Math.log(e.evaluate(d))/Math.LN10],ln:[xt,[xt],(d,[e])=>Math.log(e.evaluate(d))],log2:[xt,[xt],(d,[e])=>Math.log(e.evaluate(d))/Math.LN2],sin:[xt,[xt],(d,[e])=>Math.sin(e.evaluate(d))],cos:[xt,[xt],(d,[e])=>Math.cos(e.evaluate(d))],tan:[xt,[xt],(d,[e])=>Math.tan(e.evaluate(d))],asin:[xt,[xt],(d,[e])=>Math.asin(e.evaluate(d))],acos:[xt,[xt],(d,[e])=>Math.acos(e.evaluate(d))],atan:[xt,[xt],(d,[e])=>Math.atan(e.evaluate(d))],min:[xt,Pn(xt),(d,e)=>Math.min(...e.map(f=>f.evaluate(d)))],max:[xt,Pn(xt),(d,e)=>Math.max(...e.map(f=>f.evaluate(d)))],abs:[xt,[xt],(d,[e])=>Math.abs(e.evaluate(d))],round:[xt,[xt],(d,[e])=>{const f=e.evaluate(d);return f<0?-Math.round(-f):Math.round(f)}],floor:[xt,[xt],(d,[e])=>Math.floor(e.evaluate(d))],ceil:[xt,[xt],(d,[e])=>Math.ceil(e.evaluate(d))],"filter-==":[xi,[Mi,bi],(d,[e,f])=>d.properties()[e.value]===f.value],"filter-id-==":[xi,[bi],(d,[e])=>d.id()===e.value],"filter-type-==":[xi,[Mi],(d,[e])=>d.geometryType()===e.value],"filter-<":[xi,[Mi,bi],(d,[e,f])=>{const m=d.properties()[e.value],y=f.value;return typeof m==typeof y&&m<y}],"filter-id-<":[xi,[bi],(d,[e])=>{const f=d.id(),m=e.value;return typeof f==typeof m&&f<m}],"filter->":[xi,[Mi,bi],(d,[e,f])=>{const m=d.properties()[e.value],y=f.value;return typeof m==typeof y&&m>y}],"filter-id->":[xi,[bi],(d,[e])=>{const f=d.id(),m=e.value;return typeof f==typeof m&&f>m}],"filter-<=":[xi,[Mi,bi],(d,[e,f])=>{const m=d.properties()[e.value],y=f.value;return typeof m==typeof y&&m<=y}],"filter-id-<=":[xi,[bi],(d,[e])=>{const f=d.id(),m=e.value;return typeof f==typeof m&&f<=m}],"filter->=":[xi,[Mi,bi],(d,[e,f])=>{const m=d.properties()[e.value],y=f.value;return typeof m==typeof y&&m>=y}],"filter-id->=":[xi,[bi],(d,[e])=>{const f=d.id(),m=e.value;return typeof f==typeof m&&f>=m}],"filter-has":[xi,[bi],(d,[e])=>e.value in d.properties()],"filter-has-id":[xi,[],d=>d.id()!==null&&d.id()!==void 0],"filter-type-in":[xi,[Yr(Mi)],(d,[e])=>e.value.indexOf(d.geometryType())>=0],"filter-id-in":[xi,[Yr(bi)],(d,[e])=>e.value.indexOf(d.id())>=0],"filter-in-small":[xi,[Mi,Yr(bi)],(d,[e,f])=>f.value.indexOf(d.properties()[e.value])>=0],"filter-in-large":[xi,[Mi,Yr(bi)],(d,[e,f])=>function(m,y,b,M){for(;b<=M;){const I=b+M>>1;if(y[I]===m)return!0;y[I]>m?M=I-1:b=I+1}return!1}(d.properties()[e.value],f.value,0,f.value.length-1)],all:{type:xi,overloads:[[[xi,xi],(d,[e,f])=>e.evaluate(d)&&f.evaluate(d)],[Pn(xi),(d,e)=>{for(const f of e)if(!f.evaluate(d))return!1;return!0}]]},any:{type:xi,overloads:[[[xi,xi],(d,[e,f])=>e.evaluate(d)||f.evaluate(d)],[Pn(xi),(d,e)=>{for(const f of e)if(f.evaluate(d))return!0;return!1}]]},"!":[xi,[xi],(d,[e])=>!e.evaluate(d)],"is-supported-script":[xi,[Mi],(d,[e])=>{const f=d.globals&&d.globals.isSupportedScript;return!f||f(e.evaluate(d))}],upcase:[Mi,[Mi],(d,[e])=>e.evaluate(d).toUpperCase()],downcase:[Mi,[Mi],(d,[e])=>e.evaluate(d).toLowerCase()],concat:[Mi,Pn(bi),(d,e)=>e.map(f=>xn(f.evaluate(d))).join("")],"resolved-locale":[Mi,[Yn],(d,[e])=>e.evaluate(d).resolvedLocale()]});class Os{constructor(e,f){this.expression=e,this._warningHistory={},this._evaluator=new Rl,this._defaultValue=f?function(m){return m.type==="color"&&Qn(m.default)?new Di(0,0,0,0):m.type==="color"?Di.parse(m.default)||null:m.default===void 0?null:m.default}(f):null,this._enumValues=f&&f.type==="enum"?f.values:null}evaluateWithoutErrorHandling(e,f,m,y,b,M,I,P){return this._evaluator.globals=e,this._evaluator.feature=f,this._evaluator.featureState=m,this._evaluator.canonical=y||null,this._evaluator.availableImages=b||null,this._evaluator.formattedSection=M,this._evaluator.featureTileCoord=I||null,this._evaluator.featureDistanceData=P||null,this.expression.evaluate(this._evaluator)}evaluate(e,f,m,y,b,M,I,P){this._evaluator.globals=e,this._evaluator.feature=f||null,this._evaluator.featureState=m||null,this._evaluator.canonical=y||null,this._evaluator.availableImages=b||null,this._evaluator.formattedSection=M||null,this._evaluator.featureTileCoord=I||null,this._evaluator.featureDistanceData=P||null;try{const L=this.expression.evaluate(this._evaluator);if(L==null||typeof L=="number"&&L!=L)return this._defaultValue;if(this._enumValues&&!(L in this._enumValues))throw new _r(`Expected value to be one of ${Object.keys(this._enumValues).map(N=>JSON.stringify(N)).join(", ")}, but found ${JSON.stringify(L)} instead.`);return L}catch(L){return this._warningHistory[L.message]||(this._warningHistory[L.message]=!0,typeof console!="undefined"&&console.warn(L.message)),this._defaultValue}}}function yo(d){return Array.isArray(d)&&d.length>0&&typeof d[0]=="string"&&d[0]in Kn}function Ho(d,e){const f=new kn(Kn,[],e?function(y){const b={color:fn,string:Mi,number:xt,enum:Mi,boolean:xi,formatted:co,resolvedImage:Mr};return y.type==="array"?Yr(b[y.value]||bi,y.length):b[y.type]}(e):void 0),m=f.parse(d,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return m?Pa(new Os(m,e)):Jn(f.errors)}class za{constructor(e,f){this.kind=e,this._styleExpression=f,this.isStateDependent=e!=="constant"&&!Uo(f.expression)}evaluateWithoutErrorHandling(e,f,m,y,b,M){return this._styleExpression.evaluateWithoutErrorHandling(e,f,m,y,b,M)}evaluate(e,f,m,y,b,M){return this._styleExpression.evaluate(e,f,m,y,b,M)}}class Fa{constructor(e,f,m,y){this.kind=e,this.zoomStops=m,this._styleExpression=f,this.isStateDependent=e!=="camera"&&!Uo(f.expression),this.interpolationType=y}evaluateWithoutErrorHandling(e,f,m,y,b,M){return this._styleExpression.evaluateWithoutErrorHandling(e,f,m,y,b,M)}evaluate(e,f,m,y,b,M){return this._styleExpression.evaluate(e,f,m,y,b,M)}interpolationFactor(e,f,m){return this.interpolationType?Nr.interpolationFactor(this.interpolationType,e,f,m):0}}function Jl(d,e){if((d=Ho(d,e)).result==="error")return d;const f=d.value.expression,m=Ir(f);if(!m&&!_o(e))return Jn([new ki("","data expressions not supported")]);const y=Vo(f,["zoom","pitch","distance-from-center"]);if(!y&&!Wl(e))return Jn([new ki("","zoom expressions not supported")]);const b=$s(f);return b||y?b instanceof ki?Jn([b]):b instanceof Nr&&!Ba(e)?Jn([new ki("",'"interpolate" expressions cannot be used with this property')]):Pa(b?new Fa(m?"camera":"composite",d.value,b.labels,b instanceof Nr?b.interpolation:void 0):new za(m?"constant":"source",d.value)):Jn([new ki("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Ns{constructor(e,f){this._parameters=e,this._specification=f,Ti(this,Ra(this._parameters,this._specification))}static deserialize(e){return new Ns(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function $s(d){let e=null;if(d instanceof Yo)e=$s(d.result);else if(d instanceof Xo){for(const f of d.args)if(e=$s(f),e)break}else(d instanceof Go||d instanceof Nr)&&d.input instanceof Or&&d.input.name==="zoom"&&(e=d);return e instanceof ki||d.eachChild(f=>{const m=$s(f);m instanceof ki?e=m:!e&&m?e=new ki("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&m&&e!==m&&(e=new ki("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}class bt{constructor(e,f,m,y){this.message=(e?`${e}: `:"")+m,y&&(this.identifier=y),f!=null&&f.__line__&&(this.line=f.__line__)}}function Wr(d){const e=d.key,f=d.value,m=d.valueSpec||{},y=d.objectElementValidators||{},b=d.style,M=d.styleSpec;let I=[];const P=Li(f);if(P!=="object")return[new bt(e,f,`object expected, ${P} found`)];for(const L in f){const N=L.split(".")[0],U=m[N]||m["*"];let j;y[N]?j=y[N]:m[N]?j=ur:y["*"]?j=y["*"]:m["*"]&&(j=ur),j?I=I.concat(j({key:(e&&`${e}.`)+L,value:f[L],valueSpec:U,style:b,styleSpec:M,object:f,objectKey:L},f)):I.push(new bt(e,f[L],`unknown property "${L}"`))}for(const L in m)y[L]||m[L].required&&m[L].default===void 0&&f[L]===void 0&&I.push(new bt(e,f,`missing required property "${L}"`));return I}function Ko(d){const e=d.value,f=d.valueSpec,m=d.style,y=d.styleSpec,b=d.key,M=d.arrayElementValidator||ur;if(Li(e)!=="array")return[new bt(b,e,`array expected, ${Li(e)} found`)];if(f.length&&e.length!==f.length)return[new bt(b,e,`array length ${f.length} expected, length ${e.length} found`)];if(f["min-length"]&&e.length<f["min-length"])return[new bt(b,e,`array length at least ${f["min-length"]} expected, length ${e.length} found`)];let I={type:f.value,values:f.values,minimum:f.minimum,maximum:f.maximum,function:void 0};y.$version<7&&(I.function=f.function),Li(f.value)==="object"&&(I=f.value);let P=[];for(let L=0;L<e.length;L++)P=P.concat(M({array:e,arrayIndex:L,value:e[L],valueSpec:I,style:m,styleSpec:y,key:`${b}[${L}]`}));return P}function Ql(d){const e=d.key,f=d.value,m=d.valueSpec;let y=Li(f);if(y==="number"&&f!=f&&(y="NaN"),y!=="number")return[new bt(e,f,`number expected, ${y} found`)];if("minimum"in m){let b=m.minimum;if(Li(m.minimum)==="array"&&(b=m.minimum[d.arrayIndex]),f<b)return[new bt(e,f,`${f} is less than the minimum value ${b}`)]}if("maximum"in m){let b=m.maximum;if(Li(m.maximum)==="array"&&(b=m.maximum[d.arrayIndex]),f>b)return[new bt(e,f,`${f} is greater than the maximum value ${b}`)]}return[]}function ec(d){const e=d.valueSpec,f=St(d.value.type);let m,y,b,M={};const I=f!=="categorical"&&d.value.property===void 0,P=!I,L=Li(d.value.stops)==="array"&&Li(d.value.stops[0])==="array"&&Li(d.value.stops[0][0])==="object",N=Wr({key:d.key,value:d.value,valueSpec:d.styleSpec.function,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{stops:function(H){if(f==="identity")return[new bt(H.key,H.value,'identity function may not have a "stops" property')];let ne=[];const ae=H.value;return ne=ne.concat(Ko({key:H.key,value:ae,valueSpec:H.valueSpec,style:H.style,styleSpec:H.styleSpec,arrayElementValidator:U})),Li(ae)==="array"&&ae.length===0&&ne.push(new bt(H.key,ae,"array must have at least one stop")),ne},default:function(H){return ur({key:H.key,value:H.value,valueSpec:e,style:H.style,styleSpec:H.styleSpec})}}});return f==="identity"&&I&&N.push(new bt(d.key,d.value,'missing required property "property"')),f==="identity"||d.value.stops||N.push(new bt(d.key,d.value,'missing required property "stops"')),f==="exponential"&&d.valueSpec.expression&&!Ba(d.valueSpec)&&N.push(new bt(d.key,d.value,"exponential functions not supported")),d.styleSpec.$version>=8&&(P&&!_o(d.valueSpec)?N.push(new bt(d.key,d.value,"property functions not supported")):I&&!Wl(d.valueSpec)&&N.push(new bt(d.key,d.value,"zoom functions not supported"))),f!=="categorical"&&!L||d.value.property!==void 0||N.push(new bt(d.key,d.value,'"property" property is required')),N;function U(H){let ne=[];const ae=H.value,pe=H.key;if(Li(ae)!=="array")return[new bt(pe,ae,`array expected, ${Li(ae)} found`)];if(ae.length!==2)return[new bt(pe,ae,`array length 2 expected, length ${ae.length} found`)];if(L){if(Li(ae[0])!=="object")return[new bt(pe,ae,`object expected, ${Li(ae[0])} found`)];if(ae[0].zoom===void 0)return[new bt(pe,ae,"object stop key must have zoom")];if(ae[0].value===void 0)return[new bt(pe,ae,"object stop key must have value")];const ve=St(ae[0].zoom);if(typeof ve!="number")return[new bt(pe,ae[0].zoom,"stop zoom values must be numbers")];if(b&&b>ve)return[new bt(pe,ae[0].zoom,"stop zoom values must appear in ascending order")];ve!==b&&(b=ve,y=void 0,M={}),ne=ne.concat(Wr({key:`${pe}[0]`,value:ae[0],valueSpec:{zoom:{}},style:H.style,styleSpec:H.styleSpec,objectElementValidators:{zoom:Ql,value:j}}))}else ne=ne.concat(j({key:`${pe}[0]`,value:ae[0],valueSpec:{},style:H.style,styleSpec:H.styleSpec},ae));return yo(Ai(ae[1]))?ne.concat([new bt(`${pe}[1]`,ae[1],"expressions are not allowed in function stops.")]):ne.concat(ur({key:`${pe}[1]`,value:ae[1],valueSpec:e,style:H.style,styleSpec:H.styleSpec}))}function j(H,ne){const ae=Li(H.value),pe=St(H.value),ve=H.value!==null?H.value:ne;if(m){if(ae!==m)return[new bt(H.key,ve,`${ae} stop domain type must match previous stop domain type ${m}`)]}else m=ae;if(ae!=="number"&&ae!=="string"&&ae!=="boolean"&&typeof pe!="number"&&typeof pe!="string"&&typeof pe!="boolean")return[new bt(H.key,ve,"stop domain value must be a number, string, or boolean")];if(ae!=="number"&&f!=="categorical"){let Ie=`number expected, ${ae} found`;return _o(e)&&f===void 0&&(Ie+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new bt(H.key,ve,Ie)]}return f!=="categorical"||ae!=="number"||typeof pe=="number"&&isFinite(pe)&&Math.floor(pe)===pe?f!=="categorical"&&ae==="number"&&typeof pe=="number"&&typeof y=="number"&&y!==void 0&&pe<y?[new bt(H.key,ve,"stop domain values must appear in ascending order")]:(y=pe,f==="categorical"&&pe in M?[new bt(H.key,ve,"stop domain values must be unique")]:(M[pe]=!0,[])):[new bt(H.key,ve,`integer expected, found ${String(pe)}`)]}}function xo(d){const e=(d.expressionContext==="property"?Jl:Ho)(Ai(d.value),d.valueSpec);if(e.result==="error")return e.value.map(m=>new bt(`${d.key}${m.key}`,d.value,m.message));const f=e.value.expression||e.value._styleExpression.expression;if(d.expressionContext==="property"&&d.propertyKey==="text-font"&&!f.outputDefined())return[new bt(d.key,d.value,`Invalid data expression for "${d.propertyKey}". Output values must be contained as literals within the expression.`)];if(d.expressionContext==="property"&&d.propertyType==="layout"&&!Uo(f))return[new bt(d.key,d.value,'"feature-state" data expressions are not supported with layout properties.')];if(d.expressionContext==="filter")return bn(f,d);if(d.expressionContext&&d.expressionContext.indexOf("cluster")===0){if(!Vo(f,["zoom","feature-state"]))return[new bt(d.key,d.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(d.expressionContext==="cluster-initial"&&!Ir(f))return[new bt(d.key,d.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function bn(d,e){const f=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(e.valueSpec&&e.valueSpec.expression)for(const y of e.valueSpec.expression.parameters)f.delete(y);if(f.size===0)return[];const m=[];return d instanceof Or&&f.has(d.name)?[new bt(e.key,e.value,`["${d.name}"] expression is not supported in a filter for a ${e.object.type} layer with id: ${e.object.id}`)]:(d.eachChild(y=>{m.push(...bn(y,e))}),m)}function Jo(d){const e=d.key,f=d.value,m=d.valueSpec,y=[];return Array.isArray(m.values)?m.values.indexOf(St(f))===-1&&y.push(new bt(e,f,`expected one of [${m.values.join(", ")}], ${JSON.stringify(f)} found`)):Object.keys(m.values).indexOf(St(f))===-1&&y.push(new bt(e,f,`expected one of [${Object.keys(m.values).join(", ")}], ${JSON.stringify(f)} found`)),y}function Bn(d){if(d===!0||d===!1)return!0;if(!Array.isArray(d)||d.length===0)return!1;switch(d[0]){case"has":return d.length>=2&&d[1]!=="$id"&&d[1]!=="$type";case"in":return d.length>=3&&(typeof d[1]!="string"||Array.isArray(d[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return d.length!==3||Array.isArray(d[1])||Array.isArray(d[2]);case"any":case"all":for(const e of d.slice(1))if(!Bn(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Rn(d,e="fill"){if(d==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Bn(d)||(d=Qo(d));const f=d;let m=!0;try{m=function(L){if(!Ln(L))return L;let N=Ai(L);return tc(N),N=Oa(N),N}(f)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(f,null,2)}
        `)}const y=$e[`filter_${e}`],b=Ho(m,y);let M=null;if(b.result==="error")throw new Error(b.value.map(L=>`${L.key}: ${L.message}`).join(", "));M=(L,N,U)=>b.value.evaluate(L,N,{},U);let I=null,P=null;if(m!==f){const L=Ho(f,y);if(L.result==="error")throw new Error(L.value.map(N=>`${N.key}: ${N.message}`).join(", "));I=(N,U,j,H,ne)=>L.value.evaluate(N,U,{},j,void 0,void 0,H,ne),P=!Ir(L.value.expression)}return M=M,{filter:M,dynamicFilter:I||void 0,needGeometry:Us(m),needFeature:!!P}}function Oa(d){if(!Array.isArray(d))return d;const e=function(f){if(ic.has(f[0])){for(let m=1;m<f.length;m++)if(Ln(f[m]))return!0}return f}(d);return e===!0?e:e.map(f=>Oa(f))}function tc(d){let e=!1;const f=[];if(d[0]==="case"){for(let m=1;m<d.length-1;m+=2)e=e||Ln(d[m]),f.push(d[m+1]);f.push(d[d.length-1])}else if(d[0]==="match"){e=e||Ln(d[1]);for(let m=2;m<d.length-1;m+=2)f.push(d[m+1]);f.push(d[d.length-1])}else if(d[0]==="step"){e=e||Ln(d[1]);for(let m=1;m<d.length-1;m+=2)f.push(d[m+1])}e&&(d.length=0,d.push("any",...f));for(let m=1;m<d.length;m++)tc(d[m])}function Ln(d){if(!Array.isArray(d))return!1;if((e=d[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let f=1;f<d.length;f++)if(Ln(d[f]))return!0;return!1}const ic=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Na(d,e){return d<e?-1:d>e?1:0}function Us(d){if(!Array.isArray(d))return!1;if(d[0]==="within")return!0;for(let e=1;e<d.length;e++)if(Us(d[e]))return!0;return!1}function Qo(d){if(!d)return!0;const e=d[0];return d.length<=1?e!=="any":e==="=="?es(d[1],d[2],"=="):e==="!="?ts(es(d[1],d[2],"==")):e==="<"||e===">"||e==="<="||e===">="?es(d[1],d[2],e):e==="any"?(f=d.slice(1),["any"].concat(f.map(Qo))):e==="all"?["all"].concat(d.slice(1).map(Qo)):e==="none"?["all"].concat(d.slice(1).map(Qo).map(ts)):e==="in"?$a(d[1],d.slice(2)):e==="!in"?ts($a(d[1],d.slice(2))):e==="has"?Ua(d[1]):e==="!has"?ts(Ua(d[1])):e!=="within"||d;var f}function es(d,e,f){switch(d){case"$type":return[`filter-type-${f}`,e];case"$id":return[`filter-id-${f}`,e];default:return[`filter-${f}`,d,e]}}function $a(d,e){if(e.length===0)return!1;switch(d){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(f=>typeof f!=typeof e[0])?["filter-in-large",d,["literal",e.sort(Na)]]:["filter-in-small",d,["literal",e]]}}function Ua(d){switch(d){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",d]}}function ts(d){return["!",d]}function zn(d){return Bn(Ai(d.value))?xo(Ti({},d,{expressionContext:"filter",valueSpec:d.styleSpec[`filter_${d.layerType||"fill"}`]})):Va(d)}function Va(d){const e=d.value,f=d.key;if(Li(e)!=="array")return[new bt(f,e,`array expected, ${Li(e)} found`)];const m=d.styleSpec;let y,b=[];if(e.length<1)return[new bt(f,e,"filter array must have at least 1 element")];switch(b=b.concat(Jo({key:`${f}[0]`,value:e[0],valueSpec:m.filter_operator,style:d.style,styleSpec:d.styleSpec})),St(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&St(e[1])==="$type"&&b.push(new bt(f,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&b.push(new bt(f,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(y=Li(e[1]),y!=="string"&&b.push(new bt(`${f}[1]`,e[1],`string expected, ${y} found`)));for(let M=2;M<e.length;M++)y=Li(e[M]),St(e[1])==="$type"?b=b.concat(Jo({key:`${f}[${M}]`,value:e[M],valueSpec:m.geometry_type,style:d.style,styleSpec:d.styleSpec})):y!=="string"&&y!=="number"&&y!=="boolean"&&b.push(new bt(`${f}[${M}]`,e[M],`string, number, or boolean expected, ${y} found`));break;case"any":case"all":case"none":for(let M=1;M<e.length;M++)b=b.concat(Va({key:`${f}[${M}]`,value:e[M],style:d.style,styleSpec:d.styleSpec}));break;case"has":case"!has":y=Li(e[1]),e.length!==2?b.push(new bt(f,e,`filter array for "${e[0]}" operator must have 2 elements`)):y!=="string"&&b.push(new bt(`${f}[1]`,e[1],`string expected, ${y} found`));break;case"within":y=Li(e[1]),e.length!==2?b.push(new bt(f,e,`filter array for "${e[0]}" operator must have 2 elements`)):y!=="object"&&b.push(new bt(`${f}[1]`,e[1],`object expected, ${y} found`))}return b}function ja(d,e){const f=d.key,m=d.style,y=d.styleSpec,b=d.value,M=d.objectKey,I=y[`${e}_${d.layerType}`];if(!I)return[];const P=M.match(/^(.*)-transition$/);if(e==="paint"&&P&&I[P[1]]&&I[P[1]].transition)return ur({key:f,value:b,valueSpec:y.transition,style:m,styleSpec:y});const L=d.valueSpec||I[M];if(!L)return[new bt(f,b,`unknown property "${M}"`)];let N;if(Li(b)==="string"&&_o(L)&&!L.tokens&&(N=/^{([^}]+)}$/.exec(b)))return[new bt(f,b,`"${M}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(N[1])} }\`.`)];const U=[];return d.layerType==="symbol"&&(M==="text-field"&&m&&!m.glyphs&&U.push(new bt(f,b,'use of "text-field" requires a style "glyphs" property')),M==="text-font"&&Qn(Ai(b))&&St(b.type)==="identity"&&U.push(new bt(f,b,'"text-font" does not support identity functions'))),U.concat(ur({key:d.key,value:b,valueSpec:L,style:m,styleSpec:y,expressionContext:"property",propertyType:e,propertyKey:M}))}function Vs(d){return ja(d,"paint")}function Ga(d){return ja(d,"layout")}function rc(d){let e=[];const f=d.value,m=d.key,y=d.style,b=d.styleSpec;f.type||f.ref||e.push(new bt(m,f,'either "type" or "ref" is required'));let M=St(f.type);const I=St(f.ref);if(f.id){const P=St(f.id);for(let L=0;L<d.arrayIndex;L++){const N=y.layers[L];St(N.id)===P&&e.push(new bt(m,f.id,`duplicate layer id "${f.id}", previously used at line ${N.id.__line__}`))}}if("ref"in f){let P;["type","source","source-layer","filter","layout"].forEach(L=>{L in f&&e.push(new bt(m,f[L],`"${L}" is prohibited for ref layers`))}),y.layers.forEach(L=>{St(L.id)===I&&(P=L)}),P?P.ref?e.push(new bt(m,f.ref,"ref cannot reference another ref layer")):M=St(P.type):typeof I=="string"&&e.push(new bt(m,f.ref,`ref layer "${I}" not found`))}else if(M!=="background"&&M!=="sky")if(f.source){const P=y.sources&&y.sources[f.source],L=P&&St(P.type);P?L==="vector"&&M==="raster"?e.push(new bt(m,f.source,`layer "${f.id}" requires a raster source`)):L==="raster"&&M!=="raster"?e.push(new bt(m,f.source,`layer "${f.id}" requires a vector source`)):L!=="vector"||f["source-layer"]?L==="raster-dem"&&M!=="hillshade"?e.push(new bt(m,f.source,"raster-dem source can only be used with layer type 'hillshade'.")):M!=="line"||!f.paint||!f.paint["line-gradient"]||L==="geojson"&&P.lineMetrics||e.push(new bt(m,f,`layer "${f.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new bt(m,f,`layer "${f.id}" must specify a "source-layer"`)):e.push(new bt(m,f.source,`source "${f.source}" not found`))}else e.push(new bt(m,f,'missing required property "source"'));return e=e.concat(Wr({key:m,value:f,valueSpec:b.layer,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ur({key:`${m}.type`,value:f.type,valueSpec:b.layer.type,style:d.style,styleSpec:d.styleSpec,object:f,objectKey:"type"}),filter:P=>zn(Ti({layerType:M},P)),layout:P=>Wr({layer:f,key:P.key,value:P.value,valueSpec:{},style:P.style,styleSpec:P.styleSpec,objectElementValidators:{"*":L=>Ga(Ti({layerType:M},L))}}),paint:P=>Wr({layer:f,key:P.key,value:P.value,valueSpec:{},style:P.style,styleSpec:P.styleSpec,objectElementValidators:{"*":L=>Vs(Ti({layerType:M},L))}})}})),e}function wn(d){const e=d.value,f=d.key,m=Li(e);return m!=="string"?[new bt(f,e,`string expected, ${m} found`)]:[]}const nc={promoteId:function({key:d,value:e}){if(Li(e)==="string")return wn({key:d,value:e});{const f=[];for(const m in e)f.push(...wn({key:`${d}.${m}`,value:e[m]}));return f}}};function oc(d){const e=d.value,f=d.key,m=d.styleSpec,y=d.style;if(!e.type)return[new bt(f,e,'"type" is required')];const b=St(e.type);let M;switch(b){case"vector":case"raster":case"raster-dem":return M=Wr({key:f,value:e,valueSpec:m[`source_${b.replace("-","_")}`],style:d.style,styleSpec:m,objectElementValidators:nc}),M;case"geojson":if(M=Wr({key:f,value:e,valueSpec:m.source_geojson,style:y,styleSpec:m,objectElementValidators:nc}),e.cluster)for(const I in e.clusterProperties){const[P,L]=e.clusterProperties[I],N=typeof P=="string"?[P,["accumulated"],["get",I]]:P;M.push(...xo({key:`${f}.${I}.map`,value:L,expressionContext:"cluster-map"})),M.push(...xo({key:`${f}.${I}.reduce`,value:N,expressionContext:"cluster-reduce"}))}return M;case"video":return Wr({key:f,value:e,valueSpec:m.source_video,style:y,styleSpec:m});case"image":return Wr({key:f,value:e,valueSpec:m.source_image,style:y,styleSpec:m});case"canvas":return[new bt(f,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Jo({key:`${f}.type`,value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:y,styleSpec:m})}}function sc(d){const e=d.value,f=d.styleSpec,m=f.light,y=d.style;let b=[];const M=Li(e);if(e===void 0)return b;if(M!=="object")return b=b.concat([new bt("light",e,`object expected, ${M} found`)]),b;for(const I in e){const P=I.match(/^(.*)-transition$/);b=b.concat(P&&m[P[1]]&&m[P[1]].transition?ur({key:I,value:e[I],valueSpec:f.transition,style:y,styleSpec:f}):m[I]?ur({key:I,value:e[I],valueSpec:m[I],style:y,styleSpec:f}):[new bt(I,e[I],`unknown property "${I}"`)])}return b}function ac(d){const e=d.value,f=d.key,m=d.style,y=d.styleSpec,b=y.terrain;let M=[];const I=Li(e);if(e===void 0)return M;if(I!=="object")return M=M.concat([new bt("terrain",e,`object expected, ${I} found`)]),M;for(const P in e){const L=P.match(/^(.*)-transition$/);M=M.concat(L&&b[L[1]]&&b[L[1]].transition?ur({key:P,value:e[P],valueSpec:y.transition,style:m,styleSpec:y}):b[P]?ur({key:P,value:e[P],valueSpec:b[P],style:m,styleSpec:y}):[new bt(P,e[P],`unknown property "${P}"`)])}if(e.source){const P=m.sources&&m.sources[e.source],L=P&&St(P.type);P?L!=="raster-dem"&&M.push(new bt(f,e.source,`terrain cannot be used with a source of type ${String(L)}, it only be used with a "raster-dem" source type`)):M.push(new bt(f,e.source,`source "${e.source}" not found`))}else M.push(new bt(f,e,'terrain is missing required property "source"'));return M}function lc(d){const e=d.value,f=d.style,m=d.styleSpec,y=m.fog;let b=[];const M=Li(e);if(e===void 0)return b;if(M!=="object")return b=b.concat([new bt("fog",e,`object expected, ${M} found`)]),b;for(const I in e){const P=I.match(/^(.*)-transition$/);b=b.concat(P&&y[P[1]]&&y[P[1]].transition?ur({key:I,value:e[I],valueSpec:m.transition,style:f,styleSpec:m}):y[I]?ur({key:I,value:e[I],valueSpec:y[I],style:f,styleSpec:m}):[new bt(I,e[I],`unknown property "${I}"`)])}return b}const is={"*":()=>[],array:Ko,boolean:function(d){const e=d.value,f=d.key,m=Li(e);return m!=="boolean"?[new bt(f,e,`boolean expected, ${m} found`)]:[]},number:Ql,color:function(d){const e=d.key,f=d.value,m=Li(f);return m!=="string"?[new bt(e,f,`color expected, ${m} found`)]:_a.parseCSSColor(f)===null?[new bt(e,f,`color expected, "${f}" found`)]:[]},enum:Jo,filter:zn,function:ec,layer:rc,object:Wr,source:oc,light:sc,terrain:ac,fog:lc,string:wn,formatted:function(d){return wn(d).length===0?[]:xo(d)},resolvedImage:function(d){return wn(d).length===0?[]:xo(d)},projection:function(d){const e=d.value,f=d.styleSpec,m=f.projection,y=d.style;let b=[];const M=Li(e);if(M==="object")for(const I in e)b=b.concat(ur({key:I,value:e[I],valueSpec:m[I],style:y,styleSpec:f}));else M!=="string"&&(b=b.concat([new bt("projection",e,`object or string expected, ${M} found`)]));return b}};function ur(d){const e=d.value,f=d.valueSpec,m=d.styleSpec;return f.expression&&Qn(St(e))?ec(d):f.expression&&yo(Ai(e))?xo(d):f.type&&is[f.type]?is[f.type](d):Wr(Ti({},d,{valueSpec:f.type?m[f.type]:f}))}function $r(d){const e=d.value,f=d.key,m=wn(d);return m.length||(e.indexOf("{fontstack}")===-1&&m.push(new bt(f,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&m.push(new bt(f,e,'"glyphs" url must include a "{range}" token'))),m}function rs(d,e=$e){return En(ur({key:"",value:d,valueSpec:e.$root,styleSpec:e,style:d,objectElementValidators:{glyphs:$r,"*":()=>[]}}))}const yh=d=>En(Vs(d)),xh=d=>En(Ga(d));function En(d){return d.slice().sort((e,f)=>e.line&&f.line?e.line-f.line:0)}function cc(d,e){let f=!1;if(e&&e.length)for(const m of e)d.fire(new Lt(new Error(m.message))),f=!0;return f}var Fn=pn;function pn(d,e,f){var m=this.cells=[];if(d instanceof ArrayBuffer){this.arrayBuffer=d;var y=new Int32Array(this.arrayBuffer);d=y[0],this.d=(e=y[1])+2*(f=y[2]);for(var b=0;b<this.d*this.d;b++){var M=y[3+b],I=y[3+b+1];m.push(M===I?null:y.subarray(M,I))}var P=y[3+m.length+1];this.keys=y.subarray(y[3+m.length],P),this.bboxes=y.subarray(P),this.insert=this._insertReadonly}else{this.d=e+2*f;for(var L=0;L<this.d*this.d;L++)m.push([]);this.keys=[],this.bboxes=[]}this.n=e,this.extent=d,this.padding=f,this.scale=e/d,this.uid=0;var N=f/e*d;this.min=-N,this.max=d+N}pn.prototype.insert=function(d,e,f,m,y){this._forEachCell(e,f,m,y,this._insertCell,this.uid++),this.keys.push(d),this.bboxes.push(e),this.bboxes.push(f),this.bboxes.push(m),this.bboxes.push(y)},pn.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},pn.prototype._insertCell=function(d,e,f,m,y,b){this.cells[y].push(b)},pn.prototype.query=function(d,e,f,m,y){var b=this.min,M=this.max;if(d<=b&&e<=b&&M<=f&&M<=m&&!y)return Array.prototype.slice.call(this.keys);var I=[];return this._forEachCell(d,e,f,m,this._queryCell,I,{},y),I},pn.prototype._queryCell=function(d,e,f,m,y,b,M,I){var P=this.cells[y];if(P!==null)for(var L=this.keys,N=this.bboxes,U=0;U<P.length;U++){var j=P[U];if(M[j]===void 0){var H=4*j;(I?I(N[H+0],N[H+1],N[H+2],N[H+3]):d<=N[H+2]&&e<=N[H+3]&&f>=N[H+0]&&m>=N[H+1])?(M[j]=!0,b.push(L[j])):M[j]=!1}}},pn.prototype._forEachCell=function(d,e,f,m,y,b,M,I){for(var P=this._convertToCellCoord(d),L=this._convertToCellCoord(e),N=this._convertToCellCoord(f),U=this._convertToCellCoord(m),j=P;j<=N;j++)for(var H=L;H<=U;H++){var ne=this.d*H+j;if((!I||I(this._convertFromCellCoord(j),this._convertFromCellCoord(H),this._convertFromCellCoord(j+1),this._convertFromCellCoord(H+1)))&&y.call(this,d,e,f,m,ne,b,M,I))return}},pn.prototype._convertFromCellCoord=function(d){return(d-this.padding)/this.scale},pn.prototype._convertToCellCoord=function(d){return Math.max(0,Math.min(this.d-1,Math.floor(d*this.scale)+this.padding))},pn.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var d=this.cells,e=3+this.cells.length+1+1,f=0,m=0;m<this.cells.length;m++)f+=this.cells[m].length;var y=new Int32Array(e+f+this.keys.length+this.bboxes.length);y[0]=this.extent,y[1]=this.n,y[2]=this.padding;for(var b=e,M=0;M<d.length;M++){var I=d[M];y[3+M]=b,y.set(I,b),b+=I.length}return y[3+d.length]=b,y.set(this.keys,b),y[3+d.length+1]=b+=this.keys.length,y.set(this.bboxes,b),b+=this.bboxes.length,y.buffer};const vo={};function Mt(d,e,f={}){Object.defineProperty(d,"_classRegistryKey",{value:e,writeable:!1}),vo[e]={klass:d,omit:f.omit||[]}}Mt(Object,"Object"),Fn.serialize=function(d,e){const f=d.toArrayBuffer();return e&&e.push(f),{buffer:f}},Fn.deserialize=function(d){return new Fn(d.buffer)},Object.defineProperty(Fn,"name",{value:"Grid"}),Mt(Fn,"Grid"),Mt(Di,"Color"),Mt(Error,"Error"),Mt(G,"AJAXError"),Mt(Fr,"ResolvedImage"),Mt(Ns,"StylePropertyFunction"),Mt(Os,"StyleExpression",{omit:["_evaluator"]}),Mt(Fa,"ZoomDependentExpression"),Mt(za,"ZoomConstantExpression"),Mt(Or,"CompoundExpression",{omit:["_evaluate"]});for(const d in Kn)vo[Kn[d]._classRegistryKey]||Mt(Kn[d],`Expression${d}`);function hc(d){return d&&typeof ArrayBuffer!="undefined"&&(d instanceof ArrayBuffer||d.constructor&&d.constructor.name==="ArrayBuffer")}function js(d){return O.ImageBitmap&&d instanceof O.ImageBitmap}function ns(d,e){if(d==null||typeof d=="boolean"||typeof d=="number"||typeof d=="string"||d instanceof Boolean||d instanceof Number||d instanceof String||d instanceof Date||d instanceof RegExp)return d;if(hc(d)||js(d))return e&&e.push(d),d;if(ArrayBuffer.isView(d)){const f=d;return e&&e.push(f.buffer),f}if(d instanceof O.ImageData)return e&&e.push(d.data.buffer),d;if(Array.isArray(d)){const f=[];for(const m of d)f.push(ns(m,e));return f}if(typeof d=="object"){const f=d.constructor,m=f._classRegistryKey;if(!m)throw new Error(`can't serialize object of unregistered class ${m}`);const y=f.serialize?f.serialize(d,e):{};if(!f.serialize){for(const b in d)d.hasOwnProperty(b)&&(vo[m].omit.indexOf(b)>=0||(y[b]=ns(d[b],e)));d instanceof Error&&(y.message=d.message)}if(y.$name)throw new Error("$name property is reserved for worker serialization logic.");return m!=="Object"&&(y.$name=m),y}throw new Error("can't serialize object of type "+typeof d)}function bo(d){if(d==null||typeof d=="boolean"||typeof d=="number"||typeof d=="string"||d instanceof Boolean||d instanceof Number||d instanceof String||d instanceof Date||d instanceof RegExp||hc(d)||js(d)||ArrayBuffer.isView(d)||d instanceof O.ImageData)return d;if(Array.isArray(d))return d.map(bo);if(typeof d=="object"){const e=d.$name||"Object",{klass:f}=vo[e];if(!f)throw new Error(`can't deserialize unregistered class ${e}`);if(f.deserialize)return f.deserialize(d);const m=Object.create(f.prototype);for(const y of Object.keys(d))y!=="$name"&&(m[y]=bo(d[y]));return m}throw new Error("can't deserialize object of type "+typeof d)}class qa{constructor(){this.first=!0}update(e,f){const m=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=m,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=m,!0):(this.lastFloorZoom>m?(this.lastIntegerZoom=m+1,this.lastIntegerZoomTime=f):this.lastFloorZoom<m&&(this.lastIntegerZoom=m,this.lastIntegerZoomTime=f),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=m,!0))}}const uc=d=>d>=1536&&d<=1791,Gs=d=>d>=1872&&d<=1919,os=d=>d>=2208&&d<=2303,Za=d=>d>=11904&&d<=12031,dc=d=>d>=12032&&d<=12255,Xa=d=>d>=12272&&d<=12287,qs=d=>d>=12288&&d<=12351,ss=d=>d>=12352&&d<=12447,Zs=d=>d>=12448&&d<=12543,fc=d=>d>=12544&&d<=12591,pc=d=>d>=12704&&d<=12735,mc=d=>d>=12736&&d<=12783,Ya=d=>d>=12784&&d<=12799,gc=d=>d>=12800&&d<=13055,_c=d=>d>=13056&&d<=13311,yc=d=>d>=13312&&d<=19903,Wa=d=>d>=19968&&d<=40959,xc=d=>d>=40960&&d<=42127,vc=d=>d>=42128&&d<=42191,bc=d=>d>=44032&&d<=55215,as=d=>d>=63744&&d<=64255,Ha=d=>d>=64336&&d<=65023,wc=d=>d>=65040&&d<=65055,wo=d=>d>=65072&&d<=65103,Ec=d=>d>=65104&&d<=65135,Xs=d=>d>=65136&&d<=65279,Ka=d=>d>=65280&&d<=65519;function Ys(d){for(const e of d)if(Ws(e.charCodeAt(0)))return!0;return!1}function Tc(d){for(const e of d)if(!Mc(e.charCodeAt(0)))return!1;return!0}function Mc(d){return!(uc(d)||Gs(d)||os(d)||Ha(d)||Xs(d))}function Ws(d){return!(d!==746&&d!==747&&(d<4352||!(pc(d)||fc(d)||wo(d)&&!(d>=65097&&d<=65103)||as(d)||_c(d)||Za(d)||mc(d)||!(!qs(d)||d>=12296&&d<=12305||d>=12308&&d<=12319||d===12336)||yc(d)||Wa(d)||gc(d)||(e=>e>=12592&&e<=12687)(d)||(e=>e>=43360&&e<=43391)(d)||(e=>e>=55216&&e<=55295)(d)||(e=>e>=4352&&e<=4607)(d)||bc(d)||ss(d)||Xa(d)||(e=>e>=12688&&e<=12703)(d)||dc(d)||Ya(d)||Zs(d)&&d!==12540||!(!Ka(d)||d===65288||d===65289||d===65293||d>=65306&&d<=65310||d===65339||d===65341||d===65343||d>=65371&&d<=65503||d===65507||d>=65512&&d<=65519)||!(!Ec(d)||d>=65112&&d<=65118||d>=65123&&d<=65126)||(e=>e>=5120&&e<=5759)(d)||(e=>e>=6320&&e<=6399)(d)||wc(d)||(e=>e>=19904&&e<=19967)(d)||xc(d)||vc(d))))}function Hs(d){return!(Ws(d)||function(e){return!!((f=>f>=128&&f<=255)(e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||(f=>f>=8192&&f<=8303)(e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||(f=>f>=8448&&f<=8527)(e)||(f=>f>=8528&&f<=8591)(e)||(f=>f>=8960&&f<=9215)(e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||(f=>f>=9216&&f<=9279)(e)&&e!==9251||(f=>f>=9280&&f<=9311)(e)||(f=>f>=9312&&f<=9471)(e)||(f=>f>=9632&&f<=9727)(e)||(f=>f>=9728&&f<=9983)(e)&&!(e>=9754&&e<=9759)||(f=>f>=11008&&f<=11263)(e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||qs(e)||Zs(e)||(f=>f>=57344&&f<=63743)(e)||wo(e)||Ec(e)||Ka(e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(d))}function Ks(d){return d>=1424&&d<=2303||Ha(d)||Xs(d)}function vh(d,e){return!(!e&&Ks(d)||d>=2304&&d<=3583||d>=3840&&d<=4255||(f=>f>=6016&&f<=6143)(d))}function bh(d){for(const e of d)if(Ks(e.charCodeAt(0)))return!0;return!1}const Ja="deferred",ls="loading",Qa="loaded";let el=null,Cr="unavailable",Ur=null;const cs=function(d){d&&typeof d=="string"&&d.indexOf("NetworkError")>-1&&(Cr="error"),el&&el(d)};function eo(){tl.fire(new wt("pluginStateChange",{pluginStatus:Cr,pluginURL:Ur}))}const tl=new Wt,Js=function(){return Cr},Eo=function(){if(Cr!==Ja||!Ur)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Cr=ls,eo(),Ur&&me({url:Ur},d=>{d?cs(d):(Cr=Qa,eo())})},Hr={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Cr===Qa||Hr.applyArabicShaping!=null,isLoading:()=>Cr===ls,setState(d){Cr=d.pluginStatus,Ur=d.pluginURL},isParsed:()=>Hr.applyArabicShaping!=null&&Hr.processBidirectionalText!=null&&Hr.processStyledBidirectionalText!=null,getPluginURL:()=>Ur};class ji{constructor(e,f){this.zoom=e,f?(this.now=f.now,this.fadeDuration=f.fadeDuration,this.zoomHistory=f.zoomHistory,this.transition=f.transition,this.pitch=f.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new qa,this.transition={},this.pitch=0)}isSupportedScript(e){return function(f,m){for(const y of f)if(!vh(y.charCodeAt(0),m))return!1;return!0}(e,Hr.isLoaded())}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,f=e-Math.floor(e),m=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:f+(1-f)*m}:{fromScale:.5,toScale:1,t:1-(1-m)*f}}}class hs{constructor(e,f){this.property=e,this.value=f,this.expression=function(m,y){if(Qn(m))return new Ns(m,y);if(yo(m)){const b=Jl(m,y);if(b.result==="error")throw new Error(b.value.map(M=>`${M.key}: ${M.message}`).join(", "));return b.value}{let b=m;return typeof m=="string"&&y.type==="color"&&(b=Di.parse(m)),{kind:"constant",evaluate:()=>b}}}(f===void 0?e.specification.default:f,e.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,f,m){return this.property.possiblyEvaluate(this,e,f,m)}}class To{constructor(e){this.property=e,this.value=new hs(e,void 0)}transitioned(e,f){return new h(this.property,this.value,f,ue({},e.transition,this.transition),e.now)}untransitioned(){return new h(this.property,this.value,null,{},0)}}class x{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues)}getValue(e){return Yt(this._values[e].value.value)}setValue(e,f){this._values.hasOwnProperty(e)||(this._values[e]=new To(this._values[e].property)),this._values[e].value=new hs(this._values[e].property,f===null?void 0:Yt(f))}getTransition(e){return Yt(this._values[e].transition)}setTransition(e,f){this._values.hasOwnProperty(e)||(this._values[e]=new To(this._values[e].property)),this._values[e].transition=Yt(f)||void 0}serialize(){const e={};for(const f of Object.keys(this._values)){const m=this.getValue(f);m!==void 0&&(e[f]=m);const y=this.getTransition(f);y!==void 0&&(e[`${f}-transition`]=y)}return e}transitioned(e,f){const m=new _(this._properties);for(const y of Object.keys(this._values))m._values[y]=this._values[y].transitioned(e,f._values[y]);return m}untransitioned(){const e=new _(this._properties);for(const f of Object.keys(this._values))e._values[f]=this._values[f].untransitioned();return e}}class h{constructor(e,f,m,y,b){const M=y.delay||0,I=y.duration||0;b=b||0,this.property=e,this.value=f,this.begin=b+M,this.end=this.begin+I,e.specification.transition&&(y.delay||y.duration)&&(this.prior=m)}possiblyEvaluate(e,f,m){const y=e.now||0,b=this.value.possiblyEvaluate(e,f,m),M=this.prior;if(M){if(y>this.end)return this.prior=null,b;if(this.value.isDataDriven())return this.prior=null,b;if(y<this.begin)return M.possiblyEvaluate(e,f,m);{const I=(y-this.begin)/(this.end-this.begin);return this.property.interpolate(M.possiblyEvaluate(e,f,m),b,ee(I))}}return b}}class _{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,f,m){const y=new k(this._properties);for(const b of Object.keys(this._values))y._values[b]=this._values[b].possiblyEvaluate(e,f,m);return y}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class T{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues)}getValue(e){return Yt(this._values[e].value)}setValue(e,f){this._values[e]=new hs(this._values[e].property,f===null?void 0:Yt(f))}serialize(){const e={};for(const f of Object.keys(this._values)){const m=this.getValue(f);m!==void 0&&(e[f]=m)}return e}possiblyEvaluate(e,f,m){const y=new k(this._properties);for(const b of Object.keys(this._values))y._values[b]=this._values[b].possiblyEvaluate(e,f,m);return y}}class C{constructor(e,f,m){this.property=e,this.value=f,this.parameters=m}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,f,m,y){return this.property.evaluate(this.value,this.parameters,e,f,m,y)}}class k{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class B{constructor(e){this.specification=e}possiblyEvaluate(e,f){return e.expression.evaluate(f)}interpolate(e,f,m){const y=Is[this.specification.type];return y?y(e,f,m):e}}class F{constructor(e,f){this.specification=e,this.overrides=f}possiblyEvaluate(e,f,m,y){return new C(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(f,null,{},m,y)}:e.expression,f)}interpolate(e,f,m){if(e.value.kind!=="constant"||f.value.kind!=="constant")return e;if(e.value.value===void 0||f.value.value===void 0)return new C(this,{kind:"constant",value:void 0},e.parameters);const y=Is[this.specification.type];return y?new C(this,{kind:"constant",value:y(e.value.value,f.value.value,m)},e.parameters):e}evaluate(e,f,m,y,b,M){return e.kind==="constant"?e.value:e.evaluate(f,m,y,b,M)}}class V extends F{possiblyEvaluate(e,f,m,y){if(e.value===void 0)return new C(this,{kind:"constant",value:void 0},f);if(e.expression.kind==="constant"){const b=e.expression.evaluate(f,null,{},m,y),M=e.property.specification.type==="resolvedImage"&&typeof b!="string"?b.name:b,I=this._calculate(M,M,M,f);return new C(this,{kind:"constant",value:I},f)}if(e.expression.kind==="camera"){const b=this._calculate(e.expression.evaluate({zoom:f.zoom-1}),e.expression.evaluate({zoom:f.zoom}),e.expression.evaluate({zoom:f.zoom+1}),f);return new C(this,{kind:"constant",value:b},f)}return new C(this,e.expression,f)}evaluate(e,f,m,y,b,M){if(e.kind==="source"){const I=e.evaluate(f,m,y,b,M);return this._calculate(I,I,I,f)}return e.kind==="composite"?this._calculate(e.evaluate({zoom:Math.floor(f.zoom)-1},m,y),e.evaluate({zoom:Math.floor(f.zoom)},m,y),e.evaluate({zoom:Math.floor(f.zoom)+1},m,y),f):e.value}_calculate(e,f,m,y){return y.zoom>y.zoomHistory.lastIntegerZoom?{from:e,to:f,other:m}:{from:m,to:f,other:e}}interpolate(e){return e}}class Z{constructor(e){this.specification=e}possiblyEvaluate(e,f,m,y){if(e.value!==void 0){if(e.expression.kind==="constant"){const b=e.expression.evaluate(f,null,{},m,y);return this._calculate(b,b,b,f)}return this._calculate(e.expression.evaluate(new ji(Math.floor(f.zoom-1),f)),e.expression.evaluate(new ji(Math.floor(f.zoom),f)),e.expression.evaluate(new ji(Math.floor(f.zoom+1),f)),f)}}_calculate(e,f,m,y){return y.zoom>y.zoomHistory.lastIntegerZoom?{from:e,to:f}:{from:m,to:f}}interpolate(e){return e}}class X{constructor(e){this.specification=e}possiblyEvaluate(e,f,m,y){return!!e.expression.evaluate(f,null,{},m,y)}interpolate(){return!1}}class te{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const f in e){const m=e[f];m.specification.overridable&&this.overridableProperties.push(f);const y=this.defaultPropertyValues[f]=new hs(m,void 0),b=this.defaultTransitionablePropertyValues[f]=new To(m);this.defaultTransitioningPropertyValues[f]=b.untransitioned(),this.defaultPossiblyEvaluatedValues[f]=y.possiblyEvaluate({})}}}function le(d,e){return 256*(d=_e(Math.floor(d),0,255))+_e(Math.floor(e),0,255)}Mt(F,"DataDrivenProperty"),Mt(B,"DataConstantProperty"),Mt(V,"CrossFadedDataDrivenProperty"),Mt(Z,"CrossFadedProperty"),Mt(X,"ColorRampProperty");const ge={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class de{constructor(e,f){this._structArray=e,this._pos1=f*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class se{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,f){return e._trim(),f&&(e.isTransferred=!0,f.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const f=Object.create(this.prototype);return f.arrayBuffer=e.arrayBuffer,f.length=e.length,f.capacity=e.arrayBuffer.byteLength/f.bytesPerElement,f._refreshViews(),f}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const f=this.uint8;this._refreshViews(),f&&this.uint8.set(f)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Se(d,e=1){let f=0,m=0;return{members:d.map(y=>{const b=ge[y.type].BYTES_PER_ELEMENT,M=f=xe(f,Math.max(e,b)),I=y.components||1;return m=Math.max(m,b),f+=b*I,{name:y.name,type:y.type,components:I,offset:M}}),size:xe(f,Math.max(m,e)),alignment:e}}function xe(d,e){return Math.ceil(d/e)*e}class Te extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,f){const m=this.length;return this.resize(m+1),this.emplace(m,e,f)}emplace(e,f,m){const y=2*e;return this.int16[y+0]=f,this.int16[y+1]=m,e}}Te.prototype.bytesPerElement=4,Mt(Te,"StructArrayLayout2i4");class Me extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,e,f,m)}emplace(e,f,m,y){const b=3*e;return this.int16[b+0]=f,this.int16[b+1]=m,this.int16[b+2]=y,e}}Me.prototype.bytesPerElement=6,Mt(Me,"StructArrayLayout3i6");class Ae extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,f,m,y){const b=this.length;return this.resize(b+1),this.emplace(b,e,f,m,y)}emplace(e,f,m,y,b){const M=4*e;return this.int16[M+0]=f,this.int16[M+1]=m,this.int16[M+2]=y,this.int16[M+3]=b,e}}Ae.prototype.bytesPerElement=8,Mt(Ae,"StructArrayLayout4i8");class Ee extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I){const P=this.length;return this.resize(P+1),this.emplace(P,e,f,m,y,b,M,I)}emplace(e,f,m,y,b,M,I,P){const L=6*e,N=12*e,U=3*e;return this.int16[L+0]=f,this.int16[L+1]=m,this.uint8[N+4]=y,this.uint8[N+5]=b,this.uint8[N+6]=M,this.uint8[N+7]=I,this.float32[U+2]=P,e}}Ee.prototype.bytesPerElement=12,Mt(Ee,"StructArrayLayout2i4ub1f12");class De extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,f,m,y){const b=this.length;return this.resize(b+1),this.emplace(b,e,f,m,y)}emplace(e,f,m,y,b){const M=4*e;return this.float32[M+0]=f,this.float32[M+1]=m,this.float32[M+2]=y,this.float32[M+3]=b,e}}De.prototype.bytesPerElement=16,Mt(De,"StructArrayLayout4f16");class Ue extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I,P,L,N){const U=this.length;return this.resize(U+1),this.emplace(U,e,f,m,y,b,M,I,P,L,N)}emplace(e,f,m,y,b,M,I,P,L,N,U){const j=10*e;return this.uint16[j+0]=f,this.uint16[j+1]=m,this.uint16[j+2]=y,this.uint16[j+3]=b,this.uint16[j+4]=M,this.uint16[j+5]=I,this.uint16[j+6]=P,this.uint16[j+7]=L,this.uint16[j+8]=N,this.uint16[j+9]=U,e}}Ue.prototype.bytesPerElement=20,Mt(Ue,"StructArrayLayout10ui20");class Ze extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I,P){const L=this.length;return this.resize(L+1),this.emplace(L,e,f,m,y,b,M,I,P)}emplace(e,f,m,y,b,M,I,P,L){const N=8*e;return this.uint16[N+0]=f,this.uint16[N+1]=m,this.uint16[N+2]=y,this.uint16[N+3]=b,this.uint16[N+4]=M,this.uint16[N+5]=I,this.uint16[N+6]=P,this.uint16[N+7]=L,e}}Ze.prototype.bytesPerElement=16,Mt(Ze,"StructArrayLayout8ui16");class He extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M){const I=this.length;return this.resize(I+1),this.emplace(I,e,f,m,y,b,M)}emplace(e,f,m,y,b,M,I){const P=6*e;return this.int16[P+0]=f,this.int16[P+1]=m,this.int16[P+2]=y,this.int16[P+3]=b,this.int16[P+4]=M,this.int16[P+5]=I,e}}He.prototype.bytesPerElement=12,Mt(He,"StructArrayLayout6i12");class Ye extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe){const ve=this.length;return this.resize(ve+1),this.emplace(ve,e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe)}emplace(e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe,ve){const Ie=16*e;return this.int16[Ie+0]=f,this.int16[Ie+1]=m,this.int16[Ie+2]=y,this.int16[Ie+3]=b,this.uint16[Ie+4]=M,this.uint16[Ie+5]=I,this.uint16[Ie+6]=P,this.uint16[Ie+7]=L,this.int16[Ie+8]=N,this.int16[Ie+9]=U,this.int16[Ie+10]=j,this.int16[Ie+11]=H,this.int16[Ie+12]=ne,this.int16[Ie+13]=ae,this.int16[Ie+14]=pe,this.int16[Ie+15]=ve,e}}Ye.prototype.bytesPerElement=32,Mt(Ye,"StructArrayLayout4i4ui4i4i32");class ct extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,e,f,m)}emplace(e,f,m,y){const b=3*e;return this.float32[b+0]=f,this.float32[b+1]=m,this.float32[b+2]=y,e}}ct.prototype.bytesPerElement=12,Mt(ct,"StructArrayLayout3f12");class Ve extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const f=this.length;return this.resize(f+1),this.emplace(f,e)}emplace(e,f){return this.uint32[1*e+0]=f,e}}Ve.prototype.bytesPerElement=4,Mt(Ve,"StructArrayLayout1ul4");class ht extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I,P,L,N,U,j,H){const ne=this.length;return this.resize(ne+1),this.emplace(ne,e,f,m,y,b,M,I,P,L,N,U,j,H)}emplace(e,f,m,y,b,M,I,P,L,N,U,j,H,ne){const ae=20*e,pe=10*e;return this.int16[ae+0]=f,this.int16[ae+1]=m,this.int16[ae+2]=y,this.int16[ae+3]=b,this.int16[ae+4]=M,this.float32[pe+3]=I,this.float32[pe+4]=P,this.float32[pe+5]=L,this.float32[pe+6]=N,this.int16[ae+14]=U,this.uint32[pe+8]=j,this.uint16[ae+18]=H,this.uint16[ae+19]=ne,e}}ht.prototype.bytesPerElement=40,Mt(ht,"StructArrayLayout5i4f1i1ul2ui40");class at extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I){const P=this.length;return this.resize(P+1),this.emplace(P,e,f,m,y,b,M,I)}emplace(e,f,m,y,b,M,I,P){const L=8*e;return this.int16[L+0]=f,this.int16[L+1]=m,this.int16[L+2]=y,this.int16[L+4]=b,this.int16[L+5]=M,this.int16[L+6]=I,this.int16[L+7]=P,e}}at.prototype.bytesPerElement=16,Mt(at,"StructArrayLayout3i2i2i16");class Dt extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b){const M=this.length;return this.resize(M+1),this.emplace(M,e,f,m,y,b)}emplace(e,f,m,y,b,M){const I=4*e,P=8*e;return this.float32[I+0]=f,this.float32[I+1]=m,this.float32[I+2]=y,this.int16[P+6]=b,this.int16[P+7]=M,e}}Dt.prototype.bytesPerElement=16,Mt(Dt,"StructArrayLayout2f1f2i16");class Je extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,f,m,y){const b=this.length;return this.resize(b+1),this.emplace(b,e,f,m,y)}emplace(e,f,m,y,b){const M=12*e,I=3*e;return this.uint8[M+0]=f,this.uint8[M+1]=m,this.float32[I+1]=y,this.float32[I+2]=b,e}}Je.prototype.bytesPerElement=12,Mt(Je,"StructArrayLayout2ub2f12");class At extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,e,f,m)}emplace(e,f,m,y){const b=3*e;return this.uint16[b+0]=f,this.uint16[b+1]=m,this.uint16[b+2]=y,e}}At.prototype.bytesPerElement=6,Mt(At,"StructArrayLayout3ui6");class qt extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe,ve,Ie,Be,Le,Fe){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe,ve,Ie,Be,Le,Fe)}emplace(e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe,ve,Ie,Be,Le,Fe,Oe){const Xe=30*e,We=15*e,tt=60*e;return this.int16[Xe+0]=f,this.int16[Xe+1]=m,this.int16[Xe+2]=y,this.float32[We+2]=b,this.float32[We+3]=M,this.uint16[Xe+8]=I,this.uint16[Xe+9]=P,this.uint32[We+5]=L,this.uint32[We+6]=N,this.uint32[We+7]=U,this.uint16[Xe+16]=j,this.uint16[Xe+17]=H,this.uint16[Xe+18]=ne,this.float32[We+10]=ae,this.float32[We+11]=pe,this.uint8[tt+48]=ve,this.uint8[tt+49]=Ie,this.uint8[tt+50]=Be,this.uint32[We+13]=Le,this.int16[Xe+28]=Fe,this.uint8[tt+58]=Oe,e}}qt.prototype.bytesPerElement=60,Mt(qt,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class It extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe,ve,Ie,Be,Le,Fe,Oe,Xe,We,tt,nt,qe,Qe,st,mt){const lt=this.length;return this.resize(lt+1),this.emplace(lt,e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe,ve,Ie,Be,Le,Fe,Oe,Xe,We,tt,nt,qe,Qe,st,mt)}emplace(e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe,ve,Ie,Be,Le,Fe,Oe,Xe,We,tt,nt,qe,Qe,st,mt,lt){const dt=38*e,ri=19*e;return this.int16[dt+0]=f,this.int16[dt+1]=m,this.int16[dt+2]=y,this.float32[ri+2]=b,this.float32[ri+3]=M,this.int16[dt+8]=I,this.int16[dt+9]=P,this.int16[dt+10]=L,this.int16[dt+11]=N,this.int16[dt+12]=U,this.int16[dt+13]=j,this.uint16[dt+14]=H,this.uint16[dt+15]=ne,this.uint16[dt+16]=ae,this.uint16[dt+17]=pe,this.uint16[dt+18]=ve,this.uint16[dt+19]=Ie,this.uint16[dt+20]=Be,this.uint16[dt+21]=Le,this.uint16[dt+22]=Fe,this.uint16[dt+23]=Oe,this.uint16[dt+24]=Xe,this.uint16[dt+25]=We,this.uint16[dt+26]=tt,this.uint16[dt+27]=nt,this.uint16[dt+28]=qe,this.uint32[ri+15]=Qe,this.float32[ri+16]=st,this.float32[ri+17]=mt,this.float32[ri+18]=lt,e}}It.prototype.bytesPerElement=76,Mt(It,"StructArrayLayout3i2f6i15ui1ul3f76");class Ct extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const f=this.length;return this.resize(f+1),this.emplace(f,e)}emplace(e,f){return this.float32[1*e+0]=f,e}}Ct.prototype.bytesPerElement=4,Mt(Ct,"StructArrayLayout1f4");class Kt extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I){const P=this.length;return this.resize(P+1),this.emplace(P,e,f,m,y,b,M,I)}emplace(e,f,m,y,b,M,I,P){const L=7*e;return this.float32[L+0]=f,this.float32[L+1]=m,this.float32[L+2]=y,this.float32[L+3]=b,this.float32[L+4]=M,this.float32[L+5]=I,this.float32[L+6]=P,e}}Kt.prototype.bytesPerElement=28,Mt(Kt,"StructArrayLayout7f28");class mi extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b){const M=this.length;return this.resize(M+1),this.emplace(M,e,f,m,y,b)}emplace(e,f,m,y,b,M){const I=5*e;return this.float32[I+0]=f,this.float32[I+1]=m,this.float32[I+2]=y,this.float32[I+3]=b,this.float32[I+4]=M,e}}mi.prototype.bytesPerElement=20,Mt(mi,"StructArrayLayout5f20");class jt extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,f,m,y){const b=this.length;return this.resize(b+1),this.emplace(b,e,f,m,y)}emplace(e,f,m,y,b){const M=6*e;return this.uint32[3*e+0]=f,this.uint16[M+2]=m,this.uint16[M+3]=y,this.uint16[M+4]=b,e}}jt.prototype.bytesPerElement=12,Mt(jt,"StructArrayLayout1ul3ui12");class ti extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,f){const m=this.length;return this.resize(m+1),this.emplace(m,e,f)}emplace(e,f,m){const y=2*e;return this.uint16[y+0]=f,this.uint16[y+1]=m,e}}ti.prototype.bytesPerElement=4,Mt(ti,"StructArrayLayout2ui4");class Ii extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const f=this.length;return this.resize(f+1),this.emplace(f,e)}emplace(e,f){return this.uint16[1*e+0]=f,e}}Ii.prototype.bytesPerElement=2,Mt(Ii,"StructArrayLayout1ui2");class Yi extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,f){const m=this.length;return this.resize(m+1),this.emplace(m,e,f)}emplace(e,f,m){const y=2*e;return this.float32[y+0]=f,this.float32[y+1]=m,e}}Yi.prototype.bytesPerElement=8,Mt(Yi,"StructArrayLayout2f8");class vr extends se{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,f,m,y,b,M,I){const P=this.length;return this.resize(P+1),this.emplace(P,e,f,m,y,b,M,I)}emplace(e,f,m,y,b,M,I,P){const L=8*e,N=4*e;return this.int16[L+0]=f,this.int16[L+1]=m,this.int16[L+2]=y,this.int16[L+3]=b,this.int16[L+4]=M,this.int16[L+5]=I,this.float32[N+3]=P,e}}vr.prototype.bytesPerElement=16,Mt(vr,"StructArrayLayout6i1f16");class br extends de{get a_pos_30(){return this._structArray.int16[this._pos2+0]}get a_pos_31(){return this._structArray.int16[this._pos2+1]}get a_pos_32(){return this._structArray.int16[this._pos2+2]}get a_pos_normal_30(){return this._structArray.int16[this._pos2+3]}get a_pos_normal_31(){return this._structArray.int16[this._pos2+4]}get a_pos_normal_32(){return this._structArray.int16[this._pos2+5]}}br.prototype.size=12;class Vr extends He{get(e){return new br(this,e)}}Mt(Vr,"FillExtrusionExtArray");class hn extends de{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}hn.prototype.size=40;class Tn extends ht{get(e){return new hn(this,e)}}Mt(Tn,"CollisionBoxArray");class On extends de{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}On.prototype.size=60;class Mn extends qt{get(e){return new On(this,e)}}Mt(Mn,"PlacedSymbolArray");class Hi extends de{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(e){this._structArray.uint32[this._pos4+15]=e}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}Hi.prototype.size=76;class Ji extends It{get(e){return new Hi(this,e)}}Mt(Ji,"SymbolInstanceArray");class Pi extends Ct{getoffsetX(e){return this.float32[1*e+0]}}Mt(Pi,"GlyphOffsetArray");class nr extends Me{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}Mt(nr,"SymbolLineVertexArray");class jr extends de{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}jr.prototype.size=12;class Wi extends jt{get(e){return new jr(this,e)}}Mt(Wi,"FeatureIndexArray");class Kr extends de{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0]}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1]}}Kr.prototype.size=4;class us extends ti{get(e){return new Kr(this,e)}}Mt(us,"FillExtrusionCentroidArray");class Gr extends de{get a_pos_30(){return this._structArray.int16[this._pos2+0]}get a_pos_31(){return this._structArray.int16[this._pos2+1]}get a_pos_32(){return this._structArray.int16[this._pos2+2]}get a_pos_normal_30(){return this._structArray.int16[this._pos2+3]}get a_pos_normal_31(){return this._structArray.int16[this._pos2+4]}get a_pos_normal_32(){return this._structArray.int16[this._pos2+5]}get a_scale(){return this._structArray.float32[this._pos4+3]}}Gr.prototype.size=16;class to extends vr{get(e){return new Gr(this,e)}}Mt(to,"CircleGlobeExtArray");const Sc=Se([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),il=Se([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var Mo=bs(function(d){d.exports=function(e,f){var m,y,b,M,I,P,L,N;for(y=e.length-(m=3&e.length),b=f,I=3432918353,P=461845907,N=0;N<y;)L=255&e.charCodeAt(N)|(255&e.charCodeAt(++N))<<8|(255&e.charCodeAt(++N))<<16|(255&e.charCodeAt(++N))<<24,++N,b=27492+(65535&(M=5*(65535&(b=(b^=L=(65535&(L=(L=(65535&L)*I+(((L>>>16)*I&65535)<<16)&4294967295)<<15|L>>>17))*P+(((L>>>16)*P&65535)<<16)&4294967295)<<13|b>>>19))+((5*(b>>>16)&65535)<<16)&4294967295))+((58964+(M>>>16)&65535)<<16);switch(L=0,m){case 3:L^=(255&e.charCodeAt(N+2))<<16;case 2:L^=(255&e.charCodeAt(N+1))<<8;case 1:b^=L=(65535&(L=(L=(65535&(L^=255&e.charCodeAt(N)))*I+(((L>>>16)*I&65535)<<16)&4294967295)<<15|L>>>17))*P+(((L>>>16)*P&65535)<<16)&4294967295}return b^=e.length,b=2246822507*(65535&(b^=b>>>16))+((2246822507*(b>>>16)&65535)<<16)&4294967295,b=3266489909*(65535&(b^=b>>>13))+((3266489909*(b>>>16)&65535)<<16)&4294967295,(b^=b>>>16)>>>0}}),wh=bs(function(d){d.exports=function(e,f){for(var m,y=e.length,b=f^y,M=0;y>=4;)m=1540483477*(65535&(m=255&e.charCodeAt(M)|(255&e.charCodeAt(++M))<<8|(255&e.charCodeAt(++M))<<16|(255&e.charCodeAt(++M))<<24))+((1540483477*(m>>>16)&65535)<<16),b=1540483477*(65535&b)+((1540483477*(b>>>16)&65535)<<16)^(m=1540483477*(65535&(m^=m>>>24))+((1540483477*(m>>>16)&65535)<<16)),y-=4,++M;switch(y){case 3:b^=(255&e.charCodeAt(M+2))<<16;case 2:b^=(255&e.charCodeAt(M+1))<<8;case 1:b=1540483477*(65535&(b^=255&e.charCodeAt(M)))+((1540483477*(b>>>16)&65535)<<16)}return b=1540483477*(65535&(b^=b>>>13))+((1540483477*(b>>>16)&65535)<<16),(b^=b>>>15)>>>0}}),Nn=Mo,rl=wh;Nn.murmur3=Mo,Nn.murmur2=rl;class Ac{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,f,m,y){this.ids.push(Iu(e)),this.positions.push(f,m,y)}getPositions(e){const f=Iu(e);let m=0,y=this.ids.length-1;for(;m<y;){const M=m+y>>1;this.ids[M]>=f?y=M:m=M+1}const b=[];for(;this.ids[m]===f;)b.push({index:this.positions[3*m],start:this.positions[3*m+1],end:this.positions[3*m+2]}),m++;return b}static serialize(e,f){const m=new Float64Array(e.ids),y=new Uint32Array(e.positions);return Eh(m,y,0,m.length-1),f&&f.push(m.buffer,y.buffer),{ids:m,positions:y}}static deserialize(e){const f=new Ac;return f.ids=e.ids,f.positions=e.positions,f.indexed=!0,f}}function Iu(d){const e=+d;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Nn(String(d))}function Eh(d,e,f,m){for(;f<m;){const y=d[f+m>>1];let b=f-1,M=m+1;for(;;){do b++;while(d[b]<y);do M--;while(d[M]>y);if(b>=M)break;Ic(d,b,M),Ic(e,3*b,3*M),Ic(e,3*b+1,3*M+1),Ic(e,3*b+2,3*M+2)}M-f<m-M?(Eh(d,e,f,M),f=M+1):(Eh(d,e,M+1,m),m=M)}}function Ic(d,e,f){const m=d[e];d[e]=d[f],d[f]=m}Mt(Ac,"FeaturePositionMap");class io{constructor(e,f){this.gl=e.gl,this.location=f}}class Cc extends io{constructor(e,f){super(e,f),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class Cu extends io{constructor(e,f){super(e,f),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class ku extends io{constructor(e,f){super(e,f),this.current=Di.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const Ff=new Float32Array(16),Of=new Float32Array(9),Nf=new Float32Array(4);function Th(d){return[le(255*d.r,255*d.g),le(255*d.b,255*d.a)]}class nl{constructor(e,f,m){this.value=e,this.uniformNames=f.map(y=>`u_${y}`),this.type=m}setUniform(e,f,m){e.set(m.constantOr(this.value))}getBinding(e,f,m){return this.type==="color"?new ku(e,f):new Cc(e,f)}}class Qs{constructor(e,f){this.uniformNames=f.map(m=>`u_${m}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,f){this.pixelRatioFrom=f.pixelRatio||1,this.pixelRatioTo=e.pixelRatio||1,this.patternFrom=f.tl.concat(f.br),this.patternTo=e.tl.concat(e.br)}setUniform(e,f,m,y){const b=y==="u_pattern_to"||y==="u_dash_to"?this.patternTo:y==="u_pattern_from"||y==="u_dash_from"?this.patternFrom:y==="u_pixel_ratio_to"?this.pixelRatioTo:y==="u_pixel_ratio_from"?this.pixelRatioFrom:null;b&&e.set(b)}getBinding(e,f,m){return m==="u_pattern_from"||m==="u_pattern_to"||m==="u_dash_from"||m==="u_dash_to"?new Cu(e,f):new Cc(e,f)}}class ro{constructor(e,f,m,y){this.expression=e,this.type=m,this.maxValue=0,this.paintVertexAttributes=f.map(b=>({name:`a_${b}`,type:"Float32",components:m==="color"?2:1,offset:0})),this.paintVertexArray=new y}populatePaintArray(e,f,m,y,b,M){const I=this.paintVertexArray.length,P=this.expression.evaluate(new ji(0),f,{},b,y,M);this.paintVertexArray.resize(e),this._setPaintValue(I,e,P)}updatePaintArray(e,f,m,y,b){const M=this.expression.evaluate({zoom:0},m,y,void 0,b);this._setPaintValue(e,f,M)}_setPaintValue(e,f,m){if(this.type==="color"){const y=Th(m);for(let b=e;b<f;b++)this.paintVertexArray.emplace(b,y[0],y[1])}else{for(let y=e;y<f;y++)this.paintVertexArray.emplace(y,m);this.maxValue=Math.max(this.maxValue,Math.abs(m))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Sn{constructor(e,f,m,y,b,M){this.expression=e,this.uniformNames=f.map(I=>`u_${I}_t`),this.type=m,this.useIntegerZoom=y,this.zoom=b,this.maxValue=0,this.paintVertexAttributes=f.map(I=>({name:`a_${I}`,type:"Float32",components:m==="color"?4:2,offset:0})),this.paintVertexArray=new M}populatePaintArray(e,f,m,y,b,M){const I=this.expression.evaluate(new ji(this.zoom),f,{},b,y,M),P=this.expression.evaluate(new ji(this.zoom+1),f,{},b,y,M),L=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(L,e,I,P)}updatePaintArray(e,f,m,y,b){const M=this.expression.evaluate({zoom:this.zoom},m,y,void 0,b),I=this.expression.evaluate({zoom:this.zoom+1},m,y,void 0,b);this._setPaintValue(e,f,M,I)}_setPaintValue(e,f,m,y){if(this.type==="color"){const b=Th(m),M=Th(y);for(let I=e;I<f;I++)this.paintVertexArray.emplace(I,b[0],b[1],M[0],M[1])}else{for(let b=e;b<f;b++)this.paintVertexArray.emplace(b,m,y);this.maxValue=Math.max(this.maxValue,Math.abs(m),Math.abs(y))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,f){const m=this.useIntegerZoom?Math.floor(f.zoom):f.zoom,y=_e(this.expression.interpolationFactor(m,this.zoom,this.zoom+1),0,1);e.set(y)}getBinding(e,f,m){return new Cc(e,f)}}class So{constructor(e,f,m,y,b,M,I){this.expression=e,this.type=m,this.useIntegerZoom=y,this.zoom=b,this.layerId=I,this.paintVertexAttributes=(m==="array"?il:Sc).members;for(let P=0;P<f.length;++P);this.zoomInPaintVertexArray=new M,this.zoomOutPaintVertexArray=new M}populatePaintArray(e,f,m){const y=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(y,e,f.patterns&&f.patterns[this.layerId],m)}updatePaintArray(e,f,m,y,b,M){this._setPaintValues(e,f,m.patterns&&m.patterns[this.layerId],M)}_setPaintValues(e,f,m,y){if(!y||!m)return;const{min:b,mid:M,max:I}=m,P=y[b],L=y[M],N=y[I];if(P&&L&&N)for(let U=e;U<f;U++)this._setPaintValue(this.zoomInPaintVertexArray,U,L,P),this._setPaintValue(this.zoomOutPaintVertexArray,U,L,N)}_setPaintValue(e,f,m,y){e.emplace(f,m.tl[0],m.tl[1],m.br[0],m.br[1],y.tl[0],y.tl[1],y.br[0],y.br[1],m.pixelRatio,y.pixelRatio)}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Ao{constructor(e,f,m=()=>!0){this.binders={},this._buffers=[];const y=[];for(const b in e.paint._values){if(!m(b))continue;const M=e.paint.get(b);if(!(M instanceof C&&_o(M.property.specification)))continue;const I=Uf(b,e.type),P=M.value,L=M.property.specification.type,N=M.property.useIntegerZoom,U=M.property.specification["property-type"],j=U==="cross-faded"||U==="cross-faded-data-driven",H=String(b)==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant";if(P.kind!=="constant"||H)if(P.kind==="source"||H||j){const ne=Du(b,L,"source");this.binders[b]=j?new So(P,I,L,N,f,ne,e.id):new ro(P,I,L,ne),y.push(`/a_${b}`)}else{const ne=Du(b,L,"composite");this.binders[b]=new Sn(P,I,L,N,f,ne),y.push(`/z_${b}`)}else this.binders[b]=j?new Qs(P.value,I):new nl(P.value,I,L),y.push(`/u_${b}`)}this.cacheKey=y.sort().join("")}getMaxValue(e){const f=this.binders[e];return f instanceof ro||f instanceof Sn?f.maxValue:0}populatePaintArrays(e,f,m,y,b,M){for(const I in this.binders){const P=this.binders[I];(P instanceof ro||P instanceof Sn||P instanceof So)&&P.populatePaintArray(e,f,m,y,b,M)}}setConstantPatternPositions(e,f){for(const m in this.binders){const y=this.binders[m];y instanceof Qs&&y.setConstantPatternPositions(e,f)}}updatePaintArrays(e,f,m,y,b,M){let I=!1;for(const P in e){const L=f.getPositions(P);for(const N of L){const U=m.feature(N.index);for(const j in this.binders){const H=this.binders[j];if((H instanceof ro||H instanceof Sn||H instanceof So)&&H.expression.isStateDependent===!0){const ne=y.paint.get(j);H.expression=ne.value,H.updatePaintArray(N.start,N.end,U,e[P],b,M),I=!0}}}}return I}defines(){const e=[];for(const f in this.binders){const m=this.binders[f];(m instanceof nl||m instanceof Qs)&&e.push(...m.uniformNames.map(y=>`#define HAS_UNIFORM_${y}`))}return e}getBinderAttributes(){const e=[];for(const f in this.binders){const m=this.binders[f];if(m instanceof ro||m instanceof Sn||m instanceof So)for(let y=0;y<m.paintVertexAttributes.length;y++)e.push(m.paintVertexAttributes[y].name)}return e}getBinderUniforms(){const e=[];for(const f in this.binders){const m=this.binders[f];if(m instanceof nl||m instanceof Qs||m instanceof Sn)for(const y of m.uniformNames)e.push(y)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,f){const m=[];for(const y in this.binders){const b=this.binders[y];if(b instanceof nl||b instanceof Qs||b instanceof Sn){for(const M of b.uniformNames)if(f[M]){const I=b.getBinding(e,f[M],M);m.push({name:M,property:y,binding:I})}}}return m}setUniforms(e,f,m,y){for(const{name:b,property:M,binding:I}of f)this.binders[M].setUniform(I,y,m.get(M),b)}updatePaintBuffers(e){this._buffers=[];for(const f in this.binders){const m=this.binders[f];if(e&&m instanceof So){const y=e.fromScale===2?m.zoomInPaintVertexBuffer:m.zoomOutPaintVertexBuffer;y&&this._buffers.push(y)}else(m instanceof ro||m instanceof Sn)&&m.paintVertexBuffer&&this._buffers.push(m.paintVertexBuffer)}}upload(e){for(const f in this.binders){const m=this.binders[f];(m instanceof ro||m instanceof Sn||m instanceof So)&&m.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const f=this.binders[e];(f instanceof ro||f instanceof Sn||f instanceof So)&&f.destroy()}}}class ds{constructor(e,f,m=()=>!0){this.programConfigurations={};for(const y of e)this.programConfigurations[y.id]=new Ao(y,f,m);this.needsUpload=!1,this._featureMap=new Ac,this._bufferOffset=0}populatePaintArrays(e,f,m,y,b,M,I){for(const P in this.programConfigurations)this.programConfigurations[P].populatePaintArrays(e,f,y,b,M,I);f.id!==void 0&&this._featureMap.add(f.id,m,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,f,m,y,b){for(const M of m)this.needsUpload=this.programConfigurations[M.id].updatePaintArrays(e,this._featureMap,f,M,y,b)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const f in this.programConfigurations)this.programConfigurations[f].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const $f={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function Uf(d,e){return $f[d]||[d.replace(`${e}-`,"").replace(/-/g,"_")]}const Vf={"line-pattern":{source:Ue,composite:Ue},"fill-pattern":{source:Ue,composite:Ue},"fill-extrusion-pattern":{source:Ue,composite:Ue},"line-dasharray":{source:Ze,composite:Ze}},jf={color:{source:Yi,composite:De},number:{source:Ct,composite:Yi}};function Du(d,e,f){const m=Vf[d];return m&&m[f]||jf[e][f]}Mt(nl,"ConstantBinder"),Mt(Qs,"CrossFadedConstantBinder"),Mt(ro,"SourceExpressionBinder"),Mt(So,"CrossFadedCompositeBinder"),Mt(Sn,"CompositeExpressionBinder"),Mt(Ao,"ProgramConfiguration",{omit:["_buffers"]}),Mt(ds,"ProgramConfigurationSet");const kc="-transition";class An extends Wt{constructor(e,f){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,e.type!=="custom"&&(this.metadata=(e=e).metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&e.type!=="sky"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),f.layout&&(this._unevaluatedLayout=new T(f.layout)),f.paint)){this._transitionablePaint=new x(f.paint);for(const m in e.paint)this.setPaintProperty(m,e.paint[m],{validate:!1});for(const m in e.layout)this.setLayoutProperty(m,e.layout[m],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new k(f.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,f,m={}){f!=null&&this._validate(xh,`layers.${this.id}.layout.${e}`,e,f,m)||(e!=="visibility"?this._unevaluatedLayout.setValue(e,f):this.visibility=f)}getPaintProperty(e){return vt(e,kc)?this._transitionablePaint.getTransition(e.slice(0,-kc.length)):this._transitionablePaint.getValue(e)}setPaintProperty(e,f,m={}){if(f!=null&&this._validate(yh,`layers.${this.id}.paint.${e}`,e,f,m))return!1;if(vt(e,kc))return this._transitionablePaint.setTransition(e.slice(0,-kc.length),f||void 0),!1;{const y=this._transitionablePaint._values[e],b=y.property.specification["property-type"]==="cross-faded-data-driven",M=y.value.isDataDriven(),I=y.value;this._transitionablePaint.setValue(e,f),this._handleSpecialPaintPropertyUpdate(e);const P=this._transitionablePaint._values[e].value;return P.isDataDriven()||M||b||this._handleOverridablePaintPropertyUpdate(e,I,P)}}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getProgramConfiguration(e){return null}_handleOverridablePaintPropertyUpdate(e,f,m){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,f){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,f)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,f)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),kt(e,(f,m)=>!(f===void 0||m==="layout"&&!Object.keys(f).length||m==="paint"&&!Object.keys(f).length))}_validate(e,f,m,y,b={}){return(!b||b.validate!==!1)&&cc(this,e.call(rs,{key:f,layerType:this.type,objectKey:m,value:y,styleSpec:$e,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const f=this.paint.get(e);if(f instanceof C&&_o(f.property.specification)&&(f.value.kind==="source"||f.value.kind==="composite")&&f.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Rn(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const Gf=Se([{name:"a_pos",components:2,type:"Int16"}],4),qf=Se([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"},{name:"a_scale",components:1,type:"Float32"}]);class Qi{constructor(e=[]){this.segments=e}prepareSegment(e,f,m,y){let b=this.segments[this.segments.length-1];return e>Qi.MAX_VERTEX_ARRAY_LENGTH&&ot(`Max vertices per segment is ${Qi.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!b||b.vertexLength+e>Qi.MAX_VERTEX_ARRAY_LENGTH||b.sortKey!==y)&&(b={vertexOffset:f.length,primitiveOffset:m.length,vertexLength:0,primitiveLength:0},y!==void 0&&(b.sortKey=y),this.segments.push(b)),b}get(){return this.segments}destroy(){for(const e of this.segments)for(const f in e.vaos)e.vaos[f].destroy()}static simpleSegment(e,f,m,y){return new Qi([{vertexOffset:e,primitiveOffset:f,vertexLength:m,primitiveLength:y,vaos:{},sortKey:0}])}}Qi.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Mt(Qi,"SegmentVector");var fi=8192;class Io{constructor(e,f){e&&(f?this.setSouthWest(e).setNorthEast(f):e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof Ni?new Ni(e.lng,e.lat):Ni.convert(e),this}setSouthWest(e){return this._sw=e instanceof Ni?new Ni(e.lng,e.lat):Ni.convert(e),this}extend(e){const f=this._sw,m=this._ne;let y,b;if(e instanceof Ni)y=e,b=e;else{if(!(e instanceof Io))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(Io.convert(e)):this.extend(Ni.convert(e)):this;if(y=e._sw,b=e._ne,!y||!b)return this}return f||m?(f.lng=Math.min(y.lng,f.lng),f.lat=Math.min(y.lat,f.lat),m.lng=Math.max(b.lng,m.lng),m.lat=Math.max(b.lat,m.lat)):(this._sw=new Ni(y.lng,y.lat),this._ne=new Ni(b.lng,b.lat)),this}getCenter(){return new Ni((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Ni(this.getWest(),this.getNorth())}getSouthEast(){return new Ni(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:f,lat:m}=Ni.convert(e);let y=this._sw.lng<=f&&f<=this._ne.lng;return this._sw.lng>this._ne.lng&&(y=this._sw.lng>=f&&f>=this._ne.lng),this._sw.lat<=m&&m<=this._ne.lat&&y}static convert(e){return!e||e instanceof Io?e:new Io(e)}}const Mh=63710088e-1;class Ni{constructor(e,f){if(isNaN(e)||isNaN(f))throw new Error(`Invalid LngLat object: (${e}, ${f})`);if(this.lng=+e,this.lat=+f,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ni(oe(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const f=Math.PI/180,m=this.lat*f,y=e.lat*f,b=Math.sin(m)*Math.sin(y)+Math.cos(m)*Math.cos(y)*Math.cos((e.lng-this.lng)*f);return Mh*Math.acos(Math.min(b,1))}toBounds(e=0){const f=360*e/40075017,m=f/Math.cos(Math.PI/180*this.lat);return new Io(new Ni(this.lng-m,this.lat-f),new Ni(this.lng+m,this.lat+f))}static convert(e){if(e instanceof Ni)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Ni(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Ni(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const Pu=2*Math.PI*Mh;function Sh(d){return Pu*Math.cos(d*Math.PI/180)}function ol(d){return(180+d)/360}function ea(d){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+d*Math.PI/360)))/360}function ta(d,e){return d/Sh(e)}function mn(d){return 360*d-180}function wr(d){return 360/Math.PI*Math.atan(Math.exp((180-360*d)*Math.PI/180))-90}function Bu(d,e){return d*Sh(wr(e))}const $n=85.051129;class Dc{constructor(e,f,m=0){this.x=+e,this.y=+f,this.z=+m}static fromLngLat(e,f=0){const m=Ni.convert(e);return new Dc(ol(m.lng),ea(m.lat),ta(f,m.lat))}toLngLat(){return new Ni(mn(this.x),wr(this.y))}toAltitude(){return Bu(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Pu*(e=wr(this.y),1/Math.cos(e*Math.PI/180));var e}}function Ah(d,e,f,m,y,b,M,I,P){const L=(e+m)/2,N=(f+y)/2,U=new z(L,N);I(U),function(j,H,ne,ae,pe,ve){const Ie=ne-pe,Be=ae-ve;return Math.abs((ae-H)*Ie-(ne-j)*Be)/Math.hypot(Ie,Be)}(U.x,U.y,b.x,b.y,M.x,M.y)>=P?(Ah(d,e,f,L,N,b,U,I,P),Ah(d,L,N,m,y,U,M,I,P)):d.push(M)}function Zf(d,e,f){let m=d[0],y=m.x,b=m.y;e(m);const M=[m];for(let I=1;I<d.length;I++){const P=d[I],{x:L,y:N}=P;e(P),Ah(M,y,b,L,N,m,P,e,f),y=L,b=N,m=P}return M}const Ih=Math.pow(2,14)-1,Ru=-Ih-1;function Xf(d,e){const f=Math.round(d.x*e),m=Math.round(d.y*e);return d.x=_e(f,Ru,Ih),d.y=_e(m,Ru,Ih),(f<d.x||f>d.x+1||m<d.y||m>d.y+1)&&ot("Geometry exceeds allowed extent, reduce your vector tile buffer size"),d}function no(d,e,f){const m=d.loadGeometry(),y=d.extent,b=fi/y;if(e&&f&&f.projection.isReprojectedInTileSpace){const M=1<<e.z,{scale:I,x:P,y:L,projection:N}=f,U=j=>{const H=mn((e.x+j.x/y)/M),ne=wr((e.y+j.y/y)/M),ae=N.project(H,ne);j.x=(ae.x*I-P)*y,j.y=(ae.y*I-L)*y};for(let j=0;j<m.length;j++)if(d.type!==1)m[j]=Zf(m[j],U,1);else{const H=[];for(const ne of m[j])ne.x<0||ne.x>=y||ne.y<0||ne.y>=y||(U(ne),H.push(ne));m[j]=H}}for(const M of m)for(const I of M)Xf(I,b);return m}function fs(d,e){return{type:d.type,id:d.id,properties:d.properties,geometry:e?no(d):[]}}function Pc(d,e,f,m,y){d.emplaceBack(2*e+(m+1)/2,2*f+(y+1)/2)}function Bc(d,e,f,m){d.emplaceBack(e.x,e.y,e.z,f[0]*16384,f[1]*16384,f[2]*16384,m)}class Ch{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(f=>f.id),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Te,this.indexArray=new At,this.segments=new Qi,this.programConfigurations=new ds(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(f=>f.isStateDependent()).map(f=>f.id)}populate(e,f,m,y){const b=this.layers[0],M=[];let I=null;b.type==="circle"&&(I=b.layout.get("circle-sort-key"));for(const{feature:L,id:N,index:U,sourceLayerIndex:j}of e){const H=this.layers[0]._featureFilter.needGeometry,ne=fs(L,H);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),ne,m))continue;const ae=I?I.evaluate(ne,{},m):void 0,pe={id:N,properties:L.properties,type:L.type,sourceLayerIndex:j,index:U,geometry:H?ne.geometry:no(L,m,y),patterns:{},sortKey:ae};M.push(pe)}I&&M.sort((L,N)=>L.sortKey-N.sortKey);let P=null;y.projection.name==="globe"&&(this.globeExtVertexArray=new to,P=y.projection);for(const L of M){const{geometry:N,index:U,sourceLayerIndex:j}=L,H=e[U].feature;this.addFeature(L,N,U,f.availableImages,m,P),f.featureIndex.insert(H,N,U,j,this.index)}}update(e,f,m,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,f,this.stateDependentLayers,m,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Gf.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,qf.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,f,m,y,b,M){for(const I of f)for(const P of I){const L=P.x,N=P.y;if(L<0||L>=fi||N<0||N>=fi)continue;if(M){const H=M.projectTilePoint(L,N,b),ne=M.upVector(b,L,N),ae=wr((N/fi+b.y)/(1<<b.z)),pe=M.pixelsPerMeter(ae,1)/ta(1,ae),ve=this.globeExtVertexArray;Bc(ve,H,ne,pe),Bc(ve,H,ne,pe),Bc(ve,H,ne,pe),Bc(ve,H,ne,pe)}const U=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),j=U.vertexLength;Pc(this.layoutVertexArray,L,N,-1,-1),Pc(this.layoutVertexArray,L,N,1,-1),Pc(this.layoutVertexArray,L,N,1,1),Pc(this.layoutVertexArray,L,N,-1,1),this.indexArray.emplaceBack(j,j+1,j+2),this.indexArray.emplaceBack(j,j+3,j+2),U.vertexLength+=4,U.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,m,{},y,b)}}function Lu(d,e){for(let f=0;f<d.length;f++)if(ia(e,d[f]))return!0;for(let f=0;f<e.length;f++)if(ia(d,e[f]))return!0;return!!kh(d,e)}function Yf(d,e,f){return!!ia(d,e)||!!Dh(e,d,f)}function zu(d,e){if(d.length===1)return Ou(e,d[0]);for(let f=0;f<e.length;f++){const m=e[f];for(let y=0;y<m.length;y++)if(ia(d,m[y]))return!0}for(let f=0;f<d.length;f++)if(Ou(e,d[f]))return!0;for(let f=0;f<e.length;f++)if(kh(d,e[f]))return!0;return!1}function Wf(d,e,f){if(d.length>1){if(kh(d,e))return!0;for(let m=0;m<e.length;m++)if(Dh(e[m],d,f))return!0}for(let m=0;m<d.length;m++)if(Dh(d[m],e,f))return!0;return!1}function kh(d,e){if(d.length===0||e.length===0)return!1;for(let f=0;f<d.length-1;f++){const m=d[f],y=d[f+1];for(let b=0;b<e.length-1;b++)if(Hf(m,y,e[b],e[b+1]))return!0}return!1}function Hf(d,e,f,m){return gt(d,f,m)!==gt(e,f,m)&&gt(d,e,f)!==gt(d,e,m)}function Dh(d,e,f){const m=f*f;if(e.length===1)return d.distSqr(e[0])<m;for(let y=1;y<e.length;y++)if(Fu(d,e[y-1],e[y])<m)return!0;return!1}function Fu(d,e,f){const m=e.distSqr(f);if(m===0)return d.distSqr(e);const y=((d.x-e.x)*(f.x-e.x)+(d.y-e.y)*(f.y-e.y))/m;return d.distSqr(y<0?e:y>1?f:f.sub(e)._mult(y)._add(e))}function Ou(d,e){let f,m,y,b=!1;for(let M=0;M<d.length;M++){f=d[M];for(let I=0,P=f.length-1;I<f.length;P=I++)m=f[I],y=f[P],m.y>e.y!=y.y>e.y&&e.x<(y.x-m.x)*(e.y-m.y)/(y.y-m.y)+m.x&&(b=!b)}return b}function ia(d,e){let f=!1;for(let m=0,y=d.length-1;m<d.length;y=m++){const b=d[m],M=d[y];b.y>e.y!=M.y>e.y&&e.x<(M.x-b.x)*(e.y-b.y)/(M.y-b.y)+b.x&&(f=!f)}return f}function Nu(d,e,f,m,y){for(const M of d)if(e<=M.x&&f<=M.y&&m>=M.x&&y>=M.y)return!0;const b=[new z(e,f),new z(e,y),new z(m,y),new z(m,f)];if(d.length>2){for(const M of b)if(ia(d,M))return!0}for(let M=0;M<d.length-1;M++)if(Kf(d[M],d[M+1],b))return!0;return!1}function Kf(d,e,f){const m=f[0],y=f[2];if(d.x<m.x&&e.x<m.x||d.x>y.x&&e.x>y.x||d.y<m.y&&e.y<m.y||d.y>y.y&&e.y>y.y)return!1;const b=gt(d,e,f[0]);return b!==gt(d,e,f[1])||b!==gt(d,e,f[2])||b!==gt(d,e,f[3])}function ra(d,e,f){const m=e.paint.get(d).value;return m.kind==="constant"?m.value:f.programConfigurations.get(e.id).getMaxValue(d)}function Rc(d){return Math.sqrt(d[0]*d[0]+d[1]*d[1])}function $u(d,e,f,m,y){if(!e[0]&&!e[1])return d;const b=z.convert(e)._mult(y);f==="viewport"&&b._rotate(-m);const M=[];for(let I=0;I<d.length;I++)M.push(d[I].sub(b));return M}function Uu(d,e,f,m){const y=z.convert(d)._mult(m);return e==="viewport"&&y._rotate(-f),y}Mt(Ch,"CircleBucket",{omit:["layers"]});const Jf=new te({"circle-sort-key":new F($e.layout_circle["circle-sort-key"])});var Qf={paint:new te({"circle-radius":new F($e.paint_circle["circle-radius"]),"circle-color":new F($e.paint_circle["circle-color"]),"circle-blur":new F($e.paint_circle["circle-blur"]),"circle-opacity":new F($e.paint_circle["circle-opacity"]),"circle-translate":new B($e.paint_circle["circle-translate"]),"circle-translate-anchor":new B($e.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new B($e.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new B($e.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new F($e.paint_circle["circle-stroke-width"]),"circle-stroke-color":new F($e.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new F($e.paint_circle["circle-stroke-opacity"])}),layout:Jf},Ph=1e-6,Jr=typeof Float32Array!="undefined"?Float32Array:Array;function Vu(){var d=new Jr(9);return Jr!=Float32Array&&(d[1]=0,d[2]=0,d[3]=0,d[5]=0,d[6]=0,d[7]=0),d[0]=1,d[4]=1,d[8]=1,d}function Un(d){return d[0]=1,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=1,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=1,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function Bh(d,e,f){var m=e[0],y=e[1],b=e[2],M=e[3],I=e[4],P=e[5],L=e[6],N=e[7],U=e[8],j=e[9],H=e[10],ne=e[11],ae=e[12],pe=e[13],ve=e[14],Ie=e[15],Be=f[0],Le=f[1],Fe=f[2],Oe=f[3];return d[0]=Be*m+Le*I+Fe*U+Oe*ae,d[1]=Be*y+Le*P+Fe*j+Oe*pe,d[2]=Be*b+Le*L+Fe*H+Oe*ve,d[3]=Be*M+Le*N+Fe*ne+Oe*Ie,d[4]=(Be=f[4])*m+(Le=f[5])*I+(Fe=f[6])*U+(Oe=f[7])*ae,d[5]=Be*y+Le*P+Fe*j+Oe*pe,d[6]=Be*b+Le*L+Fe*H+Oe*ve,d[7]=Be*M+Le*N+Fe*ne+Oe*Ie,d[8]=(Be=f[8])*m+(Le=f[9])*I+(Fe=f[10])*U+(Oe=f[11])*ae,d[9]=Be*y+Le*P+Fe*j+Oe*pe,d[10]=Be*b+Le*L+Fe*H+Oe*ve,d[11]=Be*M+Le*N+Fe*ne+Oe*Ie,d[12]=(Be=f[12])*m+(Le=f[13])*I+(Fe=f[14])*U+(Oe=f[15])*ae,d[13]=Be*y+Le*P+Fe*j+Oe*pe,d[14]=Be*b+Le*L+Fe*H+Oe*ve,d[15]=Be*M+Le*N+Fe*ne+Oe*Ie,d}function ps(d,e,f){var m,y,b,M,I,P,L,N,U,j,H,ne,ae=f[0],pe=f[1],ve=f[2];return e===d?(d[12]=e[0]*ae+e[4]*pe+e[8]*ve+e[12],d[13]=e[1]*ae+e[5]*pe+e[9]*ve+e[13],d[14]=e[2]*ae+e[6]*pe+e[10]*ve+e[14],d[15]=e[3]*ae+e[7]*pe+e[11]*ve+e[15]):(y=e[1],b=e[2],M=e[3],I=e[4],P=e[5],L=e[6],N=e[7],U=e[8],j=e[9],H=e[10],ne=e[11],d[0]=m=e[0],d[1]=y,d[2]=b,d[3]=M,d[4]=I,d[5]=P,d[6]=L,d[7]=N,d[8]=U,d[9]=j,d[10]=H,d[11]=ne,d[12]=m*ae+I*pe+U*ve+e[12],d[13]=y*ae+P*pe+j*ve+e[13],d[14]=b*ae+L*pe+H*ve+e[14],d[15]=M*ae+N*pe+ne*ve+e[15]),d}function Co(d,e,f){var m=f[0],y=f[1],b=f[2];return d[0]=e[0]*m,d[1]=e[1]*m,d[2]=e[2]*m,d[3]=e[3]*m,d[4]=e[4]*y,d[5]=e[5]*y,d[6]=e[6]*y,d[7]=e[7]*y,d[8]=e[8]*b,d[9]=e[9]*b,d[10]=e[10]*b,d[11]=e[11]*b,d[12]=e[12],d[13]=e[13],d[14]=e[14],d[15]=e[15],d}function Rh(d,e,f){var m=Math.sin(f),y=Math.cos(f),b=e[4],M=e[5],I=e[6],P=e[7],L=e[8],N=e[9],U=e[10],j=e[11];return e!==d&&(d[0]=e[0],d[1]=e[1],d[2]=e[2],d[3]=e[3],d[12]=e[12],d[13]=e[13],d[14]=e[14],d[15]=e[15]),d[4]=b*y+L*m,d[5]=M*y+N*m,d[6]=I*y+U*m,d[7]=P*y+j*m,d[8]=L*y-b*m,d[9]=N*y-M*m,d[10]=U*y-I*m,d[11]=j*y-P*m,d}function Lh(d,e,f){var m=Math.sin(f),y=Math.cos(f),b=e[0],M=e[1],I=e[2],P=e[3],L=e[8],N=e[9],U=e[10],j=e[11];return e!==d&&(d[4]=e[4],d[5]=e[5],d[6]=e[6],d[7]=e[7],d[12]=e[12],d[13]=e[13],d[14]=e[14],d[15]=e[15]),d[0]=b*y-L*m,d[1]=M*y-N*m,d[2]=I*y-U*m,d[3]=P*y-j*m,d[8]=b*m+L*y,d[9]=M*m+N*y,d[10]=I*m+U*y,d[11]=P*m+j*y,d}Math.hypot||(Math.hypot=function(){for(var d=0,e=arguments.length;e--;)d+=arguments[e]*arguments[e];return Math.sqrt(d)});var ep=Bh;function zh(){var d=new Jr(3);return Jr!=Float32Array&&(d[0]=0,d[1]=0,d[2]=0),d}function ju(d){var e=new Jr(3);return e[0]=d[0],e[1]=d[1],e[2]=d[2],e}function Gu(d){return Math.hypot(d[0],d[1],d[2])}function sl(d,e,f){var m=new Jr(3);return m[0]=d,m[1]=e,m[2]=f,m}function qu(d,e,f){return d[0]=e[0]+f[0],d[1]=e[1]+f[1],d[2]=e[2]+f[2],d}function Zu(d,e,f){return d[0]=e[0]-f[0],d[1]=e[1]-f[1],d[2]=e[2]-f[2],d}function Xu(d,e,f){return d[0]=e[0]*f[0],d[1]=e[1]*f[1],d[2]=e[2]*f[2],d}function Fh(d,e,f){return d[0]=Math.min(e[0],f[0]),d[1]=Math.min(e[1],f[1]),d[2]=Math.min(e[2],f[2]),d}function Oh(d,e,f){return d[0]=Math.max(e[0],f[0]),d[1]=Math.max(e[1],f[1]),d[2]=Math.max(e[2],f[2]),d}function al(d,e,f){return d[0]=e[0]*f,d[1]=e[1]*f,d[2]=e[2]*f,d}function Nh(d,e,f,m){return d[0]=e[0]+f[0]*m,d[1]=e[1]+f[1]*m,d[2]=e[2]+f[2]*m,d}function ll(d,e){var f=e[0],m=e[1],y=e[2],b=f*f+m*m+y*y;return b>0&&(b=1/Math.sqrt(b)),d[0]=e[0]*b,d[1]=e[1]*b,d[2]=e[2]*b,d}function cl(d,e){return d[0]*e[0]+d[1]*e[1]+d[2]*e[2]}function Yu(d,e,f){var m=e[0],y=e[1],b=e[2],M=f[0],I=f[1],P=f[2];return d[0]=y*P-b*I,d[1]=b*M-m*P,d[2]=m*I-y*M,d}function ms(d,e,f){var m=e[0],y=e[1],b=e[2],M=f[3]*m+f[7]*y+f[11]*b+f[15];return d[0]=(f[0]*m+f[4]*y+f[8]*b+f[12])/(M=M||1),d[1]=(f[1]*m+f[5]*y+f[9]*b+f[13])/M,d[2]=(f[2]*m+f[6]*y+f[10]*b+f[14])/M,d}function Wu(d,e,f){var m=f[0],y=f[1],b=f[2],M=e[0],I=e[1],P=e[2],L=y*P-b*I,N=b*M-m*P,U=m*I-y*M,j=y*U-b*N,H=b*L-m*U,ne=m*N-y*L,ae=2*f[3];return N*=ae,U*=ae,H*=2,ne*=2,d[0]=M+(L*=ae)+(j*=2),d[1]=I+N+H,d[2]=P+U+ne,d}var hl,na=Zu,tp=Xu,ip=Gu;function oa(d,e,f){var m=e[0],y=e[1],b=e[2],M=e[3];return d[0]=f[0]*m+f[4]*y+f[8]*b+f[12]*M,d[1]=f[1]*m+f[5]*y+f[9]*b+f[13]*M,d[2]=f[2]*m+f[6]*y+f[10]*b+f[14]*M,d[3]=f[3]*m+f[7]*y+f[11]*b+f[15]*M,d}function Hu(){var d=new Jr(4);return Jr!=Float32Array&&(d[0]=0,d[1]=0,d[2]=0),d[3]=1,d}function Ku(d){return d[0]=0,d[1]=0,d[2]=0,d[3]=1,d}function Ju(d,e,f){f*=.5;var m=e[0],y=e[1],b=e[2],M=e[3],I=Math.sin(f),P=Math.cos(f);return d[0]=m*P+M*I,d[1]=y*P+b*I,d[2]=b*P-y*I,d[3]=M*P-m*I,d}zh(),hl=new Jr(4),Jr!=Float32Array&&(hl[0]=0,hl[1]=0,hl[2]=0,hl[3]=0),zh(),sl(1,0,0),sl(0,1,0),Hu(),Hu(),Vu();class $h{constructor(e,f){this.points=e,this.planes=f}static fromInvProjectionMatrix(e,f,m,y){const b=Math.pow(2,m),M=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(P=>{const L=oa([],P,e),N=1/L[3]/f*b;return function(U,j,H){return U[0]=j[0]*H[0],U[1]=j[1]*H[1],U[2]=j[2]*H[2],U[3]=j[3]*H[3],U}(L,L,[N,N,y?1/L[3]:N,N])}),I=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(P=>{const L=ll([],Yu([],na([],M[P[0]],M[P[1]]),na([],M[P[2]],M[P[1]]))),N=-cl(L,M[P[1]]);return L.concat(N)});return new $h(M,I)}}class un{constructor(e,f){this.min=e,this.max=f,this.center=al([],qu([],this.min,this.max),.5)}quadrant(e){const f=[e%2==0,e<2],m=ju(this.min),y=ju(this.max);for(let b=0;b<f.length;b++)m[b]=f[b]?this.min[b]:this.center[b],y[b]=f[b]?this.center[b]:this.max[b];return y[2]=this.max[2],new un(m,y)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,f=this.max;return[[e[0],e[1],e[2]],[f[0],e[1],e[2]],[f[0],f[1],e[2]],[e[0],f[1],e[2]],[e[0],e[1],f[2]],[f[0],e[1],f[2]],[f[0],f[1],f[2]],[e[0],f[1],f[2]]]}intersects(e){const f=this.getCorners();let m=!0;for(let y=0;y<e.planes.length;y++){const b=e.planes[y];let M=0;for(let I=0;I<f.length;I++)M+=cl(b,f[I])+b[3]>=0;if(M===0)return 0;M!==f.length&&(m=!1)}if(m)return 2;for(let y=0;y<3;y++){let b=Number.MAX_VALUE,M=-Number.MAX_VALUE;for(let I=0;I<e.points.length;I++){const P=e.points[I][y]-this.min[y];b=Math.min(b,P),M=Math.max(M,P)}if(M<0||b>this.max[y]-this.min[y])return 0}return 1}}function Qu(d,e,f,m,y,b,M,I,P){if(b&&d.queryGeometry.isAboveHorizon)return!1;b&&(P*=d.pixelToTileUnitsFactor);for(const L of e)for(const N of L){const U=N.add(I),j=y&&f.elevation?f.elevation.exaggeration()*y.getElevationAt(U.x,U.y,!0):0,H=b?U:rp(U,j,m),ne=b?d.tilespaceRays.map(pe=>op(pe,j)):d.queryGeometry.screenGeometry,ae=oa([],[N.x,N.y,j,1],m);if(!M&&b?P*=ae[3]/f.cameraToCenterDistance:M&&!b&&(P*=f.cameraToCenterDistance/ae[3]),Yf(ne,H,P))return!0}return!1}function rp(d,e,f){const m=oa([],[d.x,d.y,e,1],f);return new z(m[0]/m[3],m[1]/m[3])}const ed=sl(0,0,0),np=sl(0,0,1);function op(d,e){const f=zh();return ed[2]=e,d.intersectsPlane(ed,np,f),new z(f[0],f[1])}class td extends Ch{}function id(d,{width:e,height:f},m,y){if(y){if(y instanceof Uint8ClampedArray)y=new Uint8Array(y.buffer);else if(y.length!==e*f*m)throw new RangeError("mismatched image size")}else y=new Uint8Array(e*f*m);return d.width=e,d.height=f,d.data=y,d}function rd(d,e,f){const{width:m,height:y}=e;m===d.width&&y===d.height||(Uh(d,e,{x:0,y:0},{x:0,y:0},{width:Math.min(d.width,m),height:Math.min(d.height,y)},f),d.width=m,d.height=y,d.data=e.data)}function Uh(d,e,f,m,y,b){if(y.width===0||y.height===0)return e;if(y.width>d.width||y.height>d.height||f.x>d.width-y.width||f.y>d.height-y.height)throw new RangeError("out of range source coordinates for image copy");if(y.width>e.width||y.height>e.height||m.x>e.width-y.width||m.y>e.height-y.height)throw new RangeError("out of range destination coordinates for image copy");const M=d.data,I=e.data;for(let P=0;P<y.height;P++){const L=((f.y+P)*d.width+f.x)*b,N=((m.y+P)*e.width+m.x)*b;for(let U=0;U<y.width*b;U++)I[N+U]=M[L+U]}return e}Mt(td,"HeatmapBucket",{omit:["layers"]});class oo{constructor(e,f){id(this,e,1,f)}resize(e){rd(this,new oo(e),1)}clone(){return new oo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,f,m,y,b){Uh(e,f,m,y,b,1)}}class Qr{constructor(e,f){id(this,e,4,f)}resize(e){rd(this,new Qr(e),4)}replace(e,f){f?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Qr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,f,m,y,b){Uh(e,f,m,y,b,4)}}Mt(oo,"AlphaImage"),Mt(Qr,"RGBAImage");var sp={paint:new te({"heatmap-radius":new F($e.paint_heatmap["heatmap-radius"]),"heatmap-weight":new F($e.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new B($e.paint_heatmap["heatmap-intensity"]),"heatmap-color":new X($e.paint_heatmap["heatmap-color"]),"heatmap-opacity":new B($e.paint_heatmap["heatmap-opacity"])})};function Vh(d){const e={},f=d.resolution||256,m=d.clips?d.clips.length:1,y=d.image||new Qr({width:f,height:m}),b=(M,I,P)=>{e[d.evaluationKey]=P;const L=d.expression.evaluate(e);y.data[M+I+0]=Math.floor(255*L.r/L.a),y.data[M+I+1]=Math.floor(255*L.g/L.a),y.data[M+I+2]=Math.floor(255*L.b/L.a),y.data[M+I+3]=Math.floor(255*L.a)};if(d.clips)for(let M=0,I=0;M<m;++M,I+=4*f)for(let P=0,L=0;P<f;P++,L+=4){const N=P/(f-1),{start:U,end:j}=d.clips[M];b(I,L,U*(1-N)+j*N)}else for(let M=0,I=0;M<f;M++,I+=4)b(0,I,M/(f-1));return y}var ap={paint:new te({"hillshade-illumination-direction":new B($e.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new B($e.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new B($e.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new B($e.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new B($e.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new B($e.paint_hillshade["hillshade-accent-color"])})};const lp=Se([{name:"a_pos",components:2,type:"Int16"}],4),{members:cp}=lp;var Lc=zc,hp=zc;function zc(d,e,f){f=f||2;var m,y,b,M,I,P,L,N=e&&e.length,U=N?e[0]*f:d.length,j=nd(d,0,U,f,!0),H=[];if(!j||j.next===j.prev)return H;if(N&&(j=function(ae,pe,ve,Ie){var Be,Le,Fe,Oe=[];for(Be=0,Le=pe.length;Be<Le;Be++)(Fe=nd(ae,pe[Be]*Ie,Be<Le-1?pe[Be+1]*Ie:ae.length,Ie,!1))===Fe.next&&(Fe.steiner=!0),Oe.push(yp(Fe));for(Oe.sort(mp),Be=0;Be<Oe.length;Be++)ve=ko(ve=gp(Oe[Be],ve),ve.next);return ve}(d,e,j,f)),d.length>80*f){m=b=d[0],y=M=d[1];for(var ne=f;ne<U;ne+=f)(I=d[ne])<m&&(m=I),(P=d[ne+1])<y&&(y=P),I>b&&(b=I),P>M&&(M=P);L=(L=Math.max(b-m,M-y))!==0?1/L:0}return ul(j,H,f,m,y,L),H}function nd(d,e,f,m,y){var b,M;if(y===qh(d,e,f,m)>0)for(b=e;b<f;b+=m)M=ad(b,d[b],d[b+1],M);else for(b=f-m;b>=e;b-=m)M=ad(b,d[b],d[b+1],M);return M&&Fc(M,M.next)&&(fl(M),M=M.next),M}function ko(d,e){if(!d)return d;e||(e=d);var f,m=d;do if(f=!1,m.steiner||!Fc(m,m.next)&&or(m.prev,m,m.next)!==0)m=m.next;else{if(fl(m),(m=e=m.prev)===m.next)break;f=!0}while(f||m!==e);return e}function ul(d,e,f,m,y,b,M){if(d){!M&&b&&function(N,U,j,H){var ne=N;do ne.z===null&&(ne.z=jh(ne.x,ne.y,U,j,H)),ne.prevZ=ne.prev,ne.nextZ=ne.next,ne=ne.next;while(ne!==N);ne.prevZ.nextZ=null,ne.prevZ=null,function(ae){var pe,ve,Ie,Be,Le,Fe,Oe,Xe,We=1;do{for(ve=ae,ae=null,Le=null,Fe=0;ve;){for(Fe++,Ie=ve,Oe=0,pe=0;pe<We&&(Oe++,Ie=Ie.nextZ);pe++);for(Xe=We;Oe>0||Xe>0&&Ie;)Oe!==0&&(Xe===0||!Ie||ve.z<=Ie.z)?(Be=ve,ve=ve.nextZ,Oe--):(Be=Ie,Ie=Ie.nextZ,Xe--),Le?Le.nextZ=Be:ae=Be,Be.prevZ=Le,Le=Be;ve=Ie}Le.nextZ=null,We*=2}while(Fe>1)}(ne)}(d,m,y,b);for(var I,P,L=d;d.prev!==d.next;)if(I=d.prev,P=d.next,b?dp(d,m,y,b):up(d))e.push(I.i/f),e.push(d.i/f),e.push(P.i/f),fl(d),d=P.next,L=P.next;else if((d=P)===L){M?M===1?ul(d=fp(ko(d),e,f),e,f,m,y,b,2):M===2&&pp(d,e,f,m,y,b):ul(ko(d),e,f,m,y,b,1);break}}}function up(d){var e=d.prev,f=d,m=d.next;if(or(e,f,m)>=0)return!1;for(var y=d.next.next;y!==d.prev;){if(sa(e.x,e.y,f.x,f.y,m.x,m.y,y.x,y.y)&&or(y.prev,y,y.next)>=0)return!1;y=y.next}return!0}function dp(d,e,f,m){var y=d.prev,b=d,M=d.next;if(or(y,b,M)>=0)return!1;for(var I=y.x>b.x?y.x>M.x?y.x:M.x:b.x>M.x?b.x:M.x,P=y.y>b.y?y.y>M.y?y.y:M.y:b.y>M.y?b.y:M.y,L=jh(y.x<b.x?y.x<M.x?y.x:M.x:b.x<M.x?b.x:M.x,y.y<b.y?y.y<M.y?y.y:M.y:b.y<M.y?b.y:M.y,e,f,m),N=jh(I,P,e,f,m),U=d.prevZ,j=d.nextZ;U&&U.z>=L&&j&&j.z<=N;){if(U!==d.prev&&U!==d.next&&sa(y.x,y.y,b.x,b.y,M.x,M.y,U.x,U.y)&&or(U.prev,U,U.next)>=0||(U=U.prevZ,j!==d.prev&&j!==d.next&&sa(y.x,y.y,b.x,b.y,M.x,M.y,j.x,j.y)&&or(j.prev,j,j.next)>=0))return!1;j=j.nextZ}for(;U&&U.z>=L;){if(U!==d.prev&&U!==d.next&&sa(y.x,y.y,b.x,b.y,M.x,M.y,U.x,U.y)&&or(U.prev,U,U.next)>=0)return!1;U=U.prevZ}for(;j&&j.z<=N;){if(j!==d.prev&&j!==d.next&&sa(y.x,y.y,b.x,b.y,M.x,M.y,j.x,j.y)&&or(j.prev,j,j.next)>=0)return!1;j=j.nextZ}return!0}function fp(d,e,f){var m=d;do{var y=m.prev,b=m.next.next;!Fc(y,b)&&od(y,m,m.next,b)&&dl(y,b)&&dl(b,y)&&(e.push(y.i/f),e.push(m.i/f),e.push(b.i/f),fl(m),fl(m.next),m=d=b),m=m.next}while(m!==d);return ko(m)}function pp(d,e,f,m,y,b){var M=d;do{for(var I=M.next.next;I!==M.prev;){if(M.i!==I.i&&xp(M,I)){var P=sd(M,I);return M=ko(M,M.next),P=ko(P,P.next),ul(M,e,f,m,y,b),void ul(P,e,f,m,y,b)}I=I.next}M=M.next}while(M!==d)}function mp(d,e){return d.x-e.x}function gp(d,e){var f=function(b,M){var I,P=M,L=b.x,N=b.y,U=-1/0;do{if(N<=P.y&&N>=P.next.y&&P.next.y!==P.y){var j=P.x+(N-P.y)*(P.next.x-P.x)/(P.next.y-P.y);if(j<=L&&j>U){if(U=j,j===L){if(N===P.y)return P;if(N===P.next.y)return P.next}I=P.x<P.next.x?P:P.next}}P=P.next}while(P!==M);if(!I)return null;if(L===U)return I;var H,ne=I,ae=I.x,pe=I.y,ve=1/0;P=I;do L>=P.x&&P.x>=ae&&L!==P.x&&sa(N<pe?L:U,N,ae,pe,N<pe?U:L,N,P.x,P.y)&&(H=Math.abs(N-P.y)/(L-P.x),dl(P,b)&&(H<ve||H===ve&&(P.x>I.x||P.x===I.x&&_p(I,P)))&&(I=P,ve=H)),P=P.next;while(P!==ne);return I}(d,e);if(!f)return e;var m=sd(f,d),y=ko(f,f.next);return ko(m,m.next),e===f?y:e}function _p(d,e){return or(d.prev,d,e.prev)<0&&or(e.next,d,d.next)<0}function jh(d,e,f,m,y){return(d=1431655765&((d=858993459&((d=252645135&((d=16711935&((d=32767*(d-f)*y)|d<<8))|d<<4))|d<<2))|d<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-m)*y)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function yp(d){var e=d,f=d;do(e.x<f.x||e.x===f.x&&e.y<f.y)&&(f=e),e=e.next;while(e!==d);return f}function sa(d,e,f,m,y,b,M,I){return(y-M)*(e-I)-(d-M)*(b-I)>=0&&(d-M)*(m-I)-(f-M)*(e-I)>=0&&(f-M)*(b-I)-(y-M)*(m-I)>=0}function xp(d,e){return d.next.i!==e.i&&d.prev.i!==e.i&&!function(f,m){var y=f;do{if(y.i!==f.i&&y.next.i!==f.i&&y.i!==m.i&&y.next.i!==m.i&&od(y,y.next,f,m))return!0;y=y.next}while(y!==f);return!1}(d,e)&&(dl(d,e)&&dl(e,d)&&function(f,m){var y=f,b=!1,M=(f.x+m.x)/2,I=(f.y+m.y)/2;do y.y>I!=y.next.y>I&&y.next.y!==y.y&&M<(y.next.x-y.x)*(I-y.y)/(y.next.y-y.y)+y.x&&(b=!b),y=y.next;while(y!==f);return b}(d,e)&&(or(d.prev,d,e.prev)||or(d,e.prev,e))||Fc(d,e)&&or(d.prev,d,d.next)>0&&or(e.prev,e,e.next)>0)}function or(d,e,f){return(e.y-d.y)*(f.x-e.x)-(e.x-d.x)*(f.y-e.y)}function Fc(d,e){return d.x===e.x&&d.y===e.y}function od(d,e,f,m){var y=Nc(or(d,e,f)),b=Nc(or(d,e,m)),M=Nc(or(f,m,d)),I=Nc(or(f,m,e));return y!==b&&M!==I||!(y!==0||!Oc(d,f,e))||!(b!==0||!Oc(d,m,e))||!(M!==0||!Oc(f,d,m))||!(I!==0||!Oc(f,e,m))}function Oc(d,e,f){return e.x<=Math.max(d.x,f.x)&&e.x>=Math.min(d.x,f.x)&&e.y<=Math.max(d.y,f.y)&&e.y>=Math.min(d.y,f.y)}function Nc(d){return d>0?1:d<0?-1:0}function dl(d,e){return or(d.prev,d,d.next)<0?or(d,e,d.next)>=0&&or(d,d.prev,e)>=0:or(d,e,d.prev)<0||or(d,d.next,e)<0}function sd(d,e){var f=new Gh(d.i,d.x,d.y),m=new Gh(e.i,e.x,e.y),y=d.next,b=e.prev;return d.next=e,e.prev=d,f.next=y,y.prev=f,m.next=f,f.prev=m,b.next=m,m.prev=b,m}function ad(d,e,f,m){var y=new Gh(d,e,f);return m?(y.next=m.next,y.prev=m,m.next.prev=y,m.next=y):(y.prev=y,y.next=y),y}function fl(d){d.next.prev=d.prev,d.prev.next=d.next,d.prevZ&&(d.prevZ.nextZ=d.nextZ),d.nextZ&&(d.nextZ.prevZ=d.prevZ)}function Gh(d,e,f){this.i=d,this.x=e,this.y=f,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function qh(d,e,f,m){for(var y=0,b=e,M=f-m;b<f;b+=m)y+=(d[M]-d[b])*(d[b+1]+d[M+1]),M=b;return y}function vp(d,e,f,m,y){ld(d,e,f||0,m||d.length-1,y||bp)}function ld(d,e,f,m,y){for(;m>f;){if(m-f>600){var b=m-f+1,M=e-f+1,I=Math.log(b),P=.5*Math.exp(2*I/3),L=.5*Math.sqrt(I*P*(b-P)/b)*(M-b/2<0?-1:1);ld(d,e,Math.max(f,Math.floor(e-M*P/b+L)),Math.min(m,Math.floor(e+(b-M)*P/b+L)),y)}var N=d[e],U=f,j=m;for(pl(d,f,e),y(d[m],N)>0&&pl(d,f,m);U<j;){for(pl(d,U,j),U++,j--;y(d[U],N)<0;)U++;for(;y(d[j],N)>0;)j--}y(d[f],N)===0?pl(d,f,j):pl(d,++j,m),j<=e&&(f=j+1),e<=j&&(m=j-1)}}function pl(d,e,f){var m=d[e];d[e]=d[f],d[f]=m}function bp(d,e){return d<e?-1:d>e?1:0}function Zh(d,e){const f=d.length;if(f<=1)return[d];const m=[];let y,b;for(let M=0;M<f;M++){const I=pt(d[M]);I!==0&&(d[M].area=Math.abs(I),b===void 0&&(b=I<0),b===I<0?(y&&m.push(y),y=[d[M]]):y.push(d[M]))}if(y&&m.push(y),e>1)for(let M=0;M<m.length;M++)m[M].length<=e||(vp(m[M],e,1,m[M].length-1,wp),m[M]=m[M].slice(0,e));return m}function wp(d,e){return e.area-d.area}function Xh(d,e,f){const m=f.patternDependencies;let y=!1;for(const b of e){const M=b.paint.get(`${d}-pattern`);M.isConstant()||(y=!0);const I=M.constantOr(null);I&&(y=!0,m[I.to]=!0,m[I.from]=!0)}return y}function Yh(d,e,f,m,y){const b=y.patternDependencies;for(const M of e){const I=M.paint.get(`${d}-pattern`).value;if(I.kind!=="constant"){let P=I.evaluate({zoom:m-1},f,{},y.availableImages),L=I.evaluate({zoom:m},f,{},y.availableImages),N=I.evaluate({zoom:m+1},f,{},y.availableImages);P=P&&P.name?P.name:P,L=L&&L.name?L.name:L,N=N&&N.name?N.name:N,b[P]=!0,b[L]=!0,b[N]=!0,f.patterns[M.id]={min:P,mid:L,max:N}}}return f}zc.deviation=function(d,e,f,m){var y=e&&e.length,b=Math.abs(qh(d,0,y?e[0]*f:d.length,f));if(y)for(var M=0,I=e.length;M<I;M++)b-=Math.abs(qh(d,e[M]*f,M<I-1?e[M+1]*f:d.length,f));var P=0;for(M=0;M<m.length;M+=3){var L=m[M]*f,N=m[M+1]*f,U=m[M+2]*f;P+=Math.abs((d[L]-d[U])*(d[N+1]-d[L+1])-(d[L]-d[N])*(d[U+1]-d[L+1]))}return b===0&&P===0?0:Math.abs((P-b)/b)},zc.flatten=function(d){for(var e=d[0][0].length,f={vertices:[],holes:[],dimensions:e},m=0,y=0;y<d.length;y++){for(var b=0;b<d[y].length;b++)for(var M=0;M<e;M++)f.vertices.push(d[y][b][M]);y>0&&f.holes.push(m+=d[y-1].length)}return f},Lc.default=hp;class $c{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(f=>f.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Te,this.indexArray=new At,this.indexArray2=new ti,this.programConfigurations=new ds(e.layers,e.zoom),this.segments=new Qi,this.segments2=new Qi,this.stateDependentLayerIds=this.layers.filter(f=>f.isStateDependent()).map(f=>f.id),this.projection=e.projection}populate(e,f,m,y){this.hasPattern=Xh("fill",this.layers,f);const b=this.layers[0].layout.get("fill-sort-key"),M=[];for(const{feature:I,id:P,index:L,sourceLayerIndex:N}of e){const U=this.layers[0]._featureFilter.needGeometry,j=fs(I,U);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),j,m))continue;const H=b?b.evaluate(j,{},m,f.availableImages):void 0,ne={id:P,properties:I.properties,type:I.type,sourceLayerIndex:N,index:L,geometry:U?j.geometry:no(I,m,y),patterns:{},sortKey:H};M.push(ne)}b&&M.sort((I,P)=>I.sortKey-P.sortKey);for(const I of M){const{geometry:P,index:L,sourceLayerIndex:N}=I;if(this.hasPattern){const U=Yh("fill",this.layers,I,this.zoom,f);this.patternFeatures.push(U)}else this.addFeature(I,P,L,m,{},f.availableImages);f.featureIndex.insert(e[L].feature,P,L,N,this.index)}}update(e,f,m,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,f,this.stateDependentLayers,m,y)}addFeatures(e,f,m,y,b){for(const M of this.patternFeatures)this.addFeature(M,M.geometry,M.index,f,m,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,cp),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,f,m,y,b,M=[]){for(const I of Zh(f,500)){let P=0;for(const ne of I)P+=ne.length;const L=this.segments.prepareSegment(P,this.layoutVertexArray,this.indexArray),N=L.vertexLength,U=[],j=[];for(const ne of I){if(ne.length===0)continue;ne!==I[0]&&j.push(U.length/2);const ae=this.segments2.prepareSegment(ne.length,this.layoutVertexArray,this.indexArray2),pe=ae.vertexLength;this.layoutVertexArray.emplaceBack(ne[0].x,ne[0].y),this.indexArray2.emplaceBack(pe+ne.length-1,pe),U.push(ne[0].x),U.push(ne[0].y);for(let ve=1;ve<ne.length;ve++)this.layoutVertexArray.emplaceBack(ne[ve].x,ne[ve].y),this.indexArray2.emplaceBack(pe+ve-1,pe+ve),U.push(ne[ve].x),U.push(ne[ve].y);ae.vertexLength+=ne.length,ae.primitiveLength+=ne.length}const H=Lc(U,j);for(let ne=0;ne<H.length;ne+=3)this.indexArray.emplaceBack(N+H[ne],N+H[ne+1],N+H[ne+2]);L.vertexLength+=P,L.primitiveLength+=H.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,m,b,M,y)}}Mt($c,"FillBucket",{omit:["layers","patternFeatures"]});const Ep=new te({"fill-sort-key":new F($e.layout_fill["fill-sort-key"])});var Tp={paint:new te({"fill-antialias":new B($e.paint_fill["fill-antialias"]),"fill-opacity":new F($e.paint_fill["fill-opacity"]),"fill-color":new F($e.paint_fill["fill-color"]),"fill-outline-color":new F($e.paint_fill["fill-outline-color"]),"fill-translate":new B($e.paint_fill["fill-translate"]),"fill-translate-anchor":new B($e.paint_fill["fill-translate-anchor"]),"fill-pattern":new V($e.paint_fill["fill-pattern"])}),layout:Ep};const Mp=Se([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Sp=Se([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Ap=Se([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Ip}=Mp;var cd=aa;function aa(d,e,f,m,y){this.properties={},this.extent=f,this.type=0,this._pbf=d,this._geometry=-1,this._keys=m,this._values=y,d.readFields(Cp,this,e)}function Cp(d,e,f){d==1?e.id=f.readVarint():d==2?function(m,y){for(var b=m.readVarint()+m.pos;m.pos<b;){var M=y._keys[m.readVarint()],I=y._values[m.readVarint()];y.properties[M]=I}}(f,e):d==3?e.type=f.readVarint():d==4&&(e._geometry=f.pos)}function kp(d){for(var e,f,m=0,y=0,b=d.length,M=b-1;y<b;M=y++)m+=((f=d[M]).x-(e=d[y]).x)*(e.y+f.y);return m}aa.types=["Unknown","Point","LineString","Polygon"],aa.prototype.loadGeometry=function(){var d=this._pbf;d.pos=this._geometry;for(var e,f=d.readVarint()+d.pos,m=1,y=0,b=0,M=0,I=[];d.pos<f;){if(y<=0){var P=d.readVarint();m=7&P,y=P>>3}if(y--,m===1||m===2)b+=d.readSVarint(),M+=d.readSVarint(),m===1&&(e&&I.push(e),e=[]),e.push(new z(b,M));else{if(m!==7)throw new Error("unknown command "+m);e&&e.push(e[0].clone())}}return e&&I.push(e),I},aa.prototype.bbox=function(){var d=this._pbf;d.pos=this._geometry;for(var e=d.readVarint()+d.pos,f=1,m=0,y=0,b=0,M=1/0,I=-1/0,P=1/0,L=-1/0;d.pos<e;){if(m<=0){var N=d.readVarint();f=7&N,m=N>>3}if(m--,f===1||f===2)(y+=d.readSVarint())<M&&(M=y),y>I&&(I=y),(b+=d.readSVarint())<P&&(P=b),b>L&&(L=b);else if(f!==7)throw new Error("unknown command "+f)}return[M,P,I,L]},aa.prototype.toGeoJSON=function(d,e,f){var m,y,b=this.extent*Math.pow(2,f),M=this.extent*d,I=this.extent*e,P=this.loadGeometry(),L=aa.types[this.type];function N(H){for(var ne=0;ne<H.length;ne++){var ae=H[ne];H[ne]=[360*(ae.x+M)/b-180,360/Math.PI*Math.atan(Math.exp((180-360*(ae.y+I)/b)*Math.PI/180))-90]}}switch(this.type){case 1:var U=[];for(m=0;m<P.length;m++)U[m]=P[m][0];N(P=U);break;case 2:for(m=0;m<P.length;m++)N(P[m]);break;case 3:for(P=function(H){var ne=H.length;if(ne<=1)return[H];for(var ae,pe,ve=[],Ie=0;Ie<ne;Ie++){var Be=kp(H[Ie]);Be!==0&&(pe===void 0&&(pe=Be<0),pe===Be<0?(ae&&ve.push(ae),ae=[H[Ie]]):ae.push(H[Ie]))}return ae&&ve.push(ae),ve}(P),m=0;m<P.length;m++)for(y=0;y<P[m].length;y++)N(P[m][y])}P.length===1?P=P[0]:L="Multi"+L;var j={type:"Feature",geometry:{type:L,coordinates:P},properties:this.properties};return"id"in this&&(j.id=this.id),j};var hd=ud;function ud(d,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=d,this._keys=[],this._values=[],this._features=[],d.readFields(Dp,this,e),this.length=this._features.length}function Dp(d,e,f){d===15?e.version=f.readVarint():d===1?e.name=f.readString():d===5?e.extent=f.readVarint():d===2?e._features.push(f.pos):d===3?e._keys.push(f.readString()):d===4&&e._values.push(function(m){for(var y=null,b=m.readVarint()+m.pos;m.pos<b;){var M=m.readVarint()>>3;y=M===1?m.readString():M===2?m.readFloat():M===3?m.readDouble():M===4?m.readVarint64():M===5?m.readVarint():M===6?m.readSVarint():M===7?m.readBoolean():null}return y}(f))}function Pp(d,e,f){if(d===3){var m=new hd(f,f.readVarint()+f.pos);m.length&&(e[m.name]=m)}}ud.prototype.feature=function(d){if(d<0||d>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[d];var e=this._pbf.readVarint()+this._pbf.pos;return new cd(this._pbf,e,this.extent,this._keys,this._values)};var gs={VectorTile:function(d,e){this.layers=d.readFields(Pp,{},e)},VectorTileFeature:cd,VectorTileLayer:hd};function Uc(d,e,f,m){const y=[],b=m===0?(M,I,P,L,N,U)=>{M.push(new z(U,P+(U-I)/(L-I)*(N-P)))}:(M,I,P,L,N,U)=>{M.push(new z(I+(U-P)/(N-P)*(L-I),U))};for(const M of d){const I=[];for(const P of M){if(P.length<=2)continue;const L=[];for(let j=0;j<P.length-1;j++){const H=P[j].x,ne=P[j].y,ae=P[j+1].x,pe=P[j+1].y,ve=m===0?H:ne,Ie=m===0?ae:pe;ve<e?Ie>e&&b(L,H,ne,ae,pe,e):ve>f?Ie<f&&b(L,H,ne,ae,pe,f):L.push(P[j]),Ie<e&&ve>=e&&b(L,H,ne,ae,pe,e),Ie>f&&ve<=f&&b(L,H,ne,ae,pe,f)}let N=P[P.length-1];const U=m===0?N.x:N.y;U>=e&&U<=f&&L.push(N),L.length&&(N=L[L.length-1],L[0].x===N.x&&L[0].y===N.y||L.push(L[0]),I.push(L))}I.length&&y.push(I)}return y}const Bp=gs.VectorTileFeature.types,Rp=Math.pow(2,13);function ml(d,e,f,m,y,b,M,I){d.emplaceBack((e<<1)+M,(f<<1)+b,(Math.floor(m*Rp)<<1)+y,Math.round(I))}function gl(d,e,f){d.emplaceBack(e.x,e.y,e.z,f[0]*16384,f[1]*16384,f[2]*16384)}class dd{constructor(){this.acc=new z(0,0),this.polyCount=[]}startRing(e){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new z(e.x,e.y),this.max=new z(e.x,e.y))}append(e,f){this.currentPolyCount.edges++,this.acc._add(e);const m=this.min,y=this.max;e.x<m.x?m.x=e.x:e.x>y.x&&(y.x=e.x),e.y<m.y?m.y=e.y:e.y>y.y&&(y.y=e.y),((e.x===0||e.x===fi)&&e.x===f.x)!=((e.y===0||e.y===fi)&&e.y===f.y)&&this.processBorderOverlap(e,f),f.x<0!=e.x<0&&this.addBorderIntersection(0,Xt(f.y,e.y,(0-f.x)/(e.x-f.x))),f.x>fi!=e.x>fi&&this.addBorderIntersection(1,Xt(f.y,e.y,(fi-f.x)/(e.x-f.x))),f.y<0!=e.y<0&&this.addBorderIntersection(2,Xt(f.x,e.x,(0-f.y)/(e.y-f.y))),f.y>fi!=e.y>fi&&this.addBorderIntersection(3,Xt(f.x,e.x,(fi-f.y)/(e.y-f.y)))}addBorderIntersection(e,f){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const m=this.borders[e];f<m[0]&&(m[0]=f),f>m[1]&&(m[1]=f)}processBorderOverlap(e,f){if(e.x===f.x){if(e.y===f.y)return;const m=e.x===0?0:1;this.addBorderIntersection(m,f.y),this.addBorderIntersection(m,e.y)}else{const m=e.y===0?2:3;this.addBorderIntersection(m,f.x),this.addBorderIntersection(m,e.x)}}centroid(){const e=this.polyCount.reduce((f,m)=>f+m.edges,0);return e!==0?this.acc.div(e)._round():new z(0,0)}span(){return new z(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((e,f)=>e+ +(f[0]!==Number.MAX_VALUE),0)}}class _l{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(f=>f.id),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Ae,this.centroidVertexArray=new us,this.indexArray=new At,this.programConfigurations=new ds(e.layers,e.zoom),this.segments=new Qi,this.stateDependentLayerIds=this.layers.filter(f=>f.isStateDependent()).map(f=>f.id),this.enableTerrain=e.enableTerrain}populate(e,f,m,y){this.features=[],this.hasPattern=Xh("fill-extrusion",this.layers,f),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=function(b){const M=Math.exp(Math.PI*(1-b.y/(1<<b.z)*2));return 80150034*M/(M*M+1)/fi/(1<<b.z)}(m);for(const{feature:b,id:M,index:I,sourceLayerIndex:P}of e){const L=this.layers[0]._featureFilter.needGeometry,N=fs(b,L);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),N,m))continue;const U={id:M,sourceLayerIndex:P,index:I,geometry:L?N.geometry:no(b,m,y),properties:b.properties,type:b.type,patterns:{}},j=this.layoutVertexArray.length;this.hasPattern?this.features.push(Yh("fill-extrusion",this.layers,U,this.zoom,f)):this.addFeature(U,U.geometry,I,m,{},f.availableImages,y),f.featureIndex.insert(b,U.geometry,I,P,this.index,j)}this.sortBorders()}addFeatures(e,f,m,y,b){for(const M of this.features){const{geometry:I}=M;this.addFeature(M,I,M.index,f,m,y,b)}this.sortBorders()}update(e,f,m,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,f,this.stateDependentLayers,m,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Ip),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,Ap.members,!0))),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.centroidVertexArray.length!==0&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,Sp.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,f,m,y,b,M,I){const P=[new z(0,0),new z(fi,fi)],L=I.projection,N=L.name==="globe",U=this.enableTerrain&&!N?new dd:null;N&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Vr);const j=Zh(f,500);for(let ae=j.length-1;ae>=0;ae--){const pe=j[ae];(pe.length===0||(H=pe[0]).every(ve=>ve.x<=0)||H.every(ve=>ve.x>=fi)||H.every(ve=>ve.y<=0)||H.every(ve=>ve.y>=fi))&&j.splice(ae,1)}var H;let ne;if(N){const pe=1<<y.z,ve=mn(y.x/pe),Ie=mn((y.x+1)/pe),Be=wr(y.y/pe),Le=wr((y.y+1)/pe);ne=function(Fe,Oe,Xe,We,tt=0,nt){const qe=[];if(!Fe.length||!Xe||!We)return qe;const Qe=(ni,gi)=>{for(const Ot of ni)qe.push({polygon:Ot,bounds:gi})},st=Math.ceil(Math.log2(Xe)),mt=Math.ceil(Math.log2(We)),lt=st-mt,dt=[];for(let ni=0;ni<Math.abs(lt);ni++)dt.push(lt>0?0:1);for(let ni=0;ni<Math.min(st,mt);ni++)dt.push(0),dt.push(1);let ri=Fe;if(ri=Uc(ri,Oe[0].y-tt,Oe[1].y+tt,1),ri=Uc(ri,Oe[0].x-tt,Oe[1].x+tt,0),!ri.length)return qe;const vi=[];for(dt.length?vi.push({polygons:ri,bounds:Oe,depth:0}):Qe(ri,Oe);vi.length;){const ni=vi.pop(),gi=ni.depth,Ot=dt[gi],Et=ni.bounds[0],wi=ni.bounds[1],Bi=Ot===0?Et.x:Et.y,lr=Ot===0?wi.x:wi.y,Gi=nt?nt(Ot,Bi,lr):.5*(Bi+lr),cr=Uc(ni.polygons,Bi-tt,Gi+tt,Ot),Ri=Uc(ni.polygons,Gi-tt,lr+tt,Ot);if(cr.length){const Si=[Et,new z(Ot===0?Gi:wi.x,Ot===1?Gi:wi.y)];dt.length>gi+1?vi.push({polygons:cr,bounds:Si,depth:gi+1}):Qe(cr,Si)}if(Ri.length){const Si=[new z(Ot===0?Gi:Et.x,Ot===1?Gi:Et.y),wi];dt.length>gi+1?vi.push({polygons:Ri,bounds:Si,depth:gi+1}):Qe(Ri,Si)}}return qe}(j,P,Math.ceil((Ie-ve)/11.25),Math.ceil((Be-Le)/11.25),1,(Fe,Oe,Xe)=>{if(Fe===0)return .5*(Oe+Xe);{const We=wr((y.y+Oe/fi)/pe);return(ea(.5*(wr((y.y+Xe/fi)/pe)+We))*pe-y.y)*fi}})}else{ne=[];for(const ae of j)ne.push({polygon:ae,bounds:P})}for(const ae of ne){const pe=ae.polygon;let ve=0,Ie=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(let Xe=0;Xe<pe.length;Xe++){const We=pe[Xe];if(We.length===0)continue;ve+=We.length;let tt=0;U&&U.startRing(We[0]);for(let nt=0;nt<We.length;nt++){const qe=We[nt];if(nt>=1){const Qe=We[nt-1];if(!Lp(qe,Qe,ae.bounds)){U&&U.append(qe,Qe),Ie.vertexLength+4>Qi.MAX_VERTEX_ARRAY_LENGTH&&(Ie=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const st=qe.sub(Qe)._perp(),mt=st.x/(Math.abs(st.x)+Math.abs(st.y)),lt=st.y>0?1:0,dt=Qe.dist(qe);tt+dt>32768&&(tt=0),ml(this.layoutVertexArray,qe.x,qe.y,mt,lt,0,0,tt),ml(this.layoutVertexArray,qe.x,qe.y,mt,lt,0,1,tt),tt+=dt,ml(this.layoutVertexArray,Qe.x,Qe.y,mt,lt,0,0,tt),ml(this.layoutVertexArray,Qe.x,Qe.y,mt,lt,0,1,tt);const ri=Ie.vertexLength;if(this.indexArray.emplaceBack(ri,ri+2,ri+1),this.indexArray.emplaceBack(ri+1,ri+2,ri+3),Ie.vertexLength+=4,Ie.primitiveLength+=2,N){const vi=this.layoutVertexExtArray,ni=L.projectTilePoint(qe.x,qe.y,y),gi=L.projectTilePoint(Qe.x,Qe.y,y),Ot=L.upVector(y,qe.x,qe.y),Et=L.upVector(y,Qe.x,Qe.y);gl(vi,ni,Ot),gl(vi,ni,Ot),gl(vi,gi,Et),gl(vi,gi,Et)}}}}}if(Ie.vertexLength+ve>Qi.MAX_VERTEX_ARRAY_LENGTH&&(Ie=this.segments.prepareSegment(ve,this.layoutVertexArray,this.indexArray)),Bp[e.type]!=="Polygon")continue;const Be=[],Le=[],Fe=Ie.vertexLength;for(let Xe=0;Xe<pe.length;Xe++){const We=pe[Xe];if(We.length!==0){We!==pe[0]&&Le.push(Be.length/2);for(let tt=0;tt<We.length;tt++){const nt=We[tt];ml(this.layoutVertexArray,nt.x,nt.y,0,0,1,1,0),Be.push(nt.x),Be.push(nt.y),U&&U.currentPolyCount.top++,N&&gl(this.layoutVertexExtArray,L.projectTilePoint(nt.x,nt.y,y),L.upVector(y,nt.x,nt.y))}}}const Oe=Lc(Be,Le);for(let Xe=0;Xe<Oe.length;Xe+=3)this.indexArray.emplaceBack(Fe+Oe[Xe],Fe+Oe[Xe+2],Fe+Oe[Xe+1]);Ie.primitiveLength+=Oe.length/3,Ie.vertexLength+=ve}if(U&&U.polyCount.length>0){if(U.borders){U.vertexArrayOffset=this.centroidVertexArray.length;const ae=U.borders,pe=this.featuresOnBorder.push(U)-1;for(let ve=0;ve<4;ve++)ae[ve][0]!==Number.MAX_VALUE&&this.borders[ve].push(pe)}this.encodeCentroid(U.borders?void 0:U.centroid(),U)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,m,b,M,y)}sortBorders(){for(let e=0;e<4;e++)this.borders[e].sort((f,m)=>this.featuresOnBorder[f].borders[e][0]-this.featuresOnBorder[m].borders[e][0])}encodeCentroid(e,f,m=!0){let y,b;if(e)if(e.y!==0){const I=f.span()._mult(this.tileToMeter);y=(Math.max(e.x,1)<<3)+Math.min(7,Math.round(I.x/10)),b=(Math.max(e.y,1)<<3)+Math.min(7,Math.round(I.y/10))}else y=Math.ceil(7*(e.x+450)),b=0;else y=0,b=+m;let M=m?this.centroidVertexArray.length:f.vertexArrayOffset;for(const I of f.polyCount){m&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*I.edges+I.top);for(let P=0;P<2*I.edges;P++)this.centroidVertexArray.emplace(M++,0,b),this.centroidVertexArray.emplace(M++,y,b);for(let P=0;P<I.top;P++)this.centroidVertexArray.emplace(M++,y,b)}}}function Lp(d,e,f){return d.x===e.x&&(d.x<f[0].x||d.x>f[1].x)||d.y===e.y&&(d.y<f[0].y||d.y>f[1].y)}Mt(_l,"FillExtrusionBucket",{omit:["layers","features"]}),Mt(dd,"PartMetadata");var zp={paint:new te({"fill-extrusion-opacity":new B($e["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new F($e["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new B($e["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new B($e["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new V($e["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new F($e["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new F($e["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new B($e["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function yl(d,e){return d.x*e.x+d.y*e.y}function fd(d,e){if(d.length===1){let f=0;const m=e[f++];let y;for(;!y||m.equals(y);)if(y=e[f++],!y)return 1/0;for(;f<e.length;f++){const b=e[f],M=d[0],I=y.sub(m),P=b.sub(m),L=M.sub(m),N=yl(I,I),U=yl(I,P),j=yl(P,P),H=yl(L,I),ne=yl(L,P),ae=N*j-U*U,pe=(j*H-U*ne)/ae,ve=(N*ne-U*H)/ae,Ie=m.z*(1-pe-ve)+y.z*pe+b.z*ve;if(isFinite(Ie))return Ie}return 1/0}{let f=1/0;for(const m of e)f=Math.min(f,m.z);return f}}function pd(d){const e=new z(d[0],d[1]);return e.z=d[2],e}function Fp(d,e,f,m,y,b,M,I){const P=M*y.getElevationAt(d,e,!0,!0),L=b[0]!==0,N=L?b[1]===0?M*(b[0]/7-450):M*function(U,j,H){const ne=Math.floor(j[0]/8),ae=Math.floor(j[1]/8),pe=10*(j[0]-8*ne),ve=10*(j[1]-8*ae),Ie=U.getElevationAt(ne,ae,!0,!0),Be=U.getMeterToDEM(H),Le=Math.floor(.5*(pe*Be-1)),Fe=Math.floor(.5*(ve*Be-1)),Oe=U.tileCoordToPixel(ne,ae),Xe=2*Le+1,We=2*Fe+1,tt=function(lt,dt,ri,vi,ni){return[lt.getElevationAtPixel(dt,ri,!0),lt.getElevationAtPixel(dt+ni,ri,!0),lt.getElevationAtPixel(dt,ri+ni,!0),lt.getElevationAtPixel(dt+vi,ri+ni,!0)]}(U,Oe.x-Le,Oe.y-Fe,Xe,We),nt=Math.abs(tt[0]-tt[1]),qe=Math.abs(tt[2]-tt[3]),Qe=Math.abs(tt[0]-tt[2])+Math.abs(tt[1]-tt[3]),st=Math.min(.25,.5*Be*(nt+qe)/Xe),mt=Math.min(.25,.5*Be*Qe/We);return Ie+Math.max(st*pe,mt*ve)}(y,b,I):P;return{base:P+(f===0)?-1:f,top:L?Math.max(N+m,P+f+2):P+m}}const Op=Se([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:Np}=Op,$p=Se([{name:"a_packed",components:3,type:"Float32"}]),{members:Up}=$p,Vp=gs.VectorTileFeature.types,jp=Math.cos(Math.PI/180*37.5);class Vc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(f=>f.id),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(f=>{this.gradients[f.id]={}}),this.layoutVertexArray=new Ee,this.layoutVertexArray2=new ct,this.indexArray=new At,this.programConfigurations=new ds(e.layers,e.zoom),this.segments=new Qi,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(f=>f.isStateDependent()).map(f=>f.id)}populate(e,f,m,y){this.hasPattern=Xh("line",this.layers,f);const b=this.layers[0].layout.get("line-sort-key"),M=[];for(const{feature:N,id:U,index:j,sourceLayerIndex:H}of e){const ne=this.layers[0]._featureFilter.needGeometry,ae=fs(N,ne);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),ae,m))continue;const pe=b?b.evaluate(ae,{},m):void 0,ve={id:U,properties:N.properties,type:N.type,sourceLayerIndex:H,index:j,geometry:ne?ae.geometry:no(N,m,y),patterns:{},sortKey:pe};M.push(ve)}b&&M.sort((N,U)=>N.sortKey-U.sortKey);const{lineAtlas:I,featureIndex:P}=f,L=this.addConstantDashes(I);for(const N of M){const{geometry:U,index:j,sourceLayerIndex:H}=N;if(L&&this.addFeatureDashes(N,I),this.hasPattern){const ne=Yh("line",this.layers,N,this.zoom,f);this.patternFeatures.push(ne)}else this.addFeature(N,U,j,m,I.positions,f.availableImages);P.insert(e[j].feature,U,j,H,this.index)}}addConstantDashes(e){let f=!1;for(const m of this.layers){const y=m.paint.get("line-dasharray").value,b=m.layout.get("line-cap").value;if(y.kind!=="constant"||b.kind!=="constant")f=!0;else{const M=b.value,I=y.value;if(!I)continue;e.addDash(I.from,M),e.addDash(I.to,M),I.other&&e.addDash(I.other,M)}}return f}addFeatureDashes(e,f){const m=this.zoom;for(const y of this.layers){const b=y.paint.get("line-dasharray").value,M=y.layout.get("line-cap").value;if(b.kind==="constant"&&M.kind==="constant")continue;let I,P,L,N,U,j;if(b.kind==="constant"){const pe=b.value;if(!pe)continue;I=pe.other||pe.to,P=pe.to,L=pe.from}else I=b.evaluate({zoom:m-1},e),P=b.evaluate({zoom:m},e),L=b.evaluate({zoom:m+1},e);M.kind==="constant"?N=U=j=M.value:(N=M.evaluate({zoom:m-1},e),U=M.evaluate({zoom:m},e),j=M.evaluate({zoom:m+1},e)),f.addDash(I,N),f.addDash(P,U),f.addDash(L,j);const H=f.getKey(I,N),ne=f.getKey(P,U),ae=f.getKey(L,j);e.patterns[y.id]={min:H,mid:ne,max:ae}}}update(e,f,m,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,f,this.stateDependentLayers,m,y)}addFeatures(e,f,m,y,b){for(const M of this.patternFeatures)this.addFeature(M,M.geometry,M.index,f,m,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Up)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Np),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,f,m,y,b,M){const I=this.layers[0].layout,P=I.get("line-join").evaluate(e,{}),L=I.get("line-cap").evaluate(e,{}),N=I.get("line-miter-limit"),U=I.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const j of f)this.addLine(j,e,P,L,N,U);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,m,b,M,y)}addLine(e,f,m,y,b,M){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let ve=0;ve<e.length-1;ve++)this.totalDistance+=e[ve].dist(e[ve+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const I=Vp[f.type]==="Polygon";let P=e.length;for(;P>=2&&e[P-1].equals(e[P-2]);)P--;let L=0;for(;L<P-1&&e[L].equals(e[L+1]);)L++;if(P<(I?3:2))return;m==="bevel"&&(b=1.05);const N=this.overscaling<=16?122880/(512*this.overscaling):0,U=this.segments.prepareSegment(10*P,this.layoutVertexArray,this.indexArray);let j,H,ne,ae,pe;this.e1=this.e2=-1,I&&(j=e[P-2],pe=e[L].sub(j)._unit()._perp());for(let ve=L;ve<P;ve++){if(ne=ve===P-1?I?e[L+1]:void 0:e[ve+1],ne&&e[ve].equals(ne))continue;pe&&(ae=pe),j&&(H=j),j=e[ve],pe=ne?ne.sub(j)._unit()._perp():ae,ae=ae||pe;let Ie=ae.add(pe);Ie.x===0&&Ie.y===0||Ie._unit();const Be=ae.x*pe.x+ae.y*pe.y,Le=Ie.x*pe.x+Ie.y*pe.y,Fe=Le!==0?1/Le:1/0,Oe=2*Math.sqrt(2-2*Le),Xe=Le<jp&&H&&ne,We=ae.x*pe.y-ae.y*pe.x>0;if(Xe&&ve>L){const qe=j.dist(H);if(qe>2*N){const Qe=j.sub(j.sub(H)._mult(N/qe)._round());this.updateDistance(H,Qe),this.addCurrentVertex(Qe,ae,0,0,U),H=Qe}}const tt=H&&ne;let nt=tt?m:I?"butt":y;if(tt&&nt==="round"&&(Fe<M?nt="miter":Fe<=2&&(nt="fakeround")),nt==="miter"&&Fe>b&&(nt="bevel"),nt==="bevel"&&(Fe>2&&(nt="flipbevel"),Fe<b&&(nt="miter")),H&&this.updateDistance(H,j),nt==="miter")Ie._mult(Fe),this.addCurrentVertex(j,Ie,0,0,U);else if(nt==="flipbevel"){if(Fe>100)Ie=pe.mult(-1);else{const qe=Fe*ae.add(pe).mag()/ae.sub(pe).mag();Ie._perp()._mult(qe*(We?-1:1))}this.addCurrentVertex(j,Ie,0,0,U),this.addCurrentVertex(j,Ie.mult(-1),0,0,U)}else if(nt==="bevel"||nt==="fakeround"){const qe=-Math.sqrt(Fe*Fe-1),Qe=We?qe:0,st=We?0:qe;if(H&&this.addCurrentVertex(j,ae,Qe,st,U),nt==="fakeround"){const mt=Math.round(180*Oe/Math.PI/20);for(let lt=1;lt<mt;lt++){let dt=lt/mt;if(dt!==.5){const vi=dt-.5;dt+=dt*vi*(dt-1)*((1.0904+Be*(Be*(3.55645-1.43519*Be)-3.2452))*vi*vi+(.848013+Be*(.215638*Be-1.06021)))}const ri=pe.sub(ae)._mult(dt)._add(ae)._unit()._mult(We?-1:1);this.addHalfVertex(j,ri.x,ri.y,!1,We,0,U)}}ne&&this.addCurrentVertex(j,pe,-Qe,-st,U)}else if(nt==="butt")this.addCurrentVertex(j,Ie,0,0,U);else if(nt==="square"){const qe=H?1:-1;H||this.addCurrentVertex(j,Ie,qe,qe,U),this.addCurrentVertex(j,Ie,0,0,U),H&&this.addCurrentVertex(j,Ie,qe,qe,U)}else nt==="round"&&(H&&(this.addCurrentVertex(j,ae,0,0,U),this.addCurrentVertex(j,ae,1,1,U,!0)),ne&&(this.addCurrentVertex(j,pe,-1,-1,U,!0),this.addCurrentVertex(j,pe,0,0,U)));if(Xe&&ve<P-1){const qe=j.dist(ne);if(qe>2*N){const Qe=j.add(ne.sub(j)._mult(N/qe)._round());this.updateDistance(j,Qe),this.addCurrentVertex(Qe,pe,0,0,U),j=Qe}}}}addCurrentVertex(e,f,m,y,b,M=!1){const I=f.y*y-f.x,P=-f.y-f.x*y;this.addHalfVertex(e,f.x+f.y*m,f.y-f.x*m,M,!1,m,b),this.addHalfVertex(e,I,P,M,!0,-y,b)}addHalfVertex({x:e,y:f},m,y,b,M,I,P){this.layoutVertexArray.emplaceBack((e<<1)+(b?1:0),(f<<1)+(M?1:0),Math.round(63*m)+128,Math.round(63*y)+128,1+(I===0?0:I<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineSoFar);const L=P.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,L),P.primitiveLength++),M?this.e2=L:this.e1=L}updateScaledDistance(){if(this.lineClips){const e=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(e,f){this.distance+=e.dist(f),this.updateScaledDistance()}}Mt(Vc,"LineBucket",{omit:["layers","patternFeatures"]});const Gp=new te({"line-cap":new F($e.layout_line["line-cap"]),"line-join":new F($e.layout_line["line-join"]),"line-miter-limit":new B($e.layout_line["line-miter-limit"]),"line-round-limit":new B($e.layout_line["line-round-limit"]),"line-sort-key":new F($e.layout_line["line-sort-key"])});var md={paint:new te({"line-opacity":new F($e.paint_line["line-opacity"]),"line-color":new F($e.paint_line["line-color"]),"line-translate":new B($e.paint_line["line-translate"]),"line-translate-anchor":new B($e.paint_line["line-translate-anchor"]),"line-width":new F($e.paint_line["line-width"]),"line-gap-width":new F($e.paint_line["line-gap-width"]),"line-offset":new F($e.paint_line["line-offset"]),"line-blur":new F($e.paint_line["line-blur"]),"line-dasharray":new V($e.paint_line["line-dasharray"]),"line-pattern":new V($e.paint_line["line-pattern"]),"line-gradient":new X($e.paint_line["line-gradient"])}),layout:Gp};const gd=new class extends F{possiblyEvaluate(d,e){return e=new ji(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,zoomHistory:e.zoomHistory,transition:e.transition}),super.possiblyEvaluate(d,e)}evaluate(d,e,f,m){return e=ue({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(d,e,f,m)}}(md.paint.properties["line-width"].specification);function _d(d,e){return e>0?e+2*d:d}gd.useIntegerZoom=!0;const qp=Se([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"},{name:"a_z_tile_anchor",components:4,type:"Int16"}],4),Zp=Se([{name:"a_projected_pos",components:3,type:"Float32"}],4);Se([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Xp=Se([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),Yp=Se([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);Se([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const yd=Se([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Wp=Se([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Se([{name:"triangle",components:3,type:"Uint16"}]),Se([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Se([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),Se([{type:"Float32",name:"offsetX"}]),Se([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var Er=24;const Vn=128;function Wh(d,e){const{expression:f}=e;if(f.kind==="constant")return{kind:"constant",layoutSize:f.evaluate(new ji(d+1))};if(f.kind==="source")return{kind:"source"};{const{zoomStops:m,interpolationType:y}=f;let b=0;for(;b<m.length&&m[b]<=d;)b++;b=Math.max(0,b-1);let M=b;for(;M<m.length&&m[M]<d+1;)M++;M=Math.min(m.length-1,M);const I=m[b],P=m[M];return f.kind==="composite"?{kind:"composite",minZoom:I,maxZoom:P,interpolationType:y}:{kind:"camera",minZoom:I,maxZoom:P,minSize:f.evaluate(new ji(I)),maxSize:f.evaluate(new ji(P)),interpolationType:y}}}function jc(d,{uSize:e,uSizeT:f},{lowerSize:m,upperSize:y}){return d.kind==="source"?m/Vn:d.kind==="composite"?Xt(m/Vn,y/Vn,f):e}function la(d,e){let f=0,m=0;if(d.kind==="constant")m=d.layoutSize;else if(d.kind!=="source"){const{interpolationType:y,minZoom:b,maxZoom:M}=d,I=y?_e(Nr.interpolationFactor(y,e,b,M),0,1):0;d.kind==="camera"?m=Xt(d.minSize,d.maxSize,I):f=I}return{uSizeT:f,uSize:m}}var Hp=Object.freeze({__proto__:null,getSizeData:Wh,evaluateSizeForFeature:jc,evaluateSizeForZoom:la,SIZE_PACK_FACTOR:Vn});function Kp(d,e,f){return d.sections.forEach(m=>{m.text=function(y,b,M){const I=b.layout.get("text-transform").evaluate(M,{});return I==="uppercase"?y=y.toLocaleUpperCase():I==="lowercase"&&(y=y.toLocaleLowerCase()),Hr.applyArabicShaping&&(y=Hr.applyArabicShaping(y)),y}(m.text,e,f)}),d}const xl={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};function Jp(d){return d==="\uFE36"||d==="\uFE48"||d==="\uFE38"||d==="\uFE44"||d==="\uFE42"||d==="\uFE3E"||d==="\uFE3C"||d==="\uFE3A"||d==="\uFE18"||d==="\uFE40"||d==="\uFE10"||d==="\uFE13"||d==="\uFE14"||d==="\uFF40"||d==="\uFFE3"||d==="\uFE11"||d==="\uFE12"}function Qp(d){return d==="\uFE35"||d==="\uFE47"||d==="\uFE37"||d==="\uFE43"||d==="\uFE41"||d==="\uFE3D"||d==="\uFE3B"||d==="\uFE39"||d==="\uFE17"||d==="\uFE3F"}var xd=function(d,e,f,m,y){var b,M,I=8*y-m-1,P=(1<<I)-1,L=P>>1,N=-7,U=f?y-1:0,j=f?-1:1,H=d[e+U];for(U+=j,b=H&(1<<-N)-1,H>>=-N,N+=I;N>0;b=256*b+d[e+U],U+=j,N-=8);for(M=b&(1<<-N)-1,b>>=-N,N+=m;N>0;M=256*M+d[e+U],U+=j,N-=8);if(b===0)b=1-L;else{if(b===P)return M?NaN:1/0*(H?-1:1);M+=Math.pow(2,m),b-=L}return(H?-1:1)*M*Math.pow(2,b-m)},vd=function(d,e,f,m,y,b){var M,I,P,L=8*b-y-1,N=(1<<L)-1,U=N>>1,j=y===23?Math.pow(2,-24)-Math.pow(2,-77):0,H=m?0:b-1,ne=m?1:-1,ae=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(I=isNaN(e)?1:0,M=N):(M=Math.floor(Math.log(e)/Math.LN2),e*(P=Math.pow(2,-M))<1&&(M--,P*=2),(e+=M+U>=1?j/P:j*Math.pow(2,1-U))*P>=2&&(M++,P/=2),M+U>=N?(I=0,M=N):M+U>=1?(I=(e*P-1)*Math.pow(2,y),M+=U):(I=e*Math.pow(2,U-1)*Math.pow(2,y),M=0));y>=8;d[f+H]=255&I,H+=ne,I/=256,y-=8);for(M=M<<y|I,L+=y;L>0;d[f+H]=255&M,H+=ne,M/=256,L-=8);d[f+H-ne]|=128*ae},vl=Vi;function Vi(d){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(d)?d:new Uint8Array(d||0),this.pos=0,this.type=0,this.length=this.buf.length}Vi.Varint=0,Vi.Fixed64=1,Vi.Bytes=2,Vi.Fixed32=5;var Hh=4294967296,bd=1/Hh,wd=typeof TextDecoder=="undefined"?null:new TextDecoder("utf8");function so(d){return d.type===Vi.Bytes?d.readVarint()+d.pos:d.pos+1}function ca(d,e,f){return f?4294967296*e+(d>>>0):4294967296*(e>>>0)+(d>>>0)}function Ed(d,e,f){var m=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));f.realloc(m);for(var y=f.pos-1;y>=d;y--)f.buf[y+m]=f.buf[y]}function em(d,e){for(var f=0;f<d.length;f++)e.writeVarint(d[f])}function tm(d,e){for(var f=0;f<d.length;f++)e.writeSVarint(d[f])}function im(d,e){for(var f=0;f<d.length;f++)e.writeFloat(d[f])}function rm(d,e){for(var f=0;f<d.length;f++)e.writeDouble(d[f])}function nm(d,e){for(var f=0;f<d.length;f++)e.writeBoolean(d[f])}function om(d,e){for(var f=0;f<d.length;f++)e.writeFixed32(d[f])}function sm(d,e){for(var f=0;f<d.length;f++)e.writeSFixed32(d[f])}function am(d,e){for(var f=0;f<d.length;f++)e.writeFixed64(d[f])}function lm(d,e){for(var f=0;f<d.length;f++)e.writeSFixed64(d[f])}function Gc(d,e){return(d[e]|d[e+1]<<8|d[e+2]<<16)+16777216*d[e+3]}function ha(d,e,f){d[f]=e,d[f+1]=e>>>8,d[f+2]=e>>>16,d[f+3]=e>>>24}function Td(d,e){return(d[e]|d[e+1]<<8|d[e+2]<<16)+(d[e+3]<<24)}function cm(d,e,f){e.glyphs=[],d===1&&f.readMessage(hm,e)}function hm(d,e,f){if(d===3){const{id:m,bitmap:y,width:b,height:M,left:I,top:P,advance:L}=f.readMessage(um,{});e.glyphs.push({id:m,bitmap:new oo({width:b+6,height:M+6},y),metrics:{width:b,height:M,left:I,top:P,advance:L}})}else d===4?e.ascender=f.readSVarint():d===5&&(e.descender=f.readSVarint())}function um(d,e,f){d===1?e.id=f.readVarint():d===2?e.bitmap=f.readBytes():d===3?e.width=f.readVarint():d===4?e.height=f.readVarint():d===5?e.left=f.readSVarint():d===6?e.top=f.readSVarint():d===7&&(e.advance=f.readVarint())}function Kh(d){let e=0,f=0;for(const M of d)e+=M.w*M.h,f=Math.max(f,M.w);d.sort((M,I)=>I.h-M.h);const m=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),f),h:1/0}];let y=0,b=0;for(const M of d)for(let I=m.length-1;I>=0;I--){const P=m[I];if(!(M.w>P.w||M.h>P.h)){if(M.x=P.x,M.y=P.y,b=Math.max(b,M.y+M.h),y=Math.max(y,M.x+M.w),M.w===P.w&&M.h===P.h){const L=m.pop();I<m.length&&(m[I]=L)}else M.h===P.h?(P.x+=M.w,P.w-=M.w):M.w===P.w?(P.y+=M.h,P.h-=M.h):(m.push({x:P.x+M.w,y:P.y,w:P.w-M.w,h:M.h}),P.y+=M.h,P.h-=M.h);break}}return{w:y,h:b,fill:e/(y*b)||0}}Vi.prototype={destroy:function(){this.buf=null},readFields:function(d,e,f){for(f=f||this.length;this.pos<f;){var m=this.readVarint(),y=m>>3,b=this.pos;this.type=7&m,d(y,e,this),this.pos===b&&this.skip(m)}return e},readMessage:function(d,e){return this.readFields(d,e,this.readVarint()+this.pos)},readFixed32:function(){var d=Gc(this.buf,this.pos);return this.pos+=4,d},readSFixed32:function(){var d=Td(this.buf,this.pos);return this.pos+=4,d},readFixed64:function(){var d=Gc(this.buf,this.pos)+Gc(this.buf,this.pos+4)*Hh;return this.pos+=8,d},readSFixed64:function(){var d=Gc(this.buf,this.pos)+Td(this.buf,this.pos+4)*Hh;return this.pos+=8,d},readFloat:function(){var d=xd(this.buf,this.pos,!0,23,4);return this.pos+=4,d},readDouble:function(){var d=xd(this.buf,this.pos,!0,52,8);return this.pos+=8,d},readVarint:function(d){var e,f,m=this.buf;return e=127&(f=m[this.pos++]),f<128?e:(e|=(127&(f=m[this.pos++]))<<7,f<128?e:(e|=(127&(f=m[this.pos++]))<<14,f<128?e:(e|=(127&(f=m[this.pos++]))<<21,f<128?e:function(y,b,M){var I,P,L=M.buf;if(I=(112&(P=L[M.pos++]))>>4,P<128||(I|=(127&(P=L[M.pos++]))<<3,P<128)||(I|=(127&(P=L[M.pos++]))<<10,P<128)||(I|=(127&(P=L[M.pos++]))<<17,P<128)||(I|=(127&(P=L[M.pos++]))<<24,P<128)||(I|=(1&(P=L[M.pos++]))<<31,P<128))return ca(y,I,b);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(f=m[this.pos]))<<28,d,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var d=this.readVarint();return d%2==1?(d+1)/-2:d/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var d=this.readVarint()+this.pos,e=this.pos;return this.pos=d,d-e>=12&&wd?function(f,m,y){return wd.decode(f.subarray(m,y))}(this.buf,e,d):function(f,m,y){for(var b="",M=m;M<y;){var I,P,L,N=f[M],U=null,j=N>239?4:N>223?3:N>191?2:1;if(M+j>y)break;j===1?N<128&&(U=N):j===2?(192&(I=f[M+1]))==128&&(U=(31&N)<<6|63&I)<=127&&(U=null):j===3?(P=f[M+2],(192&(I=f[M+1]))==128&&(192&P)==128&&((U=(15&N)<<12|(63&I)<<6|63&P)<=2047||U>=55296&&U<=57343)&&(U=null)):j===4&&(P=f[M+2],L=f[M+3],(192&(I=f[M+1]))==128&&(192&P)==128&&(192&L)==128&&((U=(15&N)<<18|(63&I)<<12|(63&P)<<6|63&L)<=65535||U>=1114112)&&(U=null)),U===null?(U=65533,j=1):U>65535&&(U-=65536,b+=String.fromCharCode(U>>>10&1023|55296),U=56320|1023&U),b+=String.fromCharCode(U),M+=j}return b}(this.buf,e,d)},readBytes:function(){var d=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,d);return this.pos=d,e},readPackedVarint:function(d,e){if(this.type!==Vi.Bytes)return d.push(this.readVarint(e));var f=so(this);for(d=d||[];this.pos<f;)d.push(this.readVarint(e));return d},readPackedSVarint:function(d){if(this.type!==Vi.Bytes)return d.push(this.readSVarint());var e=so(this);for(d=d||[];this.pos<e;)d.push(this.readSVarint());return d},readPackedBoolean:function(d){if(this.type!==Vi.Bytes)return d.push(this.readBoolean());var e=so(this);for(d=d||[];this.pos<e;)d.push(this.readBoolean());return d},readPackedFloat:function(d){if(this.type!==Vi.Bytes)return d.push(this.readFloat());var e=so(this);for(d=d||[];this.pos<e;)d.push(this.readFloat());return d},readPackedDouble:function(d){if(this.type!==Vi.Bytes)return d.push(this.readDouble());var e=so(this);for(d=d||[];this.pos<e;)d.push(this.readDouble());return d},readPackedFixed32:function(d){if(this.type!==Vi.Bytes)return d.push(this.readFixed32());var e=so(this);for(d=d||[];this.pos<e;)d.push(this.readFixed32());return d},readPackedSFixed32:function(d){if(this.type!==Vi.Bytes)return d.push(this.readSFixed32());var e=so(this);for(d=d||[];this.pos<e;)d.push(this.readSFixed32());return d},readPackedFixed64:function(d){if(this.type!==Vi.Bytes)return d.push(this.readFixed64());var e=so(this);for(d=d||[];this.pos<e;)d.push(this.readFixed64());return d},readPackedSFixed64:function(d){if(this.type!==Vi.Bytes)return d.push(this.readSFixed64());var e=so(this);for(d=d||[];this.pos<e;)d.push(this.readSFixed64());return d},skip:function(d){var e=7&d;if(e===Vi.Varint)for(;this.buf[this.pos++]>127;);else if(e===Vi.Bytes)this.pos=this.readVarint()+this.pos;else if(e===Vi.Fixed32)this.pos+=4;else{if(e!==Vi.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(d,e){this.writeVarint(d<<3|e)},realloc:function(d){for(var e=this.length||16;e<this.pos+d;)e*=2;if(e!==this.length){var f=new Uint8Array(e);f.set(this.buf),this.buf=f,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(d){this.realloc(4),ha(this.buf,d,this.pos),this.pos+=4},writeSFixed32:function(d){this.realloc(4),ha(this.buf,d,this.pos),this.pos+=4},writeFixed64:function(d){this.realloc(8),ha(this.buf,-1&d,this.pos),ha(this.buf,Math.floor(d*bd),this.pos+4),this.pos+=8},writeSFixed64:function(d){this.realloc(8),ha(this.buf,-1&d,this.pos),ha(this.buf,Math.floor(d*bd),this.pos+4),this.pos+=8},writeVarint:function(d){(d=+d||0)>268435455||d<0?function(e,f){var m,y;if(e>=0?(m=e%4294967296|0,y=e/4294967296|0):(y=~(-e/4294967296),4294967295^(m=~(-e%4294967296))?m=m+1|0:(m=0,y=y+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");f.realloc(10),function(b,M,I){I.buf[I.pos++]=127&b|128,b>>>=7,I.buf[I.pos++]=127&b|128,b>>>=7,I.buf[I.pos++]=127&b|128,b>>>=7,I.buf[I.pos++]=127&b|128,I.buf[I.pos]=127&(b>>>=7)}(m,0,f),function(b,M){var I=(7&b)<<4;M.buf[M.pos++]|=I|((b>>>=3)?128:0),b&&(M.buf[M.pos++]=127&b|((b>>>=7)?128:0),b&&(M.buf[M.pos++]=127&b|((b>>>=7)?128:0),b&&(M.buf[M.pos++]=127&b|((b>>>=7)?128:0),b&&(M.buf[M.pos++]=127&b|((b>>>=7)?128:0),b&&(M.buf[M.pos++]=127&b)))))}(y,f)}(d,this):(this.realloc(4),this.buf[this.pos++]=127&d|(d>127?128:0),d<=127||(this.buf[this.pos++]=127&(d>>>=7)|(d>127?128:0),d<=127||(this.buf[this.pos++]=127&(d>>>=7)|(d>127?128:0),d<=127||(this.buf[this.pos++]=d>>>7&127))))},writeSVarint:function(d){this.writeVarint(d<0?2*-d-1:2*d)},writeBoolean:function(d){this.writeVarint(Boolean(d))},writeString:function(d){d=String(d),this.realloc(4*d.length),this.pos++;var e=this.pos;this.pos=function(m,y,b){for(var M,I,P=0;P<y.length;P++){if((M=y.charCodeAt(P))>55295&&M<57344){if(!I){M>56319||P+1===y.length?(m[b++]=239,m[b++]=191,m[b++]=189):I=M;continue}if(M<56320){m[b++]=239,m[b++]=191,m[b++]=189,I=M;continue}M=I-55296<<10|M-56320|65536,I=null}else I&&(m[b++]=239,m[b++]=191,m[b++]=189,I=null);M<128?m[b++]=M:(M<2048?m[b++]=M>>6|192:(M<65536?m[b++]=M>>12|224:(m[b++]=M>>18|240,m[b++]=M>>12&63|128),m[b++]=M>>6&63|128),m[b++]=63&M|128)}return b}(this.buf,d,this.pos);var f=this.pos-e;f>=128&&Ed(e,f,this),this.pos=e-1,this.writeVarint(f),this.pos+=f},writeFloat:function(d){this.realloc(4),vd(this.buf,d,this.pos,!0,23,4),this.pos+=4},writeDouble:function(d){this.realloc(8),vd(this.buf,d,this.pos,!0,52,8),this.pos+=8},writeBytes:function(d){var e=d.length;this.writeVarint(e),this.realloc(e);for(var f=0;f<e;f++)this.buf[this.pos++]=d[f]},writeRawMessage:function(d,e){this.pos++;var f=this.pos;d(e,this);var m=this.pos-f;m>=128&&Ed(f,m,this),this.pos=f-1,this.writeVarint(m),this.pos+=m},writeMessage:function(d,e,f){this.writeTag(d,Vi.Bytes),this.writeRawMessage(e,f)},writePackedVarint:function(d,e){e.length&&this.writeMessage(d,em,e)},writePackedSVarint:function(d,e){e.length&&this.writeMessage(d,tm,e)},writePackedBoolean:function(d,e){e.length&&this.writeMessage(d,nm,e)},writePackedFloat:function(d,e){e.length&&this.writeMessage(d,im,e)},writePackedDouble:function(d,e){e.length&&this.writeMessage(d,rm,e)},writePackedFixed32:function(d,e){e.length&&this.writeMessage(d,om,e)},writePackedSFixed32:function(d,e){e.length&&this.writeMessage(d,sm,e)},writePackedFixed64:function(d,e){e.length&&this.writeMessage(d,am,e)},writePackedSFixed64:function(d,e){e.length&&this.writeMessage(d,lm,e)},writeBytesField:function(d,e){this.writeTag(d,Vi.Bytes),this.writeBytes(e)},writeFixed32Field:function(d,e){this.writeTag(d,Vi.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(d,e){this.writeTag(d,Vi.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(d,e){this.writeTag(d,Vi.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(d,e){this.writeTag(d,Vi.Fixed64),this.writeSFixed64(e)},writeVarintField:function(d,e){this.writeTag(d,Vi.Varint),this.writeVarint(e)},writeSVarintField:function(d,e){this.writeTag(d,Vi.Varint),this.writeSVarint(e)},writeStringField:function(d,e){this.writeTag(d,Vi.Bytes),this.writeString(e)},writeFloatField:function(d,e){this.writeTag(d,Vi.Fixed32),this.writeFloat(e)},writeDoubleField:function(d,e){this.writeTag(d,Vi.Fixed64),this.writeDouble(e)},writeBooleanField:function(d,e){this.writeVarintField(d,Boolean(e))}};class Jh{constructor(e,{pixelRatio:f,version:m,stretchX:y,stretchY:b,content:M}){this.paddedRect=e,this.pixelRatio=f,this.stretchX=y,this.stretchY=b,this.content=M,this.version=m}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Md{constructor(e,f){const m={},y={};this.haveRenderCallbacks=[];const b=[];this.addImages(e,m,b),this.addImages(f,y,b);const{w:M,h:I}=Kh(b),P=new Qr({width:M||1,height:I||1});for(const L in e){const N=e[L],U=m[L].paddedRect;Qr.copy(N.data,P,{x:0,y:0},{x:U.x+1,y:U.y+1},N.data)}for(const L in f){const N=f[L],U=y[L].paddedRect,j=U.x+1,H=U.y+1,ne=N.data.width,ae=N.data.height;Qr.copy(N.data,P,{x:0,y:0},{x:j,y:H},N.data),Qr.copy(N.data,P,{x:0,y:ae-1},{x:j,y:H-1},{width:ne,height:1}),Qr.copy(N.data,P,{x:0,y:0},{x:j,y:H+ae},{width:ne,height:1}),Qr.copy(N.data,P,{x:ne-1,y:0},{x:j-1,y:H},{width:1,height:ae}),Qr.copy(N.data,P,{x:0,y:0},{x:j+ne,y:H},{width:1,height:ae})}this.image=P,this.iconPositions=m,this.patternPositions=y}addImages(e,f,m){for(const y in e){const b=e[y],M={x:0,y:0,w:b.data.width+2,h:b.data.height+2};m.push(M),f[y]=new Jh(M,b),b.hasRenderCallback&&this.haveRenderCallbacks.push(y)}}patchUpdatedImages(e,f){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(m=>e.hasImage(m)),e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const m in e.updatedImages)this.patchUpdatedImage(this.iconPositions[m],e.getImage(m),f),this.patchUpdatedImage(this.patternPositions[m],e.getImage(m),f)}patchUpdatedImage(e,f,m){if(!e||!f||e.version===f.version)return;e.version=f.version;const[y,b]=e.tl;m.update(f.data,void 0,{x:y,y:b})}}Mt(Jh,"ImagePosition"),Mt(Md,"ImageAtlas");const dn={horizontal:1,vertical:2,horizontalOnly:3};class bl{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,f){const m=new bl;return m.scale=e||1,m.fontStack=f,m}static forImage(e){const f=new bl;return f.imageName=e,f}}class ua{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,f){const m=new ua;for(let y=0;y<e.sections.length;y++){const b=e.sections[y];b.image?m.addImageSection(b):m.addTextSection(b,f)}return m}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCharCode(e){return this.text.charCodeAt(e)}verticalizePunctuation(e){this.text=function(f,m){let y="";for(let b=0;b<f.length;b++){const M=f.charCodeAt(b+1)||null,I=f.charCodeAt(b-1)||null;y+=!m&&(M&&Hs(M)&&!xl[f[b+1]]||I&&Hs(I)&&!xl[f[b-1]])||!xl[f[b]]?f[b]:xl[f[b]]}return y}(this.text,e)}trim(){let e=0;for(let m=0;m<this.text.length&&qc[this.text.charCodeAt(m)];m++)e++;let f=this.text.length;for(let m=this.text.length-1;m>=0&&m>=e&&qc[this.text.charCodeAt(m)];m--)f--;this.text=this.text.substring(e,f),this.sectionIndex=this.sectionIndex.slice(e,f)}substring(e,f){const m=new ua;return m.text=this.text.substring(e,f),m.sectionIndex=this.sectionIndex.slice(e,f),m.sections=this.sections,m}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,f)=>Math.max(e,this.sections[f].scale),0)}addTextSection(e,f){this.text+=e.text,this.sections.push(bl.forText(e.scale,e.fontStack||f));const m=this.sections.length-1;for(let y=0;y<e.text.length;++y)this.sectionIndex.push(m)}addImageSection(e){const f=e.image?e.image.name:"";if(f.length===0)return void ot("Can't add FormattedSection with an empty image.");const m=this.getNextImageSectionCharCode();m?(this.text+=String.fromCharCode(m),this.sections.push(bl.forImage(f)),this.sectionIndex.push(this.sections.length-1)):ot("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Qh(d,e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae){const pe=ua.fromFeature(d,y);let ve;U===dn.vertical&&pe.verticalizePunctuation(j);const{processBidirectionalText:Ie,processStyledBidirectionalText:Be}=Hr;if(Ie&&pe.sections.length===1){ve=[];const Oe=Ie(pe.toString(),eu(pe,L,b,e,m,H,ne));for(const Xe of Oe){const We=new ua;We.text=Xe,We.sections=pe.sections;for(let tt=0;tt<Xe.length;tt++)We.sectionIndex.push(0);ve.push(We)}}else if(Be){ve=[];const Oe=Be(pe.text,pe.sectionIndex,eu(pe,L,b,e,m,H,ne));for(const Xe of Oe){const We=new ua;We.text=Xe[0],We.sectionIndex=Xe[1],We.sections=pe.sections,ve.push(We)}}else ve=function(Oe,Xe){const We=[],tt=Oe.text;let nt=0;for(const qe of Xe)We.push(Oe.substring(nt,qe)),nt=qe;return nt<tt.length&&We.push(Oe.substring(nt,tt.length)),We}(pe,eu(pe,L,b,e,m,H,ne));const Le=[],Fe={positionedLines:Le,text:pe.toString(),top:N[1],bottom:N[1],left:N[0],right:N[0],writingMode:U,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Oe,Xe,We,tt,nt,qe,Qe,st,mt,lt,dt,ri){let vi=0,ni=0,gi=0;const Ot=st==="right"?1:st==="left"?0:.5;let Et=!1;for(const Ri of nt){const Si=Ri.getSections();for(const $i of Si){if($i.imageName)continue;const Ki=Xe[$i.fontStack];if(Ki&&(Et=Ki.ascender!==void 0&&Ki.descender!==void 0,!Et))break}if(!Et)break}let wi=0;for(const Ri of nt){Ri.trim();const Si=Ri.getMaxScale(),$i=(Si-1)*Er,Ki={positionedGlyphs:[],lineOffset:0};Oe.positionedLines[wi]=Ki;const er=Ki.positionedGlyphs;let hr=0;if(!Ri.length()){ni+=qe,++wi;continue}let fr=0,rn=0;for(let Ui=0;Ui<Ri.length();Ui++){const Dr=Ri.getSection(Ui),nn=Ri.getSectionIndex(Ui),yr=Ri.getCharCode(Ui);let pr=Dr.scale,Zi=null,qi=null,Zr=null,Pr=Er,sr=0;const Br=!(mt===dn.horizontal||!dt&&!Ws(yr)||dt&&(qc[yr]||(Bi=yr,uc(Bi)||Gs(Bi)||os(Bi)||Ha(Bi)||Xs(Bi))));if(Dr.imageName){const Sr=tt[Dr.imageName];if(!Sr)continue;Zr=Dr.imageName,Oe.iconsInText=Oe.iconsInText||!0,qi=Sr.paddedRect;const mr=Sr.displaySize;pr=pr*Er/ri,Zi={width:mr[0],height:mr[1],left:1,top:-3,advance:Br?mr[1]:mr[0],localGlyph:!1},sr=Et?-Zi.height*pr:Si*Er-17-mr[1]*pr,Pr=Zi.advance;const _n=(Br?mr[0]:mr[1])*pr-Er*Si;_n>0&&_n>hr&&(hr=_n)}else{const Sr=We[Dr.fontStack];if(!Sr)continue;Sr[yr]&&(qi=Sr[yr]);const mr=Xe[Dr.fontStack];if(!mr)continue;const _n=mr.glyphs[yr];if(!_n)continue;if(Zi=_n.metrics,Pr=yr!==8203?Er:0,Et){const Fo=mr.ascender!==void 0?Math.abs(mr.ascender):0,Dl=mr.descender!==void 0?Math.abs(mr.descender):0,Pl=(Fo+Dl)*pr;fr<Pl&&(fr=Pl,rn=(Fo-Dl)/2*pr),sr=-Fo*pr}else sr=(Si-pr)*Er-17}Br?(Oe.verticalizable=!0,er.push({glyph:yr,imageName:Zr,x:vi,y:ni+sr,vertical:Br,scale:pr,localGlyph:Zi.localGlyph,fontStack:Dr.fontStack,sectionIndex:nn,metrics:Zi,rect:qi}),vi+=Pr*pr+lt):(er.push({glyph:yr,imageName:Zr,x:vi,y:ni+sr,vertical:Br,scale:pr,localGlyph:Zi.localGlyph,fontStack:Dr.fontStack,sectionIndex:nn,metrics:Zi,rect:qi}),vi+=Zi.advance*pr+lt)}er.length!==0&&(gi=Math.max(vi-lt,gi),Et?kd(er,Ot,hr,rn,qe*Si/2):kd(er,Ot,hr,0,qe/2)),vi=0;const qr=qe*Si+hr;Ki.lineOffset=Math.max(hr,$i),ni+=qr,++wi}var Bi;const lr=ni,{horizontalAlign:Gi,verticalAlign:cr}=tu(Qe);(function(Ri,Si,$i,Ki,er,hr){const fr=(Si-$i)*er,rn=-hr*Ki;for(const qr of Ri)for(const Ui of qr.positionedGlyphs)Ui.x+=fr,Ui.y+=rn})(Oe.positionedLines,Ot,Gi,cr,gi,lr),Oe.top+=-cr*lr,Oe.bottom=Oe.top+lr,Oe.left+=-Gi*gi,Oe.right=Oe.left+gi,Oe.hasBaseline=Et}(Fe,e,f,m,ve,M,I,P,U,L,j,ae),!function(Oe){for(const Xe of Oe)if(Xe.positionedGlyphs.length!==0)return!1;return!0}(Le)&&Fe}const qc={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},dm={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Sd(d,e,f,m,y,b){if(e.imageName){const M=m[e.imageName];return M?M.displaySize[0]*e.scale*Er/b+y:0}{const M=f[e.fontStack],I=M&&M.glyphs[d];return I?I.metrics.advance*e.scale+y:0}}function Ad(d,e,f,m){const y=Math.pow(d-e,2);return m?d<e?y/2:2*y:y+Math.abs(f)*f}function fm(d,e,f){let m=0;return d===10&&(m-=1e4),f&&(m+=150),d!==40&&d!==65288||(m+=50),e!==41&&e!==65289||(m+=50),m}function Id(d,e,f,m,y,b){let M=null,I=Ad(e,f,y,b);for(const P of m){const L=Ad(e-P.x,f,y,b)+P.badness;L<=I&&(M=P,I=L)}return{index:d,x:e,priorBreak:M,badness:I}}function Cd(d){return d?Cd(d.priorBreak).concat(d.index):[]}function eu(d,e,f,m,y,b,M){if(b!=="point")return[];if(!d)return[];const I=[],P=function(j,H,ne,ae,pe,ve){let Ie=0;for(let Be=0;Be<j.length();Be++){const Le=j.getSection(Be);Ie+=Sd(j.getCharCode(Be),Le,ae,pe,H,ve)}return Ie/Math.max(1,Math.ceil(Ie/ne))}(d,e,f,m,y,M),L=d.text.indexOf("\u200B")>=0;let N=0;for(let j=0;j<d.length();j++){const H=d.getSection(j),ne=d.getCharCode(j);if(qc[ne]||(N+=Sd(ne,H,m,y,e,M)),j<d.length()-1){const ae=!((U=ne)<11904||!(pc(U)||fc(U)||wo(U)||as(U)||_c(U)||Za(U)||mc(U)||qs(U)||yc(U)||Wa(U)||gc(U)||Ka(U)||ss(U)||Xa(U)||dc(U)||Ya(U)||Zs(U)||wc(U)||vc(U)||xc(U)));(dm[ne]||ae||H.imageName)&&I.push(Id(j+1,N,P,I,fm(ne,d.getCharCode(j+1),ae&&L),!1))}}var U;return Cd(Id(d.length(),N,P,I,0,!0))}function tu(d){let e=.5,f=.5;switch(d){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(d){case"bottom":case"bottom-right":case"bottom-left":f=1;break;case"top":case"top-right":case"top-left":f=0}return{horizontalAlign:e,verticalAlign:f}}function kd(d,e,f,m,y){if(!(e||f||m||y))return;const b=d.length-1,M=d[b],I=(M.x+M.metrics.advance*M.scale)*e;for(let P=0;P<=b;P++)d[P].x-=I,d[P].y+=f+m+y}function pm(d,e,f){const{horizontalAlign:m,verticalAlign:y}=tu(f),b=e[0]-d.displaySize[0]*m,M=e[1]-d.displaySize[1]*y;return{image:d,top:M,bottom:M+d.displaySize[1],left:b,right:b+d.displaySize[0]}}function Dd(d,e,f,m,y,b){const M=d.image;let I;if(M.content){const pe=M.content,ve=M.pixelRatio||1;I=[pe[0]/ve,pe[1]/ve,M.displaySize[0]-pe[2]/ve,M.displaySize[1]-pe[3]/ve]}const P=e.left*b,L=e.right*b;let N,U,j,H;f==="width"||f==="both"?(H=y[0]+P-m[3],U=y[0]+L+m[1]):(H=y[0]+(P+L-M.displaySize[0])/2,U=H+M.displaySize[0]);const ne=e.top*b,ae=e.bottom*b;return f==="height"||f==="both"?(N=y[1]+ne-m[0],j=y[1]+ae+m[2]):(N=y[1]+(ne+ae-M.displaySize[1])/2,j=N+M.displaySize[1]),{image:M,top:N,right:U,bottom:j,left:H,collisionPadding:I}}class ao extends z{constructor(e,f,m,y,b){super(e,f),this.angle=y,this.z=m,b!==void 0&&(this.segment=b)}clone(){return new ao(this.x,this.y,this.z,this.angle,this.segment)}}function Pd(d,e,f,m,y){if(e.segment===void 0)return!0;let b=e,M=e.segment+1,I=0;for(;I>-f/2;){if(M--,M<0)return!1;I-=d[M].dist(b),b=d[M]}I+=d[M].dist(d[M+1]),M++;const P=[];let L=0;for(;I<f/2;){const N=d[M],U=d[M+1];if(!U)return!1;let j=d[M-1].angleTo(N)-N.angleTo(U);for(j=Math.abs((j+3*Math.PI)%(2*Math.PI)-Math.PI),P.push({distance:I,angleDelta:j}),L+=j;I-P[0].distance>m;)L-=P.shift().angleDelta;if(L>y)return!1;M++,I+=N.dist(U)}return!0}function Bd(d){let e=0;for(let f=0;f<d.length-1;f++)e+=d[f].dist(d[f+1]);return e}function Rd(d,e,f){return d?.6*e*f:0}function Ld(d,e){return Math.max(d?d.right-d.left:0,e?e.right-e.left:0)}function mm(d,e,f,m,y,b){const M=Rd(f,y,b),I=Ld(f,m)*b;let P=0;const L=Bd(d)/2;for(let N=0;N<d.length-1;N++){const U=d[N],j=d[N+1],H=U.dist(j);if(P+H>L){const ne=(L-P)/H,ae=Xt(U.x,j.x,ne),pe=Xt(U.y,j.y,ne),ve=new ao(ae,pe,0,j.angleTo(U),N);return!M||Pd(d,ve,I,M,e)?ve:void 0}P+=H}}function gm(d,e,f,m,y,b,M,I,P){const L=Rd(m,b,M),N=Ld(m,y),U=N*M,j=d[0].x===0||d[0].x===P||d[0].y===0||d[0].y===P;return e-U<e/4&&(e=U+e/4),zd(d,j?e/2*I%e:(N/2+2*b)*M*I%e,e,L,f,U,j,!1,P)}function zd(d,e,f,m,y,b,M,I,P){const L=b/2,N=Bd(d);let U=0,j=e-f,H=[];for(let ne=0;ne<d.length-1;ne++){const ae=d[ne],pe=d[ne+1],ve=ae.dist(pe),Ie=pe.angleTo(ae);for(;j+f<U+ve;){j+=f;const Be=(j-U)/ve,Le=Xt(ae.x,pe.x,Be),Fe=Xt(ae.y,pe.y,Be);if(Le>=0&&Le<P&&Fe>=0&&Fe<P&&j-L>=0&&j+L<=N){const Oe=new ao(Le,Fe,0,Ie,ne);Oe._round(),m&&!Pd(d,Oe,b,m,y)||H.push(Oe)}}U+=ve}return I||H.length||M||(H=zd(d,U/2,f,m,y,b,M,!0,P)),H}function Fd(d,e,f,m,y){const b=[];for(let M=0;M<d.length;M++){const I=d[M];let P;for(let L=0;L<I.length-1;L++){let N=I[L],U=I[L+1];N.x<e&&U.x<e||(N.x<e?N=new z(e,N.y+(e-N.x)/(U.x-N.x)*(U.y-N.y))._round():U.x<e&&(U=new z(e,N.y+(e-N.x)/(U.x-N.x)*(U.y-N.y))._round()),N.y<f&&U.y<f||(N.y<f?N=new z(N.x+(f-N.y)/(U.y-N.y)*(U.x-N.x),f)._round():U.y<f&&(U=new z(N.x+(f-N.y)/(U.y-N.y)*(U.x-N.x),f)._round()),N.x>=m&&U.x>=m||(N.x>=m?N=new z(m,N.y+(m-N.x)/(U.x-N.x)*(U.y-N.y))._round():U.x>=m&&(U=new z(m,N.y+(m-N.x)/(U.x-N.x)*(U.y-N.y))._round()),N.y>=y&&U.y>=y||(N.y>=y?N=new z(N.x+(y-N.y)/(U.y-N.y)*(U.x-N.x),y)._round():U.y>=y&&(U=new z(N.x+(y-N.y)/(U.y-N.y)*(U.x-N.x),y)._round()),P&&N.equals(P[P.length-1])||(P=[N],b.push(P)),P.push(U)))))}}return b}Mt(ao,"Anchor");const wl=1e20;function Od(d,e,f,m,y,b,M,I,P){for(let L=e;L<e+m;L++)Nd(d,f*b+L,b,y,M,I,P);for(let L=f;L<f+y;L++)Nd(d,L*b+e,1,m,M,I,P)}function Nd(d,e,f,m,y,b,M){b[0]=0,M[0]=-wl,M[1]=wl,y[0]=d[e];for(let I=1,P=0,L=0;I<m;I++){y[I]=d[e+I*f];const N=I*I;do{const U=b[P];L=(y[I]-y[U]+N-U*U)/(I-U)/2}while(L<=M[P]&&--P>-1);P++,b[P]=I,M[P]=L,M[P+1]=wl}for(let I=0,P=0;I<m;I++){for(;M[P+1]<I;)P++;const L=b[P],N=I-L;d[e+I*f]=y[L]+N*N}}const iu={none:0,ideographs:1,all:2};class da{constructor(e,f,m){this.requestManager=e,this.localGlyphMode=f,this.localFontFamily=m,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,f){const m=[];for(const y in e)for(const b of e[y])m.push({stack:y,id:b});be(m,({stack:y,id:b},M)=>{let I=this.entries[y];I||(I=this.entries[y]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let P=I.glyphs[b];if(P!==void 0)return void M(null,{stack:y,id:b,glyph:P});if(P=this._tinySDF(I,y,b),P)return I.glyphs[b]=P,void M(null,{stack:y,id:b,glyph:P});const L=Math.floor(b/256);if(256*L>65535)return void M(new Error("glyphs > 65535 not supported"));if(I.ranges[L])return void M(null,{stack:y,id:b,glyph:P});let N=I.requests[L];N||(N=I.requests[L]=[],da.loadGlyphRange(y,L,this.url,this.requestManager,(U,j)=>{if(j){I.ascender=j.ascender,I.descender=j.descender;for(const H in j.glyphs)this._doesCharSupportLocalGlyph(+H)||(I.glyphs[+H]=j.glyphs[+H]);I.ranges[L]=!0}for(const H of N)H(U,j);delete I.requests[L]})),N.push((U,j)=>{U?M(U):j&&M(null,{stack:y,id:b,glyph:j.glyphs[b]||null})})},(y,b)=>{if(y)f(y);else if(b){const M={};for(const{stack:I,id:P,glyph:L}of b)M[I]===void 0&&(M[I]={}),M[I].glyphs===void 0&&(M[I].glyphs={}),M[I].glyphs[P]=L&&{id:L.id,bitmap:L.bitmap.clone(),metrics:L.metrics},M[I].ascender=this.entries[I].ascender,M[I].descender=this.entries[I].descender;f(null,M)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==iu.none&&(this.localGlyphMode===iu.all?!!this.localFontFamily:!!this.localFontFamily&&(Wa(e)||bc(e)||ss(e)||Zs(e)||qs(e)))}_tinySDF(e,f,m){const y=this.localFontFamily;if(!y||!this._doesCharSupportLocalGlyph(m))return;let b=e.tinySDF;if(!b){let ae="400";/bold/i.test(f)?ae="900":/medium/i.test(f)?ae="500":/light/i.test(f)&&(ae="200"),b=e.tinySDF=new da.TinySDF({fontFamily:y,fontWeight:ae,fontSize:48,buffer:6,radius:16}),b.fontWeight=ae}if(this.localGlyphs[b.fontWeight][m])return this.localGlyphs[b.fontWeight][m];const M=String.fromCharCode(m),{data:I,width:P,height:L,glyphWidth:N,glyphHeight:U,glyphLeft:j,glyphTop:H,glyphAdvance:ne}=b.draw(M);return this.localGlyphs[b.fontWeight][m]={id:m,bitmap:new oo({width:P,height:L},I),metrics:{width:N/2,height:U/2,left:j/2,top:H/2-27,advance:ne/2,localGlyph:!0}}}}function $d(d,e,f,m){const y=[],b=d.image,M=b.pixelRatio,I=b.paddedRect.w-2,P=b.paddedRect.h-2,L=d.right-d.left,N=d.bottom-d.top,U=b.stretchX||[[0,I]],j=b.stretchY||[[0,P]],H=(qe,Qe)=>qe+Qe[1]-Qe[0],ne=U.reduce(H,0),ae=j.reduce(H,0),pe=I-ne,ve=P-ae;let Ie=0,Be=ne,Le=0,Fe=ae,Oe=0,Xe=pe,We=0,tt=ve;if(b.content&&m){const qe=b.content;Ie=Zc(U,0,qe[0]),Le=Zc(j,0,qe[1]),Be=Zc(U,qe[0],qe[2]),Fe=Zc(j,qe[1],qe[3]),Oe=qe[0]-Ie,We=qe[1]-Le,Xe=qe[2]-qe[0]-Be,tt=qe[3]-qe[1]-Fe}const nt=(qe,Qe,st,mt)=>{const lt=Xc(qe.stretch-Ie,Be,L,d.left),dt=Yc(qe.fixed-Oe,Xe,qe.stretch,ne),ri=Xc(Qe.stretch-Le,Fe,N,d.top),vi=Yc(Qe.fixed-We,tt,Qe.stretch,ae),ni=Xc(st.stretch-Ie,Be,L,d.left),gi=Yc(st.fixed-Oe,Xe,st.stretch,ne),Ot=Xc(mt.stretch-Le,Fe,N,d.top),Et=Yc(mt.fixed-We,tt,mt.stretch,ae),wi=new z(lt,ri),Bi=new z(ni,ri),lr=new z(ni,Ot),Gi=new z(lt,Ot),cr=new z(dt/M,vi/M),Ri=new z(gi/M,Et/M),Si=e*Math.PI/180;if(Si){const er=Math.sin(Si),hr=Math.cos(Si),fr=[hr,-er,er,hr];wi._matMult(fr),Bi._matMult(fr),Gi._matMult(fr),lr._matMult(fr)}const $i=qe.stretch+qe.fixed,Ki=Qe.stretch+Qe.fixed;return{tl:wi,tr:Bi,bl:Gi,br:lr,tex:{x:b.paddedRect.x+1+$i,y:b.paddedRect.y+1+Ki,w:st.stretch+st.fixed-$i,h:mt.stretch+mt.fixed-Ki},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:cr,pixelOffsetBR:Ri,minFontScaleX:Xe/M/L,minFontScaleY:tt/M/N,isSDF:f}};if(m&&(b.stretchX||b.stretchY)){const qe=Ud(U,pe,ne),Qe=Ud(j,ve,ae);for(let st=0;st<qe.length-1;st++){const mt=qe[st],lt=qe[st+1];for(let dt=0;dt<Qe.length-1;dt++)y.push(nt(mt,Qe[dt],lt,Qe[dt+1]))}}else y.push(nt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:I+1},{fixed:0,stretch:P+1}));return y}function Zc(d,e,f){let m=0;for(const y of d)m+=Math.max(e,Math.min(f,y[1]))-Math.max(e,Math.min(f,y[0]));return m}function Ud(d,e,f){const m=[{fixed:-1,stretch:0}];for(const[y,b]of d){const M=m[m.length-1];m.push({fixed:y-M.stretch,stretch:M.stretch}),m.push({fixed:y-M.stretch,stretch:M.stretch+(b-y)})}return m.push({fixed:e+1,stretch:f}),m}function Xc(d,e,f,m){return d/e*f+m}function Yc(d,e,f,m){return d-e*f/m}function _m(d,e,f,m){const y=e+d.positionedLines[m].lineOffset;return m===0?f+y/2:f+(y+(e+d.positionedLines[m-1].lineOffset))/2}da.loadGlyphRange=function(d,e,f,m,y){const b=256*e,M=b+255,I=m.transformRequest(m.normalizeGlyphsURL(f).replace("{fontstack}",d).replace("{range}",`${b}-${M}`),Q.Glyphs);me(I,(P,L)=>{if(P)y(P);else if(L){const N={},U=function(j){return new vl(j).readFields(cm,{})}(L);for(const j of U.glyphs)N[j.id]=j;y(null,{glyphs:N,ascender:U.ascender,descender:U.descender})}})},da.TinySDF=class{constructor({fontSize:d=24,buffer:e=3,radius:f=8,cutoff:m=.25,fontFamily:y="sans-serif",fontWeight:b="normal",fontStyle:M="normal"}){this.buffer=e,this.cutoff=m,this.radius=f;const I=this.size=d+4*e,P=this._createCanvas(I),L=this.ctx=P.getContext("2d",{willReadFrequently:!0});L.font=`${M} ${b} ${d}px ${y}`,L.textBaseline="alphabetic",L.textAlign="left",L.fillStyle="black",this.gridOuter=new Float64Array(I*I),this.gridInner=new Float64Array(I*I),this.f=new Float64Array(I),this.z=new Float64Array(I+1),this.v=new Uint16Array(I)}_createCanvas(d){const e=document.createElement("canvas");return e.width=e.height=d,e}draw(d){const{width:e,actualBoundingBoxAscent:f,actualBoundingBoxDescent:m,actualBoundingBoxLeft:y,actualBoundingBoxRight:b}=this.ctx.measureText(d),M=Math.floor(f),I=Math.min(this.size-this.buffer,Math.ceil(b-y)),P=Math.min(this.size-this.buffer,Math.ceil(f)+Math.ceil(m)),L=I+2*this.buffer,N=P+2*this.buffer,U=L*N,j=new Uint8ClampedArray(U),H={data:j,width:L,height:N,glyphWidth:I,glyphHeight:P,glyphTop:M,glyphLeft:0,glyphAdvance:e};if(I===0||P===0)return H;const{ctx:ne,buffer:ae,gridInner:pe,gridOuter:ve}=this;ne.clearRect(ae,ae,I,P),ne.fillText(d,ae,ae+M+1);const Ie=ne.getImageData(ae,ae,I,P);ve.fill(wl,0,U),pe.fill(0,0,U);for(let Be=0;Be<P;Be++)for(let Le=0;Le<I;Le++){const Fe=Ie.data[4*(Be*I+Le)+3]/255;if(Fe===0)continue;const Oe=(Be+ae)*L+Le+ae;if(Fe===1)ve[Oe]=0,pe[Oe]=wl;else{const Xe=.5-Fe;ve[Oe]=Xe>0?Xe*Xe:0,pe[Oe]=Xe<0?Xe*Xe:0}}Od(ve,0,0,L,N,L,this.f,this.v,this.z),Od(pe,ae,ae,I,P,L,this.f,this.v,this.z);for(let Be=0;Be<U;Be++){const Le=Math.sqrt(ve[Be])-Math.sqrt(pe[Be]);j[Be]=Math.round(255-255*(Le/this.radius+this.cutoff))}return H}};class ym{constructor(e=[],f=xm){if(this.data=e,this.length=this.data.length,this.compare=f,this.length>0)for(let m=(this.length>>1)-1;m>=0;m--)this._down(m)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],f=this.data.pop();return this.length--,this.length>0&&(this.data[0]=f,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:f,compare:m}=this,y=f[e];for(;e>0;){const b=e-1>>1,M=f[b];if(m(y,M)>=0)break;f[e]=M,e=b}f[e]=y}_down(e){const{data:f,compare:m}=this,y=this.length>>1,b=f[e];for(;e<y;){let M=1+(e<<1),I=f[M];const P=M+1;if(P<this.length&&m(f[P],I)<0&&(M=P,I=f[P]),m(I,b)>=0)break;f[e]=I,e=M}f[e]=b}}function xm(d,e){return d<e?-1:d>e?1:0}function vm(d,e=1,f=!1){let m=1/0,y=1/0,b=-1/0,M=-1/0;const I=d[0];for(let H=0;H<I.length;H++){const ne=I[H];(!H||ne.x<m)&&(m=ne.x),(!H||ne.y<y)&&(y=ne.y),(!H||ne.x>b)&&(b=ne.x),(!H||ne.y>M)&&(M=ne.y)}const P=Math.min(b-m,M-y);let L=P/2;const N=new ym([],bm);if(P===0)return new z(m,y);for(let H=m;H<b;H+=P)for(let ne=y;ne<M;ne+=P)N.push(new fa(H+L,ne+L,L,d));let U=function(H){let ne=0,ae=0,pe=0;const ve=H[0];for(let Ie=0,Be=ve.length,Le=Be-1;Ie<Be;Le=Ie++){const Fe=ve[Ie],Oe=ve[Le],Xe=Fe.x*Oe.y-Oe.x*Fe.y;ae+=(Fe.x+Oe.x)*Xe,pe+=(Fe.y+Oe.y)*Xe,ne+=3*Xe}return new fa(ae/ne,pe/ne,0,H)}(d),j=N.length;for(;N.length;){const H=N.pop();(H.d>U.d||!U.d)&&(U=H,f&&console.log("found best %d after %d probes",Math.round(1e4*H.d)/1e4,j)),H.max-U.d<=e||(L=H.h/2,N.push(new fa(H.p.x-L,H.p.y-L,L,d)),N.push(new fa(H.p.x+L,H.p.y-L,L,d)),N.push(new fa(H.p.x-L,H.p.y+L,L,d)),N.push(new fa(H.p.x+L,H.p.y+L,L,d)),j+=4)}return f&&(console.log(`num probes: ${j}`),console.log(`best distance: ${U.d}`)),U.p}function bm(d,e){return e.max-d.max}function fa(d,e,f,m){this.p=new z(d,e),this.h=f,this.d=function(y,b){let M=!1,I=1/0;for(let P=0;P<b.length;P++){const L=b[P];for(let N=0,U=L.length,j=U-1;N<U;j=N++){const H=L[N],ne=L[j];H.y>y.y!=ne.y>y.y&&y.x<(ne.x-H.x)*(y.y-H.y)/(ne.y-H.y)+H.x&&(M=!M),I=Math.min(I,Fu(y,H,ne))}}return(M?1:-1)*Math.sqrt(I)}(this.p,m),this.max=this.d+this.h*Math.SQRT2}const ru=Number.POSITIVE_INFINITY,wm=Math.sqrt(2);function Vd(d,e){return e[1]!==ru?function(f,m,y){let b=0,M=0;switch(m=Math.abs(m),y=Math.abs(y),f){case"top-right":case"top-left":case"top":M=y-7;break;case"bottom-right":case"bottom-left":case"bottom":M=7-y}switch(f){case"top-right":case"bottom-right":case"right":b=-m;break;case"top-left":case"bottom-left":case"left":b=m}return[b,M]}(d,e[0],e[1]):function(f,m){let y=0,b=0;m<0&&(m=0);const M=m/wm;switch(f){case"top-right":case"top-left":b=M-7;break;case"bottom-right":case"bottom-left":b=7-M;break;case"bottom":b=7-m;break;case"top":b=m-7}switch(f){case"top-right":case"bottom-right":y=-M;break;case"top-left":case"bottom-left":y=M;break;case"left":y=m;break;case"right":y=-m}return[y,b]}(d,e[0])}function Em(d,e,f,m,y,b,M,I,P,L){d.createArrays(),d.tilePixelRatio=fi/(512*d.overscaling),d.compareText={},d.iconsNeedLinear=!1;const N=d.layers[0].layout,U=d.layers[0]._unevaluatedLayout._values,j={};if(d.textSizeData.kind==="composite"){const{minZoom:ae,maxZoom:pe}=d.textSizeData;j.compositeTextSizes=[U["text-size"].possiblyEvaluate(new ji(ae),I),U["text-size"].possiblyEvaluate(new ji(pe),I)]}if(d.iconSizeData.kind==="composite"){const{minZoom:ae,maxZoom:pe}=d.iconSizeData;j.compositeIconSizes=[U["icon-size"].possiblyEvaluate(new ji(ae),I),U["icon-size"].possiblyEvaluate(new ji(pe),I)]}j.layoutTextSize=U["text-size"].possiblyEvaluate(new ji(P+1),I),j.layoutIconSize=U["icon-size"].possiblyEvaluate(new ji(P+1),I),j.textMaxSize=U["text-size"].possiblyEvaluate(new ji(18),I);const H=N.get("text-rotation-alignment")==="map"&&N.get("symbol-placement")!=="point",ne=N.get("text-size");for(const ae of d.features){const pe=N.get("text-font").evaluate(ae,{},I).join(","),ve=ne.evaluate(ae,{},I),Ie=j.layoutTextSize.evaluate(ae,{},I),Be=(j.layoutIconSize.evaluate(ae,{},I),{horizontal:{},vertical:void 0}),Le=ae.text;let Fe,Oe=[0,0];if(Le){const tt=Le.toString(),nt=N.get("text-letter-spacing").evaluate(ae,{},I)*Er,qe=N.get("text-line-height").evaluate(ae,{},I)*Er,Qe=Tc(tt)?nt:0,st=N.get("text-anchor").evaluate(ae,{},I),mt=N.get("text-variable-anchor");if(!mt){const gi=N.get("text-radial-offset").evaluate(ae,{},I);Oe=gi?Vd(st,[gi*Er,ru]):N.get("text-offset").evaluate(ae,{},I).map(Ot=>Ot*Er)}let lt=H?"center":N.get("text-justify").evaluate(ae,{},I);const dt=N.get("symbol-placement"),ri=dt==="point",vi=dt==="point"?N.get("text-max-width").evaluate(ae,{},I)*Er:0,ni=gi=>{d.allowVerticalPlacement&&Ys(tt)&&(Be.vertical=Qh(Le,e,f,y,pe,vi,qe,st,gi,Qe,Oe,dn.vertical,!0,dt,Ie,ve))};if(!H&&mt){const gi=lt==="auto"?mt.map(Et=>nu(Et)):[lt];let Ot=!1;for(let Et=0;Et<gi.length;Et++){const wi=gi[Et];if(!Be.horizontal[wi])if(Ot)Be.horizontal[wi]=Be.horizontal[0];else{const Bi=Qh(Le,e,f,y,pe,vi,qe,"center",wi,Qe,Oe,dn.horizontal,!1,dt,Ie,ve);Bi&&(Be.horizontal[wi]=Bi,Ot=Bi.positionedLines.length===1)}}ni("left")}else{if(lt==="auto"&&(lt=nu(st)),ri||N.get("text-writing-mode").indexOf("horizontal")>=0||!Ys(tt)){const gi=Qh(Le,e,f,y,pe,vi,qe,st,lt,Qe,Oe,dn.horizontal,!1,dt,Ie,ve);gi&&(Be.horizontal[lt]=gi)}ni(dt==="point"?"left":lt)}}let Xe=!1;if(ae.icon&&ae.icon.name){const tt=m[ae.icon.name];tt&&(Fe=pm(y[ae.icon.name],N.get("icon-offset").evaluate(ae,{},I),N.get("icon-anchor").evaluate(ae,{},I)),Xe=tt.sdf,d.sdfIcons===void 0?d.sdfIcons=tt.sdf:d.sdfIcons!==tt.sdf&&ot("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(tt.pixelRatio!==d.pixelRatio||N.get("icon-rotate").constantOr(1)!==0)&&(d.iconsNeedLinear=!0))}const We=Gd(Be.horizontal)||Be.vertical;d.iconsInText||(d.iconsInText=!!We&&We.iconsInText),(We||Fe)&&Tm(d,ae,Be,Fe,m,j,Ie,0,Oe,Xe,M,I,L)}b&&d.generateCollisionDebugBuffers(P,d.collisionBoxArray)}function nu(d){switch(d){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Tm(d,e,f,m,y,b,M,I,P,L,N,U,j){let H=b.textMaxSize.evaluate(e,{},U);H===void 0&&(H=M);const ne=d.layers[0].layout,ae=ne.get("icon-offset").evaluate(e,{},U),pe=Gd(f.horizontal)||f.vertical,ve=M/24,Ie=d.tilePixelRatio*H/24,Be=(qe=d.overscaling,d.zoom>18&&qe>2&&(qe>>=1),Math.max(fi/(512*qe),1)*ne.get("symbol-spacing")),Le=ne.get("text-padding")*d.tilePixelRatio,Fe=ne.get("icon-padding")*d.tilePixelRatio,Oe=J(ne.get("text-max-angle")),Xe=ne.get("text-rotation-alignment")==="map"&&ne.get("symbol-placement")!=="point",We=ne.get("icon-rotation-alignment")==="map"&&ne.get("symbol-placement")!=="point",tt=ne.get("symbol-placement"),nt=Be/2;var qe;const Qe=ne.get("icon-text-fit");let st;m&&Qe!=="none"&&(d.allowVerticalPlacement&&f.vertical&&(st=Dd(m,f.vertical,Qe,ne.get("icon-text-fit-padding"),ae,ve)),pe&&(m=Dd(m,pe,Qe,ne.get("icon-text-fit-padding"),ae,ve)));const mt=(lt,dt,ri)=>{if(dt.x<0||dt.x>=fi||dt.y<0||dt.y>=fi)return;const{x:vi,y:ni,z:gi}=j.projectTilePoint(dt.x,dt.y,ri),Ot=new ao(vi,ni,gi,0,void 0);(function(Et,wi,Bi,lr,Gi,cr,Ri,Si,$i,Ki,er,hr,fr,rn,qr,Ui,Dr,nn,yr,pr,Zi,qi,Zr,Pr,sr){const Br=Et.addToLineVertexArray(wi,lr);let Sr,mr,_n,Fo,Dl,Pl,Af,If=0,Cf=0,kf=0,Df=0,bu=-1,wu=-1;const Zn={};let Pf=Nn(""),Eu=0,Tu=0;if($i._unevaluatedLayout.getValue("text-radial-offset")===void 0?[Eu,Tu]=$i.layout.get("text-offset").evaluate(Zi,{},sr).map(on=>on*Er):(Eu=$i.layout.get("text-radial-offset").evaluate(Zi,{},sr)*Er,Tu=ru),Et.allowVerticalPlacement&&Gi.vertical){const on=Gi.vertical;if(qr)Pl=ou(on),Si&&(Af=ou(Si));else{const sn=$i.layout.get("text-rotate").evaluate(Zi,{},sr)+90;_n=Wc(Ki,Bi,wi,er,hr,fr,on,rn,sn,Ui),Si&&(Fo=Wc(Ki,Bi,wi,er,hr,fr,Si,nn,sn))}}if(cr){const on=$i.layout.get("icon-rotate").evaluate(Zi,{},sr),sn=$i.layout.get("icon-text-fit")!=="none",Bl=$d(cr,on,Zr,sn),Su=Si?$d(Si,on,Zr,sn):void 0;mr=Wc(Ki,Bi,wi,er,hr,fr,cr,nn,on),If=4*Bl.length;const Bf=Et.iconSizeData;let xs=null;Bf.kind==="source"?(xs=[Vn*$i.layout.get("icon-size").evaluate(Zi,{},sr)],xs[0]>Do&&ot(`${Et.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Bf.kind==="composite"&&(xs=[Vn*qi.compositeIconSizes[0].evaluate(Zi,{},sr),Vn*qi.compositeIconSizes[1].evaluate(Zi,{},sr)],(xs[0]>Do||xs[1]>Do)&&ot(`${Et.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),Et.addSymbols(Et.icon,Bl,xs,pr,yr,Zi,!1,Bi,wi,Br.lineStartIndex,Br.lineLength,-1,Pr,sr),bu=Et.icon.placedSymbolArray.length-1,Su&&(Cf=4*Su.length,Et.addSymbols(Et.icon,Su,xs,pr,yr,Zi,dn.vertical,Bi,wi,Br.lineStartIndex,Br.lineLength,-1,Pr,sr),wu=Et.icon.placedSymbolArray.length-1)}for(const on in Gi.horizontal){const sn=Gi.horizontal[on];Sr||(Pf=Nn(sn.text),qr?Dl=ou(sn):Sr=Wc(Ki,Bi,wi,er,hr,fr,sn,rn,$i.layout.get("text-rotate").evaluate(Zi,{},sr),Ui));const Bl=sn.positionedLines.length===1;if(kf+=jd(Et,Bi,wi,sn,Ri,$i,qr,Zi,Ui,Br,Gi.vertical?dn.horizontal:dn.horizontalOnly,Bl?Object.keys(Gi.horizontal):[on],Zn,bu,qi,Pr,sr),Bl)break}Gi.vertical&&(Df+=jd(Et,Bi,wi,Gi.vertical,Ri,$i,qr,Zi,Ui,Br,dn.vertical,["vertical"],Zn,wu,qi,Pr,sr));let Oo=-1;const Mu=(on,sn)=>on?Math.max(on,sn):sn;Oo=Mu(Dl,Oo),Oo=Mu(Pl,Oo),Oo=Mu(Af,Oo);const ng=Oo>-1?1:0;Et.glyphOffsetArray.length>=Po.MAX_GLYPHS&&ot("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Zi.sortKey!==void 0&&Et.addToSortKeyRanges(Et.symbolInstances.length,Zi.sortKey),Et.symbolInstances.emplaceBack(Bi.x,Bi.y,Bi.z,wi.x,wi.y,Zn.right>=0?Zn.right:-1,Zn.center>=0?Zn.center:-1,Zn.left>=0?Zn.left:-1,Zn.vertical>=0?Zn.vertical:-1,bu,wu,Pf,Sr!==void 0?Sr:Et.collisionBoxArray.length,Sr!==void 0?Sr+1:Et.collisionBoxArray.length,_n!==void 0?_n:Et.collisionBoxArray.length,_n!==void 0?_n+1:Et.collisionBoxArray.length,mr!==void 0?mr:Et.collisionBoxArray.length,mr!==void 0?mr+1:Et.collisionBoxArray.length,Fo||Et.collisionBoxArray.length,Fo?Fo+1:Et.collisionBoxArray.length,er,kf,Df,If,Cf,ng,0,Eu,Tu,Oo)})(d,dt,Ot,lt,f,m,y,st,d.layers[0],d.collisionBoxArray,e.index,e.sourceLayerIndex,d.index,Le,Xe,P,0,Fe,We,ae,e,b,L,N,U)};if(tt==="line")for(const lt of Fd(e.geometry,0,0,fi,fi)){const dt=gm(lt,Be,Oe,f.vertical||pe,m,24,Ie,d.overscaling,fi);for(const ri of dt){const vi=pe;vi&&Mm(d,vi.text,nt,ri)||mt(lt,ri,U)}}else if(tt==="line-center"){for(const lt of e.geometry)if(lt.length>1){const dt=mm(lt,Oe,f.vertical||pe,m,24,Ie);dt&&mt(lt,dt,U)}}else if(e.type==="Polygon")for(const lt of Zh(e.geometry,0)){const dt=vm(lt,16);mt(lt[0],new ao(dt.x,dt.y,0,0,void 0),U)}else if(e.type==="LineString")for(const lt of e.geometry)mt(lt,new ao(lt[0].x,lt[0].y,0,0,void 0),U);else if(e.type==="Point")for(const lt of e.geometry)for(const dt of lt)mt([dt],new ao(dt.x,dt.y,0,0,void 0),U)}const Do=32640;function jd(d,e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae,pe){const ve=function(Le,Fe,Oe,Xe,We,tt,nt,qe){const Qe=[];if(Fe.positionedLines.length===0)return Qe;const st=Xe.layout.get("text-rotate").evaluate(tt,{})*Math.PI/180,mt=function(ni){const gi=ni[0],Ot=ni[1],Et=gi*Ot;return Et>0?[gi,-Ot]:Et<0?[-gi,Ot]:gi===0?[Ot,gi]:[Ot,-gi]}(Oe);let lt=Math.abs(Fe.top-Fe.bottom);for(const ni of Fe.positionedLines)lt-=ni.lineOffset;const dt=Fe.positionedLines.length,ri=lt/dt;let vi=Fe.top-Oe[1];for(let ni=0;ni<dt;++ni){const gi=Fe.positionedLines[ni];vi=_m(Fe,ri,vi,ni);for(const Ot of gi.positionedGlyphs){if(!Ot.rect)continue;const Et=Ot.rect||{};let wi=4,Bi=!0,lr=1,Gi=0;if(Ot.imageName){const qi=nt[Ot.imageName];if(!qi)continue;if(qi.sdf){ot("SDF images are not supported in formatted text and will be ignored.");continue}Bi=!1,lr=qi.pixelRatio,wi=1/lr}const cr=(We||qe)&&Ot.vertical,Ri=Ot.metrics.advance*Ot.scale/2,Si=Ot.metrics,$i=Ot.rect;if($i===null)continue;qe&&Fe.verticalizable&&(Gi=Ot.imageName?Ri-Ot.metrics.width*Ot.scale/2:0);const Ki=We?[Ot.x+Ri,Ot.y]:[0,0];let er=[0,0],hr=[0,0],fr=!1;We||(cr?(hr=[Ot.x+Ri+mt[0],Ot.y+mt[1]-Gi],fr=!0):er=[Ot.x+Ri+Oe[0],Ot.y+Oe[1]-Gi]);const rn=$i.w*Ot.scale/(lr*(Ot.localGlyph?2:1)),qr=$i.h*Ot.scale/(lr*(Ot.localGlyph?2:1));let Ui,Dr,nn,yr;if(cr){const qi=Ot.y-vi,Zr=new z(-Ri,Ri-qi),Pr=-Math.PI/2,sr=new z(...hr);Ui=new z(-Ri+er[0],er[1]),Ui._rotateAround(Pr,Zr)._add(sr),Ui.x+=-qi+Ri,Ui.y-=(Si.left-wi)*Ot.scale;const Br=Ot.imageName?Si.advance*Ot.scale:Er*Ot.scale,Sr=String.fromCharCode(Ot.glyph);Jp(Sr)?Ui.x+=(1-wi)*Ot.scale:Qp(Sr)?Ui.x+=Br-Si.height*Ot.scale+(-wi-1)*Ot.scale:Ui.x+=Ot.imageName||Si.width+2*wi===$i.w&&Si.height+2*wi===$i.h?(Br-qr)/2:(Br-(Si.height+2*wi)*Ot.scale)/2,Dr=new z(Ui.x,Ui.y-rn),nn=new z(Ui.x+qr,Ui.y),yr=new z(Ui.x+qr,Ui.y-rn)}else{const qi=(Si.left-wi)*Ot.scale-Ri+er[0],Zr=(-Si.top-wi)*Ot.scale+er[1],Pr=qi+rn,sr=Zr+qr;Ui=new z(qi,Zr),Dr=new z(Pr,Zr),nn=new z(qi,sr),yr=new z(Pr,sr)}if(st){let qi;qi=We?new z(0,0):fr?new z(mt[0],mt[1]):new z(Oe[0],Oe[1]),Ui._rotateAround(st,qi),Dr._rotateAround(st,qi),nn._rotateAround(st,qi),yr._rotateAround(st,qi)}const pr=new z(0,0),Zi=new z(0,0);Qe.push({tl:Ui,tr:Dr,bl:nn,br:yr,tex:Et,writingMode:Fe.writingMode,glyphOffset:Ki,sectionIndex:Ot.sectionIndex,isSDF:Bi,pixelOffsetTL:pr,pixelOffsetBR:Zi,minFontScaleX:0,minFontScaleY:0})}}return Qe}(0,m,P,b,M,I,y,d.allowVerticalPlacement),Ie=d.textSizeData;let Be=null;Ie.kind==="source"?(Be=[Vn*b.layout.get("text-size").evaluate(I,{},pe)],Be[0]>Do&&ot(`${d.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Ie.kind==="composite"&&(Be=[Vn*ne.compositeTextSizes[0].evaluate(I,{},pe),Vn*ne.compositeTextSizes[1].evaluate(I,{},pe)],(Be[0]>Do||Be[1]>Do)&&ot(`${d.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),d.addSymbols(d.text,ve,Be,P,M,I,N,e,f,L.lineStartIndex,L.lineLength,H,ae,pe);for(const Le of U)j[Le]=d.text.placedSymbolArray.length-1;return 4*ve.length}function Gd(d){for(const e in d)return d[e];return null}function Wc(d,e,f,m,y,b,M,I,P,L){let N=M.top,U=M.bottom,j=M.left,H=M.right;const ne=M.collisionPadding;if(ne&&(j-=ne[0],N-=ne[1],H+=ne[2],U+=ne[3]),P){const ae=new z(j,N),pe=new z(H,N),ve=new z(j,U),Ie=new z(H,U),Be=J(P);let Le=new z(0,0);L&&(Le=new z(L[0],L[1])),ae._rotateAround(Be,Le),pe._rotateAround(Be,Le),ve._rotateAround(Be,Le),Ie._rotateAround(Be,Le),j=Math.min(ae.x,pe.x,ve.x,Ie.x),H=Math.max(ae.x,pe.x,ve.x,Ie.x),N=Math.min(ae.y,pe.y,ve.y,Ie.y),U=Math.max(ae.y,pe.y,ve.y,Ie.y)}return d.emplaceBack(e.x,e.y,e.z,f.x,f.y,j,N,H,U,I,m,y,b),d.length-1}function ou(d){d.collisionPadding&&(d.top-=d.collisionPadding[1],d.bottom+=d.collisionPadding[3]);const e=d.bottom-d.top;return e>0?Math.max(10,e):null}function Mm(d,e,f,m){const y=d.compareText;if(e in y){const b=y[e];for(let M=b.length-1;M>=0;M--)if(m.dist(b[M])<f)return!0}else y[e]=[];return y[e].push(m),!1}const Sm=gs.VectorTileFeature.types,Am=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Hc(d,e,f,m,y,b,M,I,P,L,N,U,j,H,ne,ae){const pe=N?Math.min(Do,Math.round(N[0])):0,ve=N?Math.min(Do,Math.round(N[1])):0;d.emplaceBack(e,f,Math.round(32*M),Math.round(32*I),P,L,(pe<<1)+(U?1:0),ve,16*j,16*H,256*ne,256*ae,m,y,b,0)}function su(d,e,f){d.emplaceBack(e.x,e.y,f),d.emplaceBack(e.x,e.y,f),d.emplaceBack(e.x,e.y,f),d.emplaceBack(e.x,e.y,f)}function Im(d){for(const e of d.sections)if(bh(e.text))return!0;return!1}class au{constructor(e){this.layoutVertexArray=new Ye,this.indexArray=new At,this.programConfigurations=e,this.segments=new Qi,this.dynamicLayoutVertexArray=new ct,this.opacityVertexArray=new Ve,this.placedSymbolArray=new Mn}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(e,f,m,y){this.isEmpty()||(m&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,qp.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,f),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Zp.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Am,!0),this.opacityVertexBuffer.itemSize=1),(m||y)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Mt(au,"SymbolBuffers");class lu{constructor(e,f,m){this.layoutVertexArray=new e,this.layoutAttributes=f,this.indexArray=new m,this.segments=new Qi,this.collisionVertexArray=new Je,this.collisionVertexArrayExt=new ct}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Xp.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,Yp.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Mt(lu,"CollisionBuffers");class Po{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(M=>M.id),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Un([]),this.placementViewportMatrix=Un([]);const f=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Wh(this.zoom,f["text-size"]),this.iconSizeData=Wh(this.zoom,f["icon-size"]);const m=this.layers[0].layout,y=m.get("symbol-sort-key"),b=m.get("symbol-z-order");this.canOverlap=m.get("text-allow-overlap")||m.get("icon-allow-overlap")||m.get("text-ignore-placement")||m.get("icon-ignore-placement"),this.sortFeaturesByKey=b!=="viewport-y"&&y.constantOr(1)!==void 0,this.sortFeaturesByY=(b==="viewport-y"||b==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=m.get("text-writing-mode").map(M=>dn[M]),this.stateDependentLayerIds=this.layers.filter(M=>M.isStateDependent()).map(M=>M.id),this.sourceID=e.sourceID,this.projection=e.projection}createArrays(){this.text=new au(new ds(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new au(new ds(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new Pi,this.lineVertexArray=new nr,this.symbolInstances=new Ji}calculateGlyphDependencies(e,f,m,y,b){for(let M=0;M<e.length;M++)if(f[e.charCodeAt(M)]=!0,y&&b){const I=xl[e.charAt(M)];I&&(f[I.charCodeAt(0)]=!0)}}populate(e,f,m,y){const b=this.layers[0],M=b.layout,I=M.get("text-font"),P=M.get("text-field"),L=M.get("icon-image"),N=(P.value.kind!=="constant"||P.value.value instanceof ar&&!P.value.value.isEmpty()||P.value.value.toString().length>0)&&(I.value.kind!=="constant"||I.value.value.length>0),U=L.value.kind!=="constant"||!!L.value.value||Object.keys(L.parameters).length>0,j=M.get("symbol-sort-key");if(this.features=[],!N&&!U)return;const H=f.iconDependencies,ne=f.glyphDependencies,ae=f.availableImages,pe=new ji(this.zoom);for(const{feature:ve,id:Ie,index:Be,sourceLayerIndex:Le}of e){const Fe=b._featureFilter.needGeometry,Oe=fs(ve,Fe);if(!b._featureFilter.filter(pe,Oe,m))continue;let Xe,We;if(Fe||(Oe.geometry=no(ve,m,y)),N){const nt=b.getValueAndResolveTokens("text-field",Oe,m,ae),qe=ar.factory(nt);Im(qe)&&(this.hasRTLText=!0),(!this.hasRTLText||Js()==="unavailable"||this.hasRTLText&&Hr.isParsed())&&(Xe=Kp(qe,b,Oe))}if(U){const nt=b.getValueAndResolveTokens("icon-image",Oe,m,ae);We=nt instanceof Fr?nt:Fr.fromString(nt)}if(!Xe&&!We)continue;const tt=this.sortFeaturesByKey?j.evaluate(Oe,{},m):void 0;if(this.features.push({id:Ie,text:Xe,icon:We,index:Be,sourceLayerIndex:Le,geometry:Oe.geometry,properties:ve.properties,type:Sm[ve.type],sortKey:tt}),We&&(H[We.name]=!0),Xe){const nt=I.evaluate(Oe,{},m).join(","),qe=M.get("text-rotation-alignment")==="map"&&M.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(dn.vertical)>=0;for(const Qe of Xe.sections)if(Qe.image)H[Qe.image.name]=!0;else{const st=Ys(Xe.toString()),mt=Qe.fontStack||nt,lt=ne[mt]=ne[mt]||{};this.calculateGlyphDependencies(Qe.text,lt,qe,this.allowVerticalPlacement,st)}}}M.get("symbol-placement")==="line"&&(this.features=function(ve){const Ie={},Be={},Le=[];let Fe=0;function Oe(nt){Le.push(ve[nt]),Fe++}function Xe(nt,qe,Qe){const st=Be[nt];return delete Be[nt],Be[qe]=st,Le[st].geometry[0].pop(),Le[st].geometry[0]=Le[st].geometry[0].concat(Qe[0]),st}function We(nt,qe,Qe){const st=Ie[qe];return delete Ie[qe],Ie[nt]=st,Le[st].geometry[0].shift(),Le[st].geometry[0]=Qe[0].concat(Le[st].geometry[0]),st}function tt(nt,qe,Qe){const st=Qe?qe[0][qe[0].length-1]:qe[0][0];return`${nt}:${st.x}:${st.y}`}for(let nt=0;nt<ve.length;nt++){const qe=ve[nt],Qe=qe.geometry,st=qe.text?qe.text.toString():null;if(!st){Oe(nt);continue}const mt=tt(st,Qe),lt=tt(st,Qe,!0);if(mt in Be&&lt in Ie&&Be[mt]!==Ie[lt]){const dt=We(mt,lt,Qe),ri=Xe(mt,lt,Le[dt].geometry);delete Ie[mt],delete Be[lt],Be[tt(st,Le[ri].geometry,!0)]=ri,Le[dt].geometry=null}else mt in Be?Xe(mt,lt,Qe):lt in Ie?We(mt,lt,Qe):(Oe(nt),Ie[mt]=Fe-1,Be[lt]=Fe-1)}return Le.filter(nt=>nt.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((ve,Ie)=>ve.sortKey-Ie.sortKey)}update(e,f,m,y){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,f,this.layers,m,y),this.icon.programConfigurations.updatePaintArrays(e,f,this.layers,m,y))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,f){const m=this.lineVertexArray.length,y=e.segment;if(y!==void 0){let b=e.dist(f[y+1]),M=e.dist(f[y]);const I={};for(let P=y+1;P<f.length;P++)I[P]={x:f[P].x,y:f[P].y,tileUnitDistanceFromAnchor:b},P<f.length-1&&(b+=f[P+1].dist(f[P]));for(let P=y||0;P>=0;P--)I[P]={x:f[P].x,y:f[P].y,tileUnitDistanceFromAnchor:M},P>0&&(M+=f[P-1].dist(f[P]));for(let P=0;P<f.length;P++){const L=I[P];this.lineVertexArray.emplaceBack(L.x,L.y,L.tileUnitDistanceFromAnchor)}}return{lineStartIndex:m,lineLength:this.lineVertexArray.length-m}}addSymbols(e,f,m,y,b,M,I,P,L,N,U,j,H,ne){const ae=e.indexArray,pe=e.layoutVertexArray,ve=e.segments.prepareSegment(4*f.length,pe,ae,this.canOverlap?M.sortKey:void 0),Ie=this.glyphOffsetArray.length,Be=ve.vertexLength,Le=this.allowVerticalPlacement&&I===dn.vertical?Math.PI/2:0,Fe=M.text&&M.text.sections;for(let Oe=0;Oe<f.length;Oe++){const{tl:Xe,tr:We,bl:tt,br:nt,tex:qe,pixelOffsetTL:Qe,pixelOffsetBR:st,minFontScaleX:mt,minFontScaleY:lt,glyphOffset:dt,isSDF:ri,sectionIndex:vi}=f[Oe],ni=ve.vertexLength,gi=dt[1];Hc(pe,P.x,P.y,P.z,L.x,L.y,Xe.x,gi+Xe.y,qe.x,qe.y,m,ri,Qe.x,Qe.y,mt,lt),Hc(pe,P.x,P.y,P.z,L.x,L.y,We.x,gi+We.y,qe.x+qe.w,qe.y,m,ri,st.x,Qe.y,mt,lt),Hc(pe,P.x,P.y,P.z,L.x,L.y,tt.x,gi+tt.y,qe.x,qe.y+qe.h,m,ri,Qe.x,st.y,mt,lt),Hc(pe,P.x,P.y,P.z,L.x,L.y,nt.x,gi+nt.y,qe.x+qe.w,qe.y+qe.h,m,ri,st.x,st.y,mt,lt),su(e.dynamicLayoutVertexArray,P,Le),ae.emplaceBack(ni,ni+1,ni+2),ae.emplaceBack(ni+1,ni+2,ni+3),ve.vertexLength+=4,ve.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(dt[0]),Oe!==f.length-1&&vi===f[Oe+1].sectionIndex||e.programConfigurations.populatePaintArrays(pe.length,M,M.index,{},H,ne,Fe&&Fe[vi])}e.placedSymbolArray.emplaceBack(P.x,P.y,P.z,L.x,L.y,Ie,this.glyphOffsetArray.length-Ie,Be,N,U,L.segment,m?m[0]:0,m?m[1]:0,y[0],y[1],I,0,!1,0,j,0)}_commitLayoutVertex(e,f,m,y,b,M,I){e.emplaceBack(f,m,y,b,M,Math.round(I.x),Math.round(I.y))}_addCollisionDebugVertices(e,f,m,y,b,M,I){const P=m.segments.prepareSegment(4,m.layoutVertexArray,m.indexArray),L=P.vertexLength,N=I.tileAnchorX,U=I.tileAnchorY;for(let H=0;H<4;H++)m.collisionVertexArray.emplaceBack(0,0,0,0);m.collisionVertexArrayExt.emplaceBack(f,-e.padding,-e.padding),m.collisionVertexArrayExt.emplaceBack(f,e.padding,-e.padding),m.collisionVertexArrayExt.emplaceBack(f,e.padding,e.padding),m.collisionVertexArrayExt.emplaceBack(f,-e.padding,e.padding),this._commitLayoutVertex(m.layoutVertexArray,y,b,M,N,U,new z(e.x1,e.y1)),this._commitLayoutVertex(m.layoutVertexArray,y,b,M,N,U,new z(e.x2,e.y1)),this._commitLayoutVertex(m.layoutVertexArray,y,b,M,N,U,new z(e.x2,e.y2)),this._commitLayoutVertex(m.layoutVertexArray,y,b,M,N,U,new z(e.x1,e.y2)),P.vertexLength+=4;const j=m.indexArray;j.emplaceBack(L,L+1),j.emplaceBack(L+1,L+2),j.emplaceBack(L+2,L+3),j.emplaceBack(L+3,L),P.primitiveLength+=4}_addTextDebugCollisionBoxes(e,f,m,y,b,M){for(let I=y;I<b;I++){const P=m.get(I),L=this.getSymbolInstanceTextSize(e,M,f,I);this._addCollisionDebugVertices(P,L,this.textCollisionBox,P.projectedAnchorX,P.projectedAnchorY,P.projectedAnchorZ,M)}}_addIconDebugCollisionBoxes(e,f,m,y,b,M){for(let I=y;I<b;I++){const P=m.get(I),L=this.getSymbolInstanceIconSize(e,f,I);this._addCollisionDebugVertices(P,L,this.iconCollisionBox,P.projectedAnchorX,P.projectedAnchorY,P.projectedAnchorZ,M)}}generateCollisionDebugBuffers(e,f){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new lu(at,yd.members,ti),this.iconCollisionBox=new lu(at,yd.members,ti);const m=la(this.iconSizeData,e),y=la(this.textSizeData,e);for(let b=0;b<this.symbolInstances.length;b++){const M=this.symbolInstances.get(b);this._addTextDebugCollisionBoxes(y,e,f,M.textBoxStartIndex,M.textBoxEndIndex,M),this._addTextDebugCollisionBoxes(y,e,f,M.verticalTextBoxStartIndex,M.verticalTextBoxEndIndex,M),this._addIconDebugCollisionBoxes(m,e,f,M.iconBoxStartIndex,M.iconBoxEndIndex,M),this._addIconDebugCollisionBoxes(m,e,f,M.verticalIconBoxStartIndex,M.verticalIconBoxEndIndex,M)}}getSymbolInstanceTextSize(e,f,m,y){const b=this.text.placedSymbolArray.get(f.rightJustifiedTextSymbolIndex>=0?f.rightJustifiedTextSymbolIndex:f.centerJustifiedTextSymbolIndex>=0?f.centerJustifiedTextSymbolIndex:f.leftJustifiedTextSymbolIndex>=0?f.leftJustifiedTextSymbolIndex:f.verticalPlacedTextSymbolIndex>=0?f.verticalPlacedTextSymbolIndex:y),M=jc(this.textSizeData,e,b)/Er;return this.tilePixelRatio*M}getSymbolInstanceIconSize(e,f,m){const y=this.icon.placedSymbolArray.get(m),b=jc(this.iconSizeData,e,y);return this.tilePixelRatio*b}_commitDebugCollisionVertexUpdate(e,f,m){e.emplaceBack(f,-m,-m),e.emplaceBack(f,m,-m),e.emplaceBack(f,m,m),e.emplaceBack(f,-m,m)}_updateTextDebugCollisionBoxes(e,f,m,y,b,M){for(let I=y;I<b;I++){const P=m.get(I),L=this.getSymbolInstanceTextSize(e,M,f,I);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,L,P.padding)}}_updateIconDebugCollisionBoxes(e,f,m,y,b){for(let M=y;M<b;M++){const I=m.get(M),P=this.getSymbolInstanceIconSize(e,f,M);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,P,I.padding)}}updateCollisionDebugBuffers(e,f){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const m=la(this.iconSizeData,e),y=la(this.textSizeData,e);for(let b=0;b<this.symbolInstances.length;b++){const M=this.symbolInstances.get(b);this._updateTextDebugCollisionBoxes(y,e,f,M.textBoxStartIndex,M.textBoxEndIndex,M),this._updateTextDebugCollisionBoxes(y,e,f,M.verticalTextBoxStartIndex,M.verticalTextBoxEndIndex,M),this._updateIconDebugCollisionBoxes(m,e,f,M.iconBoxStartIndex,M.iconBoxEndIndex),this._updateIconDebugCollisionBoxes(m,e,f,M.verticalIconBoxStartIndex,M.verticalIconBoxEndIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,f,m,y,b,M,I,P,L){const N={};for(let U=f;U<m;U++){const j=e.get(U);N.textBox={x1:j.x1,y1:j.y1,x2:j.x2,y2:j.y2,padding:j.padding,projectedAnchorX:j.projectedAnchorX,projectedAnchorY:j.projectedAnchorY,projectedAnchorZ:j.projectedAnchorZ,tileAnchorX:j.tileAnchorX,tileAnchorY:j.tileAnchorY},N.textFeatureIndex=j.featureIndex;break}for(let U=y;U<b;U++){const j=e.get(U);N.verticalTextBox={x1:j.x1,y1:j.y1,x2:j.x2,y2:j.y2,padding:j.padding,projectedAnchorX:j.projectedAnchorX,projectedAnchorY:j.projectedAnchorY,projectedAnchorZ:j.projectedAnchorZ,tileAnchorX:j.tileAnchorX,tileAnchorY:j.tileAnchorY},N.verticalTextFeatureIndex=j.featureIndex;break}for(let U=M;U<I;U++){const j=e.get(U);N.iconBox={x1:j.x1,y1:j.y1,x2:j.x2,y2:j.y2,padding:j.padding,projectedAnchorX:j.projectedAnchorX,projectedAnchorY:j.projectedAnchorY,projectedAnchorZ:j.projectedAnchorZ,tileAnchorX:j.tileAnchorX,tileAnchorY:j.tileAnchorY},N.iconFeatureIndex=j.featureIndex;break}for(let U=P;U<L;U++){const j=e.get(U);N.verticalIconBox={x1:j.x1,y1:j.y1,x2:j.x2,y2:j.y2,padding:j.padding,projectedAnchorX:j.projectedAnchorX,projectedAnchorY:j.projectedAnchorY,projectedAnchorZ:j.projectedAnchorZ,tileAnchorX:j.tileAnchorX,tileAnchorY:j.tileAnchorY},N.verticalIconFeatureIndex=j.featureIndex;break}return N}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let f=0;f<this.symbolInstances.length;f++){const m=this.symbolInstances.get(f);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,m.textBoxStartIndex,m.textBoxEndIndex,m.verticalTextBoxStartIndex,m.verticalTextBoxEndIndex,m.iconBoxStartIndex,m.iconBoxEndIndex,m.verticalIconBoxStartIndex,m.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,f){const m=e.placedSymbolArray.get(f),y=m.vertexStartIndex+4*m.numGlyphs;for(let b=m.vertexStartIndex;b<y;b+=4)e.indexArray.emplaceBack(b,b+1,b+2),e.indexArray.emplaceBack(b+1,b+2,b+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const f=Math.sin(e),m=Math.cos(e),y=[],b=[],M=[];for(let I=0;I<this.symbolInstances.length;++I){M.push(I);const P=this.symbolInstances.get(I);y.push(0|Math.round(f*P.tileAnchorX+m*P.tileAnchorY)),b.push(P.featureIndex)}return M.sort((I,P)=>y[I]-y[P]||b[P]-b[I]),M}addToSortKeyRanges(e,f){const m=this.sortKeyRanges[this.sortKeyRanges.length-1];m&&m.sortKey===f?m.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:f,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const f of this.symbolInstanceIndexes){const m=this.symbolInstances.get(f);this.featureSortOrder.push(m.featureIndex),[m.rightJustifiedTextSymbolIndex,m.centerJustifiedTextSymbolIndex,m.leftJustifiedTextSymbolIndex].forEach((y,b,M)=>{y>=0&&M.indexOf(y)===b&&this.addIndicesForPlacedSymbol(this.text,y)}),m.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,m.verticalPlacedTextSymbolIndex),m.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,m.placedIconSymbolIndex),m.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,m.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Mt(Po,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Po.MAX_GLYPHS=65535,Po.addDynamicAttributes=su;const Cm=new te({"symbol-placement":new B($e.layout_symbol["symbol-placement"]),"symbol-spacing":new B($e.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new B($e.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new F($e.layout_symbol["symbol-sort-key"]),"symbol-z-order":new B($e.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new B($e.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new B($e.layout_symbol["icon-ignore-placement"]),"icon-optional":new B($e.layout_symbol["icon-optional"]),"icon-rotation-alignment":new B($e.layout_symbol["icon-rotation-alignment"]),"icon-size":new F($e.layout_symbol["icon-size"]),"icon-text-fit":new B($e.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new B($e.layout_symbol["icon-text-fit-padding"]),"icon-image":new F($e.layout_symbol["icon-image"]),"icon-rotate":new F($e.layout_symbol["icon-rotate"]),"icon-padding":new B($e.layout_symbol["icon-padding"]),"icon-keep-upright":new B($e.layout_symbol["icon-keep-upright"]),"icon-offset":new F($e.layout_symbol["icon-offset"]),"icon-anchor":new F($e.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new B($e.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new B($e.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new B($e.layout_symbol["text-rotation-alignment"]),"text-field":new F($e.layout_symbol["text-field"]),"text-font":new F($e.layout_symbol["text-font"]),"text-size":new F($e.layout_symbol["text-size"]),"text-max-width":new F($e.layout_symbol["text-max-width"]),"text-line-height":new F($e.layout_symbol["text-line-height"]),"text-letter-spacing":new F($e.layout_symbol["text-letter-spacing"]),"text-justify":new F($e.layout_symbol["text-justify"]),"text-radial-offset":new F($e.layout_symbol["text-radial-offset"]),"text-variable-anchor":new B($e.layout_symbol["text-variable-anchor"]),"text-anchor":new F($e.layout_symbol["text-anchor"]),"text-max-angle":new B($e.layout_symbol["text-max-angle"]),"text-writing-mode":new B($e.layout_symbol["text-writing-mode"]),"text-rotate":new F($e.layout_symbol["text-rotate"]),"text-padding":new B($e.layout_symbol["text-padding"]),"text-keep-upright":new B($e.layout_symbol["text-keep-upright"]),"text-transform":new F($e.layout_symbol["text-transform"]),"text-offset":new F($e.layout_symbol["text-offset"]),"text-allow-overlap":new B($e.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new B($e.layout_symbol["text-ignore-placement"]),"text-optional":new B($e.layout_symbol["text-optional"])});var cu={paint:new te({"icon-opacity":new F($e.paint_symbol["icon-opacity"]),"icon-color":new F($e.paint_symbol["icon-color"]),"icon-halo-color":new F($e.paint_symbol["icon-halo-color"]),"icon-halo-width":new F($e.paint_symbol["icon-halo-width"]),"icon-halo-blur":new F($e.paint_symbol["icon-halo-blur"]),"icon-translate":new B($e.paint_symbol["icon-translate"]),"icon-translate-anchor":new B($e.paint_symbol["icon-translate-anchor"]),"text-opacity":new F($e.paint_symbol["text-opacity"]),"text-color":new F($e.paint_symbol["text-color"],{runtimeType:fn,getOverride:d=>d.textColor,hasOverride:d=>!!d.textColor}),"text-halo-color":new F($e.paint_symbol["text-halo-color"]),"text-halo-width":new F($e.paint_symbol["text-halo-width"]),"text-halo-blur":new F($e.paint_symbol["text-halo-blur"]),"text-translate":new B($e.paint_symbol["text-translate"]),"text-translate-anchor":new B($e.paint_symbol["text-translate-anchor"])}),layout:Cm};class qd{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:yn,this.defaultValue=e}evaluate(e){if(e.formattedSection){const f=this.defaultValue.property.overrides;if(f&&f.hasOverride(e.formattedSection))return f.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Mt(qd,"FormatSectionOverride",{omit:["defaultValue"]});class Kc extends An{constructor(e){super(e,cu)}recalculate(e,f){super.recalculate(e,f),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const m=this.layout.get("text-writing-mode");if(m){const y=[];for(const b of m)y.indexOf(b)<0&&y.push(b);this.layout._values["text-writing-mode"]=y}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(e,f,m,y){const b=this.layout.get(e).evaluate(f,{},m,y),M=this._unevaluatedLayout._values[e];return M.isDataDriven()||yo(M.value)||!b?b:function(I,P){return P.replace(/{([^{}]+)}/g,(L,N)=>N in I?String(I[N]):"")}(f.properties,b)}createBucket(e){return new Po(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of cu.paint.overridableProperties){if(!Kc.hasPaintOverride(this.layout,e))continue;const f=this.paint.get(e),m=new qd(f),y=new Os(m,f.property.specification);let b=null;b=f.value.kind==="constant"||f.value.kind==="source"?new za("source",y):new Fa("composite",y,f.value.zoomStops,f.value._interpolationType),this.paint._values[e]=new C(f.property,b,f.parameters)}}_handleOverridablePaintPropertyUpdate(e,f,m){return!(!this.layout||f.isDataDriven()||m.isDataDriven())&&Kc.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,f){const m=e.get("text-field"),y=cu.paint.properties[f];let b=!1;const M=I=>{for(const P of I)if(y.overrides&&y.overrides.hasOverride(P))return void(b=!0)};if(m.value.kind==="constant"&&m.value.value instanceof ar)M(m.value.value.sections);else if(m.value.kind==="source"){const I=L=>{b||(L instanceof vn&&rr(L.value)===co?M(L.value.sections):L instanceof fo?M(L.sections):L.eachChild(I))},P=m.value;P._styleExpression&&I(P._styleExpression.expression)}return b}getProgramConfiguration(e){return new Ao(this,e)}}var km={paint:new te({"background-color":new B($e.paint_background["background-color"]),"background-pattern":new Z($e.paint_background["background-pattern"]),"background-opacity":new B($e.paint_background["background-opacity"])})},Dm={paint:new te({"raster-opacity":new B($e.paint_raster["raster-opacity"]),"raster-hue-rotate":new B($e.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new B($e.paint_raster["raster-brightness-min"]),"raster-brightness-max":new B($e.paint_raster["raster-brightness-max"]),"raster-saturation":new B($e.paint_raster["raster-saturation"]),"raster-contrast":new B($e.paint_raster["raster-contrast"]),"raster-resampling":new B($e.paint_raster["raster-resampling"]),"raster-fade-duration":new B($e.paint_raster["raster-fade-duration"])})};class Pm extends An{constructor(e){super(e,{}),this.implementation=e}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}var Bm={paint:new te({"sky-type":new B($e.paint_sky["sky-type"]),"sky-atmosphere-sun":new B($e.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new B($e.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new B($e.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new B($e.paint_sky["sky-gradient-radius"]),"sky-gradient":new X($e.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new B($e.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new B($e.paint_sky["sky-atmosphere-color"]),"sky-opacity":new B($e.paint_sky["sky-opacity"])})};function hu(d,e,f){const m=[0,0,1],y=Ku([]);return function(b,M,I){I*=.5;var P=M[0],L=M[1],N=M[2],U=M[3],j=Math.sin(I),H=Math.cos(I);b[0]=P*H-N*j,b[1]=L*H+U*j,b[2]=N*H+P*j,b[3]=U*H-L*j}(y,y,f?-J(d)+Math.PI:J(d)),Ju(y,y,-J(e)),Wu(m,m,y),ll(m,m)}const Rm={circle:class extends An{constructor(d){super(d,Qf)}createBucket(d){return new Ch(d)}queryRadius(d){const e=d;return ra("circle-radius",this,e)+ra("circle-stroke-width",this,e)+Rc(this.paint.get("circle-translate"))}queryIntersectsFeature(d,e,f,m,y,b,M,I){const P=Uu(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),b.angle,d.pixelToTileUnitsFactor),L=this.paint.get("circle-radius").evaluate(e,f)+this.paint.get("circle-stroke-width").evaluate(e,f);return Qu(d,m,b,M,I,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",P,L)}getProgramIds(){return["circle"]}getProgramConfiguration(d){return new Ao(this,d)}},heatmap:class extends An{createBucket(d){return new td(d)}constructor(d){super(d,sp),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(d){d==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Vh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(d){return ra("heatmap-radius",this,d)}queryIntersectsFeature(d,e,f,m,y,b,M,I){const P=this.paint.get("heatmap-radius").evaluate(e,f);return Qu(d,m,b,M,I,!0,!0,new z(0,0),P)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(d){return new Ao(this,d)}},hillshade:class extends An{constructor(d){super(d,ap)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}},fill:class extends An{constructor(d){super(d,Tp)}getProgramIds(){const d=this.paint.get("fill-pattern"),e=d&&d.constantOr(1),f=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&f.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),f}getProgramConfiguration(d){return new Ao(this,d)}recalculate(d,e){super.recalculate(d,e);const f=this.paint._values["fill-outline-color"];f.value.kind==="constant"&&f.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(d){return new $c(d)}queryRadius(){return Rc(this.paint.get("fill-translate"))}queryIntersectsFeature(d,e,f,m,y,b){return!d.queryGeometry.isAboveHorizon&&zu($u(d.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),b.angle,d.pixelToTileUnitsFactor),m)}isTileClipped(){return!0}},"fill-extrusion":class extends An{constructor(d){super(d,zp)}createBucket(d){return new _l(d)}queryRadius(){return Rc(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(d){return new Ao(this,d)}queryIntersectsFeature(d,e,f,m,y,b,M,I,P){const L=Uu(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),b.angle,d.pixelToTileUnitsFactor),N=this.paint.get("fill-extrusion-height").evaluate(e,f),U=this.paint.get("fill-extrusion-base").evaluate(e,f),j=[0,0],H=I&&b.elevation,ne=b.elevation?b.elevation.exaggeration():1,ae=d.tile.getBucket(this);if(H&&ae instanceof _l){const Ie=ae.centroidVertexArray,Be=P+1;if(Be<Ie.length){const Le=Ie.get(Be);j[0]=Le.a_centroid_pos0,j[1]=Le.a_centroid_pos1}}if(j[0]===0&&j[1]===1)return!1;const pe=function(Ie,Be,Le,Fe,Oe,Xe,We,tt,nt){return Xe?function(qe,Qe,st,mt,lt,dt,ri,vi,ni){const gi=[],Ot=[],Et=[0,0,0,1];for(const wi of qe){const Bi=[],lr=[];for(const Gi of wi){const cr=Gi.x+mt.x,Ri=Gi.y+mt.y,Si=Fp(cr,Ri,Qe,st,dt,ri,vi,ni);Et[0]=cr,Et[1]=Ri,Et[2]=Si.base,Et[3]=1,oa(Et,Et,lt),Et[3]=Math.max(Et[3],1e-5);const $i=pd([Et[0]/Et[3],Et[1]/Et[3],Et[2]/Et[3]]);Et[0]=cr,Et[1]=Ri,Et[2]=Si.top,Et[3]=1,oa(Et,Et,lt),Et[3]=Math.max(Et[3],1e-5);const Ki=pd([Et[0]/Et[3],Et[1]/Et[3],Et[2]/Et[3]]);Bi.push($i),lr.push(Ki)}gi.push(Bi),Ot.push(lr)}return[gi,Ot]}(Ie,Be,Le,Fe,Oe,Xe,We,tt,nt):function(qe,Qe,st,mt,lt){const dt=[],ri=[],vi=lt[8]*Qe,ni=lt[9]*Qe,gi=lt[10]*Qe,Ot=lt[11]*Qe,Et=lt[8]*st,wi=lt[9]*st,Bi=lt[10]*st,lr=lt[11]*st;for(const Gi of qe){const cr=[],Ri=[];for(const Si of Gi){const $i=Si.x+mt.x,Ki=Si.y+mt.y,er=lt[0]*$i+lt[4]*Ki+lt[12],hr=lt[1]*$i+lt[5]*Ki+lt[13],fr=lt[2]*$i+lt[6]*Ki+lt[14],rn=lt[3]*$i+lt[7]*Ki+lt[15],qr=er+vi,Ui=hr+ni,Dr=fr+gi,nn=Math.max(rn+Ot,1e-5),yr=er+Et,pr=hr+wi,Zi=fr+Bi,qi=Math.max(rn+lr,1e-5),Zr=new z(qr/nn,Ui/nn);Zr.z=Dr/nn,cr.push(Zr);const Pr=new z(yr/qi,pr/qi);Pr.z=Zi/qi,Ri.push(Pr)}dt.push(cr),ri.push(Ri)}return[dt,ri]}(Ie,Be,Le,Fe,Oe)}(m,U,N,L,M,H?I:null,j,ne,b.center.lat),ve=d.queryGeometry;return function(Ie,Be,Le){let Fe=1/0;zu(Le,Be)&&(Fe=fd(Le,Be[0]));for(let Oe=0;Oe<Be.length;Oe++){const Xe=Be[Oe],We=Ie[Oe];for(let tt=0;tt<Xe.length-1;tt++){const nt=Xe[tt],qe=[nt,Xe[tt+1],We[tt+1],We[tt],nt];Lu(Le,qe)&&(Fe=Math.min(Fe,fd(Le,qe)))}}return Fe!==1/0&&Fe}(pe[0],pe[1],ve.isPointQuery()?ve.screenBounds:ve.screenGeometry)}},line:class extends An{constructor(d){super(d,md),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(d){if(d==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Go,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(d,e){super.recalculate(d,e),this.paint._values["line-floorwidth"]=gd.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,d)}createBucket(d){return new Vc(d)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(d){return new Ao(this,d)}queryRadius(d){const e=d,f=_d(ra("line-width",this,e),ra("line-gap-width",this,e)),m=ra("line-offset",this,e);return f/2+Math.abs(m)+Rc(this.paint.get("line-translate"))}queryIntersectsFeature(d,e,f,m,y,b){if(d.queryGeometry.isAboveHorizon)return!1;const M=$u(d.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),b.angle,d.pixelToTileUnitsFactor),I=d.pixelToTileUnitsFactor/2*_d(this.paint.get("line-width").evaluate(e,f),this.paint.get("line-gap-width").evaluate(e,f)),P=this.paint.get("line-offset").evaluate(e,f);return P&&(m=function(L,N){const U=[],j=new z(0,0);for(let H=0;H<L.length;H++){const ne=L[H],ae=[];for(let pe=0;pe<ne.length;pe++){const ve=ne[pe-1],Ie=ne[pe],Be=ne[pe+1],Le=pe===0?j:Ie.sub(ve)._unit()._perp(),Fe=pe===ne.length-1?j:Be.sub(Ie)._unit()._perp(),Oe=Le._add(Fe)._unit();Oe._mult(1/(Oe.x*Fe.x+Oe.y*Fe.y)),ae.push(Oe._mult(N)._add(Ie))}U.push(ae)}return U}(m,P*d.pixelToTileUnitsFactor)),function(L,N,U){for(let j=0;j<N.length;j++){const H=N[j];if(L.length>=3){for(let ne=0;ne<H.length;ne++)if(ia(L,H[ne]))return!0}if(Wf(L,H,U))return!0}return!1}(M,m,I)}isTileClipped(){return!0}},symbol:Kc,background:class extends An{constructor(d){super(d,km)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends An{constructor(d){super(d,Dm)}getProgramIds(){return["raster"]}},sky:class extends An{constructor(d){super(d,Bm),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(d){d==="sky-gradient"?this._updateColorRamp():d!=="sky-atmosphere-sun"&&d!=="sky-atmosphere-halo-color"&&d!=="sky-atmosphere-color"&&d!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Vh({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(d){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=d.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(d,e){if(this.paint.get("sky-type")==="atmosphere"){const m=this.paint.get("sky-atmosphere-sun"),y=!m,b=d.style.light,M=b.properties.get("position");return y&&b.properties.get("anchor")==="viewport"&&ot("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),y?hu(M.azimuthal,90-M.polar,e):hu(m[0],90-m[1],e)}const f=this.paint.get("sky-gradient-center");return hu(f[0],90-f[1],e)}is3D(){return!1}isSky(){return!0}markSkyboxValid(d){this._skyboxInvalidated=!1,this._lightPosition=d.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const d=this.paint.get("sky-type");return d==="atmosphere"?["skyboxCapture","skybox"]:d==="gradient"?["skyboxGradient"]:null}}};class El{constructor(e,f,m,y){this.context=e,this.format=m,this.texture=e.gl.createTexture(),this.update(f,y)}update(e,f,m){const{width:y,height:b}=e,{context:M}=this,{gl:I}=M,{HTMLImageElement:P,HTMLCanvasElement:L,HTMLVideoElement:N,ImageData:U,ImageBitmap:j}=O;if(I.bindTexture(I.TEXTURE_2D,this.texture),M.pixelStoreUnpackFlipY.set(!1),M.pixelStoreUnpack.set(1),M.pixelStoreUnpackPremultiplyAlpha.set(this.format===I.RGBA&&(!f||f.premultiply!==!1)),m||this.size&&this.size[0]===y&&this.size[1]===b){const{x:H,y:ne}=m||{x:0,y:0};e instanceof P||e instanceof L||e instanceof N||e instanceof U||j&&e instanceof j?I.texSubImage2D(I.TEXTURE_2D,0,H,ne,I.RGBA,I.UNSIGNED_BYTE,e):I.texSubImage2D(I.TEXTURE_2D,0,H,ne,y,b,I.RGBA,I.UNSIGNED_BYTE,e.data)}else this.size=[y,b],e instanceof P||e instanceof L||e instanceof N||e instanceof U||j&&e instanceof j?I.texImage2D(I.TEXTURE_2D,0,this.format,this.format,I.UNSIGNED_BYTE,e):I.texImage2D(I.TEXTURE_2D,0,this.format,y,b,0,this.format,I.UNSIGNED_BYTE,e.data);this.useMipmap=Boolean(f&&f.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&I.generateMipmap(I.TEXTURE_2D)}bind(e,f){const{context:m}=this,{gl:y}=m;y.bindTexture(y.TEXTURE_2D,this.texture),e!==this.filter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,e),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,this.useMipmap?e===y.NEAREST?y.NEAREST_MIPMAP_NEAREST:y.LINEAR_MIPMAP_NEAREST:e),this.filter=e),f!==this.wrap&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,f),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,f),this.wrap=f)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class uu{constructor(e,f){this.width=e,this.height=f,this.nextRow=0,this.image=new oo({width:e,height:f}),this.positions={},this.uploaded=!1}getDash(e,f){const m=this.getKey(e,f);return this.positions[m]}trim(){const e=this.width,f=this.height=rt(this.nextRow);this.image.resize({width:e,height:f})}getKey(e,f){return e.join(",")+f}getDashRanges(e,f,m){const y=[];let b=e.length%2==1?-e[e.length-1]*m:0,M=e[0]*m,I=!0;y.push({left:b,right:M,isDash:I,zeroLength:e[0]===0});let P=e[0];for(let L=1;L<e.length;L++){I=!I;const N=e[L];b=P*m,P+=N,M=P*m,y.push({left:b,right:M,isDash:I,zeroLength:N===0})}return y}addRoundDash(e,f,m){const y=f/2;for(let b=-m;b<=m;b++){const M=this.width*(this.nextRow+m+b);let I=0,P=e[I];for(let L=0;L<this.width;L++){L/P.right>1&&(P=e[++I]);const N=Math.abs(L-P.left),U=Math.abs(L-P.right),j=Math.min(N,U);let H;const ne=b/m*(y+1);if(P.isDash){const ae=y-Math.abs(ne);H=Math.sqrt(j*j+ae*ae)}else H=y-Math.sqrt(j*j+ne*ne);this.image.data[M+L]=Math.max(0,Math.min(255,H+128))}}}addRegularDash(e,f){for(let P=e.length-1;P>=0;--P){const L=e[P],N=e[P+1];L.zeroLength?e.splice(P,1):N&&N.isDash===L.isDash&&(N.left=L.left,e.splice(P,1))}const m=e[0],y=e[e.length-1];m.isDash===y.isDash&&(m.left=y.left-this.width,y.right=m.right+this.width);const b=this.width*this.nextRow;let M=0,I=e[M];for(let P=0;P<this.width;P++){P/I.right>1&&(I=e[++M]);const L=Math.abs(P-I.left),N=Math.abs(P-I.right),U=Math.min(L,N);this.image.data[b+P]=Math.max(0,Math.min(255,(I.isDash?U:-U)+f+128))}}addDash(e,f){const m=this.getKey(e,f);if(this.positions[m])return this.positions[m];const y=f==="round",b=y?7:0,M=2*b+1;if(this.nextRow+M>this.height)return ot("LineAtlas out of space"),null;e.length===0&&e.push(1);let I=0;for(let N=0;N<e.length;N++)e[N]<0&&(ot("Negative value is found in line dasharray, replacing values with 0"),e[N]=0),I+=e[N];if(I!==0){const N=this.width/I,U=this.getDashRanges(e,this.width,N);y?this.addRoundDash(U,N,b):this.addRegularDash(U,f==="square"?.5*N:0)}const P=this.nextRow+b;this.nextRow+=M;const L={tl:[P,b],br:[I,0]};return this.positions[m]=L,L}}Mt(uu,"LineAtlas");class Lm{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel!="undefined"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}const zm=O.performance;function Zd(d){const e=d?d.url.toString():void 0;return zm.getEntriesByName(e)}class Fm{constructor(){this.tasks={},this.taskQueue=[],zt(["process"],this),this.invoker=new Lm(this.process),this.nextId=0}add(e,f){const m=this.nextId++,y=function({type:b,isSymbolTile:M,zoom:I}){return I=I||0,b==="message"?0:b!=="maybePrepare"||M?b!=="parseTile"||M?b==="parseTile"&&M?300-I:b==="maybePrepare"&&M?400-I:500:200-I:100-I}(f);if(y===0){Bt();try{e()}finally{}return{cancel:()=>{}}}return this.tasks[m]={fn:e,metadata:f,priority:y,id:m},this.taskQueue.push(m),this.invoker.trigger(),{cancel:()=>{delete this.tasks[m]}}}process(){Bt();try{if(this.taskQueue=this.taskQueue.filter(m=>!!this.tasks[m]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const f=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!f)return;f.fn()}finally{}}pick(){let e=null,f=1/0;for(let y=0;y<this.taskQueue.length;y++){const b=this.tasks[this.taskQueue[y]];b.priority<f&&(f=b.priority,e=y)}if(e===null)return null;const m=this.taskQueue[e];return this.taskQueue.splice(e,1),m}remove(){this.invoker.remove()}}const Om=Se([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_merc_pos",components:2},{type:"Float32",name:"a_uv",components:2}]),Nm=Se([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Xd}=Om,Yd=Se([{name:"a_pos_3",components:3,type:"Int16"}]);var Tl=Se([{name:"a_pos",type:"Int16",components:2}]);const pa=fi/Math.PI/2,en=-pa,tn=pa,$m=[new un([en,en,en],[tn,tn,tn]),new un([en,en,en],[0,0,tn]),new un([0,en,en],[tn,0,tn]),new un([en,0,en],[0,tn,tn]),new un([0,0,en],[tn,tn,tn])];class Um{constructor(e,f,m){this.a=na([],e,m),this.b=na([],f,m),this.center=m;const y=ll([],this.a),b=ll([],this.b);this.angle=Math.acos(cl(y,b))}}function du(d,e){if(d.angle===0)return null;let f;return f=d.a[e]===0?1/d.angle*.5*Math.PI:1/d.angle*Math.atan(d.b[e]/d.a[e]/Math.sin(d.angle)-1/Math.tan(d.angle)),f<0||f>1?null:function(m,y,b,M){const I=Math.sin(b);return m*(Math.sin((1-M)*b)/I)+y*(Math.sin(M*b)/I)}(d.a[e],d.b[e],d.angle,_e(f,0,1))+d.center[e]}function Ml(d){if(d.z<=1)return $m[d.z+2*d.y+d.x];const[e,f]=fu(d),m=[lo(e[0],e[1]),lo(e[0],f[1]),lo(f[0],e[1]),lo(f[0],f[1])],y=[tn,tn,tn],b=[en,en,en];for(const M of m)y[0]=Math.min(y[0],M[0]),y[1]=Math.min(y[1],M[1]),y[2]=Math.min(y[2],M[2]),b[0]=Math.max(b[0],M[0]),b[1]=Math.max(b[1],M[1]),b[2]=Math.max(b[2],M[2]);return new un(y,b)}function Vm(d,e,f){const m=e/d.worldSize,y=(Qe,st)=>{al(Qe,Qe,m),al(st,st,m)},b=Number.MAX_VALUE,M=[-b,-b,-b],I=[b,b,b],P=Qd(d);if(f.z<=1){const Qe=Ml(f).getCorners();for(let st=0;st<Qe.length;st++)ms(Qe[st],Qe[st],P),Fh(I,I,Qe[st]),Oh(M,M,Qe[st]);return y(I,M),new un(I,M)}const[L,N]=fu(f),U=new Io;U.setSouthWest([L[1],N[0]]),U.setNorthEast([N[1],L[0]]);const j=[lo(U.getSouth(),U.getWest()),lo(U.getSouth(),U.getEast()),lo(U.getNorth(),U.getEast()),lo(U.getNorth(),U.getWest())];for(let Qe=0;Qe<j.length;Qe++)ms(j[Qe],j[Qe],P),Fh(I,I,j[Qe]),Oh(M,M,j[Qe]);if(U.contains(d.center))return M[2]=0,y(I,M),new un(I,M);const H=[P[12],P[13],P[14]],ne=d.center.lng,ae=_e(d.center.lat,-85.051129,$n),pe=[ol(ne),ea(ae)],ve=U.getCenter().lng,Ie=_e(U.getCenter().lat,-85.051129,$n),Be=[ol(ve),ea(Ie)];let Le=new Array(3),Fe=0;const Oe=pe[0]-Be[0],Xe=pe[1]-Be[1];if(Math.abs(Oe)>Math.abs(Xe))Fe=Oe>=0?1:3,Le=H;else{Fe=Xe>=0?0:2;const Qe=[P[4],P[5],P[6]];let st;st=Xe>=0?-Math.sin(J(U.getSouth()))*pa:-Math.sin(J(U.getNorth()))*pa,Le=Nh(Le,H,Qe,st)}const We=j[Fe],tt=j[(Fe+1)%4],nt=new Um(We,tt,Le),qe=[du(nt,0)||We[0],du(nt,1)||We[1],du(nt,2)||We[2]];return I[2]=Math.min(We[2],tt[2]),Fh(I,I,qe),Oh(M,M,qe),y(I,M),new un(I,M)}function fu(d){const e=1<<d.z,f=d.x/e,m=(d.x+1)/e,y=(d.y+1)/e;return[[wr(d.y/e),mn(f)],[wr(y),mn(m)]]}function Wd(d,e,f,m=pa){return f=J(f),[d*Math.sin(f)*m,-e*m,d*Math.cos(f)*m]}function lo(d,e,f){return Wd(Math.cos(J(d)),Math.sin(J(d)),e,f)}function Hd(d,e,f){const m=Math.pow(2,f.z),y=(d/fi+f.x)/m;return lo(wr((e/fi+f.y)/m),mn(y))}function pu(d){return 16383/Math.max(...na([],d.max,d.min))}function Kd(d){const e=Un(new Float64Array(16)),f=pu(d);var m,y;return Co(e,e,[f,f,f]),ps(e,e,((m=[])[0]=-(y=d.min)[0],m[1]=-y[1],m[2]=-y[2],m)),e}function Jd(d,e,f,m,y){const b=function(P){const L=fi/(2*Math.PI);return P/(2*Math.PI)/L}(f),M=[d,e,-f/(2*Math.PI)],I=Un(new Float64Array(16));return ps(I,I,M),Co(I,I,[b,b,b]),Rh(I,I,J(-y)),Lh(I,I,J(-m)),I}function Qd(d){const{x:e,y:f}=d.point,{lng:m,lat:y}=d._center;return Jd(e,f,d.worldSize,m,y)}const ef=J(85),jm=Math.cos(ef),Gm=Math.sin(ef);function tf(d,e,f){var m=2*Math.PI*6378137/256/Math.pow(2,f);return[d*m-2*Math.PI*6378137/2,e*m-2*Math.PI*6378137/2]}class Jc{constructor(e,f,m){this.z=e,this.x=f,this.y=m,this.key=Sl(0,e,e,f,m)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,f){const m=function(b,M,I){var P=tf(256*b,256*(M=Math.pow(2,I)-M-1),I),L=tf(256*(b+1),256*(M+1),I);return P[0]+","+P[1]+","+L[0]+","+L[1]}(this.x,this.y,this.z),y=function(b,M,I){let P,L="";for(let N=b;N>0;N--)P=1<<N-1,L+=(M&P?1:0)+(I&P?2:0);return L}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace("{z}",String(this.z)).replace("{x}",String(this.x)).replace("{y}",String(f==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",y).replace("{bbox-epsg-3857}",m)}toString(){return`${this.z}/${this.x}/${this.y}`}}class rf{constructor(e,f){this.wrap=e,this.canonical=f,this.key=Sl(e,f.z,f.z,f.x,f.y)}}class kr{constructor(e,f,m,y,b){this.overscaledZ=e,this.wrap=f,this.canonical=new Jc(m,+y,+b),this.key=f===0&&e===m?this.canonical.key:Sl(f,e,m,y,b)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const f=this.canonical.z-e;return e>this.canonical.z?new kr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new kr(e,this.wrap,e,this.canonical.x>>f,this.canonical.y>>f)}calculateScaledKey(e,f=!0){if(this.overscaledZ===e&&f)return this.key;if(e>this.canonical.z)return Sl(this.wrap*+f,e,this.canonical.z,this.canonical.x,this.canonical.y);{const m=this.canonical.z-e;return Sl(this.wrap*+f,e,e,this.canonical.x>>m,this.canonical.y>>m)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const f=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>f&&e.canonical.y===this.canonical.y>>f}children(e){if(this.overscaledZ>=e)return[new kr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const f=this.canonical.z+1,m=2*this.canonical.x,y=2*this.canonical.y;return[new kr(f,this.wrap,f,m,y),new kr(f,this.wrap,f,m+1,y),new kr(f,this.wrap,f,m,y+1),new kr(f,this.wrap,f,m+1,y+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new kr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new kr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new rf(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Sl(d,e,f,m,y){const b=1<<Math.min(f,22);let M=b*(y%b)+m%b;return d&&f<22&&(M+=b*b*((d<0?-2*d-1:2*d)%(1<<2*(22-f)))),16*(32*M+f)+(e-f)}function _s(d,e){if(!e.isReprojectedInTileSpace)return{scale:1<<d.z,x:d.x,y:d.y,x2:d.x+1,y2:d.y+1,projection:e};const f=Math.pow(2,-d.z),m=d.x*f,y=(d.x+1)*f,b=d.y*f,M=(d.y+1)*f,I=mn(m),P=mn(y),L=wr(b),N=wr(M),U=e.project(I,L),j=e.project(P,L),H=e.project(P,N),ne=e.project(I,N);let ae=Math.min(U.x,j.x,H.x,ne.x),pe=Math.min(U.y,j.y,H.y,ne.y),ve=Math.max(U.x,j.x,H.x,ne.x),Ie=Math.max(U.y,j.y,H.y,ne.y);const Be=f/16;function Le(Oe,Xe,We,tt,nt,qe){const Qe=(We+nt)/2,st=(tt+qe)/2,mt=e.project(mn(Qe),wr(st)),lt=Math.max(0,ae-mt.x,pe-mt.y,mt.x-ve,mt.y-Ie);ae=Math.min(ae,mt.x),ve=Math.max(ve,mt.x),pe=Math.min(pe,mt.y),Ie=Math.max(Ie,mt.y),lt>Be&&(Le(Oe,mt,We,tt,Qe,st),Le(mt,Xe,Qe,st,nt,qe))}Le(U,j,m,b,y,b),Le(j,H,y,b,y,M),Le(H,ne,y,M,m,M),Le(ne,U,m,M,m,b),ae-=Be,pe-=Be,ve+=Be,Ie+=Be;const Fe=1/Math.max(ve-ae,Ie-pe);return{scale:Fe,x:ae*Fe,y:pe*Fe,x2:ve*Fe,y2:Ie*Fe,projection:e}}Mt(Jc,"CanonicalTileID"),Mt(kr,"OverscaledTileID",{omit:["projMatrix"]});class nf{constructor(e){this._stringToNumber={},this._numberToString=[];for(let f=0;f<e.length;f++){const m=e[f];this._stringToNumber[m]=f,this._numberToString[f]=m}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const qm=["tile","layer","source","sourceLayer","state"];class of{constructor(e,f,m,y,b){this.type="Feature",this._vectorTileFeature=e,this._z=f,this._x=m,this._y=y,this.properties=e.properties,this.id=b}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",geometry:this.geometry,properties:this.properties};this.id!==void 0&&(e.id=this.id);for(const f of qm)this[f]!==void 0&&(e[f]=this[f]);return e}}const gn=32,jn=33,Bo=new Uint16Array(8184);for(let d=0;d<2046;d++){let e=d+2,f=0,m=0,y=0,b=0,M=0,I=0;for(1&e?y=b=M=gn:f=m=I=gn;(e>>=1)>1;){const L=f+y>>1,N=m+b>>1;1&e?(y=f,b=m,f=M,m=I):(f=y,m=b,y=M,b=I),M=L,I=N}const P=4*d;Bo[P+0]=f,Bo[P+1]=m,Bo[P+2]=y,Bo[P+3]=b}const Gn=new Uint16Array(2178),Ro=new Uint8Array(1089),Qc=new Uint16Array(1089);function sf(d){return d===0?-.03125:d===32?.03125:0}var af=Se([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const lf={type:2,extent:fi,loadGeometry:()=>[[new z(0,0),new z(8193,0),new z(8193,8193),new z(0,8193),new z(0,0)]]};class mu{constructor(e,f,m,y,b){this.tileID=e,this.uid=Ne(),this.uses=0,this.tileSize=f,this.tileZoom=m,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=b,this.expiredRequestCount=0,this.state="loading",y&&y.transform&&(this.projection=y.transform.projection)}registerFadeDuration(e){const f=e+this.timeAdded;f<ft.now()||this.fadeEndTime&&f<this.fadeEndTime||(this.fadeEndTime=f)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=_s(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(e,f,m){if(this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(y,b){const M={};if(!b)return M;for(const I of y){const P=I.layerIds.map(L=>b.getLayer(L)).filter(Boolean);if(P.length!==0){I.layers=P,I.stateDependentLayerIds&&(I.stateDependentLayers=I.stateDependentLayerIds.map(L=>P.filter(N=>N.id===L)[0]));for(const L of P)M[L.id]=I}}return M}(e.buckets,f.style),this.hasSymbolBuckets=!1;for(const y in this.buckets){const b=this.buckets[y];if(b instanceof Po){if(this.hasSymbolBuckets=!0,!m)break;b.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const y in this.buckets){const b=this.buckets[y];if(b instanceof Po&&b.hasRTLText){this.hasRTLText=!0,Hr.isLoading()||Hr.isLoaded()||Js()!=="deferred"||Eo();break}}this.queryPadding=0;for(const y in this.buckets){const b=this.buckets[y];this.queryPadding=Math.max(this.queryPadding,f.style.getLayer(y).queryRadius(b))}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage),e.lineAtlas&&(this.lineAtlas=e.lineAtlas)}else this.collisionBoxArray=new Tn}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugIndexBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(e){return this.buckets[e.id]}upload(e){for(const m in this.buckets){const y=this.buckets[m];y.uploadPending()&&y.upload(e)}const f=e.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new El(e,this.imageAtlas.image,f.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new El(e,this.glyphAtlasImage,f.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new El(e,this.lineAtlas.image,f.ALPHA),this.lineAtlas.uploaded=!0)}prepare(e){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture)}queryRenderedFeatures(e,f,m,y,b,M,I,P){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:y,pixelPosMatrix:I,transform:M,params:b,tileTransform:this.tileTransform},e,f,m):{}}querySourceFeatures(e,f){const m=this.latestFeatureIndex;if(!m||!m.rawTileData)return;const y=m.loadVTLayers(),b=f?f.sourceLayer:"",M=y._geojsonTileLayer||y[b];if(!M)return;const I=Rn(f&&f.filter),{z:P,x:L,y:N}=this.tileID.canonical,U={z:P,x:L,y:N};for(let j=0;j<M.length;j++){const H=M.feature(j);if(I.needGeometry){const pe=fs(H,!0);if(!I.filter(new ji(this.tileID.overscaledZ),pe,this.tileID.canonical))continue}else if(!I.filter(new ji(this.tileID.overscaledZ),H))continue;const ne=m.getId(H,b),ae=new of(H,P,L,N,ne);ae.tile=U,e.push(ae)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(e){const f=this.expirationTime;if(e.cacheControl){const m=Zt(e.cacheControl);m["max-age"]&&(this.expirationTime=Date.now()+1e3*m["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const m=Date.now();let y=!1;if(this.expirationTime>m)y=!1;else if(f)if(this.expirationTime<f)y=!0;else{const b=this.expirationTime-f;b?this.expirationTime=m+Math.max(b,3e4):y=!0}else y=!0;y?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(e,f){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(e).length===0||!f)return;const m=this.latestFeatureIndex.loadVTLayers(),y=f.style.listImages();for(const b in this.buckets){if(!f.style.hasLayer(b))continue;const M=this.buckets[b],I=M.layers[0].sourceLayer||"_geojsonTileLayer",P=m[I],L=e[I];if(!P||!L||Object.keys(L).length===0)continue;if(M.update(L,P,y,this.imageAtlas&&this.imageAtlas.patternPositions||{}),M instanceof Vc||M instanceof $c){const U=f.style._getSourceCache(M.layers[0].source);f._terrain&&f._terrain.enabled&&U&&M.programConfigurations.needsUpload&&f._terrain._clearRenderCacheForTile(U.id,this.tileID)}const N=f&&f.style&&f.style.getLayer(b);N&&(this.queryPadding=Math.max(this.queryPadding,N.queryRadius(M)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<ft.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=ft.now()+e}setTexture(e,f){const m=f.context,y=m.gl;this.texture=f.getTileTexture(e.width),this.texture?this.texture.update(e,{useMipmap:!0}):(this.texture=new El(m,e,y.RGBA,{useMipmap:!0}),this.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE),m.extTextureFilterAnisotropic&&y.texParameterf(y.TEXTURE_2D,m.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,m.extTextureFilterAnisotropicMax))}setDependencies(e,f){const m={};for(const y of f)m[y]=!0;this.dependencies[e]=m}hasDependency(e,f){for(const m of e){const y=this.dependencies[m];if(y){for(const b of f)if(y[b])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(e,f){if(!f||f.name==="mercator"||this._tileDebugBuffer)return;const m=no(lf,this.tileID.canonical,this.tileTransform)[0],y=new Te,b=new Ii;for(let M=0;M<m.length;M++){const{x:I,y:P}=m[M];y.emplaceBack(I,P),b.emplaceBack(M)}b.emplaceBack(0),this._tileDebugIndexBuffer=e.createIndexBuffer(b),this._tileDebugBuffer=e.createVertexBuffer(y,Tl.members),this._tileDebugSegments=Qi.simpleSegment(0,0,y.length,b.length)}_makeTileBoundsBuffers(e,f){if(this._tileBoundsBuffer||!f||f.name==="mercator")return;const m=no(lf,this.tileID.canonical,this.tileTransform)[0];let y,b;if(this.isRaster){const M=function(I,P){const L=_s(I,P),N=Math.pow(2,I.z);for(let pe=0;pe<jn;pe++)for(let ve=0;ve<jn;ve++){const Ie=mn((I.x+(ve+sf(ve))/gn)/N),Be=wr((I.y+(pe+sf(pe))/gn)/N),Le=P.project(Ie,Be),Fe=pe*jn+ve;Gn[2*Fe+0]=Math.round((Le.x*L.scale-L.x)*fi),Gn[2*Fe+1]=Math.round((Le.y*L.scale-L.y)*fi)}Ro.fill(0),Qc.fill(0);for(let pe=2045;pe>=0;pe--){const ve=4*pe,Ie=Bo[ve+0],Be=Bo[ve+1],Le=Bo[ve+2],Fe=Bo[ve+3],Oe=Ie+Le>>1,Xe=Be+Fe>>1,We=Oe+Xe-Be,tt=Xe+Ie-Oe,nt=Be*jn+Ie,qe=Fe*jn+Le,Qe=Xe*jn+Oe,st=Math.hypot((Gn[2*nt+0]+Gn[2*qe+0])/2-Gn[2*Qe+0],(Gn[2*nt+1]+Gn[2*qe+1])/2-Gn[2*Qe+1])>=16;if(Ro[Qe]=Ro[Qe]||(st?1:0),pe<1022){const mt=(Be+tt>>1)*jn+(Ie+We>>1),lt=(Fe+tt>>1)*jn+(Le+We>>1);Ro[Qe]=Ro[Qe]||Ro[mt]||Ro[lt]}}const U=new Ae,j=new At;let H=0;function ne(pe,ve){const Ie=ve*jn+pe;return Qc[Ie]===0&&(U.emplaceBack(Gn[2*Ie+0],Gn[2*Ie+1],pe*fi/gn,ve*fi/gn),Qc[Ie]=++H),Qc[Ie]-1}function ae(pe,ve,Ie,Be,Le,Fe){const Oe=pe+Ie>>1,Xe=ve+Be>>1;if(Math.abs(pe-Le)+Math.abs(ve-Fe)>1&&Ro[Xe*jn+Oe])ae(Le,Fe,pe,ve,Oe,Xe),ae(Ie,Be,Le,Fe,Oe,Xe);else{const We=ne(pe,ve),tt=ne(Ie,Be),nt=ne(Le,Fe);j.emplaceBack(We,tt,nt)}}return ae(0,0,gn,gn,gn,0),ae(gn,gn,0,0,0,gn),{vertices:U,indices:j}}(this.tileID.canonical,f);y=M.vertices,b=M.indices}else{y=new Ae,b=new At;for(const{x:I,y:P}of m)y.emplaceBack(I,P,0,0);const M=Lc(y.int16,void 0,4);for(let I=0;I<M.length;I+=3)b.emplaceBack(M[I],M[I+1],M[I+2])}this._tileBoundsBuffer=e.createVertexBuffer(y,af.members),this._tileBoundsIndexBuffer=e.createIndexBuffer(b),this._tileBoundsSegments=Qi.simpleSegment(0,0,y.length,b.length)}_makeGlobeTileDebugBuffers(e,f){if(this._globeTileDebugBorderBuffer||this._globeTileDebugTextBuffer||!f||f.name!=="globe")return;const m=this.tileID.canonical,y=Kd(Ml(m));this._makeGlobeTileDebugBorderBuffer(e,m,y),this._makeGlobeTileDebugTextBuffer(e,m,y)}_makeGlobeTileDebugBorderBuffer(e,f,m){const y=new Te,b=new Ii,M=new Me,I=(L,N,U,j,H)=>{const ne=(U-L)/(H-1),ae=(j-N)/(H-1),pe=y.length;for(let ve=0;ve<H;ve++){const Ie=L+ve*ne,Be=N+ve*ae;y.emplaceBack(Ie,Be);const Le=Hd(Ie,Be,f),Fe=ms(Le,Le,m);M.emplaceBack(Fe[0],Fe[1],Fe[2]),b.emplaceBack(pe+ve)}},P=fi;I(0,0,P,0,16),I(P,0,P,P,16),I(P,P,0,P,16),I(0,P,0,0,16),this._tileDebugIndexBuffer=e.createIndexBuffer(b),this._tileDebugBuffer=e.createVertexBuffer(y,Tl.members),this._globeTileDebugBorderBuffer=e.createVertexBuffer(M,Yd.members),this._tileDebugSegments=Qi.simpleSegment(0,0,y.length,b.length)}_makeGlobeTileDebugTextBuffer(e,f,m){const y=new Te,b=new At,M=new Me,I=25;b.reserve(32),y.reserve(I),M.reserve(I);const P=(L,N)=>I*L+N;for(let L=0;L<I;L++){const N=2048*L;for(let U=0;U<I;U++){const j=2048*U;y.emplaceBack(j,N);const H=Hd(j,N,f),ne=ms(H,H,m);M.emplaceBack(ne[0],ne[1],ne[2])}}for(let L=0;L<4;L++)for(let N=0;N<4;N++){const U=P(L,N),j=P(L,N+1),H=P(L+1,N),ne=P(L+1,N+1);b.emplaceBack(U,j,H),b.emplaceBack(H,j,ne)}this._tileDebugTextIndexBuffer=e.createIndexBuffer(b),this._tileDebugTextBuffer=e.createVertexBuffer(y,Tl.members),this._globeTileDebugTextBuffer=e.createVertexBuffer(M,Yd.members),this._tileDebugTextSegments=Qi.simpleSegment(0,0,I,32)}}class Zm{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,f,m){const y=String(f);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][y]=this.stateChanges[e][y]||{},ue(this.stateChanges[e][y],m),this.deletedStates[e]===null){this.deletedStates[e]={};for(const b in this.state[e])b!==y&&(this.deletedStates[e][b]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][y]===null){this.deletedStates[e][y]={};for(const b in this.state[e][y])m[b]||(this.deletedStates[e][y][b]=null)}else for(const b in m)this.deletedStates[e]&&this.deletedStates[e][y]&&this.deletedStates[e][y][b]===null&&delete this.deletedStates[e][y][b]}removeFeatureState(e,f,m){if(this.deletedStates[e]===null)return;const y=String(f);if(this.deletedStates[e]=this.deletedStates[e]||{},m&&f!==void 0)this.deletedStates[e][y]!==null&&(this.deletedStates[e][y]=this.deletedStates[e][y]||{},this.deletedStates[e][y][m]=null);else if(f!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][y])for(m in this.deletedStates[e][y]={},this.stateChanges[e][y])this.deletedStates[e][y][m]=null;else this.deletedStates[e][y]=null;else this.deletedStates[e]=null}getState(e,f){const m=String(f),y=ue({},(this.state[e]||{})[m],(this.stateChanges[e]||{})[m]);if(this.deletedStates[e]===null)return{};if(this.deletedStates[e]){const b=this.deletedStates[e][f];if(b===null)return{};for(const M in b)delete y[M]}return y}initializeTileState(e,f){e.setFeatureState(this.state,f)}coalesceChanges(e,f){const m={};for(const y in this.stateChanges){this.state[y]=this.state[y]||{};const b={};for(const M in this.stateChanges[y])this.state[y][M]||(this.state[y][M]={}),ue(this.state[y][M],this.stateChanges[y][M]),b[M]=this.state[y][M];m[y]=b}for(const y in this.deletedStates){this.state[y]=this.state[y]||{};const b={};if(this.deletedStates[y]===null)for(const M in this.state[y])b[M]={},this.state[y][M]={};else for(const M in this.deletedStates[y]){if(this.deletedStates[y][M]===null)this.state[y][M]={};else for(const I of Object.keys(this.deletedStates[y][M]))delete this.state[y][M][I];b[M]=this.state[y][M]}m[y]=m[y]||{},ue(m[y],b)}if(this.stateChanges={},this.deletedStates={},Object.keys(m).length!==0)for(const y in e)e[y].setFeatureState(m,f)}}class cf{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,f){const m=this.toIdx(e,f);return{min:this.minimums[m],max:this.maximums[m]}}isLeaf(e,f){return this.leaves[this.toIdx(e,f)]}toIdx(e,f){return f*this.size+e}}function hf(d,e,f,m){let y=0,b=Number.MAX_VALUE;for(let M=0;M<3;M++)if(Math.abs(m[M])<1e-15){if(f[M]<d[M]||f[M]>e[M])return null}else{const I=1/m[M];let P=(d[M]-f[M])*I,L=(e[M]-f[M])*I;if(P>L){const N=P;P=L,L=N}if(P>y&&(y=P),L<b&&(b=L),y>b)return null}return y}function uf(d,e,f,m,y,b,M,I,P,L,N){const U=m-d,j=y-e,H=b-f,ne=M-d,ae=I-e,pe=P-f,ve=N[1]*pe-N[2]*ae,Ie=N[2]*ne-N[0]*pe,Be=N[0]*ae-N[1]*ne,Le=U*ve+j*Ie+H*Be;if(Math.abs(Le)<1e-15)return null;const Fe=1/Le,Oe=L[0]-d,Xe=L[1]-e,We=L[2]-f,tt=(Oe*ve+Xe*Ie+We*Be)*Fe;if(tt<0||tt>1)return null;const nt=Xe*H-We*j,qe=We*U-Oe*H,Qe=Oe*j-Xe*U,st=(N[0]*nt+N[1]*qe+N[2]*Qe)*Fe;return st<0||tt+st>1?null:(ne*nt+ae*qe+pe*Qe)*Fe}function df(d,e,f){return(d-e)/(f-e)}function ff(d,e,f,m,y,b,M,I,P){const L=1<<f,N=b-m,U=M-y,j=(d+1)/L*N+m,H=(e+0)/L*U+y,ne=(e+1)/L*U+y;I[0]=(d+0)/L*N+m,I[1]=H,P[0]=j,P[1]=ne}class pf{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const f=function(b){const M=Math.ceil(Math.log2(b.dim/8)),I=[];let P=Math.ceil(Math.pow(2,M));const L=1/P,N=(H,ne,ae,pe,ve)=>{const Ie=pe?1:0,Be=(H+1)*ae-Ie,Le=ne*ae,Fe=(ne+1)*ae-Ie;ve[0]=H*ae,ve[1]=Le,ve[2]=Be,ve[3]=Fe};let U=new cf(P);const j=[];for(let H=0;H<P*P;H++){N(H%P,Math.floor(H/P),L,!1,j);const ne=Lo(j[0],j[1],b),ae=Lo(j[2],j[1],b),pe=Lo(j[2],j[3],b),ve=Lo(j[0],j[3],b);U.minimums.push(Math.min(ne,ae,pe,ve)),U.maximums.push(Math.max(ne,ae,pe,ve)),U.leaves.push(1)}for(I.push(U),P/=2;P>=1;P/=2){const H=I[I.length-1];U=new cf(P);for(let ne=0;ne<P*P;ne++){N(ne%P,Math.floor(ne/P),2,!0,j);const ae=H.getElevation(j[0],j[1]),pe=H.getElevation(j[2],j[1]),ve=H.getElevation(j[2],j[3]),Ie=H.getElevation(j[0],j[3]),Be=H.isLeaf(j[0],j[1]),Le=H.isLeaf(j[2],j[1]),Fe=H.isLeaf(j[2],j[3]),Oe=H.isLeaf(j[0],j[3]),Xe=Math.min(ae.min,pe.min,ve.min,Ie.min),We=Math.max(ae.max,pe.max,ve.max,Ie.max),tt=Be&&Le&&Fe&&Oe;U.maximums.push(We),U.minimums.push(Xe),U.leaves.push(We-Xe<=5&&tt?1:0)}I.push(U)}return I}(this.dem),m=f.length-1,y=f[m];this._addNode(y.minimums[0],y.maximums[0],y.leaves[0]),this._construct(f,0,0,m,0)}raycastRoot(e,f,m,y,b,M,I=1){return hf([e,f,-100],[m,y,this.maximums[0]*I],b,M)}raycast(e,f,m,y,b,M,I=1){if(!this.nodeCount)return null;const P=this.raycastRoot(e,f,m,y,b,M,I);if(P==null)return null;const L=[],N=[],U=[],j=[],H=[{idx:0,t:P,nodex:0,nodey:0,depth:0}];for(;H.length>0;){const{idx:ne,t:ae,nodex:pe,nodey:ve,depth:Ie}=H.pop();if(this.leaves[ne]){ff(pe,ve,Ie,e,f,m,y,U,j);const Le=1<<Ie,Fe=(pe+0)/Le,Oe=(pe+1)/Le,Xe=(ve+0)/Le,We=(ve+1)/Le,tt=Lo(Fe,Xe,this.dem)*I,nt=Lo(Oe,Xe,this.dem)*I,qe=Lo(Oe,We,this.dem)*I,Qe=Lo(Fe,We,this.dem)*I,st=uf(U[0],U[1],tt,j[0],U[1],nt,j[0],j[1],qe,b,M),mt=uf(j[0],j[1],qe,U[0],j[1],Qe,U[0],U[1],tt,b,M),lt=Math.min(st!==null?st:Number.MAX_VALUE,mt!==null?mt:Number.MAX_VALUE);if(lt!==Number.MAX_VALUE)return lt;{const dt=Nh([],b,M,ae);if(mf(tt,nt,Qe,qe,df(dt[0],U[0],j[0]),df(dt[1],U[1],j[1]))>=dt[2])return ae}continue}let Be=0;for(let Le=0;Le<this._siblingOffset.length;Le++){ff((pe<<1)+this._siblingOffset[Le][0],(ve<<1)+this._siblingOffset[Le][1],Ie+1,e,f,m,y,U,j),U[2]=-100,j[2]=this.maximums[this.childOffsets[ne]+Le]*I;const Fe=hf(U,j,b,M);if(Fe!=null){const Oe=Fe;L[Le]=Oe;let Xe=!1;for(let We=0;We<Be&&!Xe;We++)Oe>=L[N[We]]&&(N.splice(We,0,Le),Xe=!0);Xe||(N[Be]=Le),Be++}}for(let Le=0;Le<Be;Le++){const Fe=N[Le];H.push({idx:this.childOffsets[ne]+Fe,t:L[Fe],nodex:(pe<<1)+this._siblingOffset[Fe][0],nodey:(ve<<1)+this._siblingOffset[Fe][1],depth:Ie+1})}}return null}_addNode(e,f,m){return this.minimums.push(e),this.maximums.push(f),this.leaves.push(m),this.childOffsets.push(0),this.nodeCount++}_construct(e,f,m,y,b){if(e[y].isLeaf(f,m)===1)return;this.childOffsets[b]||(this.childOffsets[b]=this.nodeCount);const M=y-1,I=e[M];let P=0,L=0;for(let N=0;N<this._siblingOffset.length;N++){const U=2*f+this._siblingOffset[N][0],j=2*m+this._siblingOffset[N][1],H=I.getElevation(U,j),ne=I.isLeaf(U,j),ae=this._addNode(H.min,H.max,ne);ne&&(P|=1<<N),L||(L=ae)}for(let N=0;N<this._siblingOffset.length;N++)P&1<<N||this._construct(e,2*f+this._siblingOffset[N][0],2*m+this._siblingOffset[N][1],M,L+N)}}function mf(d,e,f,m,y,b){return Xt(Xt(d,f,b),Xt(e,m,b),y)}function Lo(d,e,f){const m=f.dim,y=_e(d*m-.5,0,m-1),b=_e(e*m-.5,0,m-1),M=Math.floor(y),I=Math.floor(b),P=Math.min(M+1,m-1),L=Math.min(I+1,m-1);return mf(f.get(M,I),f.get(P,I),f.get(M,L),f.get(P,L),y-M,b-I)}const gf={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class eh{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,f,m,y=!1,b=!1){if(this.uid=e,f.height!==f.width)throw new RangeError("DEM tiles must be square");if(m&&m!=="mapbox"&&m!=="terrarium")return ot(`"${m}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=f.height;const M=this.dim=f.height-2,I=new Uint32Array(f.data.buffer);if(this.pixels=new Uint8Array(f.data.buffer),this.encoding=m||"mapbox",this.borderReady=y,!y){for(let P=0;P<M;P++)I[this._idx(-1,P)]=I[this._idx(0,P)],I[this._idx(M,P)]=I[this._idx(M-1,P)],I[this._idx(P,-1)]=I[this._idx(P,0)],I[this._idx(P,M)]=I[this._idx(P,M-1)];I[this._idx(-1,-1)]=I[this._idx(0,0)],I[this._idx(M,-1)]=I[this._idx(M-1,0)],I[this._idx(-1,M)]=I[this._idx(0,M-1)],I[this._idx(M,M)]=I[this._idx(M-1,M-1)],b&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new pf(this)}get(e,f,m=!1){m&&(e=_e(e,-1,this.dim),f=_e(f,-1,this.dim));const y=4*this._idx(e,f);return(this.encoding==="terrarium"?this._unpackTerrarium:this._unpackMapbox)(this.pixels[y],this.pixels[y+1],this.pixels[y+2])}static getUnpackVector(e){return gf[e]}get unpackVector(){return gf[this.encoding]}_idx(e,f){if(e<-1||e>=this.dim+1||f<-1||f>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(f+1)*this.stride+(e+1)}_unpackMapbox(e,f,m){return(256*e*256+256*f+m)/10-1e4}_unpackTerrarium(e,f,m){return 256*e+f+m/256-32768}static pack(e,f){const m=[0,0,0,0],y=eh.getUnpackVector(f);let b=Math.floor((e+y[3])/y[2]);return m[2]=b%256,b=Math.floor(b/256),m[1]=b%256,b=Math.floor(b/256),m[0]=b,m}getPixels(){return new Qr({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,f,m){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let y=f*this.dim,b=f*this.dim+this.dim,M=m*this.dim,I=m*this.dim+this.dim;switch(f){case-1:y=b-1;break;case 1:b=y+1}switch(m){case-1:M=I-1;break;case 1:I=M+1}const P=-f*this.dim,L=-m*this.dim;for(let N=M;N<I;N++)for(let U=y;U<b;U++){const j=4*this._idx(U,N),H=4*this._idx(U+P,N+L);this.pixels[j+0]=e.pixels[H+0],this.pixels[j+1]=e.pixels[H+1],this.pixels[j+2]=e.pixels[H+2],this.pixels[j+3]=e.pixels[H+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Mt(eh,"DEMData"),Mt(pf,"DemMinMaxQuadTree",{omit:["dem"]});class Xm{constructor(e,f){this.max=e,this.onRemove=f,this.reset()}reset(){for(const e in this.data)for(const f of this.data[e])f.timeout&&clearTimeout(f.timeout),this.onRemove(f.value);return this.data={},this.order=[],this}add(e,f,m){const y=e.wrapped().key;this.data[y]===void 0&&(this.data[y]=[]);const b={value:f,timeout:void 0};if(m!==void 0&&(b.timeout=setTimeout(()=>{this.remove(e,b)},m)),this.data[y].push(b),this.order.push(y),this.order.length>this.max){const M=this._getAndRemoveByKey(this.order[0]);M&&this.onRemove(M)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const f=this.data[e].shift();return f.timeout&&clearTimeout(f.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),f.value}getByKey(e){const f=this.data[e];return f?f[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,f){if(!this.has(e))return this;const m=e.wrapped().key,y=f===void 0?0:this.data[m].indexOf(f),b=this.data[m][y];return this.data[m].splice(y,1),b.timeout&&clearTimeout(b.timeout),this.data[m].length===0&&delete this.data[m],this.onRemove(b.value),this.order.splice(this.order.indexOf(m),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const f=this._getAndRemoveByKey(this.order[0]);f&&this.onRemove(f)}return this}filter(e){const f=[];for(const m in this.data)for(const y of this.data[m])e(y.value)||f.push(y);for(const m of f)this.remove(m.value.tileID,m)}}class ma{constructor(e,f,m){this.func=e,this.mask=f,this.range=m}}ma.ReadOnly=!1,ma.ReadWrite=!0,ma.disabled=new ma(519,ma.ReadOnly,[0,1]);const gu=7680;class _u{constructor(e,f,m,y,b,M){this.test=e,this.ref=f,this.mask=m,this.fail=y,this.depthFail=b,this.pass=M}}_u.disabled=new _u({func:519,mask:0},0,0,gu,gu,gu);class qn{constructor(e,f,m){this.blendFunction=e,this.blendColor=f,this.mask=m}}qn.Replace=[1,0],qn.disabled=new qn(qn.Replace,Di.transparent,[!1,!1,!1,!1]),qn.unblended=new qn(qn.Replace,Di.transparent,[!0,!0,!0,!0]),qn.alphaBlended=new qn([1,771],Di.transparent,[!0,!0,!0,!0]);const yu=1029,xu=2305;class In{constructor(e,f,m){this.enable=e,this.mode=f,this.frontFace=m}}In.disabled=new In(!1,yu,xu),In.backCCW=new In(!0,yu,xu),In.backCW=new In(!0,yu,2304),In.frontCW=new In(!0,1028,2304),In.frontCCW=new In(!0,1028,xu);class ys extends Wt{constructor(e,f,m){super(),this.id=e,this._onlySymbols=m,f.on("data",y=>{y.dataType==="source"&&y.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&y.dataType==="source"&&y.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),f.on("error",()=>{this._sourceErrored=!0}),this._source=f,this._tiles={},this._cache=new Xm(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=f.minTileCacheSize,this._maxTileCacheSize=f.maxTileCacheSize,this._loadedParentTiles={},this._coveredTiles={},this._state=new Zm,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(e){this.map=e,this._minTileCacheSize=this._minTileCacheSize===void 0&&e?e._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&e?e._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const e in this._tiles){const f=this._tiles[e];if(f.state!=="loaded"&&f.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,f){return e.isSymbolTile=this._onlySymbols,this._source.loadTile(e,f)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e,()=>{})}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e,()=>{})}serialize(){return this._source.serialize()}prepare(e){if(this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null),this._source.prepareTile)for(const f in this._tiles){const m=this._tiles[f];this._source.prepareTile(m)&&this.map.painter.terrain&&this.map.painter.terrain._clearRenderCacheForTile(this.id,m.tileID),m.upload(e),m.prepare(this.map.style.imageManager)}else for(const f in this._tiles){const m=this._tiles[f];m.upload(e),m.prepare(this.map.style.imageManager)}}getIds(){return ie(this._tiles).map(e=>e.tileID).sort(_f).map(e=>e.key)}getRenderableIds(e){const f=[];for(const m in this._tiles)this._isIdRenderable(+m,e)&&f.push(this._tiles[m]);return e?f.sort((m,y)=>{const b=m.tileID,M=y.tileID,I=new z(b.canonical.x,b.canonical.y)._rotate(this.transform.angle),P=new z(M.canonical.x,M.canonical.y)._rotate(this.transform.angle);return b.overscaledZ-M.overscaledZ||P.y-I.y||P.x-I.x}).map(m=>m.tileID.key):f.map(m=>m.tileID).sort(_f).map(m=>m.key)}hasRenderableParent(e){const f=this.findLoadedParent(e,0);return!!f&&this._isIdRenderable(f.tileID.key)}_isIdRenderable(e,f){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(f||!this._tiles[e].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(+e,"reloading")}}_reloadTile(e,f){const m=this._tiles[e];m&&(m.state!=="loading"&&(m.state=f),this._loadTile(m,this._tileLoaded.bind(this,m,e,f)))}_tileLoaded(e,f,m,y){if(y)if(e.state="errored",y.status!==404)this._source.fire(new Lt(y,{tile:e}));else if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const b=this.map.painter.terrain;this.update(this.transform,b.getScaledDemTileSize(),!0),b.resetTileLookupCache(this.id)}else this.update(this.transform);else e.timeAdded=ft.now(),m==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(f,e),this._source.type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),this._source.fire(new wt("data",{dataType:"source",tile:e,coord:e.tileID,sourceCacheId:this.id}))}_backfillDEM(e){const f=this.getRenderableIds();for(let y=0;y<f.length;y++){const b=f[y];if(e.neighboringTiles&&e.neighboringTiles[b]){const M=this.getTileByID(b);m(e,M),m(M,e)}}function m(y,b){if(!y.dem||y.dem.borderReady)return;y.needsHillshadePrepare=!0,y.needsDEMTextureUpload=!0;let M=b.tileID.canonical.x-y.tileID.canonical.x;const I=b.tileID.canonical.y-y.tileID.canonical.y,P=Math.pow(2,y.tileID.canonical.z),L=b.tileID.key;M===0&&I===0||Math.abs(I)>1||(Math.abs(M)>1&&(Math.abs(M+P)===1?M+=P:Math.abs(M-P)===1&&(M-=P)),b.dem&&y.dem&&(y.dem.backfillBorder(b.dem,M,I),y.neighboringTiles&&y.neighboringTiles[L]&&(y.neighboringTiles[L].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,f,m,y){for(const b in this._tiles){let M=this._tiles[b];if(y[b]||!M.hasData()||M.tileID.overscaledZ<=f||M.tileID.overscaledZ>m)continue;let I=M.tileID;for(;M&&M.tileID.overscaledZ>f+1;){const L=M.tileID.scaledTo(M.tileID.overscaledZ-1);M=this._tiles[L.key],M&&M.hasData()&&(I=L)}let P=I;for(;P.overscaledZ>f;)if(P=P.scaledTo(P.overscaledZ-1),e[P.key]){y[I.key]=I;break}}}findLoadedParent(e,f){if(e.key in this._loadedParentTiles){const m=this._loadedParentTiles[e.key];return m&&m.tileID.overscaledZ>=f?m:null}for(let m=e.overscaledZ-1;m>=f;m--){const y=e.scaledTo(m),b=this._getLoadedTile(y);if(b)return b}}_getLoadedTile(e){const f=this._tiles[e.key];return f&&f.hasData()?f:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,f){f=f||this._source.tileSize;const m=Math.ceil(e.width/f)+1,y=Math.ceil(e.height/f)+1,b=Math.floor(m*y*5),M=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,b):b,I=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,M):M;this._cache.setMaxSize(I)}handleWrapJump(e){const f=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,f){const m={};for(const y in this._tiles){const b=this._tiles[y];b.tileID=b.tileID.unwrapTo(b.tileID.wrap+f),m[b.tileID.key]=b}this._tiles=m;for(const y in this._timers)clearTimeout(this._timers[y]),delete this._timers[y];for(const y in this._tiles)this._setTileReloadTimer(+y,this._tiles[y])}}update(e,f,m){if(this.transform=e,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!m)return;let y;this.updateCacheSize(e,f),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?y=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(I=>new kr(I.canonical.z,I.wrap,I.canonical.z,I.canonical.x,I.canonical.y)):(y=e.coveringTiles({tileSize:f||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!m,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(y=y.filter(I=>this._source.hasTile(I)))):y=[];const b=this._updateRetainedTiles(y);if(yf(this._source.type)&&y.length!==0){const I={},P={},L=Object.keys(b);for(const U of L){const j=b[U],H=this._tiles[U];if(!H||H.fadeEndTime&&H.fadeEndTime<=ft.now())continue;const ne=this.findLoadedParent(j,Math.max(j.overscaledZ-ys.maxOverzooming,this._source.minzoom));ne&&(this._addTile(ne.tileID),I[ne.tileID.key]=ne.tileID),P[U]=j}const N=y[y.length-1].overscaledZ;for(const U in this._tiles){const j=this._tiles[U];if(b[U]||!j.hasData())continue;let H=j.tileID;for(;H.overscaledZ>N;){H=H.scaledTo(H.overscaledZ-1);const ne=this._tiles[H.key];if(ne&&ne.hasData()&&P[H.key]){b[U]=j.tileID;break}}}for(const U in I)b[U]||(this._coveredTiles[U]=!0,b[U]=I[U])}for(const I in b)this._tiles[I].clearFadeHold();const M=function(I,P){const L=[];for(const N in I)N in P||L.push(N);return L}(this._tiles,b);for(const I of M){const P=this._tiles[I];P.hasSymbolBuckets&&!P.holdingForFade()?P.setHoldDuration(this.map._fadeDuration):P.hasSymbolBuckets&&!P.symbolFadeFinished()||this._removeTile(+I)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){const f={};if(e.length===0)return f;const m={},y=e.reduce((L,N)=>Math.min(L,N.overscaledZ),1/0),b=e[0].overscaledZ,M=Math.max(b-ys.maxOverzooming,this._source.minzoom),I=Math.max(b+ys.maxUnderzooming,this._source.minzoom),P={};for(const L of e){const N=this._addTile(L);f[L.key]=L,N.hasData()||y<this._source.maxzoom&&(P[L.key]=L)}this._retainLoadedChildren(P,y,I,f);for(const L of e){let N=this._tiles[L.key];if(N.hasData())continue;if(L.canonical.z>=this._source.maxzoom){const j=L.children(this._source.maxzoom)[0],H=this.getTile(j);if(H&&H.hasData()){f[j.key]=j;continue}}else{const j=L.children(this._source.maxzoom);if(f[j[0].key]&&f[j[1].key]&&f[j[2].key]&&f[j[3].key])continue}let U=N.wasRequested();for(let j=L.overscaledZ-1;j>=M;--j){const H=L.scaledTo(j);if(m[H.key]||(m[H.key]=!0,N=this.getTile(H),!N&&U&&(N=this._addTile(H)),N&&(f[H.key]=H,U=N.wasRequested(),N.hasData())))break}}return f}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const f=[];let m,y=this._tiles[e].tileID;for(;y.overscaledZ>0;){if(y.key in this._loadedParentTiles){m=this._loadedParentTiles[y.key];break}f.push(y.key);const b=y.scaledTo(y.overscaledZ-1);if(m=this._getLoadedTile(b),m)break;y=b}for(const b of f)this._loadedParentTiles[b]=m}}_addTile(e){let f=this._tiles[e.key];if(f)return this._source.prepareTile&&this._source.prepareTile(f),f;f=this._cache.getAndRemove(e),f&&(this._setTileReloadTimer(e.key,f),f.tileID=e,this._state.initializeTileState(f,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,f)));const m=Boolean(f);if(!m){const y=this.map?this.map.painter:null;f=new mu(e,this._source.tileSize*e.overscaleFactor(),this.transform.tileZoom,y,this._isRaster),this._source.prepareTile&&this._source.prepareTile(f)||this._loadTile(f,this._tileLoaded.bind(this,f,e.key,f.state))}return f?(f.uses++,this._tiles[e.key]=f,m||this._source.fire(new wt("dataloading",{tile:f,coord:f.tileID,dataType:"source"})),f):null}_setTileReloadTimer(e,f){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const m=f.getExpiryTimeout();m&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},m))}_removeTile(e){const f=this._tiles[e];f&&(f.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),f.uses>0||(f.hasData()&&f.state!=="reloading"?this._cache.add(f.tileID,f,f.getExpiryTimeout()):(f.aborted=!0,this._abortTile(f),this._unloadTile(f))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(e,f,m){const y=[],b=this.transform;if(!b)return y;for(const M in this._tiles){const I=this._tiles[M];if(m&&I.clearQueryDebugViz(),I.holdingForFade())continue;const P=e.containsTile(I,b,f);P&&y.push(P)}return y}getVisibleCoordinates(e){const f=this.getRenderableIds(e).map(m=>this._tiles[m].tileID);for(const m of f)m.projMatrix=this.transform.calculateProjMatrix(m.toUnwrapped());return f}hasTransition(){if(this._source.hasTransition())return!0;if(yf(this._source.type))for(const e in this._tiles){const f=this._tiles[e];if(f.fadeEndTime!==void 0&&f.fadeEndTime>=ft.now())return!0}return!1}setFeatureState(e,f,m){this._state.updateState(e=e||"_geojsonTileLayer",f,m)}removeFeatureState(e,f,m){this._state.removeFeatureState(e=e||"_geojsonTileLayer",f,m)}getFeatureState(e,f){return this._state.getState(e=e||"_geojsonTileLayer",f)}setDependencies(e,f,m){const y=this._tiles[e];y&&y.setDependencies(f,m)}reloadTilesForDependencies(e,f){for(const m in this._tiles)this._tiles[m].hasDependency(e,f)&&this._reloadTile(+m,"reloading");this._cache.filter(m=>!m.hasDependency(e,f))}_preloadTiles(e,f){const m=new Map,y=Array.isArray(e)?e:[e],b=this.map.painter.terrain,M=this.usedForTerrain&&b?b.getScaledDemTileSize():this._source.tileSize;for(const I of y){const P=I.coveringTiles({tileSize:M,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const L of P)m.set(L.key,L);this.usedForTerrain&&I.updateElevation(!1)}be(Array.from(m.values()),(I,P)=>{const L=new mu(I,this._source.tileSize*I.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(L,N=>{this._source.type==="raster-dem"&&L.dem&&this._backfillDEM(L),P(N,L)})},f)}}function _f(d,e){const f=Math.abs(2*d.wrap)-+(d.wrap<0),m=Math.abs(2*e.wrap)-+(e.wrap<0);return d.overscaledZ-e.overscaledZ||m-f||e.canonical.y-d.canonical.y||e.canonical.x-d.canonical.x}function yf(d){return d==="raster"||d==="image"||d==="video"}ys.maxOverzooming=10,ys.maxUnderzooming=3;class th{constructor(e,f,m){this._demTile=e,this._dem=this._demTile.dem,this._scale=f,this._offset=m}static create(e,f,m){const y=m||e.findDEMTileFor(f);if(!y||!y.dem)return;const b=y.dem,M=y.tileID,I=1<<f.canonical.z-M.canonical.z;return new th(y,y.tileSize/fi/I,[(f.canonical.x/I-M.canonical.x)*b.dim,(f.canonical.y/I-M.canonical.y)*b.dim])}tileCoordToPixel(e,f){const m=f*this._scale+this._offset[1],y=Math.floor(e*this._scale+this._offset[0]),b=Math.floor(m);return new z(y,b)}getElevationAt(e,f,m,y){const b=e*this._scale+this._offset[0],M=f*this._scale+this._offset[1],I=Math.floor(b),P=Math.floor(M),L=this._dem;return y=!!y,m?Xt(Xt(L.get(I,P,y),L.get(I,P+1,y),M-P),Xt(L.get(I+1,P,y),L.get(I+1,P+1,y),M-P),b-I):L.get(I,P,y)}getElevationAtPixel(e,f,m){return this._dem.get(e,f,!!m)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*ta(1,e)*this._dem.stride}}class xf{constructor(e,f){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Fn(fi,16,0),this.featureIndexArray=new Wi,this.promoteId=f}insert(e,f,m,y,b,M=0){const I=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(m,y,b,M);const P=this.grid;for(let L=0;L<f.length;L++){const N=f[L],U=[1/0,1/0,-1/0,-1/0];for(let j=0;j<N.length;j++){const H=N[j];U[0]=Math.min(U[0],H.x),U[1]=Math.min(U[1],H.y),U[2]=Math.max(U[2],H.x),U[3]=Math.max(U[3],H.y)}U[0]<fi&&U[1]<fi&&U[2]>=0&&U[3]>=0&&P.insert(I,U[0],U[1],U[2],U[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new gs.VectorTile(new vl(this.rawTileData)).layers,this.sourceLayerCoder=new nf(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,f,m,y){this.loadVTLayers();const b=e.params||{},M=Rn(b.filter),I=e.tileResult,P=e.transform,L=I.bufferedTilespaceBounds,N=this.grid.query(L.min.x,L.min.y,L.max.x,L.max.y,(ne,ae,pe,ve)=>Nu(I.bufferedTilespaceGeometry,ne,ae,pe,ve));N.sort(Ym);let U=null;P.elevation&&N.length>0&&(U=th.create(P.elevation,this.tileID));const j={};let H;for(let ne=0;ne<N.length;ne++){const ae=N[ne];if(ae===H)continue;H=ae;const pe=this.featureIndexArray.get(ae);let ve=null;this.loadMatchingFeature(j,pe,M,b.layers,b.availableImages,f,m,y,(Ie,Be,Le,Fe=0)=>(ve||(ve=no(Ie,this.tileID.canonical,e.tileTransform)),Be.queryIntersectsFeature(I,Ie,Le,ve,this.z,e.transform,e.pixelPosMatrix,U,Fe)))}return j}loadMatchingFeature(e,f,m,y,b,M,I,P,L){const{featureIndex:N,bucketIndex:U,sourceLayerIndex:j,layoutVertexArrayOffset:H}=f,ne=this.bucketLayerIDs[U];if(y&&!function(Ie,Be){for(let Le=0;Le<Ie.length;Le++)if(Be.indexOf(Ie[Le])>=0)return!0;return!1}(y,ne))return;const ae=this.sourceLayerCoder.decode(j),pe=this.vtLayers[ae].feature(N);if(m.needGeometry){const Ie=fs(pe,!0);if(!m.filter(new ji(this.tileID.overscaledZ),Ie,this.tileID.canonical))return}else if(!m.filter(new ji(this.tileID.overscaledZ),pe))return;const ve=this.getId(pe,ae);for(let Ie=0;Ie<ne.length;Ie++){const Be=ne[Ie];if(y&&y.indexOf(Be)<0)continue;const Le=M[Be];if(!Le)continue;let Fe={};ve!==void 0&&P&&(Fe=P.getState(Le.sourceLayer||"_geojsonTileLayer",ve));const Oe=ue({},I[Be]);Oe.paint=vf(Oe.paint,Le.paint,pe,Fe,b),Oe.layout=vf(Oe.layout,Le.layout,pe,Fe,b);const Xe=!L||L(pe,Le,Fe,H);if(!Xe)continue;const We=new of(pe,this.z,this.x,this.y,ve);We.layer=Oe;let tt=e[Be];tt===void 0&&(tt=e[Be]=[]),tt.push({featureIndex:N,feature:We,intersectionZ:Xe})}}lookupSymbolFeatures(e,f,m,y,b,M,I,P){const L={};this.loadVTLayers();const N=Rn(b);for(const U of e)this.loadMatchingFeature(L,{bucketIndex:m,sourceLayerIndex:y,featureIndex:U,layoutVertexArrayOffset:0},N,M,I,P,f);return L}loadFeature(e){const{featureIndex:f,sourceLayerIndex:m}=e;this.loadVTLayers();const y=this.sourceLayerCoder.decode(m),b=this.vtFeatures[y];if(b[f])return b[f];const M=this.vtLayers[y].feature(f);return b[f]=M,M}hasLayer(e){for(const f of this.bucketLayerIDs)for(const m of f)if(e===m)return!0;return!1}getId(e,f){let m=e.id;return this.promoteId&&(m=e.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[f]],typeof m=="boolean"&&(m=Number(m))),m}}function vf(d,e,f,m,y){return Vt(d,(b,M)=>{const I=e instanceof k?e.get(M):null;return I&&I.evaluate?I.evaluate(f,m,y):I})}function Ym(d,e){return e-d}Mt(xf,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});class bf{constructor(e){const f={},m=[];for(const I in e){const P=e[I],L=f[I]={};for(const N in P.glyphs){const U=P.glyphs[+N];if(!U||U.bitmap.width===0||U.bitmap.height===0)continue;const j=U.metrics.localGlyph?2:1,H={x:0,y:0,w:U.bitmap.width+2*j,h:U.bitmap.height+2*j};m.push(H),L[N]=H}}const{w:y,h:b}=Kh(m),M=new oo({width:y||1,height:b||1});for(const I in e){const P=e[I];for(const L in P.glyphs){const N=P.glyphs[+L];if(!N||N.bitmap.width===0||N.bitmap.height===0)continue;const U=f[I][L],j=N.metrics.localGlyph?2:1;oo.copy(N.bitmap,M,{x:0,y:0},{x:U.x+j,y:U.y+j},N.bitmap)}}this.image=M,this.positions=f}}Mt(bf,"GlyphAtlas");class Wm{constructor(e){this.tileID=new kr(e.tileID.overscaledZ,e.tileID.wrap,e.tileID.canonical.z,e.tileID.canonical.x,e.tileID.canonical.y),this.tileZoom=e.tileZoom,this.uid=e.uid,this.zoom=e.zoom,this.canonical=e.tileID.canonical,this.pixelRatio=e.pixelRatio,this.tileSize=e.tileSize,this.source=e.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=e.showCollisionBoxes,this.collectResourceTiming=!!e.collectResourceTiming,this.returnDependencies=!!e.returnDependencies,this.promoteId=e.promoteId,this.enableTerrain=!!e.enableTerrain,this.isSymbolTile=e.isSymbolTile,this.tileTransform=_s(e.tileID.canonical,e.projection),this.projection=e.projection}parse(e,f,m,y,b){this.status="parsing",this.data=e,this.collisionBoxArray=new Tn;const M=new nf(Object.keys(e.layers).sort()),I=new xf(this.tileID,this.promoteId);I.bucketLayerIDs=[];const P={},L=new uu(256,256),N={featureIndex:I,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:L,availableImages:m},U=f.familiesBySource[this.source];for(const Fe in U){const Oe=e.layers[Fe];if(!Oe)continue;let Xe=!1,We=!1;for(const qe of U[Fe])qe[0].type==="symbol"?Xe=!0:We=!0;if(this.isSymbolTile===!0&&!Xe||this.isSymbolTile===!1&&!We)continue;Oe.version===1&&ot(`Vector tile source "${this.source}" layer "${Fe}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const tt=M.encode(Fe),nt=[];for(let qe=0;qe<Oe.length;qe++){const Qe=Oe.feature(qe),st=I.getId(Qe,Fe);nt.push({feature:Qe,id:st,index:qe,sourceLayerIndex:tt})}for(const qe of U[Fe]){const Qe=qe[0];this.isSymbolTile!==void 0&&Qe.type==="symbol"!==this.isSymbolTile||Qe.minzoom&&this.zoom<Math.floor(Qe.minzoom)||Qe.maxzoom&&this.zoom>=Qe.maxzoom||Qe.visibility!=="none"&&(vu(qe,this.zoom,m),(P[Qe.id]=Qe.createBucket({index:I.bucketLayerIDs.length,layers:qe,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:tt,sourceID:this.source,enableTerrain:this.enableTerrain,projection:this.projection.name,availableImages:m})).populate(nt,N,this.tileID.canonical,this.tileTransform),I.bucketLayerIDs.push(qe.map(st=>st.id)))}}let j,H,ne,ae;L.trim();const pe={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},ve=Vt(N.glyphDependencies,Fe=>Object.keys(Fe).map(Number));Object.keys(ve).length?y.send("getGlyphs",{uid:this.uid,stacks:ve},(Fe,Oe)=>{j||(j=Fe,H=Oe,Le.call(this))},void 0,!1,pe):H={};const Ie=Object.keys(N.iconDependencies);Ie.length?y.send("getImages",{icons:Ie,source:this.source,tileID:this.tileID,type:"icons"},(Fe,Oe)=>{j||(j=Fe,ne=Oe,Le.call(this))},void 0,!1,pe):ne={};const Be=Object.keys(N.patternDependencies);function Le(){if(j)return b(j);if(H&&ne&&ae){const Fe=new bf(H),Oe=new Md(ne,ae);for(const Xe in P){const We=P[Xe];We instanceof Po?(vu(We.layers,this.zoom,m),Em(We,H,Fe.positions,ne,Oe.iconPositions,this.showCollisionBoxes,m,this.tileID.canonical,this.tileZoom,this.projection)):We.hasPattern&&(We instanceof Vc||We instanceof $c||We instanceof _l)&&(vu(We.layers,this.zoom,m),We.addFeatures(N,this.tileID.canonical,Oe.patternPositions,m,this.tileTransform))}this.status="done",b(null,{buckets:ie(P).filter(Xe=>!Xe.isEmpty()),featureIndex:I,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Fe.image,lineAtlas:L,imageAtlas:Oe,glyphMap:this.returnDependencies?H:null,iconMap:this.returnDependencies?ne:null,glyphPositions:this.returnDependencies?Fe.positions:null})}}Be.length?y.send("getImages",{icons:Be,source:this.source,tileID:this.tileID,type:"patterns"},(Fe,Oe)=>{j||(j=Fe,ae=Oe,Le.call(this))},void 0,!1,pe):ae={},Le.call(this)}}function vu(d,e,f){const m=new ji(e);for(const y of d)y.recalculate(m,f)}class wf{constructor(e){this.entries={},this.scheduler=e}request(e,f,m,y){const b=this.entries[e]=this.entries[e]||{callbacks:[]};if(b.result){const[M,I]=b.result;return this.scheduler?this.scheduler.add(()=>{y(M,I)},f):y(M,I),()=>{}}return b.callbacks.push(y),b.cancel||(b.cancel=m((M,I)=>{b.result=[M,I];for(const P of b.callbacks)this.scheduler?this.scheduler.add(()=>{P(M,I)},f):P(M,I);setTimeout(()=>delete this.entries[e],3e3)})),()=>{b.result||(b.callbacks=b.callbacks.filter(M=>M!==y),b.callbacks.length||(b.cancel(),delete this.entries[e]))}}}function Ef(d,e,f){const m=JSON.stringify(d.request);return d.data&&(this.deduped.entries[m]={result:[null,d.data]}),this.deduped.request(m,{type:"parseTile",isSymbolTile:d.isSymbolTile,zoom:d.tileZoom},y=>{const b=me(d.request,(M,I,P,L)=>{M?y(M):I&&y(null,{vectorTile:f?void 0:new gs.VectorTile(new vl(I)),rawData:I,cacheControl:P,expires:L})});return()=>{b.cancel(),y()}},e)}const Hm=Un(new Float32Array(16));class zo{constructor(e){this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,f){return{x:0,y:0,z:0}}unproject(e,f){return new Ni(0,0)}projectTilePoint(e,f,m){return{x:e,y:f,z:0}}locationPoint(e,f){return e._coordinatePoint(e.locationCoordinate(f),!1)}pixelsPerMeter(e,f){return ta(1,e)*f}farthestPixelDistance(e){return function(f,m){const y=f.fovAboveCenter,b=f.elevation?f.elevation.getMinElevationBelowMSL()*m:0,M=(f._camera.position[2]*f.worldSize-b)/Math.cos(f._pitch),I=Math.sin(y)*M/Math.sin(Math.max(Math.PI/2-f._pitch-y,.01)),P=Math.sin(f._pitch)*I+M;return Math.min(1.01*P,M*(1/f._horizonShift))}(e,e.pixelsPerMeter)}pointCoordinate(e,f,m,y){const b=e.horizonLineFromTop(!1),M=new z(f,Math.max(b,m));return e.rayIntersectionCoordinate(e.pointRayIntersection(M,y))}createInversionMatrix(e,f){return Hm}createTileMatrix(e,f,m){let y,b,M;const I=m.canonical,P=Un(new Float64Array(16));if(this.isReprojectedInTileSpace){const L=_s(I,this);y=1,b=L.x+m.wrap*L.scale,M=L.y,Co(P,P,[y/L.scale,y/L.scale,e.pixelsPerMeter/f])}else y=f/e.zoomScale(I.z),b=(I.x+Math.pow(2,I.z)*m.wrap)*y,M=I.y*y;return ps(P,P,[b,M,0]),Co(P,P,[y/fi,y/fi,1]),P}upVector(e,f,m){return[0,0,1]}upVectorScale(e,f,m){return{metersToTile:1,metersToLabelSpace:1}}}class Km extends zo{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,f){return{x:ol(e),y:ea(f),z:0}}unproject(e,f){const m=mn(e),y=wr(f);return new Ni(m,y)}}class Jm extends zo{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[f,m]=this.parallels=e.parallels||[29.5,45.5],y=Math.sin(J(f));this.n=(y+Math.sin(J(m)))/2,this.c=1+y*(2*this.n-y),this.r0=Math.sqrt(this.c)/this.n}project(e,f){const{n:m,c:y,r0:b}=this,M=J(e-this.center[0]),I=J(f),P=Math.sqrt(y-2*m*Math.sin(I))/m;return{x:P*Math.sin(M*m),y:P*Math.cos(M*m)-b,z:0}}unproject(e,f){const{n:m,c:y,r0:b}=this,M=b+f;let I=Math.atan2(e,Math.abs(M))*Math.sign(M);M*m<0&&(I-=Math.PI*Math.sign(e)*Math.sign(M));const P=J(this.center[0])*m;I=oe(I,-Math.PI-P,Math.PI-P);const L=Y(I/m)+this.center[0],N=Math.asin(_e((y-(e*e+M*M)*m*m)/(2*m),-1,1)),U=_e(Y(N),-85.051129,$n);return new Ni(L,U)}}const Al=1.340264,Il=-.081106,Cl=893e-6,kl=.003796,ih=Math.sqrt(3)/2;class Qm extends zo{project(e,f){f=f/180*Math.PI,e=e/180*Math.PI;const m=Math.asin(ih*Math.sin(f)),y=m*m,b=y*y*y;return{x:.5*(e*Math.cos(m)/(ih*(Al+3*Il*y+b*(7*Cl+9*kl*y)))/Math.PI+.5),y:1-.5*(m*(Al+Il*y+b*(Cl+kl*y))/Math.PI+1),z:0}}unproject(e,f){e=(2*e-.5)*Math.PI;let m=f=(2*(1-f)-1)*Math.PI,y=m*m,b=y*y*y;for(let N,U,j,H=0;H<12&&(U=m*(Al+Il*y+b*(Cl+kl*y))-f,j=Al+3*Il*y+b*(7*Cl+9*kl*y),N=U/j,m=_e(m-N,-Math.PI/3,Math.PI/3),y=m*m,b=y*y*y,!(Math.abs(N)<1e-12));++H);const M=ih*e*(Al+3*Il*y+b*(7*Cl+9*kl*y))/Math.cos(m),I=Math.asin(Math.sin(m)/ih),P=_e(180*M/Math.PI,-180,180),L=_e(180*I/Math.PI,-85.051129,$n);return new Ni(P,L)}}class eg extends zo{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,f){return{x:.5+e/360,y:.5-f/360,z:0}}unproject(e,f){const m=360*(e-.5),y=_e(360*(.5-f),-85.051129,$n);return new Ni(m,y)}}const ga=Math.PI/2;function rh(d){return Math.tan((ga+d)/2)}class tg extends zo{constructor(e){super(e),this.center=e.center||[0,30];const[f,m]=this.parallels=e.parallels||[30,30],y=J(f),b=J(m),M=Math.cos(y);this.n=y===b?Math.sin(y):Math.log(M/Math.cos(b))/Math.log(rh(b)/rh(y)),this.f=M*Math.pow(rh(y),this.n)/this.n}project(e,f){f=J(f),e=J(e-this.center[0]);const m=1e-6,{n:y,f:b}=this;b>0?f<-ga+m&&(f=-ga+m):f>ga-m&&(f=ga-m);const M=b/Math.pow(rh(f),y),I=M*Math.sin(y*e),P=b-M*Math.cos(y*e);return{x:.5*(I/Math.PI+.5),y:1-.5*(P/Math.PI+.5),z:0}}unproject(e,f){e=(2*e-.5)*Math.PI,f=(2*(1-f)-.5)*Math.PI;const{n:m,f:y}=this,b=y-f,M=Math.sign(b),I=Math.sign(m)*Math.sqrt(e*e+b*b);let P=Math.atan2(e,Math.abs(b))*M;b*m<0&&(P-=Math.PI*Math.sign(e)*M);const L=_e(Y(P/m)+this.center[0],-180,180),N=_e(Y(2*Math.atan(Math.pow(y/I,1/m))-ga),-85.051129,$n);return new Ni(L,N)}}const Tf=J($n);class ig extends zo{project(e,f){const m=(f=J(f))*f,y=m*m;return{x:.5*((e=J(e))*(.8707-.131979*m+y*(y*(.003971*m-.001529*y)-.013791))/Math.PI+.5),y:1-.5*(f*(1.007226+m*(.015085+y*(.028874*m-.044475-.005916*y)))/Math.PI+1),z:0}}unproject(e,f){e=(2*e-.5)*Math.PI;let m=f=(2*(1-f)-1)*Math.PI,y=25,b=0,M=m*m;do{M=m*m;const L=M*M;b=(m*(1.007226+M*(.015085+L*(.028874*M-.044475-.005916*L)))-f)/(1.007226+M*(.045255+L*(.259866*M-.311325-.005916*11*L))),m=_e(m-b,-Tf,Tf)}while(Math.abs(b)>1e-6&&--y>0);M=m*m;const I=_e(Y(e/(.8707+M*(M*(M*M*M*(.003971-.001529*M)-.013791)-.131979))),-180,180),P=Y(m);return new Ni(I,P)}}const Mf=J($n);class rg extends zo{project(e,f){f=J(f),e=J(e);const m=Math.cos(f),y=2/Math.PI,b=Math.acos(m*Math.cos(e/2)),M=Math.sin(b)/b,I=.5*(e*y+2*m*Math.sin(e/2)/M)||0,P=.5*(f+Math.sin(f)/M)||0;return{x:.5*(I/Math.PI+.5),y:1-.5*(P/Math.PI+1),z:0}}unproject(e,f){let m=e=(2*e-.5)*Math.PI,y=f=(2*(1-f)-1)*Math.PI,b=25;const M=1e-6;let I=0,P=0;do{const L=Math.cos(y),N=Math.sin(y),U=2*N*L,j=N*N,H=L*L,ne=Math.cos(m/2),ae=Math.sin(m/2),pe=2*ne*ae,ve=ae*ae,Ie=1-H*ne*ne,Be=Ie?1/Ie:0,Le=Ie?Math.acos(L*ne)*Math.sqrt(1/Ie):0,Fe=.5*(2*Le*L*ae+2*m/Math.PI)-e,Oe=.5*(Le*N+y)-f,Xe=.5*Be*(H*ve+Le*L*ne*j)+1/Math.PI,We=Be*(pe*U/4-Le*N*ae),tt=.125*Be*(U*ae-Le*N*H*pe),nt=.5*Be*(j*ne+Le*ve*L)+.5,qe=We*tt-nt*Xe;I=(Oe*We-Fe*nt)/qe,P=(Fe*tt-Oe*Xe)/qe,m=_e(m-I,-Math.PI,Math.PI),y=_e(y-P,-Mf,Mf)}while((Math.abs(I)>M||Math.abs(P)>M)&&--b>0);return new Ni(Y(m),Y(y))}}class Sf extends zo{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(J(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,f){const{scale:m,cosPhi:y}=this;return{x:J(e)*y*m+.5,y:-Math.sin(J(f))/y*m+.5,z:0}}unproject(e,f){const{scale:m,cosPhi:y}=this,b=-(f-.5)/m,M=_e(Y((e-.5)/m)/y,-180,180),I=Math.asin(_e(b*y,-1,1)),P=_e(Y(I),-85.051129,$n);return new Ni(M,P)}}u.ARRAY_TYPE=Jr,u.AUTH_ERR_MSG=hi,u.Aabb=un,u.Actor=class{constructor(d,e,f){this.target=d,this.parent=e,this.mapId=f,this.callbacks={},this.cancelCallbacks={},zt(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=Bt()?d:O,this.scheduler=new Fm}send(d,e,f,m,y=!1,b){const M=Math.round(1e18*Math.random()).toString(36).substring(0,10);f&&(f.metadata=b,this.callbacks[M]=f);const I=ci(this.globalScope)?void 0:[];return this.target.postMessage({id:M,type:d,hasCallback:!!f,targetMapId:m,mustQueue:y,sourceMapId:this.mapId,data:ns(e,I)},I),{cancel:()=>{f&&delete this.callbacks[M],this.target.postMessage({id:M,type:"<cancel>",targetMapId:m,sourceMapId:this.mapId})}}}receive(d){const e=d.data,f=e.id;if(f&&(!e.targetMapId||this.mapId===e.targetMapId))if(e.type==="<cancel>"){const m=this.cancelCallbacks[f];delete this.cancelCallbacks[f],m&&m.cancel()}else if(e.mustQueue||Bt()){const m=this.callbacks[f];this.cancelCallbacks[f]=this.scheduler.add(()=>this.processTask(f,e),m&&m.metadata||{type:"message"})}else this.processTask(f,e)}processTask(d,e){if(e.type==="<response>"){const f=this.callbacks[d];delete this.callbacks[d],f&&(e.error?f(bo(e.error)):f(null,bo(e.data)))}else{const f=ci(this.globalScope)?void 0:[],m=e.hasCallback?(b,M)=>{delete this.cancelCallbacks[d],this.target.postMessage({id:d,type:"<response>",sourceMapId:this.mapId,error:b?ns(b):null,data:ns(M,f)},f)}:b=>{},y=bo(e.data);if(this.parent[e.type])this.parent[e.type](e.sourceMapId,y,m);else if(this.parent.getWorkerSource){const b=e.type.split(".");this.parent.getWorkerSource(e.sourceMapId,b[0],y.source)[b[1]](y,m)}else m(new Error(`Could not find function ${e.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},u.CanonicalTileID=Jc,u.Color=Di,u.ColorMode=qn,u.CullFaceMode=In,u.DEMData=eh,u.DataConstantProperty=B,u.DedupedRequest=wf,u.DepthMode=ma,u.EXTENT=fi,u.Elevation=class{isDataAvailableAtPoint(d){const e=this._source();if(!e||d.y<0||d.y>1)return!1;const f=e.getSource().maxzoom,m=1<<f,y=Math.floor(d.x),b=Math.floor((d.x-y)*m),M=Math.floor(d.y*m),I=this.findDEMTileFor(new kr(f,y,f,b,M));return!(!I||!I.dem)}getAtPointOrZero(d,e=0){return this.getAtPoint(d,e)||0}getAtPoint(d,e,f=!0){e==null&&(e=null);const m=this._source();if(!m||d.y<0||d.y>1)return e;const y=m.getSource().maxzoom,b=1<<y,M=Math.floor(d.x),I=d.x-M,P=new kr(y,M,y,Math.floor(I*b),Math.floor(d.y*b)),L=this.findDEMTileFor(P);if(!L||!L.dem)return e;const N=L.dem,U=1<<L.tileID.canonical.z,j=(I*U-L.tileID.canonical.x)*N.dim,H=(d.y*U-L.tileID.canonical.y)*N.dim,ne=Math.floor(j),ae=Math.floor(H);return(f?this.exaggeration():1)*Xt(Xt(N.get(ne,ae),N.get(ne,ae+1),H-ae),Xt(N.get(ne+1,ae),N.get(ne+1,ae+1),H-ae),j-ne)}getAtTileOffset(d,e,f){const m=1<<d.canonical.z;return this.getAtPointOrZero(new Dc(d.wrap+(d.canonical.x+e/fi)/m,(d.canonical.y+f/fi)/m))}getAtTileOffsetFunc(d,e,f,m){return y=>{const b=this.getAtTileOffset(d,y.x,y.y),M=m.upVector(d.canonical,y.x,y.y);return al(M,M,b*m.upVectorScale(d.canonical,e,f).metersToTile),M}}getForTilePoints(d,e,f,m){const y=th.create(this,d,m);return!!y&&(e.forEach(b=>{b[2]=this.exaggeration()*y.getElevationAt(b[0],b[1],f)}),!0)}getMinMaxForTile(d){const e=this.findDEMTileFor(d);if(!e||!e.dem)return null;const f=e.dem.tree,m=e.tileID,y=1<<d.canonical.z-m.canonical.z;let b=d.canonical.x/y-m.canonical.x,M=d.canonical.y/y-m.canonical.y,I=0;for(let P=0;P<d.canonical.z-m.canonical.z&&!f.leaves[I];P++){b*=2,M*=2;const L=2*Math.floor(M)+Math.floor(b);I=f.childOffsets[I]+L,b%=1,M%=1}return{min:this.exaggeration()*f.minimums[I],max:this.exaggeration()*f.maximums[I]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(d,e,f){throw new Error("Pure virtual method called.")}pointCoordinate(d){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(d){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},u.ErrorEvent=Lt,u.EvaluationParameters=ji,u.Event=wt,u.Evented=Wt,u.FillExtrusionBucket=_l,u.Frustum=$h,u.GLOBE_RADIUS=pa,u.GlobeSharedBuffers=class{constructor(d){this._createGrid(d),this._createPoles(d),this._createAtmosphere(d)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const d of this._poleSegments)d.destroy();this._gridSegments.destroy(),this.atmosphereVertexBuffer.destroy(),this.atmosphereIndexBuffer.destroy(),this.atmosphereSegments.destroy(),this._wireframeIndexBuffer&&(this._wireframeIndexBuffer.destroy(),this._wireframeSegments.destroy())}_createGrid(d){const e=new Te,f=new At,m=65;for(let y=0;y<m;y++)for(let b=0;b<m;b++)e.emplaceBack(b,y);for(let y=0;y<64;y++)for(let b=0;b<64;b++){const M=y*m+b;f.emplaceBack(M+1,M,M+m),f.emplaceBack(M+m,M+m+1,M+1)}this._gridBuffer=d.createVertexBuffer(e,Tl.members),this._gridIndexBuffer=d.createIndexBuffer(f,!0),this._gridSegments=Qi.simpleSegment(0,0,4225,8192)}_createPoles(d){const e=new At;for(let y=0;y<=64;y++)e.emplaceBack(0,y+1,y+2);this._poleIndexBuffer=d.createIndexBuffer(e,!0);const f=new Kt,m=new Kt;this._poleSegments=[];for(let y=0,b=0;y<5;y++){const M=1<<y,I=512*M/Math.PI/2,P=360/M;f.emplaceBack(0,-I,0,0,0,.5,0),m.emplaceBack(0,-I,0,0,0,.5,1);for(let L=0;L<=64;L++){const N=L/64,U=Xt(0,P,N),[j,H,ne]=Wd(jm,Gm,U,I);f.emplaceBack(j,H,ne,0,0,N,0),m.emplaceBack(j,H,ne,0,0,N,1)}this._poleSegments.push(Qi.simpleSegment(b,0,66,64)),b+=66}this._poleNorthVertexBuffer=d.createVertexBuffer(f,Xd,!1),this._poleSouthVertexBuffer=d.createVertexBuffer(m,Xd,!1)}_createAtmosphere(d){const e=new mi;e.emplaceBack(-1,1,1,0,0),e.emplaceBack(1,1,1,1,0),e.emplaceBack(1,-1,1,1,1),e.emplaceBack(-1,-1,1,0,1);const f=new At;f.emplaceBack(0,1,2),f.emplaceBack(2,3,0),this.atmosphereVertexBuffer=d.createVertexBuffer(e,Nm.members),this.atmosphereIndexBuffer=d.createIndexBuffer(f),this.atmosphereSegments=Qi.simpleSegment(0,0,4,2)}getGridBuffers(){return[this._gridBuffer,this._gridIndexBuffer,this._gridSegments]}getPoleBuffers(d){return[this._poleNorthVertexBuffer,this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[d]]}getWirefameBuffers(d){if(!this._wireframeSegments){const e=new ti,f=64,m=f+1;for(let y=0;y<f;y++)for(let b=0;b<f;b++){const M=y*m+b;e.emplaceBack(M,M+1),e.emplaceBack(M,M+m),e.emplaceBack(M,M+m+1)}this._wireframeIndexBuffer=d.createIndexBuffer(e),this._wireframeSegments=Qi.simpleSegment(0,0,f*f,e.length)}return[this._gridBuffer,this._wireframeIndexBuffer,this._wireframeSegments]}},u.GlyphManager=da,u.ImagePosition=Jh,u.LineAtlas=uu,u.LngLat=Ni,u.LngLatBounds=Io,u.LocalGlyphMode=iu,u.MAX_MERCATOR_LATITUDE=$n,u.MercatorCoordinate=Dc,u.ONE_EM=Er,u.OverscaledTileID=kr,u.Properties=te,u.RGBAImage=Qr,u.Ray=class{constructor(d,e){this.pos=d,this.dir=e}intersectsPlane(d,e,f){const m=cl(e,this.dir);if(Math.abs(m)<1e-6)return!1;const y=((d[0]-this.pos[0])*e[0]+(d[1]-this.pos[1])*e[1]+(d[2]-this.pos[2])*e[2])/m;return f[0]=this.pos[0]+this.dir[0]*y,f[1]=this.pos[1]+this.dir[1]*y,f[2]=this.pos[2]+this.dir[2]*y,!0}closestPointOnSphere(d,e,f){if(function(j,H){var ne=j[0],ae=j[1],pe=j[2],ve=H[0],Ie=H[1],Be=H[2];return Math.abs(ne-ve)<=Ph*Math.max(1,Math.abs(ne),Math.abs(ve))&&Math.abs(ae-Ie)<=Ph*Math.max(1,Math.abs(ae),Math.abs(Ie))&&Math.abs(pe-Be)<=Ph*Math.max(1,Math.abs(pe),Math.abs(Be))}(this.pos,d)||e===0)return f[0]=f[1]=f[2]=0,!1;const[m,y,b]=this.dir,M=this.pos[0]-d[0],I=this.pos[1]-d[1],P=this.pos[2]-d[2],L=m*m+y*y+b*b,N=2*(M*m+I*y+P*b),U=N*N-4*L*(M*M+I*I+P*P-e*e);if(U<0){const j=Math.max(-N/2,0),H=M+m*j,ne=I+y*j,ae=P+b*j,pe=Math.hypot(H,ne,ae);return f[0]=H*e/pe,f[1]=ne*e/pe,f[2]=ae*e/pe,!1}{const j=(-N-Math.sqrt(U))/(2*L);if(j<0){const H=Math.hypot(M,I,P);return f[0]=M*e/H,f[1]=I*e/H,f[2]=P*e/H,!1}return f[0]=M+m*j,f[1]=I+y*j,f[2]=P+b*j,!0}}},u.RequestManager=class{constructor(d,e,f){this._transformRequestFn=d,this._customAccessToken=e,this._silenceAuthErrors=!!f,this._createSkuToken()}_createSkuToken(){const d=function(){let e="";for(let f=0;f<10;f++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Ci,e].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=d.token,this._skuTokenExpiresAt=d.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(d,e){return this._transformRequestFn&&this._transformRequestFn(d,e)||{url:d}}normalizeStyleURL(d,e){if(!Ft(d))return d;const f=ui(d);return f.path=`/styles/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||e)}normalizeGlyphsURL(d,e){if(!Ft(d))return d;const f=ui(d);return f.path=`/fonts/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||e)}normalizeSourceURL(d,e){if(!Ft(d))return d;const f=ui(d);return f.path=`/v4/${f.authority}.json`,f.params.push("secure"),this._makeAPIURL(f,this._customAccessToken||e)}normalizeSpriteURL(d,e,f,m){const y=ui(d);return Ft(d)?(y.path=`/styles/v1${y.path}/sprite${e}${f}`,this._makeAPIURL(y,this._customAccessToken||m)):(y.path+=`${e}${f}`,yi(y))}normalizeTileURL(d,e,f){if(this._isSkuTokenExpired()&&this._createSkuToken(),d&&!Ft(d))return d;const m=ui(d);m.path=m.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${e||f&&m.authority!=="raster"&&f===512?"@2x":""}${Ge.supported?".webp":"$1"}`),m.authority==="raster"?m.path=`/${Tt.RASTER_URL_PREFIX}${m.path}`:(m.path=m.path.replace(/^.+\/v4\//,"/"),m.path=`/${Tt.TILE_URL_VERSION}${m.path}`);const y=this._customAccessToken||function(b){for(const M of b){const I=M.match(/^access_token=(.*)$/);if(I)return I[1]}return null}(m.params)||Tt.ACCESS_TOKEN;return Tt.REQUIRE_ACCESS_TOKEN&&y&&this._skuToken&&m.params.push(`sku=${this._skuToken}`),this._makeAPIURL(m,y)}canonicalizeTileURL(d,e){const f=ui(d);if(!f.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!f.path.match(/\.[\w]+$/))return d;let m="mapbox://";f.path.match(/^\/raster\/v1\//)?m+=`raster/${f.path.replace(`/${Tt.RASTER_URL_PREFIX}/`,"")}`:m+=`tiles/${f.path.replace(`/${Tt.TILE_URL_VERSION}/`,"")}`;let y=f.params;return e&&(y=y.filter(b=>!b.match(/^access_token=/))),y.length&&(m+=`?${y.join("&")}`),m}canonicalizeTileset(d,e){const f=!!e&&Ft(e),m=[];for(const y of d.tiles||[])Ut(y)?m.push(this.canonicalizeTileURL(y,f)):m.push(y);return m}_makeAPIURL(d,e){const f="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",m=ui(Tt.API_URL);if(d.protocol=m.protocol,d.authority=m.authority,d.protocol==="http"){const y=d.params.indexOf("secure");y>=0&&d.params.splice(y,1)}if(m.path!=="/"&&(d.path=`${m.path}${d.path}`),!Tt.REQUIRE_ACCESS_TOKEN)return yi(d);if(e=e||Tt.ACCESS_TOKEN,!this._silenceAuthErrors){if(!e)throw new Error(`An API access token is required to use Mapbox GL. ${f}`);if(e[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${f}`)}return d.params=d.params.filter(y=>y.indexOf("access_token")===-1),d.params.push(`access_token=${e||""}`),yi(d)}},u.ResourceType=Q,u.SegmentVector=Qi,u.SourceCache=ys,u.StencilMode=_u,u.StructArrayLayout1ui2=Ii,u.StructArrayLayout2f1f2i16=Dt,u.StructArrayLayout2i4=Te,u.StructArrayLayout2ui4=ti,u.StructArrayLayout3f12=ct,u.StructArrayLayout3ui6=At,u.StructArrayLayout4i8=Ae,u.Texture=El,u.Tile=mu,u.Transitionable=x,u.Uniform1f=Cc,u.Uniform1i=class extends io{constructor(d,e){super(d,e),this.current=0}set(d){this.current!==d&&(this.current=d,this.gl.uniform1i(this.location,d))}},u.Uniform2f=class extends io{constructor(d,e){super(d,e),this.current=[0,0]}set(d){d[0]===this.current[0]&&d[1]===this.current[1]||(this.current=d,this.gl.uniform2f(this.location,d[0],d[1]))}},u.Uniform3f=class extends io{constructor(d,e){super(d,e),this.current=[0,0,0]}set(d){d[0]===this.current[0]&&d[1]===this.current[1]&&d[2]===this.current[2]||(this.current=d,this.gl.uniform3f(this.location,d[0],d[1],d[2]))}},u.Uniform4f=Cu,u.UniformColor=ku,u.UniformMatrix2f=class extends io{constructor(d,e){super(d,e),this.current=Nf}set(d){for(let e=0;e<4;e++)if(d[e]!==this.current[e]){this.current=d,this.gl.uniformMatrix2fv(this.location,!1,d);break}}},u.UniformMatrix3f=class extends io{constructor(d,e){super(d,e),this.current=Of}set(d){for(let e=0;e<9;e++)if(d[e]!==this.current[e]){this.current=d,this.gl.uniformMatrix3fv(this.location,!1,d);break}}},u.UniformMatrix4f=class extends io{constructor(d,e){super(d,e),this.current=Ff}set(d){if(d[12]!==this.current[12]||d[0]!==this.current[0])return this.current=d,void this.gl.uniformMatrix4fv(this.location,!1,d);for(let e=1;e<16;e++)if(d[e]!==this.current[e]){this.current=d,this.gl.uniformMatrix4fv(this.location,!1,d);break}}},u.UnwrappedTileID=rf,u.ValidationError=bt,u.VectorTileWorkerSource=class extends Wt{constructor(d,e,f,m,y){super(),this.actor=d,this.layerIndex=e,this.availableImages=f,this.loadVectorData=y||Ef,this.loading={},this.loaded={},this.deduped=new wf(d.scheduler),this.isSpriteLoaded=m,this.scheduler=d.scheduler}loadTile(d,e){const f=d.uid,m=d&&d.request,y=m&&m.collectResourceTiming,b=this.loading[f]=new Wm(d);b.abort=this.loadVectorData(d,(M,I)=>{const P=!this.loading[f];if(delete this.loading[f],P||M||!I)return b.status="done",P||(this.loaded[f]=b),e(M);const L=I.rawData,N={};I.expires&&(N.expires=I.expires),I.cacheControl&&(N.cacheControl=I.cacheControl),b.vectorTile=I.vectorTile||new gs.VectorTile(new vl(L));const U=()=>{b.parse(b.vectorTile,this.layerIndex,this.availableImages,this.actor,(j,H)=>{if(j||!H)return e(j);const ne={};if(y){const ae=Zd(m);ae.length>0&&(ne.resourceTiming=JSON.parse(JSON.stringify(ae)))}e(null,ue({rawTileData:L.slice(0)},H,N,ne))})};this.isSpriteLoaded?U():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(U,{type:"parseTile",isSymbolTile:d.isSymbolTile,zoom:d.tileZoom}):U()}),this.loaded=this.loaded||{},this.loaded[f]=b})}reloadTile(d,e){const f=this.loaded,m=d.uid,y=this;if(f&&f[m]){const b=f[m];b.showCollisionBoxes=d.showCollisionBoxes,b.enableTerrain=!!d.enableTerrain,b.projection=d.projection,b.tileTransform=_s(d.tileID.canonical,d.projection);const M=(I,P)=>{const L=b.reloadCallback;L&&(delete b.reloadCallback,b.parse(b.vectorTile,y.layerIndex,this.availableImages,y.actor,L)),e(I,P)};b.status==="parsing"?b.reloadCallback=M:b.status==="done"&&(b.vectorTile?b.parse(b.vectorTile,this.layerIndex,this.availableImages,this.actor,M):M())}}abortTile(d,e){const f=d.uid,m=this.loading[f];m&&(m.abort&&m.abort(),delete this.loading[f]),e()}removeTile(d,e){const f=this.loaded,m=d.uid;f&&f[m]&&delete f[m],e()}},u.WritingMode=dn,u.ZoomHistory=qa,u.add=qu,u.addDynamicAttributes=su,u.adjoint=function(d,e){var f=e[0],m=e[1],y=e[2],b=e[3],M=e[4],I=e[5],P=e[6],L=e[7],N=e[8];return d[0]=M*N-I*L,d[1]=y*L-m*N,d[2]=m*I-y*M,d[3]=I*P-b*N,d[4]=f*N-y*P,d[5]=y*b-f*I,d[6]=b*L-M*P,d[7]=m*P-f*L,d[8]=f*M-m*b,d},u.asyncAll=be,u.bezier=re,u.bindAll=zt,u.boundsAttributes=af,u.bufferConvexPolygon=function(d,e){const f=[];for(let m=0;m<d.length;m++){const y=oe(m-1,-1,d.length-1),b=oe(m+1,-1,d.length-1),M=d[m],I=d[b],P=d[y].sub(M).unit(),L=I.sub(M).unit(),N=L.angleWithSep(P.x,P.y),U=P.add(L).unit().mult(-1*e/Math.sin(N/2));f.push(M.add(U))}return f},u.cacheEntryPossiblyAdded=function(d){ye++,ye>xr&&(d.getActor().send("enforceCacheSizeLimit",gr),ye=0)},u.calculateGlobeLabelMatrix=function(d,e){const{lng:f,lat:m}=d._center,y=Jd(0,0,d.worldSize/d._projectionScaler,f,m);return Bh(y,y,function(b){const M=Un(new Float64Array(16)),I=1/pu(b);return ps(M,M,b.min),Co(M,M,[I,I,I]),M}(Ml(e)))},u.calculateGlobeMatrix=Qd,u.calculateGlobeMercatorMatrix=function(d){const e=d.worldSize,f=d.point,m=ta(1,d.center.lat)*e,y=d.pixelsPerMeter,b=e/(m/d.pixelsPerMeter),M=Un(new Float64Array(16));return ps(M,M,[f.x,f.y,0]),Co(M,M,[b,b,y]),Float32Array.from(M)},u.circumferenceAtLatitude=Sh,u.clamp=_e,u.clearTileCache=function(d){const e=O.caches.delete(Tr);d&&e.catch(d).then(()=>d())},u.clipLine=Fd,u.clone=function(d){var e=new Jr(16);return e[0]=d[0],e[1]=d[1],e[2]=d[2],e[3]=d[3],e[4]=d[4],e[5]=d[5],e[6]=d[6],e[7]=d[7],e[8]=d[8],e[9]=d[9],e[10]=d[10],e[11]=d[11],e[12]=d[12],e[13]=d[13],e[14]=d[14],e[15]=d[15],e},u.clone$1=Yt,u.collisionCircleLayout=Wp,u.config=Tt,u.conjugate=function(d,e){return d[0]=-e[0],d[1]=-e[1],d[2]=-e[2],d[3]=e[3],d},u.create=function(){var d=new Jr(16);return Jr!=Float32Array&&(d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[11]=0,d[12]=0,d[13]=0,d[14]=0),d[0]=1,d[5]=1,d[10]=1,d[15]=1,d},u.create$1=Vu,u.createExpression=Ho,u.createLayout=Se,u.createStyleLayer=function(d){return d.type==="custom"?new Pm(d):new Rm[d.type](d)},u.cross=Yu,u.degToRad=J,u.div=function(d,e,f){return d[0]=e[0]/f[0],d[1]=e[1]/f[1],d[2]=e[2]/f[2],d},u.dot=cl,u.earthRadius=Mh,u.ease=he,u.easeCubicInOut=ee,u.emitValidationErrors=cc,u.endsWith=vt,u.enforceCacheSizeLimit=function(d){Ar(),tr&&tr.then(e=>{e.keys().then(f=>{for(let m=0;m<f.length-d;m++)e.delete(f[m])})})},u.evaluateSizeForFeature=jc,u.evaluateSizeForZoom=la,u.evaluateVariableOffset=Vd,u.evented=tl,u.exactEquals=function(d,e){return d[0]===e[0]&&d[1]===e[1]&&d[2]===e[2]&&d[3]===e[3]},u.exactEquals$1=function(d,e){return d[0]===e[0]&&d[1]===e[1]&&d[2]===e[2]},u.exported=ft,u.exported$1=Ge,u.extend=ue,u.extend$1=Ti,u.filterObject=kt,u.fromMat4=function(d,e){return d[0]=e[0],d[1]=e[1],d[2]=e[2],d[3]=e[4],d[4]=e[5],d[5]=e[6],d[6]=e[8],d[7]=e[9],d[8]=e[10],d},u.fromQuat=function(d,e){var f=e[0],m=e[1],y=e[2],b=e[3],M=f+f,I=m+m,P=y+y,L=f*M,N=m*M,U=m*I,j=y*M,H=y*I,ne=y*P,ae=b*M,pe=b*I,ve=b*P;return d[0]=1-U-ne,d[1]=N+ve,d[2]=j-pe,d[3]=0,d[4]=N-ve,d[5]=1-L-ne,d[6]=H+ae,d[7]=0,d[8]=j+pe,d[9]=H-ae,d[10]=1-L-U,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d},u.fromRotation=function(d,e){var f=Math.sin(e),m=Math.cos(e);return d[0]=m,d[1]=f,d[2]=0,d[3]=-f,d[4]=m,d[5]=0,d[6]=0,d[7]=0,d[8]=1,d},u.fromScaling=function(d,e){return d[0]=e[0],d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=e[1],d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=e[2],d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d},u.furthestTileCorner=function(d){const e=Math.round((d+45+360)%360/90)%4;return fe[e]},u.getAABBPointSquareDist=function(d,e,f){let m=0;for(let y=0;y<2;++y){const b=f?f[y]:0;d[y]>b&&(m+=(d[y]-b)*(d[y]-b)),e[y]<b&&(m+=(b-e[y])*(b-e[y]))}return m},u.getAnchorAlignment=tu,u.getAnchorJustification=nu,u.getBounds=function(d){let e=1/0,f=1/0,m=-1/0,y=-1/0;for(const b of d)e=Math.min(e,b.x),f=Math.min(f,b.y),m=Math.max(m,b.x),y=Math.max(y,b.y);return{min:new z(e,f),max:new z(m,y)}},u.getColumn=function(d,e){return[d[4*e],d[4*e+1],d[4*e+2],d[4*e+3]]},u.getGridMatrix=function(d,e){const[f,m]=e,y=.015625;return[0,(m[1]-f[1])*y,1<<d.z,(m[0]-f[0])*y,0,d.y,f[0],f[1],y]},u.getImage=ut,u.getJSON=function(d,e){return ce(ue(d,{type:"json"}),e)},u.getMapSessionAPI=Rr,u.getPerformanceMeasurement=Zd,u.getProjection=function(d){const e=d.parallels,f=!!e&&Math.abs(e[0]+e[1])<.01;switch(d.name){case"mercator":return new Km(d);case"equirectangular":return new eg(d);case"naturalEarth":return new ig(d);case"equalEarth":return new Qm(d);case"winkelTripel":return new rg(d);case"albers":return f?new Sf(d):new Jm(d);case"lambertConformalConic":return f?new Sf(d):new tg(d)}throw new Error(`Invalid projection name: ${d.name}`)},u.getRTLTextPluginStatus=Js,u.getReferrer=W,u.getTilePoint=function(d,{x:e,y:f},m=0){return new z(((e-m)*d.scale-d.x)*fi,(f*d.scale-d.y)*fi)},u.getTileVec3=function(d,e,f=0){return sl(((e.x-f)*d.scale-d.x)*fi,(e.y*d.scale-d.y)*fi,Bu(e.z,e.y))},u.getVideo=function(d,e){const f=O.document.createElement("video");f.muted=!0,f.onloadstart=function(){e(null,f)};for(let m=0;m<d.length;m++){const y=O.document.createElement("source");ze(d[m])||(f.crossOrigin="Anonymous"),y.src=d[m],f.appendChild(y)}return{cancel:()=>{}}},u.globeECEFOrigin=function(d,e){const f=[0,0,0];return ms(f,f,Kd(Ml(e.canonical))),ms(f,f,d),f},u.globePixelsToTileUnits=function(d,e){return fi/(512*Math.pow(2,d))*pu(Ml(e))},u.globePoleMatrixForTile=function(d,e,f){const m=Un(new Float64Array(16)),y=1<<d,b=360*(e/y-.5),M=f.point,I=f.worldSize/(f.tileSize*y);return ps(m,m,[M.x,M.y,-f.worldSize/Math.PI/2]),Co(m,m,[I,I,I]),Rh(m,m,J(-f._center.lat)),Lh(m,m,J(-f._center.lng+b)),Float32Array.from(m)},u.globeTileLatLngCorners=fu,u.globeToMercatorTransition=function(d){return we(5,6,d)},u.identity=Un,u.identity$1=Ku,u.invert=function(d,e){var f=e[0],m=e[1],y=e[2],b=e[3],M=e[4],I=e[5],P=e[6],L=e[7],N=e[8],U=e[9],j=e[10],H=e[11],ne=e[12],ae=e[13],pe=e[14],ve=e[15],Ie=f*I-m*M,Be=f*P-y*M,Le=f*L-b*M,Fe=m*P-y*I,Oe=m*L-b*I,Xe=y*L-b*P,We=N*ae-U*ne,tt=N*pe-j*ne,nt=N*ve-H*ne,qe=U*pe-j*ae,Qe=U*ve-H*ae,st=j*ve-H*pe,mt=Ie*st-Be*Qe+Le*qe+Fe*nt-Oe*tt+Xe*We;return mt?(d[0]=(I*st-P*Qe+L*qe)*(mt=1/mt),d[1]=(y*Qe-m*st-b*qe)*mt,d[2]=(ae*Xe-pe*Oe+ve*Fe)*mt,d[3]=(j*Oe-U*Xe-H*Fe)*mt,d[4]=(P*nt-M*st-L*tt)*mt,d[5]=(f*st-y*nt+b*tt)*mt,d[6]=(pe*Le-ne*Xe-ve*Be)*mt,d[7]=(N*Xe-j*Le+H*Be)*mt,d[8]=(M*Qe-I*nt+L*We)*mt,d[9]=(m*nt-f*Qe-b*We)*mt,d[10]=(ne*Oe-ae*Le+ve*Ie)*mt,d[11]=(U*Le-N*Oe-H*Ie)*mt,d[12]=(I*tt-M*qe-P*We)*mt,d[13]=(f*qe-m*tt+y*We)*mt,d[14]=(ae*Be-ne*Fe-pe*Ie)*mt,d[15]=(N*Fe-U*Be+j*Ie)*mt,d):null},u.isMapAuthenticated=function(d){return Lr.has(d)},u.isMapboxURL=Ft,u.isSafariWithAntialiasingBug=function(d){const e=d.navigator?d.navigator.userAgent:null;return!!ci(d)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},u.latFromMercatorY=wr,u.len=ip,u.length=Gu,u.length$1=function(d){return Math.hypot(d[0],d[1],d[2],d[3])},u.loadVectorTile=Ef,u.makeRequest=ce,u.mercatorXfromLng=ol,u.mercatorYfromLat=ea,u.mercatorZfromAltitude=ta,u.mul=ep,u.mul$1=tp,u.multiply=function(d,e,f){var m=e[0],y=e[1],b=e[2],M=e[3],I=e[4],P=e[5],L=e[6],N=e[7],U=e[8],j=f[0],H=f[1],ne=f[2],ae=f[3],pe=f[4],ve=f[5],Ie=f[6],Be=f[7],Le=f[8];return d[0]=j*m+H*M+ne*L,d[1]=j*y+H*I+ne*N,d[2]=j*b+H*P+ne*U,d[3]=ae*m+pe*M+ve*L,d[4]=ae*y+pe*I+ve*N,d[5]=ae*b+pe*P+ve*U,d[6]=Ie*m+Be*M+Le*L,d[7]=Ie*y+Be*I+Le*N,d[8]=Ie*b+Be*P+Le*U,d},u.multiply$1=Bh,u.multiply$2=Xu,u.nextPowerOfTwo=rt,u.normalize=ll,u.normalize$1=function(d,e){var f=e[0],m=e[1],y=e[2],b=e[3],M=f*f+m*m+y*y+b*b;return M>0&&(M=1/Math.sqrt(M)),d[0]=f*M,d[1]=m*M,d[2]=y*M,d[3]=b*M,d},u.number=Xt,u.ortho=function(d,e,f,m,y,b,M){var I=1/(e-f),P=1/(m-y),L=1/(b-M);return d[0]=-2*I,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=-2*P,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=2*L,d[11]=0,d[12]=(e+f)*I,d[13]=(y+m)*P,d[14]=(M+b)*L,d[15]=1,d},u.pbf=vl,u.perspective=function(d,e,f,m,y){var b,M=1/Math.tan(e/2);return d[0]=M/f,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=M,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[11]=-1,d[12]=0,d[13]=0,d[15]=0,y!=null&&y!==1/0?(d[10]=(y+m)*(b=1/(m-y)),d[14]=2*y*m*b):(d[10]=-1,d[14]=-2*m),d},u.pick=function(d,e){const f={};for(let m=0;m<e.length;m++){const y=e[m];y in d&&(f[y]=d[y])}return f},u.plugin=Hr,u.pointGeometry=z,u.polygonIntersectsBox=Nu,u.polygonIntersectsPolygon=Lu,u.polygonizeBounds=function(d,e,f=0,m=!0){const y=new z(f,f),b=d.sub(y),M=e.add(y),I=[b,new z(M.x,b.y),M,new z(b.x,M.y)];return m&&I.push(b),I},u.posAttributes=Tl,u.postMapLoadEvent=Oi,u.postTurnstileEvent=zi,u.potpack=Kh,u.prevPowerOfTwo=function(d){return d<=1?1:Math.pow(2,Math.floor(Math.log(d)/Math.LN2))},u.radToDeg=Y,u.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],u.registerForPluginStateChange=function(d){return d({pluginStatus:Cr,pluginURL:Ur}),tl.on("pluginStateChange",d),d},u.removeAuthState=function(d){Lr.delete(d)},u.renderColorRamp=Vh,u.rotateX=Rh,u.rotateX$1=Ju,u.rotateY=Lh,u.rotateZ=function(d,e,f){var m=Math.sin(f),y=Math.cos(f),b=e[0],M=e[1],I=e[2],P=e[3],L=e[4],N=e[5],U=e[6],j=e[7];return e!==d&&(d[8]=e[8],d[9]=e[9],d[10]=e[10],d[11]=e[11],d[12]=e[12],d[13]=e[13],d[14]=e[14],d[15]=e[15]),d[0]=b*y+L*m,d[1]=M*y+N*m,d[2]=I*y+U*m,d[3]=P*y+j*m,d[4]=L*y-b*m,d[5]=N*y-M*m,d[6]=U*y-I*m,d[7]=j*y-P*m,d},u.rotateZ$1=function(d,e,f){f*=.5;var m=e[0],y=e[1],b=e[2],M=e[3],I=Math.sin(f),P=Math.cos(f);return d[0]=m*P+y*I,d[1]=y*P-m*I,d[2]=b*P+M*I,d[3]=M*P-b*I,d},u.scale=Co,u.scale$1=function(d,e,f){return d[0]=e[0]*f,d[1]=e[1]*f,d[2]=e[2]*f,d[3]=e[3]*f,d},u.scale$2=al,u.scaleAndAdd=Nh,u.setCacheLimits=function(d,e){gr=d,xr=e},u.setColumn=function(d,e,f){d[4*e+0]=f[0],d[4*e+1]=f[1],d[4*e+2]=f[2],d[4*e+3]=f[3]},u.setRTLTextPlugin=function(d,e,f=!1){if(Cr===Ja||Cr===ls||Cr===Qa)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ur=ft.resolveURL(d),Cr=Ja,el=e,eo(),f||Eo()},u.smoothstep=we,u.spec=$e,u.storeAuthState=function(d,e){e?Lr.add(d):Lr.delete(d)},u.sub=na,u.subtract=Zu,u.symbolSize=Hp,u.tileAABB=function(d,e,f,m,y,b,M,I,P){if(P.name==="globe")return Vm(d,e,new Jc(f,m,y));const L=_s({z:f,x:m,y},P);return new un([(b+L.x/L.scale)*e,e*(L.y/L.scale),M],[(b+L.x2/L.scale)*e,e*(L.y2/L.scale),I])},u.tileTransform=_s,u.transformMat3=function(d,e,f){var m=e[0],y=e[1],b=e[2];return d[0]=m*f[0]+y*f[3]+b*f[6],d[1]=m*f[1]+y*f[4]+b*f[7],d[2]=m*f[2]+y*f[5]+b*f[8],d},u.transformMat4=ms,u.transformMat4$1=oa,u.transformQuat=Wu,u.translate=ps,u.transpose=function(d,e){if(d===e){var f=e[1],m=e[2],y=e[5];d[1]=e[3],d[2]=e[6],d[3]=f,d[5]=e[7],d[6]=m,d[7]=y}else d[0]=e[0],d[1]=e[3],d[2]=e[6],d[3]=e[1],d[4]=e[4],d[5]=e[7],d[6]=e[2],d[7]=e[5],d[8]=e[8];return d},u.triggerPluginCompletionEvent=cs,u.uniqueId=Ne,u.validateCustomStyleLayer=function(d){const e=[],f=d.id;return f===void 0&&e.push({message:`layers.${f}: missing required property "id"`}),d.render===void 0&&e.push({message:`layers.${f}: missing required method "render"`}),d.renderingMode&&d.renderingMode!=="2d"&&d.renderingMode!=="3d"&&e.push({message:`layers.${f}: property "renderingMode" must be either "2d" or "3d"`}),e},u.validateFilter=d=>En(zn(d)),u.validateFog=d=>En(lc(d)),u.validateLayer=d=>En(rc(d)),u.validateLight=d=>En(sc(d)),u.validateSource=d=>En(oc(d)),u.validateStyle=rs,u.validateTerrain=d=>En(ac(d)),u.values=ie,u.vectorTile=gs,u.version=A,u.warnOnce=ot,u.window=O,u.wrap=oe}),g(["./shared"],function(u){function A(Q){if(typeof Q=="number"||typeof Q=="boolean"||typeof Q=="string"||Q==null)return JSON.stringify(Q);if(Array.isArray(Q)){let W="[";for(const ce of Q)W+=`${A(ce)},`;return`${W}]`}let G="{";for(const W of Object.keys(Q).sort())G+=`${W}:${A(Q[W])},`;return`${G}}`}function S(Q){let G="";for(const W of u.refProperties)G+=`/${A(Q[W])}`;return G}class D{constructor(G){this.keyCache={},G&&this.replace(G)}replace(G){this._layerConfigs={},this._layers={},this.update(G,[])}update(G,W){for(const me of G)this._layerConfigs[me.id]=me,(this._layers[me.id]=u.createStyleLayer(me)).compileFilter(),this.keyCache[me.id]&&delete this.keyCache[me.id];for(const me of W)delete this.keyCache[me],delete this._layerConfigs[me],delete this._layers[me];this.familiesBySource={};const ce=function(me,ke){const Re={};for(let Pe=0;Pe<me.length;Pe++){const je=ke&&ke[me[Pe].id]||S(me[Pe]);ke&&(ke[me[Pe].id]=je);let Ke=Re[je];Ke||(Ke=Re[je]=[]),Ke.push(me[Pe])}const ze=[];for(const Pe in Re)ze.push(Re[Pe]);return ze}(u.values(this._layerConfigs),this.keyCache);for(const me of ce){const ke=me.map(ut=>this._layers[ut.id]),Re=ke[0];if(Re.visibility==="none")continue;const ze=Re.source||"";let Pe=this.familiesBySource[ze];Pe||(Pe=this.familiesBySource[ze]={});const je=Re.sourceLayer||"_geojsonTileLayer";let Ke=Pe[je];Ke||(Ke=Pe[je]=[]),Ke.push(ke)}}}class z{loadTile(G,W){const{uid:ce,encoding:me,rawImageData:ke,padding:Re,buildQuadTree:ze}=G,Pe=u.window.ImageBitmap&&ke instanceof u.window.ImageBitmap?this.getImageData(ke,Re):ke;W(null,new u.DEMData(ce,Pe,me,Re<1,ze))}getImageData(G,W){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(G.width,G.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=G.width,this.offscreenCanvas.height=G.height,this.offscreenCanvasContext.drawImage(G,0,0,G.width,G.height);const ce=this.offscreenCanvasContext.getImageData(-W,-W,G.width+2*W,G.height+2*W);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ce}}var $=function Q(G,W){var ce,me=G&&G.type;if(me==="FeatureCollection")for(ce=0;ce<G.features.length;ce++)Q(G.features[ce],W);else if(me==="GeometryCollection")for(ce=0;ce<G.geometries.length;ce++)Q(G.geometries[ce],W);else if(me==="Feature")Q(G.geometry,W);else if(me==="Polygon")O(G.coordinates,W);else if(me==="MultiPolygon")for(ce=0;ce<G.coordinates.length;ce++)O(G.coordinates[ce],W);return G};function O(Q,G){if(Q.length!==0){q(Q[0],G);for(var W=1;W<Q.length;W++)q(Q[W],!G)}}function q(Q,G){for(var W=0,ce=0,me=0,ke=Q.length,Re=ke-1;me<ke;Re=me++){var ze=(Q[me][0]-Q[Re][0])*(Q[Re][1]+Q[me][1]),Pe=W+ze;ce+=Math.abs(W)>=Math.abs(ze)?W-Pe+ze:ze-Pe+W,W=Pe}W+ce>=0!=!!G&&Q.reverse()}const K=u.vectorTile.VectorTileFeature.prototype.toGeoJSON;class J{constructor(G){this._feature=G,this.extent=u.EXTENT,this.type=G.type,this.properties=G.tags,"id"in G&&!isNaN(G.id)&&(this.id=parseInt(G.id,10))}loadGeometry(){if(this._feature.type===1){const G=[];for(const W of this._feature.geometry)G.push([new u.pointGeometry(W[0],W[1])]);return G}{const G=[];for(const W of this._feature.geometry){const ce=[];for(const me of W)ce.push(new u.pointGeometry(me[0],me[1]));G.push(ce)}return G}}toGeoJSON(G,W,ce){return K.call(this,G,W,ce)}}class Y{constructor(G){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=u.EXTENT,this.length=G.length,this._features=G}feature(G){return new J(this._features[G])}}var fe=u.vectorTile.VectorTileFeature,ee=re;function re(Q,G){this.options=G||{},this.features=Q,this.length=Q.length}function he(Q,G){this.id=typeof Q.id=="number"?Q.id:void 0,this.type=Q.type,this.rawGeometry=Q.type===1?[Q.geometry]:Q.geometry,this.properties=Q.tags,this.extent=G||4096}re.prototype.feature=function(Q){return new he(this.features[Q],this.options.extent)},he.prototype.loadGeometry=function(){var Q=this.rawGeometry;this.geometry=[];for(var G=0;G<Q.length;G++){for(var W=Q[G],ce=[],me=0;me<W.length;me++)ce.push(new u.pointGeometry(W[me][0],W[me][1]));this.geometry.push(ce)}return this.geometry},he.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Q=this.geometry,G=1/0,W=-1/0,ce=1/0,me=-1/0,ke=0;ke<Q.length;ke++)for(var Re=Q[ke],ze=0;ze<Re.length;ze++){var Pe=Re[ze];G=Math.min(G,Pe.x),W=Math.max(W,Pe.x),ce=Math.min(ce,Pe.y),me=Math.max(me,Pe.y)}return[G,ce,W,me]},he.prototype.toGeoJSON=fe.prototype.toGeoJSON;var _e=oe,we=ee;function oe(Q){var G=new u.pbf;return function(W,ce){for(var me in W.layers)ce.writeMessage(3,be,W.layers[me])}(Q,G),G.finish()}function be(Q,G){var W;G.writeVarintField(15,Q.version||1),G.writeStringField(1,Q.name||""),G.writeVarintField(5,Q.extent||4096);var ce={keys:[],values:[],keycache:{},valuecache:{}};for(W=0;W<Q.length;W++)ce.feature=Q.feature(W),G.writeMessage(2,ie,ce);var me=ce.keys;for(W=0;W<me.length;W++)G.writeStringField(3,me[W]);var ke=ce.values;for(W=0;W<ke.length;W++)G.writeMessage(4,rt,ke[W])}function ie(Q,G){var W=Q.feature;W.id!==void 0&&G.writeVarintField(1,W.id),G.writeMessage(2,ue,Q),G.writeVarintField(3,W.type),G.writeMessage(4,it,W)}function ue(Q,G){var W=Q.feature,ce=Q.keys,me=Q.values,ke=Q.keycache,Re=Q.valuecache;for(var ze in W.properties){var Pe=W.properties[ze],je=ke[ze];if(Pe!==null){je===void 0&&(ce.push(ze),ke[ze]=je=ce.length-1),G.writeVarint(je);var Ke=typeof Pe;Ke!=="string"&&Ke!=="boolean"&&Ke!=="number"&&(Pe=JSON.stringify(Pe));var ut=Ke+":"+Pe,et=Re[ut];et===void 0&&(me.push(Pe),Re[ut]=et=me.length-1),G.writeVarint(et)}}}function Ce(Q,G){return(G<<3)+(7&Q)}function Ne(Q){return Q<<1^Q>>31}function it(Q,G){for(var W=Q.loadGeometry(),ce=Q.type,me=0,ke=0,Re=W.length,ze=0;ze<Re;ze++){var Pe=W[ze],je=1;ce===1&&(je=Pe.length),G.writeVarint(Ce(1,je));for(var Ke=ce===3?Pe.length-1:Pe.length,ut=0;ut<Ke;ut++){ut===1&&ce!==1&&G.writeVarint(Ce(2,Ke-1));var et=Pe[ut].x-me,Rt=Pe[ut].y-ke;G.writeVarint(Ne(et)),G.writeVarint(Ne(Rt)),me+=et,ke+=Rt}ce===3&&G.writeVarint(Ce(7,1))}}function rt(Q,G){var W=typeof Q;W==="string"?G.writeStringField(1,Q):W==="boolean"?G.writeBooleanField(7,Q):W==="number"&&(Q%1!=0?G.writeDoubleField(3,Q):Q<0?G.writeSVarintField(6,Q):G.writeVarintField(5,Q))}function Pt(Q,G,W,ce,me,ke){if(me-ce<=W)return;const Re=ce+me>>1;zt(Q,G,Re,ce,me,ke%2),Pt(Q,G,W,ce,Re-1,ke+1),Pt(Q,G,W,Re+1,me,ke+1)}function zt(Q,G,W,ce,me,ke){for(;me>ce;){if(me-ce>600){const je=me-ce+1,Ke=W-ce+1,ut=Math.log(je),et=.5*Math.exp(2*ut/3),Rt=.5*Math.sqrt(ut*et*(je-et)/je)*(Ke-je/2<0?-1:1);zt(Q,G,W,Math.max(ce,Math.floor(W-Ke*et/je+Rt)),Math.min(me,Math.floor(W+(je-Ke)*et/je+Rt)),ke)}const Re=G[2*W+ke];let ze=ce,Pe=me;for(vt(Q,G,ce,W),G[2*me+ke]>Re&&vt(Q,G,ce,me);ze<Pe;){for(vt(Q,G,ze,Pe),ze++,Pe--;G[2*ze+ke]<Re;)ze++;for(;G[2*Pe+ke]>Re;)Pe--}G[2*ce+ke]===Re?vt(Q,G,ce,Pe):(Pe++,vt(Q,G,Pe,me)),Pe<=W&&(ce=Pe+1),W<=Pe&&(me=Pe-1)}}function vt(Q,G,W,ce){Vt(Q,W,ce),Vt(G,2*W,2*ce),Vt(G,2*W+1,2*ce+1)}function Vt(Q,G,W){const ce=Q[G];Q[G]=Q[W],Q[W]=ce}function kt(Q,G,W,ce){const me=Q-W,ke=G-ce;return me*me+ke*ke}_e.fromVectorTileJs=oe,_e.fromGeojsonVt=function(Q,G){G=G||{};var W={};for(var ce in Q)W[ce]=new ee(Q[ce].features,G),W[ce].name=ce,W[ce].version=G.version,W[ce].extent=G.extent;return oe({layers:W})},_e.GeoJSONWrapper=we;const Yt=Q=>Q[0],Qt=Q=>Q[1];class ot{constructor(G,W=Yt,ce=Qt,me=64,ke=Float64Array){this.nodeSize=me,this.points=G;const Re=G.length<65536?Uint16Array:Uint32Array,ze=this.ids=new Re(G.length),Pe=this.coords=new ke(2*G.length);for(let je=0;je<G.length;je++)ze[je]=je,Pe[2*je]=W(G[je]),Pe[2*je+1]=ce(G[je]);Pt(ze,Pe,me,0,ze.length-1,0)}range(G,W,ce,me){return function(ke,Re,ze,Pe,je,Ke,ut){const et=[0,ke.length-1,0],Rt=[];let wt,Lt;for(;et.length;){const Wt=et.pop(),$e=et.pop(),Ti=et.pop();if($e-Ti<=ut){for(let ki=Ti;ki<=$e;ki++)wt=Re[2*ki],Lt=Re[2*ki+1],wt>=ze&&wt<=je&&Lt>=Pe&&Lt<=Ke&&Rt.push(ke[ki]);continue}const St=Math.floor((Ti+$e)/2);wt=Re[2*St],Lt=Re[2*St+1],wt>=ze&&wt<=je&&Lt>=Pe&&Lt<=Ke&&Rt.push(ke[St]);const Ai=(Wt+1)%2;(Wt===0?ze<=wt:Pe<=Lt)&&(et.push(Ti),et.push(St-1),et.push(Ai)),(Wt===0?je>=wt:Ke>=Lt)&&(et.push(St+1),et.push($e),et.push(Ai))}return Rt}(this.ids,this.coords,G,W,ce,me,this.nodeSize)}within(G,W,ce){return function(me,ke,Re,ze,Pe,je){const Ke=[0,me.length-1,0],ut=[],et=Pe*Pe;for(;Ke.length;){const Rt=Ke.pop(),wt=Ke.pop(),Lt=Ke.pop();if(wt-Lt<=je){for(let Ai=Lt;Ai<=wt;Ai++)kt(ke[2*Ai],ke[2*Ai+1],Re,ze)<=et&&ut.push(me[Ai]);continue}const Wt=Math.floor((Lt+wt)/2),$e=ke[2*Wt],Ti=ke[2*Wt+1];kt($e,Ti,Re,ze)<=et&&ut.push(me[Wt]);const St=(Rt+1)%2;(Rt===0?Re-Pe<=$e:ze-Pe<=Ti)&&(Ke.push(Lt),Ke.push(Wt-1),Ke.push(St)),(Rt===0?Re+Pe>=$e:ze+Pe>=Ti)&&(Ke.push(Wt+1),Ke.push(wt),Ke.push(St))}return ut}(this.ids,this.coords,G,W,ce,this.nodeSize)}}const gt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Q=>Q},pt=Math.fround||(Bt=new Float32Array(1),Q=>(Bt[0]=+Q,Bt[0]));var Bt;class Zt{constructor(G){this.options=ft(Object.create(gt),G),this.trees=new Array(this.options.maxZoom+1)}load(G){const{log:W,minZoom:ce,maxZoom:me,nodeSize:ke}=this.options;W&&console.time("total time");const Re=`prepare ${G.length} points`;W&&console.time(Re),this.points=G;let ze=[];for(let Pe=0;Pe<G.length;Pe++)G[Pe].geometry&&ze.push(ii(G[Pe],Pe));this.trees[me+1]=new ot(ze,_i,Tt,ke,Float32Array),W&&console.timeEnd(Re);for(let Pe=me;Pe>=ce;Pe--){const je=+Date.now();ze=this._cluster(ze,Pe),this.trees[Pe]=new ot(ze,_i,Tt,ke,Float32Array),W&&console.log("z%d: %d clusters in %dms",Pe,ze.length,+Date.now()-je)}return W&&console.timeEnd("total time"),this}getClusters(G,W){let ce=((G[0]+180)%360+360)%360-180;const me=Math.max(-90,Math.min(90,G[1]));let ke=G[2]===180?180:((G[2]+180)%360+360)%360-180;const Re=Math.max(-90,Math.min(90,G[3]));if(G[2]-G[0]>=360)ce=-180,ke=180;else if(ce>ke){const Ke=this.getClusters([ce,me,180,Re],W),ut=this.getClusters([-180,me,ke,Re],W);return Ke.concat(ut)}const ze=this.trees[this._limitZoom(W)],Pe=ze.range(Nt(ce),ci(Re),Nt(ke),ci(me)),je=[];for(const Ke of Pe){const ut=ze.points[Ke];je.push(ut.numPoints?pi(ut):this.points[ut.index])}return je}getChildren(G){const W=this._getOriginId(G),ce=this._getOriginZoom(G),me="No cluster with the specified id.",ke=this.trees[ce];if(!ke)throw new Error(me);const Re=ke.points[W];if(!Re)throw new Error(me);const ze=this.options.radius/(this.options.extent*Math.pow(2,ce-1)),Pe=ke.within(Re.x,Re.y,ze),je=[];for(const Ke of Pe){const ut=ke.points[Ke];ut.parentId===G&&je.push(ut.numPoints?pi(ut):this.points[ut.index])}if(je.length===0)throw new Error(me);return je}getLeaves(G,W,ce){const me=[];return this._appendLeaves(me,G,W=W||10,ce=ce||0,0),me}getTile(G,W,ce){const me=this.trees[this._limitZoom(G)],ke=Math.pow(2,G),{extent:Re,radius:ze}=this.options,Pe=ze/Re,je=(ce-Pe)/ke,Ke=(ce+1+Pe)/ke,ut={features:[]};return this._addTileFeatures(me.range((W-Pe)/ke,je,(W+1+Pe)/ke,Ke),me.points,W,ce,ke,ut),W===0&&this._addTileFeatures(me.range(1-Pe/ke,je,1,Ke),me.points,ke,ce,ke,ut),W===ke-1&&this._addTileFeatures(me.range(0,je,Pe/ke,Ke),me.points,-1,ce,ke,ut),ut.features.length?ut:null}getClusterExpansionZoom(G){let W=this._getOriginZoom(G)-1;for(;W<=this.options.maxZoom;){const ce=this.getChildren(G);if(W++,ce.length!==1)break;G=ce[0].properties.cluster_id}return W}_appendLeaves(G,W,ce,me,ke){const Re=this.getChildren(W);for(const ze of Re){const Pe=ze.properties;if(Pe&&Pe.cluster?ke+Pe.point_count<=me?ke+=Pe.point_count:ke=this._appendLeaves(G,Pe.cluster_id,ce,me,ke):ke<me?ke++:G.push(ze),G.length===ce)break}return ke}_addTileFeatures(G,W,ce,me,ke,Re){for(const ze of G){const Pe=W[ze],je=Pe.numPoints;let Ke,ut,et;if(je)Ke=ai(Pe),ut=Pe.x,et=Pe.y;else{const Lt=this.points[Pe.index];Ke=Lt.properties,ut=Nt(Lt.geometry.coordinates[0]),et=ci(Lt.geometry.coordinates[1])}const Rt={type:1,geometry:[[Math.round(this.options.extent*(ut*ke-ce)),Math.round(this.options.extent*(et*ke-me))]],tags:Ke};let wt;je?wt=Pe.id:this.options.generateId?wt=Pe.index:this.points[Pe.index].id&&(wt=this.points[Pe.index].id),wt!==void 0&&(Rt.id=wt),Re.features.push(Rt)}}_limitZoom(G){return Math.max(this.options.minZoom,Math.min(+G,this.options.maxZoom+1))}_cluster(G,W){const ce=[],{radius:me,extent:ke,reduce:Re,minPoints:ze}=this.options,Pe=me/(ke*Math.pow(2,W));for(let je=0;je<G.length;je++){const Ke=G[je];if(Ke.zoom<=W)continue;Ke.zoom=W;const ut=this.trees[W+1],et=ut.within(Ke.x,Ke.y,Pe),Rt=Ke.numPoints||1;let wt=Rt;for(const Lt of et){const Wt=ut.points[Lt];Wt.zoom>W&&(wt+=Wt.numPoints||1)}if(wt>Rt&&wt>=ze){let Lt=Ke.x*Rt,Wt=Ke.y*Rt,$e=Re&&Rt>1?this._map(Ke,!0):null;const Ti=(je<<5)+(W+1)+this.points.length;for(const St of et){const Ai=ut.points[St];if(Ai.zoom<=W)continue;Ai.zoom=W;const ki=Ai.numPoints||1;Lt+=Ai.x*ki,Wt+=Ai.y*ki,Ai.parentId=Ti,Re&&($e||($e=this._map(Ke,!0)),Re($e,this._map(Ai)))}Ke.parentId=Ti,ce.push(si(Lt/wt,Wt/wt,Ti,wt,$e))}else if(ce.push(Ke),wt>1)for(const Lt of et){const Wt=ut.points[Lt];Wt.zoom<=W||(Wt.zoom=W,ce.push(Wt))}}return ce}_getOriginId(G){return G-this.points.length>>5}_getOriginZoom(G){return(G-this.points.length)%32}_map(G,W){if(G.numPoints)return W?ft({},G.properties):G.properties;const ce=this.points[G.index].properties,me=this.options.map(ce);return W&&me===ce?ft({},me):me}}function si(Q,G,W,ce,me){return{x:pt(Q),y:pt(G),zoom:1/0,id:W,parentId:-1,numPoints:ce,properties:me}}function ii(Q,G){const[W,ce]=Q.geometry.coordinates;return{x:pt(Nt(W)),y:pt(ci(ce)),zoom:1/0,index:G,parentId:-1}}function pi(Q){return{type:"Feature",id:Q.id,properties:ai(Q),geometry:{type:"Point",coordinates:[(G=Q.x,360*(G-.5)),$t(Q.y)]}};var G}function ai(Q){const G=Q.numPoints,W=G>=1e4?`${Math.round(G/1e3)}k`:G>=1e3?Math.round(G/100)/10+"k":G;return ft(ft({},Q.properties),{cluster:!0,cluster_id:Q.id,point_count:G,point_count_abbreviated:W})}function Nt(Q){return Q/360+.5}function ci(Q){const G=Math.sin(Q*Math.PI/180),W=.5-.25*Math.log((1+G)/(1-G))/Math.PI;return W<0?0:W>1?1:W}function $t(Q){const G=(180-360*Q)*Math.PI/180;return 360*Math.atan(Math.exp(G))/Math.PI-90}function ft(Q,G){for(const W in G)Q[W]=G[W];return Q}function _i(Q){return Q.x}function Tt(Q){return Q.y}function Ge(Q,G,W,ce){for(var me,ke=ce,Re=W-G>>1,ze=W-G,Pe=Q[G],je=Q[G+1],Ke=Q[W],ut=Q[W+1],et=G+3;et<W;et+=3){var Rt=Gt(Q[et],Q[et+1],Pe,je,Ke,ut);if(Rt>ke)me=et,ke=Rt;else if(Rt===ke){var wt=Math.abs(et-Re);wt<ze&&(me=et,ze=wt)}}ke>ce&&(me-G>3&&Ge(Q,G,me,ce),Q[me+2]=ke,W-me>3&&Ge(Q,me,W,ce))}function Gt(Q,G,W,ce,me,ke){var Re=me-W,ze=ke-ce;if(Re!==0||ze!==0){var Pe=((Q-W)*Re+(G-ce)*ze)/(Re*Re+ze*ze);Pe>1?(W=me,ce=ke):Pe>0&&(W+=Re*Pe,ce+=ze*Pe)}return(Re=Q-W)*Re+(ze=G-ce)*ze}function Ht(Q,G,W,ce){var me={id:Q===void 0?null:Q,type:G,geometry:W,tags:ce,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(ke){var Re=ke.geometry,ze=ke.type;if(ze==="Point"||ze==="MultiPoint"||ze==="LineString")ei(ke,Re);else if(ze==="Polygon"||ze==="MultiLineString")for(var Pe=0;Pe<Re.length;Pe++)ei(ke,Re[Pe]);else if(ze==="MultiPolygon")for(Pe=0;Pe<Re.length;Pe++)for(var je=0;je<Re[Pe].length;je++)ei(ke,Re[Pe][je])}(me),me}function ei(Q,G){for(var W=0;W<G.length;W+=3)Q.minX=Math.min(Q.minX,G[W]),Q.minY=Math.min(Q.minY,G[W+1]),Q.maxX=Math.max(Q.maxX,G[W]),Q.maxY=Math.max(Q.maxY,G[W+1])}function oi(Q,G,W,ce){if(G.geometry){var me=G.geometry.coordinates,ke=G.geometry.type,Re=Math.pow(W.tolerance/((1<<W.maxZoom)*W.extent),2),ze=[],Pe=G.id;if(W.promoteId?Pe=G.properties[W.promoteId]:W.generateId&&(Pe=ce||0),ke==="Point")_t(me,ze);else if(ke==="MultiPoint")for(var je=0;je<me.length;je++)_t(me[je],ze);else if(ke==="LineString")Ci(me,ze,Re,!1);else if(ke==="MultiLineString"){if(W.lineMetrics){for(je=0;je<me.length;je++)Ci(me[je],ze=[],Re,!1),Q.push(Ht(Pe,"LineString",ze,G.properties));return}hi(me,ze,Re,!1)}else if(ke==="Polygon")hi(me,ze,Re,!0);else{if(ke!=="MultiPolygon"){if(ke==="GeometryCollection"){for(je=0;je<G.geometry.geometries.length;je++)oi(Q,{id:Pe,geometry:G.geometry.geometries[je],properties:G.properties},W,ce);return}throw new Error("Input data is not a valid GeoJSON object.")}for(je=0;je<me.length;je++){var Ke=[];hi(me[je],Ke,Re,!0),ze.push(Ke)}}Q.push(Ht(Pe,ke,ze,G.properties))}}function _t(Q,G){G.push(Ft(Q[0])),G.push(Ut(Q[1])),G.push(0)}function Ci(Q,G,W,ce){for(var me,ke,Re=0,ze=0;ze<Q.length;ze++){var Pe=Ft(Q[ze][0]),je=Ut(Q[ze][1]);G.push(Pe),G.push(je),G.push(0),ze>0&&(Re+=ce?(me*je-Pe*ke)/2:Math.sqrt(Math.pow(Pe-me,2)+Math.pow(je-ke,2))),me=Pe,ke=je}var Ke=G.length-3;G[2]=1,Ge(G,0,Ke,W),G[Ke+2]=1,G.size=Math.abs(Re),G.start=0,G.end=G.size}function hi(Q,G,W,ce){for(var me=0;me<Q.length;me++){var ke=[];Ci(Q[me],ke,W,ce),G.push(ke)}}function Ft(Q){return Q/360+.5}function Ut(Q){var G=Math.sin(Q*Math.PI/180),W=.5-.25*Math.log((1+G)/(1-G))/Math.PI;return W<0?0:W>1?1:W}function yt(Q,G,W,ce,me,ke,Re,ze){if(ce/=G,ke>=(W/=G)&&Re<ce)return Q;if(Re<W||ke>=ce)return null;for(var Pe=[],je=0;je<Q.length;je++){var Ke=Q[je],ut=Ke.geometry,et=Ke.type,Rt=me===0?Ke.minX:Ke.minY,wt=me===0?Ke.maxX:Ke.maxY;if(Rt>=W&&wt<ce)Pe.push(Ke);else if(!(wt<W||Rt>=ce)){var Lt=[];if(et==="Point"||et==="MultiPoint")ui(ut,Lt,W,ce,me);else if(et==="LineString")yi(ut,Lt,W,ce,me,!1,ze.lineMetrics);else if(et==="MultiLineString")Jt(ut,Lt,W,ce,me,!1);else if(et==="Polygon")Jt(ut,Lt,W,ce,me,!0);else if(et==="MultiPolygon")for(var Wt=0;Wt<ut.length;Wt++){var $e=[];Jt(ut[Wt],$e,W,ce,me,!0),$e.length&&Lt.push($e)}if(Lt.length){if(ze.lineMetrics&&et==="LineString"){for(Wt=0;Wt<Lt.length;Wt++)Pe.push(Ht(Ke.id,et,Lt[Wt],Ke.tags));continue}et!=="LineString"&&et!=="MultiLineString"||(Lt.length===1?(et="LineString",Lt=Lt[0]):et="MultiLineString"),et!=="Point"&&et!=="MultiPoint"||(et=Lt.length===3?"Point":"MultiPoint"),Pe.push(Ht(Ke.id,et,Lt,Ke.tags))}}}return Pe.length?Pe:null}function ui(Q,G,W,ce,me){for(var ke=0;ke<Q.length;ke+=3){var Re=Q[ke+me];Re>=W&&Re<=ce&&(G.push(Q[ke]),G.push(Q[ke+1]),G.push(Q[ke+2]))}}function yi(Q,G,W,ce,me,ke,Re){for(var ze,Pe,je=Ei(Q),Ke=me===0?zi:Fi,ut=Q.start,et=0;et<Q.length-3;et+=3){var Rt=Q[et],wt=Q[et+1],Lt=Q[et+2],Wt=Q[et+3],$e=Q[et+4],Ti=me===0?Rt:wt,St=me===0?Wt:$e,Ai=!1;Re&&(ze=Math.sqrt(Math.pow(Rt-Wt,2)+Math.pow(wt-$e,2))),Ti<W?St>W&&(Pe=Ke(je,Rt,wt,Wt,$e,W),Re&&(je.start=ut+ze*Pe)):Ti>ce?St<ce&&(Pe=Ke(je,Rt,wt,Wt,$e,ce),Re&&(je.start=ut+ze*Pe)):di(je,Rt,wt,Lt),St<W&&Ti>=W&&(Pe=Ke(je,Rt,wt,Wt,$e,W),Ai=!0),St>ce&&Ti<=ce&&(Pe=Ke(je,Rt,wt,Wt,$e,ce),Ai=!0),!ke&&Ai&&(Re&&(je.end=ut+ze*Pe),G.push(je),je=Ei(Q)),Re&&(ut+=ze)}var ki=Q.length-3;Rt=Q[ki],wt=Q[ki+1],Lt=Q[ki+2],(Ti=me===0?Rt:wt)>=W&&Ti<=ce&&di(je,Rt,wt,Lt),ki=je.length-3,ke&&ki>=3&&(je[ki]!==je[0]||je[ki+1]!==je[1])&&di(je,je[0],je[1],je[2]),je.length&&G.push(je)}function Ei(Q){var G=[];return G.size=Q.size,G.start=Q.start,G.end=Q.end,G}function Jt(Q,G,W,ce,me,ke){for(var Re=0;Re<Q.length;Re++)yi(Q[Re],G,W,ce,me,ke,!1)}function di(Q,G,W,ce){Q.push(G),Q.push(W),Q.push(ce)}function zi(Q,G,W,ce,me,ke){var Re=(ke-G)/(ce-G);return Q.push(ke),Q.push(W+(me-W)*Re),Q.push(1),Re}function Fi(Q,G,W,ce,me,ke){var Re=(ke-W)/(me-W);return Q.push(G+(ce-G)*Re),Q.push(ke),Q.push(1),Re}function Oi(Q,G){for(var W=[],ce=0;ce<Q.length;ce++){var me,ke=Q[ce],Re=ke.type;if(Re==="Point"||Re==="MultiPoint"||Re==="LineString")me=ir(ke.geometry,G);else if(Re==="MultiLineString"||Re==="Polygon"){me=[];for(var ze=0;ze<ke.geometry.length;ze++)me.push(ir(ke.geometry[ze],G))}else if(Re==="MultiPolygon")for(me=[],ze=0;ze<ke.geometry.length;ze++){for(var Pe=[],je=0;je<ke.geometry[ze].length;je++)Pe.push(ir(ke.geometry[ze][je],G));me.push(Pe)}W.push(Ht(ke.id,Re,me,ke.tags))}return W}function ir(Q,G){var W=[];W.size=Q.size,Q.start!==void 0&&(W.start=Q.start,W.end=Q.end);for(var ce=0;ce<Q.length;ce+=3)W.push(Q[ce]+G,Q[ce+1],Q[ce+2]);return W}function Rr(Q,G){if(Q.transformed)return Q;var W,ce,me,ke=1<<Q.z,Re=Q.x,ze=Q.y;for(W=0;W<Q.features.length;W++){var Pe=Q.features[W],je=Pe.geometry,Ke=Pe.type;if(Pe.geometry=[],Ke===1)for(ce=0;ce<je.length;ce+=2)Pe.geometry.push(Lr(je[ce],je[ce+1],G,ke,Re,ze));else for(ce=0;ce<je.length;ce++){var ut=[];for(me=0;me<je[ce].length;me+=2)ut.push(Lr(je[ce][me],je[ce][me+1],G,ke,Re,ze));Pe.geometry.push(ut)}}return Q.transformed=!0,Q}function Lr(Q,G,W,ce,me,ke){return[Math.round(W*(Q*ce-me)),Math.round(W*(G*ce-ke))]}function Tr(Q,G,W,ce,me){for(var ke=G===me.maxZoom?0:me.tolerance/((1<<G)*me.extent),Re={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:W,y:ce,z:G,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},ze=0;ze<Q.length;ze++){Re.numFeatures++,tr(Re,Q[ze],ke,me);var Pe=Q[ze].minX,je=Q[ze].minY,Ke=Q[ze].maxX,ut=Q[ze].maxY;Pe<Re.minX&&(Re.minX=Pe),je<Re.minY&&(Re.minY=je),Ke>Re.maxX&&(Re.maxX=Ke),ut>Re.maxY&&(Re.maxY=ut)}return Re}function tr(Q,G,W,ce){var me=G.geometry,ke=G.type,Re=[];if(ke==="Point"||ke==="MultiPoint")for(var ze=0;ze<me.length;ze+=3)Re.push(me[ze]),Re.push(me[ze+1]),Q.numPoints++,Q.numSimplified++;else if(ke==="LineString")dr(Re,me,Q,W,!1,!1);else if(ke==="MultiLineString"||ke==="Polygon")for(ze=0;ze<me.length;ze++)dr(Re,me[ze],Q,W,ke==="Polygon",ze===0);else if(ke==="MultiPolygon")for(var Pe=0;Pe<me.length;Pe++){var je=me[Pe];for(ze=0;ze<je.length;ze++)dr(Re,je[ze],Q,W,!0,ze===0)}if(Re.length){var Ke=G.tags||null;if(ke==="LineString"&&ce.lineMetrics){for(var ut in Ke={},G.tags)Ke[ut]=G.tags[ut];Ke.mapbox_clip_start=me.start/me.size,Ke.mapbox_clip_end=me.end/me.size}var et={geometry:Re,type:ke==="Polygon"||ke==="MultiPolygon"?3:ke==="LineString"||ke==="MultiLineString"?2:1,tags:Ke};G.id!==null&&(et.id=G.id),Q.features.push(et)}}function dr(Q,G,W,ce,me,ke){var Re=ce*ce;if(ce>0&&G.size<(me?Re:ce))W.numPoints+=G.length/3;else{for(var ze=[],Pe=0;Pe<G.length;Pe+=3)(ce===0||G[Pe+2]>Re)&&(W.numSimplified++,ze.push(G[Pe]),ze.push(G[Pe+1])),W.numPoints++;me&&function(je,Ke){for(var ut=0,et=0,Rt=je.length,wt=Rt-2;et<Rt;wt=et,et+=2)ut+=(je[et]-je[wt])*(je[et+1]+je[wt+1]);if(ut>0===Ke)for(et=0,Rt=je.length;et<Rt/2;et+=2){var Lt=je[et],Wt=je[et+1];je[et]=je[Rt-2-et],je[et+1]=je[Rt-1-et],je[Rt-2-et]=Lt,je[Rt-1-et]=Wt}}(ze,ke),Q.push(ze)}}function gr(Q,G){var W=(G=this.options=function(me,ke){for(var Re in ke)me[Re]=ke[Re];return me}(Object.create(this.options),G)).debug;if(W&&console.time("preprocess data"),G.maxZoom<0||G.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(G.promoteId&&G.generateId)throw new Error("promoteId and generateId cannot be used together.");var ce=function(me,ke){var Re=[];if(me.type==="FeatureCollection")for(var ze=0;ze<me.features.length;ze++)oi(Re,me.features[ze],ke,ze);else oi(Re,me.type==="Feature"?me:{geometry:me},ke);return Re}(Q,G);this.tiles={},this.tileCoords=[],W&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",G.indexMaxZoom,G.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(ce=function(me,ke){var Re=ke.buffer/ke.extent,ze=me,Pe=yt(me,1,-1-Re,Re,0,-1,2,ke),je=yt(me,1,1-Re,2+Re,0,-1,2,ke);return(Pe||je)&&(ze=yt(me,1,-Re,1+Re,0,-1,2,ke)||[],Pe&&(ze=Oi(Pe,1).concat(ze)),je&&(ze=ze.concat(Oi(je,-1)))),ze}(ce,G)).length&&this.splitTile(ce,0,0,0),W&&(ce.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function xr(Q,G,W){return 32*((1<<Q)*W+G)+Q}function Ar(Q,G){const W=Q.tileID.canonical;if(!this._geoJSONIndex)return G(null,null);const ce=this._geoJSONIndex.getTile(W.z,W.x,W.y);if(!ce)return G(null,null);const me=new Y(ce.features);let ke=_e(me);ke.byteOffset===0&&ke.byteLength===ke.buffer.byteLength||(ke=new Uint8Array(ke)),G(null,{vectorTile:me,rawData:ke.buffer})}gr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},gr.prototype.splitTile=function(Q,G,W,ce,me,ke,Re){for(var ze=[Q,G,W,ce],Pe=this.options,je=Pe.debug;ze.length;){ce=ze.pop(),W=ze.pop(),G=ze.pop(),Q=ze.pop();var Ke=1<<G,ut=xr(G,W,ce),et=this.tiles[ut];if(!et&&(je>1&&console.time("creation"),et=this.tiles[ut]=Tr(Q,G,W,ce,Pe),this.tileCoords.push({z:G,x:W,y:ce}),je)){je>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",G,W,ce,et.numFeatures,et.numPoints,et.numSimplified),console.timeEnd("creation"));var Rt="z"+G;this.stats[Rt]=(this.stats[Rt]||0)+1,this.total++}if(et.source=Q,me){if(G===Pe.maxZoom||G===me)continue;var wt=1<<me-G;if(W!==Math.floor(ke/wt)||ce!==Math.floor(Re/wt))continue}else if(G===Pe.indexMaxZoom||et.numPoints<=Pe.indexMaxPoints)continue;if(et.source=null,Q.length!==0){je>1&&console.time("clipping");var Lt,Wt,$e,Ti,St,Ai,ki=.5*Pe.buffer/Pe.extent,Xr=.5-ki,yn=.5+ki,xt=1+ki;Lt=Wt=$e=Ti=null,St=yt(Q,Ke,W-ki,W+yn,0,et.minX,et.maxX,Pe),Ai=yt(Q,Ke,W+Xr,W+xt,0,et.minX,et.maxX,Pe),Q=null,St&&(Lt=yt(St,Ke,ce-ki,ce+yn,1,et.minY,et.maxY,Pe),Wt=yt(St,Ke,ce+Xr,ce+xt,1,et.minY,et.maxY,Pe),St=null),Ai&&($e=yt(Ai,Ke,ce-ki,ce+yn,1,et.minY,et.maxY,Pe),Ti=yt(Ai,Ke,ce+Xr,ce+xt,1,et.minY,et.maxY,Pe),Ai=null),je>1&&console.timeEnd("clipping"),ze.push(Lt||[],G+1,2*W,2*ce),ze.push(Wt||[],G+1,2*W,2*ce+1),ze.push($e||[],G+1,2*W+1,2*ce),ze.push(Ti||[],G+1,2*W+1,2*ce+1)}}},gr.prototype.getTile=function(Q,G,W){var ce=this.options,me=ce.extent,ke=ce.debug;if(Q<0||Q>24)return null;var Re=1<<Q,ze=xr(Q,G=(G%Re+Re)%Re,W);if(this.tiles[ze])return Rr(this.tiles[ze],me);ke>1&&console.log("drilling down to z%d-%d-%d",Q,G,W);for(var Pe,je=Q,Ke=G,ut=W;!Pe&&je>0;)je--,Ke=Math.floor(Ke/2),ut=Math.floor(ut/2),Pe=this.tiles[xr(je,Ke,ut)];return Pe&&Pe.source?(ke>1&&console.log("found parent tile z%d-%d-%d",je,Ke,ut),ke>1&&console.time("drilling down"),this.splitTile(Pe.source,je,Ke,ut,Q,G,W),ke>1&&console.timeEnd("drilling down"),this.tiles[ze]?Rr(this.tiles[ze],me):null):null};class zr extends u.VectorTileWorkerSource{constructor(G,W,ce,me,ke){super(G,W,ce,me,Ar),ke&&(this.loadGeoJSON=ke)}loadData(G,W){const ce=G&&G.request,me=ce&&ce.collectResourceTiming;this.loadGeoJSON(G,(ke,Re)=>{if(ke||!Re)return W(ke);if(typeof Re!="object")return W(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`));{$(Re,!0);try{if(G.filter){const Pe=u.createExpression(G.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Pe.result==="error")throw new Error(Pe.value.map(Ke=>`${Ke.key}: ${Ke.message}`).join(", "));const je=Re.features.filter(Ke=>Pe.value.evaluate({zoom:0},Ke));Re={type:"FeatureCollection",features:je}}this._geoJSONIndex=G.cluster?new Zt(function({superclusterOptions:Pe,clusterProperties:je}){if(!je||!Pe)return Pe;const Ke={},ut={},et={accumulated:null,zoom:0},Rt={properties:null},wt=Object.keys(je);for(const Lt of wt){const[Wt,$e]=je[Lt],Ti=u.createExpression($e),St=u.createExpression(typeof Wt=="string"?[Wt,["accumulated"],["get",Lt]]:Wt);Ke[Lt]=Ti.value,ut[Lt]=St.value}return Pe.map=Lt=>{Rt.properties=Lt;const Wt={};for(const $e of wt)Wt[$e]=Ke[$e].evaluate(et,Rt);return Wt},Pe.reduce=(Lt,Wt)=>{Rt.properties=Wt;for(const $e of wt)et.accumulated=Lt[$e],Lt[$e]=ut[$e].evaluate(et,Rt)},Pe}(G)).load(Re.features):function(Pe,je){return new gr(Pe,je)}(Re,G.geojsonVtOptions)}catch(Pe){return W(Pe)}this.loaded={};const ze={};if(me){const Pe=u.getPerformanceMeasurement(ce);Pe&&(ze.resourceTiming={},ze.resourceTiming[G.source]=JSON.parse(JSON.stringify(Pe)))}W(null,ze)}})}reloadTile(G,W){const ce=this.loaded;return ce&&ce[G.uid]?super.reloadTile(G,W):this.loadTile(G,W)}loadGeoJSON(G,W){if(G.request)u.getJSON(G.request,W);else{if(typeof G.data!="string")return W(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`));try{return W(null,JSON.parse(G.data))}catch{return W(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(G,W){try{W(null,this._geoJSONIndex.getClusterExpansionZoom(G.clusterId))}catch(ce){W(ce)}}getClusterChildren(G,W){try{W(null,this._geoJSONIndex.getChildren(G.clusterId))}catch(ce){W(ce)}}getClusterLeaves(G,W){try{W(null,this._geoJSONIndex.getLeaves(G.clusterId,G.limit,G.offset))}catch(ce){W(ce)}}}class ye{constructor(G){this.self=G,this.actor=new u.Actor(G,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=u.getProjection({name:"mercator"}),this.workerSourceTypes={vector:u.VectorTileWorkerSource,geojson:zr},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(W,ce)=>{if(this.workerSourceTypes[W])throw new Error(`Worker source with name "${W}" already registered.`);this.workerSourceTypes[W]=ce},this.self.registerRTLTextPlugin=W=>{if(u.plugin.isParsed())throw new Error("RTL text plugin already registered.");u.plugin.applyArabicShaping=W.applyArabicShaping,u.plugin.processBidirectionalText=W.processBidirectionalText,u.plugin.processStyledBidirectionalText=W.processStyledBidirectionalText}}clearCaches(G,W,ce){delete this.layerIndexes[G],delete this.availableImages[G],delete this.workerSources[G],delete this.demWorkerSources[G],ce()}checkIfReady(G,W,ce){ce()}setReferrer(G,W){this.referrer=W}spriteLoaded(G,W){this.isSpriteLoaded[G]=W;for(const ce in this.workerSources[G]){const me=this.workerSources[G][ce];for(const ke in me)me[ke]instanceof u.VectorTileWorkerSource&&(me[ke].isSpriteLoaded=W,me[ke].fire(new u.Event("isSpriteLoaded")))}}setImages(G,W,ce){this.availableImages[G]=W;for(const me in this.workerSources[G]){const ke=this.workerSources[G][me];for(const Re in ke)ke[Re].availableImages=W}ce()}enableTerrain(G,W,ce){this.terrain=W,ce()}setProjection(G,W){this.projections[G]=u.getProjection(W)}setLayers(G,W,ce){this.getLayerIndex(G).replace(W),ce()}updateLayers(G,W,ce){this.getLayerIndex(G).update(W.layers,W.removedIds),ce()}loadTile(G,W,ce){const me=this.enableTerrain?u.extend({enableTerrain:this.terrain},W):W;me.projection=this.projections[G]||this.defaultProjection,this.getWorkerSource(G,W.type,W.source).loadTile(me,ce)}loadDEMTile(G,W,ce){const me=this.enableTerrain?u.extend({buildQuadTree:this.terrain},W):W;this.getDEMWorkerSource(G,W.source).loadTile(me,ce)}reloadTile(G,W,ce){const me=this.enableTerrain?u.extend({enableTerrain:this.terrain},W):W;me.projection=this.projections[G]||this.defaultProjection,this.getWorkerSource(G,W.type,W.source).reloadTile(me,ce)}abortTile(G,W,ce){this.getWorkerSource(G,W.type,W.source).abortTile(W,ce)}removeTile(G,W,ce){this.getWorkerSource(G,W.type,W.source).removeTile(W,ce)}removeSource(G,W,ce){if(!this.workerSources[G]||!this.workerSources[G][W.type]||!this.workerSources[G][W.type][W.source])return;const me=this.workerSources[G][W.type][W.source];delete this.workerSources[G][W.type][W.source],me.removeSource!==void 0?me.removeSource(W,ce):ce()}loadWorkerSource(G,W,ce){try{this.self.importScripts(W.url),ce()}catch(me){ce(me.toString())}}syncRTLPluginState(G,W,ce){try{u.plugin.setState(W);const me=u.plugin.getPluginURL();if(u.plugin.isLoaded()&&!u.plugin.isParsed()&&me!=null){this.self.importScripts(me);const ke=u.plugin.isParsed();ce(ke?void 0:new Error(`RTL Text Plugin failed to import scripts from ${me}`),ke)}}catch(me){ce(me.toString())}}getAvailableImages(G){let W=this.availableImages[G];return W||(W=[]),W}getLayerIndex(G){let W=this.layerIndexes[G];return W||(W=this.layerIndexes[G]=new D),W}getWorkerSource(G,W,ce){return this.workerSources[G]||(this.workerSources[G]={}),this.workerSources[G][W]||(this.workerSources[G][W]={}),this.workerSources[G][W][ce]||(this.workerSources[G][W][ce]=new this.workerSourceTypes[W]({send:(me,ke,Re,ze,Pe,je)=>{this.actor.send(me,ke,Re,G,Pe,je)},scheduler:this.actor.scheduler},this.getLayerIndex(G),this.getAvailableImages(G),this.isSpriteLoaded[G])),this.workerSources[G][W][ce]}getDEMWorkerSource(G,W){return this.demWorkerSources[G]||(this.demWorkerSources[G]={}),this.demWorkerSources[G][W]||(this.demWorkerSources[G][W]=new z),this.demWorkerSources[G][W]}enforceCacheSizeLimit(G,W){u.enforceCacheSizeLimit(W)}getWorkerPerformanceMetrics(G,W,ce){ce(void 0,void 0)}}return typeof WorkerGlobalScope!="undefined"&&typeof self!="undefined"&&self instanceof WorkerGlobalScope&&(self.worker=new ye(self)),ye}),g(["./shared"],function(u){var A=S;function S(x){return!function(h){return typeof window=="undefined"||typeof document=="undefined"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var T,C,k=new Blob([""],{type:"text/javascript"}),B=URL.createObjectURL(k);try{C=new Worker(B),T=!0}catch{T=!1}return C&&C.terminate(),URL.revokeObjectURL(B),T}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var T=document.createElement("canvas");T.width=T.height=1;var C=T.getContext("2d");if(!C)return!1;var k=C.getImageData(0,0,1,1);return k&&k.width===T.width}()?(D[_=h&&h.failIfMajorPerformanceCaveat]===void 0&&(D[_]=function(T){var C,k=function(B){var F=document.createElement("canvas"),V=Object.create(S.webGLContextAttributes);return V.failIfMajorPerformanceCaveat=B,F.getContext("webgl",V)||F.getContext("experimental-webgl",V)}(T);if(!k)return!1;try{C=k.createShader(k.VERTEX_SHADER)}catch{return!1}return!(!C||k.isContextLost())&&(k.shaderSource(C,"void main() {}"),k.compileShader(C),k.getShaderParameter(C,k.COMPILE_STATUS)===!0)}(_)),D[_]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var _}(x)}var D={};function z(x,h){if(Array.isArray(x)){if(!Array.isArray(h)||x.length!==h.length)return!1;for(let _=0;_<x.length;_++)if(!z(x[_],h[_]))return!1;return!0}if(typeof x=="object"&&x!==null&&h!==null){if(typeof h!="object"||Object.keys(x).length!==Object.keys(h).length)return!1;for(const _ in x)if(!z(x[_],h[_]))return!1;return!0}return x===h}function $(x,h,_){const T=u.window.document.createElement(x);return h!==void 0&&(T.className=h),_&&_.appendChild(T),T}function O(x,h,_){const T=u.window.document.createElementNS("http://www.w3.org/2000/svg",x);for(const C of Object.keys(h))T.setAttributeNS(null,C,h[C]);return _&&_.appendChild(T),T}S.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const q=u.window.document&&u.window.document.documentElement.style,K=q&&q.userSelect!==void 0?"userSelect":"WebkitUserSelect";let J;function Y(){q&&K&&(J=q[K],q[K]="none")}function fe(){q&&K&&(q[K]=J)}function ee(x){x.preventDefault(),x.stopPropagation(),u.window.removeEventListener("click",ee,!0)}function re(){u.window.addEventListener("click",ee,!0),u.window.setTimeout(()=>{u.window.removeEventListener("click",ee,!0)},0)}function he(x,h){const _=x.getBoundingClientRect();return oe(x,_,h)}function _e(x,h){const _=x.getBoundingClientRect(),T=[];for(let C=0;C<h.length;C++)T.push(oe(x,_,h[C]));return T}function we(x){return u.window.InstallTrigger!==void 0&&x.button===2&&x.ctrlKey&&u.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:x.button}function oe(x,h,_){const T=x.offsetWidth===h.width?1:x.offsetWidth/h.width;return new u.pointGeometry((_.clientX-h.left)*T,(_.clientY-h.top)*T)}function be(x,h){var _=h[0],T=h[1],C=h[2],k=h[3],B=_*k-C*T;return B?(x[0]=k*(B=1/B),x[1]=-T*B,x[2]=-C*B,x[3]=_*B,x):null}function ie(x){const{userImage:h}=x;return!!(h&&h.render&&h.render())&&(x.data.replace(new Uint8Array(h.data.buffer)),!0)}class ue extends u.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new u.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(h){if(this.loaded!==h&&(this.loaded=h,h)){for(const{ids:_,callback:T}of this.requestors)this._notify(_,T);this.requestors=[]}}hasImage(h){return!!this.getImage(h)}getImage(h){return this.images[h]}addImage(h,_){this._validate(h,_)&&(this.images[h]=_)}_validate(h,_){let T=!0;return this._validateStretch(_.stretchX,_.data&&_.data.width)||(this.fire(new u.ErrorEvent(new Error(`Image "${h}" has invalid "stretchX" value`))),T=!1),this._validateStretch(_.stretchY,_.data&&_.data.height)||(this.fire(new u.ErrorEvent(new Error(`Image "${h}" has invalid "stretchY" value`))),T=!1),this._validateContent(_.content,_)||(this.fire(new u.ErrorEvent(new Error(`Image "${h}" has invalid "content" value`))),T=!1),T}_validateStretch(h,_){if(!h)return!0;let T=0;for(const C of h){if(C[0]<T||C[1]<C[0]||_<C[1])return!1;T=C[1]}return!0}_validateContent(h,_){return!(h&&(h.length!==4||h[0]<0||_.data.width<h[0]||h[1]<0||_.data.height<h[1]||h[2]<0||_.data.width<h[2]||h[3]<0||_.data.height<h[3]||h[2]<h[0]||h[3]<h[1]))}updateImage(h,_){_.version=this.images[h].version+1,this.images[h]=_,this.updatedImages[h]=!0}removeImage(h){const _=this.images[h];delete this.images[h],delete this.patterns[h],_.userImage&&_.userImage.onRemove&&_.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(h,_){let T=!0;if(!this.isLoaded())for(const C of h)this.images[C]||(T=!1);this.isLoaded()||T?this._notify(h,_):this.requestors.push({ids:h,callback:_})}_notify(h,_){const T={};for(const C of h){this.images[C]||this.fire(new u.Event("styleimagemissing",{id:C}));const k=this.images[C];k?T[C]={data:k.data.clone(),pixelRatio:k.pixelRatio,sdf:k.sdf,version:k.version,stretchX:k.stretchX,stretchY:k.stretchY,content:k.content,hasRenderCallback:Boolean(k.userImage&&k.userImage.render)}:u.warnOnce(`Image "${C}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}_(null,T)}getPixelSize(){const{width:h,height:_}=this.atlasImage;return{width:h,height:_}}getPattern(h){const _=this.patterns[h],T=this.getImage(h);if(!T)return null;if(_&&_.position.version===T.version)return _.position;if(_)_.position.version=T.version;else{const C={w:T.data.width+2,h:T.data.height+2,x:0,y:0},k=new u.ImagePosition(C,T);this.patterns[h]={bin:C,position:k}}return this._updatePatternAtlas(),this.patterns[h].position}bind(h){const _=h.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new u.Texture(h,this.atlasImage,_.RGBA),this.atlasTexture.bind(_.LINEAR,_.CLAMP_TO_EDGE)}_updatePatternAtlas(){const h=[];for(const k in this.patterns)h.push(this.patterns[k].bin);const{w:_,h:T}=u.potpack(h),C=this.atlasImage;C.resize({width:_||1,height:T||1});for(const k in this.patterns){const{bin:B}=this.patterns[k],F=B.x+1,V=B.y+1,Z=this.images[k].data,X=Z.width,te=Z.height;u.RGBAImage.copy(Z,C,{x:0,y:0},{x:F,y:V},{width:X,height:te}),u.RGBAImage.copy(Z,C,{x:0,y:te-1},{x:F,y:V-1},{width:X,height:1}),u.RGBAImage.copy(Z,C,{x:0,y:0},{x:F,y:V+te},{width:X,height:1}),u.RGBAImage.copy(Z,C,{x:X-1,y:0},{x:F-1,y:V},{width:1,height:te}),u.RGBAImage.copy(Z,C,{x:0,y:0},{x:F+X,y:V},{width:1,height:te})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(h){for(const _ of h){if(this.callbackDispatchedThisFrame[_])continue;this.callbackDispatchedThisFrame[_]=!0;const T=this.images[_];ie(T)&&this.updateImage(_,T)}}}const Ce=new u.Properties({anchor:new u.DataConstantProperty(u.spec.light.anchor),position:new class{constructor(){this.specification=u.spec.light.position}possiblyEvaluate(x,h){return function([_,T,C]){const k=u.degToRad(T+90),B=u.degToRad(C);return{x:_*Math.cos(k)*Math.sin(B),y:_*Math.sin(k)*Math.sin(B),z:_*Math.cos(B),azimuthal:T,polar:C}}(x.expression.evaluate(h))}interpolate(x,h,_){return{x:u.number(x.x,h.x,_),y:u.number(x.y,h.y,_),z:u.number(x.z,h.z,_),azimuthal:u.number(x.azimuthal,h.azimuthal,_),polar:u.number(x.polar,h.polar,_)}}},color:new u.DataConstantProperty(u.spec.light.color),intensity:new u.DataConstantProperty(u.spec.light.intensity)}),Ne="-transition";class it extends u.Evented{constructor(h){super(),this._transitionable=new u.Transitionable(Ce),this.setLight(h),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(h,_={}){if(!this._validate(u.validateLight,h,_))for(const T in h){const C=h[T];u.endsWith(T,Ne)?this._transitionable.setTransition(T.slice(0,-Ne.length),C):this._transitionable.setValue(T,C)}}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}_validate(h,_,T){return(!T||T.validate!==!1)&&u.emitValidationErrors(this,h.call(u.validateStyle,u.extend({value:_,style:{glyphs:!0,sprite:!0},styleSpec:u.spec})))}}const rt=new u.Properties({source:new u.DataConstantProperty(u.spec.terrain.source),exaggeration:new u.DataConstantProperty(u.spec.terrain.exaggeration)}),Pt="-transition";class zt extends u.Evented{constructor(h,_){super(),this._transitionable=new u.Transitionable(rt),this.set(h),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=_}get(){return this._transitionable.serialize()}set(h){for(const _ in h){const T=h[_];u.endsWith(_,Pt)?this._transitionable.setTransition(_.slice(0,-Pt.length),T):this._transitionable.setValue(_,T)}}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}}function vt(x,h,_,T){const C=u.smoothstep(45,65,_),[k,B]=Vt(x,T),F=u.length(h);let V=1-Math.min(1,Math.exp((F-k)/(B-k)*-6));return V*=V*V,V=Math.min(1,1.00747*V),V*C*x.alpha}function Vt(x,h){const _=.5/Math.tan(.5*h);return[x.range[0]+_,x.range[1]+_]}const kt=new u.Properties({range:new u.DataConstantProperty(u.spec.fog.range),color:new u.DataConstantProperty(u.spec.fog.color),"horizon-blend":new u.DataConstantProperty(u.spec.fog["horizon-blend"])}),Yt="-transition";class Qt extends u.Evented{constructor(h,_){super(),this._transitionable=new u.Transitionable(kt),this.set(h),this._transitioning=this._transitionable.untransitioned(),this._transform=_}get state(){return{range:this.properties.get("range"),horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(h,_={}){if(!this._validate(u.validateFog,h,_))for(const T in h){const C=h[T];u.endsWith(T,Yt)?this._transitionable.setTransition(T.slice(0,-Yt.length),C):this._transitionable.setValue(T,C)}}getOpacity(h){if(!this._transform.projection.supportsFog)return 0;const _=this.properties&&this.properties.get("color")||1;return u.smoothstep(45,65,h)*_.a}getOpacityAtLatLng(h,_){return this._transform.projection.supportsFog?function(T,C,k){const B=u.MercatorCoordinate.fromLngLat(C),F=k.elevation?k.elevation.getAtPointOrZero(B):0,V=[B.x,B.y,F];return u.transformMat4(V,V,k.mercatorFogMatrix),vt(T,V,k.pitch,k._fov)}(this.state,h,_):0}getFovAdjustedRange(h){return this._transform.projection.supportsFog?Vt(this.state,h):[0,1]}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}_validate(h,_,T){return(!T||T.validate!==!1)&&u.emitValidationErrors(this,h.call(u.validateStyle,u.extend({value:_,style:{glyphs:!0,sprite:!0},styleSpec:u.spec})))}}class ot{constructor(h,_){this.workerPool=h,this.actors=[],this.currentActor=0,this.id=u.uniqueId();const T=this.workerPool.acquire(this.id);for(let C=0;C<T.length;C++){const k=new ot.Actor(T[C],_,this.id);k.name=`Worker ${C}`,this.actors.push(k)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(h,_,T){u.asyncAll(this.actors,(C,k)=>{C.send(h,_,k)},T=T||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(h=>{h.remove()}),this.actors=[],this.workerPool.release(this.id)}}function gt(x,h,_){return h*(u.EXTENT/(x.tileSize*Math.pow(2,_-x.tileID.overscaledZ)))}ot.Actor=u.Actor;class pt{constructor(h,_,T,C){this.screenBounds=h,this.cameraPoint=_,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=T,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this.screenGeometry.map(k=>C.pointCoordinate3D(k)),this.cameraGeometry=this.bufferedCameraGeometry(0)}static createFromScreenPoints(h,_){let T,C;if(h instanceof u.pointGeometry||typeof h[0]=="number"){const k=u.pointGeometry.convert(h);T=[u.pointGeometry.convert(h)],C=_.isPointAboveHorizon(k)}else{const k=u.pointGeometry.convert(h[0]),B=u.pointGeometry.convert(h[1]);T=[k,B],C=u.polygonizeBounds(k,B).every(F=>_.isPointAboveHorizon(F))}return new pt(T,_.getCameraPoint(),C,_)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(h){return u.polygonizeBounds(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],h)}bufferedCameraGeometry(h){const _=this.screenBounds[0],T=this.screenBounds.length===1?this.screenBounds[0].add(new u.pointGeometry(1,1)):this.screenBounds[1],C=u.polygonizeBounds(_,T,0,!1);return this.cameraPoint.y>T.y&&(this.cameraPoint.x>_.x&&this.cameraPoint.x<T.x?C.splice(3,0,this.cameraPoint):this.cameraPoint.x>=T.x?C[2]=this.cameraPoint:this.cameraPoint.x<=_.x&&(C[3]=this.cameraPoint)),u.bufferConvexPolygon(C,h)}containsTile(h,_,T){const C=h.queryPadding+1,k=h.tileID.wrap,B=T?this._bufferedCameraMercator(C,_).map(de=>u.getTilePoint(h.tileTransform,de,k)):this._bufferedScreenMercator(C,_).map(de=>u.getTilePoint(h.tileTransform,de,k)),F=this.screenGeometryMercator.map(de=>u.getTileVec3(h.tileTransform,de,k)),V=F.map(de=>new u.pointGeometry(de[0],de[1])),Z=_.getFreeCameraOptions().position||new u.MercatorCoordinate(0,0,0),X=u.getTileVec3(h.tileTransform,Z,k),te=F.map(de=>{const se=u.sub(de,de,X);return u.normalize(se,se),new u.Ray(X,se)}),le=gt(h,1,_.zoom);if(u.polygonIntersectsBox(B,0,0,u.EXTENT,u.EXTENT))return{queryGeometry:this,tilespaceGeometry:V,tilespaceRays:te,bufferedTilespaceGeometry:B,bufferedTilespaceBounds:(ge=u.getBounds(B),ge.min.x=u.clamp(ge.min.x,0,u.EXTENT),ge.min.y=u.clamp(ge.min.y,0,u.EXTENT),ge.max.x=u.clamp(ge.max.x,0,u.EXTENT),ge.max.y=u.clamp(ge.max.y,0,u.EXTENT),ge),tile:h,tileID:h.tileID,pixelToTileUnitsFactor:le};var ge}_bufferedScreenMercator(h,_){const T=Bt(h);if(this._screenRaycastCache[T])return this._screenRaycastCache[T];{const C=this.bufferedScreenGeometry(h).map(k=>_.pointCoordinate3D(k));return this._screenRaycastCache[T]=C,C}}_bufferedCameraMercator(h,_){const T=Bt(h);if(this._cameraRaycastCache[T])return this._cameraRaycastCache[T];{const C=this.bufferedCameraGeometry(h).map(k=>_.pointCoordinate3D(k));return this._cameraRaycastCache[T]=C,C}}}function Bt(x){return 100*x|0}function Zt(x,h,_){const T=function(C,k){if(C)return _(C);if(k){const B=u.pick(u.extend(k,x),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);k.vector_layers&&(B.vectorLayers=k.vector_layers,B.vectorLayerIds=B.vectorLayers.map(F=>F.id)),B.tiles=h.canonicalizeTileset(B,x.url),_(null,B)}};return x.url?u.getJSON(h.transformRequest(h.normalizeSourceURL(x.url),u.ResourceType.Source),T):u.exported.frame(()=>T(null,x))}class si{constructor(h,_,T){this.bounds=u.LngLatBounds.convert(this.validateBounds(h)),this.minzoom=_||0,this.maxzoom=T||24}validateBounds(h){return Array.isArray(h)&&h.length===4?[Math.max(-180,h[0]),Math.max(-90,h[1]),Math.min(180,h[2]),Math.min(90,h[3])]:[-180,-90,180,90]}contains(h){const _=Math.pow(2,h.z),T=Math.floor(u.mercatorXfromLng(this.bounds.getWest())*_),C=Math.floor(u.mercatorYfromLat(this.bounds.getNorth())*_),k=Math.ceil(u.mercatorXfromLng(this.bounds.getEast())*_),B=Math.ceil(u.mercatorYfromLat(this.bounds.getSouth())*_);return h.x>=T&&h.x<k&&h.y>=C&&h.y<B}}class ii{constructor(h,_,T){this.context=h;const C=h.gl;this.buffer=C.createBuffer(),this.dynamicDraw=Boolean(T),this.context.unbindVAO(),h.bindElementBuffer.set(this.buffer),C.bufferData(C.ELEMENT_ARRAY_BUFFER,_.arrayBuffer,this.dynamicDraw?C.DYNAMIC_DRAW:C.STATIC_DRAW),this.dynamicDraw||_.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(h){const _=this.context.gl;this.context.unbindVAO(),this.bind(),_.bufferSubData(_.ELEMENT_ARRAY_BUFFER,0,h.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const pi={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class ai{constructor(h,_,T,C){this.length=_.length,this.attributes=T,this.itemSize=_.bytesPerElement,this.dynamicDraw=C,this.context=h;const k=h.gl;this.buffer=k.createBuffer(),h.bindVertexBuffer.set(this.buffer),k.bufferData(k.ARRAY_BUFFER,_.arrayBuffer,this.dynamicDraw?k.DYNAMIC_DRAW:k.STATIC_DRAW),this.dynamicDraw||_.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(h){const _=this.context.gl;this.bind(),_.bufferSubData(_.ARRAY_BUFFER,0,h.arrayBuffer)}enableAttributes(h,_){for(let T=0;T<this.attributes.length;T++){const C=_.attributes[this.attributes[T].name];C!==void 0&&h.enableVertexAttribArray(C)}}setVertexAttribPointers(h,_,T){for(let C=0;C<this.attributes.length;C++){const k=this.attributes[C],B=_.attributes[k.name];B!==void 0&&h.vertexAttribPointer(B,k.components,h[pi[k.type]],!1,this.itemSize,k.offset+this.itemSize*(T||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Nt{constructor(h){this.gl=h.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(h){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ci extends Nt{getDefault(){return u.Color.transparent}set(h){const _=this.current;(h.r!==_.r||h.g!==_.g||h.b!==_.b||h.a!==_.a||this.dirty)&&(this.gl.clearColor(h.r,h.g,h.b,h.a),this.current=h,this.dirty=!1)}}class $t extends Nt{getDefault(){return 1}set(h){(h!==this.current||this.dirty)&&(this.gl.clearDepth(h),this.current=h,this.dirty=!1)}}class ft extends Nt{getDefault(){return 0}set(h){(h!==this.current||this.dirty)&&(this.gl.clearStencil(h),this.current=h,this.dirty=!1)}}class _i extends Nt{getDefault(){return[!0,!0,!0,!0]}set(h){const _=this.current;(h[0]!==_[0]||h[1]!==_[1]||h[2]!==_[2]||h[3]!==_[3]||this.dirty)&&(this.gl.colorMask(h[0],h[1],h[2],h[3]),this.current=h,this.dirty=!1)}}class Tt extends Nt{getDefault(){return!0}set(h){(h!==this.current||this.dirty)&&(this.gl.depthMask(h),this.current=h,this.dirty=!1)}}class Ge extends Nt{getDefault(){return 255}set(h){(h!==this.current||this.dirty)&&(this.gl.stencilMask(h),this.current=h,this.dirty=!1)}}class Gt extends Nt{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(h){const _=this.current;(h.func!==_.func||h.ref!==_.ref||h.mask!==_.mask||this.dirty)&&(this.gl.stencilFunc(h.func,h.ref,h.mask),this.current=h,this.dirty=!1)}}class Ht extends Nt{getDefault(){const h=this.gl;return[h.KEEP,h.KEEP,h.KEEP]}set(h){const _=this.current;(h[0]!==_[0]||h[1]!==_[1]||h[2]!==_[2]||this.dirty)&&(this.gl.stencilOp(h[0],h[1],h[2]),this.current=h,this.dirty=!1)}}class ei extends Nt{getDefault(){return!1}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;h?_.enable(_.STENCIL_TEST):_.disable(_.STENCIL_TEST),this.current=h,this.dirty=!1}}class oi extends Nt{getDefault(){return[0,1]}set(h){const _=this.current;(h[0]!==_[0]||h[1]!==_[1]||this.dirty)&&(this.gl.depthRange(h[0],h[1]),this.current=h,this.dirty=!1)}}class _t extends Nt{getDefault(){return!1}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;h?_.enable(_.DEPTH_TEST):_.disable(_.DEPTH_TEST),this.current=h,this.dirty=!1}}class Ci extends Nt{getDefault(){return this.gl.LESS}set(h){(h!==this.current||this.dirty)&&(this.gl.depthFunc(h),this.current=h,this.dirty=!1)}}class hi extends Nt{getDefault(){return!1}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;h?_.enable(_.BLEND):_.disable(_.BLEND),this.current=h,this.dirty=!1}}class Ft extends Nt{getDefault(){const h=this.gl;return[h.ONE,h.ZERO]}set(h){const _=this.current;(h[0]!==_[0]||h[1]!==_[1]||this.dirty)&&(this.gl.blendFunc(h[0],h[1]),this.current=h,this.dirty=!1)}}class Ut extends Nt{getDefault(){return u.Color.transparent}set(h){const _=this.current;(h.r!==_.r||h.g!==_.g||h.b!==_.b||h.a!==_.a||this.dirty)&&(this.gl.blendColor(h.r,h.g,h.b,h.a),this.current=h,this.dirty=!1)}}class yt extends Nt{getDefault(){return this.gl.FUNC_ADD}set(h){(h!==this.current||this.dirty)&&(this.gl.blendEquation(h),this.current=h,this.dirty=!1)}}class ui extends Nt{getDefault(){return!1}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;h?_.enable(_.CULL_FACE):_.disable(_.CULL_FACE),this.current=h,this.dirty=!1}}class yi extends Nt{getDefault(){return this.gl.BACK}set(h){(h!==this.current||this.dirty)&&(this.gl.cullFace(h),this.current=h,this.dirty=!1)}}class Ei extends Nt{getDefault(){return this.gl.CCW}set(h){(h!==this.current||this.dirty)&&(this.gl.frontFace(h),this.current=h,this.dirty=!1)}}class Jt extends Nt{getDefault(){return null}set(h){(h!==this.current||this.dirty)&&(this.gl.useProgram(h),this.current=h,this.dirty=!1)}}class di extends Nt{getDefault(){return this.gl.TEXTURE0}set(h){(h!==this.current||this.dirty)&&(this.gl.activeTexture(h),this.current=h,this.dirty=!1)}}class zi extends Nt{getDefault(){const h=this.gl;return[0,0,h.drawingBufferWidth,h.drawingBufferHeight]}set(h){const _=this.current;(h[0]!==_[0]||h[1]!==_[1]||h[2]!==_[2]||h[3]!==_[3]||this.dirty)&&(this.gl.viewport(h[0],h[1],h[2],h[3]),this.current=h,this.dirty=!1)}}class Fi extends Nt{getDefault(){return null}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;_.bindFramebuffer(_.FRAMEBUFFER,h),this.current=h,this.dirty=!1}}class Oi extends Nt{getDefault(){return null}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;_.bindRenderbuffer(_.RENDERBUFFER,h),this.current=h,this.dirty=!1}}class ir extends Nt{getDefault(){return null}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;_.bindTexture(_.TEXTURE_2D,h),this.current=h,this.dirty=!1}}class Rr extends Nt{getDefault(){return null}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;_.bindBuffer(_.ARRAY_BUFFER,h),this.current=h,this.dirty=!1}}class Lr extends Nt{getDefault(){return null}set(h){const _=this.gl;_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,h),this.current=h,this.dirty=!1}}class Tr extends Nt{constructor(h){super(h),this.vao=h.extVertexArrayObject}getDefault(){return null}set(h){this.vao&&(h!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(h),this.current=h,this.dirty=!1)}}class tr extends Nt{getDefault(){return 4}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;_.pixelStorei(_.UNPACK_ALIGNMENT,h),this.current=h,this.dirty=!1}}class dr extends Nt{getDefault(){return!1}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,h),this.current=h,this.dirty=!1}}class gr extends Nt{getDefault(){return!1}set(h){if(h===this.current&&!this.dirty)return;const _=this.gl;_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,h),this.current=h,this.dirty=!1}}class xr extends Nt{constructor(h,_){super(h),this.context=h,this.parent=_}getDefault(){return null}}class Ar extends xr{setDirty(){this.dirty=!0}set(h){if(h===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const _=this.gl;_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,h,0),this.current=h,this.dirty=!1}}class zr extends xr{attachment(){return this.gl.DEPTH_ATTACHMENT}set(h){if(h===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const _=this.gl;_.framebufferRenderbuffer(_.FRAMEBUFFER,this.attachment(),_.RENDERBUFFER,h),this.current=h,this.dirty=!1}}class ye extends zr{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class Q{constructor(h,_,T,C){this.context=h,this.width=_,this.height=T;const k=this.framebuffer=h.gl.createFramebuffer();this.colorAttachment=new Ar(h,k),C&&(this.depthAttachment=new zr(h,k))}destroy(){const h=this.context.gl,_=this.colorAttachment.get();if(_&&h.deleteTexture(_),this.depthAttachment){const T=this.depthAttachment.get();T&&h.deleteRenderbuffer(T)}h.deleteFramebuffer(this.framebuffer)}}class G{constructor(h){this.gl=h,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new ci(this),this.clearDepth=new $t(this),this.clearStencil=new ft(this),this.colorMask=new _i(this),this.depthMask=new Tt(this),this.stencilMask=new Ge(this),this.stencilFunc=new Gt(this),this.stencilOp=new Ht(this),this.stencilTest=new ei(this),this.depthRange=new oi(this),this.depthTest=new _t(this),this.depthFunc=new Ci(this),this.blend=new hi(this),this.blendFunc=new Ft(this),this.blendColor=new Ut(this),this.blendEquation=new yt(this),this.cullFace=new ui(this),this.cullFaceSide=new yi(this),this.frontFace=new Ei(this),this.program=new Jt(this),this.activeTexture=new di(this),this.viewport=new zi(this),this.bindFramebuffer=new Fi(this),this.bindRenderbuffer=new Oi(this),this.bindTexture=new ir(this),this.bindVertexBuffer=new Rr(this),this.bindElementBuffer=new Lr(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new Tr(this),this.pixelStoreUnpack=new tr(this),this.pixelStoreUnpackPremultiplyAlpha=new dr(this),this.pixelStoreUnpackFlipY=new gr(this),this.extTextureFilterAnisotropic=h.getExtension("EXT_texture_filter_anisotropic")||h.getExtension("MOZ_EXT_texture_filter_anisotropic")||h.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=h.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extTextureHalfFloat=h.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(h.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=h.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=h.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=h.getParameter(h.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(h,_){return new ii(this,h,_)}createVertexBuffer(h,_,T){return new ai(this,h,_,T)}createRenderbuffer(h,_,T){const C=this.gl,k=C.createRenderbuffer();return this.bindRenderbuffer.set(k),C.renderbufferStorage(C.RENDERBUFFER,h,_,T),this.bindRenderbuffer.set(null),k}createFramebuffer(h,_,T){return new Q(this,h,_,T)}clear({color:h,depth:_,stencil:T}){const C=this.gl;let k=0;h&&(k|=C.COLOR_BUFFER_BIT,this.clearColor.set(h),this.colorMask.set([!0,!0,!0,!0])),_!==void 0&&(k|=C.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(_),this.depthMask.set(!0)),T!==void 0&&(k|=C.STENCIL_BUFFER_BIT,this.clearStencil.set(T),this.stencilMask.set(255)),C.clear(k)}setCullFace(h){h.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(h.mode),this.frontFace.set(h.frontFace))}setDepthMode(h){h.func!==this.gl.ALWAYS||h.mask?(this.depthTest.set(!0),this.depthFunc.set(h.func),this.depthMask.set(h.mask),this.depthRange.set(h.range)):this.depthTest.set(!1)}setStencilMode(h){h.test.func!==this.gl.ALWAYS||h.mask?(this.stencilTest.set(!0),this.stencilMask.set(h.mask),this.stencilOp.set([h.fail,h.depthFail,h.pass]),this.stencilFunc.set({func:h.test.func,ref:h.ref,mask:h.test.mask})):this.stencilTest.set(!1)}setColorMode(h){z(h.blendFunction,u.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(h.blendFunction),this.blendColor.set(h.blendColor)),this.colorMask.set(h.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class W extends u.Evented{constructor(h,_,T,C){super(),this.id=h,this.dispatcher=T,this.setEventedParent(C),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=u.extend({type:"raster"},_),u.extend(this,u.pick(_,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new u.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=Zt(this._options,this.map._requestManager,(h,_)=>{this._tileJSONRequest=null,this._loaded=!0,h?this.fire(new u.ErrorEvent(h)):_&&(u.extend(this,_),_.bounds&&(this.tileBounds=new si(_.bounds,this.minzoom,this.maxzoom)),u.postTurnstileEvent(_.tiles),this.fire(new u.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(h){this.map=h,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return u.extend({},this._options)}hasTile(h){return!this.tileBounds||this.tileBounds.contains(h.canonical)}loadTile(h,_){const T=u.exported.devicePixelRatio>=2,C=this.map._requestManager.normalizeTileURL(h.tileID.canonical.url(this.tiles,this.scheme),T,this.tileSize);h.request=u.getImage(this.map._requestManager.transformRequest(C,u.ResourceType.Tile),(k,B,F,V)=>(delete h.request,h.aborted?(h.state="unloaded",_(null)):k?(h.state="errored",_(k)):B?(this.map._refreshExpiredTiles&&h.setExpiryData({cacheControl:F,expires:V}),h.setTexture(B,this.map.painter),h.state="loaded",u.cacheEntryPossiblyAdded(this.dispatcher),void _(null)):_(null)))}static loadTileData(h,_,T){h.setTexture(_,T)}static unloadTileData(h,_){h.texture&&_.saveTileTexture(h.texture)}abortTile(h,_){h.request&&(h.request.cancel(),delete h.request),_()}unloadTile(h,_){h.texture&&this.map.painter.saveTileTexture(h.texture),_()}hasTransition(){return!1}}let ce;function me(x,h,_,T,C,k,B,F){const V=[x,_,C,h,T,k,1,1,1],Z=[B,F,1],X=u.adjoint([],V),[te,le,ge]=u.transformMat3(Z,Z,u.transpose(X,X));return u.multiply(V,[te,0,0,0,le,0,0,0,ge],V)}class ke extends u.Evented{constructor(h,_,T,C){super(),this.id=h,this.dispatcher=T,this.coordinates=_.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(C),this.options=_}load(h){this._loaded=!1,this.fire(new u.Event("dataloading",{dataType:"source"})),this.url=this.options.url,u.getImage(this.map._requestManager.transformRequest(this.url,u.ResourceType.Image),(_,T)=>{if(this._loaded=!0,_)this.fire(new u.ErrorEvent(_));else if(T){const{HTMLImageElement:C}=u.window;this.image=T instanceof C?u.exported.getImageData(T):T,this.width=this.image.width,this.height=this.image.height,h&&(this.coordinates=h),this._finishLoading()}})}loaded(){return this._loaded}updateImage(h){return this.image&&h.url?(this.options.url=h.url,this.load(h.coordinates),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new u.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(h){this.map=h,this.load()}onRemove(){this.texture&&this.texture.destroy()}setCoordinates(h){this.coordinates=h,this._boundsArray=void 0;const _=h.map(u.MercatorCoordinate.fromLngLat);return this.tileID=function(T){let C=1/0,k=1/0,B=-1/0,F=-1/0;for(const te of T)C=Math.min(C,te.x),k=Math.min(k,te.y),B=Math.max(B,te.x),F=Math.max(F,te.y);const V=Math.max(B-C,F-k),Z=Math.max(0,Math.floor(-Math.log(V)/Math.LN2)),X=Math.pow(2,Z);return new u.CanonicalTileID(Z,Math.floor((C+B)/2*X),Math.floor((k+F)/2*X))}(_),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new u.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(h){for(const V in this.tiles){const Z=this.tiles[V];Z.state!=="loaded"&&(Z.state="loaded",Z.texture=this.texture)}if(this._boundsArray)return;const _=u.tileTransform(this.tileID,this.map.transform.projection),[T,C,k,B]=this.coordinates.map(V=>{const Z=_.projection.project(V[0],V[1]);return u.getTilePoint(_,Z)._round()});this.perspectiveTransform=function(V,Z,X,te,le,ge,de,se,Se,xe){const Te=me(0,0,V,0,0,Z,V,Z),Me=me(X,te,le,ge,de,se,Se,xe);return u.multiply(Me,u.adjoint(Te,Te),Me),[Me[6]/Me[8]*V/u.EXTENT,Me[7]/Me[8]*Z/u.EXTENT]}(this.width,this.height,T.x,T.y,C.x,C.y,B.x,B.y,k.x,k.y);const F=this._boundsArray=new u.StructArrayLayout4i8;F.emplaceBack(T.x,T.y,0,0),F.emplaceBack(C.x,C.y,u.EXTENT,0),F.emplaceBack(B.x,B.y,0,u.EXTENT),F.emplaceBack(k.x,k.y,u.EXTENT,u.EXTENT),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=h.createVertexBuffer(F,u.boundsAttributes.members),this.boundsSegments=u.SegmentVector.simpleSegment(0,0,4,2)}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const h=this.map.painter.context,_=h.gl;this.texture?this.texture.update(this.image):(this.texture=new u.Texture(h,this.image,_.RGBA),this.texture.bind(_.LINEAR,_.CLAMP_TO_EDGE)),this._prepareData(h)}loadTile(h,_){this.tileID&&this.tileID.equals(h.tileID.canonical)?(this.tiles[String(h.tileID.wrap)]=h,h.buckets={},_(null)):(h.state="errored",_(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const Re={vector:class extends u.Evented{constructor(x,h,_,T){if(super(),this.id=x,this.dispatcher=_,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,u.extend(this,u.pick(h,["url","scheme","tileSize","promoteId"])),this._options=u.extend({type:"vector"},h),this._collectResourceTiming=h.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(T),this._tileWorkers={},this._deduped=new u.DedupedRequest}load(){this._loaded=!1,this.fire(new u.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=Zt(this._options,this.map._requestManager,(x,h)=>{this._tileJSONRequest=null,this._loaded=!0,x?this.fire(new u.ErrorEvent(x)):h&&(u.extend(this,h),h.bounds&&(this.tileBounds=new si(h.bounds,this.minzoom,this.maxzoom)),u.postTurnstileEvent(h.tiles,this.map._requestManager._customAccessToken),this.fire(new u.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}hasTile(x){return!this.tileBounds||this.tileBounds.contains(x.canonical)}onAdd(x){this.map=x,this.load()}setSourceProperty(x){this._tileJSONRequest&&this._tileJSONRequest.cancel(),x();const h=this.map.style._getSourceCaches(this.id);for(const _ of h)_.clearTiles();this.load()}setTiles(x){return this.setSourceProperty(()=>{this._options.tiles=x}),this}setUrl(x){return this.setSourceProperty(()=>{this.url=x,this._options.url=x}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return u.extend({},this._options)}loadTile(x,h){const _=this.map._requestManager.normalizeTileURL(x.tileID.canonical.url(this.tiles,this.scheme)),T={request:this.map._requestManager.transformRequest(_,u.ResourceType.Tile),data:void 0,uid:x.uid,tileID:x.tileID,tileZoom:x.tileZoom,zoom:x.tileID.overscaledZ,tileSize:this.tileSize*x.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:u.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:x.isSymbolTile};if(T.request.collectResourceTiming=this._collectResourceTiming,x.actor&&x.state!=="expired")x.state==="loading"?x.reloadCallback=h:x.request=x.actor.send("reloadTile",T,C.bind(this));else if(x.actor=this._tileWorkers[_]=this._tileWorkers[_]||this.dispatcher.getActor(),this.dispatcher.ready)x.request=x.actor.send("loadTile",T,C.bind(this),void 0,!0);else{const k=u.loadVectorTile.call({deduped:this._deduped},T,(B,F)=>{B||!F?C.call(this,B):(T.data={cacheControl:F.cacheControl,expires:F.expires,rawData:F.rawData.slice(0)},x.actor&&x.actor.send("loadTile",T,C.bind(this),void 0,!0))},!0);x.request={cancel:k}}function C(k,B){return delete x.request,x.aborted?h(null):k&&k.status!==404?h(k):(B&&B.resourceTiming&&(x.resourceTiming=B.resourceTiming),this.map._refreshExpiredTiles&&B&&x.setExpiryData(B),x.loadVectorData(B,this.map.painter),u.cacheEntryPossiblyAdded(this.dispatcher),h(null),void(x.reloadCallback&&(this.loadTile(x,x.reloadCallback),x.reloadCallback=null)))}}abortTile(x){x.request&&(x.request.cancel(),delete x.request),x.actor&&x.actor.send("abortTile",{uid:x.uid,type:this.type,source:this.id})}unloadTile(x){x.unloadVectorData(),x.actor&&x.actor.send("removeTile",{uid:x.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}},raster:W,"raster-dem":class extends W{constructor(x,h,_,T){super(x,h,_,T),this.type="raster-dem",this.maxzoom=22,this._options=u.extend({type:"raster-dem"},h),this.encoding=h.encoding||"mapbox"}loadTile(x,h){const _=this.map._requestManager.normalizeTileURL(x.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function T(C,k){C&&(x.state="errored",h(C)),k&&(x.dem=k,x.dem.onDeserialize(),x.needsHillshadePrepare=!0,x.needsDEMTextureUpload=!0,x.state="loaded",h(null))}x.request=u.getImage(this.map._requestManager.transformRequest(_,u.ResourceType.Tile),function(C,k,B,F){if(delete x.request,x.aborted)x.state="unloaded",h(null);else if(C)x.state="errored",h(C);else if(k){this.map._refreshExpiredTiles&&x.setExpiryData({cacheControl:B,expires:F});const V=u.window.ImageBitmap&&k instanceof u.window.ImageBitmap&&(ce==null&&(ce=u.window.OffscreenCanvas&&new u.window.OffscreenCanvas(1,1).getContext("2d")&&typeof u.window.createImageBitmap=="function"),ce),Z=1-(k.width-u.prevPowerOfTwo(k.width))/2;Z<1||x.neighboringTiles||(x.neighboringTiles=this._getNeighboringTiles(x.tileID));const X=V?k:u.exported.getImageData(k,Z),te={uid:x.uid,coord:x.tileID,source:this.id,rawImageData:X,encoding:this.encoding,padding:Z};x.actor&&x.state!=="expired"||(x.actor=this.dispatcher.getActor(),x.actor.send("loadDEMTile",te,T.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(x){const h=x.canonical,_=Math.pow(2,h.z),T=(h.x-1+_)%_,C=h.x===0?x.wrap-1:x.wrap,k=(h.x+1+_)%_,B=h.x+1===_?x.wrap+1:x.wrap,F={};return F[new u.OverscaledTileID(x.overscaledZ,C,h.z,T,h.y).key]={backfilled:!1},F[new u.OverscaledTileID(x.overscaledZ,B,h.z,k,h.y).key]={backfilled:!1},h.y>0&&(F[new u.OverscaledTileID(x.overscaledZ,C,h.z,T,h.y-1).key]={backfilled:!1},F[new u.OverscaledTileID(x.overscaledZ,x.wrap,h.z,h.x,h.y-1).key]={backfilled:!1},F[new u.OverscaledTileID(x.overscaledZ,B,h.z,k,h.y-1).key]={backfilled:!1}),h.y+1<_&&(F[new u.OverscaledTileID(x.overscaledZ,C,h.z,T,h.y+1).key]={backfilled:!1},F[new u.OverscaledTileID(x.overscaledZ,x.wrap,h.z,h.x,h.y+1).key]={backfilled:!1},F[new u.OverscaledTileID(x.overscaledZ,B,h.z,k,h.y+1).key]={backfilled:!1}),F}unloadTile(x){x.demTexture&&this.map.painter.saveTileTexture(x.demTexture),x.fbo&&(x.fbo.destroy(),delete x.fbo),x.dem&&delete x.dem,delete x.neighboringTiles,x.state="unloaded"}},geojson:class extends u.Evented{constructor(x,h,_,T){super(),this.id=x,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=_.getActor(),this.setEventedParent(T),this._data=h.data,this._options=u.extend({},h),this._collectResourceTiming=h.collectResourceTiming,h.maxzoom!==void 0&&(this.maxzoom=h.maxzoom),h.type&&(this.type=h.type),h.attribution&&(this.attribution=h.attribution),this.promoteId=h.promoteId;const C=u.EXTENT/this.tileSize;this.workerOptions=u.extend({source:this.id,cluster:h.cluster||!1,geojsonVtOptions:{buffer:(h.buffer!==void 0?h.buffer:128)*C,tolerance:(h.tolerance!==void 0?h.tolerance:.375)*C,extent:u.EXTENT,maxZoom:this.maxzoom,lineMetrics:h.lineMetrics||!1,generateId:h.generateId||!1},superclusterOptions:{maxZoom:h.clusterMaxZoom!==void 0?h.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,h.clusterMinPoints||2),extent:u.EXTENT,radius:(h.clusterRadius!==void 0?h.clusterRadius:50)*C,log:!1,generateId:h.generateId||!1},clusterProperties:h.clusterProperties,filter:h.filter},h.workerOptions)}onAdd(x){this.map=x,this.setData(this._data)}setData(x){return this._data=x,this._updateWorkerData(),this}getClusterExpansionZoom(x,h){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:x,source:this.id},h),this}getClusterChildren(x,h){return this.actor.send("geojson.getClusterChildren",{clusterId:x,source:this.id},h),this}getClusterLeaves(x,h,_,T){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:x,limit:h,offset:_},T),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new u.Event("dataloading",{dataType:"source"})),this._loaded=!1;const x=u.extend({},this.workerOptions),h=this._data;typeof h=="string"?(x.request=this.map._requestManager.transformRequest(u.exported.resolveURL(h),u.ResourceType.Source),x.request.collectResourceTiming=this._collectResourceTiming):x.data=JSON.stringify(h),this._pendingLoad=this.actor.send(`${this.type}.loadData`,x,(_,T)=>{if(this._loaded=!0,this._pendingLoad=null,_)this.fire(new u.ErrorEvent(_));else{const C={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&T&&T.resourceTiming&&T.resourceTiming[this.id]&&(C.resourceTiming=T.resourceTiming[this.id]),this.fire(new u.Event("data",C)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(x,h){const _=x.actor?"reloadTile":"loadTile";x.actor=this.actor,x.request=this.actor.send(_,{type:this.type,uid:x.uid,tileID:x.tileID,tileZoom:x.tileZoom,zoom:x.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:u.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(T,C)=>(delete x.request,x.unloadVectorData(),x.aborted?h(null):T?h(T):(x.loadVectorData(C,this.map.painter,_==="reloadTile"),h(null))),void 0,_==="loadTile")}abortTile(x){x.request&&(x.request.cancel(),delete x.request),x.aborted=!0}unloadTile(x){x.unloadVectorData(),this.actor.send("removeTile",{uid:x.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return u.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends ke{constructor(x,h,_,T){super(x,h,_,T),this.roundZoom=!0,this.type="video",this.options=h}load(){this._loaded=!1;const x=this.options;this.urls=[];for(const h of x.urls)this.urls.push(this.map._requestManager.transformRequest(h,u.ResourceType.Source).url);u.getVideo(this.urls,(h,_)=>{this._loaded=!0,h?this.fire(new u.ErrorEvent(h)):_&&(this.video=_,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(x){if(this.video){const h=this.video.seekable;x<h.start(0)||x>h.end(0)?this.fire(new u.ErrorEvent(new u.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${h.start(0)} and ${h.end(0)}-second mark.`))):this.video.currentTime=x}}getVideo(){return this.video}onAdd(x){this.map||(this.map=x,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const x=this.map.painter.context,h=x.gl;this.texture?this.video.paused||(this.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE),h.texSubImage2D(h.TEXTURE_2D,0,0,0,h.RGBA,h.UNSIGNED_BYTE,this.video)):(this.texture=new u.Texture(x,this.video,h.RGBA),this.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(x)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:ke,canvas:class extends ke{constructor(x,h,_,T){super(x,h,_,T),h.coordinates?Array.isArray(h.coordinates)&&h.coordinates.length===4&&!h.coordinates.some(C=>!Array.isArray(C)||C.length!==2||C.some(k=>typeof k!="number"))||this.fire(new u.ErrorEvent(new u.ValidationError(`sources.${x}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new u.ErrorEvent(new u.ValidationError(`sources.${x}`,null,'missing required property "coordinates"'))),h.animate&&typeof h.animate!="boolean"&&this.fire(new u.ErrorEvent(new u.ValidationError(`sources.${x}`,null,'optional "animate" property must be a boolean value'))),h.canvas?typeof h.canvas=="string"||h.canvas instanceof u.window.HTMLCanvasElement||this.fire(new u.ErrorEvent(new u.ValidationError(`sources.${x}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new u.ErrorEvent(new u.ValidationError(`sources.${x}`,null,'missing required property "canvas"'))),this.options=h,this.animate=h.animate===void 0||h.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof u.window.HTMLCanvasElement?this.options.canvas:u.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new u.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(x){this.map=x,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let x=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,x=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,x=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const h=this.map.painter.context;this.texture?(x||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new u.Texture(h,this.canvas,h.gl.RGBA,{premultiply:!0}),this._prepareData(h)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const x of[this.canvas.width,this.canvas.height])if(isNaN(x)||x<=0)return!0;return!1}},custom:class extends u.Evented{constructor(x,h,_,T){super(),this.id=x,this.type="custom",this._dataType="raster",this._dispatcher=_,this._implementation=h,this.setEventedParent(T),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new u.ErrorEvent(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new u.ErrorEvent(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new si(this._implementation.bounds,this.minzoom,this.maxzoom)),h.update=this._update.bind(this),h.coveringTiles=this._coveringTiles.bind(this),u.extend(this,u.pick(h,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return u.pick(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new u.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new u.Event("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(x){this._map=x,this._loaded=!1,this.fire(new u.Event("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(x),this.load()}onRemove(x){this._implementation.onRemove&&this._implementation.onRemove(x)}hasTile(x){if(this._implementation.hasTile){const{x:h,y:_,z:T}=x.canonical;return this._implementation.hasTile({x:h,y:_,z:T})}return!this.tileBounds||this.tileBounds.contains(x.canonical)}loadTile(x,h){const{x:_,y:T,z:C}=x.tileID.canonical,k=new u.window.AbortController,B=this._implementation.loadTile({x:_,y:T,z:C},{signal:k.signal});if(!B)return this.loadTileData(x,{width:this.tileSize,height:this.tileSize,data:null}),x.state="loaded",h(null);B.cancel=()=>k.abort(),x.request=B.then(function(F){return delete x.request,x.aborted?(x.state="unloaded",h(null)):F?function(V){return V instanceof u.window.ImageData||V instanceof u.window.ImageBitmap||V instanceof u.window.HTMLCanvasElement}(F)?(this.loadTileData(x,F),x.state="loaded",void h(null)):(x.state="errored",h(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`))):(this.loadTileData(x,{width:this.tileSize,height:this.tileSize,data:null}),x.state="loaded",h(null))}.bind(this)).catch(F=>{F.code!==20&&(x.state="errored",h(F))})}loadTileData(x,h){W.loadTileData(x,h,this._map.painter)}unloadTileData(x){W.unloadTileData(x,this._map.painter)}prepareTile(x){if(!this._implementation.prepareTile)return null;const{x:h,y:_,z:T}=x.tileID.canonical,C=this._implementation.prepareTile({x:h,y:_,z:T});return C?(this.loadTileData(x,C),x.state="loaded",C):null}unloadTile(x,h){if(this.unloadTileData(x),this._implementation.unloadTile){const{x:_,y:T,z:C}=x.tileID.canonical;this._implementation.unloadTile({x:_,y:T,z:C})}h()}abortTile(x,h){x.request&&x.request.cancel&&(x.request.cancel(),delete x.request),h()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(x=>({x:x.canonical.x,y:x.canonical.y,z:x.canonical.z}))}_update(){this.fire(new u.Event("data",{dataType:"source",sourceDataType:"content"}))}}},ze=function(x,h,_,T){const C=new Re[h.type](x,h,_,T);if(C.id!==x)throw new Error(`Expected Source id to be ${x} instead of ${C.id}`);return u.bindAll(["load","abort","unload","serialize","prepare"],C),C};function Pe(x,h){const _=u.identity([]);return u.scale(_,_,[.5*x.width,.5*-x.height,1]),u.translate(_,_,[1,-1,0]),u.multiply$1(_,_,x.calculateProjMatrix(h.toUnwrapped())),Float32Array.from(_)}function je(x,h,_,T,C,k,B,F=!1){const V=x.tilesIn(T,B,F);V.sort(ut);const Z=[];for(const te of V)Z.push({wrappedTileID:te.tile.tileID.wrapped().key,queryResults:te.tile.queryRenderedFeatures(h,_,x._state,te,C,k,Pe(x.transform,te.tile.tileID),F)});const X=function(te){const le={},ge={};for(const de of te){const se=de.queryResults,Se=de.wrappedTileID,xe=ge[Se]=ge[Se]||{};for(const Te in se){const Me=se[Te],Ae=xe[Te]=xe[Te]||{},Ee=le[Te]=le[Te]||[];for(const De of Me)Ae[De.featureIndex]||(Ae[De.featureIndex]=!0,Ee.push(De))}}return le}(Z);for(const te in X)X[te].forEach(le=>{const ge=le.feature,de=ge.layer;de&&de.type!=="background"&&de.type!=="sky"&&(ge.source=de.source,de["source-layer"]&&(ge.sourceLayer=de["source-layer"]),ge.state=ge.id!==void 0?x.getFeatureState(de["source-layer"],ge.id):{})});return X}function Ke(x,h){const _=x.getRenderableIds().map(k=>x.getTileByID(k)),T=[],C={};for(let k=0;k<_.length;k++){const B=_[k],F=B.tileID.canonical.key;C[F]||(C[F]=!0,B.querySourceFeatures(T,h))}return T}function ut(x,h){const _=x.tileID,T=h.tileID;return _.overscaledZ-T.overscaledZ||_.canonical.y-T.canonical.y||_.wrap-T.wrap||_.canonical.x-T.canonical.x}function et(){return To.workerClass!=null?new To.workerClass:new u.window.Worker(To.workerUrl)}const Rt="mapboxgl_preloaded_worker_pool";class wt{constructor(){this.active={}}acquire(h){if(!this.workers)for(this.workers=[];this.workers.length<wt.workerCount;)this.workers.push(new et);return this.active[h]=!0,this.workers.slice()}release(h){delete this.active[h],this.numActive()===0&&(this.workers.forEach(_=>{_.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Rt]}numActive(){return Object.keys(this.active).length}}let Lt;function Wt(){return Lt||(Lt=new wt),Lt}function $e(x,h){const _={};for(const T in x)T!=="ref"&&(_[T]=x[T]);return u.refProperties.forEach(T=>{T in h&&(_[T]=h[T])}),_}function Ti(x){x=x.slice();const h=Object.create(null);for(let _=0;_<x.length;_++)h[x[_].id]=x[_];for(let _=0;_<x.length;_++)"ref"in x[_]&&(x[_]=$e(x[_],h[x[_].ref]));return x}wt.workerCount=2;const St={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function Ai(x,h,_){_.push({command:St.addSource,args:[x,h[x]]})}function ki(x,h,_){h.push({command:St.removeSource,args:[x]}),_[x]=!0}function Xr(x,h,_,T){ki(x,_,T),Ai(x,h,_)}function yn(x,h,_){let T;for(T in x[_])if(x[_].hasOwnProperty(T)&&T!=="data"&&!z(x[_][T],h[_][T]))return!1;for(T in h[_])if(h[_].hasOwnProperty(T)&&T!=="data"&&!z(x[_][T],h[_][T]))return!1;return!0}function xt(x,h,_,T,C,k){let B;for(B in h=h||{},x=x||{})x.hasOwnProperty(B)&&(z(x[B],h[B])||_.push({command:k,args:[T,B,h[B],C]}));for(B in h)h.hasOwnProperty(B)&&!x.hasOwnProperty(B)&&(z(x[B],h[B])||_.push({command:k,args:[T,B,h[B],C]}))}function Mi(x){return x.id}function xi(x,h){return x[h.id]=h,x}class fn{constructor(h,_){this.reset(h,_)}reset(h,_){this.points=h||[],this._distances=[0];for(let T=1;T<this.points.length;T++)this._distances[T]=this._distances[T-1]+this.points[T].dist(this.points[T-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(_||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(h){if(this.points.length===1)return this.points[0];h=u.clamp(h,0,1);let _=1,T=this._distances[_];const C=h*this.paddedLength+this.padding;for(;T<C&&_<this._distances.length;)T=this._distances[++_];const k=_-1,B=this._distances[k],F=T-B,V=F>0?(C-B)/F:0;return this.points[k].mult(1-V).add(this.points[_].mult(V))}}class Xn{constructor(h,_,T){const C=this.boxCells=[],k=this.circleCells=[];this.xCellCount=Math.ceil(h/T),this.yCellCount=Math.ceil(_/T);for(let B=0;B<this.xCellCount*this.yCellCount;B++)C.push([]),k.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=h,this.height=_,this.xScale=this.xCellCount/h,this.yScale=this.yCellCount/_,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(h,_,T,C,k){this._forEachCell(_,T,C,k,this._insertBoxCell,this.boxUid++),this.boxKeys.push(h),this.bboxes.push(_),this.bboxes.push(T),this.bboxes.push(C),this.bboxes.push(k)}insertCircle(h,_,T,C){this._forEachCell(_-C,T-C,_+C,T+C,this._insertCircleCell,this.circleUid++),this.circleKeys.push(h),this.circles.push(_),this.circles.push(T),this.circles.push(C)}_insertBoxCell(h,_,T,C,k,B){this.boxCells[k].push(B)}_insertCircleCell(h,_,T,C,k,B){this.circleCells[k].push(B)}_query(h,_,T,C,k,B){if(T<0||h>this.width||C<0||_>this.height)return!k&&[];const F=[];if(h<=0&&_<=0&&this.width<=T&&this.height<=C){if(k)return!0;for(let V=0;V<this.boxKeys.length;V++)F.push({key:this.boxKeys[V],x1:this.bboxes[4*V],y1:this.bboxes[4*V+1],x2:this.bboxes[4*V+2],y2:this.bboxes[4*V+3]});for(let V=0;V<this.circleKeys.length;V++){const Z=this.circles[3*V],X=this.circles[3*V+1],te=this.circles[3*V+2];F.push({key:this.circleKeys[V],x1:Z-te,y1:X-te,x2:Z+te,y2:X+te})}return B?F.filter(B):F}return this._forEachCell(h,_,T,C,this._queryCell,F,{hitTest:k,seenUids:{box:{},circle:{}}},B),k?F.length>0:F}_queryCircle(h,_,T,C,k){const B=h-T,F=h+T,V=_-T,Z=_+T;if(F<0||B>this.width||Z<0||V>this.height)return!C&&[];const X=[];return this._forEachCell(B,V,F,Z,this._queryCellCircle,X,{hitTest:C,circle:{x:h,y:_,radius:T},seenUids:{box:{},circle:{}}},k),C?X.length>0:X}query(h,_,T,C,k){return this._query(h,_,T,C,!1,k)}hitTest(h,_,T,C,k){return this._query(h,_,T,C,!0,k)}hitTestCircle(h,_,T,C){return this._queryCircle(h,_,T,!0,C)}_queryCell(h,_,T,C,k,B,F,V){const Z=F.seenUids,X=this.boxCells[k];if(X!==null){const le=this.bboxes;for(const ge of X)if(!Z.box[ge]){Z.box[ge]=!0;const de=4*ge;if(h<=le[de+2]&&_<=le[de+3]&&T>=le[de+0]&&C>=le[de+1]&&(!V||V(this.boxKeys[ge]))){if(F.hitTest)return B.push(!0),!0;B.push({key:this.boxKeys[ge],x1:le[de],y1:le[de+1],x2:le[de+2],y2:le[de+3]})}}}const te=this.circleCells[k];if(te!==null){const le=this.circles;for(const ge of te)if(!Z.circle[ge]){Z.circle[ge]=!0;const de=3*ge;if(this._circleAndRectCollide(le[de],le[de+1],le[de+2],h,_,T,C)&&(!V||V(this.circleKeys[ge]))){if(F.hitTest)return B.push(!0),!0;{const se=le[de],Se=le[de+1],xe=le[de+2];B.push({key:this.circleKeys[ge],x1:se-xe,y1:Se-xe,x2:se+xe,y2:Se+xe})}}}}}_queryCellCircle(h,_,T,C,k,B,F,V){const Z=F.circle,X=F.seenUids,te=this.boxCells[k];if(te!==null){const ge=this.bboxes;for(const de of te)if(!X.box[de]){X.box[de]=!0;const se=4*de;if(this._circleAndRectCollide(Z.x,Z.y,Z.radius,ge[se+0],ge[se+1],ge[se+2],ge[se+3])&&(!V||V(this.boxKeys[de])))return B.push(!0),!0}}const le=this.circleCells[k];if(le!==null){const ge=this.circles;for(const de of le)if(!X.circle[de]){X.circle[de]=!0;const se=3*de;if(this._circlesCollide(ge[se],ge[se+1],ge[se+2],Z.x,Z.y,Z.radius)&&(!V||V(this.circleKeys[de])))return B.push(!0),!0}}}_forEachCell(h,_,T,C,k,B,F,V){const Z=this._convertToXCellCoord(h),X=this._convertToYCellCoord(_),te=this._convertToXCellCoord(T),le=this._convertToYCellCoord(C);for(let ge=Z;ge<=te;ge++)for(let de=X;de<=le;de++)if(k.call(this,h,_,T,C,this.xCellCount*de+ge,B,F,V))return}_convertToXCellCoord(h){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(h*this.xScale)))}_convertToYCellCoord(h){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(h*this.yScale)))}_circlesCollide(h,_,T,C,k,B){const F=C-h,V=k-_,Z=T+B;return Z*Z>F*F+V*V}_circleAndRectCollide(h,_,T,C,k,B,F){const V=(B-C)/2,Z=Math.abs(h-(C+V));if(Z>V+T)return!1;const X=(F-k)/2,te=Math.abs(_-(k+X));if(te>X+T)return!1;if(Z<=V||te<=X)return!0;const le=Z-V,ge=te-X;return le*le+ge*ge<=T*T}}const bi=Math.tan(85*Math.PI/180);function Yn(x,h,_,T,C,k){const B=u.create();if(_){if(C.projection.name==="globe")u.multiply$1(B,B,u.calculateGlobeLabelMatrix(C,h));else{const F=be([],k);B[0]=F[0],B[1]=F[1],B[4]=F[2],B[5]=F[3]}T||u.rotateZ(B,B,C.angle)}else u.multiply$1(B,C.labelPlaneMatrix,x);return B}function co(x,h,_,T,C,k){if(_){if(C.projection.name==="globe"){const B=Yn(x,h,_,T,C,k);return u.invert(B,B),u.multiply$1(B,x,B),B}{const B=u.clone(x),F=u.identity([]);return F[0]=k[0],F[1]=k[1],F[4]=k[2],F[5]=k[3],u.multiply$1(B,B,F),T||u.rotateZ(B,B,-C.angle),B}}return C.glCoordMatrix}function Mr(x,h,_=0){const T=[x.x,x.y,_,1];_?u.transformMat4$1(T,T,h):Fr(T,T,h);const C=T[3];return{point:new u.pointGeometry(T[0]/C,T[1]/C),signedDistanceFromCamera:C}}function Yr(x,h){const _=[x[0],x[1],x[2],1];u.transformMat4$1(_,_,h);const T=_[3];return{point:new u.pointGeometry(_[0]/T,_[1]/T),signedDistanceFromCamera:T}}function Xi(x,h){return Math.min(.5+x/h*.5,1.5)}function nh(x,h){const _=x[0]/x[3],T=x[1]/x[3];return _>=-h[0]&&_<=h[0]&&T>=-h[1]&&T<=h[1]}function No(x,h,_,T,C,k,B,F,V,Z){const X=_.transform,te=T?x.textSizeData:x.iconSizeData,le=u.evaluateSizeForZoom(te,_.transform.zoom),ge=[256/_.width*2+1,256/_.height*2+1],de=T?x.text.dynamicLayoutVertexArray:x.icon.dynamicLayoutVertexArray;de.clear();const se=x.lineVertexArray,Se=T?x.text.placedSymbolArray:x.icon.placedSymbolArray,xe=_.transform.width/_.transform.height;let Te=!1;for(let Me=0;Me<Se.length;Me++){const Ae=Se.get(Me);if(Ae.writingMode!==u.WritingMode.vertical||Te||Me!==0&&Se.get(Me-1).writingMode===u.WritingMode.horizontal||(Te=!0),(Ae.hidden||Ae.writingMode===u.WritingMode.vertical)&&!Te){ar(Ae.numGlyphs,de);continue}Te=!1;const Ee=new u.pointGeometry(Ae.tileAnchorX,Ae.tileAnchorY),De=V?V(Ee):[0,0,0],Ue=X.projection.projectTilePoint(Ee.x,Ee.y,Z.canonical),Ze=[Ue.x+De[0],Ue.y+De[1],Ue.z+De[2]],He=[...Ze,1];if(u.transformMat4$1(He,He,h),!nh(He,ge)){ar(Ae.numGlyphs,de);continue}const Ye=Xi(_.transform.cameraToCenterDistance,He[3]),ct=u.evaluateSizeForFeature(te,le,Ae),Ve=B?ct/Ye:ct*Ye,ht=Mr(new u.pointGeometry(Ze[0],Ze[1]),C,Ze[2]);if(ht.signedDistanceFromCamera<=0){ar(Ae.numGlyphs,de);continue}let at={};const Dt=B?null:V,Je=bs(Ae,Ve,!1,F,h,C,k,x.glyphOffsetArray,se,de,ht.point,Ee,at,xe,Dt,X.projection,Z);Te=Je.useVertical,Dt&&Je.needsFlipping&&(at={}),(Je.notEnoughRoom||Te||Je.needsFlipping&&bs(Ae,Ve,!0,F,h,C,k,x.glyphOffsetArray,se,de,ht.point,Ee,at,xe,Dt,X.projection,Z).notEnoughRoom)&&ar(Ae.numGlyphs,de)}T?x.text.dynamicLayoutVertexBuffer.updateData(de):x.icon.dynamicLayoutVertexBuffer.updateData(de)}function vs(x,h,_,T,C,k,B,F,V,Z,X,te,le,ge,de){const se=F.glyphStartIndex+F.numGlyphs,Se=F.lineStartIndex,xe=F.lineStartIndex+F.lineLength,Te=h.getoffsetX(F.glyphStartIndex),Me=h.getoffsetX(se-1),Ae=uo(x*Te,_,T,C,k,B,F.segment,Se,xe,V,Z,X,te,le,!0,ge,de);if(!Ae)return null;const Ee=uo(x*Me,_,T,C,k,B,F.segment,Se,xe,V,Z,X,te,le,!0,ge,de);return Ee?{first:Ae,last:Ee}:null}function ho(x,h,_,T){return x.writingMode===u.WritingMode.horizontal&&Math.abs(_.y-h.y)>Math.abs(_.x-h.x)*T?{useVertical:!0}:x.writingMode===u.WritingMode.vertical?h.y<_.y?{needsFlipping:!0}:null:x.flipState!==0&&function(C,k,B){const F=(k.x-C.x)*B;return F===0||Math.abs((k.y-C.y)/F)>bi}(h,_,T)?x.flipState===1?{needsFlipping:!0}:null:h.x>_.x?{needsFlipping:!0}:null}function bs(x,h,_,T,C,k,B,F,V,Z,X,te,le,ge,de,se,Se){const xe=h/24,Te=x.lineOffsetX*xe,Me=x.lineOffsetY*xe;let Ae;if(x.numGlyphs>1){const Ee=x.glyphStartIndex+x.numGlyphs,De=x.lineStartIndex,Ue=x.lineStartIndex+x.lineLength,Ze=vs(xe,F,Te,Me,_,X,te,x,V,k,le,de,!1,se,Se);if(!Ze)return{notEnoughRoom:!0};const He=Mr(Ze.first.point,B).point,Ye=Mr(Ze.last.point,B).point;if(T&&!_){const ct=ho(x,He,Ye,ge);if(x.flipState=ct&&ct.needsFlipping?1:2,ct)return ct}Ae=[Ze.first];for(let ct=x.glyphStartIndex+1;ct<Ee-1;ct++)Ae.push(uo(xe*F.getoffsetX(ct),Te,Me,_,X,te,x.segment,De,Ue,V,k,le,de,!1,!1,se,Se));Ae.push(Ze.last)}else{if(T&&!_){const De=Mr(te,C).point,Ue=x.lineStartIndex+x.segment+1,Ze=new u.pointGeometry(V.getx(Ue),V.gety(Ue)),He=Mr(Ze,C),Ye=ho(x,De,He.signedDistanceFromCamera>0?He.point:Di(te,Ze,De,1,C,void 0,se,Se.canonical),ge);if(x.flipState=Ye&&Ye.needsFlipping?1:2,Ye)return Ye}const Ee=uo(xe*F.getoffsetX(x.glyphStartIndex),Te,Me,_,X,te,x.segment,x.lineStartIndex,x.lineStartIndex+x.lineLength,V,k,le,de,!1,!1,se,Se);if(!Ee)return{notEnoughRoom:!0};Ae=[Ee]}for(const Ee of Ae)u.addDynamicAttributes(Z,Ee.point,Ee.angle);return{}}function _a(x,h,_,T,C){const k=T.projectTilePoint(x.x,x.y,h);if(!C)return Mr(k,_,k.z);const B=C(x);return Mr(new u.pointGeometry(k.x+B[0],k.y+B[1]),_,k.z+B[2])}function Di(x,h,_,T,C,k,B,F){const V=_a(x.add(x.sub(h)._unit()),F,C,B,k).point,Z=_.sub(V);return _.add(Z._mult(T/Z.mag()))}function uo(x,h,_,T,C,k,B,F,V,Z,X,te,le,ge,de,se,Se){const xe=T?x-h:x+h;let Te=xe>0?1:-1,Me=0;T&&(Te*=-1,Me=Math.PI),Te<0&&(Me+=Math.PI);let Ae=Te>0?F+B:F+B+1,Ee=C,De=C,Ue=0,Ze=0;const He=Math.abs(xe),Ye=[],ct=[];let Ve=k;const ht=()=>{const It=Ae-Te;return Ue===0?k:new u.pointGeometry(Z.getx(It),Z.gety(It))},at=()=>Di(ht(),Ve,De,He-Ue+1,X,le,se,Se.canonical);for(;Ue+Ze<=He;){if(Ae+=Te,Ae<F||Ae>=V)return null;if(De=Ee,Ye.push(Ee),ge&&ct.push(Ve||ht()),Ee=te[Ae],Ee===void 0){Ve=new u.pointGeometry(Z.getx(Ae),Z.gety(Ae));const It=_a(Ve,Se.canonical,X,se,le);Ee=It.signedDistanceFromCamera>0?te[Ae]=It.point:at()}else Ve=null;Ue+=Ze,Ze=De.dist(Ee)}de&&le&&(Ve=Ve||new u.pointGeometry(Z.getx(Ae),Z.gety(Ae)),te[Ae]=Ee=te[Ae]===void 0?Ee:at(),Ze=De.dist(Ee));const Dt=(He-Ue)/Ze,Je=Ee.sub(De),At=Je.mult(Dt)._add(De);_&&At._add(Je._unit()._perp()._mult(_*Te));const qt=Me+Math.atan2(Ee.y-De.y,Ee.x-De.x);return Ye.push(At),ge&&(Ve=Ve||new u.pointGeometry(Z.getx(Ae),Z.gety(Ae)),ct.push(function(It,Ct,Kt){const mi=1-Kt;return new u.pointGeometry(It.x*mi+Ct.x*Kt,It.y*mi+Ct.y*Kt)}(ct.length>0?ct[ct.length-1]:Ve,Ve,Dt))),{point:At,angle:qt,path:Ye,tilePath:ct}}const ya=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function ar(x,h){for(let _=0;_<x;_++){const T=h.length;h.resize(T+4),h.float32.set(ya,3*T)}}function Fr(x,h,_){const T=h[0],C=h[1];return x[0]=_[0]*T+_[4]*C+_[12],x[1]=_[1]*T+_[5]*C+_[13],x[3]=_[3]*T+_[7]*C+_[15],x}const an=100;class ws{constructor(h,_,T=new Xn(h.width+200,h.height+200,25),C=new Xn(h.width+200,h.height+200,25)){this.transform=h,this.grid=T,this.ignoredGrid=C,this.pitchfactor=Math.cos(h._pitch)*h.cameraToCenterDistance,this.screenRightBoundary=h.width+an,this.screenBottomBoundary=h.height+an,this.gridRightBoundary=h.width+200,this.gridBottomBoundary=h.height+200,this.fogState=_}placeCollisionBox(h,_,T,C,k,B,F){let V=_.projectedAnchorX,Z=_.projectedAnchorY,X=_.projectedAnchorZ;const te=_.elevation,le=_.tileID;if(te&&le){const Ae=this.transform.projection.upVector(le.canonical,_.tileAnchorX,_.tileAnchorY),Ee=this.transform.projection.upVectorScale(le.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;V+=Ae[0]*te*Ee,Z+=Ae[1]*te*Ee,X+=Ae[2]*te*Ee}const ge=this.projectAndGetPerspectiveRatio(B,[V,Z,X],_.tileID,this.transform.projection.name==="globe"||!!te||this.transform.pitch>0),de=k*ge.perspectiveRatio,se=(_.x1*h+T.x-_.padding)*de+ge.point.x,Se=(_.y1*h+T.y-_.padding)*de+ge.point.y,xe=(_.x2*h+T.x+_.padding)*de+ge.point.x,Te=(_.y2*h+T.y+_.padding)*de+ge.point.y,Me=ge.perspectiveRatio<=.55||ge.occluded;return!this.isInsideGrid(se,Se,xe,Te)||!C&&this.grid.hitTest(se,Se,xe,Te,F)||Me?{box:[],offscreen:!1,occluded:ge.occluded}:{box:[se,Se,xe,Te],offscreen:this.isOffscreen(se,Se,xe,Te),occluded:!1}}placeCollisionCircles(h,_,T,C,k,B,F,V,Z,X,te,le,ge,de){const se=[],Se=this.transform.elevation,xe=Se?Se.getAtTileOffsetFunc(de,this.transform.center.lat,this.transform.worldSize,this.transform.projection):at=>[0,0,0],Te=new u.pointGeometry(_.tileAnchorX,_.tileAnchorY),Me=this.transform.projection.projectTilePoint(_.tileAnchorX,_.tileAnchorY,de.canonical),Ae=xe(Te),Ee=[Me.x+Ae[0],Me.y+Ae[1],Me.z+Ae[2]],De=this.projectAndGetPerspectiveRatio(B,[Ee[0],Ee[1],Ee[2]],de,this.transform.projection.name==="globe"||!!Se||this.transform.pitch>0),{perspectiveRatio:Ue}=De,Ze=(X?k/Ue:k*Ue)/u.ONE_EM,He=Mr(new u.pointGeometry(Ee[0],Ee[1]),F,Ee[2]).point,Ye=De.signedDistanceFromCamera>0?vs(Ze,C,_.lineOffsetX*Ze,_.lineOffsetY*Ze,!1,He,Te,_,T,F,{},Se&&!X?xe:null,X&&!!Se,this.transform.projection,de):null;let ct=!1,Ve=!1,ht=!0;if(Ye&&!De.occluded){const at=.5*le*Ue+ge,Dt=new u.pointGeometry(-100,-100),Je=new u.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),At=new fn,qt=Ye.first,It=Ye.last;let Ct=[];for(let jt=qt.path.length-1;jt>=1;jt--)Ct.push(qt.path[jt]);for(let jt=1;jt<It.path.length;jt++)Ct.push(It.path[jt]);const Kt=2.5*at;if(V){const jt=Ct.map(Se?(ti,Ii)=>{const Yi=xe(Ii<qt.path.length-1?qt.tilePath[qt.path.length-1-Ii]:It.tilePath[Ii-qt.path.length+2]);return Mr(ti,V,Yi[2])}:ti=>Mr(ti,V));Ct=jt.some(ti=>ti.signedDistanceFromCamera<=0)?[]:jt.map(ti=>ti.point)}let mi=[];if(Ct.length>0){const jt=Ct[0].clone(),ti=Ct[0].clone();for(let Ii=1;Ii<Ct.length;Ii++)jt.x=Math.min(jt.x,Ct[Ii].x),jt.y=Math.min(jt.y,Ct[Ii].y),ti.x=Math.max(ti.x,Ct[Ii].x),ti.y=Math.max(ti.y,Ct[Ii].y);mi=jt.x>=Dt.x&&ti.x<=Je.x&&jt.y>=Dt.y&&ti.y<=Je.y?[Ct]:ti.x<Dt.x||jt.x>Je.x||ti.y<Dt.y||jt.y>Je.y?[]:u.clipLine([Ct],Dt.x,Dt.y,Je.x,Je.y)}for(const jt of mi){At.reset(jt,.25*at);let ti=0;ti=At.length<=.5*at?1:Math.ceil(At.paddedLength/Kt)+1;for(let Ii=0;Ii<ti;Ii++){const Yi=Ii/Math.max(ti-1,1),vr=At.lerp(Yi),br=vr.x+an,Vr=vr.y+an;se.push(br,Vr,at,0);const hn=br-at,Tn=Vr-at,On=br+at,Mn=Vr+at;if(ht=ht&&this.isOffscreen(hn,Tn,On,Mn),Ve=Ve||this.isInsideGrid(hn,Tn,On,Mn),!h&&this.grid.hitTestCircle(br,Vr,at,te)&&(ct=!0,!Z))return{circles:[],offscreen:!1,collisionDetected:ct,occluded:!1}}}}return{circles:!Z&&ct||!Ve?[]:se,offscreen:ht,collisionDetected:ct,occluded:De.occluded}}queryRenderedSymbols(h){if(h.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const _=[];let T=1/0,C=1/0,k=-1/0,B=-1/0;for(const X of h){const te=new u.pointGeometry(X.x+an,X.y+an);T=Math.min(T,te.x),C=Math.min(C,te.y),k=Math.max(k,te.x),B=Math.max(B,te.y),_.push(te)}const F=this.grid.query(T,C,k,B).concat(this.ignoredGrid.query(T,C,k,B)),V={},Z={};for(const X of F){const te=X.key;if(V[te.bucketInstanceId]===void 0&&(V[te.bucketInstanceId]={}),V[te.bucketInstanceId][te.featureIndex])continue;const le=[new u.pointGeometry(X.x1,X.y1),new u.pointGeometry(X.x2,X.y1),new u.pointGeometry(X.x2,X.y2),new u.pointGeometry(X.x1,X.y2)];u.polygonIntersectsPolygon(_,le)&&(V[te.bucketInstanceId][te.featureIndex]=!0,Z[te.bucketInstanceId]===void 0&&(Z[te.bucketInstanceId]=[]),Z[te.bucketInstanceId].push(te.featureIndex))}return Z}insertCollisionBox(h,_,T,C,k){(_?this.ignoredGrid:this.grid).insert({bucketInstanceId:T,featureIndex:C,collisionGroupID:k},h[0],h[1],h[2],h[3])}insertCollisionCircles(h,_,T,C,k){const B=_?this.ignoredGrid:this.grid,F={bucketInstanceId:T,featureIndex:C,collisionGroupID:k};for(let V=0;V<h.length;V+=4)B.insertCircle(F,h[V],h[V+1],h[V+2])}projectAndGetPerspectiveRatio(h,_,T,C){const k=[_[0],_[1],_[2],1];let B=!1;return _[2]||this.transform.pitch>0?(u.transformMat4$1(k,k,h),this.fogState&&T&&(B=function(F,V,Z,X,te,le){const ge=le.calculateFogTileMatrix(te),de=[V,Z,X];return u.transformMat4(de,de,ge),vt(F,de,le.pitch,le._fov)}(this.fogState,_[0],_[1],_[2],T.toUnwrapped(),this.transform)>.9)):Fr(k,k,h),{point:new u.pointGeometry((k[0]/k[3]+1)/2*this.transform.width+an,(-k[1]/k[3]+1)/2*this.transform.height+an),perspectiveRatio:Math.min(.5+this.transform.cameraToCenterDistance/k[3]*.5,1.5),signedDistanceFromCamera:k[3],occluded:C&&k[2]>k[3]||B}}isOffscreen(h,_,T,C){return T<an||h>=this.screenRightBoundary||C<an||_>this.screenBottomBoundary}isInsideGrid(h,_,T,C){return T>=0&&h<this.gridRightBoundary&&C>=0&&_<this.gridBottomBoundary}getViewportMatrix(){const h=u.identity([]);return u.translate(h,h,[-100,-100,0]),h}}class rr{constructor(h,_,T,C){this.opacity=h?Math.max(0,Math.min(1,h.opacity+(h.placed?_:-_))):C&&T?1:0,this.placed=T}isHidden(){return this.opacity===0&&!this.placed}}class xn{constructor(h,_,T,C,k,B=!1){this.text=new rr(h?h.text:null,_,T,k),this.icon=new rr(h?h.icon:null,_,C,k),this.clipped=B}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class vn{constructor(h,_,T,C=!1){this.text=h,this.icon=_,this.skipFade=T,this.clipped=C}}class _r{constructor(){this.invProjMatrix=u.create(),this.viewportMatrix=u.create(),this.circles=[]}}class xa{constructor(h,_,T,C,k){this.bucketInstanceId=h,this.featureIndex=_,this.sourceLayerIndex=T,this.bucketIndex=C,this.tileID=k}}class ln{constructor(h){this.crossSourceCollisions=h,this.maxGroupID=0,this.collisionGroups={}}get(h){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[h]){const _=++this.maxGroupID;this.collisionGroups[h]={ID:_,predicate:T=>T.collisionGroupID===_}}return this.collisionGroups[h]}}function fo(x,h,_,T,C){const{horizontalAlign:k,verticalAlign:B}=u.getAnchorAlignment(x),F=-(k-.5)*h,V=-(B-.5)*_,Z=u.evaluateVariableOffset(x,T);return new u.pointGeometry(F+Z[0]*C,V+Z[1]*C)}function po(x,h,_,T,C){const k=new u.pointGeometry(x,h);return _&&k._rotate(T?C:-C),k}class oh{constructor(h,_,T,C,k){this.transform=h.clone(),this.collisionIndex=new ws(this.transform,k),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=_,this.retainedQueryData={},this.collisionGroups=new ln(T),this.collisionCircleArrays={},this.prevPlacement=C,C&&(C.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(h,_,T,C){const k=T.getBucket(_),B=T.latestFeatureIndex;if(!k||!B||_.id!==k.layerIds[0])return;const F=k.layers[0].layout,V=T.collisionBoxArray,Z=Math.pow(2,this.transform.zoom-T.tileID.overscaledZ),X=T.tileSize/u.EXTENT,te=T.tileID.toUnwrapped(),le=this.transform.calculateProjMatrix(te),ge=F.get("text-pitch-alignment")==="map",de=F.get("text-rotation-alignment")==="map";_.compileFilter();const se=_.dynamicFilter(),Se=_.dynamicFilterNeedsFeature(),xe=this.transform.calculatePixelsToTileUnitsMatrix(T),Te=Yn(le,T.tileID.canonical,ge,de,this.transform,xe);let Me=null;if(ge){const De=co(le,T.tileID.canonical,ge,de,this.transform,xe);Me=u.multiply$1([],this.transform.labelPlaneMatrix,De)}let Ae=null;se&&T.latestFeatureIndex&&(Ae={unwrappedTileID:te,dynamicFilter:se,dynamicFilterNeedsFeature:Se,featureIndex:T.latestFeatureIndex}),this.retainedQueryData[k.bucketInstanceId]=new xa(k.bucketInstanceId,B,k.sourceLayerIndex,k.index,T.tileID);const Ee={bucket:k,layout:F,posMatrix:le,textLabelPlaneMatrix:Te,labelToScreenMatrix:Me,clippingData:Ae,scale:Z,textPixelRatio:X,holdingForFade:T.holdingForFade(),collisionBoxArray:V,partiallyEvaluatedTextSize:u.evaluateSizeForZoom(k.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:u.evaluateSizeForZoom(k.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(k.sourceID)};if(C)for(const De of k.sortKeyRanges){const{sortKey:Ue,symbolInstanceStart:Ze,symbolInstanceEnd:He}=De;h.push({sortKey:Ue,symbolInstanceStart:Ze,symbolInstanceEnd:He,parameters:Ee})}else h.push({symbolInstanceStart:0,symbolInstanceEnd:k.symbolInstances.length,parameters:Ee})}attemptAnchorPlacement(h,_,T,C,k,B,F,V,Z,X,te,le,ge,de,se,Se,xe,Te){const Me=[le.textOffset0,le.textOffset1],Ae=fo(h,T,C,Me,k),Ee=this.collisionIndex.placeCollisionBox(k,_,po(Ae.x,Ae.y,B,F,this.transform.angle),te,V,Z,X.predicate);if((!Se||this.collisionIndex.placeCollisionBox(de.getSymbolInstanceIconSize(Te,this.transform.zoom,ge),Se,po(Ae.x,Ae.y,B,F,this.transform.angle),te,V,Z,X.predicate).box.length!==0)&&Ee.box.length>0){let De;return this.prevPlacement&&this.prevPlacement.variableOffsets[le.crossTileID]&&this.prevPlacement.placements[le.crossTileID]&&this.prevPlacement.placements[le.crossTileID].text&&(De=this.prevPlacement.variableOffsets[le.crossTileID].anchor),this.variableOffsets[le.crossTileID]={textOffset:Me,width:T,height:C,anchor:h,textScale:k,prevAnchor:De},this.markUsedJustification(de,h,le,se),de.allowVerticalPlacement&&(this.markUsedOrientation(de,se,le),this.placedOrientations[le.crossTileID]=se),{shift:Ae,placedGlyphBoxes:Ee}}}placeLayerBucketPart(h,_,T,C){const{bucket:k,layout:B,posMatrix:F,textLabelPlaneMatrix:V,labelToScreenMatrix:Z,clippingData:X,textPixelRatio:te,holdingForFade:le,collisionBoxArray:ge,partiallyEvaluatedTextSize:de,partiallyEvaluatedIconSize:se,collisionGroup:Se}=h.parameters,xe=B.get("text-optional"),Te=B.get("icon-optional"),Me=B.get("text-allow-overlap"),Ae=B.get("icon-allow-overlap"),Ee=B.get("text-rotation-alignment")==="map",De=B.get("text-pitch-alignment")==="map",Ue=B.get("icon-text-fit")!=="none",Ze=B.get("symbol-z-order")==="viewport-y";let He=Me&&(Ae||!k.hasIconData()||Te),Ye=Ae&&(Me||!k.hasTextData()||xe);!k.collisionArrays&&ge&&k.deserializeCollisionBoxes(ge),T&&C&&k.updateCollisionDebugBuffers(this.transform.zoom,ge);const ct=(Ve,ht,at)=>{if(X){const Hi={zoom:this.transform.zoom,pitch:this.transform.pitch};let Ji=null;if(X.dynamicFilterNeedsFeature){const Pi=this.retainedQueryData[k.bucketInstanceId];Ji=X.featureIndex.loadFeature({featureIndex:Ve.featureIndex,bucketIndex:Pi.bucketIndex,sourceLayerIndex:Pi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,X.dynamicFilter)(Hi,Ji,this.retainedQueryData[k.bucketInstanceId].tileID.canonical,new u.pointGeometry(Ve.tileAnchorX,Ve.tileAnchorY),this.transform.calculateDistanceTileData(X.unwrappedTileID)))return this.placements[Ve.crossTileID]=new vn(!1,!1,!1,!0),void(_[Ve.crossTileID]=!0)}if(_[Ve.crossTileID])return;if(le)return void(this.placements[Ve.crossTileID]=new vn(!1,!1,!1));let Dt=!1,Je=!1,At=!0,qt=!1,It=!1,Ct=null,Kt={box:null,offscreen:null,occluded:null},mi={box:null,offscreen:null,occluded:null},jt=null,ti=null,Ii=null,Yi=0,vr=0,br=0;at.textFeatureIndex?Yi=at.textFeatureIndex:Ve.useRuntimeCollisionCircles&&(Yi=Ve.featureIndex),at.verticalTextFeatureIndex&&(vr=at.verticalTextFeatureIndex);const Vr=Hi=>{Hi.tileID=this.retainedQueryData[k.bucketInstanceId].tileID,(this.transform.elevation||Hi.elevation)&&(Hi.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[k.bucketInstanceId].tileID,Hi.tileAnchorX,Hi.tileAnchorY):0)},hn=at.textBox;if(hn){Vr(hn);const Hi=Pi=>{let nr=u.WritingMode.horizontal;if(k.allowVerticalPlacement&&!Pi&&this.prevPlacement){const jr=this.prevPlacement.placedOrientations[Ve.crossTileID];jr&&(this.placedOrientations[Ve.crossTileID]=jr,nr=jr,this.markUsedOrientation(k,nr,Ve))}return nr},Ji=(Pi,nr)=>{if(k.allowVerticalPlacement&&Ve.numVerticalGlyphVertices>0&&at.verticalTextBox){for(const jr of k.writingModes)if(jr===u.WritingMode.vertical?(Kt=nr(),mi=Kt):Kt=Pi(),Kt&&Kt.box&&Kt.box.length)break}else Kt=Pi()};if(B.get("text-variable-anchor")){let Pi=B.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Ve.crossTileID]){const Wi=this.prevPlacement.variableOffsets[Ve.crossTileID];Pi.indexOf(Wi.anchor)>0&&(Pi=Pi.filter(Kr=>Kr!==Wi.anchor),Pi.unshift(Wi.anchor))}const nr=(Wi,Kr,us)=>{const Gr=k.getSymbolInstanceTextSize(de,Ve,this.transform.zoom,ht),to=(Wi.x2-Wi.x1)*Gr+2*Wi.padding,Sc=(Wi.y2-Wi.y1)*Gr+2*Wi.padding,il=Ue&&!Ae?Kr:null;il&&Vr(il);let Mo={box:[],offscreen:!1,occluded:!1};const wh=Me?2*Pi.length:Pi.length;for(let Nn=0;Nn<wh;++Nn){const rl=this.attemptAnchorPlacement(Pi[Nn%Pi.length],Wi,to,Sc,Gr,Ee,De,te,F,Se,Nn>=Pi.length,Ve,ht,k,us,il,de,se);if(rl&&(Mo=rl.placedGlyphBoxes,Mo&&Mo.box&&Mo.box.length)){Dt=!0,Ct=rl.shift;break}}return Mo};Ji(()=>nr(hn,at.iconBox,u.WritingMode.horizontal),()=>{const Wi=at.verticalTextBox;return Wi&&Vr(Wi),k.allowVerticalPlacement&&!(Kt&&Kt.box&&Kt.box.length)&&Ve.numVerticalGlyphVertices>0&&Wi?nr(Wi,at.verticalIconBox,u.WritingMode.vertical):{box:null,offscreen:null,occluded:null}}),Kt&&(Dt=Kt.box,At=Kt.offscreen,qt=Kt.occluded);const jr=Hi(Kt&&Kt.box);if(!Dt&&this.prevPlacement){const Wi=this.prevPlacement.variableOffsets[Ve.crossTileID];Wi&&(this.variableOffsets[Ve.crossTileID]=Wi,this.markUsedJustification(k,Wi.anchor,Ve,jr))}}else{const Pi=(nr,jr)=>{const Wi=k.getSymbolInstanceTextSize(de,Ve,this.transform.zoom,ht),Kr=this.collisionIndex.placeCollisionBox(Wi,nr,new u.pointGeometry(0,0),Me,te,F,Se.predicate);return Kr&&Kr.box&&Kr.box.length&&(this.markUsedOrientation(k,jr,Ve),this.placedOrientations[Ve.crossTileID]=jr),Kr};Ji(()=>Pi(hn,u.WritingMode.horizontal),()=>{const nr=at.verticalTextBox;return k.allowVerticalPlacement&&Ve.numVerticalGlyphVertices>0&&nr?(Vr(nr),Pi(nr,u.WritingMode.vertical)):{box:null,offscreen:null,occluded:null}}),Hi(Kt&&Kt.box&&Kt.box.length)}}if(jt=Kt,Dt=jt&&jt.box&&jt.box.length>0,At=jt&&jt.offscreen,qt=jt&&jt.occluded,Ve.useRuntimeCollisionCircles){const Hi=k.text.placedSymbolArray.get(Ve.centerJustifiedTextSymbolIndex>=0?Ve.centerJustifiedTextSymbolIndex:Ve.verticalPlacedTextSymbolIndex),Ji=u.evaluateSizeForFeature(k.textSizeData,de,Hi),Pi=B.get("text-padding");ti=this.collisionIndex.placeCollisionCircles(Me,Hi,k.lineVertexArray,k.glyphOffsetArray,Ji,F,V,Z,T,De,Se.predicate,Ve.collisionCircleDiameter*Ji/u.ONE_EM,Pi,this.retainedQueryData[k.bucketInstanceId].tileID),Dt=Me||ti.circles.length>0&&!ti.collisionDetected,At=At&&ti.offscreen,qt=ti.occluded}if(at.iconFeatureIndex&&(br=at.iconFeatureIndex),at.iconBox){const Hi=Ji=>{Vr(Ji);const Pi=Ue&&Ct?po(Ct.x,Ct.y,Ee,De,this.transform.angle):new u.pointGeometry(0,0),nr=k.getSymbolInstanceIconSize(se,this.transform.zoom,ht);return this.collisionIndex.placeCollisionBox(nr,Ji,Pi,Ae,te,F,Se.predicate)};mi&&mi.box&&mi.box.length&&at.verticalIconBox?(Ii=Hi(at.verticalIconBox),Je=Ii.box.length>0):(Ii=Hi(at.iconBox),Je=Ii.box.length>0),At=At&&Ii.offscreen,It=Ii.occluded}const Tn=xe||Ve.numHorizontalGlyphVertices===0&&Ve.numVerticalGlyphVertices===0,On=Te||Ve.numIconVertices===0;if(Tn||On?On?Tn||(Je=Je&&Dt):Dt=Je&&Dt:Je=Dt=Je&&Dt,Dt&&jt&&jt.box&&this.collisionIndex.insertCollisionBox(jt.box,B.get("text-ignore-placement"),k.bucketInstanceId,mi&&mi.box&&vr?vr:Yi,Se.ID),Je&&Ii&&this.collisionIndex.insertCollisionBox(Ii.box,B.get("icon-ignore-placement"),k.bucketInstanceId,br,Se.ID),ti&&(Dt&&this.collisionIndex.insertCollisionCircles(ti.circles,B.get("text-ignore-placement"),k.bucketInstanceId,Yi,Se.ID),T)){const Hi=k.bucketInstanceId;let Ji=this.collisionCircleArrays[Hi];Ji===void 0&&(Ji=this.collisionCircleArrays[Hi]=new _r);for(let Pi=0;Pi<ti.circles.length;Pi+=4)Ji.circles.push(ti.circles[Pi+0]),Ji.circles.push(ti.circles[Pi+1]),Ji.circles.push(ti.circles[Pi+2]),Ji.circles.push(ti.collisionDetected?1:0)}const Mn=this.transform.projection.name!=="globe";He=He&&(Mn||!qt),Ye=Ye&&(Mn||!It),this.placements[Ve.crossTileID]=new vn(Dt||He,Je||Ye,At||k.justReloaded),_[Ve.crossTileID]=!0};if(Ze){const Ve=k.getSortedSymbolIndexes(this.transform.angle);for(let ht=Ve.length-1;ht>=0;--ht){const at=Ve[ht];ct(k.symbolInstances.get(at),at,k.collisionArrays[at])}}else for(let Ve=h.symbolInstanceStart;Ve<h.symbolInstanceEnd;Ve++)ct(k.symbolInstances.get(Ve),Ve,k.collisionArrays[Ve]);if(T&&k.bucketInstanceId in this.collisionCircleArrays){const Ve=this.collisionCircleArrays[k.bucketInstanceId];u.invert(Ve.invProjMatrix,F),Ve.viewportMatrix=this.collisionIndex.getViewportMatrix()}k.justReloaded=!1}markUsedJustification(h,_,T,C){let k;k=C===u.WritingMode.vertical?T.verticalPlacedTextSymbolIndex:{left:T.leftJustifiedTextSymbolIndex,center:T.centerJustifiedTextSymbolIndex,right:T.rightJustifiedTextSymbolIndex}[u.getAnchorJustification(_)];const B=[T.leftJustifiedTextSymbolIndex,T.centerJustifiedTextSymbolIndex,T.rightJustifiedTextSymbolIndex,T.verticalPlacedTextSymbolIndex];for(const F of B)F>=0&&(h.text.placedSymbolArray.get(F).crossTileID=k>=0&&F!==k?0:T.crossTileID)}markUsedOrientation(h,_,T){const C=_===u.WritingMode.horizontal||_===u.WritingMode.horizontalOnly?_:0,k=_===u.WritingMode.vertical?_:0,B=[T.leftJustifiedTextSymbolIndex,T.centerJustifiedTextSymbolIndex,T.rightJustifiedTextSymbolIndex];for(const F of B)h.text.placedSymbolArray.get(F).placedOrientation=C;T.verticalPlacedTextSymbolIndex&&(h.text.placedSymbolArray.get(T.verticalPlacedTextSymbolIndex).placedOrientation=k)}commit(h){this.commitTime=h,this.zoomAtLastRecencyCheck=this.transform.zoom;const _=this.prevPlacement;let T=!1;this.prevZoomAdjustment=_?_.zoomAdjustment(this.transform.zoom):0;const C=_?_.symbolFadeChange(h):1,k=_?_.opacities:{},B=_?_.variableOffsets:{},F=_?_.placedOrientations:{};for(const V in this.placements){const Z=this.placements[V],X=k[V];X?(this.opacities[V]=new xn(X,C,Z.text,Z.icon,null,Z.clipped),T=T||Z.text!==X.text.placed||Z.icon!==X.icon.placed):(this.opacities[V]=new xn(null,C,Z.text,Z.icon,Z.skipFade,Z.clipped),T=T||Z.text||Z.icon)}for(const V in k){const Z=k[V];if(!this.opacities[V]){const X=new xn(Z,C,!1,!1);X.isHidden()||(this.opacities[V]=X,T=T||Z.text.placed||Z.icon.placed)}}for(const V in B)this.variableOffsets[V]||!this.opacities[V]||this.opacities[V].isHidden()||(this.variableOffsets[V]=B[V]);for(const V in F)this.placedOrientations[V]||!this.opacities[V]||this.opacities[V].isHidden()||(this.placedOrientations[V]=F[V]);T?this.lastPlacementChangeTime=h:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=_?_.lastPlacementChangeTime:h)}updateLayerOpacities(h,_){const T={};for(const C of _){const k=C.getBucket(h);k&&C.latestFeatureIndex&&h.id===k.layerIds[0]&&this.updateBucketOpacities(k,T,C.collisionBoxArray)}}updateBucketOpacities(h,_,T){h.hasTextData()&&h.text.opacityVertexArray.clear(),h.hasIconData()&&h.icon.opacityVertexArray.clear(),h.hasIconCollisionBoxData()&&h.iconCollisionBox.collisionVertexArray.clear(),h.hasTextCollisionBoxData()&&h.textCollisionBox.collisionVertexArray.clear();const C=h.layers[0].layout,k=!!h.layers[0].dynamicFilter(),B=new xn(null,0,!1,!1,!0),F=C.get("text-allow-overlap"),V=C.get("icon-allow-overlap"),Z=C.get("text-variable-anchor"),X=C.get("text-rotation-alignment")==="map",te=C.get("text-pitch-alignment")==="map",le=C.get("icon-text-fit")!=="none",ge=new xn(null,0,F&&(V||!h.hasIconData()||C.get("icon-optional")),V&&(F||!h.hasTextData()||C.get("text-optional")),!0);!h.collisionArrays&&T&&(h.hasIconCollisionBoxData()||h.hasTextCollisionBoxData())&&h.deserializeCollisionBoxes(T);const de=(Se,xe,Te)=>{for(let Me=0;Me<xe/4;Me++)Se.opacityVertexArray.emplaceBack(Te)};let se=0;for(let Se=0;Se<h.symbolInstances.length;Se++){const xe=h.symbolInstances.get(Se),{numHorizontalGlyphVertices:Te,numVerticalGlyphVertices:Me,crossTileID:Ae}=xe;let Ee=this.opacities[Ae];_[Ae]?Ee=B:Ee||(Ee=ge,this.opacities[Ae]=Ee),_[Ae]=!0;const De=Te>0||Me>0,Ue=xe.numIconVertices>0,Ze=this.placedOrientations[xe.crossTileID],He=Ze===u.WritingMode.vertical,Ye=Ze===u.WritingMode.horizontal||Ze===u.WritingMode.horizontalOnly;if(!De&&!Ue||Ee.isHidden()||se++,De){const ct=Ll(Ee.text);de(h.text,Te,He?Ms:ct),de(h.text,Me,Ye?Ms:ct);const Ve=Ee.text.isHidden();[xe.rightJustifiedTextSymbolIndex,xe.centerJustifiedTextSymbolIndex,xe.leftJustifiedTextSymbolIndex].forEach(Dt=>{Dt>=0&&(h.text.placedSymbolArray.get(Dt).hidden=Ve||He?1:0)}),xe.verticalPlacedTextSymbolIndex>=0&&(h.text.placedSymbolArray.get(xe.verticalPlacedTextSymbolIndex).hidden=Ve||Ye?1:0);const ht=this.variableOffsets[xe.crossTileID];ht&&this.markUsedJustification(h,ht.anchor,xe,Ze);const at=this.placedOrientations[xe.crossTileID];at&&(this.markUsedJustification(h,"left",xe,at),this.markUsedOrientation(h,at,xe))}if(Ue){const ct=Ll(Ee.icon);xe.placedIconSymbolIndex>=0&&(de(h.icon,xe.numIconVertices,He?Ms:ct),h.icon.placedSymbolArray.get(xe.placedIconSymbolIndex).hidden=Ee.icon.isHidden()),xe.verticalPlacedIconSymbolIndex>=0&&(de(h.icon,xe.numVerticalIconVertices,Ye?Ms:ct),h.icon.placedSymbolArray.get(xe.verticalPlacedIconSymbolIndex).hidden=Ee.icon.isHidden())}if(h.hasIconCollisionBoxData()||h.hasTextCollisionBoxData()){const ct=h.collisionArrays[Se];if(ct){let Ve=new u.pointGeometry(0,0),ht=!0;if(ct.textBox||ct.verticalTextBox){if(Z){const Dt=this.variableOffsets[Ae];Dt?(Ve=fo(Dt.anchor,Dt.width,Dt.height,Dt.textOffset,Dt.textScale),X&&Ve._rotate(te?this.transform.angle:-this.transform.angle)):ht=!1}k&&(ht=!Ee.clipped),ct.textBox&&cn(h.textCollisionBox.collisionVertexArray,Ee.text.placed,!ht||He,Ve.x,Ve.y),ct.verticalTextBox&&cn(h.textCollisionBox.collisionVertexArray,Ee.text.placed,!ht||Ye,Ve.x,Ve.y)}const at=ht&&Boolean(!Ye&&ct.verticalIconBox);ct.iconBox&&cn(h.iconCollisionBox.collisionVertexArray,Ee.icon.placed,at,le?Ve.x:0,le?Ve.y:0),ct.verticalIconBox&&cn(h.iconCollisionBox.collisionVertexArray,Ee.icon.placed,!at,le?Ve.x:0,le?Ve.y:0)}}}if(h.fullyClipped=se===0,h.sortFeatures(this.transform.angle),this.retainedQueryData[h.bucketInstanceId]&&(this.retainedQueryData[h.bucketInstanceId].featureSortOrder=h.featureSortOrder),h.hasTextData()&&h.text.opacityVertexBuffer&&h.text.opacityVertexBuffer.updateData(h.text.opacityVertexArray),h.hasIconData()&&h.icon.opacityVertexBuffer&&h.icon.opacityVertexBuffer.updateData(h.icon.opacityVertexArray),h.hasIconCollisionBoxData()&&h.iconCollisionBox.collisionVertexBuffer&&h.iconCollisionBox.collisionVertexBuffer.updateData(h.iconCollisionBox.collisionVertexArray),h.hasTextCollisionBoxData()&&h.textCollisionBox.collisionVertexBuffer&&h.textCollisionBox.collisionVertexBuffer.updateData(h.textCollisionBox.collisionVertexArray),h.bucketInstanceId in this.collisionCircleArrays){const Se=this.collisionCircleArrays[h.bucketInstanceId];h.placementInvProjMatrix=Se.invProjMatrix,h.placementViewportMatrix=Se.viewportMatrix,h.collisionCircleArray=Se.circles,delete this.collisionCircleArrays[h.bucketInstanceId]}}symbolFadeChange(h){return this.fadeDuration===0?1:(h-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(h){return Math.max(0,(this.transform.zoom-h)/1.5)}hasTransitions(h){return this.stale||h-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(h,_){const T=this.zoomAtLastRecencyCheck===_?1-this.zoomAdjustment(_):1;return this.zoomAtLastRecencyCheck=_,this.commitTime+this.fadeDuration*T>h}setStale(){this.stale=!0}}function cn(x,h,_,T,C){x.emplaceBack(h?1:0,_?1:0,T||0,C||0),x.emplaceBack(h?1:0,_?1:0,T||0,C||0),x.emplaceBack(h?1:0,_?1:0,T||0,C||0),x.emplaceBack(h?1:0,_?1:0,T||0,C||0)}const sh=Math.pow(2,25),Rl=Math.pow(2,24),Or=Math.pow(2,17),Es=Math.pow(2,16),Cn=Math.pow(2,9),va=Math.pow(2,8),Ts=Math.pow(2,1);function Ll(x){if(x.opacity===0&&!x.placed)return 0;if(x.opacity===1&&x.placed)return 4294967295;const h=x.placed?1:0,_=Math.floor(127*x.opacity);return _*sh+h*Rl+_*Or+h*Es+_*Cn+h*va+_*Ts+h}const Ms=0;class ba{constructor(h){this._sortAcrossTiles=h.layout.get("symbol-z-order")!=="viewport-y"&&h.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(h,_,T,C,k){const B=this._bucketParts;for(;this._currentTileIndex<h.length;)if(_.getBucketParts(B,C,h[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,k())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,B.sort((F,V)=>F.sortKey-V.sortKey));this._currentPartIndex<B.length;){const F=B[this._currentPartIndex];if(_.placeLayerBucketPart(F,this._seenCrossTileIDs,T,F.symbolInstanceStart===0),this._currentPartIndex++,k())return!0}return!1}}class ah{constructor(h,_,T,C,k,B,F,V){this.placement=new oh(h,k,B,F,V),this._currentPlacementIndex=_.length-1,this._forceFullPlacement=T,this._showCollisionBoxes=C,this._done=!1}isDone(){return this._done}continuePlacement(h,_,T){const C=u.exported.now(),k=()=>{const B=u.exported.now()-C;return!this._forceFullPlacement&&B>2};for(;this._currentPlacementIndex>=0;){const B=_[h[this._currentPlacementIndex]],F=this.placement.collisionIndex.transform.zoom;if(B.type==="symbol"&&(!B.minzoom||B.minzoom<=F)&&(!B.maxzoom||B.maxzoom>F)){if(this._inProgressLayer||(this._inProgressLayer=new ba(B)),this._inProgressLayer.continuePlacement(T[B.source],this.placement,this._showCollisionBoxes,B,k))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(h){return this.placement.commit(h),this.placement}}const zl=512/u.EXTENT/2;class lh{constructor(h,_,T){this.tileID=h,this.indexedSymbolInstances={},this.bucketInstanceId=T;for(let C=0;C<_.length;C++){const k=_.get(C),B=k.key;this.indexedSymbolInstances[B]||(this.indexedSymbolInstances[B]=[]),this.indexedSymbolInstances[B].push({crossTileID:k.crossTileID,coord:this.getScaledCoordinates(k,h)})}}getScaledCoordinates(h,_){const T=zl/Math.pow(2,_.canonical.z-this.tileID.canonical.z);return{x:Math.floor((_.canonical.x*u.EXTENT+h.tileAnchorX)*T),y:Math.floor((_.canonical.y*u.EXTENT+h.tileAnchorY)*T)}}findMatches(h,_,T){const C=this.tileID.canonical.z<_.canonical.z?1:Math.pow(2,this.tileID.canonical.z-_.canonical.z);for(let k=0;k<h.length;k++){const B=h.get(k);if(B.crossTileID)continue;const F=this.indexedSymbolInstances[B.key];if(!F)continue;const V=this.getScaledCoordinates(B,_);for(const Z of F)if(Math.abs(Z.coord.x-V.x)<=C&&Math.abs(Z.coord.y-V.y)<=C&&!T[Z.crossTileID]){T[Z.crossTileID]=!0,B.crossTileID=Z.crossTileID;break}}}}class Fl{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class ch{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(h){const _=Math.round((h-this.lng)/360);if(_!==0)for(const T in this.indexes){const C=this.indexes[T],k={};for(const B in C){const F=C[B];F.tileID=F.tileID.unwrapTo(F.tileID.wrap+_),k[F.tileID.key]=F}this.indexes[T]=k}this.lng=h}addBucket(h,_,T){if(this.indexes[h.overscaledZ]&&this.indexes[h.overscaledZ][h.key]){if(this.indexes[h.overscaledZ][h.key].bucketInstanceId===_.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(h.overscaledZ,this.indexes[h.overscaledZ][h.key])}for(let k=0;k<_.symbolInstances.length;k++)_.symbolInstances.get(k).crossTileID=0;this.usedCrossTileIDs[h.overscaledZ]||(this.usedCrossTileIDs[h.overscaledZ]={});const C=this.usedCrossTileIDs[h.overscaledZ];for(const k in this.indexes){const B=this.indexes[k];if(Number(k)>h.overscaledZ)for(const F in B){const V=B[F];V.tileID.isChildOf(h)&&V.findMatches(_.symbolInstances,h,C)}else{const F=B[h.scaledTo(Number(k)).key];F&&F.findMatches(_.symbolInstances,h,C)}}for(let k=0;k<_.symbolInstances.length;k++){const B=_.symbolInstances.get(k);B.crossTileID||(B.crossTileID=T.generate(),C[B.crossTileID]=!0)}return this.indexes[h.overscaledZ]===void 0&&(this.indexes[h.overscaledZ]={}),this.indexes[h.overscaledZ][h.key]=new lh(h,_.symbolInstances,_.bucketInstanceId),!0}removeBucketCrossTileIDs(h,_){for(const T in _.indexedSymbolInstances)for(const C of _.indexedSymbolInstances[T])delete this.usedCrossTileIDs[h][C.crossTileID]}removeStaleBuckets(h){let _=!1;for(const T in this.indexes){const C=this.indexes[T];for(const k in C)h[C[k].bucketInstanceId]||(this.removeBucketCrossTileIDs(T,C[k]),delete C[k],_=!0)}return _}}class Ss{constructor(){this.layerIndexes={},this.crossTileIDs=new Fl,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(h,_,T,C){let k=this.layerIndexes[h.id];k===void 0&&(k=this.layerIndexes[h.id]=new ch);let B=!1;const F={};C.name!=="globe"&&k.handleWrapJump(T);for(const V of _){const Z=V.getBucket(h);Z&&h.id===Z.layerIds[0]&&(Z.bucketInstanceId||(Z.bucketInstanceId=++this.maxBucketInstanceId),k.addBucket(V.tileID,Z,this.crossTileIDs)&&(B=!0),F[Z.bucketInstanceId]=!0)}return k.removeStaleBuckets(F)&&(B=!0),B}pruneUnusedLayers(h){const _={};h.forEach(T=>{_[T]=!0});for(const T in this.layerIndexes)_[T]||delete this.layerIndexes[T]}}const $o=(x,h)=>u.emitValidationErrors(x,h&&h.filter(_=>_.identifier!=="source.canvas")),Ol=u.pick(St,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Nl=u.pick(St,["setCenter","setZoom","setBearing","setPitch"]),$l={version:8,layers:[],sources:{}},Wn={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class Ir extends u.Evented{constructor(h,_={}){super(),this.map=h,this.dispatcher=new ot(Wt(),this),this.imageManager=new ue,this.imageManager.setEventedParent(this),this.glyphManager=new u.GlyphManager(h._requestManager,_.localFontFamily?u.LocalGlyphMode.all:_.localIdeographFontFamily?u.LocalGlyphMode.ideographs:u.LocalGlyphMode.none,_.localFontFamily||_.localIdeographFontFamily),this.lineAtlas=new u.LineAtlas(256,512),this.crossTileSymbolIndex=new Ss,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new u.ZoomHistory,this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",u.getReferrer());const T=this;this._rtlTextPluginCallback=Ir.registerForPluginStateChange(C=>{T.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:C.pluginStatus,pluginURL:C.pluginURL},(k,B)=>{if(u.triggerPluginCompletionEvent(k),B&&B.every(F=>F))for(const F in T._sourceCaches){const V=T._sourceCaches[F],Z=V.getSource().type;Z!=="vector"&&Z!=="geojson"||V.reload()}})}),this.on("data",C=>{if(C.dataType!=="source"||C.sourceDataType!=="metadata")return;const k=this.getSource(C.sourceId);if(k&&k.vectorLayerIds)for(const B in this._layers){const F=this._layers[B];F.source===k.id&&this._validateLayer(F)}})}loadURL(h,_={}){this.fire(new u.Event("dataloading",{dataType:"style"}));const T=typeof _.validate=="boolean"?_.validate:!u.isMapboxURL(h);h=this.map._requestManager.normalizeStyleURL(h,_.accessToken);const C=this.map._requestManager.transformRequest(h,u.ResourceType.Style);this._request=u.getJSON(C,(k,B)=>{this._request=null,k?this.fire(new u.ErrorEvent(k)):B&&this._load(B,T)})}loadJSON(h,_={}){this.fire(new u.Event("dataloading",{dataType:"style"})),this._request=u.exported.frame(()=>{this._request=null,this._load(h,_.validate!==!1)})}loadEmpty(){this.fire(new u.Event("dataloading",{dataType:"style"})),this._load($l,!1)}_updateLayerCount(h,_){const T=_?1:-1;h.is3D()&&(this._num3DLayers+=T),h.type==="circle"&&(this._numCircleLayers+=T),h.type==="symbol"&&(this._numSymbolLayers+=T)}_load(h,_){if(_&&$o(this,u.validateStyle(h)))return;this._loaded=!0,this.stylesheet=h,this._updateMapProjection();for(const C in h.sources)this.addSource(C,h.sources[C],{validate:!1});this._changed=!1,h.sprite?this._loadSprite(h.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(h.glyphs);const T=Ti(this.stylesheet.layers);this._order=T.map(C=>C.id),this._layers={},this._serializedLayers={};for(let C of T)C=u.createStyleLayer(C),C.setEventedParent(this,{layer:{id:C.id}}),this._layers[C.id]=C,this._serializedLayers[C.id]=C.serialize(),this._updateLayerCount(C,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new it(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new u.Event("data",{dataType:"style"})),this.fire(new u.Event("style.load"))}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}setProjection(h){h?this.stylesheet.projection=h:delete this.stylesheet.projection,this.map._explicitProjection||this.map._updateProjection()}_updateMapProjection(){this.map._explicitProjection?this.applyProjectionUpdate():this.map._updateProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_loadSprite(h){this._spriteRequest=function(_,T,C){let k,B,F;const V=u.exported.devicePixelRatio>1?"@2x":"";let Z=u.getJSON(T.transformRequest(T.normalizeSpriteURL(_,V,".json"),u.ResourceType.SpriteJSON),(le,ge)=>{Z=null,F||(F=le,k=ge,te())}),X=u.getImage(T.transformRequest(T.normalizeSpriteURL(_,V,".png"),u.ResourceType.SpriteImage),(le,ge)=>{X=null,F||(F=le,B=ge,te())});function te(){if(F)C(F);else if(k&&B){const le=u.exported.getImageData(B),ge={};for(const de in k){const{width:se,height:Se,x:xe,y:Te,sdf:Me,pixelRatio:Ae,stretchX:Ee,stretchY:De,content:Ue}=k[de],Ze=new u.RGBAImage({width:se,height:Se});u.RGBAImage.copy(le,Ze,{x:xe,y:Te},{x:0,y:0},{width:se,height:Se}),ge[de]={data:Ze,pixelRatio:Ae,sdf:Me,stretchX:Ee,stretchY:De,content:Ue}}C(null,ge)}}return{cancel(){Z&&(Z.cancel(),Z=null),X&&(X.cancel(),X=null)}}}(h,this.map._requestManager,(_,T)=>{if(this._spriteRequest=null,_)this.fire(new u.ErrorEvent(_));else if(T)for(const C in T)this.imageManager.addImage(C,T[C]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new u.Event("data",{dataType:"style"}))})}_validateLayer(h){const _=this.getSource(h.source);if(!_)return;const T=h.sourceLayer;T&&(_.type==="geojson"||_.vectorLayerIds&&_.vectorLayerIds.indexOf(T)===-1)&&this.fire(new u.ErrorEvent(new Error(`Source layer "${T}" does not exist on source "${_.id}" as specified by style layer "${h.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const h in this._sourceCaches)if(!this._sourceCaches[h].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(h){const _=[];for(const T of h){const C=this._layers[T];C.type!=="custom"&&_.push(C.serialize())}return _}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const h in this._sourceCaches)if(this._sourceCaches[h].hasTransition())return!0;for(const h in this._layers)if(this._layers[h].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(h){return!!this.terrain&&Wn[h.type]}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(h){if(!this._loaded)return;const _=this._changed;if(this._changed){const C=Object.keys(this._updatedLayers),k=Object.keys(this._removedLayers);(C.length||k.length)&&this._updateWorkerLayers(C,k);for(const B in this._updatedSources){const F=this._updatedSources[B];F==="reload"?this._reloadSource(B):F==="clear"&&this._clearSource(B)}this._updateTilesForChangedImages();for(const B in this._updatedPaintProps)this._layers[B].updateTransitions(h);this.light.updateTransitions(h),this.fog&&this.fog.updateTransitions(h),this._resetUpdates()}const T={};for(const C in this._sourceCaches){const k=this._sourceCaches[C];T[C]=k.used,k.used=!1}for(const C of this._order){const k=this._layers[C];if(k.recalculate(h,this._availableImages),!k.isHidden(h.zoom)){const F=this._getLayerSourceCache(k);F&&(F.used=!0)}const B=this.map.painter;if(B){const F=k.getProgramIds();if(!F)continue;const V=k.getProgramConfiguration(h.zoom);for(const Z of F)B.useProgram(Z,V)}}for(const C in T){const k=this._sourceCaches[C];T[C]!==k.used&&k.getSource().fire(new u.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:k.getSource().id}))}this.light.recalculate(h),this.terrain&&this.terrain.recalculate(h),this.fog&&this.fog.recalculate(h),this.z=h.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),_&&this.fire(new u.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const h=Object.keys(this._changedImages);if(h.length){for(const _ in this._sourceCaches)this._sourceCaches[_].reloadTilesForDependencies(["icons","patterns"],h);this._changedImages={}}}_updateWorkerLayers(h,_){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(h),removedIds:_})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(h){if(this._checkLoaded(),$o(this,u.validateStyle(h)))return!1;(h=u.clone$1(h)).layers=Ti(h.layers);const _=function(C,k){if(!C)return[{command:St.setStyle,args:[k]}];let B=[];try{if(!z(C.version,k.version))return[{command:St.setStyle,args:[k]}];z(C.center,k.center)||B.push({command:St.setCenter,args:[k.center]}),z(C.zoom,k.zoom)||B.push({command:St.setZoom,args:[k.zoom]}),z(C.bearing,k.bearing)||B.push({command:St.setBearing,args:[k.bearing]}),z(C.pitch,k.pitch)||B.push({command:St.setPitch,args:[k.pitch]}),z(C.sprite,k.sprite)||B.push({command:St.setSprite,args:[k.sprite]}),z(C.glyphs,k.glyphs)||B.push({command:St.setGlyphs,args:[k.glyphs]}),z(C.transition,k.transition)||B.push({command:St.setTransition,args:[k.transition]}),z(C.light,k.light)||B.push({command:St.setLight,args:[k.light]}),z(C.fog,k.fog)||B.push({command:St.setFog,args:[k.fog]}),z(C.projection,k.projection)||B.push({command:St.setProjection,args:[k.projection]});const F={},V=[];(function(te,le,ge,de){let se;for(se in le=le||{},te=te||{})te.hasOwnProperty(se)&&(le.hasOwnProperty(se)||ki(se,ge,de));for(se in le)le.hasOwnProperty(se)&&(te.hasOwnProperty(se)?z(te[se],le[se])||(te[se].type==="geojson"&&le[se].type==="geojson"&&yn(te,le,se)?ge.push({command:St.setGeoJSONSourceData,args:[se,le[se].data]}):Xr(se,le,ge,de)):Ai(se,le,ge))})(C.sources,k.sources,V,F);const Z=[];C.layers&&C.layers.forEach(te=>{te.source&&F[te.source]?B.push({command:St.removeLayer,args:[te.id]}):Z.push(te)});let X=C.terrain;X&&F[X.source]&&(B.push({command:St.setTerrain,args:[void 0]}),X=void 0),B=B.concat(V),z(X,k.terrain)||B.push({command:St.setTerrain,args:[k.terrain]}),function(te,le,ge){le=le||[];const de=(te=te||[]).map(Mi),se=le.map(Mi),Se=te.reduce(xi,{}),xe=le.reduce(xi,{}),Te=de.slice(),Me=Object.create(null);let Ae,Ee,De,Ue,Ze,He,Ye;for(Ae=0,Ee=0;Ae<de.length;Ae++)De=de[Ae],xe.hasOwnProperty(De)?Ee++:(ge.push({command:St.removeLayer,args:[De]}),Te.splice(Te.indexOf(De,Ee),1));for(Ae=0,Ee=0;Ae<se.length;Ae++)De=se[se.length-1-Ae],Te[Te.length-1-Ae]!==De&&(Se.hasOwnProperty(De)?(ge.push({command:St.removeLayer,args:[De]}),Te.splice(Te.lastIndexOf(De,Te.length-Ee),1)):Ee++,He=Te[Te.length-Ae],ge.push({command:St.addLayer,args:[xe[De],He]}),Te.splice(Te.length-Ae,0,De),Me[De]=!0);for(Ae=0;Ae<se.length;Ae++)if(De=se[Ae],Ue=Se[De],Ze=xe[De],!Me[De]&&!z(Ue,Ze))if(z(Ue.source,Ze.source)&&z(Ue["source-layer"],Ze["source-layer"])&&z(Ue.type,Ze.type)){for(Ye in xt(Ue.layout,Ze.layout,ge,De,null,St.setLayoutProperty),xt(Ue.paint,Ze.paint,ge,De,null,St.setPaintProperty),z(Ue.filter,Ze.filter)||ge.push({command:St.setFilter,args:[De,Ze.filter]}),z(Ue.minzoom,Ze.minzoom)&&z(Ue.maxzoom,Ze.maxzoom)||ge.push({command:St.setLayerZoomRange,args:[De,Ze.minzoom,Ze.maxzoom]}),Ue)Ue.hasOwnProperty(Ye)&&Ye!=="layout"&&Ye!=="paint"&&Ye!=="filter"&&Ye!=="metadata"&&Ye!=="minzoom"&&Ye!=="maxzoom"&&(Ye.indexOf("paint.")===0?xt(Ue[Ye],Ze[Ye],ge,De,Ye.slice(6),St.setPaintProperty):z(Ue[Ye],Ze[Ye])||ge.push({command:St.setLayerProperty,args:[De,Ye,Ze[Ye]]}));for(Ye in Ze)Ze.hasOwnProperty(Ye)&&!Ue.hasOwnProperty(Ye)&&Ye!=="layout"&&Ye!=="paint"&&Ye!=="filter"&&Ye!=="metadata"&&Ye!=="minzoom"&&Ye!=="maxzoom"&&(Ye.indexOf("paint.")===0?xt(Ue[Ye],Ze[Ye],ge,De,Ye.slice(6),St.setPaintProperty):z(Ue[Ye],Ze[Ye])||ge.push({command:St.setLayerProperty,args:[De,Ye,Ze[Ye]]}))}else ge.push({command:St.removeLayer,args:[De]}),He=Te[Te.lastIndexOf(De)+1],ge.push({command:St.addLayer,args:[Ze,He]})}(Z,k.layers,B)}catch(F){console.warn("Unable to compute style diff:",F),B=[{command:St.setStyle,args:[k]}]}return B}(this.serialize(),h).filter(C=>!(C.command in Nl));if(_.length===0)return!1;const T=_.filter(C=>!(C.command in Ol));if(T.length>0)throw new Error(`Unimplemented: ${T.map(C=>C.command).join(", ")}.`);return _.forEach(C=>{C.command!=="setTransition"&&this[C.command].apply(this,C.args)}),this.stylesheet=h,this._updateMapProjection(),!0}addImage(h,_){return this.getImage(h)?this.fire(new u.ErrorEvent(new Error("An image with this name already exists."))):(this.imageManager.addImage(h,_),this._afterImageUpdated(h),this)}updateImage(h,_){this.imageManager.updateImage(h,_)}getImage(h){return this.imageManager.getImage(h)}removeImage(h){return this.getImage(h)?(this.imageManager.removeImage(h),this._afterImageUpdated(h),this):this.fire(new u.ErrorEvent(new Error("No image with this name exists.")))}_afterImageUpdated(h){this._availableImages=this.imageManager.listImages(),this._changedImages[h]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new u.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(h,_,T={}){if(this._checkLoaded(),this.getSource(h)!==void 0)throw new Error("There is already a source with this ID");if(!_.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(_).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(_.type)>=0&&this._validate(u.validateSource,`sources.${h}`,_,null,T))return;this.map&&this.map._collectResourceTiming&&(_.collectResourceTiming=!0);const C=ze(h,_,this.dispatcher,this);C.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(h),source:C.serialize(),sourceId:h}));const k=B=>{const F=(B?"symbol:":"other:")+h,V=this._sourceCaches[F]=new u.SourceCache(F,C,B);(B?this._symbolSourceCaches:this._otherSourceCaches)[h]=V,V.style=this,V.onAdd(this.map)};k(!1),_.type!=="vector"&&_.type!=="geojson"||k(!0),C.onAdd&&C.onAdd(this.map),this._changed=!0}removeSource(h){this._checkLoaded();const _=this.getSource(h);if(!_)throw new Error("There is no source with this ID");for(const C in this._layers)if(this._layers[C].source===h)return this.fire(new u.ErrorEvent(new Error(`Source "${h}" cannot be removed while layer "${C}" is using it.`)));if(this.terrain&&this.terrain.get().source===h)return this.fire(new u.ErrorEvent(new Error(`Source "${h}" cannot be removed while terrain is using it.`)));const T=this._getSourceCaches(h);for(const C of T)delete this._sourceCaches[C.id],delete this._updatedSources[C.id],C.fire(new u.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:C.getSource().id})),C.setEventedParent(null),C.clearTiles();return delete this._otherSourceCaches[h],delete this._symbolSourceCaches[h],_.setEventedParent(null),_.onRemove&&_.onRemove(this.map),this._changed=!0,this}setGeoJSONSourceData(h,_){this._checkLoaded(),this.getSource(h).setData(_),this._changed=!0}getSource(h){const _=this._getSourceCache(h);return _&&_.getSource()}addLayer(h,_,T={}){this._checkLoaded();const C=h.id;if(this.getLayer(C))return void this.fire(new u.ErrorEvent(new Error(`Layer with id "${C}" already exists on this map`)));let k;if(h.type==="custom"){if($o(this,u.validateCustomStyleLayer(h)))return;k=u.createStyleLayer(h)}else{if(typeof h.source=="object"&&(this.addSource(C,h.source),h=u.clone$1(h),h=u.extend(h,{source:C})),this._validate(u.validateLayer,`layers.${C}`,h,{arrayIndex:-1},T))return;k=u.createStyleLayer(h),this._validateLayer(k),k.setEventedParent(this,{layer:{id:C}}),this._serializedLayers[k.id]=k.serialize(),this._updateLayerCount(k,!0)}const B=_?this._order.indexOf(_):this._order.length;if(_&&B===-1)return void this.fire(new u.ErrorEvent(new Error(`Layer with id "${_}" does not exist on this map.`)));this._order.splice(B,0,C),this._layerOrderChanged=!0,this._layers[C]=k;const F=this._getLayerSourceCache(k);if(this._removedLayers[C]&&k.source&&F&&k.type!=="custom"){const V=this._removedLayers[C];delete this._removedLayers[C],V.type!==k.type?this._updatedSources[k.source]="clear":(this._updatedSources[k.source]="reload",F.pause())}this._updateLayer(k),k.onAdd&&k.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(h,_){if(this._checkLoaded(),this._changed=!0,!this._layers[h])return void this.fire(new u.ErrorEvent(new Error(`The layer '${h}' does not exist in the map's style and cannot be moved.`)));if(h===_)return;const T=this._order.indexOf(h);this._order.splice(T,1);const C=_?this._order.indexOf(_):this._order.length;_&&C===-1?this.fire(new u.ErrorEvent(new Error(`Layer with id "${_}" does not exist on this map.`))):(this._order.splice(C,0,h),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(h){this._checkLoaded();const _=this._layers[h];if(!_)return void this.fire(new u.ErrorEvent(new Error(`The layer '${h}' does not exist in the map's style and cannot be removed.`)));_.setEventedParent(null),this._updateLayerCount(_,!1);const T=this._order.indexOf(h);this._order.splice(T,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[h]=_,delete this._layers[h],delete this._serializedLayers[h],delete this._updatedLayers[h],delete this._updatedPaintProps[h],_.onRemove&&_.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(h){return this._layers[h]}hasLayer(h){return h in this._layers}hasLayerType(h){for(const _ in this._layers)if(this._layers[_].type===h)return!0;return!1}setLayerZoomRange(h,_,T){this._checkLoaded();const C=this.getLayer(h);C?C.minzoom===_&&C.maxzoom===T||(_!=null&&(C.minzoom=_),T!=null&&(C.maxzoom=T),this._updateLayer(C)):this.fire(new u.ErrorEvent(new Error(`The layer '${h}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(h,_,T={}){this._checkLoaded();const C=this.getLayer(h);if(C){if(!z(C.filter,_))return _==null?(C.filter=void 0,void this._updateLayer(C)):void(this._validate(u.validateFilter,`layers.${C.id}.filter`,_,{layerType:C.type},T)||(C.filter=u.clone$1(_),this._updateLayer(C)))}else this.fire(new u.ErrorEvent(new Error(`The layer '${h}' does not exist in the map's style and cannot be filtered.`)))}getFilter(h){const _=this.getLayer(h);return _&&u.clone$1(_.filter)}setLayoutProperty(h,_,T,C={}){this._checkLoaded();const k=this.getLayer(h);k?z(k.getLayoutProperty(_),T)||(k.setLayoutProperty(_,T,C),this._updateLayer(k)):this.fire(new u.ErrorEvent(new Error(`The layer '${h}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(h,_){const T=this.getLayer(h);if(T)return T.getLayoutProperty(_);this.fire(new u.ErrorEvent(new Error(`The layer '${h}' does not exist in the map's style.`)))}setPaintProperty(h,_,T,C={}){this._checkLoaded();const k=this.getLayer(h);k?z(k.getPaintProperty(_),T)||(k.setPaintProperty(_,T,C)&&this._updateLayer(k),this._changed=!0,this._updatedPaintProps[h]=!0):this.fire(new u.ErrorEvent(new Error(`The layer '${h}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(h,_){const T=this.getLayer(h);return T&&T.getPaintProperty(_)}setFeatureState(h,_){this._checkLoaded();const T=h.source,C=h.sourceLayer,k=this.getSource(T);if(!k)return void this.fire(new u.ErrorEvent(new Error(`The source '${T}' does not exist in the map's style.`)));const B=k.type;if(B==="geojson"&&C)return void this.fire(new u.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(B==="vector"&&!C)return void this.fire(new u.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));h.id===void 0&&this.fire(new u.ErrorEvent(new Error("The feature id parameter must be provided.")));const F=this._getSourceCaches(T);for(const V of F)V.setFeatureState(C,h.id,_)}removeFeatureState(h,_){this._checkLoaded();const T=h.source,C=this.getSource(T);if(!C)return void this.fire(new u.ErrorEvent(new Error(`The source '${T}' does not exist in the map's style.`)));const k=C.type,B=k==="vector"?h.sourceLayer:void 0;if(k==="vector"&&!B)return void this.fire(new u.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(_&&typeof h.id!="string"&&typeof h.id!="number")return void this.fire(new u.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const F=this._getSourceCaches(T);for(const V of F)V.removeFeatureState(B,h.id,_)}getFeatureState(h){this._checkLoaded();const _=h.source,T=h.sourceLayer,C=this.getSource(_);if(C){if(C.type!=="vector"||T)return h.id===void 0&&this.fire(new u.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(_)[0].getFeatureState(T,h.id);this.fire(new u.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new u.ErrorEvent(new Error(`The source '${_}' does not exist in the map's style.`)))}getTransition(){return u.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const h={};for(const _ in this._sourceCaches){const T=this._sourceCaches[_].getSource();h[T.id]||(h[T.id]=T.serialize())}return u.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.stylesheet.terrain,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:h,layers:this._serializeLayers(this._order)},_=>_!==void 0)}_updateLayer(h){this._updatedLayers[h.id]=!0;const _=this._getLayerSourceCache(h);h.source&&!this._updatedSources[h.source]&&_&&_.getSource().type!=="raster"&&(this._updatedSources[h.source]="reload",_.pause()),this._changed=!0,h.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(h){const _=B=>this._layers[B].type==="fill-extrusion",T={},C=[];for(let B=this._order.length-1;B>=0;B--){const F=this._order[B];if(_(F)){T[F]=B;for(const V of h){const Z=V[F];if(Z)for(const X of Z)C.push(X)}}}C.sort((B,F)=>F.intersectionZ-B.intersectionZ);const k=[];for(let B=this._order.length-1;B>=0;B--){const F=this._order[B];if(_(F))for(let V=C.length-1;V>=0;V--){const Z=C[V].feature;if(T[Z.layer.id]<B)break;k.push(Z),C.pop()}else for(const V of h){const Z=V[F];if(Z)for(const X of Z)k.push(X.feature)}}return k}queryRenderedFeatures(h,_,T){_&&_.filter&&this._validate(u.validateFilter,"queryRenderedFeatures.filter",_.filter,null,_);const C={};if(_&&_.layers){if(!Array.isArray(_.layers))return this.fire(new u.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const V of _.layers){const Z=this._layers[V];if(!Z)return this.fire(new u.ErrorEvent(new Error(`The layer '${V}' does not exist in the map's style and cannot be queried for features.`))),[];C[Z.source]=!0}}const k=[];_.availableImages=this._availableImages;const B=_&&_.layers?_.layers.some(V=>{const Z=this.getLayer(V);return Z&&Z.is3D()}):this.has3DLayers(),F=pt.createFromScreenPoints(h,T);for(const V in this._sourceCaches){const Z=this._sourceCaches[V].getSource().id;_.layers&&!C[Z]||k.push(je(this._sourceCaches[V],this._layers,this._serializedLayers,F,_,T,B,!!this.map._showQueryGeometry))}return this.placement&&k.push(function(V,Z,X,te,le,ge,de){const se={},Se=ge.queryRenderedSymbols(te),xe=[];for(const Te of Object.keys(Se).map(Number))xe.push(de[Te]);xe.sort(ut);for(const Te of xe){const Me=Te.featureIndex.lookupSymbolFeatures(Se[Te.bucketInstanceId],Z,Te.bucketIndex,Te.sourceLayerIndex,le.filter,le.layers,le.availableImages,V);for(const Ae in Me){const Ee=se[Ae]=se[Ae]||[],De=Me[Ae];De.sort((Ue,Ze)=>{const He=Te.featureSortOrder;if(He){const Ye=He.indexOf(Ue.featureIndex);return He.indexOf(Ze.featureIndex)-Ye}return Ze.featureIndex-Ue.featureIndex});for(const Ue of De)Ee.push(Ue)}}for(const Te in se)se[Te].forEach(Me=>{const Ae=Me.feature,Ee=X(V[Te]).getFeatureState(Ae.layer["source-layer"],Ae.id);Ae.source=Ae.layer.source,Ae.layer["source-layer"]&&(Ae.sourceLayer=Ae.layer["source-layer"]),Ae.state=Ee});return se}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),F.screenGeometry,_,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(k)}querySourceFeatures(h,_){_&&_.filter&&this._validate(u.validateFilter,"querySourceFeatures.filter",_.filter,null,_);const T=this._getSourceCaches(h);let C=[];for(const k of T)C=C.concat(Ke(k,_));return C}addSourceType(h,_,T){return Ir.getSourceType(h)?T(new Error(`A source type called "${h}" already exists.`)):(Ir.setSourceType(h,_),_.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:h,url:_.workerSourceURL},T):T(null,null))}getLight(){return this.light.getLight()}setLight(h,_={}){this._checkLoaded();const T=this.light.getLight();let C=!1;for(const B in h)if(!z(h[B],T[B])){C=!0;break}if(!C)return;const k={now:u.exported.now(),transition:u.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(h,_),this.light.updateTransitions(k)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(h,_=1){if(this._checkLoaded(),!h)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(_===1){if(typeof h.source=="object"){const T="terrain-dem-src";this.addSource(T,h.source),h=u.clone$1(h),h=u.extend(h,{source:T})}if(this._validate(u.validateTerrain,"terrain",h))return}if(!this.terrain||this.terrain&&_!==this.terrain.drapeRenderMode)this._createTerrain(h,_);else{const T=this.terrain,C=T.get();for(const k in h)if(!z(h[k],C[k])){T.set(h),this.stylesheet.terrain=h;const B={now:u.exported.now(),transition:u.extend({duration:0},this.stylesheet.transition)};T.updateTransitions(B);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(h){const _=this.fog=new Qt(h,this.map.transform);this.stylesheet.fog=h;const T={now:u.exported.now(),transition:u.extend({duration:0},this.stylesheet.transition)};_.updateTransitions(T)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const h of this.map._markers)h._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(h){if(this._checkLoaded(),!h)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const _=this.fog,T=_.get();for(const C in h)if(!z(h[C],T[C])){_.set(h),this.stylesheet.fog=h;const k={now:u.exported.now(),transition:u.extend({duration:0},this.stylesheet.transition)};_.updateTransitions(k);break}}else this._createFog(h);this._markersNeedUpdate=!0}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const h=this._order.filter(T=>this.isLayerDraped(this._layers[T])),_=this._order.filter(T=>!this.isLayerDraped(this._layers[T]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...h),this._drapedFirstOrder.push(..._)}_createTerrain(h,_){const T=this.terrain=new zt(h,_);this.stylesheet.terrain=h,this.dispatcher.broadcast("enableTerrain",!this.terrainSetForDrapingOnly()),this._force3DLayerUpdate();const C={now:u.exported.now(),transition:u.extend({duration:0},this.stylesheet.transition)};T.updateTransitions(C)}_force3DLayerUpdate(){for(const h in this._layers){const _=this._layers[h];_.type==="fill-extrusion"&&this._updateLayer(_)}}_forceSymbolLayerUpdate(){for(const h in this._layers){const _=this._layers[h];_.type==="symbol"&&this._updateLayer(_)}}_validate(h,_,T,C,k={}){return(!k||k.validate!==!1)&&$o(this,h.call(u.validateStyle,u.extend({key:_,style:this.serialize(),value:T,styleSpec:u.spec},C)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),u.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const h in this._layers)this._layers[h].setEventedParent(null);for(const h in this._sourceCaches)this._sourceCaches[h].clearTiles(),this._sourceCaches[h].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(h){const _=this._getSourceCaches(h);for(const T of _)T.clearTiles()}_reloadSource(h){const _=this._getSourceCaches(h);for(const T of _)T.resume(),T.reload()}_updateSources(h){for(const _ in this._sourceCaches)this._sourceCaches[_].update(h)}_generateCollisionBoxes(){for(const h in this._sourceCaches){const _=this._sourceCaches[h];_.resume(),_.reload()}}_updatePlacement(h,_,T,C,k=!1){let B=!1,F=!1;const V={};for(const Z of this._order){const X=this._layers[Z];if(X.type!=="symbol")continue;if(!V[X.source]){const le=this._getLayerSourceCache(X);if(!le)continue;V[X.source]=le.getRenderableIds(!0).map(ge=>le.getTileByID(ge)).sort((ge,de)=>de.tileID.overscaledZ-ge.tileID.overscaledZ||(ge.tileID.isLessThan(de.tileID)?-1:1))}const te=this.crossTileSymbolIndex.addLayer(X,V[X.source],h.center.lng,h.projection);B=B||te}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),k=k||this._layerOrderChanged||T===0,this._layerOrderChanged&&this.fire(new u.Event("neworder")),(k||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(u.exported.now(),h.zoom))&&(this.pauseablePlacement=new ah(h,this._order,k,_,T,C,this.placement,this.fog&&h.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,V),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(u.exported.now()),F=!0),B&&this.pauseablePlacement.placement.setStale()),F||B)for(const Z of this._order){const X=this._layers[Z];X.type==="symbol"&&this.placement.updateLayerOpacities(X,V[X.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(u.exported.now())}_releaseSymbolFadeTiles(){for(const h in this._sourceCaches)this._sourceCaches[h].releaseSymbolFadeTiles()}getImages(h,_,T){this.imageManager.getImages(_.icons,T),this._updateTilesForChangedImages();const C=k=>{k&&k.setDependencies(_.tileID.key,_.type,_.icons)};C(this._otherSourceCaches[_.source]),C(this._symbolSourceCaches[_.source])}getGlyphs(h,_,T){this.glyphManager.getGlyphs(_.stacks,T)}getResource(h,_,T){return u.makeRequest(_,T)}_getSourceCache(h){return this._otherSourceCaches[h]}_getLayerSourceCache(h){return h.type==="symbol"?this._symbolSourceCaches[h.source]:this._otherSourceCaches[h.source]}_getSourceCaches(h){const _=[];return this._otherSourceCaches[h]&&_.push(this._otherSourceCaches[h]),this._symbolSourceCaches[h]&&_.push(this._symbolSourceCaches[h]),_}_isSourceCacheLoaded(h){const _=this._getSourceCaches(h);return _.length===0?(this.fire(new u.ErrorEvent(new Error(`There is no source with ID '${h}'`))),!1):_.every(T=>T.loaded())}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Ir.getSourceType=function(x){return Re[x]},Ir.setSourceType=function(x,h){Re[x]=h},Ir.registerForPluginStateChange=u.registerForPluginStateChange;var Uo=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#define HALF_PI PI/2.0
#define QUARTER_PI PI/4.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}
#endif`,Vo="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}";let Hn={},kn={};Hn=Xt("",`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform sampler2D u_dem;uniform sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {return currentElevation(apos);}
#endif
float unpack_depth(vec4 rgba_depth)
{const vec4 bit_shift=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,!0),kn=Xt(`#ifdef FOG
uniform float u_fog_temporal_offset;float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,`#ifdef FOG
uniform mat4 u_fog_matrix;vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,!0);const As=Xt(`
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef TERRAIN
highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(256.0*256.0*256.0,256.0*256.0,256.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/256.0,1.0/256.0,1.0/256.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#endif`,`
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),jo=Uo;var Go={background:Xt(`uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Xt(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:Xt(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
vec2 scaled_extrude=extrude*a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=scaled_extrude.x*surface_vectors[0]+scaled_extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);vec4 world_center=vec4(pos,1);
#else 
mat3 surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);vec4 world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
#if defined(SCALE_WITH_MAP) && defined(PROJECTION_GLOBE_VIEW)
view_scale*=a_scale;
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);vec4 occlusion_world_center=vec4(circle_center,cantilevered_height,1);vec4 occlusion_projected_center=u_matrix*occlusion_world_center;
#else
vec4 occlusion_world_center=world_center;vec4 occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Xt("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Xt(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);
#ifdef PROJECTION_GLOBE_VIEW
extrude*=a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
vec3 pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Xt(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Xt("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Xt("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Xt("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",`attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;
#endif
varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:Xt(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:Xt(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Xt(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Xt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Xt(`varying vec4 v_color;void main() {vec4 color=v_color;
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 pos=vec3(pos_nx.xy,h);
#else
vec3 pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(pos.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionPattern:Xt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 p=vec3(pos_nx.xy,h);
#else
vec3 p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),hillshadePrepare:Xt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Xt(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Xt(`uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
#ifdef RENDER_LINE_GRADIENT
vec4 out_color=texture2D(u_gradient_image,v_uv);
#else
vec4 out_color=color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef RENDER_LINE_ALPHA_DISCARD
if (alpha < u_alpha_discard_threshold) {discard;}
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#ifdef RENDER_LINE_GRADIENT
attribute vec3 a_packed;
#else
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;varying highp vec2 v_uv;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_GRADIENT
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];float a_linesofar=a_packed[2];highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);
#endif
#ifdef RENDER_LINE_DASH
float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:Xt(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:Xt(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:Xt(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchor_z=a_z_tile_anchor.x;vec2 tile_anchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchor_z)+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;float globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
vec3 world_pos=vec3(a_pos,anchor_z)+h;float globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point=u_matrix*vec4(a_pos+vec2(1,0),anchor_z,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchor_z),mercator_pos,u_zoom_transition);
#else
vec3 proj_pos=vec3(a_projected_pos.xy,anchor_z);
#endif
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}`),symbolSDF:Xt(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchor_z=a_z_tile_anchor.x;vec2 tile_anchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchor_z)+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;float globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
vec3 world_pos=vec3(a_pos,anchor_z)+h;float globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point=u_matrix*vec4(a_pos+vec2(1,0),anchor_z,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchor_z),mercator_pos,u_zoom_transition);
#else
vec3 proj_pos=vec3(a_projected_pos.xy,anchor_z);
#endif
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}`),symbolTextAndIcon:Xt(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchor_z=a_z_tile_anchor.x;vec2 tile_anchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchor_z)+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;float globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
vec3 world_pos=vec3(a_pos,anchor_z)+h;float globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),anchor_z,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchor_z),mercator_pos,u_zoom_transition);
#else
vec3 proj_pos=vec3(a_projected_pos.xy,anchor_z);
#endif
#ifdef PROJECTED_POS_ON_VIEWPORT
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);
#else
vec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}`),terrainRaster:Xt(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
void main() {vec4 color=texture2D(u_image0,v_pos0);
#ifdef FOG
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
const float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;
#ifdef TERRAIN_WIREFRAME
elevation+=u_skirt_height*u_skirt_height*wireframeOffset;
#endif
vec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
}`),terrainDepth:Xt(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:Xt(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Vo),skyboxGradient:Xt(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Vo),skyboxCapture:Xt(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Xt(`uniform sampler2D u_image0;varying vec2 v_pos0;void main() {gl_FragColor=texture2D(u_image0,v_pos0);
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_proj_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;
#ifdef GLOBE_POLES
attribute vec3 a_globe_pos;attribute vec2 a_merc_pos;attribute vec2 a_uv;
#else
attribute vec2 a_pos;
#endif
varying vec2 v_pos0;const float wireframeOffset=1e3;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 merc_pos=a_merc_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idy=u_grid_matrix[1][2];float S=u_grid_matrix[2][2];vec3 latLng=u_grid_matrix*vec3(a_pos,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=a_pos[0]*S;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;uv=uv*EXTENT;vec4 up_vector=vec4(elevationVector(uv),1.0);float height=elevation(uv);
#ifdef TERRAIN_WIREFRAME
height+=wireframeOffset;
#endif
vec4 globe=u_globe_matrix*vec4(globe_pos+up_vector.xyz*height,1.0);vec4 mercator=vec4(0.0);if (u_zoom_transition > 0.0) {mercator=vec4(merc_pos,height,1.0);mercator.xy-=u_merc_center;mercator.x=wrap(mercator.x,-0.5,0.5);mercator=u_merc_matrix*mercator;}vec3 position=mix(globe.xyz,mercator.xyz,u_zoom_transition);gl_Position=u_proj_matrix*vec4(position,1.0);}`),globeAtmosphere:Xt(`uniform float u_opacity;uniform highp float u_fadeout_range;uniform vec3 u_start_color;uniform vec3 u_end_color;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;varying highp vec3 v_ray_dir;void main() {highp vec3 dir=normalize(v_ray_dir);highp vec3 closest_point=abs(dot(u_globe_pos,dir))*dir;float norm_dist_from_center=length(closest_point-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 1.0)
discard;float t=clamp(1.0-sqrt(norm_dist_from_center-1.0)/u_fadeout_range,0.0,1.0);vec3 color=mix(u_start_color,u_end_color,1.0-t);gl_FragColor=vec4(color*t*u_opacity,u_opacity);}`,"attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;varying highp vec3 v_ray_dir;void main() {v_ray_dir=mix(mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);gl_Position=vec4(a_pos,1.0);}")};function Xt(x,h,_){const T=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,C=/uniform (highp |mediump |lowp )?([\w]+) ([\w]+)([\s]*)([\w]*)/g,k=h.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),B=x.match(C),F=h.match(C),V=Uo.match(C);let Z=F?F.concat(B):B;_||(Hn.staticUniforms&&(Z=Hn.staticUniforms.concat(Z)),kn.staticUniforms&&(Z=kn.staticUniforms.concat(Z))),Z&&(Z=Z.concat(V));const X={};return{fragmentSource:x=x.replace(T,(te,le,ge,de,se)=>(X[se]=!0,le==="define"?`
#ifndef HAS_UNIFORM_u_${se}
varying ${ge} ${de} ${se};
#else
uniform ${ge} ${de} u_${se};
#endif
`:`
#ifdef HAS_UNIFORM_u_${se}
    ${ge} ${de} ${se} = u_${se};
#endif
`)),vertexSource:h=h.replace(T,(te,le,ge,de,se)=>{const Se=de==="float"?"vec2":"vec4",xe=se.match(/color/)?"color":Se;return X[se]?le==="define"?`
#ifndef HAS_UNIFORM_u_${se}
uniform lowp float u_${se}_t;
attribute ${ge} ${Se} a_${se};
varying ${ge} ${de} ${se};
#else
uniform ${ge} ${de} u_${se};
#endif
`:xe==="vec4"?`
#ifndef HAS_UNIFORM_u_${se}
    ${se} = a_${se};
#else
    ${ge} ${de} ${se} = u_${se};
#endif
`:`
#ifndef HAS_UNIFORM_u_${se}
    ${se} = unpack_mix_${xe}(a_${se}, u_${se}_t);
#else
    ${ge} ${de} ${se} = u_${se};
#endif
`:le==="define"?`
#ifndef HAS_UNIFORM_u_${se}
uniform lowp float u_${se}_t;
attribute ${ge} ${Se} a_${se};
#else
uniform ${ge} ${de} u_${se};
#endif
`:xe==="vec4"?`
#ifndef HAS_UNIFORM_u_${se}
    ${ge} ${de} ${se} = a_${se};
#else
    ${ge} ${de} ${se} = u_${se};
#endif
`:`
#ifndef HAS_UNIFORM_u_${se}
    ${ge} ${de} ${se} = unpack_mix_${xe}(a_${se}, u_${se}_t);
#else
    ${ge} ${de} ${se} = u_${se};
#endif
`}),staticAttributes:k,staticUniforms:Z}}class Is{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(h,_,T,C,k,B,F,V){this.context=h;let Z=this.boundPaintVertexBuffers.length!==C.length;for(let X=0;!Z&&X<C.length;X++)this.boundPaintVertexBuffers[X]!==C[X]&&(Z=!0);h.extVertexArrayObject&&this.vao&&this.boundProgram===_&&this.boundLayoutVertexBuffer===T&&!Z&&this.boundIndexBuffer===k&&this.boundVertexOffset===B&&this.boundDynamicVertexBuffer===F&&this.boundDynamicVertexBuffer2===V?(h.bindVertexArrayOES.set(this.vao),F&&F.bind(),k&&k.dynamicDraw&&k.bind(),V&&V.bind()):this.freshBind(_,T,C,k,B,F,V)}freshBind(h,_,T,C,k,B,F){let V;const Z=h.numAttributes,X=this.context,te=X.gl;if(X.extVertexArrayObject)this.vao&&this.destroy(),this.vao=X.extVertexArrayObject.createVertexArrayOES(),X.bindVertexArrayOES.set(this.vao),V=0,this.boundProgram=h,this.boundLayoutVertexBuffer=_,this.boundPaintVertexBuffers=T,this.boundIndexBuffer=C,this.boundVertexOffset=k,this.boundDynamicVertexBuffer=B,this.boundDynamicVertexBuffer2=F;else{V=X.currentNumAttributes||0;for(let le=Z;le<V;le++)te.disableVertexAttribArray(le)}_.enableAttributes(te,h);for(const le of T)le.enableAttributes(te,h);B&&B.enableAttributes(te,h),F&&F.enableAttributes(te,h),_.bind(),_.setVertexAttribPointers(te,h,k);for(const le of T)le.bind(),le.setVertexAttribPointers(te,h,k);B&&(B.bind(),B.setVertexAttribPointers(te,h,k)),C&&C.bind(),F&&(F.bind(),F.setVertexAttribPointers(te,h,k)),X.currentNumAttributes=Z}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function Ul(x,h){const _=Math.pow(2,h.canonical.z),T=h.canonical.y;return[new u.MercatorCoordinate(0,T/_).toLngLat().lat,new u.MercatorCoordinate(0,(T+1)/_).toLngLat().lat]}function Vl(x,h,_,T,C,k,B){const F=x.context,V=F.gl,Z=_.fbo;if(!Z)return;x.prepareDrawTile();const X=x.useProgram("hillshade");F.activeTexture.set(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D,Z.colorAttachment.get());const te=((se,Se,xe,Te)=>{const Me=xe.paint.get("hillshade-shadow-color"),Ae=xe.paint.get("hillshade-highlight-color"),Ee=xe.paint.get("hillshade-accent-color");let De=xe.paint.get("hillshade-illumination-direction")*(Math.PI/180);xe.paint.get("hillshade-illumination-anchor")==="viewport"&&(De-=se.transform.angle);const Ue=!se.options.moving;return{u_matrix:Te||se.transform.calculateProjMatrix(Se.tileID.toUnwrapped(),Ue),u_image:0,u_latrange:Ul(0,Se.tileID),u_light:[xe.paint.get("hillshade-exaggeration"),De],u_shadow:Me,u_highlight:Ae,u_accent:Ee}})(x,_,T,x.terrain?h.projMatrix:null);x.prepareDrawProgram(F,X,h.toUnwrapped());const{tileBoundsBuffer:le,tileBoundsIndexBuffer:ge,tileBoundsSegments:de}=x.getTileBoundsBuffers(_);X.draw(F,V.TRIANGLES,C,k,B,u.CullFaceMode.disabled,te,T.id,le,ge,de)}function wa(x,h,_){if(!h.needsDEMTextureUpload)return;const T=x.context,C=T.gl;T.pixelStoreUnpackPremultiplyAlpha.set(!1),h.demTexture=h.demTexture||x.getTileTexture(_.stride);const k=_.getPixels();h.demTexture?h.demTexture.update(k,{premultiply:!1}):h.demTexture=new u.Texture(T,k,C.RGBA,{premultiply:!1}),h.needsDEMTextureUpload=!1}function Ea(x,h,_,T,C,k){const B=x.context,F=B.gl;if(!h.dem)return;const V=h.dem;if(B.activeTexture.set(F.TEXTURE1),wa(x,h,V),!h.demTexture)return;h.demTexture.bind(F.NEAREST,F.CLAMP_TO_EDGE);const Z=V.dim;B.activeTexture.set(F.TEXTURE0);let X=h.fbo;if(!X){const de=new u.Texture(B,{width:Z,height:Z,data:null},F.RGBA);de.bind(F.LINEAR,F.CLAMP_TO_EDGE),X=h.fbo=B.createFramebuffer(Z,Z,!0),X.colorAttachment.set(de.texture)}B.bindFramebuffer.set(X.framebuffer),B.viewport.set([0,0,Z,Z]);const{tileBoundsBuffer:te,tileBoundsIndexBuffer:le,tileBoundsSegments:ge}=x.getMercatorTileBoundsBuffers();x.useProgram("hillshadePrepare").draw(B,F.TRIANGLES,T,C,k,u.CullFaceMode.disabled,((de,se)=>{const Se=se.stride,xe=u.create();return u.ortho(xe,0,u.EXTENT,-u.EXTENT,0,0,1),u.translate(xe,xe,[0,-u.EXTENT,0]),{u_matrix:xe,u_image:1,u_dimension:[Se,Se],u_zoom:de.overscaledZ,u_unpack:se.unpackVector}})(h.tileID,V),_.id,te,le,ge),h.needsHillshadePrepare=!1}const Ta=(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_image0:new u.Uniform1i(x,h.u_image0),u_skirt_height:new u.Uniform1f(x,h.u_skirt_height)}),jl=(x,h)=>({u_matrix:x,u_image0:0,u_skirt_height:h}),Gl=(x,h,_,T,C,k)=>({u_proj_matrix:Float32Array.from(x),u_globe_matrix:h,u_merc_matrix:_,u_zoom_transition:T,u_merc_center:C,u_image0:0,u_grid_matrix:k?Float32Array.from(k):new Float32Array(9)});function Cs(x,h){return x!=null&&h!=null&&!(!x.hasData()||!h.hasData())&&x.demTexture!=null&&h.demTexture!=null&&x.tileID.key!==h.tileID.key}const Dn=new class{constructor(){this.operations={}}newMorphing(x,h,_,T,C){if(x in this.operations){const k=this.operations[x];k.to.tileID.key!==_.tileID.key&&(k.queued=_)}else this.operations[x]={startTime:T,phase:0,duration:C,from:h,to:_,queued:null}}getMorphValuesForProxy(x){if(!(x in this.operations))return null;const h=this.operations[x];return{from:h.from,to:h.to,phase:h.phase}}update(x){for(const h in this.operations){const _=this.operations[h];for(_.phase=(x-_.startTime)/_.duration;_.phase>=1||!this._validOp(_);)if(!this._nextOp(_,x)){delete this.operations[h];break}}}_nextOp(x,h){return!!x.queued&&(x.from=x.to,x.to=x.queued,x.queued=null,x.phase=0,x.startTime=h,!0)}_validOp(x){return x.from.hasData()&&x.to.hasData()}},mo={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function Ma(x,h){const _=1<<x.z;return!h&&(x.x===0||x.x===_-1)||x.y===0||x.y===_-1}const ks=x=>({u_matrix:x});function Sa(x,h,_,T,C){if(C>0){const k=u.exported.now(),B=(k-x.timeAdded)/C,F=h?(k-h.timeAdded)/C:-1,V=_.getSource(),Z=T.coveringZoomLevel({tileSize:V.tileSize,roundZoom:V.roundZoom}),X=!h||Math.abs(h.tileID.overscaledZ-Z)>Math.abs(x.tileID.overscaledZ-Z),te=X&&x.refreshedUponExpiration?1:u.clamp(X?B:1-F,0,1);return x.refreshedUponExpiration&&B>=1&&(x.refreshedUponExpiration=!1),h?{opacity:1,mix:1-te}:{opacity:te,mix:0}}return{opacity:1,mix:0}}const hh=2*u.mercatorZfromAltitude(1,0)*u.GLOBE_RADIUS*Math.PI;class qo extends u.SourceCache{constructor(h){const _={type:"raster-dem",maxzoom:h.transform.maxZoom},T=new ot(Wt(),null),C=ze("mock-dem",_,T,h.style);super("mock-dem",C,!1),C.setEventedParent(this),this._sourceLoaded=!0}_loadTile(h,_){h.state="loaded",_(null)}}class Zo extends u.SourceCache{constructor(h){const _=ze("proxy",{type:"geojson",maxzoom:h.transform.maxZoom},new ot(Wt(),null),h.style);super("proxy",_,!1),_.setEventedParent(this),this.map=this.getSource().map=h,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(h,_,T){if(h.freezeTileCoverage)return;this.transform=h;const C=h.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((k,B)=>{if(k[B.key]="",!this._tiles[B.key]){const F=new u.Tile(B,this._source.tileSize*B.overscaleFactor(),h.tileZoom);F.state="loaded",this._tiles[B.key]=F}return k},{});for(const k in this._tiles)k in C||(this.freeFBO(k),this._tiles[k].unloadVectorData(),delete this._tiles[k])}freeFBO(h){const _=this.proxyCachedFBO[h];if(_!==void 0){const T=Object.values(_);this.renderCachePool.push(...T),delete this.proxyCachedFBO[h]}}deallocRenderCache(){this.renderCache.forEach(h=>h.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Aa extends u.OverscaledTileID{constructor(h,_,T){super(h.overscaledZ,h.wrap,h.canonical.z,h.canonical.x,h.canonical.y),this.proxyTileKey=_,this.projMatrix=T}}class Nr extends u.Elevation{constructor(h,_){super(),this.painter=h,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[T,C,k]=function(V){const Z=new u.StructArrayLayout4i8,X=new u.StructArrayLayout3ui6,te=131;Z.reserve(17161),X.reserve(33800);const le=u.EXTENT/128,ge=u.EXTENT+le/2,de=ge+le;for(let Se=-le;Se<de;Se+=le)for(let xe=-le;xe<de;xe+=le){const Te=xe<0||xe>ge||Se<0||Se>ge?24575:0,Me=u.clamp(Math.round(xe),0,u.EXTENT),Ae=u.clamp(Math.round(Se),0,u.EXTENT);Z.emplaceBack(Me+Te,Ae,Me,Ae)}const se=(Se,xe)=>{const Te=xe*te+Se;X.emplaceBack(Te+1,Te,Te+te),X.emplaceBack(Te+te,Te+te+1,Te+1)};for(let Se=1;Se<129;Se++)for(let xe=1;xe<129;xe++)se(xe,Se);return[0,129].forEach(Se=>{for(let xe=0;xe<130;xe++)se(xe,Se),se(Se,xe)}),[Z,X,32768]}(),B=h.context;this.gridBuffer=B.createVertexBuffer(T,u.boundsAttributes.members),this.gridIndexBuffer=B.createIndexBuffer(C),this.gridSegments=u.SegmentVector.simpleSegment(0,0,T.length,C.length),this.gridNoSkirtSegments=u.SegmentVector.simpleSegment(0,0,T.length,k),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Zo(_.map),this.orthoMatrix=u.create(),u.ortho(this.orthoMatrix,0,u.EXTENT,0,u.EXTENT,0,1);const F=B.gl;this._overlapStencilMode=new u.StencilMode({func:F.GEQUAL,mask:255},0,255,F.KEEP,F.KEEP,F.REPLACE),this._previousZoom=h.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=_,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new qo(_.map)}set style(h){h.on("data",this._onStyleDataEvent.bind(this)),h.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=h,this._checkRenderCacheEfficiency()}update(h,_,T){if(h&&h.terrain){this._style!==h&&(this.style=h),this.enabled=!0;const C=h.terrain.properties;this.sourceCache=h.terrain.drapeRenderMode===0?this._mockSourceCache:h._getSourceCache(C.get("source")),this._exaggeration=C.get("exaggeration");const k=()=>{this.sourceCache.used&&u.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const B=this.getScaledDemTileSize();this.sourceCache.update(_,B,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,k(),this._initializing=!0),k(),_.updateElevation(!T),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(_),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(h){this._findCoveringTileCache[h]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const h=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||h.efficiency!==100&&u.warnOnce(`Terrain render cache efficiency is not optimal (${h.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${h.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(h){h.coord&&h.dataType==="source"?this._clearRenderCacheForTile(h.sourceCacheId,h.coord):h.dataType==="style"&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const h in this._style._sourceCaches)this._style._sourceCaches[h].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(h=>h.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0)}_source(){return this.enabled?this.sourceCache:null}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const h=2*this.proxySourceCache.getSource().tileSize;return[h,h]}set useVertexMorphing(h){this._useVertexMorphing=h}updateTileBinding(h){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const _=this.proxySourceCache,T=this.painter.transform;this._initializing&&(this._initializing=T._centerAltitude===0&&this.getAtPointOrZero(u.MercatorCoordinate.fromLngLat(T.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const C=this.proxyCoords=_.getIds().map(V=>{const Z=_.getTileByID(V).tileID;return Z.projMatrix=T.calculateProjMatrix(Z.toUnwrapped()),Z});(function(V,Z){const X=Z.transform.pointCoordinate(Z.transform.getCameraPoint()),te=new u.pointGeometry(X.x,X.y);V.sort((le,ge)=>{if(ge.overscaledZ-le.overscaledZ)return ge.overscaledZ-le.overscaledZ;const de=new u.pointGeometry(le.canonical.x+(1<<le.canonical.z)*le.wrap,le.canonical.y),se=new u.pointGeometry(ge.canonical.x+(1<<ge.canonical.z)*ge.wrap,ge.canonical.y),Se=te.mult(1<<le.canonical.z);return Se.x-=.5,Se.y-=.5,Se.distSqr(de)-Se.distSqr(se)})})(C,this.painter),this._previousZoom=T.zoom;const k=this.proxyToSource||{};this.proxyToSource={},C.forEach(V=>{this.proxyToSource[V.key]={}}),this.terrainTileForTile={};const B=this._style._sourceCaches;for(const V in B){const Z=B[V];if(!Z.used||(Z!==this.sourceCache&&this.resetTileLookupCache(Z.id),this._setupProxiedCoordsForOrtho(Z,h[V],k),Z.usedForTerrain))continue;const X=h[V];Z.getSource().reparseOverscaled&&this._assignTerrainTiles(X)}this.proxiedCoords[_.id]=C.map(V=>new Aa(V,V.key,this.orthoMatrix)),this._assignTerrainTiles(C),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(k),this.renderingToTexture=!1,this._updateTimestamp=u.exported.now();const F={};this._visibleDemTiles=[];for(const V of this.proxyCoords){const Z=this.terrainTileForTile[V.key];if(!Z)continue;const X=Z.tileID.key;X in F||(this._visibleDemTiles.push(Z),F[X]=X)}}_assignTerrainTiles(h){this._initializing||h.forEach(_=>{if(this.terrainTileForTile[_.key])return;const T=this._findTileCoveringTileID(_,this.sourceCache);T&&(this.terrainTileForTile[_.key]=T)})}_prepareDEMTextures(){const h=this.painter.context,_=h.gl;for(const T in this.terrainTileForTile){const C=this.terrainTileForTile[T],k=C.dem;!k||C.demTexture&&!C.needsDEMTextureUpload||(h.activeTexture.set(_.TEXTURE1),wa(this.painter,C,k))}}_prepareDemTileUniforms(h,_,T,C){if(!_||_.demTexture==null)return!1;const k=h.tileID.canonical,B=Math.pow(2,_.tileID.canonical.z-k.z),F=C||"";return T[`u_dem_tl${F}`]=[k.x*B%1,k.y*B%1],T[`u_dem_scale${F}`]=B,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const h=this.painter.context,_=h.gl;if(!this._emptyDepthBufferTexture){const T=new u.RGBAImage({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new u.Texture(h,T,_.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let h=0;const _=this._visibleDemTiles.reduce((T,C)=>{if(!C.dem)return T;const k=C.dem.tree.minimums[0];return k>0&&h++,T+k},0);return h?_/h:0}_updateEmptyDEMTexture(){const h=this.painter.context,_=h.gl;h.activeTexture.set(_.TEXTURE2);const T=this._getLoadedAreaMinimum(),C=new u.RGBAImage({width:1,height:1},new Uint8Array(u.DEMData.pack(T,this.sourceCache.getSource().encoding)));this._emptyDEMTextureDirty=!1;let k=this._emptyDEMTexture;return k?k.update(C,{premultiply:!1}):k=this._emptyDEMTexture=new u.Texture(h,C,_.RGBA,{premultiply:!1}),k}setupElevationDraw(h,_,T){const C=this.painter.context,k=C.gl,B=(F=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:u.DEMData.getUnpackVector(F),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0,u_tile_tl_up:[0,0,1],u_tile_tr_up:[0,0,1],u_tile_br_up:[0,0,1],u_tile_bl_up:[0,0,1],u_tile_up_scale:1});var F;B.u_dem_size=this.sourceCache.getSource().tileSize,B.u_exaggeration=this.exaggeration();const V=this.painter.transform,Z=V.projection,X=h.tileID.canonical;B.u_tile_tl_up=Z.upVector(X,0,0),B.u_tile_tr_up=Z.upVector(X,u.EXTENT,0),B.u_tile_br_up=Z.upVector(X,u.EXTENT,u.EXTENT),B.u_tile_bl_up=Z.upVector(X,0,u.EXTENT),B.u_tile_up_scale=T&&T.useDenormalizedUpVectorScale?hh:Z.upVectorScale(X,V.center.lat,V.worldSize).metersToTile;let te=null,le=null,ge=1;if(T&&T.morphing&&this._useVertexMorphing){const de=T.morphing.srcDemTile,se=T.morphing.dstDemTile;ge=T.morphing.phase,de&&se&&(this._prepareDemTileUniforms(h,de,B,"_prev")&&(le=de),this._prepareDemTileUniforms(h,se,B)&&(te=se))}if(le&&te?(C.activeTexture.set(k.TEXTURE2),te.demTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE,k.NEAREST),C.activeTexture.set(k.TEXTURE4),le.demTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE,k.NEAREST),B.u_dem_lerp=ge):(te=this.terrainTileForTile[h.tileID.key],C.activeTexture.set(k.TEXTURE2),(this._prepareDemTileUniforms(h,te,B)?te.demTexture:this.emptyDEMTexture).bind(k.NEAREST,k.CLAMP_TO_EDGE)),C.activeTexture.set(k.TEXTURE3),T&&T.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE),this._depthFBO&&(B.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE),B.u_depth_size_inv=[1,1]),T&&T.useMeterToDem&&te){const de=(1<<te.tileID.canonical.z)*u.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;B.u_meter_to_dem=de}T&&T.labelPlaneMatrixInv&&(B.u_label_plane_matrix_inv=T.labelPlaneMatrixInv),_.setTerrainUniformValues(C,B)}renderToBackBuffer(h){const _=this.painter,T=this.painter.context;h.length!==0&&(T.bindFramebuffer.set(null),T.viewport.set([0,0,_.width,_.height]),this.renderingToTexture=!1,function(C,k,B,F,V){if(C.transform.projection.name==="globe")(function(Z,X,te,le,ge){const de=Z.context,se=de.gl;let Se,xe;const Te=Z.options.showTerrainWireframe?2:0,Me=(Ye,ct)=>{if(xe===Ye)return;const Ve=[mo[Ye],"PROJECTION_GLOBE_VIEW"];ct&&Ve.push(mo[Te]),Se=Z.useProgram("globeRaster",null,Ve),xe=Ye},Ae=Z.colorModeForRenderPass(),Ee=new u.DepthMode(se.LEQUAL,u.DepthMode.ReadWrite,Z.depthRangeFor3D);Dn.update(ge);const De=Z.transform,Ue=u.calculateGlobeMercatorMatrix(De),Ze=[u.mercatorXfromLng(De.center.lng),u.mercatorYfromLat(De.center.lat)],He=Z.globeSharedBuffers;if((Te?[!1,!0]:[!1]).forEach(Ye=>{xe=-1;const ct=Ye?se.LINES:se.TRIANGLES;for(const Ve of le){const ht=te.getTile(Ve),at=u.StencilMode.disabled,Dt=X.prevTerrainTileForTile[Ve.key],Je=X.terrainTileForTile[Ve.key];Cs(Dt,Je)&&Dn.newMorphing(Ve.key,Dt,Je,ge,250),de.activeTexture.set(se.TEXTURE0),ht.texture.bind(se.LINEAR,se.CLAMP_TO_EDGE);const At=Dn.getMorphValuesForProxy(Ve.key),qt=At?1:0,It={useDenormalizedUpVectorScale:!0};At&&u.extend$1(It,{morphing:{srcDemTile:At.from,dstDemTile:At.to,phase:u.easeCubicInOut(At.phase)}});const Ct=Float32Array.from(De.globeMatrix),Kt=u.globeTileLatLngCorners(Ve.canonical),mi=u.getGridMatrix(Ve.canonical,Kt),jt=Gl(De.projMatrix,Ct,Ue,u.globeToMercatorTransition(De.zoom),Ze,mi);if(Me(qt,Ye),X.setupElevationDraw(ht,Se,It),Z.prepareDrawProgram(de,Se,Ve.toUnwrapped()),He){const[ti,Ii,Yi]=Ye?He.getWirefameBuffers(Z.context):He.getGridBuffers();Se.draw(de,ct,Ee,at,Ae,u.CullFaceMode.backCCW,jt,"globe_raster",ti,Ii,Yi)}}}),He){Se=Z.useProgram("globeRaster",null,["GLOBE_POLES","PROJECTION_GLOBE_VIEW"]);for(const Ye of le){const{x:ct,y:Ve,z:ht}=Ye.canonical,at=Ve===0,Dt=Ve===(1<<ht)-1,[Je,At,qt,It]=He.getPoleBuffers(ht);if(It&&(at||Dt)){const Ct=te.getTile(Ye);de.activeTexture.set(se.TEXTURE0),Ct.texture.bind(se.LINEAR,se.CLAMP_TO_EDGE);let Kt=u.globePoleMatrixForTile(ht,ct,De);const mi=(jt,ti)=>jt.draw(de,se.TRIANGLES,Ee,u.StencilMode.disabled,Ae,u.CullFaceMode.disabled,Gl(De.projMatrix,Kt,Kt,0,Ze),"globe_pole_raster",ti,qt,It);X.setupElevationDraw(Ct,Se,{}),Z.prepareDrawProgram(de,Se,Ye.toUnwrapped()),at&&mi(Se,Je),Dt&&(Kt=u.scale(u.create(),Kt,[1,-1,1]),mi(Se,At))}}}})(C,k,B,F,V);else{const Z=C.context,X=Z.gl;let te,le;const ge=C.options.showTerrainWireframe?2:0,de=(Me,Ae)=>{if(le===Me)return;const Ee=[mo[Me]];Ae&&Ee.push(mo[ge]),te=C.useProgram("terrainRaster",null,Ee),le=Me},se=C.colorModeForRenderPass(),Se=new u.DepthMode(X.LEQUAL,u.DepthMode.ReadWrite,C.depthRangeFor3D);Dn.update(V);const xe=C.transform,Te=6*Math.pow(1.5,22-xe.zoom)*k.exaggeration();(ge?[!1,!0]:[!1]).forEach(Me=>{le=-1;const Ae=Me?X.LINES:X.TRIANGLES,[Ee,De]=Me?k.getWirefameBuffer():[k.gridIndexBuffer,k.gridSegments];for(const Ue of F){const Ze=B.getTile(Ue),He=u.StencilMode.disabled,Ye=k.prevTerrainTileForTile[Ue.key],ct=k.terrainTileForTile[Ue.key];Cs(Ye,ct)&&Dn.newMorphing(Ue.key,Ye,ct,V,250),Z.activeTexture.set(X.TEXTURE0),Ze.texture.bind(X.LINEAR,X.CLAMP_TO_EDGE,X.LINEAR_MIPMAP_NEAREST);const Ve=Dn.getMorphValuesForProxy(Ue.key),ht=Ve?1:0;let at;Ve&&(at={morphing:{srcDemTile:Ve.from,dstDemTile:Ve.to,phase:u.easeCubicInOut(Ve.phase)}});const Dt=jl(Ue.projMatrix,Ma(Ue.canonical,xe.renderWorldCopies)?Te/10:Te);de(ht,Me),k.setupElevationDraw(Ze,te,at),C.prepareDrawProgram(Z,te,Ue.toUnwrapped()),te.draw(Z,Ae,Se,He,se,u.CullFaceMode.backCCW,Dt,"terrain_raster",k.gridBuffer,Ee,De)}})}}(_,this,this.proxySourceCache,h,this._updateTimestamp),this.renderingToTexture=!0,h.splice(0,h.length))}renderBatch(h){if(this._drapedRenderBatches.length===0)return h+1;this.renderingToTexture=!0;const _=this.painter,T=this.painter.context,C=this.proxySourceCache,k=this.proxiedCoords[C.id],B=this._drapedRenderBatches.shift(),F=[],V=_.style.order;let Z=0;for(const X of k){const te=C.getTileByID(X.proxyTileKey),le=C.proxyCachedFBO[X.key]?C.proxyCachedFBO[X.key][h]:void 0,ge=le!==void 0?C.renderCache[le]:this.pool[Z++],de=le!==void 0;if(te.texture=ge.tex,de&&!ge.dirty){F.push(te.tileID);continue}let se;T.bindFramebuffer.set(ge.fb.framebuffer),this.renderedToTile=!1,ge.dirty&&(T.clear({color:u.Color.transparent,stencil:0}),ge.dirty=!1);for(let Se=B.start;Se<=B.end;++Se){const xe=_.style._layers[V[Se]];if(xe.isHidden(_.transform.zoom))continue;const Te=_.style._getLayerSourceCache(xe),Me=Te?this.proxyToSource[X.key][Te.id]:[X];if(!Me)continue;const Ae=Me;T.viewport.set([0,0,ge.fb.width,ge.fb.height]),se!==(Te?Te.id:null)&&(this._setupStencil(ge,Me,xe,Te),se=Te?Te.id:null),_.renderLayer(_,Te,xe,Ae)}this.renderedToTile?(ge.dirty=!0,F.push(te.tileID)):de||--Z,Z===5&&(Z=0,this.renderToBackBuffer(F))}return this.renderToBackBuffer(F),this.renderingToTexture=!1,T.bindFramebuffer.set(null),T.viewport.set([0,0,_.width,_.height]),B.end+1}postRender(){}renderCacheEfficiency(h){const _=h.order.length;if(_===0)return{efficiency:100};let T,C=0,k=0,B=!1;for(let F=0;F<_;++F){const V=h._layers[h.order[F]];this._style.isLayerDraped(V)?(B&&++C,++k):B||(B=!0,T=V.id)}return k===0?{efficiency:100}:{efficiency:100*(1-C/k),firstUndrapedLayer:T}}getMinElevationBelowMSL(){let h=0;return this._visibleDemTiles.filter(_=>_.dem).forEach(_=>{h=Math.min(h,_.dem.tree.minimums[0])}),h===0?h:(h-30)*this._exaggeration}raycast(h,_,T){if(!this._visibleDemTiles)return null;const C=this._visibleDemTiles.filter(k=>k.dem).map(k=>{const B=k.tileID,F=Math.pow(2,B.overscaledZ),{x:V,y:Z}=B.canonical,X=V/F,te=(V+1)/F,le=Z/F,ge=(Z+1)/F;return{minx:X,miny:le,maxx:te,maxy:ge,t:k.dem.tree.raycastRoot(X,le,te,ge,h,_,T),tile:k}});C.sort((k,B)=>(k.t!==null?k.t:Number.MAX_VALUE)-(B.t!==null?B.t:Number.MAX_VALUE));for(const k of C){if(k.t==null)return null;const B=k.tile.dem.tree.raycast(k.minx,k.miny,k.maxx,k.maxy,h,_,T);if(B!=null)return B}return null}_createFBO(){const h=this.painter.context,_=h.gl,T=this.drapeBufferSize;h.activeTexture.set(_.TEXTURE0);const C=new u.Texture(h,{width:T[0],height:T[1],data:null},_.RGBA);C.bind(_.LINEAR,_.CLAMP_TO_EDGE);const k=h.createFramebuffer(T[0],T[1],!1);return k.colorAttachment.set(C.texture),k.depthAttachment=new ye(h,k.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=h.createRenderbuffer(h.gl.DEPTH_STENCIL,T[0],T[1]),this._stencilRef=0,k.depthAttachment.set(this._sharedDepthStencil),h.clear({stencil:0})):k.depthAttachment.set(this._sharedDepthStencil),h.extTextureFilterAnisotropic&&!h.extTextureFilterAnisotropicForceOff&&_.texParameterf(_.TEXTURE_2D,h.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,h.extTextureFilterAnisotropicMax),{fb:k,tex:C,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const h in this._style._sourceCaches)if(this._style._sourceCaches[h].hasTransition())return!0;return this._style.order.some(h=>{const _=this._style._layers[h],T=_.isHidden(this.painter.transform.zoom),C=_.getCrossfadeParameters(),k=!!C&&C.t!==1,B=_.hasTransition();return _.type!=="custom"&&!T&&(k||B)})}_clearRasterFadeFromRenderCache(){let h=!1;for(const _ in this._style._sourceCaches)if(this._style._sourceCaches[_]._source instanceof W){h=!0;break}if(h)for(let _=0;_<this._style.order.length;++_){const T=this._style._layers[this._style.order[_]],C=T.isHidden(this.painter.transform.zoom),k=this._style._getLayerSourceCache(T);if(T.type!=="raster"||C||!k)continue;const B=T.paint.get("raster-fade-duration");for(const F of this.proxyCoords){const V=this.proxyToSource[F.key][k.id];if(V)for(const Z of V){const X=Sa(k.getTile(Z),k.findLoadedParent(Z,0),k,this.painter.transform,B);(X.opacity!==1||X.mix!==0)&&this._clearRenderCacheForTile(k.id,Z)}}}}_setupDrapedRenderBatches(){const h=this._style.order,_=h.length;if(_===0)return;const T=[];let C,k=0,B=this._style._layers[h[k]];for(;!this._style.isLayerDraped(B)&&B.isHidden(this.painter.transform.zoom)&&++k<_;)B=this._style._layers[h[k]];for(;k<_;++k){const F=this._style._layers[h[k]];F.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(F)?C===void 0&&(C=k):C!==void 0&&(T.push({start:C,end:k-1}),C=void 0))}C!==void 0&&T.push({start:C,end:k-1}),this._drapedRenderBatches=T}_setupRenderCache(h){const _=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,_.renderCache.length>_.renderCachePool.length){const B=Object.values(_.proxyCachedFBO);_.proxyCachedFBO={};for(let F=0;F<B.length;++F){const V=Object.values(B[F]);_.renderCachePool.push(...V)}}return}this._clearRasterFadeFromRenderCache();const T=this.proxyCoords,C=this._tilesDirty;for(let B=T.length-1;B>=0;B--){const F=T[B];if(_.getTileByID(F.key),_.proxyCachedFBO[F.key]!==void 0){const V=h[F.key],Z=this.proxyToSource[F.key];let X=0;for(const te in Z){const le=Z[te],ge=V[te];if(!ge||ge.length!==le.length||le.some((de,se)=>de!==ge[se]||C[te]&&C[te].hasOwnProperty(de.key))){X=-1;break}++X}for(const te in _.proxyCachedFBO[F.key])_.renderCache[_.proxyCachedFBO[F.key][te]].dirty=X<0||X!==Object.values(V).length}}const k=[...this._drapedRenderBatches];k.sort((B,F)=>F.end-F.start-(B.end-B.start));for(const B of k)for(const F of T){if(_.proxyCachedFBO[F.key])continue;let V=_.renderCachePool.pop();V===void 0&&_.renderCache.length<50&&(V=_.renderCache.length,_.renderCache.push(this._createFBO())),V!==void 0&&(_.proxyCachedFBO[F.key]={},_.proxyCachedFBO[F.key][B.start]=V,_.renderCache[V].dirty=!0)}this._tilesDirty={}}_setupStencil(h,_,T,C){if(!C||!this._sourceTilesOverlap[C.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const k=this.painter.context,B=k.gl;if(_.length<=1)return void(this._overlapStencilType=!1);let F;if(T.isTileClipped())F=_.length,this._overlapStencilMode.test={func:B.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(_[0].overscaledZ>_[_.length-1].overscaledZ))return void(this._overlapStencilType=!1);F=1,this._overlapStencilMode.test={func:B.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+F>255&&(k.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=F,this._overlapStencilMode.ref=this._stencilRef,T.isTileClipped()&&this._renderTileClippingMasks(_,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(h){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs.get(h.key)||0),this._overlapStencilMode):u.StencilMode.disabled}_renderTileClippingMasks(h,_){const T=this.painter,C=this.painter.context,k=C.gl;T._tileClippingMaskIDs.clear(),C.setColorMode(u.ColorMode.disabled),C.setDepthMode(u.DepthMode.disabled);const B=T.useProgram("clippingMask");for(const F of h){const V=--_;T._tileClippingMaskIDs.set(F.key,V),B.draw(C,k.TRIANGLES,u.DepthMode.disabled,new u.StencilMode({func:k.ALWAYS,mask:0},V,255,k.KEEP,k.KEEP,k.REPLACE),u.ColorMode.disabled,u.CullFaceMode.disabled,ks(F.projMatrix),"$clipping",T.tileExtentBuffer,T.quadTriangleIndexBuffer,T.tileExtentSegments)}}pointCoordinate(h){const _=this.painter.transform;if(h.x<0||h.x>_.width||h.y<0||h.y>_.height)return null;const T=[h.x,h.y,1,1];u.transformMat4$1(T,T,_.pixelMatrixInverse),u.scale$1(T,T,1/T[3]),T[0]/=_.worldSize,T[1]/=_.worldSize;const C=_._camera.position,k=u.mercatorZfromAltitude(1,_.center.lat),B=[C[0],C[1],C[2]/k,0],F=u.subtract([],T.slice(0,3),B);u.normalize(F,F);const V=this.raycast(B,F,this._exaggeration);return V!==null&&V?(u.scaleAndAdd(B,B,F,V),B[3]=B[2],B[2]*=k,B):null}drawDepth(){const h=this.painter,_=h.context,T=this.proxySourceCache,C=Math.ceil(h.width),k=Math.ceil(h.height);if(!this._depthFBO||this._depthFBO.width===C&&this._depthFBO.height===k||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const B=_.gl,F=_.createFramebuffer(C,k,!0);_.activeTexture.set(B.TEXTURE0);const V=new u.Texture(_,{width:C,height:k,data:null},B.RGBA);V.bind(B.NEAREST,B.CLAMP_TO_EDGE),F.colorAttachment.set(V.texture);const Z=_.createRenderbuffer(_.gl.DEPTH_COMPONENT16,C,k);F.depthAttachment.set(Z),this._depthFBO=F,this._depthTexture=V}_.bindFramebuffer.set(this._depthFBO.framebuffer),_.viewport.set([0,0,C,k]),function(B,F,V,Z){if(B.transform.projection.name==="globe")return;const X=B.context,te=X.gl;X.clear({depth:1});const le=B.useProgram("terrainDepth"),ge=new u.DepthMode(te.LESS,u.DepthMode.ReadWrite,B.depthRangeFor3D);for(const de of Z){const se=V.getTile(de),Se=jl(de.projMatrix,0);F.setupElevationDraw(se,le),le.draw(X,te.TRIANGLES,ge,u.StencilMode.disabled,u.ColorMode.unblended,u.CullFaceMode.backCCW,Se,"terrain_depth",F.gridBuffer,F.gridIndexBuffer,F.gridNoSkirtSegments)}}(h,this,T,this.proxyCoords)}_setupProxiedCoordsForOrtho(h,_,T){if(h.getSource()instanceof ke)return this._setupProxiedCoordsForImageSource(h,_,T);this._findCoveringTileCache[h.id]=this._findCoveringTileCache[h.id]||{};const C=this.proxiedCoords[h.id]=[],k=this.proxyCoords;for(let F=0;F<k.length;F++){const V=k[F],Z=this._findTileCoveringTileID(V,h);if(Z){const X=this._createProxiedId(V,Z,T[V.key]&&T[V.key][h.id]);C.push(X),this.proxyToSource[V.key][h.id]=[X]}}let B=!1;for(let F=0;F<_.length;F++){const V=h.getTile(_[F]);if(!V||!V.hasData())continue;const Z=this._findTileCoveringTileID(V.tileID,this.proxySourceCache);if(Z&&Z.tileID.canonical.z!==V.tileID.canonical.z){const X=this.proxyToSource[Z.tileID.key][h.id],te=this._createProxiedId(Z.tileID,V,T[Z.tileID.key]&&T[Z.tileID.key][h.id]);X?X.splice(X.length-1,0,te):this.proxyToSource[Z.tileID.key][h.id]=[te],C.push(te),B=!0}}this._sourceTilesOverlap[h.id]=B}_setupProxiedCoordsForImageSource(h,_,T){if(!h.getSource().loaded())return;const C=this.proxiedCoords[h.id]=[],k=this.proxyCoords,B=h.getSource(),F=new u.pointGeometry(B.tileID.x,B.tileID.y)._div(1<<B.tileID.z),V=B.coordinates.map(u.MercatorCoordinate.fromLngLat).reduce((X,te)=>(X.min.x=Math.min(X.min.x,te.x-F.x),X.min.y=Math.min(X.min.y,te.y-F.y),X.max.x=Math.max(X.max.x,te.x-F.x),X.max.y=Math.max(X.max.y,te.y-F.y),X),{min:new u.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new u.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),Z=(X,te)=>{const le=X.wrap+X.canonical.x/(1<<X.canonical.z),ge=X.canonical.y/(1<<X.canonical.z),de=u.EXTENT/(1<<X.canonical.z),se=te.wrap+te.canonical.x/(1<<te.canonical.z),Se=te.canonical.y/(1<<te.canonical.z);return le+de<se+V.min.x||le>se+V.max.x||ge+de<Se+V.min.y||ge>Se+V.max.y};for(let X=0;X<k.length;X++){const te=k[X];for(let le=0;le<_.length;le++){const ge=h.getTile(_[le]);if(!ge||!ge.hasData()||Z(te,ge.tileID))continue;const de=this._createProxiedId(te,ge,T[te.key]&&T[te.key][h.id]),se=this.proxyToSource[te.key][h.id];se?se.push(de):this.proxyToSource[te.key][h.id]=[de],C.push(de)}}}_createProxiedId(h,_,T){let C=this.orthoMatrix;if(T){const k=T.find(B=>B.key===_.tileID.key);if(k)return k}if(_.tileID.key!==h.key){const k=h.canonical.z-_.tileID.canonical.z;let B,F,V;C=u.create();const Z=_.tileID.wrap-h.wrap<<h.overscaledZ;k>0?(B=u.EXTENT>>k,F=B*((_.tileID.canonical.x<<k)-h.canonical.x+Z),V=B*((_.tileID.canonical.y<<k)-h.canonical.y)):(B=u.EXTENT<<-k,F=u.EXTENT*(_.tileID.canonical.x-(h.canonical.x+Z<<-k)),V=u.EXTENT*(_.tileID.canonical.y-(h.canonical.y<<-k))),u.ortho(C,0,B,0,B,0,1),u.translate(C,C,[F,V,0])}return new Aa(_.tileID,h.key,C)}_findTileCoveringTileID(h,_){let T=_.getTile(h);if(T&&T.hasData())return T;const C=this._findCoveringTileCache[_.id],k=C[h.key];if(T=k?_.getTileByID(k):null,T&&T.hasData()||k===null)return T;let B=T?T.tileID:h,F=B.overscaledZ;const V=_.getSource().minzoom,Z=[];if(!k){const te=_.getSource().maxzoom;if(h.canonical.z>=te){const le=h.canonical.z-te;_.getSource().reparseOverscaled?(F=Math.max(h.canonical.z+2,_.transform.tileZoom),B=new u.OverscaledTileID(F,h.wrap,te,h.canonical.x>>le,h.canonical.y>>le)):le!==0&&(F=te,B=new u.OverscaledTileID(F,h.wrap,te,h.canonical.x>>le,h.canonical.y>>le))}B.key!==h.key&&(Z.push(B.key),T=_.getTile(B))}const X=te=>{Z.forEach(le=>{C[le]=te}),Z.length=0};for(F-=1;F>=V&&(!T||!T.hasData());F--){T&&X(T.tileID.key);const te=B.calculateScaledKey(F);if(T=_.getTileByID(te),T&&T.hasData())break;const le=C[te];if(le===null)break;le===void 0?Z.push(te):T=_.getTileByID(le)}return X(T?T.tileID.key:null),T&&T.hasData()?T:null}findDEMTileFor(h){return this.enabled?this._findTileCoveringTileID(h,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(h,_){let T=this._tilesDirty[h];T||(T=this._tilesDirty[h]={}),T[_.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const h=function(_){let T=0;const C=new u.StructArrayLayout2ui4,k=131;for(let B=1;B<129;B++){for(let F=1;F<129;F++)T=B*k+F,C.emplaceBack(T,T+1),C.emplaceBack(T,T+k),C.emplaceBack(T+1,T+k),B===128&&C.emplaceBack(T+k,T+k+1);C.emplaceBack(T+1,T+1+k)}return C}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(h),this.wireframeSegments=u.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,h.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}function Ds(x){const h=[];for(let _=0;_<x.length;_++){if(x[_]===null)continue;const T=x[_].split(" ");h.push(T.pop())}return h}class Xo{static cacheKey(h,_,T){let C=`${h}${T?T.cacheKey:""}`;for(const k of _)C+=`/${k}`;return C}constructor(h,_,T,C,k,B){const F=h.gl;this.program=F.createProgram();const V=Ds(T.staticAttributes),Z=C?C.getBinderAttributes():[],X=V.concat(Z),te=T.staticUniforms?Ds(T.staticUniforms):[],le=C?C.getBinderUniforms():[],ge=te.concat(le),de=[];for(const Ee of ge)de.indexOf(Ee)<0&&de.push(Ee);let se=C?C.defines():[];se=se.concat(B.map(Ee=>`#define ${Ee}`));const Se=se.concat(`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,jo,As.fragmentSource,kn.fragmentSource,T.fragmentSource).join(`
`),xe=se.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,jo,As.vertexSource,kn.vertexSource,Hn.vertexSource,T.vertexSource).join(`
`),Te=F.createShader(F.FRAGMENT_SHADER);if(F.isContextLost())return void(this.failedToCreate=!0);F.shaderSource(Te,Se),F.compileShader(Te),F.attachShader(this.program,Te);const Me=F.createShader(F.VERTEX_SHADER);if(F.isContextLost())return void(this.failedToCreate=!0);F.shaderSource(Me,xe),F.compileShader(Me),F.attachShader(this.program,Me),this.attributes={};const Ae={};this.numAttributes=X.length;for(let Ee=0;Ee<this.numAttributes;Ee++)X[Ee]&&(F.bindAttribLocation(this.program,Ee,X[Ee]),this.attributes[X[Ee]]=Ee);F.linkProgram(this.program),F.deleteShader(Me),F.deleteShader(Te);for(let Ee=0;Ee<de.length;Ee++){const De=de[Ee];if(De&&!Ae[De]){const Ue=F.getUniformLocation(this.program,De);Ue&&(Ae[De]=Ue)}}this.fixedUniforms=k(h,Ae),this.binderUniforms=C?C.getUniforms(h,Ae):[],B.indexOf("TERRAIN")!==-1&&(this.terrainUniforms=((Ee,De)=>({u_dem:new u.Uniform1i(Ee,De.u_dem),u_dem_prev:new u.Uniform1i(Ee,De.u_dem_prev),u_dem_unpack:new u.Uniform4f(Ee,De.u_dem_unpack),u_dem_tl:new u.Uniform2f(Ee,De.u_dem_tl),u_dem_scale:new u.Uniform1f(Ee,De.u_dem_scale),u_dem_tl_prev:new u.Uniform2f(Ee,De.u_dem_tl_prev),u_dem_scale_prev:new u.Uniform1f(Ee,De.u_dem_scale_prev),u_dem_size:new u.Uniform1f(Ee,De.u_dem_size),u_dem_lerp:new u.Uniform1f(Ee,De.u_dem_lerp),u_exaggeration:new u.Uniform1f(Ee,De.u_exaggeration),u_depth:new u.Uniform1i(Ee,De.u_depth),u_depth_size_inv:new u.Uniform2f(Ee,De.u_depth_size_inv),u_meter_to_dem:new u.Uniform1f(Ee,De.u_meter_to_dem),u_label_plane_matrix_inv:new u.UniformMatrix4f(Ee,De.u_label_plane_matrix_inv),u_tile_tl_up:new u.Uniform3f(Ee,De.u_tile_tl_up),u_tile_tr_up:new u.Uniform3f(Ee,De.u_tile_tr_up),u_tile_br_up:new u.Uniform3f(Ee,De.u_tile_br_up),u_tile_bl_up:new u.Uniform3f(Ee,De.u_tile_bl_up),u_tile_up_scale:new u.Uniform1f(Ee,De.u_tile_up_scale)}))(h,Ae)),B.indexOf("FOG")!==-1&&(this.fogUniforms=((Ee,De)=>({u_fog_matrix:new u.UniformMatrix4f(Ee,De.u_fog_matrix),u_fog_range:new u.Uniform2f(Ee,De.u_fog_range),u_fog_color:new u.Uniform4f(Ee,De.u_fog_color),u_fog_horizon_blend:new u.Uniform1f(Ee,De.u_fog_horizon_blend),u_fog_temporal_offset:new u.Uniform1f(Ee,De.u_fog_temporal_offset)}))(h,Ae))}setTerrainUniformValues(h,_){if(!this.terrainUniforms)return;const T=this.terrainUniforms;if(!this.failedToCreate){h.program.set(this.program);for(const C in _)T[C].set(_[C])}}setFogUniformValues(h,_){if(!this.fogUniforms)return;const T=this.fogUniforms;if(!this.failedToCreate){h.program.set(this.program);for(const C in _)T[C].location&&T[C].set(_[C])}}draw(h,_,T,C,k,B,F,V,Z,X,te,le,ge,de,se,Se){const xe=h.gl;if(this.failedToCreate)return;h.program.set(this.program),h.setDepthMode(T),h.setStencilMode(C),h.setColorMode(k),h.setCullFace(B);for(const Me of Object.keys(this.fixedUniforms))this.fixedUniforms[Me].set(F[Me]);de&&de.setUniforms(h,this.binderUniforms,le,{zoom:ge});const Te={[xe.LINES]:2,[xe.TRIANGLES]:3,[xe.LINE_STRIP]:1}[_];for(const Me of te.get()){const Ae=Me.vaos||(Me.vaos={});(Ae[V]||(Ae[V]=new Is)).bind(h,this,Z,de?de.getPaintVertexBuffers():[],X,Me.vertexOffset,se,Se),xe.drawElements(_,Me.primitiveLength*Te,xe.UNSIGNED_SHORT,Me.primitiveOffset*Te*2)}}}function Yo(x,h,_){const T=1/gt(_,1,h.transform.tileZoom),C=Math.pow(2,_.tileID.overscaledZ),k=_.tileSize*Math.pow(2,h.transform.tileZoom)/C,B=k*(_.tileID.canonical.x+_.tileID.wrap*C),F=k*_.tileID.canonical.y;return{u_image:0,u_texsize:_.imageAtlasTexture.size,u_scale:[T,x.fromScale,x.toScale],u_fade:x.t,u_pixel_coord_upper:[B>>16,F>>16],u_pixel_coord_lower:[65535&B,65535&F]}}const Ia=u.create(),Ps=(x,h,_,T,C,k,B,F,V)=>{const Z=h.style.light,X=Z.properties.get("position"),te=[X.x,X.y,X.z],le=u.create$1();Z.properties.get("anchor")==="viewport"&&(u.fromRotation(le,-h.transform.angle),u.transformMat3(te,te,le));const ge=Z.properties.get("color"),de=h.transform,se={u_matrix:x,u_lightpos:te,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[ge.r,ge.g,ge.b],u_vertical_gradient:+_,u_opacity:T,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Ia,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0};return de.projection.name==="globe"&&(se.u_tile_id=[C.canonical.x,C.canonical.y,1<<C.canonical.z],se.u_zoom_transition=B,se.u_inv_rot_matrix=V,se.u_merc_center=F,se.u_up_dir=de.projection.upVector(new u.CanonicalTileID(0,0,0),F[0]*u.EXTENT,F[1]*u.EXTENT),se.u_height_lift=k),se},Bs=(x,h,_,T,C,k,B,F,V,Z,X)=>{const te=Ps(x,h,_,T,C,F,V,Z,X),le={u_height_factor:-Math.pow(2,C.overscaledZ)/B.tileSize/8};return u.extend(te,Yo(k,h,B),le)},Rs=x=>({u_matrix:x}),Ls=(x,h,_,T)=>u.extend(Rs(x),Yo(_,h,T)),zs=(x,h)=>({u_matrix:x,u_world:h}),ql=(x,h,_,T,C)=>u.extend(Ls(x,h,_,T),{u_world:C}),Zl=u.create(),go=(x,h,_,T,C,k)=>{const B=x.transform,F=B.projection.name==="globe";let V;if(k.paint.get("circle-pitch-alignment")==="map")if(F){const X=u.globePixelsToTileUnits(B.zoom,h.canonical);V=Float32Array.from([X,0,0,X])}else V=B.calculatePixelsToTileUnitsMatrix(_);else V=new Float32Array([B.pixelsToGLUnits[0],0,0,B.pixelsToGLUnits[1]]);const Z={u_camera_to_center_distance:B.cameraToCenterDistance,u_matrix:x.translatePosMatrix(h.projMatrix,_,k.paint.get("circle-translate"),k.paint.get("circle-translate-anchor")),u_device_pixel_ratio:u.exported.devicePixelRatio,u_extrude_scale:V,u_inv_rot_matrix:Zl,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};return F&&(Z.u_inv_rot_matrix=T,Z.u_merc_center=C,Z.u_tile_id=[h.canonical.x,h.canonical.y,1<<h.canonical.z],Z.u_zoom_transition=u.globeToMercatorTransition(B.zoom),Z.u_up_dir=B.projection.upVector(h.canonical,C[0],C[1])),Z},uh=x=>{const h=[];return x.paint.get("circle-pitch-alignment")==="map"&&h.push("PITCH_WITH_MAP"),x.paint.get("circle-pitch-scale")==="map"&&h.push("SCALE_WITH_MAP"),h},dh=(x,h,_)=>{const T=u.EXTENT/_.tileSize;return{u_matrix:x,u_camera_to_center_distance:h.cameraToCenterDistance,u_extrude_scale:[h.pixelsToGLUnits[0]/T,h.pixelsToGLUnits[1]/T]}},Xl=(x,h,_=1)=>({u_matrix:x,u_color:h,u_overlay:0,u_overlay_scale:_}),fh=u.create(),ph=(x,h,_,T,C,k,B)=>{const F=x.transform,V=F.projection.name==="globe",Z=V?u.globePixelsToTileUnits(F.zoom,h.canonical):gt(_,1,k),X={u_matrix:h.projMatrix,u_extrude_scale:Z,u_intensity:B,u_inv_rot_matrix:fh,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};return V&&(X.u_inv_rot_matrix=T,X.u_merc_center=C,X.u_tile_id=[h.canonical.x,h.canonical.y,1<<h.canonical.z],X.u_zoom_transition=u.globeToMercatorTransition(F.zoom),X.u_up_dir=F.projection.upVector(h.canonical,C[0],C[1])),X},mh=(x,h,_,T,C,k,B)=>{const F=x.transform,V=F.calculatePixelsToTileUnitsMatrix(h),Z={u_matrix:Kn(x,h,_,C),u_pixels_to_tile_units:V,u_device_pixel_ratio:B,u_units_to_pixels:[1/F.pixelsToGLUnits[0],1/F.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:k,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0,u_alpha_discard_threshold:0};if(ka(_)){const X=Fs(h,x.transform);Z.u_texsize=h.lineAtlasTexture.size,Z.u_scale=[X,T.fromScale,T.toScale],Z.u_mix=T.t}return Z},Ca=(x,h,_,T,C,k)=>{const B=x.transform,F=Fs(h,B);return{u_matrix:Kn(x,h,_,C),u_texsize:h.imageAtlasTexture.size,u_pixels_to_tile_units:B.calculatePixelsToTileUnitsMatrix(h),u_device_pixel_ratio:k,u_image:0,u_scale:[F,T.fromScale,T.toScale],u_fade:T.t,u_units_to_pixels:[1/B.pixelsToGLUnits[0],1/B.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Fs(x,h){return 1/gt(x,1,h.tileZoom)}function Kn(x,h,_,T){return x.translatePosMatrix(T||h.tileID.projMatrix,h,_.paint.get("line-translate"),_.paint.get("line-translate-anchor"))}function ka(x){const h=x.paint.get("line-dasharray").value;return h.value||h.kind!=="constant"}const Yl=(x,h,_,T,C,k)=>{return{u_matrix:x,u_tl_parent:h,u_scale_parent:_,u_fade_t:T.mix,u_opacity:T.opacity*C.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:C.paint.get("raster-brightness-min"),u_brightness_high:C.paint.get("raster-brightness-max"),u_saturation_factor:(F=C.paint.get("raster-saturation"),F>0?1-1/(1.001-F):-F),u_contrast_factor:(B=C.paint.get("raster-contrast"),B>0?1/(1-B):1+B),u_spin_weights:Da(C.paint.get("raster-hue-rotate")),u_perspective_transform:k};var B,F};function Da(x){x*=Math.PI/180;const h=Math.sin(x),_=Math.cos(x);return[(2*_+1)/3,(-Math.sqrt(3)*h-_+1)/3,(Math.sqrt(3)*h-_+1)/3]}const Pn=u.create(),Pa=(x,h,_,T,C,k,B,F,V,Z,X,te,le,ge)=>{const de=C.transform,se={u_is_size_zoom_constant:+(x==="constant"||x==="source"),u_is_size_feature_constant:+(x==="constant"||x==="camera"),u_size_t:h?h.uSizeT:0,u_size:h?h.uSize:0,u_camera_to_center_distance:de.cameraToCenterDistance,u_rotate_symbol:+_,u_aspect_ratio:de.width/de.height,u_fade_change:C.options.fadeDuration?C.symbolFadeChange:1,u_matrix:k,u_label_plane_matrix:B,u_coord_matrix:F,u_is_text:+V,u_pitch_with_map:+T,u_texsize:Z,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Pn,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Pn};return de.projection.name==="globe"&&(se.u_tile_id=[X.canonical.x,X.canonical.y,1<<X.canonical.z],se.u_zoom_transition=te,se.u_inv_rot_matrix=ge,se.u_merc_center=le,se.u_camera_forward=de._camera.forward(),se.u_ecef_origin=u.globeECEFOrigin(de.globeMatrix,X.toUnwrapped()),se.u_tile_matrix=Float32Array.from(de.globeMatrix)),se},Jn=(x,h,_,T,C,k,B,F,V,Z,X,te,le,ge,de)=>{const{cameraToCenterDistance:se,_pitch:Se}=C.transform;return u.extend(Pa(x,h,_,T,C,k,B,F,V,Z,te,le,ge,de),{u_gamma_scale:T?se*Math.cos(C.terrain?0:Se):1,u_device_pixel_ratio:u.exported.devicePixelRatio,u_is_halo:+X})},_o=(x,h,_,T,C,k,B,F,V,Z,X,te,le,ge)=>u.extend(Jn(x,h,_,T,C,k,B,F,!0,V,!0,X,te,le,ge),{u_texsize_icon:Z,u_texture_icon:1}),Wl=(x,h,_)=>({u_matrix:x,u_opacity:h,u_color:_}),Ba=(x,h,_,T,C,k)=>u.extend(function(B,F,V,Z){const X=V.imageManager.getPattern(B.from.toString()),te=V.imageManager.getPattern(B.to.toString()),{width:le,height:ge}=V.imageManager.getPixelSize(),de=Math.pow(2,Z.tileID.overscaledZ),se=Z.tileSize*Math.pow(2,V.transform.tileZoom)/de,Se=se*(Z.tileID.canonical.x+Z.tileID.wrap*de),xe=se*Z.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:X.tl,u_pattern_br_a:X.br,u_pattern_tl_b:te.tl,u_pattern_br_b:te.br,u_texsize:[le,ge],u_mix:F.t,u_pattern_size_a:X.displaySize,u_pattern_size_b:te.displaySize,u_scale_a:F.fromScale,u_scale_b:F.toScale,u_tile_units_to_pixels:1/gt(Z,1,V.transform.tileZoom),u_pixel_coord_upper:[Se>>16,xe>>16],u_pixel_coord_lower:[65535&Se,65535&xe]}}(T,k,_,C),{u_matrix:x,u_opacity:h}),Li={fillExtrusion:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_lightpos:new u.Uniform3f(x,h.u_lightpos),u_lightintensity:new u.Uniform1f(x,h.u_lightintensity),u_lightcolor:new u.Uniform3f(x,h.u_lightcolor),u_vertical_gradient:new u.Uniform1f(x,h.u_vertical_gradient),u_opacity:new u.Uniform1f(x,h.u_opacity),u_tile_id:new u.Uniform3f(x,h.u_tile_id),u_zoom_transition:new u.Uniform1f(x,h.u_zoom_transition),u_inv_rot_matrix:new u.UniformMatrix4f(x,h.u_inv_rot_matrix),u_merc_center:new u.Uniform2f(x,h.u_merc_center),u_up_dir:new u.Uniform3f(x,h.u_up_dir),u_height_lift:new u.Uniform1f(x,h.u_height_lift)}),fillExtrusionPattern:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_lightpos:new u.Uniform3f(x,h.u_lightpos),u_lightintensity:new u.Uniform1f(x,h.u_lightintensity),u_lightcolor:new u.Uniform3f(x,h.u_lightcolor),u_vertical_gradient:new u.Uniform1f(x,h.u_vertical_gradient),u_height_factor:new u.Uniform1f(x,h.u_height_factor),u_tile_id:new u.Uniform3f(x,h.u_tile_id),u_zoom_transition:new u.Uniform1f(x,h.u_zoom_transition),u_inv_rot_matrix:new u.UniformMatrix4f(x,h.u_inv_rot_matrix),u_merc_center:new u.Uniform2f(x,h.u_merc_center),u_up_dir:new u.Uniform3f(x,h.u_up_dir),u_height_lift:new u.Uniform1f(x,h.u_height_lift),u_image:new u.Uniform1i(x,h.u_image),u_texsize:new u.Uniform2f(x,h.u_texsize),u_pixel_coord_upper:new u.Uniform2f(x,h.u_pixel_coord_upper),u_pixel_coord_lower:new u.Uniform2f(x,h.u_pixel_coord_lower),u_scale:new u.Uniform3f(x,h.u_scale),u_fade:new u.Uniform1f(x,h.u_fade),u_opacity:new u.Uniform1f(x,h.u_opacity)}),fill:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix)}),fillPattern:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_image:new u.Uniform1i(x,h.u_image),u_texsize:new u.Uniform2f(x,h.u_texsize),u_pixel_coord_upper:new u.Uniform2f(x,h.u_pixel_coord_upper),u_pixel_coord_lower:new u.Uniform2f(x,h.u_pixel_coord_lower),u_scale:new u.Uniform3f(x,h.u_scale),u_fade:new u.Uniform1f(x,h.u_fade)}),fillOutline:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_world:new u.Uniform2f(x,h.u_world)}),fillOutlinePattern:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_world:new u.Uniform2f(x,h.u_world),u_image:new u.Uniform1i(x,h.u_image),u_texsize:new u.Uniform2f(x,h.u_texsize),u_pixel_coord_upper:new u.Uniform2f(x,h.u_pixel_coord_upper),u_pixel_coord_lower:new u.Uniform2f(x,h.u_pixel_coord_lower),u_scale:new u.Uniform3f(x,h.u_scale),u_fade:new u.Uniform1f(x,h.u_fade)}),circle:(x,h)=>({u_camera_to_center_distance:new u.Uniform1f(x,h.u_camera_to_center_distance),u_extrude_scale:new u.UniformMatrix2f(x,h.u_extrude_scale),u_device_pixel_ratio:new u.Uniform1f(x,h.u_device_pixel_ratio),u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_inv_rot_matrix:new u.UniformMatrix4f(x,h.u_inv_rot_matrix),u_merc_center:new u.Uniform2f(x,h.u_merc_center),u_tile_id:new u.Uniform3f(x,h.u_tile_id),u_zoom_transition:new u.Uniform1f(x,h.u_zoom_transition),u_up_dir:new u.Uniform3f(x,h.u_up_dir)}),collisionBox:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_camera_to_center_distance:new u.Uniform1f(x,h.u_camera_to_center_distance),u_extrude_scale:new u.Uniform2f(x,h.u_extrude_scale)}),collisionCircle:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_inv_matrix:new u.UniformMatrix4f(x,h.u_inv_matrix),u_camera_to_center_distance:new u.Uniform1f(x,h.u_camera_to_center_distance),u_viewport_size:new u.Uniform2f(x,h.u_viewport_size)}),debug:(x,h)=>({u_color:new u.UniformColor(x,h.u_color),u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_overlay:new u.Uniform1i(x,h.u_overlay),u_overlay_scale:new u.Uniform1f(x,h.u_overlay_scale)}),clippingMask:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix)}),heatmap:(x,h)=>({u_extrude_scale:new u.Uniform1f(x,h.u_extrude_scale),u_intensity:new u.Uniform1f(x,h.u_intensity),u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_inv_rot_matrix:new u.UniformMatrix4f(x,h.u_inv_rot_matrix),u_merc_center:new u.Uniform2f(x,h.u_merc_center),u_tile_id:new u.Uniform3f(x,h.u_tile_id),u_zoom_transition:new u.Uniform1f(x,h.u_zoom_transition),u_up_dir:new u.Uniform3f(x,h.u_up_dir)}),heatmapTexture:(x,h)=>({u_image:new u.Uniform1i(x,h.u_image),u_color_ramp:new u.Uniform1i(x,h.u_color_ramp),u_opacity:new u.Uniform1f(x,h.u_opacity)}),hillshade:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_image:new u.Uniform1i(x,h.u_image),u_latrange:new u.Uniform2f(x,h.u_latrange),u_light:new u.Uniform2f(x,h.u_light),u_shadow:new u.UniformColor(x,h.u_shadow),u_highlight:new u.UniformColor(x,h.u_highlight),u_accent:new u.UniformColor(x,h.u_accent)}),hillshadePrepare:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_image:new u.Uniform1i(x,h.u_image),u_dimension:new u.Uniform2f(x,h.u_dimension),u_zoom:new u.Uniform1f(x,h.u_zoom),u_unpack:new u.Uniform4f(x,h.u_unpack)}),line:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_pixels_to_tile_units:new u.UniformMatrix2f(x,h.u_pixels_to_tile_units),u_device_pixel_ratio:new u.Uniform1f(x,h.u_device_pixel_ratio),u_units_to_pixels:new u.Uniform2f(x,h.u_units_to_pixels),u_dash_image:new u.Uniform1i(x,h.u_dash_image),u_gradient_image:new u.Uniform1i(x,h.u_gradient_image),u_image_height:new u.Uniform1f(x,h.u_image_height),u_texsize:new u.Uniform2f(x,h.u_texsize),u_scale:new u.Uniform3f(x,h.u_scale),u_mix:new u.Uniform1f(x,h.u_mix),u_alpha_discard_threshold:new u.Uniform1f(x,h.u_alpha_discard_threshold)}),linePattern:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_texsize:new u.Uniform2f(x,h.u_texsize),u_pixels_to_tile_units:new u.UniformMatrix2f(x,h.u_pixels_to_tile_units),u_device_pixel_ratio:new u.Uniform1f(x,h.u_device_pixel_ratio),u_image:new u.Uniform1i(x,h.u_image),u_units_to_pixels:new u.Uniform2f(x,h.u_units_to_pixels),u_scale:new u.Uniform3f(x,h.u_scale),u_fade:new u.Uniform1f(x,h.u_fade),u_alpha_discard_threshold:new u.Uniform1f(x,h.u_alpha_discard_threshold)}),raster:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_tl_parent:new u.Uniform2f(x,h.u_tl_parent),u_scale_parent:new u.Uniform1f(x,h.u_scale_parent),u_fade_t:new u.Uniform1f(x,h.u_fade_t),u_opacity:new u.Uniform1f(x,h.u_opacity),u_image0:new u.Uniform1i(x,h.u_image0),u_image1:new u.Uniform1i(x,h.u_image1),u_brightness_low:new u.Uniform1f(x,h.u_brightness_low),u_brightness_high:new u.Uniform1f(x,h.u_brightness_high),u_saturation_factor:new u.Uniform1f(x,h.u_saturation_factor),u_contrast_factor:new u.Uniform1f(x,h.u_contrast_factor),u_spin_weights:new u.Uniform3f(x,h.u_spin_weights),u_perspective_transform:new u.Uniform2f(x,h.u_perspective_transform)}),symbolIcon:(x,h)=>({u_is_size_zoom_constant:new u.Uniform1i(x,h.u_is_size_zoom_constant),u_is_size_feature_constant:new u.Uniform1i(x,h.u_is_size_feature_constant),u_size_t:new u.Uniform1f(x,h.u_size_t),u_size:new u.Uniform1f(x,h.u_size),u_camera_to_center_distance:new u.Uniform1f(x,h.u_camera_to_center_distance),u_rotate_symbol:new u.Uniform1i(x,h.u_rotate_symbol),u_aspect_ratio:new u.Uniform1f(x,h.u_aspect_ratio),u_fade_change:new u.Uniform1f(x,h.u_fade_change),u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_label_plane_matrix:new u.UniformMatrix4f(x,h.u_label_plane_matrix),u_coord_matrix:new u.UniformMatrix4f(x,h.u_coord_matrix),u_is_text:new u.Uniform1i(x,h.u_is_text),u_pitch_with_map:new u.Uniform1i(x,h.u_pitch_with_map),u_texsize:new u.Uniform2f(x,h.u_texsize),u_tile_id:new u.Uniform3f(x,h.u_tile_id),u_zoom_transition:new u.Uniform1f(x,h.u_zoom_transition),u_inv_rot_matrix:new u.UniformMatrix4f(x,h.u_inv_rot_matrix),u_merc_center:new u.Uniform2f(x,h.u_merc_center),u_camera_forward:new u.Uniform3f(x,h.u_camera_forward),u_tile_matrix:new u.UniformMatrix4f(x,h.u_tile_matrix),u_ecef_origin:new u.Uniform3f(x,h.u_ecef_origin),u_texture:new u.Uniform1i(x,h.u_texture)}),symbolSDF:(x,h)=>({u_is_size_zoom_constant:new u.Uniform1i(x,h.u_is_size_zoom_constant),u_is_size_feature_constant:new u.Uniform1i(x,h.u_is_size_feature_constant),u_size_t:new u.Uniform1f(x,h.u_size_t),u_size:new u.Uniform1f(x,h.u_size),u_camera_to_center_distance:new u.Uniform1f(x,h.u_camera_to_center_distance),u_rotate_symbol:new u.Uniform1i(x,h.u_rotate_symbol),u_aspect_ratio:new u.Uniform1f(x,h.u_aspect_ratio),u_fade_change:new u.Uniform1f(x,h.u_fade_change),u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_label_plane_matrix:new u.UniformMatrix4f(x,h.u_label_plane_matrix),u_coord_matrix:new u.UniformMatrix4f(x,h.u_coord_matrix),u_is_text:new u.Uniform1i(x,h.u_is_text),u_pitch_with_map:new u.Uniform1i(x,h.u_pitch_with_map),u_texsize:new u.Uniform2f(x,h.u_texsize),u_texture:new u.Uniform1i(x,h.u_texture),u_gamma_scale:new u.Uniform1f(x,h.u_gamma_scale),u_device_pixel_ratio:new u.Uniform1f(x,h.u_device_pixel_ratio),u_tile_id:new u.Uniform3f(x,h.u_tile_id),u_zoom_transition:new u.Uniform1f(x,h.u_zoom_transition),u_inv_rot_matrix:new u.UniformMatrix4f(x,h.u_inv_rot_matrix),u_merc_center:new u.Uniform2f(x,h.u_merc_center),u_camera_forward:new u.Uniform3f(x,h.u_camera_forward),u_tile_matrix:new u.UniformMatrix4f(x,h.u_tile_matrix),u_ecef_origin:new u.Uniform3f(x,h.u_ecef_origin),u_is_halo:new u.Uniform1i(x,h.u_is_halo)}),symbolTextAndIcon:(x,h)=>({u_is_size_zoom_constant:new u.Uniform1i(x,h.u_is_size_zoom_constant),u_is_size_feature_constant:new u.Uniform1i(x,h.u_is_size_feature_constant),u_size_t:new u.Uniform1f(x,h.u_size_t),u_size:new u.Uniform1f(x,h.u_size),u_camera_to_center_distance:new u.Uniform1f(x,h.u_camera_to_center_distance),u_rotate_symbol:new u.Uniform1i(x,h.u_rotate_symbol),u_aspect_ratio:new u.Uniform1f(x,h.u_aspect_ratio),u_fade_change:new u.Uniform1f(x,h.u_fade_change),u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_label_plane_matrix:new u.UniformMatrix4f(x,h.u_label_plane_matrix),u_coord_matrix:new u.UniformMatrix4f(x,h.u_coord_matrix),u_is_text:new u.Uniform1i(x,h.u_is_text),u_pitch_with_map:new u.Uniform1i(x,h.u_pitch_with_map),u_texsize:new u.Uniform2f(x,h.u_texsize),u_texsize_icon:new u.Uniform2f(x,h.u_texsize_icon),u_texture:new u.Uniform1i(x,h.u_texture),u_texture_icon:new u.Uniform1i(x,h.u_texture_icon),u_gamma_scale:new u.Uniform1f(x,h.u_gamma_scale),u_device_pixel_ratio:new u.Uniform1f(x,h.u_device_pixel_ratio),u_is_halo:new u.Uniform1i(x,h.u_is_halo)}),background:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_opacity:new u.Uniform1f(x,h.u_opacity),u_color:new u.UniformColor(x,h.u_color)}),backgroundPattern:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_opacity:new u.Uniform1f(x,h.u_opacity),u_image:new u.Uniform1i(x,h.u_image),u_pattern_tl_a:new u.Uniform2f(x,h.u_pattern_tl_a),u_pattern_br_a:new u.Uniform2f(x,h.u_pattern_br_a),u_pattern_tl_b:new u.Uniform2f(x,h.u_pattern_tl_b),u_pattern_br_b:new u.Uniform2f(x,h.u_pattern_br_b),u_texsize:new u.Uniform2f(x,h.u_texsize),u_mix:new u.Uniform1f(x,h.u_mix),u_pattern_size_a:new u.Uniform2f(x,h.u_pattern_size_a),u_pattern_size_b:new u.Uniform2f(x,h.u_pattern_size_b),u_scale_a:new u.Uniform1f(x,h.u_scale_a),u_scale_b:new u.Uniform1f(x,h.u_scale_b),u_pixel_coord_upper:new u.Uniform2f(x,h.u_pixel_coord_upper),u_pixel_coord_lower:new u.Uniform2f(x,h.u_pixel_coord_lower),u_tile_units_to_pixels:new u.Uniform1f(x,h.u_tile_units_to_pixels)}),terrainRaster:Ta,terrainDepth:Ta,skybox:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_sun_direction:new u.Uniform3f(x,h.u_sun_direction),u_cubemap:new u.Uniform1i(x,h.u_cubemap),u_opacity:new u.Uniform1f(x,h.u_opacity),u_temporal_offset:new u.Uniform1f(x,h.u_temporal_offset)}),skyboxGradient:(x,h)=>({u_matrix:new u.UniformMatrix4f(x,h.u_matrix),u_color_ramp:new u.Uniform1i(x,h.u_color_ramp),u_center_direction:new u.Uniform3f(x,h.u_center_direction),u_radius:new u.Uniform1f(x,h.u_radius),u_opacity:new u.Uniform1f(x,h.u_opacity),u_temporal_offset:new u.Uniform1f(x,h.u_temporal_offset)}),skyboxCapture:(x,h)=>({u_matrix_3f:new u.UniformMatrix3f(x,h.u_matrix_3f),u_sun_direction:new u.Uniform3f(x,h.u_sun_direction),u_sun_intensity:new u.Uniform1f(x,h.u_sun_intensity),u_color_tint_r:new u.Uniform4f(x,h.u_color_tint_r),u_color_tint_m:new u.Uniform4f(x,h.u_color_tint_m),u_luminance:new u.Uniform1f(x,h.u_luminance)}),globeRaster:(x,h)=>({u_proj_matrix:new u.UniformMatrix4f(x,h.u_proj_matrix),u_globe_matrix:new u.UniformMatrix4f(x,h.u_globe_matrix),u_merc_matrix:new u.UniformMatrix4f(x,h.u_merc_matrix),u_zoom_transition:new u.Uniform1f(x,h.u_zoom_transition),u_merc_center:new u.Uniform2f(x,h.u_merc_center),u_image0:new u.Uniform1i(x,h.u_image0),u_grid_matrix:new u.UniformMatrix3f(x,h.u_grid_matrix)}),globeAtmosphere:(x,h)=>({u_frustum_tl:new u.Uniform3f(x,h.u_frustum_tl),u_frustum_tr:new u.Uniform3f(x,h.u_frustum_tr),u_frustum_br:new u.Uniform3f(x,h.u_frustum_br),u_frustum_bl:new u.Uniform3f(x,h.u_frustum_bl),u_globe_pos:new u.Uniform3f(x,h.u_globe_pos),u_globe_radius:new u.Uniform1f(x,h.u_globe_radius),u_opacity:new u.Uniform1f(x,h.u_opacity),u_fadeout_range:new u.Uniform1f(x,h.u_fadeout_range),u_start_color:new u.Uniform3f(x,h.u_start_color),u_end_color:new u.Uniform3f(x,h.u_end_color)})};let Qn;function Hl(x,h,_,T,C,k,B){const F=x.context,V=F.gl,Z=x.useProgram("collisionBox"),X=[];let te=0,le=0;for(let Me=0;Me<T.length;Me++){const Ae=T[Me],Ee=h.getTile(Ae),De=Ee.getBucket(_);if(!De)continue;let Ue=Ae.projMatrix;C[0]===0&&C[1]===0||(Ue=x.translatePosMatrix(Ae.projMatrix,Ee,C,k));const Ze=B?De.textCollisionBox:De.iconCollisionBox,He=De.collisionCircleArray;if(He.length>0){const Ye=u.create(),ct=Ue;u.mul(Ye,De.placementInvProjMatrix,x.transform.glCoordMatrix),u.mul(Ye,Ye,De.placementViewportMatrix),X.push({circleArray:He,circleOffset:le,transform:ct,invTransform:Ye}),te+=He.length/4,le=te}Ze&&(x.terrain&&x.terrain.setupElevationDraw(Ee,Z),Z.draw(F,V.LINES,u.DepthMode.disabled,u.StencilMode.disabled,x.colorModeForRenderPass(),u.CullFaceMode.disabled,dh(Ue,x.transform,Ee),_.id,Ze.layoutVertexBuffer,Ze.indexBuffer,Ze.segments,null,x.transform.zoom,null,Ze.collisionVertexBuffer,Ze.collisionVertexBufferExt))}if(!B||!X.length)return;const ge=x.useProgram("collisionCircle"),de=new u.StructArrayLayout2f1f2i16;de.resize(4*te),de._trim();let se=0;for(const Me of X)for(let Ae=0;Ae<Me.circleArray.length/4;Ae++){const Ee=4*Ae,De=Me.circleArray[Ee+0],Ue=Me.circleArray[Ee+1],Ze=Me.circleArray[Ee+2],He=Me.circleArray[Ee+3];de.emplace(se++,De,Ue,Ze,He,0),de.emplace(se++,De,Ue,Ze,He,1),de.emplace(se++,De,Ue,Ze,He,2),de.emplace(se++,De,Ue,Ze,He,3)}(!Qn||Qn.length<2*te)&&(Qn=function(Me){const Ae=2*Me,Ee=new u.StructArrayLayout3ui6;Ee.resize(Ae),Ee._trim();for(let De=0;De<Ae;De++){const Ue=6*De;Ee.uint16[Ue+0]=4*De+0,Ee.uint16[Ue+1]=4*De+1,Ee.uint16[Ue+2]=4*De+2,Ee.uint16[Ue+3]=4*De+2,Ee.uint16[Ue+4]=4*De+3,Ee.uint16[Ue+5]=4*De+0}return Ee}(te));const Se=F.createIndexBuffer(Qn,!0),xe=F.createVertexBuffer(de,u.collisionCircleLayout.members,!0);for(const Me of X){const Ae={u_matrix:Me.transform,u_inv_matrix:Me.invTransform,u_camera_to_center_distance:(Te=x.transform).cameraToCenterDistance,u_viewport_size:[Te.width,Te.height]};ge.draw(F,V.TRIANGLES,u.DepthMode.disabled,u.StencilMode.disabled,x.colorModeForRenderPass(),u.CullFaceMode.disabled,Ae,_.id,xe,Se,u.SegmentVector.simpleSegment(0,2*Me.circleOffset,Me.circleArray.length,Me.circleArray.length/2),null,x.transform.zoom,null,null,null)}var Te;xe.destroy(),Se.destroy()}const Ra=u.create();function Wo(x,h,_,T,C,k){const{horizontalAlign:B,verticalAlign:F}=u.getAnchorAlignment(x),V=-(B-.5)*h,Z=-(F-.5)*_,X=u.evaluateVariableOffset(x,T);return new u.pointGeometry((V/C+X[0])*k,(Z/C+X[1])*k)}function gh(x,h,_,T,C,k,B,F,V,Z,X,te){const le=x.text.placedSymbolArray,ge=x.text.dynamicLayoutVertexArray,de=x.icon.dynamicLayoutVertexArray,se={},Se=F.projMatrix,xe=k.elevation,Te=te.upVectorScale(F.canonical,k.center.lat,k.worldSize);ge.clear();for(let Me=0;Me<le.length;Me++){const Ae=le.get(Me),Ee=x.allowVerticalPlacement&&!Ae.placedOrientation,De=Ae.hidden||!Ae.crossTileID||Ee?null:T[Ae.crossTileID];if(De){const Ue=new u.pointGeometry(Ae.tileAnchorX,Ae.tileAnchorY),Ze=te.upVector(F.canonical,Ue.x,Ue.y),He=xe?xe.getAtTileOffset(F,Ue.x,Ue.y):0,Ye=Yr([Ae.projectedAnchorX+He*Ze[0]*Te.metersToTile,Ae.projectedAnchorY+He*Ze[1]*Te.metersToTile,Ae.projectedAnchorZ+He*Ze[2]*Te.metersToTile],_?Se:B),ct=Xi(k.cameraToCenterDistance,Ye.signedDistanceFromCamera);let Ve=C.evaluateSizeForFeature(x.textSizeData,Z,Ae)*ct/u.ONE_EM;_&&(Ve*=x.tilePixelRatio/V);const{width:ht,height:at,anchor:Dt,textOffset:Je,textScale:At}=De,qt=Wo(Dt,ht,at,Je,At,Ve),It=_?Mr(Ue.add(qt),B,He*Te.metersToLabelSpace).point:Ye.point.add(h?qt.rotate(-k.angle):qt),Ct=x.allowVerticalPlacement&&Ae.placedOrientation===u.WritingMode.vertical?Math.PI/2:0;for(let Kt=0;Kt<Ae.numGlyphs;Kt++)u.addDynamicAttributes(ge,It,Ct);X&&Ae.associatedIconIndex>=0&&(se[Ae.associatedIconIndex]={shiftedAnchor:It,angle:Ct})}else ar(Ae.numGlyphs,ge)}if(X){de.clear();const Me=x.icon.placedSymbolArray;for(let Ae=0;Ae<Me.length;Ae++){const Ee=Me.get(Ae);if(Ee.hidden)ar(Ee.numGlyphs,de);else{const De=se[Ae];if(De)for(let Ue=0;Ue<Ee.numGlyphs;Ue++)u.addDynamicAttributes(de,De.shiftedAnchor,De.angle);else ar(Ee.numGlyphs,de)}}x.icon.dynamicLayoutVertexBuffer.updateData(de)}x.text.dynamicLayoutVertexBuffer.updateData(ge)}function _h(x,h,_){return _.iconsInText&&h?"symbolTextAndIcon":x?"symbolSDF":"symbolIcon"}function La(x,h,_,T,C,k,B,F,V,Z,X,te){const le=x.context,ge=le.gl,de=x.transform,se=F==="map",Se=V==="map",xe=se&&_.layout.get("symbol-placement")!=="point",Te=se&&!Se&&!xe,Me=_.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Ae=!1;const Ee=x.depthModeForSublayer(0,u.DepthMode.ReadOnly),De=[u.mercatorXfromLng(de.center.lng),u.mercatorYfromLat(de.center.lat)],Ue=_.layout.get("text-variable-anchor"),Ze=de.projection.name==="globe",He=Ze?u.globeToMercatorTransition(de.zoom):0,Ye=[],ct=[];x.terrain&&Se&&ct.push("PITCH_WITH_MAP_TERRAIN"),Ze&&ct.push("PROJECTION_GLOBE_VIEW");for(const Ve of T){const ht=h.getTile(Ve),at=ht.getBucket(_);if(!at||at.projection!==de.projection.name)continue;const Dt=C?at.text:at.icon;if(!Dt||at.fullyClipped||!Dt.segments.get().length)continue;const Je=Dt.programConfigurations.get(_.id),At=C||at.sdfIcons,qt=C?at.textSizeData:at.iconSizeData,It=Se||de.pitch!==0,Ct=u.evaluateSizeForZoom(qt,de.zoom);let Kt,mi,jt,ti,Ii=[0,0],Yi=null;if(C){if(mi=ht.glyphAtlasTexture,jt=ge.LINEAR,Kt=ht.glyphAtlasTexture.size,at.iconsInText){Ii=ht.imageAtlasTexture.size,Yi=ht.imageAtlasTexture;const Gr=qt.kind==="composite"||qt.kind==="camera";ti=It||x.options.rotating||x.options.zooming||Gr?ge.LINEAR:ge.NEAREST}}else{const Gr=_.layout.get("icon-size").constantOr(0)!==1||at.iconsNeedLinear;mi=ht.imageAtlasTexture,jt=At||x.options.rotating||x.options.zooming||Gr||It?ge.LINEAR:ge.NEAREST,Kt=ht.imageAtlasTexture.size}const vr=x.transform.calculatePixelsToTileUnitsMatrix(ht),br=Yn(Ve.projMatrix,ht.tileID.canonical,Se,se,x.transform,vr),Vr=x.terrain&&Se&&xe?u.invert(u.create(),br):Ra,hn=co(Ve.projMatrix,ht.tileID.canonical,Se,se,x.transform,vr),Tn=Ue&&at.hasTextData(),On=_.layout.get("icon-text-fit")!=="none"&&Tn&&at.hasIconData();if(xe){const Gr=de.elevation,to=Gr?Gr.getAtTileOffsetFunc(Ve,de.center.lat,de.worldSize,de.projection):Sc=>[0,0,0];No(at,Ve.projMatrix,x,C,br,hn,Se,Z,to,Ve)}const Mn=xe||C&&Ue||On,Hi=x.translatePosMatrix(Ve.projMatrix,ht,k,B),Ji=Mn?Ra:br,Pi=x.translatePosMatrix(hn,ht,k,B,!0),nr=de.projection.createInversionMatrix(de,Ve.canonical),jr=Mn?ct.concat(["PROJECTED_POS_ON_VIEWPORT"]):ct,Wi=At&&_.paint.get(C?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Kr;Kr=At?at.iconsInText?_o(qt.kind,Ct,Te,Se,x,Hi,Ji,Pi,Kt,Ii,Ve,He,De,nr):Jn(qt.kind,Ct,Te,Se,x,Hi,Ji,Pi,C,Kt,!0,Ve,He,De,nr):Pa(qt.kind,Ct,Te,Se,x,Hi,Ji,Pi,C,Kt,Ve,He,De,nr);const us={program:x.useProgram(_h(At,C,at),Je,jr),buffers:Dt,uniformValues:Kr,atlasTexture:mi,atlasTextureIcon:Yi,atlasInterpolation:jt,atlasInterpolationIcon:ti,isSDF:At,hasHalo:Wi,tile:ht,labelPlaneMatrixInv:Vr};if(Me&&at.canOverlap){Ae=!0;const Gr=Dt.segments.get();for(const to of Gr)Ye.push({segments:new u.SegmentVector([to]),sortKey:to.sortKey,state:us})}else Ye.push({segments:Dt.segments,sortKey:0,state:us})}Ae&&Ye.sort((Ve,ht)=>Ve.sortKey-ht.sortKey);for(const Ve of Ye){const ht=Ve.state;if(x.terrain&&x.terrain.setupElevationDraw(ht.tile,ht.program,{useDepthForOcclusion:!Ze,labelPlaneMatrixInv:ht.labelPlaneMatrixInv}),le.activeTexture.set(ge.TEXTURE0),ht.atlasTexture.bind(ht.atlasInterpolation,ge.CLAMP_TO_EDGE),ht.atlasTextureIcon&&(le.activeTexture.set(ge.TEXTURE1),ht.atlasTextureIcon&&ht.atlasTextureIcon.bind(ht.atlasInterpolationIcon,ge.CLAMP_TO_EDGE)),ht.isSDF){const at=ht.uniformValues;ht.hasHalo&&(at.u_is_halo=1,Kl(ht.buffers,Ve.segments,_,x,ht.program,Ee,X,te,at)),at.u_is_halo=0}Kl(ht.buffers,Ve.segments,_,x,ht.program,Ee,X,te,ht.uniformValues)}}function Kl(x,h,_,T,C,k,B,F,V){const Z=T.context;C.draw(Z,Z.gl.TRIANGLES,k,B,F,u.CullFaceMode.disabled,V,_.id,x.layoutVertexBuffer,x.indexBuffer,h,_.paint,T.transform.zoom,x.programConfigurations.get(_.id),x.dynamicLayoutVertexBuffer,x.opacityVertexBuffer)}function Os(x,h,_,T,C,k,B){const F=x.context.gl,V=_.paint.get("fill-pattern"),Z=V&&V.constantOr(1),X=_.getCrossfadeParameters();let te,le,ge,de,se;B?(le=Z&&!_.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",te=F.LINES):(le=Z?"fillPattern":"fill",te=F.TRIANGLES);for(const Se of T){const xe=h.getTile(Se);if(Z&&!xe.patternsLoaded())continue;const Te=xe.getBucket(_);if(!Te)continue;x.prepareDrawTile();const Me=Te.programConfigurations.get(_.id),Ae=x.useProgram(le,Me);Z&&(x.context.activeTexture.set(F.TEXTURE0),xe.imageAtlasTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),Me.updatePaintBuffers(X));const Ee=V.constantOr(null);if(Ee&&xe.imageAtlas){const Ue=xe.imageAtlas,Ze=Ue.patternPositions[Ee.to.toString()],He=Ue.patternPositions[Ee.from.toString()];Ze&&He&&Me.setConstantPatternPositions(Ze,He)}const De=x.translatePosMatrix(Se.projMatrix,xe,_.paint.get("fill-translate"),_.paint.get("fill-translate-anchor"));if(B){de=Te.indexBuffer2,se=Te.segments2;const Ue=x.terrain&&x.terrain.renderingToTexture?x.terrain.drapeBufferSize:[F.drawingBufferWidth,F.drawingBufferHeight];ge=le==="fillOutlinePattern"&&Z?ql(De,x,X,xe,Ue):zs(De,Ue)}else de=Te.indexBuffer,se=Te.segments,ge=Z?Ls(De,x,X,xe):Rs(De);x.prepareDrawProgram(x.context,Ae,Se.toUnwrapped()),Ae.draw(x.context,te,C,x.stencilModeForClipping(Se),k,u.CullFaceMode.disabled,ge,_.id,Te.layoutVertexBuffer,de,se,_.paint,x.transform.zoom,Me)}}function yo(x,h,_,T,C,k,B){const F=x.context,V=F.gl,Z=x.transform,X=_.paint.get("fill-extrusion-pattern"),te=X.constantOr(1),le=_.getCrossfadeParameters(),ge=_.paint.get("fill-extrusion-opacity"),de=function(Me){if(Me.projection.name!=="globe")return 0;const Ae=Math.PI/32,Ee=Math.tan(Ae),De=u.earthRadius;return De*Math.sqrt(1+2*Ee*Ee)-De}(Z),se=Z.projection.name==="globe",Se=se?u.globeToMercatorTransition(Z.zoom):0,xe=[u.mercatorXfromLng(Z.center.lng),u.mercatorYfromLat(Z.center.lat)],Te=[];se&&Te.push("PROJECTION_GLOBE_VIEW");for(const Me of T){const Ae=h.getTile(Me),Ee=Ae.getBucket(_);if(!Ee||Ee.projection!==Z.projection.name)continue;const De=Ee.programConfigurations.get(_.id),Ue=x.useProgram(te?"fillExtrusionPattern":"fillExtrusion",De,Te);if(x.terrain){const ht=x.terrain;if(x.style.terrainSetForDrapingOnly())ht.setupElevationDraw(Ae,Ue,{useMeterToDem:!0});else{if(!Ee.enableTerrain)continue;if(ht.setupElevationDraw(Ae,Ue,{useMeterToDem:!0}),Ho(F,h,Me,Ee,_,ht),!Ee.centroidVertexBuffer){const at=Ue.attributes.a_centroid_pos;at!==void 0&&V.vertexAttrib2f(at,0,0)}}}te&&(x.context.activeTexture.set(V.TEXTURE0),Ae.imageAtlasTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),De.updatePaintBuffers(le));const Ze=X.constantOr(null);if(Ze&&Ae.imageAtlas){const ht=Ae.imageAtlas,at=ht.patternPositions[Ze.to.toString()],Dt=ht.patternPositions[Ze.from.toString()];at&&Dt&&De.setConstantPatternPositions(at,Dt)}const He=x.translatePosMatrix(Me.projMatrix,Ae,_.paint.get("fill-extrusion-translate"),_.paint.get("fill-extrusion-translate-anchor")),Ye=Z.projection.createInversionMatrix(Z,Me.canonical),ct=_.paint.get("fill-extrusion-vertical-gradient"),Ve=te?Bs(He,x,ct,ge,Me,le,Ae,de,Se,xe,Ye):Ps(He,x,ct,ge,Me,de,Se,xe,Ye);x.prepareDrawProgram(F,Ue,Me.toUnwrapped()),Ue.draw(F,F.gl.TRIANGLES,C,k,B,u.CullFaceMode.backCCW,Ve,_.id,Ee.layoutVertexBuffer,Ee.indexBuffer,Ee.segments,_.paint,x.transform.zoom,De,x.terrain?Ee.centroidVertexBuffer:null,se?Ee.layoutVertexExtBuffer:null)}}function Ho(x,h,_,T,C,k){const B=[xe=>{let Te=xe.canonical.x-1,Me=xe.wrap;return Te<0&&(Te=(1<<xe.canonical.z)-1,Me--),new u.OverscaledTileID(xe.overscaledZ,Me,xe.canonical.z,Te,xe.canonical.y)},xe=>{let Te=xe.canonical.x+1,Me=xe.wrap;return Te===1<<xe.canonical.z&&(Te=0,Me++),new u.OverscaledTileID(xe.overscaledZ,Me,xe.canonical.z,Te,xe.canonical.y)},xe=>new u.OverscaledTileID(xe.overscaledZ,xe.wrap,xe.canonical.z,xe.canonical.x,(xe.canonical.y===0?1<<xe.canonical.z:xe.canonical.y)-1),xe=>new u.OverscaledTileID(xe.overscaledZ,xe.wrap,xe.canonical.z,xe.canonical.x,xe.canonical.y===(1<<xe.canonical.z)-1?0:xe.canonical.y+1)],F=xe=>{const Te=h.getSource().minzoom,Me=Ee=>{const De=h.getTileByID(Ee);if(De&&De.hasData())return De.getBucket(C)},Ae=[0,-1,1];for(const Ee of Ae){if(xe.overscaledZ+Ee<Te)continue;const De=Me(xe.calculateScaledKey(xe.overscaledZ+Ee));if(De)return De}},V=[0,0,0],Z=(xe,Te)=>(V[0]=Math.min(xe.min.y,Te.min.y),V[1]=Math.max(xe.max.y,Te.max.y),V[2]=u.EXTENT-Te.min.x>xe.max.x?Te.min.x-u.EXTENT:xe.max.x,V),X=(xe,Te)=>(V[0]=Math.min(xe.min.x,Te.min.x),V[1]=Math.max(xe.max.x,Te.max.x),V[2]=u.EXTENT-Te.min.y>xe.max.y?Te.min.y-u.EXTENT:xe.max.y,V),te=[(xe,Te)=>Z(xe,Te),(xe,Te)=>Z(Te,xe),(xe,Te)=>X(xe,Te),(xe,Te)=>X(Te,xe)],le=new u.pointGeometry(0,0);let ge,de,se;const Se=(xe,Te,Me,Ae,Ee)=>{const De=[[Ae?Me:xe,Ae?xe:Me,0],[Ae?Me:Te,Ae?Te:Me,0]],Ue=Ee<0?u.EXTENT+Ee:Ee,Ze=[Ae?Ue:(xe+Te)/2,Ae?(xe+Te)/2:Ue,0];return Me===0&&Ee<0||Me!==0&&Ee>0?k.getForTilePoints(se,[Ze],!0,de):De.push(Ze),k.getForTilePoints(_,De,!0,ge),Math.max(De[0][2],De[1][2],Ze[2])/k.exaggeration()};for(let xe=0;xe<4;xe++){const Te=(xe<2?1:5)-xe,Me=T.borders[xe];if(Me.length===0)continue;const Ae=se=B[xe](_),Ee=F(Ae);if(!(Ee&&Ee instanceof u.FillExtrusionBucket&&Ee.enableTerrain)||T.borderDoneWithNeighborZ[xe]===Ee.canonical.z&&Ee.borderDoneWithNeighborZ[Te]===T.canonical.z||(de=k.findDEMTileFor(Ae),!de||!de.dem))continue;if(!ge){const He=k.findDEMTileFor(_);if(!He||!He.dem)return;ge=He}const De=Ee.borders[Te];let Ue=0;const Ze=Ee.borderDoneWithNeighborZ[Te]!==T.canonical.z;if(T.canonical.z===Ee.canonical.z){for(let He=0;He<Me.length;He++){const Ye=T.featuresOnBorder[Me[He]],ct=Ye.borders[xe];let Ve;for(;Ue<De.length&&(Ve=Ee.featuresOnBorder[De[Ue]],!(Ve.borders[Te][1]>ct[0]+3));)Ze&&Ee.encodeCentroid(void 0,Ve,!1),Ue++;if(Ve&&Ue<De.length){const ht=Ue;let at=0;for(;!(Ve.borders[Te][0]>ct[1]-3)&&(at++,++Ue!==De.length);)Ve=Ee.featuresOnBorder[De[Ue]];if(Ve=Ee.featuresOnBorder[De[ht]],Ye.intersectsCount()>1||Ve.intersectsCount()>1||at!==1){at!==1&&(Ue=ht),T.encodeCentroid(void 0,Ye,!1),Ze&&Ee.encodeCentroid(void 0,Ve,!1);continue}const Dt=te[xe](Ye,Ve),Je=xe%2?u.EXTENT-1:0;le.x=Se(Dt[0],Math.min(u.EXTENT-1,Dt[1]),Je,xe<2,Dt[2]),le.y=0,T.encodeCentroid(le,Ye,!1),Ze&&Ee.encodeCentroid(le,Ve,!1)}else T.encodeCentroid(void 0,Ye,!1)}T.borderDoneWithNeighborZ[xe]=Ee.canonical.z,T.needsCentroidUpdate=!0,Ze&&(Ee.borderDoneWithNeighborZ[Te]=T.canonical.z,Ee.needsCentroidUpdate=!0)}else{for(const He of Me)T.encodeCentroid(void 0,T.featuresOnBorder[He],!1);if(Ze){for(const He of De)Ee.encodeCentroid(void 0,Ee.featuresOnBorder[He],!1);Ee.borderDoneWithNeighborZ[Te]=T.canonical.z,Ee.needsCentroidUpdate=!0}T.borderDoneWithNeighborZ[xe]=Ee.canonical.z,T.needsCentroidUpdate=!0}}(T.needsCentroidUpdate||!T.centroidVertexBuffer&&T.centroidVertexArray.length!==0)&&T.uploadCentroid(x)}const za=new u.Color(1,0,0,1),Fa=new u.Color(0,1,0,1),Jl=new u.Color(0,0,1,1),Ns=new u.Color(1,0,1,1),$s=new u.Color(0,1,1,1);function bt(x,h,_,T){Ko(x,0,h+_/2,x.transform.width,_,T)}function Wr(x,h,_,T){Ko(x,h-_/2,0,_,x.transform.height,T)}function Ko(x,h,_,T,C,k){const B=x.context,F=B.gl;F.enable(F.SCISSOR_TEST),F.scissor(h*u.exported.devicePixelRatio,_*u.exported.devicePixelRatio,T*u.exported.devicePixelRatio,C*u.exported.devicePixelRatio),B.clear({color:k}),F.disable(F.SCISSOR_TEST)}function Ql(x,h,_){const T=x.context,C=T.gl,k=x.transform.projection.name==="globe",B=_.projMatrix,F=x.useProgram("debug",null,k?["PROJECTION_GLOBE_VIEW"]:null),V=h.getTileByID(_.key);x.terrain&&x.terrain.setupElevationDraw(V,F);const Z=u.DepthMode.disabled,X=u.StencilMode.disabled,te=x.colorModeForRenderPass(),le="$debug";T.activeTexture.set(C.TEXTURE0),x.emptyTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),k?V._makeGlobeTileDebugBuffers(x.context,x.transform.projection):V._makeDebugTileBoundsBuffers(x.context,x.transform.projection);const ge=V._tileDebugBuffer||x.debugBuffer,de=V._tileDebugIndexBuffer||x.debugIndexBuffer,se=V._tileDebugSegments||x.debugSegments;F.draw(T,C.LINE_STRIP,Z,X,te,u.CullFaceMode.disabled,Xl(B,u.Color.red),le,ge,de,se,null,null,null,V._globeTileDebugBorderBuffer);const Se=V.latestRawTileData,xe=Math.floor((Se&&Se.byteLength||0)/1024),Te=h.getTile(_).tileSize,Me=512/Math.min(Te,512)*(_.overscaledZ/x.transform.zoom)*.5;let Ae=_.canonical.toString();_.overscaledZ!==_.canonical.z&&(Ae+=` => ${_.overscaledZ}`),function(Ze,He){Ze.initDebugOverlayCanvas();const Ye=Ze.debugOverlayCanvas,ct=Ze.context.gl,Ve=Ze.debugOverlayCanvas.getContext("2d");Ve.clearRect(0,0,Ye.width,Ye.height),Ve.shadowColor="white",Ve.shadowBlur=2,Ve.lineWidth=1.5,Ve.strokeStyle="white",Ve.textBaseline="top",Ve.font="bold 36px Open Sans, sans-serif",Ve.fillText(He,5,5),Ve.strokeText(He,5,5),Ze.debugOverlayTexture.update(Ye),Ze.debugOverlayTexture.bind(ct.LINEAR,ct.CLAMP_TO_EDGE)}(x,`${Ae} ${xe}kb`);const Ee=V._tileDebugTextBuffer||x.debugBuffer,De=V._tileDebugTextIndexBuffer||x.quadTriangleIndexBuffer,Ue=V._tileDebugTextSegments||x.debugSegments;F.draw(T,C.TRIANGLES,Z,X,u.ColorMode.alphaBlended,u.CullFaceMode.disabled,Xl(B,u.Color.transparent,Me),le,Ee,De,Ue,null,null,null,V._globeTileDebugTextBuffer)}const ec=u.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:xo}=ec;function bn(x,h,_,T){x.emplaceBack(h,_,T)}class Jo{constructor(h){this.vertexArray=new u.StructArrayLayout3f12,this.indices=new u.StructArrayLayout3ui6,bn(this.vertexArray,-1,-1,1),bn(this.vertexArray,1,-1,1),bn(this.vertexArray,-1,1,1),bn(this.vertexArray,1,1,1),bn(this.vertexArray,-1,-1,-1),bn(this.vertexArray,1,-1,-1),bn(this.vertexArray,-1,1,-1),bn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=h.createVertexBuffer(this.vertexArray,xo),this.indexBuffer=h.createIndexBuffer(this.indices),this.segment=u.SegmentVector.simpleSegment(0,0,36,12)}}function Bn(x,h,_,T,C,k){const B=x.gl,F=h.paint.get("sky-atmosphere-color"),V=h.paint.get("sky-atmosphere-halo-color"),Z=h.paint.get("sky-atmosphere-sun-intensity"),X=((te,le,ge,de,se)=>({u_matrix_3f:te,u_sun_direction:le,u_sun_intensity:ge,u_color_tint_r:[de.r,de.g,de.b,de.a],u_color_tint_m:[se.r,se.g,se.b,se.a],u_luminance:5e-5}))(u.fromMat4(u.create$1(),T),C,Z,F,V);B.framebufferTexture2D(B.FRAMEBUFFER,B.COLOR_ATTACHMENT0,B.TEXTURE_CUBE_MAP_POSITIVE_X+k,h.skyboxTexture,0),_.draw(x,B.TRIANGLES,u.DepthMode.disabled,u.StencilMode.disabled,u.ColorMode.unblended,u.CullFaceMode.frontCW,X,"skyboxCapture",h.skyboxGeometry.vertexBuffer,h.skyboxGeometry.indexBuffer,h.skyboxGeometry.segment)}function Rn(x,h){return u.transformMat4(x,x,h)}const Oa={symbol:function(x,h,_,T,C){if(x.renderPass!=="translucent")return;const k=u.StencilMode.disabled,B=x.colorModeForRenderPass();_.layout.get("text-variable-anchor")&&function(F,V,Z,X,te,le,ge){const de=V.transform,se=te==="map",Se=le==="map";for(const xe of F){const Te=X.getTile(xe),Me=Te.getBucket(Z);if(!Me||Me.projection!==de.projection.name||!Me.text||!Me.text.segments.get().length)continue;const Ae=u.evaluateSizeForZoom(Me.textSizeData,de.zoom),Ee=V.transform.calculatePixelsToTileUnitsMatrix(Te),De=Yn(xe.projMatrix,Te.tileID.canonical,Se,se,V.transform,Ee),Ue=Z.layout.get("icon-text-fit")!=="none"&&Me.hasIconData();if(Ae){const Ze=Math.pow(2,de.zoom-Te.tileID.overscaledZ);gh(Me,se,Se,ge,u.symbolSize,de,De,xe,Ze,Ae,Ue,de.projection)}}}(T,x,_,h,_.layout.get("text-rotation-alignment"),_.layout.get("text-pitch-alignment"),C),_.paint.get("icon-opacity").constantOr(1)!==0&&La(x,h,_,T,!1,_.paint.get("icon-translate"),_.paint.get("icon-translate-anchor"),_.layout.get("icon-rotation-alignment"),_.layout.get("icon-pitch-alignment"),_.layout.get("icon-keep-upright"),k,B),_.paint.get("text-opacity").constantOr(1)!==0&&La(x,h,_,T,!0,_.paint.get("text-translate"),_.paint.get("text-translate-anchor"),_.layout.get("text-rotation-alignment"),_.layout.get("text-pitch-alignment"),_.layout.get("text-keep-upright"),k,B),h.map.showCollisionBoxes&&(Hl(x,h,_,T,_.paint.get("text-translate"),_.paint.get("text-translate-anchor"),!0),Hl(x,h,_,T,_.paint.get("icon-translate"),_.paint.get("icon-translate-anchor"),!1))},circle:function(x,h,_,T){if(x.renderPass!=="translucent")return;const C=_.paint.get("circle-opacity"),k=_.paint.get("circle-stroke-width"),B=_.paint.get("circle-stroke-opacity"),F=_.layout.get("circle-sort-key").constantOr(1)!==void 0;if(C.constantOr(1)===0&&(k.constantOr(1)===0||B.constantOr(1)===0))return;const V=x.context,Z=V.gl,X=x.transform,te=x.depthModeForSublayer(0,u.DepthMode.ReadOnly),le=u.StencilMode.disabled,ge=x.colorModeForRenderPass(),de=X.projection.name==="globe",se=[u.mercatorXfromLng(X.center.lng),u.mercatorYfromLat(X.center.lat)],Se=[];for(let Te=0;Te<T.length;Te++){const Me=T[Te],Ae=h.getTile(Me),Ee=Ae.getBucket(_);if(!Ee)continue;const De=Ee.programConfigurations.get(_.id),Ue=uh(_);de&&Ue.push("PROJECTION_GLOBE_VIEW");const Ze=x.useProgram("circle",De,Ue),He=Ee.layoutVertexBuffer,Ye=Ee.globeExtVertexBuffer,ct=Ee.indexBuffer,Ve=X.projection.createInversionMatrix(X,Me.canonical),ht={programConfiguration:De,program:Ze,layoutVertexBuffer:He,globeExtVertexBuffer:Ye,indexBuffer:ct,uniformValues:go(x,Me,Ae,Ve,se,_),tile:Ae};if(F){const at=Ee.segments.get();for(const Dt of at)Se.push({segments:new u.SegmentVector([Dt]),sortKey:Dt.sortKey,state:ht})}else Se.push({segments:Ee.segments,sortKey:0,state:ht})}F&&Se.sort((Te,Me)=>Te.sortKey-Me.sortKey);const xe={useDepthForOcclusion:!de};for(const Te of Se){const{programConfiguration:Me,program:Ae,layoutVertexBuffer:Ee,globeExtVertexBuffer:De,indexBuffer:Ue,uniformValues:Ze,tile:He}=Te.state,Ye=Te.segments;x.terrain&&x.terrain.setupElevationDraw(He,Ae,xe),x.prepareDrawProgram(V,Ae,He.tileID.toUnwrapped()),Ae.draw(V,Z.TRIANGLES,te,le,ge,u.CullFaceMode.disabled,Ze,_.id,Ee,Ue,Ye,_.paint,X.zoom,Me,de?De:null)}},heatmap:function(x,h,_,T){if(_.paint.get("heatmap-opacity")!==0)if(x.renderPass==="offscreen"){const C=x.context,k=C.gl,B=u.StencilMode.disabled,F=new u.ColorMode([k.ONE,k.ONE],u.Color.transparent,[!0,!0,!0,!0]);(function(le,ge,de){const se=le.gl;le.activeTexture.set(se.TEXTURE1),le.viewport.set([0,0,ge.width/4,ge.height/4]);let Se=de.heatmapFbo;if(Se)se.bindTexture(se.TEXTURE_2D,Se.colorAttachment.get()),le.bindFramebuffer.set(Se.framebuffer);else{const xe=se.createTexture();se.bindTexture(se.TEXTURE_2D,xe),se.texParameteri(se.TEXTURE_2D,se.TEXTURE_WRAP_S,se.CLAMP_TO_EDGE),se.texParameteri(se.TEXTURE_2D,se.TEXTURE_WRAP_T,se.CLAMP_TO_EDGE),se.texParameteri(se.TEXTURE_2D,se.TEXTURE_MIN_FILTER,se.LINEAR),se.texParameteri(se.TEXTURE_2D,se.TEXTURE_MAG_FILTER,se.LINEAR),Se=de.heatmapFbo=le.createFramebuffer(ge.width/4,ge.height/4,!1),function(Te,Me,Ae,Ee){const De=Te.gl;De.texImage2D(De.TEXTURE_2D,0,De.RGBA,Me.width/4,Me.height/4,0,De.RGBA,Te.extRenderToTextureHalfFloat?Te.extTextureHalfFloat.HALF_FLOAT_OES:De.UNSIGNED_BYTE,null),Ee.colorAttachment.set(Ae)}(le,ge,xe,Se)}})(C,x,_),C.clear({color:u.Color.transparent});const V=x.transform,Z=V.projection.name==="globe",X=Z?["PROJECTION_GLOBE_VIEW"]:null,te=[u.mercatorXfromLng(V.center.lng),u.mercatorYfromLat(V.center.lat)];for(let le=0;le<T.length;le++){const ge=T[le];if(h.hasRenderableParent(ge))continue;const de=h.getTile(ge),se=de.getBucket(_);if(!se)continue;const Se=se.programConfigurations.get(_.id),xe=x.useProgram("heatmap",Se,X),{zoom:Te}=x.transform;x.terrain&&x.terrain.setupElevationDraw(de,xe),x.prepareDrawProgram(C,xe,ge.toUnwrapped());const Me=V.projection.createInversionMatrix(V,ge.canonical);xe.draw(C,k.TRIANGLES,u.DepthMode.disabled,B,F,u.CullFaceMode.disabled,ph(x,ge,de,Me,te,Te,_.paint.get("heatmap-intensity")),_.id,se.layoutVertexBuffer,se.indexBuffer,se.segments,_.paint,x.transform.zoom,Se,Z?se.globeExtVertexBuffer:null)}C.viewport.set([0,0,x.width,x.height])}else x.renderPass==="translucent"&&(x.context.setColorMode(x.colorModeForRenderPass()),function(C,k){const B=C.context,F=B.gl,V=k.heatmapFbo;if(!V)return;B.activeTexture.set(F.TEXTURE0),F.bindTexture(F.TEXTURE_2D,V.colorAttachment.get()),B.activeTexture.set(F.TEXTURE1);let Z=k.colorRampTexture;Z||(Z=k.colorRampTexture=new u.Texture(B,k.colorRamp,F.RGBA)),Z.bind(F.LINEAR,F.CLAMP_TO_EDGE),C.useProgram("heatmapTexture").draw(B,F.TRIANGLES,u.DepthMode.disabled,u.StencilMode.disabled,C.colorModeForRenderPass(),u.CullFaceMode.disabled,((X,te,le,ge)=>({u_image:0,u_color_ramp:1,u_opacity:te.paint.get("heatmap-opacity")}))(0,k),k.id,C.viewportBuffer,C.quadTriangleIndexBuffer,C.viewportSegments,k.paint,C.transform.zoom)}(x,_))},line:function(x,h,_,T){if(x.renderPass!=="translucent")return;const C=_.paint.get("line-opacity"),k=_.paint.get("line-width");if(C.constantOr(1)===0||k.constantOr(1)===0)return;const B=x.depthModeForSublayer(0,u.DepthMode.ReadOnly),F=x.colorModeForRenderPass(),V=x.terrain&&x.terrain.renderingToTexture?1:u.exported.devicePixelRatio,Z=_.paint.get("line-dasharray"),X=Z.constantOr(1),te=_.layout.get("line-cap"),le=_.paint.get("line-pattern"),ge=le.constantOr(1),de=_.paint.get("line-gradient"),se=_.getCrossfadeParameters(),Se=ge?"linePattern":"line",xe=x.context,Te=xe.gl,Me=(Ee=>{const De=[];ka(Ee)&&De.push("RENDER_LINE_DASH"),Ee.paint.get("line-gradient")&&De.push("RENDER_LINE_GRADIENT");const Ue=Ee.paint.get("line-pattern").constantOr(1),Ze=Ee.paint.get("line-opacity").constantOr(1)!==1;return!Ue&&Ze&&De.push("RENDER_LINE_ALPHA_DISCARD"),De})(_);let Ae=Me.includes("RENDER_LINE_ALPHA_DISCARD");x.terrain&&x.terrain.clipOrMaskOverlapStencilType()&&(Ae=!1);for(const Ee of T){const De=h.getTile(Ee);if(ge&&!De.patternsLoaded())continue;const Ue=De.getBucket(_);if(!Ue)continue;x.prepareDrawTile();const Ze=Ue.programConfigurations.get(_.id),He=x.useProgram(Se,Ze,Me),Ye=le.constantOr(null);if(Ye&&De.imageAtlas){const Je=De.imageAtlas,At=Je.patternPositions[Ye.to.toString()],qt=Je.patternPositions[Ye.from.toString()];At&&qt&&Ze.setConstantPatternPositions(At,qt)}const ct=Z.constantOr(null),Ve=te.constantOr(null);if(!ge&&ct&&Ve&&De.lineAtlas){const Je=De.lineAtlas,At=Je.getDash(ct.to,Ve),qt=Je.getDash(ct.from,Ve);At&&qt&&Ze.setConstantPatternPositions(At,qt)}const ht=x.terrain?Ee.projMatrix:null,at=ge?Ca(x,De,_,se,ht,V):mh(x,De,_,se,ht,Ue.lineClipsArray.length,V);if(de){const Je=Ue.gradients[_.id];let At=Je.texture;if(_.gradientVersion!==Je.version){let qt=256;if(_.stepInterpolant){const It=h.getSource().maxzoom,Ct=Ee.canonical.z===It?Math.ceil(1<<x.transform.maxZoom-Ee.canonical.z):1;qt=u.clamp(u.nextPowerOfTwo(Ue.maxLineLength/u.EXTENT*1024*Ct),256,xe.maxTextureSize)}Je.gradient=u.renderColorRamp({expression:_.gradientExpression(),evaluationKey:"lineProgress",resolution:qt,image:Je.gradient||void 0,clips:Ue.lineClipsArray}),Je.texture?Je.texture.update(Je.gradient):Je.texture=new u.Texture(xe,Je.gradient,Te.RGBA),Je.version=_.gradientVersion,At=Je.texture}xe.activeTexture.set(Te.TEXTURE1),At.bind(_.stepInterpolant?Te.NEAREST:Te.LINEAR,Te.CLAMP_TO_EDGE)}X&&(xe.activeTexture.set(Te.TEXTURE0),De.lineAtlasTexture.bind(Te.LINEAR,Te.REPEAT),Ze.updatePaintBuffers(se)),ge&&(xe.activeTexture.set(Te.TEXTURE0),De.imageAtlasTexture.bind(Te.LINEAR,Te.CLAMP_TO_EDGE),Ze.updatePaintBuffers(se)),x.prepareDrawProgram(xe,He,Ee.toUnwrapped());const Dt=Je=>{He.draw(xe,Te.TRIANGLES,B,Je,F,u.CullFaceMode.disabled,at,_.id,Ue.layoutVertexBuffer,Ue.indexBuffer,Ue.segments,_.paint,x.transform.zoom,Ze,Ue.layoutVertexBuffer2)};if(Ae){const Je=x.stencilModeForClipping(Ee).ref;Je===0&&x.terrain&&xe.clear({stencil:0});const At={func:Te.EQUAL,mask:255};at.u_alpha_discard_threshold=.8,Dt(new u.StencilMode(At,Je,255,Te.KEEP,Te.KEEP,Te.INVERT)),at.u_alpha_discard_threshold=0,Dt(new u.StencilMode(At,Je,255,Te.KEEP,Te.KEEP,Te.KEEP))}else Dt(x.stencilModeForClipping(Ee))}Ae&&(x.resetStencilClippingMasks(),x.terrain&&xe.clear({stencil:0}))},fill:function(x,h,_,T){const C=_.paint.get("fill-color"),k=_.paint.get("fill-opacity");if(k.constantOr(1)===0)return;const B=x.colorModeForRenderPass(),F=_.paint.get("fill-pattern"),V=x.opaquePassEnabledForLayer()&&!F.constantOr(1)&&C.constantOr(u.Color.transparent).a===1&&k.constantOr(0)===1?"opaque":"translucent";if(x.renderPass===V){const Z=x.depthModeForSublayer(1,x.renderPass==="opaque"?u.DepthMode.ReadWrite:u.DepthMode.ReadOnly);Os(x,h,_,T,Z,B,!1)}if(x.renderPass==="translucent"&&_.paint.get("fill-antialias")){const Z=x.depthModeForSublayer(_.getPaintProperty("fill-outline-color")?2:0,u.DepthMode.ReadOnly);Os(x,h,_,T,Z,B,!0)}},"fill-extrusion":function(x,h,_,T){const C=_.paint.get("fill-extrusion-opacity");if(C!==0&&x.renderPass==="translucent"){const k=new u.DepthMode(x.context.gl.LEQUAL,u.DepthMode.ReadWrite,x.depthRangeFor3D);if(C!==1||_.paint.get("fill-extrusion-pattern").constantOr(1))yo(x,h,_,T,k,u.StencilMode.disabled,u.ColorMode.disabled),yo(x,h,_,T,k,x.stencilModeFor3D(),x.colorModeForRenderPass()),x.resetStencilClippingMasks();else{const B=x.colorModeForRenderPass();yo(x,h,_,T,k,u.StencilMode.disabled,B)}}},hillshade:function(x,h,_,T){if(x.renderPass!=="offscreen"&&x.renderPass!=="translucent")return;const C=x.context,k=x.depthModeForSublayer(0,u.DepthMode.ReadOnly),B=x.colorModeForRenderPass(),F=x.terrain&&x.terrain.renderingToTexture,[V,Z]=x.renderPass!=="translucent"||F?[{},T]:x.stencilConfigForOverlap(T);for(const X of Z){const te=h.getTile(X);if(te.needsHillshadePrepare&&x.renderPass==="offscreen")Ea(x,te,_,k,u.StencilMode.disabled,B);else if(x.renderPass==="translucent"){const le=F&&x.terrain?x.terrain.stencilModeForRTTOverlap(X):V[X.overscaledZ];Vl(x,X,te,_,k,le,B)}}C.viewport.set([0,0,x.width,x.height]),x.resetStencilClippingMasks()},raster:function(x,h,_,T,C,k){if(x.renderPass!=="translucent"||_.paint.get("raster-opacity")===0||!T.length)return;const B=x.context,F=B.gl,V=h.getSource(),Z=x.useProgram("raster"),X=x.colorModeForRenderPass(),te=x.terrain&&x.terrain.renderingToTexture,[le,ge]=V instanceof ke||te?[{},T]:x.stencilConfigForOverlap(T),de=ge[ge.length-1].overscaledZ,se=!x.options.moving;for(const Se of ge){const xe=te?u.DepthMode.disabled:x.depthModeForSublayer(Se.overscaledZ-de,_.paint.get("raster-opacity")===1?u.DepthMode.ReadWrite:u.DepthMode.ReadOnly,F.LESS),Te=Se.toUnwrapped(),Me=h.getTile(Se);if(te&&(!Me||!Me.hasData()))continue;const Ae=te?Se.projMatrix:x.transform.calculateProjMatrix(Te,se),Ee=x.terrain&&te?x.terrain.stencilModeForRTTOverlap(Se):le[Se.overscaledZ],De=k?0:_.paint.get("raster-fade-duration");Me.registerFadeDuration(De);const Ue=h.findLoadedParent(Se,0),Ze=Sa(Me,Ue,h,x.transform,De);let He,Ye;x.terrain&&x.terrain.prepareDrawTile();const ct=_.paint.get("raster-resampling")==="nearest"?F.NEAREST:F.LINEAR;B.activeTexture.set(F.TEXTURE0),Me.texture.bind(ct,F.CLAMP_TO_EDGE),B.activeTexture.set(F.TEXTURE1),Ue?(Ue.texture.bind(ct,F.CLAMP_TO_EDGE),He=Math.pow(2,Ue.tileID.overscaledZ-Me.tileID.overscaledZ),Ye=[Me.tileID.canonical.x*He%1,Me.tileID.canonical.y*He%1]):Me.texture.bind(ct,F.CLAMP_TO_EDGE);const Ve=Yl(Ae,Ye||[0,0],He||1,Ze,_,V instanceof ke?V.perspectiveTransform:[0,0]);if(x.prepareDrawProgram(B,Z,Te),V instanceof ke)V.boundsBuffer&&V.boundsSegments&&Z.draw(B,F.TRIANGLES,xe,u.StencilMode.disabled,X,u.CullFaceMode.disabled,Ve,_.id,V.boundsBuffer,x.quadTriangleIndexBuffer,V.boundsSegments);else{const{tileBoundsBuffer:ht,tileBoundsIndexBuffer:at,tileBoundsSegments:Dt}=x.getTileBoundsBuffers(Me);Z.draw(B,F.TRIANGLES,xe,Ee,X,u.CullFaceMode.disabled,Ve,_.id,ht,at,Dt)}}x.resetStencilClippingMasks()},background:function(x,h,_,T){const C=_.paint.get("background-color"),k=_.paint.get("background-opacity");if(k===0)return;const B=x.context,F=B.gl,V=x.transform,Z=V.tileSize,X=_.paint.get("background-pattern");if(x.isPatternMissing(X))return;const te=!X&&C.a===1&&k===1&&x.opaquePassEnabledForLayer()?"opaque":"translucent";if(x.renderPass!==te)return;const le=u.StencilMode.disabled,ge=x.depthModeForSublayer(0,te==="opaque"?u.DepthMode.ReadWrite:u.DepthMode.ReadOnly),de=x.colorModeForRenderPass(),se=x.useProgram(X?"backgroundPattern":"background");let Se,xe=T;xe||(Se=x.getBackgroundTiles(),xe=Object.values(Se).map(Me=>Me.tileID)),X&&(B.activeTexture.set(F.TEXTURE0),x.imageManager.bind(x.context));const Te=_.getCrossfadeParameters();for(const Me of xe){const Ae=Me.toUnwrapped(),Ee=T?Me.projMatrix:x.transform.calculateProjMatrix(Ae);x.prepareDrawTile();const De=h?h.getTile(Me):Se?Se[Me.key]:new u.Tile(Me,Z,V.zoom,x),Ue=X?Ba(Ee,k,x,X,{tileID:Me,tileSize:Z},Te):Wl(Ee,k,C);x.prepareDrawProgram(B,se,Ae);const{tileBoundsBuffer:Ze,tileBoundsIndexBuffer:He,tileBoundsSegments:Ye}=x.getTileBoundsBuffers(De);se.draw(B,F.TRIANGLES,ge,le,de,u.CullFaceMode.disabled,Ue,_.id,Ze,He,Ye)}},sky:function(x,h,_){const T=x.transform,C=T.projection.name==="mercator"||T.projection.name==="globe"?1:u.smoothstep(7,8,T.zoom),k=_.paint.get("sky-opacity")*C;if(k===0)return;const B=x.context,F=_.paint.get("sky-type"),V=new u.DepthMode(B.gl.LEQUAL,u.DepthMode.ReadOnly,[0,1]),Z=x.frameCounter/1e3%1;F==="atmosphere"?x.renderPass==="offscreen"?_.needsSkyboxCapture(x)&&(function(X,te,le,ge){const de=X.context,se=de.gl;let Se=te.skyboxFbo;if(!Se){Se=te.skyboxFbo=de.createFramebuffer(32,32,!1),te.skyboxGeometry=new Jo(de),te.skyboxTexture=de.gl.createTexture(),se.bindTexture(se.TEXTURE_CUBE_MAP,te.skyboxTexture),se.texParameteri(se.TEXTURE_CUBE_MAP,se.TEXTURE_WRAP_S,se.CLAMP_TO_EDGE),se.texParameteri(se.TEXTURE_CUBE_MAP,se.TEXTURE_WRAP_T,se.CLAMP_TO_EDGE),se.texParameteri(se.TEXTURE_CUBE_MAP,se.TEXTURE_MIN_FILTER,se.LINEAR),se.texParameteri(se.TEXTURE_CUBE_MAP,se.TEXTURE_MAG_FILTER,se.LINEAR);for(let Ae=0;Ae<6;++Ae)se.texImage2D(se.TEXTURE_CUBE_MAP_POSITIVE_X+Ae,0,se.RGBA,32,32,0,se.RGBA,se.UNSIGNED_BYTE,null)}de.bindFramebuffer.set(Se.framebuffer),de.viewport.set([0,0,32,32]);const xe=te.getCenter(X,!0),Te=X.useProgram("skyboxCapture"),Me=new Float64Array(16);u.identity(Me),u.rotateY(Me,Me,.5*-Math.PI),Bn(de,te,Te,Me,xe,0),u.identity(Me),u.rotateY(Me,Me,.5*Math.PI),Bn(de,te,Te,Me,xe,1),u.identity(Me),u.rotateX(Me,Me,.5*-Math.PI),Bn(de,te,Te,Me,xe,2),u.identity(Me),u.rotateX(Me,Me,.5*Math.PI),Bn(de,te,Te,Me,xe,3),u.identity(Me),Bn(de,te,Te,Me,xe,4),u.identity(Me),u.rotateY(Me,Me,Math.PI),Bn(de,te,Te,Me,xe,5),de.viewport.set([0,0,X.width,X.height])}(x,_),_.markSkyboxValid(x)):x.renderPass==="sky"&&function(X,te,le,ge,de){const se=X.context,Se=se.gl,xe=X.transform,Te=X.useProgram("skybox");se.activeTexture.set(Se.TEXTURE0),Se.bindTexture(Se.TEXTURE_CUBE_MAP,te.skyboxTexture);const Me=((Ae,Ee,De,Ue,Ze)=>({u_matrix:Ae,u_sun_direction:Ee,u_cubemap:0,u_opacity:Ue,u_temporal_offset:Ze}))(xe.skyboxMatrix,te.getCenter(X,!1),0,ge,de);X.prepareDrawProgram(se,Te),Te.draw(se,Se.TRIANGLES,le,u.StencilMode.disabled,X.colorModeForRenderPass(),u.CullFaceMode.backCW,Me,"skybox",te.skyboxGeometry.vertexBuffer,te.skyboxGeometry.indexBuffer,te.skyboxGeometry.segment)}(x,_,V,k,Z):F==="gradient"&&x.renderPass==="sky"&&function(X,te,le,ge,de){const se=X.context,Se=se.gl,xe=X.transform,Te=X.useProgram("skyboxGradient");te.skyboxGeometry||(te.skyboxGeometry=new Jo(se)),se.activeTexture.set(Se.TEXTURE0);let Me=te.colorRampTexture;Me||(Me=te.colorRampTexture=new u.Texture(se,te.colorRamp,Se.RGBA)),Me.bind(Se.LINEAR,Se.CLAMP_TO_EDGE);const Ae=((Ee,De,Ue,Ze,He)=>({u_matrix:Ee,u_color_ramp:0,u_center_direction:De,u_radius:u.degToRad(Ue),u_opacity:Ze,u_temporal_offset:He}))(xe.skyboxMatrix,te.getCenter(X,!1),te.paint.get("sky-gradient-radius"),ge,de);X.prepareDrawProgram(se,Te),Te.draw(se,Se.TRIANGLES,le,u.StencilMode.disabled,X.colorModeForRenderPass(),u.CullFaceMode.backCW,Ae,"skyboxGradient",te.skyboxGeometry.vertexBuffer,te.skyboxGeometry.indexBuffer,te.skyboxGeometry.segment)}(x,_,V,k,Z)},debug:function(x,h,_){for(let T=0;T<_.length;T++)Ql(x,h,_[T])},custom:function(x,h,_){const T=x.context,C=_.implementation;if(x.transform.projection.unsupportedLayers&&x.transform.projection.unsupportedLayers.includes("custom"))u.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.");else if(x.renderPass==="offscreen"){const k=C.prerender;k&&(x.setCustomLayerDefaults(),T.setColorMode(x.colorModeForRenderPass()),k.call(C,T.gl,x.transform.customLayerMatrix()),T.setDirty(),x.setBaseState())}else if(x.renderPass==="translucent"){x.setCustomLayerDefaults(),T.setColorMode(x.colorModeForRenderPass()),T.setStencilMode(u.StencilMode.disabled);const k=C.renderingMode==="3d"?new u.DepthMode(x.context.gl.LEQUAL,u.DepthMode.ReadWrite,x.depthRangeFor3D):x.depthModeForSublayer(0,u.DepthMode.ReadOnly);T.setDepthMode(k),C.render(T.gl,x.transform.customLayerMatrix()),T.setDirty(),x.setBaseState(),T.bindFramebuffer.set(null)}}};class tc{constructor(h,_){this.context=new G(h),this.transform=_,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=u.SourceCache.maxUnderzooming+u.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Ss,this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this._tileClippingMaskIDs=new Map,this._skippedStencilTileIDs=new Set}updateTerrain(h,_){const T=!!h&&!!h.terrain&&this.transform.projection.supportsTerrain;if(!(T||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Nr(this,h));const C=this._terrain;this.transform.elevation=T?C:null,C.update(h,this.transform,_)}_updateFog(h){const _=h.fog;if(!_||_.getOpacity(this.transform.pitch)<1||_.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[T,C]=_.getFovAdjustedRange(this.transform._fov);if(T>C)return void(this.transform.fogCullDistSq=null);const k=T+.78*(C-T);this.transform.fogCullDistSq=k*k}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(h,_){if(this.width=h*u.exported.devicePixelRatio,this.height=_*u.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const T of this.style.order)this.style._layers[T].resize()}setup(){const h=this.context,_=new u.StructArrayLayout2i4;_.emplaceBack(0,0),_.emplaceBack(u.EXTENT,0),_.emplaceBack(0,u.EXTENT),_.emplaceBack(u.EXTENT,u.EXTENT),this.tileExtentBuffer=h.createVertexBuffer(_,u.posAttributes.members),this.tileExtentSegments=u.SegmentVector.simpleSegment(0,0,4,2);const T=new u.StructArrayLayout2i4;T.emplaceBack(0,0),T.emplaceBack(u.EXTENT,0),T.emplaceBack(0,u.EXTENT),T.emplaceBack(u.EXTENT,u.EXTENT),this.debugBuffer=h.createVertexBuffer(T,u.posAttributes.members),this.debugSegments=u.SegmentVector.simpleSegment(0,0,4,5);const C=new u.StructArrayLayout2i4;C.emplaceBack(-1,-1),C.emplaceBack(1,-1),C.emplaceBack(-1,1),C.emplaceBack(1,1),this.viewportBuffer=h.createVertexBuffer(C,u.posAttributes.members),this.viewportSegments=u.SegmentVector.simpleSegment(0,0,4,2);const k=new u.StructArrayLayout4i8;k.emplaceBack(0,0,0,0),k.emplaceBack(u.EXTENT,0,u.EXTENT,0),k.emplaceBack(0,u.EXTENT,0,u.EXTENT),k.emplaceBack(u.EXTENT,u.EXTENT,u.EXTENT,u.EXTENT),this.mercatorBoundsBuffer=h.createVertexBuffer(k,u.boundsAttributes.members),this.mercatorBoundsSegments=u.SegmentVector.simpleSegment(0,0,4,2);const B=new u.StructArrayLayout3ui6;B.emplaceBack(0,1,2),B.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=h.createIndexBuffer(B);const F=new u.StructArrayLayout1ui2;for(const Z of[0,1,3,2,0])F.emplaceBack(Z);this.debugIndexBuffer=h.createIndexBuffer(F),this.emptyTexture=new u.Texture(h,new u.RGBAImage({width:1,height:1},Uint8Array.of(0,0,0,0)),h.gl.RGBA),this.identityMat=u.create();const V=this.context.gl;this.stencilClearMode=new u.StencilMode({func:V.ALWAYS,mask:0},0,255,V.ZERO,V.ZERO,V.ZERO),this.loadTimeStamps.push(u.window.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(h){return h._makeTileBoundsBuffers(this.context,this.transform.projection),h._tileBoundsBuffer?{tileBoundsBuffer:h._tileBoundsBuffer,tileBoundsIndexBuffer:h._tileBoundsIndexBuffer,tileBoundsSegments:h._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const h=this.context,_=h.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs.clear(),this._skippedStencilTileIDs.clear(),this.useProgram("clippingMask").draw(h,_.TRIANGLES,u.DepthMode.disabled,this.stencilClearMode,u.ColorMode.disabled,u.CullFaceMode.disabled,ks(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs.clear(),this._skippedStencilTileIDs.clear())}_renderTileClippingMasks(h,_,T){if(!_||this.currentStencilSource===_.id||!h.isTileClipped()||!T||T.length===0)return;const C=[];let k=!1;if(this._tileClippingMaskIDs&&!this.terrain){for(const X of T)if(this._tileClippingMaskIDs.has(X.key)||(k=!0),this._skippedStencilTileIDs.has(X.key)){if(!_.getTile(X).getBucket(h))continue;this._skippedStencilTileIDs.delete(X.key),C.push(X)}if(!k&&C.length===0)return}const B=this.context,F=B.gl;B.setColorMode(u.ColorMode.disabled),B.setDepthMode(u.DepthMode.disabled);const V=this.useProgram("clippingMask"),Z=X=>{const te=_.getTile(X),{tileBoundsBuffer:le,tileBoundsIndexBuffer:ge,tileBoundsSegments:de}=this.getTileBoundsBuffers(te);V.draw(B,F.TRIANGLES,u.DepthMode.disabled,new u.StencilMode({func:F.GREATER,mask:255},this._tileClippingMaskIDs.get(X.key)||0,255,F.KEEP,F.KEEP,F.REPLACE),u.ColorMode.disabled,u.CullFaceMode.disabled,ks(X.projMatrix),"$clipping",le,ge,de)};if(!k&&C.length>0)for(const X of C)Z(X);else{(this._tileClippingMaskIDs.size===0||this.nextStencilID+T.length>256)&&this.clearStencil(),this._tileClippingMaskIDs.clear(),this._skippedStencilTileIDs.clear();for(const X of T)this._tileClippingMaskIDs.set(X.key,this.nextStencilID++),_.getTile(X).getBucket(h)?Z(X):this._skippedStencilTileIDs.add(X.key)}this._skippedStencilTileIDs.size===0&&(this.currentStencilSource=_.id)}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const h=this.nextStencilID++,_=this.context.gl;return new u.StencilMode({func:_.NOTEQUAL,mask:255},h,255,_.KEEP,_.KEEP,_.REPLACE)}stencilModeForClipping(h){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(h);const _=this.context.gl;return new u.StencilMode({func:_.EQUAL,mask:255},this._tileClippingMaskIDs.get(h.key)||0,0,_.KEEP,_.KEEP,_.REPLACE)}stencilConfigForOverlap(h){const _=this.context.gl,T=h.sort((B,F)=>F.overscaledZ-B.overscaledZ),C=T[T.length-1].overscaledZ,k=T[0].overscaledZ-C+1;if(k>1){this.currentStencilSource=void 0,this.nextStencilID+k>256&&this.clearStencil();const B={};for(let F=0;F<k;F++)B[F+C]=new u.StencilMode({func:_.GEQUAL,mask:255},F+this.nextStencilID,255,_.KEEP,_.KEEP,_.REPLACE);return this.nextStencilID+=k,[B,T]}return[{[C]:u.StencilMode.disabled},T]}colorModeForRenderPass(){const h=this.context.gl;return this._showOverdrawInspector?new u.ColorMode([h.CONSTANT_COLOR,h.ONE],new u.Color(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?u.ColorMode.unblended:u.ColorMode.alphaBlended}depthModeForSublayer(h,_,T){if(!this.opaquePassEnabledForLayer())return u.DepthMode.disabled;const C=1-((1+this.currentLayer)*this.numSublayers+h)*this.depthEpsilon;return new u.DepthMode(T||this.context.gl.LEQUAL,_,[C,C])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(h,_){this.style=h,this.options=_,this.lineAtlas=h.lineAtlas,this.imageManager=h.imageManager,this.glyphManager=h.glyphManager,this.symbolFadeChange=h.placement.symbolFadeChange(u.exported.now()),this.imageManager.beginFrame();const T=this.style.order,C=this.style._sourceCaches;for(const Z in C){const X=C[Z];X.used&&X.prepare(this.context)}const k={},B={},F={};for(const Z in C){const X=C[Z];k[Z]=X.getVisibleCoordinates(),B[Z]=k[Z].slice().reverse(),F[Z]=X.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let Z=0;Z<T.length;Z++)if(this.style._layers[T[Z]].is3D()){this.opaquePassCutoff=Z;break}if(this.terrain&&(this.terrain.updateTileBinding(F),this.opaquePassCutoff=0),this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new u.GlobeSharedBuffers(this.context)),!u.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const Z of T){const X=this.style._layers[Z],te=h._getLayerSourceCache(X);if(!X.hasOffscreenPass()||X.isHidden(this.transform.zoom))continue;const le=te?B[te.id]:void 0;(X.type==="custom"||X.isSky()||le&&le.length)&&this.renderLayer(this,te,X,le)}this.depthRangeFor3D=[0,1-(h.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let V=u.Color.transparent;if(this.style.fog&&this.style.fog.getOpacity(this.transform.pitch)&&(V=this.style.fog.properties.get("color")),this.context.clear({color:_.showOverdrawInspector?u.Color.black:V,depth:1}),this.clearStencil(),this._showOverdrawInspector=_.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=T.length-1;this.currentLayer>=0;this.currentLayer--){const Z=this.style._layers[T[this.currentLayer]],X=h._getLayerSourceCache(Z);if(Z.isSky())continue;const te=X?B[X.id]:void 0;this._renderTileClippingMasks(Z,X,te),this.renderLayer(this,X,Z,te)}if(this.renderPass="sky",(u.globeToMercatorTransition(this.transform.zoom)>0||this.transform.projection.name!=="globe")&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<T.length;this.currentLayer++){const Z=this.style._layers[T[this.currentLayer]],X=h._getLayerSourceCache(Z);Z.isSky()&&this.renderLayer(this,X,Z,X?B[X.id]:void 0)}for(this.transform.projection.name==="globe"&&function(Z){const X=Z.context,te=X.gl,le=Z.transform,ge=new u.DepthMode(te.LEQUAL,u.DepthMode.ReadOnly,[0,1]),de=Z.useProgram("globeAtmosphere"),se=le.centerOffset,Se=le._camera.getCameraToClipPerspective(le._fov,le.width/le.height,le._nearZ,le._farZ);Se[8]=2*-se.x/le.width,Se[9]=2*se.y/le.height;const xe=u.invert([],Se),Te=u.mul([],xe,le.projMatrix),Me={u_frustum_tl:Rn([-1,1,1],xe),u_frustum_tr:Rn([1,1,1],xe),u_frustum_br:Rn([1,-1,1],xe),u_frustum_bl:Rn([-1,-1,1],xe),u_globe_pos:Rn([le.globeMatrix[12],le.globeMatrix[13],le.globeMatrix[14]],Te),u_globe_radius:le.worldSize/2/Math.PI-1,u_opacity:1-u.globeToMercatorTransition(le.zoom),u_fadeout_range:2,u_start_color:[1,1,1],u_end_color:[.0118,.7451,.9882]};Z.prepareDrawProgram(X,de);const Ae=Z.globeSharedBuffers;Ae&&de.draw(X,te.TRIANGLES,ge,u.StencilMode.disabled,u.ColorMode.alphaBlended,u.CullFaceMode.backCW,Me,"skybox",Ae.atmosphereVertexBuffer,Ae.atmosphereIndexBuffer,Ae.atmosphereSegments)}(this),this.renderPass="translucent",this.currentLayer=0;this.currentLayer<T.length;){const Z=this.style._layers[T[this.currentLayer]],X=h._getLayerSourceCache(Z);if(Z.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(Z)){if(Z.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const te=X?(Z.type==="symbol"?F:B)[X.id]:void 0;this._renderTileClippingMasks(Z,X,X?k[X.id]:void 0),this.renderLayer(this,X,Z,te),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry){let Z=null;u.values(this.style._layers).forEach(X=>{const te=h._getLayerSourceCache(X);te&&!X.isHidden(this.transform.zoom)&&(!Z||Z.getSource().maxzoom<te.getSource().maxzoom)&&(Z=te)}),Z&&this.options.showTileBoundaries&&Oa.debug(this,Z,Z.getVisibleCoordinates())}this.options.showPadding&&function(Z){const X=Z.transform.padding;bt(Z,Z.transform.height-(X.top||0),3,za),bt(Z,X.bottom||0,3,Fa),Wr(Z,X.left||0,3,Jl),Wr(Z,Z.transform.width-(X.right||0),3,Ns);const te=Z.transform.centerPoint;(function(le,ge,de,se){Ko(le,ge-1,de-10,2,20,se),Ko(le,ge-10,de-1,20,2,se)})(Z,te.x,Z.transform.height-te.y,$s)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(u.window.performance.now()),this.saveCanvasCopy())}renderLayer(h,_,T,C){T.isHidden(this.transform.zoom)||(T.type==="background"||T.type==="sky"||T.type==="custom"||C&&C.length)&&(this.id=T.id,this.gpuTimingStart(T),h.transform.projection.unsupportedLayers&&h.transform.projection.unsupportedLayers.includes(T.type)||Oa[T.type](h,_,T,C,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(h){if(!this.options.gpuTiming)return;const _=this.context.extTimerQuery;let T=this.gpuTimers[h.id];T||(T=this.gpuTimers[h.id]={calls:0,cpuTime:0,query:_.createQueryEXT()}),T.calls++,_.beginQueryEXT(_.TIME_ELAPSED_EXT,T.query)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const h=this.context.extTimerQuery;h.endQueryEXT(h.TIME_ELAPSED_EXT)}collectGpuTimers(){const h=this.gpuTimers;return this.gpuTimers={},h}queryGpuTimers(h){const _={};for(const T in h){const C=h[T],k=this.context.extTimerQuery,B=k.getQueryObjectEXT(C.query,k.QUERY_RESULT_EXT)/1e6;k.deleteQueryEXT(C.query),_[T]=B}return _}translatePosMatrix(h,_,T,C,k){if(!T[0]&&!T[1])return h;const B=k?C==="map"?this.transform.angle:0:C==="viewport"?-this.transform.angle:0;if(B){const Z=Math.sin(B),X=Math.cos(B);T=[T[0]*X-T[1]*Z,T[0]*Z+T[1]*X]}const F=[k?T[0]:gt(_,T[0],this.transform.zoom),k?T[1]:gt(_,T[1],this.transform.zoom),0],V=new Float32Array(16);return u.translate(V,h,F),V}saveTileTexture(h){const _=this._tileTextures[h.size[0]];_?_.push(h):this._tileTextures[h.size[0]]=[h]}getTileTexture(h){const _=this._tileTextures[h];return _&&_.length>0?_.pop():null}isPatternMissing(h){if(!h)return!1;if(!h.from||!h.to)return!0;const _=this.imageManager.getPattern(h.from.toString()),T=this.imageManager.getPattern(h.to.toString());return!_||!T}currentGlobalDefines(){const h=this.terrain&&this.terrain.renderingToTexture,_=this.style&&this.style.fog,T=[];return this.terrain&&!this.terrain.renderingToTexture&&T.push("TERRAIN"),_&&!h&&_.getOpacity(this.transform.pitch)!==0&&T.push("FOG"),h&&T.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&T.push("OVERDRAW_INSPECTOR"),T}useProgram(h,_,T){this.cache=this.cache||{};const C=T||[],k=this.currentGlobalDefines().concat(C),B=Xo.cacheKey(h,k,_);return this.cache[B]||(this.cache[B]=new Xo(this.context,h,Go[h],_,Li[h],k)),this.cache[B]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const h=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(h.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=u.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new u.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}prepareDrawProgram(h,_,T){if(this.terrain&&this.terrain.renderingToTexture)return;const C=this.style.fog;if(C){const k=C.getOpacity(this.transform.pitch);k!==0&&_.setFogUniformValues(h,((B,F,V,Z)=>{const X=F.properties.get("color"),te=B.frameCounter/1e3%1,le=[X.r/X.a,X.g/X.a,X.b/X.a,Z];return{u_fog_matrix:V?B.transform.calculateFogTileMatrix(V):B.identityMat,u_fog_range:F.getFovAdjustedRange(B.transform._fov),u_fog_color:le,u_fog_horizon_blend:F.properties.get("horizon-blend"),u_fog_temporal_offset:te}})(this,C,T,k))}}setTileLoadedFlag(h){this.tileLoaded=h}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1}canvasCopy(){const h=this.context.gl,_=h.createTexture();return h.bindTexture(h.TEXTURE_2D,_),h.copyTexImage2D(h.TEXTURE_2D,0,h.RGBA,0,0,h.drawingBufferWidth,h.drawingBufferHeight,0),_}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const h=this.style&&this.style.fog;return!!h&&h.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const h=this._backgroundTiles,_=this._backgroundTiles={},T=this.transform.coveringTiles({tileSize:512});for(const C of T)_[C.key]=h[C.key]||new u.Tile(C,512,this.transform.tileZoom,this);return _}clearBackgroundTiles(){this._backgroundTiles={}}}class Ln{constructor(h=0,_=0,T=0,C=0){if(isNaN(h)||h<0||isNaN(_)||_<0||isNaN(T)||T<0||isNaN(C)||C<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=h,this.bottom=_,this.left=T,this.right=C}interpolate(h,_,T){return _.top!=null&&h.top!=null&&(this.top=u.number(h.top,_.top,T)),_.bottom!=null&&h.bottom!=null&&(this.bottom=u.number(h.bottom,_.bottom,T)),_.left!=null&&h.left!=null&&(this.left=u.number(h.left,_.left,T)),_.right!=null&&h.right!=null&&(this.right=u.number(h.right,_.right,T)),this}getCenter(h,_){const T=u.clamp((this.left+h-this.right)/2,0,h),C=u.clamp((this.top+_-this.bottom)/2,0,_);return new u.pointGeometry(T,C)}equals(h){return this.top===h.top&&this.bottom===h.bottom&&this.left===h.left&&this.right===h.right}clone(){return new Ln(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function ic(x,h){const _=u.getColumn(x,3);u.fromQuat(x,h),u.setColumn(x,3,_)}function Na(x,h){const _=u.identity$1([]);return u.rotateZ$1(_,_,-h),u.rotateX$1(_,_,-x),_}function Us(x,h){const _=[x[0],x[1],0],T=[h[0],h[1],0];if(u.length(_)>=1e-15){const B=u.normalize([],_);u.scale$2(T,B,u.dot(T,B)),h[0]=T[0],h[1]=T[1]}const C=u.cross([],h,x);if(u.len(C)<1e-15)return null;const k=Math.atan2(-C[1],C[0]);return Na(Math.atan2(Math.sqrt(x[0]*x[0]+x[1]*x[1]),-x[2]),k)}class Qo{constructor(h,_){this.position=h,this.orientation=_}get position(){return this._position}set position(h){if(h){const _=h instanceof u.MercatorCoordinate?h:new u.MercatorCoordinate(h[0],h[1],h[2]);this._renderWorldCopies&&(_.x=u.wrap(_.x,0,1)),this._position=_}else this._position=null}lookAtPoint(h,_){if(this.orientation=null,!this.position)return;const T=this._elevation?this._elevation.getAtPointOrZero(u.MercatorCoordinate.fromLngLat(h)):0,C=this.position,k=u.MercatorCoordinate.fromLngLat(h,T),B=[k.x-C.x,k.y-C.y,k.z-C.z];_||(_=[0,0,1]),_[2]=Math.abs(_[2]),this.orientation=Us(B,_)}setPitchBearing(h,_){this.orientation=Na(u.degToRad(h),u.degToRad(-_))}}class es{constructor(h,_){this._transform=u.identity([]),this.orientation=_,this.position=h}get mercatorPosition(){const h=this.position;return new u.MercatorCoordinate(h[0],h[1],h[2])}get position(){const h=u.getColumn(this._transform,3);return[h[0],h[1],h[2]]}set position(h){var _;h&&u.setColumn(this._transform,3,[(_=h)[0],_[1],_[2],1])}get orientation(){return this._orientation}set orientation(h){this._orientation=h||u.identity$1([]),h&&ic(this._transform,this._orientation)}getPitchBearing(){const h=this.forward(),_=this.right();return{bearing:Math.atan2(-_[1],_[0]),pitch:Math.atan2(Math.sqrt(h[0]*h[0]+h[1]*h[1]),-h[2])}}setPitchBearing(h,_){this._orientation=Na(h,_),ic(this._transform,this._orientation)}forward(){const h=u.getColumn(this._transform,2);return[-h[0],-h[1],-h[2]]}up(){const h=u.getColumn(this._transform,1);return[-h[0],-h[1],-h[2]]}right(){const h=u.getColumn(this._transform,0);return[h[0],h[1],h[2]]}getCameraToWorld(h,_){const T=new Float64Array(16);return u.invert(T,this.getWorldToCamera(h,_)),T}getWorldToCameraPosition(h,_,T){const C=this.position;u.scale$2(C,C,-h);const k=new Float64Array(16);return u.fromScaling(k,[T,T,T]),u.translate(k,k,C),k[10]*=_,k}getWorldToCamera(h,_){const T=new Float64Array(16),C=new Float64Array(4),k=this.position;return u.conjugate(C,this._orientation),u.scale$2(k,k,-h),u.fromQuat(T,C),u.translate(T,T,k),T[1]*=-1,T[5]*=-1,T[9]*=-1,T[13]*=-1,T[8]*=_,T[9]*=_,T[10]*=_,T[11]*=_,T}getCameraToClipPerspective(h,_,T,C){const k=new Float64Array(16);return u.perspective(k,h,_,T,C),k}getDistanceToElevation(h){const _=h===0?0:u.mercatorZfromAltitude(h,this.position[1]),T=this.forward();return(_-this.position[2])/T[2]}clone(){return new es([...this.position],[...this.orientation])}}function $a(x,h){const _=ts(x),T=function(k,B,F,V,Z){const X=new u.LngLat(F.lng-180*zn,F.lat),te=new u.LngLat(F.lng+180*zn,F.lat),le=k.project(X.lng,X.lat),ge=k.project(te.lng,te.lat),de=-Math.atan2(ge.y-le.y,ge.x-le.x),se=u.MercatorCoordinate.fromLngLat(F);se.y=u.clamp(se.y,-.999975,.999975);const Se=se.toLngLat(),xe=k.project(Se.lng,Se.lat),Te=u.MercatorCoordinate.fromLngLat(Se);Te.x+=zn;const Me=Te.toLngLat(),Ae=k.project(Me.lng,Me.lat),Ee=ja(Ae.x-xe.x,Ae.y-xe.y,de),De=u.MercatorCoordinate.fromLngLat(Se);De.y+=zn;const Ue=De.toLngLat(),Ze=k.project(Ue.lng,Ue.lat),He=ja(Ze.x-xe.x,Ze.y-xe.y,de),Ye=Math.abs(Ee.x)/Math.abs(He.y),ct=u.identity([]);u.rotateZ(ct,ct,-de*(1-(Z?0:V)));const Ve=u.identity([]);return u.scale(Ve,Ve,[1,1-(1-Ye)*V,1]),Ve[4]=-He.x/He.y*V,u.rotateZ(Ve,Ve,de),u.multiply$1(Ve,ct,Ve),Ve}(x.projection,0,x.center,_,h),C=Ua(x);return u.scale(T,T,[C,C,1]),T}function Ua(x){const h=x.projection,_=ts(x),T=Va(h,x.center),C=Va(h,u.LngLat.convert(h.center));return Math.pow(2,T*_+(1-_)*C)}function ts(x){const h=x.projection.range;if(!h)return 0;const _=Math.max(x.width,x.height),T=Math.log(_/1024)/Math.LN2;return u.smoothstep(h[0]+T,h[1]+T,x.zoom)}const zn=1/4e4;function Va(x,h){const _=u.clamp(h.lat,-u.MAX_MERCATOR_LATITUDE,u.MAX_MERCATOR_LATITUDE),T=new u.LngLat(h.lng-180*zn,_),C=new u.LngLat(h.lng+180*zn,_),k=x.project(T.lng,_),B=x.project(C.lng,_),F=u.MercatorCoordinate.fromLngLat(T),V=u.MercatorCoordinate.fromLngLat(C),Z=B.x-k.x,X=B.y-k.y,te=V.x-F.x,le=V.y-F.y,ge=Math.sqrt((te*te+le*le)/(Z*Z+X*X));return Math.log(ge)/Math.LN2}function ja(x,h,_){const T=Math.cos(_),C=Math.sin(_);return{x:x*T-h*C,y:x*C+h*T}}class Vs{constructor(h,_,T,C,k,B,F){this.tileSize=512,this._renderWorldCopies=k===void 0||k,this._minZoom=h||0,this._maxZoom=_||22,this._minPitch=T==null?0:T,this._maxPitch=C==null?60:C,this.setProjection(B),this.setMaxBounds(F),this.width=0,this.height=0,this._center=new u.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Ln,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new es,this._centerAltitude=0,this._centerAltitudeValidForExaggeration=0,this._averageElevation=0,this.cameraElevationReference="ground",this._projectionScaler=1,this._horizonShift=.1}clone(){const h=new Vs(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return h._elevation=this._elevation,h._centerAltitude=this._centerAltitude,h._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,h.tileSize=this.tileSize,h.width=this.width,h.height=this.height,h.cameraElevationReference=this.cameraElevationReference,h._center=this._center,h._setZoom(this.zoom),h._seaLevelZoom=this._seaLevelZoom,h.angle=this.angle,h._fov=this._fov,h._pitch=this._pitch,h._nearZ=this._nearZ,h._farZ=this._farZ,h._averageElevation=this._averageElevation,h._unmodified=this._unmodified,h._edgeInsets=this._edgeInsets.clone(),h._camera=this._camera.clone(),h._calcMatrices(),h.freezeTileCoverage=this.freezeTileCoverage,h}get elevation(){return this._elevation}set elevation(h){this._elevation!==h&&(this._elevation=h,this._updateCameraOnTerrain(),this._calcMatrices())}updateElevation(h){const _=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||_)&&this._updateCameraOnTerrain(),(h||_)&&this._constrainCameraAltitude(),this._calcMatrices()}getProjection(){return u.pick(this.projection,["name","center","parallels"])}setProjection(h){h==null&&(h={name:"mercator"}),this.projectionOptions=h;const _=this.projection?this.getProjection():void 0;this.projection=u.getProjection(h);const T=this.getProjection();return z(_,T)?null:(this._calcMatrices(),T)}get minZoom(){return this._minZoom}set minZoom(h){this._minZoom!==h&&(this._minZoom=h,this.zoom=Math.max(this.zoom,h))}get maxZoom(){return this._maxZoom}set maxZoom(h){this._maxZoom!==h&&(this._maxZoom=h,this.zoom=Math.min(this.zoom,h))}get minPitch(){return this._minPitch}set minPitch(h){this._minPitch!==h&&(this._minPitch=h,this.pitch=Math.max(this.pitch,h))}get maxPitch(){return this._maxPitch}set maxPitch(h){this._maxPitch!==h&&(this._maxPitch=h,this.pitch=Math.min(this.pitch,h))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(h){h===void 0?h=!0:h===null&&(h=!1),this._renderWorldCopies=h}get worldSize(){return this.tileSize*this.scale}get cameraWorldSize(){const h=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(h))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.cameraWorldSize)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new u.pointGeometry(this.width,this.height)}get bearing(){return u.wrap(this.rotation,-180,180)}set bearing(h){this.rotation=h}get rotation(){return-this.angle/Math.PI*180}set rotation(h){const _=-h*Math.PI/180;var T;this.angle!==_&&(this._unmodified=!1,this.angle=_,this._calcMatrices(),this.rotationMatrix=(T=new u.ARRAY_TYPE(4),u.ARRAY_TYPE!=Float32Array&&(T[1]=0,T[2]=0),T[0]=1,T[3]=1,T),function(C,k,B){var F=k[0],V=k[1],Z=k[2],X=k[3],te=Math.sin(B),le=Math.cos(B);C[0]=F*le+Z*te,C[1]=V*le+X*te,C[2]=F*-te+Z*le,C[3]=V*-te+X*le}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(h){const _=u.clamp(h,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==_&&(this._unmodified=!1,this._pitch=_,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(h){h=Math.max(.01,Math.min(60,h)),this._fov!==h&&(this._unmodified=!1,this._fov=h/180*Math.PI,this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(h){this._averageElevation=h,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(h){const _=Math.min(Math.max(h,this.minZoom),this.maxZoom);this._zoom!==_&&(this._unmodified=!1,this._setZoom(_),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(h){this._zoom=h,this.scale=this.zoomScale(h),this.tileZoom=Math.floor(h),this.zoomFraction=h-this.tileZoom}_updateCameraOnTerrain(){if(!this._elevation||!this._elevation.isDataAvailableAtPoint(this.locationCoordinate(this.center)))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=0);const h=this._elevation;this._centerAltitude=h.getAtPointOrZero(this.locationCoordinate(this.center)),this._centerAltitudeValidForExaggeration=h.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const h=this._elevation,_=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],T=this.horizonLineFromTop();let C=0,k=0;for(let B=0;B<_.length;B++){const F=new u.pointGeometry(_[B][0]*this.width,T+_[B][1]*(this.height-T)),V=h.pointCoordinate(F);if(!V)continue;const Z=1/Math.hypot(V[0]-this._camera.position[0],V[1]-this._camera.position[1]);C+=V[3]*Z,k+=Z}return k===0?NaN:C/k}get center(){return this._center}set center(h){h.lat===this._center.lat&&h.lng===this._center.lng||(this._unmodified=!1,this._center=h,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const h=this._seaLevelZoom,_=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),T=this.pixelsPerMeter/this.worldSize*_,C=this._mercatorZfromZoom(h),k=this._mercatorZfromZoom(this._maxZoom),B=Math.max(C-T,k);this._setZoom(this._zoomFromMercatorZ(B))}get padding(){return this._edgeInsets.toJSON()}set padding(h){this._edgeInsets.equals(h)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,h,1),this._calcMatrices())}computeZoomRelativeTo(h){const _=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,h.toAltitude()));let T;T=h.z<this._camera.position[2]?[_.x,_.y,_.z]:[h.x,h.y,h.z];const C=u.length(u.sub([],this._camera.position,T));return u.clamp(this._zoomFromMercatorZ(C),this._minZoom,this._maxZoom)}setFreeCameraOptions(h){if(!this.height||!h.position&&!h.orientation)return;this._updateCameraState();let _=!1;if(h.orientation&&!u.exactEquals(h.orientation,this._camera.orientation)&&(_=this._setCameraOrientation(h.orientation)),h.position){const T=[h.position.x,h.position.y,h.position.z];u.exactEquals$1(T,this._camera.position)||(this._setCameraPosition(T),_=!0)}_&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const h=this._camera.position,_=new Qo;return _.position=new u.MercatorCoordinate(h[0],h[1],h[2]),_.orientation=this._camera.orientation,_._elevation=this.elevation,_._renderWorldCopies=this.renderWorldCopies,_}_setCameraOrientation(h){if(!u.length$1(h))return!1;u.normalize$1(h,h);const _=u.transformQuat([],[0,0,-1],h),T=u.transformQuat([],[0,-1,0],h);if(T[2]<0)return!1;const C=Us(_,T);return!!C&&(this._camera.orientation=C,!0)}_setCameraPosition(h){const _=this.zoomScale(this.minZoom)*this.tileSize,T=this.zoomScale(this.maxZoom)*this.tileSize,C=this.cameraToCenterDistance;h[2]=u.clamp(h[2],C/T,C/_),this._camera.position=h}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(h){return this._edgeInsets.equals(h)}interpolatePadding(h,_,T){this._unmodified=!1,this._edgeInsets.interpolate(h,_,T),this._constrain(),this._calcMatrices()}coveringZoomLevel(h){const _=(h.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/h.tileSize));return Math.max(0,_)}getVisibleUnwrappedCoordinates(h){const _=[new u.UnwrappedTileID(0,h)];if(this.renderWorldCopies){const T=this.pointCoordinate(new u.pointGeometry(0,0)),C=this.pointCoordinate(new u.pointGeometry(this.width,0)),k=this.pointCoordinate(new u.pointGeometry(this.width,this.height)),B=this.pointCoordinate(new u.pointGeometry(0,this.height)),F=Math.floor(Math.min(T.x,C.x,k.x,B.x)),V=Math.floor(Math.max(T.x,C.x,k.x,B.x)),Z=1;for(let X=F-Z;X<=V+Z;X++)X!==0&&_.push(new u.UnwrappedTileID(X,h))}return _}coveringTiles(h){let _=this.coveringZoomLevel(h);const T=_,C=this.elevation&&!h.isTerrainDEM,k=this.projection.name==="mercator";if(h.minzoom!==void 0&&_<h.minzoom)return[];h.maxzoom!==void 0&&_>h.maxzoom&&(_=h.maxzoom);const B=this.locationCoordinate(this.center),F=this.center.lat,V=1<<_,Z=[V*B.x,V*B.y,0],X=this.projection.name==="globe",te=!X,le=u.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,_,te),ge=X?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),de=V*u.mercatorZfromAltitude(1,this.center.lat),se=this._camera.position[2]/u.mercatorZfromAltitude(1,this.center.lat),Se=[V*ge.x,V*ge.y,se*(te?1:de)],xe=this.cameraToCenterDistance/h.tileSize*(h.roundZoom?1:.502),Te=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?_:0,Me=h.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,Ae=h.isTerrainDEM?-Me:this._elevation?this._elevation.getMinElevationBelowMSL():0,Ee=this.projection.isReprojectedInTileSpace?Ua(this):1,De=Je=>{const qt=new u.MercatorCoordinate(Je.x+25e-6,Je.y,Je.z),It=new u.MercatorCoordinate(Je.x,Je.y+25e-6,Je.z),Ct=Je.toLngLat(),Kt=qt.toLngLat(),mi=It.toLngLat(),jt=this.locationCoordinate(Ct),ti=this.locationCoordinate(Kt),Ii=this.locationCoordinate(mi),Yi=Math.hypot(ti.x-jt.x,ti.y-jt.y),vr=Math.hypot(Ii.x-jt.x,Ii.y-jt.y);return Math.sqrt(Yi*vr)*Ee/25e-6},Ue=Je=>{const At=Me,qt=Ae;return{aabb:u.tileAABB(this,V,0,0,0,Je,qt,At,this.projection),zoom:0,x:0,y:0,minZ:qt,maxZ:At,wrap:Je,fullyVisible:!1}},Ze=[];let He=[];const Ye=_,ct=h.reparseOverscaled?T:_,Ve=Je=>Je*Je,ht=Ve((se-this._centerAltitude)*de),at=Je=>{if(!this._elevation||!Je.tileID||!k)return;const At=this._elevation.getMinMaxForTile(Je.tileID),qt=Je.aabb;At?(qt.min[2]=At.min,qt.max[2]=At.max,qt.center[2]=(qt.min[2]+qt.max[2])/2):(Je.shouldSplit=Dt(Je),Je.shouldSplit||(qt.min[2]=qt.max[2]=qt.center[2]=this._centerAltitude))},Dt=Je=>{if(Je.zoom<Te)return!0;if(Je.zoom===Ye)return!1;if(Je.shouldSplit!=null)return Je.shouldSplit;const At=Je.aabb.distanceX(Se),qt=Je.aabb.distanceY(Se);let It=ht,Ct=1;if(X){It=Ve(Je.aabb.distanceZ(Se));const mi=Math.pow(2,Je.zoom),jt=u.latFromMercatorY((Je.y+1)/mi),ti=u.latFromMercatorY(Je.y/mi),Ii=Math.min(Math.max(F,jt),ti),Yi=u.circumferenceAtLatitude(Ii)/u.circumferenceAtLatitude(F);Ct=Math.min(Yi,1)}else if(C&&(It=Ve(Je.aabb.distanceZ(Se)*de)),this.projection.isReprojectedInTileSpace&&T<=5){const mi=Math.pow(2,Je.zoom),jt=De(new u.MercatorCoordinate((Je.x+.5)/mi,(Je.y+.5)/mi));Ct=jt>.85?1:jt}const Kt=At*At+qt*qt+It;return Kt<Ve((1<<Ye-Je.zoom)*xe*Ct*((mi,jt)=>{if(jt*Ve(.707)<mi)return 1;const ti=Math.sqrt(jt/mi);return ti/(1.4144271570014144+(Math.pow(1.1,ti-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(It,ht),Kt))};if(this.renderWorldCopies)for(let Je=1;Je<=3;Je++)Ze.push(Ue(-Je)),Ze.push(Ue(Je));for(Ze.push(Ue(0));Ze.length>0;){const Je=Ze.pop(),At=Je.x,qt=Je.y;let It=Je.fullyVisible;if(!It){const Ct=Je.aabb.intersects(le);if(Ct===0)continue;It=Ct===2}if(Je.zoom!==Ye&&Dt(Je))for(let Ct=0;Ct<4;Ct++){const Kt=(At<<1)+Ct%2,mi=(qt<<1)+(Ct>>1),jt={aabb:k?Je.aabb.quadrant(Ct):u.tileAABB(this,V,Je.zoom+1,Kt,mi,Je.wrap,Je.minZ,Je.maxZ,this.projection),zoom:Je.zoom+1,x:Kt,y:mi,wrap:Je.wrap,fullyVisible:It,tileID:void 0,shouldSplit:void 0,minZ:Je.minZ,maxZ:Je.maxZ};C&&!X&&(jt.tileID=new u.OverscaledTileID(Je.zoom+1===Ye?ct:Je.zoom+1,Je.wrap,Je.zoom+1,Kt,mi),at(jt)),Ze.push(jt)}else{const Ct=Je.zoom===Ye?ct:Je.zoom;if(h.minzoom&&h.minzoom>Ct)continue;const Kt=Z[0]-(.5+At+(Je.wrap<<Je.zoom))*(1<<_-Je.zoom),mi=Z[1]-.5-qt,jt=Je.tileID?Je.tileID:new u.OverscaledTileID(Ct,Je.wrap,Je.zoom,At,qt);He.push({tileID:jt,distanceSq:Kt*Kt+mi*mi})}}if(this.fogCullDistSq){const Je=this.fogCullDistSq,At=this.horizonLineFromTop();He=He.filter(qt=>{const It=[0,0,0,1],Ct=[u.EXTENT,u.EXTENT,0,1],Kt=this.calculateFogTileMatrix(qt.tileID.toUnwrapped());u.transformMat4$1(It,It,Kt),u.transformMat4$1(Ct,Ct,Kt);const mi=u.getAABBPointSquareDist(It,Ct);if(mi===0)return!0;let jt=!1;const ti=this._elevation;if(ti&&mi>Je&&At!==0){const Ii=this.calculateProjMatrix(qt.tileID.toUnwrapped());let Yi;h.isTerrainDEM||(Yi=ti.getMinMaxForTile(qt.tileID)),Yi||(Yi={min:Ae,max:Me});const vr=u.furthestTileCorner(this.rotation),br=[vr[0]*u.EXTENT,vr[1]*u.EXTENT,Yi.max];u.transformMat4(br,br,Ii),jt=(1-br[1])*this.height*.5<At}return mi<Je||jt})}return He.sort((Je,At)=>Je.distanceSq-At.distanceSq).map(Je=>Je.tileID)}resize(h,_){this.width=h,this.height=_,this.pixelsToGLUnits=[2/h,-2/_],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(h){return Math.pow(2,h)}scaleZoom(h){return Math.log(h)/Math.LN2}project(h){const _=u.clamp(h.lat,-u.MAX_MERCATOR_LATITUDE,u.MAX_MERCATOR_LATITUDE),T=this.projection.project(h.lng,_);return new u.pointGeometry(T.x*this.worldSize,T.y*this.worldSize)}unproject(h){return this.projection.unproject(h.x/this.worldSize,h.y/this.worldSize)}get point(){return this.project(this.center)}setLocationAtPoint(h,_){let T,C;const k=this.centerPoint;if(this.projection.name==="globe"){const F=this.worldSize;T=(_.x-k.x)/F,C=(_.y-k.y)/F}else{const F=this.pointCoordinate(_),V=this.pointCoordinate(k);T=F.x-V.x,C=F.y-V.y}const B=this.locationCoordinate(h);this.setLocation(new u.MercatorCoordinate(B.x-T,B.y-C))}setLocation(h){this.center=this.coordinateLocation(h),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(h){return this.projection.locationPoint(this,h)}locationPoint3D(h){return this._coordinatePoint(this.locationCoordinate(h),!0)}pointLocation(h){return this.coordinateLocation(this.pointCoordinate(h))}pointLocation3D(h){return this.coordinateLocation(this.pointCoordinate3D(h))}locationCoordinate(h,_){const T=_?u.mercatorZfromAltitude(_,h.lat):void 0,C=this.projection.project(h.lng,h.lat);return new u.MercatorCoordinate(C.x,C.y,T)}coordinateLocation(h){return this.projection.unproject(h.x,h.y)}pointRayIntersection(h,_){const T=_!=null?_:this._centerAltitude,C=[h.x,h.y,0,1],k=[h.x,h.y,1,1];u.transformMat4$1(C,C,this.pixelMatrixInverse),u.transformMat4$1(k,k,this.pixelMatrixInverse);const B=k[3];u.scale$1(C,C,1/C[3]),u.scale$1(k,k,1/B);const F=C[2],V=k[2];return{p0:C,p1:k,t:F===V?0:(T-F)/(V-F)}}screenPointToMercatorRay(h){const _=[h.x,h.y,0,1],T=[h.x,h.y,1,1];return u.transformMat4$1(_,_,this.pixelMatrixInverse),u.transformMat4$1(T,T,this.pixelMatrixInverse),u.scale$1(_,_,1/_[3]),u.scale$1(T,T,1/T[3]),_[2]=u.mercatorZfromAltitude(_[2],this._center.lat)*this.worldSize,T[2]=u.mercatorZfromAltitude(T[2],this._center.lat)*this.worldSize,u.scale$1(_,_,1/this.worldSize),u.scale$1(T,T,1/this.worldSize),new u.Ray([_[0],_[1],_[2]],u.normalize([],u.sub([],T,_)))}rayIntersectionCoordinate(h){const{p0:_,p1:T,t:C}=h,k=u.mercatorZfromAltitude(_[2],this._center.lat),B=u.mercatorZfromAltitude(T[2],this._center.lat);return new u.MercatorCoordinate(u.number(_[0],T[0],C)/this.worldSize,u.number(_[1],T[1],C)/this.worldSize,u.number(k,B,C))}pointCoordinate(h,_=this._centerAltitude){return this.projection.pointCoordinate(this,h.x,h.y,_)}pointCoordinate3D(h){if(!this.elevation)return this.pointCoordinate(h);const _=this.elevation;let T=this.elevation.pointCoordinate(h);if(T)return new u.MercatorCoordinate(T[0],T[1],T[2]);let C=0,k=this.horizonLineFromTop();if(h.y>k)return this.pointCoordinate(h);const B=.02*k,F=h.clone();for(let V=0;V<10&&k-C>B;V++){F.y=u.number(C,k,.66);const Z=_.pointCoordinate(F);Z?(k=F.y,T=Z):C=F.y}return T?new u.MercatorCoordinate(T[0],T[1],T[2]):this.pointCoordinate(h)}isPointAboveHorizon(h){if(this.elevation)return!this.elevation.pointCoordinate(h);{const _=this.horizonLineFromTop();return h.y<_}}_coordinatePoint(h,_){const T=_&&this.elevation?this.elevation.getAtPointOrZero(h,this._centerAltitude):this._centerAltitude,C=[h.x*this.worldSize,h.y*this.worldSize,T+h.toAltitude(),1];return u.transformMat4$1(C,C,this.pixelMatrix),C[3]>0?new u.pointGeometry(C[0]/C[3],C[1]/C[3]):new u.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getBounds(h,_){const T=new u.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),C=new u.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),k=new u.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),B=new u.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let F=this.pointCoordinate(T,h),V=this.pointCoordinate(C,h);const Z=this.pointCoordinate(k,_),X=this.pointCoordinate(B,_),te=(le,ge)=>(ge.y-le.y)/(ge.x-le.x);return F.y>1&&V.y>=0?F=new u.MercatorCoordinate((1-X.y)/te(X,F)+X.x,1):F.y<0&&V.y<=1&&(F=new u.MercatorCoordinate(-X.y/te(X,F)+X.x,0)),V.y>1&&F.y>=0?V=new u.MercatorCoordinate((1-Z.y)/te(Z,V)+Z.x,1):V.y<0&&F.y<=1&&(V=new u.MercatorCoordinate(-Z.y/te(Z,V)+Z.x,0)),new u.LngLatBounds().extend(this.coordinateLocation(F)).extend(this.coordinateLocation(V)).extend(this.coordinateLocation(X)).extend(this.coordinateLocation(Z))}_getBounds3D(){const h=this.elevation;if(!h.visibleDemTiles.length)return this._getBounds(0,0);const _=h.visibleDemTiles.reduce((T,C)=>{if(C.dem){const k=C.dem.tree;T.min=Math.min(T.min,k.minimums[0]),T.max=Math.max(T.max,k.maximums[0])}return T},{min:Number.MAX_VALUE,max:0});return this._getBounds(_.min*h.exaggeration(),_.max*h.exaggeration())}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0)}horizonLineFromTop(h=!0){const _=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,T=this.height/2-_*(1-this._horizonShift);return h?Math.max(0,T):T}getMaxBounds(){return this.maxBounds}setMaxBounds(h){this.maxBounds=h,this.minLat=-u.MAX_MERCATOR_LATITUDE,this.maxLat=u.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,h&&(this.minLat=h.getSouth(),this.maxLat=h.getNorth(),this.minLng=h.getWest(),this.maxLng=h.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=u.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=u.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=u.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=u.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(h,_){return this.projection.createTileMatrix(this,_,h)}calculateDistanceTileData(h){const _=h.key,T=this._distanceTileDataCache;if(T[_])return T[_];const C=h.canonical,k=1/this.height,B=this.cameraWorldSize/this.zoomScale(C.z),F=(C.x+Math.pow(2,C.z)*h.wrap)*B,V=C.y*B,Z=this.point,X=this.angle,te=Math.sin(-X),le=-Math.cos(-X);return T[_]={bearing:[te,le],center:[(Z.x-F)*k,(Z.y-V)*k],scale:B/u.EXTENT*k},T[_]}calculateFogTileMatrix(h){const _=h.key,T=this._fogTileMatrixCache;if(T[_])return T[_];const C=this.calculatePosMatrix(h,this.cameraWorldSize);return u.multiply$1(C,this.worldToFogMatrix,C),T[_]=new Float32Array(C),T[_]}calculateProjMatrix(h,_=!1){const T=h.key,C=_?this._alignedProjMatrixCache:this._projMatrixCache;if(C[T])return C[T];const k=this.calculatePosMatrix(h,this.worldSize);return u.multiply$1(k,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:_?this.alignedProjMatrix:this.projMatrix,k),C[T]=new Float32Array(k),C[T]}calculatePixelsToTileUnitsMatrix(h){const _=h.tileID.key,T=this._pixelsToTileUnitsCache;if(T[_])return T[_];const C=function(k,B){const{scale:F}=k.tileTransform,V=F*u.EXTENT/(k.tileSize*Math.pow(2,B.zoom-k.tileID.overscaledZ+k.tileID.canonical.z));return Z=new Float32Array(4),le=(X=B.inverseAdjustmentMatrix)[1],ge=X[2],de=X[3],Se=(te=[V,V])[1],Z[0]=X[0]*(se=te[0]),Z[1]=le*se,Z[2]=ge*Se,Z[3]=de*Se,Z;var Z,X,te,le,ge,de,se,Se}(h,this);return T[_]=C,T[_]}customLayerMatrix(){return this.mercatorMatrix.slice()}recenterOnTerrain(){if(!this._elevation)return;const h=this._elevation;this._updateCameraState();const _=u.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,T=this._computeCameraPosition(_),C=this._camera.forward(),k=u.mercatorZfromAltitude(1,this._center.lat);T[2]/=k,C[2]/=k,u.normalize(C,C);const B=h.raycast(T,C,h.exaggeration());if(B){const F=u.scaleAndAdd([],T,C,B),V=new u.MercatorCoordinate(F[0],F[1],u.mercatorZfromAltitude(F[2],u.latFromMercatorY(F[1]))),Z=(V.z+u.length([V.x-T[0],V.y-T[1],V.z-T[2]*k]))*this._projectionScaler;this._seaLevelZoom=this._zoomFromMercatorZ(Z),this._centerAltitude=V.toAltitude(),this._center=this.coordinateLocation(V),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCameraAltitude(){if(!this._elevation)return;const h=this._elevation;this._updateCameraState();const _=u.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,T=this._computeCameraPosition(_),C=h.getAtPointOrZero(new u.MercatorCoordinate(...T)),k=this._minimumHeightOverTerrain()*Math.cos(u.degToRad(this._maxPitch)),B=this._camera.position[2]-this.pixelsPerMeter/this.worldSize*C;if(B<k){const F=this.locationCoordinate(this._center,this._centerAltitude),V=[F.x-T[0],F.y-T[1],F.z-T[2]],Z=u.length(V);V[2]-=(k-B)/this._projectionScaler;const X=u.length(V);if(X===0)return;u.scale$2(V,V,Z/X*this._projectionScaler),this._camera.position=[F.x-V[0],F.y-V[1],F.z*this._projectionScaler-V[2]],this._camera.orientation=Us(V,this._camera.up()),this._updateStateFromCamera()}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;if(this._constraining=!0,this.projection.isReprojectedInTileSpace){const te=this.center;return te.lat=u.clamp(te.lat,this.minLat,this.maxLat),!this.maxBounds&&this.renderWorldCopies||(te.lng=u.clamp(te.lng,this.minLng,this.maxLng)),this.center=te,void(this._constraining=!1)}const h=this._unmodified,{x:_,y:T}=this.point;let C=0,k=_,B=T;const F=this.width/2,V=this.height/2,Z=this.worldMinY*this.scale,X=this.worldMaxY*this.scale;if(T-V<Z&&(B=Z+V),T+V>X&&(B=X-V),X-Z<this.height&&(C=Math.max(C,this.height/(X-Z)),B=(X+Z)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const te=this.worldMinX*this.scale,le=this.worldMaxX*this.scale,ge=this.worldSize/2-(te+le)/2;k=(_+ge+this.worldSize)%this.worldSize-ge,k-F<te&&(k=te+F),k+F>le&&(k=le-F),le-te<this.width&&(C=Math.max(C,this.width/(le-te)),k=(le+te)/2)}k===_&&B===T||(this.center=this.unproject(new u.pointGeometry(k,B))),C&&(this.zoom+=this.scaleZoom(C)),this._constrainCameraAltitude(),this._unmodified=h,this._constraining=!1}_minZoomForBounds(){let h=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(h=Math.max(h,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),h}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const h=this._fov/2,_=this.centerOffset,T=this.pixelsPerMeter;this._projectionScaler=T/(u.mercatorZfromAltitude(1,this.center.lat)*this.worldSize),this.cameraToCenterDistance=.5/Math.tan(h)*this.height*this._projectionScaler,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const C=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?T:1),k=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);k[8]=2*-_.x/this.width,k[9]=2*_.y/this.height;let B=u.mul([],k,C);if(this.projection.isReprojectedInTileSpace){const Ae=this.locationCoordinate(this.center),Ee=u.identity([]);u.translate(Ee,Ee,[Ae.x*this.worldSize,Ae.y*this.worldSize,0]),u.multiply$1(Ee,Ee,$a(this)),u.translate(Ee,Ee,[-Ae.x*this.worldSize,-Ae.y*this.worldSize,0]),u.multiply$1(B,B,Ee),this.inverseAdjustmentMatrix=function(De){const Ue=$a(De,!0);return be([],[Ue[0],Ue[1],Ue[4],Ue[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=u.scale([],B,[this.worldSize,this.worldSize,this.worldSize/T,1]),this.projMatrix=B,this.invProjMatrix=u.invert(new Float64Array(16),this.projMatrix);const F=new Float32Array(16);u.identity(F),u.scale(F,F,[1,-1,1]),u.rotateX(F,F,this._pitch),u.rotateZ(F,F,this.angle);const V=u.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),Z=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;V[8]=2*-_.x/this.width,V[9]=2*(_.y+Z)/this.height,this.skyboxMatrix=u.multiply$1(F,V,F);const X=this.point,te=X.x,le=X.y,ge=this.width%2/2,de=this.height%2/2,se=Math.cos(this.angle),Se=Math.sin(this.angle),xe=te-Math.round(te)+se*ge+Se*de,Te=le-Math.round(le)+se*de+Se*ge,Me=new Float64Array(B);if(u.translate(Me,Me,[xe>.5?xe-1:xe,Te>.5?Te-1:Te,0]),this.alignedProjMatrix=Me,B=u.create(),u.scale(B,B,[this.width/2,-this.height/2,1]),u.translate(B,B,[1,-1,0]),this.labelPlaneMatrix=B,B=u.create(),u.scale(B,B,[1,-1,1]),u.translate(B,B,[-1,-1,0]),u.scale(B,B,[2/this.width,2/this.height,1]),this.glCoordMatrix=B,this.pixelMatrix=u.multiply$1(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},B=u.invert(new Float64Array(16),this.pixelMatrix),!B)throw new Error("failed to invert matrix");this.pixelMatrixInverse=B,this.globeMatrix=this.projection.name==="globe"?u.calculateGlobeMatrix(this):B,this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const h=this.cameraWorldSize,_=this.cameraPixelsPerMeter,T=this._camera.position,C=1/this.height,k=[h,h,_];u.scale$2(k,k,C),u.scale$2(T,T,-1),u.multiply$2(T,T,k);const B=u.create();u.translate(B,B,T),u.scale(B,B,k),this.mercatorFogMatrix=B,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(h,_,C)}_computeCameraPosition(h){const _=(h=h||this.pixelsPerMeter)/this.pixelsPerMeter,T=this._camera.forward(),C=this.point,k=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*_-h/this.worldSize*this._centerAltitude;return[C.x/this.worldSize-T[0]*k,C.y/this.worldSize-T[1]*k,h/this.worldSize*this._centerAltitude-T[2]*k]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(h){const _=this._maxCameraBoundsDistance()*Math.cos(this._pitch),T=h[2];let C=1;T>0&&(C=Math.min((_-this._camera.position[2])/T,1)),this._camera.position=u.scaleAndAdd([],this._camera.position,h,C),this._updateStateFromCamera(),this.projection.wrap&&(this.center=this.center.wrap())}_updateStateFromCamera(){const h=this._camera.position,_=this._camera.forward(),{pitch:T,bearing:C}=this._camera.getPitchBearing(),k=u.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._projectionScaler,B=this._mercatorZfromZoom(this._maxZoom)*Math.cos(u.degToRad(this._maxPitch)),F=Math.max((h[2]-k)/Math.cos(T),B),V=this._zoomFromMercatorZ(F);u.scaleAndAdd(h,h,_,F),this._pitch=u.clamp(T,u.degToRad(this.minPitch),u.degToRad(this.maxPitch)),this.angle=u.wrap(C,-Math.PI,Math.PI),this._setZoom(u.clamp(V,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new u.MercatorCoordinate(h[0],h[1],h[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(h){return Math.pow(2,h)*this.tileSize}_mercatorZfromZoom(h){return this.cameraToCenterDistance/this._worldSizeFromZoom(h)}_minimumHeightOverTerrain(){const h=Math.min((this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(h)}_zoomFromMercatorZ(h){return this.scaleZoom(this.cameraToCenterDistance/(h*this.tileSize))}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(u.warnOnce("Terrain is not yet supported with alternate projections. Use mercator to enable terrain."),1))}anyCornerOffEdge(h,_){const T=Math.min(h.x,_.x),C=Math.max(h.x,_.x),k=Math.min(h.y,_.y),B=Math.max(h.y,_.y);if(k<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const F=[new u.pointGeometry(T,k),new u.pointGeometry(C,B),new u.pointGeometry(T,B),new u.pointGeometry(C,k)],V=this.renderWorldCopies?-3:0,Z=this.renderWorldCopies?4:1;for(const X of F){const te=this.pointRayIntersection(X);if(te.t<0)return!0;const le=this.rayIntersectionCoordinate(te);if(le.x<V||le.y<0||le.x>Z||le.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+u.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new u.pointGeometry(0,0),new u.pointGeometry(this.width,this.height))}zoomDeltaToMovement(h,_){const T=u.length(u.sub([],this._camera.position,h)),C=this._zoomFromMercatorZ(T)+_;return T-this._mercatorZfromZoom(C)}getCameraPoint(){const h=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new u.pointGeometry(0,h))}}function Ga(x,h){let _=!1,T=null;const C=()=>{T=null,_&&(x(),T=setTimeout(C,h),_=!1)};return()=>(_=!0,T||C(),T)}class rc{constructor(h){this._hashName=h&&encodeURIComponent(h),u.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ga(this._updateHashUnthrottled.bind(this),300)}addTo(h){return this._map=h,u.window.addEventListener("hashchange",this._onHashChange,!1),h.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),u.window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(h){const _=this._map;if(!_)return"";const T=_.getCenter(),C=Math.round(100*_.getZoom())/100,k=Math.ceil((C*Math.LN2+Math.log(512/360/.5))/Math.LN10),B=Math.pow(10,k),F=Math.round(T.lng*B)/B,V=Math.round(T.lat*B)/B,Z=_.getBearing(),X=_.getPitch();let te="";if(te+=h?`/${F}/${V}/${C}`:`${C}/${V}/${F}`,(Z||X)&&(te+="/"+Math.round(10*Z)/10),X&&(te+=`/${Math.round(X)}`),this._hashName){const le=this._hashName;let ge=!1;const de=u.window.location.hash.slice(1).split("&").map(se=>{const Se=se.split("=")[0];return Se===le?(ge=!0,`${Se}=${te}`):se}).filter(se=>se);return ge||de.push(`${le}=${te}`),`#${de.join("&")}`}return`#${te}`}_getCurrentHash(){const h=u.window.location.hash.replace("#","");if(this._hashName){let _;return h.split("&").map(T=>T.split("=")).forEach(T=>{T[0]===this._hashName&&(_=T)}),(_&&_[1]||"").split("/")}return h.split("/")}_onHashChange(){const h=this._map;if(!h)return!1;const _=this._getCurrentHash();if(_.length>=3&&!_.some(T=>isNaN(T))){const T=h.dragRotate.isEnabled()&&h.touchZoomRotate.isEnabled()?+(_[3]||0):h.getBearing();return h.jumpTo({center:[+_[2],+_[1]],zoom:+_[0],bearing:T,pitch:+(_[4]||0)}),!0}return!1}_updateHashUnthrottled(){const h=u.window.location.href.replace(/(#.+)?$/,this.getHashString());u.window.history.replaceState(u.window.history.state,null,h)}}const wn={linearity:.3,easing:u.bezier(0,0,.3,1)},nc=u.extend({deceleration:2500,maxSpeed:1400},wn),oc=u.extend({deceleration:20,maxSpeed:1400},wn),sc=u.extend({deceleration:1e3,maxSpeed:360},wn),ac=u.extend({deceleration:1e3,maxSpeed:90},wn);class lc{constructor(h){this._map=h,this.clear()}clear(){this._inertiaBuffer=[]}record(h){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:u.exported.now(),settings:h})}_drainInertiaBuffer(){const h=this._inertiaBuffer,_=u.exported.now();for(;h.length>0&&_-h[0].time>160;)h.shift()}_onMoveEnd(h){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const _={zoom:0,bearing:0,pitch:0,pan:new u.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:k}of this._inertiaBuffer)_.zoom+=k.zoomDelta||0,_.bearing+=k.bearingDelta||0,_.pitch+=k.pitchDelta||0,k.panDelta&&_.pan._add(k.panDelta),k.around&&(_.around=k.around),k.pinchAround&&(_.pinchAround=k.pinchAround);const T=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,C={};if(_.pan.mag()){const k=ur(_.pan.mag(),T,u.extend({},nc,h||{}));C.offset=_.pan.mult(k.amount/_.pan.mag()),C.center=this._map.transform.center,is(C,k)}if(_.zoom){const k=ur(_.zoom,T,oc);C.zoom=this._map.transform.zoom+k.amount,is(C,k)}if(_.bearing){const k=ur(_.bearing,T,sc);C.bearing=this._map.transform.bearing+u.clamp(k.amount,-179,179),is(C,k)}if(_.pitch){const k=ur(_.pitch,T,ac);C.pitch=this._map.transform.pitch+k.amount,is(C,k)}if(C.zoom||C.bearing){const k=_.pinchAround===void 0?_.around:_.pinchAround;C.around=k?this._map.unproject(k):this._map.getCenter()}return this.clear(),C.noMoveStart=!0,C}}function is(x,h){(!x.duration||x.duration<h.duration)&&(x.duration=h.duration,x.easing=h.easing)}function ur(x,h,_){const{maxSpeed:T,linearity:C,deceleration:k}=_,B=u.clamp(x*C/(h/1e3),-T,T),F=Math.abs(B)/(k*C);return{easing:_.easing,duration:1e3*F,amount:B*(F/2)}}class $r extends u.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(h,_,T,C={}){const k=he(_.getCanvasContainer(),T),B=_.unproject(k);super(h,u.extend({point:k,lngLat:B,originalEvent:T},C)),this._defaultPrevented=!1,this.target=_}}class rs extends u.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(h,_,T){const C=h==="touchend"?T.changedTouches:T.touches,k=_e(_.getCanvasContainer(),C),B=k.map(V=>_.unproject(V)),F=k.reduce((V,Z,X,te)=>V.add(Z.div(te.length)),new u.pointGeometry(0,0));super(h,{points:k,point:F,lngLats:B,lngLat:_.unproject(F),originalEvent:T}),this._defaultPrevented=!1}}class yh extends u.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(h,_,T){super(h,{originalEvent:T}),this._defaultPrevented=!1}}class xh{constructor(h,_){this._map=h,this._clickTolerance=_.clickTolerance}reset(){this._mousedownPos=void 0}wheel(h){return this._firePreventable(new yh(h.type,this._map,h))}mousedown(h,_){return this._mousedownPos=_,this._firePreventable(new $r(h.type,this._map,h))}mouseup(h){this._map.fire(new $r(h.type,this._map,h))}preclick(h){const _=u.extend({},h);_.type="preclick",this._map.fire(new $r(_.type,this._map,_))}click(h,_){this._mousedownPos&&this._mousedownPos.dist(_)>=this._clickTolerance||(this.preclick(h),this._map.fire(new $r(h.type,this._map,h)))}dblclick(h){return this._firePreventable(new $r(h.type,this._map,h))}mouseover(h){this._map.fire(new $r(h.type,this._map,h))}mouseout(h){this._map.fire(new $r(h.type,this._map,h))}touchstart(h){return this._firePreventable(new rs(h.type,this._map,h))}touchmove(h){this._map.fire(new rs(h.type,this._map,h))}touchend(h){this._map.fire(new rs(h.type,this._map,h))}touchcancel(h){this._map.fire(new rs(h.type,this._map,h))}_firePreventable(h){if(this._map.fire(h),h.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class En{constructor(h){this._map=h}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(h){this._map.fire(new $r(h.type,this._map,h))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new $r("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(h){this._delayContextMenu?this._contextMenuEvent=h:this._map.fire(new $r(h.type,this._map,h)),this._map.listens("contextmenu")&&h.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class cc{constructor(h,_){this._map=h,this._el=h.getCanvasContainer(),this._container=h.getContainer(),this._clickTolerance=_.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(h,_){this.isEnabled()&&h.shiftKey&&h.button===0&&(Y(),this._startPos=this._lastPos=_,this._active=!0)}mousemoveWindow(h,_){if(!this._active)return;const T=_;if(this._lastPos.equals(T)||!this._box&&T.dist(this._startPos)<this._clickTolerance)return;const C=this._startPos;this._lastPos=T,this._box||(this._box=$("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",h));const k=Math.min(C.x,T.x),B=Math.max(C.x,T.x),F=Math.min(C.y,T.y),V=Math.max(C.y,T.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${k}px,${F}px)`,this._box.style.width=B-k+"px",this._box.style.height=V-F+"px")})}mouseupWindow(h,_){if(!this._active||h.button!==0)return;const T=this._startPos,C=_;if(this.reset(),re(),T.x!==C.x||T.y!==C.y)return this._map.fire(new u.Event("boxzoomend",{originalEvent:h})),{cameraAnimation:k=>k.fitScreenCoordinates(T,C,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",h)}keydown(h){this._active&&h.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",h))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),fe(),delete this._startPos,delete this._lastPos}_fireEvent(h,_){return this._map.fire(new u.Event(h,{originalEvent:_}))}}function Fn(x,h){const _={};for(let T=0;T<x.length;T++)_[x[T].identifier]=h[T];return _}class pn{constructor(h){this.reset(),this.numTouches=h.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(h,_,T){(this.centroid||T.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=h.timeStamp),T.length===this.numTouches&&(this.centroid=function(C){const k=new u.pointGeometry(0,0);for(const B of C)k._add(B);return k.div(C.length)}(_),this.touches=Fn(T,_)))}touchmove(h,_,T){if(this.aborted||!this.centroid)return;const C=Fn(T,_);for(const k in this.touches){const B=this.touches[k],F=C[k];(!F||F.dist(B)>30)&&(this.aborted=!0)}}touchend(h,_,T){if((!this.centroid||h.timeStamp-this.startTime>500)&&(this.aborted=!0),T.length===0){const C=!this.aborted&&this.centroid;if(this.reset(),C)return C}}}class vo{constructor(h){this.singleTap=new pn(h),this.numTaps=h.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(h,_,T){this.singleTap.touchstart(h,_,T)}touchmove(h,_,T){this.singleTap.touchmove(h,_,T)}touchend(h,_,T){const C=this.singleTap.touchend(h,_,T);if(C){const k=h.timeStamp-this.lastTime<500,B=!this.lastTap||this.lastTap.dist(C)<30;if(k&&B||this.reset(),this.count++,this.lastTime=h.timeStamp,this.lastTap=C,this.count===this.numTaps)return this.reset(),C}}}class Mt{constructor(){this._zoomIn=new vo({numTouches:1,numTaps:2}),this._zoomOut=new vo({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(h,_,T){this._zoomIn.touchstart(h,_,T),this._zoomOut.touchstart(h,_,T)}touchmove(h,_,T){this._zoomIn.touchmove(h,_,T),this._zoomOut.touchmove(h,_,T)}touchend(h,_,T){const C=this._zoomIn.touchend(h,_,T),k=this._zoomOut.touchend(h,_,T);return C?(this._active=!0,h.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:B=>B.easeTo({duration:300,zoom:B.getZoom()+1,around:B.unproject(C)},{originalEvent:h})}):k?(this._active=!0,h.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:B=>B.easeTo({duration:300,zoom:B.getZoom()-1,around:B.unproject(k)},{originalEvent:h})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const hc={0:1,2:2};class js{constructor(h){this.reset(),this._clickTolerance=h.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(h,_){return!1}_move(h,_){return{}}mousedown(h,_){if(this._lastPoint)return;const T=we(h);this._correctButton(h,T)&&(this._lastPoint=_,this._eventButton=T)}mousemoveWindow(h,_){const T=this._lastPoint;if(T){if(h.preventDefault(),this._eventButton!=null&&function(C,k){const B=hc[k];return C.buttons===void 0||(C.buttons&B)!==B}(h,this._eventButton))this.reset();else if(this._moved||!(_.dist(T)<this._clickTolerance))return this._moved=!0,this._lastPoint=_,this._move(T,_)}}mouseupWindow(h){this._lastPoint&&we(h)===this._eventButton&&(this._moved&&re(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ns extends js{mousedown(h,_){super.mousedown(h,_),this._lastPoint&&(this._active=!0)}_correctButton(h,_){return _===0&&!h.ctrlKey}_move(h,_){return{around:_,panDelta:_.sub(h)}}}class bo extends js{_correctButton(h,_){return _===0&&h.ctrlKey||_===2}_move(h,_){const T=.8*(_.x-h.x);if(T)return this._active=!0,{bearingDelta:T}}contextmenu(h){h.preventDefault()}}class qa extends js{_correctButton(h,_){return _===0&&h.ctrlKey||_===2}_move(h,_){const T=-.5*(_.y-h.y);if(T)return this._active=!0,{pitchDelta:T}}contextmenu(h){h.preventDefault()}}class uc{constructor(h,_){this._map=h,this._el=h.getCanvasContainer(),this._minTouches=1,this._clickTolerance=_.clickTolerance||1,this.reset(),u.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new u.pointGeometry(0,0)}touchstart(h,_,T){return this._calculateTransform(h,_,T)}touchmove(h,_,T){if(this._active&&!(T.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(T.length===1)return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return h.preventDefault(),this._calculateTransform(h,_,T)}}touchend(h,_,T){this._calculateTransform(h,_,T),this._active&&T.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(h,_,T){T.length>0&&(this._active=!0);const C=Fn(T,_),k=new u.pointGeometry(0,0),B=new u.pointGeometry(0,0);let F=0;for(const Z in C){const X=C[Z],te=this._touches[Z];te&&(k._add(X),B._add(X.sub(te)),F++,C[Z]=X)}if(this._touches=C,F<this._minTouches||!B.mag())return;const V=B.div(F);return this._sum._add(V),this._sum.mag()<this._clickTolerance?void 0:{around:k.div(F),panDelta:V}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=$("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show")},500)}}class Gs{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(h){}_move(h,_,T){return{}}touchstart(h,_,T){this._firstTwoTouches||T.length<2||(this._firstTwoTouches=[T[0].identifier,T[1].identifier],this._start([_[0],_[1]]))}touchmove(h,_,T){const C=this._firstTwoTouches;if(!C)return;h.preventDefault();const[k,B]=C,F=os(T,_,k),V=os(T,_,B);if(!F||!V)return;const Z=this._aroundCenter?null:F.add(V).div(2);return this._move([F,V],Z,h)}touchend(h,_,T){if(!this._firstTwoTouches)return;const[C,k]=this._firstTwoTouches,B=os(T,_,C),F=os(T,_,k);B&&F||(this._active&&re(),this.reset())}touchcancel(){this.reset()}enable(h){this._enabled=!0,this._aroundCenter=!!h&&h.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function os(x,h,_){for(let T=0;T<x.length;T++)if(x[T].identifier===_)return h[T]}function Za(x,h){return Math.log(x/h)/Math.LN2}class dc extends Gs{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(h){this._startDistance=this._distance=h[0].dist(h[1])}_move(h,_){const T=this._distance;if(this._distance=h[0].dist(h[1]),this._active||!(Math.abs(Za(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Za(this._distance,T),pinchAround:_}}}function Xa(x,h){return 180*x.angleWith(h)/Math.PI}class qs extends Gs{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(h){this._startVector=this._vector=h[0].sub(h[1]),this._minDiameter=h[0].dist(h[1])}_move(h,_){const T=this._vector;if(this._vector=h[0].sub(h[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:Xa(this._vector,T),pinchAround:_}}_isBelowThreshold(h){this._minDiameter=Math.min(this._minDiameter,h.mag());const _=25/(Math.PI*this._minDiameter)*360,T=Xa(h,this._startVector);return Math.abs(T)<_}}function ss(x){return Math.abs(x.y)>Math.abs(x.x)}class Zs extends Gs{constructor(h){super(),this._map=h}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(h){this._lastPoints=h,ss(h[0].sub(h[1]))&&(this._valid=!1)}_move(h,_,T){const C=this._lastPoints;if(!C)return;const k=h[0].sub(C[0]),B=h[1].sub(C[1]);return this._map._cooperativeGestures&&T.touches.length<3||(this._valid=this.gestureBeginsVertically(k,B,T.timeStamp),!this._valid)?void 0:(this._lastPoints=h,this._active=!0,{pitchDelta:(k.y+B.y)/2*-.5})}gestureBeginsVertically(h,_,T){if(this._valid!==void 0)return this._valid;const C=h.mag()>=2,k=_.mag()>=2;if(!C&&!k)return;if(!C||!k)return this._firstMove==null&&(this._firstMove=T),T-this._firstMove<100&&void 0;const B=h.y>0==_.y>0;return ss(h)&&ss(_)&&B}}const fc={panStep:100,bearingStep:15,pitchStep:10};class pc{constructor(){const h=fc;this._panStep=h.panStep,this._bearingStep=h.bearingStep,this._pitchStep=h.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(h){if(h.altKey||h.ctrlKey||h.metaKey)return;let _=0,T=0,C=0,k=0,B=0;switch(h.keyCode){case 61:case 107:case 171:case 187:_=1;break;case 189:case 109:case 173:_=-1;break;case 37:h.shiftKey?T=-1:(h.preventDefault(),k=-1);break;case 39:h.shiftKey?T=1:(h.preventDefault(),k=1);break;case 38:h.shiftKey?C=1:(h.preventDefault(),B=-1);break;case 40:h.shiftKey?C=-1:(h.preventDefault(),B=1);break;default:return}return this._rotationDisabled&&(T=0,C=0),{cameraAnimation:F=>{const V=F.getZoom();F.easeTo({duration:300,easeId:"keyboardHandler",easing:mc,zoom:_?Math.round(V)+_*(h.shiftKey?2:1):V,bearing:F.getBearing()+T*this._bearingStep,pitch:F.getPitch()+C*this._pitchStep,offset:[-k*this._panStep,-B*this._panStep],center:F.getCenter()},{originalEvent:h})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function mc(x){return x*(2-x)}const Ya=4.000244140625;class gc{constructor(h,_){this._map=h,this._el=h.getCanvasContainer(),this._handler=_,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,u.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert","_isFullscreen"],this)}setZoomRate(h){this._defaultZoomRate=h}setWheelZoomRate(h){this._wheelZoomRate=h}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(h){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!h&&h.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(h){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(h.ctrlKey||h.metaKey||this.isZooming()||this._isFullscreen()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let _=h.deltaMode===u.window.WheelEvent.DOM_DELTA_LINE?40*h.deltaY:h.deltaY;const T=u.exported.now(),C=T-(this._lastWheelEventTime||0);this._lastWheelEventTime=T,_!==0&&_%Ya==0?this._type="wheel":_!==0&&Math.abs(_)<4?this._type="trackpad":C>400?(this._type=null,this._lastValue=_,this._timeout=setTimeout(this._onTimeout,40,h)):this._type||(this._type=Math.abs(C*_)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,_+=this._lastValue)),h.shiftKey&&_&&(_/=4),this._type&&(this._lastWheelEvent=h,this._delta-=_,this._active||this._start(h)),h.preventDefault()}_onTimeout(h){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(h)}_start(h){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const _=he(this._el,h);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:_,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const h=this._map.transform,_=()=>h._terrainEnabled()&&this._aroundCoord?h.computeZoomRelativeTo(this._aroundCoord):h.zoom;if(this._delta!==0){const V=this._type==="wheel"&&Math.abs(this._delta)>Ya?this._wheelZoomRate:this._defaultZoomRate;let Z=2/(1+Math.exp(-Math.abs(this._delta*V)));this._delta<0&&Z!==0&&(Z=1/Z);const X=_(),te=Math.pow(2,X),le=typeof this._targetZoom=="number"?h.zoomScale(this._targetZoom):te;this._targetZoom=Math.min(h.maxZoom,Math.max(h.minZoom,h.scaleZoom(le*Z))),this._type==="wheel"&&(this._startZoom=_(),this._easing=this._smoothOutEasing(200)),this._delta=0}const T=typeof this._targetZoom=="number"?this._targetZoom:_(),C=this._startZoom,k=this._easing;let B,F=!1;if(this._type==="wheel"&&C&&k){const V=Math.min((u.exported.now()-this._lastWheelEventTime)/200,1),Z=k(V);B=u.number(C,T,Z),V<1?this._frameId||(this._frameId=!0):F=!0}else B=T,F=!0;return this._active=!0,F&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!F,zoomDelta:B-_(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(h){let _=u.ease;if(this._prevEase){const T=this._prevEase,C=(u.exported.now()-T.start)/T.duration,k=T.easing(C+.01)-T.easing(C),B=.27/Math.sqrt(k*k+1e-4)*.01,F=Math.sqrt(.0729-B*B);_=u.bezier(B,F,.25,1)}return this._prevEase={start:u.exported.now(),duration:h,easing:_},_}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=$("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(u.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_isFullscreen(){return!!u.window.document.fullscreenElement||!!u.window.document.webkitFullscreenElement}_showBlockerAlert(){this._alertContainer.style.visibility==="hidden"&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show")},200)}}class _c{constructor(h,_){this._clickZoom=h,this._tapZoom=_}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class yc{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(h,_){return h.preventDefault(),{cameraAnimation:T=>{T.easeTo({duration:300,zoom:T.getZoom()+(h.shiftKey?-1:1),around:T.unproject(_)},{originalEvent:h})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wa{constructor(){this._tap=new vo({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(h,_,T){this._swipePoint||(this._tapTime&&h.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?T.length>0&&(this._swipePoint=_[0],this._swipeTouch=T[0].identifier):this._tap.touchstart(h,_,T))}touchmove(h,_,T){if(this._tapTime){if(this._swipePoint){if(T[0].identifier!==this._swipeTouch)return;const C=_[0],k=C.y-this._swipePoint.y;return this._swipePoint=C,h.preventDefault(),this._active=!0,{zoomDelta:k/128}}}else this._tap.touchmove(h,_,T)}touchend(h,_,T){this._tapTime?this._swipePoint&&T.length===0&&this.reset():this._tap.touchend(h,_,T)&&(this._tapTime=h.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class xc{constructor(h,_,T){this._el=h,this._mousePan=_,this._touchPan=T}enable(h){this._inertiaOptions=h||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class vc{constructor(h,_,T){this._pitchWithRotate=h.pitchWithRotate,this._mouseRotate=_,this._mousePitch=T}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class bc{constructor(h,_,T,C){this._el=h,this._touchZoom=_,this._touchRotate=T,this._tapDragZoom=C,this._rotationDisabled=!1,this._enabled=!0}enable(h){this._touchZoom.enable(h),this._rotationDisabled||this._touchRotate.enable(h),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const as=x=>x.zoom||x.drag||x.pitch||x.rotate;class Ha extends u.Event{}class wc{constructor(){this.constants=[1,1,.01],this.radius=0}setup(h,_){const T=u.sub([],_,h);this.radius=u.length(T[2]<0?u.div([],T,this.constants):[T[0],T[1],0])}projectRay(h){u.div(h,h,this.constants),u.normalize(h,h),u.mul$1(h,h,this.constants);const _=u.scale$2([],h,this.radius);if(_[2]>0){const T=u.scale$2([],[0,0,1],u.dot(_,[0,0,1])),C=u.scale$2([],u.normalize([],[_[0],_[1],0]),this.radius),k=u.add([],_,u.scale$2([],u.sub([],u.add([],C,T),_),2));_[0]=k[0],_[1]=k[1]}return _}}function wo(x){return x.panDelta&&x.panDelta.mag()||x.zoomDelta||x.bearingDelta||x.pitchDelta}class Ec{constructor(h,_){this._map=h,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new lc(h),this._bearingSnap=_.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new wc,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(_),u.bindAll(["handleEvent","handleWindowEvent"],this);const T=this._el;this._listeners=[[T,"touchstart",{passive:!0}],[T,"touchmove",{passive:!1}],[T,"touchend",void 0],[T,"touchcancel",void 0],[T,"mousedown",void 0],[T,"mousemove",void 0],[T,"mouseup",void 0],[u.window.document,"mousemove",{capture:!0}],[u.window.document,"mouseup",void 0],[T,"mouseover",void 0],[T,"mouseout",void 0],[T,"dblclick",void 0],[T,"click",void 0],[T,"keydown",{capture:!1}],[T,"keyup",void 0],[T,"wheel",{passive:!1}],[T,"contextmenu",void 0],[u.window,"blur",void 0]];for(const[C,k,B]of this._listeners)C.addEventListener(k,C===u.window.document?this.handleWindowEvent:this.handleEvent,B)}destroy(){for(const[h,_,T]of this._listeners)h.removeEventListener(_,h===u.window.document?this.handleWindowEvent:this.handleEvent,T)}_addDefaultHandlers(h){const _=this._map,T=_.getCanvasContainer();this._add("mapEvent",new xh(_,h));const C=_.boxZoom=new cc(_,h);this._add("boxZoom",C);const k=new Mt,B=new yc;_.doubleClickZoom=new _c(B,k),this._add("tapZoom",k),this._add("clickZoom",B);const F=new Wa;this._add("tapDragZoom",F);const V=_.touchPitch=new Zs(_);this._add("touchPitch",V);const Z=new bo(h),X=new qa(h);_.dragRotate=new vc(h,Z,X),this._add("mouseRotate",Z,["mousePitch"]),this._add("mousePitch",X,["mouseRotate"]);const te=new ns(h),le=new uc(_,h);_.dragPan=new xc(T,te,le),this._add("mousePan",te),this._add("touchPan",le,["touchZoom","touchRotate"]);const ge=new qs,de=new dc;_.touchZoomRotate=new bc(T,de,ge,F),this._add("touchRotate",ge,["touchPan","touchZoom"]),this._add("touchZoom",de,["touchPan","touchRotate"]),this._add("blockableMapEvent",new En(_));const se=_.scrollZoom=new gc(_,this);this._add("scrollZoom",se,["mousePan"]);const Se=_.keyboard=new pc;this._add("keyboard",Se);for(const xe of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])h.interactive&&h[xe]&&_[xe].enable(h[xe])}_add(h,_,T){this._handlers.push({handlerName:h,handler:_,allowed:T}),this._handlersById[h]=_}stop(h){if(!this._updatingCamera){for(const{handler:_}of this._handlers)_.reset();this._inertia.clear(),this._fireEvents({},{},h),this._changes=[]}}isActive(){for(const{handler:h}of this._handlers)if(h.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!as(this._eventsInProgress)||this.isZooming()}_blockedByActive(h,_,T){for(const C in h)if(C!==T&&(!_||_.indexOf(C)<0))return!0;return!1}handleWindowEvent(h){this.handleEvent(h,`${h.type}Window`)}_getMapTouches(h){const _=[];for(const T of h)this._el.contains(T.target)&&_.push(T);return _}handleEvent(h,_){this._updatingCamera=!0;const T=h.type==="renderFrame",C=T?void 0:h,k={needsRenderFrame:!1},B={},F={},V=h.touches?this._getMapTouches(h.touches):void 0,Z=V?_e(this._el,V):T?void 0:he(this._el,h);for(const{handlerName:le,handler:ge,allowed:de}of this._handlers){if(!ge.isEnabled())continue;let se;this._blockedByActive(F,de,le)?ge.reset():ge[_||h.type]&&(se=ge[_||h.type](h,Z,V),this.mergeHandlerResult(k,B,se,le,C),se&&se.needsRenderFrame&&this._triggerRenderFrame()),(se||ge.isActive())&&(F[le]=ge)}const X={};for(const le in this._previousActiveHandlers)F[le]||(X[le]=C);this._previousActiveHandlers=F,(Object.keys(X).length||wo(k))&&(this._changes.push([k,B,X]),this._triggerRenderFrame()),(Object.keys(F).length||wo(k))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:te}=k;te&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],te(this._map))}mergeHandlerResult(h,_,T,C,k){if(!T)return;u.extend(h,T);const B={handlerName:C,originalEvent:T.originalEvent||k};T.zoomDelta!==void 0&&(_.zoom=B),T.panDelta!==void 0&&(_.drag=B),T.pitchDelta!==void 0&&(_.pitch=B),T.bearingDelta!==void 0&&(_.rotate=B)}_applyChanges(){const h={},_={},T={};for(const[C,k,B]of this._changes)C.panDelta&&(h.panDelta=(h.panDelta||new u.pointGeometry(0,0))._add(C.panDelta)),C.zoomDelta&&(h.zoomDelta=(h.zoomDelta||0)+C.zoomDelta),C.bearingDelta&&(h.bearingDelta=(h.bearingDelta||0)+C.bearingDelta),C.pitchDelta&&(h.pitchDelta=(h.pitchDelta||0)+C.pitchDelta),C.around!==void 0&&(h.around=C.around),C.aroundCoord!==void 0&&(h.aroundCoord=C.aroundCoord),C.pinchAround!==void 0&&(h.pinchAround=C.pinchAround),C.noInertia&&(h.noInertia=C.noInertia),u.extend(_,k),u.extend(T,B);this._updateMapTransform(h,_,T),this._changes=[]}_updateMapTransform(h,_,T){const C=this._map,k=C.transform,B=Te=>[Te.x,Te.y,Te.z];if((Te=>{const Me=this._eventsInProgress.drag;return Me&&!this._handlersById[Me.handlerName].isActive()})()&&!wo(h)){const Te=k.zoom;k.cameraElevationReference="sea",k.recenterOnTerrain(),k.cameraElevationReference="ground",Te!==k.zoom&&this._map._update(!0)}if(!wo(h))return void this._fireEvents(_,T,!0);let{panDelta:F,zoomDelta:V,bearingDelta:Z,pitchDelta:X,around:te,aroundCoord:le,pinchAround:ge}=h;ge!==void 0&&(te=ge),(Te=>_.drag&&!this._eventsInProgress.drag)()&&te&&(this._dragOrigin=B(k.pointCoordinate3D(te)),this._trackingEllipsoid.setup(k._camera.position,this._dragOrigin)),k.cameraElevationReference="sea",C._stop(!0),te=te||C.transform.centerPoint,Z&&(k.bearing+=Z),X&&(k.pitch+=X),k._updateCameraState();const de=[0,0,0];if(F){const Te=k.pointCoordinate(te);if(k.projection.name==="globe"){const Me=u.latFromMercatorY(Te.y),Ae=k.center.lat,Ee=Math.min(u.mercatorZfromAltitude(1,Me)/u.mercatorZfromAltitude(1,Ae),2);F=F.rotate(-k.angle),de[0]=-F.x/k.worldSize*Ee,de[1]=-F.y/k.worldSize*Ee}else{const Me=k.pointCoordinate(te.sub(F));Te&&Me&&(de[0]=Me.x-Te.x,de[1]=Me.y-Te.y)}}const se=k.zoom,Se=[0,0,0];if(V){const Te=B(le||k.pointCoordinate3D(te)),Me={dir:u.normalize([],u.sub([],Te,k._camera.position))};if(Me.dir[2]<0){const Ae=k.zoomDeltaToMovement(Te,V);u.scale$2(Se,Me.dir,Ae)}}const xe=u.add(de,de,Se);k._translateCameraConstrained(xe),V&&Math.abs(k.zoom-se)>1e-4&&k.recenterOnTerrain(),k.cameraElevationReference="ground",this._map._update(),h.noInertia||this._inertia.record(h),this._fireEvents(_,T,!0)}_fireEvents(h,_,T){const C=as(this._eventsInProgress),k=as(h),B={};for(const X in h){const{originalEvent:te}=h[X];this._eventsInProgress[X]||(B[`${X}start`]=te),this._eventsInProgress[X]=h[X]}!C&&k&&this._fireEvent("movestart",k.originalEvent);for(const X in B)this._fireEvent(X,B[X]);k&&this._fireEvent("move",k.originalEvent);for(const X in h){const{originalEvent:te}=h[X];this._fireEvent(X,te)}const F={};let V;for(const X in this._eventsInProgress){const{handlerName:te,originalEvent:le}=this._eventsInProgress[X];this._handlersById[te].isActive()||(delete this._eventsInProgress[X],V=_[te]||le,F[`${X}end`]=V)}for(const X in F)this._fireEvent(X,F[X]);const Z=as(this._eventsInProgress);if(T&&(C||k)&&!Z){this._updatingCamera=!0;const X=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),te=le=>le!==0&&-this._bearingSnap<le&&le<this._bearingSnap;X?(te(X.bearing||this._map.getBearing())&&(X.bearing=0),this._map.easeTo(X,{originalEvent:V})):(this._map.fire(new u.Event("moveend",{originalEvent:V})),te(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(h,_){this._map.fire(new u.Event(h,_?{originalEvent:_}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(h=>{this._frameId=void 0,this.handleEvent(new Ha("renderFrame",{timeStamp:h})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Xs="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Ka extends u.Evented{constructor(h,_){super(),this._moving=!1,this._zooming=!1,this.transform=h,this._bearingSnap=_.bearingSnap,u.bindAll(["_renderFrameCallback"],this)}getCenter(){return new u.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(h,_){return this.jumpTo({center:h},_)}panBy(h,_,T){return h=u.pointGeometry.convert(h).mult(-1),this.panTo(this.transform.center,u.extend({offset:h},_),T)}panTo(h,_,T){return this.easeTo(u.extend({center:h},_),T)}getZoom(){return this.transform.zoom}setZoom(h,_){return this.jumpTo({zoom:h},_),this}zoomTo(h,_,T){return this.easeTo(u.extend({zoom:h},_),T)}zoomIn(h,_){return this.zoomTo(this.getZoom()+1,h,_),this}zoomOut(h,_){return this.zoomTo(this.getZoom()-1,h,_),this}getBearing(){return this.transform.bearing}setBearing(h,_){return this.jumpTo({bearing:h},_),this}getPadding(){return this.transform.padding}setPadding(h,_){return this.jumpTo({padding:h},_),this}rotateTo(h,_,T){return this.easeTo(u.extend({bearing:h},_),T)}resetNorth(h,_){return this.rotateTo(0,u.extend({duration:1e3},h),_),this}resetNorthPitch(h,_){return this.easeTo(u.extend({bearing:0,pitch:0,duration:1e3},h),_),this}snapToNorth(h,_){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(h,_):this}getPitch(){return this.transform.pitch}setPitch(h,_){return this.jumpTo({pitch:h},_),this}cameraForBounds(h,_){h=u.LngLatBounds.convert(h);const T=_&&_.bearing||0;return this._cameraForBoxAndBearing(h.getNorthWest(),h.getSouthEast(),T,_)}_extendCameraOptions(h){const _={top:0,bottom:0,right:0,left:0};if(typeof(h=u.extend({padding:_,offset:[0,0],maxZoom:this.transform.maxZoom},h)).padding=="number"){const T=h.padding;h.padding={top:T,bottom:T,right:T,left:T}}return h.padding=u.extend(_,h.padding),h}_cameraForBoxAndBearing(h,_,T,C){const k=this._extendCameraOptions(C),B=this.transform,F=B.padding,V=B.project(u.LngLat.convert(h)),Z=B.project(u.LngLat.convert(_)),X=new u.pointGeometry(V.x,Z.y),te=new u.pointGeometry(Z.x,V.y),le=-u.degToRad(T),ge=V.rotate(le),de=Z.rotate(le),se=X.rotate(le),Se=te.rotate(le),xe=new u.pointGeometry(Math.max(ge.x,de.x,se.x,Se.x),Math.max(ge.y,de.y,se.y,Se.y)),Te=new u.pointGeometry(Math.min(ge.x,de.x,se.x,Se.x),Math.min(ge.y,de.y,se.y,Se.y)),Me=xe.sub(Te),Ae=(B.width-((F.left||0)+(F.right||0)+k.padding.left+k.padding.right))/Me.x,Ee=(B.height-((F.top||0)+(F.bottom||0)+k.padding.top+k.padding.bottom))/Me.y;if(Ee<0||Ae<0)return void u.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const De=Math.min(B.scaleZoom(B.scale*Math.min(Ae,Ee)),k.maxZoom),Ue=typeof k.offset.x=="number"&&typeof k.offset.y=="number"?new u.pointGeometry(k.offset.x,k.offset.y):u.pointGeometry.convert(k.offset),Ze=new u.pointGeometry((k.padding.left-k.padding.right)/2,(k.padding.top-k.padding.bottom)/2).rotate(T*Math.PI/180),He=Ue.add(Ze).mult(B.scale/B.zoomScale(De));return{center:B.unproject(V.add(Z).div(2).sub(He)),zoom:De,bearing:T}}_cameraForBox(h,_,T,C,k){const B=this._extendCameraOptions(k);T=T||0,C=C||0,h=u.LngLat.convert(h),_=u.LngLat.convert(_);const F=this.transform.clone();F.padding=B.padding;const V=this.getFreeCameraOptions(),Z=new u.LngLat(.5*(h.lng+_.lng),.5*(h.lat+_.lat)),X=.5*(T+C);if(F._camera.position[2]<u.mercatorZfromAltitude(X,Z.lat))return void u.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");V.lookAtPoint(Z),F.setFreeCameraOptions(V);const te=u.MercatorCoordinate.fromLngLat(h),le=u.MercatorCoordinate.fromLngLat(_),ge=F.pointRayIntersection(F.centerPoint,X),de=[(se=F.rayIntersectionCoordinate(ge)).x,se.y,se.z];var se;const Se=F.screenPointToMercatorRay(F.centerPoint),xe=F.projection.name!=="globe";let Te,Me=0;do{const Ae=Math.floor(F.zoom),Ee=1<<Ae,De=Math.min(Ee*te.x,Ee*le.x),Ue=Math.min(Ee*te.y,Ee*le.y),Ze=Math.max(Ee*te.x,Ee*le.x),He=Math.max(Ee*te.y,Ee*le.y),Ye=new u.Aabb([De,Ue,T],[Ze,He,C]),ct=u.Frustum.fromInvProjectionMatrix(F.invProjMatrix,F.worldSize,Ae,xe);if(Ye.intersects(ct)!==2){Te&&(F._camera.position=u.scaleAndAdd([],F._camera.position,Se.dir,-Te),F._updateStateFromCamera());break}const Ve=u.sub([],F._camera.position,de);Te=.5*u.length(Ve),F._camera.position=u.scaleAndAdd([],F._camera.position,Se.dir,Te);try{F._updateStateFromCamera()}catch{return void u.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}}while(++Me<10);return{center:F.center,zoom:F.zoom,bearing:F.bearing,pitch:F.pitch}}fitBounds(h,_,T){return this._fitInternal(this.cameraForBounds(h,_),_,T)}_raycastElevationBox(h,_){const T=this.transform.elevation;if(!T)return;const C=new u.pointGeometry(h.x,_.y),k=new u.pointGeometry(_.x,h.y),B=T.pointCoordinate(h);if(!B)return;const F=T.pointCoordinate(_);if(!F)return;const V=T.pointCoordinate(C);if(!V)return;const Z=T.pointCoordinate(k);if(!Z)return;const X=new u.MercatorCoordinate(B[0],B[1]).toLngLat(),te=new u.MercatorCoordinate(F[0],F[1]).toLngLat(),le=new u.MercatorCoordinate(V[0],V[1]).toLngLat(),ge=new u.MercatorCoordinate(Z[0],Z[1]).toLngLat(),de=Math.min(X.lng,Math.min(te.lng,Math.min(le.lng,ge.lng))),se=Math.min(X.lat,Math.min(te.lat,Math.min(le.lat,ge.lat))),Se=Math.max(X.lng,Math.max(te.lng,Math.max(le.lng,ge.lng))),xe=Math.max(X.lat,Math.max(te.lat,Math.max(le.lat,ge.lat))),Te=Math.min(B[3],Math.min(F[3],Math.min(V[3],Z[3]))),Me=Math.max(B[3],Math.max(F[3],Math.max(V[3],Z[3])));return{minLngLat:new u.LngLat(de,se),maxLngLat:new u.LngLat(Se,xe),minAltitude:Te,maxAltitude:Me}}fitScreenCoordinates(h,_,T,C,k){let B,F,V,Z;const X=u.pointGeometry.convert(h),te=u.pointGeometry.convert(_),le=this._raycastElevationBox(X,te);if(le)B=le.minLngLat,F=le.maxLngLat,V=le.minAltitude,Z=le.maxAltitude;else{if(this.transform.anyCornerOffEdge(X,te))return this;B=this.transform.pointLocation(X),F=this.transform.pointLocation(te)}return this._fitInternal(this.transform.pitch===0?this._cameraForBoxAndBearing(this.transform.pointLocation(u.pointGeometry.convert(h)),this.transform.pointLocation(u.pointGeometry.convert(_)),T,C):this._cameraForBox(B,F,V,Z,C),C,k)}_fitInternal(h,_,T){return h?(delete(_=u.extend(h,_)).padding,_.linear?this.easeTo(_,T):this.flyTo(_,T)):this}jumpTo(h,_){this.stop();const T=h.preloadOnly?this.transform.clone():this.transform;let C=!1,k=!1,B=!1;return"zoom"in h&&T.zoom!==+h.zoom&&(C=!0,T.zoom=+h.zoom),h.center!==void 0&&(T.center=u.LngLat.convert(h.center)),"bearing"in h&&T.bearing!==+h.bearing&&(k=!0,T.bearing=+h.bearing),"pitch"in h&&T.pitch!==+h.pitch&&(B=!0,T.pitch=+h.pitch),h.padding==null||T.isPaddingEqual(h.padding)||(T.padding=h.padding),h.preloadOnly?(this._preloadTiles(T),this):(this.fire(new u.Event("movestart",_)).fire(new u.Event("move",_)),C&&this.fire(new u.Event("zoomstart",_)).fire(new u.Event("zoom",_)).fire(new u.Event("zoomend",_)),k&&this.fire(new u.Event("rotatestart",_)).fire(new u.Event("rotate",_)).fire(new u.Event("rotateend",_)),B&&this.fire(new u.Event("pitchstart",_)).fire(new u.Event("pitch",_)).fire(new u.Event("pitchend",_)),this.fire(new u.Event("moveend",_)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||u.warnOnce(Xs),this.transform.getFreeCameraOptions()}setFreeCameraOptions(h,_){const T=this.transform;if(!T.projection.supportsFreeCamera)return u.warnOnce(Xs),this;this.stop();const C=T.zoom,k=T.pitch,B=T.bearing;T.setFreeCameraOptions(h);const F=C!==T.zoom,V=k!==T.pitch,Z=B!==T.bearing;return this.fire(new u.Event("movestart",_)).fire(new u.Event("move",_)),F&&this.fire(new u.Event("zoomstart",_)).fire(new u.Event("zoom",_)).fire(new u.Event("zoomend",_)),Z&&this.fire(new u.Event("rotatestart",_)).fire(new u.Event("rotate",_)).fire(new u.Event("rotateend",_)),V&&this.fire(new u.Event("pitchstart",_)).fire(new u.Event("pitch",_)).fire(new u.Event("pitchend",_)),this.fire(new u.Event("moveend",_)),this}easeTo(h,_){this._stop(!1,h.easeId),((h=u.extend({offset:[0,0],duration:500,easing:u.ease},h)).animate===!1||!h.essential&&u.exported.prefersReducedMotion)&&(h.duration=0);const T=this.transform,C=this.getZoom(),k=this.getBearing(),B=this.getPitch(),F=this.getPadding(),V="zoom"in h?+h.zoom:C,Z="bearing"in h?this._normalizeBearing(h.bearing,k):k,X="pitch"in h?+h.pitch:B,te="padding"in h?h.padding:T.padding,le=u.pointGeometry.convert(h.offset);let ge,de,se;if(T.projection.name==="globe"){const He=u.MercatorCoordinate.fromLngLat(T.center),Ye=le.rotate(-T.angle);He.x+=Ye.x/T.worldSize,He.y+=Ye.y/T.worldSize;const ct=He.toLngLat(),Ve=u.LngLat.convert(h.center||ct);this._normalizeCenter(Ve),ge=T.centerPoint.add(Ye),de=new u.pointGeometry(He.x,He.y).mult(T.worldSize),se=new u.pointGeometry(u.mercatorXfromLng(Ve.lng),u.mercatorYfromLat(Ve.lat)).mult(T.worldSize).sub(de)}else{ge=T.centerPoint.add(le);const He=T.pointLocation(ge),Ye=u.LngLat.convert(h.center||He);this._normalizeCenter(Ye),de=T.project(He),se=T.project(Ye).sub(de)}const Se=T.zoomScale(V-C);let xe,Te;h.around&&(xe=u.LngLat.convert(h.around),Te=T.locationPoint(xe));const Me=this._zooming||V!==C,Ae=this._rotating||k!==Z,Ee=this._pitching||X!==B,De=!T.isPaddingEqual(te),Ue=He=>Ye=>{if(Me&&(He.zoom=u.number(C,V,Ye)),Ae&&(He.bearing=u.number(k,Z,Ye)),Ee&&(He.pitch=u.number(B,X,Ye)),De&&(He.interpolatePadding(F,te,Ye),ge=He.centerPoint.add(le)),xe)He.setLocationAtPoint(xe,Te);else{const ct=He.zoomScale(He.zoom-C),Ve=V>C?Math.min(2,Se):Math.max(.5,Se),ht=Math.pow(Ve,1-Ye),at=He.unproject(de.add(se.mult(Ye*ht)).mult(ct));He.setLocationAtPoint(He.renderWorldCopies?at.wrap():at,ge)}return h.preloadOnly||this._fireMoveEvents(_),He};if(h.preloadOnly){const He=this._emulate(Ue,h.duration,T);return this._preloadTiles(He),this}const Ze={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Me,this._rotating=Ae,this._pitching=Ee,this._padding=De,this._easeId=h.easeId,this._prepareEase(_,h.noMoveStart,Ze),this._ease(Ue(T),He=>{T.recenterOnTerrain(),this._afterEase(_,He)},h),this}_prepareEase(h,_,T={}){this._moving=!0,this.transform.cameraElevationReference="sea",_||T.moving||this.fire(new u.Event("movestart",h)),this._zooming&&!T.zooming&&this.fire(new u.Event("zoomstart",h)),this._rotating&&!T.rotating&&this.fire(new u.Event("rotatestart",h)),this._pitching&&!T.pitching&&this.fire(new u.Event("pitchstart",h))}_fireMoveEvents(h){this.fire(new u.Event("move",h)),this._zooming&&this.fire(new u.Event("zoom",h)),this._rotating&&this.fire(new u.Event("rotate",h)),this._pitching&&this.fire(new u.Event("pitch",h))}_afterEase(h,_){if(this._easeId&&_&&this._easeId===_)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const T=this._zooming,C=this._rotating,k=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,T&&this.fire(new u.Event("zoomend",h)),C&&this.fire(new u.Event("rotateend",h)),k&&this.fire(new u.Event("pitchend",h)),this.fire(new u.Event("moveend",h))}flyTo(h,_){if(!h.essential&&u.exported.prefersReducedMotion){const It=u.pick(h,["center","zoom","bearing","pitch","around"]);return this.jumpTo(It,_)}this.stop(),h=u.extend({offset:[0,0],speed:1.2,curve:1.42,easing:u.ease},h);const T=this.transform,C=this.getZoom(),k=this.getBearing(),B=this.getPitch(),F=this.getPadding(),V="zoom"in h?u.clamp(+h.zoom,T.minZoom,T.maxZoom):C,Z="bearing"in h?this._normalizeBearing(h.bearing,k):k,X="pitch"in h?+h.pitch:B,te="padding"in h?h.padding:T.padding,le=T.zoomScale(V-C),ge=u.pointGeometry.convert(h.offset);let de=T.centerPoint.add(ge);const se=T.pointLocation(de),Se=u.LngLat.convert(h.center||se);this._normalizeCenter(Se);const xe=T.project(se),Te=T.project(Se).sub(xe);let Me=h.curve;const Ae=Math.max(T.width,T.height),Ee=Ae/le,De=Te.mag();if("minZoom"in h){const It=u.clamp(Math.min(h.minZoom,C,V),T.minZoom,T.maxZoom),Ct=Ae/T.zoomScale(It-C);Me=Math.sqrt(Ct/De*2)}const Ue=Me*Me;function Ze(It){const Ct=(Ee*Ee-Ae*Ae+(It?-1:1)*Ue*Ue*De*De)/(2*(It?Ee:Ae)*Ue*De);return Math.log(Math.sqrt(Ct*Ct+1)-Ct)}function He(It){return(Math.exp(It)-Math.exp(-It))/2}function Ye(It){return(Math.exp(It)+Math.exp(-It))/2}const ct=Ze(0);let Ve=function(It){return Ye(ct)/Ye(ct+Me*It)},ht=function(It){return Ae*((Ye(ct)*(He(Ct=ct+Me*It)/Ye(Ct))-He(ct))/Ue)/De;var Ct},at=(Ze(1)-ct)/Me;if(Math.abs(De)<1e-6||!isFinite(at)){if(Math.abs(Ae-Ee)<1e-6)return this.easeTo(h,_);const It=Ee<Ae?-1:1;at=Math.abs(Math.log(Ee/Ae))/Me,ht=function(){return 0},Ve=function(Ct){return Math.exp(It*Me*Ct)}}h.duration="duration"in h?+h.duration:1e3*at/("screenSpeed"in h?+h.screenSpeed/Me:+h.speed),h.maxDuration&&h.duration>h.maxDuration&&(h.duration=0);const Dt=k!==Z,Je=X!==B,At=!T.isPaddingEqual(te),qt=It=>Ct=>{const Kt=Ct*at,mi=1/Ve(Kt);It.zoom=Ct===1?V:C+It.scaleZoom(mi),Dt&&(It.bearing=u.number(k,Z,Ct)),Je&&(It.pitch=u.number(B,X,Ct)),At&&(It.interpolatePadding(F,te,Ct),de=It.centerPoint.add(ge));const jt=Ct===1?Se:It.unproject(xe.add(Te.mult(ht(Kt))).mult(mi));return It.setLocationAtPoint(It.renderWorldCopies?jt.wrap():jt,de),It._updateCameraOnTerrain(),h.preloadOnly||this._fireMoveEvents(_),It};if(h.preloadOnly){const It=this._emulate(qt,h.duration,T);return this._preloadTiles(It),this}return this._zooming=!0,this._rotating=Dt,this._pitching=Je,this._padding=At,this._prepareEase(_,!1),this._ease(qt(T),()=>this._afterEase(_),h),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(h,_){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const T=this._onEaseEnd;this._onEaseEnd=void 0,T.call(this,_)}if(!h){const T=this.handlers;T&&T.stop(!1)}return this}_ease(h,_,T){T.animate===!1||T.duration===0?(h(1),_()):(this._easeStart=u.exported.now(),this._easeOptions=T,this._onEaseFrame=h,this._onEaseEnd=_,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const h=Math.min((u.exported.now()-this._easeStart)/this._easeOptions.duration,1),_=this._onEaseFrame;_&&_(this._easeOptions.easing(h)),h<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(h,_){h=u.wrap(h,-180,180);const T=Math.abs(h-_);return Math.abs(h-360-_)<T&&(h-=360),Math.abs(h+360-_)<T&&(h+=360),h}_normalizeCenter(h){const _=this.transform;if(!_.renderWorldCopies||_.maxBounds)return;const T=h.lng-_.center.lng;h.lng+=T>180?-360:T<-180?360:0}_emulate(h,_,T){const C=Math.ceil(15*_/1e3),k=[],B=h(T.clone());for(let F=0;F<=C;F++){const V=B(F/C);k.push(V.clone())}return k}}class Ys{constructor(h={}){this.options=h,u.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(h){const _=this.options&&this.options.compact;return this._map=h,this._container=$("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=$("button","mapboxgl-ctrl-attrib-button",this._container),$("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=$("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),_&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),_===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(h,_){const T=this._map._getUIString(`AttributionControl.${_}`);h.setAttribute("aria-label",T),h.removeAttribute("title"),h.firstElementChild&&h.firstElementChild.setAttribute("title",T)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let h=this._editLink;h||(h=this._editLink=this._container.querySelector(".mapbox-improve-map"));const _=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||u.config.ACCESS_TOKEN}];if(h){const T=_.reduce((C,k,B)=>(k.value&&(C+=`${k.key}=${k.value}${B<_.length-1?"&":""}`),C),"?");h.href=`${u.config.FEEDBACK_URL}/${T}${this._map._hash?this._map._hash.getHashString(!0):""}`,h.rel="noopener nofollow",this._setElementTitle(h,"MapFeedback")}}_updateData(h){!h||h.sourceDataType!=="metadata"&&h.sourceDataType!=="visibility"&&h.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let h=[];if(this._map.style.stylesheet){const C=this._map.style.stylesheet;this.styleOwner=C.owner,this.styleId=C.id}const _=this._map.style._sourceCaches;for(const C in _){const k=_[C];if(k.used){const B=k.getSource();B.attribution&&h.indexOf(B.attribution)<0&&h.push(B.attribution)}}h.sort((C,k)=>C.length-k.length),h=h.filter((C,k)=>{for(let B=k+1;B<h.length;B++)if(h[B].indexOf(C)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?h=[...this.options.customAttribution,...h]:h.unshift(this.options.customAttribution));const T=h.join(" | ");T!==this._attribHTML&&(this._attribHTML=T,h.length?(this._innerContainer.innerHTML=T,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Tc{constructor(){u.bindAll(["_updateLogo","_updateCompact"],this)}onAdd(h){this._map=h,this._container=$("div","mapboxgl-ctrl");const _=$("a","mapboxgl-ctrl-logo");return _.target="_blank",_.rel="noopener nofollow",_.href="https://www.mapbox.com/",_.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),_.setAttribute("rel","noopener nofollow"),this._container.appendChild(_),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(h){h&&h.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const h=this._map.style._sourceCaches;if(Object.entries(h).length===0)return!0;for(const _ in h){const T=h[_].getSource();if(T.hasOwnProperty("mapbox_logo")&&!T.mapbox_logo)return!1}return!0}_updateCompact(){const h=this._container.children;if(h.length){const _=h[0];this._map.getCanvasContainer().offsetWidth<250?_.classList.add("mapboxgl-compact"):_.classList.remove("mapboxgl-compact")}}}class Mc{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(h){const _=++this._id;return this._queue.push({callback:h,id:_,cancelled:!1}),_}remove(h){const _=this._currentlyRunning,T=_?this._queue.concat(_):this._queue;for(const C of T)if(C.id===h)return void(C.cancelled=!0)}run(h=0){const _=this._currentlyRunning=this._queue;this._queue=[];for(const T of _)if(!T.cancelled&&(T.callback(h),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Ws(x,h,_){if(x=new u.LngLat(x.lng,x.lat),h){const T=new u.LngLat(x.lng-360,x.lat),C=new u.LngLat(x.lng+360,x.lat),k=360*Math.ceil(Math.abs(x.lng-_.center.lng)/360),B=_.locationPoint(x).distSqr(h),F=h.x<0||h.y<0||h.x>_.width||h.y>_.height;_.locationPoint(T).distSqr(h)<B&&(F||Math.abs(T.lng-_.center.lng)<k)?x=T:_.locationPoint(C).distSqr(h)<B&&(F||Math.abs(C.lng-_.center.lng)<k)&&(x=C)}for(;Math.abs(x.lng-_.center.lng)>180;){const T=_.locationPoint(x);if(T.x>=0&&T.y>=0&&T.x<=_.width&&T.y<=_.height)break;x.lng>_.center.lng?x.lng-=360:x.lng+=360}return x}const Hs={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Ks extends u.Evented{constructor(h,_){if(super(),(h instanceof u.window.HTMLElement||_)&&(h=u.extend({element:h},_)),u.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=h&&h.anchor||"center",this._color=h&&h.color||"#3FB1CE",this._scale=h&&h.scale||1,this._draggable=h&&h.draggable||!1,this._clickTolerance=h&&h.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=h&&h.rotation||0,this._rotationAlignment=h&&h.rotationAlignment||"auto",this._pitchAlignment=h&&h.pitchAlignment&&h.pitchAlignment!=="auto"?h.pitchAlignment:this._rotationAlignment,this._updateMoving=()=>this._update(!0),h&&h.element)this._element=h.element,this._offset=u.pointGeometry.convert(h&&h.offset||[0,0]);else{this._defaultMarker=!0,this._element=$("div");const C=41,k=27,B=O("svg",{display:"block",height:C*this._scale+"px",width:k*this._scale+"px",viewBox:`0 0 ${k} ${C}`},this._element),F=O("radialGradient",{id:"shadowGradient"},O("defs",{},B));O("stop",{offset:"10%","stop-opacity":.4},F),O("stop",{offset:"100%","stop-opacity":.05},F),O("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},B),O("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},B),O("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},B),O("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},B),this._offset=u.pointGeometry.convert(h&&h.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",C=>{C.preventDefault()}),this._element.addEventListener("mousedown",C=>{C.preventDefault()});const T=this._element.classList;for(const C in Hs)T.remove(`mapboxgl-marker-anchor-${C}`);T.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(h){return h===this._map||(this.remove(),this._map=h,h.getCanvasContainer().appendChild(this._element),h.on("move",this._updateMoving),h.on("moveend",this._update),h.on("remove",this._clearFadeTimer),h._addMarker(this),this.setDraggable(this._draggable),this._update(),h.on("click",this._onMapClick)),this}remove(){const h=this._map;return h&&(h.off("click",this._onMapClick),h.off("move",this._updateMoving),h.off("moveend",this._update),h.off("mousedown",this._addDragHandler),h.off("touchstart",this._addDragHandler),h.off("mouseup",this._onUp),h.off("touchend",this._onUp),h.off("mousemove",this._onMove),h.off("touchmove",this._onMove),h.off("remove",this._clearFadeTimer),h._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(h){return this._lngLat=u.LngLat.convert(h),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(h){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),h){if(!("offset"in h.options)){const C=Math.sqrt(Math.pow(13.5,2)/2);h.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[C,-1*(38.1-13.5+C)],"bottom-right":[-C,-1*(38.1-13.5+C)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=h,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(h){const _=h.code,T=h.charCode||h.keyCode;_!=="Space"&&_!=="Enter"&&T!==32&&T!==13||this.togglePopup()}_onMapClick(h){const _=h.originalEvent.target,T=this._element;this._popup&&(_===T||T.contains(_))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const h=this._popup;return h?(h.isOpen()?(h.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(h.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_evaluateOpacity(){const h=this._map;if(!h)return;const _=this._pos;if(!_||_.x<0||_.x>h.transform.width||_.y<0||_.y>h.transform.height)return void this._clearFadeTimer();const T=h.unproject(_);let C=!1;if(h.transform._terrainEnabled()&&h.getTerrain()){const B=h.getFreeCameraOptions();if(B.position){const F=B.position.toLngLat();C=F.distanceTo(T)<.9*F.distanceTo(this._lngLat)}}const k=(1-h._queryFogOpacity(T))*(C?.2:1);this._element.style.opacity=`${k}`,this._popup&&this._popup._setOpacity(`${k}`),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const h=this._pos;if(!h)return;const _=this._offset.mult(this._scale),T=this._calculatePitch(),C=this._calculateRotation();this._element.style.transform=`
            translate(${h.x}px, ${h.y}px) ${Hs[this._anchor]}
            rotateX(${T}deg) rotateZ(${C}deg)
            translate(${_.x}px, ${_.y}px)
        `}_calculatePitch(){return this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?0:this._map&&this._pitchAlignment==="map"?this._map.getPitch():0}_calculateRotation(){return this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?this._rotation:this._map&&this._rotationAlignment==="map"?this._rotation-this._map.getBearing():0}_update(h){u.window.cancelAnimationFrame(this._updateFrameId);const _=this._map;_&&(_.transform.renderWorldCopies&&(this._lngLat=Ws(this._lngLat,this._pos,_.transform)),this._pos=_.project(this._lngLat),h===!0?this._updateFrameId=u.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),_._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),!_.getTerrain()&&!_.getFog()||this._fadeTimer||(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(h){return this._offset=u.pointGeometry.convert(h),this._update(),this}_onMove(h){const _=this._map;if(_){if(!this._isDragging){const T=this._clickTolerance||_._clickTolerance;this._isDragging=h.point.dist(this._pointerdownPos)>=T}this._isDragging&&(this._pos=h.point.sub(this._positionDelta),this._lngLat=_.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new u.Event("dragstart"))),this.fire(new u.Event("drag")))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const h=this._map;h&&(h.off("mousemove",this._onMove),h.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new u.Event("dragend")),this._state="inactive"}_addDragHandler(h){const _=this._map;_&&this._element.contains(h.originalEvent.target)&&(h.preventDefault(),this._positionDelta=h.point.sub(this._pos),this._pointerdownPos=h.point,this._state="pending",_.on("mousemove",this._onMove),_.on("touchmove",this._onMove),_.once("mouseup",this._onUp),_.once("touchend",this._onUp))}setDraggable(h){this._draggable=!!h;const _=this._map;return _&&(h?(_.on("mousedown",this._addDragHandler),_.on("touchstart",this._addDragHandler)):(_.off("mousedown",this._addDragHandler),_.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(h){return this._rotation=h||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(h){return this._rotationAlignment=h||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(h){return this._pitchAlignment=h&&h!=="auto"?h:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}}class vh{constructor(h){this.jumpTo(h)}getValue(h){if(h<=this._startTime)return this._start;if(h>=this._endTime)return this._end;const _=u.easeCubicInOut((h-this._startTime)/(this._endTime-this._startTime));return this._start*(1-_)+this._end*_}isEasing(h){return h>=this._startTime&&h<=this._endTime}jumpTo(h){this._startTime=-1/0,this._endTime=-1/0,this._start=h,this._end=h}easeTo(h,_,T){this._start=this.getValue(_),this._end=h,this._startTime=_,this._endTime=_+T}}const bh={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},Ja={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function ls(x){x.parentNode&&x.parentNode.removeChild(x)}const Qa={showCompass:!0,showZoom:!0,visualizePitch:!1};class el{constructor(h,_,T=!1){this._clickTolerance=10,this.element=_,this.mouseRotate=new bo({clickTolerance:h.dragRotate._mouseRotate._clickTolerance}),this.map=h,T&&(this.mousePitch=new qa({clickTolerance:h.dragRotate._mousePitch._clickTolerance})),u.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),_.addEventListener("mousedown",this.mousedown),_.addEventListener("touchstart",this.touchstart,{passive:!1}),_.addEventListener("touchmove",this.touchmove),_.addEventListener("touchend",this.touchend),_.addEventListener("touchcancel",this.reset)}down(h,_){this.mouseRotate.mousedown(h,_),this.mousePitch&&this.mousePitch.mousedown(h,_),Y()}move(h,_){const T=this.map,C=this.mouseRotate.mousemoveWindow(h,_),k=C&&C.bearingDelta;if(k&&T.setBearing(T.getBearing()+k),this.mousePitch){const B=this.mousePitch.mousemoveWindow(h,_),F=B&&B.pitchDelta;F&&T.setPitch(T.getPitch()+F)}}off(){const h=this.element;h.removeEventListener("mousedown",this.mousedown),h.removeEventListener("touchstart",this.touchstart,{passive:!1}),h.removeEventListener("touchmove",this.touchmove),h.removeEventListener("touchend",this.touchend),h.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){fe(),u.window.removeEventListener("mousemove",this.mousemove),u.window.removeEventListener("mouseup",this.mouseup)}mousedown(h){this.down(u.extend({},h,{ctrlKey:!0,preventDefault:()=>h.preventDefault()}),he(this.element,h)),u.window.addEventListener("mousemove",this.mousemove),u.window.addEventListener("mouseup",this.mouseup)}mousemove(h){this.move(h,he(this.element,h))}mouseup(h){this.mouseRotate.mouseupWindow(h),this.mousePitch&&this.mousePitch.mouseupWindow(h),this.offTemp()}touchstart(h){h.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=_e(this.element,h.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>h.preventDefault()},this._startPos))}touchmove(h){h.targetTouches.length!==1?this.reset():(this._lastPos=_e(this.element,h.targetTouches)[0],this.move({preventDefault:()=>h.preventDefault()},this._lastPos))}touchend(h){h.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const Cr={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1};let Ur,cs=0,eo=!1;const tl={maxWidth:100,unit:"metric"};function Js(x,h,_){const T=_&&_.maxWidth||100,C=x._containerHeight/2,k=x._containerWidth/2-T/2,B=x.unproject([k,C]),F=x.unproject([k+T,C]),V=B.distanceTo(F);if(_&&_.unit==="imperial"){const Z=3.2808*V;Z>5280?Eo(h,T,Z/5280,x._getUIString("ScaleControl.Miles"),x):Eo(h,T,Z,x._getUIString("ScaleControl.Feet"),x)}else _&&_.unit==="nautical"?Eo(h,T,V/1852,x._getUIString("ScaleControl.NauticalMiles"),x):V>=1e3?Eo(h,T,V/1e3,x._getUIString("ScaleControl.Kilometers"),x):Eo(h,T,V,x._getUIString("ScaleControl.Meters"),x)}function Eo(x,h,_,T,C){const k=function(F){const V=Math.pow(10,`${Math.floor(F)}`.length-1);let Z=F/V;return Z=Z>=10?10:Z>=5?5:Z>=3?3:Z>=2?2:Z>=1?1:function(X){const te=Math.pow(10,Math.ceil(-Math.log(X)/Math.LN10));return Math.round(X*te)/te}(Z),V*Z}(_),B=k/_;C._requestDomTask(()=>{x.style.width=h*B+"px",x.innerHTML=`${k}&nbsp;${T}`})}const Hr={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},ji=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function hs(x=new u.pointGeometry(0,0),h="bottom"){if(typeof x=="number"){const _=Math.round(Math.sqrt(.5*Math.pow(x,2)));switch(h){case"top":return new u.pointGeometry(0,x);case"top-left":return new u.pointGeometry(_,_);case"top-right":return new u.pointGeometry(-_,_);case"bottom":return new u.pointGeometry(0,-x);case"bottom-left":return new u.pointGeometry(_,-_);case"bottom-right":return new u.pointGeometry(-_,-_);case"left":return new u.pointGeometry(x,0);case"right":return new u.pointGeometry(-x,0)}return new u.pointGeometry(0,0)}return x instanceof u.pointGeometry||Array.isArray(x)?u.pointGeometry.convert(x):u.pointGeometry.convert(x[h]||[0,0])}const To={version:u.version,supported:A,setRTLTextPlugin:u.setRTLTextPlugin,getRTLTextPluginStatus:u.getRTLTextPluginStatus,Map:class extends Ka{constructor(x){if((x=u.extend({},Ja,x)).minZoom!=null&&x.maxZoom!=null&&x.minZoom>x.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(x.minPitch!=null&&x.maxPitch!=null&&x.minPitch>x.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(x.minPitch!=null&&x.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(x.maxPitch!=null&&x.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(x.antialias&&u.isSafariWithAntialiasingBug(u.window)&&(x.antialias=!1,u.warnOnce("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Vs(x.minZoom,x.maxZoom,x.minPitch,x.maxPitch,x.renderWorldCopies),x),this._interactive=x.interactive,this._minTileCacheSize=x.minTileCacheSize,this._maxTileCacheSize=x.maxTileCacheSize,this._failIfMajorPerformanceCaveat=x.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=x.preserveDrawingBuffer,this._antialias=x.antialias,this._trackResize=x.trackResize,this._bearingSnap=x.bearingSnap,this._refreshExpiredTiles=x.refreshExpiredTiles,this._fadeDuration=x.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=x.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=x.collectResourceTiming,this._optimizeForTerrain=x.optimizeForTerrain,this._renderTaskQueue=new Mc,this._domRenderTaskQueue=new Mc,this._controls=[],this._markers=[],this._mapId=u.uniqueId(),this._locale=u.extend({},bh,x.locale),this._clickTolerance=x.clickTolerance,this._cooperativeGestures=x.cooperativeGestures,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new vh(0),this._explicitProjection=null,this._requestManager=new u.RequestManager(x.transformRequest,x.accessToken,x.testMode),this._silenceAuthErrors=!!x.testMode,typeof x.container=="string"){if(this._container=u.window.document.getElementById(x.container),!this._container)throw new Error(`Container '${x.container}' not found.`)}else{if(!(x.container instanceof u.window.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=x.container}if(this._container.childNodes.length>0&&u.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),x.maxBounds&&this.setMaxBounds(x.maxBounds),u.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),u.window!==void 0&&(u.window.addEventListener("online",this._onWindowOnline,!1),u.window.addEventListener("resize",this._onWindowResize,!1),u.window.addEventListener("orientationchange",this._onWindowResize,!1),u.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new Ec(this,x),this._localFontFamily=x.localFontFamily,this._localIdeographFontFamily=x.localIdeographFontFamily,x.style&&this.setStyle(x.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),x.projection&&this.setProjection(x.projection),this._hash=x.hash&&new rc(typeof x.hash=="string"&&x.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:x.center,zoom:x.zoom,bearing:x.bearing,pitch:x.pitch}),x.bounds&&(this.resize(),this.fitBounds(x.bounds,u.extend({},x.fitBoundsOptions,{duration:0})))),this.resize(),x.attributionControl&&this.addControl(new Ys({customAttribution:x.customAttribution})),this._logoControl=new Tc,this.addControl(this._logoControl,x.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",h=>{this._update(h.dataType==="style"),this.fire(new u.Event(`${h.dataType}data`,h))}),this.on("dataloading",h=>{this.fire(new u.Event(`${h.dataType}dataloading`,h))})}_getMapId(){return this._mapId}addControl(x,h){if(h===void 0&&(h=x.getDefaultPosition?x.getDefaultPosition():"top-right"),!x||!x.onAdd)return this.fire(new u.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const _=x.onAdd(this);this._controls.push(x);const T=this._controlPositions[h];return h.indexOf("bottom")!==-1?T.insertBefore(_,T.firstChild):T.appendChild(_),this}removeControl(x){if(!x||!x.onRemove)return this.fire(new u.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const h=this._controls.indexOf(x);return h>-1&&this._controls.splice(h,1),x.onRemove(this),this}hasControl(x){return this._controls.indexOf(x)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(x){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const h=!this._moving;return h&&this.fire(new u.Event("movestart",x)).fire(new u.Event("move",x)),this.fire(new u.Event("resize",x)),h&&this.fire(new u.Event("moveend",x)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(x){return this.transform.setMaxBounds(u.LngLatBounds.convert(x)),this._update()}setMinZoom(x){if((x=x==null?-2:x)>=-2&&x<=this.transform.maxZoom)return this.transform.minZoom=x,this._update(),this.getZoom()<x?this.setZoom(x):this.fire(new u.Event("zoomstart")).fire(new u.Event("zoom")).fire(new u.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(x){if((x=x==null?22:x)>=this.transform.minZoom)return this.transform.maxZoom=x,this._update(),this.getZoom()>x?this.setZoom(x):this.fire(new u.Event("zoomstart")).fire(new u.Event("zoom")).fire(new u.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(x){if((x=x==null?0:x)<0)throw new Error("minPitch must be greater than or equal to 0");if(x>=0&&x<=this.transform.maxPitch)return this.transform.minPitch=x,this._update(),this.getPitch()<x?this.setPitch(x):this.fire(new u.Event("pitchstart")).fire(new u.Event("pitch")).fire(new u.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(x){if((x=x==null?85:x)>85)throw new Error("maxPitch must be less than or equal to 85");if(x>=this.transform.minPitch)return this.transform.maxPitch=x,this._update(),this.getPitch()>x?this.setPitch(x):this.fire(new u.Event("pitchstart")).fire(new u.Event("pitch")).fire(new u.Event("pitchend")),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(x){return this.transform.renderWorldCopies=x,this._update()}getProjection(){return this._explicitProjection?this._explicitProjection:this.style&&this.style.stylesheet&&this.style.stylesheet.projection?this.style.stylesheet.projection:{name:"mercator",center:[0,0]}}setProjection(x){return this._lazyInitEmptyStyle(),x?typeof x=="string"&&(x={name:x}):x=null,this._updateProjection(x)}_updateProjection(x){x===null&&(this._explicitProjection=null);const h=x||this.getProjection(),_=this.transform.setProjection(h);if(x&&(this._explicitProjection=this.transform.getProjection()),_){this.painter.clearBackgroundTiles();for(const T in this.style._sourceCaches)this.style._sourceCaches[T].clearTiles();this.style.applyProjectionUpdate(),this._update(!0)}return this}project(x){return this.transform.locationPoint3D(u.LngLat.convert(x))}unproject(x){return this.transform.pointLocation3D(u.pointGeometry.convert(x))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_createDelegatedListener(x,h,_){if(x==="mouseenter"||x==="mouseover"){let T=!1;const C=B=>{const F=h.filter(Z=>this.getLayer(Z)),V=F.length?this.queryRenderedFeatures(B.point,{layers:F}):[];V.length?T||(T=!0,_.call(this,new $r(x,this,B.originalEvent,{features:V}))):T=!1},k=()=>{T=!1};return{layers:new Set(h),listener:_,delegates:{mousemove:C,mouseout:k}}}if(x==="mouseleave"||x==="mouseout"){let T=!1;const C=B=>{const F=h.filter(V=>this.getLayer(V));(F.length?this.queryRenderedFeatures(B.point,{layers:F}):[]).length?T=!0:T&&(T=!1,_.call(this,new $r(x,this,B.originalEvent)))},k=B=>{T&&(T=!1,_.call(this,new $r(x,this,B.originalEvent)))};return{layers:new Set(h),listener:_,delegates:{mousemove:C,mouseout:k}}}{const T=C=>{const k=h.filter(F=>this.getLayer(F)),B=k.length?this.queryRenderedFeatures(C.point,{layers:k}):[];B.length&&(C.features=B,_.call(this,C),delete C.features)};return{layers:new Set(h),listener:_,delegates:{[x]:T}}}}on(x,h,_){if(_===void 0)return super.on(x,h);Array.isArray(h)||(h=[h]);const T=this._createDelegatedListener(x,h,_);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[x]=this._delegatedListeners[x]||[],this._delegatedListeners[x].push(T);for(const C in T.delegates)this.on(C,T.delegates[C]);return this}once(x,h,_){if(_===void 0)return super.once(x,h);Array.isArray(h)||(h=[h]);const T=this._createDelegatedListener(x,h,_);for(const C in T.delegates)this.once(C,T.delegates[C]);return this}off(x,h,_){if(_===void 0)return super.off(x,h);h=new Set(Array.isArray(h)?h:[h]);const T=(k,B)=>{if(k.size!==B.size)return!1;for(const F of k)if(!B.has(F))return!1;return!0},C=this._delegatedListeners?this._delegatedListeners[x]:void 0;return C&&(k=>{for(let B=0;B<k.length;B++){const F=k[B];if(F.listener===_&&T(F.layers,h)){for(const V in F.delegates)this.off(V,F.delegates[V]);return k.splice(B,1),this}}})(C),this}queryRenderedFeatures(x,h){return this.style?(h!==void 0||x===void 0||x instanceof u.pointGeometry||Array.isArray(x)||(h=x,x=void 0),this.style.queryRenderedFeatures(x=x||[[0,0],[this.transform.width,this.transform.height]],h=h||{},this.transform)):[]}querySourceFeatures(x,h){return this.style.querySourceFeatures(x,h)}queryTerrainElevation(x,h){const _=this.transform.elevation;return _?(h=u.extend({},{exaggerated:!0},h),_.getAtPoint(u.MercatorCoordinate.fromLngLat(x),null,h.exaggerated)):null}setStyle(x,h){return(h=u.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},h)).diff!==!1&&h.localIdeographFontFamily===this._localIdeographFontFamily&&h.localFontFamily===this._localFontFamily&&this.style&&x?(this._diffStyle(x,h),this):(this._localIdeographFontFamily=h.localIdeographFontFamily,this._localFontFamily=h.localFontFamily,this._updateStyle(x,h))}_getUIString(x){const h=this._locale[x];if(h==null)throw new Error(`Missing UI string '${x}'`);return h}_updateStyle(x,h){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),x&&(this.style=new Ir(this,h||{}),this.style.setEventedParent(this,{style:this.style}),typeof x=="string"?this.style.loadURL(x):this.style.loadJSON(x)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Ir(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(x,h){if(typeof x=="string"){const _=this._requestManager.normalizeStyleURL(x),T=this._requestManager.transformRequest(_,u.ResourceType.Style);u.getJSON(T,(C,k)=>{C?this.fire(new u.ErrorEvent(C)):k&&this._updateDiff(k,h)})}else typeof x=="object"&&this._updateDiff(x,h)}_updateDiff(x,h){try{this.style.setState(x)&&this._update(!0)}catch(_){u.warnOnce(`Unable to perform style diff: ${_.message||_.error||_}.  Rebuilding the style from scratch.`),this._updateStyle(x,h)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(u.warnOnce("There is no style added to the map."),!1)}addSource(x,h){return this._lazyInitEmptyStyle(),this.style.addSource(x,h),this._update(!0)}isSourceLoaded(x){return!!this.style&&this.style._isSourceCacheLoaded(x)}areTilesLoaded(){const x=this.style&&this.style._sourceCaches;for(const h in x){const _=x[h]._tiles;for(const T in _){const C=_[T];if(C.state!=="loaded"&&C.state!=="errored")return!1}}return!0}addSourceType(x,h,_){this._lazyInitEmptyStyle(),this.style.addSourceType(x,h,_)}removeSource(x){return this.style.removeSource(x),this._updateTerrain(),this._update(!0)}getSource(x){return this.style.getSource(x)}addImage(x,h,{pixelRatio:_=1,sdf:T=!1,stretchX:C,stretchY:k,content:B}={}){if(this._lazyInitEmptyStyle(),h instanceof u.window.HTMLImageElement||u.window.ImageBitmap&&h instanceof u.window.ImageBitmap){const{width:F,height:V,data:Z}=u.exported.getImageData(h);this.style.addImage(x,{data:new u.RGBAImage({width:F,height:V},Z),pixelRatio:_,stretchX:C,stretchY:k,content:B,sdf:T,version:0})}else if(h.width===void 0||h.height===void 0)this.fire(new u.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:F,height:V}=h,Z=h;this.style.addImage(x,{data:new u.RGBAImage({width:F,height:V},new Uint8Array(Z.data)),pixelRatio:_,stretchX:C,stretchY:k,content:B,sdf:T,version:0,userImage:Z}),Z.onAdd&&Z.onAdd(this,x)}}updateImage(x,h){const _=this.style.getImage(x);if(!_)return void this.fire(new u.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const T=h instanceof u.window.HTMLImageElement||u.window.ImageBitmap&&h instanceof u.window.ImageBitmap?u.exported.getImageData(h):h,{width:C,height:k}=T;C!==void 0&&k!==void 0?C===_.data.width&&k===_.data.height?(_.data.replace(T.data,!(h instanceof u.window.HTMLImageElement||u.window.ImageBitmap&&h instanceof u.window.ImageBitmap)),this.style.updateImage(x,_)):this.fire(new u.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image"))):this.fire(new u.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(x){return x?!!this.style.getImage(x):(this.fire(new u.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(x){this.style.removeImage(x)}loadImage(x,h){u.getImage(this._requestManager.transformRequest(x,u.ResourceType.Image),(_,T)=>{h(_,T instanceof u.window.HTMLImageElement?u.exported.getImageData(T):T)})}listImages(){return this.style.listImages()}addLayer(x,h){return this._lazyInitEmptyStyle(),this.style.addLayer(x,h),this._update(!0)}moveLayer(x,h){return this.style.moveLayer(x,h),this._update(!0)}removeLayer(x){return this.style.removeLayer(x),this._update(!0)}getLayer(x){return this.style.getLayer(x)}setLayerZoomRange(x,h,_){return this.style.setLayerZoomRange(x,h,_),this._update(!0)}setFilter(x,h,_={}){return this.style.setFilter(x,h,_),this._update(!0)}getFilter(x){return this.style.getFilter(x)}setPaintProperty(x,h,_,T={}){return this.style.setPaintProperty(x,h,_,T),this._update(!0)}getPaintProperty(x,h){return this.style.getPaintProperty(x,h)}setLayoutProperty(x,h,_,T={}){return this.style.setLayoutProperty(x,h,_,T),this._update(!0)}getLayoutProperty(x,h){return this.style.getLayoutProperty(x,h)}setLight(x,h={}){return this._lazyInitEmptyStyle(),this.style.setLight(x,h),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(x){return this._lazyInitEmptyStyle(),!x&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(x),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(x){return this._lazyInitEmptyStyle(),this.style.setFog(x),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(x){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(u.LngLat.convert(x),this.transform):0}setFeatureState(x,h){return this.style.setFeatureState(x,h),this._update()}removeFeatureState(x,h){return this.style.removeFeatureState(x,h),this._update()}getFeatureState(x){return this.style.getFeatureState(x)}_updateContainerDimensions(){if(!this._container)return;const x=this._container.getBoundingClientRect().width||400,h=this._container.getBoundingClientRect().height||300;let _,T,C,k=this._container;for(;k&&(!T||!C);){const B=u.window.getComputedStyle(k).transform;B&&B!=="none"&&(_=B.match(/matrix.*\((.+)\)/)[1].split(", "),_[0]&&_[0]!=="0"&&_[0]!=="1"&&(T=_[0]),_[3]&&_[3]!=="0"&&_[3]!=="1"&&(C=_[3])),k=k.parentElement}this._containerWidth=T?Math.abs(x/T):x,this._containerHeight=C?Math.abs(h/C):h}_detectMissingCSS(){u.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&u.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const x=this._container;x.classList.add("mapboxgl-map"),(this._missingCSSCanary=$("div","mapboxgl-canary",x)).style.visibility="hidden",this._detectMissingCSS();const h=this._canvasContainer=$("div","mapboxgl-canvas-container",x);this._interactive&&h.classList.add("mapboxgl-interactive"),this._canvas=$("canvas","mapboxgl-canvas",h),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const _=this._controlContainer=$("div","mapboxgl-control-container",x),T=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(C=>{T[C]=$("div",`mapboxgl-ctrl-${C}`,_)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(x,h){const _=u.exported.devicePixelRatio||1;this._canvas.width=_*Math.ceil(x),this._canvas.height=_*Math.ceil(h),this._canvas.style.width=`${x}px`,this._canvas.style.height=`${h}px`}_addMarker(x){this._markers.push(x)}_removeMarker(x){const h=this._markers.indexOf(x);h!==-1&&this._markers.splice(h,1)}_setupPainter(){const x=u.extend({},A.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),h=this._canvas.getContext("webgl",x)||this._canvas.getContext("experimental-webgl",x);h?(u.storeAuthState(h,!0),this.painter=new tc(h,this.transform),this.on("data",_=>{_.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),u.exported$1.testSupport(h)):this.fire(new u.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(x){x.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new u.Event("webglcontextlost",{originalEvent:x}))}_contextRestored(x){this._setupPainter(),this.resize(),this._update(),this.fire(new u.Event("webglcontextrestored",{originalEvent:x}))}_onMapScroll(x){if(x.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(x){return this.style?(this._styleDirty=this._styleDirty||x,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(x){return this._update(),this._renderTaskQueue.add(x)}_cancelRenderFrame(x){this._renderTaskQueue.remove(x)}_requestDomTask(x){!this.loaded()||this.loaded()&&!this.isMoving()?x():this._domRenderTaskQueue.add(x)}_render(x){let h;const _=this.painter.context.extTimerQuery,T=u.exported.now();if(this.listens("gpu-timing-frame")&&(h=_.createQueryEXT(),_.beginQueryEXT(_.TIME_ELAPSED_EXT,h)),this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(x),this._domRenderTaskQueue.run(x),this._removed)return;let C=!1;const k=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const V=this.transform.zoom,Z=this.transform.pitch,X=u.exported.now();this.style.zoomHistory.update(V,X);const te=new u.EvaluationParameters(V,{now:X,fadeDuration:k,pitch:Z,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),le=te.crossFadingFactor();le===1&&le===this._crossFadingFactor||(C=!0,this._crossFadingFactor=le),this.style.update(te)}this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let B=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),B=this._updateAverageElevation(T),this.style._updateSources(this.transform),this._forceMarkerUpdate()):B=this._updateAverageElevation(T),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,k,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:k,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),speedIndexTiming:this.speedIndexTiming}),this.fire(new u.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new u.Event("load"))),this.style&&(this.style.hasTransitions()||C)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const V=u.exported.now()-T;_.endQueryEXT(_.TIME_ELAPSED_EXT,h),setTimeout(()=>{const Z=_.getQueryObjectEXT(h,_.QUERY_RESULT_EXT)/1e6;_.deleteQueryEXT(h),this.fire(new u.Event("gpu-timing-frame",{cpuTime:V,gpuTime:Z}))},50)}if(this.listens("gpu-timing-layer")){const V=this.painter.collectGpuTimers();setTimeout(()=>{const Z=this.painter.queryGpuTimers(V);this.fire(new u.Event("gpu-timing-layer",{layerTimes:Z}))},50)}const F=this._sourcesDirty||this._styleDirty||this._placementDirty||B;if(F||this._repaint)this.triggerRepaint();else{const V=!this.isMoving()&&this.loaded();if(V&&(B=this._updateAverageElevation(T,!0)),B)this.triggerRepaint();else if(this._triggerFrame(!1),V&&(this.fire(new u.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const Z=this._calculateSpeedIndex();this.fire(new u.Event("speedindexcompleted",{speedIndex:Z})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||F||(this._fullyLoaded=!0,this._authenticate())}_forceMarkerUpdate(){for(const x of this._markers)x._update()}_updateAverageElevation(x,h=!1){const _=T=>(this.transform.averageElevation=T,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&_(0);if((h||x-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(x)){const T=this.transform.averageElevation;let C=this.transform.sampleAverageElevation(),k=!1;this.transform.elevation&&(k=this.transform.elevation.exaggeration()!==this._averageElevationExaggeration,this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(C)?C=0:this._averageElevationLastSampledAt=x;const B=Math.abs(T-C);if(B>1){if(this._isInitialLoad||k)return this._averageElevation.jumpTo(C),_(C);this._averageElevation.easeTo(C,x,300)}else if(B>1e-4)return this._averageElevation.jumpTo(C),_(C)}return!!this._averageElevation.isEasing(x)&&_(this._averageElevation.getValue(x))}_authenticate(){u.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,x=>{if(x&&(x.message===u.AUTH_ERR_MSG||x.status===401)){const h=this.painter.context.gl;u.storeAuthState(h,!1),this._logoControl instanceof Tc&&this._logoControl._updateLogo(),h&&h.clear(h.DEPTH_BUFFER_BIT|h.COLOR_BUFFER_BIT|h.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new u.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),u.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming())}_calculateSpeedIndex(){const x=this.painter.canvasCopy(),h=this.painter.getCanvasCopiesAndTimestamps();h.timeStamps.push(performance.now());const _=this.painter.context.gl,T=_.createFramebuffer();function C(k){_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,k,0);const B=new Uint8Array(_.drawingBufferWidth*_.drawingBufferHeight*4);return _.readPixels(0,0,_.drawingBufferWidth,_.drawingBufferHeight,_.RGBA,_.UNSIGNED_BYTE,B),B}return _.bindFramebuffer(_.FRAMEBUFFER,T),this._canvasPixelComparison(C(x),h.canvasCopies.map(C),h.timeStamps)}_canvasPixelComparison(x,h,_){let T=_[1]-_[0];const C=x.length/4;for(let k=0;k<h.length;k++){const B=h[k];let F=0;for(let V=0;V<B.length;V+=4)B[V]===x[V]&&B[V+1]===x[V+1]&&B[V+2]===x[V+2]&&B[V+3]===x[V+3]&&(F+=1);T+=(_[k+2]-_[k+1])*(1-F/C)}return T}remove(){this._hash&&this._hash.remove();for(const h of this._controls)h.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),u.window!==void 0&&(u.window.removeEventListener("resize",this._onWindowResize,!1),u.window.removeEventListener("orientationchange",this._onWindowResize,!1),u.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),u.window.removeEventListener("online",this._onWindowOnline,!1));const x=this.painter.context.gl.getExtension("WEBGL_lose_context");x&&x.loseContext(),ls(this._canvasContainer),ls(this._controlContainer),ls(this._missingCSSCanary),this._container.classList.remove("mapboxgl-map"),u.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new u.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(x){this._renderNextFrame=this._renderNextFrame||x,this.style&&!this._frame&&(this._frame=u.exported.frame(h=>{const _=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,_&&this._render(h)}))}_preloadTiles(x){const h=this.style?Object.values(this.style._sourceCaches):[];return u.asyncAll(h,(_,T)=>_._preloadTiles(x,T),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(x){this._trackResize&&this.resize({originalEvent:x})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(x){this._showTileBoundaries!==x&&(this._showTileBoundaries=x,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(x){this._showTerrainWireframe!==x&&(this._showTerrainWireframe=x,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(x){this._speedIndexTiming!==x&&(this._speedIndexTiming=x,this._update())}get showPadding(){return!!this._showPadding}set showPadding(x){this._showPadding!==x&&(this._showPadding=x,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(x){this._showCollisionBoxes!==x&&(this._showCollisionBoxes=x,x?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(x){this._showOverdrawInspector!==x&&(this._showOverdrawInspector=x,this._update())}get repaint(){return!!this._repaint}set repaint(x){this._repaint!==x&&(this._repaint=x,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(x){this._vertices=x,this._update()}_setCacheLimits(x,h){u.setCacheLimits(x,h)}get version(){return u.version}},NavigationControl:class{constructor(x){this.options=u.extend({},Qa,x),this._container=$("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",h=>h.preventDefault()),this.options.showZoom&&(u.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",h=>{this._map&&this._map.zoomIn({},{originalEvent:h})}),$("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",h=>{this._map&&this._map.zoomOut({},{originalEvent:h})}),$("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(u.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",h=>{const _=this._map;_&&(this.options.visualizePitch?_.resetNorthPitch({},{originalEvent:h}):_.resetNorth({},{originalEvent:h}))}),this._compassIcon=$("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const x=this._map;if(!x)return;const h=x.getZoom(),_=h===x.getMaxZoom(),T=h===x.getMinZoom();this._zoomInButton.disabled=_,this._zoomOutButton.disabled=T,this._zoomInButton.setAttribute("aria-disabled",_.toString()),this._zoomOutButton.setAttribute("aria-disabled",T.toString())}_rotateCompassArrow(){const x=this._map;if(!x)return;const h=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(x.transform.pitch*(Math.PI/180)),.5)}) rotateX(${x.transform.pitch}deg) rotateZ(${x.transform.angle*(180/Math.PI)}deg)`:`rotate(${x.transform.angle*(180/Math.PI)}deg)`;x._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=h)})}onAdd(x){return this._map=x,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),x.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&x.on("pitch",this._rotateCompassArrow),x.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new el(x,this._compass,this.options.visualizePitch)),this._container}onRemove(){const x=this._map;x&&(this._container.remove(),this.options.showZoom&&x.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&x.off("pitch",this._rotateCompassArrow),x.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(x,h){const _=$("button",x,this._container);return _.type="button",_.addEventListener("click",h),_}_setButtonTitle(x,h){if(!this._map)return;const _=this._map._getUIString(`NavigationControl.${h}`);x.setAttribute("aria-label",_),x.firstElementChild&&x.firstElementChild.setAttribute("title",_)}},GeolocateControl:class extends u.Evented{constructor(x){super(),this.options=u.extend({},Cr,x),u.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ga(this._updateMarkerRotation,20)}onAdd(x){var h;return this._map=x,this._container=$("div","mapboxgl-ctrl mapboxgl-ctrl-group"),h=this._setupUI,Ur!==void 0?h(Ur):u.window.navigator.permissions!==void 0?u.window.navigator.permissions.query({name:"geolocation"}).then(_=>{Ur=_.state!=="denied",h(Ur)}):(Ur=!!u.window.navigator.geolocation,h(Ur)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(u.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,cs=0,eo=!1}_isOutOfMapMaxBounds(x){const h=this._map.getMaxBounds(),_=x.coords;return!!h&&(_.longitude<h.getWest()||_.longitude>h.getEast()||_.latitude<h.getSouth()||_.latitude>h.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(x){if(this._map){if(this._isOutOfMapMaxBounds(x))return this._setErrorState(),this.fire(new u.Event("outofmaxbounds",x)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=x,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(x),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(x),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new u.Event("geolocate",x)),this._finish()}}_updateCamera(x){const h=new u.LngLat(x.coords.longitude,x.coords.latitude),_=x.coords.accuracy,T=this._map.getBearing(),C=u.extend({bearing:T},this.options.fitBoundsOptions);this._map.fitBounds(h.toBounds(_),C,{geolocateSource:!0})}_updateMarker(x){if(x){const h=new u.LngLat(x.coords.longitude,x.coords.latitude);this._accuracyCircleMarker.setLngLat(h).addTo(this._map),this._userLocationDotMarker.setLngLat(h).addTo(this._map),this._accuracy=x.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const x=this._map._containerHeight/2,h=this._map.unproject([0,x]),_=this._map.unproject([100,x]),T=h.distanceTo(_)/100,C=Math.ceil(2*this._accuracy/T);this._circleElement.style.width=`${C}px`,this._circleElement.style.height=`${C}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(x){if(this._map){if(this.options.trackUserLocation)if(x.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const h=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",h),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",h),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(x.code===3&&eo)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new u.Event("error",x)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(x){if(this._container.addEventListener("contextmenu",h=>h.preventDefault()),this._geolocateButton=$("button","mapboxgl-ctrl-geolocate",this._container),$("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",x===!1){u.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const h=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",h),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",h)}else{const h=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",h),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",h)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=$("div","mapboxgl-user-location"),this._dotElement.appendChild($("div","mapboxgl-user-location-dot")),this._dotElement.appendChild($("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Ks({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=$("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ks({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",h=>{h.geolocateSource||this._watchState!=="ACTIVE_LOCK"||h.originalEvent&&h.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new u.Event("trackuserlocationend")))})}_onDeviceOrientation(x){this._userLocationDotMarker&&(x.webkitCompassHeading?this._heading=x.webkitCompassHeading:x.absolute===!0&&(this._heading=-1*x.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return u.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new u.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":cs--,eo=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new u.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new u.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let x;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),cs++,cs>1?(x={maximumAge:6e5,timeout:0},eo=!0):(x=this.options.positionOptions,eo=!1),this._geolocationWatchID=u.window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,x),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else u.window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const x=()=>{u.window.addEventListener("ondeviceorientationabsolute"in u.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};u.window.DeviceMotionEvent!==void 0&&typeof u.window.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(h=>{h==="granted"&&x()}).catch(console.error):x()}_clearWatch(){u.window.navigator.geolocation.clearWatch(this._geolocationWatchID),u.window.removeEventListener("deviceorientation",this._onDeviceOrientation),u.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Ys,ScaleControl:class{constructor(x){this.options=u.extend({},tl,x),u.bindAll(["_onMove","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_onMove(){Js(this._map,this._container,this.options)}onAdd(x){return this._map=x,this._container=$("div","mapboxgl-ctrl mapboxgl-ctrl-scale",x.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._onMove),this._map=void 0}setUnit(x){this.options.unit=x,Js(this._map,this._container,this.options)}},FullscreenControl:class{constructor(x){this._fullscreen=!1,x&&x.container&&(x.container instanceof u.window.HTMLElement?this._container=x.container:u.warnOnce("Full screen control 'container' must be a DOM element.")),u.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in u.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in u.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(x){return this._map=x,this._container||(this._container=this._map.getContainer()),this._controlContainer=$("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",u.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,u.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!u.window.document.fullscreenEnabled&&!u.window.document.webkitFullscreenEnabled)}_setupUI(){const x=this._fullscreenButton=$("button","mapboxgl-ctrl-fullscreen",this._controlContainer);$("span","mapboxgl-ctrl-icon",x).setAttribute("aria-hidden","true"),x.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),u.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const x=this._getTitle();this._fullscreenButton.setAttribute("aria-label",x),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",x)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(u.window.document.fullscreenElement||u.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?u.window.document.exitFullscreen?u.window.document.exitFullscreen():u.window.document.webkitCancelFullScreen&&u.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends u.Evented{constructor(x){super(),this.options=u.extend(Object.create(Hr),x),u.bindAll(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(x&&x.className?x.className.trim().split(/\s+/):[])}addTo(x){return this._map&&this.remove(),this._map=x,this.options.closeOnClick&&x.on("preclick",this._onClose),this.options.closeOnMove&&x.on("move",this._onClose),x.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(x.on("mousemove",this._onMouseEvent),x.on("mouseup",this._onMouseEvent),x._canvasContainer.classList.add("mapboxgl-track-pointer")):x.on("move",this._update),this.fire(new u.Event("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const x=this._map;return x&&(x.off("move",this._update),x.off("move",this._onClose),x.off("preclick",this._onClose),x.off("click",this._onClose),x.off("remove",this.remove),x.off("mousemove",this._onMouseEvent),x.off("mouseup",this._onMouseEvent),x.off("drag",this._onMouseEvent),this._map=void 0),this.fire(new u.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(x){this._lngLat=u.LngLat.convert(x),this._pos=null,this._trackPointer=!1,this._update();const h=this._map;return h&&(h.on("move",this._update),h.off("mousemove",this._onMouseEvent),h._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const x=this._map;return x&&(x.off("move",this._update),x.on("mousemove",this._onMouseEvent),x.on("drag",this._onMouseEvent),x._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(x){return this.setDOMContent(u.window.document.createTextNode(x))}setHTML(x){const h=u.window.document.createDocumentFragment(),_=u.window.document.createElement("body");let T;for(_.innerHTML=x;T=_.firstChild,T;)h.appendChild(T);return this.setDOMContent(h)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(x){return this.options.maxWidth=x,this._update(),this}setDOMContent(x){let h=this._content;if(h)for(;h.hasChildNodes();)h.firstChild&&h.removeChild(h.firstChild);else h=this._content=$("div","mapboxgl-popup-content",this._container||void 0);if(h.appendChild(x),this.options.closeButton){const _=this._closeButton=$("button","mapboxgl-popup-close-button",h);_.type="button",_.setAttribute("aria-label","Close popup"),_.setAttribute("aria-hidden","true"),_.innerHTML="&#215;",_.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(x){return this._classList.add(x),this._updateClassList(),this}removeClassName(x){return this._classList.delete(x),this._updateClassList(),this}setOffset(x){return this.options.offset=x,this._update(),this}toggleClassName(x){let h;return this._classList.delete(x)?h=!1:(this._classList.add(x),h=!0),this._updateClassList(),h}_onMouseEvent(x){this._update(x.point)}_getAnchor(x){if(this.options.anchor)return this.options.anchor;const h=this._map,_=this._container,T=this._pos;if(!h||!_||!T)return"bottom";const C=_.offsetWidth,k=_.offsetHeight,B=T.x<C/2,F=T.x>h.transform.width-C/2;if(T.y+x<k)return B?"top-left":F?"top-right":"top";if(T.y>h.transform.height-k){if(B)return"bottom-left";if(F)return"bottom-right"}return B?"left":F?"right":"bottom"}_updateClassList(){const x=this._container;if(!x)return;const h=[...this._classList];h.push("mapboxgl-popup"),this._anchor&&h.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&h.push("mapboxgl-popup-track-pointer"),x.className=h.join(" ")}_update(x){const h=this._map,_=this._content;if(!h||!this._lngLat&&!this._trackPointer||!_)return;let T=this._container;if(T||(T=this._container=$("div","mapboxgl-popup",h.getContainer()),this._tip=$("div","mapboxgl-popup-tip",T),T.appendChild(_)),this.options.maxWidth&&T.style.maxWidth!==this.options.maxWidth&&(T.style.maxWidth=this.options.maxWidth),h.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Ws(this._lngLat,this._pos,h.transform)),!this._trackPointer||x){const C=this._pos=this._trackPointer&&x?x:h.project(this._lngLat),k=hs(this.options.offset),B=this._anchor=this._getAnchor(k.y),F=hs(this.options.offset,B),V=C.add(F).round();h._requestDomTask(()=>{this._container&&B&&(this._container.style.transform=`${Hs[B]} translate(${V.x}px,${V.y}px)`)})}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const x=this._container.querySelector(ji);x&&x.focus()}_onClose(){this.remove()}_setOpacity(x){this._content&&(this._content.style.opacity=x),this._tip&&(this._tip.style.opacity=x)}},Marker:Ks,Style:Ir,LngLat:u.LngLat,LngLatBounds:u.LngLatBounds,Point:u.pointGeometry,MercatorCoordinate:u.MercatorCoordinate,FreeCameraOptions:Qo,Evented:u.Evented,config:u.config,prewarm:function(){Wt().acquire(Rt)},clearPrewarmedResources:function(){const x=Lt;x&&(x.isPreloaded()&&x.numActive()===1?(x.release(Rt),Lt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return u.config.ACCESS_TOKEN},set accessToken(x){u.config.ACCESS_TOKEN=x},get baseApiUrl(){return u.config.API_URL},set baseApiUrl(x){u.config.API_URL=x},get workerCount(){return wt.workerCount},set workerCount(x){wt.workerCount=x},get maxParallelImageRequests(){return u.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(x){u.config.MAX_PARALLEL_IMAGE_REQUESTS=x},clearStorage(x){u.clearTileCache(x)},workerUrl:"",workerClass:null,setNow:u.exported.setNow,restoreNow:u.exported.restoreNow};return To});var w=p;return w})})(mapboxGl);var mapboxgl=mapboxGl.exports,d2r=Math.PI/180,r2d=180/Math.PI;function tileToBBOX(n){var t=tile2lon(n[0]+1,n[2]),s=tile2lon(n[0],n[2]),l=tile2lat(n[1]+1,n[2]),p=tile2lat(n[1],n[2]);return[s,l,t,p]}function tileToGeoJSON(n){var t=tileToBBOX(n),s={type:"Polygon",coordinates:[[[t[0],t[3]],[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]]]]};return s}function tile2lon(n,t){return n/Math.pow(2,t)*360-180}function tile2lat(n,t){var s=Math.PI-2*Math.PI*n/Math.pow(2,t);return r2d*Math.atan(.5*(Math.exp(s)-Math.exp(-s)))}function pointToTile(n,t,s){var l=pointToTileFraction(n,t,s);return l[0]=Math.floor(l[0]),l[1]=Math.floor(l[1]),l}function getChildren(n){return[[n[0]*2,n[1]*2,n[2]+1],[n[0]*2+1,n[1]*2,n[2]+1],[n[0]*2+1,n[1]*2+1,n[2]+1],[n[0]*2,n[1]*2+1,n[2]+1]]}function getParent(n){return[n[0]>>1,n[1]>>1,n[2]-1]}function getSiblings(n){return getChildren(getParent(n))}function hasSiblings(n,t){for(var s=getSiblings(n),l=0;l<s.length;l++)if(!hasTile(t,s[l]))return!1;return!0}function hasTile(n,t){for(var s=0;s<n.length;s++)if(tilesEqual(n[s],t))return!0;return!1}function tilesEqual(n,t){return n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]}function tileToQuadkey(n){for(var t="",s=n[2];s>0;s--){var l=0,p=1<<s-1;(n[0]&p)!==0&&l++,(n[1]&p)!==0&&(l+=2),t+=l.toString()}return t}function quadkeyToTile(n){for(var t=0,s=0,l=n.length,p=l;p>0;p--){var g=1<<p-1,w=+n[l-p];w===1&&(t|=g),w===2&&(s|=g),w===3&&(t|=g,s|=g)}return[t,s,l]}function bboxToTile(n){var t=pointToTile(n[0],n[1],32),s=pointToTile(n[2],n[3],32),l=[t[0],t[1],s[0],s[1]],p=getBboxZoom(l);if(p===0)return[0,0,0];var g=l[0]>>>32-p,w=l[1]>>>32-p;return[g,w,p]}function getBboxZoom(n){for(var t=28,s=0;s<t;s++){var l=1<<32-(s+1);if((n[0]&l)!==(n[2]&l)||(n[1]&l)!==(n[3]&l))return s}return t}function pointToTileFraction(n,t,s){var l=Math.sin(t*d2r),p=Math.pow(2,s),g=p*(n/360+.5),w=p*(.5-.25*Math.log((1+l)/(1-l))/Math.PI);return g=g%p,g<0&&(g=g+p),[g,w,s]}var tilebelt={tileToGeoJSON,tileToBBOX,getChildren,getParent,getSiblings,hasTile,hasSiblings,tilesEqual,tileToQuadkey,quadkeyToTile,pointToTile,bboxToTile,pointToTileFraction};function feature(n,t,s){s===void 0&&(s={});var l={type:"Feature"};return(s.id===0||s.id)&&(l.id=s.id),s.bbox&&(l.bbox=s.bbox),l.properties=t||{},l.geometry=n,l}function polygon(n,t,s){s===void 0&&(s={});for(var l=0,p=n;l<p.length;l++){var g=p[l];if(g.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var w=0;w<g[g.length-1].length;w++)if(g[g.length-1][w]!==g[0][w])throw new Error("First and last Position are not equivalent.")}var u={type:"Polygon",coordinates:n};return feature(u,t,s)}function bboxPolygon(n,t){t===void 0&&(t={});var s=Number(n[0]),l=Number(n[1]),p=Number(n[2]),g=Number(n[3]);if(n.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var w=[s,l],u=[s,g],A=[p,g],S=[p,l];return polygon([[w,S,A,u,w]],t.properties,{bbox:n,id:t.id})}const bitMethods={getBit(n){return this.data[getSlot(n)]&1<<getShift(n)?1:0},setBit(n){this.data[getSlot(n)]|=1<<getShift(n)},clearBit(n){this.data[getSlot(n)]&=~(1<<getShift(n))},toggleBit(n){this.data[getSlot(n)]^=1<<getShift(n)},getBitXY(n,t){return n>=this.width||t>=this.height?0:this.getBit(t*this.width+n)},setBitXY(n,t){this.setBit(t*this.width+n)},clearBitXY(n,t){this.clearBit(t*this.width+n)},toggleBitXY(n,t){this.toggleBit(t*this.width+n)}};function getSlot(n){return n>>3}function getShift(n){return 7-(n&7)}function setBitMethods(n){for(const t in bitMethods)n.prototype[t]=bitMethods[t]}function checkProcessable(n,t={}){let{bitDepth:s,alpha:l,colorModel:p,components:g,channels:w}=t;if(typeof n!="string"||n.length===0)throw new TypeError("processName must be a string");if(s&&(Array.isArray(s)||(s=[s]),!s.includes(this.bitDepth)))throw new TypeError(`The process: ${n} can only be applied if bit depth is in: ${s}`);if(l&&(Array.isArray(l)||(l=[l]),!l.includes(this.alpha)))throw new TypeError(`The process: ${n} can only be applied if alpha is in: ${l}`);if(p&&(Array.isArray(p)||(p=[p]),!p.includes(this.colorModel)))throw new TypeError(`The process: ${n} can only be applied if color model is in: ${p}`);if(g&&(Array.isArray(g)||(g=[g]),!g.includes(this.components))){let u=`The process: ${n} can only be applied if the number of components is in: ${g}`;throw g.length===1&&g[0]===1?new TypeError(`${u}.\rYou should transform your image using "image.grey()" before applying the algorithm.`):new TypeError(u)}if(w&&(Array.isArray(w)||(w=[w]),!w.includes(this.channels)))throw new TypeError(`The process: ${n} can only be applied if the number of channels is in: ${w}`)}function createBlob(n,t){n=n||[],t=t||{},typeof t=="string"&&(t={type:t});try{return new Blob(n,t)}catch(g){if(g.name!=="TypeError")throw g;for(var s=typeof BlobBuilder!="undefined"?BlobBuilder:typeof MSBlobBuilder!="undefined"?MSBlobBuilder:typeof MozBlobBuilder!="undefined"?MozBlobBuilder:WebKitBlobBuilder,l=new s,p=0;p<n.length;p+=1)l.append(n[p]);return l.getBlob(t.type)}}function dataURLToBlob(n){var t=n.match(/data:([^;]+)/)[1],s=n.replace(/^[^,]+,/,""),l=binaryStringToArrayBuffer(atob(s));return createBlob([l],{type:t})}function canvasToBlob(n,t,s){return typeof n.toBlob=="function"?new Promise(function(l){n.toBlob(l,t,s)}):Promise.resolve(dataURLToBlob(n.toDataURL(t,s)))}function binaryStringToArrayBuffer(n){for(var t=n.length,s=new ArrayBuffer(t),l=new Uint8Array(s),p=-1;++p<t;)l[p]=n.charCodeAt(p);return s}var utf8$1={exports:{}};/*! https://mths.be/utf8js v2.1.2 by @mathias */(function(n,t){(function(s){var l=t,p=n&&n.exports==l&&n,g=typeof commonjsGlobal=="object"&&commonjsGlobal;(g.global===g||g.window===g)&&(s=g);var w=String.fromCharCode;function u(we){for(var oe=[],be=0,ie=we.length,ue,Ce;be<ie;)ue=we.charCodeAt(be++),ue>=55296&&ue<=56319&&be<ie?(Ce=we.charCodeAt(be++),(Ce&64512)==56320?oe.push(((ue&1023)<<10)+(Ce&1023)+65536):(oe.push(ue),be--)):oe.push(ue);return oe}function A(we){for(var oe=we.length,be=-1,ie,ue="";++be<oe;)ie=we[be],ie>65535&&(ie-=65536,ue+=w(ie>>>10&1023|55296),ie=56320|ie&1023),ue+=w(ie);return ue}function S(we){if(we>=55296&&we<=57343)throw Error("Lone surrogate U+"+we.toString(16).toUpperCase()+" is not a scalar value")}function D(we,oe){return w(we>>oe&63|128)}function z(we){if((we&4294967168)==0)return w(we);var oe="";return(we&4294965248)==0?oe=w(we>>6&31|192):(we&4294901760)==0?(S(we),oe=w(we>>12&15|224),oe+=D(we,6)):(we&4292870144)==0&&(oe=w(we>>18&7|240),oe+=D(we,12),oe+=D(we,6)),oe+=w(we&63|128),oe}function $(we){for(var oe=u(we),be=oe.length,ie=-1,ue,Ce="";++ie<be;)ue=oe[ie],Ce+=z(ue);return Ce}function O(){if(Y>=J)throw Error("Invalid byte index");var we=K[Y]&255;if(Y++,(we&192)==128)return we&63;throw Error("Invalid continuation byte")}function q(){var we,oe,be,ie,ue;if(Y>J)throw Error("Invalid byte index");if(Y==J)return!1;if(we=K[Y]&255,Y++,(we&128)==0)return we;if((we&224)==192){if(oe=O(),ue=(we&31)<<6|oe,ue>=128)return ue;throw Error("Invalid continuation byte")}if((we&240)==224){if(oe=O(),be=O(),ue=(we&15)<<12|oe<<6|be,ue>=2048)return S(ue),ue;throw Error("Invalid continuation byte")}if((we&248)==240&&(oe=O(),be=O(),ie=O(),ue=(we&7)<<18|oe<<12|be<<6|ie,ue>=65536&&ue<=1114111))return ue;throw Error("Invalid UTF-8 detected")}var K,J,Y;function fe(we){K=u(we),J=K.length,Y=0;for(var oe=[],be;(be=q())!==!1;)oe.push(be);return A(oe)}var ee={version:"2.1.2",encode:$,decode:fe};if(l&&!l.nodeType)if(p)p.exports=ee;else{var re={},he=re.hasOwnProperty;for(var _e in ee)he.call(ee,_e)&&(l[_e]=ee[_e])}else s.utf8=ee})(commonjsGlobal)})(utf8$1,utf8$1.exports);const utf8=utf8$1.exports,defaultByteLength$3=1024*8,charArray$1=[];class IOBuffer$6{constructor(t,s){s=s||{};var l=!1;t===void 0&&(t=defaultByteLength$3),typeof t=="number"?t=new ArrayBuffer(t):(l=!0,this._lastWrittenByte=t.byteLength);const p=s.offset?s.offset>>>0:0;let g=t.byteLength-p,w=p;t.buffer&&(t.byteLength!==t.buffer.byteLength&&(w=t.byteOffset+p),t=t.buffer),l?this._lastWrittenByte=g:this._lastWrittenByte=0,this.buffer=t,this.length=g,this.byteLength=g,this.byteOffset=w,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,w,g),this._mark=0,this._marks=[]}available(t){return t===void 0&&(t=1),this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t){return t===void 0&&(t=1),this.offset+=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(t===void 0)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t){if(t===void 0&&(t=1),!this.available(t)){const l=(this.offset+t)*2,p=new Uint8Array(l);p.set(new Uint8Array(this.buffer)),this.buffer=p.buffer,this.length=this.byteLength=l,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t){t===void 0&&(t=1);for(var s=new Uint8Array(t),l=0;l<t;l++)s[l]=this.readByte();return s}readInt16(){var t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){var t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){var t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){var t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){var t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){var t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t){t===void 0&&(t=1),charArray$1.length=t;for(var s=0;s<t;s++)charArray$1[s]=this.readChar();return charArray$1.join("")}readUtf8(t){t===void 0&&(t=1);const s=this.readChars(t);return utf8.decode(s)}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(var s=0;s<t.length;s++)this._data.setUint8(this.offset++,t[s]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(var s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));return this}writeUtf8(t){const s=utf8.encode(t);return this.writeChars(s)}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}getBuffer(){return typeof Buffer!="undefined"?Buffer.from(this.toArray()):this.toArray()}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}}var IOBuffer_1$1=IOBuffer$6,constants$7={BITMAPV5HEADER:{LogicalColorSpace:{LCS_CALIBRATED_RGB:0,LCS_sRGB:1934772034,LCS_WINDOWS_COLOR_SPACE:1466527264},Compression:{BI_RGB:0,BI_RLE8:1,BI_RLE4:2,BI_BITFIELDS:3,BI_JPEG:4,BI_PNG:5,BI_CMYK:11,BI_CMYKRLE8:12,BI_CMYKRLE4:13},GamutMappingIntent:{LCS_GM_ABS_COLORIMETRIC:8,LCS_GM_BUSINESS:1,LCS_GM_GRAPHICS:2,LCS_GM_IMAGES:4}}};const IOBuffer$5=IOBuffer_1$1,constants$6=constants$7,tableLeft=[];for(var i$4=0;i$4<=8;i$4++)tableLeft.push(255<<i$4);var encode$5=function(n){if(n.bitDepth!==1)throw new Error("Only bitDepth of 1 is supported");if(!n.height||!n.width)throw new Error("ImageData width and height are required");if(n.components!==1)throw new Error("Only 1 component is supported");if(n.channels!==1)throw new Error("Only 1 channel is supported");var t=new IOBuffer$5;t.skip(14),writeBitmapV5Header(t,n),writeColorTable(t,n);const s=t.offset;return writePixelArray(t,n),t.rewind(),writeBitmapFileHeader(t,s),t.getBuffer()};function writePixelArray(n,t){const s=Math.floor((t.bitDepth*t.width+31)/32)*4,l=Math.ceil(t.bitDepth*t.width/8),p=s-l,g=t.bitDepth*t.width%8,w=g===0?0:8-g,u=s*t.height;var A,S;const D=new IOBuffer$5(t.data);let z=0,$=0,O=8;n.mark(),S=D.readUint8();for(var q=t.height-1;q>=0;q--){const J=q===0;n.reset(),n.skip(q*s);for(var K=0;K<l;K++){const Y=K===l-1;$<=w&&Y?(n.writeByte(S<<$),(w===0||w===$)&&!J&&(A=S,S=D.readByte())):$===0?(A=S,S=D.readUint8(),n.writeByte(A)):(A=S,S=D.readUint8(),n.writeByte(A<<$&tableLeft[$]|S>>O)),Y?(z+=g||8,n.skip(p),$=z%8,O=8-$):z+=8}}s>l&&(n.reset(),n.skip(u-1),n.writeUint8(0))}function writeColorTable(n,t){t.bitDepth>8||n.writeUint32(0).writeUint32(16777215)}function writeBitmapFileHeader(n,t){n.writeChars("BM"),n.writeInt32(n._lastWrittenByte),n.writeUint16(0),n.writeUint16(0),n.writeUint32(t)}function writeBitmapV5Header(n,t){n.writeUint32(124).writeInt32(t.width).writeInt32(t.height).writeUint16(1).writeUint16(t.bitDepth).writeUint32(constants$6.BITMAPV5HEADER.Compression.BI_RGB).writeUint32(t.width*t.height*t.bitDepth).writeInt32(0).writeInt32(0).writeUint32(Math.pow(2,t.bitDepth)).writeUint32(Math.pow(2,t.bitDepth)).writeUint32(4278190080).writeUint32(16711680).writeUint32(65280).writeUint32(255).writeUint32(constants$6.BITMAPV5HEADER.LogicalColorSpace.LCS_sRGB).skip(36).skip(12).writeUint32(constants$6.BITMAPV5HEADER.GamutMappingIntent.LCS_GM_IMAGES).skip(12)}var encode$4=encode$5;(function(n){if(n.TextEncoder&&n.TextDecoder)return!1;function t(l="utf-8"){if(l!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${l}') is invalid.`)}Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),t.prototype.encode=function(l,p={stream:!1}){if(p.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let g=0;const w=l.length;let u=0,A=Math.max(32,w+(w>>1)+7),S=new Uint8Array(A>>3<<3);for(;g<w;){let D=l.charCodeAt(g++);if(D>=55296&&D<=56319){if(g<w){const z=l.charCodeAt(g);(z&64512)===56320&&(++g,D=((D&1023)<<10)+(z&1023)+65536)}if(D>=55296&&D<=56319)continue}if(u+4>S.length){A+=8,A*=1+g/l.length*2,A=A>>3<<3;const z=new Uint8Array(A);z.set(S),S=z}if((D&4294967168)===0){S[u++]=D;continue}else if((D&4294965248)===0)S[u++]=D>>6&31|192;else if((D&4294901760)===0)S[u++]=D>>12&15|224,S[u++]=D>>6&63|128;else if((D&4292870144)===0)S[u++]=D>>18&7|240,S[u++]=D>>12&63|128,S[u++]=D>>6&63|128;else continue;S[u++]=D&63|128}return S.slice(0,u)};function s(l="utf-8",p={fatal:!1}){if(l!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${l}') is invalid.`);if(p.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(s.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(s.prototype,"fatal",{value:!1}),Object.defineProperty(s.prototype,"ignoreBOM",{value:!1}),s.prototype.decode=function(l,p={stream:!1}){if(p.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const g=new Uint8Array(l);let w=0;const u=g.length,A=[];for(;w<u;){const S=g[w++];if(S===0)break;if((S&128)===0)A.push(S);else if((S&224)===192){const D=g[w++]&63;A.push((S&31)<<6|D)}else if((S&240)===224){const D=g[w++]&63,z=g[w++]&63;A.push((S&31)<<12|D<<6|z)}else if((S&248)===240){const D=g[w++]&63,z=g[w++]&63,$=g[w++]&63;let O=(S&7)<<18|D<<12|z<<6|$;O>65535&&(O-=65536,A.push(O>>>10&1023|55296),O=56320|O&1023),A.push(O)}}return String.fromCharCode.apply(null,A)},n.TextEncoder=t,n.TextDecoder=s})(typeof window!="undefined"?window:typeof self!="undefined"?self:globalThis);const decoder$2=new TextDecoder("utf-8");function decode$6(n){return decoder$2.decode(n)}const encoder$2=new TextEncoder;function encode$3(n){return encoder$2.encode(n)}const defaultByteLength$2=1024*8;class IOBuffer$4{constructor(t=defaultByteLength$2,s={}){let l=!1;typeof t=="number"?t=new ArrayBuffer(t):(l=!0,this.lastWrittenByte=t.byteLength);const p=s.offset?s.offset>>>0:0,g=t.byteLength-p;let w=p;(ArrayBuffer.isView(t)||t instanceof IOBuffer$4)&&(t.byteLength!==t.buffer.byteLength&&(w=t.byteOffset+p),t=t.buffer),l?this.lastWrittenByte=g:this.lastWrittenByte=0,this.buffer=t,this.length=g,this.byteLength=g,this.byteOffset=w,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,w,g),this._mark=0,this._marks=[]}available(t=1){return this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t=1){return this.offset+=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(t===void 0)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t=1){if(!this.available(t)){const l=(this.offset+t)*2,p=new Uint8Array(l);p.set(new Uint8Array(this.buffer)),this.buffer=p.buffer,this.length=this.byteLength=l,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t=1){const s=new Uint8Array(t);for(let l=0;l<t;l++)s[l]=this.readByte();return s}readInt16(){const t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){const t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){const t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){const t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){const t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){const t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readBigInt64(){const t=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,t}readBigUint64(){const t=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t=1){let s="";for(let l=0;l<t;l++)s+=this.readChar();return s}readUtf8(t=1){return decode$6(this.readBytes(t))}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(let s=0;s<t.length;s++)this._data.setUint8(this.offset++,t[s]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(t){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(t){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(let s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));return this}writeUtf8(t){return this.writeBytes(encode$3(t))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}/*! pako 2.0.4 https://github.com/nodeca/pako @license (MIT AND Zlib) */const Z_FIXED$1=4,Z_BINARY=0,Z_TEXT=1,Z_UNKNOWN$1=2;function zero$1(n){let t=n.length;for(;--t>=0;)n[t]=0}const STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,MIN_MATCH$1=3,MAX_MATCH$1=258,LENGTH_CODES$1=29,LITERALS$1=256,L_CODES$1=LITERALS$1+1+LENGTH_CODES$1,D_CODES$1=30,BL_CODES$1=19,HEAP_SIZE$1=2*L_CODES$1+1,MAX_BITS$1=15,Buf_size=16,MAX_BL_BITS=7,END_BLOCK=256,REP_3_6=16,REPZ_3_10=17,REPZ_11_138=18,extra_lbits=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),extra_dbits=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),extra_blbits=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),bl_order=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),DIST_CODE_LEN=512,static_ltree=new Array((L_CODES$1+2)*2);zero$1(static_ltree);const static_dtree=new Array(D_CODES$1*2);zero$1(static_dtree);const _dist_code=new Array(DIST_CODE_LEN);zero$1(_dist_code);const _length_code=new Array(MAX_MATCH$1-MIN_MATCH$1+1);zero$1(_length_code);const base_length=new Array(LENGTH_CODES$1);zero$1(base_length);const base_dist=new Array(D_CODES$1);zero$1(base_dist);function StaticTreeDesc(n,t,s,l,p){this.static_tree=n,this.extra_bits=t,this.extra_base=s,this.elems=l,this.max_length=p,this.has_stree=n&&n.length}let static_l_desc,static_d_desc,static_bl_desc;function TreeDesc(n,t){this.dyn_tree=n,this.max_code=0,this.stat_desc=t}const d_code=n=>n<256?_dist_code[n]:_dist_code[256+(n>>>7)],put_short=(n,t)=>{n.pending_buf[n.pending++]=t&255,n.pending_buf[n.pending++]=t>>>8&255},send_bits=(n,t,s)=>{n.bi_valid>Buf_size-s?(n.bi_buf|=t<<n.bi_valid&65535,put_short(n,n.bi_buf),n.bi_buf=t>>Buf_size-n.bi_valid,n.bi_valid+=s-Buf_size):(n.bi_buf|=t<<n.bi_valid&65535,n.bi_valid+=s)},send_code=(n,t,s)=>{send_bits(n,s[t*2],s[t*2+1])},bi_reverse=(n,t)=>{let s=0;do s|=n&1,n>>>=1,s<<=1;while(--t>0);return s>>>1},bi_flush=n=>{n.bi_valid===16?(put_short(n,n.bi_buf),n.bi_buf=0,n.bi_valid=0):n.bi_valid>=8&&(n.pending_buf[n.pending++]=n.bi_buf&255,n.bi_buf>>=8,n.bi_valid-=8)},gen_bitlen=(n,t)=>{const s=t.dyn_tree,l=t.max_code,p=t.stat_desc.static_tree,g=t.stat_desc.has_stree,w=t.stat_desc.extra_bits,u=t.stat_desc.extra_base,A=t.stat_desc.max_length;let S,D,z,$,O,q,K=0;for($=0;$<=MAX_BITS$1;$++)n.bl_count[$]=0;for(s[n.heap[n.heap_max]*2+1]=0,S=n.heap_max+1;S<HEAP_SIZE$1;S++)D=n.heap[S],$=s[s[D*2+1]*2+1]+1,$>A&&($=A,K++),s[D*2+1]=$,!(D>l)&&(n.bl_count[$]++,O=0,D>=u&&(O=w[D-u]),q=s[D*2],n.opt_len+=q*($+O),g&&(n.static_len+=q*(p[D*2+1]+O)));if(K!==0){do{for($=A-1;n.bl_count[$]===0;)$--;n.bl_count[$]--,n.bl_count[$+1]+=2,n.bl_count[A]--,K-=2}while(K>0);for($=A;$!==0;$--)for(D=n.bl_count[$];D!==0;)z=n.heap[--S],!(z>l)&&(s[z*2+1]!==$&&(n.opt_len+=($-s[z*2+1])*s[z*2],s[z*2+1]=$),D--)}},gen_codes=(n,t,s)=>{const l=new Array(MAX_BITS$1+1);let p=0,g,w;for(g=1;g<=MAX_BITS$1;g++)l[g]=p=p+s[g-1]<<1;for(w=0;w<=t;w++){let u=n[w*2+1];u!==0&&(n[w*2]=bi_reverse(l[u]++,u))}},tr_static_init=()=>{let n,t,s,l,p;const g=new Array(MAX_BITS$1+1);for(s=0,l=0;l<LENGTH_CODES$1-1;l++)for(base_length[l]=s,n=0;n<1<<extra_lbits[l];n++)_length_code[s++]=l;for(_length_code[s-1]=l,p=0,l=0;l<16;l++)for(base_dist[l]=p,n=0;n<1<<extra_dbits[l];n++)_dist_code[p++]=l;for(p>>=7;l<D_CODES$1;l++)for(base_dist[l]=p<<7,n=0;n<1<<extra_dbits[l]-7;n++)_dist_code[256+p++]=l;for(t=0;t<=MAX_BITS$1;t++)g[t]=0;for(n=0;n<=143;)static_ltree[n*2+1]=8,n++,g[8]++;for(;n<=255;)static_ltree[n*2+1]=9,n++,g[9]++;for(;n<=279;)static_ltree[n*2+1]=7,n++,g[7]++;for(;n<=287;)static_ltree[n*2+1]=8,n++,g[8]++;for(gen_codes(static_ltree,L_CODES$1+1,g),n=0;n<D_CODES$1;n++)static_dtree[n*2+1]=5,static_dtree[n*2]=bi_reverse(n,5);static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS$1+1,L_CODES$1,MAX_BITS$1),static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES$1,MAX_BITS$1),static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES$1,MAX_BL_BITS)},init_block=n=>{let t;for(t=0;t<L_CODES$1;t++)n.dyn_ltree[t*2]=0;for(t=0;t<D_CODES$1;t++)n.dyn_dtree[t*2]=0;for(t=0;t<BL_CODES$1;t++)n.bl_tree[t*2]=0;n.dyn_ltree[END_BLOCK*2]=1,n.opt_len=n.static_len=0,n.last_lit=n.matches=0},bi_windup=n=>{n.bi_valid>8?put_short(n,n.bi_buf):n.bi_valid>0&&(n.pending_buf[n.pending++]=n.bi_buf),n.bi_buf=0,n.bi_valid=0},copy_block=(n,t,s,l)=>{bi_windup(n),l&&(put_short(n,s),put_short(n,~s)),n.pending_buf.set(n.window.subarray(t,t+s),n.pending),n.pending+=s},smaller=(n,t,s,l)=>{const p=t*2,g=s*2;return n[p]<n[g]||n[p]===n[g]&&l[t]<=l[s]},pqdownheap=(n,t,s)=>{const l=n.heap[s];let p=s<<1;for(;p<=n.heap_len&&(p<n.heap_len&&smaller(t,n.heap[p+1],n.heap[p],n.depth)&&p++,!smaller(t,l,n.heap[p],n.depth));)n.heap[s]=n.heap[p],s=p,p<<=1;n.heap[s]=l},compress_block=(n,t,s)=>{let l,p,g=0,w,u;if(n.last_lit!==0)do l=n.pending_buf[n.d_buf+g*2]<<8|n.pending_buf[n.d_buf+g*2+1],p=n.pending_buf[n.l_buf+g],g++,l===0?send_code(n,p,t):(w=_length_code[p],send_code(n,w+LITERALS$1+1,t),u=extra_lbits[w],u!==0&&(p-=base_length[w],send_bits(n,p,u)),l--,w=d_code(l),send_code(n,w,s),u=extra_dbits[w],u!==0&&(l-=base_dist[w],send_bits(n,l,u)));while(g<n.last_lit);send_code(n,END_BLOCK,t)},build_tree=(n,t)=>{const s=t.dyn_tree,l=t.stat_desc.static_tree,p=t.stat_desc.has_stree,g=t.stat_desc.elems;let w,u,A=-1,S;for(n.heap_len=0,n.heap_max=HEAP_SIZE$1,w=0;w<g;w++)s[w*2]!==0?(n.heap[++n.heap_len]=A=w,n.depth[w]=0):s[w*2+1]=0;for(;n.heap_len<2;)S=n.heap[++n.heap_len]=A<2?++A:0,s[S*2]=1,n.depth[S]=0,n.opt_len--,p&&(n.static_len-=l[S*2+1]);for(t.max_code=A,w=n.heap_len>>1;w>=1;w--)pqdownheap(n,s,w);S=g;do w=n.heap[1],n.heap[1]=n.heap[n.heap_len--],pqdownheap(n,s,1),u=n.heap[1],n.heap[--n.heap_max]=w,n.heap[--n.heap_max]=u,s[S*2]=s[w*2]+s[u*2],n.depth[S]=(n.depth[w]>=n.depth[u]?n.depth[w]:n.depth[u])+1,s[w*2+1]=s[u*2+1]=S,n.heap[1]=S++,pqdownheap(n,s,1);while(n.heap_len>=2);n.heap[--n.heap_max]=n.heap[1],gen_bitlen(n,t),gen_codes(s,A,n.bl_count)},scan_tree=(n,t,s)=>{let l,p=-1,g,w=t[0*2+1],u=0,A=7,S=4;for(w===0&&(A=138,S=3),t[(s+1)*2+1]=65535,l=0;l<=s;l++)g=w,w=t[(l+1)*2+1],!(++u<A&&g===w)&&(u<S?n.bl_tree[g*2]+=u:g!==0?(g!==p&&n.bl_tree[g*2]++,n.bl_tree[REP_3_6*2]++):u<=10?n.bl_tree[REPZ_3_10*2]++:n.bl_tree[REPZ_11_138*2]++,u=0,p=g,w===0?(A=138,S=3):g===w?(A=6,S=3):(A=7,S=4))},send_tree=(n,t,s)=>{let l,p=-1,g,w=t[0*2+1],u=0,A=7,S=4;for(w===0&&(A=138,S=3),l=0;l<=s;l++)if(g=w,w=t[(l+1)*2+1],!(++u<A&&g===w)){if(u<S)do send_code(n,g,n.bl_tree);while(--u!==0);else g!==0?(g!==p&&(send_code(n,g,n.bl_tree),u--),send_code(n,REP_3_6,n.bl_tree),send_bits(n,u-3,2)):u<=10?(send_code(n,REPZ_3_10,n.bl_tree),send_bits(n,u-3,3)):(send_code(n,REPZ_11_138,n.bl_tree),send_bits(n,u-11,7));u=0,p=g,w===0?(A=138,S=3):g===w?(A=6,S=3):(A=7,S=4)}},build_bl_tree=n=>{let t;for(scan_tree(n,n.dyn_ltree,n.l_desc.max_code),scan_tree(n,n.dyn_dtree,n.d_desc.max_code),build_tree(n,n.bl_desc),t=BL_CODES$1-1;t>=3&&n.bl_tree[bl_order[t]*2+1]===0;t--);return n.opt_len+=3*(t+1)+5+5+4,t},send_all_trees=(n,t,s,l)=>{let p;for(send_bits(n,t-257,5),send_bits(n,s-1,5),send_bits(n,l-4,4),p=0;p<l;p++)send_bits(n,n.bl_tree[bl_order[p]*2+1],3);send_tree(n,n.dyn_ltree,t-1),send_tree(n,n.dyn_dtree,s-1)},detect_data_type=n=>{let t=4093624447,s;for(s=0;s<=31;s++,t>>>=1)if(t&1&&n.dyn_ltree[s*2]!==0)return Z_BINARY;if(n.dyn_ltree[9*2]!==0||n.dyn_ltree[10*2]!==0||n.dyn_ltree[13*2]!==0)return Z_TEXT;for(s=32;s<LITERALS$1;s++)if(n.dyn_ltree[s*2]!==0)return Z_TEXT;return Z_BINARY};let static_init_done=!1;const _tr_init$1=n=>{static_init_done||(tr_static_init(),static_init_done=!0),n.l_desc=new TreeDesc(n.dyn_ltree,static_l_desc),n.d_desc=new TreeDesc(n.dyn_dtree,static_d_desc),n.bl_desc=new TreeDesc(n.bl_tree,static_bl_desc),n.bi_buf=0,n.bi_valid=0,init_block(n)},_tr_stored_block$1=(n,t,s,l)=>{send_bits(n,(STORED_BLOCK<<1)+(l?1:0),3),copy_block(n,t,s,!0)},_tr_align$1=n=>{send_bits(n,STATIC_TREES<<1,3),send_code(n,END_BLOCK,static_ltree),bi_flush(n)},_tr_flush_block$1=(n,t,s,l)=>{let p,g,w=0;n.level>0?(n.strm.data_type===Z_UNKNOWN$1&&(n.strm.data_type=detect_data_type(n)),build_tree(n,n.l_desc),build_tree(n,n.d_desc),w=build_bl_tree(n),p=n.opt_len+3+7>>>3,g=n.static_len+3+7>>>3,g<=p&&(p=g)):p=g=s+5,s+4<=p&&t!==-1?_tr_stored_block$1(n,t,s,l):n.strategy===Z_FIXED$1||g===p?(send_bits(n,(STATIC_TREES<<1)+(l?1:0),3),compress_block(n,static_ltree,static_dtree)):(send_bits(n,(DYN_TREES<<1)+(l?1:0),3),send_all_trees(n,n.l_desc.max_code+1,n.d_desc.max_code+1,w+1),compress_block(n,n.dyn_ltree,n.dyn_dtree)),init_block(n),l&&bi_windup(n)},_tr_tally$1=(n,t,s)=>(n.pending_buf[n.d_buf+n.last_lit*2]=t>>>8&255,n.pending_buf[n.d_buf+n.last_lit*2+1]=t&255,n.pending_buf[n.l_buf+n.last_lit]=s&255,n.last_lit++,t===0?n.dyn_ltree[s*2]++:(n.matches++,t--,n.dyn_ltree[(_length_code[s]+LITERALS$1+1)*2]++,n.dyn_dtree[d_code(t)*2]++),n.last_lit===n.lit_bufsize-1);var _tr_init_1=_tr_init$1,_tr_stored_block_1=_tr_stored_block$1,_tr_flush_block_1=_tr_flush_block$1,_tr_tally_1=_tr_tally$1,_tr_align_1=_tr_align$1,trees={_tr_init:_tr_init_1,_tr_stored_block:_tr_stored_block_1,_tr_flush_block:_tr_flush_block_1,_tr_tally:_tr_tally_1,_tr_align:_tr_align_1};const adler32=(n,t,s,l)=>{let p=n&65535|0,g=n>>>16&65535|0,w=0;for(;s!==0;){w=s>2e3?2e3:s,s-=w;do p=p+t[l++]|0,g=g+p|0;while(--w);p%=65521,g%=65521}return p|g<<16|0};var adler32_1=adler32;const makeTable=()=>{let n,t=[];for(var s=0;s<256;s++){n=s;for(var l=0;l<8;l++)n=n&1?3988292384^n>>>1:n>>>1;t[s]=n}return t},crcTable$1=new Uint32Array(makeTable()),crc32=(n,t,s,l)=>{const p=crcTable$1,g=l+s;n^=-1;for(let w=l;w<g;w++)n=n>>>8^p[(n^t[w])&255];return n^-1};var crc32_1=crc32,messages={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},constants$2$1={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init,_tr_stored_block,_tr_flush_block,_tr_tally,_tr_align}=trees,{Z_NO_FLUSH:Z_NO_FLUSH$2,Z_PARTIAL_FLUSH,Z_FULL_FLUSH:Z_FULL_FLUSH$1,Z_FINISH:Z_FINISH$3,Z_BLOCK:Z_BLOCK$1,Z_OK:Z_OK$3,Z_STREAM_END:Z_STREAM_END$3,Z_STREAM_ERROR:Z_STREAM_ERROR$2,Z_DATA_ERROR:Z_DATA_ERROR$2,Z_BUF_ERROR:Z_BUF_ERROR$1,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$1,Z_FILTERED,Z_HUFFMAN_ONLY,Z_RLE,Z_FIXED,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY$1,Z_UNKNOWN,Z_DEFLATED:Z_DEFLATED$2}=constants$2$1,MAX_MEM_LEVEL=9,MAX_WBITS$1=15,DEF_MEM_LEVEL=8,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,MIN_MATCH=3,MAX_MATCH=258,MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1,PRESET_DICT=32,INIT_STATE=42,EXTRA_STATE=69,NAME_STATE=73,COMMENT_STATE=91,HCRC_STATE=103,BUSY_STATE=113,FINISH_STATE=666,BS_NEED_MORE=1,BS_BLOCK_DONE=2,BS_FINISH_STARTED=3,BS_FINISH_DONE=4,OS_CODE=3,err=(n,t)=>(n.msg=messages[t],t),rank=n=>(n<<1)-(n>4?9:0),zero=n=>{let t=n.length;for(;--t>=0;)n[t]=0};let HASH_ZLIB=(n,t,s)=>(t<<n.hash_shift^s)&n.hash_mask,HASH=HASH_ZLIB;const flush_pending=n=>{const t=n.state;let s=t.pending;s>n.avail_out&&(s=n.avail_out),s!==0&&(n.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+s),n.next_out),n.next_out+=s,t.pending_out+=s,n.total_out+=s,n.avail_out-=s,t.pending-=s,t.pending===0&&(t.pending_out=0))},flush_block_only=(n,t)=>{_tr_flush_block(n,n.block_start>=0?n.block_start:-1,n.strstart-n.block_start,t),n.block_start=n.strstart,flush_pending(n.strm)},put_byte=(n,t)=>{n.pending_buf[n.pending++]=t},putShortMSB=(n,t)=>{n.pending_buf[n.pending++]=t>>>8&255,n.pending_buf[n.pending++]=t&255},read_buf=(n,t,s,l)=>{let p=n.avail_in;return p>l&&(p=l),p===0?0:(n.avail_in-=p,t.set(n.input.subarray(n.next_in,n.next_in+p),s),n.state.wrap===1?n.adler=adler32_1(n.adler,t,p,s):n.state.wrap===2&&(n.adler=crc32_1(n.adler,t,p,s)),n.next_in+=p,n.total_in+=p,p)},longest_match=(n,t)=>{let s=n.max_chain_length,l=n.strstart,p,g,w=n.prev_length,u=n.nice_match;const A=n.strstart>n.w_size-MIN_LOOKAHEAD?n.strstart-(n.w_size-MIN_LOOKAHEAD):0,S=n.window,D=n.w_mask,z=n.prev,$=n.strstart+MAX_MATCH;let O=S[l+w-1],q=S[l+w];n.prev_length>=n.good_match&&(s>>=2),u>n.lookahead&&(u=n.lookahead);do if(p=t,!(S[p+w]!==q||S[p+w-1]!==O||S[p]!==S[l]||S[++p]!==S[l+1])){l+=2,p++;do;while(S[++l]===S[++p]&&S[++l]===S[++p]&&S[++l]===S[++p]&&S[++l]===S[++p]&&S[++l]===S[++p]&&S[++l]===S[++p]&&S[++l]===S[++p]&&S[++l]===S[++p]&&l<$);if(g=MAX_MATCH-($-l),l=$-MAX_MATCH,g>w){if(n.match_start=t,w=g,g>=u)break;O=S[l+w-1],q=S[l+w]}}while((t=z[t&D])>A&&--s!==0);return w<=n.lookahead?w:n.lookahead},fill_window=n=>{const t=n.w_size;let s,l,p,g,w;do{if(g=n.window_size-n.lookahead-n.strstart,n.strstart>=t+(t-MIN_LOOKAHEAD)){n.window.set(n.window.subarray(t,t+t),0),n.match_start-=t,n.strstart-=t,n.block_start-=t,l=n.hash_size,s=l;do p=n.head[--s],n.head[s]=p>=t?p-t:0;while(--l);l=t,s=l;do p=n.prev[--s],n.prev[s]=p>=t?p-t:0;while(--l);g+=t}if(n.strm.avail_in===0)break;if(l=read_buf(n.strm,n.window,n.strstart+n.lookahead,g),n.lookahead+=l,n.lookahead+n.insert>=MIN_MATCH)for(w=n.strstart-n.insert,n.ins_h=n.window[w],n.ins_h=HASH(n,n.ins_h,n.window[w+1]);n.insert&&(n.ins_h=HASH(n,n.ins_h,n.window[w+MIN_MATCH-1]),n.prev[w&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=w,w++,n.insert--,!(n.lookahead+n.insert<MIN_MATCH)););}while(n.lookahead<MIN_LOOKAHEAD&&n.strm.avail_in!==0)},deflate_stored=(n,t)=>{let s=65535;for(s>n.pending_buf_size-5&&(s=n.pending_buf_size-5);;){if(n.lookahead<=1){if(fill_window(n),n.lookahead===0&&t===Z_NO_FLUSH$2)return BS_NEED_MORE;if(n.lookahead===0)break}n.strstart+=n.lookahead,n.lookahead=0;const l=n.block_start+s;if((n.strstart===0||n.strstart>=l)&&(n.lookahead=n.strstart-l,n.strstart=l,flush_block_only(n,!1),n.strm.avail_out===0)||n.strstart-n.block_start>=n.w_size-MIN_LOOKAHEAD&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}return n.insert=0,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):(n.strstart>n.block_start&&(flush_block_only(n,!1),n.strm.avail_out===0),BS_NEED_MORE)},deflate_fast=(n,t)=>{let s,l;for(;;){if(n.lookahead<MIN_LOOKAHEAD){if(fill_window(n),n.lookahead<MIN_LOOKAHEAD&&t===Z_NO_FLUSH$2)return BS_NEED_MORE;if(n.lookahead===0)break}if(s=0,n.lookahead>=MIN_MATCH&&(n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+MIN_MATCH-1]),s=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart),s!==0&&n.strstart-s<=n.w_size-MIN_LOOKAHEAD&&(n.match_length=longest_match(n,s)),n.match_length>=MIN_MATCH)if(l=_tr_tally(n,n.strstart-n.match_start,n.match_length-MIN_MATCH),n.lookahead-=n.match_length,n.match_length<=n.max_lazy_match&&n.lookahead>=MIN_MATCH){n.match_length--;do n.strstart++,n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+MIN_MATCH-1]),s=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart;while(--n.match_length!==0);n.strstart++}else n.strstart+=n.match_length,n.match_length=0,n.ins_h=n.window[n.strstart],n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+1]);else l=_tr_tally(n,0,n.window[n.strstart]),n.lookahead--,n.strstart++;if(l&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}return n.insert=n.strstart<MIN_MATCH-1?n.strstart:MIN_MATCH-1,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):n.last_lit&&(flush_block_only(n,!1),n.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_slow=(n,t)=>{let s,l,p;for(;;){if(n.lookahead<MIN_LOOKAHEAD){if(fill_window(n),n.lookahead<MIN_LOOKAHEAD&&t===Z_NO_FLUSH$2)return BS_NEED_MORE;if(n.lookahead===0)break}if(s=0,n.lookahead>=MIN_MATCH&&(n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+MIN_MATCH-1]),s=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart),n.prev_length=n.match_length,n.prev_match=n.match_start,n.match_length=MIN_MATCH-1,s!==0&&n.prev_length<n.max_lazy_match&&n.strstart-s<=n.w_size-MIN_LOOKAHEAD&&(n.match_length=longest_match(n,s),n.match_length<=5&&(n.strategy===Z_FILTERED||n.match_length===MIN_MATCH&&n.strstart-n.match_start>4096)&&(n.match_length=MIN_MATCH-1)),n.prev_length>=MIN_MATCH&&n.match_length<=n.prev_length){p=n.strstart+n.lookahead-MIN_MATCH,l=_tr_tally(n,n.strstart-1-n.prev_match,n.prev_length-MIN_MATCH),n.lookahead-=n.prev_length-1,n.prev_length-=2;do++n.strstart<=p&&(n.ins_h=HASH(n,n.ins_h,n.window[n.strstart+MIN_MATCH-1]),s=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart);while(--n.prev_length!==0);if(n.match_available=0,n.match_length=MIN_MATCH-1,n.strstart++,l&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}else if(n.match_available){if(l=_tr_tally(n,0,n.window[n.strstart-1]),l&&flush_block_only(n,!1),n.strstart++,n.lookahead--,n.strm.avail_out===0)return BS_NEED_MORE}else n.match_available=1,n.strstart++,n.lookahead--}return n.match_available&&(l=_tr_tally(n,0,n.window[n.strstart-1]),n.match_available=0),n.insert=n.strstart<MIN_MATCH-1?n.strstart:MIN_MATCH-1,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):n.last_lit&&(flush_block_only(n,!1),n.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_rle=(n,t)=>{let s,l,p,g;const w=n.window;for(;;){if(n.lookahead<=MAX_MATCH){if(fill_window(n),n.lookahead<=MAX_MATCH&&t===Z_NO_FLUSH$2)return BS_NEED_MORE;if(n.lookahead===0)break}if(n.match_length=0,n.lookahead>=MIN_MATCH&&n.strstart>0&&(p=n.strstart-1,l=w[p],l===w[++p]&&l===w[++p]&&l===w[++p])){g=n.strstart+MAX_MATCH;do;while(l===w[++p]&&l===w[++p]&&l===w[++p]&&l===w[++p]&&l===w[++p]&&l===w[++p]&&l===w[++p]&&l===w[++p]&&p<g);n.match_length=MAX_MATCH-(g-p),n.match_length>n.lookahead&&(n.match_length=n.lookahead)}if(n.match_length>=MIN_MATCH?(s=_tr_tally(n,1,n.match_length-MIN_MATCH),n.lookahead-=n.match_length,n.strstart+=n.match_length,n.match_length=0):(s=_tr_tally(n,0,n.window[n.strstart]),n.lookahead--,n.strstart++),s&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}return n.insert=0,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):n.last_lit&&(flush_block_only(n,!1),n.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_huff=(n,t)=>{let s;for(;;){if(n.lookahead===0&&(fill_window(n),n.lookahead===0)){if(t===Z_NO_FLUSH$2)return BS_NEED_MORE;break}if(n.match_length=0,s=_tr_tally(n,0,n.window[n.strstart]),n.lookahead--,n.strstart++,s&&(flush_block_only(n,!1),n.strm.avail_out===0))return BS_NEED_MORE}return n.insert=0,t===Z_FINISH$3?(flush_block_only(n,!0),n.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):n.last_lit&&(flush_block_only(n,!1),n.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE};function Config(n,t,s,l,p){this.good_length=n,this.max_lazy=t,this.nice_length=s,this.max_chain=l,this.func=p}const configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],lm_init=n=>{n.window_size=2*n.w_size,zero(n.head),n.max_lazy_match=configuration_table[n.level].max_lazy,n.good_match=configuration_table[n.level].good_length,n.nice_match=configuration_table[n.level].nice_length,n.max_chain_length=configuration_table[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=MIN_MATCH-1,n.match_available=0,n.ins_h=0};function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Z_DEFLATED$2,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(HEAP_SIZE*2),this.dyn_dtree=new Uint16Array((2*D_CODES+1)*2),this.bl_tree=new Uint16Array((2*BL_CODES+1)*2),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(MAX_BITS+1),this.heap=new Uint16Array(2*L_CODES+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*L_CODES+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const deflateResetKeep=n=>{if(!n||!n.state)return err(n,Z_STREAM_ERROR$2);n.total_in=n.total_out=0,n.data_type=Z_UNKNOWN;const t=n.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?INIT_STATE:BUSY_STATE,n.adler=t.wrap===2?0:1,t.last_flush=Z_NO_FLUSH$2,_tr_init(t),Z_OK$3},deflateReset=n=>{const t=deflateResetKeep(n);return t===Z_OK$3&&lm_init(n.state),t},deflateSetHeader=(n,t)=>!n||!n.state||n.state.wrap!==2?Z_STREAM_ERROR$2:(n.state.gzhead=t,Z_OK$3),deflateInit2=(n,t,s,l,p,g)=>{if(!n)return Z_STREAM_ERROR$2;let w=1;if(t===Z_DEFAULT_COMPRESSION$1&&(t=6),l<0?(w=0,l=-l):l>15&&(w=2,l-=16),p<1||p>MAX_MEM_LEVEL||s!==Z_DEFLATED$2||l<8||l>15||t<0||t>9||g<0||g>Z_FIXED)return err(n,Z_STREAM_ERROR$2);l===8&&(l=9);const u=new DeflateState;return n.state=u,u.strm=n,u.wrap=w,u.gzhead=null,u.w_bits=l,u.w_size=1<<u.w_bits,u.w_mask=u.w_size-1,u.hash_bits=p+7,u.hash_size=1<<u.hash_bits,u.hash_mask=u.hash_size-1,u.hash_shift=~~((u.hash_bits+MIN_MATCH-1)/MIN_MATCH),u.window=new Uint8Array(u.w_size*2),u.head=new Uint16Array(u.hash_size),u.prev=new Uint16Array(u.w_size),u.lit_bufsize=1<<p+6,u.pending_buf_size=u.lit_bufsize*4,u.pending_buf=new Uint8Array(u.pending_buf_size),u.d_buf=1*u.lit_bufsize,u.l_buf=(1+2)*u.lit_bufsize,u.level=t,u.strategy=g,u.method=s,deflateReset(n)},deflateInit=(n,t)=>deflateInit2(n,t,Z_DEFLATED$2,MAX_WBITS$1,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY$1),deflate$2=(n,t)=>{let s,l;if(!n||!n.state||t>Z_BLOCK$1||t<0)return n?err(n,Z_STREAM_ERROR$2):Z_STREAM_ERROR$2;const p=n.state;if(!n.output||!n.input&&n.avail_in!==0||p.status===FINISH_STATE&&t!==Z_FINISH$3)return err(n,n.avail_out===0?Z_BUF_ERROR$1:Z_STREAM_ERROR$2);p.strm=n;const g=p.last_flush;if(p.last_flush=t,p.status===INIT_STATE)if(p.wrap===2)n.adler=0,put_byte(p,31),put_byte(p,139),put_byte(p,8),p.gzhead?(put_byte(p,(p.gzhead.text?1:0)+(p.gzhead.hcrc?2:0)+(p.gzhead.extra?4:0)+(p.gzhead.name?8:0)+(p.gzhead.comment?16:0)),put_byte(p,p.gzhead.time&255),put_byte(p,p.gzhead.time>>8&255),put_byte(p,p.gzhead.time>>16&255),put_byte(p,p.gzhead.time>>24&255),put_byte(p,p.level===9?2:p.strategy>=Z_HUFFMAN_ONLY||p.level<2?4:0),put_byte(p,p.gzhead.os&255),p.gzhead.extra&&p.gzhead.extra.length&&(put_byte(p,p.gzhead.extra.length&255),put_byte(p,p.gzhead.extra.length>>8&255)),p.gzhead.hcrc&&(n.adler=crc32_1(n.adler,p.pending_buf,p.pending,0)),p.gzindex=0,p.status=EXTRA_STATE):(put_byte(p,0),put_byte(p,0),put_byte(p,0),put_byte(p,0),put_byte(p,0),put_byte(p,p.level===9?2:p.strategy>=Z_HUFFMAN_ONLY||p.level<2?4:0),put_byte(p,OS_CODE),p.status=BUSY_STATE);else{let w=Z_DEFLATED$2+(p.w_bits-8<<4)<<8,u=-1;p.strategy>=Z_HUFFMAN_ONLY||p.level<2?u=0:p.level<6?u=1:p.level===6?u=2:u=3,w|=u<<6,p.strstart!==0&&(w|=PRESET_DICT),w+=31-w%31,p.status=BUSY_STATE,putShortMSB(p,w),p.strstart!==0&&(putShortMSB(p,n.adler>>>16),putShortMSB(p,n.adler&65535)),n.adler=1}if(p.status===EXTRA_STATE)if(p.gzhead.extra){for(s=p.pending;p.gzindex<(p.gzhead.extra.length&65535)&&!(p.pending===p.pending_buf_size&&(p.gzhead.hcrc&&p.pending>s&&(n.adler=crc32_1(n.adler,p.pending_buf,p.pending-s,s)),flush_pending(n),s=p.pending,p.pending===p.pending_buf_size));)put_byte(p,p.gzhead.extra[p.gzindex]&255),p.gzindex++;p.gzhead.hcrc&&p.pending>s&&(n.adler=crc32_1(n.adler,p.pending_buf,p.pending-s,s)),p.gzindex===p.gzhead.extra.length&&(p.gzindex=0,p.status=NAME_STATE)}else p.status=NAME_STATE;if(p.status===NAME_STATE)if(p.gzhead.name){s=p.pending;do{if(p.pending===p.pending_buf_size&&(p.gzhead.hcrc&&p.pending>s&&(n.adler=crc32_1(n.adler,p.pending_buf,p.pending-s,s)),flush_pending(n),s=p.pending,p.pending===p.pending_buf_size)){l=1;break}p.gzindex<p.gzhead.name.length?l=p.gzhead.name.charCodeAt(p.gzindex++)&255:l=0,put_byte(p,l)}while(l!==0);p.gzhead.hcrc&&p.pending>s&&(n.adler=crc32_1(n.adler,p.pending_buf,p.pending-s,s)),l===0&&(p.gzindex=0,p.status=COMMENT_STATE)}else p.status=COMMENT_STATE;if(p.status===COMMENT_STATE)if(p.gzhead.comment){s=p.pending;do{if(p.pending===p.pending_buf_size&&(p.gzhead.hcrc&&p.pending>s&&(n.adler=crc32_1(n.adler,p.pending_buf,p.pending-s,s)),flush_pending(n),s=p.pending,p.pending===p.pending_buf_size)){l=1;break}p.gzindex<p.gzhead.comment.length?l=p.gzhead.comment.charCodeAt(p.gzindex++)&255:l=0,put_byte(p,l)}while(l!==0);p.gzhead.hcrc&&p.pending>s&&(n.adler=crc32_1(n.adler,p.pending_buf,p.pending-s,s)),l===0&&(p.status=HCRC_STATE)}else p.status=HCRC_STATE;if(p.status===HCRC_STATE&&(p.gzhead.hcrc?(p.pending+2>p.pending_buf_size&&flush_pending(n),p.pending+2<=p.pending_buf_size&&(put_byte(p,n.adler&255),put_byte(p,n.adler>>8&255),n.adler=0,p.status=BUSY_STATE)):p.status=BUSY_STATE),p.pending!==0){if(flush_pending(n),n.avail_out===0)return p.last_flush=-1,Z_OK$3}else if(n.avail_in===0&&rank(t)<=rank(g)&&t!==Z_FINISH$3)return err(n,Z_BUF_ERROR$1);if(p.status===FINISH_STATE&&n.avail_in!==0)return err(n,Z_BUF_ERROR$1);if(n.avail_in!==0||p.lookahead!==0||t!==Z_NO_FLUSH$2&&p.status!==FINISH_STATE){let w=p.strategy===Z_HUFFMAN_ONLY?deflate_huff(p,t):p.strategy===Z_RLE?deflate_rle(p,t):configuration_table[p.level].func(p,t);if((w===BS_FINISH_STARTED||w===BS_FINISH_DONE)&&(p.status=FINISH_STATE),w===BS_NEED_MORE||w===BS_FINISH_STARTED)return n.avail_out===0&&(p.last_flush=-1),Z_OK$3;if(w===BS_BLOCK_DONE&&(t===Z_PARTIAL_FLUSH?_tr_align(p):t!==Z_BLOCK$1&&(_tr_stored_block(p,0,0,!1),t===Z_FULL_FLUSH$1&&(zero(p.head),p.lookahead===0&&(p.strstart=0,p.block_start=0,p.insert=0))),flush_pending(n),n.avail_out===0))return p.last_flush=-1,Z_OK$3}return t!==Z_FINISH$3?Z_OK$3:p.wrap<=0?Z_STREAM_END$3:(p.wrap===2?(put_byte(p,n.adler&255),put_byte(p,n.adler>>8&255),put_byte(p,n.adler>>16&255),put_byte(p,n.adler>>24&255),put_byte(p,n.total_in&255),put_byte(p,n.total_in>>8&255),put_byte(p,n.total_in>>16&255),put_byte(p,n.total_in>>24&255)):(putShortMSB(p,n.adler>>>16),putShortMSB(p,n.adler&65535)),flush_pending(n),p.wrap>0&&(p.wrap=-p.wrap),p.pending!==0?Z_OK$3:Z_STREAM_END$3)},deflateEnd=n=>{if(!n||!n.state)return Z_STREAM_ERROR$2;const t=n.state.status;return t!==INIT_STATE&&t!==EXTRA_STATE&&t!==NAME_STATE&&t!==COMMENT_STATE&&t!==HCRC_STATE&&t!==BUSY_STATE&&t!==FINISH_STATE?err(n,Z_STREAM_ERROR$2):(n.state=null,t===BUSY_STATE?err(n,Z_DATA_ERROR$2):Z_OK$3)},deflateSetDictionary=(n,t)=>{let s=t.length;if(!n||!n.state)return Z_STREAM_ERROR$2;const l=n.state,p=l.wrap;if(p===2||p===1&&l.status!==INIT_STATE||l.lookahead)return Z_STREAM_ERROR$2;if(p===1&&(n.adler=adler32_1(n.adler,t,s,0)),l.wrap=0,s>=l.w_size){p===0&&(zero(l.head),l.strstart=0,l.block_start=0,l.insert=0);let A=new Uint8Array(l.w_size);A.set(t.subarray(s-l.w_size,s),0),t=A,s=l.w_size}const g=n.avail_in,w=n.next_in,u=n.input;for(n.avail_in=s,n.next_in=0,n.input=t,fill_window(l);l.lookahead>=MIN_MATCH;){let A=l.strstart,S=l.lookahead-(MIN_MATCH-1);do l.ins_h=HASH(l,l.ins_h,l.window[A+MIN_MATCH-1]),l.prev[A&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=A,A++;while(--S);l.strstart=A,l.lookahead=MIN_MATCH-1,fill_window(l)}return l.strstart+=l.lookahead,l.block_start=l.strstart,l.insert=l.lookahead,l.lookahead=0,l.match_length=l.prev_length=MIN_MATCH-1,l.match_available=0,n.next_in=w,n.input=u,n.avail_in=g,l.wrap=p,Z_OK$3};var deflateInit_1=deflateInit,deflateInit2_1=deflateInit2,deflateReset_1=deflateReset,deflateResetKeep_1=deflateResetKeep,deflateSetHeader_1=deflateSetHeader,deflate_2$1=deflate$2,deflateEnd_1=deflateEnd,deflateSetDictionary_1=deflateSetDictionary,deflateInfo="pako deflate (from Nodeca project)",deflate_1$2={deflateInit:deflateInit_1,deflateInit2:deflateInit2_1,deflateReset:deflateReset_1,deflateResetKeep:deflateResetKeep_1,deflateSetHeader:deflateSetHeader_1,deflate:deflate_2$1,deflateEnd:deflateEnd_1,deflateSetDictionary:deflateSetDictionary_1,deflateInfo};const _has=(n,t)=>Object.prototype.hasOwnProperty.call(n,t);var assign=function(n){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const s=t.shift();if(!!s){if(typeof s!="object")throw new TypeError(s+"must be non-object");for(const l in s)_has(s,l)&&(n[l]=s[l])}}return n},flattenChunks=n=>{let t=0;for(let l=0,p=n.length;l<p;l++)t+=n[l].length;const s=new Uint8Array(t);for(let l=0,p=0,g=n.length;l<g;l++){let w=n[l];s.set(w,p),p+=w.length}return s},common={assign,flattenChunks};let STR_APPLY_UIA_OK=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{STR_APPLY_UIA_OK=!1}const _utf8len=new Uint8Array(256);for(let n=0;n<256;n++)_utf8len[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=n=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(n);let t,s,l,p,g,w=n.length,u=0;for(p=0;p<w;p++)s=n.charCodeAt(p),(s&64512)===55296&&p+1<w&&(l=n.charCodeAt(p+1),(l&64512)===56320&&(s=65536+(s-55296<<10)+(l-56320),p++)),u+=s<128?1:s<2048?2:s<65536?3:4;for(t=new Uint8Array(u),g=0,p=0;g<u;p++)s=n.charCodeAt(p),(s&64512)===55296&&p+1<w&&(l=n.charCodeAt(p+1),(l&64512)===56320&&(s=65536+(s-55296<<10)+(l-56320),p++)),s<128?t[g++]=s:s<2048?(t[g++]=192|s>>>6,t[g++]=128|s&63):s<65536?(t[g++]=224|s>>>12,t[g++]=128|s>>>6&63,t[g++]=128|s&63):(t[g++]=240|s>>>18,t[g++]=128|s>>>12&63,t[g++]=128|s>>>6&63,t[g++]=128|s&63);return t};const buf2binstring=(n,t)=>{if(t<65534&&n.subarray&&STR_APPLY_UIA_OK)return String.fromCharCode.apply(null,n.length===t?n:n.subarray(0,t));let s="";for(let l=0;l<t;l++)s+=String.fromCharCode(n[l]);return s};var buf2string=(n,t)=>{const s=t||n.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(n.subarray(0,t));let l,p;const g=new Array(s*2);for(p=0,l=0;l<s;){let w=n[l++];if(w<128){g[p++]=w;continue}let u=_utf8len[w];if(u>4){g[p++]=65533,l+=u-1;continue}for(w&=u===2?31:u===3?15:7;u>1&&l<s;)w=w<<6|n[l++]&63,u--;if(u>1){g[p++]=65533;continue}w<65536?g[p++]=w:(w-=65536,g[p++]=55296|w>>10&1023,g[p++]=56320|w&1023)}return buf2binstring(g,p)},utf8border=(n,t)=>{t=t||n.length,t>n.length&&(t=n.length);let s=t-1;for(;s>=0&&(n[s]&192)===128;)s--;return s<0||s===0?t:s+_utf8len[n[s]]>t?s:t},strings={string2buf,buf2string,utf8border};function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var zstream=ZStream;const toString$1$1=Object.prototype.toString,{Z_NO_FLUSH:Z_NO_FLUSH$1,Z_SYNC_FLUSH,Z_FULL_FLUSH,Z_FINISH:Z_FINISH$2,Z_OK:Z_OK$2,Z_STREAM_END:Z_STREAM_END$2,Z_DEFAULT_COMPRESSION,Z_DEFAULT_STRATEGY,Z_DEFLATED:Z_DEFLATED$1}=constants$2$1;function Deflate$1(n){this.options=common.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED$1,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY},n||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let s=deflate_1$2.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(s!==Z_OK$2)throw new Error(messages[s]);if(t.header&&deflate_1$2.deflateSetHeader(this.strm,t.header),t.dictionary){let l;if(typeof t.dictionary=="string"?l=strings.string2buf(t.dictionary):toString$1$1.call(t.dictionary)==="[object ArrayBuffer]"?l=new Uint8Array(t.dictionary):l=t.dictionary,s=deflate_1$2.deflateSetDictionary(this.strm,l),s!==Z_OK$2)throw new Error(messages[s]);this._dict_set=!0}}Deflate$1.prototype.push=function(n,t){const s=this.strm,l=this.options.chunkSize;let p,g;if(this.ended)return!1;for(t===~~t?g=t:g=t===!0?Z_FINISH$2:Z_NO_FLUSH$1,typeof n=="string"?s.input=strings.string2buf(n):toString$1$1.call(n)==="[object ArrayBuffer]"?s.input=new Uint8Array(n):s.input=n,s.next_in=0,s.avail_in=s.input.length;;){if(s.avail_out===0&&(s.output=new Uint8Array(l),s.next_out=0,s.avail_out=l),(g===Z_SYNC_FLUSH||g===Z_FULL_FLUSH)&&s.avail_out<=6){this.onData(s.output.subarray(0,s.next_out)),s.avail_out=0;continue}if(p=deflate_1$2.deflate(s,g),p===Z_STREAM_END$2)return s.next_out>0&&this.onData(s.output.subarray(0,s.next_out)),p=deflate_1$2.deflateEnd(this.strm),this.onEnd(p),this.ended=!0,p===Z_OK$2;if(s.avail_out===0){this.onData(s.output);continue}if(g>0&&s.next_out>0){this.onData(s.output.subarray(0,s.next_out)),s.avail_out=0;continue}if(s.avail_in===0)break}return!0};Deflate$1.prototype.onData=function(n){this.chunks.push(n)};Deflate$1.prototype.onEnd=function(n){n===Z_OK$2&&(this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};function deflate$1(n,t){const s=new Deflate$1(t);if(s.push(n,!0),s.err)throw s.msg||messages[s.err];return s.result}function deflateRaw$1(n,t){return t=t||{},t.raw=!0,deflate$1(n,t)}function gzip$1(n,t){return t=t||{},t.gzip=!0,deflate$1(n,t)}var Deflate_1$1=Deflate$1,deflate_2=deflate$1,deflateRaw_1$1=deflateRaw$1,gzip_1$1=gzip$1,constants$1$1=constants$2$1,deflate_1$1={Deflate:Deflate_1$1,deflate:deflate_2,deflateRaw:deflateRaw_1$1,gzip:gzip_1$1,constants:constants$1$1};const BAD$1=30,TYPE$1=12;var inffast=function(t,s){let l,p,g,w,u,A,S,D,z,$,O,q,K,J,Y,fe,ee,re,he,_e,we,oe,be,ie;const ue=t.state;l=t.next_in,be=t.input,p=l+(t.avail_in-5),g=t.next_out,ie=t.output,w=g-(s-t.avail_out),u=g+(t.avail_out-257),A=ue.dmax,S=ue.wsize,D=ue.whave,z=ue.wnext,$=ue.window,O=ue.hold,q=ue.bits,K=ue.lencode,J=ue.distcode,Y=(1<<ue.lenbits)-1,fe=(1<<ue.distbits)-1;e:do{q<15&&(O+=be[l++]<<q,q+=8,O+=be[l++]<<q,q+=8),ee=K[O&Y];t:for(;;){if(re=ee>>>24,O>>>=re,q-=re,re=ee>>>16&255,re===0)ie[g++]=ee&65535;else if(re&16){he=ee&65535,re&=15,re&&(q<re&&(O+=be[l++]<<q,q+=8),he+=O&(1<<re)-1,O>>>=re,q-=re),q<15&&(O+=be[l++]<<q,q+=8,O+=be[l++]<<q,q+=8),ee=J[O&fe];i:for(;;){if(re=ee>>>24,O>>>=re,q-=re,re=ee>>>16&255,re&16){if(_e=ee&65535,re&=15,q<re&&(O+=be[l++]<<q,q+=8,q<re&&(O+=be[l++]<<q,q+=8)),_e+=O&(1<<re)-1,_e>A){t.msg="invalid distance too far back",ue.mode=BAD$1;break e}if(O>>>=re,q-=re,re=g-w,_e>re){if(re=_e-re,re>D&&ue.sane){t.msg="invalid distance too far back",ue.mode=BAD$1;break e}if(we=0,oe=$,z===0){if(we+=S-re,re<he){he-=re;do ie[g++]=$[we++];while(--re);we=g-_e,oe=ie}}else if(z<re){if(we+=S+z-re,re-=z,re<he){he-=re;do ie[g++]=$[we++];while(--re);if(we=0,z<he){re=z,he-=re;do ie[g++]=$[we++];while(--re);we=g-_e,oe=ie}}}else if(we+=z-re,re<he){he-=re;do ie[g++]=$[we++];while(--re);we=g-_e,oe=ie}for(;he>2;)ie[g++]=oe[we++],ie[g++]=oe[we++],ie[g++]=oe[we++],he-=3;he&&(ie[g++]=oe[we++],he>1&&(ie[g++]=oe[we++]))}else{we=g-_e;do ie[g++]=ie[we++],ie[g++]=ie[we++],ie[g++]=ie[we++],he-=3;while(he>2);he&&(ie[g++]=ie[we++],he>1&&(ie[g++]=ie[we++]))}}else if((re&64)===0){ee=J[(ee&65535)+(O&(1<<re)-1)];continue i}else{t.msg="invalid distance code",ue.mode=BAD$1;break e}break}}else if((re&64)===0){ee=K[(ee&65535)+(O&(1<<re)-1)];continue t}else if(re&32){ue.mode=TYPE$1;break e}else{t.msg="invalid literal/length code",ue.mode=BAD$1;break e}break}}while(l<p&&g<u);he=q>>3,l-=he,q-=he<<3,O&=(1<<q)-1,t.next_in=l,t.next_out=g,t.avail_in=l<p?5+(p-l):5-(l-p),t.avail_out=g<u?257+(u-g):257-(g-u),ue.hold=O,ue.bits=q};const MAXBITS=15,ENOUGH_LENS$1=852,ENOUGH_DISTS$1=592,CODES$1=0,LENS$1=1,DISTS$1=2,lbase=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),lext=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),dbase=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),dext=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),inflate_table=(n,t,s,l,p,g,w,u)=>{const A=u.bits;let S=0,D=0,z=0,$=0,O=0,q=0,K=0,J=0,Y=0,fe=0,ee,re,he,_e,we,oe=null,be=0,ie;const ue=new Uint16Array(MAXBITS+1),Ce=new Uint16Array(MAXBITS+1);let Ne=null,it=0,rt,Pt,zt;for(S=0;S<=MAXBITS;S++)ue[S]=0;for(D=0;D<l;D++)ue[t[s+D]]++;for(O=A,$=MAXBITS;$>=1&&ue[$]===0;$--);if(O>$&&(O=$),$===0)return p[g++]=1<<24|64<<16|0,p[g++]=1<<24|64<<16|0,u.bits=1,0;for(z=1;z<$&&ue[z]===0;z++);for(O<z&&(O=z),J=1,S=1;S<=MAXBITS;S++)if(J<<=1,J-=ue[S],J<0)return-1;if(J>0&&(n===CODES$1||$!==1))return-1;for(Ce[1]=0,S=1;S<MAXBITS;S++)Ce[S+1]=Ce[S]+ue[S];for(D=0;D<l;D++)t[s+D]!==0&&(w[Ce[t[s+D]]++]=D);if(n===CODES$1?(oe=Ne=w,ie=19):n===LENS$1?(oe=lbase,be-=257,Ne=lext,it-=257,ie=256):(oe=dbase,Ne=dext,ie=-1),fe=0,D=0,S=z,we=g,q=O,K=0,he=-1,Y=1<<O,_e=Y-1,n===LENS$1&&Y>ENOUGH_LENS$1||n===DISTS$1&&Y>ENOUGH_DISTS$1)return 1;for(;;){rt=S-K,w[D]<ie?(Pt=0,zt=w[D]):w[D]>ie?(Pt=Ne[it+w[D]],zt=oe[be+w[D]]):(Pt=32+64,zt=0),ee=1<<S-K,re=1<<q,z=re;do re-=ee,p[we+(fe>>K)+re]=rt<<24|Pt<<16|zt|0;while(re!==0);for(ee=1<<S-1;fe&ee;)ee>>=1;if(ee!==0?(fe&=ee-1,fe+=ee):fe=0,D++,--ue[S]===0){if(S===$)break;S=t[s+w[D]]}if(S>O&&(fe&_e)!==he){for(K===0&&(K=O),we+=z,q=S-K,J=1<<q;q+K<$&&(J-=ue[q+K],!(J<=0));)q++,J<<=1;if(Y+=1<<q,n===LENS$1&&Y>ENOUGH_LENS$1||n===DISTS$1&&Y>ENOUGH_DISTS$1)return 1;he=fe&_e,p[he]=O<<24|q<<16|we-g|0}}return fe!==0&&(p[we+fe]=S-K<<24|64<<16|0),u.bits=O,0};var inftrees=inflate_table;const CODES=0,LENS=1,DISTS=2,{Z_FINISH:Z_FINISH$1,Z_BLOCK,Z_TREES,Z_OK:Z_OK$1,Z_STREAM_END:Z_STREAM_END$1,Z_NEED_DICT:Z_NEED_DICT$1,Z_STREAM_ERROR:Z_STREAM_ERROR$1,Z_DATA_ERROR:Z_DATA_ERROR$1,Z_MEM_ERROR:Z_MEM_ERROR$1,Z_BUF_ERROR,Z_DEFLATED}=constants$2$1,HEAD=1,FLAGS=2,TIME=3,OS=4,EXLEN=5,EXTRA=6,NAME=7,COMMENT=8,HCRC=9,DICTID=10,DICT=11,TYPE=12,TYPEDO=13,STORED=14,COPY_=15,COPY=16,TABLE=17,LENLENS=18,CODELENS=19,LEN_=20,LEN=21,LENEXT=22,DIST=23,DISTEXT=24,MATCH=25,LIT=26,CHECK=27,LENGTH=28,DONE=29,BAD=30,MEM=31,SYNC=32,ENOUGH_LENS=852,ENOUGH_DISTS=592,MAX_WBITS=15,DEF_WBITS=MAX_WBITS,zswap32=n=>(n>>>24&255)+(n>>>8&65280)+((n&65280)<<8)+((n&255)<<24);function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const inflateResetKeep=n=>{if(!n||!n.state)return Z_STREAM_ERROR$1;const t=n.state;return n.total_in=n.total_out=t.total=0,n.msg="",t.wrap&&(n.adler=t.wrap&1),t.mode=HEAD,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(ENOUGH_LENS),t.distcode=t.distdyn=new Int32Array(ENOUGH_DISTS),t.sane=1,t.back=-1,Z_OK$1},inflateReset=n=>{if(!n||!n.state)return Z_STREAM_ERROR$1;const t=n.state;return t.wsize=0,t.whave=0,t.wnext=0,inflateResetKeep(n)},inflateReset2=(n,t)=>{let s;if(!n||!n.state)return Z_STREAM_ERROR$1;const l=n.state;return t<0?(s=0,t=-t):(s=(t>>4)+1,t<48&&(t&=15)),t&&(t<8||t>15)?Z_STREAM_ERROR$1:(l.window!==null&&l.wbits!==t&&(l.window=null),l.wrap=s,l.wbits=t,inflateReset(n))},inflateInit2=(n,t)=>{if(!n)return Z_STREAM_ERROR$1;const s=new InflateState;n.state=s,s.window=null;const l=inflateReset2(n,t);return l!==Z_OK$1&&(n.state=null),l},inflateInit=n=>inflateInit2(n,DEF_WBITS);let virgin=!0,lenfix,distfix;const fixedtables=n=>{if(virgin){lenfix=new Int32Array(512),distfix=new Int32Array(32);let t=0;for(;t<144;)n.lens[t++]=8;for(;t<256;)n.lens[t++]=9;for(;t<280;)n.lens[t++]=7;for(;t<288;)n.lens[t++]=8;for(inftrees(LENS,n.lens,0,288,lenfix,0,n.work,{bits:9}),t=0;t<32;)n.lens[t++]=5;inftrees(DISTS,n.lens,0,32,distfix,0,n.work,{bits:5}),virgin=!1}n.lencode=lenfix,n.lenbits=9,n.distcode=distfix,n.distbits=5},updatewindow=(n,t,s,l)=>{let p;const g=n.state;return g.window===null&&(g.wsize=1<<g.wbits,g.wnext=0,g.whave=0,g.window=new Uint8Array(g.wsize)),l>=g.wsize?(g.window.set(t.subarray(s-g.wsize,s),0),g.wnext=0,g.whave=g.wsize):(p=g.wsize-g.wnext,p>l&&(p=l),g.window.set(t.subarray(s-l,s-l+p),g.wnext),l-=p,l?(g.window.set(t.subarray(s-l,s),0),g.wnext=l,g.whave=g.wsize):(g.wnext+=p,g.wnext===g.wsize&&(g.wnext=0),g.whave<g.wsize&&(g.whave+=p))),0},inflate$2=(n,t)=>{let s,l,p,g,w,u,A,S,D,z,$,O,q,K,J=0,Y,fe,ee,re,he,_e,we,oe;const be=new Uint8Array(4);let ie,ue;const Ce=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!n||!n.state||!n.output||!n.input&&n.avail_in!==0)return Z_STREAM_ERROR$1;s=n.state,s.mode===TYPE&&(s.mode=TYPEDO),w=n.next_out,p=n.output,A=n.avail_out,g=n.next_in,l=n.input,u=n.avail_in,S=s.hold,D=s.bits,z=u,$=A,oe=Z_OK$1;e:for(;;)switch(s.mode){case HEAD:if(s.wrap===0){s.mode=TYPEDO;break}for(;D<16;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if(s.wrap&2&&S===35615){s.check=0,be[0]=S&255,be[1]=S>>>8&255,s.check=crc32_1(s.check,be,2,0),S=0,D=0,s.mode=FLAGS;break}if(s.flags=0,s.head&&(s.head.done=!1),!(s.wrap&1)||(((S&255)<<8)+(S>>8))%31){n.msg="incorrect header check",s.mode=BAD;break}if((S&15)!==Z_DEFLATED){n.msg="unknown compression method",s.mode=BAD;break}if(S>>>=4,D-=4,we=(S&15)+8,s.wbits===0)s.wbits=we;else if(we>s.wbits){n.msg="invalid window size",s.mode=BAD;break}s.dmax=1<<s.wbits,n.adler=s.check=1,s.mode=S&512?DICTID:TYPE,S=0,D=0;break;case FLAGS:for(;D<16;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if(s.flags=S,(s.flags&255)!==Z_DEFLATED){n.msg="unknown compression method",s.mode=BAD;break}if(s.flags&57344){n.msg="unknown header flags set",s.mode=BAD;break}s.head&&(s.head.text=S>>8&1),s.flags&512&&(be[0]=S&255,be[1]=S>>>8&255,s.check=crc32_1(s.check,be,2,0)),S=0,D=0,s.mode=TIME;case TIME:for(;D<32;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}s.head&&(s.head.time=S),s.flags&512&&(be[0]=S&255,be[1]=S>>>8&255,be[2]=S>>>16&255,be[3]=S>>>24&255,s.check=crc32_1(s.check,be,4,0)),S=0,D=0,s.mode=OS;case OS:for(;D<16;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}s.head&&(s.head.xflags=S&255,s.head.os=S>>8),s.flags&512&&(be[0]=S&255,be[1]=S>>>8&255,s.check=crc32_1(s.check,be,2,0)),S=0,D=0,s.mode=EXLEN;case EXLEN:if(s.flags&1024){for(;D<16;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}s.length=S,s.head&&(s.head.extra_len=S),s.flags&512&&(be[0]=S&255,be[1]=S>>>8&255,s.check=crc32_1(s.check,be,2,0)),S=0,D=0}else s.head&&(s.head.extra=null);s.mode=EXTRA;case EXTRA:if(s.flags&1024&&(O=s.length,O>u&&(O=u),O&&(s.head&&(we=s.head.extra_len-s.length,s.head.extra||(s.head.extra=new Uint8Array(s.head.extra_len)),s.head.extra.set(l.subarray(g,g+O),we)),s.flags&512&&(s.check=crc32_1(s.check,l,O,g)),u-=O,g+=O,s.length-=O),s.length))break e;s.length=0,s.mode=NAME;case NAME:if(s.flags&2048){if(u===0)break e;O=0;do we=l[g+O++],s.head&&we&&s.length<65536&&(s.head.name+=String.fromCharCode(we));while(we&&O<u);if(s.flags&512&&(s.check=crc32_1(s.check,l,O,g)),u-=O,g+=O,we)break e}else s.head&&(s.head.name=null);s.length=0,s.mode=COMMENT;case COMMENT:if(s.flags&4096){if(u===0)break e;O=0;do we=l[g+O++],s.head&&we&&s.length<65536&&(s.head.comment+=String.fromCharCode(we));while(we&&O<u);if(s.flags&512&&(s.check=crc32_1(s.check,l,O,g)),u-=O,g+=O,we)break e}else s.head&&(s.head.comment=null);s.mode=HCRC;case HCRC:if(s.flags&512){for(;D<16;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if(S!==(s.check&65535)){n.msg="header crc mismatch",s.mode=BAD;break}S=0,D=0}s.head&&(s.head.hcrc=s.flags>>9&1,s.head.done=!0),n.adler=s.check=0,s.mode=TYPE;break;case DICTID:for(;D<32;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}n.adler=s.check=zswap32(S),S=0,D=0,s.mode=DICT;case DICT:if(s.havedict===0)return n.next_out=w,n.avail_out=A,n.next_in=g,n.avail_in=u,s.hold=S,s.bits=D,Z_NEED_DICT$1;n.adler=s.check=1,s.mode=TYPE;case TYPE:if(t===Z_BLOCK||t===Z_TREES)break e;case TYPEDO:if(s.last){S>>>=D&7,D-=D&7,s.mode=CHECK;break}for(;D<3;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}switch(s.last=S&1,S>>>=1,D-=1,S&3){case 0:s.mode=STORED;break;case 1:if(fixedtables(s),s.mode=LEN_,t===Z_TREES){S>>>=2,D-=2;break e}break;case 2:s.mode=TABLE;break;case 3:n.msg="invalid block type",s.mode=BAD}S>>>=2,D-=2;break;case STORED:for(S>>>=D&7,D-=D&7;D<32;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if((S&65535)!==(S>>>16^65535)){n.msg="invalid stored block lengths",s.mode=BAD;break}if(s.length=S&65535,S=0,D=0,s.mode=COPY_,t===Z_TREES)break e;case COPY_:s.mode=COPY;case COPY:if(O=s.length,O){if(O>u&&(O=u),O>A&&(O=A),O===0)break e;p.set(l.subarray(g,g+O),w),u-=O,g+=O,A-=O,w+=O,s.length-=O;break}s.mode=TYPE;break;case TABLE:for(;D<14;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if(s.nlen=(S&31)+257,S>>>=5,D-=5,s.ndist=(S&31)+1,S>>>=5,D-=5,s.ncode=(S&15)+4,S>>>=4,D-=4,s.nlen>286||s.ndist>30){n.msg="too many length or distance symbols",s.mode=BAD;break}s.have=0,s.mode=LENLENS;case LENLENS:for(;s.have<s.ncode;){for(;D<3;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}s.lens[Ce[s.have++]]=S&7,S>>>=3,D-=3}for(;s.have<19;)s.lens[Ce[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,ie={bits:s.lenbits},oe=inftrees(CODES,s.lens,0,19,s.lencode,0,s.work,ie),s.lenbits=ie.bits,oe){n.msg="invalid code lengths set",s.mode=BAD;break}s.have=0,s.mode=CODELENS;case CODELENS:for(;s.have<s.nlen+s.ndist;){for(;J=s.lencode[S&(1<<s.lenbits)-1],Y=J>>>24,fe=J>>>16&255,ee=J&65535,!(Y<=D);){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if(ee<16)S>>>=Y,D-=Y,s.lens[s.have++]=ee;else{if(ee===16){for(ue=Y+2;D<ue;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if(S>>>=Y,D-=Y,s.have===0){n.msg="invalid bit length repeat",s.mode=BAD;break}we=s.lens[s.have-1],O=3+(S&3),S>>>=2,D-=2}else if(ee===17){for(ue=Y+3;D<ue;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}S>>>=Y,D-=Y,we=0,O=3+(S&7),S>>>=3,D-=3}else{for(ue=Y+7;D<ue;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}S>>>=Y,D-=Y,we=0,O=11+(S&127),S>>>=7,D-=7}if(s.have+O>s.nlen+s.ndist){n.msg="invalid bit length repeat",s.mode=BAD;break}for(;O--;)s.lens[s.have++]=we}}if(s.mode===BAD)break;if(s.lens[256]===0){n.msg="invalid code -- missing end-of-block",s.mode=BAD;break}if(s.lenbits=9,ie={bits:s.lenbits},oe=inftrees(LENS,s.lens,0,s.nlen,s.lencode,0,s.work,ie),s.lenbits=ie.bits,oe){n.msg="invalid literal/lengths set",s.mode=BAD;break}if(s.distbits=6,s.distcode=s.distdyn,ie={bits:s.distbits},oe=inftrees(DISTS,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,ie),s.distbits=ie.bits,oe){n.msg="invalid distances set",s.mode=BAD;break}if(s.mode=LEN_,t===Z_TREES)break e;case LEN_:s.mode=LEN;case LEN:if(u>=6&&A>=258){n.next_out=w,n.avail_out=A,n.next_in=g,n.avail_in=u,s.hold=S,s.bits=D,inffast(n,$),w=n.next_out,p=n.output,A=n.avail_out,g=n.next_in,l=n.input,u=n.avail_in,S=s.hold,D=s.bits,s.mode===TYPE&&(s.back=-1);break}for(s.back=0;J=s.lencode[S&(1<<s.lenbits)-1],Y=J>>>24,fe=J>>>16&255,ee=J&65535,!(Y<=D);){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if(fe&&(fe&240)===0){for(re=Y,he=fe,_e=ee;J=s.lencode[_e+((S&(1<<re+he)-1)>>re)],Y=J>>>24,fe=J>>>16&255,ee=J&65535,!(re+Y<=D);){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}S>>>=re,D-=re,s.back+=re}if(S>>>=Y,D-=Y,s.back+=Y,s.length=ee,fe===0){s.mode=LIT;break}if(fe&32){s.back=-1,s.mode=TYPE;break}if(fe&64){n.msg="invalid literal/length code",s.mode=BAD;break}s.extra=fe&15,s.mode=LENEXT;case LENEXT:if(s.extra){for(ue=s.extra;D<ue;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}s.length+=S&(1<<s.extra)-1,S>>>=s.extra,D-=s.extra,s.back+=s.extra}s.was=s.length,s.mode=DIST;case DIST:for(;J=s.distcode[S&(1<<s.distbits)-1],Y=J>>>24,fe=J>>>16&255,ee=J&65535,!(Y<=D);){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if((fe&240)===0){for(re=Y,he=fe,_e=ee;J=s.distcode[_e+((S&(1<<re+he)-1)>>re)],Y=J>>>24,fe=J>>>16&255,ee=J&65535,!(re+Y<=D);){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}S>>>=re,D-=re,s.back+=re}if(S>>>=Y,D-=Y,s.back+=Y,fe&64){n.msg="invalid distance code",s.mode=BAD;break}s.offset=ee,s.extra=fe&15,s.mode=DISTEXT;case DISTEXT:if(s.extra){for(ue=s.extra;D<ue;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}s.offset+=S&(1<<s.extra)-1,S>>>=s.extra,D-=s.extra,s.back+=s.extra}if(s.offset>s.dmax){n.msg="invalid distance too far back",s.mode=BAD;break}s.mode=MATCH;case MATCH:if(A===0)break e;if(O=$-A,s.offset>O){if(O=s.offset-O,O>s.whave&&s.sane){n.msg="invalid distance too far back",s.mode=BAD;break}O>s.wnext?(O-=s.wnext,q=s.wsize-O):q=s.wnext-O,O>s.length&&(O=s.length),K=s.window}else K=p,q=w-s.offset,O=s.length;O>A&&(O=A),A-=O,s.length-=O;do p[w++]=K[q++];while(--O);s.length===0&&(s.mode=LEN);break;case LIT:if(A===0)break e;p[w++]=s.length,A--,s.mode=LEN;break;case CHECK:if(s.wrap){for(;D<32;){if(u===0)break e;u--,S|=l[g++]<<D,D+=8}if($-=A,n.total_out+=$,s.total+=$,$&&(n.adler=s.check=s.flags?crc32_1(s.check,p,$,w-$):adler32_1(s.check,p,$,w-$)),$=A,(s.flags?S:zswap32(S))!==s.check){n.msg="incorrect data check",s.mode=BAD;break}S=0,D=0}s.mode=LENGTH;case LENGTH:if(s.wrap&&s.flags){for(;D<32;){if(u===0)break e;u--,S+=l[g++]<<D,D+=8}if(S!==(s.total&4294967295)){n.msg="incorrect length check",s.mode=BAD;break}S=0,D=0}s.mode=DONE;case DONE:oe=Z_STREAM_END$1;break e;case BAD:oe=Z_DATA_ERROR$1;break e;case MEM:return Z_MEM_ERROR$1;case SYNC:default:return Z_STREAM_ERROR$1}return n.next_out=w,n.avail_out=A,n.next_in=g,n.avail_in=u,s.hold=S,s.bits=D,(s.wsize||$!==n.avail_out&&s.mode<BAD&&(s.mode<CHECK||t!==Z_FINISH$1))&&updatewindow(n,n.output,n.next_out,$-n.avail_out),z-=n.avail_in,$-=n.avail_out,n.total_in+=z,n.total_out+=$,s.total+=$,s.wrap&&$&&(n.adler=s.check=s.flags?crc32_1(s.check,p,$,n.next_out-$):adler32_1(s.check,p,$,n.next_out-$)),n.data_type=s.bits+(s.last?64:0)+(s.mode===TYPE?128:0)+(s.mode===LEN_||s.mode===COPY_?256:0),(z===0&&$===0||t===Z_FINISH$1)&&oe===Z_OK$1&&(oe=Z_BUF_ERROR),oe},inflateEnd=n=>{if(!n||!n.state)return Z_STREAM_ERROR$1;let t=n.state;return t.window&&(t.window=null),n.state=null,Z_OK$1},inflateGetHeader=(n,t)=>{if(!n||!n.state)return Z_STREAM_ERROR$1;const s=n.state;return(s.wrap&2)===0?Z_STREAM_ERROR$1:(s.head=t,t.done=!1,Z_OK$1)},inflateSetDictionary=(n,t)=>{const s=t.length;let l,p,g;return!n||!n.state||(l=n.state,l.wrap!==0&&l.mode!==DICT)?Z_STREAM_ERROR$1:l.mode===DICT&&(p=1,p=adler32_1(p,t,s,0),p!==l.check)?Z_DATA_ERROR$1:(g=updatewindow(n,t,s,s),g?(l.mode=MEM,Z_MEM_ERROR$1):(l.havedict=1,Z_OK$1))};var inflateReset_1=inflateReset,inflateReset2_1=inflateReset2,inflateResetKeep_1=inflateResetKeep,inflateInit_1=inflateInit,inflateInit2_1=inflateInit2,inflate_2$1=inflate$2,inflateEnd_1=inflateEnd,inflateGetHeader_1=inflateGetHeader,inflateSetDictionary_1=inflateSetDictionary,inflateInfo="pako inflate (from Nodeca project)",inflate_1$2={inflateReset:inflateReset_1,inflateReset2:inflateReset2_1,inflateResetKeep:inflateResetKeep_1,inflateInit:inflateInit_1,inflateInit2:inflateInit2_1,inflate:inflate_2$1,inflateEnd:inflateEnd_1,inflateGetHeader:inflateGetHeader_1,inflateSetDictionary:inflateSetDictionary_1,inflateInfo};function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var gzheader=GZheader;const toString$3=Object.prototype.toString,{Z_NO_FLUSH,Z_FINISH,Z_OK,Z_STREAM_END,Z_NEED_DICT,Z_STREAM_ERROR,Z_DATA_ERROR,Z_MEM_ERROR}=constants$2$1;function Inflate$1(n){this.options=common.assign({chunkSize:1024*64,windowBits:15,to:""},n||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),t.windowBits>=0&&t.windowBits<16&&!(n&&n.windowBits)&&(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(t.windowBits&15)===0&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let s=inflate_1$2.inflateInit2(this.strm,t.windowBits);if(s!==Z_OK)throw new Error(messages[s]);if(this.header=new gzheader,inflate_1$2.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=strings.string2buf(t.dictionary):toString$3.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(s=inflate_1$2.inflateSetDictionary(this.strm,t.dictionary),s!==Z_OK)))throw new Error(messages[s])}Inflate$1.prototype.push=function(n,t){const s=this.strm,l=this.options.chunkSize,p=this.options.dictionary;let g,w,u;if(this.ended)return!1;for(t===~~t?w=t:w=t===!0?Z_FINISH:Z_NO_FLUSH,toString$3.call(n)==="[object ArrayBuffer]"?s.input=new Uint8Array(n):s.input=n,s.next_in=0,s.avail_in=s.input.length;;){for(s.avail_out===0&&(s.output=new Uint8Array(l),s.next_out=0,s.avail_out=l),g=inflate_1$2.inflate(s,w),g===Z_NEED_DICT&&p&&(g=inflate_1$2.inflateSetDictionary(s,p),g===Z_OK?g=inflate_1$2.inflate(s,w):g===Z_DATA_ERROR&&(g=Z_NEED_DICT));s.avail_in>0&&g===Z_STREAM_END&&s.state.wrap>0&&n[s.next_in]!==0;)inflate_1$2.inflateReset(s),g=inflate_1$2.inflate(s,w);switch(g){case Z_STREAM_ERROR:case Z_DATA_ERROR:case Z_NEED_DICT:case Z_MEM_ERROR:return this.onEnd(g),this.ended=!0,!1}if(u=s.avail_out,s.next_out&&(s.avail_out===0||g===Z_STREAM_END))if(this.options.to==="string"){let A=strings.utf8border(s.output,s.next_out),S=s.next_out-A,D=strings.buf2string(s.output,A);s.next_out=S,s.avail_out=l-S,S&&s.output.set(s.output.subarray(A,A+S),0),this.onData(D)}else this.onData(s.output.length===s.next_out?s.output:s.output.subarray(0,s.next_out));if(!(g===Z_OK&&u===0)){if(g===Z_STREAM_END)return g=inflate_1$2.inflateEnd(this.strm),this.onEnd(g),this.ended=!0,!0;if(s.avail_in===0)break}}return!0};Inflate$1.prototype.onData=function(n){this.chunks.push(n)};Inflate$1.prototype.onEnd=function(n){n===Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};function inflate$1(n,t){const s=new Inflate$1(t);if(s.push(n),s.err)throw s.msg||messages[s.err];return s.result}function inflateRaw$1(n,t){return t=t||{},t.raw=!0,inflate$1(n,t)}var Inflate_1$1=Inflate$1,inflate_2=inflate$1,inflateRaw_1$1=inflateRaw$1,ungzip$1=inflate$1,constants$5=constants$2$1,inflate_1$1={Inflate:Inflate_1$1,inflate:inflate_2,inflateRaw:inflateRaw_1$1,ungzip:ungzip$1,constants:constants$5};const{Deflate,deflate,deflateRaw,gzip}=deflate_1$1,{Inflate,inflate,inflateRaw,ungzip}=inflate_1$1;var deflate_1=deflate,Inflate_1=Inflate,inflate_1=inflate;const pngSignature=[137,80,78,71,13,10,26,10],crcTable=[];for(let n=0;n<256;n++){let t=n;for(let s=0;s<8;s++)t&1?t=3988292384^t>>>1:t=t>>>1;crcTable[n]=t}const initialCrc=4294967295;function updateCrc(n,t,s){let l=n;for(let p=0;p<s;p++)l=crcTable[(l^t[p])&255]^l>>>8;return l}function crc(n,t){return(updateCrc(initialCrc,n,t)^initialCrc)>>>0}var ColorType;(function(n){n[n.UNKNOWN=-1]="UNKNOWN",n[n.GREYSCALE=0]="GREYSCALE",n[n.TRUECOLOUR=2]="TRUECOLOUR",n[n.INDEXED_COLOUR=3]="INDEXED_COLOUR",n[n.GREYSCALE_ALPHA=4]="GREYSCALE_ALPHA",n[n.TRUECOLOUR_ALPHA=6]="TRUECOLOUR_ALPHA"})(ColorType||(ColorType={}));var CompressionMethod;(function(n){n[n.UNKNOWN=-1]="UNKNOWN",n[n.DEFLATE=0]="DEFLATE"})(CompressionMethod||(CompressionMethod={}));var FilterMethod;(function(n){n[n.UNKNOWN=-1]="UNKNOWN",n[n.ADAPTIVE=0]="ADAPTIVE"})(FilterMethod||(FilterMethod={}));var InterlaceMethod;(function(n){n[n.UNKNOWN=-1]="UNKNOWN",n[n.NO_INTERLACE=0]="NO_INTERLACE",n[n.ADAM7=1]="ADAM7"})(InterlaceMethod||(InterlaceMethod={}));const empty=new Uint8Array(0),NULL="\0",uint16=new Uint16Array([255]),uint8=new Uint8Array(uint16.buffer),osIsLittleEndian=uint8[0]===255;class PngDecoder extends IOBuffer$4{constructor(t,s={}){super(t);const{checkCrc:l=!1}=s;this._checkCrc=l,this._inflator=new Inflate_1,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._end=!1,this._hasPalette=!1,this._palette=[],this._compressionMethod=CompressionMethod.UNKNOWN,this._filterMethod=FilterMethod.UNKNOWN,this._interlaceMethod=InterlaceMethod.UNKNOWN,this._colorType=-1,this.setBigEndian()}decode(){for(this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(let t=0;t<pngSignature.length;t++)if(this.readUint8()!==pngSignature[t])throw new Error(`wrong PNG signature. Byte at ${t} should be ${pngSignature[t]}.`)}decodeChunk(){const t=this.readUint32(),s=this.readChars(4),l=this.offset;switch(s){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(t);break;case"IDAT":this.decodeIDAT(t);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(t);break;case"iCCP":this.decodeiCCP(t);break;case"tEXt":this.decodetEXt(t);break;case"pHYs":this.decodepHYs();break;default:this.skip(t);break}if(this.offset-l!==t)throw new Error(`Length mismatch while decoding chunk ${s}`);if(this._checkCrc){const p=this.readUint32(),g=t+4,w=crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-g-4,g),g);if(w!==p)throw new Error(`CRC mismatch for chunk ${s}. Expected ${p}, found ${w}`)}else this.skip(4)}decodeIHDR(){const t=this._png;t.width=this.readUint32(),t.height=this.readUint32(),t.depth=checkBitDepth(this.readUint8());const s=this.readUint8();this._colorType=s;let l;switch(s){case ColorType.GREYSCALE:l=1;break;case ColorType.TRUECOLOUR:l=3;break;case ColorType.INDEXED_COLOUR:l=1;break;case ColorType.GREYSCALE_ALPHA:l=2;break;case ColorType.TRUECOLOUR_ALPHA:l=4;break;default:throw new Error(`Unknown color type: ${s}`)}if(this._png.channels=l,this._compressionMethod=this.readUint8(),this._compressionMethod!==CompressionMethod.DEFLATE)throw new Error(`Unsupported compression method: ${this._compressionMethod}`);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodePLTE(t){if(t%3!==0)throw new RangeError(`PLTE field length must be a multiple of 3. Got ${t}`);const s=t/3;this._hasPalette=!0;const l=[];this._palette=l;for(let p=0;p<s;p++)l.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(t){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,t)),this.skip(t)}decodetRNS(t){if(this._colorType===3){if(t>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${t} vs ${this._palette.length})`);let s=0;for(;s<t;s++){const l=this.readByte();this._palette[s].push(l)}for(;s<this._palette.length;s++)this._palette[s].push(255)}}decodeiCCP(t){let s="",l;for(;(l=this.readChar())!==NULL;)s+=l;const p=this.readUint8();if(p!==CompressionMethod.DEFLATE)throw new Error(`Unsupported iCCP compression method: ${p}`);const g=this.readBytes(t-s.length-2);this._png.iccEmbeddedProfile={name:s,profile:inflate_1(g)}}decodetEXt(t){let s="",l;for(;(l=this.readChar())!==NULL;)s+=l;this._png.text[s]=this.readChars(t-s.length-1)}decodepHYs(){const t=this.readUint32(),s=this.readUint32(),l=this.readByte();this._png.resolution={x:t,y:s,unit:l}}decodeImage(){if(this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);const t=this._inflator.result;if(this._filterMethod!==FilterMethod.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod===InterlaceMethod.NO_INTERLACE)this.decodeInterlaceNull(t);else throw new Error(`Interlace method ${this._interlaceMethod} not supported`)}decodeInterlaceNull(t){const s=this._png.height,l=this._png.channels*this._png.depth/8,p=this._png.width*l,g=new Uint8Array(this._png.height*p);let w=empty,u=0,A,S;for(let D=0;D<s;D++){switch(A=t.subarray(u+1,u+1+p),S=g.subarray(D*p,(D+1)*p),t[u]){case 0:unfilterNone(A,S,p);break;case 1:unfilterSub(A,S,p,l);break;case 2:unfilterUp(A,S,w,p);break;case 3:unfilterAverage(A,S,w,p,l);break;case 4:unfilterPaeth(A,S,w,p,l);break;default:throw new Error(`Unsupported filter: ${t[u]}`)}w=S,u+=p+1}if(this._hasPalette&&(this._png.palette=this._palette),this._png.depth===16){const D=new Uint16Array(g.buffer);if(osIsLittleEndian)for(let z=0;z<D.length;z++)D[z]=swap16(D[z]);this._png.data=D}else this._png.data=g}}function unfilterNone(n,t,s){for(let l=0;l<s;l++)t[l]=n[l]}function unfilterSub(n,t,s,l){let p=0;for(;p<l;p++)t[p]=n[p];for(;p<s;p++)t[p]=n[p]+t[p-l]&255}function unfilterUp(n,t,s,l){let p=0;if(s.length===0)for(;p<l;p++)t[p]=n[p];else for(;p<l;p++)t[p]=n[p]+s[p]&255}function unfilterAverage(n,t,s,l,p){let g=0;if(s.length===0){for(;g<p;g++)t[g]=n[g];for(;g<l;g++)t[g]=n[g]+(t[g-p]>>1)&255}else{for(;g<p;g++)t[g]=n[g]+(s[g]>>1)&255;for(;g<l;g++)t[g]=n[g]+(t[g-p]+s[g]>>1)&255}}function unfilterPaeth(n,t,s,l,p){let g=0;if(s.length===0){for(;g<p;g++)t[g]=n[g];for(;g<l;g++)t[g]=n[g]+t[g-p]&255}else{for(;g<p;g++)t[g]=n[g]+s[g]&255;for(;g<l;g++)t[g]=n[g]+paethPredictor(t[g-p],s[g],s[g-p])&255}}function paethPredictor(n,t,s){const l=n+t-s,p=Math.abs(l-n),g=Math.abs(l-t),w=Math.abs(l-s);return p<=g&&p<=w?n:g<=w?t:s}function swap16(n){return(n&255)<<8|n>>8&255}function checkBitDepth(n){if(n!==1&&n!==2&&n!==4&&n!==8&&n!==16)throw new Error(`invalid bit depth: ${n}`);return n}const defaultZlibOptions={level:3};class PngEncoder extends IOBuffer$4{constructor(t,s={}){super(),this._colorType=ColorType.UNKNOWN,this._zlibOptions=Object.assign({},defaultZlibOptions,s.zlib),this._png=this._checkData(t),this.setBigEndian()}encode(){return this.encodeSignature(),this.encodeIHDR(),this.encodeData(),this.encodeIEND(),this.toArray()}encodeSignature(){this.writeBytes(pngSignature)}encodeIHDR(){this.writeUint32(13),this.writeChars("IHDR"),this.writeUint32(this._png.width),this.writeUint32(this._png.height),this.writeByte(this._png.depth),this.writeByte(this._colorType),this.writeByte(CompressionMethod.DEFLATE),this.writeByte(FilterMethod.ADAPTIVE),this.writeByte(InterlaceMethod.NO_INTERLACE),this.writeCrc(17)}encodeIEND(){this.writeUint32(0),this.writeChars("IEND"),this.writeCrc(4)}encodeIDAT(t){this.writeUint32(t.length),this.writeChars("IDAT"),this.writeBytes(t),this.writeCrc(t.length+4)}encodeData(){const{width:t,height:s,channels:l,depth:p,data:g}=this._png,w=l*t,u=new IOBuffer$4().setBigEndian();let A=0;for(let z=0;z<s;z++)if(u.writeByte(0),p===8)A=writeDataBytes(g,u,w,A);else if(p===16)A=writeDataUint16(g,u,w,A);else throw new Error("unreachable");const S=u.toArray(),D=deflate_1(S,this._zlibOptions);this.encodeIDAT(D)}_checkData(t){const{colorType:s,channels:l,depth:p}=getColorType(t),g={width:checkInteger(t.width,"width"),height:checkInteger(t.height,"height"),channels:l,data:t.data,depth:p,text:{}};this._colorType=s;const w=g.width*g.height*l;if(g.data.length!==w)throw new RangeError(`wrong data size. Found ${g.data.length}, expected ${w}`);return g}writeCrc(t){this.writeUint32(crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-t,t),t))}}function checkInteger(n,t){if(Number.isInteger(n)&&n>0)return n;throw new TypeError(`${t} must be a positive integer`)}function getColorType(n){const{channels:t=4,depth:s=8}=n;if(t!==4&&t!==3&&t!==2&&t!==1)throw new RangeError(`unsupported number of channels: ${t}`);if(s!==8&&s!==16)throw new RangeError(`unsupported bit depth: ${s}`);const l={channels:t,depth:s,colorType:ColorType.UNKNOWN};switch(t){case 4:l.colorType=ColorType.TRUECOLOUR_ALPHA;break;case 3:l.colorType=ColorType.TRUECOLOUR;break;case 1:l.colorType=ColorType.GREYSCALE;break;case 2:l.colorType=ColorType.GREYSCALE_ALPHA;break;default:throw new Error("unsupported number of channels")}return l}function writeDataBytes(n,t,s,l){for(let p=0;p<s;p++)t.writeByte(n[l++]);return l}function writeDataUint16(n,t,s,l){for(let p=0;p<s;p++)t.writeUint16(n[l++]);return l}var ResolutionUnitSpecifier;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.METRE=1]="METRE"})(ResolutionUnitSpecifier||(ResolutionUnitSpecifier={}));function decodePng(n,t){return new PngDecoder(n,t).decode()}function encodePng$1(n,t){return new PngEncoder(n,t).encode()}var encoder$1={exports:{}};(function(n){function t(l){var p=Math.floor,g=new Array(64),w=new Array(64),u=new Array(64),A=new Array(64),S,D,z,$,O=new Array(65535),q=new Array(65535),K=new Array(64),J=new Array(64),Y=[],fe=0,ee=7,re=new Array(64),he=new Array(64),_e=new Array(64),we=new Array(256),oe=new Array(2048),be,ie=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],ue=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],Ce=[0,1,2,3,4,5,6,7,8,9,10,11],Ne=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],it=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],rt=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],Pt=[0,1,2,3,4,5,6,7,8,9,10,11],zt=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],vt=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function Vt(Ge){for(var Gt=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],Ht=0;Ht<64;Ht++){var ei=p((Gt[Ht]*Ge+50)/100);ei<1?ei=1:ei>255&&(ei=255),g[ie[Ht]]=ei}for(var oi=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],_t=0;_t<64;_t++){var Ci=p((oi[_t]*Ge+50)/100);Ci<1?Ci=1:Ci>255&&(Ci=255),w[ie[_t]]=Ci}for(var hi=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],Ft=0,Ut=0;Ut<8;Ut++)for(var yt=0;yt<8;yt++)u[Ft]=1/(g[ie[Ft]]*hi[Ut]*hi[yt]*8),A[Ft]=1/(w[ie[Ft]]*hi[Ut]*hi[yt]*8),Ft++}function kt(Ge,Gt){for(var Ht=0,ei=0,oi=new Array,_t=1;_t<=16;_t++){for(var Ci=1;Ci<=Ge[_t];Ci++)oi[Gt[ei]]=[],oi[Gt[ei]][0]=Ht,oi[Gt[ei]][1]=_t,ei++,Ht++;Ht*=2}return oi}function Yt(){S=kt(ue,Ce),D=kt(rt,Pt),z=kt(Ne,it),$=kt(zt,vt)}function Qt(){for(var Ge=1,Gt=2,Ht=1;Ht<=15;Ht++){for(var ei=Ge;ei<Gt;ei++)q[32767+ei]=Ht,O[32767+ei]=[],O[32767+ei][1]=Ht,O[32767+ei][0]=ei;for(var oi=-(Gt-1);oi<=-Ge;oi++)q[32767+oi]=Ht,O[32767+oi]=[],O[32767+oi][1]=Ht,O[32767+oi][0]=Gt-1+oi;Ge<<=1,Gt<<=1}}function ot(){for(var Ge=0;Ge<256;Ge++)oe[Ge]=19595*Ge,oe[Ge+256>>0]=38470*Ge,oe[Ge+512>>0]=7471*Ge+32768,oe[Ge+768>>0]=-11059*Ge,oe[Ge+1024>>0]=-21709*Ge,oe[Ge+1280>>0]=32768*Ge+8421375,oe[Ge+1536>>0]=-27439*Ge,oe[Ge+1792>>0]=-5329*Ge}function gt(Ge){for(var Gt=Ge[0],Ht=Ge[1]-1;Ht>=0;)Gt&1<<Ht&&(fe|=1<<ee),Ht--,ee--,ee<0&&(fe==255?(pt(255),pt(0)):pt(fe),ee=7,fe=0)}function pt(Ge){Y.push(Ge)}function Bt(Ge){pt(Ge>>8&255),pt(Ge&255)}function Zt(Ge,Gt){var Ht,ei,oi,_t,Ci,hi,Ft,Ut,yt=0,ui,yi=8,Ei=64;for(ui=0;ui<yi;++ui){Ht=Ge[yt],ei=Ge[yt+1],oi=Ge[yt+2],_t=Ge[yt+3],Ci=Ge[yt+4],hi=Ge[yt+5],Ft=Ge[yt+6],Ut=Ge[yt+7];var Jt=Ht+Ut,di=Ht-Ut,zi=ei+Ft,Fi=ei-Ft,Oi=oi+hi,ir=oi-hi,Rr=_t+Ci,Lr=_t-Ci,Tr=Jt+Rr,tr=Jt-Rr,dr=zi+Oi,gr=zi-Oi;Ge[yt]=Tr+dr,Ge[yt+4]=Tr-dr;var xr=(gr+tr)*.707106781;Ge[yt+2]=tr+xr,Ge[yt+6]=tr-xr,Tr=Lr+ir,dr=ir+Fi,gr=Fi+di;var Ar=(Tr-gr)*.382683433,zr=.5411961*Tr+Ar,ye=1.306562965*gr+Ar,Q=dr*.707106781,G=di+Q,W=di-Q;Ge[yt+5]=W+zr,Ge[yt+3]=W-zr,Ge[yt+1]=G+ye,Ge[yt+7]=G-ye,yt+=8}for(yt=0,ui=0;ui<yi;++ui){Ht=Ge[yt],ei=Ge[yt+8],oi=Ge[yt+16],_t=Ge[yt+24],Ci=Ge[yt+32],hi=Ge[yt+40],Ft=Ge[yt+48],Ut=Ge[yt+56];var ce=Ht+Ut,me=Ht-Ut,ke=ei+Ft,Re=ei-Ft,ze=oi+hi,Pe=oi-hi,je=_t+Ci,Ke=_t-Ci,ut=ce+je,et=ce-je,Rt=ke+ze,wt=ke-ze;Ge[yt]=ut+Rt,Ge[yt+32]=ut-Rt;var Lt=(wt+et)*.707106781;Ge[yt+16]=et+Lt,Ge[yt+48]=et-Lt,ut=Ke+Pe,Rt=Pe+Re,wt=Re+me;var Wt=(ut-wt)*.382683433,$e=.5411961*ut+Wt,Ti=1.306562965*wt+Wt,St=Rt*.707106781,Ai=me+St,ki=me-St;Ge[yt+40]=ki+$e,Ge[yt+24]=ki-$e,Ge[yt+8]=Ai+Ti,Ge[yt+56]=Ai-Ti,yt++}var Xr;for(ui=0;ui<Ei;++ui)Xr=Ge[ui]*Gt[ui],K[ui]=Xr>0?Xr+.5|0:Xr-.5|0;return K}function si(){Bt(65504),Bt(16),pt(74),pt(70),pt(73),pt(70),pt(0),pt(1),pt(1),pt(0),Bt(1),Bt(1),pt(0),pt(0)}function ii(Ge){if(!!Ge){Bt(65505),Ge[0]===69&&Ge[1]===120&&Ge[2]===105&&Ge[3]===102?Bt(Ge.length+2):(Bt(Ge.length+5+2),pt(69),pt(120),pt(105),pt(102),pt(0));for(var Gt=0;Gt<Ge.length;Gt++)pt(Ge[Gt])}}function pi(Ge,Gt){Bt(65472),Bt(17),pt(8),Bt(Gt),Bt(Ge),pt(3),pt(1),pt(17),pt(0),pt(2),pt(17),pt(1),pt(3),pt(17),pt(1)}function ai(){Bt(65499),Bt(132),pt(0);for(var Ge=0;Ge<64;Ge++)pt(g[Ge]);pt(1);for(var Gt=0;Gt<64;Gt++)pt(w[Gt])}function Nt(){Bt(65476),Bt(418),pt(0);for(var Ge=0;Ge<16;Ge++)pt(ue[Ge+1]);for(var Gt=0;Gt<=11;Gt++)pt(Ce[Gt]);pt(16);for(var Ht=0;Ht<16;Ht++)pt(Ne[Ht+1]);for(var ei=0;ei<=161;ei++)pt(it[ei]);pt(1);for(var oi=0;oi<16;oi++)pt(rt[oi+1]);for(var _t=0;_t<=11;_t++)pt(Pt[_t]);pt(17);for(var Ci=0;Ci<16;Ci++)pt(zt[Ci+1]);for(var hi=0;hi<=161;hi++)pt(vt[hi])}function ci(){Bt(65498),Bt(12),pt(3),pt(1),pt(0),pt(2),pt(17),pt(3),pt(17),pt(0),pt(63),pt(0)}function $t(Ge,Gt,Ht,ei,oi){for(var _t=oi[0],Ci=oi[240],hi,Ft=16,Ut=63,yt=64,ui=Zt(Ge,Gt),yi=0;yi<yt;++yi)J[ie[yi]]=ui[yi];var Ei=J[0]-Ht;Ht=J[0],Ei==0?gt(ei[0]):(hi=32767+Ei,gt(ei[q[hi]]),gt(O[hi]));for(var Jt=63;Jt>0&&J[Jt]==0;Jt--);if(Jt==0)return gt(_t),Ht;for(var di=1,zi;di<=Jt;){for(var Fi=di;J[di]==0&&di<=Jt;++di);var Oi=di-Fi;if(Oi>=Ft){zi=Oi>>4;for(var ir=1;ir<=zi;++ir)gt(Ci);Oi=Oi&15}hi=32767+J[di],gt(oi[(Oi<<4)+q[hi]]),gt(O[hi]),di++}return Jt!=Ut&&gt(_t),Ht}function ft(){for(var Ge=String.fromCharCode,Gt=0;Gt<256;Gt++)we[Gt]=Ge(Gt)}this.encode=function(Ge,Gt){new Date().getTime(),Gt&&_i(Gt),Y=new Array,fe=0,ee=7,Bt(65496),si(),ii(Ge.exifBuffer),ai(),pi(Ge.width,Ge.height),Nt(),ci();var Ht=0,ei=0,oi=0;fe=0,ee=7,this.encode.displayName="_encode_";for(var _t=Ge.data,Ci=Ge.width,hi=Ge.height,Ft=Ci*4,Ut,yt=0,ui,yi,Ei,Jt,di,zi,Fi,Oi;yt<hi;){for(Ut=0;Ut<Ft;){for(Jt=Ft*yt+Ut,di=Jt,zi=-1,Fi=0,Oi=0;Oi<64;Oi++)Fi=Oi>>3,zi=(Oi&7)*4,di=Jt+Fi*Ft+zi,yt+Fi>=hi&&(di-=Ft*(yt+1+Fi-hi)),Ut+zi>=Ft&&(di-=Ut+zi-Ft+4),ui=_t[di++],yi=_t[di++],Ei=_t[di++],re[Oi]=(oe[ui]+oe[yi+256>>0]+oe[Ei+512>>0]>>16)-128,he[Oi]=(oe[ui+768>>0]+oe[yi+1024>>0]+oe[Ei+1280>>0]>>16)-128,_e[Oi]=(oe[ui+1280>>0]+oe[yi+1536>>0]+oe[Ei+1792>>0]>>16)-128;Ht=$t(re,u,Ht,S,z),ei=$t(he,A,ei,D,$),oi=$t(_e,A,oi,D,$),Ut+=32}yt+=8}if(ee>=0){var ir=[];ir[1]=ee+1,ir[0]=(1<<ee+1)-1,gt(ir)}return Bt(65497),Buffer.from(Y)};function _i(Ge){if(Ge<=0&&(Ge=1),Ge>100&&(Ge=100),be!=Ge){var Gt=0;Ge<50?Gt=Math.floor(5e3/Ge):Gt=Math.floor(200-Ge*2),Vt(Gt),be=Ge}}function Tt(){var Ge=new Date().getTime();l||(l=50),ft(),Yt(),Qt(),ot(),_i(l),new Date().getTime()-Ge}Tt()}n.exports=s;function s(l,p){typeof p=="undefined"&&(p=50);var g=new t(p),w=g.encode(l,p);return{data:w,width:l.width,height:l.height}}})(encoder$1);var decoder$1={exports:{}};(function(n){var t=function(){var p=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),g=4017,w=799,u=3406,A=2276,S=1567,D=3784,z=5793,$=2896;function O(){}function q(he,_e){for(var we=0,oe=[],be,ie,ue=16;ue>0&&!he[ue-1];)ue--;oe.push({children:[],index:0});var Ce=oe[0],Ne;for(be=0;be<ue;be++){for(ie=0;ie<he[be];ie++){for(Ce=oe.pop(),Ce.children[Ce.index]=_e[we];Ce.index>0;){if(oe.length===0)throw new Error("Could not recreate Huffman Table");Ce=oe.pop()}for(Ce.index++,oe.push(Ce);oe.length<=be;)oe.push(Ne={children:[],index:0}),Ce.children[Ce.index]=Ne.children,Ce=Ne;we++}be+1<ue&&(oe.push(Ne={children:[],index:0}),Ce.children[Ce.index]=Ne.children,Ce=Ne)}return oe[0].children}function K(he,_e,we,oe,be,ie,ue,Ce,Ne,it){we.precision,we.samplesPerLine,we.scanLines;var rt=we.mcusPerLine,Pt=we.progressive;we.maxH,we.maxV;var zt=_e,vt=0,Vt=0;function kt(){if(Vt>0)return Vt--,vt>>Vt&1;if(vt=he[_e++],vt==255){var Ft=he[_e++];if(Ft)throw new Error("unexpected marker: "+(vt<<8|Ft).toString(16))}return Vt=7,vt>>>7}function Yt(Ft){for(var Ut=Ft,yt;(yt=kt())!==null;){if(Ut=Ut[yt],typeof Ut=="number")return Ut;if(typeof Ut!="object")throw new Error("invalid huffman sequence")}return null}function Qt(Ft){for(var Ut=0;Ft>0;){var yt=kt();if(yt===null)return;Ut=Ut<<1|yt,Ft--}return Ut}function ot(Ft){var Ut=Qt(Ft);return Ut>=1<<Ft-1?Ut:Ut+(-1<<Ft)+1}function gt(Ft,Ut){var yt=Yt(Ft.huffmanTableDC),ui=yt===0?0:ot(yt);Ut[0]=Ft.pred+=ui;for(var yi=1;yi<64;){var Ei=Yt(Ft.huffmanTableAC),Jt=Ei&15,di=Ei>>4;if(Jt===0){if(di<15)break;yi+=16;continue}yi+=di;var zi=p[yi];Ut[zi]=ot(Jt),yi++}}function pt(Ft,Ut){var yt=Yt(Ft.huffmanTableDC),ui=yt===0?0:ot(yt)<<Ne;Ut[0]=Ft.pred+=ui}function Bt(Ft,Ut){Ut[0]|=kt()<<Ne}var Zt=0;function si(Ft,Ut){if(Zt>0){Zt--;return}for(var yt=ie,ui=ue;yt<=ui;){var yi=Yt(Ft.huffmanTableAC),Ei=yi&15,Jt=yi>>4;if(Ei===0){if(Jt<15){Zt=Qt(Jt)+(1<<Jt)-1;break}yt+=16;continue}yt+=Jt;var di=p[yt];Ut[di]=ot(Ei)*(1<<Ne),yt++}}var ii=0,pi;function ai(Ft,Ut){for(var yt=ie,ui=ue,yi=0;yt<=ui;){var Ei=p[yt],Jt=Ut[Ei]<0?-1:1;switch(ii){case 0:var di=Yt(Ft.huffmanTableAC),zi=di&15,yi=di>>4;if(zi===0)yi<15?(Zt=Qt(yi)+(1<<yi),ii=4):(yi=16,ii=1);else{if(zi!==1)throw new Error("invalid ACn encoding");pi=ot(zi),ii=yi?2:3}continue;case 1:case 2:Ut[Ei]?Ut[Ei]+=(kt()<<Ne)*Jt:(yi--,yi===0&&(ii=ii==2?3:0));break;case 3:Ut[Ei]?Ut[Ei]+=(kt()<<Ne)*Jt:(Ut[Ei]=pi<<Ne,ii=0);break;case 4:Ut[Ei]&&(Ut[Ei]+=(kt()<<Ne)*Jt);break}yt++}ii===4&&(Zt--,Zt===0&&(ii=0))}function Nt(Ft,Ut,yt,ui,yi){var Ei=yt/rt|0,Jt=yt%rt,di=Ei*Ft.v+ui,zi=Jt*Ft.h+yi;Ft.blocks[di]===void 0&&it.tolerantDecoding||Ut(Ft,Ft.blocks[di][zi])}function ci(Ft,Ut,yt){var ui=yt/Ft.blocksPerLine|0,yi=yt%Ft.blocksPerLine;Ft.blocks[ui]===void 0&&it.tolerantDecoding||Ut(Ft,Ft.blocks[ui][yi])}var $t=oe.length,ft,_i,Tt,Ge,Gt,Ht;Pt?ie===0?Ht=Ce===0?pt:Bt:Ht=Ce===0?si:ai:Ht=gt;var ei=0,oi,_t;$t==1?_t=oe[0].blocksPerLine*oe[0].blocksPerColumn:_t=rt*we.mcusPerColumn,be||(be=_t);for(var Ci,hi;ei<_t;){for(_i=0;_i<$t;_i++)oe[_i].pred=0;if(Zt=0,$t==1)for(ft=oe[0],Gt=0;Gt<be;Gt++)ci(ft,Ht,ei),ei++;else for(Gt=0;Gt<be;Gt++){for(_i=0;_i<$t;_i++)for(ft=oe[_i],Ci=ft.h,hi=ft.v,Tt=0;Tt<hi;Tt++)for(Ge=0;Ge<Ci;Ge++)Nt(ft,Ht,ei,Tt,Ge);if(ei++,ei===_t)break}if(ei===_t)do{if(he[_e]===255&&he[_e+1]!==0)break;_e+=1}while(_e<he.length-2);if(Vt=0,oi=he[_e]<<8|he[_e+1],oi<65280)throw new Error("marker was not found");if(oi>=65488&&oi<=65495)_e+=2;else break}return _e-zt}function J(he,_e){var we=[],oe=_e.blocksPerLine,be=_e.blocksPerColumn,ie=oe<<3,ue=new Int32Array(64),Ce=new Uint8Array(64);function Ne(Qt,ot,gt){var pt=_e.quantizationTable,Bt,Zt,si,ii,pi,ai,Nt,ci,$t,ft=gt,_i;for(_i=0;_i<64;_i++)ft[_i]=Qt[_i]*pt[_i];for(_i=0;_i<8;++_i){var Tt=8*_i;if(ft[1+Tt]==0&&ft[2+Tt]==0&&ft[3+Tt]==0&&ft[4+Tt]==0&&ft[5+Tt]==0&&ft[6+Tt]==0&&ft[7+Tt]==0){$t=z*ft[0+Tt]+512>>10,ft[0+Tt]=$t,ft[1+Tt]=$t,ft[2+Tt]=$t,ft[3+Tt]=$t,ft[4+Tt]=$t,ft[5+Tt]=$t,ft[6+Tt]=$t,ft[7+Tt]=$t;continue}Bt=z*ft[0+Tt]+128>>8,Zt=z*ft[4+Tt]+128>>8,si=ft[2+Tt],ii=ft[6+Tt],pi=$*(ft[1+Tt]-ft[7+Tt])+128>>8,ci=$*(ft[1+Tt]+ft[7+Tt])+128>>8,ai=ft[3+Tt]<<4,Nt=ft[5+Tt]<<4,$t=Bt-Zt+1>>1,Bt=Bt+Zt+1>>1,Zt=$t,$t=si*D+ii*S+128>>8,si=si*S-ii*D+128>>8,ii=$t,$t=pi-Nt+1>>1,pi=pi+Nt+1>>1,Nt=$t,$t=ci+ai+1>>1,ai=ci-ai+1>>1,ci=$t,$t=Bt-ii+1>>1,Bt=Bt+ii+1>>1,ii=$t,$t=Zt-si+1>>1,Zt=Zt+si+1>>1,si=$t,$t=pi*A+ci*u+2048>>12,pi=pi*u-ci*A+2048>>12,ci=$t,$t=ai*w+Nt*g+2048>>12,ai=ai*g-Nt*w+2048>>12,Nt=$t,ft[0+Tt]=Bt+ci,ft[7+Tt]=Bt-ci,ft[1+Tt]=Zt+Nt,ft[6+Tt]=Zt-Nt,ft[2+Tt]=si+ai,ft[5+Tt]=si-ai,ft[3+Tt]=ii+pi,ft[4+Tt]=ii-pi}for(_i=0;_i<8;++_i){var Ge=_i;if(ft[8+Ge]==0&&ft[16+Ge]==0&&ft[24+Ge]==0&&ft[32+Ge]==0&&ft[40+Ge]==0&&ft[48+Ge]==0&&ft[56+Ge]==0){$t=z*gt[_i+0]+8192>>14,ft[0+Ge]=$t,ft[8+Ge]=$t,ft[16+Ge]=$t,ft[24+Ge]=$t,ft[32+Ge]=$t,ft[40+Ge]=$t,ft[48+Ge]=$t,ft[56+Ge]=$t;continue}Bt=z*ft[0+Ge]+2048>>12,Zt=z*ft[32+Ge]+2048>>12,si=ft[16+Ge],ii=ft[48+Ge],pi=$*(ft[8+Ge]-ft[56+Ge])+2048>>12,ci=$*(ft[8+Ge]+ft[56+Ge])+2048>>12,ai=ft[24+Ge],Nt=ft[40+Ge],$t=Bt-Zt+1>>1,Bt=Bt+Zt+1>>1,Zt=$t,$t=si*D+ii*S+2048>>12,si=si*S-ii*D+2048>>12,ii=$t,$t=pi-Nt+1>>1,pi=pi+Nt+1>>1,Nt=$t,$t=ci+ai+1>>1,ai=ci-ai+1>>1,ci=$t,$t=Bt-ii+1>>1,Bt=Bt+ii+1>>1,ii=$t,$t=Zt-si+1>>1,Zt=Zt+si+1>>1,si=$t,$t=pi*A+ci*u+2048>>12,pi=pi*u-ci*A+2048>>12,ci=$t,$t=ai*w+Nt*g+2048>>12,ai=ai*g-Nt*w+2048>>12,Nt=$t,ft[0+Ge]=Bt+ci,ft[56+Ge]=Bt-ci,ft[8+Ge]=Zt+Nt,ft[48+Ge]=Zt-Nt,ft[16+Ge]=si+ai,ft[40+Ge]=si-ai,ft[24+Ge]=ii+pi,ft[32+Ge]=ii-pi}for(_i=0;_i<64;++_i){var Gt=128+(ft[_i]+8>>4);ot[_i]=Gt<0?0:Gt>255?255:Gt}}re(ie*be*8);for(var it,rt,Pt=0;Pt<be;Pt++){var zt=Pt<<3;for(it=0;it<8;it++)we.push(new Uint8Array(ie));for(var vt=0;vt<oe;vt++){Ne(_e.blocks[Pt][vt],Ce,ue);var Vt=0,kt=vt<<3;for(rt=0;rt<8;rt++){var Yt=we[zt+rt];for(it=0;it<8;it++)Yt[kt+it]=Ce[Vt++]}}}return we}function Y(he){return he<0?0:he>255?255:he}O.prototype={load:function(_e){var we=new XMLHttpRequest;we.open("GET",_e,!0),we.responseType="arraybuffer",we.onload=function(){var oe=new Uint8Array(we.response||we.mozResponseArrayBuffer);this.parse(oe),this.onload&&this.onload()}.bind(this),we.send(null)},parse:function(_e){var we=this.opts.maxResolutionInMP*1e3*1e3,oe=0;_e.length;function be(){var Jt=_e[oe]<<8|_e[oe+1];return oe+=2,Jt}function ie(){var Jt=be(),di=_e.subarray(oe,oe+Jt-2);return oe+=di.length,di}function ue(Jt){var di=0,zi=0,Fi,Oi;for(Oi in Jt.components)Jt.components.hasOwnProperty(Oi)&&(Fi=Jt.components[Oi],di<Fi.h&&(di=Fi.h),zi<Fi.v&&(zi=Fi.v));var ir=Math.ceil(Jt.samplesPerLine/8/di),Rr=Math.ceil(Jt.scanLines/8/zi);for(Oi in Jt.components)if(Jt.components.hasOwnProperty(Oi)){Fi=Jt.components[Oi];var Lr=Math.ceil(Math.ceil(Jt.samplesPerLine/8)*Fi.h/di),Tr=Math.ceil(Math.ceil(Jt.scanLines/8)*Fi.v/zi),tr=ir*Fi.h,dr=Rr*Fi.v,gr=dr*tr,xr=[];re(gr*256);for(var Ar=0;Ar<dr;Ar++){for(var zr=[],ye=0;ye<tr;ye++)zr.push(new Int32Array(64));xr.push(zr)}Fi.blocksPerLine=Lr,Fi.blocksPerColumn=Tr,Fi.blocks=xr}Jt.maxH=di,Jt.maxV=zi,Jt.mcusPerLine=ir,Jt.mcusPerColumn=Rr}var Ce=null,Ne=null,it,rt,Pt=[],zt=[],vt=[],Vt=[],kt=be(),Yt=-1;if(this.comments=[],kt!=65496)throw new Error("SOI not found");for(kt=be();kt!=65497;){var Qt,ot;switch(kt){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var gt=ie();if(kt===65534){var pt=String.fromCharCode.apply(null,gt);this.comments.push(pt)}kt===65504&&gt[0]===74&&gt[1]===70&&gt[2]===73&&gt[3]===70&&gt[4]===0&&(Ce={version:{major:gt[5],minor:gt[6]},densityUnits:gt[7],xDensity:gt[8]<<8|gt[9],yDensity:gt[10]<<8|gt[11],thumbWidth:gt[12],thumbHeight:gt[13],thumbData:gt.subarray(14,14+3*gt[12]*gt[13])}),kt===65505&&gt[0]===69&&gt[1]===120&&gt[2]===105&&gt[3]===102&&gt[4]===0&&(this.exifBuffer=gt.subarray(5,gt.length)),kt===65518&&gt[0]===65&&gt[1]===100&&gt[2]===111&&gt[3]===98&&gt[4]===101&&gt[5]===0&&(Ne={version:gt[6],flags0:gt[7]<<8|gt[8],flags1:gt[9]<<8|gt[10],transformCode:gt[11]});break;case 65499:for(var Bt=be(),Zt=Bt+oe-2;oe<Zt;){var si=_e[oe++];re(256);var ii=new Int32Array(64);if(si>>4===0)for(ot=0;ot<64;ot++){var pi=p[ot];ii[pi]=_e[oe++]}else if(si>>4===1)for(ot=0;ot<64;ot++){var pi=p[ot];ii[pi]=be()}else throw new Error("DQT: invalid table spec");Pt[si&15]=ii}break;case 65472:case 65473:case 65474:be(),it={},it.extended=kt===65473,it.progressive=kt===65474,it.precision=_e[oe++],it.scanLines=be(),it.samplesPerLine=be(),it.components={},it.componentsOrder=[];var ai=it.scanLines*it.samplesPerLine;if(ai>we){var Nt=Math.ceil((ai-we)/1e6);throw new Error(`maxResolutionInMP limit exceeded by ${Nt}MP`)}var ci=_e[oe++],$t;for(Qt=0;Qt<ci;Qt++){$t=_e[oe];var ft=_e[oe+1]>>4,_i=_e[oe+1]&15,Tt=_e[oe+2];it.componentsOrder.push($t),it.components[$t]={h:ft,v:_i,quantizationIdx:Tt},oe+=3}ue(it),zt.push(it);break;case 65476:var Ge=be();for(Qt=2;Qt<Ge;){var Gt=_e[oe++],Ht=new Uint8Array(16),ei=0;for(ot=0;ot<16;ot++,oe++)ei+=Ht[ot]=_e[oe];re(16+ei);var oi=new Uint8Array(ei);for(ot=0;ot<ei;ot++,oe++)oi[ot]=_e[oe];Qt+=17+ei,(Gt>>4===0?Vt:vt)[Gt&15]=q(Ht,oi)}break;case 65501:be(),rt=be();break;case 65500:be(),be();break;case 65498:be();var _t=_e[oe++],Ci=[],hi;for(Qt=0;Qt<_t;Qt++){hi=it.components[_e[oe++]];var Ft=_e[oe++];hi.huffmanTableDC=Vt[Ft>>4],hi.huffmanTableAC=vt[Ft&15],Ci.push(hi)}var Ut=_e[oe++],yt=_e[oe++],ui=_e[oe++],yi=K(_e,oe,it,Ci,rt,Ut,yt,ui>>4,ui&15,this.opts);oe+=yi;break;case 65535:_e[oe]!==255&&oe--;break;default:if(_e[oe-3]==255&&_e[oe-2]>=192&&_e[oe-2]<=254){oe-=3;break}else if(kt===224||kt==225){if(Yt!==-1)throw new Error(`first unknown JPEG marker at offset ${Yt.toString(16)}, second unknown JPEG marker ${kt.toString(16)} at offset ${(oe-1).toString(16)}`);Yt=oe-1;const Jt=be();if(_e[oe+Jt-2]===255){oe+=Jt-2;break}}throw new Error("unknown JPEG marker "+kt.toString(16))}kt=be()}if(zt.length!=1)throw new Error("only single frame JPEGs supported");for(var Qt=0;Qt<zt.length;Qt++){var Ei=zt[Qt].components;for(var ot in Ei)Ei[ot].quantizationTable=Pt[Ei[ot].quantizationIdx],delete Ei[ot].quantizationIdx}this.width=it.samplesPerLine,this.height=it.scanLines,this.jfif=Ce,this.adobe=Ne,this.components=[];for(var Qt=0;Qt<it.componentsOrder.length;Qt++){var hi=it.components[it.componentsOrder[Qt]];this.components.push({lines:J(it,hi),scaleX:hi.h/it.maxH,scaleY:hi.v/it.maxV})}},getData:function(_e,we){var oe=this.width/_e,be=this.height/we,ie,ue,Ce,Ne,it,rt,Pt,zt,vt,Vt,kt=0,Yt,Qt,ot,gt,pt,Bt,Zt,si,ii,pi,ai,Nt=_e*we*this.components.length;re(Nt);var ci=new Uint8Array(Nt);switch(this.components.length){case 1:for(ie=this.components[0],Vt=0;Vt<we;Vt++)for(it=ie.lines[0|Vt*ie.scaleY*be],vt=0;vt<_e;vt++)Yt=it[0|vt*ie.scaleX*oe],ci[kt++]=Yt;break;case 2:for(ie=this.components[0],ue=this.components[1],Vt=0;Vt<we;Vt++)for(it=ie.lines[0|Vt*ie.scaleY*be],rt=ue.lines[0|Vt*ue.scaleY*be],vt=0;vt<_e;vt++)Yt=it[0|vt*ie.scaleX*oe],ci[kt++]=Yt,Yt=rt[0|vt*ue.scaleX*oe],ci[kt++]=Yt;break;case 3:for(ai=!0,this.adobe&&this.adobe.transformCode?ai=!0:typeof this.opts.colorTransform!="undefined"&&(ai=!!this.opts.colorTransform),ie=this.components[0],ue=this.components[1],Ce=this.components[2],Vt=0;Vt<we;Vt++)for(it=ie.lines[0|Vt*ie.scaleY*be],rt=ue.lines[0|Vt*ue.scaleY*be],Pt=Ce.lines[0|Vt*Ce.scaleY*be],vt=0;vt<_e;vt++)ai?(Yt=it[0|vt*ie.scaleX*oe],Qt=rt[0|vt*ue.scaleX*oe],ot=Pt[0|vt*Ce.scaleX*oe],si=Y(Yt+1.402*(ot-128)),ii=Y(Yt-.3441363*(Qt-128)-.71413636*(ot-128)),pi=Y(Yt+1.772*(Qt-128))):(si=it[0|vt*ie.scaleX*oe],ii=rt[0|vt*ue.scaleX*oe],pi=Pt[0|vt*Ce.scaleX*oe]),ci[kt++]=si,ci[kt++]=ii,ci[kt++]=pi;break;case 4:if(!this.adobe)throw new Error("Unsupported color mode (4 components)");for(ai=!1,this.adobe&&this.adobe.transformCode?ai=!0:typeof this.opts.colorTransform!="undefined"&&(ai=!!this.opts.colorTransform),ie=this.components[0],ue=this.components[1],Ce=this.components[2],Ne=this.components[3],Vt=0;Vt<we;Vt++)for(it=ie.lines[0|Vt*ie.scaleY*be],rt=ue.lines[0|Vt*ue.scaleY*be],Pt=Ce.lines[0|Vt*Ce.scaleY*be],zt=Ne.lines[0|Vt*Ne.scaleY*be],vt=0;vt<_e;vt++)ai?(Yt=it[0|vt*ie.scaleX*oe],Qt=rt[0|vt*ue.scaleX*oe],ot=Pt[0|vt*Ce.scaleX*oe],gt=zt[0|vt*Ne.scaleX*oe],pt=255-Y(Yt+1.402*(ot-128)),Bt=255-Y(Yt-.3441363*(Qt-128)-.71413636*(ot-128)),Zt=255-Y(Yt+1.772*(Qt-128))):(pt=it[0|vt*ie.scaleX*oe],Bt=rt[0|vt*ue.scaleX*oe],Zt=Pt[0|vt*Ce.scaleX*oe],gt=zt[0|vt*Ne.scaleX*oe]),ci[kt++]=255-pt,ci[kt++]=255-Bt,ci[kt++]=255-Zt,ci[kt++]=255-gt;break;default:throw new Error("Unsupported color mode")}return ci},copyToImageData:function(_e,we){var oe=_e.width,be=_e.height,ie=_e.data,ue=this.getData(oe,be),Ce=0,Ne=0,it,rt,Pt,zt,vt,Vt,kt,Yt,Qt;switch(this.components.length){case 1:for(rt=0;rt<be;rt++)for(it=0;it<oe;it++)Pt=ue[Ce++],ie[Ne++]=Pt,ie[Ne++]=Pt,ie[Ne++]=Pt,we&&(ie[Ne++]=255);break;case 3:for(rt=0;rt<be;rt++)for(it=0;it<oe;it++)kt=ue[Ce++],Yt=ue[Ce++],Qt=ue[Ce++],ie[Ne++]=kt,ie[Ne++]=Yt,ie[Ne++]=Qt,we&&(ie[Ne++]=255);break;case 4:for(rt=0;rt<be;rt++)for(it=0;it<oe;it++)vt=ue[Ce++],Vt=ue[Ce++],Pt=ue[Ce++],zt=ue[Ce++],kt=255-Y(vt*(1-zt/255)+zt),Yt=255-Y(Vt*(1-zt/255)+zt),Qt=255-Y(Pt*(1-zt/255)+zt),ie[Ne++]=kt,ie[Ne++]=Yt,ie[Ne++]=Qt,we&&(ie[Ne++]=255);break;default:throw new Error("Unsupported color mode")}}};var fe=0,ee=0;function re(he=0){var _e=fe+he;if(_e>ee){var we=Math.ceil((_e-ee)/1024/1024);throw new Error(`maxMemoryUsageInMB limit exceeded by at least ${we}MB`)}fe=_e}return O.resetMaxMemoryUsage=function(he){fe=0,ee=he},O.getBytesAllocated=function(){return fe},O.requestMemoryAllocation=re,O}();n.exports=s;function s(l,p={}){var g={colorTransform:void 0,useTArray:!1,formatAsRGBA:!0,tolerantDecoding:!0,maxResolutionInMP:100,maxMemoryUsageInMB:512},w=Au(Au({},g),p),u=new Uint8Array(l),A=new t;A.opts=w,t.resetMaxMemoryUsage(w.maxMemoryUsageInMB*1024*1024),A.parse(u);var S=w.formatAsRGBA?4:3,D=A.width*A.height*S;try{t.requestMemoryAllocation(D);var z={width:A.width,height:A.height,exifBuffer:A.exifBuffer,data:w.useTArray?new Uint8Array(D):Buffer.alloc(D)};A.comments.length>0&&(z.comments=A.comments)}catch($){throw $ instanceof RangeError?new Error("Could not allocate enough memory for the image. Required: "+D):$}return A.copyToImageData(z,w.formatAsRGBA),z}})(decoder$1);var encode$2=encoder$1.exports,decode$5=decoder$1.exports,jpegJs={encode:encode$2,decode:decode$5};let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=new Uint8Array(256);for(let n=0;n<chars.length;n++)lookup[chars.charCodeAt(n)]=n;function encode$1(n){let t,s=n.length,l="";for(t=0;t<s;t+=3)l+=chars[n[t]>>2],l+=chars[(n[t]&3)<<4|n[t+1]>>4],l+=chars[(n[t+1]&15)<<2|n[t+2]>>6],l+=chars[n[t+2]&63];return s%3===2?l=`${l.substring(0,l.length-1)}=`:s%3===1&&(l=`${l.substring(0,l.length-2)}==`),l}function decode$4(n){let t=n.length*.75,s=n.length,l=0,p,g,w,u;n[n.length-1]==="="&&(t--,n[n.length-2]==="="&&t--);const A=new Uint8Array(t);for(let S=0;S<s;S+=4)p=lookup[n.charCodeAt(S)],g=lookup[n.charCodeAt(S+1)],w=lookup[n.charCodeAt(S+2)],u=lookup[n.charCodeAt(S+3)],A[l++]=p<<2|g>>4,A[l++]=(g&15)<<4|w>>2,A[l++]=(w&3)<<6|u&63;return A}function toBase64URL(n,t){const s=encode$1(n);return`data:${t};base64,${s}`}const ImageData=self.ImageData,DOMImage=self.Image;function createCanvas(n,t){let s=self.document.createElement("canvas");return s.width=n,s.height=t,s}function fetchBinary(n,{withCredentials:t=!1}={}){return new Promise(function(s,l){let p=new self.XMLHttpRequest;p.open("GET",n,!0),p.responseType="arraybuffer",p.withCredentials=t,p.onload=function(g){this.status!==200?l(g):s(this.response)},p.onerror=l,p.send()})}function createWriteStream(){throw new Error("createWriteStream does not exist in the browser")}function writeFile(){throw new Error("writeFile does not exist in the browser")}function getType(n){return n.includes("/")||(n=`image/${n}`),n}function encodeJpeg(n,t={}){const s={width:n.width,height:n.height,data:n.getRGBAData()};return jpegJs.encode(s,t.quality).data}function encodePng(n,t){const s={width:n.width,height:n.height,channels:n.channels,depth:n.bitDepth,data:n.data};return(s.depth===1||s.depth===32)&&(s.depth=8,s.channels=4,s.data=n.getRGBAData()),encodePng$1(s,t)}const exportMethods={save(n,t={}){const{useCanvas:s=!1,encoder:l=void 0}=t;let{format:p}=t;if(!p){const g=/\.(?<format>[a-zA-Z]+)$/.exec(n);g&&(p=g.groups.format.toLowerCase())}if(!p)throw new Error("file format not provided");return new Promise((g,w)=>{let u,A;switch(p.toLowerCase()){case"png":{s?u=this.getCanvas().pngStream():A=encodePng(this,l);break}case"jpg":case"jpeg":s?u=this.getCanvas().jpegStream():A=encodeJpeg(this,l);break;case"bmp":A=encode$4(this,l);break;default:throw new RangeError(`invalid output format: ${p}`)}if(u){let S=createWriteStream();S.on("finish",g),S.on("error",w),u.pipe(S)}else A&&writeFile()})},toDataURL(n="image/png",t={}){typeof n=="object"&&(t=n,n="image/png");const{useCanvas:s=!1,encoder:l=void 0}=t;n=getType(n);function p(g,w){const u=g(w,l);return toBase64URL(u,n)}return n==="image/bmp"?p(encode$4,this):n==="image/png"&&!s?p(encodePng,this):n==="image/jpeg"&&!s?p(encodeJpeg,this):this.getCanvas().toDataURL(n)},toBuffer(n={}){const{format:t="png",encoder:s=void 0}=n;switch(t.toLowerCase()){case"png":return encodePng(this,s);case"jpeg":case"jpg":return encodeJpeg(this,s);case"bmp":return encode$4(this,s);default:throw new RangeError(`invalid output format: ${t}`)}},toBase64(n="image/png",t={}){if(t.async)return this.toDataURL(n,t).then(function(s){return s.substring(s.indexOf(",")+1)});{const s=this.toDataURL(n,t);return s.substring(s.indexOf(",")+1)}},toBlob(n="image/png",t=.8){return canvasToBlob(this.getCanvas(),n,t)},getCanvas(){const n=new ImageData(this.getRGBAData({clamped:!0}),this.width,this.height);let t=createCanvas(this.width,this.height);return t.getContext("2d").putImageData(n,0,0),t}};function setExportMethods(n){for(const t in exportMethods)n.prototype[t]=exportMethods[t]}var hasOwn$1={exports:{}};const name="has-own",version="1.0.1",description="A safer .hasOwnProperty() - hasOwn(name, obj)",main="index.js",scripts={test:"make test"},author="Aaron Heckmann <aaron.heckmann+github@gmail.com>",license="MIT",repository={type:"git",url:"git://github.com/aheckmann/has-own.git"},homepage="https://github.com/aheckmann/has-own/",devDependencies={mocha:"^6.2.2"};var require$$0$3={name,version,description,main,scripts,author,license,repository,homepage,devDependencies};(function(n,t){var s=Object.prototype.hasOwnProperty;n.exports=t=function(p,g){return s.call(g,p)},t.version=require$$0$3.version})(hasOwn$1,hasOwn$1.exports);var hasOwn=hasOwn$1.exports;let computedPropertyDescriptor$1={configurable:!0,enumerable:!1,get:void 0};function extendMethod(n,t,s={}){let{inPlace:l=!1,returnThis:p=!0,partialArgs:g=[]}=s;return l?Image$1.prototype[n]=function(...w){this.computed=null;let u=t.apply(this,[...g,...w]);return p?this:u}:Image$1.prototype[n]=function(...w){return t.apply(this,[...g,...w])},Image$1}function extendProperty(n,t,s={}){let{partialArgs:l=[]}=s;return computedPropertyDescriptor$1.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(n,this.computed))return this.computed[n];let p=t.apply(this,l);return this.computed[n]=p,p},Object.defineProperty(Image$1.prototype,n,computedPropertyDescriptor$1),Image$1}const GREY$1="GREY",RGB$1="RGB",HSL="HSL",HSV="HSV",CMYK$1="CMYK";var ColorModel=Object.freeze(Object.defineProperty({__proto__:null,GREY:GREY$1,RGB:RGB$1,HSL,HSV,CMYK:CMYK$1},Symbol.toStringTag,{value:"Module"}));function getRGBAData(n={}){const{clamped:t}=n;this.checkProcessable("getRGBAData",{components:[1,3],bitDepth:[1,8,16,32]});const s=this.width*this.height*4;let l=t?new Uint8ClampedArray(s):new Uint8Array(s);return this.bitDepth===1?fillDataFromBinary(this,l):this.bitDepth===32?(this.checkProcessable("getRGBAData",{alpha:0}),this.components===1?fillDataFromGrey32(this,l):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB32(this,l))):this.components===1?fillDataFromGrey(this,l):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB(this,l)),this.alpha===1?(this.checkProcessable("getRGBAData",{bitDepth:[8,16]}),copyAlpha(this,l)):fillAlpha(this,l),l}function fillDataFromBinary(n,t){for(let s=0;s<n.size;s++){const l=n.getBit(s);t[s*4]=l*255,t[s*4+1]=l*255,t[s*4+2]=l*255}}function fillDataFromGrey32(n,t){const s=n.min[0],p=n.max[0]-s;for(let g=0;g<n.size;g++){const w=Math.floor(255*(n.data[g]-s)/p);t[g*4]=w,t[g*4+1]=w,t[g*4+2]=w}}function fillDataFromRGB32(n,t){const s=Math.min(...n.min),p=Math.max(...n.max)-s;for(let g=0;g<n.size;g++){const w=Math.floor(255*(n.data[g*3]-s)/p),u=Math.floor(255*(n.data[g*3+1]-s)/p),A=Math.floor(255*(n.data[g*3+2]-s)/p);t[g*4]=w,t[g*4+1]=u,t[g*4+2]=A}}function fillDataFromGrey(n,t){for(let s=0;s<n.size;s++)t[s*4]=n.data[s*n.channels]>>>n.bitDepth-8,t[s*4+1]=n.data[s*n.channels]>>>n.bitDepth-8,t[s*4+2]=n.data[s*n.channels]>>>n.bitDepth-8}function fillDataFromRGB(n,t){for(let s=0;s<n.size;s++)t[s*4]=n.data[s*n.channels]>>>n.bitDepth-8,t[s*4+1]=n.data[s*n.channels+1]>>>n.bitDepth-8,t[s*4+2]=n.data[s*n.channels+2]>>>n.bitDepth-8}function copyAlpha(n,t){for(let s=0;s<n.size;s++)t[s*4+3]=n.data[s*n.channels+n.components]>>n.bitDepth-8}function fillAlpha(n,t){for(let s=0;s<n.size;s++)t[s*4+3]=255}const BINARY="BINARY",GREY="GREY",GREYA="GREYA",RGB="RGB",RGBA="RGBA",CMYK="CMYK",CMYKA="CMYKA",kinds={};kinds[BINARY]={components:1,alpha:0,bitDepth:1,colorModel:GREY$1};kinds[GREYA]={components:1,alpha:1,bitDepth:8,colorModel:GREY$1};kinds[GREY]={components:1,alpha:0,bitDepth:8,colorModel:GREY$1};kinds[RGBA]={components:3,alpha:1,bitDepth:8,colorModel:RGB$1};kinds[RGB]={components:3,alpha:0,bitDepth:8,colorModel:RGB$1};kinds[CMYK]={components:4,alpha:0,bitDepth:8,colorModel:CMYK$1};kinds[CMYKA]={components:4,alpha:1,bitDepth:8,colorModel:CMYK$1};function getKind(n){const t=kinds[n];if(!t)throw new RangeError(`invalid image kind: ${n}`);return t}const validBitDepth=[1,8,16,32];function verifyKindDefinition(n){const{components:t,alpha:s,bitDepth:l,colorModel:p}=n;if(!Number.isInteger(t)||t<=0)throw new RangeError(`invalid components: ${t}. Must be a positive integer`);if(s!==0&&s!==1&&typeof s!="boolean")throw new TypeError(`invalid alpha: ${s}: must be a boolean, 0 or 1`);if(!validBitDepth.includes(l))throw new RangeError(`invalid bitDepth: ${l}. Must be one of ${validBitDepth.join(", ")}`);if(!ColorModel[p])throw new RangeError(`invalid colorModel: ${p}. Must be one of ${Object.keys(ColorModel).join(", ")}`)}function getTheoreticalPixelArraySize(n,t,s){let l=t*n;return s===1&&(l=Math.ceil(l/8)),l}function createPixelArray(n,t,s,l,p,g){const w=l*n;let u;switch(p){case 1:u=new Uint8Array(Math.ceil(w/8));break;case 8:u=new Uint8Array(w);break;case 16:u=new Uint16Array(w);break;case 32:u=new Float32Array(w);break;default:throw new Error(`Cannot create pixel array for bit depth ${p}`)}if(s)for(let A=t;A<u.length;A+=l)u[A]=g;return u}const defaultByteLength$1=1024*8,charArray=[];class IOBuffer$3{constructor(t,s){s=s||{},t===void 0&&(t=defaultByteLength$1),typeof t=="number"&&(t=new ArrayBuffer(t));let l=t.byteLength;const p=s.offset?s.offset>>>0:0;t.buffer&&(l=t.byteLength-p,t.byteLength!==t.buffer.byteLength?t=t.buffer.slice(t.byteOffset+p,t.byteOffset+t.byteLength):p?t=t.buffer.slice(p):t=t.buffer),this.buffer=t,this.length=l,this.byteLength=l,this.byteOffset=0,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer),this._increment=l||defaultByteLength$1,this._mark=0}available(t){return t===void 0&&(t=1),this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){this.littleEndian=!0}isBigEndian(){return!this.littleEndian}setBigEndian(){this.littleEndian=!1}skip(t){t===void 0&&(t=1),this.offset+=t}seek(t){this.offset=t}mark(){this._mark=this.offset}reset(){this.offset=this._mark}rewind(){this.offset=0}ensureAvailable(t){if(t===void 0&&(t=1),!this.available(t)){const s=this._increment+this._increment;this._increment=s;const l=this.length+s,p=new Uint8Array(l);p.set(new Uint8Array(this.buffer)),this.buffer=p.buffer,this.length=l,this._data=new DataView(this.buffer)}}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t){t===void 0&&(t=1);for(var s=new Uint8Array(t),l=0;l<t;l++)s[l]=this.readByte();return s}readInt16(){var t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){var t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){var t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){var t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){var t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){var t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t){t===void 0&&(t=1),charArray.length=t;for(var s=0;s<t;s++)charArray[s]=this.readChar();return charArray.join("")}writeBoolean(t){this.writeUint8(t?255:0)}writeInt8(t){this.ensureAvailable(1),this._data.setInt8(this.offset++,t)}writeUint8(t){this.ensureAvailable(1),this._data.setUint8(this.offset++,t)}writeByte(t){this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(var s=0;s<t.length;s++)this._data.setUint8(this.offset++,t[s])}writeInt16(t){this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2}writeUint16(t){this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2}writeInt32(t){this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4}writeUint32(t){this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4}writeFloat32(t){this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4}writeFloat64(t){this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8}writeChar(t){this.writeUint8(t.charCodeAt(0))}writeChars(t){for(var s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s))}toArray(){return new Uint8Array(this.buffer,0,this.offset)}}var IOBuffer_1=IOBuffer$3,src$4={};const tagsById$5={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName$5={};for(var i$3 in tagsById$5)tagsByName$5[tagsById$5[i$3]]=i$3;var standard$1={tagsById:tagsById$5,tagsByName:tagsByName$5};const tagsById$4={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$4={};for(var i$2 in tagsById$4)tagsByName$4[tagsById$4[i$2]]=i$2;var exif$1={tagsById:tagsById$4,tagsByName:tagsByName$4};const tagsById$3={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$3={};for(var i$1 in tagsById$3)tagsByName$3[tagsById$3[i$1]]=i$1;var gps$1={tagsById:tagsById$3,tagsByName:tagsByName$3};const tags$1={standard:standard$1,exif:exif$1,gps:gps$1};class IFD$2{constructor(t){if(!t)throw new Error("missing kind");this.data=null,this.fields=new Map,this.kind=t,this._map=null}get(t){if(typeof t=="number")return this.fields.get(t);if(typeof t=="string")return this.fields.get(tags$1[this.kind].tagsByName[t]);throw new Error("expected a number or string")}get map(){if(!this._map){this._map={};const s=tags$1[this.kind].tagsById;for(var t of this.fields.keys())s[t]&&(this._map[s[t]]=this.fields.get(t))}return this._map}}var ifd=IFD$2;const Ifd=ifd,dateTimeRegex$1=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd$1 extends Ifd{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){var t=new Date,s=dateTimeRegex$1.exec(this.dateTime);return t.setFullYear(s[1],s[2]-1,s[3]),t.setHours(s[4],s[5],s[6]),t}get newSubfileType(){return this.get(254)}get imageWidth(){return this.get(256)}get imageLength(){return this.get(257)}get bitsPerSample(){return this.get(258)}get compression(){return this.get(259)||1}get type(){return this.get(262)}get fillOrder(){return this.get(266)||1}get documentName(){return this.get(269)}get imageDescription(){return this.get(270)}get stripOffsets(){return alwaysArray$1(this.get(273))}get orientation(){return this.get(274)}get samplesPerPixel(){return this.get(277)}get rowsPerStrip(){return this.get(278)}get stripByteCounts(){return alwaysArray$1(this.get(279))}get minSampleValue(){return this.get(280)||0}get maxSampleValue(){return this.get(281)||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get(282)}get yResolution(){return this.get(283)}get planarConfiguration(){return this.get(284)||1}get resolutionUnit(){return this.get(296)||2}get dateTime(){return this.get(306)}get predictor(){return this.get(317)||1}get sampleFormat(){return this.get(339)||1}get sMinSampleValue(){return this.get(340)||this.minSampleValue}get sMaxSampleValue(){return this.get(341)||this.maxSampleValue}}function alwaysArray$1(n){return typeof n=="number"?[n]:n}var tiffIfd=TiffIfd$1,ifdValue={},types$1=new Map([[1,[1,readByte$1]],[2,[1,readASCII$1]],[3,[2,readShort$1]],[4,[4,readLong$1]],[5,[8,readRational$1]],[6,[1,readSByte$1]],[7,[1,readByte$1]],[8,[2,readSShort$1]],[9,[4,readSLong$1]],[10,[8,readSRational$1]],[11,[4,readFloat$1]],[12,[8,readDouble$1]]]);ifdValue.getByteLength=function(n,t){return types$1.get(n)[0]*t};ifdValue.readData=function(n,t,s){return types$1.get(t)[1](n,s)};function readByte$1(n,t){if(t===1)return n.readUint8();for(var s=new Uint8Array(t),l=0;l<t;l++)s[l]=n.readUint8();return s}function readASCII$1(n,t){for(var s=[],l="",p=0;p<t;p++){var g=String.fromCharCode(n.readUint8());g==="\0"?(s.push(l),l=""):l+=g}return s.length===1?s[0]:s}function readShort$1(n,t){if(t===1)return n.readUint16();for(var s=new Uint16Array(t),l=0;l<t;l++)s[l]=n.readUint16();return s}function readLong$1(n,t){if(t===1)return n.readUint32();for(var s=new Uint32Array(t),l=0;l<t;l++)s[l]=n.readUint32();return s}function readRational$1(n,t){if(t===1)return n.readUint32()/n.readUint32();for(var s=new Array(t),l=0;l<t;l++)s[l]=n.readUint32()/n.readUint32();return s}function readSByte$1(n,t){if(t===1)return n.readInt8();for(var s=new Int8Array(t),l=0;l<t;l++)s[l]=n.readInt8();return s}function readSShort$1(n,t){if(t===1)return n.readInt16();for(var s=new Int16Array(t),l=0;l<t;l++)s[l]=n.readInt16();return s}function readSLong$1(n,t){if(t===1)return n.readInt32();for(var s=new Int32Array(t),l=0;l<t;l++)s[l]=n.readInt32();return s}function readSRational$1(n,t){if(t===1)return n.readInt32()/n.readInt32();for(var s=new Array(t),l=0;l<t;l++)s[l]=n.readInt32()/n.readInt32();return s}function readFloat$1(n,t){if(t===1)return n.readFloat32();for(var s=new Float32Array(t),l=0;l<t;l++)s[l]=n.readFloat32();return s}function readDouble$1(n,t){if(t===1)return n.readFloat64();for(var s=new Float64Array(t),l=0;l<t;l++)s[l]=n.readFloat64();return s}const IOBuffer$2=IOBuffer_1,IFD$1=ifd,TiffIFD=tiffIfd,IFDValue=ifdValue,defaultOptions$d={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder$2 extends IOBuffer$2{constructor(t,s){super(t,s),this._nextIFD=0}decode(t){t=Object.assign({},defaultOptions$d,t);const s=[];for(this.decodeHeader();this._nextIFD;)if(s.push(this.decodeIFD(t)),t.onlyFirst)return s[0];return s}decodeHeader(){let t=this.readUint16();if(t===18761)this.setLittleEndian();else if(t===19789)this.setBigEndian();else throw new Error("invalid byte order: 0x"+t.toString(16));if(t=this.readUint16(),t!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(t){this.seek(this._nextIFD);var s;t.kind?s=new IFD$1(t.kind):s=new TiffIFD;const l=this.readUint16();for(var p=0;p<l;p++)this.decodeIFDEntry(s);return t.ignoreImageData||this.decodeImageData(s),this._nextIFD=this.readUint32(),s}decodeIFDEntry(t){const s=this.offset,l=this.readUint16(),p=this.readUint16(),g=this.readUint32();if(p<1||p>12){this.skip(4);return}IFDValue.getByteLength(p,g)>4&&this.seek(this.readUint32());const u=IFDValue.readData(this,p,g);if(t.fields.set(l,u),l===34665||l===34853){let A=this.offset,S;l===34665?S="exif":l===34853&&(S="gps"),this._nextIFD=u,t[S]=this.decodeIFD({kind:S,ignoreImageData:!0}),this.offset=A}this.seek(s),this.skip(12)}decodeImageData(t){const s=t.orientation;switch(s&&s!==1&&unsupported$1("orientation",s),t.type){case 1:case 2:this.readStripData(t);break;default:unsupported$1("image type",t.type);break}}readStripData(t){const s=t.width,l=t.height,p=validateBitDepth(t.bitsPerSample),g=t.sampleFormat;let w=s*l;const u=getDataArray$1(w,1,p,g),A=t.compression,D=t.rowsPerStrip*s,z=t.stripOffsets,$=t.stripByteCounts;for(var O=0,q=0;q<z.length;q++){var K=this.getStripData(A,z[q],$[q]),J=w>D?D:w;w-=J,p===8?O=fill8bit$1(u,K,O,J):p===16?O=fill16bit$1(u,K,O,J,this.isLittleEndian()):p===32&&g===3?O=fillFloat32$1(u,K,O,J,this.isLittleEndian()):unsupported$1("bitDepth",p)}t.data=u}getStripData(t,s,l){switch(t){case 1:return new DataView(this.buffer,s,l);case 2:case 32773:return unsupported$1("Compression",t);default:throw new Error("invalid compression: "+t)}}}var tiffDecoder=TIFFDecoder$2;function getDataArray$1(n,t,s,l){return s===8?new Uint8Array(n*t):s===16?new Uint16Array(n*t):s===32&&l===3?new Float32Array(n*t):unsupported$1("bit depth / sample format",s+" / "+l)}function fill8bit$1(n,t,s,l){for(var p=0;p<l;p++)n[s++]=t.getUint8(p);return s}function fill16bit$1(n,t,s,l,p){for(var g=0;g<l*2;g+=2)n[s++]=t.getUint16(g,p);return s}function fillFloat32$1(n,t,s,l,p){for(var g=0;g<l*4;g+=4)n[s++]=t.getFloat32(g,p);return s}function unsupported$1(n,t){throw new Error("Unsupported "+n+": "+t)}function validateBitDepth(n){if(n.length){const s=n;n=s[0];for(var t=0;t<s.length;t++)s[t]!==n&&unsupported$1("bit depth",s)}return n}const TIFFDecoder$1=tiffDecoder;var decode$3=function(t,s){return new TIFFDecoder$1(t,s).decode(s)};src$4.decode=decode$3;const IOBuffer$1=IOBuffer_1,tiff=src$4;function decode$2(n){const t=new IOBuffer$1(n),s={};if(t.setBigEndian(),t.readUint16()!==65496)throw new Error("SOI marker not found. Not a valid JPEG file");if(t.readUint16()===65505){t.readUint16();const g=t.readBytes(6);if(g[0]===69&&g[1]===120&&g[2]===105&&g[3]===102&&g[4]===0&&g[5]===0){const w=tiff.decode(t,{onlyFirst:!0,ignoreImageData:!0,offset:t.offset});s.exif=w}}return s}var decode_1=decode$2,decode$1=decode_1,imageType$2={exports:{}},fileType$1={exports:{}};(function(module){const toBytes=n=>[...n].map(t=>t.charCodeAt(0)),xpiZipFilename=toBytes("META-INF/mozilla.rsa"),oxmlContentTypes=toBytes("[Content_Types].xml"),oxmlRels=toBytes("_rels/.rels");function readUInt64LE(n,t=0){let s=n[t],l=1,p=0;for(;++p<8;)l*=256,s+=n[t+p]*l;return s}const fileType=n=>{if(!(n instanceof Uint8Array||n instanceof ArrayBuffer||Buffer.isBuffer(n)))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`Buffer\` or \`ArrayBuffer\`, got \`${typeof n}\``);const t=n instanceof Uint8Array?n:new Uint8Array(n);if(!(t&&t.length>1))return null;const s=(p,g)=>{g=Object.assign({offset:0},g);for(let w=0;w<p.length;w++)if(g.mask){if(p[w]!==(g.mask[w]&t[w+g.offset]))return!1}else if(p[w]!==t[w+g.offset])return!1;return!0},l=(p,g)=>s(toBytes(p),g);if(s([255,216,255]))return{ext:"jpg",mime:"image/jpeg"};if(s([137,80,78,71,13,10,26,10]))return{ext:"png",mime:"image/png"};if(s([71,73,70]))return{ext:"gif",mime:"image/gif"};if(s([87,69,66,80],{offset:8}))return{ext:"webp",mime:"image/webp"};if(s([70,76,73,70]))return{ext:"flif",mime:"image/flif"};if((s([73,73,42,0])||s([77,77,0,42]))&&s([67,82],{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(s([73,73,42,0])||s([77,77,0,42]))return{ext:"tif",mime:"image/tiff"};if(s([66,77]))return{ext:"bmp",mime:"image/bmp"};if(s([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(s([56,66,80,83]))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(s([80,75,3,4])){if(s([109,105,109,101,116,121,112,101,97,112,112,108,105,99,97,116,105,111,110,47,101,112,117,98,43,122,105,112],{offset:30}))return{ext:"epub",mime:"application/epub+zip"};if(s(xpiZipFilename,{offset:30}))return{ext:"xpi",mime:"application/x-xpinstall"};if(l("mimetypeapplication/vnd.oasis.opendocument.text",{offset:30}))return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};if(l("mimetypeapplication/vnd.oasis.opendocument.spreadsheet",{offset:30}))return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};if(l("mimetypeapplication/vnd.oasis.opendocument.presentation",{offset:30}))return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};const p=(A,S=0)=>A.findIndex((D,z,$)=>z>=S&&$[z]===80&&$[z+1]===75&&$[z+2]===3&&$[z+3]===4);let g=0,w=!1,u=null;do{const A=g+30;if(w||(w=s(oxmlContentTypes,{offset:A})||s(oxmlRels,{offset:A})),u||(l("word/",{offset:A})?u={ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}:l("ppt/",{offset:A})?u={ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}:l("xl/",{offset:A})&&(u={ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),w&&u)return u;g=p(t,A)}while(g>=0);if(u)return u}if(s([80,75])&&(t[2]===3||t[2]===5||t[2]===7)&&(t[3]===4||t[3]===6||t[3]===8))return{ext:"zip",mime:"application/zip"};if(s([117,115,116,97,114],{offset:257}))return{ext:"tar",mime:"application/x-tar"};if(s([82,97,114,33,26,7])&&(t[6]===0||t[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(s([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(s([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(s([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(s([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(s([51,103,112,53])||s([0,0,0])&&s([102,116,121,112],{offset:4})&&(s([109,112,52,49],{offset:8})||s([109,112,52,50],{offset:8})||s([105,115,111,109],{offset:8})||s([105,115,111,50],{offset:8})||s([109,109,112,52],{offset:8})||s([77,52,86],{offset:8})||s([100,97,115,104],{offset:8})))return{ext:"mp4",mime:"video/mp4"};if(s([77,84,104,100]))return{ext:"mid",mime:"audio/midi"};if(s([26,69,223,163])){const p=t.subarray(4,4100),g=p.findIndex((w,u,A)=>A[u]===66&&A[u+1]===130);if(g!==-1){const w=g+3,u=A=>[...A].every((S,D)=>p[w+D]===S.charCodeAt(0));if(u("matroska"))return{ext:"mkv",mime:"video/x-matroska"};if(u("webm"))return{ext:"webm",mime:"video/webm"}}}if(s([0,0,0,20,102,116,121,112,113,116,32,32])||s([102,114,101,101],{offset:4})||s([102,116,121,112,113,116,32,32],{offset:4})||s([109,100,97,116],{offset:4})||s([109,111,111,118],{offset:4})||s([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(s([82,73,70,70])){if(s([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(s([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/vnd.wave"};if(s([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(s([48,38,178,117,142,102,207,17,166,217])){let p=30;do{const g=readUInt64LE(t,p+16);if(s([145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101],{offset:p})){if(s([64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43],{offset:p+24}))return{ext:"wma",mime:"audio/x-ms-wma"};if(s([192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43],{offset:p+24}))return{ext:"wmv",mime:"video/x-ms-asf"};break}p+=g}while(p+24<=t.length);return{ext:"asf",mime:"application/vnd.ms-asf"}}if(s([0,0,1,186])||s([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(s([102,116,121,112,51,103],{offset:4}))return{ext:"3gp",mime:"video/3gpp"};for(let p=0;p<2&&p<t.length-16;p++){if(s([73,68,51],{offset:p})||s([255,226],{offset:p,mask:[255,226]}))return{ext:"mp3",mime:"audio/mpeg"};if(s([255,228],{offset:p,mask:[255,228]}))return{ext:"mp2",mime:"audio/mpeg"};if(s([255,248],{offset:p,mask:[255,252]}))return{ext:"mp2",mime:"audio/mpeg"};if(s([255,240],{offset:p,mask:[255,252]}))return{ext:"mp4",mime:"audio/mpeg"}}if(s([102,116,121,112,77,52,65],{offset:4}))return{ext:"m4a",mime:"audio/mp4"};if(s([79,112,117,115,72,101,97,100],{offset:28}))return{ext:"opus",mime:"audio/opus"};if(s([79,103,103,83]))return s([128,116,104,101,111,114,97],{offset:28})?{ext:"ogv",mime:"video/ogg"}:s([1,118,105,100,101,111,0],{offset:28})?{ext:"ogm",mime:"video/ogg"}:s([127,70,76,65,67],{offset:28})?{ext:"oga",mime:"audio/ogg"}:s([83,112,101,101,120,32,32],{offset:28})?{ext:"spx",mime:"audio/ogg"}:s([1,118,111,114,98,105,115],{offset:28})?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"};if(s([102,76,97,67]))return{ext:"flac",mime:"audio/x-flac"};if(s([77,65,67,32]))return{ext:"ape",mime:"audio/ape"};if(s([119,118,112,107]))return{ext:"wv",mime:"audio/wavpack"};if(s([35,33,65,77,82,10]))return{ext:"amr",mime:"audio/amr"};if(s([37,80,68,70]))return{ext:"pdf",mime:"application/pdf"};if(s([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if((t[0]===67||t[0]===70)&&s([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(s([123,92,114,116,102]))return{ext:"rtf",mime:"application/rtf"};if(s([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(s([119,79,70,70])&&(s([0,1,0,0],{offset:4})||s([79,84,84,79],{offset:4})))return{ext:"woff",mime:"font/woff"};if(s([119,79,70,50])&&(s([0,1,0,0],{offset:4})||s([79,84,84,79],{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(s([76,80],{offset:34})&&(s([0,0,1],{offset:8})||s([1,0,2],{offset:8})||s([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(s([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(s([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(s([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(s([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(s([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(s([37,33]))return{ext:"ps",mime:"application/postscript"};if(s([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(s([83,81,76,105]))return{ext:"sqlite",mime:"application/x-sqlite3"};if(s([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(s([67,114,50,52]))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(s([77,83,67,70])||s([73,83,99,40]))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(s([33,60,97,114,99,104,62,10,100,101,98,105,97,110,45,98,105,110,97,114,121]))return{ext:"deb",mime:"application/x-deb"};if(s([33,60,97,114,99,104,62]))return{ext:"ar",mime:"application/x-unix-archive"};if(s([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(s([31,160])||s([31,157]))return{ext:"Z",mime:"application/x-compress"};if(s([76,90,73,80]))return{ext:"lz",mime:"application/x-lzip"};if(s([208,207,17,224,161,177,26,225]))return{ext:"msi",mime:"application/x-msi"};if(s([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(s([71],{offset:4})&&(s([71],{offset:192})||s([71],{offset:196})))return{ext:"mts",mime:"video/mp2t"};if(s([66,76,69,78,68,69,82]))return{ext:"blend",mime:"application/x-blender"};if(s([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(s([0,0,0,12,106,80,32,32,13,10,135,10])){if(s([106,112,50,32],{offset:20}))return{ext:"jp2",mime:"image/jp2"};if(s([106,112,120,32],{offset:20}))return{ext:"jpx",mime:"image/jpx"};if(s([106,112,109,32],{offset:20}))return{ext:"jpm",mime:"image/jpm"};if(s([109,106,112,50],{offset:20}))return{ext:"mj2",mime:"image/mj2"}}if(s([70,79,82,77]))return{ext:"aif",mime:"audio/aiff"};if(l("<?xml "))return{ext:"xml",mime:"application/xml"};if(s([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(s([102,116,121,112],{offset:4})){if(s([109,105,102,49],{offset:8}))return{ext:"heic",mime:"image/heif"};if(s([109,115,102,49],{offset:8}))return{ext:"heic",mime:"image/heif-sequence"};if(s([104,101,105,99],{offset:8})||s([104,101,105,120],{offset:8}))return{ext:"heic",mime:"image/heic"};if(s([104,101,118,99],{offset:8})||s([104,101,118,120],{offset:8}))return{ext:"heic",mime:"image/heic-sequence"}}return s([171,75,84,88,32,49,49,187,13,10,26,10])?{ext:"ktx",mime:"image/ktx"}:s([68,73,67,77],{offset:128})?{ext:"dcm",mime:"application/dicom"}:s([77,80,43])?{ext:"mpc",mime:"audio/x-musepack"}:s([77,80,67,75])?{ext:"mpc",mime:"audio/x-musepack"}:s([66,69,71,73,78,58])?{ext:"ics",mime:"text/calendar"}:s([103,108,84,70,2,0,0,0])?{ext:"glb",mime:"model/gltf-binary"}:s([212,195,178,161])||s([161,178,195,212])?{ext:"pcap",mime:"application/vnd.tcpdump.pcap"}:null};module.exports=fileType,module.exports.default=fileType,Object.defineProperty(fileType,"minimumBytes",{value:4100}),module.exports.stream=readableStream=>new Promise((resolve,reject)=>{const stream=eval("require")("stream");readableStream.once("readable",()=>{const n=new stream.PassThrough,t=readableStream.read(module.exports.minimumBytes)||readableStream.read();try{n.fileType=fileType(t)}catch(s){reject(s)}readableStream.unshift(t),stream.pipeline?resolve(stream.pipeline(readableStream,n,()=>{})):resolve(readableStream.pipe(n))})})})(fileType$1);const fileType=fileType$1.exports,imageExts=new Set(["jpg","png","gif","webp","flif","cr2","tif","bmp","jxr","psd","ico","bpg","jp2","jpm","jpx","heic","cur","dcm"]),imageType=n=>{const t=fileType(n);return imageExts.has(t&&t.ext)?t:null};imageType$2.exports=imageType;imageType$2.exports.default=imageType;Object.defineProperty(imageType,"minimumBytes",{value:fileType.minimumBytes});var imageType$1=imageType$2.exports;(function(n){if(n.TextEncoder&&n.TextDecoder)return!1;function t(l="utf-8"){if(l!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${l}') is invalid.`)}Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),t.prototype.encode=function(l,p={stream:!1}){if(p.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let g=0;const w=l.length;let u=0,A=Math.max(32,w+(w>>1)+7),S=new Uint8Array(A>>3<<3);for(;g<w;){let D=l.charCodeAt(g++);if(D>=55296&&D<=56319){if(g<w){const z=l.charCodeAt(g);(z&64512)===56320&&(++g,D=((D&1023)<<10)+(z&1023)+65536)}if(D>=55296&&D<=56319)continue}if(u+4>S.length){A+=8,A*=1+g/l.length*2,A=A>>3<<3;const z=new Uint8Array(A);z.set(S),S=z}if((D&4294967168)===0){S[u++]=D;continue}else if((D&4294965248)===0)S[u++]=D>>6&31|192;else if((D&4294901760)===0)S[u++]=D>>12&15|224,S[u++]=D>>6&63|128;else if((D&4292870144)===0)S[u++]=D>>18&7|240,S[u++]=D>>12&63|128,S[u++]=D>>6&63|128;else continue;S[u++]=D&63|128}return S.slice(0,u)};function s(l="utf-8",p={fatal:!1}){if(l!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${l}') is invalid.`);if(p.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(s.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(s.prototype,"fatal",{value:!1}),Object.defineProperty(s.prototype,"ignoreBOM",{value:!1}),s.prototype.decode=function(l,p={stream:!1}){if(p.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const g=new Uint8Array(l);let w=0;const u=g.length,A=[];for(;w<u;){const S=g[w++];if(S===0)break;if((S&128)===0)A.push(S);else if((S&224)===192){const D=g[w++]&63;A.push((S&31)<<6|D)}else if((S&240)===224){const D=g[w++]&63,z=g[w++]&63;A.push((S&31)<<12|D<<6|z)}else if((S&248)===240){const D=g[w++]&63,z=g[w++]&63,$=g[w++]&63;let O=(S&7)<<18|D<<12|z<<6|$;O>65535&&(O-=65536,A.push(O>>>10&1023|55296),O=56320|O&1023),A.push(O)}}return String.fromCharCode.apply(null,A)},n.TextEncoder=t,n.TextDecoder=s})(typeof window!="undefined"?window:typeof self!="undefined"?self:globalThis);const decoder=new TextDecoder("utf-8");function decode(n){return decoder.decode(n)}const encoder=new TextEncoder;function encode(n){return encoder.encode(n)}const defaultByteLength=1024*8;class IOBuffer{constructor(t=defaultByteLength,s={}){let l=!1;typeof t=="number"?t=new ArrayBuffer(t):(l=!0,this.lastWrittenByte=t.byteLength);const p=s.offset?s.offset>>>0:0,g=t.byteLength-p;let w=p;(ArrayBuffer.isView(t)||t instanceof IOBuffer)&&(t.byteLength!==t.buffer.byteLength&&(w=t.byteOffset+p),t=t.buffer),l?this.lastWrittenByte=g:this.lastWrittenByte=0,this.buffer=t,this.length=g,this.byteLength=g,this.byteOffset=w,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,w,g),this._mark=0,this._marks=[]}available(t=1){return this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t=1){return this.offset+=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(t===void 0)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t=1){if(!this.available(t)){const l=(this.offset+t)*2,p=new Uint8Array(l);p.set(new Uint8Array(this.buffer)),this.buffer=p.buffer,this.length=this.byteLength=l,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t=1){const s=new Uint8Array(t);for(let l=0;l<t;l++)s[l]=this.readByte();return s}readInt16(){const t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){const t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){const t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){const t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){const t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){const t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readBigInt64(){const t=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,t}readBigUint64(){const t=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t=1){let s="";for(let l=0;l<t;l++)s+=this.readChar();return s}readUtf8(t=1){return decode(this.readBytes(t))}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(let s=0;s<t.length;s++)this._data.setUint8(this.offset++,t[s]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(t){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(t){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(let s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));return this}writeUtf8(t){return this.writeBytes(encode(t))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}function guessStripByteCounts(n){if(n.compression!==1)throw new Error("missing mandatory StripByteCounts field in compressed image");const t=n.rowsPerStrip*n.width*n.samplesPerPixel*(n.bitsPerSample/8);return new Array(n.stripOffsets.length).fill(t)}function applyHorizontalDifferencing8Bit(n,t,s){let l=0;for(;l<n.length;){for(let p=s;p<t*s;p+=s)for(let g=0;g<s;g++)n[l+p+g]=n[l+p+g]+n[l+p-(s-g)]&255;l+=t*s}}function applyHorizontalDifferencing16Bit(n,t,s){let l=0;for(;l<n.length;){for(let p=s;p<t*s;p+=s)for(let g=0;g<s;g++)n[l+p+g]=n[l+p+g]+n[l+p-(s-g)]&65535;l+=t*s}}const tagsById$2={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$2={};for(let n in tagsById$2)tagsByName$2[tagsById$2[n]]=Number(n);var exif=Object.freeze(Object.defineProperty({__proto__:null,tagsById:tagsById$2,tagsByName:tagsByName$2},Symbol.toStringTag,{value:"Module"}));const tagsById$1={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$1={};for(let n in tagsById$1)tagsByName$1[tagsById$1[n]]=Number(n);var gps=Object.freeze(Object.defineProperty({__proto__:null,tagsById:tagsById$1,tagsByName:tagsByName$1},Symbol.toStringTag,{value:"Module"}));const tagsById={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName={};for(let n in tagsById)tagsByName[tagsById[n]]=Number(n);var standard=Object.freeze(Object.defineProperty({__proto__:null,tagsById,tagsByName},Symbol.toStringTag,{value:"Module"}));const tags={standard,exif,gps};class IFD{constructor(t){if(!t)throw new Error("missing kind");this.data=new Uint8Array,this.fields=new Map,this.kind=t,this._hasMap=!1,this._map={}}get(t){if(typeof t=="number")return this.fields.get(t);if(typeof t=="string")return this.fields.get(tags[this.kind].tagsByName[t]);throw new Error("expected a number or string")}get map(){if(!this._hasMap){const t=tags[this.kind].tagsById;for(let s of this.fields.keys())t[s]&&(this._map[t[s]]=this.fields.get(s));this._hasMap=!0}return this._map}}let types=new Map([[1,[1,readByte]],[2,[1,readASCII]],[3,[2,readShort]],[4,[4,readLong]],[5,[8,readRational]],[6,[1,readSByte]],[7,[1,readByte]],[8,[2,readSShort]],[9,[4,readSLong]],[10,[8,readSRational]],[11,[4,readFloat]],[12,[8,readDouble]]]);function getByteLength(n,t){const s=types.get(n);if(!s)throw new Error(`type not found: ${n}`);return s[0]*t}function readData(n,t,s){const l=types.get(t);if(!l)throw new Error(`type not found: ${t}`);return l[1](n,s)}function readByte(n,t){if(t===1)return n.readUint8();let s=new Uint8Array(t);for(let l=0;l<t;l++)s[l]=n.readUint8();return s}function readASCII(n,t){let s=[],l="";for(let p=0;p<t;p++){let g=String.fromCharCode(n.readUint8());g==="\0"?(s.push(l),l=""):l+=g}return s.length===1?s[0]:s}function readShort(n,t){if(t===1)return n.readUint16();let s=new Uint16Array(t);for(let l=0;l<t;l++)s[l]=n.readUint16();return s}function readLong(n,t){if(t===1)return n.readUint32();let s=new Uint32Array(t);for(let l=0;l<t;l++)s[l]=n.readUint32();return s}function readRational(n,t){if(t===1)return n.readUint32()/n.readUint32();let s=new Array(t);for(let l=0;l<t;l++)s[l]=n.readUint32()/n.readUint32();return s}function readSByte(n,t){if(t===1)return n.readInt8();let s=new Int8Array(t);for(let l=0;l<t;l++)s[l]=n.readInt8();return s}function readSShort(n,t){if(t===1)return n.readInt16();let s=new Int16Array(t);for(let l=0;l<t;l++)s[l]=n.readInt16();return s}function readSLong(n,t){if(t===1)return n.readInt32();let s=new Int32Array(t);for(let l=0;l<t;l++)s[l]=n.readInt32();return s}function readSRational(n,t){if(t===1)return n.readInt32()/n.readInt32();let s=new Array(t);for(let l=0;l<t;l++)s[l]=n.readInt32()/n.readInt32();return s}function readFloat(n,t){if(t===1)return n.readFloat32();let s=new Float32Array(t);for(let l=0;l<t;l++)s[l]=n.readFloat32();return s}function readDouble(n,t){if(t===1)return n.readFloat64();let s=new Float64Array(t);for(let l=0;l<t;l++)s[l]=n.readFloat64();return s}const CLEAR_CODE=256,EOI_CODE=257,TABLE_START=258,MIN_BIT_LENGTH=9;let stringTable=[];function initializeStringTable(){if(stringTable.length===0){for(let t=0;t<256;t++)stringTable.push([t]);const n=[];for(let t=256;t<4096;t++)stringTable.push(n)}}const andTable=[511,1023,2047,4095],bitJumps=[0,0,0,0,0,0,0,0,0,511,1023,2047,4095];class LzwDecoder{constructor(t){this.nextData=0,this.nextBits=0,this.bytePointer=0,this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH,this.stripArray=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),this.outData=new IOBuffer(t.byteLength),this.initializeTable()}decode(){let t=0,s=0;for(;(t=this.getNextCode())!==EOI_CODE;)if(t===CLEAR_CODE){if(this.initializeTable(),t=this.getNextCode(),t===EOI_CODE)break;this.writeString(this.stringFromCode(t)),s=t}else if(this.isInTable(t))this.writeString(this.stringFromCode(t)),this.addStringToTable(this.stringFromCode(s).concat(this.stringFromCode(t)[0])),s=t;else{const p=this.stringFromCode(s).concat(this.stringFromCode(s)[0]);this.writeString(p),this.addStringToTable(p),s=t}const l=this.outData.toArray();return new DataView(l.buffer,l.byteOffset,l.byteLength)}initializeTable(){initializeStringTable(),this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH}writeString(t){this.outData.writeBytes(t)}stringFromCode(t){return stringTable[t]}isInTable(t){return t<this.tableLength}addStringToTable(t){if(stringTable[this.tableLength++]=t,stringTable.length>4096)throw stringTable=[],new Error("LZW decoding error. Please open an issue at https://github.com/image-js/tiff/issues/new/choose (include a test image).");this.tableLength===bitJumps[this.currentBitLength]&&this.currentBitLength++}getNextCode(){this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8,this.nextBits<this.currentBitLength&&(this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8);const t=this.nextData>>this.nextBits-this.currentBitLength&andTable[this.currentBitLength-9];return this.nextBits-=this.currentBitLength,this.bytePointer>this.stripArray.length?257:t}}function decompressLzw(n){return new LzwDecoder(n).decode()}const dateTimeRegex=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd extends IFD{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){let t=new Date,s=dateTimeRegex.exec(this.dateTime);if(s===null)throw new Error(`invalid dateTime: ${this.dateTime}`);return t.setFullYear(Number(s[1]),Number(s[2])-1,Number(s[3])),t.setHours(Number(s[4]),Number(s[5]),Number(s[6])),t}get newSubfileType(){return this.get("NewSubfileType")}get imageWidth(){return this.get("ImageWidth")}get imageLength(){return this.get("ImageLength")}get bitsPerSample(){const t=this.get("BitsPerSample");return t&&typeof t!="number"?t[0]:t}get alpha(){const t=this.extraSamples;return t?t[0]!==0:!1}get associatedAlpha(){const t=this.extraSamples;return t?t[0]===1:!1}get extraSamples(){return alwaysArray(this.get("ExtraSamples"))}get compression(){return this.get("Compression")||1}get type(){return this.get("PhotometricInterpretation")}get fillOrder(){return this.get("FillOrder")||1}get documentName(){return this.get("DocumentName")}get imageDescription(){return this.get("ImageDescription")}get stripOffsets(){return alwaysArray(this.get("StripOffsets"))}get orientation(){return this.get("Orientation")}get samplesPerPixel(){return this.get("SamplesPerPixel")||1}get rowsPerStrip(){return this.get("RowsPerStrip")}get stripByteCounts(){return alwaysArray(this.get("StripByteCounts"))}get minSampleValue(){return this.get("MinSampleValue")||0}get maxSampleValue(){return this.get("MaxSampleValue")||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get("XResolution")}get yResolution(){return this.get("YResolution")}get planarConfiguration(){return this.get("PlanarConfiguration")||1}get resolutionUnit(){return this.get("ResolutionUnit")||2}get dateTime(){return this.get("DateTime")}get predictor(){return this.get("Predictor")||1}get sampleFormat(){return this.get("SampleFormat")||1}get sMinSampleValue(){return this.get("SMinSampleValue")||this.minSampleValue}get sMaxSampleValue(){return this.get("SMaxSampleValue")||this.maxSampleValue}get palette(){const t=2**this.bitsPerSample,s=this.get("ColorMap");if(!s)return;if(s.length!==3*t)throw new Error(`ColorMap size must be ${t}`);const l=[];for(let p=0;p<t;p++)l.push([s[p],s[p+t],s[p+2*t]]);return l}}function alwaysArray(n){return typeof n=="number"?[n]:n}function decompressZlib(n){const t=new Uint8Array(n.buffer,n.byteOffset,n.byteLength),s=inflate_1(t);return new DataView(s.buffer,s.byteOffset,s.byteLength)}const defaultOptions$c={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder extends IOBuffer{constructor(t){super(t),this._nextIFD=0}get isMultiPage(){let t=0;for(this.decodeHeader();this._nextIFD;)if(t++,this.decodeIFD({ignoreImageData:!0},!0),t===2)return!0;if(t===1)return!1;throw unsupported("ifdCount",t)}get pageCount(){let t=0;for(this.decodeHeader();this._nextIFD;)t++,this.decodeIFD({ignoreImageData:!0},!0);if(t>0)return t;throw unsupported("ifdCount",t)}decode(t={}){t=Object.assign({},defaultOptions$c,t);const s=[];for(this.decodeHeader();this._nextIFD;)if(s.push(this.decodeIFD(t,!0)),t.onlyFirst)return[s[0]];return s}decodeHeader(){const t=this.readUint16();if(t===18761)this.setLittleEndian();else if(t===19789)this.setBigEndian();else throw new Error(`invalid byte order: 0x${t.toString(16)}`);if(this.readUint16()!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(t,s){this.seek(this._nextIFD);let l;if(s)l=new TiffIfd;else{if(!t.kind)throw new Error("kind is missing");l=new IFD(t.kind)}const p=this.readUint16();for(let g=0;g<p;g++)this.decodeIFDEntry(l);if(!t.ignoreImageData){if(!(l instanceof TiffIfd))throw new Error("must be a tiff ifd");this.decodeImageData(l)}return this._nextIFD=this.readUint32(),l}decodeIFDEntry(t){const s=this.offset,l=this.readUint16(),p=this.readUint16(),g=this.readUint32();if(p<1||p>12){this.skip(4);return}getByteLength(p,g)>4&&this.seek(this.readUint32());const u=readData(this,p,g);if(t.fields.set(l,u),l===34665||l===34853){let A=this.offset,S="exif";l===34665?S="exif":l===34853&&(S="gps"),this._nextIFD=u,t[S]=this.decodeIFD({kind:S,ignoreImageData:!0},!1),this.offset=A}this.seek(s),this.skip(12)}decodeImageData(t){const s=t.orientation;if(s&&s!==1)throw unsupported("orientation",s);switch(t.type){case 0:case 1:case 2:case 3:this.readStripData(t);break;default:throw unsupported("image type",t.type)}if(this.applyPredictor(t),this.convertAlpha(t),t.type===0){const l=t.bitsPerSample,p=Math.pow(2,l)-1;for(let g=0;g<t.data.length;g++)t.data[g]=p-t.data[g]}}readStripData(t){const s=t.width,l=t.height,p=t.bitsPerSample,g=t.sampleFormat,w=s*l*t.samplesPerPixel,u=getDataArray(w,p,g),S=t.rowsPerStrip*s*t.samplesPerPixel,D=t.stripOffsets,z=t.stripByteCounts||guessStripByteCounts(t);let $=w,O=0;for(let q=0;q<D.length;q++){let K=new DataView(this.buffer,this.byteOffset+D[q],z[q]),J=$>S?S:$;$-=J;let Y=K;switch(t.compression){case 1:break;case 5:{Y=decompressLzw(K);break}case 8:{Y=decompressZlib(K);break}case 2:throw unsupported("Compression","CCITT Group 3");case 32773:throw unsupported("Compression","PackBits");default:throw unsupported("Compression",t.compression)}O=this.fillUncompressed(p,g,u,Y,O,J)}t.data=u}fillUncompressed(t,s,l,p,g,w){if(t===8)return fill8bit(l,p,g,w);if(t===16)return fill16bit(l,p,g,w,this.isLittleEndian());if(t===32&&s===3)return fillFloat32(l,p,g,w,this.isLittleEndian());throw unsupported("bitDepth",t)}applyPredictor(t){const s=t.bitsPerSample;switch(t.predictor){case 1:break;case 2:{if(s===8)applyHorizontalDifferencing8Bit(t.data,t.width,t.components);else if(s===16)applyHorizontalDifferencing16Bit(t.data,t.width,t.components);else throw new Error(`Horizontal differencing is only supported for images with a bit depth of ${s}`);break}default:throw new Error(`invalid predictor: ${t.predictor}`)}}convertAlpha(t){if(t.alpha&&t.associatedAlpha){const{data:s,components:l,maxSampleValue:p}=t;for(let g=0;g<s.length;g+=l){const w=s[g+l-1];for(let u=0;u<l-1;u++)s[g+u]=Math.round(s[g+u]*p/w)}}}}function getDataArray(n,t,s){if(t===8)return new Uint8Array(n);if(t===16)return new Uint16Array(n);if(t===32&&s===3)return new Float32Array(n);throw unsupported("bit depth / sample format",`${t} / ${s}`)}function fill8bit(n,t,s,l){for(let p=0;p<l;p++)n[s++]=t.getUint8(p);return s}function fill16bit(n,t,s,l,p){for(let g=0;g<l*2;g+=2)n[s++]=t.getUint16(g,p);return s}function fillFloat32(n,t,s,l,p){for(let g=0;g<l*4;g+=4)n[s++]=t.getFloat32(g,p);return s}function unsupported(n,t){return new Error(`Unsupported ${n}: ${t}`)}function decodeTIFF(n,t){return new TIFFDecoder(n).decode(t)}function matchAndCrop(n={}){let{algorithm:t="matchToPrevious",ignoreBorder:s=[0,0]}=n;this.checkProcessable("matchAndCrop",{bitDepth:[8,16]});let l=t==="matchToPrevious",p=this[0],g=[];g[0]={position:[0,0],image:this[0]};let w=[0,0];for(let $=1;$<this.length;$++){let O=p.getBestMatch(this[$],{border:s});g[$]={position:[O[0]+w[0],O[1]+w[1]],image:this[$]},l&&(w[0]+=O[0],w[1]+=O[1],p=this[$])}let u=0,A=0,S=0,D=0;for(let $=0;$<g.length;$++){let O=g[$];O.position[0]>u&&(u=O.position[0]),O.position[0]<A&&(A=O.position[0]),O.position[1]>S&&(S=O.position[1]),O.position[1]<D&&(D=O.position[1])}A=0-A,D=0-D;for(let $=0;$<g.length;$++){let O=g[$];O.crop=O.image.crop({x:u-O.position[0],y:S-O.position[1],width:p.width-A-u,height:p.height-D-S})}let z=[];for(let $=0;$<g.length;$++)z[$]=g[$].crop;return new Stack(z)}function min$2(){this.checkProcessable("min",{bitDepth:[8,16]});let n=this[0].min;for(let t=1;t<this.length;t++)for(let s=0;s<n.length;s++)n[s]=Math.min(n[s],this[t].min[s]);return n}function max$2(){this.checkProcessable("min",{bitDepth:[8,16]});let n=this[0].max;for(let t=1;t<this.length;t++)for(let s=0;s<n.length;s++)n[s]=Math.max(n[s],this[t].max[s]);return n}function median$2(n){let t=n.reduce((w,u)=>w+u);if(t===0)throw new Error("unreachable");let s=0,l=0,p=t/2,g;for(;;){if(n[s]>0){if(g!==void 0)return(g+s)/2;if(l+=n[s],l>p)return s;l===p&&(g=s)}s++}}function mean$2(n){let t=0,s=0;for(let l=0;l<n.length;l++)t+=n[l],s+=n[l]*l;return t===0?0:s/t}function median$1(){this.checkProcessable("median",{bitDepth:[8,16]});let n=this.getHistograms({maxSlots:this[0].maxValue+1}),t=new Array(n.length);for(let s=0;s<n.length;s++){let l=n[s];t[s]=median$2(l)}return t}function histogram(n){this.checkProcessable("min",{bitDepth:[8,16]});let t=this[0].getHistogram(n);for(let s=1;s<this.length;s++){let l=this[s].getHistogram(n);for(let p=0;p<t.length;p++)t[p]+=l[p]}return t}function histograms(n){this.checkProcessable("min",{bitDepth:[8,16]});let t=this[0].getHistograms(n),s=t[0].length;for(let l=1;l<this.length;l++){let p=this[l].getHistograms(n);for(let g=0;g<t.length;g++)for(let w=0;w<s;w++)t[g][w]+=p[g][w]}return t}function averageImage(){this.checkProcessable("averageImage",{bitDepth:[8,16]});let n=new Uint32Array(this[0].data.length);for(let l=0;l<this.length;l++){let p=this[l];for(let g=0;g<this[0].data.length;g++)n[g]+=p.data[g]}let t=Image$1.createFrom(this[0]),s=t.data;for(let l=0;l<this[0].data.length;l++)s[l]=n[l]/this.length;return t}function maxImage(){this.checkProcessable("max",{bitDepth:[8,16]});let n=Image$1.createFrom(this[0]);n.data.fill(0);for(const t of this)for(let s=0;s<n.data.length;s++)n.data[s]=Math.max(t.data[s],n.data[s]);return n}function minImage(){this.checkProcessable("max",{bitDepth:[8,16]});let n=Image$1.createFrom(this[0]);n.data.fill(n.maxValue);for(const t of this)for(let s=0;s<n.data.length;s++)n.data[s]=Math.min(t.data[s],n.data[s]);return n}function extend$5(n){n.extendMethod("matchAndCrop",matchAndCrop),n.extendMethod("getMin",min$2),n.extendMethod("getMax",max$2),n.extendMethod("getMedian",median$1),n.extendMethod("getHistogram",histogram),n.extendMethod("getHistograms",histograms),n.extendMethod("getAverage",averageImage),n.extendMethod("getAverageImage",averageImage),n.extendMethod("getMaxImage",maxImage),n.extendMethod("getMinImage",minImage)}let computedPropertyDescriptor={configurable:!0,enumerable:!1,get:void 0};class Stack extends Array{constructor(t){if(Array.isArray(t)){super(t.length);for(let s=0;s<t.length;s++)this[s]=t[s]}else typeof t=="number"?super(t):super();this.computed=null}static load(t){return Promise.all(t.map(Image$1.load)).then(s=>new Stack(s))}static extendMethod(t,s,l={}){let{inPlace:p=!1,returnThis:g=!0,partialArgs:w=[]}=l;return p?Stack.prototype[t]=function(...u){this.computed=null;let A=s.apply(this,[...w,...u]);return g?this:A}:Stack.prototype[t]=function(...u){return s.apply(this,[...w,...u])},Stack}static extendProperty(t,s,l={}){let{partialArgs:p=[]}=l;return computedPropertyDescriptor.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(t,this.computed))return this.computed[t];let g=s.apply(this,p);return this.computed[t]=g,g},Object.defineProperty(Stack.prototype,t,computedPropertyDescriptor),Stack}checkProcessable(t,s={}){if(typeof t!="string")throw new TypeError("checkProcessable requires as first parameter the processName (a string)");if(this.size===0)throw new TypeError(`The process: ${t} can not be applied on an empty stack`);this[0].checkProcessable(t,s);for(let l=1;l<this.length;l++){if((s.sameSize===void 0||s.sameSize)&&this[0].width!==this[l].width)throw new TypeError(`The process: ${t} can not be applied if width is not identical in all images`);if((s.sameSize===void 0||s.sameSize)&&this[0].height!==this[l].height)throw new TypeError(`The process: ${t} can not be applied if height is not identical in all images`);if((s.sameAlpha===void 0||s.sameAlpha)&&this[0].alpha!==this[l].alpha)throw new TypeError(`The process: ${t} can not be applied if alpha is not identical in all images`);if((s.sameBitDepth===void 0||s.sameBitDepth)&&this[0].bitDepth!==this[l].bitDepth)throw new TypeError(`The process: ${t} can not be applied if bitDepth is not identical in all images`);if((s.sameColorModel===void 0||s.sameColorModel)&&this[0].colorModel!==this[l].colorModel)throw new TypeError(`The process: ${t} can not be applied if colorModel is not identical in all images`);if((s.sameNumberChannels===void 0||s.sameNumberChannels)&&this[0].channels!==this[l].channels)throw new TypeError(`The process: ${t} can not be applied if channels is not identical in all images`)}}}Array[Symbol.species]||(Stack.prototype.map=function(n,t){if(typeof n!="function")throw new TypeError(`${n} is not a function`);let s=new Stack(this.length);for(let l=0;l<this.length;l++)s[l]=n.call(t,this[l],l,this);return s});extend$5(Stack);const isDataURL=/^data:[a-z]+\/(?:[a-z]+);base64,/;function load(n,t){if(typeof n=="string")return loadURL(n,t);if(n instanceof ArrayBuffer)return Promise.resolve(loadBinary(new Uint8Array(n),void 0,t&&t.ignorePalette));if(n.buffer)return Promise.resolve(loadBinary(n,void 0,t&&t.ignorePalette));throw new Error('argument to "load" must be a string or buffer.')}function loadBinary(n,t,s){const l=imageType$1(n);if(l)switch(l.mime){case"image/png":return loadPNG(n);case"image/jpeg":return loadJPEG(n);case"image/tiff":return loadTIFF(n,s);default:return loadGeneric(p(l.mime))}return loadGeneric(p("application/octet-stream"));function p(g){return t||toBase64URL(n,g)}}function loadURL(n,t){const s=n.slice(0,64).match(isDataURL);let l;return s!==null?l=Promise.resolve(decode$4(n.slice(s[0].length))):l=fetchBinary(n,t),l.then(p=>{const g=new Uint8Array(p);return loadBinary(g,s?n:void 0,t&&t.ignorePalette)})}function loadPNG(n){const t=decodePng(n);let s=t.channels,l,p=0;return s===2||s===4?(l=s-1,p=1):l=s,t.palette?loadPNGFromPalette(t):new Image$1(t.width,t.height,t.data,{components:l,alpha:p,bitDepth:t.depth})}function loadPNGFromPalette(n){const t=n.width*n.height,s=n.palette[0].length,l=new Uint8Array(t*s),p=8/n.depth,g=n.depth<8?p:1,w=parseInt("1".repeat(n.depth),2),u=s===4;let A=0;for(let S=0;S<t;S++){const D=Math.floor(S/g);let z=n.data[D];n.depth<8&&(z=z>>>n.depth*(p-1-S%p)&w);const $=n.palette[z];l[A++]=$[0],l[A++]=$[1],l[A++]=$[2],u&&(l[A++]=$[3])}return new Image$1(n.width,n.height,l,{components:3,alpha:u,bitDepth:8})}function loadJPEG(n){const t=decode$1(n);let s;t.exif&&(s=getMetadata(t.exif));const l=jpegJs.decode(n,{useTArray:!0,maxMemoryUsageInMB:1024});let p=new Image$1(l.width,l.height,l.data,{meta:s});if(s&&s.tiff.tags.Orientation){const g=s.tiff.tags.Orientation;g>2&&(p=p.rotate({3:180,4:180,5:90,6:90,7:270,8:270}[g])),[2,4,5,7].includes(g)&&(p=p.flipX())}return p}function loadTIFF(n,t){let s=decodeTIFF(n);return s.length===1?getImageFromIFD(s[0],t):new Stack(s.map(function(l){return getImageFromIFD(l,t)}))}function getMetadata(n){const t={tiff:{fields:n.fields,tags:n.map}};return n.exif&&(t.exif=n.exif),n.gps&&(t.gps=n.gps),t}function getImageFromIFD(n,t){if(!t&&n.type===3){const s=new Uint16Array(3*n.width*n.height),l=n.palette;let p=0;for(let g=0;g<n.data.length;g++){const w=n.data[g],u=l[w];s[p++]=u[0],s[p++]=u[1],s[p++]=u[2]}return new Image$1(n.width,n.height,s,{components:3,alpha:n.alpha,colorModel:RGB$1,bitDepth:16,meta:getMetadata(n)})}else return new Image$1(n.width,n.height,n.data,{components:n.type===2?3:1,alpha:n.alpha,colorModel:n.type===2?RGB$1:GREY$1,bitDepth:n.bitsPerSample.length?n.bitsPerSample[0]:n.bitsPerSample,meta:getMetadata(n)})}function loadGeneric(n,t){return t=t||{},new Promise(function(s,l){let p=new DOMImage;p.onload=function(){let g=p.width,w=p.height,A=createCanvas(g,w).getContext("2d");A.drawImage(p,0,0,g,w);let S=A.getImageData(0,0,g,w).data;s(new Image$1(g,w,S,t))},p.onerror=function(){l(new Error(`Could not load ${n}`))},p.src=n})}const valueMethods={getValueXY(n,t,s){return this.data[(t*this.width+n)*this.channels+s]},setValueXY(n,t,s,l){return this.data[(t*this.width+n)*this.channels+s]=l,this.computed=null,this},getValue(n,t){return this.data[n*this.channels+t]},setValue(n,t,s){return this.data[n*this.channels+t]=s,this.computed=null,this},getPixelXY(n,t){return this.getPixel(t*this.width+n)},setPixelXY(n,t,s){return this.setPixel(t*this.width+n,s)},getPixel(n){const t=new Array(this.channels),s=n*this.channels;for(let l=0;l<this.channels;l++)t[l]=this.data[s+l];return t},setPixel(n,t){const s=n*this.channels;for(let l=0;l<t.length;l++)this.data[s+l]=t[l];return this.computed=null,this}};function setValueMethods(n){for(const t in valueMethods)n.prototype[t]=valueMethods[t]}function getImageParameters(n){return{width:n.width,height:n.height,components:n.components,alpha:n.alpha,colorModel:n.colorModel,bitDepth:n.bitDepth}}function getOutputImage(n,t,s,l={}){const{out:p}=t;if(p===void 0)return l.copy?n.clone():Image$1.createFrom(n,s);{if(!Image$1.isImage(p))throw new TypeError("out must be an Image object");const g=Object.assign(getImageParameters(n),s);for(const w in g)if(p[w]!==g[w])throw new RangeError(`cannot use out. Its ${w} must be "${g[w]}" (found "${p[w]}")`);return p}}function getOutputImageOrInPlace(n,t,s){if(t.inPlace!==void 0&&typeof t.inPlace!="boolean")throw new TypeError("inPlace option must be a boolean");if(t.inPlace){if(t.out!==void 0)throw new TypeError("out option must not be set if inPlace option is true");return n}return getOutputImage(n,t,null,s)}function abs(n={}){this.checkProcessable("abs",{bitDepth:[32]});const t=getOutputImageOrInPlace(this,n);return absolute(this,t),t}function absolute(n,t){for(let s=0;s<n.data.length;s++)t.data[s]=Math.abs(n.data[s])}function copyAlphaChannel(n,t){if(n.alpha===1&&t.alpha===1)for(let s=0;s<n.size;s++)t.data[s*t.channels+t.components]=n.data[s*n.channels+n.components]}function invert(n={}){this.checkProcessable("invert",{bitDepth:[1,8,16]});const t=getOutputImageOrInPlace(this,n);return this.bitDepth===1?invertBinary(this,t):(invertColor(this,t),this!==t&&copyAlphaChannel(this,t)),t}function invertBinary(n,t){for(let s=0;s<n.data.length;s++)t.data[s]=~n.data[s]}function invertColor(n,t){for(let s=0;s<n.data.length;s+=n.channels)for(let l=0;l<n.components;l++)t.data[s+l]=n.maxValue-n.data[s+l]}function flipX(){this.checkProcessable("flipX",{bitDepth:[8,16]});for(let n=0;n<this.height;n++){let t=n*this.width*this.channels;for(let s=0;s<Math.floor(this.width/2);s++){let l=s*this.channels+t,p=(this.width-s-1)*this.channels+t;for(let g=0;g<this.channels;g++){let w=this.data[l+g];this.data[l+g]=this.data[p+g],this.data[p+g]=w}}}return this}function flipY(){this.checkProcessable("flipY",{bitDepth:[8,16]});for(let n=0;n<Math.floor(this.height/2);n++)for(let t=0;t<this.width;t++){let s=t*this.channels+n*this.width*this.channels,l=t*this.channels+(this.height-1-n)*this.channels*this.width;for(let p=0;p<this.channels;p++){let g=this.data[s+p];this.data[s+p]=this.data[l+p],this.data[l+p]=g}}return this}function blurFilter(n={}){const{radius:t=1}=n;if(t<1)throw new Error("radius must be greater than 1");const s=2*t+1,l=new Array(s);for(let p=0;p<s;p++){l[p]=new Array(s);for(let g=0;g<s;g++)l[p][g]=1/(s*s)}return this.convolution(l)}var medianQuickselect_min={exports:{}};(function(n){(function(){function t(p){for(var g=0,w=p.length-1,u=void 0,A=void 0,S=void 0,D=l(g,w);;){if(w<=g)return p[D];if(w==g+1)return p[g]>p[w]&&s(p,g,w),p[D];for(u=l(g,w),p[u]>p[w]&&s(p,u,w),p[g]>p[w]&&s(p,g,w),p[u]>p[g]&&s(p,u,g),s(p,u,g+1),A=g+1,S=w;;){do A++;while(p[g]>p[A]);do S--;while(p[S]>p[g]);if(S<A)break;s(p,A,S)}s(p,g,S),S<=D&&(g=A),S>=D&&(w=S-1)}}var s=function(g,w,u){var A;return A=[g[u],g[w]],g[w]=A[0],g[u]=A[1],A},l=function(g,w){return~~((g+w)/2)};n.exports?n.exports=t:window.median=t})()})(medianQuickselect_min);var quickSelectMedian=medianQuickselect_min.exports;function validateArrayOfChannels(n,t={}){let{channels:s,allowAlpha:l,defaultAlpha:p}=t;return typeof l!="boolean"&&(l=!0),typeof s=="undefined"?allChannels(n,p):validateChannels(n,s,l)}function allChannels(n,t){let s=t?n.channels:n.components,l=new Array(s);for(let p=0;p<s;p++)l[p]=p;return l}function validateChannels(n,t,s){Array.isArray(t)||(t=[t]);for(let l=0;l<t.length;l++)t[l]=validateChannel(n,t[l],s);return t}function validateChannel(n,t,s=!0){if(t===void 0)throw new RangeError(`validateChannel : the channel has to be >=0 and <${n.channels}`);if(typeof t=="string"){switch(n.colorModel){case GREY$1:break;case RGB$1:if("rgb".includes(t))switch(t){case"r":t=0;break;case"g":t=1;break;case"b":t=2;break}break;case HSL:if("hsl".includes(t))switch(t){case"h":t=0;break;case"s":t=1;break;case"l":t=2;break}break;case HSV:if("hsv".includes(t))switch(t){case"h":t=0;break;case"s":t=1;break;case"v":t=2;break}break;case CMYK$1:if("cmyk".includes(t))switch(t){case"c":t=0;break;case"m":t=1;break;case"y":t=2;break;case"k":t=3;break}break;default:throw new Error(`Unexpected color model: ${n.colorModel}`)}if(t==="a"){if(!n.alpha)throw new Error("validateChannel : the image does not contain alpha channel");t=n.components}if(typeof t=="string")throw new Error(`validateChannel : undefined channel: ${t}`)}if(t>=n.channels)throw new RangeError(`validateChannel : the channel has to be >=0 and <${n.channels}`);if(!s&&t>=n.components)throw new RangeError("validateChannel : alpha channel may not be selected");return t}function medianFilter(n={}){let{radius:t=1,border:s="copy",channels:l}=n;if(this.checkProcessable("medianFilter",{bitDepth:[8,16]}),t<1)throw new Error("radius must be greater than 0");l=validateArrayOfChannels(this,l);let p=t,g=t,w=Image$1.createFrom(this),u=(p*2+1)*(g*2+1),A=new Array(u);for(let S=0;S<l.length;S++){let D=l[S];for(let z=g;z<this.height-g;z++)for(let $=p;$<this.width-p;$++){let O=0;for(let K=-g;K<=g;K++)for(let J=-p;J<=p;J++){let Y=((z+K)*this.width+$+J)*this.channels+D;A[O++]=this.data[Y]}let q=(z*this.width+$)*this.channels+D;w.data[q]=quickSelectMedian(A)}}if(this.alpha&&!l.includes(this.channels))for(let S=this.components;S<this.data.length;S=S+this.channels)w.data[S]=this.data[S];return w.setBorder({size:[p,g],algorithm:s}),w}function gaussianFilter(n={}){let{radius:t=1,sigma:s,channels:l,border:p="copy"}=n;this.checkProcessable("gaussian",{bitDepth:[8,16]});const g=getKernel(t,s);return this.convolution([g,g],{border:p,channels:l,algorithm:"separable"})}function getKernel(n,t){const s=n*2+1,l=new Array(s),p=t||((s-1)*.5-1)*.3+.8,g=-.5/(p*p);let w=0;for(let u=0;u<s;u++){const A=u-n,S=Math.exp(g*A*A);l[u]=S,w+=S}for(let u=0;u<s;u++)l[u]/=w;return l}const SOBEL_X=[[-1,0,1],[-2,0,2],[-1,0,1]],SOBEL_Y=[[-1,-2,-1],[0,0,0],[1,2,1]],SCHARR_X=[[3,0,-3],[10,0,-10],[3,0,-3]],SCHARR_Y=[[3,10,3],[0,0,0],[-3,-10,-3]];var src$3={},fftlib={};(function(n){(function(){var t;t=n;var s={release:"0.3.0",date:"2013-03"};t.toString=function(){return"version "+s.release+", released "+s.date};for(var l=0,p=null,g=null,w={init:function(S){if(S!==0&&(S&S-1)===0)l=S,w._initArray(),w._makeBitReversalTable(),w._makeCosSinTable();else throw new Error("init: radix-2 required")},fft1d:function(S,D){w.fft(S,D,1)},ifft1d:function(S,D){var z=1/l;w.fft(S,D,-1);for(var $=0;$<l;$++)S[$]*=z,D[$]*=z},bt1d:function(S,D){w.fft(S,D,-1)},fft2d:function(S,D){for(var z=[],$=[],O=0,q=0;q<l;q++){O=q*l;for(var K=0;K<l;K++)z[K]=S[K+O],$[K]=D[K+O];w.fft1d(z,$);for(var J=0;J<l;J++)S[J+O]=z[J],D[J+O]=$[J]}for(var Y=0;Y<l;Y++){for(var fe=0;fe<l;fe++)O=Y+fe*l,z[fe]=S[O],$[fe]=D[O];w.fft1d(z,$);for(var ee=0;ee<l;ee++)O=Y+ee*l,S[O]=z[ee],D[O]=$[ee]}},ifft2d:function(S,D){for(var z=[],$=[],O=0,q=0;q<l;q++){O=q*l;for(var K=0;K<l;K++)z[K]=S[K+O],$[K]=D[K+O];w.ifft1d(z,$);for(var J=0;J<l;J++)S[J+O]=z[J],D[J+O]=$[J]}for(var Y=0;Y<l;Y++){for(var fe=0;fe<l;fe++)O=Y+fe*l,z[fe]=S[O],$[fe]=D[O];w.ifft1d(z,$);for(var ee=0;ee<l;ee++)O=Y+ee*l,S[O]=z[ee],D[O]=$[ee]}},fft:function(S,D,z){for(var $,O,q,K,J,Y,fe,ee,re,he=l>>2,_e=0;_e<l;_e++)K=p[_e],_e<K&&(J=S[_e],S[_e]=S[K],S[K]=J,J=D[_e],D[_e]=D[K],D[K]=J);for(var we=1;we<l;we<<=1){O=0,$=l/(we<<1);for(var oe=0;oe<we;oe++){Y=g[O+he],fe=z*g[O];for(var be=oe;be<l;be+=we<<1)q=be+we,ee=Y*S[q]+fe*D[q],re=Y*D[q]-fe*S[q],S[q]=S[be]-ee,S[be]+=ee,D[q]=D[be]-re,D[be]+=re;O+=$}}},_initArray:function(){typeof Uint32Array!="undefined"?p=new Uint32Array(l):p=[],typeof Float64Array!="undefined"?g=new Float64Array(l*1.25):g=[]},_paddingZero:function(){},_makeBitReversalTable:function(){var S=0,D=0,z=0;for(p[0]=0;++S<l;){for(z=l>>1;z<=D;)D-=z,z>>=1;D+=z,p[S]=D}},_makeCosSinTable:function(){var S=l>>1,D=l>>2,z=l>>3,$=S+D,O=Math.sin(Math.PI/l),q=2*O*O,K=Math.sqrt(q*(2-q)),J=g[D]=1,Y=g[0]=0;O=2*q;for(var fe=1;fe<z;fe++)J-=q,q+=O*J,Y+=K,K-=O*Y,g[fe]=Y,g[D-fe]=J;z!==0&&(g[z]=Math.sqrt(.5));for(var ee=0;ee<D;ee++)g[S-ee]=g[ee];for(var re=0;re<$;re++)g[re+S]=-g[re]}},u=["init","fft1d","ifft1d","fft2d","ifft2d"],A=0;A<u.length;A++)t[u[A]]=w[u[A]];return t.bt=w.bt1d,t.fft=w.fft1d,t.ifft=w.ifft1d,t}).call(commonjsGlobal)})(fftlib);var FFT=fftlib,FFTUtils$1={DEBUG:!1,ifft2DArray:function(n,t,s){var l=new Array(t*s),p=t/2,g=(s-1)*2;FFT.init(p);for(var w={re:new Array(p),im:new Array(p)},u=0;u<s;u++){for(var A=p-1;A>=0;A--)w.re[A]=n[A*2*s+u],w.im[A]=n[(A*2+1)*s+u];FFT.bt(w.re,w.im);for(var A=p-1;A>=0;A--)l[A*2*s+u]=w.re[A],l[(A*2+1)*s+u]=w.im[A]}var S=new Array(p*g);FFT.init(g);for(var D={re:new Array(g),im:new Array(g)},z=g*p,A=0;A<t;A+=2){D.re[0]=l[A*s],D.im[0]=l[(A+1)*s];for(var u=1;u<s;u++)D.re[u]=l[A*s+u],D.im[u]=l[(A+1)*s+u],D.re[g-u]=l[A*s+u],D.im[g-u]=-l[(A+1)*s+u];FFT.bt(D.re,D.im);for(var $=A/2*g,u=g-1;u>=0;u--)S[$+u]=D.re[u]/z}return S},fft2DArray:function(n,t,s,l){Object.assign({},{inplace:!0});var p=s/2+1,g=t*2,w=new Array(g*p);FFT.init(s);for(var u={re:new Array(s),im:new Array(s)},A={re:new Array(s),im:new Array(s)},S={re:new Array(s),im:new Array(s)},D,z,$,O,q,K=0;K<t/2;K++){D=K*2*s,u.re=n.slice(D,D+s),D=(K*2+1)*s,u.im=n.slice(D,D+s),FFT.fft1d(u.re,u.im),this.reconstructTwoRealFFT(u,A,S),z=K*4*p,$=(K*4+1)*p,O=(K*4+2)*p,q=(K*4+3)*p;for(var J=p-1;J>=0;J--)w[z+J]=A.re[J],w[$+J]=A.im[J],w[O+J]=S.re[J],w[q+J]=S.im[J]}A=null,S=null;var Y=new Array(g*p);FFT.init(t);for(var fe={re:new Array(t),im:new Array(t)},ee=p-1;ee>=0;ee--){for(var K=t-1;K>=0;K--)fe.re[K]=w[K*2*p+ee],fe.im[K]=w[(K*2+1)*p+ee],isNaN(fe.re[K])&&(fe.re[K]=0),isNaN(fe.im[K])&&(fe.im[K]=0);FFT.fft1d(fe.re,fe.im);for(var K=t-1;K>=0;K--)Y[K*2*p+ee]=fe.re[K],Y[(K*2+1)*p+ee]=fe.im[K]}return Y},reconstructTwoRealFFT:function(n,t,s){var l=n.re.length;t.re[0]=n.re[0],t.im[0]=0,s.re[0]=n.im[0],s.im[0]=0;for(var p,g,w,u,A,S=l/2;S>0;S--)A=l-S,p=.5*(n.re[S]-n.re[A]),g=.5*(n.re[S]+n.re[A]),w=.5*(n.im[S]-n.im[A]),u=.5*(n.im[S]+n.im[A]),t.re[S]=g,t.im[S]=w,t.re[A]=g,t.im[A]=-w,s.re[S]=u,s.im[S]=-p,s.re[A]=u,s.im[A]=p},convolute2DI:function(n,t,s,l){for(var p,g,w=0;w<s/2;w++)for(var u=0;u<l;u++)p=n[w*2*l+u]*t[w*2*l+u]-n[(w*2+1)*l+u]*t[(w*2+1)*l+u],g=n[w*2*l+u]*t[(w*2+1)*l+u]+n[(w*2+1)*l+u]*t[w*2*l+u],n[w*2*l+u]=p,n[(w*2+1)*l+u]=g},convolute:function(n,t,s,l,p){for(var g=new Array(l*s),w=0;w<s*l;w++)g[w]=n[w];g=this.fft2DArray(g,s,l);for(var u=t.length,A=t[0].length,S=new Array(l*s),w=0;w<l*s;w++)S[w]=0;for(var D,z,$=Math.floor((u-1)/2),O=Math.floor((A-1)/2),q=0;q<u;q++){D=(q-$+s)%s;for(var K=0;K<A;K++)z=(K-O+l)%l,S[D*l+z]=t[q][K]}S=this.fft2DArray(S,s,l);var J=s*2,Y=l/2+1;return this.convolute2DI(g,S,J,Y),this.ifft2DArray(g,J,Y)},toRadix2:function(n,t,s){var l,p,g,w,u=s,A=t;if(!(s!==0&&(s&s-1)===0)){for(u=0;s>>++u!=0;);u=1<<u}if(!(t!==0&&(t&t-1)===0)){for(A=0;t>>++A!=0;);A=1<<A}if(A==t&&u==s)return{data:n,rows:t,cols:s};var S=new Array(A*u),D=Math.floor((A-t)/2)-t,z=Math.floor((u-s)/2)-s;for(l=0;l<A;l++)for(g=l*u,w=(l-D)%t*s,p=0;p<u;p++)S[g+p]=n[w+(p-z)%s];return{data:S,rows:A,cols:u}},crop:function(n,t,s,l,p,g){if(t==l&&s==p)return n;Object.assign({},g);var w=new Array(p*l),u=Math.floor((t-l)/2),A=Math.floor((s-p)/2),S,D,z,$;for(z=0;z<l;z++)for(S=z*p,D=(z+u)*s,$=0;$<p;$++)w[S+$]=n[D+($+A)];return w}},FFTUtils_1=FFTUtils$1;src$3.FFTUtils=FFTUtils_1;src$3.FFT=fftlib;var FFTUtils=src$3.FFTUtils;function convolutionFFT(n,t,s){var l=matrix2Array(n),p=l.data,g=Object.assign({normalize:!1,divisor:1,rows:l.rows,cols:l.cols},s),w,u;if(g.rows&&g.cols)w=g.rows,u=g.cols;else throw new Error("Invalid number of rows or columns "+w+" "+u);var A=g.divisor,S,D,z=t.length,$=t[0].length;if(g.normalize)for(A=0,S=0;S<z;S++)for(D=0;D<$;D++)A+=t[S][D];if(A===0)throw new RangeError("convolution: The divisor is equal to zero");var O=FFTUtils.toRadix2(p,w,u),q=FFTUtils.convolute(O.data,t,O.rows,O.cols);if(q=FFTUtils.crop(q,O.rows,O.cols,w,u),A!=0&&A!=1)for(S=0;S<q.length;S++)q[S]/=A;return q}function convolutionDirect(n,t,s){var l=matrix2Array(n),p=l.data,g=Object.assign({normalize:!1,divisor:1,rows:l.rows,cols:l.cols},s),w,u;if(g.rows&&g.cols)w=g.rows,u=g.cols;else throw new Error("Invalid number of rows or columns "+w+" "+u);var A=g.divisor,S=t.length,D=t[0].length,z,$,O,q,K,J,Y,fe,ee;if(g.normalize)for(A=0,z=0;z<S;z++)for($=0;$<D;$++)A+=t[z][$];if(A===0)throw new RangeError("convolution: The divisor is equal to zero");var re=new Array(w*u),he=Math.floor(S/2),_e=Math.floor(D/2);for(q=0;q<w;q++)for(O=0;O<u;O++){for(J=0,$=0;$<S;$++)for(z=0;z<D;z++)Y=t[S-$-1][D-z-1],fe=(q+$-he+w)%w,ee=(O+z-_e+u)%u,K=fe*u+ee,J+=p[K]*Y;K=q*u+O,re[K]=J/A}return re}function LoG(n,t,s){var l=1e3;s&&s.factor&&(l=s.factor);var p=new Array(t),g,w,u,A;l*=-1;var S=(t-1)/2,D=2*n*n;for(g=0;g<t;g++)for(p[g]=new Array(t),A=(g-S)*(g-S),w=0;w<t;w++)u=-((w-S)*(w-S)+A)/D,p[g][w]=Math.round(l*(1+u)*Math.exp(u));return p}function matrix2Array(n){var t=n,s,l;if(typeof n[0]!="number"){s=n.length,l=n[0].length,t=new Array(s*l);for(var p=0;p<s;p++)for(var g=0;g<l;g++)t[p*l+g]=n[p][g]}else{var w=Math.sqrt(n.length);Number.isInteger(w)&&(s=w,l=w)}return{data:t,rows:s,cols:l}}var src$2={fft:convolutionFFT,direct:convolutionDirect,kernelFactory:{LoG},matrix2Array},_isFinite=Number.isFinite||function(n){return!(typeof n!="number"||n!==n||n===1/0||n===-1/0)},isFinite$1=_isFinite,isInteger=Number.isInteger||function(n){return typeof n=="number"&&isFinite$1(n)&&Math.floor(n)===n};function validateKernel(n){let t,s;if(Array.isArray(n))if(Array.isArray(n[0])){if((n.length&1)===0||(n[0].length&1)===0)throw new RangeError("validateKernel: Kernel rows and columns should be odd numbers");t=Math.floor(n.length/2),s=Math.floor(n[0].length/2)}else{let l=Math.sqrt(n.length);if(isInteger(l))s=t=Math.floor(Math.sqrt(n.length)/2);else throw new RangeError("validateKernel: Kernel array should be a square");let p=new Array(l);for(let g=0;g<l;g++){p[g]=new Array(l);for(let w=0;w<l;w++)p[g][w]=n[g*l+w]}n=p}else throw new Error(`validateKernel: Invalid Kernel: ${n}`);return{kernel:n,kWidth:s,kHeight:t}}function clamp(n,t){return Math.round(Math.min(Math.max(n,0),t.maxValue))}function directConvolution(n,t,s){if(s===void 0){const g=n.length+t.length-1;s=new Array(g)}fill(s);for(var l=0;l<n.length;l++)for(var p=0;p<t.length;p++)s[l+p]+=n[l]*t[p];return s}function fill(n){for(var t=0;t<n.length;t++)n[t]=0}function convolutionSeparable(n,t,s,l){const p=new Array(n.length);let g,w,u,A;A=t[1],u=(A.length-1)/2,w=new Array(s+A.length-1),g=new Array(s);for(let S=0;S<l;S++){for(let D=0;D<s;D++)g[D]=n[S*s+D];directConvolution(g,A,w);for(let D=0;D<s;D++)p[S*s+D]=w[u+D]}A=t[0],u=(A.length-1)/2,w=new Array(l+A.length-1),g=new Array(l);for(let S=0;S<s;S++){for(let D=0;D<l;D++)g[D]=p[D*s+S];directConvolution(g,A,w);for(let D=0;D<l;D++)p[D*s+S]=w[u+D]}return p}const toString$2=Object.prototype.toString;function isAnyArray(n){return toString$2.call(n).endsWith("Array]")}function max$1(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(n))throw new TypeError("input must be an array");if(n.length===0)throw new TypeError("input must not be empty");var s=t.fromIndex,l=s===void 0?0:s,p=t.toIndex,g=p===void 0?n.length:p;if(l<0||l>=n.length||!Number.isInteger(l))throw new Error("fromIndex must be a positive integer smaller than length");if(g<=l||g>n.length||!Number.isInteger(g))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var w=n[l],u=l+1;u<g;u++)n[u]>w&&(w=n[u]);return w}function min$1(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(n))throw new TypeError("input must be an array");if(n.length===0)throw new TypeError("input must not be empty");var s=t.fromIndex,l=s===void 0?0:s,p=t.toIndex,g=p===void 0?n.length:p;if(l<0||l>=n.length||!Number.isInteger(l))throw new Error("fromIndex must be a positive integer smaller than length");if(g<=l||g>n.length||!Number.isInteger(g))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var w=n[l],u=l+1;u<g;u++)n[u]<w&&(w=n[u]);return w}function rescale(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(isAnyArray(n)){if(n.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var s;if(t.output!==void 0){if(!isAnyArray(t.output))throw new TypeError("output option must be an array if specified");s=t.output}else s=new Array(n.length);var l=min$1(n),p=max$1(n);if(l===p)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var g=t.min,w=g===void 0?t.autoMinMax?l:0:g,u=t.max,A=u===void 0?t.autoMinMax?p:1:u;if(w>=A)throw new RangeError("min option must be smaller than max option");for(var S=(A-w)/(p-l),D=0;D<n.length;D++)s[D]=(n[D]-l)*S+w;return s}const indent=" ".repeat(2),indentData=" ".repeat(4);function inspectMatrix(){return inspectMatrixWithOptions(this)}function inspectMatrixWithOptions(n,t={}){const{maxRows:s=15,maxColumns:l=10,maxNumSize:p=8}=t;return`${n.constructor.name} {
${indent}[
${indentData}${inspectData(n,s,l,p)}
${indent}]
${indent}rows: ${n.rows}
${indent}columns: ${n.columns}
}`}function inspectData(n,t,s,l){const{rows:p,columns:g}=n,w=Math.min(p,t),u=Math.min(g,s),A=[];for(let S=0;S<w;S++){let D=[];for(let z=0;z<u;z++)D.push(formatNumber(n.get(S,z),l));A.push(`${D.join(" ")}`)}return u!==g&&(A[A.length-1]+=` ... ${g-s} more columns`),w!==p&&A.push(`... ${p-t} more rows`),A.join(`
${indentData}`)}function formatNumber(n,t){const s=String(n);if(s.length<=t)return s.padEnd(t," ");const l=n.toPrecision(t-2);if(l.length<=t)return l;const p=n.toExponential(t-2),g=p.indexOf("e"),w=p.slice(g);return p.slice(0,t-w.length)+w}function installMathOperations(n,t){n.prototype.add=function(l){return typeof l=="number"?this.addS(l):this.addM(l)},n.prototype.addS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)+l);return this},n.prototype.addM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)+l.get(p,g));return this},n.add=function(l,p){return new t(l).add(p)},n.prototype.sub=function(l){return typeof l=="number"?this.subS(l):this.subM(l)},n.prototype.subS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)-l);return this},n.prototype.subM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)-l.get(p,g));return this},n.sub=function(l,p){return new t(l).sub(p)},n.prototype.subtract=n.prototype.sub,n.prototype.subtractS=n.prototype.subS,n.prototype.subtractM=n.prototype.subM,n.subtract=n.sub,n.prototype.mul=function(l){return typeof l=="number"?this.mulS(l):this.mulM(l)},n.prototype.mulS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)*l);return this},n.prototype.mulM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)*l.get(p,g));return this},n.mul=function(l,p){return new t(l).mul(p)},n.prototype.multiply=n.prototype.mul,n.prototype.multiplyS=n.prototype.mulS,n.prototype.multiplyM=n.prototype.mulM,n.multiply=n.mul,n.prototype.div=function(l){return typeof l=="number"?this.divS(l):this.divM(l)},n.prototype.divS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)/l);return this},n.prototype.divM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)/l.get(p,g));return this},n.div=function(l,p){return new t(l).div(p)},n.prototype.divide=n.prototype.div,n.prototype.divideS=n.prototype.divS,n.prototype.divideM=n.prototype.divM,n.divide=n.div,n.prototype.mod=function(l){return typeof l=="number"?this.modS(l):this.modM(l)},n.prototype.modS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)%l);return this},n.prototype.modM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)%l.get(p,g));return this},n.mod=function(l,p){return new t(l).mod(p)},n.prototype.modulus=n.prototype.mod,n.prototype.modulusS=n.prototype.modS,n.prototype.modulusM=n.prototype.modM,n.modulus=n.mod,n.prototype.and=function(l){return typeof l=="number"?this.andS(l):this.andM(l)},n.prototype.andS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)&l);return this},n.prototype.andM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)&l.get(p,g));return this},n.and=function(l,p){return new t(l).and(p)},n.prototype.or=function(l){return typeof l=="number"?this.orS(l):this.orM(l)},n.prototype.orS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)|l);return this},n.prototype.orM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)|l.get(p,g));return this},n.or=function(l,p){return new t(l).or(p)},n.prototype.xor=function(l){return typeof l=="number"?this.xorS(l):this.xorM(l)},n.prototype.xorS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)^l);return this},n.prototype.xorM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)^l.get(p,g));return this},n.xor=function(l,p){return new t(l).xor(p)},n.prototype.leftShift=function(l){return typeof l=="number"?this.leftShiftS(l):this.leftShiftM(l)},n.prototype.leftShiftS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)<<l);return this},n.prototype.leftShiftM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)<<l.get(p,g));return this},n.leftShift=function(l,p){return new t(l).leftShift(p)},n.prototype.signPropagatingRightShift=function(l){return typeof l=="number"?this.signPropagatingRightShiftS(l):this.signPropagatingRightShiftM(l)},n.prototype.signPropagatingRightShiftS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)>>l);return this},n.prototype.signPropagatingRightShiftM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)>>l.get(p,g));return this},n.signPropagatingRightShift=function(l,p){return new t(l).signPropagatingRightShift(p)},n.prototype.rightShift=function(l){return typeof l=="number"?this.rightShiftS(l):this.rightShiftM(l)},n.prototype.rightShiftS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)>>>l);return this},n.prototype.rightShiftM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,this.get(p,g)>>>l.get(p,g));return this},n.rightShift=function(l,p){return new t(l).rightShift(p)},n.prototype.zeroFillRightShift=n.prototype.rightShift,n.prototype.zeroFillRightShiftS=n.prototype.rightShiftS,n.prototype.zeroFillRightShiftM=n.prototype.rightShiftM,n.zeroFillRightShift=n.rightShift,n.prototype.not=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,~this.get(l,p));return this},n.not=function(l){return new t(l).not()},n.prototype.abs=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.abs(this.get(l,p)));return this},n.abs=function(l){return new t(l).abs()},n.prototype.acos=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.acos(this.get(l,p)));return this},n.acos=function(l){return new t(l).acos()},n.prototype.acosh=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.acosh(this.get(l,p)));return this},n.acosh=function(l){return new t(l).acosh()},n.prototype.asin=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.asin(this.get(l,p)));return this},n.asin=function(l){return new t(l).asin()},n.prototype.asinh=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.asinh(this.get(l,p)));return this},n.asinh=function(l){return new t(l).asinh()},n.prototype.atan=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.atan(this.get(l,p)));return this},n.atan=function(l){return new t(l).atan()},n.prototype.atanh=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.atanh(this.get(l,p)));return this},n.atanh=function(l){return new t(l).atanh()},n.prototype.cbrt=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.cbrt(this.get(l,p)));return this},n.cbrt=function(l){return new t(l).cbrt()},n.prototype.ceil=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.ceil(this.get(l,p)));return this},n.ceil=function(l){return new t(l).ceil()},n.prototype.clz32=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.clz32(this.get(l,p)));return this},n.clz32=function(l){return new t(l).clz32()},n.prototype.cos=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.cos(this.get(l,p)));return this},n.cos=function(l){return new t(l).cos()},n.prototype.cosh=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.cosh(this.get(l,p)));return this},n.cosh=function(l){return new t(l).cosh()},n.prototype.exp=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.exp(this.get(l,p)));return this},n.exp=function(l){return new t(l).exp()},n.prototype.expm1=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.expm1(this.get(l,p)));return this},n.expm1=function(l){return new t(l).expm1()},n.prototype.floor=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.floor(this.get(l,p)));return this},n.floor=function(l){return new t(l).floor()},n.prototype.fround=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.fround(this.get(l,p)));return this},n.fround=function(l){return new t(l).fround()},n.prototype.log=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.log(this.get(l,p)));return this},n.log=function(l){return new t(l).log()},n.prototype.log1p=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.log1p(this.get(l,p)));return this},n.log1p=function(l){return new t(l).log1p()},n.prototype.log10=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.log10(this.get(l,p)));return this},n.log10=function(l){return new t(l).log10()},n.prototype.log2=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.log2(this.get(l,p)));return this},n.log2=function(l){return new t(l).log2()},n.prototype.round=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.round(this.get(l,p)));return this},n.round=function(l){return new t(l).round()},n.prototype.sign=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.sign(this.get(l,p)));return this},n.sign=function(l){return new t(l).sign()},n.prototype.sin=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.sin(this.get(l,p)));return this},n.sin=function(l){return new t(l).sin()},n.prototype.sinh=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.sinh(this.get(l,p)));return this},n.sinh=function(l){return new t(l).sinh()},n.prototype.sqrt=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.sqrt(this.get(l,p)));return this},n.sqrt=function(l){return new t(l).sqrt()},n.prototype.tan=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.tan(this.get(l,p)));return this},n.tan=function(l){return new t(l).tan()},n.prototype.tanh=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.tanh(this.get(l,p)));return this},n.tanh=function(l){return new t(l).tanh()},n.prototype.trunc=function(){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.set(l,p,Math.trunc(this.get(l,p)));return this},n.trunc=function(l){return new t(l).trunc()},n.pow=function(l,p){return new t(l).pow(p)},n.prototype.pow=function(l){return typeof l=="number"?this.powS(l):this.powM(l)},n.prototype.powS=function(l){for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,Math.pow(this.get(p,g),l));return this},n.prototype.powM=function(l){if(l=t.checkMatrix(l),this.rows!==l.rows||this.columns!==l.columns)throw new RangeError("Matrices dimensions must be equal");for(let p=0;p<this.rows;p++)for(let g=0;g<this.columns;g++)this.set(p,g,Math.pow(this.get(p,g),l.get(p,g)));return this}}function checkRowIndex(n,t,s){let l=s?n.rows:n.rows-1;if(t<0||t>l)throw new RangeError("Row index out of range")}function checkColumnIndex(n,t,s){let l=s?n.columns:n.columns-1;if(t<0||t>l)throw new RangeError("Column index out of range")}function checkRowVector(n,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==n.columns)throw new RangeError("vector size must be the same as the number of columns");return t}function checkColumnVector(n,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==n.rows)throw new RangeError("vector size must be the same as the number of rows");return t}function checkRowIndices(n,t){if(!isAnyArray(t))throw new TypeError("row indices must be an array");for(let s=0;s<t.length;s++)if(t[s]<0||t[s]>=n.rows)throw new RangeError("row indices are out of range")}function checkColumnIndices(n,t){if(!isAnyArray(t))throw new TypeError("column indices must be an array");for(let s=0;s<t.length;s++)if(t[s]<0||t[s]>=n.columns)throw new RangeError("column indices are out of range")}function checkRange(n,t,s,l,p){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(checkNumber("startRow",t),checkNumber("endRow",s),checkNumber("startColumn",l),checkNumber("endColumn",p),t>s||l>p||t<0||t>=n.rows||s<0||s>=n.rows||l<0||l>=n.columns||p<0||p>=n.columns)throw new RangeError("Submatrix indices are out of range")}function newArray$1(n,t=0){let s=[];for(let l=0;l<n;l++)s.push(t);return s}function checkNumber(n,t){if(typeof t!="number")throw new TypeError(`${n} must be a number`)}function checkNonEmpty(n){if(n.isEmpty())throw new Error("Empty matrix has no elements to index")}function sumByRow(n){let t=newArray$1(n.rows);for(let s=0;s<n.rows;++s)for(let l=0;l<n.columns;++l)t[s]+=n.get(s,l);return t}function sumByColumn(n){let t=newArray$1(n.columns);for(let s=0;s<n.rows;++s)for(let l=0;l<n.columns;++l)t[l]+=n.get(s,l);return t}function sumAll(n){let t=0;for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)t+=n.get(s,l);return t}function productByRow(n){let t=newArray$1(n.rows,1);for(let s=0;s<n.rows;++s)for(let l=0;l<n.columns;++l)t[s]*=n.get(s,l);return t}function productByColumn(n){let t=newArray$1(n.columns,1);for(let s=0;s<n.rows;++s)for(let l=0;l<n.columns;++l)t[l]*=n.get(s,l);return t}function productAll(n){let t=1;for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)t*=n.get(s,l);return t}function varianceByRow(n,t,s){const l=n.rows,p=n.columns,g=[];for(let w=0;w<l;w++){let u=0,A=0,S=0;for(let D=0;D<p;D++)S=n.get(w,D)-s[w],u+=S,A+=S*S;t?g.push((A-u*u/p)/(p-1)):g.push((A-u*u/p)/p)}return g}function varianceByColumn(n,t,s){const l=n.rows,p=n.columns,g=[];for(let w=0;w<p;w++){let u=0,A=0,S=0;for(let D=0;D<l;D++)S=n.get(D,w)-s[w],u+=S,A+=S*S;t?g.push((A-u*u/l)/(l-1)):g.push((A-u*u/l)/l)}return g}function varianceAll(n,t,s){const l=n.rows,p=n.columns,g=l*p;let w=0,u=0,A=0;for(let S=0;S<l;S++)for(let D=0;D<p;D++)A=n.get(S,D)-s,w+=A,u+=A*A;return t?(u-w*w/g)/(g-1):(u-w*w/g)/g}function centerByRow(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)-t[s])}function centerByColumn(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)-t[l])}function centerAll(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)-t)}function getScaleByRow(n){const t=[];for(let s=0;s<n.rows;s++){let l=0;for(let p=0;p<n.columns;p++)l+=Math.pow(n.get(s,p),2)/(n.columns-1);t.push(Math.sqrt(l))}return t}function scaleByRow(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)/t[s])}function getScaleByColumn(n){const t=[];for(let s=0;s<n.columns;s++){let l=0;for(let p=0;p<n.rows;p++)l+=Math.pow(n.get(p,s),2)/(n.rows-1);t.push(Math.sqrt(l))}return t}function scaleByColumn(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)/t[l])}function getScaleAll(n){const t=n.size-1;let s=0;for(let l=0;l<n.columns;l++)for(let p=0;p<n.rows;p++)s+=Math.pow(n.get(p,l),2)/t;return Math.sqrt(s)}function scaleAll(n,t){for(let s=0;s<n.rows;s++)for(let l=0;l<n.columns;l++)n.set(s,l,n.get(s,l)/t)}class AbstractMatrix{static from1DArray(t,s,l){if(t*s!==l.length)throw new RangeError("data length does not match given dimensions");let g=new Matrix$2(t,s);for(let w=0;w<t;w++)for(let u=0;u<s;u++)g.set(w,u,l[w*s+u]);return g}static rowVector(t){let s=new Matrix$2(1,t.length);for(let l=0;l<t.length;l++)s.set(0,l,t[l]);return s}static columnVector(t){let s=new Matrix$2(t.length,1);for(let l=0;l<t.length;l++)s.set(l,0,t[l]);return s}static zeros(t,s){return new Matrix$2(t,s)}static ones(t,s){return new Matrix$2(t,s).fill(1)}static rand(t,s,l={}){if(typeof l!="object")throw new TypeError("options must be an object");const{random:p=Math.random}=l;let g=new Matrix$2(t,s);for(let w=0;w<t;w++)for(let u=0;u<s;u++)g.set(w,u,p());return g}static randInt(t,s,l={}){if(typeof l!="object")throw new TypeError("options must be an object");const{min:p=0,max:g=1e3,random:w=Math.random}=l;if(!Number.isInteger(p))throw new TypeError("min must be an integer");if(!Number.isInteger(g))throw new TypeError("max must be an integer");if(p>=g)throw new RangeError("min must be smaller than max");let u=g-p,A=new Matrix$2(t,s);for(let S=0;S<t;S++)for(let D=0;D<s;D++){let z=p+Math.round(w()*u);A.set(S,D,z)}return A}static eye(t,s,l){s===void 0&&(s=t),l===void 0&&(l=1);let p=Math.min(t,s),g=this.zeros(t,s);for(let w=0;w<p;w++)g.set(w,w,l);return g}static diag(t,s,l){let p=t.length;s===void 0&&(s=p),l===void 0&&(l=s);let g=Math.min(p,s,l),w=this.zeros(s,l);for(let u=0;u<g;u++)w.set(u,u,t[u]);return w}static min(t,s){t=this.checkMatrix(t),s=this.checkMatrix(s);let l=t.rows,p=t.columns,g=new Matrix$2(l,p);for(let w=0;w<l;w++)for(let u=0;u<p;u++)g.set(w,u,Math.min(t.get(w,u),s.get(w,u)));return g}static max(t,s){t=this.checkMatrix(t),s=this.checkMatrix(s);let l=t.rows,p=t.columns,g=new this(l,p);for(let w=0;w<l;w++)for(let u=0;u<p;u++)g.set(w,u,Math.max(t.get(w,u),s.get(w,u)));return g}static checkMatrix(t){return AbstractMatrix.isMatrix(t)?t:new Matrix$2(t)}static isMatrix(t){return t!=null&&t.klass==="Matrix"}get size(){return this.rows*this.columns}apply(t){if(typeof t!="function")throw new TypeError("callback must be a function");for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t.call(this,s,l);return this}to1DArray(){let t=[];for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t.push(this.get(s,l));return t}to2DArray(){let t=[];for(let s=0;s<this.rows;s++){t.push([]);for(let l=0;l<this.columns;l++)t[s].push(this.get(s,l))}return t}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let t=0;t<this.rows;t++)for(let s=0;s<=t;s++)if(this.get(t,s)!==this.get(s,t))return!1;return!0}return!1}isEchelonForm(){let t=0,s=0,l=-1,p=!0,g=!1;for(;t<this.rows&&p;){for(s=0,g=!1;s<this.columns&&g===!1;)this.get(t,s)===0?s++:this.get(t,s)===1&&s>l?(g=!0,l=s):(p=!1,g=!0);t++}return p}isReducedEchelonForm(){let t=0,s=0,l=-1,p=!0,g=!1;for(;t<this.rows&&p;){for(s=0,g=!1;s<this.columns&&g===!1;)this.get(t,s)===0?s++:this.get(t,s)===1&&s>l?(g=!0,l=s):(p=!1,g=!0);for(let w=s+1;w<this.rows;w++)this.get(t,w)!==0&&(p=!1);t++}return p}echelonForm(){let t=this.clone(),s=0,l=0;for(;s<t.rows&&l<t.columns;){let p=s;for(let g=s;g<t.rows;g++)t.get(g,l)>t.get(p,l)&&(p=g);if(t.get(p,l)===0)l++;else{t.swapRows(s,p);let g=t.get(s,l);for(let w=l;w<t.columns;w++)t.set(s,w,t.get(s,w)/g);for(let w=s+1;w<t.rows;w++){let u=t.get(w,l)/t.get(s,l);t.set(w,l,0);for(let A=l+1;A<t.columns;A++)t.set(w,A,t.get(w,A)-t.get(s,A)*u)}s++,l++}}return t}reducedEchelonForm(){let t=this.echelonForm(),s=t.columns,l=t.rows,p=l-1;for(;p>=0;)if(t.maxRow(p)===0)p--;else{let g=0,w=!1;for(;g<l&&w===!1;)t.get(p,g)===1?w=!0:g++;for(let u=0;u<p;u++){let A=t.get(u,g);for(let S=g;S<s;S++){let D=t.get(u,S)-A*t.get(p,S);t.set(u,S,D)}}p--}return t}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{rows:s=1,columns:l=1}=t;if(!Number.isInteger(s)||s<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(l)||l<=0)throw new TypeError("columns must be a positive integer");let p=new Matrix$2(this.rows*s,this.columns*l);for(let g=0;g<s;g++)for(let w=0;w<l;w++)p.setSubMatrix(this,this.rows*g,this.columns*w);return p}fill(t){for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,t);return this}neg(){return this.mulS(-1)}getRow(t){checkRowIndex(this,t);let s=[];for(let l=0;l<this.columns;l++)s.push(this.get(t,l));return s}getRowVector(t){return Matrix$2.rowVector(this.getRow(t))}setRow(t,s){checkRowIndex(this,t),s=checkRowVector(this,s);for(let l=0;l<this.columns;l++)this.set(t,l,s[l]);return this}swapRows(t,s){checkRowIndex(this,t),checkRowIndex(this,s);for(let l=0;l<this.columns;l++){let p=this.get(t,l);this.set(t,l,this.get(s,l)),this.set(s,l,p)}return this}getColumn(t){checkColumnIndex(this,t);let s=[];for(let l=0;l<this.rows;l++)s.push(this.get(l,t));return s}getColumnVector(t){return Matrix$2.columnVector(this.getColumn(t))}setColumn(t,s){checkColumnIndex(this,t),s=checkColumnVector(this,s);for(let l=0;l<this.rows;l++)this.set(l,t,s[l]);return this}swapColumns(t,s){checkColumnIndex(this,t),checkColumnIndex(this,s);for(let l=0;l<this.rows;l++){let p=this.get(l,t);this.set(l,t,this.get(l,s)),this.set(l,s,p)}return this}addRowVector(t){t=checkRowVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)+t[l]);return this}subRowVector(t){t=checkRowVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)-t[l]);return this}mulRowVector(t){t=checkRowVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)*t[l]);return this}divRowVector(t){t=checkRowVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)/t[l]);return this}addColumnVector(t){t=checkColumnVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)+t[s]);return this}subColumnVector(t){t=checkColumnVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)-t[s]);return this}mulColumnVector(t){t=checkColumnVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)*t[s]);return this}divColumnVector(t){t=checkColumnVector(this,t);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)this.set(s,l,this.get(s,l)/t[s]);return this}mulRow(t,s){checkRowIndex(this,t);for(let l=0;l<this.columns;l++)this.set(t,l,this.get(t,l)*s);return this}mulColumn(t,s){checkColumnIndex(this,t);for(let l=0;l<this.rows;l++)this.set(l,t,this.get(l,t)*s);return this}max(t){if(this.isEmpty())return NaN;switch(t){case"row":{const s=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.get(l,p)>s[l]&&(s[l]=this.get(l,p));return s}case"column":{const s=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.get(l,p)>s[p]&&(s[p]=this.get(l,p));return s}case void 0:{let s=this.get(0,0);for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.get(l,p)>s&&(s=this.get(l,p));return s}default:throw new Error(`invalid option: ${t}`)}}maxIndex(){checkNonEmpty(this);let t=this.get(0,0),s=[0,0];for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.get(l,p)>t&&(t=this.get(l,p),s[0]=l,s[1]=p);return s}min(t){if(this.isEmpty())return NaN;switch(t){case"row":{const s=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.get(l,p)<s[l]&&(s[l]=this.get(l,p));return s}case"column":{const s=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.get(l,p)<s[p]&&(s[p]=this.get(l,p));return s}case void 0:{let s=this.get(0,0);for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.get(l,p)<s&&(s=this.get(l,p));return s}default:throw new Error(`invalid option: ${t}`)}}minIndex(){checkNonEmpty(this);let t=this.get(0,0),s=[0,0];for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)this.get(l,p)<t&&(t=this.get(l,p),s[0]=l,s[1]=p);return s}maxRow(t){if(checkRowIndex(this,t),this.isEmpty())return NaN;let s=this.get(t,0);for(let l=1;l<this.columns;l++)this.get(t,l)>s&&(s=this.get(t,l));return s}maxRowIndex(t){checkRowIndex(this,t),checkNonEmpty(this);let s=this.get(t,0),l=[t,0];for(let p=1;p<this.columns;p++)this.get(t,p)>s&&(s=this.get(t,p),l[1]=p);return l}minRow(t){if(checkRowIndex(this,t),this.isEmpty())return NaN;let s=this.get(t,0);for(let l=1;l<this.columns;l++)this.get(t,l)<s&&(s=this.get(t,l));return s}minRowIndex(t){checkRowIndex(this,t),checkNonEmpty(this);let s=this.get(t,0),l=[t,0];for(let p=1;p<this.columns;p++)this.get(t,p)<s&&(s=this.get(t,p),l[1]=p);return l}maxColumn(t){if(checkColumnIndex(this,t),this.isEmpty())return NaN;let s=this.get(0,t);for(let l=1;l<this.rows;l++)this.get(l,t)>s&&(s=this.get(l,t));return s}maxColumnIndex(t){checkColumnIndex(this,t),checkNonEmpty(this);let s=this.get(0,t),l=[0,t];for(let p=1;p<this.rows;p++)this.get(p,t)>s&&(s=this.get(p,t),l[0]=p);return l}minColumn(t){if(checkColumnIndex(this,t),this.isEmpty())return NaN;let s=this.get(0,t);for(let l=1;l<this.rows;l++)this.get(l,t)<s&&(s=this.get(l,t));return s}minColumnIndex(t){checkColumnIndex(this,t),checkNonEmpty(this);let s=this.get(0,t),l=[0,t];for(let p=1;p<this.rows;p++)this.get(p,t)<s&&(s=this.get(p,t),l[0]=p);return l}diag(){let t=Math.min(this.rows,this.columns),s=[];for(let l=0;l<t;l++)s.push(this.get(l,l));return s}norm(t="frobenius"){let s=0;if(t==="max")return this.max();if(t==="frobenius"){for(let l=0;l<this.rows;l++)for(let p=0;p<this.columns;p++)s=s+this.get(l,p)*this.get(l,p);return Math.sqrt(s)}else throw new RangeError(`unknown norm type: ${t}`)}cumulativeSum(){let t=0;for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t+=this.get(s,l),this.set(s,l,t);return this}dot(t){AbstractMatrix.isMatrix(t)&&(t=t.to1DArray());let s=this.to1DArray();if(s.length!==t.length)throw new RangeError("vectors do not have the same size");let l=0;for(let p=0;p<s.length;p++)l+=s[p]*t[p];return l}mmul(t){t=Matrix$2.checkMatrix(t);let s=this.rows,l=this.columns,p=t.columns,g=new Matrix$2(s,p),w=new Float64Array(l);for(let u=0;u<p;u++){for(let A=0;A<l;A++)w[A]=t.get(A,u);for(let A=0;A<s;A++){let S=0;for(let D=0;D<l;D++)S+=this.get(A,D)*w[D];g.set(A,u,S)}}return g}strassen2x2(t){t=Matrix$2.checkMatrix(t);let s=new Matrix$2(2,2);const l=this.get(0,0),p=t.get(0,0),g=this.get(0,1),w=t.get(0,1),u=this.get(1,0),A=t.get(1,0),S=this.get(1,1),D=t.get(1,1),z=(l+S)*(p+D),$=(u+S)*p,O=l*(w-D),q=S*(A-p),K=(l+g)*D,J=(u-l)*(p+w),Y=(g-S)*(A+D),fe=z+q-K+Y,ee=O+K,re=$+q,he=z-$+O+J;return s.set(0,0,fe),s.set(0,1,ee),s.set(1,0,re),s.set(1,1,he),s}strassen3x3(t){t=Matrix$2.checkMatrix(t);let s=new Matrix$2(3,3);const l=this.get(0,0),p=this.get(0,1),g=this.get(0,2),w=this.get(1,0),u=this.get(1,1),A=this.get(1,2),S=this.get(2,0),D=this.get(2,1),z=this.get(2,2),$=t.get(0,0),O=t.get(0,1),q=t.get(0,2),K=t.get(1,0),J=t.get(1,1),Y=t.get(1,2),fe=t.get(2,0),ee=t.get(2,1),re=t.get(2,2),he=(l+p+g-w-u-D-z)*J,_e=(l-w)*(-O+J),we=u*(-$+O+K-J-Y-fe+re),oe=(-l+w+u)*($-O+J),be=(w+u)*(-$+O),ie=l*$,ue=(-l+S+D)*($-q+Y),Ce=(-l+S)*(q-Y),Ne=(S+D)*(-$+q),it=(l+p+g-u-A-S-D)*Y,rt=D*(-$+q+K-J-Y-fe+ee),Pt=(-g+D+z)*(J+fe-ee),zt=(g-z)*(J-ee),vt=g*fe,Vt=(D+z)*(-fe+ee),kt=(-g+u+A)*(Y+fe-re),Yt=(g-A)*(Y-re),Qt=(u+A)*(-fe+re),ot=p*K,gt=A*ee,pt=w*q,Bt=S*O,Zt=z*re,si=ie+vt+ot,ii=he+oe+be+ie+Pt+vt+Vt,pi=ie+ue+Ne+it+vt+kt+Qt,ai=_e+we+oe+ie+vt+kt+Yt,Nt=_e+oe+be+ie+gt,ci=vt+kt+Yt+Qt+pt,$t=ie+ue+Ce+rt+Pt+zt+vt,ft=Pt+zt+vt+Vt+Bt,_i=ie+ue+Ce+Ne+Zt;return s.set(0,0,si),s.set(0,1,ii),s.set(0,2,pi),s.set(1,0,ai),s.set(1,1,Nt),s.set(1,2,ci),s.set(2,0,$t),s.set(2,1,ft),s.set(2,2,_i),s}mmulStrassen(t){t=Matrix$2.checkMatrix(t);let s=this.clone(),l=s.rows,p=s.columns,g=t.rows,w=t.columns;p!==g&&console.warn(`Multiplying ${l} x ${p} and ${g} x ${w} matrix: dimensions do not match.`);function u(z,$,O){let q=z.rows,K=z.columns;if(q===$&&K===O)return z;{let J=AbstractMatrix.zeros($,O);return J=J.setSubMatrix(z,0,0),J}}let A=Math.max(l,g),S=Math.max(p,w);s=u(s,A,S),t=u(t,A,S);function D(z,$,O,q){if(O<=512||q<=512)return z.mmul($);O%2===1&&q%2===1?(z=u(z,O+1,q+1),$=u($,O+1,q+1)):O%2===1?(z=u(z,O+1,q),$=u($,O+1,q)):q%2===1&&(z=u(z,O,q+1),$=u($,O,q+1));let K=parseInt(z.rows/2,10),J=parseInt(z.columns/2,10),Y=z.subMatrix(0,K-1,0,J-1),fe=$.subMatrix(0,K-1,0,J-1),ee=z.subMatrix(0,K-1,J,z.columns-1),re=$.subMatrix(0,K-1,J,$.columns-1),he=z.subMatrix(K,z.rows-1,0,J-1),_e=$.subMatrix(K,$.rows-1,0,J-1),we=z.subMatrix(K,z.rows-1,J,z.columns-1),oe=$.subMatrix(K,$.rows-1,J,$.columns-1),be=D(AbstractMatrix.add(Y,we),AbstractMatrix.add(fe,oe),K,J),ie=D(AbstractMatrix.add(he,we),fe,K,J),ue=D(Y,AbstractMatrix.sub(re,oe),K,J),Ce=D(we,AbstractMatrix.sub(_e,fe),K,J),Ne=D(AbstractMatrix.add(Y,ee),oe,K,J),it=D(AbstractMatrix.sub(he,Y),AbstractMatrix.add(fe,re),K,J),rt=D(AbstractMatrix.sub(ee,we),AbstractMatrix.add(_e,oe),K,J),Pt=AbstractMatrix.add(be,Ce);Pt.sub(Ne),Pt.add(rt);let zt=AbstractMatrix.add(ue,Ne),vt=AbstractMatrix.add(ie,Ce),Vt=AbstractMatrix.sub(be,ie);Vt.add(ue),Vt.add(it);let kt=AbstractMatrix.zeros(2*Pt.rows,2*Pt.columns);return kt=kt.setSubMatrix(Pt,0,0),kt=kt.setSubMatrix(zt,Pt.rows,0),kt=kt.setSubMatrix(vt,0,Pt.columns),kt=kt.setSubMatrix(Vt,Pt.rows,Pt.columns),kt.subMatrix(0,O-1,0,q-1)}return D(s,t,A,S)}scaleRows(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:s=0,max:l=1}=t;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(l))throw new TypeError("max must be a number");if(s>=l)throw new RangeError("min must be smaller than max");let p=new Matrix$2(this.rows,this.columns);for(let g=0;g<this.rows;g++){const w=this.getRow(g);w.length>0&&rescale(w,{min:s,max:l,output:w}),p.setRow(g,w)}return p}scaleColumns(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:s=0,max:l=1}=t;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(l))throw new TypeError("max must be a number");if(s>=l)throw new RangeError("min must be smaller than max");let p=new Matrix$2(this.rows,this.columns);for(let g=0;g<this.columns;g++){const w=this.getColumn(g);w.length&&rescale(w,{min:s,max:l,output:w}),p.setColumn(g,w)}return p}flipRows(){const t=Math.ceil(this.columns/2);for(let s=0;s<this.rows;s++)for(let l=0;l<t;l++){let p=this.get(s,l),g=this.get(s,this.columns-1-l);this.set(s,l,g),this.set(s,this.columns-1-l,p)}return this}flipColumns(){const t=Math.ceil(this.rows/2);for(let s=0;s<this.columns;s++)for(let l=0;l<t;l++){let p=this.get(l,s),g=this.get(this.rows-1-l,s);this.set(l,s,g),this.set(this.rows-1-l,s,p)}return this}kroneckerProduct(t){t=Matrix$2.checkMatrix(t);let s=this.rows,l=this.columns,p=t.rows,g=t.columns,w=new Matrix$2(s*p,l*g);for(let u=0;u<s;u++)for(let A=0;A<l;A++)for(let S=0;S<p;S++)for(let D=0;D<g;D++)w.set(p*u+S,g*A+D,this.get(u,A)*t.get(S,D));return w}kroneckerSum(t){if(t=Matrix$2.checkMatrix(t),!this.isSquare()||!t.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let s=this.rows,l=t.rows,p=this.kroneckerProduct(Matrix$2.eye(l,l)),g=Matrix$2.eye(s,s).kroneckerProduct(t);return p.add(g)}transpose(){let t=new Matrix$2(this.columns,this.rows);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t.set(l,s,this.get(s,l));return t}sortRows(t=compareNumbers){for(let s=0;s<this.rows;s++)this.setRow(s,this.getRow(s).sort(t));return this}sortColumns(t=compareNumbers){for(let s=0;s<this.columns;s++)this.setColumn(s,this.getColumn(s).sort(t));return this}subMatrix(t,s,l,p){checkRange(this,t,s,l,p);let g=new Matrix$2(s-t+1,p-l+1);for(let w=t;w<=s;w++)for(let u=l;u<=p;u++)g.set(w-t,u-l,this.get(w,u));return g}subMatrixRow(t,s,l){if(s===void 0&&(s=0),l===void 0&&(l=this.columns-1),s>l||s<0||s>=this.columns||l<0||l>=this.columns)throw new RangeError("Argument out of range");let p=new Matrix$2(t.length,l-s+1);for(let g=0;g<t.length;g++)for(let w=s;w<=l;w++){if(t[g]<0||t[g]>=this.rows)throw new RangeError(`Row index out of range: ${t[g]}`);p.set(g,w-s,this.get(t[g],w))}return p}subMatrixColumn(t,s,l){if(s===void 0&&(s=0),l===void 0&&(l=this.rows-1),s>l||s<0||s>=this.rows||l<0||l>=this.rows)throw new RangeError("Argument out of range");let p=new Matrix$2(l-s+1,t.length);for(let g=0;g<t.length;g++)for(let w=s;w<=l;w++){if(t[g]<0||t[g]>=this.columns)throw new RangeError(`Column index out of range: ${t[g]}`);p.set(w-s,g,this.get(w,t[g]))}return p}setSubMatrix(t,s,l){if(t=Matrix$2.checkMatrix(t),t.isEmpty())return this;let p=s+t.rows-1,g=l+t.columns-1;checkRange(this,s,p,l,g);for(let w=0;w<t.rows;w++)for(let u=0;u<t.columns;u++)this.set(s+w,l+u,t.get(w,u));return this}selection(t,s){checkRowIndices(this,t),checkColumnIndices(this,s);let l=new Matrix$2(t.length,s.length);for(let p=0;p<t.length;p++){let g=t[p];for(let w=0;w<s.length;w++){let u=s[w];l.set(p,w,this.get(g,u))}}return l}trace(){let t=Math.min(this.rows,this.columns),s=0;for(let l=0;l<t;l++)s+=this.get(l,l);return s}clone(){let t=new Matrix$2(this.rows,this.columns);for(let s=0;s<this.rows;s++)for(let l=0;l<this.columns;l++)t.set(s,l,this.get(s,l));return t}sum(t){switch(t){case"row":return sumByRow(this);case"column":return sumByColumn(this);case void 0:return sumAll(this);default:throw new Error(`invalid option: ${t}`)}}product(t){switch(t){case"row":return productByRow(this);case"column":return productByColumn(this);case void 0:return productAll(this);default:throw new Error(`invalid option: ${t}`)}}mean(t){const s=this.sum(t);switch(t){case"row":{for(let l=0;l<this.rows;l++)s[l]/=this.columns;return s}case"column":{for(let l=0;l<this.columns;l++)s[l]/=this.rows;return s}case void 0:return s/this.size;default:throw new Error(`invalid option: ${t}`)}}variance(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");const{unbiased:l=!0,mean:p=this.mean(t)}=s;if(typeof l!="boolean")throw new TypeError("unbiased must be a boolean");switch(t){case"row":{if(!isAnyArray(p))throw new TypeError("mean must be an array");return varianceByRow(this,l,p)}case"column":{if(!isAnyArray(p))throw new TypeError("mean must be an array");return varianceByColumn(this,l,p)}case void 0:{if(typeof p!="number")throw new TypeError("mean must be a number");return varianceAll(this,l,p)}default:throw new Error(`invalid option: ${t}`)}}standardDeviation(t,s){typeof t=="object"&&(s=t,t=void 0);const l=this.variance(t,s);if(t===void 0)return Math.sqrt(l);for(let p=0;p<l.length;p++)l[p]=Math.sqrt(l[p]);return l}center(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");const{center:l=this.mean(t)}=s;switch(t){case"row":{if(!isAnyArray(l))throw new TypeError("center must be an array");return centerByRow(this,l),this}case"column":{if(!isAnyArray(l))throw new TypeError("center must be an array");return centerByColumn(this,l),this}case void 0:{if(typeof l!="number")throw new TypeError("center must be a number");return centerAll(this,l),this}default:throw new Error(`invalid option: ${t}`)}}scale(t,s={}){if(typeof t=="object"&&(s=t,t=void 0),typeof s!="object")throw new TypeError("options must be an object");let l=s.scale;switch(t){case"row":{if(l===void 0)l=getScaleByRow(this);else if(!isAnyArray(l))throw new TypeError("scale must be an array");return scaleByRow(this,l),this}case"column":{if(l===void 0)l=getScaleByColumn(this);else if(!isAnyArray(l))throw new TypeError("scale must be an array");return scaleByColumn(this,l),this}case void 0:{if(l===void 0)l=getScaleAll(this);else if(typeof l!="number")throw new TypeError("scale must be a number");return scaleAll(this,l),this}default:throw new Error(`invalid option: ${t}`)}}toString(t){return inspectMatrixWithOptions(this,t)}}AbstractMatrix.prototype.klass="Matrix";typeof Symbol!="undefined"&&(AbstractMatrix.prototype[Symbol.for("nodejs.util.inspect.custom")]=inspectMatrix);function compareNumbers(n,t){return n-t}AbstractMatrix.random=AbstractMatrix.rand;AbstractMatrix.randomInt=AbstractMatrix.randInt;AbstractMatrix.diagonal=AbstractMatrix.diag;AbstractMatrix.prototype.diagonal=AbstractMatrix.prototype.diag;AbstractMatrix.identity=AbstractMatrix.eye;AbstractMatrix.prototype.negate=AbstractMatrix.prototype.neg;AbstractMatrix.prototype.tensorProduct=AbstractMatrix.prototype.kroneckerProduct;class Matrix$2 extends AbstractMatrix{constructor(t,s){if(super(),Matrix$2.isMatrix(t))return t.clone();if(Number.isInteger(t)&&t>=0)if(this.data=[],Number.isInteger(s)&&s>=0)for(let l=0;l<t;l++)this.data.push(new Float64Array(s));else throw new TypeError("nColumns must be a positive integer");else if(isAnyArray(t)){const l=t;if(t=l.length,s=t?l[0].length:0,typeof s!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let p=0;p<t;p++){if(l[p].length!==s)throw new RangeError("Inconsistent array dimensions");this.data.push(Float64Array.from(l[p]))}}else throw new TypeError("First argument must be a positive number or an array");this.rows=t,this.columns=s}set(t,s,l){return this.data[t][s]=l,this}get(t,s){return this.data[t][s]}removeRow(t){return checkRowIndex(this,t),this.data.splice(t,1),this.rows-=1,this}addRow(t,s){return s===void 0&&(s=t,t=this.rows),checkRowIndex(this,t,!0),s=Float64Array.from(checkRowVector(this,s)),this.data.splice(t,0,s),this.rows+=1,this}removeColumn(t){checkColumnIndex(this,t);for(let s=0;s<this.rows;s++){const l=new Float64Array(this.columns-1);for(let p=0;p<t;p++)l[p]=this.data[s][p];for(let p=t+1;p<this.columns;p++)l[p-1]=this.data[s][p];this.data[s]=l}return this.columns-=1,this}addColumn(t,s){typeof s=="undefined"&&(s=t,t=this.columns),checkColumnIndex(this,t,!0),s=checkColumnVector(this,s);for(let l=0;l<this.rows;l++){const p=new Float64Array(this.columns+1);let g=0;for(;g<t;g++)p[g]=this.data[l][g];for(p[g++]=s[l];g<this.columns+1;g++)p[g]=this.data[l][g-1];this.data[l]=p}return this.columns+=1,this}}installMathOperations(AbstractMatrix,Matrix$2);class BaseView extends AbstractMatrix{constructor(t,s,l){super(),this.matrix=t,this.rows=s,this.columns=l}}class MatrixColumnView extends BaseView{constructor(t,s){checkColumnIndex(t,s),super(t,t.rows,1),this.column=s}set(t,s,l){return this.matrix.set(t,this.column,l),this}get(t){return this.matrix.get(t,this.column)}}class MatrixColumnSelectionView extends BaseView{constructor(t,s){checkColumnIndices(t,s),super(t,t.rows,s.length),this.columnIndices=s}set(t,s,l){return this.matrix.set(t,this.columnIndices[s],l),this}get(t,s){return this.matrix.get(t,this.columnIndices[s])}}class MatrixFlipColumnView extends BaseView{constructor(t){super(t,t.rows,t.columns)}set(t,s,l){return this.matrix.set(t,this.columns-s-1,l),this}get(t,s){return this.matrix.get(t,this.columns-s-1)}}class MatrixFlipRowView extends BaseView{constructor(t){super(t,t.rows,t.columns)}set(t,s,l){return this.matrix.set(this.rows-t-1,s,l),this}get(t,s){return this.matrix.get(this.rows-t-1,s)}}class MatrixRowView extends BaseView{constructor(t,s){checkRowIndex(t,s),super(t,1,t.columns),this.row=s}set(t,s,l){return this.matrix.set(this.row,s,l),this}get(t,s){return this.matrix.get(this.row,s)}}class MatrixRowSelectionView extends BaseView{constructor(t,s){checkRowIndices(t,s),super(t,s.length,t.columns),this.rowIndices=s}set(t,s,l){return this.matrix.set(this.rowIndices[t],s,l),this}get(t,s){return this.matrix.get(this.rowIndices[t],s)}}class MatrixSelectionView extends BaseView{constructor(t,s,l){checkRowIndices(t,s),checkColumnIndices(t,l),super(t,s.length,l.length),this.rowIndices=s,this.columnIndices=l}set(t,s,l){return this.matrix.set(this.rowIndices[t],this.columnIndices[s],l),this}get(t,s){return this.matrix.get(this.rowIndices[t],this.columnIndices[s])}}class MatrixSubView extends BaseView{constructor(t,s,l,p,g){checkRange(t,s,l,p,g),super(t,l-s+1,g-p+1),this.startRow=s,this.startColumn=p}set(t,s,l){return this.matrix.set(this.startRow+t,this.startColumn+s,l),this}get(t,s){return this.matrix.get(this.startRow+t,this.startColumn+s)}}class MatrixTransposeView$1 extends BaseView{constructor(t){super(t,t.columns,t.rows)}set(t,s,l){return this.matrix.set(s,t,l),this}get(t,s){return this.matrix.get(s,t)}}class WrapperMatrix1D extends AbstractMatrix{constructor(t,s={}){const{rows:l=1}=s;if(t.length%l!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=l,this.columns=t.length/l,this.data=t}set(t,s,l){let p=this._calculateIndex(t,s);return this.data[p]=l,this}get(t,s){let l=this._calculateIndex(t,s);return this.data[l]}_calculateIndex(t,s){return t*this.columns+s}}class WrapperMatrix2D extends AbstractMatrix{constructor(t){super(),this.data=t,this.rows=t.length,this.columns=t[0].length}set(t,s,l){return this.data[t][s]=l,this}get(t,s){return this.data[t][s]}}function wrap(n,t){if(isAnyArray(n))return n[0]&&isAnyArray(n[0])?new WrapperMatrix2D(n):new WrapperMatrix1D(n,t);throw new Error("the argument is not an array")}class LuDecomposition{constructor(t){t=WrapperMatrix2D.checkMatrix(t);let s=t.clone(),l=s.rows,p=s.columns,g=new Float64Array(l),w=1,u,A,S,D,z,$,O,q,K;for(u=0;u<l;u++)g[u]=u;for(q=new Float64Array(l),A=0;A<p;A++){for(u=0;u<l;u++)q[u]=s.get(u,A);for(u=0;u<l;u++){for(K=Math.min(u,A),z=0,S=0;S<K;S++)z+=s.get(u,S)*q[S];q[u]-=z,s.set(u,A,q[u])}for(D=A,u=A+1;u<l;u++)Math.abs(q[u])>Math.abs(q[D])&&(D=u);if(D!==A){for(S=0;S<p;S++)$=s.get(D,S),s.set(D,S,s.get(A,S)),s.set(A,S,$);O=g[D],g[D]=g[A],g[A]=O,w=-w}if(A<l&&s.get(A,A)!==0)for(u=A+1;u<l;u++)s.set(u,A,s.get(u,A)/s.get(A,A))}this.LU=s,this.pivotVector=g,this.pivotSign=w}isSingular(){let t=this.LU,s=t.columns;for(let l=0;l<s;l++)if(t.get(l,l)===0)return!0;return!1}solve(t){t=Matrix$2.checkMatrix(t);let s=this.LU;if(s.rows!==t.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let p=t.columns,g=t.subMatrixRow(this.pivotVector,0,p-1),w=s.columns,u,A,S;for(S=0;S<w;S++)for(u=S+1;u<w;u++)for(A=0;A<p;A++)g.set(u,A,g.get(u,A)-g.get(S,A)*s.get(u,S));for(S=w-1;S>=0;S--){for(A=0;A<p;A++)g.set(S,A,g.get(S,A)/s.get(S,S));for(u=0;u<S;u++)for(A=0;A<p;A++)g.set(u,A,g.get(u,A)-g.get(S,A)*s.get(u,S))}return g}get determinant(){let t=this.LU;if(!t.isSquare())throw new Error("Matrix must be square");let s=this.pivotSign,l=t.columns;for(let p=0;p<l;p++)s*=t.get(p,p);return s}get lowerTriangularMatrix(){let t=this.LU,s=t.rows,l=t.columns,p=new Matrix$2(s,l);for(let g=0;g<s;g++)for(let w=0;w<l;w++)g>w?p.set(g,w,t.get(g,w)):g===w?p.set(g,w,1):p.set(g,w,0);return p}get upperTriangularMatrix(){let t=this.LU,s=t.rows,l=t.columns,p=new Matrix$2(s,l);for(let g=0;g<s;g++)for(let w=0;w<l;w++)g<=w?p.set(g,w,t.get(g,w)):p.set(g,w,0);return p}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function hypotenuse$1(n,t){let s=0;return Math.abs(n)>Math.abs(t)?(s=t/n,Math.abs(n)*Math.sqrt(1+s*s)):t!==0?(s=n/t,Math.abs(t)*Math.sqrt(1+s*s)):0}class QrDecomposition{constructor(t){t=WrapperMatrix2D.checkMatrix(t);let s=t.clone(),l=t.rows,p=t.columns,g=new Float64Array(p),w,u,A,S;for(A=0;A<p;A++){let D=0;for(w=A;w<l;w++)D=hypotenuse$1(D,s.get(w,A));if(D!==0){for(s.get(A,A)<0&&(D=-D),w=A;w<l;w++)s.set(w,A,s.get(w,A)/D);for(s.set(A,A,s.get(A,A)+1),u=A+1;u<p;u++){for(S=0,w=A;w<l;w++)S+=s.get(w,A)*s.get(w,u);for(S=-S/s.get(A,A),w=A;w<l;w++)s.set(w,u,s.get(w,u)+S*s.get(w,A))}}g[A]=-D}this.QR=s,this.Rdiag=g}solve(t){t=Matrix$2.checkMatrix(t);let s=this.QR,l=s.rows;if(t.rows!==l)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let p=t.columns,g=t.clone(),w=s.columns,u,A,S,D;for(S=0;S<w;S++)for(A=0;A<p;A++){for(D=0,u=S;u<l;u++)D+=s.get(u,S)*g.get(u,A);for(D=-D/s.get(S,S),u=S;u<l;u++)g.set(u,A,g.get(u,A)+D*s.get(u,S))}for(S=w-1;S>=0;S--){for(A=0;A<p;A++)g.set(S,A,g.get(S,A)/this.Rdiag[S]);for(u=0;u<S;u++)for(A=0;A<p;A++)g.set(u,A,g.get(u,A)-g.get(S,A)*s.get(u,S))}return g.subMatrix(0,w-1,0,p-1)}isFullRank(){let t=this.QR.columns;for(let s=0;s<t;s++)if(this.Rdiag[s]===0)return!1;return!0}get upperTriangularMatrix(){let t=this.QR,s=t.columns,l=new Matrix$2(s,s),p,g;for(p=0;p<s;p++)for(g=0;g<s;g++)p<g?l.set(p,g,t.get(p,g)):p===g?l.set(p,g,this.Rdiag[p]):l.set(p,g,0);return l}get orthogonalMatrix(){let t=this.QR,s=t.rows,l=t.columns,p=new Matrix$2(s,l),g,w,u,A;for(u=l-1;u>=0;u--){for(g=0;g<s;g++)p.set(g,u,0);for(p.set(u,u,1),w=u;w<l;w++)if(t.get(u,u)!==0){for(A=0,g=u;g<s;g++)A+=t.get(g,u)*p.get(g,w);for(A=-A/t.get(u,u),g=u;g<s;g++)p.set(g,w,p.get(g,w)+A*t.get(g,u))}}return p}}class SingularValueDecomposition{constructor(t,s={}){if(t=WrapperMatrix2D.checkMatrix(t),t.isEmpty())throw new Error("Matrix must be non-empty");let l=t.rows,p=t.columns;const{computeLeftSingularVectors:g=!0,computeRightSingularVectors:w=!0,autoTranspose:u=!1}=s;let A=Boolean(g),S=Boolean(w),D=!1,z;if(l<p)if(!u)z=t.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{z=t.transpose(),l=z.rows,p=z.columns,D=!0;let ie=A;A=S,S=ie}else z=t.clone();let $=Math.min(l,p),O=Math.min(l+1,p),q=new Float64Array(O),K=new Matrix$2(l,$),J=new Matrix$2(p,p),Y=new Float64Array(p),fe=new Float64Array(l),ee=new Float64Array(O);for(let ie=0;ie<O;ie++)ee[ie]=ie;let re=Math.min(l-1,p),he=Math.max(0,Math.min(p-2,l)),_e=Math.max(re,he);for(let ie=0;ie<_e;ie++){if(ie<re){q[ie]=0;for(let ue=ie;ue<l;ue++)q[ie]=hypotenuse$1(q[ie],z.get(ue,ie));if(q[ie]!==0){z.get(ie,ie)<0&&(q[ie]=-q[ie]);for(let ue=ie;ue<l;ue++)z.set(ue,ie,z.get(ue,ie)/q[ie]);z.set(ie,ie,z.get(ie,ie)+1)}q[ie]=-q[ie]}for(let ue=ie+1;ue<p;ue++){if(ie<re&&q[ie]!==0){let Ce=0;for(let Ne=ie;Ne<l;Ne++)Ce+=z.get(Ne,ie)*z.get(Ne,ue);Ce=-Ce/z.get(ie,ie);for(let Ne=ie;Ne<l;Ne++)z.set(Ne,ue,z.get(Ne,ue)+Ce*z.get(Ne,ie))}Y[ue]=z.get(ie,ue)}if(A&&ie<re)for(let ue=ie;ue<l;ue++)K.set(ue,ie,z.get(ue,ie));if(ie<he){Y[ie]=0;for(let ue=ie+1;ue<p;ue++)Y[ie]=hypotenuse$1(Y[ie],Y[ue]);if(Y[ie]!==0){Y[ie+1]<0&&(Y[ie]=0-Y[ie]);for(let ue=ie+1;ue<p;ue++)Y[ue]/=Y[ie];Y[ie+1]+=1}if(Y[ie]=-Y[ie],ie+1<l&&Y[ie]!==0){for(let ue=ie+1;ue<l;ue++)fe[ue]=0;for(let ue=ie+1;ue<l;ue++)for(let Ce=ie+1;Ce<p;Ce++)fe[ue]+=Y[Ce]*z.get(ue,Ce);for(let ue=ie+1;ue<p;ue++){let Ce=-Y[ue]/Y[ie+1];for(let Ne=ie+1;Ne<l;Ne++)z.set(Ne,ue,z.get(Ne,ue)+Ce*fe[Ne])}}if(S)for(let ue=ie+1;ue<p;ue++)J.set(ue,ie,Y[ue])}}let we=Math.min(p,l+1);if(re<p&&(q[re]=z.get(re,re)),l<we&&(q[we-1]=0),he+1<we&&(Y[he]=z.get(he,we-1)),Y[we-1]=0,A){for(let ie=re;ie<$;ie++){for(let ue=0;ue<l;ue++)K.set(ue,ie,0);K.set(ie,ie,1)}for(let ie=re-1;ie>=0;ie--)if(q[ie]!==0){for(let ue=ie+1;ue<$;ue++){let Ce=0;for(let Ne=ie;Ne<l;Ne++)Ce+=K.get(Ne,ie)*K.get(Ne,ue);Ce=-Ce/K.get(ie,ie);for(let Ne=ie;Ne<l;Ne++)K.set(Ne,ue,K.get(Ne,ue)+Ce*K.get(Ne,ie))}for(let ue=ie;ue<l;ue++)K.set(ue,ie,-K.get(ue,ie));K.set(ie,ie,1+K.get(ie,ie));for(let ue=0;ue<ie-1;ue++)K.set(ue,ie,0)}else{for(let ue=0;ue<l;ue++)K.set(ue,ie,0);K.set(ie,ie,1)}}if(S)for(let ie=p-1;ie>=0;ie--){if(ie<he&&Y[ie]!==0)for(let ue=ie+1;ue<p;ue++){let Ce=0;for(let Ne=ie+1;Ne<p;Ne++)Ce+=J.get(Ne,ie)*J.get(Ne,ue);Ce=-Ce/J.get(ie+1,ie);for(let Ne=ie+1;Ne<p;Ne++)J.set(Ne,ue,J.get(Ne,ue)+Ce*J.get(Ne,ie))}for(let ue=0;ue<p;ue++)J.set(ue,ie,0);J.set(ie,ie,1)}let oe=we-1,be=Number.EPSILON;for(;we>0;){let ie,ue;for(ie=we-2;ie>=-1&&ie!==-1;ie--){const Ce=Number.MIN_VALUE+be*Math.abs(q[ie]+Math.abs(q[ie+1]));if(Math.abs(Y[ie])<=Ce||Number.isNaN(Y[ie])){Y[ie]=0;break}}if(ie===we-2)ue=4;else{let Ce;for(Ce=we-1;Ce>=ie&&Ce!==ie;Ce--){let Ne=(Ce!==we?Math.abs(Y[Ce]):0)+(Ce!==ie+1?Math.abs(Y[Ce-1]):0);if(Math.abs(q[Ce])<=be*Ne){q[Ce]=0;break}}Ce===ie?ue=3:Ce===we-1?ue=1:(ue=2,ie=Ce)}switch(ie++,ue){case 1:{let Ce=Y[we-2];Y[we-2]=0;for(let Ne=we-2;Ne>=ie;Ne--){let it=hypotenuse$1(q[Ne],Ce),rt=q[Ne]/it,Pt=Ce/it;if(q[Ne]=it,Ne!==ie&&(Ce=-Pt*Y[Ne-1],Y[Ne-1]=rt*Y[Ne-1]),S)for(let zt=0;zt<p;zt++)it=rt*J.get(zt,Ne)+Pt*J.get(zt,we-1),J.set(zt,we-1,-Pt*J.get(zt,Ne)+rt*J.get(zt,we-1)),J.set(zt,Ne,it)}break}case 2:{let Ce=Y[ie-1];Y[ie-1]=0;for(let Ne=ie;Ne<we;Ne++){let it=hypotenuse$1(q[Ne],Ce),rt=q[Ne]/it,Pt=Ce/it;if(q[Ne]=it,Ce=-Pt*Y[Ne],Y[Ne]=rt*Y[Ne],A)for(let zt=0;zt<l;zt++)it=rt*K.get(zt,Ne)+Pt*K.get(zt,ie-1),K.set(zt,ie-1,-Pt*K.get(zt,Ne)+rt*K.get(zt,ie-1)),K.set(zt,Ne,it)}break}case 3:{const Ce=Math.max(Math.abs(q[we-1]),Math.abs(q[we-2]),Math.abs(Y[we-2]),Math.abs(q[ie]),Math.abs(Y[ie])),Ne=q[we-1]/Ce,it=q[we-2]/Ce,rt=Y[we-2]/Ce,Pt=q[ie]/Ce,zt=Y[ie]/Ce,vt=((it+Ne)*(it-Ne)+rt*rt)/2,Vt=Ne*rt*(Ne*rt);let kt=0;(vt!==0||Vt!==0)&&(vt<0?kt=0-Math.sqrt(vt*vt+Vt):kt=Math.sqrt(vt*vt+Vt),kt=Vt/(vt+kt));let Yt=(Pt+Ne)*(Pt-Ne)+kt,Qt=Pt*zt;for(let ot=ie;ot<we-1;ot++){let gt=hypotenuse$1(Yt,Qt);gt===0&&(gt=Number.MIN_VALUE);let pt=Yt/gt,Bt=Qt/gt;if(ot!==ie&&(Y[ot-1]=gt),Yt=pt*q[ot]+Bt*Y[ot],Y[ot]=pt*Y[ot]-Bt*q[ot],Qt=Bt*q[ot+1],q[ot+1]=pt*q[ot+1],S)for(let Zt=0;Zt<p;Zt++)gt=pt*J.get(Zt,ot)+Bt*J.get(Zt,ot+1),J.set(Zt,ot+1,-Bt*J.get(Zt,ot)+pt*J.get(Zt,ot+1)),J.set(Zt,ot,gt);if(gt=hypotenuse$1(Yt,Qt),gt===0&&(gt=Number.MIN_VALUE),pt=Yt/gt,Bt=Qt/gt,q[ot]=gt,Yt=pt*Y[ot]+Bt*q[ot+1],q[ot+1]=-Bt*Y[ot]+pt*q[ot+1],Qt=Bt*Y[ot+1],Y[ot+1]=pt*Y[ot+1],A&&ot<l-1)for(let Zt=0;Zt<l;Zt++)gt=pt*K.get(Zt,ot)+Bt*K.get(Zt,ot+1),K.set(Zt,ot+1,-Bt*K.get(Zt,ot)+pt*K.get(Zt,ot+1)),K.set(Zt,ot,gt)}Y[we-2]=Yt;break}case 4:{if(q[ie]<=0&&(q[ie]=q[ie]<0?-q[ie]:0,S))for(let Ce=0;Ce<=oe;Ce++)J.set(Ce,ie,-J.get(Ce,ie));for(;ie<oe&&!(q[ie]>=q[ie+1]);){let Ce=q[ie];if(q[ie]=q[ie+1],q[ie+1]=Ce,S&&ie<p-1)for(let Ne=0;Ne<p;Ne++)Ce=J.get(Ne,ie+1),J.set(Ne,ie+1,J.get(Ne,ie)),J.set(Ne,ie,Ce);if(A&&ie<l-1)for(let Ne=0;Ne<l;Ne++)Ce=K.get(Ne,ie+1),K.set(Ne,ie+1,K.get(Ne,ie)),K.set(Ne,ie,Ce);ie++}we--;break}}}if(D){let ie=J;J=K,K=ie}this.m=l,this.n=p,this.s=q,this.U=K,this.V=J}solve(t){let s=t,l=this.threshold,p=this.s.length,g=Matrix$2.zeros(p,p);for(let $=0;$<p;$++)Math.abs(this.s[$])<=l?g.set($,$,0):g.set($,$,1/this.s[$]);let w=this.U,u=this.rightSingularVectors,A=u.mmul(g),S=u.rows,D=w.rows,z=Matrix$2.zeros(S,D);for(let $=0;$<S;$++)for(let O=0;O<D;O++){let q=0;for(let K=0;K<p;K++)q+=A.get($,K)*w.get(O,K);z.set($,O,q)}return z.mmul(s)}solveForDiagonal(t){return this.solve(Matrix$2.diag(t))}inverse(){let t=this.V,s=this.threshold,l=t.rows,p=t.columns,g=new Matrix$2(l,this.s.length);for(let D=0;D<l;D++)for(let z=0;z<p;z++)Math.abs(this.s[z])>s&&g.set(D,z,t.get(D,z)/this.s[z]);let w=this.U,u=w.rows,A=w.columns,S=new Matrix$2(l,u);for(let D=0;D<l;D++)for(let z=0;z<u;z++){let $=0;for(let O=0;O<A;O++)$+=g.get(D,O)*w.get(z,O);S.set(D,z,$)}return S}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let t=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,s=0,l=this.s;for(let p=0,g=l.length;p<g;p++)l[p]>t&&s++;return s}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return Matrix$2.diag(this.s)}}function inverse(n,t=!1){return n=WrapperMatrix2D.checkMatrix(n),t?new SingularValueDecomposition(n).inverse():solve(n,Matrix$2.eye(n.rows))}function solve(n,t,s=!1){return n=WrapperMatrix2D.checkMatrix(n),t=WrapperMatrix2D.checkMatrix(t),s?new SingularValueDecomposition(n).solve(t):n.isSquare()?new LuDecomposition(n).solve(t):new QrDecomposition(n).solve(t)}function determinant(n){if(n=Matrix$2.checkMatrix(n),n.isSquare()){if(n.columns===0)return 1;let t,s,l,p;if(n.columns===2)return t=n.get(0,0),s=n.get(0,1),l=n.get(1,0),p=n.get(1,1),t*p-s*l;if(n.columns===3){let g,w,u;return g=new MatrixSelectionView(n,[1,2],[1,2]),w=new MatrixSelectionView(n,[1,2],[0,2]),u=new MatrixSelectionView(n,[1,2],[0,1]),t=n.get(0,0),s=n.get(0,1),l=n.get(0,2),t*determinant(g)-s*determinant(w)+l*determinant(u)}else return new LuDecomposition(n).determinant}else throw Error("determinant can only be calculated for a square matrix")}function xrange(n,t){let s=[];for(let l=0;l<n;l++)l!==t&&s.push(l);return s}function dependenciesOneRow(n,t,s,l=1e-9,p=1e-9){if(n>p)return new Array(t.rows+1).fill(0);{let g=t.addRow(s,[0]);for(let w=0;w<g.rows;w++)Math.abs(g.get(w,0))<l&&g.set(w,0,0);return g.to1DArray()}}function linearDependencies(n,t={}){const{thresholdValue:s=1e-9,thresholdError:l=1e-9}=t;n=Matrix$2.checkMatrix(n);let p=n.rows,g=new Matrix$2(p,p);for(let w=0;w<p;w++){let u=Matrix$2.columnVector(n.getRow(w)),A=n.subMatrixRow(xrange(p,w)).transpose(),D=new SingularValueDecomposition(A).solve(u),z=Matrix$2.sub(u,A.mmul(D)).abs().max();g.setRow(w,dependenciesOneRow(z,D,w,s,l))}return g}function pseudoInverse(n,t=Number.EPSILON){if(n=Matrix$2.checkMatrix(n),n.isEmpty())return n.transpose();let s=new SingularValueDecomposition(n,{autoTranspose:!0}),l=s.leftSingularVectors,p=s.rightSingularVectors,g=s.diagonal;for(let w=0;w<g.length;w++)Math.abs(g[w])>t?g[w]=1/g[w]:g[w]=0;return p.mmul(Matrix$2.diag(g).mmul(l.transpose()))}function covariance(n,t=n,s={}){n=new Matrix$2(n);let l=!1;if(typeof t=="object"&&!Matrix$2.isMatrix(t)&&!isAnyArray(t)?(s=t,t=n,l=!0):t=new Matrix$2(t),n.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:p=!0}=s;p&&(n=n.center("column"),l||(t=t.center("column")));const g=n.transpose().mmul(t);for(let w=0;w<g.rows;w++)for(let u=0;u<g.columns;u++)g.set(w,u,g.get(w,u)*(1/(n.rows-1)));return g}function correlation(n,t=n,s={}){n=new Matrix$2(n);let l=!1;if(typeof t=="object"&&!Matrix$2.isMatrix(t)&&!isAnyArray(t)?(s=t,t=n,l=!0):t=new Matrix$2(t),n.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:p=!0,scale:g=!0}=s;p&&(n.center("column"),l||t.center("column")),g&&(n.scale("column"),l||t.scale("column"));const w=n.standardDeviation("column",{unbiased:!0}),u=l?w:t.standardDeviation("column",{unbiased:!0}),A=n.transpose().mmul(t);for(let S=0;S<A.rows;S++)for(let D=0;D<A.columns;D++)A.set(S,D,A.get(S,D)*(1/(w[S]*u[D]))*(1/(n.rows-1)));return A}class EigenvalueDecomposition{constructor(t,s={}){const{assumeSymmetric:l=!1}=s;if(t=WrapperMatrix2D.checkMatrix(t),!t.isSquare())throw new Error("Matrix is not a square matrix");if(t.isEmpty())throw new Error("Matrix must be non-empty");let p=t.columns,g=new Matrix$2(p,p),w=new Float64Array(p),u=new Float64Array(p),A=t,S,D,z=!1;if(l?z=!0:z=t.isSymmetric(),z){for(S=0;S<p;S++)for(D=0;D<p;D++)g.set(S,D,A.get(S,D));tred2(p,u,w,g),tql2(p,u,w,g)}else{let $=new Matrix$2(p,p),O=new Float64Array(p);for(D=0;D<p;D++)for(S=0;S<p;S++)$.set(S,D,A.get(S,D));orthes(p,$,O,g),hqr2(p,u,w,g,$)}this.n=p,this.e=u,this.d=w,this.V=g}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let t=this.n,s=this.e,l=this.d,p=new Matrix$2(t,t),g,w;for(g=0;g<t;g++){for(w=0;w<t;w++)p.set(g,w,0);p.set(g,g,l[g]),s[g]>0?p.set(g,g+1,s[g]):s[g]<0&&p.set(g,g-1,s[g])}return p}}function tred2(n,t,s,l){let p,g,w,u,A,S,D,z;for(A=0;A<n;A++)s[A]=l.get(n-1,A);for(u=n-1;u>0;u--){for(z=0,w=0,S=0;S<u;S++)z=z+Math.abs(s[S]);if(z===0)for(t[u]=s[u-1],A=0;A<u;A++)s[A]=l.get(u-1,A),l.set(u,A,0),l.set(A,u,0);else{for(S=0;S<u;S++)s[S]/=z,w+=s[S]*s[S];for(p=s[u-1],g=Math.sqrt(w),p>0&&(g=-g),t[u]=z*g,w=w-p*g,s[u-1]=p-g,A=0;A<u;A++)t[A]=0;for(A=0;A<u;A++){for(p=s[A],l.set(A,u,p),g=t[A]+l.get(A,A)*p,S=A+1;S<=u-1;S++)g+=l.get(S,A)*s[S],t[S]+=l.get(S,A)*p;t[A]=g}for(p=0,A=0;A<u;A++)t[A]/=w,p+=t[A]*s[A];for(D=p/(w+w),A=0;A<u;A++)t[A]-=D*s[A];for(A=0;A<u;A++){for(p=s[A],g=t[A],S=A;S<=u-1;S++)l.set(S,A,l.get(S,A)-(p*t[S]+g*s[S]));s[A]=l.get(u-1,A),l.set(u,A,0)}}s[u]=w}for(u=0;u<n-1;u++){if(l.set(n-1,u,l.get(u,u)),l.set(u,u,1),w=s[u+1],w!==0){for(S=0;S<=u;S++)s[S]=l.get(S,u+1)/w;for(A=0;A<=u;A++){for(g=0,S=0;S<=u;S++)g+=l.get(S,u+1)*l.get(S,A);for(S=0;S<=u;S++)l.set(S,A,l.get(S,A)-g*s[S])}}for(S=0;S<=u;S++)l.set(S,u+1,0)}for(A=0;A<n;A++)s[A]=l.get(n-1,A),l.set(n-1,A,0);l.set(n-1,n-1,1),t[0]=0}function tql2(n,t,s,l){let p,g,w,u,A,S,D,z,$,O,q,K,J,Y,fe,ee;for(w=1;w<n;w++)t[w-1]=t[w];t[n-1]=0;let re=0,he=0,_e=Number.EPSILON;for(S=0;S<n;S++){for(he=Math.max(he,Math.abs(s[S])+Math.abs(t[S])),D=S;D<n&&!(Math.abs(t[D])<=_e*he);)D++;if(D>S)do{for(p=s[S],z=(s[S+1]-p)/(2*t[S]),$=hypotenuse$1(z,1),z<0&&($=-$),s[S]=t[S]/(z+$),s[S+1]=t[S]*(z+$),O=s[S+1],g=p-s[S],w=S+2;w<n;w++)s[w]-=g;for(re=re+g,z=s[D],q=1,K=q,J=q,Y=t[S+1],fe=0,ee=0,w=D-1;w>=S;w--)for(J=K,K=q,ee=fe,p=q*t[w],g=q*z,$=hypotenuse$1(z,t[w]),t[w+1]=fe*$,fe=t[w]/$,q=z/$,z=q*s[w]-fe*p,s[w+1]=g+fe*(q*p+fe*s[w]),A=0;A<n;A++)g=l.get(A,w+1),l.set(A,w+1,fe*l.get(A,w)+q*g),l.set(A,w,q*l.get(A,w)-fe*g);z=-fe*ee*J*Y*t[S]/O,t[S]=fe*z,s[S]=q*z}while(Math.abs(t[S])>_e*he);s[S]=s[S]+re,t[S]=0}for(w=0;w<n-1;w++){for(A=w,z=s[w],u=w+1;u<n;u++)s[u]<z&&(A=u,z=s[u]);if(A!==w)for(s[A]=s[w],s[w]=z,u=0;u<n;u++)z=l.get(u,w),l.set(u,w,l.get(u,A)),l.set(u,A,z)}}function orthes(n,t,s,l){let p=0,g=n-1,w,u,A,S,D,z,$;for(z=p+1;z<=g-1;z++){for($=0,S=z;S<=g;S++)$=$+Math.abs(t.get(S,z-1));if($!==0){for(A=0,S=g;S>=z;S--)s[S]=t.get(S,z-1)/$,A+=s[S]*s[S];for(u=Math.sqrt(A),s[z]>0&&(u=-u),A=A-s[z]*u,s[z]=s[z]-u,D=z;D<n;D++){for(w=0,S=g;S>=z;S--)w+=s[S]*t.get(S,D);for(w=w/A,S=z;S<=g;S++)t.set(S,D,t.get(S,D)-w*s[S])}for(S=0;S<=g;S++){for(w=0,D=g;D>=z;D--)w+=s[D]*t.get(S,D);for(w=w/A,D=z;D<=g;D++)t.set(S,D,t.get(S,D)-w*s[D])}s[z]=$*s[z],t.set(z,z-1,$*u)}}for(S=0;S<n;S++)for(D=0;D<n;D++)l.set(S,D,S===D?1:0);for(z=g-1;z>=p+1;z--)if(t.get(z,z-1)!==0){for(S=z+1;S<=g;S++)s[S]=t.get(S,z-1);for(D=z;D<=g;D++){for(u=0,S=z;S<=g;S++)u+=s[S]*l.get(S,D);for(u=u/s[z]/t.get(z,z-1),S=z;S<=g;S++)l.set(S,D,l.get(S,D)+u*s[S])}}}function hqr2(n,t,s,l,p){let g=n-1,w=0,u=n-1,A=Number.EPSILON,S=0,D=0,z=0,$=0,O=0,q=0,K=0,J=0,Y,fe,ee,re,he,_e,we,oe,be,ie,ue,Ce,Ne,it,rt;for(Y=0;Y<n;Y++)for((Y<w||Y>u)&&(s[Y]=p.get(Y,Y),t[Y]=0),fe=Math.max(Y-1,0);fe<n;fe++)D=D+Math.abs(p.get(Y,fe));for(;g>=w;){for(re=g;re>w&&(q=Math.abs(p.get(re-1,re-1))+Math.abs(p.get(re,re)),q===0&&(q=D),!(Math.abs(p.get(re,re-1))<A*q));)re--;if(re===g)p.set(g,g,p.get(g,g)+S),s[g]=p.get(g,g),t[g]=0,g--,J=0;else if(re===g-1){if(we=p.get(g,g-1)*p.get(g-1,g),z=(p.get(g-1,g-1)-p.get(g,g))/2,$=z*z+we,K=Math.sqrt(Math.abs($)),p.set(g,g,p.get(g,g)+S),p.set(g-1,g-1,p.get(g-1,g-1)+S),oe=p.get(g,g),$>=0){for(K=z>=0?z+K:z-K,s[g-1]=oe+K,s[g]=s[g-1],K!==0&&(s[g]=oe-we/K),t[g-1]=0,t[g]=0,oe=p.get(g,g-1),q=Math.abs(oe)+Math.abs(K),z=oe/q,$=K/q,O=Math.sqrt(z*z+$*$),z=z/O,$=$/O,fe=g-1;fe<n;fe++)K=p.get(g-1,fe),p.set(g-1,fe,$*K+z*p.get(g,fe)),p.set(g,fe,$*p.get(g,fe)-z*K);for(Y=0;Y<=g;Y++)K=p.get(Y,g-1),p.set(Y,g-1,$*K+z*p.get(Y,g)),p.set(Y,g,$*p.get(Y,g)-z*K);for(Y=w;Y<=u;Y++)K=l.get(Y,g-1),l.set(Y,g-1,$*K+z*l.get(Y,g)),l.set(Y,g,$*l.get(Y,g)-z*K)}else s[g-1]=oe+z,s[g]=oe+z,t[g-1]=K,t[g]=-K;g=g-2,J=0}else{if(oe=p.get(g,g),be=0,we=0,re<g&&(be=p.get(g-1,g-1),we=p.get(g,g-1)*p.get(g-1,g)),J===10){for(S+=oe,Y=w;Y<=g;Y++)p.set(Y,Y,p.get(Y,Y)-oe);q=Math.abs(p.get(g,g-1))+Math.abs(p.get(g-1,g-2)),oe=be=.75*q,we=-.4375*q*q}if(J===30&&(q=(be-oe)/2,q=q*q+we,q>0)){for(q=Math.sqrt(q),be<oe&&(q=-q),q=oe-we/((be-oe)/2+q),Y=w;Y<=g;Y++)p.set(Y,Y,p.get(Y,Y)-q);S+=q,oe=be=we=.964}for(J=J+1,he=g-2;he>=re&&(K=p.get(he,he),O=oe-K,q=be-K,z=(O*q-we)/p.get(he+1,he)+p.get(he,he+1),$=p.get(he+1,he+1)-K-O-q,O=p.get(he+2,he+1),q=Math.abs(z)+Math.abs($)+Math.abs(O),z=z/q,$=$/q,O=O/q,!(he===re||Math.abs(p.get(he,he-1))*(Math.abs($)+Math.abs(O))<A*(Math.abs(z)*(Math.abs(p.get(he-1,he-1))+Math.abs(K)+Math.abs(p.get(he+1,he+1))))));)he--;for(Y=he+2;Y<=g;Y++)p.set(Y,Y-2,0),Y>he+2&&p.set(Y,Y-3,0);for(ee=he;ee<=g-1&&(it=ee!==g-1,ee!==he&&(z=p.get(ee,ee-1),$=p.get(ee+1,ee-1),O=it?p.get(ee+2,ee-1):0,oe=Math.abs(z)+Math.abs($)+Math.abs(O),oe!==0&&(z=z/oe,$=$/oe,O=O/oe)),oe!==0);ee++)if(q=Math.sqrt(z*z+$*$+O*O),z<0&&(q=-q),q!==0){for(ee!==he?p.set(ee,ee-1,-q*oe):re!==he&&p.set(ee,ee-1,-p.get(ee,ee-1)),z=z+q,oe=z/q,be=$/q,K=O/q,$=$/z,O=O/z,fe=ee;fe<n;fe++)z=p.get(ee,fe)+$*p.get(ee+1,fe),it&&(z=z+O*p.get(ee+2,fe),p.set(ee+2,fe,p.get(ee+2,fe)-z*K)),p.set(ee,fe,p.get(ee,fe)-z*oe),p.set(ee+1,fe,p.get(ee+1,fe)-z*be);for(Y=0;Y<=Math.min(g,ee+3);Y++)z=oe*p.get(Y,ee)+be*p.get(Y,ee+1),it&&(z=z+K*p.get(Y,ee+2),p.set(Y,ee+2,p.get(Y,ee+2)-z*O)),p.set(Y,ee,p.get(Y,ee)-z),p.set(Y,ee+1,p.get(Y,ee+1)-z*$);for(Y=w;Y<=u;Y++)z=oe*l.get(Y,ee)+be*l.get(Y,ee+1),it&&(z=z+K*l.get(Y,ee+2),l.set(Y,ee+2,l.get(Y,ee+2)-z*O)),l.set(Y,ee,l.get(Y,ee)-z),l.set(Y,ee+1,l.get(Y,ee+1)-z*$)}}}if(D!==0){for(g=n-1;g>=0;g--)if(z=s[g],$=t[g],$===0)for(re=g,p.set(g,g,1),Y=g-1;Y>=0;Y--){for(we=p.get(Y,Y)-z,O=0,fe=re;fe<=g;fe++)O=O+p.get(Y,fe)*p.get(fe,g);if(t[Y]<0)K=we,q=O;else if(re=Y,t[Y]===0?p.set(Y,g,we!==0?-O/we:-O/(A*D)):(oe=p.get(Y,Y+1),be=p.get(Y+1,Y),$=(s[Y]-z)*(s[Y]-z)+t[Y]*t[Y],_e=(oe*q-K*O)/$,p.set(Y,g,_e),p.set(Y+1,g,Math.abs(oe)>Math.abs(K)?(-O-we*_e)/oe:(-q-be*_e)/K)),_e=Math.abs(p.get(Y,g)),A*_e*_e>1)for(fe=Y;fe<=g;fe++)p.set(fe,g,p.get(fe,g)/_e)}else if($<0)for(re=g-1,Math.abs(p.get(g,g-1))>Math.abs(p.get(g-1,g))?(p.set(g-1,g-1,$/p.get(g,g-1)),p.set(g-1,g,-(p.get(g,g)-z)/p.get(g,g-1))):(rt=cdiv(0,-p.get(g-1,g),p.get(g-1,g-1)-z,$),p.set(g-1,g-1,rt[0]),p.set(g-1,g,rt[1])),p.set(g,g-1,0),p.set(g,g,1),Y=g-2;Y>=0;Y--){for(ie=0,ue=0,fe=re;fe<=g;fe++)ie=ie+p.get(Y,fe)*p.get(fe,g-1),ue=ue+p.get(Y,fe)*p.get(fe,g);if(we=p.get(Y,Y)-z,t[Y]<0)K=we,O=ie,q=ue;else if(re=Y,t[Y]===0?(rt=cdiv(-ie,-ue,we,$),p.set(Y,g-1,rt[0]),p.set(Y,g,rt[1])):(oe=p.get(Y,Y+1),be=p.get(Y+1,Y),Ce=(s[Y]-z)*(s[Y]-z)+t[Y]*t[Y]-$*$,Ne=(s[Y]-z)*2*$,Ce===0&&Ne===0&&(Ce=A*D*(Math.abs(we)+Math.abs($)+Math.abs(oe)+Math.abs(be)+Math.abs(K))),rt=cdiv(oe*O-K*ie+$*ue,oe*q-K*ue-$*ie,Ce,Ne),p.set(Y,g-1,rt[0]),p.set(Y,g,rt[1]),Math.abs(oe)>Math.abs(K)+Math.abs($)?(p.set(Y+1,g-1,(-ie-we*p.get(Y,g-1)+$*p.get(Y,g))/oe),p.set(Y+1,g,(-ue-we*p.get(Y,g)-$*p.get(Y,g-1))/oe)):(rt=cdiv(-O-be*p.get(Y,g-1),-q-be*p.get(Y,g),K,$),p.set(Y+1,g-1,rt[0]),p.set(Y+1,g,rt[1]))),_e=Math.max(Math.abs(p.get(Y,g-1)),Math.abs(p.get(Y,g))),A*_e*_e>1)for(fe=Y;fe<=g;fe++)p.set(fe,g-1,p.get(fe,g-1)/_e),p.set(fe,g,p.get(fe,g)/_e)}for(Y=0;Y<n;Y++)if(Y<w||Y>u)for(fe=Y;fe<n;fe++)l.set(Y,fe,p.get(Y,fe));for(fe=n-1;fe>=w;fe--)for(Y=w;Y<=u;Y++){for(K=0,ee=w;ee<=Math.min(fe,u);ee++)K=K+l.get(Y,ee)*p.get(ee,fe);l.set(Y,fe,K)}}}function cdiv(n,t,s,l){let p,g;return Math.abs(s)>Math.abs(l)?(p=l/s,g=s+p*l,[(n+p*t)/g,(t-p*n)/g]):(p=s/l,g=l+p*s,[(p*n+t)/g,(p*t-n)/g])}class CholeskyDecomposition{constructor(t){if(t=WrapperMatrix2D.checkMatrix(t),!t.isSymmetric())throw new Error("Matrix is not symmetric");let s=t,l=s.rows,p=new Matrix$2(l,l),g=!0,w,u,A;for(u=0;u<l;u++){let S=0;for(A=0;A<u;A++){let D=0;for(w=0;w<A;w++)D+=p.get(A,w)*p.get(u,w);D=(s.get(u,A)-D)/p.get(A,A),p.set(u,A,D),S=S+D*D}for(S=s.get(u,u)-S,g&=S>0,p.set(u,u,Math.sqrt(Math.max(S,0))),A=u+1;A<l;A++)p.set(u,A,0)}this.L=p,this.positiveDefinite=Boolean(g)}isPositiveDefinite(){return this.positiveDefinite}solve(t){t=WrapperMatrix2D.checkMatrix(t);let s=this.L,l=s.rows;if(t.rows!==l)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let p=t.columns,g=t.clone(),w,u,A;for(A=0;A<l;A++)for(u=0;u<p;u++){for(w=0;w<A;w++)g.set(A,u,g.get(A,u)-g.get(w,u)*s.get(A,w));g.set(A,u,g.get(A,u)/s.get(A,A))}for(A=l-1;A>=0;A--)for(u=0;u<p;u++){for(w=A+1;w<l;w++)g.set(A,u,g.get(A,u)-g.get(w,u)*s.get(w,A));g.set(A,u,g.get(A,u)/s.get(A,A))}return g}get lowerTriangularMatrix(){return this.L}}class nipals{constructor(t,s={}){t=WrapperMatrix2D.checkMatrix(t);let{Y:l}=s;const{scaleScores:p=!1,maxIterations:g=1e3,terminationCriteria:w=1e-10}=s;let u;if(l){if(isAnyArray(l)&&typeof l[0]=="number"?l=Matrix$2.columnVector(l):l=WrapperMatrix2D.checkMatrix(l),l.rows!==t.rows)throw new Error("Y should have the same number of rows as X");u=l.getColumnVector(0)}else u=t.getColumnVector(0);let A=1,S,D,z,$;for(let O=0;O<g&&A>w;O++)z=t.transpose().mmul(u).div(u.transpose().mmul(u).get(0,0)),z=z.div(z.norm()),S=t.mmul(z).div(z.transpose().mmul(z).get(0,0)),O>0&&(A=S.clone().sub($).pow(2).sum()),$=S.clone(),l?(D=l.transpose().mmul(S).div(S.transpose().mmul(S).get(0,0)),D=D.div(D.norm()),u=l.mmul(D).div(D.transpose().mmul(D).get(0,0))):u=S;if(l){let O=t.transpose().mmul(S).div(S.transpose().mmul(S).get(0,0));O=O.div(O.norm());let q=t.clone().sub(S.clone().mmul(O.transpose())),K=u.transpose().mmul(S).div(S.transpose().mmul(S).get(0,0)),J=l.clone().sub(S.clone().mulS(K.get(0,0)).mmul(D.transpose()));this.t=S,this.p=O.transpose(),this.w=z.transpose(),this.q=D,this.u=u,this.s=S.transpose().mmul(S),this.xResidual=q,this.yResidual=J,this.betas=K}else this.w=z.transpose(),this.s=S.transpose().mmul(S).sqrt(),p?this.t=S.clone().div(this.s.get(0,0)):this.t=S,this.xResidual=t.sub(S.mmul(z.transpose()))}}var src$1=Object.freeze(Object.defineProperty({__proto__:null,AbstractMatrix,default:Matrix$2,Matrix:Matrix$2,wrap,WrapperMatrix1D,WrapperMatrix2D,solve,inverse,determinant,linearDependencies,pseudoInverse,covariance,correlation,SingularValueDecomposition,SVD:SingularValueDecomposition,EigenvalueDecomposition,EVD:EigenvalueDecomposition,CholeskyDecomposition,CHO:CholeskyDecomposition,LuDecomposition,LU:LuDecomposition,QrDecomposition,QR:QrDecomposition,Nipals:nipals,NIPALS:nipals,MatrixColumnView,MatrixColumnSelectionView,MatrixFlipColumnView,MatrixFlipRowView,MatrixRowView,MatrixRowSelectionView,MatrixSelectionView,MatrixSubView,MatrixTransposeView:MatrixTransposeView$1},Symbol.toStringTag,{value:"Module"}));function getSeparatedKernel(n){const t=new SingularValueDecomposition(n,{autoTranspose:!0});if(t.rank!==1)return null;const s=Math.sqrt(t.s[0]),l=t.U.to2DArray().map(g=>g[0]*s),p=t.V.to2DArray().map(g=>g[0]*s);return[l,p]}function convolution(n,t={}){let{channels:s,bitDepth:l,normalize:p=!1,divisor:g=1,border:w="copy",algorithm:u="auto"}=t,A={};l&&(A.bitDepth=l);let S=Image$1.createFrom(this,A);if(s=validateArrayOfChannels(this,s),u!=="separable")({kernel:n}=validateKernel(n));else if(!Array.isArray(n)||n.length!==2)throw new RangeError("separable convolution requires two arrays of numbers to represent the kernel");if(u==="auto"){let re=getSeparatedKernel(n);re!==null?(u="separable",n=re):(n.length>9||n[0].length>9)&&this.width<=4096&&this.height<=4096?u="fft":u="direct"}let D,z;u==="separable"?(D=Math.floor(n[0].length/2),z=Math.floor(n[1].length/2)):(D=Math.floor(n.length/2),z=Math.floor(n[0].length/2));let $=S.isClamped,O=new Array(this.height*this.width),q,K,J,Y,fe,ee;for(Y=0;Y<s.length;Y++){for(fe=s[Y],J=0;J<this.height;J++)for(K=0;K<this.width;K++)q=J*this.width+K,O[q]=this.data[q*this.channels+fe];if(u==="direct")ee=src$2.direct(O,n,{rows:this.height,cols:this.width,normalize:p,divisor:g});else if(u==="separable"){if(ee=convolutionSeparable(O,n,this.width,this.height),p){g=0;for(let re=0;re<n[0].length;re++)for(let he=0;he<n[1].length;he++)g+=n[0][re]*n[1][he]}if(g!==1)for(let re=0;re<ee.length;re++)ee[re]/=g}else ee=src$2.fft(O,n,{rows:this.height,cols:this.width,normalize:p,divisor:g});for(J=0;J<this.height;J++)for(K=0;K<this.width;K++)q=J*this.width+K,$?S.data[q*this.channels+fe]=clamp(ee[q],S):S.data[q*this.channels+fe]=ee[q]}if(this.alpha&&!s.includes(this.channels))for(K=this.components;K<this.data.length;K=K+this.channels)S.data[K]=this.data[K];return w!=="periodic"&&S.setBorder({size:[z,D],algorithm:w}),S}function gradientFilter(n={}){let{direction:t="xy",border:s="copy",kernelX:l,kernelY:p,channels:g,bitDepth:w=this.bitDepth}=n;switch(this.checkProcessable("gradientFilter",{bitDepth:[8,16]}),t){case"x":if(!l)throw new Error("kernelX option is missing");return convolution.call(this,l,{channels:g,border:s,bitDepth:w});case"y":if(!p)throw new Error("kernelY option is missing");return convolution.call(this,p,{channels:g,border:s,bitDepth:w});case"xy":{if(!l)throw new Error("kernelX option is missing");if(!p)throw new Error("kernelY option is missing");const u=convolution.call(this,l,{channels:g,border:s,bitDepth:32}),A=convolution.call(this,p,{channels:g,border:s,bitDepth:32});return u.hypotenuse(A,{bitDepth:w,channels:g})}default:throw new Error(`Unknown parameter direction: ${t}`)}}function sobelFilter(n){return gradientFilter.call(this,Object.assign({},n,{kernelX:SOBEL_X,kernelY:SOBEL_Y}))}function scharrFilter(n){return gradientFilter.call(this,Object.assign({},n,{kernelX:SCHARR_X,kernelY:SCHARR_Y}))}var newArray_1=newArray;function newArray(n,t){n=n||0;for(var s=new Array(n),l=0;l<n;l++)s[l]=t;return s}function level(n={}){let{algorithm:t="range",channels:s,min:l=this.min,max:p=this.max}=n;switch(this.checkProcessable("level",{bitDepth:[8,16,32]}),s=validateArrayOfChannels(this,{channels:s}),s.length!==this.channel&&(Array.isArray(l)&&l.length===this.channels&&(l=l.filter((g,w)=>s.includes(w))),Array.isArray(p)&&p.length===this.channels&&(p=p.filter((g,w)=>s.includes(w)))),t){case"range":l<0&&(l=0),p>this.maxValue&&(p=this.maxValue),Array.isArray(l)||(l=newArray_1(s.length,l)),Array.isArray(p)||(p=newArray_1(s.length,p)),processImage(this,l,p,s);break;default:throw new Error(`level: algorithm not implement: ${t}`)}return this}function processImage(n,t,s,l){let p=1e-5,g=new Array(l.length);for(let w=0;w<l.length;w++)t[w]===0&&s[w]===n.maxValue||s[w]===t[w]?g[w]=0:g[w]=(n.maxValue+1-p)/(s[w]-t[w]),t[w]+=(.5-p/2)/g[w];for(let w=0;w<l.length;w++){let u=l[w];if(g[w]!==0)for(let A=0;A<n.data.length;A+=n.channels)n.data[A+u]=Math.min(Math.max(0,(n.data[A+u]-t[w])*g[w]+.5|0),n.maxValue)}}var toString$1=Object.prototype.toString,isArrayType=function n(t){return toString$1.call(t).substr(-6,5)==="Array"};function checkNumberArray(n){if(isNaN(n)){if(n instanceof Image$1)return n.data;if(!isArrayType(n))throw new Error("checkNumberArray: the value should be either a number, array or Image");return n}else{if(n<=0)throw new Error("checkNumberArray: the value must be greater than 0");return n}}function add(n,t={}){let{channels:s}=t;if(this.checkProcessable("add",{bitDepth:[8,16]}),s=validateArrayOfChannels(this,{channels:s}),n=checkNumberArray(n),isNaN(n)){if(this.data.length!==n.length)throw new Error("add: the data size is different");for(let l=0;l<s.length;l++){let p=s[l];for(let g=0;g<this.data.length;g+=this.channels)this.data[g+p]=Math.max(0,Math.min(this.maxValue,this.data[g+p]+n[g+p]>>0))}}else for(let l=0;l<s.length;l++){let p=s[l];for(let g=0;g<this.data.length;g+=this.channels)this.data[g+p]=Math.min(this.maxValue,this.data[g+p]+n>>0)}return this}function subtract(n,t={}){let{channels:s}=t;if(this.checkProcessable("subtract",{bitDepth:[8,16]}),s=validateArrayOfChannels(this,{channels:s}),n=checkNumberArray(n),isNaN(n)){if(this.data.length!==n.length)throw new Error("subtract: the data size is different");for(let l=0;l<s.length;l++){let p=s[l];for(let g=0;g<this.data.length;g+=this.channels)this.data[g+p]=Math.max(0,Math.min(this.maxValue,this.data[g+p]-n[g+p]>>0))}}else for(let l=0;l<s.length;l++){let p=s[l];for(let g=0;g<this.data.length;g+=this.channels)this.data[g+p]=Math.max(0,this.data[g+p]-n>>0)}return this}function subtractImage(n,t={}){let{channels:s,absolute:l=!1}=t;if(this.checkProcessable("subtractImage",{bitDepth:[8,16]}),this.width!==n.width||this.height!==n.height)throw new Error("subtractImage: both images must have the same size");if(this.alpha!==n.alpha||this.bitDepth!==n.bitDepth)throw new Error("subtractImage: both images must have the same alpha and bitDepth");if(this.channels!==n.channels)throw new Error("subtractImage: both images must have the same number of channels");let p=this.clone();s=validateArrayOfChannels(this,{channels:s});for(let g=0;g<s.length;g++){let w=s[g];for(let u=w;u<this.data.length;u+=this.channels){let A=this.data[u]-n.data[u];l?p.data[u]=Math.abs(A):p.data[u]=Math.max(A,0)}}return p}function hypotenuse(n,t={}){let{bitDepth:s=this.bitDepth,channels:l}=t;if(this.checkProcessable("hypotenuse",{bitDepth:[8,16,32]}),this.width!==n.width||this.height!==n.height)throw new Error("hypotenuse: both images must have the same size");if(this.alpha!==n.alpha||this.bitDepth!==n.bitDepth)throw new Error("hypotenuse: both images must have the same alpha and bitDepth");if(this.channels!==n.channels)throw new Error("hypotenuse: both images must have the same number of channels");let p=Image$1.createFrom(this,{bitDepth:s});l=validateArrayOfChannels(this,{channels:l});let g=p.isClamped;for(let w=0;w<l.length;w++){let u=l[w];for(let A=u;A<this.data.length;A+=this.channels){let S=Math.hypot(this.data[A],n.data[A]);g?p.data[A]=Math.min(Math.max(Math.round(S),0),p.maxValue):p.data[A]=S}}return p}function multiply(n,t={}){let{channels:s}=t;if(this.checkProcessable("multiply",{bitDepth:[8,16]}),n<=0)throw new Error("multiply: the value must be greater than 0");if(s=validateArrayOfChannels(this,{channels:s}),n=checkNumberArray(n),isNaN(n)){if(this.data.length!==n.length)throw new Error("multiply: the data size is different");for(let l=0;l<s.length;l++){let p=s[l];for(let g=0;g<this.data.length;g+=this.channels)this.data[g+p]=Math.max(0,Math.min(this.maxValue,this.data[g+p]*n[g+p]>>0))}}else for(let l=0;l<s.length;l++){let p=s[l];for(let g=0;g<this.data.length;g+=this.channels)this.data[g+p]=Math.min(this.maxValue,this.data[g+p]*n>>0)}return this}function divide(n,t={}){let{channels:s}=t;if(this.checkProcessable("divide",{bitDepth:[8,16]}),s=validateArrayOfChannels(this,{channels:s}),n=checkNumberArray(n),isNaN(n)){if(this.data.length!==n.length)throw new Error("divide: the: the data size is different");for(let l=0;l<s.length;l++){let p=s[l];for(let g=0;g<this.data.length;g+=this.channels)this.data[g+p]=Math.max(0,Math.min(this.maxValue,this.data[g+p]/n[g+p]>>0))}}else for(let l=0;l<s.length;l++){let p=s[l];for(let g=0;g<this.data.length;g+=this.channels)this.data[g+p]=Math.min(this.maxValue,this.data[g+p]/n>>0)}return this}class BaseRegression{constructor(){if(new.target===BaseRegression)throw new Error("BaseRegression must be subclassed")}predict(t){if(typeof t=="number")return this._predict(t);if(isAnyArray(t)){const s=[];for(let l=0;l<t.length;l++)s.push(this._predict(t[l]));return s}else throw new TypeError("x must be a number or array")}_predict(){throw new Error("_predict must be implemented")}train(){}toString(){return""}toLaTeX(){return""}score(t,s){if(!isAnyArray(t)||!isAnyArray(s)||t.length!==s.length)throw new Error("x and y must be arrays of the same length");const l=t.length,p=new Array(l);for(let O=0;O<l;O++)p[O]=this._predict(t[O]);let g=0,w=0,u=0,A=0,S=0,D=0,z=0;for(let O=0;O<l;O++)g+=p[O],w+=s[O],S+=p[O]*p[O],D+=s[O]*s[O],z+=p[O]*s[O],s[O]!==0&&(u+=(s[O]-p[O])*(s[O]-p[O])/s[O]),A+=(s[O]-p[O])*(s[O]-p[O]);const $=(l*z-g*w)/Math.sqrt((l*S-g*g)*(l*D-w*w));return{r:$,r2:$*$,chi2:u,rmsd:Math.sqrt(A/l)}}}var require$$0$2=getAugmentedNamespace(src$1);function squaredEuclidean$4(n,t){let s=0;for(let l=0;l<n.length;l++)s+=(n[l]-t[l])*(n[l]-t[l]);return s}function euclidean$2(n,t){return Math.sqrt(squaredEuclidean$4(n,t))}var euclidean$3=Object.freeze(Object.defineProperty({__proto__:null,squaredEuclidean:squaredEuclidean$4,euclidean:euclidean$2},Symbol.toStringTag,{value:"Module"})),require$$0$1=getAugmentedNamespace(euclidean$3);const{squaredEuclidean:squaredEuclidean$3}=require$$0$1,defaultOptions$b={sigma:1};class GaussianKernel$1{constructor(t){t=Object.assign({},defaultOptions$b,t),this.sigma=t.sigma,this.divisor=2*t.sigma*t.sigma}compute(t,s){const l=squaredEuclidean$3(t,s);return Math.exp(-l/this.divisor)}}var gaussianKernel=GaussianKernel$1;const defaultOptions$a={degree:1,constant:1,scale:1};class PolynomialKernel$1{constructor(t){t=Object.assign({},defaultOptions$a,t),this.degree=t.degree,this.constant=t.constant,this.scale=t.scale}compute(t,s){for(var l=0,p=0;p<t.length;p++)l+=t[p]*s[p];return Math.pow(this.scale*l+this.constant,this.degree)}}var polynomialKernel=PolynomialKernel$1;const defaultOptions$9={alpha:.01,constant:-Math.E};class SigmoidKernel$1{constructor(t){t=Object.assign({},defaultOptions$9,t),this.alpha=t.alpha,this.constant=t.constant}compute(t,s){for(var l=0,p=0;p<t.length;p++)l+=t[p]*s[p];return Math.tanh(this.alpha*l+this.constant)}}var sigmoidKernel=SigmoidKernel$1;const defaultOptions$8={sigma:1,degree:1};class ANOVAKernel$1{constructor(t){t=Object.assign({},defaultOptions$8,t),this.sigma=t.sigma,this.degree=t.degree}compute(t,s){for(var l=0,p=Math.min(t.length,s.length),g=1;g<=p;++g)l+=Math.pow(Math.exp(-this.sigma*Math.pow(Math.pow(t[g-1],g)-Math.pow(s[g-1],g),2)),this.degree);return l}}var anovaKernel=ANOVAKernel$1;const{squaredEuclidean:squaredEuclidean$2}=require$$0$1,defaultOptions$7={sigma:1};class CauchyKernel$1{constructor(t){t=Object.assign({},defaultOptions$7,t),this.sigma=t.sigma}compute(t,s){return 1/(1+squaredEuclidean$2(t,s)/(this.sigma*this.sigma))}}var cauchyKernel=CauchyKernel$1;const{euclidean:euclidean$1}=require$$0$1,defaultOptions$6={sigma:1};class ExponentialKernel$1{constructor(t){t=Object.assign({},defaultOptions$6,t),this.sigma=t.sigma,this.divisor=2*t.sigma*t.sigma}compute(t,s){const l=euclidean$1(t,s);return Math.exp(-l/this.divisor)}}var exponentialKernel=ExponentialKernel$1;class HistogramIntersectionKernel{compute(t,s){for(var l=Math.min(t.length,s.length),p=0,g=0;g<l;++g)p+=Math.min(t[g],s[g]);return p}}var histogramIntersectionKernel=HistogramIntersectionKernel;const{euclidean}=require$$0$1,defaultOptions$5={sigma:1};class LaplacianKernel$1{constructor(t){t=Object.assign({},defaultOptions$5,t),this.sigma=t.sigma}compute(t,s){const l=euclidean(t,s);return Math.exp(-l/this.sigma)}}var laplacianKernel=LaplacianKernel$1;const{squaredEuclidean:squaredEuclidean$1}=require$$0$1,defaultOptions$4={constant:1};class MultiquadraticKernel$1{constructor(t){t=Object.assign({},defaultOptions$4,t),this.constant=t.constant}compute(t,s){return Math.sqrt(squaredEuclidean$1(t,s)+this.constant*this.constant)}}var multiquadraticKernel=MultiquadraticKernel$1;const{squaredEuclidean}=require$$0$1,defaultOptions$3={constant:1};class RationalQuadraticKernel{constructor(t){t=Object.assign({},defaultOptions$3,t),this.constant=t.constant}compute(t,s){const l=squaredEuclidean(t,s);return 1-l/(l+this.constant)}}var rationalQuadraticKernel=RationalQuadraticKernel;const{Matrix:Matrix$1,MatrixTransposeView}=require$$0$2,GaussianKernel=gaussianKernel,PolynomialKernel=polynomialKernel,SigmoidKernel=sigmoidKernel,ANOVAKernel=anovaKernel,CauchyKernel=cauchyKernel,ExponentialKernel=exponentialKernel,HistogramKernel=histogramIntersectionKernel,LaplacianKernel=laplacianKernel,MultiquadraticKernel=multiquadraticKernel,RationalKernel=rationalQuadraticKernel,kernelType={gaussian:GaussianKernel,rbf:GaussianKernel,polynomial:PolynomialKernel,poly:PolynomialKernel,anova:ANOVAKernel,cauchy:CauchyKernel,exponential:ExponentialKernel,histogram:HistogramKernel,min:HistogramKernel,laplacian:LaplacianKernel,multiquadratic:MultiquadraticKernel,rational:RationalKernel,sigmoid:SigmoidKernel,mlp:SigmoidKernel};class Kernel{constructor(t,s){if(this.kernelType=t,t!=="linear")if(typeof t=="string"){t=t.toLowerCase();var l=kernelType[t];if(l)this.kernelFunction=new l(s);else throw new Error(`unsupported kernel type: ${t}`)}else if(typeof t=="object"&&typeof t.compute=="function")this.kernelFunction=t;else throw new TypeError("first argument must be a valid kernel type or instance")}compute(t,s){if(t=Matrix$1.checkMatrix(t),s===void 0?s=t:s=Matrix$1.checkMatrix(s),this.kernelType==="linear")return t.mmul(new MatrixTransposeView(s));const l=new Matrix$1(t.rows,s.rows);if(t===s)for(let p=0;p<t.rows;p++)for(let g=p;g<t.rows;g++){const w=this.kernelFunction.compute(t.getRow(p),t.getRow(g));l.set(p,g,w),l.set(g,p,w)}else for(let p=0;p<t.rows;p++)for(let g=0;g<s.rows;g++)l.set(p,g,this.kernelFunction.compute(t.getRow(p),s.getRow(g)));return l}}var kernel=Kernel;const defaultOptions$2={lambda:.1,kernelType:"gaussian",kernelOptions:{},computeCoefficient:!1};class KernelRidgeRegression extends BaseRegression{constructor(t,s,l){if(super(),t===!0)this.alpha=s.alpha,this.inputs=s.inputs,this.kernelType=s.kernelType,this.kernelOptions=s.kernelOptions,this.kernel=new kernel(s.kernelType,s.kernelOptions);else{t=Matrix$2.checkMatrix(t),l=Object.assign({},defaultOptions$2,l);const p=new kernel(l.kernelType,l.kernelOptions),g=p.compute(t),w=t.rows;g.add(Matrix$2.eye(w,w).mul(l.lambda)),this.alpha=solve(g,s),this.inputs=t,this.kernelType=l.kernelType,this.kernelOptions=l.kernelOptions,this.kernel=p}}_predict(t){return this.kernel.compute([t],this.inputs).mmul(this.alpha).getRow(0)}toJSON(){return{name:"kernelRidgeRegression",alpha:this.alpha,inputs:this.inputs,kernelType:this.kernelType,kernelOptions:this.kernelOptions}}static load(t){if(t.name!=="kernelRidgeRegression")throw new TypeError("not a KRR model");return new KernelRidgeRegression(!0,t)}}function background$1(n,t,s){const l=new KernelRidgeRegression(n,t,s),p=new Array(this.size);for(let u=0;u<this.width;u++)for(let A=0;A<this.height;A++)p[A*this.width+u]=[u,A];const g=l.predict(p),w=Image$1.createFrom(this);for(let u=0;u<this.size;u++)w.data[u]=Math.min(this.maxValue,Math.max(0,g[u][0]));return w}function dilate(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("dilate",{bitDepth:[1,8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("dilate: The number of rows and columns of the kernel must be odd");let l=!0;e:for(const g of t)for(const w of g)if(w!==1){l=!1;break e}let p=this;for(let g=0;g<s;g++)if(this.bitDepth===1)if(l){const w=p.clone();p=dilateOnceBinaryOnlyOnes(p,w,t.length,t[0].length)}else{const w=Image$1.createFrom(p);p=dilateOnceBinary(p,w,t)}else if(l){const w=Image$1.createFrom(p);p=dilateOnceGreyOnlyOnes(p,w,t.length,t[0].length)}else{const w=Image$1.createFrom(p);p=dilateOnceGrey(p,w,t)}return p}function dilateOnceGrey(n,t,s){const l=s.length,p=s[0].length;let g=(l-1)/2,w=(p-1)/2;for(let u=0;u<n.height;u++)for(let A=0;A<n.width;A++){let S=0;for(let D=0;D<p;D++)for(let z=0;z<l;z++){if(s[z][D]!==1)continue;let $=z-g+A,O=D-w+u;if($<0||O<0||$>=n.width||O>=n.height)continue;const q=n.getValueXY($,O,0);q>S&&(S=q)}t.setValueXY(A,u,0,S)}return t}function dilateOnceGreyOnlyOnes(n,t,s,l){const p=(s-1)/2,g=(l-1)/2,w=[];for(let u=0;u<n.width;u++)w.push(0);for(let u=0;u<n.height;u++){for(let A=0;A<n.width;A++){let S=0;for(let D=Math.max(0,u-g);D<Math.min(n.height,u+g+1);D++){const z=n.getValueXY(A,D,0);z>S&&(S=z)}w[A]=S}for(let A=0;A<n.width;A++){let S=0;for(let D=Math.max(0,A-p);D<Math.min(n.width,A+p+1);D++)w[D]>S&&(S=w[D]);t.setValueXY(A,u,0,S)}}return t}function dilateOnceBinary(n,t,s){const l=s.length,p=s[0].length;let g=(l-1)/2,w=(p-1)/2;for(let u=0;u<n.height;u++)for(let A=0;A<n.width;A++){let S=0;e:for(let D=0;D<p;D++)for(let z=0;z<l;z++){if(s[z][D]!==1)continue;let $=z-g+A,O=D-w+u;if(O<0||$<0||$>=n.width||O>=n.height)continue;if(n.getBitXY($,O)===1){S=1;break e}}S===1&&t.setBitXY(A,u)}return t}function dilateOnceBinaryOnlyOnes(n,t,s,l){const p=(s-1)/2,g=(l-1)/2,w=[];for(let u=0;u<n.width;u++)w.push(1);for(let u=0;u<n.height;u++){for(let A=0;A<n.width;A++){w[A]=0;for(let S=Math.max(0,u-g);S<Math.min(n.height,u+g+1);S++)if(n.getBitXY(A,S)===1){w[A]=1;break}}for(let A=0;A<n.width;A++)if(t.getBitXY(A,u)!==1){for(let S=Math.max(0,A-p);S<Math.min(n.width,A+p+1);S++)if(w[S]===1){t.setBitXY(A,u);break}}}return t}function erode(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("erode",{bitDepth:[1,8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("erode: The number of rows and columns of the kernel must be odd");let l=!0;e:for(const g of t)for(const w of g)if(w!==1){l=!1;break e}let p=this;for(let g=0;g<s;g++)if(this.bitDepth===1)if(l){const w=p.clone();p=erodeOnceBinaryOnlyOnes(p,w,t.length,t[0].length)}else{const w=Image$1.createFrom(p);p=erodeOnceBinary(p,w,t)}else if(l){const w=Image$1.createFrom(p);p=erodeOnceGreyOnlyOnes(p,w,t.length,t[0].length)}else{const w=Image$1.createFrom(p);p=erodeOnceGrey(p,w,t)}return p}function erodeOnceGrey(n,t,s){const l=s.length,p=s[0].length;let g=(l-1)/2,w=(p-1)/2;for(let u=0;u<n.height;u++)for(let A=0;A<n.width;A++){let S=n.maxValue;for(let D=0;D<p;D++)for(let z=0;z<l;z++){if(s[z][D]!==1)continue;let $=z-g+A,O=D-w+u;if($<0||O<0||$>=n.width||O>=n.height)continue;const q=n.getValueXY($,O,0);q<S&&(S=q)}t.setValueXY(A,u,0,S)}return t}function erodeOnceGreyOnlyOnes(n,t,s,l){const p=(s-1)/2,g=(l-1)/2,w=[];for(let u=0;u<n.width;u++)w.push(0);for(let u=0;u<n.height;u++){for(let A=0;A<n.width;A++){let S=n.maxValue;for(let D=Math.max(0,u-g);D<Math.min(n.height,u+g+1);D++){const z=n.getValueXY(A,D,0);z<S&&(S=z)}w[A]=S}for(let A=0;A<n.width;A++){let S=n.maxValue;for(let D=Math.max(0,A-p);D<Math.min(n.width,A+p+1);D++)w[D]<S&&(S=w[D]);t.setValueXY(A,u,0,S)}}return t}function erodeOnceBinary(n,t,s){const l=s.length,p=s[0].length;let g=(l-1)/2,w=(p-1)/2;for(let u=0;u<n.height;u++)for(let A=0;A<n.width;A++){let S=1;e:for(let D=0;D<p;D++)for(let z=0;z<l;z++){if(s[z][D]!==1)continue;let $=z-g+A,O=D-w+u;if(O<0||$<0||$>=n.width||O>=n.height)continue;if(n.getBitXY($,O)===0){S=0;break e}}S===1&&t.setBitXY(A,u)}return t}function erodeOnceBinaryOnlyOnes(n,t,s,l){const p=(s-1)/2,g=(l-1)/2,w=[];for(let u=0;u<n.width;u++)w.push(0);for(let u=0;u<n.height;u++){for(let A=0;A<n.width;A++){w[A]=1;for(let S=Math.max(0,u-g);S<Math.min(n.height,u+g+1);S++)if(n.getBitXY(A,S)===0){w[A]=0;break}}for(let A=0;A<n.width;A++)if(t.getBitXY(A,u)!==0){for(let S=Math.max(0,A-p);S<Math.min(n.width,A+p+1);S++)if(w[S]===0){t.clearBitXY(A,u);break}}}return t}function open(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("open",{bitDepth:[8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("open: The number of rows and columns of the kernel must be odd");let l=this;for(let p=0;p<s;p++)l=l.erode({kernel:t}),l=l.dilate({kernel:t});return l}function close(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("close",{bitDepth:[1,8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("close: The number of rows and columns of the kernel must be odd");let l=this;for(let p=0;p<s;p++)l=l.dilate({kernel:t}).erode({kernel:t});return l}function topHat(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("topHat",{bitDepth:[8,16],components:1,alpha:0}),t.length%2===0||t[0].length%2===0)throw new TypeError("topHat: The number of rows and columns of the kernel must be odd");let l=this;for(let p=0;p<s;p++)l=l.open({kernel:t}).subtractImage(l,{absolute:!0});return l}function blackHat(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("blackHat",{bitDepth:[8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("blackHat: The number of rows and columns of the kernel must be odd");let l=this;for(let p=0;p<s;p++)l=l.close({kernel:t}).subtractImage(l,{absolute:!0});return l}function morphologicalGradient(n={}){let{kernel:t=[[1,1,1],[1,1,1],[1,1,1]],iterations:s=1}=n;if(this.checkProcessable("morphologicalGradient",{bitDepth:[8,16],components:1,alpha:0}),t.columns%2===0||t.rows%2===0)throw new TypeError("morphologicalGradient: The number of rows and columns of the kernel must be odd");let l=this;for(let p=0;p<s;p++){let g=l.dilate({kernel:t}),w=l.erode({kernel:t});l=g.subtractImage(w,{absolute:!0})}return l}function order4Points(n){let t=0,s=0,l=0,p=0,g=n[0][0],w=0;for(let S=1;S<n.length;S++)n[S][0]<g&&(g=n[S][0],w=S);let u=n[(w+1)%n.length][0],A=(w+1)%n.length;for(let S=1;S<n.length;S++)n[S][0]<u&&S!==w&&(u=n[S][0],A=S);return n[A][1]<n[w][1]?(t=n[A],p=n[w],w!==(A+1)%4?(s=n[(A+1)%4],l=n[(A+2)%4]):(s=n[(A+2)%4],l=n[(A+3)%4])):(p=n[A],t=n[w],A!==(w+1)%4?(s=n[(w+1)%4],l=n[(w+2)%4]):(s=n[(w+2)%4],l=n[(w+3)%4])),[t,s,l,p]}function distance2Points(n,t){return Math.sqrt(Math.pow(n[0]-t[0],2)+Math.pow(n[1]-t[1],2))}function crossVect(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function dotVect(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function computeWidthAndHeigth(n,t,s,l,p,g){let w=Math.max(distance2Points(n,t),distance2Points(l,s)),u=Math.max(distance2Points(n,l),distance2Points(t,s)),A=0,S=0,D=Math.ceil(p/2),z=Math.ceil(g/2),$=w/u,O=[n[0],n[1],1],q=[t[0],t[1],1],K=[l[0],l[1],1],J=[s[0],s[1],1],Y=dotVect(crossVect(O,J),K)/dotVect(crossVect(q,J),K),fe=dotVect(crossVect(O,J),q)/dotVect(crossVect(K,J),q),ee=[Y*q[0]-O[0],Y*q[1]-O[1],Y*q[2]-O[2]],re=[fe*K[0]-O[0],fe*K[1]-O[1],fe*K[2]-O[2]],he=ee[0],_e=ee[1],we=ee[2],oe=re[0],be=re[1],ie=re[2],ue=1/(we*ie)*(he*oe-(he*ie+we*oe)*D+we*ie*D*D+(_e*be-(_e*ie+we*be)*z+we*ie*z*z));ue>=0?ue=Math.sqrt(ue):ue=Math.sqrt(-ue);let Ce=new Matrix$2([[ue,0,D],[0,ue,z],[0,0,1]]),Ne=Ce.transpose(),it=inverse(Ne),rt=inverse(Ce),Pt=Matrix$2.rowVector(ee),zt=Matrix$2.rowVector(re),vt=Math.sqrt(dotVect(Pt.mmul(it).mmul(rt).to1DArray(),ee)/dotVect(zt.mmul(it).mmul(rt).to1DArray(),re));return vt===0||$===0?(A=Math.ceil(w),S=Math.ceil(u)):vt<$?(A=Math.ceil(w),S=Math.ceil(A/vt)):(S=Math.ceil(u),A=Math.ceil(vt*S)),[A,S]}function projectionPoint(n,t,s,l,p,g,w,u,A,S,D,z){let[$,O]=[(s*n+l*t+p)/(A*n+S*t+1),(g*n+w*t+u)/(A*n+S*t+1)];return D.getValueXY(Math.floor($),Math.floor(O),z)}function warpingFourPoints(n,t={}){let{calculateRatio:s=!0}=t;if(n.length!==4)throw new Error(`The array pts must have four elements, which are the four corners. Currently, pts have ${n.length} elements`);let[l,p,g,w]=n,u=[l,p,g,w],[A,S,D,z]=order4Points(u),$,O;s?[$,O]=computeWidthAndHeigth(A,S,D,z,this.width,this.height):($=Math.ceil(Math.max(distance2Points(A,S),distance2Points(z,D))),O=Math.ceil(Math.max(distance2Points(A,z),distance2Points(S,D))));let q=Image$1.createFrom(this,{width:$,height:O}),[K,J]=A,[Y,fe]=S,[ee,re]=D,[he,_e]=z,[we,oe]=[0,0],[be,ie]=[0,$-1],[ue,Ce]=[O-1,$-1],[Ne,it]=[O-1,0],rt=new Matrix$2([[we,oe,1,0,0,0,-we*K,-oe*K],[be,ie,1,0,0,0,-be*Y,-ie*Y],[ue,Ce,1,0,0,0,-ue*ee,-oe*ee],[Ne,it,1,0,0,0,-Ne*he,-it*he],[0,0,0,we,oe,1,-we*J,-oe*J],[0,0,0,be,ie,1,-be*fe,-ie*fe],[0,0,0,ue,Ce,1,-ue*re,-Ce*re],[0,0,0,Ne,it,1,-Ne*_e,-it*_e]]),Pt=Matrix$2.columnVector([K,Y,ee,he,J,fe,re,_e]),vt=new SingularValueDecomposition(rt).solve(Pt),[Vt,kt,Yt,Qt,ot,gt,pt,Bt]=vt.to1DArray(),Zt=new Matrix$2(O,$);for(let si=0;si<this.channels;si++){for(let ii=0;ii<O;ii++)for(let pi=0;pi<$;pi++)Zt.set(ii,pi,projectionPoint(ii,pi,Vt,kt,Yt,Qt,ot,gt,pt,Bt,this,si));q.setMatrix(Zt,{channel:si})}return q}function crop(n={}){let{x:t=0,y:s=0,width:l=this.width-t,height:p=this.height-s}=n;if(this.checkProcessable("max",{bitDepth:[8,16]}),t=Math.round(t),s=Math.round(s),l=Math.round(l),p=Math.round(p),t>this.width-1||s>this.height-1)throw new RangeError(`crop: origin (x:${t}, y:${s}) out of range (${this.width-1}; ${this.height-1})`);if(l<=0||p<=0)throw new RangeError(`crop: width and height (width:${l}; height:${p}) must be positive numbers`);if(t<0||s<0)throw new RangeError(`crop: x and y (x:${t}, y:${s}) must be positive numbers`);if(l>this.width-t||p>this.height-s)throw new RangeError(`crop: (x: ${t}, y:${s}, width:${l}, height:${p}) size is out of range`);let g=Image$1.createFrom(this,{width:l,height:p,position:[t,s]}),w=l*this.channels,u=s+p,A=0,S=t*this.channels;for(let D=s;D<u;D++){let z=D*this.width*this.channels+S,$=z+w;for(;z<$;z++)g.data[A++]=this.data[z]}return g}function cropAlpha(n={}){this.checkProcessable("cropAlpha",{alpha:1});const{threshold:t=this.maxValue}=n;let s=findLeft(this,t,this.components);if(s===-1)throw new Error("Could not find new dimensions. Threshold may be too high.");let l=findTop(this,t,this.components,s),p=findBottom(this,t,this.components,s),g=findRight(this,t,this.components,s,l,p);return this.crop({x:s,y:l,width:g-s+1,height:p-l+1})}function findLeft(n,t,s){for(let l=0;l<n.width;l++)for(let p=0;p<n.height;p++)if(n.getValueXY(l,p,s)>=t)return l;return-1}function findTop(n,t,s,l){for(let p=0;p<n.height;p++)for(let g=l;g<n.width;g++)if(n.getValueXY(g,p,s)>=t)return p;return-1}function findBottom(n,t,s,l){for(let p=n.height-1;p>=0;p--)for(let g=l;g<n.width;g++)if(n.getValueXY(g,p,s)>=t)return p;return-1}function findRight(n,t,s,l,p,g){for(let w=n.width-1;w>=l;w--)for(let u=p;u<=g;u++)if(n.getValueXY(w,u,s)>=t)return w;return-1}function getFactor(n){if(typeof n=="string"){const t=n[n.length-1];n=parseFloat(n),t==="%"&&(n/=100)}return n}function getThreshold$1(n,t){if(!t)throw Error("getThreshold : the maxValue should be specified");if(typeof n=="string"){if(n[n.length-1]!=="%")throw Error("getThreshold : if the value is a string it must finish by %");return parseFloat(n)/100*t}else{if(typeof n=="number")return n<1?n*t:n;throw Error("getThreshold : the value is not valid")}}function factorDimensions(n,t,s){n=getFactor(n);let l=Math.round(n*t),p=Math.round(n*s);return l<=0&&(l=1),p<=0&&(p=1),{width:l,height:p}}function checkRow(n,t){if(t<0||t>=n.height)throw new RangeError(`row must be included between 0 and ${n.height-1}. Current value: ${t}`)}function checkColumn(n,t){if(t<0||t>=n.width)throw new RangeError(`column must be included between 0 and ${n.width-1}. Current value: ${t}`)}function checkChannel(n,t){if(t<0||t>=n.channels)throw new RangeError(`channel must be included between 0 and ${n.channels-1}. Current value: ${t}`)}const validInterpolations={nearestneighbor:"nearestNeighbor",nearestneighbour:"nearestNeighbor",bilinear:"bilinear"};function checkInterpolation(n){if(typeof n!="string")throw new TypeError("interpolation must be a string");if(n=n.toLowerCase(),!validInterpolations[n])throw new RangeError(`invalid interpolation algorithm: ${n}`);return validInterpolations[n]}function nearestNeighbor(n,t,s){const l=this.width/t,p=this.height/s;if(this.bitDepth>1)for(let g=0;g<t;g++){const w=Math.floor((g+.5)*l);for(let u=0;u<s;u++){const A=Math.floor((u+.5)*p);for(let S=0;S<this.channels;S++)n.setValueXY(g,u,S,this.getValueXY(w,A,S))}}else for(let g=0;g<t;g++){const w=Math.floor((g+.5)*l);for(let u=0;u<s;u++){const A=Math.floor((u+.5)*p);this.getBitXY(w,A)&&n.setBitXY(g,u)}}}function resize(n={}){const{factor:t=1,interpolation:s=validInterpolations.nearestneighbor,preserveAspectRatio:l=!0}=n,p=checkInterpolation(s);let g=n.width,w=n.height;if(g||(w&&l?g=Math.round(w*(this.width/this.height)):g=this.width),w||(l?w=Math.round(g*(this.height/this.width)):w=this.height),{width:g,height:w}=factorDimensions(t,g,w),g===this.width&&w===this.height){const D=this.clone();return D.position=[0,0],D}let u=Math.round((this.width-g)/2),A=Math.round((this.height-w)/2);const S=Image$1.createFrom(this,{width:g,height:w,position:[u,A]});switch(p){case validInterpolations.nearestneighbor:nearestNeighbor.call(this,S,g,w);break;default:throw new Error(`unsupported resize interpolation: ${p}`)}return S}function hsv(){this.checkProcessable("hsv",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let n=Image$1.createFrom(this,{colorModel:HSV}),t=0,s=this.data;for(let l=0;l<s.length;l+=this.channels){let p=s[l],g=s[l+1],w=s[l+2],u=Math.min(p,g,w),A=Math.max(p,g,w),S=A-u,D=0,z=A===0?0:S/A,$=A;if(A!==u){switch(A){case p:D=(g-w)/S+(g<w?6:0);break;case g:D=(w-p)/S+2;break;case w:D=(p-g)/S+4;break;default:throw new Error("unreachable")}D/=6}n.data[t++]=D*this.maxValue,n.data[t++]=z*this.maxValue,n.data[t++]=$,this.alpha&&(n.data[t++]=s[l+3])}return n}function hsl$1(){this.checkProcessable("hsl",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let n=Image$1.createFrom(this,{colorModel:HSL}),t=Math.floor(this.maxValue/2),s=0,l=this.data;for(let p=0;p<l.length;p+=this.channels){let g=l[p],w=l[p+1],u=l[p+2],A=Math.max(g,w,u),S=Math.min(g,w,u),D=0,z=0,$=(A+S)/2;if(A!==S){let O=A-S;switch(z=$>t?O/(2-A-S):O/(A+S),A){case g:D=(w-u)/O+(w<u?6:0);break;case w:D=(u-g)/O+2;break;case u:D=(g-w)/O+4;break;default:throw new Error("unreachable")}D/=6}n.data[s++]=D*this.maxValue,n.data[s++]=z*this.maxValue,n.data[s++]=$,this.alpha&&(n.data[s++]=l[p+3])}return n}function cmyk(){this.checkProcessable("cmyk",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let n=Image$1.createFrom(this,{components:4,colorModel:CMYK$1}),t=0,s=this.data;for(let l=0;l<s.length;l+=this.channels){let p=s[l],g=s[l+1],w=s[l+2],u=Math.min(this.maxValue-p,this.maxValue-g,this.maxValue-w),A=(this.maxValue-p-u)/(1-u/this.maxValue),S=(this.maxValue-g-u)/(1-u/this.maxValue),D=(this.maxValue-w-u)/(1-u/this.maxValue);n.data[t++]=Math.round(A),n.data[t++]=Math.round(S),n.data[t++]=Math.round(D),n.data[t++]=Math.round(u),this.alpha&&(n.data[t++]=s[l+3])}return n}function rgba8(){return new Image$1(this.width,this.height,this.getRGBAData(),{kind:"RGBA",parent:this})}const methods$1={luma709(n,t,s){return n*6966+t*23436+s*2366>>15},luma601(n,t,s){return n*9798+t*19235+s*3735>>15},maximum(n,t,s){return Math.max(n,t,s)},minimum(n,t,s){return Math.min(n,t,s)},average(n,t,s){return(n+t+s)/3>>0},minmax(n,t,s){return(Math.max(n,t,s)+Math.min(n,t,s))/2},red(n){return n},green(n,t){return t},blue(n,t,s){return s},cyan(n,t,s,l){let p=methods$1.black(n,t,s,l);return(l.maxValue-n-p)/(1-p/l.maxValue)>>0},magenta(n,t,s,l){let p=methods$1.black(n,t,s,l);return(l.maxValue-t-p)/(1-p/l.maxValue)>>0},yellow(n,t,s,l){let p=methods$1.black(n,t,s,l);return(l.maxValue-s-p)/(1-p/l.maxValue)>>0},black(n,t,s,l){return Math.min(l.maxValue-n,l.maxValue-t,l.maxValue-s)},hue(n,t,s,l){let p=methods$1.min(n,t,s),g=methods$1.max(n,t,s);if(g===p)return 0;let w=0,u=g-p;switch(g){case n:w=(t-s)/u+(t<s?6:0);break;case t:w=(s-n)/u+2;break;case s:w=(n-t)/u+4;break;default:throw new Error("unreachable")}return w/6*l.maxValue>>0},saturation(n,t,s,l){let p=methods$1.min(n,t,s),g=methods$1.max(n,t,s),w=g-p;return g===0?0:w/g*l.maxValue},lightness(n,t,s){let l=methods$1.min(n,t,s);return(methods$1.max(n,t,s)+l)/2}};Object.defineProperty(methods$1,"luminosity",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"luminance",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"min",{enumerable:!1,value:methods$1.minimum});Object.defineProperty(methods$1,"max",{enumerable:!1,value:methods$1.maximum});Object.defineProperty(methods$1,"brightness",{enumerable:!1,value:methods$1.maximum});Object.keys(methods$1).forEach(n=>{});function grey(n={}){let{algorithm:t="luma709",keepAlpha:s=!1,mergeAlpha:l=!0}=n;if(typeof t!="string"&&typeof t!="function")throw new TypeError("algorithm must be a string or a function");this.checkProcessable("grey",{bitDepth:[8,16],alpha:[0,1]}),this.components===1&&(t="red"),s&=this.alpha,l&=this.alpha,s&&(l=!1);let p=getOutputImage(this,n,{components:1,alpha:s,colorModel:GREY$1}),g;if(typeof t=="function")g=t;else if(g=methods$1[t.toLowerCase()],!g)throw new Error(`unsupported grey algorithm: ${t}`);let w=0;for(let u=0;u<this.data.length;u+=this.channels)l?p.data[w++]=clamp(g(this.data[u],this.data[u+1],this.data[u+2],this)*this.data[u+this.components]/this.maxValue,this):(p.data[w++]=clamp(g(this.data[u],this.data[u+1],this.data[u+2],this),this),p.alpha&&(p.data[w++]=this.data[u+this.components]));return p}function huang(n){let t=0;for(let D=0;D<n.length;D++)if(n[D]!==0){t=D;break}let s=n.length-1;for(let D=n.length-1;D>=t;D--)if(n[D]!==0){s=D;break}let l=1/(s-t),p=new Array(n.length),g=0,w=0;for(let D=t;D<n.length;D++)g+=D*n[D],w+=n[D],p[D]=g/w;let u=new Array(n.length);g=w=0;for(let D=s;D>0;D--)g+=D*n[D],w+=n[D],u[D-1]=g/w;let A=-1,S=Number.MAX_VALUE;for(let D=0;D<n.length;D++){let z=0,$;for(let O=0;O<=D;O++)$=1/(1+l*Math.abs(O-p[D])),$<1e-6||$>.999999||(z+=n[O]*(-$*Math.log($)-(1-$)*Math.log(1-$)));for(let O=D+1;O<n.length;O++)$=1/(1+l*Math.abs(O-u[D])),$<1e-6||$>.999999||(z+=n[O]*(-$*Math.log($)-(1-$)*Math.log(1-$)));z<S&&(S=z,A=D)}return A}function intermodes(n){let t=n.slice(),s=0;for(;!bimodalTest$1(t);){let p=0,g=0,w=t[0];for(let u=0;u<n.length-1;u++)p=g,g=w,w=t[u+1],t[u]=(p+g+w)/3;if(t[n.length-1]=(g+w)/3,s++,s>1e4)throw new Error("Intermodes Threshold not found after 10000 iterations")}let l=0;for(let p=1;p<n.length-1;p++)t[p-1]<t[p]&&t[p+1]<t[p]&&(l+=p);return Math.floor(l/2)}function bimodalTest$1(n){let t=!1,s=0;for(let l=1;l<n.length-1;l++)if(n[l-1]<n[l]&&n[l+1]<n[l]&&(s++,s>2))return!1;return s===2&&(t=!0),t}function isodata(n){let t,s,l,p,g=0;for(let w=1;w<n.length;w++)if(n[w]>0){g=w+1;break}for(;;){t=0,l=0;for(let w=0;w<g;w++)l=l+n[w],t=t+n[w]*w;p=0,s=0;for(let w=g+1;w<n.length;w++)s+=n[w],p+=n[w]*w;if(l>0&&s>0&&(t/=l,p/=s,g===Math.round((t+p)/2)))break;if(g++,g>n.length-2)throw new Error("Threshold not found")}return g}function li(n,t){let s,l,p,g,w,u,A,S,D,z,$,O;$=.5,z=0;for(let q=0;q<n.length;q++)z+=q*n[q];z/=t,A=z;do{u=A,s=u+.5|0,l=0,g=0;for(let q=0;q<=s;q++)l+=q*n[q],g+=n[q];S=g===0?0:l/g,p=0,w=0;for(let q=s+1;q<n.length;q++)p+=q*n[q],w+=n[q];D=w===0?0:p/w,O=(S-D)/(Math.log(S)-Math.log(D)),O<-Number.EPSILON?A=O-.5|0:A=O+.5|0}while(Math.abs(A-u)>$);return s}function maxEntropy(n,t){let s=new Array(n.length);for(let $=0;$<n.length;$++)s[$]=n[$]/t;let l=new Array(n.length),p=new Array(n.length);l[0]=s[0],p[0]=1-l[0];for(let $=1;$<n.length;$++)l[$]=l[$-1]+s[$],p[$]=1-l[$];let g=0;for(let $=0;$<n.length;$++)if(Math.abs(l[$])>=Number.EPSILON){g=$;break}let w=n.length-1;for(let $=n.length-1;$>=g;$--)if(Math.abs(p[$])>=Number.EPSILON){w=$;break}let u=-1,A,S=Number.MIN_VALUE,D,z;for(let $=g;$<=w;$++){D=0;for(let O=0;O<=$;O++)n[O]!==0&&(D-=s[O]/l[$]*Math.log(s[O]/l[$]));z=0;for(let O=$+1;O<n.length;O++)n[O]!==0&&(z-=s[O]/p[$]*Math.log(s[O]/p[$]));A=D+z,S<A&&(S=A,u=$)}return u}function mean$1(n,t){let s=0;for(let l=0;l<n.length;l++)s+=l*n[l];return Math.floor(s/t)}function minError(n,t){let s,l=-2,p,g,w,u,A,S,D,z,$,O,q,K=0;for(let J=0;J<n.length;J++)K+=J*n[J];for(K/=t,s=K;s!==l;){let J=sumA(n,s),Y=sumA(n,n.length-1),fe=sumB(n,s),ee=sumB(n,n.length-1),re=sumC(n,s),he=sumC(n,n.length-1);if(p=fe/J,g=(ee-fe)/(Y-J),w=J/Y,u=(Y-J)/Y,A=re/J-p*p,S=(he-re)/(Y-J)-g*g,D=1/A-1/S,z=p/A-g/S,$=p*p/A-g*g/S+Math.log10(A*(u*u)/(S*(w*w))),O=z*z-D*$,O<0)return s;l=s,q=(z+Math.sqrt(O))/D,isNaN(q)?s=l:s=Math.floor(q)}return s}function sumA(n,t){let s=0;for(let l=0;l<=t;l++)s+=n[l];return s}function sumB(n,t){let s=0;for(let l=0;l<=t;l++)s+=l*n[l];return s}function sumC(n,t){let s=0;for(let l=0;l<=t;l++)s+=l*l*n[l];return s}function minimum(n){if(n.length<2)return 0;let t=0,s=-1,l=-1,p=new Array(n.length);for(let g=0;g<n.length;g++)p[g]=n[g],n[g]>0&&(l=g);for(;!bimodalTest(p);)if(p=smoothed(p),t++,t>1e4)return s;return s=minimumBetweenPeeks(p,l),s}function smoothed(n){let t=new Array(n.length);for(let s=1;s<n.length-1;s++)t[s]=(n[s-1]+n[s]+n[s+1])/3;return t[0]=(n[0]+n[1])/3,t[n.length-1]=(n[n.length-2]+n[n.length-1])/3,t}function minimumBetweenPeeks(n,t){let s;for(let l=1;l<t;l++)if(n[l-1]>n[l]&&n[l+1]>=n[l]){s=l;break}return s}function bimodalTest(n){let t=n.length,s=!1,l=0;for(let p=1;p<t-1;p++)if(n[p-1]<n[p]&&n[p+1]<n[p]&&(l++,l>2))return!1;return l===2&&(s=!0),s}function moments(n,t){let s=1,l=0,p=0,g=0,w=0,u,A,S,D,z,$,O=-1,q=n.length,K=new Array(q);for(let J=0;J<q;J++)K[J]=n[J]/t;for(let J=0;J<q;J++)l+=J*K[J],p+=J*J*K[J],g+=J*J*J*K[J];A=s*p-l*l,S=(-p*p+l*g)/A,D=(s*-g+p*l)/A,z=.5*(-D-Math.sqrt(D*D-4*S)),$=.5*(-D+Math.sqrt(D*D-4*S)),u=($-l)/($-z);for(let J=0;J<q;J++)if(w+=K[J],w>u){O=J;break}return O}function otsu(n,t){let s=0,l=0,p=0,g=0,w=0;for(let u=0;u<n.length;u++)w+=u*n[u];for(let u=0;u<n.length;u++){l=l+n[u];const A=t-l;if(l===0||A===0)continue;s=s+u*n[u];const S=(w-s)/A,D=l*A*(s/l-S)*(s/l-S);D>=p&&(g=u,p=D)}return g}function percentile(n){let t=-1,s=.5,l=new Array(n.length),p=partialSum(n,n.length-1),g=1;for(let w=0;w<n.length;w++)l[w]=Math.abs(partialSum(n,w)/p-s),l[w]<g&&(g=l[w],t=w);return t}function partialSum(n,t){let s=0;for(let l=0;l<=t;l++)s+=n[l];return s}function renyiEntropy(n,t){let s,l,p,g=new Array(n.length),w=new Array(n.length),u=new Array(n.length),A=0,S=0,D=0,z=0,$=0,O=0,K=1/(1-.5),Y=1/(1-2);for(let he=0;he<n.length;he++)g[he]=n[he]/t;w[0]=g[0],u[0]=1-w[0];for(let he=1;he<n.length;he++)w[he]=w[he-1]+g[he],u[he]=1-w[he];l=0;for(let he=0;he<n.length;he++)if(Math.abs(w[he])>=Number.EPSILON){l=he;break}p=n.length-1;for(let he=n.length-1;he>=l;he--)if(Math.abs(u[he])>=Number.EPSILON){p=he;break}for(let he=l;he<=p;he++){let _e=0,we=0,oe=0;for(let rt=0;rt<=he;rt++)n[rt]!==0&&(_e-=g[rt]/w[he]*Math.log(g[rt]/w[he])),we+=Math.sqrt(g[rt]/w[he]),oe+=g[rt]*g[rt]/(w[he]*w[he]);let be=0,ie=0,ue=0;for(let rt=he+1;rt<n.length;rt++)n[rt]!==0&&(be-=g[rt]/u[he]*Math.log(g[rt]/u[he])),ie+=Math.sqrt(g[rt]/u[he]),ue+=g[rt]*g[rt]/(u[he]*u[he]);let Ce=_e+be,Ne=K*(we*ie>0?Math.log(we*ie):0),it=Y*(oe*ue>0?Math.log(oe*ue):0);Ce>z&&(z=Ce,A=he),Ne>$&&($=Ne,S=he),it>O&&(O=it,D=he)}let fe=[A,S,D];fe.sort((he,_e)=>he-_e);let ee;Math.abs(fe[0]-fe[1])<=5?Math.abs(fe[1]-fe[2])<=5?ee=[1,2,1]:ee=[0,1,3]:Math.abs(fe[1]-fe[2])<=5?ee=[3,1,0]:ee=[1,2,1];let re=w[fe[2]]-w[fe[0]];return s=Math.round(fe[0]*(w[fe[0]]+.25*re*ee[0])+.25*fe[1]*re*ee[1]+fe[2]*(u[fe[2]]+.25*re*ee[2])),s}function shanbhag(n,t){let s=new Array(n.length);for(let O=0;O<n.length;O++)s[O]=n[O]/t;let l=new Array(n.length),p=new Array(n.length);l[0]=s[0],p[0]=1-l[0];for(let O=1;O<n.length;O++)l[O]=l[O-1]+s[O],p[O]=1-l[O];let g=0;for(let O=0;O<n.length;O++)if(Math.abs(l[O])>=Number.EPSILON){g=O;break}let w=n.length-1;for(let O=n.length-1;O>=g;O--)if(Math.abs(p[O])>=Number.EPSILON){w=O;break}let u=-1,A=Number.MAX_VALUE,S,D,z,$;for(let O=g;O<=w;O++){z=0,S=.5/l[O];for(let q=1;q<=O;q++)z-=s[q]*Math.log(1-S*l[q-1]);z*=S,$=0,S=.5/p[O];for(let q=O+1;q<n.length;q++)$-=s[q]*Math.log(1-S*p[q]);$*=S,D=Math.abs(z-$),D<A&&(A=D,u=O)}return u}function triangle$1(n){let t=0,s=0,l=0,p=0;for(let z=0;z<n.length;z++)if(n[z]>0){t=z;break}t>0&&t--;for(let z=n.length-1;z>0;z--)if(n[z]>0){p=z;break}p<n.length-1&&p++;for(let z=0;z<n.length;z++)n[z]>s&&(l=z,s=n[z]);let g=!1;if(l-t<p-l){g=!0;let z=0,$=n.length-1;for(;z<$;){let O=n[z];n[z]=n[$],n[$]=O,z++,$--}t=n.length-1-p,l=n.length-1-l}if(t===l)return t;let w,u,A;w=n[l],u=t-l,A=Math.sqrt(w*w+u*u),w/=A,u/=A,A=w*t+u*n[t];let S=t,D=0;for(let z=t+1;z<=l;z++){let $=w*z+u*n[z]-A;$>D&&(S=z,D=$)}if(S--,g){let z=0,$=n.length-1;for(;z<$;){let O=n[z];n[z]=n[$],n[$]=O,z++,$--}return n.length-1-S}else return S}function yen(n,t){let s=new Array(n.length);for(let S=0;S<n.length;S++)s[S]=n[S]/t;let l=new Array(n.length);l[0]=s[0];for(let S=1;S<n.length;S++)l[S]=l[S-1]+s[S];let p=new Array(n.length);p[0]=s[0]*s[0];for(let S=1;S<n.length;S++)p[S]=p[S-1]+s[S]*s[S];let g=new Array(n.length);g[n.length-1]=0;for(let S=n.length-2;S>=0;S--)g[S]=g[S+1]+s[S+1]*s[S+1];let w=-1,u=Number.MIN_VALUE,A;for(let S=0;S<n.length;S++)A=-1*(p[S]*g[S]>0?Math.log(p[S]*g[S]):0)+2*(l[S]*(1-l[S])>0?Math.log(l[S]*(1-l[S])):0),A>u&&(u=A,w=S);return w}const methods={huang,intermodes,isodata,li,maxentropy:maxEntropy,mean:mean$1,minerror:minError,minimum,moments,otsu,percentile,renyientropy:renyiEntropy,shanbhag,triangle:triangle$1,yen},names={};Object.keys(methods).forEach(n=>{names[n]=n});function getThreshold(n={}){let{algorithm:t=names.otsu}=n;this.checkProcessable("getThreshold",{components:1,bitDepth:[8,16]});let s=methods[t.toLowerCase()];if(s){let l=this.getHistogram();return s(l,this.size)}else throw new Error(`unknown thresholding algorithm: ${t}`)}const THRESHOLD="threshold";function mask(n={}){let{algorithm:t=THRESHOLD,threshold:s=.5,useAlpha:l=!0,invert:p=!1}=n;this.checkProcessable("mask",{components:1,bitDepth:[8,16]}),t===THRESHOLD?s=getThreshold$1(s,this.maxValue):s=getThreshold.call(this,n);let g=new Image$1(this.width,this.height,{kind:"BINARY",parent:this}),w=0;if(this.alpha&&l)for(let u=0;u<this.data.length;u+=this.channels){let A=this.data[u]+(this.maxValue-this.data[u])*(this.maxValue-this.data[u+1])/this.maxValue;(p&&A<=s||!p&&A>=s)&&g.setBit(w),w++}else for(let u=0;u<this.data.length;u+=this.channels)(p&&this.data[u]<=s||!p&&this.data[u]>=s)&&g.setBit(w),w++;return g}function copyImage(n,t,s,l){let p=n.width,g=n.height,w=t.width,u=n.channels;for(let A=0;A<p;A++)for(let S=0;S<g;S++)for(let D=0;D<u;D++){let z=(S*p+A)*u+D,$=((l+S)*w+s+A)*u+D;t.data[$]=n.data[z]}}function pad(n={}){let{size:t=0,algorithm:s="copy",color:l}=n;if(this.checkProcessable("pad",{bitDepth:[8,16]}),s==="set"){if(l.length!==this.channels)throw new Error(`pad: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let A=0;A<l.length;A++)l[A]===0&&(l[A]=.001)}else l=newArray_1(this.channels,null);Array.isArray(t)||(t=[t,t]);let p=this.width+t[0]*2,g=this.height+t[1]*2,w=this.channels,u=Image$1.createFrom(this,{width:p,height:g});copyImage(this,u,t[0],t[1]);for(let A=t[0];A<p-t[0];A++)for(let S=0;S<w;S++){let D=l[S]||u.data[(t[1]*p+A)*w+S];for(let z=0;z<t[1];z++)u.data[(z*p+A)*w+S]=D;D=l[S]||u.data[((g-t[1]-1)*p+A)*w+S];for(let z=g-t[1];z<g;z++)u.data[(z*p+A)*w+S]=D}for(let A=0;A<g;A++)for(let S=0;S<w;S++){let D=l[S]||u.data[(A*p+t[0])*w+S];for(let z=0;z<t[0];z++)u.data[(A*p+z)*w+S]=D;D=l[S]||u.data[(A*p+p-t[0]-1)*w+S];for(let z=p-t[0];z<p;z++)u.data[(A*p+z)*w+S]=D}return u}function colorDepth(n=8){if(this.checkProcessable("colorDepth",{bitDepth:[1,8,16]}),![8,16].includes(n))throw Error("You need to specify the new colorDepth as 8 or 16");if(this.bitDepth===n)return this.clone();let t=Image$1.createFrom(this,{bitDepth:n});switch(n){case 8:if(this.bitDepth===1)for(let s=0;s<this.size;s++)this.getBit(s)&&(t.data[s]=255);else for(let s=0;s<this.data.length;s++)t.data[s]=this.data[s]>>8;break;case 16:if(this.bitDepth===1)for(let s=0;s<this.size;s++)this.getBit(s)&&(t.data[s]=65535);else for(let s=0;s<this.data.length;s++)t.data[s]=this.data[s]<<8|this.data[s];break;default:throw new Error("colorDepth conversion unexpected case")}return t}function rotateFree(n,t={}){const{interpolation:s=validInterpolations.nearestneighbor,width:l=this.width,height:p=this.height}=t;if(typeof n!="number")throw new TypeError("degrees must be a number");const g=checkInterpolation(s),w=n*Math.PI/180,u=Math.floor(Math.abs(l*Math.cos(w))+Math.abs(p*Math.sin(w))),A=Math.floor(Math.abs(p*Math.cos(w))+Math.abs(l*Math.sin(w))),S=Image$1.createFrom(this,{width:u,height:A}),D=Math.cos(-w),z=Math.sin(-w);let $=u/2,O=A/2;u%2===0?($=$-.5,A%2===0?O=O-.5:O=Math.floor(O)):($=Math.floor($),A%2===0?O=O-.5:O=Math.floor(O));const q=Math.floor(l/2-$),K=Math.floor(p/2-O);switch(g){case validInterpolations.nearestneighbor:return rotateNearestNeighbor(this,S,q,K,$,O,D,z);case validInterpolations.bilinear:return rotateBilinear(this,S,q,K,$,O,D,z);default:throw new Error(`unsupported rotate interpolation: ${g}`)}}function rotateNearestNeighbor(n,t,s,l,p,g,w,u){for(let A=0;A<t.width;A+=1)for(let S=0;S<t.height;S+=1)for(let D=0;D<n.channels;D++){let z=Math.round((A-p)*w-(S-g)*u+p)+s,$=Math.round((S-g)*w+(A-p)*u+g)+l;z<0||z>=n.width||$<0||$>=n.height?n.alpha===1&&D===n.channels-1?t.setValueXY(A,S,D,0):t.setValueXY(A,S,D,n.maxValue):t.setValueXY(A,S,D,n.getValueXY(z,$,D))}return t}function rotateBilinear(n,t,s,l,p,g,w,u){let A=n.width*n.channels;for(let S=0;S<t.height;S++)for(let D=0;D<t.width;D++){let z=(D-p)*w-(S-g)*u+p+s,$=(S-g)*w+(D-p)*u+g+l,O=z|0,q=$|0,K=z-O,J=$-q;for(let Y=0;Y<n.channels;Y++)if(z<0||z>=n.width||$<0||$>=n.height)n.alpha===1&&Y===n.channels-1?t.setValueXY(D,S,Y,0):t.setValueXY(D,S,Y,n.maxValue);else{let fe=(q*n.width+O)*n.channels+Y,ee=n.data[fe],re=n.data[fe+n.channels],he=n.data[fe+A],_e=n.data[fe+A+n.channels],we=ee+K*(re-ee)+J*(he-ee)+K*J*(ee-re-he+_e)|0;t.setValueXY(D,S,Y,we)}}return t}function rotate$1(n,t){if(typeof n!="number")throw new TypeError("angle must be a number");switch(n<0&&(n=Math.ceil(-n/360)*360+n),n%360){case 0:return this.clone();case 90:return rotateRight.call(this);case 180:return rotate180.call(this);case 270:return rotateLeft.call(this);default:return rotateFree.call(this,n,t)}}function rotateLeft(){const n=Image$1.createFrom(this,{width:this.height,height:this.width}),t=n.height-1;for(let s=0;s<this.height;s++)for(let l=0;l<this.width;l++)for(let p=0;p<this.channels;p++)n.setValueXY(s,t-l,p,this.getValueXY(l,s,p));return n}function rotateRight(){const n=Image$1.createFrom(this,{width:this.height,height:this.width}),t=n.width-1;for(let s=0;s<this.height;s++)for(let l=0;l<this.width;l++)for(let p=0;p<this.channels;p++)n.setValueXY(t-s,l,p,this.getValueXY(l,s,p));return n}function rotate180(){const n=Image$1.createFrom(this),t=n.width-1,s=n.height-1;for(let l=0;l<this.height;l++)for(let p=0;p<this.width;p++)for(let g=0;g<this.channels;g++)n.setValueXY(t-p,s-l,g,this.getValueXY(p,l,g));return n}function insert(n,t={}){const s=getImageParameters(n);this.checkProcessable("insert",s);let{x:l=0,y:p=0}=t;const g=getOutputImageOrInPlace(this,t,{copy:!0}),w=Math.min(g.height,p+n.height),u=Math.min(g.width,l+n.width);if(g.bitDepth===1)for(let A=p;A<w;A++)for(let S=l;S<u;S++)n.getBitXY(S-l,A-p)?g.setBitXY(S,A):g.clearBitXY(S,A);else for(let A=p;A<w;A++)for(let S=l;S<u;S++)g.setPixelXY(S,A,n.getPixelXY(S-l,A-p));return g}function setBorder(n={}){let{size:t=0,algorithm:s="copy",color:l}=n;if(this.checkProcessable("setBorder",{bitDepth:[8,16,32,64]}),s==="set"){if(l.length!==this.channels)throw new Error(`setBorder: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let u=0;u<l.length;u++)l[u]===0&&(l[u]=.001)}else l=newArray_1(this.channels,null);Array.isArray(t)||(t=[t,t]);let p=t[0],g=t[1],w=this.channels;for(let u=p;u<this.width-p;u++)for(let A=0;A<w;A++){let S=l[A]||this.data[(u+this.width*g)*w+A];for(let D=0;D<g;D++)this.data[(D*this.width+u)*w+A]=S;S=l[A]||this.data[(u+this.width*(this.height-g-1))*w+A];for(let D=this.height-g;D<this.height;D++)this.data[(D*this.width+u)*w+A]=S}for(let u=0;u<this.height;u++)for(let A=0;A<w;A++){let S=l[A]||this.data[(u*this.width+p)*w+A];for(let D=0;D<p;D++)this.data[(u*this.width+D)*w+A]=S;S=l[A]||this.data[(u*this.width+this.width-p-1)*w+A];for(let D=this.width-p;D<this.width;D++)this.data[(u*this.width+D)*w+A]=S}return this}function split(n={}){let{preserveAlpha:t=!0}=n;if(this.checkProcessable("split",{bitDepth:[8,16]}),this.components===1)return new Stack([this.clone()]);let s=new Stack,l=this.data;if(this.alpha&&t)for(let p=0;p<this.components;p++){let g=Image$1.createFrom(this,{components:1,alpha:!0,colorModel:GREY$1}),w=0;for(let u=0;u<l.length;u+=this.channels)g.data[w++]=l[u+p],g.data[w++]=l[u+this.components];s.push(g)}else for(let p=0;p<this.channels;p++){let g=Image$1.createFrom(this,{components:1,alpha:!1,colorModel:GREY$1}),w=0;for(let u=0;u<l.length;u+=this.channels)g.data[w++]=l[u+p];s.push(g)}return s}function getChannel(n,t={}){let{keepAlpha:s=!1,mergeAlpha:l=!1}=t;s&=this.alpha,l&=this.alpha,this.checkProcessable("getChannel",{bitDepth:[8,16]}),n=validateChannel(this,n);let p=Image$1.createFrom(this,{components:1,alpha:s,colorModel:GREY$1}),g=0;for(let w=0;w<this.data.length;w+=this.channels)l?p.data[g++]=this.data[w+n]*this.data[w+this.components]/this.maxValue:(p.data[g++]=this.data[w+n],s&&(p.data[g++]=this.data[w+this.components]));return p}function combineChannels(n=defaultCombineMethod,t={}){let{mergeAlpha:s=!1,keepAlpha:l=!1}=t;s&=this.alpha,l&=this.alpha,this.checkProcessable("combineChannels",{bitDepth:[8,16]});let p=Image$1.createFrom(this,{components:1,alpha:l,colorModel:GREY$1}),g=0;for(let w=0;w<this.size;w++){let u=n(this.getPixel(w));s?p.data[g++]=u*this.data[w*this.channels+this.components]/this.maxValue:(p.data[g++]=u,l&&(p.data[g++]=this.data[w*this.channels+this.components]))}return p}function defaultCombineMethod(n){return(n[0]+n[1]+n[2])/3}function setChannel(n,t){if(this.checkProcessable("setChannel",{bitDepth:[8,16]}),t.checkProcessable("setChannel (image parameter check)",{bitDepth:[this.bitDepth],alpha:[0],components:[1]}),t.width!==this.width||t.height!==this.height)throw new Error("Images must have exactly the same width and height");n=validateChannel(this,n);let s=n;for(let l=0;l<t.data.length;l++)this.data[s]=t.data[l],s+=this.channels;return this}function getSimilarity(n,t={}){let{shift:s=[0,0],average:l,channels:p,defaultAlpha:g,normalize:w,border:u=[0,0]}=t;if(this.checkProcessable("getSimilarity",{bitDepth:[8,16]}),Array.isArray(u)||(u=[u,u]),p=validateArrayOfChannels(this,{channels:p,defaultAlpha:g}),this.bitDepth!==n.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==n.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==n.colorModel)throw new Error("Both images must have the same colorModel");typeof l=="undefined"&&(l=!0);let A=Math.max(u[0],-s[0]),S=Math.min(this.width-u[0],this.width-s[0]),D=Math.max(u[1],-s[1]),z=Math.min(this.height-u[1],this.height-s[1]),$=newArray_1(p.length,0);for(let O=0;O<p.length;O++){let q=p[O],K=w?this.sum[q]:Math.max(this.sum[q],n.sum[q]),J=w?n.sum[q]:Math.max(this.sum[q],n.sum[q]);if(K!==0&&J!==0)for(let Y=A;Y<S;Y++)for(let fe=D;fe<z;fe++){let ee=Y*this.multiplierX+fe*this.multiplierY+q,re=ee+s[0]*this.multiplierX+s[1]*this.multiplierY;$[O]+=Math.min(this.data[ee]/K,n.data[re]/J)}}return l?$.reduce((O,q)=>O+q)/$.length:$}function getPixelsGrid(n={}){let{sampling:t=[10,10],painted:s=!1,mask:l}=n;this.checkProcessable("getPixelsGrid",{bitDepth:[8,16],channels:1}),Array.isArray(t)||(t=[t,t]);const p=t[0],g=t[1],w=[],u=[],A=this.width/p,S=this.height/g;let D=Math.floor(A/2);for(let $=0;$<p;$++){let O=Math.floor(S/2);for(let q=0;q<g;q++){let K=Math.round(D),J=Math.round(O);(!l||l.getBitXY(K,J))&&(w.push([K,J]),u.push(this.getPixelXY(K,J))),O+=S}D+=A}const z={xyS:w,zS:u};return s&&(z.painted=this.rgba8().paintPoints(w)),z}function Matrix(n,t,s){const l=new Array(n);for(let p=0;p<n;p++)l[p]=new Array(t);if(s)for(let p=0;p<n;p++)for(let g=0;g<t;g++)l[p][g]=s;return l.width=n,l.height=t,Object.setPrototypeOf(l,Matrix.prototype),l}Matrix.prototype.localMin=function(n,t){let s=this[n][t],l=[n,t];for(let p=Math.max(0,n-1);p<Math.min(this.length,n+2);p++)for(let g=Math.max(0,t-1);g<Math.min(this[0].length,t+2);g++)this[p][g]<s&&(s=this[p][g],l=[p,g]);return{position:l,value:s}};Matrix.prototype.localMax=function(n,t){let s=this[n][t],l=[n,t];for(let p=Math.max(0,n-1);p<Math.min(this.length,n+2);p++)for(let g=Math.max(0,t-1);g<Math.min(this[0].length,t+2);g++)this[p][g]>s&&(s=this[p][g],l=[p,g]);return{position:l,value:s}};Matrix.prototype.localSearch=function(n,t,s){let l=[];for(let p=Math.max(0,n-1);p<Math.min(this.length,n+2);p++)for(let g=Math.max(0,t-1);g<Math.min(this[0].length,t+2);g++)this[p][g]===s&&l.push([p,g]);return l};function getBestMatch(n,t={}){let{border:s}=t;if(this.checkProcessable("getChannel",{bitDepth:[8,16]}),this.bitDepth!==n.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==n.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==n.colorModel)throw new Error("Both images must have the same colorModel");let l=new Matrix(n.width,n.height,-1/0),p=Math.floor(n.width/2),g=Math.floor(n.height/2),w=p,u=g,A=!1;for(;!A;){let S=l.localSearch(p,g,-1/0);for(let z=0;z<S.length;z++){let $=S[z],O=this.getSimilarity(n,{border:s,shift:[w-$[0],u-$[1]]});l[$[0]][$[1]]=O}let D=l.localMax(p,g);D.position[0]!==p||D.position[1]!==g?(p=D.position[0],g=D.position[1]):A=!0}return[p-w,g-u]}function getRow(n,t=0){this.checkProcessable("getRow",{bitDepth:[8,16]}),checkRow(this,n),checkChannel(this,t);let s=new Array(this.width),l=0,p=n*this.width*this.channels+t,g=p+this.width*this.channels;for(let w=p;w<g;w+=this.channels)s[l++]=this.data[w];return s}function getColumn(n,t=0){this.checkProcessable("getColumn",{bitDepth:[8,16]}),checkColumn(this,n),checkChannel(this,t);let s=new Array(this.height),l=0,p=this.width*this.channels;for(let g=t+n*this.channels;g<this.data.length;g+=p)s[l++]=this.data[g];return s}function getMatrix(n={}){let{channel:t}=n;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),t===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");t=0}let s=new Matrix$2(this.height,this.width);for(let l=0;l<this.height;l++)for(let p=0;p<this.width;p++)s.set(l,p,this.getValueXY(p,l,t));return s}function setMatrix(n,t={}){n=new Matrix$2(n);let{channel:s}=t;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),s===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");s=0}if(this.width!==n.columns||this.height!==n.rows)throw new RangeError("The size of the matrix must be equal to the size of the image");for(let l=0;l<this.height;l++)for(let p=0;p<this.width;p++)this.setValueXY(p,l,s,n.get(l,p))}function getPixelsArray(){this.checkProcessable("getPixelsArray",{bitDepth:[8,16,32]});let n=new Array(this.size),t=0;for(let s=0;s<this.data.length;s+=this.channels){let l=new Array(this.components);for(let p=0;p<this.components;p++)l[p]=this.data[s+p];n[t++]=l}return n}function getIntersection(n){let t=this,s=t.getClosestCommonParent(n),l=t.getRelativePosition(s,{defaultFurther:!0}),p=getRelativePositionForAllPixels(t,l),g=n.getRelativePosition(s,{defaultFurther:!0}),w=getRelativePositionForAllPixels(n,g),u=getCommonSurface(p,w),A={whitePixelsMask1:[],whitePixelsMask2:[],commonWhitePixels:[]};for(let S=0;S<u.length;S++){let D=u[S],z=[D[0]-l[0],D[1]-l[1]],$=[D[0]-g[0],D[1]-g[1]],O=t.getBitXY(z[0],z[1]),q=n.getBitXY($[0],$[1]);O===1&&q===1&&A.commonWhitePixels.push(D)}for(let S=0;S<p.length;S++){let D,z;S!==0&&(D=Math.floor(S/t.width),z=S%t.width),t.getBitXY(D,z)===1&&A.whitePixelsMask1.push(p[S])}for(let S=0;S<w.length;S++){let D=0,z=0;S!==0&&(D=Math.floor(S/n.width),z=S%n.width),n.getBitXY(D,z)===1&&A.whitePixelsMask2.push(w[S])}return A}function getRelativePositionForAllPixels(n,t){let s=[];for(let l=0;l<n.height;l++)for(let p=0;p<n.width;p++){let g=[l,p];s.push([g[0]+t[0],g[1]+t[1]])}return s}function getCommonSurface(n,t){let s=0,l=0,p=[];for(;s<n.length&&l<t.length;)n[s][0]===t[l][0]&&n[s][1]===t[l][1]?(p.push(n[s]),s++,l++):n[s][0]<t[l][0]||n[s][0]===t[l][0]&&n[s][1]<t[l][1]?s++:l++;return p}function getClosestCommonParent(n){let t=getDepth(this),s=getDepth(n),l;if(t>=s?l=getFurthestParent(this,t):l=getFurthestParent(n,s),t===0||s===0)return l;let p=this,g=n;for(;t!==s;)if(t>s){if(p=p.parent,p===null)return l;t=t-1}else{if(g=g.parent,g===null)return l;s=s-1}for(;p!==g&&p!==null&&g!==null;)if(p=p.parent,g=g.parent,p===null||g===null)return l;return p!==g?l:p}function getDepth(n){let t=0,s=n;for(;s.parent!=null;)s=s.parent,t++;return t}function getFurthestParent(n,t){let s=n;for(;t>0;)s=s.parent,t=t-1;return s}const defaultOptions$1={lowThreshold:10,highThreshold:30,gaussianBlur:1.1},Gx=[[-1,0,1],[-2,0,2],[-1,0,1]],Gy=[[-1,-2,-1],[0,0,0],[1,2,1]],convOptions={bitDepth:32,mode:"periodic"};function cannyEdgeDetector(n,t){n.checkProcessable("Canny edge detector",{bitDepth:8,channels:1,components:1}),t=Object.assign({},defaultOptions$1,t);const s=n.width,l=n.height,p=n.maxValue,g={sigma:t.gaussianBlur,radius:3},w=n.gaussianFilter(g),u=w.convolution(Gy,convOptions),A=w.convolution(Gx,convOptions),S=A.hypotenuse(u),D=n.constructor,z=new D(s,l,{kind:"GREY",bitDepth:32}),$=new D(s,l,{kind:"GREY",bitDepth:32}),O=new D(s,l,{kind:"GREY"});for(var q=1;q<s-1;q++)for(var K=1;K<l-1;K++){var J=(Math.round(Math.atan2(A.getValueXY(q,K,0),u.getValueXY(q,K,0))*(5/Math.PI))+5)%5;J===0&&(S.getValueXY(q,K,0)<=S.getValueXY(q,K-1,0)||S.getValueXY(q,K,0)<=S.getValueXY(q,K+1,0))||J===1&&(S.getValueXY(q,K,0)<=S.getValueXY(q-1,K+1,0)||S.getValueXY(q,K,0)<=S.getValueXY(q+1,K-1,0))||J===2&&(S.getValueXY(q,K,0)<=S.getValueXY(q-1,K,0)||S.getValueXY(q,K,0)<=S.getValueXY(q+1,K,0))||J===3&&(S.getValueXY(q,K,0)<=S.getValueXY(q-1,K-1,0)||S.getValueXY(q,K,0)<=S.getValueXY(q+1,K+1,0))||z.setValueXY(q,K,0,S.getValueXY(q,K,0))}for(q=0;q<s*l;++q){var Y=z.data[q],fe=0;Y>t.highThreshold&&(fe++,O.data[q]=p),Y>t.lowThreshold&&fe++,$.data[q]=fe}var ee=[];for(q=1;q<s-1;++q)for(K=1;K<l-1;++K){if($.getValueXY(q,K,0)!==1)continue;e:for(var re=q-1;re<q+2;++re)for(var he=K-1;he<K+2;++he)if($.getValueXY(re,he,0)===2){ee.push([q,K]),O.setValueXY(q,K,0,p);break e}}for(;ee.length>0;){var _e=[];for(q=0;q<ee.length;++q)for(K=-1;K<2;++K)for(re=-1;re<2;++re)if(!(K===0&&re===0)){var we=ee[q][0]+K,oe=ee[q][1]+re;$.getValueXY(we,oe,0)===1&&O.getValueXY(we,oe,0)===0&&(_e.push([we,oe]),O.setValueXY(we,oe,0,p))}ee=_e}return O}function cannyEdge(n){return cannyEdgeDetector(this,n)}function extract(n,t={}){let{position:s}=t;if(this.checkProcessable("extract",{bitDepth:[1,8,16]}),!s&&(s=n.getRelativePosition(this),!s))throw new Error("extract : can not extract an image because the relative position can not be determined, try to specify manually the position as an array of 2 elements [x,y].");if(this.bitDepth>1){let l=Image$1.createFrom(this,{width:n.width,height:n.height,alpha:1,position:s,parent:this});for(let p=0;p<n.width;p++)for(let g=0;g<n.height;g++){for(let w=0;w<this.channels;w++){let u=this.getValueXY(p+s[0],g+s[1],w);l.setValueXY(p,g,w,u)}n.getBitXY(p,g)||l.setValueXY(p,g,this.components,0)}return l}else{let l=Image$1.createFrom(this,{width:n.width,height:n.height,position:s,parent:this});for(let p=0;p<n.height;p++)for(let g=0;g<n.width;g++)n.getBitXY(g,p)&&this.getBitXY(g+s[0],p+s[1])&&l.setBitXY(g,p);return l}}var fastList={exports:{}};(function(n,t){(function(){function s(p,g,w){this.next=w,w&&(w.prev=this),this.prev=g,g&&(g.next=this),this.data=p}function l(){if(!(this instanceof l))return new l;this._head=null,this._tail=null,this.length=0}l.prototype={push:function(p){this._tail=new s(p,this._tail,null),this._head||(this._head=this._tail),this.length++},pop:function(){if(this.length!==0){var p=this._tail;return this._tail=p.prev,p.prev&&(p.prev=this._tail.next=null),this.length--,this.length===1?this._head=this._tail:this.length===0&&(this._head=this._tail=null),p.data}},unshift:function(p){this._head=new s(p,null,this._head),this._tail||(this._tail=this._head),this.length++},shift:function(){if(this.length!==0){var p=this._head;return this._head=p.next,p.next&&(p.next=this._head.prev=null),this.length--,this.length===1?this._tail=this._head:this.length===0&&(this._head=this._tail=null),p.data}},item:function(p){p<0&&(p=this.length+p);for(var g=this._head;p-- >0&&g;)g=g.next;return g?g.data:void 0},slice:function(p,g){if(p||(p=0),g||(g=this.length),g<0&&(g=this.length+g),p<0&&(p=this.length+p),g===p)return[];if(g<p)throw new Error("invalid offset: "+p+","+g+" (length="+this.length+")");for(var w=g-p,u=new Array(w),A=0,S=this._head;p-- >0&&S;)S=S.next;for(;A<w&&S;)u[A++]=S.data,S=S.next;return u},drop:function(){l.call(this)},forEach:function(p,g){for(var w=this._head,u=0,A=this.length;u<A&&w;)p.call(g||this,w.data,u,this),w=w.next,u++},map:function(p,g){var w=new l;return this.forEach(function(u,A,S){w.push(p.call(g||S,u,A,S))}),w},filter:function(p,g){var w=new l;return this.forEach(function(u,A,S){p.call(g||S,u,A,S)&&w.push(u)}),w},reduce:function(p,g,w){var u=0,A=this._head,S=this.length;for(g||(u=1,g=A&&A.data,A=A&&A.next);u<S&&A;)g=p.call(w||this,g,A.data,this),u++,A=A.next;return g}},n.exports=l})()})(fastList);var LinkedList=fastList.exports;function floodFill(n={}){const{x:t=0,y:s=0,inPlace:l=!0}=n,p=l?this:Image$1.createFrom(this);if(this.checkProcessable("floodFill",{bitDepth:1}),this.getBitXY(t,s))return p;const w=new LinkedList;for(w.push(new Node(t,s));w.length>0;){const u=w.shift();p.setBitXY(u.x,u.y);for(let A=u.x+1;A<this.width&&(!p.getBitXY(A,u.y)&&!this.getBitXY(A,u.y));A++)p.setBitXY(A,u.y),u.y+1<this.height&&!this.getBitXY(A,u.y+1)&&w.push(new Node(A,u.y+1)),u.y-1>=0&&!this.getBitXY(A,u.y-1)&&w.push(new Node(A,u.y-1));for(let A=u.x-1;A>=0&&(!p.getBitXY(A,u.y)&&!this.getBitXY(A,u.y));A++)p.setBitXY(A,u.y),u.y+1<this.height&&!this.getBitXY(A,u.y+1)&&w.push(new Node(A,u.y+1)),u.y-1>=0&&!this.getBitXY(A,u.y-1)&&w.push(new Node(A,u.y-1))}return p}function Node(n,t){this.x=n,this.y=t}function _extends(){return _extends=Object.assign?Object.assign.bind():function(n){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var l in s)Object.prototype.hasOwnProperty.call(s,l)&&(n[l]=s[l])}return n},_extends.apply(this,arguments)}function hsv2rgb(n,t,s){t=t/100,s=s/100;var l=[],p=s*t,g=n/60,w=p*(1-Math.abs(g%2-1)),u=s-p;return g>=0&&g<1?l=[p,w,0]:g>=1&&g<2?l=[w,p,0]:g>=2&&g<3?l=[0,p,w]:n>=3&&g<4?l=[0,w,p]:n>=4&&g<5?l=[w,0,p]:n>=5&&g<=6?l=[p,0,w]:l=[0,0,0],{r:Math.round(255*(l[0]+u)),g:Math.round(255*(l[1]+u)),b:Math.round(255*(l[2]+u))}}function hsl2hsv(n,t,s){return t*=(s<50?s:100-s)/100,{h:n,s:2*t/(s+t)*100,v:s+t}}function hsl2rgb$1(n,t,s){var l=hsl2hsv(n,t,s);return hsv2rgb(l.h,l.s,l.v)}var colors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]};function parse(n){return named(n)||hex3(n)||hex6(n)||rgb(n)||rgba$1(n)||hsl(n)||hsla(n)}function named(n){var t=colors[n.toLowerCase()];if(!!t)return{r:t[0],g:t[1],b:t[2],a:100}}function rgb(n){var t=n.match(/rgb\(([^)]+)\)/);if(t){var s=t[1].split(/ *, */).map(Number);return{r:s[0],g:s[1],b:s[2],a:100}}}function rgba$1(n){var t=n.match(/rgba\(([^)]+)\)/);if(t){var s=t[1].split(/ *, */).map(Number);return{r:s[0],g:s[1],b:s[2],a:s[3]*100}}}function hex6(n){if(n[0]==="#"&&n.length===7)return{r:parseInt(n.slice(1,3),16),g:parseInt(n.slice(3,5),16),b:parseInt(n.slice(5,7),16),a:100}}function hex3(n){if(n[0]==="#"&&n.length===4)return{r:parseInt(n[1]+n[1],16),g:parseInt(n[2]+n[2],16),b:parseInt(n[3]+n[3],16),a:100}}function hsl(n){var t=n.match(/hsl\(([^)]+)\)/);if(t){var s=t[1].split(/ *, */),l=parseInt(s[0],10),p=parseInt(s[1],10),g=parseInt(s[2],10),w=hsl2rgb$1(l,p,g);return _extends({},w,{a:100})}}function hsla(n){var t=n.match(/hsla\(([^)]+)\)/);if(t){var s=t[1].split(/ *, */),l=parseInt(s[0],10),p=parseInt(s[1],10),g=parseInt(s[2],10),w=parseInt(parseFloat(s[3])*100,10),u=hsl2rgb$1(l,p,g);return _extends({},u,{a:w})}}function css2array(n){let t=parse(n);return[t.r,t.g,t.b,Math.round(t.a*255/100)]}function hue2rgb(n,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?n+(t-n)*6*s:s<1/2?t:s<2/3?n+(t-n)*(2/3-s)*6:n}function hsl2rgb(n,t,s){let l,p,g,w,u,A;return t/=100,s/=100,t===0?w=u=A=s*255:(s<=.5?p=s*(t+1):p=s+t-s*t,l=s*2-p,g=n/360,w=hue2rgb(l,p,g+1/3),u=hue2rgb(l,p,g),A=hue2rgb(l,p,g-1/3)),{r:w,g:u,b:A}}function getDistinctColors(n){let t=new Array(n),s=0;for(let l=0;l<360;l+=360/n){s++;let p=hsl2rgb(l,100,30+s%4*15);t[s-1]=[Math.round(p.r*255),Math.round(p.g*255),Math.round(p.b*255)]}return t}function getRandomColor(){return[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)]}function getColors(n){let{color:t,colors:s,randomColors:l,numberColors:p=50}=n;if(t&&!Array.isArray(t)&&(t=css2array(t)),t)return[t];if(s)return s=s.map(function(g){return Array.isArray(g)?g:css2array(g)}),s;if(l){s=new Array(p);for(let g=0;g<p;g++)s[g]=getRandomColor()}return getDistinctColors(p)}function paintLabels(n,t,s={}){let{color:l="blue",colors:p,font:g="12px Helvetica",rotate:w=0}=s;if(this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1}),!Array.isArray(n))throw Error("paintLabels: labels must be an array");if(!Array.isArray(t))throw Error("paintLabels: positions must be an array");if(l&&!Array.isArray(l)&&(l=css2array(l)),p?p=p.map(function(S){return Array.isArray(S)?S:css2array(S)}):p=[l],n.length!==t.length)throw Error("paintLabels: positions and labels must be arrays from the same size");Array.isArray(g)||(g=[g]),Array.isArray(w)||(w=[w]);let A=this.getCanvas().getContext("2d");for(let S=0;S<n.length;S++){A.save();let D=p[S%p.length];A.fillStyle=`rgba(${D[0]},${D[1]},${D[2]},${D[3]/this.maxValue})`,A.font=g[S%g.length];let z=t[S];A.translate(z[0],z[1]),A.rotate(w[S%w.length]/180*Math.PI),A.fillText(n[S],0,0),A.restore()}return this.data=Uint8Array.from(A.getImageData(0,0,this.width,this.height).data),this}function paintMasks(n,t={}){let{alpha:s=255,labels:l=[],labelsPosition:p=[],labelColor:g="blue",labelFont:w="12px Helvetica"}=t;this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1});let u=getColors(Object.assign({},t,{numberColors:n.length}));Array.isArray(n)||(n=[n]);for(let A=0;A<n.length;A++){let S=n[A],D=u[A%u.length];for(let z=0;z<S.width;z++)for(let $=0;$<S.height;$++)if(S.getBitXY(z,$))for(let O=0;O<Math.min(this.components,D.length);O++)if(s===255)this.setValueXY(z+S.position[0],$+S.position[1],O,D[O]);else{let q=this.getValueXY(z+S.position[0],$+S.position[1],O);q=Math.round((q*(255-s)+D[O]*s)/255),this.setValueXY(z+S.position[0],$+S.position[1],O,q)}}if(Array.isArray(l)&&l.length>0){let S=this.getCanvas().getContext("2d");S.fillStyle=g,S.font=w;for(let D=0;D<Math.min(n.length,l.length);D++){let z=p[D]?p[D]:n[D].position;S.fillText(l[D],z[0],z[1])}this.data=Uint8Array.from(S.getImageData(0,0,this.width,this.height).data)}return this}function zerosMatrix(n,t){let s=new Array(n);for(let l=0;l<n;l++)s[l]=new Array(t).fill(0);return s}const cross=[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],smallCross=[[0,1,0],[1,1,1],[0,1,0]];class Shape{constructor(t={}){let{kind:s="cross",shape:l,size:p,width:g,height:w,filled:u=!0}=t;if(p&&(g=p,w=p),l)switch(l.toLowerCase()){case"square":case"rectangle":this.matrix=rectangle(g,w,{filled:u});break;case"circle":case"ellipse":this.matrix=ellipse(g,w,{filled:u});break;case"triangle":this.matrix=triangle(g,w,{filled:u});break;default:throw new Error(`Shape: unexpected shape: ${l}`)}else if(s)switch(s.toLowerCase()){case"cross":this.matrix=cross;break;case"smallcross":this.matrix=smallCross;break;default:throw new Error(`Shape: unexpected kind: ${s}`)}else throw new Error("Shape: expected a kind or a shape option");this.height=this.matrix.length,this.width=this.matrix[0].length,this.halfHeight=this.height/2>>0,this.halfWidth=this.width/2>>0}getPoints(){let t=this.matrix,s=[];for(let l=0;l<t.length;l++)for(let p=0;p<t[0].length;p++)t[l][p]&&s.push([p-this.halfWidth,l-this.halfHeight]);return s}getMask(){let t=new Image$1(this.width,this.height,{kind:BINARY});for(let s=0;s<this.matrix.length;s++)for(let l=0;l<this.matrix[0].length;l++)this.matrix[s][l]&&t.setBitXY(l,s);return t}}function rectangle(n,t,s){const l=zerosMatrix(t,n);if(s.filled)for(let p=0;p<t;p++)for(let g=0;g<n;g++)l[p][g]=1;else{for(let p of[0,t-1])for(let g=0;g<n;g++)l[p][g]=1;for(let p=0;p<t;p++)for(let g of[0,n-1])l[p][g]=1}return l}function ellipse(n,t,s){const l=zerosMatrix(t,n);let p=1-t%2,g=1-n%2,w=Math.floor((n-1)/2),u=Math.floor((t-1)/2),A=w*w,S=u*u;if(s.filled)for(let D=0;D<=u;D++){let z=Math.floor(Math.sqrt(A-A*D*D/S));for(let $=w-z;$<=w;$++)l[u-D][$]=1,l[u+D+p][$]=1,l[u-D][n-$-1]=1,l[u+D+p][n-$-1]=1}else{for(let D=0;D<=u;D++){let z=Math.floor(Math.sqrt(A-A*D*D/S)),$=w-z;l[u-D][$]=1,l[u+D+p][$]=1,l[u-D][n-$-1]=1,l[u+D+p][n-$-1]=1}for(let D=0;D<=w;D++){let z=Math.floor(Math.sqrt(S-S*D*D/A)),$=u-z;l[$][w-D]=1,l[$][w+D+g]=1,l[t-$-1][w-D]=1,l[t-$-1][w+D+g]=1}}return l}function triangle(n,t,s){if(!s.filled)throw new Error("Non filled triangle is not implemented");const l=zerosMatrix(t,n);for(let p=0;p<t;p++){let g=Math.floor((1-p/t)*n/2);for(let w=g;w<n-g;w++)l[p][w]=1}return l}function paintPoints(n,t={}){let{shape:s}=t;this.checkProcessable("paintPoints",{bitDepth:[8,16]});let l=getColors(Object.assign({},t,{numberColors:n.length})),p=new Shape(s).getPoints(),g=Math.min(this.channels,l[0].length);for(let w=0;w<n.length;w++){let u=l[w%l.length],A=n[w][0],S=n[w][1];for(let D=0;D<p.length;D++){let z=p[D][0],$=p[D][1];if(A+z>=0&&S+$>=0&&A+z<this.width&&S+$<this.height){let O=(A+z+(S+$)*this.width)*this.channels;for(let q=0;q<g;q++)this.data[O+q]=u[q]}}}return this}function paintPolyline(n,t={}){let{color:s=[this.maxValue,0,0],closed:l=!1}=t;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]});let p=Math.min(this.channels,s.length);for(let g=0;g<n.length-1+l;g++){let w=n[g],u=n[(g+1)%n.length],A=u[0]-w[0],S=u[1]-w[1],D=Math.max(Math.abs(A),Math.abs(S)),z=A/D,$=S/D,O=w[0],q=w[1];for(let K=0;K<=D;K++){let J=Math.round(O),Y=Math.round(q);if(J>=0&&Y>=0&&J<this.width&&Y<this.height)if(this.bitDepth===1)this.setBitXY(J,Y);else{let fe=(J+Y*this.width)*this.channels;for(let ee=0;ee<p;ee++)this.data[fe+ee]=s[ee]}O=O+z,q=q+$}}return this}function paintPolylines(n,t={}){let s=Object.assign({},t);this.checkProcessable("paintPolylines",{bitDepth:[8,16]});let l=getColors(Object.assign({},t,{numberColors:n.length}));for(let p=0;p<n.length;p++)s.color=l[p%l.length],this.paintPolyline(n[p],s);return this}function paintPolygon(n,t={}){let{color:s=[this.maxValue,0,0],filled:l=!1}=t;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]}),t.closed=!0;let p=deleteDouble(n);if(l===!1)return this.paintPolyline(n,t);{let g=Array(this.height);for(let w=0;w<this.height;w++){g[w]=[];for(let u=0;u<this.width;u++)g[w].push(0)}for(let w=0;w<p.length;w++){const u=lineBetweenTwoPoints(p[w],p[(w+1)%p.length]);for(let A=0;A<this.height;A++)for(let S=0;S<this.width;S++)isAtTheRightOfTheLine(S,A,u,this.height)&&(g[A][S]=g[A][S]===0?1:0)}for(let w=0;w<this.height;w++)for(let u=0;u<this.width;u++)if(g[w][u]===1)if(this.bitDepth===1)this.setBitXY(u,w);else{let A=Math.min(this.channels,s.length),S=(u+w*this.width)*this.channels;for(let D=0;D<A;D++)this.data[S+D]=s[D]}return this.paintPolyline(n,t)}}function deleteDouble(n){let t=[];for(let s=0;s<n.length;s++)if(!(n[s][0]===n[(s+1)%n.length][0]&&n[s][1]===n[(s+1)%n.length][1])){if(n[s][0]===n[(s-1+n.length)%n.length][0]&&n[s][1]===n[(s-1+n.length)%n.length][1])continue;if(n[(s+1)%n.length][0]===n[(s-1+n.length)%n.length][0]&&n[(s-1+n.length)%n.length][1]===n[(s+1)%n.length][1])continue;t.push(n[s])}return t}function lineBetweenTwoPoints(n,t){if(n[0]===t[0])return{a:0,b:n[0],vertical:!0};{const s=(t[1]-n[1])/(t[0]-n[0]),l=n[1]-s*n[0];return{a:s,b:l,vertical:!1}}}function isAtTheRightOfTheLine(n,t,s,l){if(s.vertical===!0)return s.b<=n;if(s.a===0)return!1;{const p=(t-s.b)/s.a;return p<n&&p>=0&&p<=l}}function paintPolygons(n,t={}){let s=Object.assign({},t);this.checkProcessable("paintPolygons",{bitDepth:[8,16]});let l=getColors(Object.assign({},t,{numberColors:n.length}));for(let p=0;p<n.length;p++)s.color=l[p%l.length],this.paintPolygon(n[p],s);return this}function getHistogram(n={}){let{maxSlots:t=256,channel:s,useAlpha:l=!0}=n;if(this.checkProcessable("getHistogram",{bitDepth:[1,8,16]}),s===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");s=0}return getChannelHistogram.call(this,s,{useAlpha:l,maxSlots:t})}function getHistograms(n={}){const{maxSlots:t=256,useAlpha:s=!0}=n;this.checkProcessable("getHistograms",{bitDepth:[8,16]});let l=new Array(s?this.components:this.channels);for(let p=0;p<l.length;p++)l[p]=getChannelHistogram.call(this,p,{useAlpha:s,maxSlots:t});return l}function getChannelHistogram(n,t){let{useAlpha:s,maxSlots:l}=t;if(this.bitDepth===1){let A=[0,0];for(let S=0;S<this.height;S++)for(let D=0;D<this.width;D++){let z=this.getBitXY(S,D);z===0?A[0]+=1:z===1&&(A[1]+=1)}return A}let p=Math.log2(l);if(!isInteger(p))throw new RangeError("maxSlots must be a power of 2, for example: 64, 256, 1024");let g=0;this.bitDepth>p&&(g=this.bitDepth-p);let w=this.data,u=newArray_1(Math.pow(2,Math.min(this.bitDepth,p)),0);if(s&&this.alpha){let A=this.channels-n-1;for(let S=n;S<w.length;S+=this.channels)u[w[S]>>g]+=w[S+A]/this.maxValue}else for(let A=n;A<w.length;A+=this.channels)u[w[A]>>g]++;return u}function getColorHistogram(n={}){let{useAlpha:t=!0,nbSlots:s=512}=n;this.checkProcessable("getColorHistogram",{bitDepth:[8,16],components:[3]});let l=Math.log(s)/Math.log(8);if(l!==Math.floor(l))throw new RangeError("nbSlots must be a power of 8. Usually 8, 64, 512 or 4096");let p=this.bitDepth-l,g=this.data,w=newArray_1(Math.pow(8,l),0),u=Math.pow(2,l*2),A=Math.pow(2,l);for(let S=0;S<g.length;S+=this.channels){let D=(g[S]>>p)*u+(g[S+1]>>p)*A+(g[S+2]>>p);t&&this.alpha?w[D]+=g[S+this.channels-1]/this.maxValue:w[D]++}return w}function min(){this.checkProcessable("min",{bitDepth:[8,16,32]});let n=newArray_1(this.channels,1/0);for(let t=0;t<this.data.length;t+=this.channels)for(let s=0;s<this.channels;s++)this.data[t+s]<n[s]&&(n[s]=this.data[t+s]);return n}function max(){this.checkProcessable("max",{bitDepth:[8,16,32]});let n=newArray_1(this.channels,-1/0);for(let t=0;t<this.data.length;t+=this.channels)for(let s=0;s<this.channels;s++)this.data[t+s]>n[s]&&(n[s]=this.data[t+s]);return n}function sum(){this.checkProcessable("sum",{bitDepth:[8,16]});let n=newArray_1(this.channels,0);for(let t=0;t<this.data.length;t+=this.channels)for(let s=0;s<this.channels;s++)n[s]+=this.data[t+s];return n}function getMoment(n=0,t=0){this.checkProcessable("getMoment",{bitDepth:[1]});let s=0;for(let l=0;l<this.width;l++)for(let p=0;p<this.height;p++)this.getBitXY(l,p)===1&&(s+=l**n*p**t);return s}function localMaxima(n={}){let{mask:t,region:s=3,removeClosePoints:l=0,invert:p=!1,maxEquals:g=2}=n,w=this;this.checkProcessable("localMaxima",{bitDepth:[8,16],components:1}),s*=4;let u=p?0:1,A=[1,0,-1,0,1,1,-1,-1,2,0,-2,0,2,2,-2,-2],S=[0,1,0,-1,1,-1,1,-1,0,2,0,-2,2,-2,2,-2],D=s<=8?1:2,z=[];for(let $=D;$<w.height-D;$++)for(let O=D;O<w.width-D;O++){if(t&&t.getBitXY(O,$)!==u)continue;let q=0,K=0,J=w.data[O+$*w.width];for(let Y=0;Y<s;Y++)p?w.data[O+A[Y]+($+S[Y])*w.width]>J&&q++:w.data[O+A[Y]+($+S[Y])*w.width]<J&&q++,w.data[O+A[Y]+($+S[Y])*w.width]===J&&K++;q+K===s&&K<=g&&z.push([O,$])}if(l>0)for(let $=0;$<z.length;$++)for(let O=$+1;O<z.length;O++)Math.sqrt(Math.pow(z[$][0]-z[O][0],2)+Math.pow(z[$][1]-z[O][1],2))<l&&(z[$][0]=z[$][0]+z[O][0]>>1,z[$][1]=z[$][1]+z[O][1]>>1,z.splice(O,1),O--);return z}function mean(){let n=this.getHistograms({maxSlots:this.maxValue+1}),t=new Array(n.length);for(let s=0;s<n.length;s++){let l=n[s];t[s]=mean$2(l)}return t}function median(){let n=this.getHistograms({maxSlots:this.maxValue+1}),t=new Array(n.length);for(let s=0;s<n.length;s++){let l=n[s];t[s]=median$2(l)}return t}function points(){this.checkProcessable("points",{bitDepth:[1]});const n=[];for(let t=0;t<this.width;t++)for(let s=0;s<this.height;s++)this.getBitXY(t,s)===1&&n.push([t,s]);return n}function extendedPoints(){this.checkProcessable("extendedPoints",{bitDepth:[1]});const n=[];for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++)if(this.getBitXY(s,t)===1)for(n.push([s,t]),this.getBitXY(s+1,t)!==1?(n.push([s+1,t]),n.push([s+1,t+1]),this.getBitXY(s,t+1)!==1&&n.push([s,t+1])):this.getBitXY(s,t+1)!==1&&(n.push([s,t+1]),n.push([s+1,t+1]));s<this.width-2&&this.getBitXY(s+1,t)===1&&this.getBitXY(s+2,t)===1;)s++;return n}function getRelativePosition(n,t={}){if(this===n)return[0,0];let s=[0,0],l=this;for(;l;){if(l===n)return s;l.position&&(s[0]+=l.position[0],s[1]+=l.position[1]),l=l.parent}return t.defaultFurther?s:!1}function countAlphaPixels(n={}){let{alpha:t=1}=n;this.checkProcessable("countAlphaPixels",{bitDepth:[8,16],alpha:1});let s=0;if(t!==void 0){for(let l=this.components;l<this.data.length;l+=this.channels)this.data[l]===t&&s++;return s}else return this.size}function monotoneChainConvexHull$1(n,t={}){t.sorted||n.sort(byXThenY);const s=n.length,l=new Array(s*2);for(var p=0,g=0;g<s;g++){const u=n[g];for(;p>=2&&cw(l[p-2],l[p-1],u)<=0;)p--;l[p++]=u}const w=p+1;for(g=s-2;g>=0;g--){const u=n[g];for(;p>=w&&cw(l[p-2],l[p-1],u)<=0;)p--;l[p++]=u}return l.slice(0,p-1)}function cw(n,t,s){return(t[1]-n[1])*(s[0]-n[0])-(t[0]-n[0])*(s[1]-n[1])}function byXThenY(n,t){return n[0]===t[0]?n[1]-t[1]:n[0]-t[0]}function monotoneChainConvexHull(){return monotoneChainConvexHull$1(this.extendedPoints,{sorted:!1})}function round(n){for(let t=0;t<n.length;t++)n[t][0]=Math.round(n[t][0]),n[t][1]=Math.round(n[t][1]);return n}function difference(n,t){return[n[0]-t[0],n[1]-t[1]]}function normalize(n){let t=Math.sqrt(n[0]**2+n[1]**2);return[n[0]/t,n[1]/t]}function rotate(n,t,s){s===void 0&&(s=new Array(t.length));let l=Math.cos(n),p=Math.sin(n);for(let g=0;g<s.length;++g)s[g]=[l*t[g][0]-p*t[g][1],p*t[g][0]+l*t[g][1]];return s}function perimeter(n){let t=0;for(let s=0;s<n.length;s++){let l=n[s][0],p=n[s][1],g=n[s===n.length-1?0:s+1][0],w=n[s===n.length-1?0:s+1][1];t+=Math.sqrt((g-l)**2+(w-p)**2)}return t}function surface(n){let t=0;for(let s=0;s<n.length;s++){let l=n[s][0],p=n[s===n.length-1?0:s+1][1],g=n[s===n.length-1?0:s+1][0],w=n[s][1];t+=l*p*.5,t-=g*w*.5}return Math.abs(t)}function minMax(n){let t=1/0,s=1/0,l=-1/0,p=-1/0;for(let g=0;g<n.length;g++)n[g][0]<t&&(t=n[g][0]),n[g][0]>l&&(l=n[g][0]),n[g][1]<s&&(s=n[g][1]),n[g][1]>p&&(p=n[g][1]);return[[t,s],[l,p]]}function moveToZeroZero(n,t){t===void 0&&(t=new Array(n.length).fill(0).map(()=>[]));let s=minMax(n),l=s[0][0],p=s[0][1];for(let g=0;g<n.length;g++)t[g][0]=n[g][0]-l,t[g][1]=n[g][1]-p;return t}function minimalBoundingRectangle(n={}){const{originalPoints:t=monotoneChainConvexHull.call(this)}=n;if(t.length===0)return[];if(t.length===1)return[t[0],t[0],t[0],t[0]];const s=new Array(t.length);let l=1/0,p=0,g;for(let w=0;w<s.length;w++){let u=getAngle$1(t[w],t[(w+1)%s.length]);rotate(-u,t,s);let A=s[w][0],S=s[w][1],D=s[(w+1)%s.length][0],z=s[(w+1)%s.length][1],$=!0,O=0,q=0,K=0;for(let ee=0;ee<s.length;ee++){let re=s[ee][0],he=s[ee][1],_e=(re-A)/(D-A);$===!0?($=!1,O=_e,q=_e):(_e<O&&(O=_e),_e>q&&(q=_e));let we=(-(D-A)*he+D*S-z*A)/(D-A);Math.abs(we)>Math.abs(K)&&(K=we)}let J=[A+O*(D-A),S],Y=[A+q*(D-A),S],fe=Math.abs(K*(O-q)*(D-A));fe<l&&(p=u,l=fe,g=[J,Y,[Y[0],Y[1]-K],[J[0],J[1]-K]])}return rotate(p,g,g),g}function getAngle$1(n,t){let s=difference(t,n),l=normalize(s),p=Math.acos(l[0]);return l[1]<0?-p:p}function extend$4(n){let t={inPlace:!0};n.extendMethod("invert",invert),n.extendMethod("abs",abs),n.extendMethod("level",level,t),n.extendMethod("add",add,t),n.extendMethod("subtract",subtract,t),n.extendMethod("subtractImage",subtractImage),n.extendMethod("multiply",multiply,t),n.extendMethod("divide",divide,t),n.extendMethod("hypotenuse",hypotenuse),n.extendMethod("background",background$1),n.extendMethod("flipX",flipX),n.extendMethod("flipY",flipY),n.extendMethod("blurFilter",blurFilter),n.extendMethod("medianFilter",medianFilter),n.extendMethod("gaussianFilter",gaussianFilter),n.extendMethod("sobelFilter",sobelFilter),n.extendMethod("gradientFilter",gradientFilter),n.extendMethod("scharrFilter",scharrFilter),n.extendMethod("dilate",dilate),n.extendMethod("erode",erode),n.extendMethod("open",open),n.extendMethod("close",close),n.extendMethod("topHat",topHat),n.extendMethod("blackHat",blackHat),n.extendMethod("morphologicalGradient",morphologicalGradient),n.extendMethod("warpingFourPoints",warpingFourPoints),n.extendMethod("crop",crop),n.extendMethod("cropAlpha",cropAlpha),n.extendMethod("resize",resize).extendMethod("scale",resize),n.extendMethod("hsv",hsv),n.extendMethod("hsl",hsl$1),n.extendMethod("cmyk",cmyk),n.extendMethod("rgba8",rgba8),n.extendMethod("grey",grey).extendMethod("gray",grey),n.extendMethod("mask",mask),n.extendMethod("pad",pad),n.extendMethod("colorDepth",colorDepth),n.extendMethod("setBorder",setBorder,t),n.extendMethod("rotate",rotate$1),n.extendMethod("rotateLeft",rotateLeft),n.extendMethod("rotateRight",rotateRight),n.extendMethod("insert",insert),n.extendMethod("getRow",getRow),n.extendMethod("getColumn",getColumn),n.extendMethod("getMatrix",getMatrix),n.extendMethod("setMatrix",setMatrix),n.extendMethod("getPixelsArray",getPixelsArray),n.extendMethod("getIntersection",getIntersection),n.extendMethod("getClosestCommonParent",getClosestCommonParent),n.extendMethod("getThreshold",getThreshold),n.extendMethod("split",split),n.extendMethod("getChannel",getChannel),n.extendMethod("combineChannels",combineChannels),n.extendMethod("setChannel",setChannel),n.extendMethod("getSimilarity",getSimilarity),n.extendMethod("getPixelsGrid",getPixelsGrid),n.extendMethod("getBestMatch",getBestMatch),n.extendMethod("cannyEdge",cannyEdge),n.extendMethod("convolution",convolution),n.extendMethod("extract",extract),n.extendMethod("floodFill",floodFill),n.extendMethod("paintLabels",paintLabels,t),n.extendMethod("paintMasks",paintMasks,t),n.extendMethod("paintPoints",paintPoints,t),n.extendMethod("paintPolyline",paintPolyline,t),n.extendMethod("paintPolylines",paintPolylines,t),n.extendMethod("paintPolygon",paintPolygon,t),n.extendMethod("paintPolygons",paintPolygons,t),n.extendMethod("countAlphaPixels",countAlphaPixels),n.extendMethod("monotoneChainConvexHull",monotoneChainConvexHull),n.extendMethod("minimalBoundingRectangle",minimalBoundingRectangle),n.extendMethod("getHistogram",getHistogram).extendProperty("histogram",getHistogram),n.extendMethod("getHistograms",getHistograms).extendProperty("histograms",getHistograms),n.extendMethod("getColorHistogram",getColorHistogram).extendProperty("colorHistogram",getColorHistogram),n.extendMethod("getMin",min).extendProperty("min",min),n.extendMethod("getMax",max).extendProperty("max",max),n.extendMethod("getSum",sum).extendProperty("sum",sum),n.extendMethod("getMoment",getMoment).extendProperty("moment",getMoment),n.extendMethod("getLocalMaxima",localMaxima),n.extendMethod("getMedian",median).extendProperty("median",median),n.extendMethod("getMean",mean).extendProperty("mean",mean),n.extendMethod("getPoints",points).extendProperty("points",points),n.extendMethod("getExtendedPoints",extendedPoints).extendProperty("extendedPoints",extendedPoints),n.extendMethod("getRelativePosition",getRelativePosition)}var quantities={exports:{}};(function(n,t){(function(s,l){n.exports=l()})(commonjsGlobal,function(){function s(ye){return typeof ye=="string"||ye instanceof String}var l=Number.isFinite||window.isFinite;function p(ye){return l(ye)}function g(ye){return ye}function w(ye){var Q={};return ye.filter(function(G){return Q.hasOwnProperty(G)?!1:Q[G]=!0})}function u(ye,Q){if(Q.length!==ye.length)return!1;for(var G=0;G<ye.length;G++)if(Q[G].compareArray&&!Q[G].compareArray(ye[G])||Q[G]!==ye[G])return!1;return!0}function A(ye,Q){Object.keys(Q).forEach(function(G){ye[G]=Q[G]})}function S(){for(var ye=1,Q=0,G=0;G<arguments.length;G++){var W=arguments[G];Q=Q+$(W),ye*=W}return Q!==0?z(ye,Q):ye}function D(ye,Q){if(Q===0)throw new Error("Divide by zero");var G=Math.pow(10,$(Q)),W=G/(G*Q);return S(ye,W)}function z(ye,Q){return Math.round(ye*Math.pow(10,Q))/Math.pow(10,Q)}function $(ye){if(!isFinite(ye))return 0;for(var Q=0;ye%1!==0;)ye*=10,Q++;return Q}function O(){var ye;if(!this)return ye=Object.create(O.prototype),O.apply(ye,arguments),ye;ye=Error.apply(this,arguments),this.name="QtyError",this.message=ye.message,this.stack=ye.stack}O.prototype=Object.create(Error.prototype,{constructor:{value:O}});function q(ye,Q){throw new O("Incompatible units: "+ye+" and "+Q)}var K={"<googol>":[["googol"],1e100,"prefix"],"<kibi>":[["Ki","Kibi","kibi"],Math.pow(2,10),"prefix"],"<mebi>":[["Mi","Mebi","mebi"],Math.pow(2,20),"prefix"],"<gibi>":[["Gi","Gibi","gibi"],Math.pow(2,30),"prefix"],"<tebi>":[["Ti","Tebi","tebi"],Math.pow(2,40),"prefix"],"<pebi>":[["Pi","Pebi","pebi"],Math.pow(2,50),"prefix"],"<exi>":[["Ei","Exi","exi"],Math.pow(2,60),"prefix"],"<zebi>":[["Zi","Zebi","zebi"],Math.pow(2,70),"prefix"],"<yebi>":[["Yi","Yebi","yebi"],Math.pow(2,80),"prefix"],"<yotta>":[["Y","Yotta","yotta"],1e24,"prefix"],"<zetta>":[["Z","Zetta","zetta"],1e21,"prefix"],"<exa>":[["E","Exa","exa"],1e18,"prefix"],"<peta>":[["P","Peta","peta"],1e15,"prefix"],"<tera>":[["T","Tera","tera"],1e12,"prefix"],"<giga>":[["G","Giga","giga"],1e9,"prefix"],"<mega>":[["M","Mega","mega"],1e6,"prefix"],"<kilo>":[["k","kilo"],1e3,"prefix"],"<hecto>":[["h","Hecto","hecto"],100,"prefix"],"<deca>":[["da","Deca","deca","deka"],10,"prefix"],"<deci>":[["d","Deci","deci"],.1,"prefix"],"<centi>":[["c","Centi","centi"],.01,"prefix"],"<milli>":[["m","Milli","milli"],.001,"prefix"],"<micro>":[["u","\u03BC","\xB5","Micro","mc","micro"],1e-6,"prefix"],"<nano>":[["n","Nano","nano"],1e-9,"prefix"],"<pico>":[["p","Pico","pico"],1e-12,"prefix"],"<femto>":[["f","Femto","femto"],1e-15,"prefix"],"<atto>":[["a","Atto","atto"],1e-18,"prefix"],"<zepto>":[["z","Zepto","zepto"],1e-21,"prefix"],"<yocto>":[["y","Yocto","yocto"],1e-24,"prefix"],"<1>":[["1","<1>"],1,""],"<meter>":[["m","meter","meters","metre","metres"],1,"length",["<meter>"]],"<inch>":[["in","inch","inches",'"'],.0254,"length",["<meter>"]],"<foot>":[["ft","foot","feet","'"],.3048,"length",["<meter>"]],"<yard>":[["yd","yard","yards"],.9144,"length",["<meter>"]],"<mile>":[["mi","mile","miles"],1609.344,"length",["<meter>"]],"<naut-mile>":[["nmi","naut-mile"],1852,"length",["<meter>"]],"<league>":[["league","leagues"],4828,"length",["<meter>"]],"<furlong>":[["furlong","furlongs"],201.2,"length",["<meter>"]],"<rod>":[["rd","rod","rods"],5.029,"length",["<meter>"]],"<mil>":[["mil","mils"],254e-7,"length",["<meter>"]],"<angstrom>":[["ang","angstrom","angstroms"],1e-10,"length",["<meter>"]],"<fathom>":[["fathom","fathoms"],1.829,"length",["<meter>"]],"<pica>":[["pica","picas"],.00423333333,"length",["<meter>"]],"<point>":[["pt","point","points"],.000352777778,"length",["<meter>"]],"<redshift>":[["z","red-shift","redshift"],1302773e20,"length",["<meter>"]],"<AU>":[["AU","astronomical-unit"],1495979e5,"length",["<meter>"]],"<light-second>":[["ls","light-second"],299792500,"length",["<meter>"]],"<light-minute>":[["lmin","light-minute"],1798755e4,"length",["<meter>"]],"<light-year>":[["ly","light-year"],9460528e9,"length",["<meter>"]],"<parsec>":[["pc","parsec","parsecs"],3085678e10,"length",["<meter>"]],"<datamile>":[["DM","datamile"],1828.8,"length",["<meter>"]],"<kilogram>":[["kg","kilogram","kilograms"],1,"mass",["<kilogram>"]],"<AMU>":[["u","AMU","amu"],1660538921e-36,"mass",["<kilogram>"]],"<dalton>":[["Da","Dalton","Daltons","dalton","daltons"],1660538921e-36,"mass",["<kilogram>"]],"<slug>":[["slug","slugs"],14.5939029,"mass",["<kilogram>"]],"<short-ton>":[["tn","ton","short-ton"],907.18474,"mass",["<kilogram>"]],"<metric-ton>":[["tonne","metric-ton"],1e3,"mass",["<kilogram>"]],"<carat>":[["ct","carat","carats"],2e-4,"mass",["<kilogram>"]],"<pound>":[["lbs","lb","pound","pounds","#"],.45359237,"mass",["<kilogram>"]],"<ounce>":[["oz","ounce","ounces"],.0283495231,"mass",["<kilogram>"]],"<gram>":[["g","gram","grams","gramme","grammes"],.001,"mass",["<kilogram>"]],"<grain>":[["grain","grains","gr"],6479891e-11,"mass",["<kilogram>"]],"<dram>":[["dram","drams","dr"],.0017718452,"mass",["<kilogram>"]],"<stone>":[["stone","stones","st"],6.35029318,"mass",["<kilogram>"]],"<hectare>":[["hectare"],1e4,"area",["<meter>","<meter>"]],"<acre>":[["acre","acres"],4046.85642,"area",["<meter>","<meter>"]],"<sqft>":[["sqft"],1,"area",["<foot>","<foot>"]],"<liter>":[["l","L","liter","liters","litre","litres"],.001,"volume",["<meter>","<meter>","<meter>"]],"<gallon>":[["gal","gallon","gallons"],.0037854118,"volume",["<meter>","<meter>","<meter>"]],"<gallon-imp>":[["galimp","gallon-imp","gallons-imp"],.00454609,"volume",["<meter>","<meter>","<meter>"]],"<quart>":[["qt","quart","quarts"],.00094635295,"volume",["<meter>","<meter>","<meter>"]],"<pint>":[["pt","pint","pints"],.000473176475,"volume",["<meter>","<meter>","<meter>"]],"<pint-imp>":[["ptimp","pint-imp","pints-imp"],.00056826125,"volume",["<meter>","<meter>","<meter>"]],"<cup>":[["cu","cup","cups"],.000236588238,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce>":[["floz","fluid-ounce","fluid-ounces"],295735297e-13,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce-imp>":[["flozimp","floz-imp","fluid-ounce-imp","fluid-ounces-imp"],284130625e-13,"volume",["<meter>","<meter>","<meter>"]],"<tablespoon>":[["tb","tbsp","tbs","tablespoon","tablespoons"],147867648e-13,"volume",["<meter>","<meter>","<meter>"]],"<teaspoon>":[["tsp","teaspoon","teaspoons"],492892161e-14,"volume",["<meter>","<meter>","<meter>"]],"<bushel>":[["bu","bsh","bushel","bushels"],.035239072,"volume",["<meter>","<meter>","<meter>"]],"<oilbarrel>":[["bbl","oilbarrel","oilbarrels","oil-barrel","oil-barrels"],.158987294928,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel>":[["bl","bl-us","beerbarrel","beerbarrels","beer-barrel","beer-barrels"],.1173477658,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel-imp>":[["blimp","bl-imp","beerbarrel-imp","beerbarrels-imp","beer-barrel-imp","beer-barrels-imp"],.16365924,"volume",["<meter>","<meter>","<meter>"]],"<kph>":[["kph"],.277777778,"speed",["<meter>"],["<second>"]],"<mph>":[["mph"],.44704,"speed",["<meter>"],["<second>"]],"<knot>":[["kt","kn","kts","knot","knots"],.514444444,"speed",["<meter>"],["<second>"]],"<fps>":[["fps"],.3048,"speed",["<meter>"],["<second>"]],"<gee>":[["gee"],9.80665,"acceleration",["<meter>"],["<second>","<second>"]],"<Gal>":[["Gal"],.01,"acceleration",["<meter>"],["<second>","<second>"]],"<kelvin>":[["degK","kelvin"],1,"temperature",["<kelvin>"]],"<celsius>":[["degC","celsius","celsius","centigrade"],1,"temperature",["<kelvin>"]],"<fahrenheit>":[["degF","fahrenheit"],5/9,"temperature",["<kelvin>"]],"<rankine>":[["degR","rankine"],5/9,"temperature",["<kelvin>"]],"<temp-K>":[["tempK","temp-K"],1,"temperature",["<temp-K>"]],"<temp-C>":[["tempC","temp-C"],1,"temperature",["<temp-K>"]],"<temp-F>":[["tempF","temp-F"],5/9,"temperature",["<temp-K>"]],"<temp-R>":[["tempR","temp-R"],5/9,"temperature",["<temp-K>"]],"<second>":[["s","sec","secs","second","seconds"],1,"time",["<second>"]],"<minute>":[["min","mins","minute","minutes"],60,"time",["<second>"]],"<hour>":[["h","hr","hrs","hour","hours"],3600,"time",["<second>"]],"<day>":[["d","day","days"],3600*24,"time",["<second>"]],"<week>":[["wk","week","weeks"],7*3600*24,"time",["<second>"]],"<fortnight>":[["fortnight","fortnights"],1209600,"time",["<second>"]],"<year>":[["y","yr","year","years","annum"],31556926,"time",["<second>"]],"<decade>":[["decade","decades"],315569260,"time",["<second>"]],"<century>":[["century","centuries"],3155692600,"time",["<second>"]],"<pascal>":[["Pa","pascal","Pascal"],1,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<bar>":[["bar","bars"],1e5,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<mmHg>":[["mmHg"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inHg>":[["inHg"],3386.3881472,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<torr>":[["torr"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<atm>":[["atm","ATM","atmosphere","atmospheres"],101325,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<psi>":[["psi"],6894.76,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<cmh2o>":[["cmH2O","cmh2o"],98.0638,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inh2o>":[["inH2O","inh2o"],249.082052,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<poise>":[["P","poise"],.1,"viscosity",["<kilogram>"],["<meter>","<second>"]],"<stokes>":[["St","stokes"],1e-4,"viscosity",["<meter>","<meter>"],["<second>"]],"<mole>":[["mol","mole"],1,"substance",["<mole>"]],"<molar>":[["M","molar"],1e3,"concentration",["<mole>"],["<meter>","<meter>","<meter>"]],"<wtpercent>":[["wt%","wtpercent"],10,"concentration",["<kilogram>"],["<meter>","<meter>","<meter>"]],"<katal>":[["kat","katal","Katal"],1,"activity",["<mole>"],["<second>"]],"<unit>":[["U","enzUnit","unit"],16667e-19,"activity",["<mole>"],["<second>"]],"<farad>":[["F","farad","Farad"],1,"capacitance",["<second>","<second>","<second>","<second>","<ampere>","<ampere>"],["<meter>","<meter>","<kilogram>"]],"<coulomb>":[["C","coulomb","Coulomb"],1,"charge",["<ampere>","<second>"]],"<Ah>":[["Ah"],3600,"charge",["<ampere>","<second>"]],"<ampere>":[["A","Ampere","ampere","amp","amps"],1,"current",["<ampere>"]],"<siemens>":[["S","Siemens","siemens"],1,"conductance",["<second>","<second>","<second>","<ampere>","<ampere>"],["<kilogram>","<meter>","<meter>"]],"<henry>":[["H","Henry","henry"],1,"inductance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>","<ampere>"]],"<volt>":[["V","Volt","volt","volts"],1,"potential",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>"]],"<ohm>":[["Ohm","ohm","\u03A9","\u2126"],1,"resistance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>","<ampere>"]],"<weber>":[["Wb","weber","webers"],1,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<tesla>":[["T","tesla","teslas"],1,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<gauss>":[["G","gauss"],1e-4,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<maxwell>":[["Mx","maxwell","maxwells"],1e-8,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<oersted>":[["Oe","oersted","oersteds"],250/Math.PI,"magnetism",["<ampere>"],["<meter>"]],"<joule>":[["J","joule","Joule","joules"],1,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<erg>":[["erg","ergs"],1e-7,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<btu>":[["BTU","btu","BTUs"],1055.056,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<calorie>":[["cal","calorie","calories"],4.184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Calorie>":[["Cal","Calorie","Calories"],4184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<therm-US>":[["th","therm","therms","Therm","therm-US"],105480400,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Wh>":[["Wh"],3600,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<newton>":[["N","Newton","newton"],1,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<dyne>":[["dyn","dyne"],1e-5,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<pound-force>":[["lbf","pound-force"],4.448222,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<hertz>":[["Hz","hertz","Hertz"],1,"frequency",["<1>"],["<second>"]],"<radian>":[["rad","radian","radians"],1,"angle",["<radian>"]],"<degree>":[["deg","degree","degrees"],Math.PI/180,"angle",["<radian>"]],"<gradian>":[["gon","grad","gradian","grads"],Math.PI/200,"angle",["<radian>"]],"<steradian>":[["sr","steradian","steradians"],1,"solid_angle",["<steradian>"]],"<rotation>":[["rotation"],2*Math.PI,"angle",["<radian>"]],"<rpm>":[["rpm"],2*Math.PI/60,"angular_velocity",["<radian>"],["<second>"]],"<byte>":[["B","byte","bytes"],1,"information",["<byte>"]],"<bit>":[["b","bit","bits"],.125,"information",["<byte>"]],"<Bps>":[["Bps"],1,"information_rate",["<byte>"],["<second>"]],"<bps>":[["bps"],.125,"information_rate",["<byte>"],["<second>"]],"<dollar>":[["USD","dollar"],1,"currency",["<dollar>"]],"<cents>":[["cents"],.01,"currency",["<dollar>"]],"<candela>":[["cd","candela"],1,"luminosity",["<candela>"]],"<lumen>":[["lm","lumen"],1,"luminous_power",["<candela>","<steradian>"]],"<lux>":[["lux"],1,"illuminance",["<candela>","<steradian>"],["<meter>","<meter>"]],"<watt>":[["W","watt","watts"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere>":[["VA","volt-ampere"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere-reactive>":[["var","Var","VAr","VAR","volt-ampere-reactive"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<horsepower>":[["hp","horsepower"],745.699872,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<gray>":[["Gy","gray","grays"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<roentgen>":[["R","roentgen"],.00933,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<sievert>":[["Sv","sievert","sieverts"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<becquerel>":[["Bq","becquerel","becquerels"],1,"radiation",["<1>"],["<second>"]],"<curie>":[["Ci","curie","curies"],37e9,"radiation",["<1>"],["<second>"]],"<cpm>":[["cpm"],1/60,"rate",["<count>"],["<second>"]],"<dpm>":[["dpm"],1/60,"rate",["<count>"],["<second>"]],"<bpm>":[["bpm"],1/60,"rate",["<count>"],["<second>"]],"<dot>":[["dot","dots"],1,"resolution",["<each>"]],"<pixel>":[["pixel","px"],1,"resolution",["<each>"]],"<ppi>":[["ppi"],1,"resolution",["<pixel>"],["<inch>"]],"<dpi>":[["dpi"],1,"typography",["<dot>"],["<inch>"]],"<cell>":[["cells","cell"],1,"counting",["<each>"]],"<each>":[["each"],1,"counting",["<each>"]],"<count>":[["count"],1,"counting",["<each>"]],"<base-pair>":[["bp","base-pair"],1,"counting",["<each>"]],"<nucleotide>":[["nt","nucleotide"],1,"counting",["<each>"]],"<molecule>":[["molecule","molecules"],1,"counting",["<1>"]],"<dozen>":[["doz","dz","dozen"],12,"prefix_only",["<each>"]],"<percent>":[["%","percent"],.01,"prefix_only",["<1>"]],"<ppm>":[["ppm"],1e-6,"prefix_only",["<1>"]],"<ppt>":[["ppt"],1e-9,"prefix_only",["<1>"]],"<gross>":[["gr","gross"],144,"prefix_only",["<dozen>","<dozen>"]],"<decibel>":[["dB","decibel","decibels"],1,"logarithmic",["<decibel>"]]},J=["<meter>","<kilogram>","<second>","<mole>","<ampere>","<radian>","<kelvin>","<temp-K>","<byte>","<dollar>","<candela>","<each>","<steradian>","<decibel>"],Y="<1>",fe=[Y];function ee(ye,Q){var G=Q[1],W=Q[3]||[],ce=Q[4]||[];if(!p(G))throw new O(ye+": Invalid unit definition. 'scalar' must be a number");W.forEach(function(me){if(K[me]===void 0)throw new O(ye+": Invalid unit definition. Unit "+me+" in 'numerator' is not recognized")}),ce.forEach(function(me){if(K[me]===void 0)throw new O(ye+": Invalid unit definition. Unit "+me+" in 'denominator' is not recognized")})}var re={},he={},_e={},we={},oe={};for(var be in K)if(K.hasOwnProperty(be)){var ie=K[be];if(ie[2]==="prefix"){re[be]=ie[1];for(var ue=0;ue<ie[0].length;ue++)he[ie[0][ue]]=be}else{ee(be,ie),_e[be]={scalar:ie[1],numerator:ie[3],denominator:ie[4]};for(var Ce=0;Ce<ie[0].length;Ce++)we[ie[0][Ce]]=be}oe[be]=ie[0][0]}function Ne(ye){var Q,G=[],W=Object.keys(K);if(typeof ye=="undefined")for(Q=0;Q<W.length;Q++)["","prefix"].indexOf(K[W[Q]][2])===-1&&G.push(W[Q].substr(1,W[Q].length-2));else{if(this.getKinds().indexOf(ye)===-1)throw new O("Kind not recognized");for(Q=0;Q<W.length;Q++)K[W[Q]][2]===ye&&G.push(W[Q].substr(1,W[Q].length-2))}return G.sort(function(ce,me){return ce.toLowerCase()<me.toLowerCase()?-1:ce.toLowerCase()>me.toLowerCase()?1:0})}function it(ye){if(!we[ye])throw new O("Unit not recognized");return K[we[ye]][0]}var rt=["length","time","temperature","mass","current","substance","luminosity","currency","information","angle"];function Pt(){if(this.signature)return this.signature;for(var ye=zt.call(this),Q=0;Q<ye.length;Q++)ye[Q]*=Math.pow(20,Q);return ye.reduce(function(G,W){return G+W},0)}function zt(){if(!this.isBase())return zt.call(this.toBase());for(var ye=new Array(rt.length),Q=0;Q<ye.length;Q++)ye[Q]=0;for(var G,W,ce=0;ce<this.numerator.length;ce++)(G=K[this.numerator[ce]])&&(W=rt.indexOf(G[2]),W>=0&&(ye[W]=ye[W]+1));for(var me=0;me<this.denominator.length;me++)(G=K[this.denominator[me]])&&(W=rt.indexOf(G[2]),W>=0&&(ye[W]=ye[W]-1));return ye}var vt="[+-]",Vt="\\d+",kt=vt+"?"+Vt,Yt="\\."+Vt,Qt="(?:"+Vt+"(?:"+Yt+")?)|(?:"+Yt+")",ot="[Ee]"+kt,gt="(?:"+Qt+")(?:"+ot+")?",pt=vt+"?\\s*"+gt,Bt="("+pt+")?\\s*([^/]*)(?:/(.+))?",Zt=new RegExp("^"+Bt+"$"),si="\\^|\\*{2}",ii="[01234]",pi=new RegExp("([^ \\*\\d]+?)(?:"+si+")?(-?"+ii+"(?![a-zA-Z]))"),ai=new RegExp("([^ \\*\\d]+?)(?:"+si+")?("+ii+"(?![a-zA-Z]))");function Nt(ye){s(ye)||(ye=ye.toString()),ye=ye.trim();var Q=Zt.exec(ye);if(!Q)throw new O(ye+": Quantity not recognized");var G=Q[1];G?(G=G.replace(/\s/g,""),this.scalar=parseFloat(G)):this.scalar=1;for(var W=Q[2],ce=Q[3],me,ke,Re;Q=pi.exec(W);){if(me=parseFloat(Q[2]),isNaN(me))throw new O("Unit exponent is not a number");if(me===0&&!Tt.test(Q[1]))throw new O("Unit not recognized");ke=Q[1]+" ",Re="";for(var ze=0;ze<Math.abs(me);ze++)Re+=ke;me>=0?W=W.replace(Q[0],Re):(ce=ce?ce+Re:Re,W=W.replace(Q[0],""))}for(;Q=ai.exec(ce);){if(me=parseFloat(Q[2]),isNaN(me))throw new O("Unit exponent is not a number");if(me===0&&!Tt.test(Q[1]))throw new O("Unit not recognized");ke=Q[1]+" ",Re="";for(var Pe=0;Pe<me;Pe++)Re+=ke;ce=ce.replace(Q[0],Re)}W&&(this.numerator=Ht(W.trim())),ce&&(this.denominator=Ht(ce.trim()))}var ci=Object.keys(he).sort(function(ye,Q){return Q.length-ye.length}).join("|"),$t=Object.keys(we).sort(function(ye,Q){return Q.length-ye.length}).join("|"),ft="\\b|$",_i="("+ci+")??("+$t+")(?:"+ft+")",Tt=new RegExp("^\\s*("+_i+"[\\s\\*]*)+$"),Ge=new RegExp(_i,"g"),Gt={};function Ht(ye){var Q=Gt[ye];if(Q)return Q;var G,W=[];if(!Tt.test(ye))throw new O("Unit not recognized");for(;G=Ge.exec(ye);)W.push(G.slice(1));return W=W.map(function(ce){return he[ce[0]]?[he[ce[0]],we[ce[1]]]:[we[ce[1]]]}),W=W.reduce(function(ce,me){return ce.concat(me)},[]),W=W.filter(function(ce){return ce}),Gt[ye]=W,W}function ei(ye){if(!s(ye))throw new O("Argument should be a string");try{return this(ye)}catch{return null}}function oi(ye){return ye instanceof _t}function _t(ye,Q){if(Ci.apply(null,arguments),!oi(this))return new _t(ye,Q);if(this.scalar=null,this.baseScalar=null,this.signature=null,this._conversionCache={},this.numerator=fe,this.denominator=fe,hi(ye)?(this.scalar=ye.scalar,this.numerator=ye.numerator&&ye.numerator.length!==0?ye.numerator:fe,this.denominator=ye.denominator&&ye.denominator.length!==0?ye.denominator:fe):Q?(Nt.call(this,Q),this.scalar=ye):Nt.call(this,ye),this.denominator.join("*").indexOf("temp")>=0)throw new O("Cannot divide with temperatures");if(this.numerator.join("*").indexOf("temp")>=0){if(this.numerator.length>1)throw new O("Cannot multiply by temperatures");if(!u(this.denominator,fe))throw new O("Cannot divide with temperatures")}if(this.initValue=ye,Ft.call(this),this.isTemperature()&&this.baseScalar<0)throw new O("Temperatures must not be less than absolute zero")}_t.prototype={constructor:_t};function Ci(ye,Q){if(Q){if(!(p(ye)&&s(Q)))throw new O("Only number accepted as initialization value when units are explicitly provided")}else if(!(s(ye)||p(ye)||oi(ye)||hi(ye)))throw new O("Only string, number or quantity accepted as single initialization value")}function hi(ye){return ye&&typeof ye=="object"&&ye.hasOwnProperty("scalar")}function Ft(){if(this.baseScalar)return this.baseScalar;if(this.isBase())this.baseScalar=this.scalar,this.signature=Pt.call(this);else{var ye=this.toBase();this.baseScalar=ye.scalar,this.signature=ye.signature}}var Ut={"-312078":"elastance","-312058":"resistance","-312038":"inductance","-152058":"potential","-152040":"magnetism","-152038":"magnetism","-7997":"specific_volume","-79":"snap","-59":"jolt","-39":"acceleration","-38":"radiation","-20":"frequency","-19":"speed","-18":"viscosity","-17":"volumetric_flow","-1":"wavenumber","0":"unitless","1":"length","2":"area","3":"volume","20":"time","400":"temperature","7941":"yank","7942":"power","7959":"pressure","7961":"force","7962":"energy","7979":"viscosity","7981":"momentum","7982":"angular_momentum","7997":"density","7998":"area_density","8000":"mass","152020":"radiation_exposure","159999":"magnetism","160000":"current","160020":"charge","312058":"conductance","312078":"capacitance","3199980":"activity","3199997":"molar_concentration","3200000":"substance","63999998":"illuminance","64000000":"luminous_power","1280000000":"currency","25599999980":"information_rate","25600000000":"information","511999999980":"angular_velocity","512000000000":"angle"};function yt(){return w(Object.keys(Ut).map(function(ye){return Ut[ye]}))}_t.prototype.kind=function(){return Ut[this.signature.toString()]},A(_t.prototype,{isDegrees:function(){return(this.signature===null||this.signature===400)&&this.numerator.length===1&&u(this.denominator,fe)&&(this.numerator[0].match(/<temp-[CFRK]>/)||this.numerator[0].match(/<(kelvin|celsius|rankine|fahrenheit)>/))},isTemperature:function(){return this.isDegrees()&&this.numerator[0].match(/<temp-[CFRK]>/)}});function ui(ye,Q){var G=ye.units(),W=Q.to(G),ce=_t(Jt(G));return _t({scalar:ye.scalar-W.scalar,numerator:ce.numerator,denominator:ce.denominator})}function yi(ye,Q){var G=Q.to(Jt(ye.units()));return _t({scalar:ye.scalar-G.scalar,numerator:ye.numerator,denominator:ye.denominator})}function Ei(ye,Q){var G=Q.to(Jt(ye.units()));return _t({scalar:ye.scalar+G.scalar,numerator:ye.numerator,denominator:ye.denominator})}function Jt(ye){if(ye==="tempK")return"degK";if(ye==="tempC")return"degC";if(ye==="tempF")return"degF";if(ye==="tempR")return"degR";throw new O("Unknown type for temp conversion from: "+ye)}function di(ye,Q){var G=zi(ye),W=Q.units(),ce;if(W==="degK")ce=G.scalar;else if(W==="degC")ce=G.scalar;else if(W==="degF")ce=G.scalar*9/5;else if(W==="degR")ce=G.scalar*9/5;else throw new O("Unknown type for degree conversion to: "+W);return _t({scalar:ce,numerator:Q.numerator,denominator:Q.denominator})}function zi(ye){var Q=ye.units(),G;if(Q.match(/(deg)[CFRK]/))G=ye.baseScalar;else if(Q==="tempK")G=ye.scalar;else if(Q==="tempC")G=ye.scalar;else if(Q==="tempF")G=ye.scalar*5/9;else if(Q==="tempR")G=ye.scalar*5/9;else throw new O("Unknown type for temp conversion from: "+Q);return _t({scalar:G,numerator:["<kelvin>"],denominator:fe})}function Fi(ye,Q){var G=Q.units(),W;if(G==="tempK")W=ye.baseScalar;else if(G==="tempC")W=ye.baseScalar-273.15;else if(G==="tempF")W=ye.baseScalar*9/5-459.67;else if(G==="tempR")W=ye.baseScalar*9/5;else throw new O("Unknown type for temp conversion to: "+G);return _t({scalar:W,numerator:Q.numerator,denominator:Q.denominator})}function Oi(ye){var Q=ye.units(),G;if(Q.match(/(deg)[CFRK]/))G=ye.baseScalar;else if(Q==="tempK")G=ye.scalar;else if(Q==="tempC")G=ye.scalar+273.15;else if(Q==="tempF")G=(ye.scalar+459.67)*5/9;else if(Q==="tempR")G=ye.scalar*5/9;else throw new O("Unknown type for temp conversion from: "+Q);return _t({scalar:G,numerator:["<temp-K>"],denominator:fe})}A(_t.prototype,{to:function(ye){var Q,G;if(ye==null)return this;if(!s(ye))return this.to(ye.units());if(Q=this._conversionCache[ye],Q)return Q;if(G=_t(ye),G.units()===this.units())return this;if(!this.isCompatible(G))this.isInverse(G)?G=this.inverse().to(ye):q(this.units(),G.units());else if(G.isTemperature())G=Fi(this,G);else if(G.isDegrees())G=di(this,G);else{var W=D(this.baseScalar,G.baseScalar);G=_t({scalar:W,numerator:G.numerator,denominator:G.denominator})}return this._conversionCache[ye]=G,G},toBase:function(){if(this.isBase())return this;if(this.isTemperature())return Oi(this);var ye=Rr[this.units()];return ye||(ye=Lr(this.numerator,this.denominator),Rr[this.units()]=ye),ye.mul(this.scalar)},toFloat:function(){if(this.isUnitless())return this.scalar;throw new O("Can't convert to Float unless unitless.  Use Unit#scalar")},toPrec:function(ye){if(s(ye)&&(ye=_t(ye)),p(ye)&&(ye=_t(ye+" "+this.units())),this.isUnitless()?ye.isUnitless()||q(this.units(),ye.units()):ye=ye.to(this.units()),ye.scalar===0)throw new O("Divide by zero");var Q=S(Math.round(this.scalar/ye.scalar),ye.scalar);return _t(Q+this.units())}});function ir(ye,Q){var G=_t(ye),W=_t(Q);if(G.eq(W))return g;var ce;return G.isTemperature()?ce=function(me){return G.mul(me).to(W).scalar}:ce=function(me){return me*G.baseScalar/W.baseScalar},function(ke){var Re,ze,Pe;if(Array.isArray(ke)){for(ze=ke.length,Pe=[],Re=0;Re<ze;Re++)Pe.push(ce(ke[Re]));return Pe}else return ce(ke)}}var Rr={};function Lr(ye,Q){for(var G=[],W=[],ce=1,me,ke=0;ke<ye.length;ke++)me=ye[ke],re[me]?ce=S(ce,re[me]):_e[me]&&(ce*=_e[me].scalar,_e[me].numerator&&G.push(_e[me].numerator),_e[me].denominator&&W.push(_e[me].denominator));for(var Re=0;Re<Q.length;Re++)me=Q[Re],re[me]?ce/=re[me]:_e[me]&&(ce/=_e[me].scalar,_e[me].numerator&&W.push(_e[me].numerator),_e[me].denominator&&G.push(_e[me].denominator));return G=G.reduce(function(ze,Pe){return ze.concat(Pe)},[]),W=W.reduce(function(ze,Pe){return ze.concat(Pe)},[]),_t({scalar:ce,numerator:G,denominator:W})}_t.parse=ei,_t.getUnits=Ne,_t.getAliases=it,_t.mulSafe=S,_t.divSafe=D,_t.getKinds=yt,_t.swiftConverter=ir,_t.Error=O,A(_t.prototype,{add:function(ye){if(s(ye)&&(ye=_t(ye)),this.isCompatible(ye)||q(this.units(),ye.units()),this.isTemperature()&&ye.isTemperature())throw new O("Cannot add two temperatures");return this.isTemperature()?Ei(this,ye):ye.isTemperature()?Ei(ye,this):_t({scalar:this.scalar+ye.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},sub:function(ye){if(s(ye)&&(ye=_t(ye)),this.isCompatible(ye)||q(this.units(),ye.units()),this.isTemperature()&&ye.isTemperature())return ui(this,ye);if(this.isTemperature())return yi(this,ye);if(ye.isTemperature())throw new O("Cannot subtract a temperature from a differential degree unit");return _t({scalar:this.scalar-ye.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},mul:function(ye){if(p(ye))return _t({scalar:S(this.scalar,ye),numerator:this.numerator,denominator:this.denominator});if(s(ye)&&(ye=_t(ye)),(this.isTemperature()||ye.isTemperature())&&!(this.isUnitless()||ye.isUnitless()))throw new O("Cannot multiply by temperatures");var Q=this,G=ye;Q.isCompatible(G)&&Q.signature!==400&&(G=G.to(Q));var W=Tr(Q.numerator,Q.denominator,G.numerator,G.denominator);return _t({scalar:S(Q.scalar,G.scalar,W[2]),numerator:W[0],denominator:W[1]})},div:function(ye){if(p(ye)){if(ye===0)throw new O("Divide by zero");return _t({scalar:this.scalar/ye,numerator:this.numerator,denominator:this.denominator})}else s(ye)&&(ye=_t(ye));if(ye.scalar===0)throw new O("Divide by zero");if(ye.isTemperature())throw new O("Cannot divide with temperatures");if(this.isTemperature()&&!ye.isUnitless())throw new O("Cannot divide with temperatures");var Q=this,G=ye;Q.isCompatible(G)&&Q.signature!==400&&(G=G.to(Q));var W=Tr(Q.numerator,Q.denominator,G.denominator,G.numerator);return _t({scalar:S(Q.scalar,W[2])/G.scalar,numerator:W[0],denominator:W[1]})},inverse:function(){if(this.isTemperature())throw new O("Cannot divide with temperatures");if(this.scalar===0)throw new O("Divide by zero");return _t({scalar:1/this.scalar,numerator:this.denominator,denominator:this.numerator})}});function Tr(ye,Q,G,W){function ce(et){return et!==Y}ye=ye.filter(ce),G=G.filter(ce),Q=Q.filter(ce),W=W.filter(ce);var me={};function ke(et,Rt){for(var wt,Lt,Wt,$e=0;$e<et.length;$e++)if(re[et[$e]]?(wt=et[$e+1],Lt=et[$e],Wt=re[Lt],$e++):(wt=et[$e],Lt=null,Wt=1),wt&&wt!==Y)if(me[wt]){me[wt][0]+=Rt;var Ti=me[wt][2]?re[me[wt][2]]:1;me[wt][Rt===1?3:4]*=D(Wt,Ti)}else me[wt]=[Rt,wt,Lt,1,1]}ke(ye,1),ke(Q,-1),ke(G,1),ke(W,-1);var Re=[],ze=[],Pe=1;for(var je in me)if(me.hasOwnProperty(je)){var Ke=me[je],ut;if(Ke[0]>0)for(ut=0;ut<Ke[0];ut++)Re.push(Ke[2]===null?Ke[1]:[Ke[2],Ke[1]]);else if(Ke[0]<0)for(ut=0;ut<-Ke[0];ut++)ze.push(Ke[2]===null?Ke[1]:[Ke[2],Ke[1]]);Pe*=D(Ke[3],Ke[4])}return Re.length===0&&(Re=fe),ze.length===0&&(ze=fe),Re=Re.reduce(function(et,Rt){return et.concat(Rt)},[]),ze=ze.reduce(function(et,Rt){return et.concat(Rt)},[]),[Re,ze,Pe]}A(_t.prototype,{eq:function(ye){return this.compareTo(ye)===0},lt:function(ye){return this.compareTo(ye)===-1},lte:function(ye){return this.eq(ye)||this.lt(ye)},gt:function(ye){return this.compareTo(ye)===1},gte:function(ye){return this.eq(ye)||this.gt(ye)},compareTo:function(ye){if(s(ye))return this.compareTo(_t(ye));if(this.isCompatible(ye)||q(this.units(),ye.units()),this.baseScalar<ye.baseScalar)return-1;if(this.baseScalar===ye.baseScalar)return 0;if(this.baseScalar>ye.baseScalar)return 1},same:function(ye){return this.scalar===ye.scalar&&this.units()===ye.units()}}),A(_t.prototype,{isUnitless:function(){return[this.numerator,this.denominator].every(function(ye){return u(ye,fe)})},isCompatible:function(ye){return s(ye)?this.isCompatible(_t(ye)):oi(ye)&&ye.signature!==void 0?this.signature===ye.signature:!1},isInverse:function(ye){return this.inverse().isCompatible(ye)},isBase:function(){return this._isBase!==void 0?this._isBase:this.isDegrees()&&this.numerator[0].match(/<(kelvin|temp-K)>/)?(this._isBase=!0,this._isBase):(this.numerator.concat(this.denominator).forEach(function(ye){ye!==Y&&J.indexOf(ye)===-1&&(this._isBase=!1)},this),this._isBase===!1?this._isBase:(this._isBase=!0,this._isBase))}});function tr(){}tr.prototype.get=function(ye){return arguments.length>1&&(ye=Array.apply(null,arguments)),ye.reduce(function(Q,G,W){if(Q){var ce=Q[G];return W===ye.length-1?ce?ce.data:void 0:ce}},this)},tr.prototype.set=function(ye,Q){return arguments.length>2&&(ye=Array.prototype.slice.call(arguments,0,-1),Q=arguments[arguments.length-1]),ye.reduce(function(G,W,ce){var me=G[W];return me===void 0&&(me=G[W]={}),ce===ye.length-1?(me.data=Q,Q):me},this)};function dr(ye,Q){return(ye+" "+Q).trim()}_t.formatter=dr,A(_t.prototype,{units:function(){if(this._units!==void 0)return this._units;var ye=u(this.numerator,fe),Q=u(this.denominator,fe);if(ye&&Q)return this._units="",this._units;var G=xr(this.numerator),W=xr(this.denominator);return this._units=G+(Q?"":"/"+W),this._units},toString:function(ye,Q){var G;if(p(ye))G=this.units(),Q=ye;else if(s(ye))G=ye;else if(oi(ye))return this.toPrec(ye).toString(Q);var W=this.to(G),ce=Q!==void 0?z(W.scalar,Q):W.scalar;return W=(ce+" "+W.units()).trim(),W},format:function(ye,Q){arguments.length===1&&typeof ye=="function"&&(Q=ye,ye=void 0),Q=Q||_t.formatter;var G=this.to(ye);return Q.call(this,G.scalar,G.units())}});var gr=new tr;function xr(ye){var Q=gr.get(ye);if(Q)return Q;var G=u(ye,fe);return G?Q="1":Q=zr(Ar(ye)).join("*"),gr.set(ye,Q),Q}function Ar(ye){for(var Q=[],G,W,ce=0;ce<ye.length;ce++)G=ye[ce],W=ye[ce+1],re[G]?(Q.push(oe[G]+oe[W]),ce++):Q.push(oe[G]);return Q}function zr(ye){var Q=ye.reduce(function(G,W){var ce=G[W];return ce||G.push(ce=G[W]=[W,0]),ce[1]++,G},[]);return Q.map(function(G){return G[0]+(G[1]>1?G[1]:"")})}return _t.version="1.7.6",_t})})(quantities);var Qty=quantities.exports;function deepValue(n,t=""){let s=t.split(".");for(let l of s){if(n[l]===void 0)return;n=n[l]}return n}var orientation={exports:{}},twoProduct_1=twoProduct$1,SPLITTER=+(Math.pow(2,27)+1);function twoProduct$1(n,t,s){var l=n*t,p=SPLITTER*n,g=p-n,w=p-g,u=n-w,A=SPLITTER*t,S=A-t,D=A-S,z=t-D,$=l-w*D,O=$-u*D,q=O-w*z,K=u*z-q;return s?(s[0]=K,s[1]=l,s):[K,l]}var robustSum=linearExpansionSum;function scalarScalar$1(n,t){var s=n+t,l=s-n,p=s-l,g=t-l,w=n-p,u=w+g;return u?[u,s]:[s]}function linearExpansionSum(n,t){var s=n.length|0,l=t.length|0;if(s===1&&l===1)return scalarScalar$1(n[0],t[0]);var p=s+l,g=new Array(p),w=0,u=0,A=0,S=Math.abs,D=n[u],z=S(D),$=t[A],O=S($),q,K;z<O?(K=D,u+=1,u<s&&(D=n[u],z=S(D))):(K=$,A+=1,A<l&&($=t[A],O=S($))),u<s&&z<O||A>=l?(q=D,u+=1,u<s&&(D=n[u],z=S(D))):(q=$,A+=1,A<l&&($=t[A],O=S($)));for(var J=q+K,Y=J-q,fe=K-Y,ee=fe,re=J,he,_e,we,oe,be;u<s&&A<l;)z<O?(q=D,u+=1,u<s&&(D=n[u],z=S(D))):(q=$,A+=1,A<l&&($=t[A],O=S($))),K=ee,J=q+K,Y=J-q,fe=K-Y,fe&&(g[w++]=fe),he=re+J,_e=he-re,we=he-_e,oe=J-_e,be=re-we,ee=be+oe,re=he;for(;u<s;)q=D,K=ee,J=q+K,Y=J-q,fe=K-Y,fe&&(g[w++]=fe),he=re+J,_e=he-re,we=he-_e,oe=J-_e,be=re-we,ee=be+oe,re=he,u+=1,u<s&&(D=n[u]);for(;A<l;)q=$,K=ee,J=q+K,Y=J-q,fe=K-Y,fe&&(g[w++]=fe),he=re+J,_e=he-re,we=he-_e,oe=J-_e,be=re-we,ee=be+oe,re=he,A+=1,A<l&&($=t[A]);return ee&&(g[w++]=ee),re&&(g[w++]=re),w||(g[w++]=0),g.length=w,g}var twoSum$1=fastTwoSum;function fastTwoSum(n,t,s){var l=n+t,p=l-n,g=l-p,w=t-p,u=n-g;return s?(s[0]=u+w,s[1]=l,s):[u+w,l]}var twoProduct=twoProduct_1,twoSum=twoSum$1,robustScale=scaleLinearExpansion;function scaleLinearExpansion(n,t){var s=n.length;if(s===1){var l=twoProduct(n[0],t);return l[0]?l:[l[1]]}var p=new Array(2*s),g=[.1,.1],w=[.1,.1],u=0;twoProduct(n[0],t,g),g[0]&&(p[u++]=g[0]);for(var A=1;A<s;++A){twoProduct(n[A],t,w);var S=g[1];twoSum(S,w[0],g),g[0]&&(p[u++]=g[0]);var D=w[1],z=g[1],$=D+z,O=$-D,q=z-O;g[1]=$,q&&(p[u++]=q)}return g[1]&&(p[u++]=g[1]),u===0&&(p[u++]=0),p.length=u,p}var robustDiff=robustSubtract;function scalarScalar(n,t){var s=n+t,l=s-n,p=s-l,g=t-l,w=n-p,u=w+g;return u?[u,s]:[s]}function robustSubtract(n,t){var s=n.length|0,l=t.length|0;if(s===1&&l===1)return scalarScalar(n[0],-t[0]);var p=s+l,g=new Array(p),w=0,u=0,A=0,S=Math.abs,D=n[u],z=S(D),$=-t[A],O=S($),q,K;z<O?(K=D,u+=1,u<s&&(D=n[u],z=S(D))):(K=$,A+=1,A<l&&($=-t[A],O=S($))),u<s&&z<O||A>=l?(q=D,u+=1,u<s&&(D=n[u],z=S(D))):(q=$,A+=1,A<l&&($=-t[A],O=S($)));for(var J=q+K,Y=J-q,fe=K-Y,ee=fe,re=J,he,_e,we,oe,be;u<s&&A<l;)z<O?(q=D,u+=1,u<s&&(D=n[u],z=S(D))):(q=$,A+=1,A<l&&($=-t[A],O=S($))),K=ee,J=q+K,Y=J-q,fe=K-Y,fe&&(g[w++]=fe),he=re+J,_e=he-re,we=he-_e,oe=J-_e,be=re-we,ee=be+oe,re=he;for(;u<s;)q=D,K=ee,J=q+K,Y=J-q,fe=K-Y,fe&&(g[w++]=fe),he=re+J,_e=he-re,we=he-_e,oe=J-_e,be=re-we,ee=be+oe,re=he,u+=1,u<s&&(D=n[u]);for(;A<l;)q=$,K=ee,J=q+K,Y=J-q,fe=K-Y,fe&&(g[w++]=fe),he=re+J,_e=he-re,we=he-_e,oe=J-_e,be=re-we,ee=be+oe,re=he,A+=1,A<l&&($=-t[A]);return ee&&(g[w++]=ee),re&&(g[w++]=re),w||(g[w++]=0),g.length=w,g}(function(n){var t=twoProduct_1,s=robustSum,l=robustScale,p=robustDiff,g=5,w=11102230246251565e-32,u=(3+16*w)*w,A=(7+56*w)*w;function S(ee,re,he,_e){return function(oe,be,ie){var ue=ee(ee(re(be[1],ie[0]),re(-ie[1],be[0])),ee(re(oe[1],be[0]),re(-be[1],oe[0]))),Ce=ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),Ne=_e(ue,Ce);return Ne[Ne.length-1]}}function D(ee,re,he,_e){return function(oe,be,ie,ue){var Ce=ee(ee(he(ee(re(ie[1],ue[0]),re(-ue[1],ie[0])),be[2]),ee(he(ee(re(be[1],ue[0]),re(-ue[1],be[0])),-ie[2]),he(ee(re(be[1],ie[0]),re(-ie[1],be[0])),ue[2]))),ee(he(ee(re(be[1],ue[0]),re(-ue[1],be[0])),oe[2]),ee(he(ee(re(oe[1],ue[0]),re(-ue[1],oe[0])),-be[2]),he(ee(re(oe[1],be[0]),re(-be[1],oe[0])),ue[2])))),Ne=ee(ee(he(ee(re(ie[1],ue[0]),re(-ue[1],ie[0])),oe[2]),ee(he(ee(re(oe[1],ue[0]),re(-ue[1],oe[0])),-ie[2]),he(ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),ue[2]))),ee(he(ee(re(be[1],ie[0]),re(-ie[1],be[0])),oe[2]),ee(he(ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),-be[2]),he(ee(re(oe[1],be[0]),re(-be[1],oe[0])),ie[2])))),it=_e(Ce,Ne);return it[it.length-1]}}function z(ee,re,he,_e){return function(oe,be,ie,ue,Ce){var Ne=ee(ee(ee(he(ee(he(ee(re(ue[1],Ce[0]),re(-Ce[1],ue[0])),ie[2]),ee(he(ee(re(ie[1],Ce[0]),re(-Ce[1],ie[0])),-ue[2]),he(ee(re(ie[1],ue[0]),re(-ue[1],ie[0])),Ce[2]))),be[3]),ee(he(ee(he(ee(re(ue[1],Ce[0]),re(-Ce[1],ue[0])),be[2]),ee(he(ee(re(be[1],Ce[0]),re(-Ce[1],be[0])),-ue[2]),he(ee(re(be[1],ue[0]),re(-ue[1],be[0])),Ce[2]))),-ie[3]),he(ee(he(ee(re(ie[1],Ce[0]),re(-Ce[1],ie[0])),be[2]),ee(he(ee(re(be[1],Ce[0]),re(-Ce[1],be[0])),-ie[2]),he(ee(re(be[1],ie[0]),re(-ie[1],be[0])),Ce[2]))),ue[3]))),ee(he(ee(he(ee(re(ie[1],ue[0]),re(-ue[1],ie[0])),be[2]),ee(he(ee(re(be[1],ue[0]),re(-ue[1],be[0])),-ie[2]),he(ee(re(be[1],ie[0]),re(-ie[1],be[0])),ue[2]))),-Ce[3]),ee(he(ee(he(ee(re(ue[1],Ce[0]),re(-Ce[1],ue[0])),be[2]),ee(he(ee(re(be[1],Ce[0]),re(-Ce[1],be[0])),-ue[2]),he(ee(re(be[1],ue[0]),re(-ue[1],be[0])),Ce[2]))),oe[3]),he(ee(he(ee(re(ue[1],Ce[0]),re(-Ce[1],ue[0])),oe[2]),ee(he(ee(re(oe[1],Ce[0]),re(-Ce[1],oe[0])),-ue[2]),he(ee(re(oe[1],ue[0]),re(-ue[1],oe[0])),Ce[2]))),-be[3])))),ee(ee(he(ee(he(ee(re(be[1],Ce[0]),re(-Ce[1],be[0])),oe[2]),ee(he(ee(re(oe[1],Ce[0]),re(-Ce[1],oe[0])),-be[2]),he(ee(re(oe[1],be[0]),re(-be[1],oe[0])),Ce[2]))),ue[3]),ee(he(ee(he(ee(re(be[1],ue[0]),re(-ue[1],be[0])),oe[2]),ee(he(ee(re(oe[1],ue[0]),re(-ue[1],oe[0])),-be[2]),he(ee(re(oe[1],be[0]),re(-be[1],oe[0])),ue[2]))),-Ce[3]),he(ee(he(ee(re(ie[1],ue[0]),re(-ue[1],ie[0])),be[2]),ee(he(ee(re(be[1],ue[0]),re(-ue[1],be[0])),-ie[2]),he(ee(re(be[1],ie[0]),re(-ie[1],be[0])),ue[2]))),oe[3]))),ee(he(ee(he(ee(re(ie[1],ue[0]),re(-ue[1],ie[0])),oe[2]),ee(he(ee(re(oe[1],ue[0]),re(-ue[1],oe[0])),-ie[2]),he(ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),ue[2]))),-be[3]),ee(he(ee(he(ee(re(be[1],ue[0]),re(-ue[1],be[0])),oe[2]),ee(he(ee(re(oe[1],ue[0]),re(-ue[1],oe[0])),-be[2]),he(ee(re(oe[1],be[0]),re(-be[1],oe[0])),ue[2]))),ie[3]),he(ee(he(ee(re(be[1],ie[0]),re(-ie[1],be[0])),oe[2]),ee(he(ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),-be[2]),he(ee(re(oe[1],be[0]),re(-be[1],oe[0])),ie[2]))),-ue[3]))))),it=ee(ee(ee(he(ee(he(ee(re(ue[1],Ce[0]),re(-Ce[1],ue[0])),ie[2]),ee(he(ee(re(ie[1],Ce[0]),re(-Ce[1],ie[0])),-ue[2]),he(ee(re(ie[1],ue[0]),re(-ue[1],ie[0])),Ce[2]))),oe[3]),he(ee(he(ee(re(ue[1],Ce[0]),re(-Ce[1],ue[0])),oe[2]),ee(he(ee(re(oe[1],Ce[0]),re(-Ce[1],oe[0])),-ue[2]),he(ee(re(oe[1],ue[0]),re(-ue[1],oe[0])),Ce[2]))),-ie[3])),ee(he(ee(he(ee(re(ie[1],Ce[0]),re(-Ce[1],ie[0])),oe[2]),ee(he(ee(re(oe[1],Ce[0]),re(-Ce[1],oe[0])),-ie[2]),he(ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),Ce[2]))),ue[3]),he(ee(he(ee(re(ie[1],ue[0]),re(-ue[1],ie[0])),oe[2]),ee(he(ee(re(oe[1],ue[0]),re(-ue[1],oe[0])),-ie[2]),he(ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),ue[2]))),-Ce[3]))),ee(ee(he(ee(he(ee(re(ie[1],Ce[0]),re(-Ce[1],ie[0])),be[2]),ee(he(ee(re(be[1],Ce[0]),re(-Ce[1],be[0])),-ie[2]),he(ee(re(be[1],ie[0]),re(-ie[1],be[0])),Ce[2]))),oe[3]),he(ee(he(ee(re(ie[1],Ce[0]),re(-Ce[1],ie[0])),oe[2]),ee(he(ee(re(oe[1],Ce[0]),re(-Ce[1],oe[0])),-ie[2]),he(ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),Ce[2]))),-be[3])),ee(he(ee(he(ee(re(be[1],Ce[0]),re(-Ce[1],be[0])),oe[2]),ee(he(ee(re(oe[1],Ce[0]),re(-Ce[1],oe[0])),-be[2]),he(ee(re(oe[1],be[0]),re(-be[1],oe[0])),Ce[2]))),ie[3]),he(ee(he(ee(re(be[1],ie[0]),re(-ie[1],be[0])),oe[2]),ee(he(ee(re(oe[1],ie[0]),re(-ie[1],oe[0])),-be[2]),he(ee(re(oe[1],be[0]),re(-be[1],oe[0])),ie[2]))),-Ce[3])))),rt=_e(Ne,it);return rt[rt.length-1]}}function $(ee){var re=ee===3?S:ee===4?D:z;return re(s,t,l,p)}var O=$(3),q=$(4),K=[function(){return 0},function(){return 0},function(re,he){return he[0]-re[0]},function(re,he,_e){var we=(re[1]-_e[1])*(he[0]-_e[0]),oe=(re[0]-_e[0])*(he[1]-_e[1]),be=we-oe,ie;if(we>0){if(oe<=0)return be;ie=we+oe}else if(we<0){if(oe>=0)return be;ie=-(we+oe)}else return be;var ue=u*ie;return be>=ue||be<=-ue?be:O(re,he,_e)},function(re,he,_e,we){var oe=re[0]-we[0],be=he[0]-we[0],ie=_e[0]-we[0],ue=re[1]-we[1],Ce=he[1]-we[1],Ne=_e[1]-we[1],it=re[2]-we[2],rt=he[2]-we[2],Pt=_e[2]-we[2],zt=be*Ne,vt=ie*Ce,Vt=ie*ue,kt=oe*Ne,Yt=oe*Ce,Qt=be*ue,ot=it*(zt-vt)+rt*(Vt-kt)+Pt*(Yt-Qt),gt=(Math.abs(zt)+Math.abs(vt))*Math.abs(it)+(Math.abs(Vt)+Math.abs(kt))*Math.abs(rt)+(Math.abs(Yt)+Math.abs(Qt))*Math.abs(Pt),pt=A*gt;return ot>pt||-ot>pt?ot:q(re,he,_e,we)}];function J(ee){var re=K[ee.length];return re||(re=K[ee.length]=$(ee.length)),re.apply(void 0,ee)}function Y(ee,re,he,_e,we,oe,be){return function(ue,Ce,Ne,it,rt){switch(arguments.length){case 0:case 1:return 0;case 2:return _e(ue,Ce);case 3:return we(ue,Ce,Ne);case 4:return oe(ue,Ce,Ne,it);case 5:return be(ue,Ce,Ne,it,rt)}for(var Pt=new Array(arguments.length),zt=0;zt<arguments.length;++zt)Pt[zt]=arguments[zt];return ee(Pt)}}function fe(){for(;K.length<=g;)K.push($(K.length));n.exports=Y.apply(void 0,[J].concat(K));for(var ee=0;ee<=g;++ee)n.exports[ee]=K[ee]}fe()})(orientation);var robustPnp=robustPointInPolygon,orient=orientation.exports;function robustPointInPolygon(n,t){for(var s=t[0],l=t[1],p=n.length,g=1,w=p,u=0,A=p-1;u<w;A=u++){var S=n[u],D=n[A],z=S[1],$=D[1];if($<z){if($<l&&l<z){var O=orient(S,D,t);if(O===0)return 0;g^=0<O|0}else if(l===z){var q=n[(u+1)%p],K=q[1];if(z<K){var O=orient(S,D,t);if(O===0)return 0;g^=0<O|0}}}else if(z<$){if(z<l&&l<$){var O=orient(S,D,t);if(O===0)return 0;g^=O<0|0}else if(l===z){var q=n[(u+1)%p],K=q[1];if(K<z){var O=orient(S,D,t);if(O===0)return 0;g^=O<0|0}}}else if(l===z){var J=Math.min(S[0],D[0]),Y=Math.max(S[0],D[0]);if(u===0){for(;A>0;){var fe=(A+p-1)%p,ee=n[fe];if(ee[1]!==l)break;var re=ee[0];J=Math.min(J,re),Y=Math.max(Y,re),A=fe}if(A===0)return J<=s&&s<=Y?0:1;w=A+1}for(var he=n[(A+p-1)%p][1];u+1<w;){var ee=n[u+1];if(ee[1]!==l)break;var re=ee[0];J=Math.min(J,re),Y=Math.max(Y,re),u+=1}if(J<=s&&s<=Y)return 0;var _e=n[(u+1)%p][1];s<J&&he<l!=_e<l&&(g^=1)}}return 2*g-1}var robustPointInPolygon$1=robustPnp;function feretDiameters(n={}){const{originalPoints:t=monotoneChainConvexHull.call(this)}=n;if(t.length===0)return{min:0,max:0,minLine:[],maxLine:[],aspectRatio:1};if(t.length===1)return{min:1,max:1,minLine:[t[0],t[0]],maxLine:[t[0],t[0]],aspectRatio:1};const s=new Array(t.length);let l=1/0,p=0,g=[];for(let S=0;S<t.length;S++){let D=getAngle(t[S],t[(S+1)%t.length]);rotate(-D,t,s);let z=0,$=[];for(let O=0;O<t.length;O++){let q=Math.abs(s[S][1]-s[O][1]);q>z&&(z=q,$=[],$.push([s[O][0],s[S][1]],[s[O][0],s[O][1]]))}z<l&&(l=z,p=D,g=$)}rotate(p,g,g);let w=0,u=[],A=0;for(let S=0;S<t.length-1;S++)for(let D=S+1;D<t.length;D++){let z=(t[S][0]-t[D][0])**2+(t[S][1]-t[D][1])**2;z>A&&(A=z,w=Math.sqrt(z),u=[t[S],t[D]])}return{min:l,minLine:g,max:w,maxLine:u,aspectRatio:l/w}}function getAngle(n,t){let s=difference(t,n),l=normalize(s),p=Math.acos(l[0]);return l[1]<0?-p:p}class Roi{constructor(t,s){this.map=t,this.id=s,this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.meanX=0,this.meanY=0,this.surface=0,this.computed={}}getMask(t={}){const{scale:s=1,kind:l=""}=t;let p;switch(l){case"contour":p=this.contourMask;break;case"box":p=this.boxMask;break;case"filled":p=this.filledMask;break;case"center":p=this.centerMask;break;case"mbr":p=this.mbrFilledMask;break;case"hull":p=this.convexHullFilledMask;break;case"hullContour":p=this.convexHullMask;break;case"mbrContour":p=this.mbrMask;break;case"feret":p=this.feretMask;break;default:p=this.mask}return s<1&&(p=p.resize({factor:s}),p.parent=this.mask.parent,p.position[0]+=this.minX,p.position[1]+=this.minY),p}get mean(){throw new Error("Roi mean not implemented yet")}get center(){return this.computed.center||(this.computed.center=[this.width/2>>0,this.height/2>>0]),this.computed.center}get ratio(){return this.width/this.height}get width(){return this.maxX-this.minX+1}get height(){return this.maxY-this.minY+1}_computExternalIDs(){let t=this.borderIDs,s=this.borderLengths;this.computed.externalIDs=[],this.computed.externalLengths=[];let l=this.internalIDs;for(let p=0;p<t.length;p++)l.includes(t[p])||(this.computed.externalIDs.push(t[p]),this.computed.externalLengths.push(s[p]))}get externalIDs(){return this.computed.externalIDs?this.computed.externalIDs:(this._computExternalIDs(),this.computed.externalIDs)}get externalLengths(){return this.computed.externalLengths?this.computed.externalLengths:(this._computExternalIDs(),this.computed.externalLengths)}_computeBorderIDs(){let t=getBorders(this);this.computed.borderIDs=t.ids,this.computed.borderLengths=t.lengths}get borderIDs(){return this.computed.borderIDs?this.computed.borderIDs:(this._computeBorderIDs(),this.computed.borderIDs)}get borderLengths(){return this.computed.borderLengths?this.computed.borderLengths:(this._computeBorderIDs(),this.computed.borderLengths)}get boxIDs(){return this.computed.boxIDs||(this.computed.boxIDs=getBoxIDs(this)),this.computed.boxIDs}get internalIDs(){return this.computed.internalIDs||(this.computed.internalIDs=getInternalIDs(this)),this.computed.internalIDs}get box(){return this.computed.box||(this.computed.box=getBox(this)),this.computed.box}get external(){return this.computed.external||(this.computed.external=getExternal(this)),this.computed.external}get holesInfo(){return this.computed.holesInfo||(this.computed.holesInfo=getHolesInfo(this)),this.computed.holesInfo}get border(){return this.computed.border||(this.computed.border=getBorder(this)),this.computed.border}get contourMask(){if(!this.computed.contourMask){let t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let s=0;s<this.width;s++)for(let l=0;l<this.height;l++)this.map.data[s+this.minX+(l+this.minY)*this.map.width]===this.id&&(s>0&&s<this.width-1&&l>0&&l<this.height-1?(this.map.data[s-1+this.minX+(l+this.minY)*this.map.width]!==this.id||this.map.data[s+1+this.minX+(l+this.minY)*this.map.width]!==this.id||this.map.data[s+this.minX+(l-1+this.minY)*this.map.width]!==this.id||this.map.data[s+this.minX+(l+1+this.minY)*this.map.width]!==this.id)&&t.setBitXY(s,l):t.setBitXY(s,l));this.computed.contourMask=t}return this.computed.contourMask}get boxMask(){if(!this.computed.boxMask){let t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let s=0;s<this.width;s++)t.setBitXY(s,0),t.setBitXY(s,this.height-1);for(let s=0;s<this.height;s++)t.setBitXY(0,s),t.setBitXY(this.width-1,s);this.computed.boxMask=t}return this.computed.boxMask}get mask(){if(!this.computed.mask){let t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let s=0;s<this.width;s++)for(let l=0;l<this.height;l++)this.map.data[s+this.minX+(l+this.minY)*this.map.width]===this.id&&t.setBitXY(s,l);this.computed.mask=t}return this.computed.mask}get filledMask(){if(!this.computed.filledMask){let t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let s=0;s<this.width;s++)for(let l=0;l<this.height;l++){let p=s+this.minX+(l+this.minY)*this.map.width;this.internalIDs.includes(this.map.data[p])&&t.setBitXY(s,l)}this.computed.filledMask=t}return this.computed.filledMask}get centerMask(){if(!this.computed.centerMask){let t=new Shape({kind:"smallCross"}).getMask();t.parent=this.map.parent,t.position=[this.minX+this.center[0]-1,this.minY+this.center[1]-1],this.computed.centerMask=t}return this.computed.centerMask}get convexHull(){if(!this.computed.convexHull){const t=[];for(let l=0;l<this.width;l++)for(let p=0;p<this.height;p++)this.map.data[l+this.minX+(p+this.minY)*this.map.width]===this.id&&(l>0&&l<this.width-1&&p>0&&p<this.height-1?(this.map.data[l-1+this.minX+(p+this.minY)*this.map.width]!==this.id||this.map.data[l+1+this.minX+(p+this.minY)*this.map.width]!==this.id||this.map.data[l+this.minX+(p-1+this.minY)*this.map.width]!==this.id||this.map.data[l+this.minX+(p+1+this.minY)*this.map.width]!==this.id)&&(t.push([l,p]),t.push([l+1,p]),t.push([l,p+1]),t.push([l+1,p+1])):(t.push([l,p]),t.push([l+1,p]),t.push([l,p+1]),t.push([l+1,p+1])));const s=monotoneChainConvexHull$1(t);this.computed.convexHull={polyline:s,surface:surface(s),perimeter:perimeter(s)}}return this.computed.convexHull}get convexHullMask(){if(!this.computed.convexHullMask){const t=this.convexHull,s=new Image$1(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});s.paintPolyline(t.polyline,{closed:!0}),this.computed.convexHullMask=s}return this.computed.convexHullMask}get convexHullFilledMask(){if(!this.computed.convexHullFilledMask){const t=this.convexHull,s=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let l=0;l<this.width;l++)for(let p=0;p<this.height;p++)robustPointInPolygon$1(t.polyline,[l,p])!==1&&s.setBitXY(l,p);this.computed.convexHullFilledMask=s}return this.computed.convexHullFilledMask}get mbr(){if(!this.computed.mbr){let t=minimalBoundingRectangle({originalPoints:this.convexHull.polyline});if(t.length===0)this.computed.mbr={width:0,height:0,surface:0,perimeter:0,rectangle:t};else{let s=t[0],l=t[1],p=t[2],g=Math.sqrt((s[0]-l[0])**2+(s[1]-l[1])**2),w=Math.sqrt((p[0]-l[0])**2+(p[1]-l[1])**2);this.computed.mbr={width:g,height:w,elongation:1-g/w,aspectRatio:g/w,surface:g*w,perimeter:(g+w)*2,rectangle:t}}}return this.computed.mbr}get fillRatio(){return this.surface/(this.surface+this.holesInfo.surface)}get feretDiameters(){return this.computed.feretDiameters||(this.computed.feretDiameters=feretDiameters({originalPoints:this.convexHull.polyline})),this.computed.feretDiameters}get eqpc(){return this.computed.eqpc||(this.computed.eqpc=2*Math.sqrt(this.surface/Math.PI)),this.computed.eqpc}get perimeterInfo(){return this.computed.perimeterInfo||(this.computed.perimeterInfo=getPerimeterInfo(this)),this.computed.perimeterInfo}get perimeter(){let t=this.perimeterInfo,s=2-Math.sqrt(2);return t.one+t.two*2+t.three*3+t.four*4-s*(t.two+t.three*2+t.four)}get ped(){return this.computed.ped||(this.computed.ped=this.perimeter/Math.PI),this.computed.ped}get feretMask(){if(!this.computed.feretMask){const t=new Image$1(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});t.paintPolyline(this.feretDiameters.minLine),t.paintPolyline(this.feretDiameters.maxLine),this.computed.feretMask=t}return this.computed.feretMask}get mbrMask(){if(!this.computed.mbrMask){let t=round(this.mbr.rectangle);if(t.length>0){const s=minMax(t),l=new Image$1(s[1][0]-s[0][0]+1,s[1][1]-s[0][1]+1,{kind:BINARY,position:[this.minX+s[0][0],this.minY+s[0][1]],parent:this.map.parent});t=moveToZeroZero(t),l.paintPolyline(t,{closed:!0}),this.computed.mbrMask=l}else this.computed.mbrMask=new Image$1(1,1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent})}return this.computed.mbrMask}get mbrFilledMask(){if(!this.computed.mbrFilledMask){const t=new Image$1(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),s=this.mask.minimalBoundingRectangle();for(let l=0;l<this.width;l++)for(let p=0;p<this.height;p++)robustPointInPolygon$1(s,[l,p])!==1&&t.setBitXY(l,p);this.computed.mbrFilledMask=t}return this.computed.mbrFilledMask}get points(){if(!this.computed.points){let t=[];for(let s=0;s<this.height;s++)for(let l=0;l<this.width;l++){let p=(s+this.minY)*this.map.width+l+this.minX;this.map.data[p]===this.id&&t.push([l,s])}this.computed.points=t}return this.computed.points}get maxLengthPoints(){if(!this.computed.maxLengthPoints){let t=0,s;const l=this.points;for(let p=0;p<l.length;p++)for(let g=p+1;g<l.length;g++){let w=Math.pow(l[p][0]-l[g][0],2)+Math.pow(l[p][1]-l[g][1],2);w>=t&&(t=w,s=[l[p],l[g]])}this.computed.maxLengthPoints=s}return this.computed.maxLengthPoints}get maxLength(){if(!this.computed.maxLength){let t=Math.sqrt(Math.pow(this.maxLengthPoints[0][0]-this.maxLengthPoints[1][0],2)+Math.pow(this.maxLengthPoints[0][1]-this.maxLengthPoints[1][1],2));this.computed.maxLength=t}return this.computed.maxLength}get roundness(){return 4*this.surface/(Math.PI*this.feretDiameters.max**2)}get sphericity(){return 2*Math.sqrt(this.surface*Math.PI)/this.perimeter}get solidity(){return this.surface/this.convexHull.surface}get angle(){if(!this.computed.angle){let t=this.maxLengthPoints,s=-Math.atan2(t[0][1]-t[1][1],t[0][0]-t[1][0])*180/Math.PI;this.computed.angle=s}return this.computed.angle}toJSON(){return{id:this.id,minX:this.minX,maxX:this.maxX,minY:this.minY,maxY:this.maxY,meanX:this.meanX,meanY:this.meanY,height:this.height,width:this.width,surface:this.surface,mbrWidth:this.mbr.width,mbrHeight:this.mbr.height,mbrSurface:this.mbr.surface,eqpc:this.eqpc,ped:this.ped,feretDiameterMin:this.feretDiameters.min,feretDiameterMax:this.feretDiameters.max,aspectRatio:this.feretDiameters.aspectRatio,fillRatio:this.fillRatio,sphericity:this.sphericity,roundness:this.roundness,solidity:this.solidity,perimeter:this.perimeter}}}function getBorders(n){let t=n.map,s=t.data,l=new Set,p=new Map,g=new Set,w=[1,0,-1,0],u=[0,1,0,-1];for(let D=n.minX;D<=n.maxX;D++)for(let z=n.minY;z<=n.maxY;z++){let $=D+z*t.width;if(s[$]===n.id)for(let O=0;O<4;O++){let q=D+w[O],K=z+u[O];if(q>=0&&K>=0&&q<t.width&&K<t.height){let J=q+K*t.width;if(s[J]!==n.id&&!g.has(J)){g.add(J),l.add(s[J]);let Y=p.get(s[J]);Y?p.set(s[J],++Y):p.set(s[J],1)}}}}let A=Array.from(l),S=A.map(function(D){return p.get(D)});return{ids:A,lengths:S}}function getBoxIDs(n){let t=new Set,s=n.map,l=s.data;for(let p of[0,n.height-1])for(let g=0;g<n.width;g++){let w=(p+n.minY)*s.width+g+n.minX;if(g-n.minX>0&&l[w]===n.id&&l[w-1]!==n.id){let u=l[w-1];t.add(u)}if(s.width-g-n.minX>1&&l[w]===n.id&&l[w+1]!==n.id){let u=l[w+1];t.add(u)}}for(let p of[0,n.width-1])for(let g=0;g<n.height;g++){let w=(g+n.minY)*s.width+p+n.minX;if(g-n.minY>0&&l[w]===n.id&&l[w-s.width]!==n.id){let u=l[w-s.width];t.add(u)}if(s.height-g-n.minY>1&&l[w]===n.id&&l[w+s.width]!==n.id){let u=l[w+s.width];t.add(u)}}return Array.from(t)}function getBox(n){let t=0,s=n.map,l=s.data,p=[0];n.height>1&&(p[1]=n.height-1);for(let w of p)for(let u=1;u<n.width-1;u++){let A=(w+n.minY)*s.width+u+n.minX;l[A]===n.id&&t++}let g=[0];n.width>1&&(g[1]=n.width-1);for(let w of g)for(let u=0;u<n.height;u++){let A=(u+n.minY)*s.width+w+n.minX;l[A]===n.id&&t++}return t}function getBorder(n){let t=0,s=n.map,l=s.data;for(let p=1;p<n.width-1;p++)for(let g=1;g<n.height-1;g++){let w=(g+n.minY)*s.width+p+n.minX;l[w]===n.id&&(l[w-1]!==n.id||l[w+1]!==n.id||l[w-s.width]!==n.id||l[w+s.width]!==n.id)&&t++}return t+n.box}function getPerimeterInfo(n){let t=n.map,s=t.data,l=0,p=0,g=0,w=0;for(let u=0;u<n.width;u++)for(let A=0;A<n.height;A++){let S=(A+n.minY)*t.width+u+n.minX;if(s[S]===n.id){let D=0;switch((u===0||n.externalIDs.includes(s[S-1]))&&D++,(u===n.width-1||n.externalIDs.includes(s[S+1]))&&D++,(A===0||n.externalIDs.includes(s[S-t.width]))&&D++,(A===n.height-1||n.externalIDs.includes(s[S+t.width]))&&D++,D){case 1:l++;break;case 2:p++;break;case 3:g++;break;case 4:w++;break}}}return{one:l,two:p,three:g,four:w}}function getExternal(n){let t=0,s=n.map,l=s.data;for(let p=1;p<n.width-1;p++)for(let g=1;g<n.height-1;g++){let w=(g+n.minY)*s.width+p+n.minX;l[w]===n.id&&(n.externalIDs.includes(l[w-1])||n.externalIDs.includes(l[w+1])||n.externalIDs.includes(l[w-s.width])||n.externalIDs.includes(l[w+s.width]))&&t++}return t+n.box}function getHolesInfo(n){let t=0,s=n.map.width,l=n.map.data;for(let p=1;p<n.width-1;p++)for(let g=1;g<n.height-1;g++){let w=(g+n.minY)*s+p+n.minX;n.internalIDs.includes(l[w])&&l[w]!==n.id&&t++}return{number:n.internalIDs.length-1,surface:t}}function getInternalIDs(n){let t=[n.id],s=n.map,l=s.data;if(n.height>2)for(let g=0;g<n.width;g++){let w=n.minY*s.width+g+n.minX;if(t.includes(l[w])){let u=l[w+s.width];!t.includes(u)&&!n.boxIDs.includes(u)&&t.push(u)}}let p=new Array(4);for(let g=1;g<n.width-1;g++)for(let w=1;w<n.height-1;w++){let u=(w+n.minY)*s.width+g+n.minX;if(t.includes(l[u])){p[0]=l[u-1],p[1]=l[u+1],p[2]=l[u-s.width],p[3]=l[u+s.width];for(let A=0;A<4;A++){let S=p[A];!t.includes(S)&&!n.boxIDs.includes(S)&&t.push(S)}}}return t}class RoiLayer{constructor(t,s){this.roiMap=t,this.options=s,this.roi=this.createRoi()}createRoi(){let t=this.roiMap.data,s={};this.roiMap.positive=0,this.roiMap.negative=0;for(let u=0;u<t.length;u++)t[u]&&!s[t[u]]&&(s[t[u]]=!0,t[u]>0?this.roiMap.positive++:this.roiMap.negative++);let l={};for(let u in s)l[u]=new Roi(this.roiMap,u*1);let p=this.roiMap.width,g=this.roiMap.height;for(let u=0;u<g;u++)for(let A=0;A<p;A++){let S=u*p+A;if(t[S]!==0){const D=t[S],z=l[D];A<z.minX&&(z.minX=A),A>z.maxX&&(z.maxX=A),u<z.minY&&(z.minY=u),u>z.maxY&&(z.maxY=u),z.meanX+=A,z.meanY+=u,z.surface++}}let w=[];for(let u in s)l[u].meanX/=l[u].surface,l[u].meanY/=l[u].surface,w.push(l[u]);return w}}function commonBorderLength(n){let t=n.data,s=[1,0,-1,0],l=[0,1,0,-1],p=n.minMax,g=-p.min,w=p.max+g,u=[];for(let S=0;S<=w;S++)u.push(Object.create(null));for(let S=0;S<n.width;S++)for(let D=0;D<n.height;D++){let z=S+D*n.width,$=t[z];if($!==0){let O=Object.create(null),q=!1;for(let K=0;K<4;K++){let J=S+s[K],Y=D+l[K];if(J>=0&&Y>=0&&J<n.width&&Y<n.height){let fe=t[J+Y*n.width];$!==fe&&(q=!0,fe!==0&&O[fe]===void 0&&(O[fe]=!0,u[fe+g][$]?u[fe+g][$]++:u[fe+g][$]=1))}else q=!0}q&&(u[$+g][$]?u[$+g][$]++:u[$+g][$]=1)}}let A={};for(let S=0;S<u.length;S++)Object.keys(u[S]).length>0&&(A[S-g]=u[S]);return A}function mergeRoi(n={}){const{algorithm:t="commonBorderLength",minCommonBorderLength:s=5,maxCommonBorderLength:l=100,minCommonBorderRatio:p=.3,maxCommonBorderRatio:g=1}=n;let w=function(J,Y,fe){return J[fe]>=s&&J[fe]<=l};typeof t=="function"&&(w=t),t.toLowerCase()==="commonborderratio"&&(w=function(J,Y,fe){let ee=Math.min(J[fe]/J[Y],1);return ee>=p&&ee<=g});const u=this,A=u.commonBorderLength;let S={},D={};for(let J of Object.keys(A)){let Y=A[J],fe=Object.keys(Y);for(let ee of fe)if(ee!==J&&w(Y,J,ee)){let re=ee;D[ee]&&(re=D[ee]);let he=J;if(D[J]&&(he=D[J]),Number(re)!==he){let _e=Math.min(re,he),we=Math.max(re,he);if(S[_e]||(S[_e]={}),S[_e][we]=!0,D[we]=_e,S[we]){for(let oe of Object.keys(S[we]))S[_e][oe]=!0,D[oe]=_e;delete S[we]}}}}let z=u.minMax,$=-z.min,O=z.max+$,q=new Array(O+1).fill(0);for(let J of Object.keys(D))q[Number(J)+$]=D[J];let K=u.data;for(let J=0;J<K.length;J++){let Y=K[J];if(Y!==0){let fe=q[Y+$];fe!==0&&(K[J]=fe)}}return u.computed={},u}class RoiMap{constructor(t,s){this.parent=t,this.width=t.width,this.height=t.height,this.data=s,this.negative=0,this.positive=0}get total(){return this.negative+this.positive}get minMax(){let t=Number.MAX_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;for(let l=0;l<this.data.length;l++)this.data[l]<t&&(t=this.data[l]),this.data[l]>s&&(s=this.data[l]);return{min:t,max:s}}get commonBorderLength(){return commonBorderLength(this)}mergeRoi(t={}){return mergeRoi.call(this,t)}mergeRois(t){const s=t[0],l=t.slice(1);for(let p=0;p<this.data.length;p++)l.includes(this.data[p])&&(this.data[p]=s)}rowsInfo(){let t=new Array(this.height),s=0;for(let l=0;l<this.data.length;l+=this.width){let p={row:s,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};t[s++]=p;let g={},w={},u=[],A=this.data[l],S=0;for(let D=l;D<l+this.width;D++){let z=this.data[D];A!==z&&(A=z,u.push(S),S=0),S++,z>0?(p.positivePixel++,g[z]||(g[z]=!0)):z<0?(p.negativePixel++,w[z]||(w[z]=!0)):p.zeroPixel++}u.push(S),p.medianChange=u.sort((D,z)=>D-z)[Math.floor(u.length/2)],p.positiveRoiIDs=Object.keys(g),p.negativeRoiIDs=Object.keys(w),p.positiveRoi=p.positiveRoiIDs.length,p.negativeRoi=p.negativeRoiIDs.length}return t}colsInfo(){let t=new Array(this.width),s=0;for(let l=0;l<this.width;l++){let p={col:s,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};t[s++]=p;let g={},w={},u=[],A=this.data[l],S=0;for(let D=l;D<l+this.data.length;D+=this.width){let z=this.data[D];A!==z&&(A=z,u.push(S),S=0),S++,z>0?(p.positivePixel++,g[z]||(g[z]=!0)):z<0?(p.negativePixel++,w[z]||(w[z]=!0)):p.zeroPixel++}u.push(S),p.medianChange=u.sort((D,z)=>D-z)[Math.floor(u.length/2)],p.positiveRoiIDs=Object.keys(g),p.negativeRoiIDs=Object.keys(w),p.positiveRoi=p.positiveRoiIDs.length,p.negativeRoi=p.negativeRoiIDs.length}return t}}function fromMask(n,t={}){const{allowCorners:s=!1}=t,l=65535;let p=new Int16Array(n.size),g=0,w=0,u=new Uint16Array(l+1),A=new Uint16Array(l+1);for(let D=0;D<n.width;D++)for(let z=0;z<n.height;z++)p[z*n.width+D]===0&&S(D,z);function S(D,z){let $=0,O=0,q=n.getBitXY(D,z),K=q?++g:--w;if(g>32767||w<-32768)throw new Error("Too many regions of interest");for(u[0]=D,A[0]=z;$<=O;){let J=u[$&l],Y=A[$&l];if(p[Y*n.width+J]=K,J>0&&p[Y*n.width+J-1]===0&&n.getBitXY(J-1,Y)===q&&(O++,u[O&l]=J-1,A[O&l]=Y,p[Y*n.width+J-1]=-32768),Y>0&&p[(Y-1)*n.width+J]===0&&n.getBitXY(J,Y-1)===q&&(O++,u[O&l]=J,A[O&l]=Y-1,p[(Y-1)*n.width+J]=-32768),J<n.width-1&&p[Y*n.width+J+1]===0&&n.getBitXY(J+1,Y)===q&&(O++,u[O&l]=J+1,A[O&l]=Y,p[Y*n.width+J+1]=-32768),Y<n.height-1&&p[(Y+1)*n.width+J]===0&&n.getBitXY(J,Y+1)===q&&(O++,u[O&l]=J,A[O&l]=Y+1,p[(Y+1)*n.width+J]=-32768),s&&(J>0&&Y>0&&p[(Y-1)*n.width+J-1]===0&&n.getBitXY(J-1,Y-1)===q&&(O++,u[O&l]=J-1,A[O&l]=Y-1,p[(Y-1)*n.width+J-1]=-32768),J<n.width-1&&Y>0&&p[(Y-1)*n.width+J+1]===0&&n.getBitXY(J+1,Y-1)===q&&(O++,u[O&l]=J+1,A[O&l]=Y-1,p[(Y-1)*n.width+J+1]=-32768),J>0&&Y<n.height-1&&p[(Y+1)*n.width+J-1]===0&&n.getBitXY(J-1,Y+1)===q&&(O++,u[O&l]=J-1,A[O&l]=Y+1,p[(Y+1)*n.width+J-1]=-32768),J<n.width-1&&Y<n.height-1&&p[(Y+1)*n.width+J+1]===0&&n.getBitXY(J+1,Y+1)===q&&(O++,u[O&l]=J+1,A[O&l]=Y+1,p[(Y+1)*n.width+J+1]=-32768)),$++,O-$>l)throw new Error("analyseMask can not finish, the array to manage internal data is not big enough.You could improve mask by changing MAX_ARRAY")}}return new RoiMap(n,p)}class DisjointSet{constructor(){this.nodes=new Map}add(t){var s=this.nodes.get(t);return s||(s=new DisjointSetNode(t),this.nodes.set(t,s)),s}union(t,s){const l=this.find(t),p=this.find(s);l!==p&&(l.rank<p.rank?l.parent=p:l.rank>p.rank?p.parent=l:(p.parent=l,l.rank++))}find(t){for(var s=t;s.parent!==null;)s=s.parent;for(var l=t;l.parent!==null;){var p=l;l=l.parent,p.parent=s}return s}connected(t,s){return this.find(t)===this.find(s)}}var DisjointSet_1=DisjointSet;function DisjointSetNode(n){this.value=n,this.parent=null,this.rank=0}var DisjointSet$1=DisjointSet_1;const direction4X=[-1,0],direction4Y=[0,-1],neighbours4=[null,null],direction8X=[-1,-1,0,1],direction8Y=[0,-1,-1,-1],neighbours8=[null,null,null,null];function fromMaskConnectedComponentLabelingAlgorithm(n,t={}){const{allowCorners:s=!1}=t;let l=4;s&&(l=8);let p,g,w;if(l===8)p=direction8X,g=direction8Y,w=neighbours8;else if(l===4)p=direction4X,g=direction4Y,w=neighbours4;else throw new RangeError(`unsupported neighbours count: ${l}`);const u=n.size,A=n.width,S=n.height,D=new Array(u),z=new Uint32Array(u),$=new DisjointSet$1;let O=1;for(let q=0;q<S;q++)for(let K=0;K<A;K++){const J=K+q*A;if(n.getBit(J)){let Y=null;for(let fe=0;fe<w.length;fe++){const ee=K+p[fe],re=q+g[fe];if(ee>=0&&re>=0&&ee<A&&re<S){const he=ee+re*A;let _e=D[he];_e?(w[fe]=_e,(!Y||w[fe].value<Y.value)&&(Y=w[fe])):w[fe]=null}}if(!Y)D[J]=$.add(O++);else{D[J]=Y;for(let fe=0;fe<w.length;fe++)w[fe]&&w[fe]!==Y&&$.union(Y,w[fe])}}}for(let q=0;q<S;q++)for(let K=0;K<A;K++){const J=K+q*A;n.getBit(J)&&(z[J]=$.find(D[J]).value)}return new RoiMap(n,z)}function fromMaxima(n={}){let{allowCorner:t=!0,onlyTop:s=!1,invert:l=!1}=n,p=this;p.checkProcessable("fromMaxima",{components:[1]});const g=1,w=2;let u=0,A=0,S=new Int16Array(p.size),D=new Int8Array(p.size),z=new Float32Array(p.size),$=1048575,O=new Uint16Array($+1),q=new Uint16Array($+1),K=0,J=0,Y=new Uint16Array($+1),fe=new Uint16Array($+1),ee=0,re=0;for(he(p);K<J;){let oe=O[K&$],be=q[K&$];we(oe,be,w),K++}return new RoiMap(p,S);function he({maxima:oe=!0}){for(let be=1;be<p.height-1;be++)for(let ie=1;ie<p.width-1;ie++){let ue=ie+be*p.width;if(D[ue]===0){let Ce=oe?p.data[ue]:-p.data[ie+be*p.width];if(p.data[be*p.width+ie-1]>Ce||p.data[be*p.width+ie+1]>Ce||p.data[(be-1)*p.width+ie]>Ce||p.data[(be+1)*p.width+ie]>Ce||t&&(p.data[(be-1)*p.width+ie-1]>Ce||p.data[(be-1)*p.width+ie+1]>Ce||p.data[(be+1)*p.width+ie-1]>Ce||p.data[(be+1)*p.width+ie+1]>Ce))continue;S[ue]=oe?++u:--A,_e(ie,be)||(oe?--u:++A)}}}function _e(oe,be){let ie=J;ee=0,re=1,Y[0]=oe,fe[0]=be;let ue=!0;for(;ee<re;){let Ce=Y[ee&$],Ne=fe[ee&$];ue&=we(Ce,Ne,g),ee++}if(!ue){for(let Ce=0;Ce<re;Ce++){let Ne=Y[Ce&$],rt=fe[Ce&$]*p.width+Ne;S[rt]=0}J=ie}return ue}function we(oe,be,ie){let ue=S[be*p.width+oe],Ce=p.data[be*p.width+oe];for(let Ne=be-1;Ne<=be+1;Ne++)for(let it=oe-1;it<=oe+1;it++){let rt=Ne*p.width+it;if(D[rt]===0)switch(D[rt]=1,z[rt]=p.data[rt]-Ce,ie){case g:if(z[rt]===0){if(it===0||Ne===0||it===p.width-1||Ne===p.height-1)return!1;S[rt]=ue,Y[re&$]=it,fe[re&$]=Ne,re++}else{if(z[rt]>0)return!1;s||(S[rt]=ue,O[J&$]=it,q[J&$]=Ne,J++)}break;case w:z[rt]<=0&&(S[rt]=ue,O[J&$]=it,q[J&$]=Ne,J++);break;default:throw new Error("unreachable")}}return!0}}function fromPoints(n,t={}){let s=new Shape(t),l=new Int16Array(this.size),p=0,g=s.getPoints();for(let w=0;w<n.length;w++){p++;let u=n[w][0],A=n[w][1];for(let S=0;S<g.length;S++){let D=g[S][0],z=g[S][1];u+D>=0&&A+z>=0&&u+D<this.width&&A+z<this.height&&(l[u+D+(A+z)*this.width]=p)}}return new RoiMap(this,l)}var priorityQueue={exports:{}};(function(n,t){(function(s){n.exports=s()})(function(){return function s(l,p,g){function w(S,D){if(!p[S]){if(!l[S]){var z=typeof commonjsRequire=="function"&&commonjsRequire;if(!D&&z)return z(S,!0);if(u)return u(S,!0);var $=new Error("Cannot find module '"+S+"'");throw $.code="MODULE_NOT_FOUND",$}var O=p[S]={exports:{}};l[S][0].call(O.exports,function(q){var K=l[S][1][q];return w(K||q)},O,O.exports,s,l,p,g)}return p[S].exports}for(var u=typeof commonjsRequire=="function"&&commonjsRequire,A=0;A<g.length;A++)w(g[A]);return w}({1:[function(s,l,p){var g,w,u,A,S,D=function($,O){for(var q in O)z.call(O,q)&&($[q]=O[q]);function K(){this.constructor=$}return K.prototype=O.prototype,$.prototype=new K,$.__super__=O.prototype,$},z={}.hasOwnProperty;g=s("./PriorityQueue/AbstractPriorityQueue"),w=s("./PriorityQueue/ArrayStrategy"),A=s("./PriorityQueue/BinaryHeapStrategy"),u=s("./PriorityQueue/BHeapStrategy"),S=function($){D(O,$);function O(q){q||(q={}),q.strategy||(q.strategy=A),q.comparator||(q.comparator=function(K,J){return(K||0)-(J||0)}),O.__super__.constructor.call(this,q)}return O}(g),S.ArrayStrategy=w,S.BinaryHeapStrategy=A,S.BHeapStrategy=u,l.exports=S},{"./PriorityQueue/AbstractPriorityQueue":2,"./PriorityQueue/ArrayStrategy":3,"./PriorityQueue/BHeapStrategy":4,"./PriorityQueue/BinaryHeapStrategy":5}],2:[function(s,l,p){l.exports=function(){function g(w){var u;if((w!=null?w.strategy:void 0)==null)throw"Must pass options.strategy, a strategy";if((w!=null?w.comparator:void 0)==null)throw"Must pass options.comparator, a comparator";this.priv=new w.strategy(w),this.length=(w!=null&&(u=w.initialValues)!=null?u.length:void 0)||0}return g.prototype.queue=function(w){this.length++,this.priv.queue(w)},g.prototype.dequeue=function(w){if(!this.length)throw"Empty queue";return this.length--,this.priv.dequeue()},g.prototype.peek=function(w){if(!this.length)throw"Empty queue";return this.priv.peek()},g.prototype.clear=function(){return this.length=0,this.priv.clear()},g}()},{}],3:[function(s,l,p){var g;g=function(w,u,A){var S,D,z;for(D=0,S=w.length;D<S;)z=D+S>>>1,A(w[z],u)>=0?D=z+1:S=z;return D},l.exports=function(){function w(u){var A;this.options=u,this.comparator=this.options.comparator,this.data=((A=this.options.initialValues)!=null?A.slice(0):void 0)||[],this.data.sort(this.comparator).reverse()}return w.prototype.queue=function(u){var A;A=g(this.data,u,this.comparator),this.data.splice(A,0,u)},w.prototype.dequeue=function(){return this.data.pop()},w.prototype.peek=function(){return this.data[this.data.length-1]},w.prototype.clear=function(){this.data.length=0},w}()},{}],4:[function(s,l,p){l.exports=function(){function g(w){var u,A,S,D,z,$,O,q;for(this.comparator=(w!=null?w.comparator:void 0)||function(K,J){return K-J},this.pageSize=(w!=null?w.pageSize:void 0)||512,this.length=0,O=0;1<<O<this.pageSize;)O+=1;if(1<<O!==this.pageSize)throw"pageSize must be a power of two";for(this._shift=O,this._emptyMemoryPageTemplate=u=[],A=0,z=this.pageSize;0<=z?A<z:A>z;0<=z?++A:--A)u.push(null);if(this._memory=[],this._mask=this.pageSize-1,w.initialValues)for($=w.initialValues,S=0,D=$.length;S<D;S++)q=$[S],this.queue(q)}return g.prototype.queue=function(w){this.length+=1,this._write(this.length,w),this._bubbleUp(this.length,w)},g.prototype.dequeue=function(){var w,u;return w=this._read(1),u=this._read(this.length),this.length-=1,this.length>0&&(this._write(1,u),this._bubbleDown(1,u)),w},g.prototype.peek=function(){return this._read(1)},g.prototype.clear=function(){this.length=0,this._memory.length=0},g.prototype._write=function(w,u){var A;for(A=w>>this._shift;A>=this._memory.length;)this._memory.push(this._emptyMemoryPageTemplate.slice(0));return this._memory[A][w&this._mask]=u},g.prototype._read=function(w){return this._memory[w>>this._shift][w&this._mask]},g.prototype._bubbleUp=function(w,u){var A,S,D,z;for(A=this.comparator;w>1&&(S=w&this._mask,w<this.pageSize||S>3?D=w&~this._mask|S>>1:S<2?(D=w-this.pageSize>>this._shift,D+=D&~(this._mask>>1),D|=this.pageSize>>1):D=w-2,z=this._read(D),!(A(z,u)<0));)this._write(D,u),this._write(w,z),w=D},g.prototype._bubbleDown=function(w,u){var A,S,D,z,$;for($=this.comparator;w<this.length;)if(w>this._mask&&!(w&this._mask-1)?A=S=w+2:w&this.pageSize>>1?(A=(w&~this._mask)>>1,A|=w&this._mask>>1,A=A+1<<this._shift,S=A+1):(A=w+(w&this._mask),S=A+1),A!==S&&S<=this.length)if(D=this._read(A),z=this._read(S),$(D,u)<0&&$(D,z)<=0)this._write(A,u),this._write(w,D),w=A;else if($(z,u)<0)this._write(S,u),this._write(w,z),w=S;else break;else if(A<=this.length)if(D=this._read(A),$(D,u)<0)this._write(A,u),this._write(w,D),w=A;else break;else break},g}()},{}],5:[function(s,l,p){l.exports=function(){function g(w){var u;this.comparator=(w!=null?w.comparator:void 0)||function(A,S){return A-S},this.length=0,this.data=((u=w.initialValues)!=null?u.slice(0):void 0)||[],this._heapify()}return g.prototype._heapify=function(){var w,u,A;if(this.data.length>0)for(w=u=1,A=this.data.length;1<=A?u<A:u>A;w=1<=A?++u:--u)this._bubbleUp(w)},g.prototype.queue=function(w){this.data.push(w),this._bubbleUp(this.data.length-1)},g.prototype.dequeue=function(){var w,u;return u=this.data[0],w=this.data.pop(),this.data.length>0&&(this.data[0]=w,this._bubbleDown(0)),u},g.prototype.peek=function(){return this.data[0]},g.prototype.clear=function(){this.length=0,this.data.length=0},g.prototype._bubbleUp=function(w){for(var u,A;w>0&&(u=w-1>>>1,this.comparator(this.data[w],this.data[u])<0);)A=this.data[u],this.data[u]=this.data[w],this.data[w]=A,w=u},g.prototype._bubbleDown=function(w){var u,A,S,D,z;for(u=this.data.length-1;A=(w<<1)+1,D=A+1,S=w,A<=u&&this.comparator(this.data[A],this.data[S])<0&&(S=A),D<=u&&this.comparator(this.data[D],this.data[S])<0&&(S=D),S!==w;)z=this.data[S],this.data[S]=this.data[w],this.data[w]=z,w=S},g}()},{}]},{},[1])(1)})})(priorityQueue);var PriorityQueue=priorityQueue.exports;const dxs=[1,0,-1,0,1,1,-1,-1],dys=[0,1,0,-1,1,-1,1,-1];function fromWaterShed(n={}){let{points:t,mask:s,image:l,fillMaxValue:p=this.maxValue,invert:g=!1}=n,w=l||this;w.checkProcessable("fromWaterShed",{bitDepth:[8,16],components:1}),g=!g,t||(t=w.getLocalMaxima({invert:g,mask:s}));let u=g?0:1,A=new Int16Array(w.size),S=w.width,D=w.height,z=new PriorityQueue({comparator:($,O)=>$[2]-O[2],strategy:PriorityQueue.BinaryHeapStrategy});for(let $=0;$<t.length;$++){let O=t[$][0]+t[$][1]*S;A[O]=$+1;let q=w.data[O];(g&&q<=p||!g&&q>=p)&&z.queue([t[$][0],t[$][1],q])}for(;z.length>0;){let $=z.dequeue(),O=$[0]+$[1]*S;for(let q=0;q<4;q++){let K=$[0]+dxs[q],J=$[1]+dys[q];if(K>=0&&J>=0&&K<S&&J<D){let Y=K+J*S;if(!s||s.getBit(Y)===u){let fe=w.data[Y];(g&&fe<=p||!g&&fe>=p)&&A[Y]===0&&(A[Y]=A[O],z.queue([$[0]+dxs[q],$[1]+dys[q],fe]))}}}}return new RoiMap(w,A)}class RoiManager{constructor(t,s={}){this._image=t,this._options=s,this._options.label||(this._options.label="default"),this._layers={},this._painted=null}fromMaxima(t={}){let s=Object.assign({},this._options,t),l=fromMaxima.call(this._image,t);this._layers[s.label]=new RoiLayer(l,s)}fromPoints(t,s={}){let l=Object.assign({},this._options,s),p=fromPoints.call(this._image,t,s);return this._layers[l.label]=new RoiLayer(p,l),this}putMap(t,s={}){let l=new RoiMap(this._image,t),p=Object.assign({},this._options,s);return this._layers[p.label]=new RoiLayer(l,p),this}fromWaterShed(t={}){let s=Object.assign({},this._options,t),l=fromWaterShed.call(this._image,t);this._layers[s.label]=new RoiLayer(l,s)}fromMask(t,s={}){let l=Object.assign({},this._options,s),p=fromMask.call(this._image,t,s);return this._layers[l.label]=new RoiLayer(p,l),this}fromMaskConnectedComponentLabelingAlgorithm(t,s={}){let l=Object.assign({},this._options,s),p=fromMaskConnectedComponentLabelingAlgorithm.call(this._image,t,s);return this._layers[l.label]=new RoiLayer(p,l),this}getMap(t={}){let s=Object.assign({},this._options,t);return this._assertLayerWithLabel(s.label),this._layers[s.label].roiMap}rowsInfo(t={}){return this.getMap(t).rowsInfo()}colsInfo(t={}){return this.getMap(t).rowsInfo()}getRoiIds(t={}){let s=this.getRois(t);if(s){let l=new Array(s.length);for(let p=0;p<s.length;p++)l[p]=s[p].id;return l}throw new Error("ROIs not found")}getRois(t={}){let{label:s=this._options.label,positive:l=!0,negative:p=!0,minSurface:g=0,maxSurface:w=Number.POSITIVE_INFINITY,minWidth:u=0,maxWidth:A=Number.POSITIVE_INFINITY,minHeight:S=0,maxHeight:D=Number.POSITIVE_INFINITY,minRatio:z=0,maxRatio:$=Number.POSITIVE_INFINITY}=t;if(!this._layers[s])throw new Error(`this Roi layer (${s}) does not exist`);const O=this._layers[s].roi,q=[];for(const K of O)(K.id<0&&p||K.id>0&&l)&&K.surface>=g&&K.surface<=w&&K.width>=u&&K.width<=A&&K.height>=S&&K.height<=D&&K.ratio>=z&&K.ratio<=$&&q.push(K);return q}getRoi(t,s={}){const{label:l=this._options.label}=s;if(!this._layers[l])throw new Error(`this Roi layer (${l}) does not exist`);const p=this._layers[l].roi.find(g=>g.id===t);if(!p)throw new Error(`found no Roi with id ${t}`);return p}getMasks(t={}){let s=this.getRois(t),l=new Array(s.length);for(let p=0;p<s.length;p++)l[p]=s[p].getMask(t);return l}getAnalysisMasks(t={}){const{analysisProperty:s}=t;let l=`${s}Mask`,p=this.getRois(t);return p.length===0||!p[0][l]?[]:p.map(g=>g[l])}getData(t={}){let s=Object.assign({},this._options,t);return this._assertLayerWithLabel(s.label),this._layers[s.label].roiMap.data}paint(t={}){let{labelProperty:s,analysisProperty:l}=t;this._painted||(this._painted=this._image.rgba8());let p=this.getMasks(t);if(s){const g=this.getRois(t);t.labels=g.map(S=>deepValue(S,s));const w=Math.max(...t.labels);let u=!1,A=!1;if(s.includes("surface")?u=!0:/(?:perimeter|min|max|external|width|height|length)/.test(s)&&(A=!0),isFinite(w)){let S="";if(t.unit!=="pixel"&&t.pixelSize&&(A||u)){S=u?`${t.unit}^2`:t.unit;let D=u?"m^2":"m",z=u?t.pixelSize**2:t.pixelSize;const $=Qty.swiftConverter(D,S);t.labels=t.labels.map(O=>$(z*O))}w>50?t.labels=t.labels.map(D=>Math.round(D)+S):w>10?t.labels=t.labels.map(D=>D.toFixed(1)+S):t.labels=t.labels.map(D=>D.toFixed(2)+S)}t.labelsPosition=g.map(S=>[S.meanX,S.meanY])}if(this._painted.paintMasks(p,t),l){let g=this.getAnalysisMasks(t);this._painted.paintMasks(g,{color:t.analysisColor,alpha:t.analysisAlpha})}return this._painted}getMask(t={}){let s=new Image$1(this._image.width,this._image.height,{kind:"BINARY"}),l=this.getMasks(t);for(let p=0;p<l.length;p++){let g=l[p];for(let w=0;w<g.width;w++)for(let u=0;u<g.height;u++)g.getBitXY(w,u)&&s.setBitXY(w+g.position[0],u+g.position[1])}return s}resetPainted(t={}){const{image:s}=t;s?this._painted=this.image.rgba8():this._painted=this._image.rgba8()}mergeRoi(t={}){const s=this.getMap(t);return s.mergeRoi(t),this.putMap(s.data,t),this}mergeRois(t,s={}){if(!Array.isArray(t)||t.some(p=>!Number.isInteger(p)))throw new Error("Roi ids must be an array of integers");if(t.length<2)throw new Error("Roi ids must have at least two elements");if(new Set(t).size!==t.length)throw new Error("Roi ids must be all different");t.forEach(p=>this.getRoi(p));const l=this.getMap(s);return l.mergeRois(t),this.putMap(l.data,s),this}findCorrespondingRoi(t,s={}){let l=this.getRois(s),p=[];for(let g=0;g<l.length;g++){let w=l[g],u=w.minX,A=w.minY,S=w.points,D=Math.sign(w.id),z=correspondingRoisInformation(u,A,S,t,D);p.push(z)}return p}_assertLayerWithLabel(t){if(!this._layers[t])throw new Error(`no layer with label ${t}`)}}function correspondingRoisInformation(n,t,s,l,p){let g={id:[],surface:[],roiSurfaceCovered:[],same:0,opposite:0,total:0};for(let w=0;w<s.length;w++){let u=s[w],A=u[0],S=u[1],D=A+n+(S+t)*l.width,z=l.data[D];(z>0||z<0)&&(g.id.includes(z)?g.surface[g.id.indexOf(z)]+=1:(g.id.push(z),g.surface.push(1)))}for(let w=0;w<g.id.length;w++)Math.sign(g.id[w])===p?g.same+=g.surface[w]:g.opposite+=g.surface[w],g.roiSurfaceCovered[w]=g.surface[w]/s.length;return g.total=g.opposite+g.same,g}const objectToString$1=Object.prototype.toString;class Image$1{constructor(t,s,l,p){if(arguments.length===1?(p=t,{width:t,height:s,data:l}=p):l&&!l.length&&(p=l,{data:l}=p),t===void 0&&(t=1),s===void 0&&(s=1),p===void 0&&(p={}),typeof p!="object"||p===null)throw new TypeError("options must be an object");if(!Number.isInteger(t)||t<=0)throw new RangeError("width must be a positive integer");if(!Number.isInteger(s)||s<=0)throw new RangeError("height must be a positive integer");const{kind:g=RGBA}=p;if(typeof g!="string")throw new TypeError("kind must be a string");const w=getKind(g),u=Object.assign({},p);for(const K in w)u[K]===void 0&&(u[K]=w[K]);verifyKindDefinition(u);const{components:A,bitDepth:S,colorModel:D}=u,z=u.alpha+0,$=t*s,O=A+z,q=S===32?Number.MAX_VALUE:2**S-1;if(l===void 0)l=createPixelArray($,A,z,O,S,q);else{const K=getTheoreticalPixelArraySize($,O,S);if(l.length!==K)throw new RangeError(`incorrect data size: ${l.length}. Should be ${K}`)}this.width=t,this.height=s,this.data=l,this.size=$,this.components=A,this.alpha=z,this.bitDepth=S,this.maxValue=q,this.colorModel=D,this.channels=O,this.meta=p.meta||{},Object.defineProperty(this,"parent",{enumerable:!1,writable:!0,configurable:!0,value:p.parent||null}),this.position=p.position||[0,0],this.computed=null,this.sizes=[this.width,this.height],this.multiplierX=this.channels,this.multiplierY=this.channels*this.width,this.isClamped=this.bitDepth<32,this.borderSizes=[0,0]}get[Symbol.toStringTag](){return"IJSImage"}static isImage(t){return objectToString$1.call(t)==="[object IJSImage]"}static fromCanvas(t){const l=t.getContext("2d").getImageData(0,0,t.width,t.height);return new Image$1(l.width,l.height,l.data)}static createFrom(t,s){const l=getImageParameters(t);return Object.assign(l,{parent:t,position:[0,0]},s),new Image$1(l)}getRoiManager(t){return new RoiManager(this,t)}clone(){const t=this.data.slice();return new Image$1(this.width,this.height,t,this)}apply(t){for(let s=0;s<this.height;s++)for(let l=0;l<this.width;l++){let p=(s*this.width+l)*this.channels;t.call(this,p)}}}setValueMethods(Image$1);setBitMethods(Image$1);setExportMethods(Image$1);Image$1.prototype.checkProcessable=checkProcessable;Image$1.prototype.getRGBAData=getRGBAData;Image$1.load=load;Image$1.extendMethod=extendMethod;Image$1.extendProperty=extendProperty;extend$4(Image$1);var workerTemplate$1={},worker$1=function(){self.window=self;function n(){this._listeners={}}n.prototype.on=function(s,l){if(this._listeners[s])throw new RangeError("there is already a listener for "+s);if(typeof l!="function")throw new TypeError("callback argument must be a function");this._listeners[s]=l},n.prototype._send=function(s,l,p){p===void 0?p=[]:Array.isArray(p)||(p=[p]),self.postMessage({id:s,data:l},p)},n.prototype._trigger=function(s,l){if(!this._listeners[s])throw new Error("event "+s+" is not defined");this._listeners[s].apply(null,l)};var t=new n;self.onmessage=function(s){switch(s.data.action){case"exec":s.data.args.unshift(function(l,p){t._send(s.data.id,l,p)}),t._trigger(s.data.event,s.data.args);break;case"ping":t._send(s.data.id,"pong");break;default:throw new Error("unexpected action: "+s.data.action)}}},workerStr=worker$1.toString().split('"CODE";');workerTemplate$1.newWorkerURL=function n(t,s){var l=new Blob(["(",workerStr[0],"importScripts.apply(self, "+JSON.stringify(s)+`);
`,"(",t,")();",workerStr[1],")();"],{type:"application/javascript"});return URL.createObjectURL(l)};var workerTemplate=workerTemplate$1,CORES=navigator.hardwareConcurrency||1;function WorkerManager(n,t){if(typeof n!="string"&&typeof n!="function")throw new TypeError("func argument must be a function");if(t===void 0&&(t={}),typeof t!="object"||t===null)throw new TypeError("options argument must be an object");this._workerCode=n.toString(),t.maxWorkers===void 0||t.maxWorkers==="auto"?this._numWorkers=Math.min(CORES-1,1):t.maxWorkers>0?this._numWorkers=Math.min(t.maxWorkers,CORES):this._numWorkers=CORES,this._workers=new Map,this._timeout=t.timeout||0,this._terminateOnError=!!t.terminateOnError;var s=t.deps;typeof s=="string"&&(s=[s]),Array.isArray(s)||(s=void 0),this._id=0,this._terminated=!1,this._working=0,this._waiting=[],this._init(s)}WorkerManager.prototype._init=function(n){for(var t=workerTemplate.newWorkerURL(this._workerCode,n),s=0;s<this._numWorkers;s++){var l=new Worker(t);l.onmessage=this._onmessage.bind(this,l),l.onerror=this._onerror.bind(this,l),l.running=!1,l.id=s,this._workers.set(l,null)}URL.revokeObjectURL(t)};WorkerManager.prototype._onerror=function(n,t){if(!this._terminated){this._working--,n.running=!1;var s=this._workers.get(n);s&&s[1](t.message),this._workers.set(n,null),this._terminateOnError?this.terminate():this._exec()}};WorkerManager.prototype._onmessage=function(n,t){if(!this._terminated){this._working--,n.running=!1;var s=this._workers.get(n);s&&s[0](t.data.data),this._workers.set(n,null),this._exec()}};WorkerManager.prototype._exec=function(){for(var n of this._workers.keys()){if(this._working===this._numWorkers||this._waiting.length===0)return;if(!n.running)for(var t=0;t<this._waiting.length;t++){var s=this._waiting[t];if(!(typeof s[4]=="number"&&s[4]!==n.id)){this._waiting.splice(t,1),n.postMessage({action:"exec",event:s[0],args:s[1]},s[2]),n.running=!0,n.time=Date.now(),this._workers.set(n,s[3]),this._working++;break}}}};WorkerManager.prototype.terminate=function(){if(!this._terminated){for(var n of this._workers)n[0].terminate(),n[1]&&n[1][1](new Error("Terminated"));this._workers.clear(),this._waiting=[],this._working=0,this._terminated=!0}};WorkerManager.prototype.postAll=function(n,t){if(this._terminated)throw new Error("Cannot post (terminated)");var s=[];for(var l of this._workers.keys())s.push(this.post(n,t,[],l.id));return Promise.all(s)};WorkerManager.prototype.post=function(n,t,s,l){t===void 0&&(t=[]),s===void 0&&(s=[]),Array.isArray(t)||(t=[t]),Array.isArray(s)||(s=[s]);var p=this;return new Promise(function(g,w){if(p._terminated)throw new Error("Cannot post (terminated)");p._waiting.push([n,t,s,[g,w],l]),p._exec()})};var src=WorkerManager;const defaultOptions={regression:{kernelType:"polynomial",kernelOptions:{degree:2,constant:1}},threshold:.02,roi:{minSurface:100,positive:!1},sampling:20,include:[]};function run(n,t,s){t=Object.assign({},defaultOptions,t);const l=this.manager;return Array.isArray(n)?Promise.all(n.map(function(p){const g=runOnce(l,p,t);return typeof s=="function"&&g.then(s),g})):runOnce(l,n,t)}function runOnce(n,t,s){return n.post("data",[t,s]).then(function(l){for(let p in l)l[p]=new Image$1(l[p]);return l})}function work(){worker.on("data",function(n,t,s){t=new IJS(t);const l={},p=[],g=t.grey(),w=g.sobelFilter();O("sobel",w);const u=w.level().mask({threshold:s.threshold});O("mask",u);const A=w.getRoiManager();A.fromMask(u);const S=A.getMask(s.roi);O("realMask",S);const D=g.getPixelsGrid({sampling:s.sampling,mask:S}),z=t.getBackground(D.xyS,D.zS,s.regression);O("background",z);const $=t.subtract(z);l.result=$,p.push($.data.buffer),n(l,p);function O(q,K){s.include.includes(q)&&(l[q]=K,p.push(K.data.buffer))}})}const background={run,work};function extend$3(n){n.extendMethod("background",background)}class Worker$1{constructor(){this._url=null,this._deps=[null]}checkUrl(){if(this._url===null)throw new Error("image worker must be initialized with an URL")}get url(){return this._url}set url(t){if(typeof t!="string")throw new TypeError("worker URL must be a string");this._url=t,this._deps[0]=t}static extendMethod(t,s){let l,p,g={};function w(...u){return l||(this.checkUrl(),p=this.url,l=new src(s.work,{deps:p}),g.manager=l),s.run.call(g,...u)}w.reset=function(){l&&(l.terminate(),l=new src(s.work,{deps:p}),g.manager=l)},Worker$1.prototype[t]=w}}extend$3(Worker$1);new Worker$1;var K0=.9996,E=.00669438,E2=Math.pow(E,2),E3=Math.pow(E,3),E_P2=E/(1-E),M1=1-E/4-3*E2/64-5*E3/256,M2=3*E/8+3*E2/32+45*E3/1024,M3=15*E2/256+45*E3/1024,M4=35*E3/3072,R$1=6378137,ZONE_LETTERS="CDEFGHJKLMNPQRSTUVWXX";function fromLatLon(n,t,s){if(n>84||n<-80)throw new RangeError("latitude out of range (must be between 80 deg S and 84 deg N)");if(t>180||t<-180)throw new RangeError("longitude out of range (must be between 180 deg W and 180 deg E)");var l=toRadians(n),p=Math.sin(l),g=Math.cos(l),w=Math.tan(l),u=Math.pow(w,2),A=Math.pow(w,4),S;s===void 0?S=latLonToZoneNumber(n,t):S=s;var D=latitudeToZoneLetter(n),z=toRadians(t),$=zoneNumberToCentralLongitude(S),O=toRadians($),q=R$1/Math.sqrt(1-E*p*p),K=E_P2*g*g,J=g*modAngle(z-O),Y=Math.pow(J,2),fe=Math.pow(J,3),ee=Math.pow(J,4),re=Math.pow(J,5),he=Math.pow(J,6),_e=R$1*(M1*l-M2*Math.sin(2*l)+M3*Math.sin(4*l)-M4*Math.sin(6*l)),we=K0*q*(J+fe/6*(1-u+K)+re/120*(5-18*u+A+72*K-58*E_P2))+5e5,oe=K0*(_e+q*w*(Y/2+ee/24*(5-u+9*K+4*K*K)+he/720*(61-58*u+A+600*K-330*E_P2)));return n<0&&(oe+=1e7),{easting:we,northing:oe,zoneNum:S,zoneLetter:D}}function latitudeToZoneLetter(n){return-80<=n&&n<=84?ZONE_LETTERS[Math.floor((n+80)/8)]:null}function latLonToZoneNumber(n,t){if(56<=n&&n<64&&3<=t&&t<12)return 32;if(72<=n&&n<=84&&t>=0){if(t<9)return 31;if(t<21)return 33;if(t<33)return 35;if(t<42)return 37}return Math.floor((t+180)/6)+1}function zoneNumberToCentralLongitude(n){return(n-1)*6-180+3}function toRadians(n){return n*Math.PI/180}function modAngle(n){return(n+Math.PI)%(2*Math.PI)-Math.PI}function getTileInfo(n,t,s){let l={},p=Math.floor(s.getZoom()),g=40075016686e-3*Math.abs(Math.cos(t))/Math.pow(2,p),w=g/512,u=tilebelt.pointToTile(n,t,p);l.z=p,l.x=u[0],l.y=u[1],l.pointLng=n,l.pointLat=t,l.tileWidthInMeters=g,l.metersPerPixel=w,l.mapboxTileName=l.z+"-"+l.x+"-"+l.y,l.tile=[l.x,l.y,l.z],l.bbox=tilebelt.tileToBBOX(l.tile),l.polygon_bb=getTileGeoJsonBB(l.bbox);const A=new mapboxgl.LngLatBounds(l.bbox);l.bboxCT=A.getCenter(),l.bboxSW=A.getSouthWest(),l.bboxNE=A.getNorthEast(),l.bboxNW=A.getNorthWest(),l.bboxSE=A.getSouthEast(),l.originCoordinates=l.bboxNW;let S=converLatLngTotUtm(l.originCoordinates.lat,l.originCoordinates.lng);return l.projected=new mapboxgl.LngLat(l.originCoordinates.lng,l.originCoordinates.lat),l.epsg=getEpsg(l.originCoordinates.lat,l.originCoordinates.lng),l.OriginEasting=S.easting,l.OriginNorthing=S.northing,l.zoneLetter=S.zoneLetter,l.zoneNum=S.zoneNum,l.originLng=l.originCoordinates.lng,l.originLat=l.originCoordinates.lat,l.maxPngValue=65535,l.rgbFileName="terrain-rgb-"+l.mapboxTileName+".png",l.thirtyTwoFileName="thirtytwo-"+l.mapboxTileName+".png",l.tileInfoFileName="tile-info-"+l.mapboxTileName+".json",l.geoJsonFileName="geojson-"+l.mapboxTileName+".json",S=converLatLngTotUtm(l.pointLat,l.pointLng),l.pointNorthing=S.northing,l.pointEasting=S.easting,S=converLatLngTotUtm(l.bboxCT.lat,l.bboxCT.lng),l.ctNorthing=S.northing,l.ctEasting=S.easting,S=converLatLngTotUtm(l.bboxSW.lat,l.bboxSW.lng),l.swNorthing=S.northing,l.swEasting=S.easting,S=converLatLngTotUtm(l.bboxNE.lat,l.bboxNE.lng),l.neNorthing=S.northing,l.neEasting=S.easting,S=converLatLngTotUtm(l.bboxNW.lat,l.bboxNW.lng),l.nwNorthing=S.northing,l.nwEasting=S.easting,S=converLatLngTotUtm(l.bboxSE.lat,l.bboxSE.lng),l.seNorthing=S.northing,l.seEasting=S.easting,l}function getEpsg(n,t){let s=Math.round((183+t)/6),l=0;return n>0?l=32600+s:l=32700+s,l}function converLatLngTotUtm(n,t){return fromLatLon(n,t)}function convertGeoJsonCoordinatesToUTM(n){return n.forEach(t=>{let s=t.geometry.coordinates;traverseArray(s)}),n}function traverseArray(n){let t=0,s,l;n.forEach((p,g)=>{if(Array.isArray(p))traverseArray(p);else{if(t===0&&(s=p),t===1){l=p;let w=converLatLngTotUtm(l,s);n[0]=w.northing,n[1]=w.easting}t=t+1,t===2&&(t=0)}})}function getTileGeoJsonBB(n){let t=bboxPolygon(n);return{type:"Feature",geometry:{type:t.geometry.type,coordinates:t.geometry.coordinates}}}function getFeaturesFromBB(n,t){return t.swPt=n.project(t.bboxSW),t.nePt=n.project(t.bboxNE),t.nwPt=n.project(t.bboxNW),t.sePt=n.project(t.bboxSE),n.queryRenderedFeatures([t.swPt,t.nePt])}async function loadImageFromArray(n){return await Image$1.load(n)}function getHeightFromRgb(n,t,s){return-1e4+(n*256*256+t*256+s)*.1}function getHeightArray(n){let t=[],s=n.getPixelsArray();for(const l of s){let p=l[0],g=l[1],w=l[2],u=getHeightFromRgb(p,g,w);u=parseFloat(u),t.push(u)}return t}async function downloadTerrainRgb(n){return await(await fetch(n)).arrayBuffer()}async function unrealRemoteControl(n,t){const s={method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)};return await(await fetch(t,s)).json()}async function getMapboxTerrainRgb(n,t,s){let l,p=await fileUtils.fileExists(n,t.rgbFileName),g;return p===!1?l=await downloadTerrainRgb(s):l=await fileUtils.readFileFromDisk(n,t.rgbFileName),idbKeyval.set("rgbImageArrayBuffer",l),g=await loadImageFromArray(l),g}function convertImage(n,t,s,l,p){return new Image$1(n,t,s,{kind:p,bitDepth:l})}function createHeightMapImage(n,t,s){let l={},p=getHeightArray(n);idbKeyval.set("decodedHeightArray",p);let g=convertImage(n.width,n.height,p,t,s);return l.minElevation=g.min[0],l.maxElevation=g.max[0],l.image=g,l.decodedHeightArray=p,l}var mapUtils={converLatLngTotUtm,getTileInfo,getFeaturesFromBB,getMapboxTerrainRgb,createHeightMapImage,loadImageFromArray,unrealRemoteControl,convertGeoJsonCoordinatesToUTM,downloadTerrainRgb};function mitt(n){return{all:n=n||new Map,on:function(t,s){var l=n.get(t);l?l.push(s):n.set(t,[s])},off:function(t,s){var l=n.get(t);l&&(s?l.splice(l.indexOf(s)>>>0,1):n.set(t,[]))},emit:function(t,s){var l=n.get(t);l&&l.slice().map(function(p){p(s)}),(l=n.get("*"))&&l.slice().map(function(p){p(t,s)})}}}var emitter=mitt(),immutable=extend$2,hasOwnProperty=Object.prototype.hasOwnProperty;function extend$2(){for(var n={},t=0;t<arguments.length;t++){var s=arguments[t];for(var l in s)hasOwnProperty.call(s,l)&&(n[l]=s[l])}return n}var fuzzy$1={exports:{}};(function(n,t){(function(){var s={};n.exports=s,s.simpleFilter=function(l,p){return p.filter(function(g){return s.test(l,g)})},s.test=function(l,p){return s.match(l,p)!==null},s.match=function(l,p,g){g=g||{};var w=0,u=[],A=p.length,S=0,D=0,z=g.pre||"",$=g.post||"",O=g.caseSensitive&&p||p.toLowerCase(),q;l=g.caseSensitive&&l||l.toLowerCase();for(var K=0;K<A;K++)q=p[K],O[K]===l[w]?(q=z+q+$,w+=1,D+=1+D):D=0,S+=D,u[u.length]=q;return w===l.length?(S=O===l?1/0:S,{rendered:u.join(""),score:S}):null},s.filter=function(l,p,g){return!p||p.length===0?[]:typeof l!="string"?p:(g=g||{},p.reduce(function(w,u,A,S){var D=u;g.extract&&(D=g.extract(u));var z=s.match(l,D,g);return z!=null&&(w[w.length]={string:z.rendered,score:z.score,index:A,original:u}),w},[]).sort(function(w,u){var A=u.score-w.score;return A||w.index-u.index}))}})()})(fuzzy$1);var List$1=function(n){return this.component=n,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,n.el.parentNode.insertBefore(this.wrapper,n.el.nextSibling),this};List$1.prototype.show=function(){this.element.style.display="block"};List$1.prototype.hide=function(){this.element.style.display="none"};List$1.prototype.add=function(n){this.items.push(n)};List$1.prototype.clear=function(){this.items=[],this.active=0};List$1.prototype.isEmpty=function(){return!this.items.length};List$1.prototype.isVisible=function(){return this.element.style.display==="block"};List$1.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var n=0;n<this.items.length;n++)this.drawItem(this.items[n],this.active===n);this.show()};List$1.prototype.drawItem=function(n,t){var s=document.createElement("li"),l=document.createElement("a");t&&(s.className+=" active"),l.innerHTML=n.string,s.appendChild(l),this.element.appendChild(s),s.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),s.addEventListener("mouseup",function(){this.handleMouseUp.call(this,n)}.bind(this))};List$1.prototype.handleMouseUp=function(n){this.selectingListItem=!1,this.component.value(n.original),this.clear(),this.draw()};List$1.prototype.move=function(n){this.active=n,this.draw()};List$1.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};List$1.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};List$1.prototype.drawError=function(n){var t=document.createElement("li");t.innerHTML=n,this.element.appendChild(t),this.show()};var list=List$1,extend$1=immutable,fuzzy=fuzzy$1.exports,List=list,Suggestions$1=function(n,t,s){return s=s||{},this.options=extend$1({minLength:2,limit:5,filter:!0,hideOnBlur:!0},s),this.el=n,this.data=t||[],this.list=new List(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",function(l){this.handleKeyUp(l.keyCode)}.bind(this),!1),this.el.addEventListener("keydown",function(l){this.handleKeyDown(l)}.bind(this)),this.el.addEventListener("focus",function(){this.handleFocus()}.bind(this)),this.el.addEventListener("blur",function(){this.handleBlur()}.bind(this)),this.el.addEventListener("paste",function(l){this.handlePaste(l)}.bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};Suggestions$1.prototype.handleKeyUp=function(n){n===40||n===38||n===27||n===13||n===9||this.handleInputChange(this.el.value)};Suggestions$1.prototype.handleKeyDown=function(n){switch(n.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&n.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};Suggestions$1.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};Suggestions$1.prototype.handlePaste=function(n){if(n.clipboardData)this.handleInputChange(n.clipboardData.getData("Text"));else{var t=this;setTimeout(function(){t.handleInputChange(n.target.value)},100)}};Suggestions$1.prototype.handleInputChange=function(n){if(this.query=this.normalize(n),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates(function(t){for(var s=0;s<t.length&&(this.list.add(t[s]),s!==this.options.limit-1);s++);this.list.draw()}.bind(this))};Suggestions$1.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};Suggestions$1.prototype.update=function(n){this.data=n,this.handleKeyUp()};Suggestions$1.prototype.clear=function(){this.data=[],this.list.clear()};Suggestions$1.prototype.normalize=function(n){return n=n.toLowerCase(),n};Suggestions$1.prototype.match=function(n,t){return n.indexOf(t)>-1};Suggestions$1.prototype.value=function(n){if(this.selected=n,this.el.value=this.getItemValue(n),document.createEvent){var t=document.createEvent("HTMLEvents");t.initEvent("change",!0,!1),this.el.dispatchEvent(t)}else this.el.fireEvent("onchange")};Suggestions$1.prototype.getCandidates=function(n){var t={pre:"<strong>",post:"</strong>",extract:function(l){return this.getItemValue(l)}.bind(this)},s;this.options.filter?(s=fuzzy.filter(this.query,this.data,t),s=s.map(function(l){return{original:l.original,string:this.render(l.original,l.string)}}.bind(this))):s=this.data.map(function(l){var p=this.render(l);return{original:l,string:p}}.bind(this)),n(s)};Suggestions$1.prototype.getItemValue=function(n){return n};Suggestions$1.prototype.render=function(n,t){if(t)return t;for(var s=n.original?this.getItemValue(n.original):this.getItemValue(n),l=this.normalize(s),p=l.lastIndexOf(this.query);p>-1;){var g=p+this.query.length;s=s.slice(0,p)+"<strong>"+s.slice(p,g)+"</strong>"+s.slice(g),p=l.slice(0,p).lastIndexOf(this.query)}return s};Suggestions$1.prototype.renderError=function(n){this.list.drawError(n)};var suggestions$1=Suggestions$1,Suggestions=suggestions$1,suggestions=Suggestions;typeof window!="undefined"&&(window.Suggestions=Suggestions);var FUNC_ERROR_TEXT="Expected a function",NAN=0/0,symbolTag="[object Symbol]",reTrim=/^\s+|\s+$/g,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsOctal=/^0o[0-7]+$/i,freeParseInt=parseInt,freeGlobal=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf=typeof self=="object"&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),objectProto=Object.prototype,objectToString=objectProto.toString,nativeMax=Math.max,nativeMin=Math.min,now=function(){return root.Date.now()};function debounce$1(n,t,s){var l,p,g,w,u,A,S=0,D=!1,z=!1,$=!0;if(typeof n!="function")throw new TypeError(FUNC_ERROR_TEXT);t=toNumber(t)||0,isObject(s)&&(D=!!s.leading,z="maxWait"in s,g=z?nativeMax(toNumber(s.maxWait)||0,t):g,$="trailing"in s?!!s.trailing:$);function O(_e){var we=l,oe=p;return l=p=void 0,S=_e,w=n.apply(oe,we),w}function q(_e){return S=_e,u=setTimeout(Y,t),D?O(_e):w}function K(_e){var we=_e-A,oe=_e-S,be=t-we;return z?nativeMin(be,g-oe):be}function J(_e){var we=_e-A,oe=_e-S;return A===void 0||we>=t||we<0||z&&oe>=g}function Y(){var _e=now();if(J(_e))return fe(_e);u=setTimeout(Y,K(_e))}function fe(_e){return u=void 0,$&&l?O(_e):(l=p=void 0,w)}function ee(){u!==void 0&&clearTimeout(u),S=0,l=A=p=u=void 0}function re(){return u===void 0?w:fe(now())}function he(){var _e=now(),we=J(_e);if(l=arguments,p=this,A=_e,we){if(u===void 0)return q(A);if(z)return u=setTimeout(Y,t),O(A)}return u===void 0&&(u=setTimeout(Y,t)),w}return he.cancel=ee,he.flush=re,he}function isObject(n){var t=typeof n;return!!n&&(t=="object"||t=="function")}function isObjectLike(n){return!!n&&typeof n=="object"}function isSymbol(n){return typeof n=="symbol"||isObjectLike(n)&&objectToString.call(n)==symbolTag}function toNumber(n){if(typeof n=="number")return n;if(isSymbol(n))return NAN;if(isObject(n)){var t=typeof n.valueOf=="function"?n.valueOf():n;n=isObject(t)?t+"":t}if(typeof n!="string")return n===0?n:+n;n=n.replace(reTrim,"");var s=reIsBinary.test(n);return s||reIsOctal.test(n)?freeParseInt(n.slice(2),s?2:8):reIsBadHex.test(n)?NAN:+n}var lodash_debounce=debounce$1,events$1={exports:{}},R=typeof Reflect=="object"?Reflect:null,ReflectApply=R&&typeof R.apply=="function"?R.apply:function n(t,s,l){return Function.prototype.apply.call(t,s,l)},ReflectOwnKeys;R&&typeof R.ownKeys=="function"?ReflectOwnKeys=R.ownKeys:Object.getOwnPropertySymbols?ReflectOwnKeys=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:ReflectOwnKeys=function(t){return Object.getOwnPropertyNames(t)};function ProcessEmitWarning(n){console&&console.warn&&console.warn(n)}var NumberIsNaN=Number.isNaN||function n(t){return t!==t};function EventEmitter$2(){EventEmitter$2.init.call(this)}events$1.exports=EventEmitter$2;events$1.exports.once=once;EventEmitter$2.EventEmitter=EventEmitter$2;EventEmitter$2.prototype._events=void 0;EventEmitter$2.prototype._eventsCount=0;EventEmitter$2.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(EventEmitter$2,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(n){if(typeof n!="number"||n<0||NumberIsNaN(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");defaultMaxListeners=n}});EventEmitter$2.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};EventEmitter$2.prototype.setMaxListeners=function n(t){if(typeof t!="number"||t<0||NumberIsNaN(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function _getMaxListeners(n){return n._maxListeners===void 0?EventEmitter$2.defaultMaxListeners:n._maxListeners}EventEmitter$2.prototype.getMaxListeners=function n(){return _getMaxListeners(this)};EventEmitter$2.prototype.emit=function n(t){for(var s=[],l=1;l<arguments.length;l++)s.push(arguments[l]);var p=t==="error",g=this._events;if(g!==void 0)p=p&&g.error===void 0;else if(!p)return!1;if(p){var w;if(s.length>0&&(w=s[0]),w instanceof Error)throw w;var u=new Error("Unhandled error."+(w?" ("+w.message+")":""));throw u.context=w,u}var A=g[t];if(A===void 0)return!1;if(typeof A=="function")ReflectApply(A,this,s);else for(var S=A.length,D=arrayClone(A,S),l=0;l<S;++l)ReflectApply(D[l],this,s);return!0};function _addListener(n,t,s,l){var p,g,w;if(checkListener(s),g=n._events,g===void 0?(g=n._events=Object.create(null),n._eventsCount=0):(g.newListener!==void 0&&(n.emit("newListener",t,s.listener?s.listener:s),g=n._events),w=g[t]),w===void 0)w=g[t]=s,++n._eventsCount;else if(typeof w=="function"?w=g[t]=l?[s,w]:[w,s]:l?w.unshift(s):w.push(s),p=_getMaxListeners(n),p>0&&w.length>p&&!w.warned){w.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+w.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=n,u.type=t,u.count=w.length,ProcessEmitWarning(u)}return n}EventEmitter$2.prototype.addListener=function n(t,s){return _addListener(this,t,s,!1)};EventEmitter$2.prototype.on=EventEmitter$2.prototype.addListener;EventEmitter$2.prototype.prependListener=function n(t,s){return _addListener(this,t,s,!0)};function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(n,t,s){var l={fired:!1,wrapFn:void 0,target:n,type:t,listener:s},p=onceWrapper.bind(l);return p.listener=s,l.wrapFn=p,p}EventEmitter$2.prototype.once=function n(t,s){return checkListener(s),this.on(t,_onceWrap(this,t,s)),this};EventEmitter$2.prototype.prependOnceListener=function n(t,s){return checkListener(s),this.prependListener(t,_onceWrap(this,t,s)),this};EventEmitter$2.prototype.removeListener=function n(t,s){var l,p,g,w,u;if(checkListener(s),p=this._events,p===void 0)return this;if(l=p[t],l===void 0)return this;if(l===s||l.listener===s)--this._eventsCount===0?this._events=Object.create(null):(delete p[t],p.removeListener&&this.emit("removeListener",t,l.listener||s));else if(typeof l!="function"){for(g=-1,w=l.length-1;w>=0;w--)if(l[w]===s||l[w].listener===s){u=l[w].listener,g=w;break}if(g<0)return this;g===0?l.shift():spliceOne(l,g),l.length===1&&(p[t]=l[0]),p.removeListener!==void 0&&this.emit("removeListener",t,u||s)}return this};EventEmitter$2.prototype.off=EventEmitter$2.prototype.removeListener;EventEmitter$2.prototype.removeAllListeners=function n(t){var s,l,p;if(l=this._events,l===void 0)return this;if(l.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):l[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete l[t]),this;if(arguments.length===0){var g=Object.keys(l),w;for(p=0;p<g.length;++p)w=g[p],w!=="removeListener"&&this.removeAllListeners(w);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(s=l[t],typeof s=="function")this.removeListener(t,s);else if(s!==void 0)for(p=s.length-1;p>=0;p--)this.removeListener(t,s[p]);return this};function _listeners(n,t,s){var l=n._events;if(l===void 0)return[];var p=l[t];return p===void 0?[]:typeof p=="function"?s?[p.listener||p]:[p]:s?unwrapListeners(p):arrayClone(p,p.length)}EventEmitter$2.prototype.listeners=function n(t){return _listeners(this,t,!0)};EventEmitter$2.prototype.rawListeners=function n(t){return _listeners(this,t,!1)};EventEmitter$2.listenerCount=function(n,t){return typeof n.listenerCount=="function"?n.listenerCount(t):listenerCount.call(n,t)};EventEmitter$2.prototype.listenerCount=listenerCount;function listenerCount(n){var t=this._events;if(t!==void 0){var s=t[n];if(typeof s=="function")return 1;if(s!==void 0)return s.length}return 0}EventEmitter$2.prototype.eventNames=function n(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(n,t){for(var s=new Array(t),l=0;l<t;++l)s[l]=n[l];return s}function spliceOne(n,t){for(;t+1<n.length;t++)n[t]=n[t+1];n.pop()}function unwrapListeners(n){for(var t=new Array(n.length),s=0;s<t.length;++s)t[s]=n[s].listener||n[s];return t}function once(n,t){return new Promise(function(s,l){function p(w){n.removeListener(t,g),l(w)}function g(){typeof n.removeListener=="function"&&n.removeListener("error",p),s([].slice.call(arguments))}eventTargetAgnosticAddListener(n,t,g,{once:!0}),t!=="error"&&addErrorHandlerIfEventEmitter(n,p,{once:!0})})}function addErrorHandlerIfEventEmitter(n,t,s){typeof n.on=="function"&&eventTargetAgnosticAddListener(n,"error",t,s)}function eventTargetAgnosticAddListener(n,t,s,l){if(typeof n.on=="function")l.once?n.once(t,s):n.on(t,s);else if(typeof n.addEventListener=="function")n.addEventListener(t,function p(g){l.once&&n.removeEventListener(t,p),s(g)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var exceptions$1={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}};function parseParam(n){var t=n.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return t?{key:t[1],value:t[2]}:null}function parseLink(n){var t=n.match(/<?([^>]*)>(.*)/);if(!t)return null;var s=t[1],l=t[2].split(";"),p=null,g=l.reduce(function(w,u){var A=parseParam(u);return A?A.key==="rel"?(p||(p=A.value),w):(w[A.key]=A.value,w):w},{});return p?{url:s,rel:p,params:g}:null}function parseLinkHeader$1(n){return n?n.split(/,\s*</).reduce(function(t,s){var l=parseLink(s);if(!l)return t;var p=l.rel.split(/\s+/);return p.forEach(function(g){t[g]||(t[g]={url:l.url,params:l.params})}),t},{}):{}}var parseLinkHeader_1=parseLinkHeader$1,parseLinkHeader=parseLinkHeader_1;function MapiResponse$1(n,t){this.request=n,this.headers=t.headers,this.rawBody=t.body,this.statusCode=t.statusCode;try{this.body=JSON.parse(t.body||"{}")}catch{this.body=t.body}this.links=parseLinkHeader(this.headers.link)}MapiResponse$1.prototype.hasNextPage=function n(){return!!this.links.next};MapiResponse$1.prototype.nextPage=function n(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};var mapiResponse=MapiResponse$1,constants$4={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"},constants$3=constants$4;function MapiError$1(n){var t=n.type||constants$3.ERROR_HTTP,s;if(n.body)try{s=JSON.parse(n.body)}catch{s=n.body}else s=null;var l=n.message||null;l||(typeof s=="string"?l=s:s&&typeof s.message=="string"?l=s.message:t===constants$3.ERROR_REQUEST_ABORTED&&(l="Request aborted")),this.message=l,this.type=t,this.statusCode=n.statusCode||null,this.request=n.request,this.body=s}var mapiError=MapiError$1;function parseSingleHeader(n){var t=n.indexOf(":"),s=n.substring(0,t).trim().toLowerCase(),l=n.substring(t+1).trim();return{name:s,value:l}}function parseHeaders$1(n){var t={};return n&&n.trim().split(/[\r|\n]+/).forEach(function(s){var l=parseSingleHeader(s);t[l.name]=l.value}),t}var parseHeaders_1=parseHeaders$1,MapiResponse=mapiResponse,MapiError=mapiError,constants$2=constants$4,parseHeaders=parseHeaders_1,requestsUnderway={};function browserAbort(n){var t=requestsUnderway[n.id];!t||(t.abort(),delete requestsUnderway[n.id])}function createResponse(n,t){return new MapiResponse(n,{body:t.response,headers:parseHeaders(t.getAllResponseHeaders()),statusCode:t.status})}function normalizeBrowserProgressEvent(n){var t=n.total,s=n.loaded,l=100*s/t;return{total:t,transferred:s,percent:l}}function sendRequestXhr(n,t){return new Promise(function(s,l){t.onprogress=function(w){n.emitter.emit(constants$2.EVENT_PROGRESS_DOWNLOAD,normalizeBrowserProgressEvent(w))};var p=n.file;p&&(t.upload.onprogress=function(w){n.emitter.emit(constants$2.EVENT_PROGRESS_UPLOAD,normalizeBrowserProgressEvent(w))}),t.onerror=function(w){l(w)},t.onabort=function(){var w=new MapiError({request:n,type:constants$2.ERROR_REQUEST_ABORTED});l(w)},t.onload=function(){if(delete requestsUnderway[n.id],t.status<200||t.status>=400){var w=new MapiError({request:n,body:t.response,statusCode:t.status});l(w);return}s(t)};var g=n.body;typeof g=="string"?t.send(g):g?t.send(JSON.stringify(g)):p?t.send(p):t.send(),requestsUnderway[n.id]=t}).then(function(s){return createResponse(n,s)})}function createRequestXhr(n,t){var s=n.url(t),l=new window.XMLHttpRequest;return l.open(n.method,s),Object.keys(n.headers).forEach(function(p){l.setRequestHeader(p,n.headers[p])}),l}function browserSend(n){return Promise.resolve().then(function(){var t=createRequestXhr(n,n.client.accessToken);return sendRequestXhr(n,t)})}var browserLayer={browserAbort,sendRequestXhr,browserSend,createRequestXhr},base64$1={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */(function(n,t){(function(s){var l=t,p=n&&n.exports==l&&n,g=typeof commonjsGlobal=="object"&&commonjsGlobal;(g.global===g||g.window===g)&&(s=g);var w=function(q){this.message=q};w.prototype=new Error,w.prototype.name="InvalidCharacterError";var u=function(q){throw new w(q)},A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",S=/[\t\n\f\r ]/g,D=function(q){q=String(q).replace(S,"");var K=q.length;K%4==0&&(q=q.replace(/==?$/,""),K=q.length),(K%4==1||/[^+a-zA-Z0-9/]/.test(q))&&u("Invalid character: the string to be decoded is not correctly encoded.");for(var J=0,Y,fe,ee="",re=-1;++re<K;)fe=A.indexOf(q.charAt(re)),Y=J%4?Y*64+fe:fe,J++%4&&(ee+=String.fromCharCode(255&Y>>(-2*J&6)));return ee},z=function(q){q=String(q),/[^\0-\xFF]/.test(q)&&u("The string to be encoded contains characters outside of the Latin1 range.");for(var K=q.length%3,J="",Y=-1,fe,ee,re,he,_e=q.length-K;++Y<_e;)fe=q.charCodeAt(Y)<<16,ee=q.charCodeAt(++Y)<<8,re=q.charCodeAt(++Y),he=fe+ee+re,J+=A.charAt(he>>18&63)+A.charAt(he>>12&63)+A.charAt(he>>6&63)+A.charAt(he&63);return K==2?(fe=q.charCodeAt(Y)<<8,ee=q.charCodeAt(++Y),he=fe+ee,J+=A.charAt(he>>10)+A.charAt(he>>4&63)+A.charAt(he<<2&63)+"="):K==1&&(he=q.charCodeAt(Y),J+=A.charAt(he>>2)+A.charAt(he<<4&63)+"=="),J},$={encode:z,decode:D,version:"0.1.0"};if(l&&!l.nodeType)if(p)p.exports=$;else for(var O in $)$.hasOwnProperty(O)&&(l[O]=$[O]);else s.base64=$})(commonjsGlobal)})(base64$1,base64$1.exports);var base64=base64$1.exports,tokenCache={};function parseToken$2(n){if(tokenCache[n])return tokenCache[n];var t=n.split("."),s=t[0],l=t[1];if(!l)throw new Error("Invalid token");var p=parsePaylod(l),g={usage:s,user:p.u};return has(p,"a")&&(g.authorization=p.a),has(p,"exp")&&(g.expires=p.exp*1e3),has(p,"iat")&&(g.created=p.iat*1e3),has(p,"scopes")&&(g.scopes=p.scopes),has(p,"client")&&(g.client=p.client),has(p,"ll")&&(g.lastLogin=p.ll),has(p,"iu")&&(g.impersonator=p.iu),tokenCache[n]=g,g}function parsePaylod(n){try{return JSON.parse(base64.decode(n))}catch{throw new Error("Invalid token")}}function has(n,t){return Object.prototype.hasOwnProperty.call(n,t)}var parseMapboxToken=parseToken$2,eventemitter3={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,s="~";function l(){}Object.create&&(l.prototype=Object.create(null),new l().__proto__||(s=!1));function p(A,S,D){this.fn=A,this.context=S,this.once=D||!1}function g(A,S,D,z,$){if(typeof D!="function")throw new TypeError("The listener must be a function");var O=new p(D,z||A,$),q=s?s+S:S;return A._events[q]?A._events[q].fn?A._events[q]=[A._events[q],O]:A._events[q].push(O):(A._events[q]=O,A._eventsCount++),A}function w(A,S){--A._eventsCount===0?A._events=new l:delete A._events[S]}function u(){this._events=new l,this._eventsCount=0}u.prototype.eventNames=function(){var S=[],D,z;if(this._eventsCount===0)return S;for(z in D=this._events)t.call(D,z)&&S.push(s?z.slice(1):z);return Object.getOwnPropertySymbols?S.concat(Object.getOwnPropertySymbols(D)):S},u.prototype.listeners=function(S){var D=s?s+S:S,z=this._events[D];if(!z)return[];if(z.fn)return[z.fn];for(var $=0,O=z.length,q=new Array(O);$<O;$++)q[$]=z[$].fn;return q},u.prototype.listenerCount=function(S){var D=s?s+S:S,z=this._events[D];return z?z.fn?1:z.length:0},u.prototype.emit=function(S,D,z,$,O,q){var K=s?s+S:S;if(!this._events[K])return!1;var J=this._events[K],Y=arguments.length,fe,ee;if(J.fn){switch(J.once&&this.removeListener(S,J.fn,void 0,!0),Y){case 1:return J.fn.call(J.context),!0;case 2:return J.fn.call(J.context,D),!0;case 3:return J.fn.call(J.context,D,z),!0;case 4:return J.fn.call(J.context,D,z,$),!0;case 5:return J.fn.call(J.context,D,z,$,O),!0;case 6:return J.fn.call(J.context,D,z,$,O,q),!0}for(ee=1,fe=new Array(Y-1);ee<Y;ee++)fe[ee-1]=arguments[ee];J.fn.apply(J.context,fe)}else{var re=J.length,he;for(ee=0;ee<re;ee++)switch(J[ee].once&&this.removeListener(S,J[ee].fn,void 0,!0),Y){case 1:J[ee].fn.call(J[ee].context);break;case 2:J[ee].fn.call(J[ee].context,D);break;case 3:J[ee].fn.call(J[ee].context,D,z);break;case 4:J[ee].fn.call(J[ee].context,D,z,$);break;default:if(!fe)for(he=1,fe=new Array(Y-1);he<Y;he++)fe[he-1]=arguments[he];J[ee].fn.apply(J[ee].context,fe)}}return!0},u.prototype.on=function(S,D,z){return g(this,S,D,z,!1)},u.prototype.once=function(S,D,z){return g(this,S,D,z,!0)},u.prototype.removeListener=function(S,D,z,$){var O=s?s+S:S;if(!this._events[O])return this;if(!D)return w(this,O),this;var q=this._events[O];if(q.fn)q.fn===D&&(!$||q.once)&&(!z||q.context===z)&&w(this,O);else{for(var K=0,J=[],Y=q.length;K<Y;K++)(q[K].fn!==D||$&&!q[K].once||z&&q[K].context!==z)&&J.push(q[K]);J.length?this._events[O]=J.length===1?J[0]:J:w(this,O)}return this},u.prototype.removeAllListeners=function(S){var D;return S?(D=s?s+S:S,this._events[D]&&w(this,D)):(this._events=new l,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=s,u.EventEmitter=u,n.exports=u})(eventemitter3);function encodeArray(n){return n.map(encodeURIComponent).join(",")}function encodeValue(n){return Array.isArray(n)?encodeArray(n):encodeURIComponent(String(n))}function appendQueryParam(n,t,s){if(s===!1||s===null)return n;var l=/\?/.test(n)?"&":"?",p=encodeURIComponent(t);return s!==void 0&&s!==""&&s!==!0&&(p+="="+encodeValue(s)),""+n+l+p}function appendQueryObject(n,t){if(!t)return n;var s=n;return Object.keys(t).forEach(function(l){var p=t[l];p!==void 0&&(Array.isArray(p)&&(p=p.filter(function(g){return g!=null}).join(",")),s=appendQueryParam(s,l,p))}),s}function prependOrigin(n,t){if(!t||n.slice(0,4)==="http")return n;var s=n[0]==="/"?"":"/";return""+t.replace(/\/$/,"")+s+n}function interpolateRouteParams(n,t){return t?n.replace(/\/:([a-zA-Z0-9]+)/g,function(s,l){var p=t[l];if(p===void 0)throw new Error("Unspecified route parameter "+l);var g=encodeValue(p);return"/"+g}):n}var urlUtils$1={appendQueryObject,appendQueryParam,prependOrigin,interpolateRouteParams},parseToken$1=parseMapboxToken,xtend$3=immutable,EventEmitter$1=eventemitter3.exports,urlUtils=urlUtils$1,constants$1=constants$4,requestId=1;function MapiRequest$1(n,t){if(!n)throw new Error("MapiRequest requires a client");if(!t||!t.path||!t.method)throw new Error("MapiRequest requires an options object with path and method properties");var s={};t.body&&(s["content-type"]="application/json");var l=xtend$3(s,t.headers),p=Object.keys(l).reduce(function(g,w){return g[w.toLowerCase()]=l[w],g},{});this.id=requestId++,this._options=t,this.emitter=new EventEmitter$1,this.client=n,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=t.path,this.method=t.method,this.origin=t.origin||n.origin,this.query=t.query||{},this.params=t.params||{},this.body=t.body||null,this.file=t.file||null,this.encoding=t.encoding||"utf8",this.sendFileAs=t.sendFileAs||null,this.headers=p}MapiRequest$1.prototype.url=function n(t){var s=urlUtils.prependOrigin(this.path,this.origin);s=urlUtils.appendQueryObject(s,this.query);var l=this.params,p=t==null?this.client.accessToken:t;if(p){s=urlUtils.appendQueryParam(s,"access_token",p);var g=parseToken$1(p).user;l=xtend$3({ownerId:g},l)}return s=urlUtils.interpolateRouteParams(s,l),s};MapiRequest$1.prototype.send=function n(){var t=this;if(t.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return t.sent=!0,t.client.sendRequest(t).then(function(s){return t.response=s,t.emitter.emit(constants$1.EVENT_RESPONSE,s),s},function(s){throw t.error=s,t.emitter.emit(constants$1.EVENT_ERROR,s),s})};MapiRequest$1.prototype.abort=function n(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};MapiRequest$1.prototype.eachPage=function n(t){var s=this;function l(w){function u(){delete s._nextPageRequest;var A=w.nextPage();A&&(s._nextPageRequest=A,g(A))}t(null,w,u)}function p(w){t(w,null,function(){})}function g(w){w.send().then(l,p)}g(this)};MapiRequest$1.prototype.clone=function n(){return this._extend()};MapiRequest$1.prototype._extend=function n(t){var s=xtend$3(this._options,t);return new MapiRequest$1(this.client,s)};var mapiRequest=MapiRequest$1,parseToken=parseMapboxToken,MapiRequest=mapiRequest,constants=constants$4;function MapiClient$2(n){if(!n||!n.accessToken)throw new Error("Cannot create a client without an access token");parseToken(n.accessToken),this.accessToken=n.accessToken,this.origin=n.origin||constants.API_ORIGIN}MapiClient$2.prototype.createRequest=function n(t){return new MapiRequest(this,t)};var mapiClient=MapiClient$2,browser=browserLayer,MapiClient$1=mapiClient;function BrowserClient(n){MapiClient$1.call(this,n)}BrowserClient.prototype=Object.create(MapiClient$1.prototype);BrowserClient.prototype.constructor=BrowserClient;BrowserClient.prototype.sendRequest=browser.browserSend;BrowserClient.prototype.abortRequest=browser.browserAbort;function createBrowserClient(n){return new BrowserClient(n)}var browserClient=createBrowserClient,client=browserClient,mapboxSdk=client,toString=Object.prototype.toString,isPlainObj=function(n){var t;return toString.call(n)==="[object Object]"&&(t=Object.getPrototypeOf(n),t===null||t===Object.getPrototypeOf({}))},isPlainObject=isPlainObj,xtend$2=immutable,DEFAULT_ERROR_PATH="value",NEWLINE_INDENT=`
  `,v$2={};v$2.assert=function(n,t){return t=t||{},function(s){var l=validate(n,s);if(!!l){var p=processMessage(l,t);throw t.apiName&&(p=t.apiName+": "+p),new Error(p)}}};v$2.shape=function n(t){var s=objectEntries(t);return function(p){var g=validate(v$2.plainObject,p);if(g)return g;for(var w,u,A=[],S=0;S<s.length;S++)w=s[S].key,u=s[S].value,g=validate(u,p[w]),g&&A.push([w].concat(g));return A.length<2?A[0]:function(D){A=A.map(function(O){var q=O[0],K=processMessage(O,D).split(`
`).join(NEWLINE_INDENT);return"- "+q+": "+K});var z=D.path.join("."),$=z===DEFAULT_ERROR_PATH?"":" of "+z;return"The following properties"+$+" have invalid values:"+NEWLINE_INDENT+A.join(NEWLINE_INDENT)}}};v$2.strictShape=function n(t){var s=v$2.shape(t);return function(p){var g=s(p);if(g)return g;var w=Object.keys(p).reduce(function(u,A){return t[A]===void 0&&u.push(A),u},[]);if(w.length!==0)return function(){return"The following keys are invalid: "+w.join(", ")}}};v$2.arrayOf=function n(t){return createArrayValidator(t)};v$2.tuple=function n(){var t=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return createArrayValidator(t)};function createArrayValidator(n){var t=Array.isArray(n),s=function(l){return t?n[l]:n};return function(p){var g=validate(v$2.plainArray,p);if(g)return g;if(t&&p.length!==n.length)return"an array with "+n.length+" items";for(var w=0;w<p.length;w++)if(g=validate(s(w),p[w]),g)return[w].concat(g)}}v$2.required=function n(t){function s(l){return l==null?function(p){return formatErrorMessage(p,isArrayCulprit(p.path)?"cannot be undefined/null.":"is required.")}:t.apply(this,arguments)}return s.__required=!0,s};v$2.oneOfType=function n(){var t=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(l){var p=t.map(function(g){return validate(g,l)}).filter(Boolean);if(p.length===t.length)return p.every(function(g){return g.length===1&&typeof g[0]=="string"})?orList(p.map(function(g){return g[0]})):p.reduce(function(g,w){return w.length>g.length?w:g})}};v$2.equal=function n(t){return function(l){if(l!==t)return JSON.stringify(t)}};v$2.oneOf=function n(){var t=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),s=t.map(function(l){return v$2.equal(l)});return v$2.oneOfType.apply(this,s)};v$2.range=function n(t){var s=t[0],l=t[1];return function(g){var w=validate(v$2.number,g);if(w||g<s||g>l)return"number between "+s+" & "+l+" (inclusive)"}};v$2.any=function n(){};v$2.boolean=function n(t){if(typeof t!="boolean")return"boolean"};v$2.number=function n(t){if(typeof t!="number")return"number"};v$2.plainArray=function n(t){if(!Array.isArray(t))return"array"};v$2.plainObject=function n(t){if(!isPlainObject(t))return"object"};v$2.string=function n(t){if(typeof t!="string")return"string"};v$2.func=function n(t){if(typeof t!="function")return"function"};function validate(n,t){if(!(t==null&&!n.hasOwnProperty("__required"))){var s=n(t);if(s)return Array.isArray(s)?s:[s]}}function processMessage(n,t){var s=n.length,l=n[s-1],p=n.slice(0,s-1);return p.length===0&&(p=[DEFAULT_ERROR_PATH]),t=xtend$2(t,{path:p}),typeof l=="function"?l(t):formatErrorMessage(t,prettifyResult(l))}function orList(n){return n.length<2?n[0]:n.length===2?n.join(" or "):n.slice(0,-1).join(", ")+", or "+n.slice(-1)}function prettifyResult(n){return"must be "+addArticle(n)+"."}function addArticle(n){return/^an? /.test(n)?n:/^[aeiou]/i.test(n)?"an "+n:/^[a-z]/i.test(n)?"a "+n:n}function formatErrorMessage(n,t){var s=isArrayCulprit(n.path),l=n.path.join(".")+" "+t,p=s?"Item at position ":"";return p+l}function isArrayCulprit(n){return typeof n[n.length-1]=="number"||typeof n[0]=="number"}function objectEntries(n){return Object.keys(n||{}).map(function(t){return{key:t,value:n[t]}})}v$2.validate=validate;v$2.processMessage=processMessage;var lib$1=v$2,xtend$1=immutable,v$1=lib$1;function file(n){if(typeof window!="undefined")return n instanceof commonjsGlobal.Blob||n instanceof commonjsGlobal.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof n=="string"||n.pipe!==void 0))return"Filename or Readable stream"}function assertShape(n,t){return v$1.assert(v$1.strictShape(n),t)}function date(n){var t="date";if(typeof n=="boolean")return t;try{var s=new Date(n);if(s.getTime&&isNaN(s.getTime()))return t}catch{return t}}function coordinates(n){return v$1.tuple(v$1.number,v$1.number)(n)}var validator=xtend$1(v$1,{file,date,coordinates,assertShape});function pick$1(n,t){var s=function(l,p){return t.indexOf(l)!==-1&&p!==void 0};return typeof t=="function"&&(s=t),Object.keys(n).filter(function(l){return s(l,n[l])}).reduce(function(l,p){return l[p]=n[p],l},{})}var pick_1=pick$1;function objectMap$1(n,t){return Object.keys(n).reduce(function(s,l){return s[l]=t(l,n[l]),s},{})}var objectMap_1=objectMap$1,objectMap=objectMap_1;function stringifyBoolean(n){return objectMap(n,function(t,s){return typeof s=="boolean"?JSON.stringify(s):s})}var stringifyBooleans$1=stringifyBoolean,MapiClient=mapiClient,createClient=browserClient;function createServiceFactory$1(n){return function(t){var s;MapiClient.prototype.isPrototypeOf(t)?s=t:s=createClient(t);var l=Object.create(n);return l.client=s,l}}var createServiceFactory_1=createServiceFactory$1,xtend=immutable,v=validator,pick=pick_1,stringifyBooleans=stringifyBooleans$1,createServiceFactory=createServiceFactory_1,Geocoding={},featureTypes=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Geocoding.forwardGeocode=function(n){v.assertShape({query:v.required(v.string),mode:v.oneOf("mapbox.places","mapbox.places-permanent"),countries:v.arrayOf(v.string),proximity:v.oneOf(v.coordinates,"ip"),types:v.arrayOf(v.oneOf(featureTypes)),autocomplete:v.boolean,bbox:v.arrayOf(v.number),limit:v.number,language:v.arrayOf(v.string),routing:v.boolean,fuzzyMatch:v.boolean,worldview:v.string})(n),n.mode=n.mode||"mapbox.places";var t=stringifyBooleans(xtend({country:n.countries},pick(n,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(n,["mode","query"]),query:t})};Geocoding.reverseGeocode=function(n){v.assertShape({query:v.required(v.coordinates),mode:v.oneOf("mapbox.places","mapbox.places-permanent"),countries:v.arrayOf(v.string),types:v.arrayOf(v.oneOf(featureTypes)),bbox:v.arrayOf(v.number),limit:v.number,language:v.arrayOf(v.string),reverseMode:v.oneOf("distance","score"),routing:v.boolean,worldview:v.string})(n),n.mode=n.mode||"mapbox.places";var t=stringifyBooleans(xtend({country:n.countries},pick(n,["country","types","bbox","limit","language","reverseMode","routing","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(n,["mode","query"]),query:t})};var geocoding=createServiceFactory(Geocoding);let urlAlphabet="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",random=n=>crypto.getRandomValues(new Uint8Array(n)),customRandom=(n,t,s)=>{let l=(2<<Math.log(n.length-1)/Math.LN2)-1,p=-~(1.6*l*t/n.length);return(g=t)=>{let w="";for(;;){let u=s(p),A=p;for(;A--;)if(w+=n[u[A]&l]||"",w.length===g)return w}}},customAlphabet=(n,t=21)=>customRandom(n,t,random),nanoid$1=(n=21)=>crypto.getRandomValues(new Uint8Array(n)).reduce((t,s)=>(s&=63,s<36?t+=s.toString(36):s<62?t+=(s-26).toString(36).toUpperCase():s>62?t+="-":t+="_",t),"");var index_browser=Object.freeze(Object.defineProperty({__proto__:null,nanoid:nanoid$1,customAlphabet,customRandom,urlAlphabet,random},Symbol.toStringTag,{value:"Module"})),require$$0=getAugmentedNamespace(index_browser),nanoid=require$$0.nanoid;function MapboxEventManager$1(n){this.origin=n.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=n.accessToken,this.version="0.2.0",this.sessionID=this.generateSessionID(),this.userAgent=this.getUserAgent(),this.options=n,this.send=this.send.bind(this),this.countries=n.countries?n.countries.split(","):null,this.types=n.types?n.types.split(","):null,this.bbox=n.bbox?n.bbox:null,this.language=n.language?n.language.split(","):null,this.limit=n.limit?+n.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(n),this.eventQueue=new Array,this.flushInterval=n.flushInterval||1e3,this.maxQueueSize=n.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}MapboxEventManager$1.prototype={select:function(n,t){var s=this.getSelectedIndex(n,t),l=this.getEventPayload("search.select",t);if(l.resultIndex=s,l.resultPlaceName=n.place_name,l.resultId=n.id,!(s===this.lastSentIndex&&l.queryString===this.lastSentInput||s==-1)&&(this.lastSentIndex=s,this.lastSentInput=l.queryString,!!l.queryString))return this.push(l)},start:function(n){var t=this.getEventPayload("search.start",n);if(!!t.queryString)return this.push(t)},keyevent:function(n,t){if(!!n.key&&!(n.metaKey||[9,27,37,39,13,38,40].indexOf(n.keyCode)!==-1)){var s=this.getEventPayload("search.keystroke",t);if(s.lastAction=n.key,!!s.queryString)return this.push(s)}},send:function(n,t){if(!this.enableEventLogging)return t?t():void 0;var s=this.getRequestOptions(n);this.request(s,function(l){if(l)return this.handleError(l,t);if(t)return t()}.bind(this))},getRequestOptions:function(n){Array.isArray(n)||(n=[n]);var t={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)};return t},getEventPayload:function(n,t){var s;t.options.proximity?typeof t.options.proximity=="object"?s=[t.options.proximity.longitude,t.options.proximity.latitude]:t.options.proximity==="ip"?s=[999,999]:s=t.options.proximity:s=null;var l=t._map?t._map.getZoom():void 0,p={event:n,created:+new Date,sessionIdentifier:this.sessionID,country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:t.options.autocomplete,fuzzyMatch:t.options.fuzzyMatch,proximity:s,limit:t.options.limit,routing:t.options.routing,worldview:t.options.worldview,mapZoom:l,keyboardLocale:this.locale};return n==="search.select"?p.queryString=t.inputString:n!="search.select"&&t._inputEl?p.queryString=t._inputEl.value:p.queryString=t.inputString,p},request:function(n,t){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(this.readyState==4)return this.status==204?t(null):t(this.statusText)},s.open(n.method,n.host+"/"+n.path,!0);for(var l in n.headers){var p=n.headers[l];s.setRequestHeader(l,p)}s.send(n.body)},handleError:function(n,t){if(t)return t(n)},generateSessionID:function(){return nanoid()},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(n,t){if(!!t._typeahead){var s=t._typeahead.data,l=n.id,p=s.map(function(w){return w.id}),g=p.indexOf(l);return g}},shouldEnableLogging:function(n){return!(n.enableEventLogging===!1||n.origin&&n.origin!=="https://api.mapbox.com"||n.localGeocoder||n.filter)},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(n,t){this.eventQueue.push(n),(this.eventQueue.length>=this.maxQueueSize||t)&&this.flush()},remove:function(){this.flush()}};var events=MapboxEventManager$1,placeholder={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"\u05DC\u05D7\u05E4\u05E9",ja:"\u30B5\u30FC\u30C1",lv:"Mekl\u0113t",pt:"Procurar",sr:"\u041F\u0440\u0435\u0442\u0440\u0430\u0433\u0430",zh:"\u641C\u7D22",cs:"Vyhled\xE1v\xE1n\xED",hu:"Keres\xE9s",ka:"\u10EB\u10D8\u10D4\u10D1\u10D0",nb:"S\xF8ke",sk:"Vyh\u013Ead\xE1vanie",th:"\u0E04\u0E49\u0E19\u0E2B\u0E32",fi:"Hae",is:"Leita",ko:"\uC218\uC0C9",pl:"Szukaj",sl:"Iskanje",fa:"\u062C\u0633\u062A\u062C\u0648",ru:"\u041F\u043E\u0438\u0441\u043A"},localization$1={placeholder},subtag$1={exports:{}};(function(n){(function(t,s,l){n.exports?n.exports=l():t[s]=l()})(commonjsGlobal,"subtag",function(){var t="",s=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function l(A){return A.match(s)||[]}function p(A){return l(A).filter(function(S,D){return S&&D})}function g(A){return A=l(A),{language:A[1]||t,extlang:A[2]||t,script:A[3]||t,region:A[4]||t}}function w(A,S,D){Object.defineProperty(A,S,{value:D,enumerable:!0})}function u(A,S,D){function z($){return l($)[A]||t}w(z,"pattern",S),w(g,D,z)}return u(1,/^[a-zA-Z]{2,3}$/,"language"),u(2,/^[a-zA-Z]{3}$/,"extlang"),u(3,/^[a-zA-Z]{4}$/,"script"),u(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),w(g,"split",p),g})})(subtag$1);function Geolocation$1(){}Geolocation$1.prototype={isSupport:function(){return Boolean(window.navigator.geolocation)},getCurrentPosition:function(){const n={enableHighAccuracy:!0};return new Promise(function(t,s){window.navigator.geolocation.getCurrentPosition(t,s,n)})}};var geolocation=Geolocation$1;function transformFeatureToGeolocationText(n,t){const s=getAddressInfo(n),l=["address","street","place","country"];var p;if(typeof t=="function")return t(s);const g=l.indexOf(t);return g===-1?p=l:p=l.slice(g),p.reduce(function(w,u){return s[u]?(w!==""&&(w=w+", "),w+s[u]):w},"")}function getAddressInfo(n){const t=n.address||"",s=n.text||"",l=n.place_name||"",g={address:l.split(",")[0],houseNumber:t,street:s,placeName:l};return n.context.forEach(function(w){const u=w.id.split(".")[0];g[u]=w.text}),g}const REVERSE_GEOCODE_COORD_RGX=/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/;var utils$1={transformFeatureToGeolocationText,getAddressInfo,REVERSE_GEOCODE_COORD_RGX},Typeahead=suggestions,debounce=lodash_debounce,extend=immutable,EventEmitter=events$1.exports.EventEmitter,exceptions=exceptions$1,MapboxClient=mapboxSdk,mbxGeocoder=geocoding,MapboxEventManager=events,localization=localization$1,subtag=subtag$1.exports,Geolocation=geolocation,utils=utils$1;const GEOCODE_REQUEST_TYPE={FORWARD:0,LOCAL:1,REVERSE:2};function getFooterNode(){var n=document.createElement("div");return n.className="mapboxgl-ctrl-geocoder--powered-by",n.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',n}function MapboxGeocoder(n){this._eventEmitter=new EventEmitter,this.options=extend({},this.options,n),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new Geolocation}MapboxGeocoder.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",getItemValue:function(n){return n.place_name},render:function(n){var t=n.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+t[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+t.splice(1,t.length).join(",")+"</div></div>"}},addTo:function(n){function t(s,l){if(!document.body.contains(l))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const p=s.onAdd();l.appendChild(p)}if(n._controlContainer)n.addControl(this);else if(n instanceof HTMLElement)t(this,n);else if(typeof n=="string"){const s=document.querySelectorAll(n);if(s.length===0)throw new Error("Element ",n,"not found.");if(s.length>1)throw new Error("Geocoder can only be added to a single html element");t(this,s[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(n){if(n&&typeof n!="string"&&(this._map=n),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new MapboxEventManager(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this);var t=this.container=document.createElement("div");t.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var s=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",debounce(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",function(S){this.eventManager.keyevent(S,this)}.bind(this));var l=document.createElement("div");l.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var p=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(p),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),l.appendChild(this._clearEl),l.appendChild(this._loadingEl),t.appendChild(s),t.appendChild(this._inputEl),t.appendChild(l),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var g=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(g),l.appendChild(this._geolocateEl),this._showGeolocateButton()}var w=this._typeahead=new Typeahead(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit});this.setRenderFunction(this.options.render),w.getItemValue=this.options.getItemValue;var u=w.list.draw,A=this._footerNode=getFooterNode();return w.list.draw=function(){u.call(this),A.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),A.addEventListener("mouseup",function(){this.selectingListItem=!1}.bind(this)),this.element.appendChild(A)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),t},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then(function(n){this._hideLoadingIcon();const t={geometry:{type:"Point",coordinates:[n.coords.longitude,n.coords.latitude]}};this._handleMarker(t),this._fly(t),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(t),this._showClearButton(),this.fresh=!1;const s={limit:1,language:[this.options.language],query:t.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){const l=t.geometry.coordinates[0]+","+t.geometry.coordinates[1];this._setInputValue(l),this._eventEmitter.emit("result",{result:t})}else this.geocoderService.reverseGeocode(s).send().then(function(l){const p=l.body.features[0];if(p){const g=utils.transformFeatureToGeolocationText(p,this.options.addressAccuracy);this._setInputValue(g),p.user_coordinates=t.geometry.coordinates,this._eventEmitter.emit("result",{result:p})}else this._eventEmitter.emit("result",{result:{user_coordinates:t.geometry.coordinates}})}.bind(this))}.bind(this)).catch(function(n){n.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}.bind(this))},createIcon:function(n,t){var s=document.createElementNS("http://www.w3.org/2000/svg","svg");return s.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+n),s.setAttribute("viewBox","0 0 18 18"),s.setAttribute("xml:space","preserve"),s.setAttribute("width",18),s.setAttribute("height",18),s.innerHTML=t,s},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(n){this._inputEl.value=n,setTimeout(function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}.bind(this),1)},_onPaste:function(n){var t=(n.clipboardData||window.clipboardData).getData("text");t.length>=this.options.minLength&&this._geocode(t)},_onKeyDown:function(n){var t=27,s=9;if(n.keyCode===t&&this.options.clearAndBlurOnEsc)return this._clear(n),this._inputEl.blur();var l=n.target&&n.target.shadowRoot?n.target.shadowRoot.activeElement:n.target,p=l?l.value:"";if(!p)return this.fresh=!0,n.keyCode!==s&&this.clear(n),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(n.metaKey||[s,t,37,39,13,38,40].indexOf(n.keyCode)!==-1)&&l.value.length>=this.options.minLength&&this._geocode(l.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(n){this.options.clearOnBlur&&this._clearOnBlur(n),this.options.collapsed&&this._collapse()},_onChange:function(){var n=this._typeahead.selected;n&&JSON.stringify(n)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(n),this.options.marker&&this._mapboxgl&&this._handleMarker(n),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(n),this._eventEmitter.emit("result",{result:n}),this.eventManager.select(n,this))},_fly:function(n){var t;if(n.properties&&exceptions[n.properties.short_code])t=extend({},this.options.flyTo),this._map&&this._map.fitBounds(exceptions[n.properties.short_code].bbox,t);else if(n.bbox){var s=n.bbox;t=extend({},this.options.flyTo),this._map&&this._map.fitBounds([[s[0],s[1]],[s[2],s[3]]],t)}else{var l={zoom:this.options.zoom};t=extend({},l,this.options.flyTo),n.center?t.center=n.center:n.geometry&&n.geometry.type&&n.geometry.type==="Point"&&n.geometry.coordinates&&(t.center=n.geometry.coordinates),this._map&&this._map.flyTo(t)}},_requestType:function(n,t){var s;return n.localGeocoderOnly?s=GEOCODE_REQUEST_TYPE.LOCAL:n.reverseGeocode&&utils.REVERSE_GEOCODE_COORD_RGX.test(t)?s=GEOCODE_REQUEST_TYPE.REVERSE:s=GEOCODE_REQUEST_TYPE.FORWARD,s},_setupConfig:function(n,t){const s=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],l=/[\s,]+/;var p=this,g=s.reduce(function(u,A){if(p.options[A]===void 0||p.options[A]===null)return u;["countries","types","language"].indexOf(A)>-1?u[A]=p.options[A].split(l):u[A]=p.options[A];const S=typeof p.options[A].longitude=="number"&&typeof p.options[A].latitude=="number";if(A==="proximity"&&S){const D=p.options[A].longitude,z=p.options[A].latitude;u[A]=[D,z]}return u},{});switch(n){case GEOCODE_REQUEST_TYPE.REVERSE:{var w=t.split(l).map(function(u){return parseFloat(u,10)});p.options.flipCoordinates||w.reverse(),g.types&&g.types[0],g=extend(g,{query:w,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(u){u in g&&delete g[u]})}break;case GEOCODE_REQUEST_TYPE.FORWARD:{const u=t.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(u)&&(t=t.replace(/,/g," ")),g=extend(g,{query:t})}break}return g},_geocode:function(n){this.inputString=n,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:n});const t=this._requestType(this.options,n),s=this._setupConfig(t,n);var l;switch(t){case GEOCODE_REQUEST_TYPE.LOCAL:l=Promise.resolve();break;case GEOCODE_REQUEST_TYPE.FORWARD:l=this.geocoderService.forwardGeocode(s).send();break;case GEOCODE_REQUEST_TYPE.REVERSE:l=this.geocoderService.reverseGeocode(s).send();break}var p=this.options.localGeocoder?this.options.localGeocoder(n)||[]:[],g=[],w=null;return l.catch(function(u){w=u}.bind(this)).then(function(u){this._hideLoadingIcon();var A={};return u?u.statusCode=="200"&&(A=u.body,A.request=u.request,A.headers=u.headers):A={type:"FeatureCollection",features:[]},A.config=s,this.fresh&&(this.eventManager.start(this),this.fresh=!1),A.features=A.features?p.concat(A.features):p,this.options.externalGeocoder?(g=this.options.externalGeocoder(n,A.features)||Promise.resolve([]),g.then(function(S){return A.features=A.features?S.concat(A.features):S,A},function(){return A})):A}.bind(this)).then(function(u){if(w)throw w;this.options.filter&&u.features.length&&(u.features=u.features.filter(this.options.filter)),u.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",u),this._typeahead.update(u.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",u))}.bind(this)).catch(function(u){this._hideLoadingIcon(),this._hideAttribution(),p.length&&this.options.localGeocoder||g.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(p)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:p}),this._eventEmitter.emit("error",{error:u})}.bind(this)),l},_clear:function(n){n&&n.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(n){this._clear(n),this._inputEl.focus()},_clearOnBlur:function(n){var t=this;n.relatedTarget&&t._clear(n)},_onQueryResult:function(n){var t=n.body;if(!!t.features.length){var s=t.features[0];this._typeahead.selected=s,this._inputEl.value=s.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var n=this._map.getCenter().wrap();this.setProximity({longitude:n.lng,latitude:n.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(n){return this._geocode(n).then(this._onQueryResult),this},_renderError:function(){var n="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(n)},_renderLocationError:function(){var n="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(n)},_renderNoResults:function(){var n="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(n)},_renderUserDeniedGeolocationError:function(){var n="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(n)},_renderMessage:function(n){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(n)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var n=this.options.language.split(",")[0],t=subtag.language(n),s=localization.placeholder[t];if(s)return s}return"Search"},setInput:function(n){return this._inputEl.value=n,this._typeahead.selected=null,this._typeahead.clear(),n.length>=this.options.minLength&&this._geocode(n),this},setProximity:function(n,t=!0){return this.options.proximity=n,t&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(n){return n&&typeof n=="function"&&(this._typeahead.render=n),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(n){var t=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=n||this.options.language||t,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(n){return this.options.zoom=n,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(n){return this.options.flyTo=n,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(n){return this.placeholder=n||this._getPlaceholderText(),this._inputEl.placeholder=this.placeholder,this._inputEl.setAttribute("aria-label",this.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(n){return this.options.bbox=n,this},getCountries:function(){return this.options.countries},setCountries:function(n){return this.options.countries=n,this},getTypes:function(){return this.options.types},setTypes:function(n){return this.options.types=n,this},getMinLength:function(){return this.options.minLength},setMinLength:function(n){return this.options.minLength=n,this._typeahead&&(this._typeahead.options.minLength=n),this},getLimit:function(){return this.options.limit},setLimit:function(n){return this.options.limit=n,this._typeahead&&(this._typeahead.options.limit=n),this},getFilter:function(){return this.options.filter},setFilter:function(n){return this.options.filter=n,this},setOrigin:function(n){return this.options.origin=n,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(n){return this.options.accessToken=n,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(n){return this.options.autocomplete=n,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(n){return this.options.fuzzyMatch=n,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(n){return this.options.routing=n,this},getRouting:function(){return this.options.routing},setWorldview:function(n){return this.options.worldview=n,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(n){if(!!this._map){this._removeMarker();var t={color:"#4668F2"},s=extend({},t,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(s),n.center?this.mapMarker.setLngLat(n.center).addTo(this._map):n.geometry&&n.geometry.type&&n.geometry.type==="Point"&&n.geometry.coordinates&&this.mapMarker.setLngLat(n.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(n,t){return this._eventEmitter.on(n,t),this},off:function(n,t){return this._eventEmitter.removeListener(n,t),this.eventManager.remove(),this}};var lib=MapboxGeocoder,mapboxMapViewer_vue_vue_type_style_index_0_lang="";let geocoder;const _sfc_main$3={name:"mapbox-map-viewer",setup(){return{dirHandle:ref(""),style_url:ref(""),access_token:ref(""),mapbox_raster_png_dem:ref(""),mapbox_api_url:ref(""),mapbox_rgb_image_url:ref(""),map:ref(""),threedview:ref(!1),layers:ref(["hillshading","bounding_box","undersea-features-lines","undersea-features-points","undersea-features-points-label","10m-bathymetry-81bsvj"]),layer_type:[{label:"Hillshade",value:"hillshading"},{label:"Bounding Box",value:"bounding_box"},{label:"Undersea Lines",value:"undersea-features-lines"},{label:"Undersea Points",value:"undersea-features-points"},{label:"Undersea Labels",value:"undersea-features-points-label"},{label:"Depth",value:"10m-bathymetry-81bsvj"},{label:"Satellite",value:"satellite"},{label:"3D",value:"3d"}]}},mounted(){},methods:{async changeLayers(n){for(const t of this.layer_type)n.includes(t.value)?t.value!=="3d"?this.map.setLayoutProperty(t.value,"visibility","visible"):this.map.setTerrain({source:"mapbox-3d",exaggeration:1.5}):t.value!=="3d"?this.map.setLayoutProperty(t.value,"visibility","none"):this.map.setTerrain(null)},loadMapSourcesLayers(n){n.addSource("mapbox_terrain_dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1"}),n.addSource("satellite",{type:"raster",url:"mapbox://mapbox.satellite",tileSize:512}),n.addLayer({id:"satellite",source:"satellite",type:"raster",layout:{visibility:"none"}}),n.addLayer({id:"hillshading",source:"mapbox_terrain_dem",type:"hillshade"}),n.addSource("bounding_box_source",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,1],[1,1],[1,0],[0,0]]]}}}),n.addLayer({id:"bounding_box",type:"fill",source:"bounding_box_source",paint:{"fill-color":"#008888","fill-opacity":0}}),n.addSource("bathymetry",{type:"vector",url:"mapbox://mapbox-public.bathymetry"}),n.addLayer({id:"undersea-features-lines",type:"line",source:"bathymetry","source-layer":"undersea-features-lines",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ff69b4","line-width":2}}),n.addLayer({id:"undersea-features-points",type:"circle",source:"bathymetry","source-layer":"undersea-features-points",paint:{"circle-radius":4,"circle-color":"#01fe01"}}),n.addLayer({id:"undersea-features-points-label",type:"symbol",source:"bathymetry","source-layer":"undersea-features-points",layout:{"text-field":"{name}","text-anchor":"top-left","text-size":12}}),n.addSource("10m-bathymetry-81bsvj",{type:"vector",url:"mapbox://mapbox.9tm8dx88"}),n.addSource("mapbox-3d",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:14}),n.addLayer({id:"10m-bathymetry-81bsvj",type:"fill",source:"10m-bathymetry-81bsvj","source-layer":"10m-bathymetry-81bsvj",layout:{},paint:{"fill-outline-color":"hsla(337, 82%, 62%, 0)","fill-color":["interpolate",["cubic-bezier",0,.5,1,.5],["get","DEPTH"],200,"#78bced",9e3,"#15659f"]}},"land-structure-polygon")},async loadMapboxMap(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.mapbox_api_url=await idbKeyval.get("mapbox_api_url"),this.dirHandle=await idbKeyval.get("dirHandle"),this.style_url=await idbKeyval.get("style_url"),this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem");let n=this,t=new mapboxgl.Map({container:"map",trackResize:!0,style:n.style_url,center:[-121.7598,46.876],zoom:9,doubleClickZoom:!0,antialias:!0,boxZoom:!0,failIfMajorPerformanceCaveat:!0});this.map=t;const s=function(w){const u=w.match(/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i);if(!u)return null;function A($,O){return{center:[$,O],geometry:{type:"Point",coordinates:[$,O]},place_name:"Lat: "+O+" Lng: "+$,place_type:["coordinate"],properties:{},type:"Feature"}}const S=Number(u[1]),D=Number(u[2]),z=[];return(S<-90||S>90)&&z.push(A(S,D)),(D<-90||D>90)&&z.push(A(D,S)),z.length===0&&(z.push(A(S,D)),z.push(A(D,S))),z};geocoder=new lib({accessToken:this.access_token,mapboxgl,localGeocoder:s,zoom:10,placeholder:"Try: -40, 170 or  Name",reverseGeocode:!0}),t.addControl(geocoder),t.addControl(new mapboxgl.FullscreenControl({})),t.addControl(new mapboxgl.NavigationControl);const l=100,p=25;function g(w){return w*(2-w)}t.on("style.load",()=>{const w=()=>{t.isStyleLoaded()?n.loadMapSourcesLayers(t):setTimeout(w,200)};w()}),t.on("load",function(){t.getCanvas().focus(),t.getCanvas().addEventListener("keydown",w=>{w.preventDefault(),w.which===87?t.panBy([0,-l],{easing:g}):w.which===83?t.panBy([0,l],{easing:g}):w.which===65?t.easeTo({bearing:t.getBearing()-p,easing:g}):w.which===68&&t.easeTo({bearing:t.getBearing()+p,easing:g})},!0)}),t.on("error",w=>{console.error(w)}),t.on("click",async function(w){let u=await idbKeyval.get("dirHandle");if(await fileUtils.verifyPermission(u,!0)===!1){console.error(`User did not grant permission to '${u.name}'`);return}let A=w.lngLat.lng,S=w.lngLat.lat,D=mapUtils.getTileInfo(A,S,t);idbKeyval.set("tile_info",D),await n.geoCodeReverse(D),t.getSource("bounding_box_source").setData(D.polygon_bb),t.setPaintProperty("bounding_box","fill-opacity",.45),n.mapbox_rgb_image_url=n.mapbox_api_url+n.mapbox_raster_png_dem+`/${D.z}/${D.x}/${D.y}@2x.pngraw?access_token=`+n.access_token;let z=await mapUtils.getMapboxTerrainRgb(u,D,n.mapbox_rgb_image_url),$=await z.toBuffer();await idbKeyval.set("rgb_image_buffer",$),await fileUtils.writeFileToDisk(u,D.rgbFileName,$);let O=mapUtils.createHeightMapImage(z,32,"GREY");if(await fileUtils.fileExists(u,D.thirtyTwoFileName)===!1){let K=await O.image.toBuffer();await fileUtils.writeFileToDisk(u,D.thirtyTwoFileName,K)}emitter.emit("updatePreviewImage",{dir_handle:u,tile_info:D,preview_image_info:O,map:t})}),t.on("mousemove",w=>{t.getCanvas().style.cursor="pointer";const u=t.queryRenderedFeatures(w.point);for(const A of u)if(Object.keys(A.type).length>0&&Object.keys(A.properties).length>0){let S=A.properties;A.layer,S.DEPTH}})},resizeMap(){this.map.resize()},async geoCodeReverse(n){geocoding({accessToken:mapboxgl.accessToken}).reverseGeocode({query:[n.pointLng,n.pointLat]}).send().then(function(s){if(s&&s.body&&s.body.features){n.address=s.body.features[0].place_name;let l=s.body.features[0].context;for(let p of l){let g=p.id;switch(g.substring(0,g.indexOf("."))){case"neighborhood":n.neighborhood=p.text;break;case"postcode":n.postcode=p.text;break;case"locality":n.locality=p.text;break;case"place":n.place=p.text;break;case"district":n.district=p.text;break;case"region":n.region=p.text;break;case"country":n.country=p.text;break}}}})}}},_hoisted_1$3={id:"map"},_hoisted_2$3={class:"row no-wrap q-pa-md"},_hoisted_3$2={class:"column"},_hoisted_4$2=createBaseVNode("u",null,[createBaseVNode("b",null,"Enable Layers")],-1);function _sfc_render$3(n,t,s,l,p,g){const w=resolveComponent("q-option-group"),u=resolveComponent("q-menu"),A=resolveComponent("q-btn"),S=resolveComponent("q-toolbar");return openBlock(),createElementBlock("div",_hoisted_1$3,[createVNode(S,{id:"mb-tbar",class:"bg-primary text-white q-pa-none q-ma-none"},{default:withCtx(()=>[createVNode(A,{color:"info",label:"Map Settings"},{default:withCtx(()=>[createVNode(u,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_2$3,[createBaseVNode("div",_hoisted_3$2,[_hoisted_4$2,createVNode(w,{dense:"",color:"green","checked-icon":"check","unchecked-icon":"clear",options:l.layer_type,type:"toggle",modelValue:l.layers,"onUpdate:modelValue":[t[0]||(t[0]=D=>l.layers=D),g.changeLayers]},null,8,["options","modelValue","onUpdate:modelValue"])])])]),_:1})]),_:1})]),_:1})])}var MapboxMapViewer=_export_sfc(_sfc_main$3,[["render",_sfc_render$3]]);const gdalWorker=new Worker("gdalWorker.js"),_sfc_main$2={name:"SideNav",setup(){const n=useQuasar();return{alert:ref(!1),access_token:ref(""),isDisabled:ref(!1),unrealLandscape:ref({label:505,value:505}),landscapeSize:[{label:"8129x8129",value:8129},{label:"4033x4033",value:4033},{label:"2017x2017",value:2017},{label:"1009x1009",value:1009},{label:"512x512-Downloaded-Size",value:512},{label:"505x505",value:505}],url:ref("thirtytwo-9-82-180.png"),tile_info:ref(""),save_fileName:ref(""),dirHandle:ref(""),preview_image_info:ref(""),rgb_image:ref(""),map:null,data:null,bbinfoalert:ref(!1),exportType:ref("unreal"),landscapeName:ref(""),unrealMapPath:ref(""),qt:n,otherOptionsModel:ref(["zrange"]),alertMsg:ref(""),otherOptions:[{label:"Zrange-sea level=0",value:"zrange"}],exportOptions:[{label:"Unreal",value:"unreal"},{label:"Normalize",value:"normalize"},{label:"None",value:"none"}]}},async mounted(){emitter.on("updatePreviewImage",n=>{this.data=n,this.updatePreviewImage()})},methods:{adjustedZscale(){let n=this.getUnrealZScale(this.preview_image_info.maxElevation),t=32767;return this.otherOptionsModel.includes("zrange")?(this.tile_info.startZRange=t,this.tile_info.zscale=(t/n).toFixed(3)):(this.tile_info.startZRange=0,this.tile_info.zscale=n.toFixed(3)),this.tile_info.zscale},otherOptionsModelChange(n){this.otherOptionsModel=n,this.adjustedZscale()},showBBInfo(){this.tile_info?this.bbinfoalert=!0:this.alert=!0},async sendToUnreal(){this.unrealMapPath=await idbKeyval.get("mappath");let n=this.tile_info.sixteenFileName,t=await idbKeyval.get("dirHandle");if(fileUtils.verifyPermission(t,!0)===!1){console.error(`User did not grant permission to '${t.name}'`);return}let s=await fileUtils.fileExists(t,n),l;if(s)if(this.tile_info){console.log("sending"),this.qt.loading.show(),this.tile_info.landscapeName=this.landscapeName;let p="http://localhost:30010/",g="remote/object/call",w={};w={objectPath:"/Script/UnrealEd.Default__EditorActorSubsystem",functionName:"GetAllLevelActors"};let u="",A="Mapbox_BP",S=await mapUtils.unrealRemoteControl(w,p+g);for(let D of S.ReturnValue)D.includes(A)===!0&&(u=D);w={objectPath:u,functionName:"GenerateMapboxLandscape",parameters:{LandscapeName:this.tile_info.landscapeName,LandscapeSize:this.tile_info.resolution.toString(),TileHeightmapFileName:this.tile_info.sixteenFileName,TileGeojsonFileName:this.tile_info.geoJsonFileName,TileInfoFileName:this.tile_info.tileInfoFileName,OriginLng:this.tile_info.originLng.toString(),OriginLat:this.tile_info.originLat.toString(),Epsg:this.tile_info.epsg.toString(),OriginNorthing:this.tile_info.OriginNorthing.toString(),OriginEasting:this.tile_info.OriginEasting.toString(),PointNorthing:this.tile_info.pointNorthing.toString(),PointEasting:this.tile_info.pointEasting.toString()}},l=await mapUtils.unrealRemoteControl(w,p+g),console.log(l),this.qt.loading.hide()}else this.alert=!0;else this.alertMsg="Please download heightmap first",this.alert=!0},updateStats(){this.preview_image_info.maxElevation!==""?(this.tile_info.MaxElevation=this.preview_image_info.maxElevation,this.tile_info.MinElevation=this.preview_image_info.minElevation,this.tile_info.minmax=this.tile_info.MinElevation.toFixed(3)+" / "+this.tile_info.MaxElevation.toFixed(3),this.tile_info.elevation_range=(this.tile_info.MaxElevation-this.tile_info.MinElevation).toFixed(3),this.tile_info.zscale=this.adjustedZscale()):this.tile_info.minmax=""},getUnrealZScale(n){return n*100*.001953125},async writeFiles(n){let t=await idbKeyval.get("dirHandle");await fileUtils.writeFileToDisk(t,this.tile_info.sixteenFileName,n);let s=mapUtils.getFeaturesFromBB(this.map,this.tile_info),l=JSON.stringify(s),p=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(t,l),await fileUtils.writeFileToDisk(t,this.tile_info.tileInfoFileName,p)},async updatePreviewImage(){this.preview_image_info=await this.data.preview_image_info,this.tile_info=this.data.tile_info,this.map=this.data.map;let n=await this.preview_image_info.image.toBlob();const t=URL.createObjectURL(n);this.url=t,this.updateStats(this.tile_info)},async saveImage(n,t){let s=await idbKeyval.get("dirHandle"),l=new Blob([n],{type:"image/png"});await fileUtils.writeFileToDisk(s,t,l)},async createWorker(n,t,s){let l=this;return new Promise(function(p){let g=new File([n],"temp.png",{type:"image/png",lastModified:Date.now()}),w=new DataTransfer;w.items.add(g);let u=w.files,A={};A.files=u,A.translateOptions=s,gdalWorker.postMessage(A),gdalWorker.onmessage=async function(S){console.log(t),await l.saveImage(S.data,t),p(!0)}})},async createSixteenHeightMap(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.tile_info.resolution=this.unrealLandscape.value,this.tile_info.geoJsonFileName="geojson-"+this.tile_info.mapboxTileName+".json",this.tile_info.tileInfoFileName="tile-info-"+this.tile_info.mapboxTileName+".json",this.tile_info.sixteenFileName="sixteen-"+this.tile_info.mapboxTileName+"-LandscapeSize-"+this.tile_info.resolution+".png";let n=await idbKeyval.get("mapbox_satellite_endpoint");await idbKeyval.get("mapbox_api_url"),this.tile_info.mapbox_satellite_image_url=n+`/${this.tile_info.z}/${this.tile_info.x}/${this.tile_info.y}?access_token=`+this.access_token;let t="satellite-"+this.tile_info.mapboxTileName+"-LandscapeSize-"+this.tile_info.resolution+".png";if(this.tile_info){this.qt.loading.show();let s=await idbKeyval.get("dirHandle");if(fileUtils.verifyPermission(s,!0)===!1){console.error(`User did not grant permission to '${s.name}'`);return}if(fileUtils.fileExists(s,this.tile_info.thirtytwoFile)){let p=await idbKeyval.get("rgb_image_buffer"),g=await mapUtils.downloadTerrainRgb(this.tile_info.mapbox_satellite_image_url),w=await mapUtils.loadImageFromArray(p),u=mapUtils.createHeightMapImage(w,16,"GREY"),A=u.image,S=parseInt(u.minElevation).toString(),D=parseInt(u.maxElevation).toString(),z=await A.toBuffer();this.tile_info.resampleSize=this.unrealLandscape.value.toString(),this.tile_info.resizeMethod="lanczos",this.tile_info.exportType=this.exportType;let $=mapUtils.converLatLngTotUtm(this.tile_info.originLat,this.tile_info.originLng);switch(this.tile_info.OriginNorthing=$.northing,this.tile_info.OriginEasting=$.easting,this.tile_info.exportType){case"unreal":let Y=["-ot","UInt16","-of","PNG","-scale",S,D,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod];await this.createWorker(z,this.tile_info.sixteenFileName,Y),Y=["-of","PNG","-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod],await this.createWorker(g,t,Y),this.qt.loading.hide();break;case"normalize":let fe=fe.level();await fileUtils.writeFileToDisk(s,this.tile_info.sixteenFileName,fe.toBuffer()),this.qt.loading.hide();break;case"none":await fileUtils.writeFileToDisk(s,this.tile_info.sixteenFileName,fe.toBuffer()),this.qt.loading.hide();break}let O=mapUtils.getFeaturesFromBB(this.map,this.tile_info),q=mapUtils.convertGeoJsonCoordinatesToUTM(O),K=JSON.stringify(q),J=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(s,this.tile_info.geoJsonFileName,K),await fileUtils.writeFileToDisk(s,this.tile_info.tileInfoFileName,J)}else this.alertMsg="Please download file first",this.alert=!0}else this.alert=!0}}},_hoisted_1$2=createBaseVNode("div",{id:"previewTitle",class:"text-h6 bg-primary text-white"},"Preview Image",-1),_hoisted_2$2={class:"row justify-start q-pa-none q-ma-none"},_hoisted_3$1={style:{width:"100%"}},_hoisted_4$1={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_5$1={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_6$1=createTextVNode("Export Type:"),_hoisted_7$1={class:"row justify-around q-pt-none q-mt-sm"},_hoisted_8$1={class:"row justify-betweenq-pt-none q-mt-xs"},_hoisted_9=createBaseVNode("div",{class:"text-h6"},[createBaseVNode("u",null,"Coordinates for Unreal LandscapeGen Plugin")],-1),_hoisted_10=createBaseVNode("div",{class:"text-h6"},"Max Latitude:",-1),_hoisted_11=createBaseVNode("div",{class:"text-h6"},"Max Longitude:",-1),_hoisted_12=createBaseVNode("div",{class:"text-h6"}," Min Latitude:",-1),_hoisted_13=createBaseVNode("div",{class:"text-h6"}," Min Longitude:",-1),_hoisted_14=createBaseVNode("div",{class:"text-h6"},"Zoom:",-1),_hoisted_15=createBaseVNode("div",{class:"text-h6"},"Mouse Point Lat:",-1),_hoisted_16=createBaseVNode("div",{class:"text-h6"},"Mouse Point Lng:",-1),_hoisted_17=createBaseVNode("div",{class:"text-h6"},"Mouse Point Northing:",-1),_hoisted_18=createBaseVNode("div",{class:"text-h6"},"Mouse Point Easting:",-1),_hoisted_19=createBaseVNode("div",{class:"text-h6"},"Center Northing:",-1),_hoisted_20=createBaseVNode("div",{class:"text-h6"},"Center Easting:",-1),_hoisted_21=createBaseVNode("div",{class:"text-h6"},"swNorthing:",-1),_hoisted_22=createBaseVNode("div",{class:"text-h6"},"swEasting:",-1),_hoisted_23=createBaseVNode("div",{class:"text-h6"},"neNorthing:",-1),_hoisted_24=createBaseVNode("div",{class:"text-h6"},"neEasting:",-1),_hoisted_25=createBaseVNode("div",{class:"text-h6"},"nwNorthing:",-1),_hoisted_26=createBaseVNode("div",{class:"text-h6"},"nwEasting:",-1),_hoisted_27=createBaseVNode("div",{class:"text-h6"},"seNorthing:",-1),_hoisted_28=createBaseVNode("div",{class:"text-h6"},"seEasting:",-1),_hoisted_29=createBaseVNode("div",{class:"text-h6"},"Alert",-1);function _sfc_render$2(n,t,s,l,p,g){const w=resolveComponent("q-img"),u=resolveComponent("q-field"),A=resolveComponent("q-item-label"),S=resolveComponent("q-option-group"),D=resolveComponent("q-select"),z=resolveComponent("q-input"),$=resolveComponent("q-btn"),O=resolveComponent("q-card-section"),q=resolveComponent("q-card-actions"),K=resolveComponent("q-card"),J=resolveComponent("q-dialog"),Y=resolveDirective("close-popup");return openBlock(),createElementBlock(Fragment,null,[_hoisted_1$2,createVNode(w,{src:l.url,height:"150px"},null,8,["src"]),createBaseVNode("div",_hoisted_2$2,[createBaseVNode("div",_hoisted_3$1,[createVNode(u,{dense:"",class:"text-weight-bolder q-pt-none q-mt-xs",label:"Min/Max Elevation","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_4$1,toDisplayString(this.tile_info.minmax),1)]),_:1}),createVNode(u,{class:"q-pt-none q-mt-xs",dense:"",label:"Unreal Z-Scale",hint:"Input into Unreal Landscape Z scale","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_5$1,toDisplayString(this.tile_info.zscale),1)]),_:1}),createVNode(A,{class:"q-pt-none q-mt-xs"},{default:withCtx(()=>[_hoisted_6$1]),_:1}),createVNode(S,{class:"q-mt-none q-pt-none",dense:"",inline:"",options:l.exportOptions,type:"radio",modelValue:l.exportType,"onUpdate:modelValue":t[0]||(t[0]=fe=>l.exportType=fe)},null,8,["options","modelValue"]),createVNode(S,{class:"q-mt-none q-pt-none",dense:"",inline:"",options:l.otherOptions,"onUpdate:modelValue":[g.otherOptionsModelChange,t[1]||(t[1]=fe=>l.otherOptionsModel=fe)],type:"checkbox",modelValue:l.otherOptionsModel},null,8,["options","onUpdate:modelValue","modelValue"]),createVNode(D,{dense:"",class:"q-pt-none q-mt-xs",label:"Landscape Size","transition-show":"scale","transition-hide":"scale",hint:"Unreal Recommended Sizes",outlined:"",modelValue:l.unrealLandscape,"onUpdate:modelValue":t[2]||(t[2]=fe=>l.unrealLandscape=fe),options:l.landscapeSize},null,8,["modelValue","options"])])]),createVNode(u,{class:"q-pt-none q-mt-xs",dense:"",label:"Landscape Name (Optional)",hint:"Enter Unique Landscape Name"},{default:withCtx(()=>[createVNode(z,{modelValue:l.landscapeName,"onUpdate:modelValue":t[3]||(t[3]=fe=>l.landscapeName=fe)},null,8,["modelValue"])]),_:1}),createBaseVNode("div",_hoisted_7$1,[createVNode($,{onClick:g.showBBInfo,dense:"",color:"orange","no-caps":"",label:"Show Bounding Box Info"},null,8,["onClick"])]),createBaseVNode("div",_hoisted_8$1,[createVNode($,{onClick:g.createSixteenHeightMap,dense:"",color:"primary","no-caps":"",label:"Download HeightMap"},null,8,["onClick"]),createVNode($,{onClick:g.sendToUnreal,disabled:l.isDisabled,dense:"",color:"green",class:"q-ml-xs","no-caps":"",label:"Send To Unreal"},null,8,["onClick","disabled"])]),createVNode(J,{modelValue:l.bbinfoalert,"onUpdate:modelValue":t[4]||(t[4]=fe=>l.bbinfoalert=fe)},{default:withCtx(()=>[createVNode(K,null,{default:withCtx(()=>[createVNode(O,null,{default:withCtx(()=>[_hoisted_9]),_:1}),createVNode(O,{class:"q-pt-none"},{default:withCtx(()=>[_hoisted_10,createTextVNode(" "+toDisplayString(l.tile_info.bbox[3])+" ",1),_hoisted_11,createTextVNode(" "+toDisplayString(this.tile_info.bbox[0])+" ",1),_hoisted_12,createTextVNode(" "+toDisplayString(l.tile_info.bbox[1])+" ",1),_hoisted_13,createTextVNode(" "+toDisplayString(l.tile_info.bbox[2])+" ",1),_hoisted_14,createTextVNode(" "+toDisplayString(l.tile_info.z)+" ",1),_hoisted_15,createTextVNode(" "+toDisplayString(l.tile_info.pointLat)+" ",1),_hoisted_16,createTextVNode(" "+toDisplayString(l.tile_info.pointLng)+" ",1),_hoisted_17,createTextVNode(" "+toDisplayString(l.tile_info.pointNorthing)+" ",1),_hoisted_18,createTextVNode(" "+toDisplayString(l.tile_info.pointEasting)+" ",1),_hoisted_19,createTextVNode(" "+toDisplayString(l.tile_info.ctNorthing)+" ",1),_hoisted_20,createTextVNode(" "+toDisplayString(l.tile_info.ctEasting)+" ",1),_hoisted_21,createTextVNode(" "+toDisplayString(l.tile_info.swNorthing)+" ",1),_hoisted_22,createTextVNode(" "+toDisplayString(l.tile_info.swEasting)+" ",1),_hoisted_23,createTextVNode(" "+toDisplayString(l.tile_info.neNorthing)+" ",1),_hoisted_24,createTextVNode(" "+toDisplayString(l.tile_info.neEasting)+" ",1),_hoisted_25,createTextVNode(" "+toDisplayString(l.tile_info.nwNorthing)+" ",1),_hoisted_26,createTextVNode(" "+toDisplayString(l.tile_info.nwEasting)+" ",1),_hoisted_27,createTextVNode(" "+toDisplayString(l.tile_info.seNorthing)+" ",1),_hoisted_28,createTextVNode(" "+toDisplayString(l.tile_info.seEasting),1)]),_:1}),createVNode(q,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode($,{flat:"",label:"OK",color:"primary"},null,512),[[Y]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),createVNode(J,{modelValue:l.alert,"onUpdate:modelValue":t[5]||(t[5]=fe=>l.alert=fe)},{default:withCtx(()=>[createVNode(K,null,{default:withCtx(()=>[createVNode(O,null,{default:withCtx(()=>[_hoisted_29]),_:1}),createVNode(O,{class:"q-pt-none"},{default:withCtx(()=>[createTextVNode(toDisplayString(l.alertMsg),1)]),_:1}),createVNode(q,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode($,{flat:"",label:"OK",color:"primary"},null,512),[[Y]])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}var SideNav=_export_sfc(_sfc_main$2,[["render",_sfc_render$2]]);const _sfc_main$1={props:{},emits:["ok","hide"],methods:{show(){this.$refs.dialog.show()},hide(){this.$refs.dialog.hide()},onDialogHide(){this.$emit("hide")},onOKClick(){this.$emit("ok"),this.hide()},onCancelClick(){this.hide()}}},_hoisted_1$1=createBaseVNode("div",null,[createBaseVNode("div",{class:"text-weight-bold"},"Help Section")],-1),_hoisted_2$1=createBaseVNode("div",{class:""},"TODO:",-1);function _sfc_render$1(n,t,s,l,p,g){const w=resolveComponent("q-space"),u=resolveComponent("q-btn"),A=resolveComponent("q-card-section"),S=resolveComponent("q-separator"),D=resolveComponent("q-card-actions"),z=resolveComponent("q-card"),$=resolveComponent("q-dialog"),O=resolveDirective("close-popup");return openBlock(),createBlock($,{class:"dialog-plugin",ref:"dialog",onHide:g.onDialogHide},{default:withCtx(()=>[createVNode(z,{style:{width:"600px",height:"600px"}},{default:withCtx(()=>[createVNode(A,{class:"row items-center no-wrap",style:{height:"50px"}},{default:withCtx(()=>[_hoisted_1$1,createVNode(w),withDirectives(createVNode(u,{flat:"",round:"",icon:"close"},null,512),[[O]])]),_:1}),createVNode(S),_hoisted_2$1,createVNode(D,{class:"absolute-bottom",align:"right"},{default:withCtx(()=>[createVNode(u,{color:"primary",label:"OK",onClick:g.onOKClick},null,8,["onClick"]),createVNode(u,{color:"primary",label:"Cancel",onClick:g.onCancelClick},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["onHide"])}var Help=_export_sfc(_sfc_main$1,[["render",_sfc_render$1]]),r$1=function(){return(r$1=Object.assign||function(n){for(var t,s=1,l=arguments.length;s<l;s++)for(var p in t=arguments[s])Object.prototype.hasOwnProperty.call(t,p)&&(n[p]=t[p]);return n}).apply(this,arguments)};function o$2(n,t,s,l){return new(s||(s=Promise))(function(p,g){function w(S){try{A(l.next(S))}catch(D){g(D)}}function u(S){try{A(l.throw(S))}catch(D){g(D)}}function A(S){var D;S.done?p(S.value):(D=S.value,D instanceof s?D:new s(function(z){z(D)})).then(w,u)}A((l=l.apply(n,t||[])).next())})}function a(n,t){var s,l,p,g,w={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return g={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(g[Symbol.iterator]=function(){return this}),g;function u(A){return function(S){return function(D){if(s)throw new TypeError("Generator is already executing.");for(;w;)try{if(s=1,l&&(p=2&D[0]?l.return:D[0]?l.throw||((p=l.return)&&p.call(l),0):l.next)&&!(p=p.call(l,D[1])).done)return p;switch(l=0,p&&(D=[2&D[0],p.value]),D[0]){case 0:case 1:p=D;break;case 4:return w.label++,{value:D[1],done:!1};case 5:w.label++,l=D[1],D=[0];continue;case 7:D=w.ops.pop(),w.trys.pop();continue;default:if(p=w.trys,!((p=p.length>0&&p[p.length-1])||D[0]!==6&&D[0]!==2)){w=0;continue}if(D[0]===3&&(!p||D[1]>p[0]&&D[1]<p[3])){w.label=D[1];break}if(D[0]===6&&w.label<p[1]){w.label=p[1],p=D;break}if(p&&w.label<p[2]){w.label=p[2],w.ops.push(D);break}p[2]&&w.ops.pop(),w.trys.pop();continue}D=t.call(n,w)}catch(z){D=[6,z],l=0}finally{s=p=0}if(5&D[0])throw D[1];return{value:D[0]?D[1]:void 0,done:!0}}([A,S])}}}function o$1(n,t){t===void 0&&(t=!1);var s=window.crypto.getRandomValues(new Uint32Array(1))[0],l="_".concat(s);return Object.defineProperty(window,l,{value:function(p){return t&&Reflect.deleteProperty(window,l),n==null?void 0:n(p)},writable:!1,configurable:!0}),s}function r(n,t){return t===void 0&&(t={}),o$2(this,void 0,void 0,function(){return a(this,function(s){return[2,new Promise(function(l,p){var g=o$1(function(u){l(u),Reflect.deleteProperty(window,w)},!0),w=o$1(function(u){p(u),Reflect.deleteProperty(window,g)},!0);window.__TAURI_IPC__(r$1({cmd:n,callback:g,error:w},t))})]})})}function c(n,t){t===void 0&&(t="asset");var s=encodeURIComponent(n);return navigator.userAgent.includes("Windows")?"https://".concat(t,".localhost/").concat(s):"".concat(t,"://").concat(s)}Object.freeze({__proto__:null,transformCallback:o$1,invoke:r,convertFileSrc:c});function o(n){return o$2(this,void 0,void 0,function(){return a(this,function(t){return[2,r("tauri",n)]})})}function i(){return o$2(this,void 0,void 0,function(){return a(this,function(n){return[2,o({__tauriModule:"Cli",message:{cmd:"cliMatches"}})]})})}Object.freeze({__proto__:null,getMatches:i});const _sfc_main={setup(){const n=useQuasar();return{showDialog(){n.dialog({component:Help,componentProps:{text:"something"}}).onOk(()=>{}).onCancel(()=>{}).onDismiss(()=>{})},data_path:"",selectedTab:ref("map"),dirHandle:ref(""),dirName:ref(""),style_url:ref(""),access_token:ref(""),mapbox_api_url:ref(""),mapbox_raster_png_dem:ref(""),mapbox_satellite_endpoint:ref(""),showPwaBtn:!0,isPwd:ref(!0),drawerLeft:ref(!1),createFolder:ref(!1)}},mounted:async function(){try{let t=await i();idbKeyval.set("tauriArgs",t)}catch{}await idbKeyval.get("pwa-installed")&&(this.showPwaBtn=!1),await this.loadUserData(),this.isRequiredSettings()===!0&&await this.loadMap(),window.addEventListener("appinstalled",this.pwaInstalled)},methods:{pwaInstalled(){idbKeyval.set("pwa-installed",!0),this.showPwaBtn=!1},async installPWA(){console.log(window.installEvent),window.installEvent.prompt(),window.installEvent=null},resizeMap(){this.$refs.mapBoxViewer.resizeMap()},changeDrawer(){this.drawerLeft=!this.drawerLeft},async loadMap(){this.selectedTab="map",await this.$nextTick(()=>{this.$refs.mapBoxViewer.loadMapboxMap()})},isRequiredSettings(){return this.access_token&&this.style_url&&this.dirName?!0:(this.redirectToSettings(),!1)},redirectToSettings(){this.selectedTab="settings",Notify.create({color:"negative",textColor:"white",icon:"report_problem",message:"Please fill out the required fields!",position:"top"})},async openDirectory(){let n;try{n=await fileUtils.getDirHandle()}catch(t){if(t.name==="AbortError")return;console.error("An error occured trying to open the file.",t)}!n||(idbKeyval.set("dirHandle",n),this.dirName=n.name)},saveUserSettings(){idbKeyval.set("access_token",this.access_token),idbKeyval.set("style_url",this.style_url),idbKeyval.set("mapbox_api_url",this.mapbox_api_url),idbKeyval.set("mapbox_satellite_endpoint",this.mapbox_satellite_endpoint),idbKeyval.set("mapbox_raster_png_dem",this.mapbox_raster_png_dem),idbKeyval.set("create_folder",this.createFolder),this.isRequiredSettings()===!0&&this.loadMap()},async loadUserData(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken||"",this.style_url=await idbKeyval.get("style_url")||"mapbox://styles/mapbox/streets-v11",this.mapbox_api_url=await idbKeyval.get("mapbox_api_url")||"https://api.mapbox.com/v4/",this.mapbox_satellite_endpoint=await idbKeyval.get("mapbox_satellite_endpoint")||"https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles",this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem")||"mapbox.mapbox-terrain-dem-v1";let n=await idbKeyval.get("dirHandle")||"";this.createFolder=await idbKeyval.get("create_folder")||"",this.dirHandle=n,this.dirName=n.name}},components:{MapboxMapViewer,SideNav,Help}},_hoisted_1={class:"row q-pa-xs full-height"},_hoisted_2=createTextVNode(" See: "),_hoisted_3=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/access-token/",target:"_blank"},"Mapbox access token docs",-1),_hoisted_4=createTextVNode(" See: "),_hoisted_5=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/style-url/",target:"_blank"},"Mapbox style url docs",-1),_hoisted_6={class:"q-pa-none row items-start"},_hoisted_7={class:"col q-pa-none"},_hoisted_8=createBaseVNode("br",null,null,-1);function _sfc_render(n,t,s,l,p,g){const w=resolveComponent("q-header"),u=resolveComponent("side-nav"),A=resolveComponent("q-card"),S=resolveComponent("q-drawer"),D=resolveComponent("q-btn"),z=resolveComponent("q-tab"),$=resolveComponent("q-tabs"),O=resolveComponent("q-separator"),q=resolveComponent("mapbox-map-viewer"),K=resolveComponent("q-tab-panel"),J=resolveComponent("q-icon"),Y=resolveComponent("q-input"),fe=resolveComponent("q-tab-panels"),ee=resolveComponent("q-page"),re=resolveComponent("q-page-container"),he=resolveComponent("q-layout");return openBlock(),createBlock(he,{view:"lHr lpr lfr"},{default:withCtx(()=>[createVNode(w,{dense:"",elevated:"",class:"bg-primary text-white","height-hint":"98"}),createVNode(S,{dense:"","show-if-above":"",modelValue:l.drawerLeft,"onUpdate:modelValue":t[0]||(t[0]=_e=>l.drawerLeft=_e),side:"left",onHide:g.resizeMap,class:"no-margin no-padding"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1,[createVNode(A,{class:"col q-pl-xs"},{default:withCtx(()=>[createVNode(u)]),_:1})])]),_:1},8,["modelValue","onHide"]),createVNode(re,null,{default:withCtx(()=>[createVNode(ee,{class:"row no-margin q-pa-sm"},{default:withCtx(()=>[createVNode(A,{class:"col"},{default:withCtx(()=>[createVNode($,{dense:"",modelValue:l.selectedTab,"onUpdate:modelValue":t[2]||(t[2]=_e=>l.selectedTab=_e),class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:withCtx(()=>[createVNode(D,{dense:"",flat:"",onClick:g.changeDrawer,round:"",icon:"menu"},null,8,["onClick"]),createVNode(z,{dense:"",name:"map",label:"Map"}),createVNode(z,{dense:"",name:"settings",label:"Settings"}),createVNode(D,{style:{background:"#FF0080",color:"white"},label:"Help",class:"q-mr-lg",onClick:l.showDialog},null,8,["onClick"]),createVNode(D,{dense:"",flat:"",round:"",onClick:t[1]||(t[1]=_e=>n.$q.dark.toggle()),icon:n.$q.dark.isActive?"nights_stay":"wb_sunny"},null,8,["icon"])]),_:1},8,["modelValue"]),createVNode(O),createVNode(fe,{class:"q-pa-none q-ma-none","keep-alive":"",modelValue:l.selectedTab,"onUpdate:modelValue":t[12]||(t[12]=_e=>l.selectedTab=_e),animated:""},{default:withCtx(()=>[createVNode(K,{name:"map",class:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",style:{width:"100%",height:"calc(100vh - 65px)"}},{default:withCtx(()=>[createVNode(q,{class:"col",ref:"mapBoxViewer"},null,512)]),_:1}),createVNode(K,{lass:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",name:"settings"},{default:withCtx(()=>[_hoisted_2,_hoisted_3,createVNode(Y,{dense:"",modelValue:l.access_token,"onUpdate:modelValue":t[4]||(t[4]=_e=>l.access_token=_e),label:"Mapbox Access Token *",filled:"",type:l.isPwd?"password":"text","lazy-rules":"",hint:"You will need your own access token created from your Mapbox accounts page. The Mapbox free plan is a great choice.",rules:[_e=>_e&&_e.length>0||"Please type something"]},{append:withCtx(()=>[createVNode(J,{dense:"",name:l.isPwd?"visibility_off":"visibility",class:"cursor-pointer",onClick:t[3]||(t[3]=_e=>l.isPwd=!l.isPwd)},null,8,["name"])]),_:1},8,["modelValue","type","rules"]),_hoisted_4,_hoisted_5,createVNode(Y,{dense:"",class:"q-pb-lg",modelValue:l.style_url,"onUpdate:modelValue":t[5]||(t[5]=_e=>l.style_url=_e),label:"Enter your Mapbox style url *",filled:"","lazy-rules":"",hint:"You can use the default style or you can create your own custom style in Mapbox Studio.",rules:[_e=>_e&&_e.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(Y,{dense:"",class:"q-pb-lg",modelValue:l.mapbox_api_url,"onUpdate:modelValue":t[6]||(t[6]=_e=>l.mapbox_api_url=_e),label:"Mapbox base api url *",filled:"","lazy-rules":"",hint:"",rules:[_e=>_e&&_e.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(Y,{dense:"",class:"q-pb-lg",modelValue:l.mapbox_raster_png_dem,"onUpdate:modelValue":t[7]||(t[7]=_e=>l.mapbox_raster_png_dem=_e),label:"Mapbox Raster Dem Endpoint *",filled:"","lazy-rules":"",hint:"",rules:[_e=>_e&&_e.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(Y,{dense:"",class:"q-pb-lg",modelValue:l.mapbox_satellite_endpoint,"onUpdate:modelValue":t[8]||(t[8]=_e=>l.mapbox_satellite_endpoint=_e),label:"Mapbox Satellite Endpoint *",filled:"","lazy-rules":"",hint:"",rules:[_e=>_e&&_e.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createBaseVNode("div",_hoisted_6,[createBaseVNode("div",_hoisted_7,[createVNode(Y,{dense:"",class:"q-pb-none",modelValue:l.dirName,"onUpdate:modelValue":t[9]||(t[9]=_e=>l.dirName=_e),label:"Enter download directory path *",filled:"","lazy-rules":"",rules:[_e=>_e&&_e.length>0||"Please type something"],type:l.isPwd?"":"text"},null,8,["modelValue","rules","type"])]),createVNode(D,{class:"q-pb-none",dense:"",onClick:t[10]||(t[10]=_e=>g.openDirectory()),color:"secondary",label:"Select download folder"})]),_hoisted_8,createVNode(D,{class:"q-pt-none",dense:"",onClick:t[11]||(t[11]=_e=>g.saveUserSettings()),color:"secondary",label:"Save settings"})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})}var MainLayout=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{MainLayout as default};
