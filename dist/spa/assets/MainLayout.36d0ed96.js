import{r as ref,i as isRuntimeSsrPreHydration,o as onMounted,c as createComponent,a as onBeforeUnmount,n as noop,b as nextTick,h,g as getCurrentInstance,l as listenOpts,d as inject,e as emptyRenderFn,f as computed,w as watch,j as hUniqueSlot,k as layoutKey,P as Platform,m as createDirective,p as client$1,q as leftClick,s as addEvt,t as preventDraggable,u as prevent,v as stop,x as position,y as cleanEvt,z as stopAndPrevent,A as useModelToggleProps,B as useDarkProps,C as useModelToggleEmits,D as useDark,E as useTimeout,F as useModelToggle,G as useHistory,H as withDirectives,I as hDir,J as hSlot,K as usePreventScroll,L as tabsKey,R as Ripple,M as isKeyCode,N as shouldIgnoreKey,Q as QIcon,O as hMergeSlot,S as isDeepEqual,T as uid$1,U as useTick,V as provide,W as onDeactivated,X as onActivated,Y as Transition,Z as getNormalizedVNodes,_ as KeepAlive,$ as pageContainerKey,a0 as getScrollTarget,a1 as getVerticalScrollPosition,a2 as getHorizontalScrollPosition,a3 as getScrollbarWidth,a4 as reactive,a5 as onUnmounted,a6 as portalProxyList,a7 as useTransitionProps,a8 as useTransition,a9 as usePortal,aa as addFocusout,ab as removeFocusout,ac as removeEscapeKey,ad as closePortalMenus,ae as addEscapeKey,af as addFocusFn,ag as childHasFocus,ah as _export_sfc,ai as openBlock,aj as createElementBlock,ak as createVNode,al as withCtx,am as QBtn,an as createBaseVNode,ao as QOptionGroup,ap as createTextVNode,aq as toDisplayString,ar as QSpinner,as as useFieldProps,at as useFieldEmits,au as useField,av as useFieldState,aw as useSizeProps,ax as useSize,ay as hMergeSlotSafely,az as useRouterLinkProps,aA as useRouterLink,aB as debounce$2,aC as onBeforeMount,aD as useFormProps,aE as useFormInputNameAttr,aF as fieldValueIsFilled,aG as onBeforeUpdate,aH as onUpdated,aI as useKeyComposition,aJ as QDialog,aK as getPortalProxy,aL as closePortals,aM as quasarKey,aN as vShow,aO as QInput,aP as QCard,aQ as QCardSection,aR as QCardActions,aS as Fragment,aT as createBlock,aU as QSeparator,aV as Notify,aW as resolveComponent}from"./index.4b08b42a.js";import{Q as QPage}from"./QPage.81aebfe6.js";function useCanRender(){const e=ref(!isRuntimeSsrPreHydration.value);return e.value===!1&&onMounted(()=>{e.value=!0}),e}const hasObserver=typeof ResizeObserver<"u",resizeProps=hasObserver===!0?{}:{style:"display:block;position:absolute;top:0;left:0;right:0;bottom:0;height:100%;width:100%;overflow:hidden;pointer-events:none;z-index:-1;",url:"about:blank"};var QResizeObserver=createComponent({name:"QResizeObserver",props:{debounce:{type:[String,Number],default:100}},emits:["resize"],setup(e,{emit:r}){let n=null,a,u={width:-1,height:-1};function f(b){b===!0||e.debounce===0||e.debounce==="0"?_():n===null&&(n=setTimeout(_,e.debounce))}function _(){if(clearTimeout(n),n=null,a){const{offsetWidth:b,offsetHeight:E}=a;(b!==u.width||E!==u.height)&&(u={width:b,height:E},r("resize",u))}}const{proxy:o}=getCurrentInstance();if(hasObserver===!0){let b;const E=M=>{a=o.$el.parentNode,a?(b=new ResizeObserver(f),b.observe(a),_()):M!==!0&&nextTick(()=>{E(!0)})};return onMounted(()=>{E()}),onBeforeUnmount(()=>{clearTimeout(n),b!==void 0&&(b.disconnect!==void 0?b.disconnect():a&&b.unobserve(a))}),noop}else{let M=function(){clearTimeout(n),E!==void 0&&(E.removeEventListener!==void 0&&E.removeEventListener("resize",f,listenOpts.passive),E=void 0)},P=function(){M(),a&&a.contentDocument&&(E=a.contentDocument.defaultView,E.addEventListener("resize",f,listenOpts.passive),_())};const b=useCanRender();let E;return onMounted(()=>{nextTick(()=>{a=o.$el,a&&P()})}),onBeforeUnmount(M),o.trigger=f,()=>{if(b.value===!0)return h("object",{style:resizeProps.style,tabindex:-1,type:"text/html",data:resizeProps.url,"aria-hidden":"true",onLoad:P})}}}}),QHeader=createComponent({name:"QHeader",props:{modelValue:{type:Boolean,default:!0},reveal:Boolean,revealOffset:{type:Number,default:250},bordered:Boolean,elevated:Boolean,heightHint:{type:[String,Number],default:50}},emits:["reveal","focusin"],setup(e,{slots:r,emit:n}){const{proxy:{$q:a}}=getCurrentInstance(),u=inject(layoutKey,emptyRenderFn);if(u===emptyRenderFn)return console.error("QHeader needs to be child of QLayout"),emptyRenderFn;const f=ref(parseInt(e.heightHint,10)),_=ref(!0),o=computed(()=>e.reveal===!0||u.view.value.indexOf("H")>-1||a.platform.is.ios&&u.isContainer.value===!0),b=computed(()=>{if(e.modelValue!==!0)return 0;if(o.value===!0)return _.value===!0?f.value:0;const oe=f.value-u.scroll.value.position;return oe>0?oe:0}),E=computed(()=>e.modelValue!==!0||o.value===!0&&_.value!==!0),M=computed(()=>e.modelValue===!0&&E.value===!0&&e.reveal===!0),P=computed(()=>"q-header q-layout__section--marginal "+(o.value===!0?"fixed":"absolute")+"-top"+(e.bordered===!0?" q-header--bordered":"")+(E.value===!0?" q-header--hidden":"")+(e.modelValue!==!0?" q-layout--prevent-focus":"")),L=computed(()=>{const oe=u.rows.value.top,W={};return oe[0]==="l"&&u.left.space===!0&&(W[a.lang.rtl===!0?"right":"left"]=`${u.left.size}px`),oe[2]==="r"&&u.right.space===!0&&(W[a.lang.rtl===!0?"left":"right"]=`${u.right.size}px`),W});function D(oe,W){u.update("header",oe,W)}function U(oe,W){oe.value!==W&&(oe.value=W)}function X({height:oe}){U(f,oe),D("size",oe)}function K(oe){M.value===!0&&U(_,!0),n("focusin",oe)}watch(()=>e.modelValue,oe=>{D("space",oe),U(_,!0),u.animate()}),watch(b,oe=>{D("offset",oe)}),watch(()=>e.reveal,oe=>{oe===!1&&U(_,e.modelValue)}),watch(_,oe=>{u.animate(),n("reveal",oe)}),watch(u.scroll,oe=>{e.reveal===!0&&U(_,oe.direction==="up"||oe.position<=e.revealOffset||oe.position-oe.inflectionPoint<100)});const q={};return u.instances.header=q,e.modelValue===!0&&D("size",f.value),D("space",e.modelValue),D("offset",b.value),onBeforeUnmount(()=>{u.instances.header===q&&(u.instances.header=void 0,D("size",0),D("offset",0),D("space",!1))}),()=>{const oe=hUniqueSlot(r.default,[]);return e.elevated===!0&&oe.push(h("div",{class:"q-layout__shadow absolute-full overflow-hidden no-pointer-events"})),oe.push(h(QResizeObserver,{debounce:0,onResize:X})),h("header",{class:P.value,style:L.value,onFocusin:K},oe)}}});const modifiersAll={left:!0,right:!0,up:!0,down:!0,horizontal:!0,vertical:!0},directionList=Object.keys(modifiersAll);modifiersAll.all=!0;function getModifierDirections(e){const r={};for(const n of directionList)e[n]===!0&&(r[n]=!0);return Object.keys(r).length===0?modifiersAll:(r.horizontal===!0?r.left=r.right=!0:r.left===!0&&r.right===!0&&(r.horizontal=!0),r.vertical===!0?r.up=r.down=!0:r.up===!0&&r.down===!0&&(r.vertical=!0),r.horizontal===!0&&r.vertical===!0&&(r.all=!0),r)}function shouldStart(e,r){return r.event===void 0&&e.target!==void 0&&e.target.draggable!==!0&&typeof r.handler=="function"&&e.target.nodeName.toUpperCase()!=="INPUT"&&(e.qClonedBy===void 0||e.qClonedBy.indexOf(r.uid)===-1)}function clearSelection(){if(window.getSelection!==void 0){const e=window.getSelection();e.empty!==void 0?e.empty():e.removeAllRanges!==void 0&&(e.removeAllRanges(),Platform.is.mobile!==!0&&e.addRange(document.createRange()))}else document.selection!==void 0&&document.selection.empty()}function getChanges(e,r,n){const a=position(e);let u,f=a.left-r.event.x,_=a.top-r.event.y,o=Math.abs(f),b=Math.abs(_);const E=r.direction;E.horizontal===!0&&E.vertical!==!0?u=f<0?"left":"right":E.horizontal!==!0&&E.vertical===!0?u=_<0?"up":"down":E.up===!0&&_<0?(u="up",o>b&&(E.left===!0&&f<0?u="left":E.right===!0&&f>0&&(u="right"))):E.down===!0&&_>0?(u="down",o>b&&(E.left===!0&&f<0?u="left":E.right===!0&&f>0&&(u="right"))):E.left===!0&&f<0?(u="left",o<b&&(E.up===!0&&_<0?u="up":E.down===!0&&_>0&&(u="down"))):E.right===!0&&f>0&&(u="right",o<b&&(E.up===!0&&_<0?u="up":E.down===!0&&_>0&&(u="down")));let M=!1;if(u===void 0&&n===!1){if(r.event.isFirst===!0||r.event.lastDir===void 0)return{};u=r.event.lastDir,M=!0,u==="left"||u==="right"?(a.left-=f,o=0,f=0):(a.top-=_,b=0,_=0)}return{synthetic:M,payload:{evt:e,touch:r.event.mouse!==!0,mouse:r.event.mouse===!0,position:a,direction:u,isFirst:r.event.isFirst,isFinal:n===!0,duration:Date.now()-r.event.time,distance:{x:o,y:b},offset:{x:f,y:_},delta:{x:a.left-r.event.lastX,y:a.top-r.event.lastY}}}}let uid=0;var TouchPan=createDirective({name:"touch-pan",beforeMount(e,{value:r,modifiers:n}){if(n.mouse!==!0&&client$1.has.touch!==!0)return;function a(f,_){n.mouse===!0&&_===!0?stopAndPrevent(f):(n.stop===!0&&stop(f),n.prevent===!0&&prevent(f))}const u={uid:"qvtp_"+uid++,handler:r,modifiers:n,direction:getModifierDirections(n),noop,mouseStart(f){shouldStart(f,u)&&leftClick(f)&&(addEvt(u,"temp",[[document,"mousemove","move","notPassiveCapture"],[document,"mouseup","end","passiveCapture"]]),u.start(f,!0))},touchStart(f){if(shouldStart(f,u)){const _=f.target;addEvt(u,"temp",[[_,"touchmove","move","notPassiveCapture"],[_,"touchcancel","end","passiveCapture"],[_,"touchend","end","passiveCapture"]]),u.start(f)}},start(f,_){if(client$1.is.firefox===!0&&preventDraggable(e,!0),u.lastEvt=f,_===!0||n.stop===!0){if(u.direction.all!==!0&&(_!==!0||u.modifiers.mouseAllDir!==!0&&u.modifiers.mousealldir!==!0)){const E=f.type.indexOf("mouse")>-1?new MouseEvent(f.type,f):new TouchEvent(f.type,f);f.defaultPrevented===!0&&prevent(E),f.cancelBubble===!0&&stop(E),Object.assign(E,{qKeyEvent:f.qKeyEvent,qClickOutside:f.qClickOutside,qAnchorHandled:f.qAnchorHandled,qClonedBy:f.qClonedBy===void 0?[u.uid]:f.qClonedBy.concat(u.uid)}),u.initialEvent={target:f.target,event:E}}stop(f)}const{left:o,top:b}=position(f);u.event={x:o,y:b,time:Date.now(),mouse:_===!0,detected:!1,isFirst:!0,isFinal:!1,lastX:o,lastY:b}},move(f){if(u.event===void 0)return;const _=position(f),o=_.left-u.event.x,b=_.top-u.event.y;if(o===0&&b===0)return;u.lastEvt=f;const E=u.event.mouse===!0,M=()=>{a(f,E);let D;n.preserveCursor!==!0&&n.preservecursor!==!0&&(D=document.documentElement.style.cursor||"",document.documentElement.style.cursor="grabbing"),E===!0&&document.body.classList.add("no-pointer-events--children"),document.body.classList.add("non-selectable"),clearSelection(),u.styleCleanup=U=>{if(u.styleCleanup=void 0,D!==void 0&&(document.documentElement.style.cursor=D),document.body.classList.remove("non-selectable"),E===!0){const X=()=>{document.body.classList.remove("no-pointer-events--children")};U!==void 0?setTimeout(()=>{X(),U()},50):X()}else U!==void 0&&U()}};if(u.event.detected===!0){u.event.isFirst!==!0&&a(f,u.event.mouse);const{payload:D,synthetic:U}=getChanges(f,u,!1);D!==void 0&&(u.handler(D)===!1?u.end(f):(u.styleCleanup===void 0&&u.event.isFirst===!0&&M(),u.event.lastX=D.position.left,u.event.lastY=D.position.top,u.event.lastDir=U===!0?void 0:D.direction,u.event.isFirst=!1));return}if(u.direction.all===!0||E===!0&&(u.modifiers.mouseAllDir===!0||u.modifiers.mousealldir===!0)){M(),u.event.detected=!0,u.move(f);return}const P=Math.abs(o),L=Math.abs(b);P!==L&&(u.direction.horizontal===!0&&P>L||u.direction.vertical===!0&&P<L||u.direction.up===!0&&P<L&&b<0||u.direction.down===!0&&P<L&&b>0||u.direction.left===!0&&P>L&&o<0||u.direction.right===!0&&P>L&&o>0?(u.event.detected=!0,u.move(f)):u.end(f,!0))},end(f,_){if(u.event!==void 0){if(cleanEvt(u,"temp"),client$1.is.firefox===!0&&preventDraggable(e,!1),_===!0)u.styleCleanup!==void 0&&u.styleCleanup(),u.event.detected!==!0&&u.initialEvent!==void 0&&u.initialEvent.target.dispatchEvent(u.initialEvent.event);else if(u.event.detected===!0){u.event.isFirst===!0&&u.handler(getChanges(f===void 0?u.lastEvt:f,u).payload);const{payload:o}=getChanges(f===void 0?u.lastEvt:f,u,!0),b=()=>{u.handler(o)};u.styleCleanup!==void 0?u.styleCleanup(b):b()}u.event=void 0,u.initialEvent=void 0,u.lastEvt=void 0}}};if(e.__qtouchpan=u,n.mouse===!0){const f=n.mouseCapture===!0||n.mousecapture===!0?"Capture":"";addEvt(u,"main",[[e,"mousedown","mouseStart",`passive${f}`]])}client$1.has.touch===!0&&addEvt(u,"main",[[e,"touchstart","touchStart",`passive${n.capture===!0?"Capture":""}`],[e,"touchmove","noop","notPassiveCapture"]])},updated(e,r){const n=e.__qtouchpan;n!==void 0&&(r.oldValue!==r.value&&(typeof value!="function"&&n.end(),n.handler=r.value),n.direction=getModifierDirections(r.modifiers))},beforeUnmount(e){const r=e.__qtouchpan;r!==void 0&&(r.event!==void 0&&r.end(),cleanEvt(r,"main"),cleanEvt(r,"temp"),client$1.is.firefox===!0&&preventDraggable(e,!1),r.styleCleanup!==void 0&&r.styleCleanup(),delete e.__qtouchpan)}});function between(e,r,n){return n<=r?r:Math.min(n,Math.max(r,e))}function normalizeToInterval(e,r,n){if(n<=r)return r;const a=n-r+1;let u=r+(e-r)%a;return u<r&&(u=a+u),u===0?0:u}const duration=150;var QDrawer=createComponent({name:"QDrawer",inheritAttrs:!1,props:{...useModelToggleProps,...useDarkProps,side:{type:String,default:"left",validator:e=>["left","right"].includes(e)},width:{type:Number,default:300},mini:Boolean,miniToOverlay:Boolean,miniWidth:{type:Number,default:57},breakpoint:{type:Number,default:1023},showIfAbove:Boolean,behavior:{type:String,validator:e=>["default","desktop","mobile"].includes(e),default:"default"},bordered:Boolean,elevated:Boolean,overlay:Boolean,persistent:Boolean,noSwipeOpen:Boolean,noSwipeClose:Boolean,noSwipeBackdrop:Boolean},emits:[...useModelToggleEmits,"onLayout","miniState"],setup(e,{slots:r,emit:n,attrs:a}){const u=getCurrentInstance(),{proxy:{$q:f}}=u,_=useDark(e,f),{preventBodyScroll:o}=usePreventScroll(),{registerTimeout:b,removeTimeout:E}=useTimeout(),M=inject(layoutKey,emptyRenderFn);if(M===emptyRenderFn)return console.error("QDrawer needs to be child of QLayout"),emptyRenderFn;let P,L,D;const U=ref(e.behavior==="mobile"||e.behavior!=="desktop"&&M.totalWidth.value<=e.breakpoint),X=computed(()=>e.mini===!0&&U.value!==!0),K=computed(()=>X.value===!0?e.miniWidth:e.width),q=ref(e.showIfAbove===!0&&U.value===!1?!0:e.modelValue===!0),oe=computed(()=>e.persistent!==!0&&(U.value===!0||je.value===!0));function W(Ae,xt){if(xe(),Ae!==!1&&M.animate(),mi(0),U.value===!0){const Xt=M.instances[Zt.value];Xt!==void 0&&Xt.belowBreakpoint===!0&&Xt.hide(!1),It(1),M.isContainer.value!==!0&&o(!0)}else It(0),Ae!==!1&&kt(!1);b(()=>{Ae!==!1&&kt(!0),xt!==!0&&n("show",Ae)},duration)}function Y(Ae,xt){se(),Ae!==!1&&M.animate(),It(0),mi(he.value*K.value),ht(),xt!==!0?b(()=>{n("hide",Ae)},duration):E()}const{show:J,hide:Ee}=useModelToggle({showing:q,hideOnRouteChange:oe,handleShow:W,handleHide:Y}),{addToHistory:xe,removeFromHistory:se}=useHistory(q,Ee,oe),ce={belowBreakpoint:U,hide:Ee},ee=computed(()=>e.side==="right"),he=computed(()=>(f.lang.rtl===!0?-1:1)*(ee.value===!0?1:-1)),Ie=ref(0),Pe=ref(!1),Qe=ref(!1),We=ref(K.value*he.value),Zt=computed(()=>ee.value===!0?"left":"right"),ti=computed(()=>q.value===!0&&U.value===!1&&e.overlay===!1?e.miniToOverlay===!0?e.miniWidth:K.value:0),$t=computed(()=>e.overlay===!0||e.miniToOverlay===!0||M.view.value.indexOf(ee.value?"R":"L")>-1||f.platform.is.ios===!0&&M.isContainer.value===!0),oi=computed(()=>e.overlay===!1&&q.value===!0&&U.value===!1),je=computed(()=>e.overlay===!0&&q.value===!0&&U.value===!1),_t=computed(()=>"fullscreen q-drawer__backdrop"+(q.value===!1&&Pe.value===!1?" hidden":"")),Bt=computed(()=>({backgroundColor:`rgba(0,0,0,${Ie.value*.4})`})),dt=computed(()=>ee.value===!0?M.rows.value.top[2]==="r":M.rows.value.top[0]==="l"),At=computed(()=>ee.value===!0?M.rows.value.bottom[2]==="r":M.rows.value.bottom[0]==="l"),Tt=computed(()=>{const Ae={};return M.header.space===!0&&dt.value===!1&&($t.value===!0?Ae.top=`${M.header.offset}px`:M.header.space===!0&&(Ae.top=`${M.header.size}px`)),M.footer.space===!0&&At.value===!1&&($t.value===!0?Ae.bottom=`${M.footer.offset}px`:M.footer.space===!0&&(Ae.bottom=`${M.footer.size}px`)),Ae}),Dt=computed(()=>{const Ae={width:`${K.value}px`,transform:`translateX(${We.value}px)`};return U.value===!0?Ae:Object.assign(Ae,Tt.value)}),Ct=computed(()=>"q-drawer__content fit "+(M.isContainer.value!==!0?"scroll":"overflow-auto")),pi=computed(()=>`q-drawer q-drawer--${e.side}`+(Qe.value===!0?" q-drawer--mini-animate":"")+(e.bordered===!0?" q-drawer--bordered":"")+(_.value===!0?" q-drawer--dark q-dark":"")+(Pe.value===!0?" no-transition":q.value===!0?"":" q-layout--prevent-focus")+(U.value===!0?" fixed q-drawer--on-top q-drawer--mobile q-drawer--top-padding":` q-drawer--${X.value===!0?"mini":"standard"}`+($t.value===!0||oi.value!==!0?" fixed":"")+(e.overlay===!0||e.miniToOverlay===!0?" q-drawer--on-top":"")+(dt.value===!0?" q-drawer--top-padding":""))),yt=computed(()=>{const Ae=f.lang.rtl===!0?e.side:Zt.value;return[[TouchPan,Pi,void 0,{[Ae]:!0,mouse:!0}]]}),vi=computed(()=>{const Ae=f.lang.rtl===!0?Zt.value:e.side;return[[TouchPan,zi,void 0,{[Ae]:!0,mouse:!0}]]}),$i=computed(()=>{const Ae=f.lang.rtl===!0?Zt.value:e.side;return[[TouchPan,zi,void 0,{[Ae]:!0,mouse:!0,mouseAllDir:!0}]]});function yi(){di(U,e.behavior==="mobile"||e.behavior!=="desktop"&&M.totalWidth.value<=e.breakpoint)}watch(U,Ae=>{Ae===!0?(P=q.value,q.value===!0&&Ee(!1)):e.overlay===!1&&e.behavior!=="mobile"&&P!==!1&&(q.value===!0?(mi(0),It(0),ht()):J(!1))}),watch(()=>e.side,(Ae,xt)=>{M.instances[xt]===ce&&(M.instances[xt]=void 0,M[xt].space=!1,M[xt].offset=0),M.instances[Ae]=ce,M[Ae].size=K.value,M[Ae].space=oi.value,M[Ae].offset=ti.value}),watch(M.totalWidth,()=>{(M.isContainer.value===!0||document.qScrollPrevented!==!0)&&yi()}),watch(()=>e.behavior+e.breakpoint,yi),watch(M.isContainer,Ae=>{q.value===!0&&o(Ae!==!0),Ae===!0&&yi()}),watch(M.scrollbarWidth,()=>{mi(q.value===!0?0:void 0)}),watch(ti,Ae=>{Gt("offset",Ae)}),watch(oi,Ae=>{n("onLayout",Ae),Gt("space",Ae)}),watch(ee,()=>{mi()}),watch(K,Ae=>{mi(),si(e.miniToOverlay,Ae)}),watch(()=>e.miniToOverlay,Ae=>{si(Ae,K.value)}),watch(()=>f.lang.rtl,()=>{mi()}),watch(()=>e.mini,()=>{e.modelValue===!0&&(Ri(),M.animate())}),watch(X,Ae=>{n("miniState",Ae)});function mi(Ae){Ae===void 0?nextTick(()=>{Ae=q.value===!0?0:K.value,mi(he.value*Ae)}):(M.isContainer.value===!0&&ee.value===!0&&(U.value===!0||Math.abs(Ae)===K.value)&&(Ae+=he.value*M.scrollbarWidth.value),We.value=Ae)}function It(Ae){Ie.value=Ae}function kt(Ae){const xt=Ae===!0?"remove":M.isContainer.value!==!0?"add":"";xt!==""&&document.body.classList[xt]("q-body--drawer-toggle")}function Ri(){clearTimeout(L),u.proxy&&u.proxy.$el&&u.proxy.$el.classList.add("q-drawer--mini-animate"),Qe.value=!0,L=setTimeout(()=>{Qe.value=!1,u&&u.proxy&&u.proxy.$el&&u.proxy.$el.classList.remove("q-drawer--mini-animate")},150)}function Pi(Ae){if(q.value!==!1)return;const xt=K.value,Xt=between(Ae.distance.x,0,xt);if(Ae.isFinal===!0){Xt>=Math.min(75,xt)===!0?J():(M.animate(),It(0),mi(he.value*xt)),Pe.value=!1;return}mi((f.lang.rtl===!0?ee.value!==!0:ee.value)?Math.max(xt-Xt,0):Math.min(0,Xt-xt)),It(between(Xt/xt,0,1)),Ae.isFirst===!0&&(Pe.value=!0)}function zi(Ae){if(q.value!==!0)return;const xt=K.value,Xt=Ae.direction===e.side,Nt=(f.lang.rtl===!0?Xt!==!0:Xt)?between(Ae.distance.x,0,xt):0;if(Ae.isFinal===!0){Math.abs(Nt)<Math.min(75,xt)===!0?(M.animate(),It(1),mi(0)):Ee(),Pe.value=!1;return}mi(he.value*Nt),It(between(1-Nt/xt,0,1)),Ae.isFirst===!0&&(Pe.value=!0)}function ht(){o(!1),kt(!0)}function Gt(Ae,xt){M.update(e.side,Ae,xt)}function di(Ae,xt){Ae.value!==xt&&(Ae.value=xt)}function si(Ae,xt){Gt("size",Ae===!0?e.miniWidth:xt)}return M.instances[e.side]=ce,si(e.miniToOverlay,K.value),Gt("space",oi.value),Gt("offset",ti.value),e.showIfAbove===!0&&e.modelValue!==!0&&q.value===!0&&e["onUpdate:modelValue"]!==void 0&&n("update:modelValue",!0),onMounted(()=>{n("onLayout",oi.value),n("miniState",X.value),P=e.showIfAbove===!0;const Ae=()=>{(q.value===!0?W:Y)(!1,!0)};if(M.totalWidth.value!==0){nextTick(Ae);return}D=watch(M.totalWidth,()=>{D(),D=void 0,q.value===!1&&e.showIfAbove===!0&&U.value===!1?J(!1):Ae()})}),onBeforeUnmount(()=>{D!==void 0&&D(),clearTimeout(L),q.value===!0&&ht(),M.instances[e.side]===ce&&(M.instances[e.side]=void 0,Gt("size",0),Gt("offset",0),Gt("space",!1))}),()=>{const Ae=[];U.value===!0&&(e.noSwipeOpen===!1&&Ae.push(withDirectives(h("div",{key:"open",class:`q-drawer__opener fixed-${e.side}`,"aria-hidden":"true"}),yt.value)),Ae.push(hDir("div",{ref:"backdrop",class:_t.value,style:Bt.value,"aria-hidden":"true",onClick:Ee},void 0,"backdrop",e.noSwipeBackdrop!==!0&&q.value===!0,()=>$i.value)));const xt=X.value===!0&&r.mini!==void 0,Xt=[h("div",{...a,key:""+xt,class:[Ct.value,a.class]},xt===!0?r.mini():hSlot(r.default))];return e.elevated===!0&&q.value===!0&&Xt.push(h("div",{class:"q-layout__shadow absolute-full overflow-hidden no-pointer-events"})),Ae.push(hDir("aside",{ref:"content",class:pi.value,style:Dt.value},Xt,"contentclose",e.noSwipeClose!==!0&&U.value===!0,()=>vi.value)),h("div",{class:"q-drawer-container"},Ae)}}});let id=0;const useTabEmits=["click","keydown"],useTabProps={icon:String,label:[Number,String],alert:[Boolean,String],alertIcon:String,name:{type:[Number,String],default:()=>`t_${id++}`},noCaps:Boolean,tabindex:[String,Number],disable:Boolean,contentClass:String,ripple:{type:[Boolean,Object],default:!0}};function useTab(e,r,n,a){const u=inject(tabsKey,emptyRenderFn);if(u===emptyRenderFn)return console.error("QTab/QRouteTab component needs to be child of QTabs"),emptyRenderFn;const{proxy:f}=getCurrentInstance(),_=ref(null),o=ref(null),b=ref(null),E=computed(()=>e.disable===!0||e.ripple===!1?!1:Object.assign({keyCodes:[13,32],early:!0},e.ripple===!0?{}:e.ripple)),M=computed(()=>u.currentModel.value===e.name),P=computed(()=>"q-tab relative-position self-stretch flex flex-center text-center"+(M.value===!0?" q-tab--active"+(u.tabProps.value.activeClass?" "+u.tabProps.value.activeClass:"")+(u.tabProps.value.activeColor?` text-${u.tabProps.value.activeColor}`:"")+(u.tabProps.value.activeBgColor?` bg-${u.tabProps.value.activeBgColor}`:""):" q-tab--inactive")+(e.icon&&e.label&&u.tabProps.value.inlineLabel===!1?" q-tab--full":"")+(e.noCaps===!0||u.tabProps.value.noCaps===!0?" q-tab--no-caps":"")+(e.disable===!0?" disabled":" q-focusable q-hoverable cursor-pointer")+(a!==void 0?a.linkClass.value:"")),L=computed(()=>"q-tab__content self-stretch flex-center relative-position q-anchor--skip non-selectable "+(u.tabProps.value.inlineLabel===!0?"row no-wrap q-tab__content--inline":"column")+(e.contentClass!==void 0?` ${e.contentClass}`:"")),D=computed(()=>e.disable===!0||u.hasFocus.value===!0||M.value===!1&&u.hasActiveTab.value===!0?-1:e.tabindex||0);function U(W,Y){if(Y!==!0&&_.value!==null&&_.value.focus(),e.disable===!0){a!==void 0&&a.hasRouterLink.value===!0&&stopAndPrevent(W);return}if(a===void 0){u.updateModel({name:e.name}),n("click",W);return}if(a.hasRouterLink.value===!0){const J=(Ee={})=>{let xe;const se=Ee.to===void 0||isDeepEqual(Ee.to,e.to)===!0?u.avoidRouteWatcher=uid$1():null;return a.navigateToRouterLink(W,{...Ee,returnRouterError:!0}).catch(ce=>{xe=ce}).then(ce=>{if(se===u.avoidRouteWatcher&&(u.avoidRouteWatcher=!1,xe===void 0&&(ce===void 0||ce.message.startsWith("Avoided redundant navigation")===!0)&&u.updateModel({name:e.name})),Ee.returnRouterError===!0)return xe!==void 0?Promise.reject(xe):ce})};n("click",W,J),W.defaultPrevented!==!0&&J();return}n("click",W)}function X(W){isKeyCode(W,[13,32])?U(W,!0):shouldIgnoreKey(W)!==!0&&W.keyCode>=35&&W.keyCode<=40&&W.altKey!==!0&&W.metaKey!==!0&&u.onKbdNavigate(W.keyCode,f.$el)===!0&&stopAndPrevent(W),n("keydown",W)}function K(){const W=u.tabProps.value.narrowIndicator,Y=[],J=h("div",{ref:b,class:["q-tab__indicator",u.tabProps.value.indicatorClass]});e.icon!==void 0&&Y.push(h(QIcon,{class:"q-tab__icon",name:e.icon})),e.label!==void 0&&Y.push(h("div",{class:"q-tab__label"},e.label)),e.alert!==!1&&Y.push(e.alertIcon!==void 0?h(QIcon,{class:"q-tab__alert-icon",color:e.alert!==!0?e.alert:void 0,name:e.alertIcon}):h("div",{class:"q-tab__alert"+(e.alert!==!0?` text-${e.alert}`:"")})),W===!0&&Y.push(J);const Ee=[h("div",{class:"q-focus-helper",tabindex:-1,ref:_}),h("div",{class:L.value},hMergeSlot(r.default,Y))];return W===!1&&Ee.push(J),Ee}const q={name:computed(()=>e.name),rootRef:o,tabIndicatorRef:b,routeData:a};onBeforeUnmount(()=>{u.unregisterTab(q)}),onMounted(()=>{u.registerTab(q)});function oe(W,Y){const J={ref:o,class:P.value,tabindex:D.value,role:"tab","aria-selected":M.value===!0?"true":"false","aria-disabled":e.disable===!0?"true":void 0,onClick:U,onKeydown:X,...Y};return withDirectives(h(W,J,K()),[[Ripple,E.value]])}return{renderTab:oe,$tabs:u}}var QTab=createComponent({name:"QTab",props:useTabProps,emits:useTabEmits,setup(e,{slots:r,emit:n}){const{renderTab:a}=useTab(e,r,n);return()=>a("div")}});let rtlHasScrollBug=!1;{const e=document.createElement("div");e.setAttribute("dir","rtl"),Object.assign(e.style,{width:"1px",height:"1px",overflow:"auto"});const r=document.createElement("div");Object.assign(r.style,{width:"1000px",height:"1px"}),document.body.appendChild(e),e.appendChild(r),e.scrollLeft=-1e3,rtlHasScrollBug=e.scrollLeft>=0,e.remove()}function getIndicatorClass(e,r,n){const a=n===!0?["left","right"]:["top","bottom"];return`absolute-${r===!0?a[0]:a[1]}${e?` text-${e}`:""}`}const alignValues=["left","center","right","justify"];var QTabs=createComponent({name:"QTabs",props:{modelValue:[Number,String],align:{type:String,default:"center",validator:e=>alignValues.includes(e)},breakpoint:{type:[String,Number],default:600},vertical:Boolean,shrink:Boolean,stretch:Boolean,activeClass:String,activeColor:String,activeBgColor:String,indicatorColor:String,leftIcon:String,rightIcon:String,outsideArrows:Boolean,mobileArrows:Boolean,switchIndicator:Boolean,narrowIndicator:Boolean,inlineLabel:Boolean,noCaps:Boolean,dense:Boolean,contentClass:String,"onUpdate:modelValue":[Function,Array]},setup(e,{slots:r,emit:n}){const{proxy:a}=getCurrentInstance(),{$q:u}=a,{registerTick:f}=useTick(),{registerTick:_}=useTick(),{registerTick:o}=useTick(),{registerTimeout:b,removeTimeout:E}=useTimeout(),{registerTimeout:M,removeTimeout:P}=useTimeout(),L=ref(null),D=ref(null),U=ref(e.modelValue),X=ref(!1),K=ref(!0),q=ref(!1),oe=ref(!1),W=computed(()=>u.platform.is.desktop===!0||e.mobileArrows===!0),Y=[],J=ref(0),Ee=ref(!1);let xe,se,ce,ee=W.value===!0?At:noop;const he=computed(()=>({activeClass:e.activeClass,activeColor:e.activeColor,activeBgColor:e.activeBgColor,indicatorClass:getIndicatorClass(e.indicatorColor,e.switchIndicator,e.vertical),narrowIndicator:e.narrowIndicator,inlineLabel:e.inlineLabel,noCaps:e.noCaps})),Ie=computed(()=>{const Ae=J.value,xt=U.value;for(let Xt=0;Xt<Ae;Xt++)if(Y[Xt].name.value===xt)return!0;return!1}),Pe=computed(()=>`q-tabs__content--align-${X.value===!0?"left":oe.value===!0?"justify":e.align}`),Qe=computed(()=>`q-tabs row no-wrap items-center q-tabs--${X.value===!0?"":"not-"}scrollable q-tabs--${e.vertical===!0?"vertical":"horizontal"} q-tabs__arrows--${W.value===!0&&e.outsideArrows===!0?"outside":"inside"}`+(e.dense===!0?" q-tabs--dense":"")+(e.shrink===!0?" col-shrink":"")+(e.stretch===!0?" self-stretch":"")),We=computed(()=>"q-tabs__content row no-wrap items-center self-stretch hide-scrollbar relative-position "+Pe.value+(e.contentClass!==void 0?` ${e.contentClass}`:"")+(u.platform.is.mobile===!0?" scroll":"")),Zt=computed(()=>e.vertical===!0?{container:"height",content:"offsetHeight",scroll:"scrollHeight"}:{container:"width",content:"offsetWidth",scroll:"scrollWidth"}),ti=computed(()=>e.vertical!==!0&&u.lang.rtl===!0),$t=computed(()=>rtlHasScrollBug===!1&&ti.value===!0);watch(ti,ee),watch(()=>e.modelValue,Ae=>{oi({name:Ae,setCurrent:!0,skipEmit:!0})}),watch(()=>e.outsideArrows,()=>{je()}),watch(W,Ae=>{ee=Ae===!0?At:noop,je()});function oi({name:Ae,setCurrent:xt,skipEmit:Xt,fromRoute:Nt}){U.value!==Ae&&(Xt!==!0&&e["onUpdate:modelValue"]!==void 0&&n("update:modelValue",Ae),(xt===!0||e["onUpdate:modelValue"]===void 0)&&(Bt(U.value,Ae),U.value=Ae))}function je(){f(()=>{_t({width:L.value.offsetWidth,height:L.value.offsetHeight})})}function _t(Ae){if(Zt.value===void 0||D.value===null)return;const xt=Ae[Zt.value.container],Xt=Math.min(D.value[Zt.value.scroll],Array.prototype.reduce.call(D.value.children,(Yt,ii)=>Yt+(ii[Zt.value.content]||0),0)),Nt=xt>0&&Xt>xt;X.value=Nt,Nt===!0&&_(ee),oe.value=xt<parseInt(e.breakpoint,10)}function Bt(Ae,xt){const Xt=Ae!=null&&Ae!==""?Y.find(Yt=>Yt.name.value===Ae):null,Nt=xt!=null&&xt!==""?Y.find(Yt=>Yt.name.value===xt):null;if(Xt&&Nt){const Yt=Xt.tabIndicatorRef.value,ii=Nt.tabIndicatorRef.value;clearTimeout(xe),Yt.style.transition="none",Yt.style.transform="none",ii.style.transition="none",ii.style.transform="none";const Rt=Yt.getBoundingClientRect(),Kt=ii.getBoundingClientRect();ii.style.transform=e.vertical===!0?`translate3d(0,${Rt.top-Kt.top}px,0) scale3d(1,${Kt.height?Rt.height/Kt.height:1},1)`:`translate3d(${Rt.left-Kt.left}px,0,0) scale3d(${Kt.width?Rt.width/Kt.width:1},1,1)`,o(()=>{xe=setTimeout(()=>{ii.style.transition="transform .25s cubic-bezier(.4, 0, .2, 1)",ii.style.transform="none"},70)})}Nt&&X.value===!0&&dt(Nt.rootRef.value)}function dt(Ae){const{left:xt,width:Xt,top:Nt,height:Yt}=D.value.getBoundingClientRect(),ii=Ae.getBoundingClientRect();let Rt=e.vertical===!0?ii.top-Nt:ii.left-xt;if(Rt<0){D.value[e.vertical===!0?"scrollTop":"scrollLeft"]+=Math.floor(Rt),ee();return}Rt+=e.vertical===!0?ii.height-Yt:ii.width-Xt,Rt>0&&(D.value[e.vertical===!0?"scrollTop":"scrollLeft"]+=Math.ceil(Rt),ee())}function At(){const Ae=D.value;if(Ae!==null){const xt=Ae.getBoundingClientRect(),Xt=e.vertical===!0?Ae.scrollTop:Math.abs(Ae.scrollLeft);ti.value===!0?(K.value=Math.ceil(Xt+xt.width)<Ae.scrollWidth-1,q.value=Xt>0):(K.value=Xt>0,q.value=e.vertical===!0?Math.ceil(Xt+xt.height)<Ae.scrollHeight:Math.ceil(Xt+xt.width)<Ae.scrollWidth)}}function Tt(Ae){pi(),se=setInterval(()=>{$i(Ae)===!0&&pi()},5)}function Dt(){Tt($t.value===!0?Number.MAX_SAFE_INTEGER:0)}function Ct(){Tt($t.value===!0?0:Number.MAX_SAFE_INTEGER)}function pi(){clearInterval(se)}function yt(Ae,xt){const Xt=Array.prototype.filter.call(D.value.children,Kt=>Kt===xt||Kt.matches&&Kt.matches(".q-tab.q-focusable")===!0),Nt=Xt.length;if(Nt===0)return;if(Ae===36)return dt(Xt[0]),Xt[0].focus(),!0;if(Ae===35)return dt(Xt[Nt-1]),Xt[Nt-1].focus(),!0;const Yt=Ae===(e.vertical===!0?38:37),ii=Ae===(e.vertical===!0?40:39),Rt=Yt===!0?-1:ii===!0?1:void 0;if(Rt!==void 0){const Kt=ti.value===!0?-1:1,Li=Xt.indexOf(xt)+Rt*Kt;return Li>=0&&Li<Nt&&(dt(Xt[Li]),Xt[Li].focus({preventScroll:!0})),!0}}const vi=computed(()=>$t.value===!0?{get:Ae=>Math.abs(Ae.scrollLeft),set:(Ae,xt)=>{Ae.scrollLeft=-xt}}:e.vertical===!0?{get:Ae=>Ae.scrollTop,set:(Ae,xt)=>{Ae.scrollTop=xt}}:{get:Ae=>Ae.scrollLeft,set:(Ae,xt)=>{Ae.scrollLeft=xt}});function $i(Ae){const xt=D.value,{get:Xt,set:Nt}=vi.value;let Yt=!1,ii=Xt(xt);const Rt=Ae<ii?-1:1;return ii+=Rt*5,ii<0?(Yt=!0,ii=0):(Rt===-1&&ii<=Ae||Rt===1&&ii>=Ae)&&(Yt=!0,ii=Ae),Nt(xt,ii),ee(),Yt}function yi(Ae,xt){for(const Xt in Ae)if(Ae[Xt]!==xt[Xt])return!1;return!0}function mi(){let Ae=null,xt={matchedLen:0,queryDiff:9999,hrefLen:0};const Xt=Y.filter(Rt=>Rt.routeData!==void 0&&Rt.routeData.hasRouterLink.value===!0),{hash:Nt,query:Yt}=a.$route,ii=Object.keys(Yt).length;for(const Rt of Xt){const Kt=Rt.routeData.exact.value===!0;if(Rt.routeData[Kt===!0?"linkIsExactActive":"linkIsActive"].value!==!0)continue;const{hash:Li,query:Ii,matched:Fi,href:Xi}=Rt.routeData.resolvedLink.value,rr=Object.keys(Ii).length;if(Kt===!0){if(Li!==Nt||rr!==ii||yi(Yt,Ii)===!1)continue;Ae=Rt.name.value;break}if(Li!==""&&Li!==Nt||rr!==0&&yi(Ii,Yt)===!1)continue;const Ki={matchedLen:Fi.length,queryDiff:ii-rr,hrefLen:Xi.length-Li.length};if(Ki.matchedLen>xt.matchedLen){Ae=Rt.name.value,xt=Ki;continue}else if(Ki.matchedLen!==xt.matchedLen)continue;if(Ki.queryDiff<xt.queryDiff)Ae=Rt.name.value,xt=Ki;else if(Ki.queryDiff!==xt.queryDiff)continue;Ki.hrefLen>xt.hrefLen&&(Ae=Rt.name.value,xt=Ki)}Ae===null&&Y.some(Rt=>Rt.routeData===void 0&&Rt.name.value===U.value)===!0||oi({name:Ae,setCurrent:!0})}function It(Ae){if(E(),Ee.value!==!0&&L.value!==null&&Ae.target&&typeof Ae.target.closest=="function"){const xt=Ae.target.closest(".q-tab");xt&&L.value.contains(xt)===!0&&(Ee.value=!0,X.value===!0&&dt(xt))}}function kt(){b(()=>{Ee.value=!1},30)}function Ri(){Gt.avoidRouteWatcher===!1?M(mi):P()}function Pi(){if(ce===void 0){const Ae=watch(()=>a.$route.fullPath,Ri);ce=()=>{Ae(),ce=void 0}}}function zi(Ae){Y.push(Ae),J.value++,je(),Ae.routeData===void 0||a.$route===void 0?M(()=>{if(X.value===!0){const xt=U.value,Xt=xt!=null&&xt!==""?Y.find(Nt=>Nt.name.value===xt):null;Xt&&dt(Xt.rootRef.value)}}):(Pi(),Ae.routeData.hasRouterLink.value===!0&&Ri())}function ht(Ae){Y.splice(Y.indexOf(Ae),1),J.value--,je(),ce!==void 0&&Ae.routeData!==void 0&&(Y.every(xt=>xt.routeData===void 0)===!0&&ce(),Ri())}const Gt={currentModel:U,tabProps:he,hasFocus:Ee,hasActiveTab:Ie,registerTab:zi,unregisterTab:ht,verifyRouteModel:Ri,updateModel:oi,onKbdNavigate:yt,avoidRouteWatcher:!1};provide(tabsKey,Gt);function di(){clearTimeout(xe),pi(),ce!==void 0&&ce()}let si;return onBeforeUnmount(di),onDeactivated(()=>{si=ce!==void 0,di()}),onActivated(()=>{si===!0&&Pi(),je()}),()=>{const Ae=[h(QResizeObserver,{onResize:_t}),h("div",{ref:D,class:We.value,onScroll:ee},hSlot(r.default))];return W.value===!0&&Ae.push(h(QIcon,{class:"q-tabs__arrow q-tabs__arrow--left absolute q-tab__icon"+(K.value===!0?"":" q-tabs__arrow--faded"),name:e.leftIcon||u.iconSet.tabs[e.vertical===!0?"up":"left"],onMousedownPassive:Dt,onTouchstartPassive:Dt,onMouseupPassive:pi,onMouseleavePassive:pi,onTouchendPassive:pi}),h(QIcon,{class:"q-tabs__arrow q-tabs__arrow--right absolute q-tab__icon"+(q.value===!0?"":" q-tabs__arrow--faded"),name:e.rightIcon||u.iconSet.tabs[e.vertical===!0?"down":"right"],onMousedownPassive:Ct,onTouchstartPassive:Ct,onMouseupPassive:pi,onMouseleavePassive:pi,onTouchendPassive:pi})),h("div",{ref:L,class:Qe.value,role:"tablist",onFocusin:It,onFocusout:kt},Ae)}}});function parseArg(e){const r=[.06,6,50];return typeof e=="string"&&e.length&&e.split(":").forEach((n,a)=>{const u=parseFloat(n);u&&(r[a]=u)}),r}var TouchSwipe=createDirective({name:"touch-swipe",beforeMount(e,{value:r,arg:n,modifiers:a}){if(a.mouse!==!0&&client$1.has.touch!==!0)return;const u=a.mouseCapture===!0?"Capture":"",f={handler:r,sensitivity:parseArg(n),direction:getModifierDirections(a),noop,mouseStart(_){shouldStart(_,f)&&leftClick(_)&&(addEvt(f,"temp",[[document,"mousemove","move",`notPassive${u}`],[document,"mouseup","end","notPassiveCapture"]]),f.start(_,!0))},touchStart(_){if(shouldStart(_,f)){const o=_.target;addEvt(f,"temp",[[o,"touchmove","move","notPassiveCapture"],[o,"touchcancel","end","notPassiveCapture"],[o,"touchend","end","notPassiveCapture"]]),f.start(_)}},start(_,o){client$1.is.firefox===!0&&preventDraggable(e,!0);const b=position(_);f.event={x:b.left,y:b.top,time:Date.now(),mouse:o===!0,dir:!1}},move(_){if(f.event===void 0)return;if(f.event.dir!==!1){stopAndPrevent(_);return}const o=Date.now()-f.event.time;if(o===0)return;const b=position(_),E=b.left-f.event.x,M=Math.abs(E),P=b.top-f.event.y,L=Math.abs(P);if(f.event.mouse!==!0){if(M<f.sensitivity[1]&&L<f.sensitivity[1]){f.end(_);return}}else if(M<f.sensitivity[2]&&L<f.sensitivity[2])return;const D=M/o,U=L/o;f.direction.vertical===!0&&M<L&&M<100&&U>f.sensitivity[0]&&(f.event.dir=P<0?"up":"down"),f.direction.horizontal===!0&&M>L&&L<100&&D>f.sensitivity[0]&&(f.event.dir=E<0?"left":"right"),f.direction.up===!0&&M<L&&P<0&&M<100&&U>f.sensitivity[0]&&(f.event.dir="up"),f.direction.down===!0&&M<L&&P>0&&M<100&&U>f.sensitivity[0]&&(f.event.dir="down"),f.direction.left===!0&&M>L&&E<0&&L<100&&D>f.sensitivity[0]&&(f.event.dir="left"),f.direction.right===!0&&M>L&&E>0&&L<100&&D>f.sensitivity[0]&&(f.event.dir="right"),f.event.dir!==!1?(stopAndPrevent(_),f.event.mouse===!0&&(document.body.classList.add("no-pointer-events--children"),document.body.classList.add("non-selectable"),clearSelection(),f.styleCleanup=X=>{f.styleCleanup=void 0,document.body.classList.remove("non-selectable");const K=()=>{document.body.classList.remove("no-pointer-events--children")};X===!0?setTimeout(K,50):K()}),f.handler({evt:_,touch:f.event.mouse!==!0,mouse:f.event.mouse,direction:f.event.dir,duration:o,distance:{x:M,y:L}})):f.end(_)},end(_){f.event!==void 0&&(cleanEvt(f,"temp"),client$1.is.firefox===!0&&preventDraggable(e,!1),f.styleCleanup!==void 0&&f.styleCleanup(!0),_!==void 0&&f.event.dir!==!1&&stopAndPrevent(_),f.event=void 0)}};if(e.__qtouchswipe=f,a.mouse===!0){const _=a.mouseCapture===!0||a.mousecapture===!0?"Capture":"";addEvt(f,"main",[[e,"mousedown","mouseStart",`passive${_}`]])}client$1.has.touch===!0&&addEvt(f,"main",[[e,"touchstart","touchStart",`passive${a.capture===!0?"Capture":""}`],[e,"touchmove","noop","notPassiveCapture"]])},updated(e,r){const n=e.__qtouchswipe;n!==void 0&&(r.oldValue!==r.value&&(typeof r.value!="function"&&n.end(),n.handler=r.value),n.direction=getModifierDirections(r.modifiers))},beforeUnmount(e){const r=e.__qtouchswipe;r!==void 0&&(cleanEvt(r,"main"),cleanEvt(r,"temp"),client$1.is.firefox===!0&&preventDraggable(e,!1),r.styleCleanup!==void 0&&r.styleCleanup(),delete e.__qtouchswipe)}});function useCache(){const e=new Map;return{getCache:function(r,n){return e[r]===void 0?e[r]=n:e[r]},getCacheWithFn:function(r,n){return e[r]===void 0?e[r]=n():e[r]}}}const usePanelChildProps={name:{required:!0},disable:Boolean},PanelWrapper={setup(e,{slots:r}){return()=>h("div",{class:"q-panel scroll",role:"tabpanel"},hSlot(r.default))}},usePanelProps={modelValue:{required:!0},animated:Boolean,infinite:Boolean,swipeable:Boolean,vertical:Boolean,transitionPrev:String,transitionNext:String,transitionDuration:{type:[String,Number],default:300},keepAlive:Boolean,keepAliveInclude:[String,Array,RegExp],keepAliveExclude:[String,Array,RegExp],keepAliveMax:Number},usePanelEmits=["update:modelValue","beforeTransition","transition"];function usePanel(){const{props:e,emit:r,proxy:n}=getCurrentInstance(),{getCacheWithFn:a}=useCache();let u,f;const _=ref(null),o=ref(null);function b(Pe){const Qe=e.vertical===!0?"up":"left";xe((n.$q.lang.rtl===!0?-1:1)*(Pe.direction===Qe?1:-1))}const E=computed(()=>[[TouchSwipe,b,void 0,{horizontal:e.vertical!==!0,vertical:e.vertical,mouse:!0}]]),M=computed(()=>e.transitionPrev||`slide-${e.vertical===!0?"down":"right"}`),P=computed(()=>e.transitionNext||`slide-${e.vertical===!0?"up":"left"}`),L=computed(()=>`--q-transition-duration: ${e.transitionDuration}ms`),D=computed(()=>typeof e.modelValue=="string"||typeof e.modelValue=="number"?e.modelValue:String(e.modelValue)),U=computed(()=>({include:e.keepAliveInclude,exclude:e.keepAliveExclude,max:e.keepAliveMax})),X=computed(()=>e.keepAliveInclude!==void 0||e.keepAliveExclude!==void 0);watch(()=>e.modelValue,(Pe,Qe)=>{const We=W(Pe)===!0?Y(Pe):-1;f!==!0&&Ee(We===-1?0:We<Y(Qe)?-1:1),_.value!==We&&(_.value=We,r("beforeTransition",Pe,Qe),nextTick(()=>{r("transition",Pe,Qe)}))});function K(){xe(1)}function q(){xe(-1)}function oe(Pe){r("update:modelValue",Pe)}function W(Pe){return Pe!=null&&Pe!==""}function Y(Pe){return u.findIndex(Qe=>Qe.props.name===Pe&&Qe.props.disable!==""&&Qe.props.disable!==!0)}function J(){return u.filter(Pe=>Pe.props.disable!==""&&Pe.props.disable!==!0)}function Ee(Pe){const Qe=Pe!==0&&e.animated===!0&&_.value!==-1?"q-transition--"+(Pe===-1?M.value:P.value):null;o.value!==Qe&&(o.value=Qe)}function xe(Pe,Qe=_.value){let We=Qe+Pe;for(;We>-1&&We<u.length;){const Zt=u[We];if(Zt!==void 0&&Zt.props.disable!==""&&Zt.props.disable!==!0){Ee(Pe),f=!0,r("update:modelValue",Zt.props.name),setTimeout(()=>{f=!1});return}We+=Pe}e.infinite===!0&&u.length>0&&Qe!==-1&&Qe!==u.length&&xe(Pe,Pe===-1?u.length:-1)}function se(){const Pe=Y(e.modelValue);return _.value!==Pe&&(_.value=Pe),!0}function ce(){const Pe=W(e.modelValue)===!0&&se()&&u[_.value];return e.keepAlive===!0?[h(KeepAlive,U.value,[h(X.value===!0?a(D.value,()=>({...PanelWrapper,name:D.value})):PanelWrapper,{key:D.value,style:L.value},()=>Pe)])]:[h("div",{class:"q-panel scroll",style:L.value,key:D.value,role:"tabpanel"},[Pe])]}function ee(){if(u.length!==0)return e.animated===!0?[h(Transition,{name:o.value},ce)]:ce()}function he(Pe){return u=getNormalizedVNodes(hSlot(Pe.default,[])).filter(Qe=>Qe.props!==null&&Qe.props.slot===void 0&&W(Qe.props.name)===!0),u.length}function Ie(){return u}return Object.assign(n,{next:K,previous:q,goTo:oe}),{panelIndex:_,panelDirectives:E,updatePanelsList:he,updatePanelIndex:se,getPanelContent:ee,getEnabledPanels:J,getPanels:Ie,isValidPanelName:W,keepAliveProps:U,needsUniqueKeepAliveWrapper:X,goToPanelByOffset:xe,goToPanel:oe,nextPanel:K,previousPanel:q}}var QTabPanel=createComponent({name:"QTabPanel",props:usePanelChildProps,setup(e,{slots:r}){return()=>h("div",{class:"q-tab-panel",role:"tabpanel"},hSlot(r.default))}}),QTabPanels=createComponent({name:"QTabPanels",props:{...usePanelProps,...useDarkProps},emits:usePanelEmits,setup(e,{slots:r}){const n=getCurrentInstance(),a=useDark(e,n.proxy.$q),{updatePanelsList:u,getPanelContent:f,panelDirectives:_}=usePanel(),o=computed(()=>"q-tab-panels q-panel-parent"+(a.value===!0?" q-tab-panels--dark q-dark":""));return()=>(u(r),hDir("div",{class:o.value},f(),"pan",e.swipeable,()=>_.value))}}),QPageContainer=createComponent({name:"QPageContainer",setup(e,{slots:r}){const{proxy:{$q:n}}=getCurrentInstance(),a=inject(layoutKey,emptyRenderFn);if(a===emptyRenderFn)return console.error("QPageContainer needs to be child of QLayout"),emptyRenderFn;provide(pageContainerKey,!0);const u=computed(()=>{const f={};return a.header.space===!0&&(f.paddingTop=`${a.header.size}px`),a.right.space===!0&&(f[`padding${n.lang.rtl===!0?"Left":"Right"}`]=`${a.right.size}px`),a.footer.space===!0&&(f.paddingBottom=`${a.footer.size}px`),a.left.space===!0&&(f[`padding${n.lang.rtl===!0?"Right":"Left"}`]=`${a.left.size}px`),f});return()=>h("div",{class:"q-page-container",style:u.value},hSlot(r.default))}});const{passive}=listenOpts,axisValues=["both","horizontal","vertical"];var QScrollObserver=createComponent({name:"QScrollObserver",props:{axis:{type:String,validator:e=>axisValues.includes(e),default:"vertical"},debounce:[String,Number],scrollTarget:{default:void 0}},emits:["scroll"],setup(e,{emit:r}){const n={position:{top:0,left:0},direction:"down",directionChanged:!1,delta:{top:0,left:0},inflectionPoint:{top:0,left:0}};let a=null,u,f;watch(()=>e.scrollTarget,()=>{b(),o()});function _(){a!==null&&a();const P=Math.max(0,getVerticalScrollPosition(u)),L=getHorizontalScrollPosition(u),D={top:P-n.position.top,left:L-n.position.left};if(e.axis==="vertical"&&D.top===0||e.axis==="horizontal"&&D.left===0)return;const U=Math.abs(D.top)>=Math.abs(D.left)?D.top<0?"up":"down":D.left<0?"left":"right";n.position={top:P,left:L},n.directionChanged=n.direction!==U,n.delta=D,n.directionChanged===!0&&(n.direction=U,n.inflectionPoint=n.position),r("scroll",{...n})}function o(){u=getScrollTarget(f,e.scrollTarget),u.addEventListener("scroll",E,passive),E(!0)}function b(){u!==void 0&&(u.removeEventListener("scroll",E,passive),u=void 0)}function E(P){if(P===!0||e.debounce===0||e.debounce==="0")_();else if(a===null){const[L,D]=e.debounce?[setTimeout(_,e.debounce),clearTimeout]:[requestAnimationFrame(_),cancelAnimationFrame];a=()=>{D(L),a=null}}}const{proxy:M}=getCurrentInstance();return watch(()=>M.$q.lang.rtl,_),onMounted(()=>{f=M.$el.parentNode,o()}),onBeforeUnmount(()=>{a!==null&&a(),b()}),Object.assign(M,{trigger:E,getPosition:()=>n}),noop}}),QLayout=createComponent({name:"QLayout",props:{container:Boolean,view:{type:String,default:"hhh lpr fff",validator:e=>/^(h|l)h(h|r) lpr (f|l)f(f|r)$/.test(e.toLowerCase())},onScroll:Function,onScrollHeight:Function,onResize:Function},setup(e,{slots:r,emit:n}){const{proxy:{$q:a}}=getCurrentInstance(),u=ref(null),f=ref(a.screen.height),_=ref(e.container===!0?0:a.screen.width),o=ref({position:0,direction:"down",inflectionPoint:0}),b=ref(0),E=ref(isRuntimeSsrPreHydration.value===!0?0:getScrollbarWidth()),M=computed(()=>"q-layout q-layout--"+(e.container===!0?"containerized":"standard")),P=computed(()=>e.container===!1?{minHeight:a.screen.height+"px"}:null),L=computed(()=>E.value!==0?{[a.lang.rtl===!0?"left":"right"]:`${E.value}px`}:null),D=computed(()=>E.value!==0?{[a.lang.rtl===!0?"right":"left"]:0,[a.lang.rtl===!0?"left":"right"]:`-${E.value}px`,width:`calc(100% + ${E.value}px)`}:null);function U(Y){if(e.container===!0||document.qScrollPrevented!==!0){const J={position:Y.position.top,direction:Y.direction,directionChanged:Y.directionChanged,inflectionPoint:Y.inflectionPoint.top,delta:Y.delta.top};o.value=J,e.onScroll!==void 0&&n("scroll",J)}}function X(Y){const{height:J,width:Ee}=Y;let xe=!1;f.value!==J&&(xe=!0,f.value=J,e.onScrollHeight!==void 0&&n("scrollHeight",J),q()),_.value!==Ee&&(xe=!0,_.value=Ee),xe===!0&&e.onResize!==void 0&&n("resize",Y)}function K({height:Y}){b.value!==Y&&(b.value=Y,q())}function q(){if(e.container===!0){const Y=f.value>b.value?getScrollbarWidth():0;E.value!==Y&&(E.value=Y)}}let oe;const W={instances:{},view:computed(()=>e.view),isContainer:computed(()=>e.container),rootRef:u,height:f,containerHeight:b,scrollbarWidth:E,totalWidth:computed(()=>_.value+E.value),rows:computed(()=>{const Y=e.view.toLowerCase().split(" ");return{top:Y[0].split(""),middle:Y[1].split(""),bottom:Y[2].split("")}}),header:reactive({size:0,offset:0,space:!1}),right:reactive({size:300,offset:0,space:!1}),footer:reactive({size:0,offset:0,space:!1}),left:reactive({size:300,offset:0,space:!1}),scroll:o,animate(){oe!==void 0?clearTimeout(oe):document.body.classList.add("q-body--layout-animate"),oe=setTimeout(()=>{document.body.classList.remove("q-body--layout-animate"),oe=void 0},155)},update(Y,J,Ee){W[Y][J]=Ee}};if(provide(layoutKey,W),getScrollbarWidth()>0){let Ee=function(){Y=null,J.classList.remove("hide-scrollbar")},xe=function(){if(Y===null){if(J.scrollHeight>a.screen.height)return;J.classList.add("hide-scrollbar")}else clearTimeout(Y);Y=setTimeout(Ee,300)},se=function(ce){Y!==null&&ce==="remove"&&(clearTimeout(Y),Ee()),window[`${ce}EventListener`]("resize",xe)},Y=null;const J=document.body;watch(()=>e.container!==!0?"add":"remove",se),e.container!==!0&&se("add"),onUnmounted(()=>{se("remove")})}return()=>{const Y=hMergeSlot(r.default,[h(QScrollObserver,{onScroll:U}),h(QResizeObserver,{onResize:X})]),J=h("div",{class:M.value,style:P.value,ref:e.container===!0?void 0:u,tabindex:-1},Y);return e.container===!0?h("div",{class:"q-layout-container overflow-hidden",ref:u},[h(QResizeObserver,{onResize:K}),h("div",{class:"absolute-full",style:L.value},[h("div",{class:"scroll",style:D.value},[J])])]):J}}});const useAnchorProps={target:{default:!0},noParentEvent:Boolean,contextMenu:Boolean};function useAnchor({showing:e,avoidEmit:r,configureAnchorEl:n}){const{props:a,proxy:u,emit:f}=getCurrentInstance(),_=ref(null);let o;function b(D){return _.value===null?!1:D===void 0||D.touches===void 0||D.touches.length<=1}const E={};n===void 0&&(Object.assign(E,{hide(D){u.hide(D)},toggle(D){u.toggle(D),D.qAnchorHandled=!0},toggleKey(D){isKeyCode(D,13)===!0&&E.toggle(D)},contextClick(D){u.hide(D),prevent(D),nextTick(()=>{u.show(D),D.qAnchorHandled=!0})},prevent,mobileTouch(D){if(E.mobileCleanup(D),b(D)!==!0)return;u.hide(D),_.value.classList.add("non-selectable");const U=D.target;addEvt(E,"anchor",[[U,"touchmove","mobileCleanup","passive"],[U,"touchend","mobileCleanup","passive"],[U,"touchcancel","mobileCleanup","passive"],[_.value,"contextmenu","prevent","notPassive"]]),o=setTimeout(()=>{u.show(D),D.qAnchorHandled=!0},300)},mobileCleanup(D){_.value.classList.remove("non-selectable"),clearTimeout(o),e.value===!0&&D!==void 0&&clearSelection()}}),n=function(D=a.contextMenu){if(a.noParentEvent===!0||_.value===null)return;let U;D===!0?u.$q.platform.is.mobile===!0?U=[[_.value,"touchstart","mobileTouch","passive"]]:U=[[_.value,"mousedown","hide","passive"],[_.value,"contextmenu","contextClick","notPassive"]]:U=[[_.value,"click","toggle","passive"],[_.value,"keyup","toggleKey","passive"]],addEvt(E,"anchor",U)});function M(){cleanEvt(E,"anchor")}function P(D){for(_.value=D;_.value.classList.contains("q-anchor--skip");)_.value=_.value.parentNode;n()}function L(){if(a.target===!1||a.target===""||u.$el.parentNode===null)_.value=null;else if(a.target===!0)P(u.$el.parentNode);else{let D=a.target;if(typeof a.target=="string")try{D=document.querySelector(a.target)}catch{D=void 0}D!=null?(_.value=D.$el||D,n()):(_.value=null,console.error(`Anchor: target "${a.target}" not found`))}}return watch(()=>a.contextMenu,D=>{_.value!==null&&(M(),n(D))}),watch(()=>a.target,()=>{_.value!==null&&M(),L()}),watch(()=>a.noParentEvent,D=>{_.value!==null&&(D===!0?M():n())}),onMounted(()=>{L(),r!==!0&&a.modelValue===!0&&_.value===null&&f("update:modelValue",!1)}),onBeforeUnmount(()=>{clearTimeout(o),M()}),{anchorEl:_,canShow:b,anchorEvents:E}}function useScrollTarget(e,r){const n=ref(null);let a;function u(o,b){const E=`${b!==void 0?"add":"remove"}EventListener`,M=b!==void 0?b:a;o!==window&&o[E]("scroll",M,listenOpts.passive),window[E]("scroll",M,listenOpts.passive),a=b}function f(){n.value!==null&&(u(n.value),n.value=null)}const _=watch(()=>e.noParentEvent,()=>{n.value!==null&&(f(),r())});return onBeforeUnmount(_),{localScrollTarget:n,unconfigureScrollTarget:f,changeScrollEvent:u}}let timer;const{notPassiveCapture}=listenOpts,registeredList=[];function globalHandler(e){clearTimeout(timer);const r=e.target;if(r===void 0||r.nodeType===8||r.classList.contains("no-pointer-events")===!0)return;let n=portalProxyList.length-1;for(;n>=0;){const a=portalProxyList[n].$;if(a.type.name!=="QDialog")break;if(a.props.seamless!==!0)return;n--}for(let a=registeredList.length-1;a>=0;a--){const u=registeredList[a];if((u.anchorEl.value===null||u.anchorEl.value.contains(r)===!1)&&(r===document.body||u.innerRef.value!==null&&u.innerRef.value.contains(r)===!1))e.qClickOutside=!0,u.onClickOutside(e);else return}}function addClickOutside(e){registeredList.push(e),registeredList.length===1&&(document.addEventListener("mousedown",globalHandler,notPassiveCapture),document.addEventListener("touchstart",globalHandler,notPassiveCapture))}function removeClickOutside(e){const r=registeredList.findIndex(n=>n===e);r>-1&&(registeredList.splice(r,1),registeredList.length===0&&(clearTimeout(timer),document.removeEventListener("mousedown",globalHandler,notPassiveCapture),document.removeEventListener("touchstart",globalHandler,notPassiveCapture)))}let vpLeft,vpTop;function validatePosition(e){const r=e.split(" ");return r.length!==2?!1:["top","center","bottom"].includes(r[0])!==!0?(console.error("Anchor/Self position must start with one of top/center/bottom"),!1):["left","middle","right","start","end"].includes(r[1])!==!0?(console.error("Anchor/Self position must end with one of left/middle/right/start/end"),!1):!0}function validateOffset(e){return e?!(e.length!==2||typeof e[0]!="number"||typeof e[1]!="number"):!0}const horizontalPos={"start#ltr":"left","start#rtl":"right","end#ltr":"right","end#rtl":"left"};["left","middle","right"].forEach(e=>{horizontalPos[`${e}#ltr`]=e,horizontalPos[`${e}#rtl`]=e});function parsePosition(e,r){const n=e.split(" ");return{vertical:n[0],horizontal:horizontalPos[`${n[1]}#${r===!0?"rtl":"ltr"}`]}}function getAnchorProps(e,r){let{top:n,left:a,right:u,bottom:f,width:_,height:o}=e.getBoundingClientRect();return r!==void 0&&(n-=r[1],a-=r[0],f+=r[1],u+=r[0],_+=r[0],o+=r[1]),{top:n,left:a,right:u,bottom:f,width:_,height:o,middle:a+(u-a)/2,center:n+(f-n)/2}}function getTargetProps(e){return{top:0,center:e.offsetHeight/2,bottom:e.offsetHeight,left:0,middle:e.offsetWidth/2,right:e.offsetWidth}}function setPosition(e){if(client$1.is.ios===!0&&window.visualViewport!==void 0){const o=document.body.style,{offsetLeft:b,offsetTop:E}=window.visualViewport;b!==vpLeft&&(o.setProperty("--q-pe-left",b+"px"),vpLeft=b),E!==vpTop&&(o.setProperty("--q-pe-top",E+"px"),vpTop=E)}let r;const{scrollLeft:n,scrollTop:a}=e.el;if(e.absoluteOffset===void 0)r=getAnchorProps(e.anchorEl,e.cover===!0?[0,0]:e.offset);else{const{top:o,left:b}=e.anchorEl.getBoundingClientRect(),E=o+e.absoluteOffset.top,M=b+e.absoluteOffset.left;r={top:E,left:M,width:1,height:1,right:M+1,center:E,middle:M,bottom:E+1}}let u={maxHeight:e.maxHeight,maxWidth:e.maxWidth,visibility:"visible"};(e.fit===!0||e.cover===!0)&&(u.minWidth=r.width+"px",e.cover===!0&&(u.minHeight=r.height+"px")),Object.assign(e.el.style,u);const f=getTargetProps(e.el),_={top:r[e.anchorOrigin.vertical]-f[e.selfOrigin.vertical],left:r[e.anchorOrigin.horizontal]-f[e.selfOrigin.horizontal]};applyBoundaries(_,r,f,e.anchorOrigin,e.selfOrigin),u={top:_.top+"px",left:_.left+"px"},_.maxHeight!==void 0&&(u.maxHeight=_.maxHeight+"px",r.height>_.maxHeight&&(u.minHeight=u.maxHeight)),_.maxWidth!==void 0&&(u.maxWidth=_.maxWidth+"px",r.width>_.maxWidth&&(u.minWidth=u.maxWidth)),Object.assign(e.el.style,u),e.el.scrollTop!==a&&(e.el.scrollTop=a),e.el.scrollLeft!==n&&(e.el.scrollLeft=n)}function applyBoundaries(e,r,n,a,u){const f=n.bottom,_=n.right,o=getScrollbarWidth(),b=window.innerHeight-o,E=document.body.clientWidth;if(e.top<0||e.top+f>b)if(u.vertical==="center")e.top=r[a.vertical]>b/2?Math.max(0,b-f):0,e.maxHeight=Math.min(f,b);else if(r[a.vertical]>b/2){const M=Math.min(b,a.vertical==="center"?r.center:a.vertical===u.vertical?r.bottom:r.top);e.maxHeight=Math.min(f,M),e.top=Math.max(0,M-f)}else e.top=Math.max(0,a.vertical==="center"?r.center:a.vertical===u.vertical?r.top:r.bottom),e.maxHeight=Math.min(f,b-e.top);if(e.left<0||e.left+_>E)if(e.maxWidth=Math.min(_,E),u.horizontal==="middle")e.left=r[a.horizontal]>E/2?Math.max(0,E-_):0;else if(r[a.horizontal]>E/2){const M=Math.min(E,a.horizontal==="middle"?r.middle:a.horizontal===u.horizontal?r.right:r.left);e.maxWidth=Math.min(_,M),e.left=Math.max(0,M-e.maxWidth)}else e.left=Math.max(0,a.horizontal==="middle"?r.middle:a.horizontal===u.horizontal?r.left:r.right),e.maxWidth=Math.min(_,E-e.left)}var QMenu=createComponent({name:"QMenu",inheritAttrs:!1,props:{...useAnchorProps,...useModelToggleProps,...useDarkProps,...useTransitionProps,persistent:Boolean,autoClose:Boolean,separateClosePopup:Boolean,noRouteDismiss:Boolean,noRefocus:Boolean,noFocus:Boolean,fit:Boolean,cover:Boolean,square:Boolean,anchor:{type:String,validator:validatePosition},self:{type:String,validator:validatePosition},offset:{type:Array,validator:validateOffset},scrollTarget:{default:void 0},touchPosition:Boolean,maxHeight:{type:String,default:null},maxWidth:{type:String,default:null}},emits:[...useModelToggleEmits,"click","escapeKey"],setup(e,{slots:r,emit:n,attrs:a}){let u=null,f,_,o;const b=getCurrentInstance(),{proxy:E}=b,{$q:M}=E,P=ref(null),L=ref(!1),D=computed(()=>e.persistent!==!0&&e.noRouteDismiss!==!0),U=useDark(e,M),{registerTick:X,removeTick:K}=useTick(),{registerTimeout:q}=useTimeout(),{transitionProps:oe,transitionStyle:W}=useTransition(e),{localScrollTarget:Y,changeScrollEvent:J,unconfigureScrollTarget:Ee}=useScrollTarget(e,dt),{anchorEl:xe,canShow:se}=useAnchor({showing:L}),{hide:ce}=useModelToggle({showing:L,canShow:se,handleShow:je,handleHide:_t,hideOnRouteChange:D,processOnMount:!0}),{showPortal:ee,hidePortal:he,renderPortal:Ie}=usePortal(b,P,pi),Pe={anchorEl:xe,innerRef:P,onClickOutside(yt){if(e.persistent!==!0&&L.value===!0)return ce(yt),(yt.type==="touchstart"||yt.target.classList.contains("q-dialog__backdrop"))&&stopAndPrevent(yt),!0}},Qe=computed(()=>parsePosition(e.anchor||(e.cover===!0?"center middle":"bottom start"),M.lang.rtl)),We=computed(()=>e.cover===!0?Qe.value:parsePosition(e.self||"top start",M.lang.rtl)),Zt=computed(()=>(e.square===!0?" q-menu--square":"")+(U.value===!0?" q-menu--dark q-dark":"")),ti=computed(()=>e.autoClose===!0?{onClick:At}:{}),$t=computed(()=>L.value===!0&&e.persistent!==!0);watch($t,yt=>{yt===!0?(addEscapeKey(Dt),addClickOutside(Pe)):(removeEscapeKey(Dt),removeClickOutside(Pe))});function oi(){addFocusFn(()=>{let yt=P.value;yt&&yt.contains(document.activeElement)!==!0&&(yt=yt.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||yt.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||yt.querySelector("[autofocus], [data-autofocus]")||yt,yt.focus({preventScroll:!0}))})}function je(yt){if(u=e.noRefocus===!1?document.activeElement:null,addFocusout(Tt),ee(),dt(),f=void 0,yt!==void 0&&(e.touchPosition||e.contextMenu)){const vi=position(yt);if(vi.left!==void 0){const{top:$i,left:yi}=xe.value.getBoundingClientRect();f={left:vi.left-yi,top:vi.top-$i}}}_===void 0&&(_=watch(()=>M.screen.width+"|"+M.screen.height+"|"+e.self+"|"+e.anchor+"|"+M.lang.rtl,Ct)),e.noFocus!==!0&&document.activeElement.blur(),X(()=>{Ct(),e.noFocus!==!0&&oi()}),q(()=>{M.platform.is.ios===!0&&(o=e.autoClose,P.value.click()),Ct(),ee(!0),n("show",yt)},e.transitionDuration)}function _t(yt){K(),he(),Bt(!0),u!==null&&(yt===void 0||yt.qClickOutside!==!0)&&(((yt&&yt.type.indexOf("key")===0?u.closest('[tabindex]:not([tabindex^="-"])'):void 0)||u).focus(),u=null),q(()=>{he(!0),n("hide",yt)},e.transitionDuration)}function Bt(yt){f=void 0,_!==void 0&&(_(),_=void 0),(yt===!0||L.value===!0)&&(removeFocusout(Tt),Ee(),removeClickOutside(Pe),removeEscapeKey(Dt)),yt!==!0&&(u=null)}function dt(){(xe.value!==null||e.scrollTarget!==void 0)&&(Y.value=getScrollTarget(xe.value,e.scrollTarget),J(Y.value,Ct))}function At(yt){o!==!0?(closePortalMenus(E,yt),n("click",yt)):o=!1}function Tt(yt){$t.value===!0&&e.noFocus!==!0&&childHasFocus(P.value,yt.target)!==!0&&oi()}function Dt(yt){n("escapeKey"),ce(yt)}function Ct(){const yt=P.value;yt===null||xe.value===null||setPosition({el:yt,offset:e.offset,anchorEl:xe.value,anchorOrigin:Qe.value,selfOrigin:We.value,absoluteOffset:f,fit:e.fit,cover:e.cover,maxHeight:e.maxHeight,maxWidth:e.maxWidth})}function pi(){return h(Transition,oe.value,()=>L.value===!0?h("div",{role:"menu",...a,ref:P,tabindex:-1,class:["q-menu q-position-engine scroll"+Zt.value,a.class],style:[a.style,W.value],...ti.value},hSlot(r.default)):null)}return onBeforeUnmount(Bt),Object.assign(E,{focus:oi,updatePosition:Ct}),Ie}}),QToolbar=createComponent({name:"QToolbar",props:{inset:Boolean},setup(e,{slots:r}){const n=computed(()=>"q-toolbar row no-wrap items-center"+(e.inset===!0?" q-toolbar--inset":""));return()=>h("div",{class:n.value,role:"toolbar"},hSlot(r.default))}});class Store{constructor(r="unreal-mapbox",n="keyval"){this.storeName=n,this._dbp=new Promise((a,u)=>{const f=indexedDB.open(r,3);f.onerror=()=>u(f.error),f.onsuccess=()=>a(f.result),f.onupgradeneeded=()=>{try{f.result.deleteObjectStore(n)}catch{}f.result.createObjectStore(n)}})}_withIDBStore(r,n){return this._dbp.then(a=>new Promise((u,f)=>{const _=a.transaction(this.storeName,r);_.oncomplete=()=>u(),_.onabort=_.onerror=()=>f(_.error),n(_.objectStore(this.storeName))}))}}let store;function getDefaultStore(){return store||(store=new Store),store}function get(e,r=getDefaultStore()){let n;return r._withIDBStore("readonly",a=>{n=a.get(e)}).then(()=>n.result)}function set(e,r,n=getDefaultStore()){return n._withIDBStore("readwrite",a=>{a.put(r,e)})}function del(e,r=getDefaultStore()){return r._withIDBStore("readwrite",n=>{n.delete(e)})}function clear(e=getDefaultStore()){return e._withIDBStore("readwrite",r=>{r.clear()})}function keys(e=getDefaultStore()){const r=[];return e._withIDBStore("readonly",n=>{(n.openKeyCursor||n.openCursor).call(n).onsuccess=function(){!this.result||(r.push(this.result.key),this.result.continue())}}).then(()=>r)}var idbKeyval={keys,clear,del,set,get};function getFileHandle(){if("showOpenFilePicker"in window)return window.showOpenFilePicker().then(e=>e[0])}function getDirHandle(){if("showDirectoryPicker"in window)return window.showDirectoryPicker().then(e=>e)}async function verifyPermission(e,r){const n={};return r&&(n.writable=!0,n.mode="readwrite"),await e.queryPermission(n)==="granted"||await e.requestPermission(n)==="granted"}async function writeFileToDisk(e,r,n){let u=await(await e.getFileHandle(r,{create:!0})).createWritable();await u.write(n),await u.close()}async function fileExists(e,r){try{return await e.getFileHandle(r),!0}catch(n){if(n.name==="NotFoundError")return!1;if(n.name==="NotAllowedError")return console.log("Please select directory to verify permissions"),!1}}async function readFileFromDisk(e,r){return await(await(await e.getFileHandle(r)).getFile()).arrayBuffer()}var fileUtils={getDirHandle,verifyPermission,writeFileToDisk,fileExists,getFileHandle,readFileFromDisk},commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getAugmentedNamespace(e){if(e.__esModule)return e;var r=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach(function(n){var a=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(r,n,a.get?a:{enumerable:!0,get:function(){return e[n]}})}),r}function commonjsRequire(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var mapboxGl={exports:{}};(function(e,r){(function(n,a){e.exports=a()})(commonjsGlobal,function(){var n,a,u;function f(o,b){if(!n)n=b;else if(!a)a=b;else{var E="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+n+")(sharedChunk); ("+a+")(sharedChunk); self.onerror = null;",M={};n(M),u=b(M),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(u.workerUrl=window.URL.createObjectURL(new Blob([E],{type:"text/javascript"})))}}f(["exports"],function(o){var b=typeof self<"u"?self:{},E="2.11.0";let M;const P={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(M==null){const s=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{M={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):s}catch{M=s}}return M},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get EVENTS_URL(){return this.API_URL?this.API_URL.indexOf("https://api.mapbox.cn")===0?"https://events.mapbox.cn/events/v2":this.API_URL.indexOf("https://api.mapbox.com")===0?"https://events.mapbox.com/events/v2":null:null},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},L={supported:!1,testSupport:function(s){!X&&U&&(K?q(s):D=s)}};let D,U,X=!1,K=!1;function q(s){const t=s.createTexture();s.bindTexture(s.TEXTURE_2D,t);try{if(s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,U),s.isContextLost())return;L.supported=!0}catch{}s.deleteTexture(t),X=!0}b.document&&(U=b.document.createElement("img"),U.onload=function(){D&&q(D),D=null,K=!0},U.onerror=function(){X=!0,D=null},U.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const oe="01";var W=Y;function Y(s,t,l,d){this.cx=3*s,this.bx=3*(l-s)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(d-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=s,this.p1y=t,this.p2x=l,this.p2y=d}Y.prototype={sampleCurveX:function(s){return((this.ax*s+this.bx)*s+this.cx)*s},sampleCurveY:function(s){return((this.ay*s+this.by)*s+this.cy)*s},sampleCurveDerivativeX:function(s){return(3*this.ax*s+2*this.bx)*s+this.cx},solveCurveX:function(s,t){if(t===void 0&&(t=1e-6),s<0)return 0;if(s>1)return 1;for(var l=s,d=0;d<8;d++){var m=this.sampleCurveX(l)-s;if(Math.abs(m)<t)return l;var y=this.sampleCurveDerivativeX(l);if(Math.abs(y)<1e-6)break;l-=m/y}var w=0,S=1;for(l=s,d=0;d<20&&(m=this.sampleCurveX(l),!(Math.abs(m-s)<t));d++)s>m?w=l:S=l,l=.5*(S-w)+w;return l},solve:function(s,t){return this.sampleCurveY(this.solveCurveX(s,t))}};var J=Ee;function Ee(s,t){this.x=s,this.y=t}Ee.prototype={clone:function(){return new Ee(this.x,this.y)},add:function(s){return this.clone()._add(s)},sub:function(s){return this.clone()._sub(s)},multByPoint:function(s){return this.clone()._multByPoint(s)},divByPoint:function(s){return this.clone()._divByPoint(s)},mult:function(s){return this.clone()._mult(s)},div:function(s){return this.clone()._div(s)},rotate:function(s){return this.clone()._rotate(s)},rotateAround:function(s,t){return this.clone()._rotateAround(s,t)},matMult:function(s){return this.clone()._matMult(s)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(s){return this.x===s.x&&this.y===s.y},dist:function(s){return Math.sqrt(this.distSqr(s))},distSqr:function(s){var t=s.x-this.x,l=s.y-this.y;return t*t+l*l},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(s){return Math.atan2(this.y-s.y,this.x-s.x)},angleWith:function(s){return this.angleWithSep(s.x,s.y)},angleWithSep:function(s,t){return Math.atan2(this.x*t-this.y*s,this.x*s+this.y*t)},_matMult:function(s){var t=s[2]*this.x+s[3]*this.y;return this.x=s[0]*this.x+s[1]*this.y,this.y=t,this},_add:function(s){return this.x+=s.x,this.y+=s.y,this},_sub:function(s){return this.x-=s.x,this.y-=s.y,this},_mult:function(s){return this.x*=s,this.y*=s,this},_div:function(s){return this.x/=s,this.y/=s,this},_multByPoint:function(s){return this.x*=s.x,this.y*=s.y,this},_divByPoint:function(s){return this.x/=s.x,this.y/=s.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var s=this.y;return this.y=this.x,this.x=-s,this},_rotate:function(s){var t=Math.cos(s),l=Math.sin(s),d=l*this.x+t*this.y;return this.x=t*this.x-l*this.y,this.y=d,this},_rotateAround:function(s,t){var l=Math.cos(s),d=Math.sin(s),m=t.y+d*(this.x-t.x)+l*(this.y-t.y);return this.x=t.x+l*(this.x-t.x)-d*(this.y-t.y),this.y=m,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Ee.convert=function(s){return s instanceof Ee?s:Array.isArray(s)?new Ee(s[0],s[1]):s};const xe=Math.PI/180,se=180/Math.PI;function ce(s){return s*xe}function ee(s){return s*se}const he=[[0,0],[1,0],[1,1],[0,1]];function Ie(s){if(s<=0)return 0;if(s>=1)return 1;const t=s*s,l=t*s;return 4*(s<.5?l:3*(s-t)+l-.75)}function Pe(s,t,l,d){const m=new W(s,t,l,d);return function(y){return m.solve(y)}}const Qe=Pe(.25,.1,.25,1);function We(s,t,l){return Math.min(l,Math.max(t,s))}function Zt(s,t,l){return(l=We((l-s)/(t-s),0,1))*l*(3-2*l)}function ti(s,t,l){const d=l-t,m=((s-t)%d+d)%d+t;return m===t?l:m}function $t(s,t,l){if(!s.length)return l(null,[]);let d=s.length;const m=new Array(s.length);let y=null;s.forEach((w,S)=>{t(w,(I,C)=>{I&&(y=I),m[S]=C,--d==0&&l(y,m)})})}function oi(s){const t=[];for(const l in s)t.push(s[l]);return t}function je(s,...t){for(const l of t)for(const d in l)s[d]=l[d];return s}let _t=1;function Bt(){return _t++}function dt(){return function s(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,s)}()}function At(s){return s<=1?1:Math.pow(2,Math.ceil(Math.log(s)/Math.LN2))}function Tt(s){return!!s&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s)}function Dt(s,t){s.forEach(l=>{t[l]&&(t[l]=t[l].bind(t))})}function Ct(s,t){return s.indexOf(t,s.length-t.length)!==-1}function pi(s,t,l){const d={};for(const m in s)d[m]=t.call(l||this,s[m],m,s);return d}function yt(s,t,l){const d={};for(const m in s)t.call(l||this,s[m],m,s)&&(d[m]=s[m]);return d}function vi(s){return Array.isArray(s)?s.map(vi):typeof s=="object"&&s?pi(s,vi):s}const $i={};function yi(s){$i[s]||(typeof console<"u"&&console.warn(s),$i[s]=!0)}function mi(s,t,l){return(l.y-s.y)*(t.x-s.x)>(t.y-s.y)*(l.x-s.x)}function It(s){let t=0;for(let l,d,m=0,y=s.length,w=y-1;m<y;w=m++)l=s[m],d=s[w],t+=(d.x-l.x)*(l.y+d.y);return t}function kt(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function Ri(s){const t={};if(s.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(l,d,m,y)=>{const w=m||y;return t[d]=!w||w.toLowerCase(),""}),t["max-age"]){const l=parseInt(t["max-age"],10);isNaN(l)?delete t["max-age"]:t["max-age"]=l}return t}let Pi=null;function zi(s){if(Pi==null){const t=s.navigator?s.navigator.userAgent:null;Pi=!!s.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return Pi}function ht(s){try{const t=b[s];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}}function Gt(s,t){return[s[4*t],s[4*t+1],s[4*t+2],s[4*t+3]]}const di="mapbox-tiles";let si,Ae,xt=500,Xt=50;function Nt(){try{return b.caches}catch{}}function Yt(){Nt()&&!si&&(si=b.caches.open(di))}function ii(s){const t=s.indexOf("?");if(t<0)return s;const l=function(m){const y=m.indexOf("?");return y>0?m.slice(y+1).split("&"):[]}(s),d=l.filter(m=>{const y=m.split("=");return y[0]==="language"||y[0]==="worldview"});return d.length?`${s.slice(0,t)}?${d.join("&")}`:s.slice(0,t)}let Rt=1/0;const Kt={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(Kt);class Li extends Error{constructor(t,l,d){l===401&&un(d)&&(t+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(t),this.status=l,this.url=d}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Ii=kt()?()=>self.worker&&self.worker.referrer:()=>(b.location.protocol==="blob:"?b.parent:b).location.href,Fi=function(s,t){if(!(/^file:/.test(l=s.url)||/^file:/.test(Ii())&&!/^\w+:/.test(l))){if(b.fetch&&b.Request&&b.AbortController&&b.Request.prototype.hasOwnProperty("signal"))return function(d,m){const y=new b.AbortController,w=new b.Request(d.url,{method:d.method||"GET",body:d.body,credentials:d.credentials,headers:d.headers,referrer:Ii(),signal:y.signal});let S=!1,I=!1;const C=(z=w.url).indexOf("sku=")>0&&un(z);var z;d.type==="json"&&w.headers.set("Accept","application/json");const N=(Z,Q,re)=>{if(I)return;if(Z&&Z.message!=="SecurityError"&&yi(Z),Q&&re)return $(Q);const ue=Date.now();b.fetch(w).then(Se=>{if(Se.ok){const Le=C?Se.clone():null;return $(Se,Le,ue)}return m(new Li(Se.statusText,Se.status,d.url))}).catch(Se=>{Se.code!==20&&m(new Error(Se.message))})},$=(Z,Q,re)=>{(d.type==="arrayBuffer"?Z.arrayBuffer():d.type==="json"?Z.json():Z.text()).then(ue=>{I||(Q&&re&&function(Se,Le,Te){if(Yt(),!si)return;const Ce={status:Le.status,statusText:Le.statusText,headers:new b.Headers};Le.headers.forEach((st,rt)=>Ce.headers.set(rt,st));const Ne=Ri(Le.headers.get("Cache-Control")||"");if(Ne["no-store"])return;Ne["max-age"]&&Ce.headers.set("Expires",new Date(Te+1e3*Ne["max-age"]).toUTCString());const Oe=Ce.headers.get("Expires");Oe&&(new Date(Oe).getTime()-Te<42e4||function(st,rt){if(Ae===void 0)try{new Response(new ReadableStream),Ae=!0}catch{Ae=!1}Ae?rt(st.body):st.blob().then(rt)}(Le,st=>{const rt=new b.Response(st,Ce);Yt(),si&&si.then(mt=>mt.put(ii(Se.url),rt)).catch(mt=>yi(mt.message))}))}(w,Q,re),S=!0,m(null,ue,Z.headers.get("Cache-Control"),Z.headers.get("Expires")))}).catch(ue=>{I||m(new Error(ue.message))})};return C?function(Z,Q){if(Yt(),!si)return Q(null);const re=ii(Z.url);si.then(ue=>{ue.match(re).then(Se=>{const Le=function(Te){if(!Te)return!1;const Ce=new Date(Te.headers.get("Expires")||0),Ne=Ri(Te.headers.get("Cache-Control")||"");return Ce>Date.now()&&!Ne["no-cache"]}(Se);ue.delete(re),Le&&ue.put(re,Se.clone()),Q(null,Se,Le)}).catch(Q)}).catch(Q)}(w,N):N(null,null),{cancel:()=>{I=!0,S||y.abort()}}}(s,t);if(kt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",s,t,void 0,!0)}var l;return function(d,m){const y=new b.XMLHttpRequest;y.open(d.method||"GET",d.url,!0),d.type==="arrayBuffer"&&(y.responseType="arraybuffer");for(const w in d.headers)y.setRequestHeader(w,d.headers[w]);return d.type==="json"&&(y.responseType="text",y.setRequestHeader("Accept","application/json")),y.withCredentials=d.credentials==="include",y.onerror=()=>{m(new Error(y.statusText))},y.onload=()=>{if((y.status>=200&&y.status<300||y.status===0)&&y.response!==null){let w=y.response;if(d.type==="json")try{w=JSON.parse(y.response)}catch(S){return m(S)}m(null,w,y.getResponseHeader("Cache-Control"),y.getResponseHeader("Expires"))}else m(new Li(y.statusText,y.status,d.url))},y.send(d.body),{cancel:()=>y.abort()}}(s,t)},Xi=function(s,t){return Fi(je(s,{type:"arrayBuffer"}),t)};function rr(s){const t=b.document.createElement("a");return t.href=s,t.protocol===b.document.location.protocol&&t.host===b.document.location.host}const Ki="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Ci,Ir;Ci=[],Ir=0;const mn=function(s,t){if(L.supported&&(s.headers||(s.headers={}),s.headers.accept="image/webp,*/*"),Ir>=P.MAX_PARALLEL_IMAGE_REQUESTS){const y={requestParameters:s,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return Ci.push(y),y}Ir++;let l=!1;const d=()=>{if(!l)for(l=!0,Ir--;Ci.length&&Ir<P.MAX_PARALLEL_IMAGE_REQUESTS;){const y=Ci.shift(),{requestParameters:w,callback:S,cancelled:I}=y;I||(y.cancel=mn(w,S).cancel)}},m=Xi(s,(y,w,S,I)=>{d(),y?t(y):w&&(b.createImageBitmap?function(C,z){const N=new b.Blob([new Uint8Array(C)],{type:"image/png"});b.createImageBitmap(N).then($=>{z(null,$)}).catch($=>{z(new Error(`Could not load image because of ${$.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(w,(C,z)=>t(C,z,S,I)):function(C,z){const N=new b.Image,$=b.URL;N.onload=()=>{z(null,N),$.revokeObjectURL(N.src),N.onload=null,b.requestAnimationFrame(()=>{N.src=Ki})},N.onerror=()=>z(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const Z=new b.Blob([new Uint8Array(C)],{type:"image/png"});N.src=C.byteLength?$.createObjectURL(Z):Ki}(w,(C,z)=>t(C,z,S,I)))});return{cancel:()=>{m.cancel(),d()}}},gn="NO_ACCESS_TOKEN";function Er(s){return s.indexOf("mapbox:")===0}function un(s){return P.API_URL_REGEX.test(s)}function ar(s){return P.API_STYLE_REGEX.test(s)&&!Jr(s)}function Jr(s){return P.API_SPRITE_REGEX.test(s)}const qr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function kr(s){const t=s.match(qr);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function ye(s){const t=s.params.length?`?${s.params.join("&")}`:"";return`${s.protocol}://${s.authority}${s.path}${t}`}function qe(s){if(!s)return null;const t=s.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(decodeURIComponent(b.atob(t[1]).split("").map(l=>"%"+("00"+l.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class at{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const l=qe(P.ACCESS_TOKEN);let d="";return d=l&&l.u?b.btoa(encodeURIComponent(l.u).replace(/%([0-9A-F]{2})/g,(m,y)=>String.fromCharCode(Number("0x"+y)))):P.ACCESS_TOKEN||"",t?`mapbox.eventData.${t}:${d}`:`mapbox.eventData:${d}`}fetchEventData(){const t=ht("localStorage"),l=this.getStorageKey(),d=this.getStorageKey("uuid");if(t)try{const m=b.localStorage.getItem(l);m&&(this.eventData=JSON.parse(m));const y=b.localStorage.getItem(d);y&&(this.anonId=y)}catch{yi("Unable to read from LocalStorage")}}saveEventData(){const t=ht("localStorage"),l=this.getStorageKey(),d=this.getStorageKey("uuid");if(t)try{b.localStorage.setItem(d,this.anonId),Object.keys(this.eventData).length>=1&&b.localStorage.setItem(l,JSON.stringify(this.eventData))}catch{yi("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,l,d,m){if(!P.EVENTS_URL)return;const y=kr(P.EVENTS_URL);y.params.push(`access_token=${m||P.ACCESS_TOKEN||""}`);const w={event:this.type,created:new Date(t).toISOString()},S=l?je(w,l):w,I={url:ye(y),headers:{"Content-Type":"text/plain"},body:JSON.stringify([S])};this.pendingRequest=function(C,z){return Fi(je(C,{method:"POST"}),z)}(I,C=>{this.pendingRequest=null,d(C),this.saveEventData(),this.processRequests(m)})}queueRequest(t,l){this.queue.push(t),this.processRequests(l)}}const ne=new class extends at{constructor(s){super("appUserTurnstile"),this._customAccessToken=s}postTurnstileEvent(s,t){P.EVENTS_URL&&P.ACCESS_TOKEN&&Array.isArray(s)&&s.some(l=>Er(l)||un(l))&&this.queueRequest(Date.now(),t)}processRequests(s){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=qe(P.ACCESS_TOKEN),l=t?t.u:P.ACCESS_TOKEN;let d=l!==this.eventData.tokenU;Tt(this.anonId)||(this.anonId=dt(),d=!0);const m=this.queue.shift();if(this.eventData.lastSuccess){const y=new Date(this.eventData.lastSuccess),w=new Date(m),S=(m-this.eventData.lastSuccess)/864e5;d=d||S>=1||S<-1||y.getDate()!==w.getDate()}else d=!0;d?this.postEvent(m,{sdkIdentifier:"mapbox-gl-js",sdkVersion:E,skuId:oe,"enabled.telemetry":!1,userId:this.anonId},y=>{y||(this.eventData.lastSuccess=m,this.eventData.tokenU=l)},s):this.processRequests()}},H=ne.postTurnstileEvent.bind(ne),te=new class extends at{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(s,t,l,d){this.skuToken=t,this.errorCb=d,P.EVENTS_URL&&(l||P.ACCESS_TOKEN?this.queueRequest({id:s,timestamp:Date.now()},l):this.errorCb(new Error(gn)))}processRequests(s){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:l}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),Tt(this.anonId)||(this.anonId=dt()),this.postEvent(l,{sdkIdentifier:"mapbox-gl-js",sdkVersion:E,skuId:oe,skuToken:this.skuToken,userId:this.anonId},d=>{d?this.errorCb(d):t&&(this.success[t]=!0)},s))}},pe=te.postMapLoadEvent.bind(te),we=new class extends at{constructor(){super("gljs.performance")}postPerformanceEvent(s,t){P.EVENTS_URL&&(s||P.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},s)}processRequests(s){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:l}=this.queue.shift(),d=function(m){const y=b.performance.getEntriesByType("resource"),w=b.performance.getEntriesByType("mark"),S=function($){const Z={};if($){for(const Q in $)if(Q!=="other")for(const re of $[Q]){const ue=`${Q}RequestCount`,Se=`${Q}ResolveRangeMin`,Le=`${Q}ResolveRangeMax`;Z[Se]=Math.min(Z[Se]||1/0,re.startTime),Z[Le]=Math.max(Z[Le]||-1/0,re.responseEnd),Z[ue]===void 0&&(Z[ue]=0),++Z[ue]}}return Z}(function($,Z){const Q={};if($)for(const re of $){const ue=Z(re);Q[ue]===void 0&&(Q[ue]=[]),Q[ue].push(re)}return Q}(y,Ut)),I=b.devicePixelRatio,C=b.navigator.connection||b.navigator.mozConnection||b.navigator.webkitConnection,z={counters:[],metadata:[],attributes:[]},N=($,Z,Q)=>{Q!=null&&$.push({name:Z,value:Q.toString()})};for(const $ in S)N(z.counters,$,S[$]);if(m.interactionRange[0]!==1/0&&m.interactionRange[1]!==-1/0&&(N(z.counters,"interactionRangeMin",m.interactionRange[0]),N(z.counters,"interactionRangeMax",m.interactionRange[1])),w)for(const $ of Object.keys(Ze)){const Z=Ze[$],Q=w.find(re=>re.name===Z);Q&&N(z.counters,Z,Q.startTime)}return N(z.attributes,"style",function($){if($)for(const Z of $){const Q=Z.name.split("?")[0];if(ar(Q)){const re=Q.split("/").slice(-2);if(re.length===2)return`mapbox://styles/${re[0]}/${re[1]}`}}}(y)),N(z.attributes,"terrainEnabled",m.terrainEnabled?"true":"false"),N(z.attributes,"fogEnabled",m.fogEnabled?"true":"false"),N(z.attributes,"projection",m.projection.name),N(z.attributes,"zoom",m.zoom),N(z.metadata,"devicePixelRatio",I),N(z.metadata,"connectionEffectiveType",C?C.effectiveType:void 0),N(z.metadata,"navigatorUserAgent",b.navigator.userAgent),N(z.metadata,"screenWidth",b.screen.width),N(z.metadata,"screenHeight",b.screen.height),N(z.metadata,"windowWidth",b.innerWidth),N(z.metadata,"windowHeight",b.innerHeight),N(z.metadata,"mapWidth",m.width/I),N(z.metadata,"mapHeight",m.height/I),N(z.metadata,"webglRenderer",m.renderer),N(z.metadata,"webglVendor",m.vendor),N(z.metadata,"sdkVersion",E),N(z.metadata,"sdkIdentifier","mapbox-gl-js"),z}(l);for(const m of d.metadata);for(const m of d.counters);for(const m of d.attributes);this.postEvent(t,d,()=>{},s)}},ke=we.postPerformanceEvent.bind(we),$e=new class extends at{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(s,t,l,d){if(!P.API_URL||!P.SESSION_PATH)return;const m=kr(P.API_URL+P.SESSION_PATH);m.params.push(`sku=${t||""}`),m.params.push(`access_token=${d||P.ACCESS_TOKEN||""}`);const y={url:ye(m),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(w,S){return Fi(je(w,{method:"GET"}),S)}(y,w=>{this.pendingRequest=null,l(w),this.saveEventData(),this.processRequests(d)})}getSessionAPI(s,t,l,d){this.skuToken=t,this.errorCb=d,P.SESSION_PATH&&P.API_URL&&(l||P.ACCESS_TOKEN?this.queueRequest({id:s,timestamp:Date.now()},l):this.errorCb(new Error(gn)))}processRequests(s){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:l}=this.queue.shift();t&&this.success[t]||this.getSession(l,this.skuToken,d=>{d?this.errorCb(d):t&&(this.success[t]=!0)},s)}},Ge=$e.getSessionAPI.bind($e),De=new Set,Ze={create:"create",load:"load",fullLoad:"fullLoad"},ut={mark(s){b.performance.mark(s)},measure(s,t,l){b.performance.measure(s,t,l)}};function Ut(s){const t=s.name.split("?")[0];return t.includes("mapbox-gl.js")?"javascript":t.includes("mapbox-gl.css")?"css":function(l){return P.API_FONTS_REGEX.test(l)}(t)?"fontRange":Jr(t)?"sprite":ar(t)?"style":function(l){return P.API_TILEJSON_REGEX.test(l)}(t)?"tilejson":"other"}const ft=b.performance;function bi(s){const t=s?s.url.toString():void 0;return ft.getEntriesByName(t)}let wi,gi,Di,Hi;const Re={now:()=>Di!==void 0?Di:b.performance.now(),setNow(s){Di=s},restoreNow(){Di=void 0},frame(s){const t=b.requestAnimationFrame(s);return{cancel:()=>b.cancelAnimationFrame(t)}},getImageData(s,t=0){const{width:l,height:d}=s;Hi||(Hi=b.document.createElement("canvas"));const m=Hi.getContext("2d");if(!m)throw new Error("failed to create canvas 2d context");return(l>Hi.width||d>Hi.height)&&(Hi.width=l,Hi.height=d),m.clearRect(-t,-t,l+2*t,d+2*t),m.drawImage(s,0,0,l,d),m.getImageData(-t,-t,l+2*t,d+2*t)},resolveURL:s=>(wi||(wi=b.document.createElement("a")),wi.href=s,wi.href),get devicePixelRatio(){return b.devicePixelRatio},get prefersReducedMotion(){return!!b.matchMedia&&(gi==null&&(gi=b.matchMedia("(prefers-reduced-motion: reduce)")),gi.matches)}};function vt(s,t,l){l[s]&&l[s].indexOf(t)!==-1||(l[s]=l[s]||[],l[s].push(t))}function Pt(s,t,l){if(l&&l[s]){const d=l[s].indexOf(t);d!==-1&&l[s].splice(d,1)}}class fi{constructor(t,l={}){je(this,l),this.type=t}}class dr extends fi{constructor(t,l={}){super("error",je({error:t},l))}}class sr{on(t,l){return this._listeners=this._listeners||{},vt(t,l,this._listeners),this}off(t,l){return Pt(t,l,this._listeners),Pt(t,l,this._oneTimeListeners),this}once(t,l){return l?(this._oneTimeListeners=this._oneTimeListeners||{},vt(t,l,this._oneTimeListeners),this):new Promise(d=>this.once(t,d))}fire(t,l){typeof t=="string"&&(t=new fi(t,l||{}));const d=t.type;if(this.listens(d)){t.target=this;const m=this._listeners&&this._listeners[d]?this._listeners[d].slice():[];for(const S of m)S.call(this,t);const y=this._oneTimeListeners&&this._oneTimeListeners[d]?this._oneTimeListeners[d].slice():[];for(const S of y)Pt(d,S,this._oneTimeListeners),S.call(this,t);const w=this._eventedParent;w&&(je(t,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),w.fire(t))}else t instanceof dr&&console.error(t.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,l){return this._eventedParent=t,this._eventedParentData=l,this}}var it=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{},"globe":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["source"]}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["fill-extrusion-edge-radius"]}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"transition":false,"requires":[{"source":"geojson","has":{"lineMetrics":true}}],"property-type":"constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function Or(s,...t){for(const l of t)for(const d in l)s[d]=l[d];return s}function Fr(s){return s instanceof Number||s instanceof String||s instanceof Boolean?s.valueOf():s}function Vr(s){if(Array.isArray(s))return s.map(Vr);if(s instanceof Object&&!(s instanceof Number||s instanceof String||s instanceof Boolean)){const t={};for(const l in s)t[l]=Vr(s[l]);return t}return Fr(s)}class xs extends Error{constructor(t,l){super(l),this.message=l,this.key=t}}var Qn=xs;class Cn{constructor(t,l=[]){this.parent=t,this.bindings={};for(const[d,m]of l)this.bindings[d]=m}concat(t){return new Cn(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var Hn=Cn;const So={kind:"null"},Qt={kind:"number"},Wi={kind:"string"},ir={kind:"boolean"},Jn={kind:"color"},ia={kind:"object"},nr={kind:"value"},ra={kind:"collator"},na={kind:"formatted"},oa={kind:"resolvedImage"};function kn(s,t){return{kind:"array",itemType:s,N:t}}function Pr(s){if(s.kind==="array"){const t=Pr(s.itemType);return typeof s.N=="number"?`array<${t}, ${s.N}>`:s.itemType.kind==="value"?"array":`array<${t}>`}return s.kind}const Qs=[So,Qt,Wi,ir,Jn,na,ia,kn(nr),oa];function B(s,t){if(t.kind==="error")return null;if(s.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!B(s.itemType,t.itemType))&&(typeof s.N!="number"||s.N===t.N))return null}else{if(s.kind===t.kind)return null;if(s.kind==="value"){for(const l of Qs)if(!B(l,t))return null}}return`Expected ${Pr(s)} but found ${Pr(t)} instead.`}function j(s,t){return t.some(l=>l.kind===s.kind)}function ae(s,t){return t.some(l=>l==="null"?s===null:l==="array"?Array.isArray(s):l==="object"?s&&!Array.isArray(s)&&typeof s=="object":l===typeof s)}var Ue,nt={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Ye(s){return(s=Math.round(s))<0?0:s>255?255:s}function et(s){return Ye(s[s.length-1]==="%"?parseFloat(s)/100*255:parseInt(s))}function jt(s){return(t=s[s.length-1]==="%"?parseFloat(s)/100:parseFloat(s))<0?0:t>1?1:t;var t}function Ot(s,t,l){return l<0?l+=1:l>1&&(l-=1),6*l<1?s+(t-s)*l*6:2*l<1?t:3*l<2?s+(t-s)*(2/3-l)*6:s}try{Ue={}.parseCSSColor=function(s){var t,l=s.replace(/ /g,"").toLowerCase();if(l in nt)return nt[l].slice();if(l[0]==="#")return l.length===4?(t=parseInt(l.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:l.length===7&&(t=parseInt(l.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var d=l.indexOf("("),m=l.indexOf(")");if(d!==-1&&m+1===l.length){var y=l.substr(0,d),w=l.substr(d+1,m-(d+1)).split(","),S=1;switch(y){case"rgba":if(w.length!==4)return null;S=jt(w.pop());case"rgb":return w.length!==3?null:[et(w[0]),et(w[1]),et(w[2]),S];case"hsla":if(w.length!==4)return null;S=jt(w.pop());case"hsl":if(w.length!==3)return null;var I=(parseFloat(w[0])%360+360)%360/360,C=jt(w[1]),z=jt(w[2]),N=z<=.5?z*(C+1):z+C-z*C,$=2*z-N;return[Ye(255*Ot($,N,I+1/3)),Ye(255*Ot($,N,I)),Ye(255*Ot($,N,I-1/3)),S];default:return null}}return null}}catch{}class ei{constructor(t,l,d,m=1){this.r=t,this.g=l,this.b=d,this.a=m}static parse(t){if(!t)return;if(t instanceof ei)return t;if(typeof t!="string")return;const l=Ue(t);return l?new ei(l[0]/255*l[3],l[1]/255*l[3],l[2]/255*l[3],l[3]):void 0}toString(){const[t,l,d,m]=this.toArray();return`rgba(${Math.round(t)},${Math.round(l)},${Math.round(d)},${m})`}toArray(){const{r:t,g:l,b:d,a:m}=this;return m===0?[0,0,0,0]:[255*t/m,255*l/m,255*d/m,m]}toArray01(){const{r:t,g:l,b:d,a:m}=this;return m===0?[0,0,0,0]:[t/m,l/m,d/m,m]}toArray01PremultipliedAlpha(){const{r:t,g:l,b:d,a:m}=this;return[t,l,d,m]}}ei.black=new ei(0,0,0,1),ei.white=new ei(1,1,1,1),ei.transparent=new ei(0,0,0,0),ei.red=new ei(1,0,0,1),ei.blue=new ei(0,0,1,1);var Ke=ei;class ci{constructor(t,l,d){this.sensitivity=t?l?"variant":"case":l?"accent":"base",this.locale=d,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,l){return this.collator.compare(t,l)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Ei{constructor(t,l,d,m,y){this.text=t.normalize?t.normalize():t,this.image=l,this.scale=d,this.fontStack=m,this.textColor=y}}class Mi{constructor(t){this.sections=t}static fromString(t){return new Mi([new Ei(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.name.length!==0)}static factory(t){return t instanceof Mi?t:Mi.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const l of this.sections){if(l.image){t.push(["image",l.image.name]);continue}t.push(l.text);const d={};l.fontStack&&(d["text-font"]=["literal",l.fontStack.split(",")]),l.scale&&(d["font-scale"]=l.scale),l.textColor&&(d["text-color"]=["rgba"].concat(l.textColor.toArray())),t.push(d)}return t}}class Oi{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new Oi({name:t,available:!1}):null}serialize(){return["image",this.name]}}function Yr(s,t,l,d){return typeof s=="number"&&s>=0&&s<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof l=="number"&&l>=0&&l<=255?d===void 0||typeof d=="number"&&d>=0&&d<=1?null:`Invalid rgba value [${[s,t,l,d].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof d=="number"?[s,t,l,d]:[s,t,l]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function St(s){if(s===null||typeof s=="string"||typeof s=="boolean"||typeof s=="number"||s instanceof Ke||s instanceof ci||s instanceof Mi||s instanceof Oi)return!0;if(Array.isArray(s)){for(const t of s)if(!St(t))return!1;return!0}if(typeof s=="object"){for(const t in s)if(!St(s[t]))return!1;return!0}return!1}function ni(s){if(s===null)return So;if(typeof s=="string")return Wi;if(typeof s=="boolean")return ir;if(typeof s=="number")return Qt;if(s instanceof Ke)return Jn;if(s instanceof ci)return ra;if(s instanceof Mi)return na;if(s instanceof Oi)return oa;if(Array.isArray(s)){const t=s.length;let l;for(const d of s){const m=ni(d);if(l){if(l===m)continue;l=nr;break}l=m}return kn(l||nr,t)}return ia}function gr(s){const t=typeof s;return s===null?"":t==="string"||t==="number"||t==="boolean"?String(s):s instanceof Ke||s instanceof Mi||s instanceof Oi?s.toString():JSON.stringify(s)}class yr{constructor(t,l){this.type=t,this.value=l}static parse(t,l){if(t.length!==2)return l.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!St(t[1]))return l.error("invalid value");const d=t[1];let m=ni(d);const y=l.expectedType;return m.kind!=="array"||m.N!==0||!y||y.kind!=="array"||typeof y.N=="number"&&y.N!==0||(m=y),new yr(m,d)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ke?["rgba"].concat(this.value.toArray()):this.value instanceof Mi?this.value.serialize():this.value}}var Dr=yr,Ti=class{constructor(s){this.name="ExpressionEvaluationError",this.message=s}toJSON(){return this.message}};const ho={string:Wi,number:Qt,boolean:ir,object:ia};class eo{constructor(t,l){this.type=t,this.args=l}static parse(t,l){if(t.length<2)return l.error("Expected at least one argument.");let d,m=1;const y=t[0];if(y==="array"){let S,I;if(t.length>2){const C=t[1];if(typeof C!="string"||!(C in ho)||C==="object")return l.error('The item type argument of "array" must be one of string, number, boolean',1);S=ho[C],m++}else S=nr;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return l.error('The length argument to "array" must be a positive integer literal',2);I=t[2],m++}d=kn(S,I)}else d=ho[y];const w=[];for(;m<t.length;m++){const S=l.parse(t[m],m,nr);if(!S)return null;w.push(S)}return new eo(d,w)}evaluate(t){for(let l=0;l<this.args.length;l++){const d=this.args[l].evaluate(t);if(!B(this.type,ni(d)))return d;if(l===this.args.length-1)throw new Ti(`Expected value to be of type ${Pr(this.type)}, but found ${Pr(ni(d))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,l=[t.kind];if(t.kind==="array"){const d=t.itemType;if(d.kind==="string"||d.kind==="number"||d.kind==="boolean"){l.push(d.kind);const m=t.N;(typeof m=="number"||this.args.length>1)&&l.push(m)}}return l.concat(this.args.map(d=>d.serialize()))}}var or=eo;class an{constructor(t){this.type=na,this.sections=t}static parse(t,l){if(t.length<2)return l.error("Expected at least one argument.");const d=t[1];if(!Array.isArray(d)&&typeof d=="object")return l.error("First argument must be an image or text section.");const m=[];let y=!1;for(let w=1;w<=t.length-1;++w){const S=t[w];if(y&&typeof S=="object"&&!Array.isArray(S)){y=!1;let I=null;if(S["font-scale"]&&(I=l.parse(S["font-scale"],1,Qt),!I))return null;let C=null;if(S["text-font"]&&(C=l.parse(S["text-font"],1,kn(Wi)),!C))return null;let z=null;if(S["text-color"]&&(z=l.parse(S["text-color"],1,Jn),!z))return null;const N=m[m.length-1];N.scale=I,N.font=C,N.textColor=z}else{const I=l.parse(t[w],1,nr);if(!I)return null;const C=I.type.kind;if(C!=="string"&&C!=="value"&&C!=="null"&&C!=="resolvedImage")return l.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");y=!0,m.push({content:I,scale:null,font:null,textColor:null})}}return new an(m)}evaluate(t){return new Mi(this.sections.map(l=>{const d=l.content.evaluate(t);return ni(d)===oa?new Ei("",d,null,null,null):new Ei(gr(d),null,l.scale?l.scale.evaluate(t):null,l.font?l.font.evaluate(t).join(","):null,l.textColor?l.textColor.evaluate(t):null)}))}eachChild(t){for(const l of this.sections)t(l.content),l.scale&&t(l.scale),l.font&&t(l.font),l.textColor&&t(l.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const l of this.sections){t.push(l.content.serialize());const d={};l.scale&&(d["font-scale"]=l.scale.serialize()),l.font&&(d["text-font"]=l.font.serialize()),l.textColor&&(d["text-color"]=l.textColor.serialize()),t.push(d)}return t}}class hn{constructor(t){this.type=oa,this.input=t}static parse(t,l){if(t.length!==2)return l.error("Expected two arguments.");const d=l.parse(t[1],1,Wi);return d?new hn(d):l.error("No image name provided.")}evaluate(t){const l=this.input.evaluate(t),d=Oi.fromString(l);return d&&t.availableImages&&(d.available=t.availableImages.indexOf(l)>-1),d}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const vs={"to-boolean":ir,"to-color":Jn,"to-number":Qt,"to-string":Wi};class Ha{constructor(t,l){this.type=t,this.args=l}static parse(t,l){if(t.length<2)return l.error("Expected at least one argument.");const d=t[0];if((d==="to-boolean"||d==="to-string")&&t.length!==2)return l.error("Expected one argument.");const m=vs[d],y=[];for(let w=1;w<t.length;w++){const S=l.parse(t[w],w,nr);if(!S)return null;y.push(S)}return new Ha(m,y)}evaluate(t){if(this.type.kind==="boolean")return Boolean(this.args[0].evaluate(t));if(this.type.kind==="color"){let l,d;for(const m of this.args){if(l=m.evaluate(t),d=null,l instanceof Ke)return l;if(typeof l=="string"){const y=t.parseColor(l);if(y)return y}else if(Array.isArray(l)&&(d=l.length<3||l.length>4?`Invalid rbga value ${JSON.stringify(l)}: expected an array containing either three or four numeric values.`:Yr(l[0],l[1],l[2],l[3]),!d))return new Ke(l[0]/255,l[1]/255,l[2]/255,l[3])}throw new Ti(d||`Could not parse color from value '${typeof l=="string"?l:String(JSON.stringify(l))}'`)}if(this.type.kind==="number"){let l=null;for(const d of this.args){if(l=d.evaluate(t),l===null)return 0;const m=Number(l);if(!isNaN(m))return m}throw new Ti(`Could not convert ${JSON.stringify(l)} to number.`)}return this.type.kind==="formatted"?Mi.fromString(gr(this.args[0].evaluate(t))):this.type.kind==="resolvedImage"?Oi.fromString(gr(this.args[0].evaluate(t))):gr(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if(this.type.kind==="formatted")return new an([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new hn(this.args[0]).serialize();const t=[`to-${this.type.kind}`];return this.eachChild(l=>{t.push(l.serialize())}),t}}var yn=Ha;const Js=["Unknown","Point","LineString","Polygon"];var bs=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Js[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const s=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:l,y:d}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(l*t-s[0])+this.featureDistanceData.bearing[1]*(d*t-s[1])}return 0}parseColor(s){let t=this._parseColorCache[s];return t||(t=this._parseColorCache[s]=Ke.parse(s)),t}};class zo{constructor(t,l,d,m){this.name=t,this.type=l,this._evaluate=d,this.args=m}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,l){const d=t[0],m=zo.definitions[d];if(!m)return l.error(`Unknown expression "${d}". If you wanted a literal array, use ["literal", [...]].`,0);const y=Array.isArray(m)?m[0]:m.type,w=Array.isArray(m)?[[m[1],m[2]]]:m.overloads,S=w.filter(([C])=>!Array.isArray(C)||C.length===t.length-1);let I=null;for(const[C,z]of S){I=new ro(l.registry,l.path,null,l.scope);const N=[];let $=!1;for(let Z=1;Z<t.length;Z++){const Q=t[Z],re=Array.isArray(C)?C[Z-1]:C.type,ue=I.parse(Q,1+N.length,re);if(!ue){$=!0;break}N.push(ue)}if(!$)if(Array.isArray(C)&&C.length!==N.length)I.error(`Expected ${C.length} arguments, but found ${N.length} instead.`);else{for(let Z=0;Z<N.length;Z++){const Q=Array.isArray(C)?C[Z]:C.type,re=N[Z];I.concat(Z+1).checkSubtype(Q,re.type)}if(I.errors.length===0)return new zo(d,y,z,N)}}if(S.length===1)l.errors.push(...I.errors);else{const C=(S.length?S:w).map(([N])=>{return $=N,Array.isArray($)?`(${$.map(Pr).join(", ")})`:`(${Pr($.type)}...)`;var $}).join(" | "),z=[];for(let N=1;N<t.length;N++){const $=l.parse(t[N],1+z.length);if(!$)return null;z.push(Pr($.type))}l.error(`Expected arguments of type ${C}, but found (${z.join(", ")}) instead.`)}return null}static register(t,l){zo.definitions=l;for(const d in l)t[d]=zo}}var On=zo;class Oo{constructor(t,l,d){this.type=ra,this.locale=d,this.caseSensitive=t,this.diacriticSensitive=l}static parse(t,l){if(t.length!==2)return l.error("Expected one argument.");const d=t[1];if(typeof d!="object"||Array.isArray(d))return l.error("Collator options argument must be an object.");const m=l.parse(d["case-sensitive"]!==void 0&&d["case-sensitive"],1,ir);if(!m)return null;const y=l.parse(d["diacritic-sensitive"]!==void 0&&d["diacritic-sensitive"],1,ir);if(!y)return null;let w=null;return d.locale&&(w=l.parse(d.locale,1,Wi),!w)?null:new Oo(m,y,w)}evaluate(t){return new ci(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}const fo=8192;function Wa(s,t){s[0]=Math.min(s[0],t[0]),s[1]=Math.min(s[1],t[1]),s[2]=Math.max(s[2],t[0]),s[3]=Math.max(s[3],t[1])}function Ya(s,t){return!(s[0]<=t[0]||s[2]>=t[2]||s[1]<=t[1]||s[3]>=t[3])}function _n(s,t){const l=(180+s[0])/360,d=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+s[1]*Math.PI/360)))/360,m=Math.pow(2,t.z);return[Math.round(l*m*fo),Math.round(d*m*fo)]}function ws(s,t,l){const d=s[0]-t[0],m=s[1]-t[1],y=s[0]-l[0],w=s[1]-l[1];return d*w-y*m==0&&d*y<=0&&m*w<=0}function Ka(s,t){let l=!1;for(let w=0,S=t.length;w<S;w++){const I=t[w];for(let C=0,z=I.length;C<z-1;C++){if(ws(s,I[C],I[C+1]))return!1;(m=I[C])[1]>(d=s)[1]!=(y=I[C+1])[1]>d[1]&&d[0]<(y[0]-m[0])*(d[1]-m[1])/(y[1]-m[1])+m[0]&&(l=!l)}}var d,m,y;return l}function el(s,t){for(let l=0;l<t.length;l++)if(Ka(s,t[l]))return!0;return!1}function Ca(s,t,l,d){const m=d[0]-l[0],y=d[1]-l[1],w=(s[0]-l[0])*y-m*(s[1]-l[1]),S=(t[0]-l[0])*y-m*(t[1]-l[1]);return w>0&&S<0||w<0&&S>0}function aa(s,t,l){for(const C of l)for(let z=0;z<C.length-1;++z)if((S=[(w=C[z+1])[0]-(y=C[z])[0],w[1]-y[1]])[0]*(I=[(m=t)[0]-(d=s)[0],m[1]-d[1]])[1]-S[1]*I[0]!=0&&Ca(d,m,y,w)&&Ca(y,w,d,m))return!0;var d,m,y,w,S,I;return!1}function ka(s,t){for(let l=0;l<s.length;++l)if(!Ka(s[l],t))return!1;for(let l=0;l<s.length-1;++l)if(aa(s[l],s[l+1],t))return!1;return!0}function Pa(s,t){for(let l=0;l<t.length;l++)if(ka(s,t[l]))return!0;return!1}function po(s,t,l){const d=[];for(let m=0;m<s.length;m++){const y=[];for(let w=0;w<s[m].length;w++){const S=_n(s[m][w],l);Wa(t,S),y.push(S)}d.push(y)}return d}function Fo(s,t,l){const d=[];for(let m=0;m<s.length;m++){const y=po(s[m],t,l);d.push(y)}return d}function Es(s,t,l,d){if(s[0]<l[0]||s[0]>l[2]){const m=.5*d;let y=s[0]-l[0]>m?-d:l[0]-s[0]>m?d:0;y===0&&(y=s[0]-l[2]>m?-d:l[2]-s[0]>m?d:0),s[0]+=y}Wa(t,s)}function Qa(s,t,l,d){const m=Math.pow(2,d.z)*fo,y=[d.x*fo,d.y*fo],w=[];if(!s)return w;for(const S of s)for(const I of S){const C=[I.x+y[0],I.y+y[1]];Es(C,t,l,m),w.push(C)}return w}function Ts(s,t,l,d){const m=Math.pow(2,d.z)*fo,y=[d.x*fo,d.y*fo],w=[];if(!s)return w;for(const I of s){const C=[];for(const z of I){const N=[z.x+y[0],z.y+y[1]];Wa(t,N),C.push(N)}w.push(C)}if(t[2]-t[0]<=m/2){(S=t)[0]=S[1]=1/0,S[2]=S[3]=-1/0;for(const I of w)for(const C of I)Es(C,t,l,m)}var S;return w}class to{constructor(t,l){this.type=ir,this.geojson=t,this.geometries=l}static parse(t,l){if(t.length!==2)return l.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(St(t[1])){const d=t[1];if(d.type==="FeatureCollection")for(let m=0;m<d.features.length;++m){const y=d.features[m].geometry.type;if(y==="Polygon"||y==="MultiPolygon")return new to(d,d.features[m].geometry)}else if(d.type==="Feature"){const m=d.geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new to(d,d.geometry)}else if(d.type==="Polygon"||d.type==="MultiPolygon")return new to(d,d)}return l.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(l,d){const m=[1/0,1/0,-1/0,-1/0],y=[1/0,1/0,-1/0,-1/0],w=l.canonicalID();if(!w)return!1;if(d.type==="Polygon"){const S=po(d.coordinates,y,w),I=Qa(l.geometry(),m,y,w);if(!Ya(m,y))return!1;for(const C of I)if(!Ka(C,S))return!1}if(d.type==="MultiPolygon"){const S=Fo(d.coordinates,y,w),I=Qa(l.geometry(),m,y,w);if(!Ya(m,y))return!1;for(const C of I)if(!el(C,S))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(l,d){const m=[1/0,1/0,-1/0,-1/0],y=[1/0,1/0,-1/0,-1/0],w=l.canonicalID();if(!w)return!1;if(d.type==="Polygon"){const S=po(d.coordinates,y,w),I=Ts(l.geometry(),m,y,w);if(!Ya(m,y))return!1;for(const C of I)if(!ka(C,S))return!1}if(d.type==="MultiPolygon"){const S=Fo(d.coordinates,y,w),I=Ts(l.geometry(),m,y,w);if(!Ya(m,y))return!1;for(const C of I)if(!Pa(C,S))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var fr=to;function sa(s){if(s instanceof On&&(s.name==="get"&&s.args.length===1||s.name==="feature-state"||s.name==="has"&&s.args.length===1||s.name==="properties"||s.name==="geometry-type"||s.name==="id"||/^filter-/.test(s.name))||s instanceof fr)return!1;let t=!0;return s.eachChild(l=>{t&&!sa(l)&&(t=!1)}),t}function la(s){if(s instanceof On&&s.name==="feature-state")return!1;let t=!0;return s.eachChild(l=>{t&&!la(l)&&(t=!1)}),t}function io(s,t){if(s instanceof On&&t.indexOf(s.name)>=0)return!1;let l=!0;return s.eachChild(d=>{l&&!io(d,t)&&(l=!1)}),l}class Fn{constructor(t,l){this.type=l.type,this.name=t,this.boundExpression=l}static parse(t,l){if(t.length!==2||typeof t[1]!="string")return l.error("'var' expression requires exactly one string literal argument.");const d=t[1];return l.scope.has(d)?new Fn(d,l.scope.get(d)):l.error(`Unknown variable "${d}". Make sure "${d}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var Mo=Fn;class No{constructor(t,l=[],d,m=new Hn,y=[]){this.registry=t,this.path=l,this.key=l.map(w=>`[${w}]`).join(""),this.scope=m,this.errors=y,this.expectedType=d}parse(t,l,d,m,y={}){return l?this.concat(l,d,m)._parse(t,y):this._parse(t,y)}_parse(t,l){function d(m,y,w){return w==="assert"?new or(y,[m]):w==="coerce"?new yn(y,[m]):m}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const m=t[0];if(typeof m!="string")return this.error(`Expression name must be a string, but found ${typeof m} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const y=this.registry[m];if(y){let w=y.parse(t,this);if(!w)return null;if(this.expectedType){const S=this.expectedType,I=w.type;if(S.kind!=="string"&&S.kind!=="number"&&S.kind!=="boolean"&&S.kind!=="object"&&S.kind!=="array"||I.kind!=="value")if(S.kind!=="color"&&S.kind!=="formatted"&&S.kind!=="resolvedImage"||I.kind!=="value"&&I.kind!=="string"){if(this.checkSubtype(S,I))return null}else w=d(w,S,l.typeAnnotation||"coerce");else w=d(w,S,l.typeAnnotation||"assert")}if(!(w instanceof Dr)&&w.type.kind!=="resolvedImage"&&Ja(w)){const S=new bs;try{w=new Dr(w.type,w.evaluate(S))}catch(I){return this.error(I.message),null}}return w}return this.error(`Unknown expression "${m}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,l,d){const m=typeof t=="number"?this.path.concat(t):this.path,y=d?this.scope.concat(d):this.scope;return new No(this.registry,m,l||null,y,this.errors)}error(t,...l){const d=`${this.key}${l.map(m=>`[${m}]`).join("")}`;this.errors.push(new Qn(d,t))}checkSubtype(t,l){const d=B(t,l);return d&&this.error(d),d}}var ro=No;function Ja(s){if(s instanceof Mo)return Ja(s.boundExpression);if(s instanceof On&&s.name==="error"||s instanceof Oo||s instanceof fr)return!1;const t=s instanceof yn||s instanceof or;let l=!0;return s.eachChild(d=>{l=t?l&&Ja(d):l&&d instanceof Dr}),!!l&&sa(s)&&io(s,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function Ao(s,t){const l=s.length-1;let d,m,y=0,w=l,S=0;for(;y<=w;)if(S=Math.floor((y+w)/2),d=s[S],m=s[S+1],d<=t){if(S===l||t<m)return S;y=S+1}else{if(!(d>t))throw new Ti("Input is not a number.");w=S-1}return 0}class Nn{constructor(t,l,d){this.type=t,this.input=l,this.labels=[],this.outputs=[];for(const[m,y]of d)this.labels.push(m),this.outputs.push(y)}static parse(t,l){if(t.length-1<4)return l.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return l.error("Expected an even number of arguments.");const d=l.parse(t[1],1,Qt);if(!d)return null;const m=[];let y=null;l.expectedType&&l.expectedType.kind!=="value"&&(y=l.expectedType);for(let w=1;w<t.length;w+=2){const S=w===1?-1/0:t[w],I=t[w+1],C=w,z=w+1;if(typeof S!="number")return l.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',C);if(m.length&&m[m.length-1][0]>=S)return l.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',C);const N=l.parse(I,z,y);if(!N)return null;y=y||N.type,m.push([S,N])}return new Nn(y,d,m)}evaluate(t){const l=this.labels,d=this.outputs;if(l.length===1)return d[0].evaluate(t);const m=this.input.evaluate(t);if(m<=l[0])return d[0].evaluate(t);const y=l.length;return m>=l[y-1]?d[y-1].evaluate(t):d[Ao(l,m)].evaluate(t)}eachChild(t){t(this.input);for(const l of this.outputs)t(l)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let l=0;l<this.labels.length;l++)l>0&&t.push(this.labels[l]),t.push(this.outputs[l].serialize());return t}}var Uo=Nn;function ur(s,t,l){return s*(1-l)+t*l}var ca=Object.freeze({__proto__:null,number:ur,color:function(s,t,l){return new Ke(ur(s.r,t.r,l),ur(s.g,t.g,l),ur(s.b,t.b,l),ur(s.a,t.a,l))},array:function(s,t,l){return s.map((d,m)=>ur(d,t[m],l))}});const Ss=.95047,Ms=1.08883,As=4/29,$o=6/29,Vo=3*$o*$o,tl=Math.PI/180,mo=180/Math.PI;function Is(s){return s>.008856451679035631?Math.pow(s,1/3):s/Vo+As}function no(s){return s>$o?s*s*s:Vo*(s-As)}function es(s){return 255*(s<=.0031308?12.92*s:1.055*Math.pow(s,1/2.4)-.055)}function ts(s){return(s/=255)<=.04045?s/12.92:Math.pow((s+.055)/1.055,2.4)}function ua(s){const t=ts(s.r),l=ts(s.g),d=ts(s.b),m=Is((.4124564*t+.3575761*l+.1804375*d)/Ss),y=Is((.2126729*t+.7151522*l+.072175*d)/1);return{l:116*y-16,a:500*(m-y),b:200*(y-Is((.0193339*t+.119192*l+.9503041*d)/Ms)),alpha:s.a}}function is(s){let t=(s.l+16)/116,l=isNaN(s.a)?t:t+s.a/500,d=isNaN(s.b)?t:t-s.b/200;return t=1*no(t),l=Ss*no(l),d=Ms*no(d),new Ke(es(3.2404542*l-1.5371385*t-.4985314*d),es(-.969266*l+1.8760108*t+.041556*d),es(.0556434*l-.2040259*t+1.0572252*d),s.alpha)}function il(s,t,l){const d=t-s;return s+l*(d>180||d<-180?d-360*Math.round(d/360):d)}const ha={forward:ua,reverse:is,interpolate:function(s,t,l){return{l:ur(s.l,t.l,l),a:ur(s.a,t.a,l),b:ur(s.b,t.b,l),alpha:ur(s.alpha,t.alpha,l)}}},da={forward:function(s){const{l:t,a:l,b:d}=ua(s),m=Math.atan2(d,l)*mo;return{h:m<0?m+360:m,c:Math.sqrt(l*l+d*d),l:t,alpha:s.a}},reverse:function(s){const t=s.h*tl,l=s.c;return is({l:s.l,a:Math.cos(t)*l,b:Math.sin(t)*l,alpha:s.alpha})},interpolate:function(s,t,l){return{h:il(s.h,t.h,l),c:ur(s.c,t.c,l),l:ur(s.l,t.l,l),alpha:ur(s.alpha,t.alpha,l)}}};var fa=Object.freeze({__proto__:null,lab:ha,hcl:da});class Da{constructor(t,l,d,m,y){this.type=t,this.operator=l,this.interpolation=d,this.input=m,this.labels=[],this.outputs=[];for(const[w,S]of y)this.labels.push(w),this.outputs.push(S)}static interpolationFactor(t,l,d,m){let y=0;if(t.name==="exponential")y=rs(l,t.base,d,m);else if(t.name==="linear")y=rs(l,1,d,m);else if(t.name==="cubic-bezier"){const w=t.controlPoints;y=new W(w[0],w[1],w[2],w[3]).solve(rs(l,1,d,m))}return y}static parse(t,l){let[d,m,y,...w]=t;if(!Array.isArray(m)||m.length===0)return l.error("Expected an interpolation type expression.",1);if(m[0]==="linear")m={name:"linear"};else if(m[0]==="exponential"){const C=m[1];if(typeof C!="number")return l.error("Exponential interpolation requires a numeric base.",1,1);m={name:"exponential",base:C}}else{if(m[0]!=="cubic-bezier")return l.error(`Unknown interpolation type ${String(m[0])}`,1,0);{const C=m.slice(1);if(C.length!==4||C.some(z=>typeof z!="number"||z<0||z>1))return l.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);m={name:"cubic-bezier",controlPoints:C}}}if(t.length-1<4)return l.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return l.error("Expected an even number of arguments.");if(y=l.parse(y,2,Qt),!y)return null;const S=[];let I=null;d==="interpolate-hcl"||d==="interpolate-lab"?I=Jn:l.expectedType&&l.expectedType.kind!=="value"&&(I=l.expectedType);for(let C=0;C<w.length;C+=2){const z=w[C],N=w[C+1],$=C+3,Z=C+4;if(typeof z!="number")return l.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',$);if(S.length&&S[S.length-1][0]>=z)return l.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',$);const Q=l.parse(N,Z,I);if(!Q)return null;I=I||Q.type,S.push([z,Q])}return I.kind==="number"||I.kind==="color"||I.kind==="array"&&I.itemType.kind==="number"&&typeof I.N=="number"?new Da(I,d,m,y,S):l.error(`Type ${Pr(I)} is not interpolatable.`)}evaluate(t){const l=this.labels,d=this.outputs;if(l.length===1)return d[0].evaluate(t);const m=this.input.evaluate(t);if(m<=l[0])return d[0].evaluate(t);const y=l.length;if(m>=l[y-1])return d[y-1].evaluate(t);const w=Ao(l,m),S=Da.interpolationFactor(this.interpolation,m,l[w],l[w+1]),I=d[w].evaluate(t),C=d[w+1].evaluate(t);return this.operator==="interpolate"?ca[this.type.kind.toLowerCase()](I,C,S):this.operator==="interpolate-hcl"?da.reverse(da.interpolate(da.forward(I),da.forward(C),S)):ha.reverse(ha.interpolate(ha.forward(I),ha.forward(C),S))}eachChild(t){t(this.input);for(const l of this.outputs)t(l)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const l=[this.operator,t,this.input.serialize()];for(let d=0;d<this.labels.length;d++)l.push(this.labels[d],this.outputs[d].serialize());return l}}function rs(s,t,l,d){const m=d-l,y=s-l;return m===0?0:t===1?y/m:(Math.pow(t,y)-1)/(Math.pow(t,m)-1)}var Xe=Da;class pt{constructor(t,l){this.type=t,this.args=l}static parse(t,l){if(t.length<2)return l.error("Expectected at least one argument.");let d=null;const m=l.expectedType;m&&m.kind!=="value"&&(d=m);const y=[];for(const S of t.slice(1)){const I=l.parse(S,1+y.length,d,void 0,{typeAnnotation:"omit"});if(!I)return null;d=d||I.type,y.push(I)}const w=m&&y.some(S=>B(m,S.type));return new pt(w?nr:d,y)}evaluate(t){let l,d=null,m=0;for(const y of this.args){if(m++,d=y.evaluate(t),d&&d instanceof Oi&&!d.available&&(l||(l=d),d=null,m===this.args.length))return l;if(d!==null)break}return d}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(l=>{t.push(l.serialize())}),t}}var ui=pt;class Ui{constructor(t,l){this.type=l.type,this.bindings=[].concat(t),this.result=l}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const l of this.bindings)t(l[1]);t(this.result)}static parse(t,l){if(t.length<4)return l.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const d=[];for(let y=1;y<t.length-1;y+=2){const w=t[y];if(typeof w!="string")return l.error(`Expected string, but found ${typeof w} instead.`,y);if(/[^a-zA-Z0-9_]/.test(w))return l.error("Variable names must contain only alphanumeric characters or '_'.",y);const S=l.parse(t[y+1],y+1);if(!S)return null;d.push([w,S])}const m=l.parse(t[t.length-1],t.length-1,l.expectedType,d);return m?new Ui(d,m):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[l,d]of this.bindings)t.push(l,d.serialize());return t.push(this.result.serialize()),t}}var Br=Ui;class cr{constructor(t,l,d){this.type=t,this.index=l,this.input=d}static parse(t,l){if(t.length!==3)return l.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const d=l.parse(t[1],1,Qt),m=l.parse(t[2],2,kn(l.expectedType||nr));return d&&m?new cr(m.type.itemType,d,m):null}evaluate(t){const l=this.index.evaluate(t),d=this.input.evaluate(t);if(l<0)throw new Ti(`Array index out of bounds: ${l} < 0.`);if(l>=d.length)throw new Ti(`Array index out of bounds: ${l} > ${d.length-1}.`);if(l!==Math.floor(l))throw new Ti(`Array index must be an integer, but found ${l} instead.`);return d[l]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var Zr=cr;class Kr{constructor(t,l){this.type=ir,this.needle=t,this.haystack=l}static parse(t,l){if(t.length!==3)return l.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const d=l.parse(t[1],1,nr),m=l.parse(t[2],2,nr);return d&&m?j(d.type,[ir,Wi,Qt,So,nr])?new Kr(d,m):l.error(`Expected first argument to be of type boolean, string, number or null, but found ${Pr(d.type)} instead`):null}evaluate(t){const l=this.needle.evaluate(t),d=this.haystack.evaluate(t);if(d==null)return!1;if(!ae(l,["boolean","string","number","null"]))throw new Ti(`Expected first argument to be of type boolean, string, number or null, but found ${Pr(ni(l))} instead.`);if(!ae(d,["string","array"]))throw new Ti(`Expected second argument to be of type array or string, but found ${Pr(ni(d))} instead.`);return d.indexOf(l)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var Wn=Kr;class Xr{constructor(t,l,d){this.type=Qt,this.needle=t,this.haystack=l,this.fromIndex=d}static parse(t,l){if(t.length<=2||t.length>=5)return l.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const d=l.parse(t[1],1,nr),m=l.parse(t[2],2,nr);if(!d||!m)return null;if(!j(d.type,[ir,Wi,Qt,So,nr]))return l.error(`Expected first argument to be of type boolean, string, number or null, but found ${Pr(d.type)} instead`);if(t.length===4){const y=l.parse(t[3],3,Qt);return y?new Xr(d,m,y):null}return new Xr(d,m)}evaluate(t){const l=this.needle.evaluate(t),d=this.haystack.evaluate(t);if(!ae(l,["boolean","string","number","null"]))throw new Ti(`Expected first argument to be of type boolean, string, number or null, but found ${Pr(ni(l))} instead.`);if(!ae(d,["string","array"]))throw new Ti(`Expected second argument to be of type array or string, but found ${Pr(ni(d))} instead.`);if(this.fromIndex){const m=this.fromIndex.evaluate(t);return d.indexOf(l,m)}return d.indexOf(l)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var en=Xr;class Pn{constructor(t,l,d,m,y,w){this.inputType=t,this.type=l,this.input=d,this.cases=m,this.outputs=y,this.otherwise=w}static parse(t,l){if(t.length<5)return l.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return l.error("Expected an even number of arguments.");let d,m;l.expectedType&&l.expectedType.kind!=="value"&&(m=l.expectedType);const y={},w=[];for(let C=2;C<t.length-1;C+=2){let z=t[C];const N=t[C+1];Array.isArray(z)||(z=[z]);const $=l.concat(C);if(z.length===0)return $.error("Expected at least one branch label.");for(const Q of z){if(typeof Q!="number"&&typeof Q!="string")return $.error("Branch labels must be numbers or strings.");if(typeof Q=="number"&&Math.abs(Q)>Number.MAX_SAFE_INTEGER)return $.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof Q=="number"&&Math.floor(Q)!==Q)return $.error("Numeric branch labels must be integer values.");if(d){if($.checkSubtype(d,ni(Q)))return null}else d=ni(Q);if(y[String(Q)]!==void 0)return $.error("Branch labels must be unique.");y[String(Q)]=w.length}const Z=l.parse(N,C,m);if(!Z)return null;m=m||Z.type,w.push(Z)}const S=l.parse(t[1],1,nr);if(!S)return null;const I=l.parse(t[t.length-1],t.length-1,m);return I?S.type.kind!=="value"&&l.concat(1).checkSubtype(d,S.type)?null:new Pn(d,m,S,y,w,I):null}evaluate(t){const l=this.input.evaluate(t);return(ni(l)===this.inputType&&this.outputs[this.cases[l]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],l=Object.keys(this.cases).sort(),d=[],m={};for(const w of l){const S=m[this.cases[w]];S===void 0?(m[this.cases[w]]=d.length,d.push([this.cases[w],[w]])):d[S][1].push(w)}const y=w=>this.inputType.kind==="number"?Number(w):w;for(const[w,S]of d)t.push(S.length===1?y(S[0]):S.map(y)),t.push(this.outputs[w].serialize());return t.push(this.otherwise.serialize()),t}}var go=Pn;class dn{constructor(t,l,d){this.type=t,this.branches=l,this.otherwise=d}static parse(t,l){if(t.length<4)return l.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return l.error("Expected an odd number of arguments.");let d;l.expectedType&&l.expectedType.kind!=="value"&&(d=l.expectedType);const m=[];for(let w=1;w<t.length-1;w+=2){const S=l.parse(t[w],w,ir);if(!S)return null;const I=l.parse(t[w+1],w+1,d);if(!I)return null;m.push([S,I]),d=d||I.type}const y=l.parse(t[t.length-1],t.length-1,d);return y?new dn(d,m,y):null}evaluate(t){for(const[l,d]of this.branches)if(l.evaluate(t))return d.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[l,d]of this.branches)t(l),t(d);t(this.otherwise)}outputDefined(){return this.branches.every(([t,l])=>l.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(l=>{t.push(l.serialize())}),t}}var _o=dn;class yo{constructor(t,l,d,m){this.type=t,this.input=l,this.beginIndex=d,this.endIndex=m}static parse(t,l){if(t.length<=2||t.length>=5)return l.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const d=l.parse(t[1],1,nr),m=l.parse(t[2],2,Qt);if(!d||!m)return null;if(!j(d.type,[kn(nr),Wi,nr]))return l.error(`Expected first argument to be of type array or string, but found ${Pr(d.type)} instead`);if(t.length===4){const y=l.parse(t[3],3,Qt);return y?new yo(d.type,d,m,y):null}return new yo(d.type,d,m)}evaluate(t){const l=this.input.evaluate(t),d=this.beginIndex.evaluate(t);if(!ae(l,["string","array"]))throw new Ti(`Expected first argument to be of type array or string, but found ${Pr(ni(l))} instead.`);if(this.endIndex){const m=this.endIndex.evaluate(t);return l.slice(d,m)}return l.slice(d)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var jo=yo;function Io(s,t){return s==="=="||s==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function Go(s,t,l,d){return d.compare(t,l)===0}function qo(s,t,l){const d=s!=="=="&&s!=="!=";return class jp{constructor(y,w,S){this.type=ir,this.lhs=y,this.rhs=w,this.collator=S,this.hasUntypedArgument=y.type.kind==="value"||w.type.kind==="value"}static parse(y,w){if(y.length!==3&&y.length!==4)return w.error("Expected two or three arguments.");const S=y[0];let I=w.parse(y[1],1,nr);if(!I)return null;if(!Io(S,I.type))return w.concat(1).error(`"${S}" comparisons are not supported for type '${Pr(I.type)}'.`);let C=w.parse(y[2],2,nr);if(!C)return null;if(!Io(S,C.type))return w.concat(2).error(`"${S}" comparisons are not supported for type '${Pr(C.type)}'.`);if(I.type.kind!==C.type.kind&&I.type.kind!=="value"&&C.type.kind!=="value")return w.error(`Cannot compare types '${Pr(I.type)}' and '${Pr(C.type)}'.`);d&&(I.type.kind==="value"&&C.type.kind!=="value"?I=new or(C.type,[I]):I.type.kind!=="value"&&C.type.kind==="value"&&(C=new or(I.type,[C])));let z=null;if(y.length===4){if(I.type.kind!=="string"&&C.type.kind!=="string"&&I.type.kind!=="value"&&C.type.kind!=="value")return w.error("Cannot use collator to compare non-string types.");if(z=w.parse(y[3],3,ra),!z)return null}return new jp(I,C,z)}evaluate(y){const w=this.lhs.evaluate(y),S=this.rhs.evaluate(y);if(d&&this.hasUntypedArgument){const I=ni(w),C=ni(S);if(I.kind!==C.kind||I.kind!=="string"&&I.kind!=="number")throw new Ti(`Expected arguments for "${s}" to be (string, string) or (number, number), but found (${I.kind}, ${C.kind}) instead.`)}if(this.collator&&!d&&this.hasUntypedArgument){const I=ni(w),C=ni(S);if(I.kind!=="string"||C.kind!=="string")return t(y,w,S)}return this.collator?l(y,w,S,this.collator.evaluate(y)):t(y,w,S)}eachChild(y){y(this.lhs),y(this.rhs),this.collator&&y(this.collator)}outputDefined(){return!0}serialize(){const y=[s];return this.eachChild(w=>{y.push(w.serialize())}),y}}}const $l=qo("==",function(s,t,l){return t===l},Go),Vl=qo("!=",function(s,t,l){return t!==l},function(s,t,l,d){return!Go(0,t,l,d)}),Cr=qo("<",function(s,t,l){return t<l},function(s,t,l,d){return d.compare(t,l)<0}),br=qo(">",function(s,t,l){return t>l},function(s,t,l,d){return d.compare(t,l)>0}),Ba=qo("<=",function(s,t,l){return t<=l},function(s,t,l,d){return d.compare(t,l)<=0}),oo=qo(">=",function(s,t,l){return t>=l},function(s,t,l,d){return d.compare(t,l)>=0});class Ra{constructor(t,l,d,m,y,w){this.type=Wi,this.number=t,this.locale=l,this.currency=d,this.unit=m,this.minFractionDigits=y,this.maxFractionDigits=w}static parse(t,l){if(t.length!==3)return l.error("Expected two arguments.");const d=l.parse(t[1],1,Qt);if(!d)return null;const m=t[2];if(typeof m!="object"||Array.isArray(m))return l.error("NumberFormat options argument must be an object.");let y=null;if(m.locale&&(y=l.parse(m.locale,1,Wi),!y))return null;let w=null;if(m.currency&&(w=l.parse(m.currency,1,Wi),!w))return null;let S=null;if(m.unit&&(S=l.parse(m.unit,1,Wi),!S))return null;let I=null;if(m["min-fraction-digits"]&&(I=l.parse(m["min-fraction-digits"],1,Qt),!I))return null;let C=null;return m["max-fraction-digits"]&&(C=l.parse(m["max-fraction-digits"],1,Qt),!C)?null:new Ra(d,y,w,S,I,C)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class Tn{constructor(t){this.type=Qt,this.input=t}static parse(t,l){if(t.length!==2)return l.error(`Expected 1 argument, but found ${t.length-1} instead.`);const d=l.parse(t[1],1);return d?d.type.kind!=="array"&&d.type.kind!=="string"&&d.type.kind!=="value"?l.error(`Expected argument of type string or array, but found ${Pr(d.type)} instead.`):new Tn(d):null}evaluate(t){const l=this.input.evaluate(t);if(typeof l=="string"||Array.isArray(l))return l.length;throw new Ti(`Expected value to be of type string or array, but found ${Pr(ni(l))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(l=>{t.push(l.serialize())}),t}}const ao={"==":$l,"!=":Vl,">":br,"<":Cr,">=":oo,"<=":Ba,array:or,at:Zr,boolean:or,case:_o,coalesce:ui,collator:Oo,format:an,image:hn,in:Wn,"index-of":en,interpolate:Xe,"interpolate-hcl":Xe,"interpolate-lab":Xe,length:Tn,let:Br,literal:Dr,match:go,number:or,"number-format":Ra,object:or,slice:jo,step:Uo,string:or,"to-boolean":yn,"to-color":yn,"to-number":yn,"to-string":yn,var:Mo,within:fr};function xo(s,[t,l,d,m]){t=t.evaluate(s),l=l.evaluate(s),d=d.evaluate(s);const y=m?m.evaluate(s):1,w=Yr(t,l,d,y);if(w)throw new Ti(w);return new Ke(t/255*y,l/255*y,d/255*y,y)}function pa(s,t){return s in t}function ma(s,t){const l=t[s];return l===void 0?null:l}function Un(s){return{type:s}}On.register(ao,{error:[{kind:"error"},[Wi],(s,[t])=>{throw new Ti(t.evaluate(s))}],typeof:[Wi,[nr],(s,[t])=>Pr(ni(t.evaluate(s)))],"to-rgba":[kn(Qt,4),[Jn],(s,[t])=>t.evaluate(s).toArray()],rgb:[Jn,[Qt,Qt,Qt],xo],rgba:[Jn,[Qt,Qt,Qt,Qt],xo],has:{type:ir,overloads:[[[Wi],(s,[t])=>pa(t.evaluate(s),s.properties())],[[Wi,ia],(s,[t,l])=>pa(t.evaluate(s),l.evaluate(s))]]},get:{type:nr,overloads:[[[Wi],(s,[t])=>ma(t.evaluate(s),s.properties())],[[Wi,ia],(s,[t,l])=>ma(t.evaluate(s),l.evaluate(s))]]},"feature-state":[nr,[Wi],(s,[t])=>ma(t.evaluate(s),s.featureState||{})],properties:[ia,[],s=>s.properties()],"geometry-type":[Wi,[],s=>s.geometryType()],id:[nr,[],s=>s.id()],zoom:[Qt,[],s=>s.globals.zoom],pitch:[Qt,[],s=>s.globals.pitch||0],"distance-from-center":[Qt,[],s=>s.distanceFromCenter()],"heatmap-density":[Qt,[],s=>s.globals.heatmapDensity||0],"line-progress":[Qt,[],s=>s.globals.lineProgress||0],"sky-radial-progress":[Qt,[],s=>s.globals.skyRadialProgress||0],accumulated:[nr,[],s=>s.globals.accumulated===void 0?null:s.globals.accumulated],"+":[Qt,Un(Qt),(s,t)=>{let l=0;for(const d of t)l+=d.evaluate(s);return l}],"*":[Qt,Un(Qt),(s,t)=>{let l=1;for(const d of t)l*=d.evaluate(s);return l}],"-":{type:Qt,overloads:[[[Qt,Qt],(s,[t,l])=>t.evaluate(s)-l.evaluate(s)],[[Qt],(s,[t])=>-t.evaluate(s)]]},"/":[Qt,[Qt,Qt],(s,[t,l])=>t.evaluate(s)/l.evaluate(s)],"%":[Qt,[Qt,Qt],(s,[t,l])=>t.evaluate(s)%l.evaluate(s)],ln2:[Qt,[],()=>Math.LN2],pi:[Qt,[],()=>Math.PI],e:[Qt,[],()=>Math.E],"^":[Qt,[Qt,Qt],(s,[t,l])=>Math.pow(t.evaluate(s),l.evaluate(s))],sqrt:[Qt,[Qt],(s,[t])=>Math.sqrt(t.evaluate(s))],log10:[Qt,[Qt],(s,[t])=>Math.log(t.evaluate(s))/Math.LN10],ln:[Qt,[Qt],(s,[t])=>Math.log(t.evaluate(s))],log2:[Qt,[Qt],(s,[t])=>Math.log(t.evaluate(s))/Math.LN2],sin:[Qt,[Qt],(s,[t])=>Math.sin(t.evaluate(s))],cos:[Qt,[Qt],(s,[t])=>Math.cos(t.evaluate(s))],tan:[Qt,[Qt],(s,[t])=>Math.tan(t.evaluate(s))],asin:[Qt,[Qt],(s,[t])=>Math.asin(t.evaluate(s))],acos:[Qt,[Qt],(s,[t])=>Math.acos(t.evaluate(s))],atan:[Qt,[Qt],(s,[t])=>Math.atan(t.evaluate(s))],min:[Qt,Un(Qt),(s,t)=>Math.min(...t.map(l=>l.evaluate(s)))],max:[Qt,Un(Qt),(s,t)=>Math.max(...t.map(l=>l.evaluate(s)))],abs:[Qt,[Qt],(s,[t])=>Math.abs(t.evaluate(s))],round:[Qt,[Qt],(s,[t])=>{const l=t.evaluate(s);return l<0?-Math.round(-l):Math.round(l)}],floor:[Qt,[Qt],(s,[t])=>Math.floor(t.evaluate(s))],ceil:[Qt,[Qt],(s,[t])=>Math.ceil(t.evaluate(s))],"filter-==":[ir,[Wi,nr],(s,[t,l])=>s.properties()[t.value]===l.value],"filter-id-==":[ir,[nr],(s,[t])=>s.id()===t.value],"filter-type-==":[ir,[Wi],(s,[t])=>s.geometryType()===t.value],"filter-<":[ir,[Wi,nr],(s,[t,l])=>{const d=s.properties()[t.value],m=l.value;return typeof d==typeof m&&d<m}],"filter-id-<":[ir,[nr],(s,[t])=>{const l=s.id(),d=t.value;return typeof l==typeof d&&l<d}],"filter->":[ir,[Wi,nr],(s,[t,l])=>{const d=s.properties()[t.value],m=l.value;return typeof d==typeof m&&d>m}],"filter-id->":[ir,[nr],(s,[t])=>{const l=s.id(),d=t.value;return typeof l==typeof d&&l>d}],"filter-<=":[ir,[Wi,nr],(s,[t,l])=>{const d=s.properties()[t.value],m=l.value;return typeof d==typeof m&&d<=m}],"filter-id-<=":[ir,[nr],(s,[t])=>{const l=s.id(),d=t.value;return typeof l==typeof d&&l<=d}],"filter->=":[ir,[Wi,nr],(s,[t,l])=>{const d=s.properties()[t.value],m=l.value;return typeof d==typeof m&&d>=m}],"filter-id->=":[ir,[nr],(s,[t])=>{const l=s.id(),d=t.value;return typeof l==typeof d&&l>=d}],"filter-has":[ir,[nr],(s,[t])=>t.value in s.properties()],"filter-has-id":[ir,[],s=>s.id()!==null&&s.id()!==void 0],"filter-type-in":[ir,[kn(Wi)],(s,[t])=>t.value.indexOf(s.geometryType())>=0],"filter-id-in":[ir,[kn(nr)],(s,[t])=>t.value.indexOf(s.id())>=0],"filter-in-small":[ir,[Wi,kn(nr)],(s,[t,l])=>l.value.indexOf(s.properties()[t.value])>=0],"filter-in-large":[ir,[Wi,kn(nr)],(s,[t,l])=>function(d,m,y,w){for(;y<=w;){const S=y+w>>1;if(m[S]===d)return!0;m[S]>d?w=S-1:y=S+1}return!1}(s.properties()[t.value],l.value,0,l.value.length-1)],all:{type:ir,overloads:[[[ir,ir],(s,[t,l])=>t.evaluate(s)&&l.evaluate(s)],[Un(ir),(s,t)=>{for(const l of t)if(!l.evaluate(s))return!1;return!0}]]},any:{type:ir,overloads:[[[ir,ir],(s,[t,l])=>t.evaluate(s)||l.evaluate(s)],[Un(ir),(s,t)=>{for(const l of t)if(l.evaluate(s))return!0;return!1}]]},"!":[ir,[ir],(s,[t])=>!t.evaluate(s)],"is-supported-script":[ir,[Wi],(s,[t])=>{const l=s.globals&&s.globals.isSupportedScript;return!l||l(t.evaluate(s))}],upcase:[Wi,[Wi],(s,[t])=>t.evaluate(s).toUpperCase()],downcase:[Wi,[Wi],(s,[t])=>t.evaluate(s).toLowerCase()],concat:[Wi,Un(nr),(s,t)=>t.map(l=>gr(l.evaluate(s))).join("")],"resolved-locale":[Wi,[ra],(s,[t])=>t.evaluate(s).resolvedLocale()]});var Dn=ao;function ns(s){return{result:"success",value:s}}function $n(s){return{result:"error",value:s}}function Co(s){return s["property-type"]==="data-driven"||s["property-type"]==="cross-faded-data-driven"}function La(s){return!!s.expression&&s.expression.parameters.indexOf("zoom")>-1}function Bn(s){return!!s.expression&&s.expression.interpolated}function hr(s){return s instanceof Number?"number":s instanceof String?"string":s instanceof Boolean?"boolean":Array.isArray(s)?"array":s===null?"null":typeof s}function Vn(s){return typeof s=="object"&&s!==null&&!Array.isArray(s)}function os(s){return s}function $c(s,t){const l=t.type==="color",d=s.stops&&typeof s.stops[0][0]=="object",m=d||!(d||s.property!==void 0),y=s.type||(Bn(t)?"exponential":"interval");if(l&&((s=Or({},s)).stops&&(s.stops=s.stops.map(C=>[C[0],Ke.parse(C[1])])),s.default=Ke.parse(s.default?s.default:t.default)),s.colorSpace&&s.colorSpace!=="rgb"&&!fa[s.colorSpace])throw new Error(`Unknown color space: ${s.colorSpace}`);let w,S,I;if(y==="exponential")w=Gl;else if(y==="interval")w=jl;else if(y==="categorical"){w=Qu,S=Object.create(null);for(const C of s.stops)S[C[0]]=C[1];I=typeof s.stops[0][0]}else{if(y!=="identity")throw new Error(`Unknown function type "${y}"`);w=ql}if(d){const C={},z=[];for(let Z=0;Z<s.stops.length;Z++){const Q=s.stops[Z],re=Q[0].zoom;C[re]===void 0&&(C[re]={zoom:re,type:s.type,property:s.property,default:s.default,stops:[]},z.push(re)),C[re].stops.push([Q[0].value,Q[1]])}const N=[];for(const Z of z)N.push([C[Z].zoom,$c(C[Z],t)]);const $={name:"linear"};return{kind:"composite",interpolationType:$,interpolationFactor:Xe.interpolationFactor.bind(void 0,$),zoomStops:N.map(Z=>Z[0]),evaluate:({zoom:Z},Q)=>Gl({stops:N,base:s.base},t,Z).evaluate(Z,Q)}}if(m){const C=y==="exponential"?{name:"exponential",base:s.base!==void 0?s.base:1}:null;return{kind:"camera",interpolationType:C,interpolationFactor:Xe.interpolationFactor.bind(void 0,C),zoomStops:s.stops.map(z=>z[0]),evaluate:({zoom:z})=>w(s,t,z,S,I)}}return{kind:"source",evaluate(C,z){const N=z&&z.properties?z.properties[s.property]:void 0;return N===void 0?as(s.default,t.default):w(s,t,N,S,I)}}}function as(s,t,l){return s!==void 0?s:t!==void 0?t:l!==void 0?l:void 0}function Qu(s,t,l,d,m){return as(typeof l===m?d[l]:void 0,s.default,t.default)}function jl(s,t,l){if(hr(l)!=="number")return as(s.default,t.default);const d=s.stops.length;if(d===1||l<=s.stops[0][0])return s.stops[0][1];if(l>=s.stops[d-1][0])return s.stops[d-1][1];const m=Ao(s.stops.map(y=>y[0]),l);return s.stops[m][1]}function Gl(s,t,l){const d=s.base!==void 0?s.base:1;if(hr(l)!=="number")return as(s.default,t.default);const m=s.stops.length;if(m===1||l<=s.stops[0][0])return s.stops[0][1];if(l>=s.stops[m-1][0])return s.stops[m-1][1];const y=Ao(s.stops.map(z=>z[0]),l),w=function(z,N,$,Z){const Q=Z-$,re=z-$;return Q===0?0:N===1?re/Q:(Math.pow(N,re)-1)/(Math.pow(N,Q)-1)}(l,d,s.stops[y][0],s.stops[y+1][0]),S=s.stops[y][1],I=s.stops[y+1][1];let C=ca[t.type]||os;if(s.colorSpace&&s.colorSpace!=="rgb"){const z=fa[s.colorSpace];C=(N,$)=>z.reverse(z.interpolate(z.forward(N),z.forward($),w))}return typeof S.evaluate=="function"?{evaluate(...z){const N=S.evaluate.apply(void 0,z),$=I.evaluate.apply(void 0,z);if(N!==void 0&&$!==void 0)return C(N,$,w)}}:C(S,I,w)}function ql(s,t,l){return t.type==="color"?l=Ke.parse(l):t.type==="formatted"?l=Mi.fromString(l.toString()):t.type==="resolvedImage"?l=Oi.fromString(l.toString()):hr(l)===t.type||t.type==="enum"&&t.values[l]||(l=void 0),as(l,s.default,t.default)}class Cs{constructor(t,l){this.expression=t,this._warningHistory={},this._evaluator=new bs,this._defaultValue=l?function(d){return d.type==="color"&&(Vn(d.default)||Array.isArray(d.default))?new Ke(0,0,0,0):d.type==="color"?Ke.parse(d.default)||null:d.default===void 0?null:d.default}(l):null,this._enumValues=l&&l.type==="enum"?l.values:null}evaluateWithoutErrorHandling(t,l,d,m,y,w,S,I){return this._evaluator.globals=t,this._evaluator.feature=l,this._evaluator.featureState=d,this._evaluator.canonical=m||null,this._evaluator.availableImages=y||null,this._evaluator.formattedSection=w,this._evaluator.featureTileCoord=S||null,this._evaluator.featureDistanceData=I||null,this.expression.evaluate(this._evaluator)}evaluate(t,l,d,m,y,w,S,I){this._evaluator.globals=t,this._evaluator.feature=l||null,this._evaluator.featureState=d||null,this._evaluator.canonical=m||null,this._evaluator.availableImages=y||null,this._evaluator.formattedSection=w||null,this._evaluator.featureTileCoord=S||null,this._evaluator.featureDistanceData=I||null;try{const C=this.expression.evaluate(this._evaluator);if(C==null||typeof C=="number"&&C!=C)return this._defaultValue;if(this._enumValues&&!(C in this._enumValues))throw new Ti(`Expected value to be one of ${Object.keys(this._enumValues).map(z=>JSON.stringify(z)).join(", ")}, but found ${JSON.stringify(C)} instead.`);return C}catch(C){return this._warningHistory[C.message]||(this._warningHistory[C.message]=!0,typeof console<"u"&&console.warn(C.message)),this._defaultValue}}}function ks(s){return Array.isArray(s)&&s.length>0&&typeof s[0]=="string"&&s[0]in Dn}function za(s,t){const l=new ro(Dn,[],t?function(m){const y={color:Jn,string:Wi,number:Qt,enum:Wi,boolean:ir,formatted:na,resolvedImage:oa};return m.type==="array"?kn(y[m.value]||nr,m.length):y[m.type]}(t):void 0),d=l.parse(s,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return d?ns(new Cs(d,t)):$n(l.errors)}class rl{constructor(t,l){this.kind=t,this._styleExpression=l,this.isStateDependent=t!=="constant"&&!la(l.expression)}evaluateWithoutErrorHandling(t,l,d,m,y,w){return this._styleExpression.evaluateWithoutErrorHandling(t,l,d,m,y,w)}evaluate(t,l,d,m,y,w){return this._styleExpression.evaluate(t,l,d,m,y,w)}}class nl{constructor(t,l,d,m){this.kind=t,this.zoomStops=d,this._styleExpression=l,this.isStateDependent=t!=="camera"&&!la(l.expression),this.interpolationType=m}evaluateWithoutErrorHandling(t,l,d,m,y,w){return this._styleExpression.evaluateWithoutErrorHandling(t,l,d,m,y,w)}evaluate(t,l,d,m,y,w){return this._styleExpression.evaluate(t,l,d,m,y,w)}interpolationFactor(t,l,d){return this.interpolationType?Xe.interpolationFactor(this.interpolationType,t,l,d):0}}function Ps(s,t){if((s=za(s,t)).result==="error")return s;const l=s.value.expression,d=sa(l);if(!d&&!Co(t))return $n([new Qn("","data expressions not supported")]);const m=io(l,["zoom","pitch","distance-from-center"]);if(!m&&!La(t))return $n([new Qn("","zoom expressions not supported")]);const y=Ds(l);return y||m?y instanceof Qn?$n([y]):y instanceof Xe&&!Bn(t)?$n([new Qn("",'"interpolate" expressions cannot be used with this property')]):ns(y?new nl(d?"camera":"composite",s.value,y.labels,y instanceof Xe?y.interpolation:void 0):new rl(d?"constant":"source",s.value)):$n([new Qn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Zo{constructor(t,l){this._parameters=t,this._specification=l,Or(this,$c(this._parameters,this._specification))}static deserialize(t){return new Zo(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Ds(s){let t=null;if(s instanceof Br)t=Ds(s.result);else if(s instanceof ui){for(const l of s.args)if(t=Ds(l),t)break}else(s instanceof Uo||s instanceof Xe)&&s.input instanceof On&&s.input.name==="zoom"&&(t=s);return t instanceof Qn||s.eachChild(l=>{const d=Ds(l);d instanceof Qn?t=d:!t&&d?t=new Qn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&d&&t!==d&&(t=new Qn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}class hi{constructor(t,l,d,m){this.message=(t?`${t}: `:"")+d,m&&(this.identifier=m),l!=null&&l.__line__&&(this.line=l.__line__)}}function Yn(s){const t=s.key,l=s.value,d=s.valueSpec||{},m=s.objectElementValidators||{},y=s.style,w=s.styleSpec;let S=[];const I=hr(l);if(I!=="object")return[new hi(t,l,`object expected, ${I} found`)];for(const C in l){const z=C.split(".")[0],N=d[z]||d["*"];let $;m[z]?$=m[z]:d[z]?$=Sn:m["*"]?$=m["*"]:d["*"]&&($=Sn),$?S=S.concat($({key:(t&&`${t}.`)+C,value:l[C],valueSpec:N,style:y,styleSpec:w,object:l,objectKey:C},l)):S.push(new hi(t,l[C],`unknown property "${C}"`))}for(const C in d)m[C]||d[C].required&&d[C].default===void 0&&l[C]===void 0&&S.push(new hi(t,l,`missing required property "${C}"`));return S}function Zl(s){const t=s.value,l=s.valueSpec,d=s.style,m=s.styleSpec,y=s.key,w=s.arrayElementValidator||Sn;if(hr(t)!=="array")return[new hi(y,t,`array expected, ${hr(t)} found`)];if(l.length&&t.length!==l.length)return[new hi(y,t,`array length ${l.length} expected, length ${t.length} found`)];if(l["min-length"]&&t.length<l["min-length"])return[new hi(y,t,`array length at least ${l["min-length"]} expected, length ${t.length} found`)];let S={type:l.value,values:l.values,minimum:l.minimum,maximum:l.maximum,function:void 0};m.$version<7&&(S.function=l.function),hr(l.value)==="object"&&(S=l.value);let I=[];for(let C=0;C<t.length;C++)I=I.concat(w({array:t,arrayIndex:C,value:t[C],valueSpec:S,style:d,styleSpec:m,key:`${y}[${C}]`}));return I}function Vc(s){const t=s.key,l=s.value,d=s.valueSpec;let m=hr(l);if(m==="number"&&l!=l&&(m="NaN"),m!=="number")return[new hi(t,l,`number expected, ${m} found`)];if("minimum"in d){let y=d.minimum;if(hr(d.minimum)==="array"&&(y=d.minimum[s.arrayIndex]),l<y)return[new hi(t,l,`${l} is less than the minimum value ${y}`)]}if("maximum"in d){let y=d.maximum;if(hr(d.maximum)==="array"&&(y=d.maximum[s.arrayIndex]),l>y)return[new hi(t,l,`${l} is greater than the maximum value ${y}`)]}return[]}function Xl(s){const t=s.valueSpec,l=Fr(s.value.type);let d,m,y,w={};const S=l!=="categorical"&&s.value.property===void 0,I=!S,C=hr(s.value.stops)==="array"&&hr(s.value.stops[0])==="array"&&hr(s.value.stops[0][0])==="object",z=Yn({key:s.key,value:s.value,valueSpec:s.styleSpec.function,style:s.style,styleSpec:s.styleSpec,objectElementValidators:{stops:function(Z){if(l==="identity")return[new hi(Z.key,Z.value,'identity function may not have a "stops" property')];let Q=[];const re=Z.value;return Q=Q.concat(Zl({key:Z.key,value:re,valueSpec:Z.valueSpec,style:Z.style,styleSpec:Z.styleSpec,arrayElementValidator:N})),hr(re)==="array"&&re.length===0&&Q.push(new hi(Z.key,re,"array must have at least one stop")),Q},default:function(Z){return Sn({key:Z.key,value:Z.value,valueSpec:t,style:Z.style,styleSpec:Z.styleSpec})}}});return l==="identity"&&S&&z.push(new hi(s.key,s.value,'missing required property "property"')),l==="identity"||s.value.stops||z.push(new hi(s.key,s.value,'missing required property "stops"')),l==="exponential"&&s.valueSpec.expression&&!Bn(s.valueSpec)&&z.push(new hi(s.key,s.value,"exponential functions not supported")),s.styleSpec.$version>=8&&(I&&!Co(s.valueSpec)?z.push(new hi(s.key,s.value,"property functions not supported")):S&&!La(s.valueSpec)&&z.push(new hi(s.key,s.value,"zoom functions not supported"))),l!=="categorical"&&!C||s.value.property!==void 0||z.push(new hi(s.key,s.value,'"property" property is required')),z;function N(Z){let Q=[];const re=Z.value,ue=Z.key;if(hr(re)!=="array")return[new hi(ue,re,`array expected, ${hr(re)} found`)];if(re.length!==2)return[new hi(ue,re,`array length 2 expected, length ${re.length} found`)];if(C){if(hr(re[0])!=="object")return[new hi(ue,re,`object expected, ${hr(re[0])} found`)];if(re[0].zoom===void 0)return[new hi(ue,re,"object stop key must have zoom")];if(re[0].value===void 0)return[new hi(ue,re,"object stop key must have value")];const Se=Fr(re[0].zoom);if(typeof Se!="number")return[new hi(ue,re[0].zoom,"stop zoom values must be numbers")];if(y&&y>Se)return[new hi(ue,re[0].zoom,"stop zoom values must appear in ascending order")];Se!==y&&(y=Se,m=void 0,w={}),Q=Q.concat(Yn({key:`${ue}[0]`,value:re[0],valueSpec:{zoom:{}},style:Z.style,styleSpec:Z.styleSpec,objectElementValidators:{zoom:Vc,value:$}}))}else Q=Q.concat($({key:`${ue}[0]`,value:re[0],valueSpec:{},style:Z.style,styleSpec:Z.styleSpec},re));return ks(Vr(re[1]))?Q.concat([new hi(`${ue}[1]`,re[1],"expressions are not allowed in function stops.")]):Q.concat(Sn({key:`${ue}[1]`,value:re[1],valueSpec:t,style:Z.style,styleSpec:Z.styleSpec}))}function $(Z,Q){const re=hr(Z.value),ue=Fr(Z.value),Se=Z.value!==null?Z.value:Q;if(d){if(re!==d)return[new hi(Z.key,Se,`${re} stop domain type must match previous stop domain type ${d}`)]}else d=re;if(re!=="number"&&re!=="string"&&re!=="boolean"&&typeof ue!="number"&&typeof ue!="string"&&typeof ue!="boolean")return[new hi(Z.key,Se,"stop domain value must be a number, string, or boolean")];if(re!=="number"&&l!=="categorical"){let Le=`number expected, ${re} found`;return Co(t)&&l===void 0&&(Le+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new hi(Z.key,Se,Le)]}return l!=="categorical"||re!=="number"||typeof ue=="number"&&isFinite(ue)&&Math.floor(ue)===ue?l!=="categorical"&&re==="number"&&typeof ue=="number"&&typeof m=="number"&&m!==void 0&&ue<m?[new hi(Z.key,Se,"stop domain values must appear in ascending order")]:(m=ue,l==="categorical"&&ue in w?[new hi(Z.key,Se,"stop domain values must be unique")]:(w[ue]=!0,[])):[new hi(Z.key,Se,`integer expected, found ${String(ue)}`)]}}function Xo(s){const t=(s.expressionContext==="property"?Ps:za)(Vr(s.value),s.valueSpec);if(t.result==="error")return t.value.map(d=>new hi(`${s.key}${d.key}`,s.value,d.message));const l=t.value.expression||t.value._styleExpression.expression;if(s.expressionContext==="property"&&s.propertyKey==="text-font"&&!l.outputDefined())return[new hi(s.key,s.value,`Invalid data expression for "${s.propertyKey}". Output values must be contained as literals within the expression.`)];if(s.expressionContext==="property"&&s.propertyType==="layout"&&!la(l))return[new hi(s.key,s.value,'"feature-state" data expressions are not supported with layout properties.')];if(s.expressionContext==="filter")return jc(l,s);if(s.expressionContext&&s.expressionContext.indexOf("cluster")===0){if(!io(l,["zoom","feature-state"]))return[new hi(s.key,s.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(s.expressionContext==="cluster-initial"&&!sa(l))return[new hi(s.key,s.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function jc(s,t){const l=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const m of t.valueSpec.expression.parameters)l.delete(m);if(l.size===0)return[];const d=[];return s instanceof On&&l.has(s.name)?[new hi(t.key,t.value,`["${s.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(s.eachChild(m=>{d.push(...jc(m,t))}),d)}function ol(s){const t=s.key,l=s.value,d=s.valueSpec,m=[];return Array.isArray(d.values)?d.values.indexOf(Fr(l))===-1&&m.push(new hi(t,l,`expected one of [${d.values.join(", ")}], ${JSON.stringify(l)} found`)):Object.keys(d.values).indexOf(Fr(l))===-1&&m.push(new hi(t,l,`expected one of [${Object.keys(d.values).join(", ")}], ${JSON.stringify(l)} found`)),m}function Hl(s){if(s===!0||s===!1)return!0;if(!Array.isArray(s)||s.length===0)return!1;switch(s[0]){case"has":return s.length>=2&&s[1]!=="$id"&&s[1]!=="$type";case"in":return s.length>=3&&(typeof s[1]!="string"||Array.isArray(s[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return s.length!==3||Array.isArray(s[1])||Array.isArray(s[2]);case"any":case"all":for(const t of s.slice(1))if(!Hl(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}function al(s,t="fill"){if(s==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Hl(s)||(s=ll(s));const l=s;let d=!0;try{d=function(C){if(!Ho(C))return C;let z=Vr(C);return Bs(z),z=Gc(z),z}(l)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(l,null,2)}
        `)}const m=it[`filter_${t}`],y=za(d,m);let w=null;if(y.result==="error")throw new Error(y.value.map(C=>`${C.key}: ${C.message}`).join(", "));w=(C,z,N)=>y.value.evaluate(C,z,{},N);let S=null,I=null;if(d!==l){const C=za(l,m);if(C.result==="error")throw new Error(C.value.map(z=>`${z.key}: ${z.message}`).join(", "));S=(z,N,$,Z,Q)=>C.value.evaluate(z,N,{},$,void 0,void 0,Z,Q),I=!sa(C.value.expression)}return{filter:w,dynamicFilter:S||void 0,needGeometry:qc(d),needFeature:!!I}}function Gc(s){if(!Array.isArray(s))return s;const t=function(l){if(Kn.has(l[0])){for(let d=1;d<l.length;d++)if(Ho(l[d]))return!0}return l}(s);return t===!0?t:t.map(l=>Gc(l))}function Bs(s){let t=!1;const l=[];if(s[0]==="case"){for(let d=1;d<s.length-1;d+=2)t=t||Ho(s[d]),l.push(s[d+1]);l.push(s[s.length-1])}else if(s[0]==="match"){t=t||Ho(s[1]);for(let d=2;d<s.length-1;d+=2)l.push(s[d+1]);l.push(s[s.length-1])}else if(s[0]==="step"){t=t||Ho(s[1]);for(let d=1;d<s.length-1;d+=2)l.push(s[d+1])}t&&(s.length=0,s.push("any",...l));for(let d=1;d<s.length;d++)Bs(s[d])}function Ho(s){if(!Array.isArray(s))return!1;if((t=s[0])==="pitch"||t==="distance-from-center")return!0;var t;for(let l=1;l<s.length;l++)if(Ho(s[l]))return!0;return!1}const Kn=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function sl(s,t){return s<t?-1:s>t?1:0}function qc(s){if(!Array.isArray(s))return!1;if(s[0]==="within")return!0;for(let t=1;t<s.length;t++)if(qc(s[t]))return!0;return!1}function ll(s){if(!s)return!0;const t=s[0];return s.length<=1?t!=="any":t==="=="?Wl(s[1],s[2],"=="):t==="!="?ul(Wl(s[1],s[2],"==")):t==="<"||t===">"||t==="<="||t===">="?Wl(s[1],s[2],t):t==="any"?(l=s.slice(1),["any"].concat(l.map(ll))):t==="all"?["all"].concat(s.slice(1).map(ll)):t==="none"?["all"].concat(s.slice(1).map(ll).map(ul)):t==="in"?Zc(s[1],s.slice(2)):t==="!in"?ul(Zc(s[1],s.slice(2))):t==="has"?cl(s[1]):t==="!has"?ul(cl(s[1])):t!=="within"||s;var l}function Wl(s,t,l){switch(s){case"$type":return[`filter-type-${l}`,t];case"$id":return[`filter-id-${l}`,t];default:return[`filter-${l}`,s,t]}}function Zc(s,t){if(t.length===0)return!1;switch(s){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(l=>typeof l!=typeof t[0])?["filter-in-large",s,["literal",t.sort(sl)]]:["filter-in-small",s,["literal",t]]}}function cl(s){switch(s){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",s]}}function ul(s){return["!",s]}function Rs(s){return Hl(Vr(s.value))?Xo(Or({},s,{expressionContext:"filter",valueSpec:s.styleSpec[`filter_${s.layerType||"fill"}`]})):Xc(s)}function Xc(s){const t=s.value,l=s.key;if(hr(t)!=="array")return[new hi(l,t,`array expected, ${hr(t)} found`)];const d=s.styleSpec;let m,y=[];if(t.length<1)return[new hi(l,t,"filter array must have at least 1 element")];switch(y=y.concat(ol({key:`${l}[0]`,value:t[0],valueSpec:d.filter_operator,style:s.style,styleSpec:s.styleSpec})),Fr(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&Fr(t[1])==="$type"&&y.push(new hi(l,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&y.push(new hi(l,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(m=hr(t[1]),m!=="string"&&y.push(new hi(`${l}[1]`,t[1],`string expected, ${m} found`)));for(let w=2;w<t.length;w++)m=hr(t[w]),Fr(t[1])==="$type"?y=y.concat(ol({key:`${l}[${w}]`,value:t[w],valueSpec:d.geometry_type,style:s.style,styleSpec:s.styleSpec})):m!=="string"&&m!=="number"&&m!=="boolean"&&y.push(new hi(`${l}[${w}]`,t[w],`string, number, or boolean expected, ${m} found`));break;case"any":case"all":case"none":for(let w=1;w<t.length;w++)y=y.concat(Xc({key:`${l}[${w}]`,value:t[w],style:s.style,styleSpec:s.styleSpec}));break;case"has":case"!has":m=hr(t[1]),t.length!==2?y.push(new hi(l,t,`filter array for "${t[0]}" operator must have 2 elements`)):m!=="string"&&y.push(new hi(`${l}[1]`,t[1],`string expected, ${m} found`));break;case"within":m=hr(t[1]),t.length!==2?y.push(new hi(l,t,`filter array for "${t[0]}" operator must have 2 elements`)):m!=="object"&&y.push(new hi(`${l}[1]`,t[1],`object expected, ${m} found`))}return y}function Hc(s,t){const l=s.key,d=s.style,m=s.styleSpec,y=s.value,w=s.objectKey,S=m[`${t}_${s.layerType}`];if(!S)return[];const I=w.match(/^(.*)-transition$/);if(t==="paint"&&I&&S[I[1]]&&S[I[1]].transition)return Sn({key:l,value:y,valueSpec:m.transition,style:d,styleSpec:m});const C=s.valueSpec||S[w];if(!C)return[new hi(l,y,`unknown property "${w}"`)];let z;if(hr(y)==="string"&&Co(C)&&!C.tokens&&(z=/^{([^}]+)}$/.exec(y)))return[new hi(l,y,`"${w}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(z[1])} }\`.`)];const N=[];return s.layerType==="symbol"&&(w==="text-field"&&d&&!d.glyphs&&N.push(new hi(l,y,'use of "text-field" requires a style "glyphs" property')),w==="text-font"&&Vn(Vr(y))&&Fr(y.type)==="identity"&&N.push(new hi(l,y,'"text-font" does not support identity functions'))),N.concat(Sn({key:s.key,value:y,valueSpec:C,style:d,styleSpec:m,expressionContext:"property",propertyType:t,propertyKey:w}))}function hl(s){return Hc(s,"paint")}function Wc(s){return Hc(s,"layout")}function Yl(s){let t=[];const l=s.value,d=s.key,m=s.style,y=s.styleSpec;l.type||l.ref||t.push(new hi(d,l,'either "type" or "ref" is required'));let w=Fr(l.type);const S=Fr(l.ref);if(l.id){const I=Fr(l.id);for(let C=0;C<s.arrayIndex;C++){const z=m.layers[C];Fr(z.id)===I&&t.push(new hi(d,l.id,`duplicate layer id "${l.id}", previously used at line ${z.id.__line__}`))}}if("ref"in l){let I;["type","source","source-layer","filter","layout"].forEach(C=>{C in l&&t.push(new hi(d,l[C],`"${C}" is prohibited for ref layers`))}),m.layers.forEach(C=>{Fr(C.id)===S&&(I=C)}),I?I.ref?t.push(new hi(d,l.ref,"ref cannot reference another ref layer")):w=Fr(I.type):typeof S=="string"&&t.push(new hi(d,l.ref,`ref layer "${S}" not found`))}else if(w!=="background"&&w!=="sky")if(l.source){const I=m.sources&&m.sources[l.source],C=I&&Fr(I.type);I?C==="vector"&&w==="raster"?t.push(new hi(d,l.source,`layer "${l.id}" requires a raster source`)):C==="raster"&&w!=="raster"?t.push(new hi(d,l.source,`layer "${l.id}" requires a vector source`)):C!=="vector"||l["source-layer"]?C==="raster-dem"&&w!=="hillshade"?t.push(new hi(d,l.source,"raster-dem source can only be used with layer type 'hillshade'.")):w!=="line"||!l.paint||!l.paint["line-gradient"]&&!l.paint["line-trim-offset"]||C==="geojson"&&I.lineMetrics||t.push(new hi(d,l,`layer "${l.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new hi(d,l,`layer "${l.id}" must specify a "source-layer"`)):t.push(new hi(d,l.source,`source "${l.source}" not found`))}else t.push(new hi(d,l,'missing required property "source"'));return t=t.concat(Yn({key:d,value:l,valueSpec:y.layer,style:s.style,styleSpec:s.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Sn({key:`${d}.type`,value:l.type,valueSpec:y.layer.type,style:s.style,styleSpec:s.styleSpec,object:l,objectKey:"type"}),filter:I=>Rs(Or({layerType:w},I)),layout:I=>Yn({layer:l,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":C=>Wc(Or({layerType:w},C))}}),paint:I=>Yn({layer:l,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":C=>hl(Or({layerType:w},C))}})}})),t}function Oa(s){const t=s.value,l=s.key,d=hr(t);return d!=="string"?[new hi(l,t,`string expected, ${d} found`)]:[]}const Yc={promoteId:function({key:s,value:t}){if(hr(t)==="string")return Oa({key:s,value:t});{const l=[];for(const d in t)l.push(...Oa({key:`${s}.${d}`,value:t[d]}));return l}}};function dl(s){const t=s.value,l=s.key,d=s.styleSpec,m=s.style;if(!t.type)return[new hi(l,t,'"type" is required')];const y=Fr(t.type);let w;switch(y){case"vector":case"raster":case"raster-dem":return w=Yn({key:l,value:t,valueSpec:d[`source_${y.replace("-","_")}`],style:s.style,styleSpec:d,objectElementValidators:Yc}),w;case"geojson":if(w=Yn({key:l,value:t,valueSpec:d.source_geojson,style:m,styleSpec:d,objectElementValidators:Yc}),t.cluster)for(const S in t.clusterProperties){const[I,C]=t.clusterProperties[S],z=typeof I=="string"?[I,["accumulated"],["get",S]]:I;w.push(...Xo({key:`${l}.${S}.map`,value:C,expressionContext:"cluster-map"})),w.push(...Xo({key:`${l}.${S}.reduce`,value:z,expressionContext:"cluster-reduce"}))}return w;case"video":return Yn({key:l,value:t,valueSpec:d.source_video,style:m,styleSpec:d});case"image":return Yn({key:l,value:t,valueSpec:d.source_image,style:m,styleSpec:d});case"canvas":return[new hi(l,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ol({key:`${l}.type`,value:t.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:m,styleSpec:d})}}function Ls(s){const t=s.value,l=s.styleSpec,d=l.light,m=s.style;let y=[];const w=hr(t);if(t===void 0)return y;if(w!=="object")return y=y.concat([new hi("light",t,`object expected, ${w} found`)]),y;for(const S in t){const I=S.match(/^(.*)-transition$/);y=y.concat(I&&d[I[1]]&&d[I[1]].transition?Sn({key:S,value:t[S],valueSpec:l.transition,style:m,styleSpec:l}):d[S]?Sn({key:S,value:t[S],valueSpec:d[S],style:m,styleSpec:l}):[new hi(S,t[S],`unknown property "${S}"`)])}return y}function Kl(s){const t=s.value,l=s.key,d=s.style,m=s.styleSpec,y=m.terrain;let w=[];const S=hr(t);if(t===void 0)return w;if(S!=="object")return w=w.concat([new hi("terrain",t,`object expected, ${S} found`)]),w;for(const I in t){const C=I.match(/^(.*)-transition$/);w=w.concat(C&&y[C[1]]&&y[C[1]].transition?Sn({key:I,value:t[I],valueSpec:m.transition,style:d,styleSpec:m}):y[I]?Sn({key:I,value:t[I],valueSpec:y[I],style:d,styleSpec:m}):[new hi(I,t[I],`unknown property "${I}"`)])}if(t.source){const I=d.sources&&d.sources[t.source],C=I&&Fr(I.type);I?C!=="raster-dem"&&w.push(new hi(l,t.source,`terrain cannot be used with a source of type ${String(C)}, it only be used with a "raster-dem" source type`)):w.push(new hi(l,t.source,`source "${t.source}" not found`))}else w.push(new hi(l,t,'terrain is missing required property "source"'));return w}function Kc(s){const t=s.value,l=s.style,d=s.styleSpec,m=d.fog;let y=[];const w=hr(t);if(t===void 0)return y;if(w!=="object")return y=y.concat([new hi("fog",t,`object expected, ${w} found`)]),y;for(const S in t){const I=S.match(/^(.*)-transition$/);y=y.concat(I&&m[I[1]]&&m[I[1]].transition?Sn({key:S,value:t[S],valueSpec:d.transition,style:l,styleSpec:d}):m[S]?Sn({key:S,value:t[S],valueSpec:m[S],style:l,styleSpec:d}):[new hi(S,t[S],`unknown property "${S}"`)])}return y}const Ql={"*":()=>[],array:Zl,boolean:function(s){const t=s.value,l=s.key,d=hr(t);return d!=="boolean"?[new hi(l,t,`boolean expected, ${d} found`)]:[]},number:Vc,color:function(s){const t=s.key,l=s.value,d=hr(l);return d!=="string"?[new hi(t,l,`color expected, ${d} found`)]:Ue(l)===null?[new hi(t,l,`color expected, "${l}" found`)]:[]},enum:ol,filter:Rs,function:Xl,layer:Yl,object:Yn,source:dl,light:Ls,terrain:Kl,fog:Kc,string:Oa,formatted:function(s){return Oa(s).length===0?[]:Xo(s)},resolvedImage:function(s){return Oa(s).length===0?[]:Xo(s)},projection:function(s){const t=s.value,l=s.styleSpec,d=l.projection,m=s.style;let y=[];const w=hr(t);if(w==="object")for(const S in t)y=y.concat(Sn({key:S,value:t[S],valueSpec:d[S],style:m,styleSpec:l}));else w!=="string"&&(y=y.concat([new hi("projection",t,`object or string expected, ${w} found`)]));return y}};function Sn(s){const t=s.value,l=s.valueSpec,d=s.styleSpec;return l.expression&&Vn(Fr(t))?Xl(s):l.expression&&ks(Vr(t))?Xo(s):l.type&&Ql[l.type]?Ql[l.type](s):Yn(Or({},s,{valueSpec:l.type?d[l.type]:l}))}function Jl(s){const t=s.value,l=s.key,d=Oa(s);return d.length||(t.indexOf("{fontstack}")===-1&&d.push(new hi(l,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&d.push(new hi(l,t,'"glyphs" url must include a "{range}" token'))),d}function Qc(s,t=it){return Wo(Sn({key:"",value:s,valueSpec:t.$root,styleSpec:t,style:s,objectElementValidators:{glyphs:Jl,"*":()=>[]}}))}const Ju=s=>Wo(hl(s)),eh=s=>Wo(Wc(s));function Wo(s){return s.slice().sort((t,l)=>t.line&&l.line?t.line-l.line:0)}function ec(s,t){let l=!1;if(t&&t.length)for(const d of t)s.fire(new dr(new Error(d.message))),l=!0;return l}var ss=ko;function ko(s,t,l){var d=this.cells=[];if(s instanceof ArrayBuffer){this.arrayBuffer=s;var m=new Int32Array(this.arrayBuffer);s=m[0],this.d=(t=m[1])+2*(l=m[2]);for(var y=0;y<this.d*this.d;y++){var w=m[3+y],S=m[3+y+1];d.push(w===S?null:m.subarray(w,S))}var I=m[3+d.length+1];this.keys=m.subarray(m[3+d.length],I),this.bboxes=m.subarray(I),this.insert=this._insertReadonly}else{this.d=t+2*l;for(var C=0;C<this.d*this.d;C++)d.push([]);this.keys=[],this.bboxes=[]}this.n=t,this.extent=s,this.padding=l,this.scale=t/s,this.uid=0;var z=l/t*s;this.min=-z,this.max=s+z}ko.prototype.insert=function(s,t,l,d,m){this._forEachCell(t,l,d,m,this._insertCell,this.uid++),this.keys.push(s),this.bboxes.push(t),this.bboxes.push(l),this.bboxes.push(d),this.bboxes.push(m)},ko.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},ko.prototype._insertCell=function(s,t,l,d,m,y){this.cells[m].push(y)},ko.prototype.query=function(s,t,l,d,m){var y=this.min,w=this.max;if(s<=y&&t<=y&&w<=l&&w<=d&&!m)return Array.prototype.slice.call(this.keys);var S=[];return this._forEachCell(s,t,l,d,this._queryCell,S,{},m),S},ko.prototype._queryCell=function(s,t,l,d,m,y,w,S){var I=this.cells[m];if(I!==null)for(var C=this.keys,z=this.bboxes,N=0;N<I.length;N++){var $=I[N];if(w[$]===void 0){var Z=4*$;(S?S(z[Z+0],z[Z+1],z[Z+2],z[Z+3]):s<=z[Z+2]&&t<=z[Z+3]&&l>=z[Z+0]&&d>=z[Z+1])?(w[$]=!0,y.push(C[$])):w[$]=!1}}},ko.prototype._forEachCell=function(s,t,l,d,m,y,w,S){for(var I=this._convertToCellCoord(s),C=this._convertToCellCoord(t),z=this._convertToCellCoord(l),N=this._convertToCellCoord(d),$=I;$<=z;$++)for(var Z=C;Z<=N;Z++){var Q=this.d*Z+$;if((!S||S(this._convertFromCellCoord($),this._convertFromCellCoord(Z),this._convertFromCellCoord($+1),this._convertFromCellCoord(Z+1)))&&m.call(this,s,t,l,d,Q,y,w,S))return}},ko.prototype._convertFromCellCoord=function(s){return(s-this.padding)/this.scale},ko.prototype._convertToCellCoord=function(s){return Math.max(0,Math.min(this.d-1,Math.floor(s*this.scale)+this.padding))},ko.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var s=this.cells,t=3+this.cells.length+1+1,l=0,d=0;d<this.cells.length;d++)l+=this.cells[d].length;var m=new Int32Array(t+l+this.keys.length+this.bboxes.length);m[0]=this.extent,m[1]=this.n,m[2]=this.padding;for(var y=t,w=0;w<s.length;w++){var S=s[w];m[3+w]=y,m.set(S,y),y+=S.length}return m[3+s.length]=y,m.set(this.keys,y),m[3+s.length+1]=y+=this.keys.length,m.set(this.bboxes,y),y+=this.bboxes.length,m.buffer};const fl={};function _i(s,t,l={}){Object.defineProperty(s,"_classRegistryKey",{value:t,writeable:!1}),fl[t]={klass:s,omit:l.omit||[]}}_i(Object,"Object"),ss.serialize=function(s,t){const l=s.toArrayBuffer();return t&&t.push(l),{buffer:l}},ss.deserialize=function(s){return new ss(s.buffer)},Object.defineProperty(ss,"name",{value:"Grid"}),_i(ss,"Grid"),_i(Ke,"Color"),_i(Error,"Error"),_i(Li,"AJAXError"),_i(Oi,"ResolvedImage"),_i(Zo,"StylePropertyFunction"),_i(Cs,"StyleExpression",{omit:["_evaluator"]}),_i(nl,"ZoomDependentExpression"),_i(rl,"ZoomConstantExpression"),_i(On,"CompoundExpression",{omit:["_evaluate"]});for(const s in Dn)fl[Dn[s]._classRegistryKey]||_i(Dn[s],`Expression${s}`);function Jc(s){return s&&typeof ArrayBuffer<"u"&&(s instanceof ArrayBuffer||s.constructor&&s.constructor.name==="ArrayBuffer")}function eu(s){return b.ImageBitmap&&s instanceof b.ImageBitmap}function zs(s,t){if(s==null||typeof s=="boolean"||typeof s=="number"||typeof s=="string"||s instanceof Boolean||s instanceof Number||s instanceof String||s instanceof Date||s instanceof RegExp)return s;if(Jc(s)||eu(s))return t&&t.push(s),s;if(ArrayBuffer.isView(s)){const l=s;return t&&t.push(l.buffer),l}if(s instanceof b.ImageData)return t&&t.push(s.data.buffer),s;if(Array.isArray(s)){const l=[];for(const d of s)l.push(zs(d,t));return l}if(typeof s=="object"){const l=s.constructor,d=l._classRegistryKey;if(!d)throw new Error(`can't serialize object of unregistered class ${d}`);const m=l.serialize?l.serialize(s,t):{};if(!l.serialize){for(const y in s)s.hasOwnProperty(y)&&(fl[d].omit.indexOf(y)>=0||(m[y]=zs(s[y],t)));s instanceof Error&&(m.message=s.message)}if(m.$name)throw new Error("$name property is reserved for worker serialization logic.");return d!=="Object"&&(m.$name=d),m}throw new Error("can't serialize object of type "+typeof s)}function ga(s){if(s==null||typeof s=="boolean"||typeof s=="number"||typeof s=="string"||s instanceof Boolean||s instanceof Number||s instanceof String||s instanceof Date||s instanceof RegExp||Jc(s)||eu(s)||ArrayBuffer.isView(s)||s instanceof b.ImageData)return s;if(Array.isArray(s))return s.map(ga);if(typeof s=="object"){const t=s.$name||"Object",{klass:l}=fl[t];if(!l)throw new Error(`can't deserialize unregistered class ${t}`);if(l.deserialize)return l.deserialize(s);const d=Object.create(l.prototype);for(const m of Object.keys(s))m!=="$name"&&(d[m]=ga(s[m]));return d}throw new Error("can't deserialize object of type "+typeof s)}class tu{constructor(){this.first=!0}update(t,l){const d=Math.floor(t);return this.first?(this.first=!1,this.lastIntegerZoom=d,this.lastIntegerZoomTime=0,this.lastZoom=t,this.lastFloorZoom=d,!0):(this.lastFloorZoom>d?(this.lastIntegerZoom=d+1,this.lastIntegerZoomTime=l):this.lastFloorZoom<d&&(this.lastIntegerZoom=d,this.lastIntegerZoomTime=l),t!==this.lastZoom&&(this.lastZoom=t,this.lastFloorZoom=d,!0))}}const iu=s=>s>=1536&&s<=1791,Os=s=>s>=1872&&s<=1919,ru=s=>s>=2208&&s<=2303,tc=s=>s>=11904&&s<=12031,nu=s=>s>=12032&&s<=12255,ic=s=>s>=12272&&s<=12287,Fs=s=>s>=12288&&s<=12351,pl=s=>s>=12352&&s<=12447,Ns=s=>s>=12448&&s<=12543,ml=s=>s>=12544&&s<=12591,gl=s=>s>=12704&&s<=12735,ou=s=>s>=12736&&s<=12783,au=s=>s>=12784&&s<=12799,rc=s=>s>=12800&&s<=13055,su=s=>s>=13056&&s<=13311,lu=s=>s>=13312&&s<=19903,nc=s=>s>=19968&&s<=40959,_l=s=>s>=40960&&s<=42127,cu=s=>s>=42128&&s<=42191,uu=s=>s>=44032&&s<=55215,hu=s=>s>=63744&&s<=64255,oc=s=>s>=64336&&s<=65023,du=s=>s>=65040&&s<=65055,yl=s=>s>=65072&&s<=65103,Us=s=>s>=65104&&s<=65135,g=s=>s>=65136&&s<=65279,c=s=>s>=65280&&s<=65519;function p(s){for(const t of s)if(A(t.charCodeAt(0)))return!0;return!1}function x(s){for(const t of s)if(!T(t.charCodeAt(0)))return!1;return!0}function T(s){return!(iu(s)||Os(s)||ru(s)||oc(s)||g(s))}function A(s){return!(s!==746&&s!==747&&(s<4352||!(gl(s)||ml(s)||yl(s)&&!(s>=65097&&s<=65103)||hu(s)||su(s)||tc(s)||ou(s)||!(!Fs(s)||s>=12296&&s<=12305||s>=12308&&s<=12319||s===12336)||lu(s)||nc(s)||rc(s)||(t=>t>=12592&&t<=12687)(s)||(t=>t>=43360&&t<=43391)(s)||(t=>t>=55216&&t<=55295)(s)||(t=>t>=4352&&t<=4607)(s)||uu(s)||pl(s)||ic(s)||(t=>t>=12688&&t<=12703)(s)||nu(s)||au(s)||Ns(s)&&s!==12540||!(!c(s)||s===65288||s===65289||s===65293||s>=65306&&s<=65310||s===65339||s===65341||s===65343||s>=65371&&s<=65503||s===65507||s>=65512&&s<=65519)||!(!Us(s)||s>=65112&&s<=65118||s>=65123&&s<=65126)||(t=>t>=5120&&t<=5759)(s)||(t=>t>=6320&&t<=6399)(s)||du(s)||(t=>t>=19904&&t<=19967)(s)||_l(s)||cu(s))))}function k(s){return!(A(s)||function(t){return!!((l=>l>=128&&l<=255)(t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||(l=>l>=8192&&l<=8303)(t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||(l=>l>=8448&&l<=8527)(t)||(l=>l>=8528&&l<=8591)(t)||(l=>l>=8960&&l<=9215)(t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||(l=>l>=9216&&l<=9279)(t)&&t!==9251||(l=>l>=9280&&l<=9311)(t)||(l=>l>=9312&&l<=9471)(t)||(l=>l>=9632&&l<=9727)(t)||(l=>l>=9728&&l<=9983)(t)&&!(t>=9754&&t<=9759)||(l=>l>=11008&&l<=11263)(t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Fs(t)||Ns(t)||(l=>l>=57344&&l<=63743)(t)||yl(t)||Us(t)||c(t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(s))}function O(s){return s>=1424&&s<=2303||oc(s)||g(s)}function F(s,t){return!(!t&&O(s)||s>=2304&&s<=3583||s>=3840&&s<=4255||(l=>l>=6016&&l<=6143)(s))}function V(s){for(const t of s)if(O(t.charCodeAt(0)))return!0;return!1}const G="deferred",ie="loading",le="loaded";let _e=null,fe="unavailable",ve=null;const me=function(s){s&&typeof s=="string"&&s.indexOf("NetworkError")>-1&&(fe="error"),_e&&_e(s)};function de(){be.fire(new fi("pluginStateChange",{pluginStatus:fe,pluginURL:ve}))}const be=new sr,ge=function(){return fe},Be=function(){if(fe!==G||!ve)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");fe=ie,de(),ve&&Xi({url:ve},s=>{s?me(s):(fe=le,de())})},ze={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>fe===le||ze.applyArabicShaping!=null,isLoading:()=>fe===ie,setState(s){fe=s.pluginStatus,ve=s.pluginURL},isParsed:()=>ze.applyArabicShaping!=null&&ze.processBidirectionalText!=null&&ze.processStyledBidirectionalText!=null,getPluginURL:()=>ve};class Me{constructor(t,l){this.zoom=t,l?(this.now=l.now,this.fadeDuration=l.fadeDuration,this.zoomHistory=l.zoomHistory,this.transition=l.transition,this.pitch=l.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new tu,this.transition={},this.pitch=0)}isSupportedScript(t){return function(l,d){for(const m of l)if(!F(m.charCodeAt(0),d))return!1;return!0}(t,ze.isLoaded())}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const t=this.zoom,l=t-Math.floor(t),d=this.crossFadingFactor();return t>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:l+(1-l)*d}:{fromScale:.5,toScale:1,t:1-(1-d)*l}}}class Fe{constructor(t,l){this.property=t,this.value=l,this.expression=function(d,m){if(Vn(d))return new Zo(d,m);if(ks(d)){const y=Ps(d,m);if(y.result==="error")throw new Error(y.value.map(w=>`${w.key}: ${w.message}`).join(", "));return y.value}{let y=d;return typeof d=="string"&&m.type==="color"&&(y=Ke.parse(d)),{kind:"constant",evaluate:()=>y}}}(l===void 0?t.specification.default:l,t.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,l,d){return this.property.possiblyEvaluate(this,t,l,d)}}class Je{constructor(t){this.property=t,this.value=new Fe(t,void 0)}transitioned(t,l){return new ot(this.property,this.value,l,je({},t.transition,this.transition),t.now)}untransitioned(){return new ot(this.property,this.value,null,{},0)}}class lt{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues)}getValue(t){return vi(this._values[t].value.value)}setValue(t,l){this._values.hasOwnProperty(t)||(this._values[t]=new Je(this._values[t].property)),this._values[t].value=new Fe(this._values[t].property,l===null?void 0:vi(l))}getTransition(t){return vi(this._values[t].transition)}setTransition(t,l){this._values.hasOwnProperty(t)||(this._values[t]=new Je(this._values[t].property)),this._values[t].transition=vi(l)||void 0}serialize(){const t={};for(const l of Object.keys(this._values)){const d=this.getValue(l);d!==void 0&&(t[l]=d);const m=this.getTransition(l);m!==void 0&&(t[`${l}-transition`]=m)}return t}transitioned(t,l){const d=new zt(this._properties);for(const m of Object.keys(this._values))d._values[m]=this._values[m].transitioned(t,l._values[m]);return d}untransitioned(){const t=new zt(this._properties);for(const l of Object.keys(this._values))t._values[l]=this._values[l].untransitioned();return t}}class ot{constructor(t,l,d,m,y){const w=m.delay||0,S=m.duration||0;y=y||0,this.property=t,this.value=l,this.begin=y+w,this.end=this.begin+S,t.specification.transition&&(m.delay||m.duration)&&(this.prior=d)}possiblyEvaluate(t,l,d){const m=t.now||0,y=this.value.possiblyEvaluate(t,l,d),w=this.prior;if(w){if(m>this.end)return this.prior=null,y;if(this.value.isDataDriven())return this.prior=null,y;if(m<this.begin)return w.possiblyEvaluate(t,l,d);{const S=(m-this.begin)/(this.end-this.begin);return this.property.interpolate(w.possiblyEvaluate(t,l,d),y,Ie(S))}}return y}}class zt{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,l,d){const m=new bt(this._properties);for(const y of Object.keys(this._values))m._values[y]=this._values[y].possiblyEvaluate(t,l,d);return m}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class He{constructor(t){this._properties=t,this._values=Object.create(t.defaultPropertyValues)}getValue(t){return vi(this._values[t].value)}setValue(t,l){this._values[t]=new Fe(this._values[t].property,l===null?void 0:vi(l))}serialize(){const t={};for(const l of Object.keys(this._values)){const d=this.getValue(l);d!==void 0&&(t[l]=d)}return t}possiblyEvaluate(t,l,d){const m=new bt(this._properties);for(const y of Object.keys(this._values))m._values[y]=this._values[y].possiblyEvaluate(t,l,d);return m}}class wt{constructor(t,l,d){this.property=t,this.value=l,this.parameters=d}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,l,d,m){return this.property.evaluate(this.value,this.parameters,t,l,d,m)}}class bt{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class tt{constructor(t){this.specification=t}possiblyEvaluate(t,l){return t.expression.evaluate(l)}interpolate(t,l,d){const m=ca[this.specification.type];return m?m(t,l,d):t}}class Ve{constructor(t,l){this.specification=t,this.overrides=l}possiblyEvaluate(t,l,d,m){return new wt(this,t.expression.kind==="constant"||t.expression.kind==="camera"?{kind:"constant",value:t.expression.evaluate(l,null,{},d,m)}:t.expression,l)}interpolate(t,l,d){if(t.value.kind!=="constant"||l.value.kind!=="constant")return t;if(t.value.value===void 0||l.value.value===void 0)return new wt(this,{kind:"constant",value:void 0},t.parameters);const m=ca[this.specification.type];return m?new wt(this,{kind:"constant",value:m(t.value.value,l.value.value,d)},t.parameters):t}evaluate(t,l,d,m,y,w){return t.kind==="constant"?t.value:t.evaluate(l,d,m,y,w)}}class ri extends Ve{possiblyEvaluate(t,l,d,m){if(t.value===void 0)return new wt(this,{kind:"constant",value:void 0},l);if(t.expression.kind==="constant"){const y=t.expression.evaluate(l,null,{},d,m),w=t.property.specification.type==="resolvedImage"&&typeof y!="string"?y.name:y,S=this._calculate(w,w,w,l);return new wt(this,{kind:"constant",value:S},l)}if(t.expression.kind==="camera"){const y=this._calculate(t.expression.evaluate({zoom:l.zoom-1}),t.expression.evaluate({zoom:l.zoom}),t.expression.evaluate({zoom:l.zoom+1}),l);return new wt(this,{kind:"constant",value:y},l)}return new wt(this,t.expression,l)}evaluate(t,l,d,m,y,w){if(t.kind==="source"){const S=t.evaluate(l,d,m,y,w);return this._calculate(S,S,S,l)}return t.kind==="composite"?this._calculate(t.evaluate({zoom:Math.floor(l.zoom)-1},d,m),t.evaluate({zoom:Math.floor(l.zoom)},d,m),t.evaluate({zoom:Math.floor(l.zoom)+1},d,m),l):t.value}_calculate(t,l,d,m){return m.zoom>m.zoomHistory.lastIntegerZoom?{from:t,to:l,other:d}:{from:d,to:l,other:t}}interpolate(t){return t}}class qt{constructor(t){this.specification=t}possiblyEvaluate(t,l,d,m){if(t.value!==void 0){if(t.expression.kind==="constant"){const y=t.expression.evaluate(l,null,{},d,m);return this._calculate(y,y,y,l)}return this._calculate(t.expression.evaluate(new Me(Math.floor(l.zoom-1),l)),t.expression.evaluate(new Me(Math.floor(l.zoom),l)),t.expression.evaluate(new Me(Math.floor(l.zoom+1),l)),l)}}_calculate(t,l,d,m){return m.zoom>m.zoomHistory.lastIntegerZoom?{from:t,to:l}:{from:d,to:l}}interpolate(t){return t}}class Jt{constructor(t){this.specification=t}possiblyEvaluate(t,l,d,m){return!!t.expression.evaluate(l,null,{},d,m)}interpolate(){return!1}}class Ht{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const l=new Me(0,{});for(const d in t){const m=t[d];m.specification.overridable&&this.overridableProperties.push(d);const y=this.defaultPropertyValues[d]=new Fe(m,void 0),w=this.defaultTransitionablePropertyValues[d]=new Je(m);this.defaultTransitioningPropertyValues[d]=w.untransitioned(),this.defaultPossiblyEvaluatedValues[d]=y.possiblyEvaluate(l)}}}function Ai(s,t){return 256*(s=We(Math.floor(s),0,255))+We(Math.floor(t),0,255)}_i(Ve,"DataDrivenProperty"),_i(tt,"DataConstantProperty"),_i(ri,"CrossFadedDataDrivenProperty"),_i(qt,"CrossFadedProperty"),_i(Jt,"ColorRampProperty");const Vi={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Ni{constructor(t,l){this._structArray=t,this._pos1=l*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Bi{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,l){return t._trim(),l&&(t.isTransferred=!0,l.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const l=Object.create(this.prototype);return l.arrayBuffer=t.arrayBuffer,l.length=t.length,l.capacity=t.arrayBuffer.byteLength/l.bytesPerElement,l._refreshViews(),l}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const l=this.uint8;this._refreshViews(),l&&this.uint8.set(l)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Wt(s,t=1){let l=0,d=0;return{members:s.map(m=>{const y=Vi[m.type].BYTES_PER_ELEMENT,w=l=Zi(l,Math.max(t,y)),S=m.components||1;return d=Math.max(d,y),l+=y*S,{name:m.name,type:m.type,components:S,offset:w}}),size:Zi(l,Math.max(d,t)),alignment:t}}function Zi(s,t){return Math.ceil(s/t)*t}class er extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,l){const d=this.length;return this.resize(d+1),this.emplace(d,t,l)}emplace(t,l,d){const m=2*t;return this.int16[m+0]=l,this.int16[m+1]=d,t}}er.prototype.bytesPerElement=4,_i(er,"StructArrayLayout2i4");class Tr extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,l,d){const m=this.length;return this.resize(m+1),this.emplace(m,t,l,d)}emplace(t,l,d,m){const y=3*t;return this.int16[y+0]=l,this.int16[y+1]=d,this.int16[y+2]=m,t}}Tr.prototype.bytesPerElement=6,_i(Tr,"StructArrayLayout3i6");class Sr extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,l,d,m){const y=this.length;return this.resize(y+1),this.emplace(y,t,l,d,m)}emplace(t,l,d,m,y){const w=4*t;return this.int16[w+0]=l,this.int16[w+1]=d,this.int16[w+2]=m,this.int16[w+3]=y,t}}Sr.prototype.bytesPerElement=8,_i(Sr,"StructArrayLayout4i8");class vr extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w,S){const I=this.length;return this.resize(I+1),this.emplace(I,t,l,d,m,y,w,S)}emplace(t,l,d,m,y,w,S,I){const C=6*t,z=12*t,N=3*t;return this.int16[C+0]=l,this.int16[C+1]=d,this.uint8[z+4]=m,this.uint8[z+5]=y,this.uint8[z+6]=w,this.uint8[z+7]=S,this.float32[N+2]=I,t}}vr.prototype.bytesPerElement=12,_i(vr,"StructArrayLayout2i4ub1f12");class fn extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,l,d,m){const y=this.length;return this.resize(y+1),this.emplace(y,t,l,d,m)}emplace(t,l,d,m,y){const w=4*t;return this.float32[w+0]=l,this.float32[w+1]=d,this.float32[w+2]=m,this.float32[w+3]=y,t}}fn.prototype.bytesPerElement=16,_i(fn,"StructArrayLayout4f16");class Rn extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w,S,I,C,z){const N=this.length;return this.resize(N+1),this.emplace(N,t,l,d,m,y,w,S,I,C,z)}emplace(t,l,d,m,y,w,S,I,C,z,N){const $=10*t;return this.uint16[$+0]=l,this.uint16[$+1]=d,this.uint16[$+2]=m,this.uint16[$+3]=y,this.uint16[$+4]=w,this.uint16[$+5]=S,this.uint16[$+6]=I,this.uint16[$+7]=C,this.uint16[$+8]=z,this.uint16[$+9]=N,t}}Rn.prototype.bytesPerElement=20,_i(Rn,"StructArrayLayout10ui20");class Po extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w,S,I){const C=this.length;return this.resize(C+1),this.emplace(C,t,l,d,m,y,w,S,I)}emplace(t,l,d,m,y,w,S,I,C){const z=8*t;return this.uint16[z+0]=l,this.uint16[z+1]=d,this.uint16[z+2]=m,this.uint16[z+3]=y,this.uint16[z+4]=w,this.uint16[z+5]=S,this.uint16[z+6]=I,this.uint16[z+7]=C,t}}Po.prototype.bytesPerElement=16,_i(Po,"StructArrayLayout8ui16");class Nr extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w){const S=this.length;return this.resize(S+1),this.emplace(S,t,l,d,m,y,w)}emplace(t,l,d,m,y,w,S){const I=6*t;return this.int16[I+0]=l,this.int16[I+1]=d,this.int16[I+2]=m,this.int16[I+3]=y,this.int16[I+4]=w,this.int16[I+5]=S,t}}Nr.prototype.bytesPerElement=12,_i(Nr,"StructArrayLayout6i12");class Hr extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w,S,I,C,z,N,$){const Z=this.length;return this.resize(Z+1),this.emplace(Z,t,l,d,m,y,w,S,I,C,z,N,$)}emplace(t,l,d,m,y,w,S,I,C,z,N,$,Z){const Q=12*t;return this.int16[Q+0]=l,this.int16[Q+1]=d,this.int16[Q+2]=m,this.int16[Q+3]=y,this.uint16[Q+4]=w,this.uint16[Q+5]=S,this.uint16[Q+6]=I,this.uint16[Q+7]=C,this.int16[Q+8]=z,this.int16[Q+9]=N,this.int16[Q+10]=$,this.int16[Q+11]=Z,t}}Hr.prototype.bytesPerElement=24,_i(Hr,"StructArrayLayout4i4ui4i24");class xr extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w){const S=this.length;return this.resize(S+1),this.emplace(S,t,l,d,m,y,w)}emplace(t,l,d,m,y,w,S){const I=10*t,C=5*t;return this.int16[I+0]=l,this.int16[I+1]=d,this.int16[I+2]=m,this.float32[C+2]=y,this.float32[C+3]=w,this.float32[C+4]=S,t}}xr.prototype.bytesPerElement=20,_i(xr,"StructArrayLayout3i3f20");class rn extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const l=this.length;return this.resize(l+1),this.emplace(l,t)}emplace(t,l){return this.uint32[1*t+0]=l,t}}rn.prototype.bytesPerElement=4,_i(rn,"StructArrayLayout1ul4");class Mn extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w,S,I,C,z,N,$,Z){const Q=this.length;return this.resize(Q+1),this.emplace(Q,t,l,d,m,y,w,S,I,C,z,N,$,Z)}emplace(t,l,d,m,y,w,S,I,C,z,N,$,Z,Q){const re=20*t,ue=10*t;return this.int16[re+0]=l,this.int16[re+1]=d,this.int16[re+2]=m,this.int16[re+3]=y,this.int16[re+4]=w,this.float32[ue+3]=S,this.float32[ue+4]=I,this.float32[ue+5]=C,this.float32[ue+6]=z,this.int16[re+14]=N,this.uint32[ue+8]=$,this.uint16[re+18]=Z,this.uint16[re+19]=Q,t}}Mn.prototype.bytesPerElement=40,_i(Mn,"StructArrayLayout5i4f1i1ul2ui40");class Rr extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w,S){const I=this.length;return this.resize(I+1),this.emplace(I,t,l,d,m,y,w,S)}emplace(t,l,d,m,y,w,S,I){const C=8*t;return this.int16[C+0]=l,this.int16[C+1]=d,this.int16[C+2]=m,this.int16[C+4]=y,this.int16[C+5]=w,this.int16[C+6]=S,this.int16[C+7]=I,t}}Rr.prototype.bytesPerElement=16,_i(Rr,"StructArrayLayout3i2i2i16");class jn extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y){const w=this.length;return this.resize(w+1),this.emplace(w,t,l,d,m,y)}emplace(t,l,d,m,y,w){const S=4*t,I=8*t;return this.float32[S+0]=l,this.float32[S+1]=d,this.float32[S+2]=m,this.int16[I+6]=y,this.int16[I+7]=w,t}}jn.prototype.bytesPerElement=16,_i(jn,"StructArrayLayout2f1f2i16");class Fa extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,l,d,m){const y=this.length;return this.resize(y+1),this.emplace(y,t,l,d,m)}emplace(t,l,d,m,y){const w=12*t,S=3*t;return this.uint8[w+0]=l,this.uint8[w+1]=d,this.float32[S+1]=m,this.float32[S+2]=y,t}}Fa.prototype.bytesPerElement=12,_i(Fa,"StructArrayLayout2ub2f12");class vo extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,l,d){const m=this.length;return this.resize(m+1),this.emplace(m,t,l,d)}emplace(t,l,d,m){const y=3*t;return this.float32[y+0]=l,this.float32[y+1]=d,this.float32[y+2]=m,t}}vo.prototype.bytesPerElement=12,_i(vo,"StructArrayLayout3f12");class Ln extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,l,d){const m=this.length;return this.resize(m+1),this.emplace(m,t,l,d)}emplace(t,l,d,m){const y=3*t;return this.uint16[y+0]=l,this.uint16[y+1]=d,this.uint16[y+2]=m,t}}Ln.prototype.bytesPerElement=6,_i(Ln,"StructArrayLayout3ui6");class ls extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w,S,I,C,z,N,$,Z,Q,re,ue,Se,Le,Te,Ce,Ne){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,t,l,d,m,y,w,S,I,C,z,N,$,Z,Q,re,ue,Se,Le,Te,Ce,Ne)}emplace(t,l,d,m,y,w,S,I,C,z,N,$,Z,Q,re,ue,Se,Le,Te,Ce,Ne,Oe){const st=30*t,rt=15*t,mt=60*t;return this.int16[st+0]=l,this.int16[st+1]=d,this.int16[st+2]=m,this.float32[rt+2]=y,this.float32[rt+3]=w,this.uint16[st+8]=S,this.uint16[st+9]=I,this.uint32[rt+5]=C,this.uint32[rt+6]=z,this.uint32[rt+7]=N,this.uint16[st+16]=$,this.uint16[st+17]=Z,this.uint16[st+18]=Q,this.float32[rt+10]=re,this.float32[rt+11]=ue,this.uint8[mt+48]=Se,this.uint8[mt+49]=Le,this.uint8[mt+50]=Te,this.uint32[rt+13]=Ce,this.int16[st+28]=Ne,this.uint8[mt+58]=Oe,t}}ls.prototype.bytesPerElement=60,_i(ls,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class _a extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y,w,S,I,C,z,N,$,Z,Q,re,ue,Se,Le,Te,Ce,Ne,Oe,st,rt,mt,Ft,ct,Et,Mt,Lt){const Vt=this.length;return this.resize(Vt+1),this.emplace(Vt,t,l,d,m,y,w,S,I,C,z,N,$,Z,Q,re,ue,Se,Le,Te,Ce,Ne,Oe,st,rt,mt,Ft,ct,Et,Mt,Lt)}emplace(t,l,d,m,y,w,S,I,C,z,N,$,Z,Q,re,ue,Se,Le,Te,Ce,Ne,Oe,st,rt,mt,Ft,ct,Et,Mt,Lt,Vt){const gt=38*t,xi=19*t;return this.int16[gt+0]=l,this.int16[gt+1]=d,this.int16[gt+2]=m,this.float32[xi+2]=y,this.float32[xi+3]=w,this.int16[gt+8]=S,this.int16[gt+9]=I,this.int16[gt+10]=C,this.int16[gt+11]=z,this.int16[gt+12]=N,this.int16[gt+13]=$,this.uint16[gt+14]=Z,this.uint16[gt+15]=Q,this.uint16[gt+16]=re,this.uint16[gt+17]=ue,this.uint16[gt+18]=Se,this.uint16[gt+19]=Le,this.uint16[gt+20]=Te,this.uint16[gt+21]=Ce,this.uint16[gt+22]=Ne,this.uint16[gt+23]=Oe,this.uint16[gt+24]=st,this.uint16[gt+25]=rt,this.uint16[gt+26]=mt,this.uint16[gt+27]=Ft,this.uint16[gt+28]=ct,this.uint32[xi+15]=Et,this.float32[xi+16]=Mt,this.float32[xi+17]=Lt,this.float32[xi+18]=Vt,t}}_a.prototype.bytesPerElement=76,_i(_a,"StructArrayLayout3i2f6i15ui1ul3f76");class xn extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const l=this.length;return this.resize(l+1),this.emplace(l,t)}emplace(t,l){return this.float32[1*t+0]=l,t}}xn.prototype.bytesPerElement=4,_i(xn,"StructArrayLayout1f4");class Do extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,l,d,m,y){const w=this.length;return this.resize(w+1),this.emplace(w,t,l,d,m,y)}emplace(t,l,d,m,y,w){const S=5*t;return this.float32[S+0]=l,this.float32[S+1]=d,this.float32[S+2]=m,this.float32[S+3]=y,this.float32[S+4]=w,t}}Do.prototype.bytesPerElement=20,_i(Do,"StructArrayLayout5f20");class ya extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,l,d,m){const y=this.length;return this.resize(y+1),this.emplace(y,t,l,d,m)}emplace(t,l,d,m,y){const w=6*t;return this.uint32[3*t+0]=l,this.uint16[w+2]=d,this.uint16[w+3]=m,this.uint16[w+4]=y,t}}ya.prototype.bytesPerElement=12,_i(ya,"StructArrayLayout1ul3ui12");class bo extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,l){const d=this.length;return this.resize(d+1),this.emplace(d,t,l)}emplace(t,l,d){const m=2*t;return this.uint16[m+0]=l,this.uint16[m+1]=d,t}}bo.prototype.bytesPerElement=4,_i(bo,"StructArrayLayout2ui4");class ac extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const l=this.length;return this.resize(l+1),this.emplace(l,t)}emplace(t,l){return this.uint16[1*t+0]=l,t}}ac.prototype.bytesPerElement=2,_i(ac,"StructArrayLayout1ui2");class fu extends Bi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,l){const d=this.length;return this.resize(d+1),this.emplace(d,t,l)}emplace(t,l,d){const m=2*t;return this.float32[m+0]=l,this.float32[m+1]=d,t}}fu.prototype.bytesPerElement=8,_i(fu,"StructArrayLayout2f8");class ad extends Ni{get a_pos_30(){return this._structArray.int16[this._pos2+0]}get a_pos_31(){return this._structArray.int16[this._pos2+1]}get a_pos_32(){return this._structArray.int16[this._pos2+2]}get a_pos_normal_30(){return this._structArray.int16[this._pos2+3]}get a_pos_normal_31(){return this._structArray.int16[this._pos2+4]}get a_pos_normal_32(){return this._structArray.int16[this._pos2+5]}}ad.prototype.size=12;class sd extends Nr{get(t){return new ad(this,t)}}_i(sd,"FillExtrusionExtArray");class ld extends Ni{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}ld.prototype.size=40;class th extends Mn{get(t){return new ld(this,t)}}_i(th,"CollisionBoxArray");class cd extends Ni{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}cd.prototype.size=60;class ud extends ls{get(t){return new cd(this,t)}}_i(ud,"PlacedSymbolArray");class hd extends Ni{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(t){this._structArray.uint32[this._pos4+15]=t}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}hd.prototype.size=76;class dd extends _a{get(t){return new hd(this,t)}}_i(dd,"SymbolInstanceArray");class fd extends xn{getoffsetX(t){return this.float32[1*t+0]}}_i(fd,"GlyphOffsetArray");class pd extends Tr{getx(t){return this.int16[3*t+0]}gety(t){return this.int16[3*t+1]}gettileUnitDistanceFromAnchor(t){return this.int16[3*t+2]}}_i(pd,"SymbolLineVertexArray");class md extends Ni{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}md.prototype.size=12;class gd extends ya{get(t){return new md(this,t)}}_i(gd,"FeatureIndexArray");class _d extends Ni{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0]}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1]}}_d.prototype.size=4;class yd extends bo{get(t){return new _d(this,t)}}_i(yd,"FillExtrusionCentroidArray");class xd extends Ni{get a_pos_30(){return this._structArray.int16[this._pos2+0]}get a_pos_31(){return this._structArray.int16[this._pos2+1]}get a_pos_32(){return this._structArray.int16[this._pos2+2]}get a_pos_normal_30(){return this._structArray.int16[this._pos2+3]}get a_pos_normal_31(){return this._structArray.int16[this._pos2+4]}get a_pos_normal_32(){return this._structArray.int16[this._pos2+5]}}xd.prototype.size=12;class vd extends Nr{get(t){return new xd(this,t)}}_i(vd,"CircleGlobeExtArray");const Gp=Wt([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),qp=Wt([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var xl={exports:{}},bd={exports:{}};bd.exports=function(s,t){var l,d,m,y,w,S,I,C;for(d=s.length-(l=3&s.length),m=t,w=3432918353,S=461845907,C=0;C<d;)I=255&s.charCodeAt(C)|(255&s.charCodeAt(++C))<<8|(255&s.charCodeAt(++C))<<16|(255&s.charCodeAt(++C))<<24,++C,m=27492+(65535&(y=5*(65535&(m=(m^=I=(65535&(I=(I=(65535&I)*w+(((I>>>16)*w&65535)<<16)&4294967295)<<15|I>>>17))*S+(((I>>>16)*S&65535)<<16)&4294967295)<<13|m>>>19))+((5*(m>>>16)&65535)<<16)&4294967295))+((58964+(y>>>16)&65535)<<16);switch(I=0,l){case 3:I^=(255&s.charCodeAt(C+2))<<16;case 2:I^=(255&s.charCodeAt(C+1))<<8;case 1:m^=I=(65535&(I=(I=(65535&(I^=255&s.charCodeAt(C)))*w+(((I>>>16)*w&65535)<<16)&4294967295)<<15|I>>>17))*S+(((I>>>16)*S&65535)<<16)&4294967295}return m^=s.length,m=2246822507*(65535&(m^=m>>>16))+((2246822507*(m>>>16)&65535)<<16)&4294967295,m=3266489909*(65535&(m^=m>>>13))+((3266489909*(m>>>16)&65535)<<16)&4294967295,(m^=m>>>16)>>>0};var wd={exports:{}};wd.exports=function(s,t){for(var l,d=s.length,m=t^d,y=0;d>=4;)l=1540483477*(65535&(l=255&s.charCodeAt(y)|(255&s.charCodeAt(++y))<<8|(255&s.charCodeAt(++y))<<16|(255&s.charCodeAt(++y))<<24))+((1540483477*(l>>>16)&65535)<<16),m=1540483477*(65535&m)+((1540483477*(m>>>16)&65535)<<16)^(l=1540483477*(65535&(l^=l>>>24))+((1540483477*(l>>>16)&65535)<<16)),d-=4,++y;switch(d){case 3:m^=(255&s.charCodeAt(y+2))<<16;case 2:m^=(255&s.charCodeAt(y+1))<<8;case 1:m=1540483477*(65535&(m^=255&s.charCodeAt(y)))+((1540483477*(m>>>16)&65535)<<16)}return m=1540483477*(65535&(m^=m>>>13))+((1540483477*(m>>>16)&65535)<<16),(m^=m>>>15)>>>0};var Ed=bd.exports,Zp=wd.exports;xl.exports=Ed,xl.exports.murmur3=Ed,xl.exports.murmur2=Zp;class pu{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(t,l,d,m){this.ids.push(Td(t)),this.positions.push(l,d,m)}getPositions(t){const l=Td(t);let d=0,m=this.ids.length-1;for(;d<m;){const w=d+m>>1;this.ids[w]>=l?m=w:d=w+1}const y=[];for(;this.ids[d]===l;)y.push({index:this.positions[3*d],start:this.positions[3*d+1],end:this.positions[3*d+2]}),d++;return y}static serialize(t,l){const d=new Float64Array(t.ids),m=new Uint32Array(t.positions);return ih(d,m,0,d.length-1),l&&l.push(d.buffer,m.buffer),{ids:d,positions:m}}static deserialize(t){const l=new pu;return l.ids=t.ids,l.positions=t.positions,l.indexed=!0,l}}function Td(s){const t=+s;return!isNaN(t)&&Number.MIN_SAFE_INTEGER<=t&&t<=Number.MAX_SAFE_INTEGER?t:xl.exports(String(s))}function ih(s,t,l,d){for(;l<d;){const m=s[l+d>>1];let y=l-1,w=d+1;for(;;){do y++;while(s[y]<m);do w--;while(s[w]>m);if(y>=w)break;mu(s,y,w),mu(t,3*y,3*w),mu(t,3*y+1,3*w+1),mu(t,3*y+2,3*w+2)}w-l<d-w?(ih(s,t,l,w),l=w+1):(ih(s,t,w+1,d),d=w)}}function mu(s,t,l){const d=s[t];s[t]=s[l],s[l]=d}_i(pu,"FeaturePositionMap");class Na{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,l){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,l),this.initialized=!0),!!this.location}}class gu extends Na{constructor(t){super(t),this.current=0}set(t,l,d){this.fetchUniformLocation(t,l)&&this.current!==d&&(this.current=d,this.gl.uniform1f(this.location,d))}}class Sd extends Na{constructor(t){super(t),this.current=[0,0,0,0]}set(t,l,d){this.fetchUniformLocation(t,l)&&(d[0]===this.current[0]&&d[1]===this.current[1]&&d[2]===this.current[2]&&d[3]===this.current[3]||(this.current=d,this.gl.uniform4f(this.location,d[0],d[1],d[2],d[3])))}}class Md extends Na{constructor(t){super(t),this.current=Ke.transparent}set(t,l,d){this.fetchUniformLocation(t,l)&&(d.r===this.current.r&&d.g===this.current.g&&d.b===this.current.b&&d.a===this.current.a||(this.current=d,this.gl.uniform4f(this.location,d.r,d.g,d.b,d.a)))}}const Xp=new Float32Array(16),Hp=new Float32Array(9),Wp=new Float32Array(4);function rh(s){return[Ai(255*s.r,255*s.g),Ai(255*s.b,255*s.a)]}class sc{constructor(t,l,d){this.value=t,this.uniformNames=l.map(m=>`u_${m}`),this.type=d}setUniform(t,l,d,m,y){l.set(t,y,m.constantOr(this.value))}getBinding(t,l){return this.type==="color"?new Md(t):new gu(t)}}class vl{constructor(t,l){this.uniformNames=l.map(d=>`u_${d}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(t,l){this.pixelRatioFrom=l.pixelRatio||1,this.pixelRatioTo=t.pixelRatio||1,this.patternFrom=l.tl.concat(l.br),this.patternTo=t.tl.concat(t.br)}setUniform(t,l,d,m,y){const w=y==="u_pattern_to"||y==="u_dash_to"?this.patternTo:y==="u_pattern_from"||y==="u_dash_from"?this.patternFrom:y==="u_pixel_ratio_to"?this.pixelRatioTo:y==="u_pixel_ratio_from"?this.pixelRatioFrom:null;w&&l.set(t,y,w)}getBinding(t,l){return l==="u_pattern_from"||l==="u_pattern_to"||l==="u_dash_from"||l==="u_dash_to"?new Sd(t):new gu(t)}}class Ua{constructor(t,l,d,m){this.expression=t,this.type=d,this.maxValue=0,this.paintVertexAttributes=l.map(y=>({name:`a_${y}`,type:"Float32",components:d==="color"?2:1,offset:0})),this.paintVertexArray=new m}populatePaintArray(t,l,d,m,y,w){const S=this.paintVertexArray.length,I=this.expression.evaluate(new Me(0),l,{},y,m,w);this.paintVertexArray.resize(t),this._setPaintValue(S,t,I)}updatePaintArray(t,l,d,m,y){const w=this.expression.evaluate({zoom:0},d,m,void 0,y);this._setPaintValue(t,l,w)}_setPaintValue(t,l,d){if(this.type==="color"){const m=rh(d);for(let y=t;y<l;y++)this.paintVertexArray.emplace(y,m[0],m[1])}else{for(let m=t;m<l;m++)this.paintVertexArray.emplace(m,d);this.maxValue=Math.max(this.maxValue,Math.abs(d))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Yo{constructor(t,l,d,m,y,w){this.expression=t,this.uniformNames=l.map(S=>`u_${S}_t`),this.type=d,this.useIntegerZoom=m,this.zoom=y,this.maxValue=0,this.paintVertexAttributes=l.map(S=>({name:`a_${S}`,type:"Float32",components:d==="color"?4:2,offset:0})),this.paintVertexArray=new w}populatePaintArray(t,l,d,m,y,w){const S=this.expression.evaluate(new Me(this.zoom),l,{},y,m,w),I=this.expression.evaluate(new Me(this.zoom+1),l,{},y,m,w),C=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(C,t,S,I)}updatePaintArray(t,l,d,m,y){const w=this.expression.evaluate({zoom:this.zoom},d,m,void 0,y),S=this.expression.evaluate({zoom:this.zoom+1},d,m,void 0,y);this._setPaintValue(t,l,w,S)}_setPaintValue(t,l,d,m){if(this.type==="color"){const y=rh(d),w=rh(m);for(let S=t;S<l;S++)this.paintVertexArray.emplace(S,y[0],y[1],w[0],w[1])}else{for(let y=t;y<l;y++)this.paintVertexArray.emplace(y,d,m);this.maxValue=Math.max(this.maxValue,Math.abs(d),Math.abs(m))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,l,d,m,y){const w=this.useIntegerZoom?Math.floor(d.zoom):d.zoom,S=We(this.expression.interpolationFactor(w,this.zoom,this.zoom+1),0,1);l.set(t,y,S)}getBinding(t,l){return new gu(t)}}class cs{constructor(t,l,d,m,y,w,S){this.expression=t,this.type=d,this.useIntegerZoom=m,this.zoom=y,this.layerId=S,this.paintVertexAttributes=(d==="array"?qp:Gp).members;for(let I=0;I<l.length;++I);this.zoomInPaintVertexArray=new w,this.zoomOutPaintVertexArray=new w}populatePaintArray(t,l,d){const m=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(t),this.zoomOutPaintVertexArray.resize(t),this._setPaintValues(m,t,l.patterns&&l.patterns[this.layerId],d)}updatePaintArray(t,l,d,m,y,w){this._setPaintValues(t,l,d.patterns&&d.patterns[this.layerId],w)}_setPaintValues(t,l,d,m){if(!m||!d)return;const{min:y,mid:w,max:S}=d,I=m[y],C=m[w],z=m[S];if(I&&C&&z)for(let N=t;N<l;N++)this._setPaintValue(this.zoomInPaintVertexArray,N,C,I),this._setPaintValue(this.zoomOutPaintVertexArray,N,C,z)}_setPaintValue(t,l,d,m){t.emplace(l,d.tl[0],d.tl[1],d.br[0],d.br[1],m.tl[0],m.tl[1],m.br[0],m.br[1],d.pixelRatio,m.pixelRatio)}upload(t){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=t.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=t.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class us{constructor(t,l,d=()=>!0){this.binders={},this._buffers=[];const m=[];for(const y in t.paint._values){if(!d(y))continue;const w=t.paint.get(y);if(!(w instanceof wt&&Co(w.property.specification)))continue;const S=Kp(y,t.type),I=w.value,C=w.property.specification.type,z=w.property.useIntegerZoom,N=w.property.specification["property-type"],$=N==="cross-faded"||N==="cross-faded-data-driven",Z=String(y)==="line-dasharray"&&t.layout.get("line-cap").value.kind!=="constant";if(I.kind!=="constant"||Z)if(I.kind==="source"||Z||$){const Q=Ad(y,C,"source");this.binders[y]=$?new cs(I,S,C,z,l,Q,t.id):new Ua(I,S,C,Q),m.push(`/a_${y}`)}else{const Q=Ad(y,C,"composite");this.binders[y]=new Yo(I,S,C,z,l,Q),m.push(`/z_${y}`)}else this.binders[y]=$?new vl(I.value,S):new sc(I.value,S,C),m.push(`/u_${y}`)}this.cacheKey=m.sort().join("")}getMaxValue(t){const l=this.binders[t];return l instanceof Ua||l instanceof Yo?l.maxValue:0}populatePaintArrays(t,l,d,m,y,w){for(const S in this.binders){const I=this.binders[S];(I instanceof Ua||I instanceof Yo||I instanceof cs)&&I.populatePaintArray(t,l,d,m,y,w)}}setConstantPatternPositions(t,l){for(const d in this.binders){const m=this.binders[d];m instanceof vl&&m.setConstantPatternPositions(t,l)}}updatePaintArrays(t,l,d,m,y,w){let S=!1;for(const I in t){const C=l.getPositions(I);for(const z of C){const N=d.feature(z.index);for(const $ in this.binders){const Z=this.binders[$];if((Z instanceof Ua||Z instanceof Yo||Z instanceof cs)&&Z.expression.isStateDependent===!0){const Q=m.paint.get($);Z.expression=Q.value,Z.updatePaintArray(z.start,z.end,N,t[I],y,w),S=!0}}}}return S}defines(){const t=[];for(const l in this.binders){const d=this.binders[l];(d instanceof sc||d instanceof vl)&&t.push(...d.uniformNames.map(m=>`#define HAS_UNIFORM_${m}`))}return t}getBinderAttributes(){const t=[];for(const l in this.binders){const d=this.binders[l];if(d instanceof Ua||d instanceof Yo||d instanceof cs)for(let m=0;m<d.paintVertexAttributes.length;m++)t.push(d.paintVertexAttributes[m].name)}return t}getBinderUniforms(){const t=[];for(const l in this.binders){const d=this.binders[l];if(d instanceof sc||d instanceof vl||d instanceof Yo)for(const m of d.uniformNames)t.push(m)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const l=[];for(const d in this.binders){const m=this.binders[d];if(m instanceof sc||m instanceof vl||m instanceof Yo)for(const y of m.uniformNames)l.push({name:y,property:d,binding:m.getBinding(t,y)})}return l}setUniforms(t,l,d,m,y){for(const{name:w,property:S,binding:I}of d)this.binders[S].setUniform(t,I,y,m.get(S),w)}updatePaintBuffers(t){this._buffers=[];for(const l in this.binders){const d=this.binders[l];if(t&&d instanceof cs){const m=t.fromScale===2?d.zoomInPaintVertexBuffer:d.zoomOutPaintVertexBuffer;m&&this._buffers.push(m)}else(d instanceof Ua||d instanceof Yo)&&d.paintVertexBuffer&&this._buffers.push(d.paintVertexBuffer)}}upload(t){for(const l in this.binders){const d=this.binders[l];(d instanceof Ua||d instanceof Yo||d instanceof cs)&&d.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const l=this.binders[t];(l instanceof Ua||l instanceof Yo||l instanceof cs)&&l.destroy()}}}class $s{constructor(t,l,d=()=>!0){this.programConfigurations={};for(const m of t)this.programConfigurations[m.id]=new us(m,l,d);this.needsUpload=!1,this._featureMap=new pu,this._bufferOffset=0}populatePaintArrays(t,l,d,m,y,w,S){for(const I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(t,l,m,y,w,S);l.id!==void 0&&this._featureMap.add(l.id,d,this._bufferOffset,t),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,l,d,m,y){for(const w of d)this.needsUpload=this.programConfigurations[w.id].updatePaintArrays(t,this._featureMap,l,w,m,y)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const l in this.programConfigurations)this.programConfigurations[l].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const Yp={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function Kp(s,t){return Yp[s]||[s.replace(`${t}-`,"").replace(/-/g,"_")]}const Qp={"line-pattern":{source:Rn,composite:Rn},"fill-pattern":{source:Rn,composite:Rn},"fill-extrusion-pattern":{source:Rn,composite:Rn},"line-dasharray":{source:Po,composite:Po}},Jp={color:{source:fu,composite:fn},number:{source:xn,composite:fu}};function Ad(s,t,l){const d=Qp[s];return d&&d[l]||Jp[t][l]}_i(sc,"ConstantBinder"),_i(vl,"CrossFadedConstantBinder"),_i(Ua,"SourceExpressionBinder"),_i(cs,"CrossFadedCompositeBinder"),_i(Yo,"CompositeExpressionBinder"),_i(us,"ProgramConfiguration",{omit:["_buffers"]}),_i($s,"ProgramConfigurationSet");const _u="-transition";class Ko extends sr{constructor(t,l){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,t.type!=="custom"&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type!=="background"&&t.type!=="sky"&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),l.layout&&(this._unevaluatedLayout=new He(l.layout)),l.paint)){this._transitionablePaint=new lt(l.paint);for(const d in t.paint)this.setPaintProperty(d,t.paint[d],{validate:!1});for(const d in t.layout)this.setLayoutProperty(d,t.layout[d],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new bt(l.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,l,d={}){l!=null&&this._validate(eh,`layers.${this.id}.layout.${t}`,t,l,d)||(t!=="visibility"?this._unevaluatedLayout.setValue(t,l):this.visibility=l)}getPaintProperty(t){return Ct(t,_u)?this._transitionablePaint.getTransition(t.slice(0,-_u.length)):this._transitionablePaint.getValue(t)}setPaintProperty(t,l,d={}){if(l!=null&&this._validate(Ju,`layers.${this.id}.paint.${t}`,t,l,d))return!1;if(Ct(t,_u))return this._transitionablePaint.setTransition(t.slice(0,-_u.length),l||void 0),!1;{const m=this._transitionablePaint._values[t],y=m.property.specification["property-type"]==="cross-faded-data-driven",w=m.value.isDataDriven(),S=m.value;this._transitionablePaint.setValue(t,l),this._handleSpecialPaintPropertyUpdate(t);const I=this._transitionablePaint._values[t].value;return I.isDataDriven()||w||y||this._handleOverridablePaintPropertyUpdate(t,S,I)}}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getProgramConfiguration(t){return null}_handleOverridablePaintPropertyUpdate(t,l,d){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,l){t.getCrossfadeParameters&&(this._crossfadeParameters=t.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,l)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,l)}serialize(){const t={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(t.layout=t.layout||{},t.layout.visibility=this.visibility),yt(t,(l,d)=>!(l===void 0||d==="layout"&&!Object.keys(l).length||d==="paint"&&!Object.keys(l).length))}_validate(t,l,d,m,y={}){return(!y||y.validate!==!1)&&ec(this,t.call(Qc,{key:l,layerType:this.type,objectKey:d,value:m,styleSpec:it,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const t in this.paint._values){const l=this.paint.get(t);if(l instanceof wt&&Co(l.property.specification)&&(l.value.kind==="source"||l.value.kind==="composite")&&l.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=al(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const em=Wt([{name:"a_pos",components:2,type:"Int16"}],4),tm=Wt([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class sn{constructor(t=[]){this.segments=t}prepareSegment(t,l,d,m){let y=this.segments[this.segments.length-1];return t>sn.MAX_VERTEX_ARRAY_LENGTH&&yi(`Max vertices per segment is ${sn.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!y||y.vertexLength+t>sn.MAX_VERTEX_ARRAY_LENGTH||y.sortKey!==m)&&(y={vertexOffset:l.length,primitiveOffset:d.length,vertexLength:0,primitiveLength:0},m!==void 0&&(y.sortKey=m),this.segments.push(y)),y}get(){return this.segments}destroy(){for(const t of this.segments)for(const l in t.vaos)t.vaos[l].destroy()}static simpleSegment(t,l,d,m){return new sn([{vertexOffset:t,primitiveOffset:l,vertexLength:d,primitiveLength:m,vaos:{},sortKey:0}])}}sn.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,_i(sn,"SegmentVector");var Gi=8192;class hs{constructor(t,l){t&&(l?this.setSouthWest(t).setNorthEast(l):t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof _r?new _r(t.lng,t.lat):_r.convert(t),this}setSouthWest(t){return this._sw=t instanceof _r?new _r(t.lng,t.lat):_r.convert(t),this}extend(t){const l=this._sw,d=this._ne;let m,y;if(t instanceof _r)m=t,y=t;else{if(!(t instanceof hs))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(hs.convert(t)):this.extend(_r.convert(t)):typeof t=="object"&&t!==null&&t.hasOwnProperty("lat")&&t.hasOwnProperty("lon")?this.extend(_r.convert(t)):this;if(m=t._sw,y=t._ne,!m||!y)return this}return l||d?(l.lng=Math.min(m.lng,l.lng),l.lat=Math.min(m.lat,l.lat),d.lng=Math.max(y.lng,d.lng),d.lat=Math.max(y.lat,d.lat)):(this._sw=new _r(m.lng,m.lat),this._ne=new _r(y.lng,y.lat)),this}getCenter(){return new _r((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new _r(this.getWest(),this.getNorth())}getSouthEast(){return new _r(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:l,lat:d}=_r.convert(t);let m=this._sw.lng<=l&&l<=this._ne.lng;return this._sw.lng>this._ne.lng&&(m=this._sw.lng>=l&&l>=this._ne.lng),this._sw.lat<=d&&d<=this._ne.lat&&m}static convert(t){return!t||t instanceof hs?t:new hs(t)}}const yu=63710088e-1;class _r{constructor(t,l){if(isNaN(t)||isNaN(l))throw new Error(`Invalid LngLat object: (${t}, ${l})`);if(this.lng=+t,this.lat=+l,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new _r(ti(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const l=Math.PI/180,d=this.lat*l,m=t.lat*l,y=Math.sin(d)*Math.sin(m)+Math.cos(d)*Math.cos(m)*Math.cos((t.lng-this.lng)*l);return yu*Math.acos(Math.min(y,1))}toBounds(t=0){const l=360*t/40075017,d=l/Math.cos(Math.PI/180*this.lat);return new hs(new _r(this.lng-d,this.lat-l),new _r(this.lng+d,this.lat+l))}static convert(t){if(t instanceof _r)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new _r(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new _r(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const Id=2*Math.PI*yu;function nh(s){return Id*Math.cos(s*Math.PI/180)}function xa(s){return(180+s)/360}function va(s){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+s*Math.PI/360)))/360}function Bo(s,t){return s/nh(t)}function wo(s){return 360*s-180}function An(s){return 360/Math.PI*Math.atan(Math.exp((180-360*s)*Math.PI/180))-90}function Cd(s,t){return s*nh(An(t))}const ba=85.051129;function kd(s){return 1/Math.cos(s*Math.PI/180)}class bl{constructor(t,l,d=0){this.x=+t,this.y=+l,this.z=+d}static fromLngLat(t,l=0){const d=_r.convert(t);return new bl(xa(d.lng),va(d.lat),Bo(l,d.lat))}toLngLat(){return new _r(wo(this.x),An(this.y))}toAltitude(){return Cd(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Id*kd(An(this.y))}}function oh(s,t,l,d,m,y,w,S,I){const C=(t+d)/2,z=(l+m)/2,N=new J(C,z);S(N),function($,Z,Q,re,ue,Se){const Le=Q-ue,Te=re-Se;return Math.abs((re-Z)*Le-(Q-$)*Te)/Math.hypot(Le,Te)}(N.x,N.y,y.x,y.y,w.x,w.y)>=I?(oh(s,t,l,C,z,y,N,S,I),oh(s,C,z,d,m,N,w,S,I)):s.push(w)}function Pd(s,t,l){let d=s[0],m=d.x,y=d.y;t(d);const w=[d];for(let S=1;S<s.length;S++){const I=s[S],{x:C,y:z}=I;t(I),oh(w,m,y,C,z,d,I,t,l),m=C,y=z,d=I}return w}function ah(s,t,l,d){if(d(t,l)){const m=t.add(l)._mult(.5);ah(s,t,m,d),ah(s,m,l,d)}else s.push(l)}function im(s,t){let l=s[0];const d=[l];for(let m=1;m<s.length;m++){const y=s[m];ah(d,l,y,t),l=y}return d}const sh=Math.pow(2,14)-1,Dd=-sh-1;function rm(s,t){const l=Math.round(s.x*t),d=Math.round(s.y*t);return s.x=We(l,Dd,sh),s.y=We(d,Dd,sh),(l<s.x||l>s.x+1||d<s.y||d>s.y+1)&&yi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),s}function $a(s,t,l){const d=s.loadGeometry(),m=s.extent,y=Gi/m;if(t&&l&&l.projection.isReprojectedInTileSpace){const w=1<<t.z,{scale:S,x:I,y:C,projection:z}=l,N=$=>{const Z=wo((t.x+$.x/m)/w),Q=An((t.y+$.y/m)/w),re=z.project(Z,Q);$.x=(re.x*S-I)*m,$.y=(re.y*S-C)*m};for(let $=0;$<d.length;$++)if(s.type!==1)d[$]=Pd(d[$],N,1);else{const Z=[];for(const Q of d[$])Q.x<0||Q.x>=m||Q.y<0||Q.y>=m||(N(Q),Z.push(Q));d[$]=Z}}for(const w of d)for(const S of w)rm(S,y);return d}function Vs(s,t){return{type:s.type,id:s.id,properties:s.properties,geometry:t?$a(s):[]}}function xu(s,t,l,d,m){s.emplaceBack(2*t+(d+1)/2,2*l+(m+1)/2)}function vu(s,t,l){s.emplaceBack(t.x,t.y,t.z,l[0]*16384,l[1]*16384,l[2]*16384)}class lh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(l=>l.id),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new er,this.indexArray=new Ln,this.segments=new sn,this.programConfigurations=new $s(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id)}populate(t,l,d,m){const y=this.layers[0],w=[];let S=null;y.type==="circle"&&(S=y.layout.get("circle-sort-key"));for(const{feature:C,id:z,index:N,sourceLayerIndex:$}of t){const Z=this.layers[0]._featureFilter.needGeometry,Q=Vs(C,Z);if(!this.layers[0]._featureFilter.filter(new Me(this.zoom),Q,d))continue;const re=S?S.evaluate(Q,{},d):void 0,ue={id:z,properties:C.properties,type:C.type,sourceLayerIndex:$,index:N,geometry:Z?Q.geometry:$a(C,d,m),patterns:{},sortKey:re};w.push(ue)}S&&w.sort((C,z)=>C.sortKey-z.sortKey);let I=null;m.projection.name==="globe"&&(this.globeExtVertexArray=new vd,I=m.projection);for(const C of w){const{geometry:z,index:N,sourceLayerIndex:$}=C,Z=t[N].feature;this.addFeature(C,z,N,l.availableImages,d,I),l.featureIndex.insert(Z,z,N,$,this.index)}}update(t,l,d,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,l,this.stateDependentLayers,d,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,em.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,tm.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(t,l,d,m,y,w){for(const S of l)for(const I of S){const C=I.x,z=I.y;if(C<0||C>=Gi||z<0||z>=Gi)continue;if(w){const Z=w.projectTilePoint(C,z,y),Q=w.upVector(y,C,z),re=this.globeExtVertexArray;vu(re,Z,Q),vu(re,Z,Q),vu(re,Z,Q),vu(re,Z,Q)}const N=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),$=N.vertexLength;xu(this.layoutVertexArray,C,z,-1,-1),xu(this.layoutVertexArray,C,z,1,-1),xu(this.layoutVertexArray,C,z,1,1),xu(this.layoutVertexArray,C,z,-1,1),this.indexArray.emplaceBack($,$+1,$+2),this.indexArray.emplaceBack($,$+2,$+3),N.vertexLength+=4,N.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,d,{},m,y)}}function Bd(s,t){for(let l=0;l<s.length;l++)if(js(t,s[l]))return!0;for(let l=0;l<t.length;l++)if(js(s,t[l]))return!0;return!!ch(s,t)}function nm(s,t,l){return!!js(s,t)||!!uh(t,s,l)}function Rd(s,t){if(s.length===1)return zd(t,s[0]);for(let l=0;l<t.length;l++){const d=t[l];for(let m=0;m<d.length;m++)if(js(s,d[m]))return!0}for(let l=0;l<s.length;l++)if(zd(t,s[l]))return!0;for(let l=0;l<t.length;l++)if(ch(s,t[l]))return!0;return!1}function om(s,t,l){if(s.length>1){if(ch(s,t))return!0;for(let d=0;d<t.length;d++)if(uh(t[d],s,l))return!0}for(let d=0;d<s.length;d++)if(uh(s[d],t,l))return!0;return!1}function ch(s,t){if(s.length===0||t.length===0)return!1;for(let l=0;l<s.length-1;l++){const d=s[l],m=s[l+1];for(let y=0;y<t.length-1;y++)if(am(d,m,t[y],t[y+1]))return!0}return!1}function am(s,t,l,d){return mi(s,l,d)!==mi(t,l,d)&&mi(s,t,l)!==mi(s,t,d)}function uh(s,t,l){const d=l*l;if(t.length===1)return s.distSqr(t[0])<d;for(let m=1;m<t.length;m++)if(Ld(s,t[m-1],t[m])<d)return!0;return!1}function Ld(s,t,l){const d=t.distSqr(l);if(d===0)return s.distSqr(t);const m=((s.x-t.x)*(l.x-t.x)+(s.y-t.y)*(l.y-t.y))/d;return s.distSqr(m<0?t:m>1?l:l.sub(t)._mult(m)._add(t))}function zd(s,t){let l,d,m,y=!1;for(let w=0;w<s.length;w++){l=s[w];for(let S=0,I=l.length-1;S<l.length;I=S++)d=l[S],m=l[I],d.y>t.y!=m.y>t.y&&t.x<(m.x-d.x)*(t.y-d.y)/(m.y-d.y)+d.x&&(y=!y)}return y}function js(s,t){let l=!1;for(let d=0,m=s.length-1;d<s.length;m=d++){const y=s[d],w=s[m];y.y>t.y!=w.y>t.y&&t.x<(w.x-y.x)*(t.y-y.y)/(w.y-y.y)+y.x&&(l=!l)}return l}function Od(s,t,l,d,m){for(const w of s)if(t<=w.x&&l<=w.y&&d>=w.x&&m>=w.y)return!0;const y=[new J(t,l),new J(t,m),new J(d,m),new J(d,l)];if(s.length>2){for(const w of y)if(js(s,w))return!0}for(let w=0;w<s.length-1;w++)if(sm(s[w],s[w+1],y))return!0;return!1}function sm(s,t,l){const d=l[0],m=l[2];if(s.x<d.x&&t.x<d.x||s.x>m.x&&t.x>m.x||s.y<d.y&&t.y<d.y||s.y>m.y&&t.y>m.y)return!1;const y=mi(s,t,l[0]);return y!==mi(s,t,l[1])||y!==mi(s,t,l[2])||y!==mi(s,t,l[3])}function wl(s,t,l){const d=t.paint.get(s).value;return d.kind==="constant"?d.value:l.programConfigurations.get(t.id).getMaxValue(s)}function bu(s){return Math.sqrt(s[0]*s[0]+s[1]*s[1])}function Fd(s,t,l,d,m){if(!t[0]&&!t[1])return s;const y=J.convert(t)._mult(m);l==="viewport"&&y._rotate(-d);const w=[];for(let S=0;S<s.length;S++)w.push(s[S].sub(y));return w}function Nd(s,t,l,d){const m=J.convert(s)._mult(d);return t==="viewport"&&m._rotate(-l),m}_i(lh,"CircleBucket",{omit:["layers"]});const lm=new Ht({"circle-sort-key":new Ve(it.layout_circle["circle-sort-key"])});var cm={paint:new Ht({"circle-radius":new Ve(it.paint_circle["circle-radius"]),"circle-color":new Ve(it.paint_circle["circle-color"]),"circle-blur":new Ve(it.paint_circle["circle-blur"]),"circle-opacity":new Ve(it.paint_circle["circle-opacity"]),"circle-translate":new tt(it.paint_circle["circle-translate"]),"circle-translate-anchor":new tt(it.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new tt(it.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new tt(it.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ve(it.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ve(it.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ve(it.paint_circle["circle-stroke-opacity"])}),layout:lm},wu=1e-6,so=typeof Float32Array<"u"?Float32Array:Array;function Ud(){var s=new so(9);return so!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s}function $d(s,t,l){var d=t[0],m=t[1],y=t[2],w=t[3],S=t[4],I=t[5],C=t[6],z=t[7],N=t[8],$=l[0],Z=l[1],Q=l[2],re=l[3],ue=l[4],Se=l[5],Le=l[6],Te=l[7],Ce=l[8];return s[0]=$*d+Z*w+Q*C,s[1]=$*m+Z*S+Q*z,s[2]=$*y+Z*I+Q*N,s[3]=re*d+ue*w+Se*C,s[4]=re*m+ue*S+Se*z,s[5]=re*y+ue*I+Se*N,s[6]=Le*d+Te*w+Ce*C,s[7]=Le*m+Te*S+Ce*z,s[8]=Le*y+Te*I+Ce*N,s}function wa(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function hh(s,t){var l=t[0],d=t[1],m=t[2],y=t[3],w=t[4],S=t[5],I=t[6],C=t[7],z=t[8],N=t[9],$=t[10],Z=t[11],Q=t[12],re=t[13],ue=t[14],Se=t[15],Le=l*S-d*w,Te=l*I-m*w,Ce=l*C-y*w,Ne=d*I-m*S,Oe=d*C-y*S,st=m*C-y*I,rt=z*re-N*Q,mt=z*ue-$*Q,Ft=z*Se-Z*Q,ct=N*ue-$*re,Et=N*Se-Z*re,Mt=$*Se-Z*ue,Lt=Le*Mt-Te*Et+Ce*ct+Ne*Ft-Oe*mt+st*rt;return Lt?(s[0]=(S*Mt-I*Et+C*ct)*(Lt=1/Lt),s[1]=(m*Et-d*Mt-y*ct)*Lt,s[2]=(re*st-ue*Oe+Se*Ne)*Lt,s[3]=($*Oe-N*st-Z*Ne)*Lt,s[4]=(I*Ft-w*Mt-C*mt)*Lt,s[5]=(l*Mt-m*Ft+y*mt)*Lt,s[6]=(ue*Ce-Q*st-Se*Te)*Lt,s[7]=(z*st-$*Ce+Z*Te)*Lt,s[8]=(w*Et-S*Ft+C*rt)*Lt,s[9]=(d*Ft-l*Et-y*rt)*Lt,s[10]=(Q*Oe-re*Ce+Se*Le)*Lt,s[11]=(N*Ce-z*Oe-Z*Le)*Lt,s[12]=(S*mt-w*ct-I*rt)*Lt,s[13]=(l*ct-d*mt+m*rt)*Lt,s[14]=(re*Te-Q*Ne-ue*Le)*Lt,s[15]=(z*Ne-N*Te+$*Le)*Lt,s):null}function El(s,t,l){var d=t[0],m=t[1],y=t[2],w=t[3],S=t[4],I=t[5],C=t[6],z=t[7],N=t[8],$=t[9],Z=t[10],Q=t[11],re=t[12],ue=t[13],Se=t[14],Le=t[15],Te=l[0],Ce=l[1],Ne=l[2],Oe=l[3];return s[0]=Te*d+Ce*S+Ne*N+Oe*re,s[1]=Te*m+Ce*I+Ne*$+Oe*ue,s[2]=Te*y+Ce*C+Ne*Z+Oe*Se,s[3]=Te*w+Ce*z+Ne*Q+Oe*Le,s[4]=(Te=l[4])*d+(Ce=l[5])*S+(Ne=l[6])*N+(Oe=l[7])*re,s[5]=Te*m+Ce*I+Ne*$+Oe*ue,s[6]=Te*y+Ce*C+Ne*Z+Oe*Se,s[7]=Te*w+Ce*z+Ne*Q+Oe*Le,s[8]=(Te=l[8])*d+(Ce=l[9])*S+(Ne=l[10])*N+(Oe=l[11])*re,s[9]=Te*m+Ce*I+Ne*$+Oe*ue,s[10]=Te*y+Ce*C+Ne*Z+Oe*Se,s[11]=Te*w+Ce*z+Ne*Q+Oe*Le,s[12]=(Te=l[12])*d+(Ce=l[13])*S+(Ne=l[14])*N+(Oe=l[15])*re,s[13]=Te*m+Ce*I+Ne*$+Oe*ue,s[14]=Te*y+Ce*C+Ne*Z+Oe*Se,s[15]=Te*w+Ce*z+Ne*Q+Oe*Le,s}function lc(s,t,l){var d,m,y,w,S,I,C,z,N,$,Z,Q,re=l[0],ue=l[1],Se=l[2];return t===s?(s[12]=t[0]*re+t[4]*ue+t[8]*Se+t[12],s[13]=t[1]*re+t[5]*ue+t[9]*Se+t[13],s[14]=t[2]*re+t[6]*ue+t[10]*Se+t[14],s[15]=t[3]*re+t[7]*ue+t[11]*Se+t[15]):(m=t[1],y=t[2],w=t[3],S=t[4],I=t[5],C=t[6],z=t[7],N=t[8],$=t[9],Z=t[10],Q=t[11],s[0]=d=t[0],s[1]=m,s[2]=y,s[3]=w,s[4]=S,s[5]=I,s[6]=C,s[7]=z,s[8]=N,s[9]=$,s[10]=Z,s[11]=Q,s[12]=d*re+S*ue+N*Se+t[12],s[13]=m*re+I*ue+$*Se+t[13],s[14]=y*re+C*ue+Z*Se+t[14],s[15]=w*re+z*ue+Q*Se+t[15]),s}function Gs(s,t,l){var d=l[0],m=l[1],y=l[2];return s[0]=t[0]*d,s[1]=t[1]*d,s[2]=t[2]*d,s[3]=t[3]*d,s[4]=t[4]*m,s[5]=t[5]*m,s[6]=t[6]*m,s[7]=t[7]*m,s[8]=t[8]*y,s[9]=t[9]*y,s[10]=t[10]*y,s[11]=t[11]*y,s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],s}function dh(s,t,l){var d=Math.sin(l),m=Math.cos(l),y=t[4],w=t[5],S=t[6],I=t[7],C=t[8],z=t[9],N=t[10],$=t[11];return t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s[4]=y*m+C*d,s[5]=w*m+z*d,s[6]=S*m+N*d,s[7]=I*m+$*d,s[8]=C*m-y*d,s[9]=z*m-w*d,s[10]=N*m-S*d,s[11]=$*m-I*d,s}function Eu(s,t,l){var d=Math.sin(l),m=Math.cos(l),y=t[0],w=t[1],S=t[2],I=t[3],C=t[8],z=t[9],N=t[10],$=t[11];return t!==s&&(s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s[0]=y*m-C*d,s[1]=w*m-z*d,s[2]=S*m-N*d,s[3]=I*m-$*d,s[8]=y*d+C*m,s[9]=w*d+z*m,s[10]=S*d+N*m,s[11]=I*d+$*m,s}function Vd(s,t){return s[0]=t[0],s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=t[1],s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=t[2],s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function jd(s,t,l){var d,m,y,w=l[0],S=l[1],I=l[2],C=Math.hypot(w,S,I);return C<wu?null:(w*=C=1/C,S*=C,I*=C,d=Math.sin(t),m=Math.cos(t),s[0]=w*w*(y=1-m)+m,s[1]=S*w*y+I*d,s[2]=I*w*y-S*d,s[3]=0,s[4]=w*S*y-I*d,s[5]=S*S*y+m,s[6]=I*S*y+w*d,s[7]=0,s[8]=w*I*y+S*d,s[9]=S*I*y-w*d,s[10]=I*I*y+m,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s)}Math.hypot||(Math.hypot=function(){for(var s=0,t=arguments.length;t--;)s+=arguments[t]*arguments[t];return Math.sqrt(s)});var um=El;function fh(){var s=new so(3);return so!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function Gd(s){var t=new so(3);return t[0]=s[0],t[1]=s[1],t[2]=s[2],t}function cc(s){return Math.hypot(s[0],s[1],s[2])}function Tl(s,t,l){var d=new so(3);return d[0]=s,d[1]=t,d[2]=l,d}function Va(s,t,l){return s[0]=t[0]+l[0],s[1]=t[1]+l[1],s[2]=t[2]+l[2],s}function ph(s,t,l){return s[0]=t[0]-l[0],s[1]=t[1]-l[1],s[2]=t[2]-l[2],s}function qd(s,t,l){return s[0]=t[0]*l[0],s[1]=t[1]*l[1],s[2]=t[2]*l[2],s}function uc(s,t,l){return s[0]=Math.min(t[0],l[0]),s[1]=Math.min(t[1],l[1]),s[2]=Math.min(t[2],l[2]),s}function hc(s,t,l){return s[0]=Math.max(t[0],l[0]),s[1]=Math.max(t[1],l[1]),s[2]=Math.max(t[2],l[2]),s}function Eo(s,t,l){return s[0]=t[0]*l,s[1]=t[1]*l,s[2]=t[2]*l,s}function dc(s,t,l,d){return s[0]=t[0]+l[0]*d,s[1]=t[1]+l[1]*d,s[2]=t[2]+l[2]*d,s}function Gn(s,t){var l=t[0],d=t[1],m=t[2],y=l*l+d*d+m*m;return y>0&&(y=1/Math.sqrt(y)),s[0]=t[0]*y,s[1]=t[1]*y,s[2]=t[2]*y,s}function Ro(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]}function mh(s,t,l){var d=t[0],m=t[1],y=t[2],w=l[0],S=l[1],I=l[2];return s[0]=m*I-y*S,s[1]=y*w-d*I,s[2]=d*S-m*w,s}function ln(s,t,l){var d=t[0],m=t[1],y=t[2],w=l[3]*d+l[7]*m+l[11]*y+l[15];return s[0]=(l[0]*d+l[4]*m+l[8]*y+l[12])/(w=w||1),s[1]=(l[1]*d+l[5]*m+l[9]*y+l[13])/w,s[2]=(l[2]*d+l[6]*m+l[10]*y+l[14])/w,s}function Zd(s,t,l){var d=l[0],m=l[1],y=l[2],w=t[0],S=t[1],I=t[2],C=m*I-y*S,z=y*w-d*I,N=d*S-m*w,$=m*N-y*z,Z=y*C-d*N,Q=d*z-m*C,re=2*l[3];return z*=re,N*=re,Z*=2,Q*=2,s[0]=w+(C*=re)+($*=2),s[1]=S+z+Z,s[2]=I+N+Q,s}var fc,Qo=ph,hm=qd,dm=cc;function Xd(s,t,l){return s[0]=t[0]*l,s[1]=t[1]*l,s[2]=t[2]*l,s[3]=t[3]*l,s}function Hd(s,t){var l=t[0],d=t[1],m=t[2],y=t[3],w=l*l+d*d+m*m+y*y;return w>0&&(w=1/Math.sqrt(w)),s[0]=l*w,s[1]=d*w,s[2]=m*w,s[3]=y*w,s}function qs(s,t,l){var d=t[0],m=t[1],y=t[2],w=t[3];return s[0]=l[0]*d+l[4]*m+l[8]*y+l[12]*w,s[1]=l[1]*d+l[5]*m+l[9]*y+l[13]*w,s[2]=l[2]*d+l[6]*m+l[10]*y+l[14]*w,s[3]=l[3]*d+l[7]*m+l[11]*y+l[15]*w,s}function Wd(){var s=new so(4);return so!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s[3]=1,s}function Yd(s){return s[0]=0,s[1]=0,s[2]=0,s[3]=1,s}function Kd(s,t,l){l*=.5;var d=t[0],m=t[1],y=t[2],w=t[3],S=Math.sin(l),I=Math.cos(l);return s[0]=d*I+w*S,s[1]=m*I+y*S,s[2]=y*I-m*S,s[3]=w*I-d*S,s}function Qd(s,t,l){l*=.5;var d=t[0],m=t[1],y=t[2],w=t[3],S=Math.sin(l),I=Math.cos(l);return s[0]=d*I-y*S,s[1]=m*I+w*S,s[2]=y*I+d*S,s[3]=w*I-m*S,s}fh(),fc=new so(4),so!=Float32Array&&(fc[0]=0,fc[1]=0,fc[2]=0,fc[3]=0);var fm=Hd;fh(),Tl(1,0,0),Tl(0,1,0),Wd(),Wd(),Ud();class gh{constructor(t,l){this.pos=t,this.dir=l}intersectsPlane(t,l,d){const m=Ro(l,this.dir);if(Math.abs(m)<1e-6)return!1;const y=((t[0]-this.pos[0])*l[0]+(t[1]-this.pos[1])*l[1]+(t[2]-this.pos[2])*l[2])/m;return d[0]=this.pos[0]+this.dir[0]*y,d[1]=this.pos[1]+this.dir[1]*y,d[2]=this.pos[2]+this.dir[2]*y,!0}closestPointOnSphere(t,l,d){if(function(Z,Q){var re=Z[0],ue=Z[1],Se=Z[2],Le=Q[0],Te=Q[1],Ce=Q[2];return Math.abs(re-Le)<=wu*Math.max(1,Math.abs(re),Math.abs(Le))&&Math.abs(ue-Te)<=wu*Math.max(1,Math.abs(ue),Math.abs(Te))&&Math.abs(Se-Ce)<=wu*Math.max(1,Math.abs(Se),Math.abs(Ce))}(this.pos,t)||l===0)return d[0]=d[1]=d[2]=0,!1;const[m,y,w]=this.dir,S=this.pos[0]-t[0],I=this.pos[1]-t[1],C=this.pos[2]-t[2],z=m*m+y*y+w*w,N=2*(S*m+I*y+C*w),$=N*N-4*z*(S*S+I*I+C*C-l*l);if($<0){const Z=Math.max(-N/2,0),Q=S+m*Z,re=I+y*Z,ue=C+w*Z,Se=Math.hypot(Q,re,ue);return d[0]=Q*l/Se,d[1]=re*l/Se,d[2]=ue*l/Se,!1}{const Z=(-N-Math.sqrt($))/(2*z);if(Z<0){const Q=Math.hypot(S,I,C);return d[0]=S*l/Q,d[1]=I*l/Q,d[2]=C*l/Q,!1}return d[0]=S+m*Z,d[1]=I+y*Z,d[2]=C+w*Z,!0}}}class _h{constructor(t,l,d,m,y){this.TL=t,this.TR=l,this.BR=d,this.BL=m,this.horizon=y}static fromInvProjectionMatrix(t,l,d){const m=[-1,1,1],y=[1,1,1],w=[1,-1,1],S=[-1,-1,1],I=ln(m,m,t),C=ln(y,y,t),z=ln(w,w,t),N=ln(S,S,t);return new _h(I,C,z,N,l/d)}}class yh{constructor(t,l){this.points=t,this.planes=l}static fromInvProjectionMatrix(t,l,d,m){const y=Math.pow(2,d),w=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(I=>{const C=qs([],I,t),z=1/C[3]/l*y;return function(N,$,Z){return N[0]=$[0]*Z[0],N[1]=$[1]*Z[1],N[2]=$[2]*Z[2],N[3]=$[3]*Z[3],N}(C,C,[z,z,m?1/C[3]:z,z])}),S=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(I=>{const C=Gn([],mh([],Qo([],w[I[0]],w[I[1]]),Qo([],w[I[2]],w[I[1]]))),z=-Ro(C,w[I[1]]);return C.concat(z)});return new yh(w,S)}}class qn{static fromPoints(t){const l=[1/0,1/0,1/0],d=[-1/0,-1/0,-1/0];for(const m of t)uc(l,l,m),hc(d,d,m);return new qn(l,d)}static applyTransform(t,l){const d=t.getCorners();for(let m=0;m<d.length;++m)ln(d[m],d[m],l);return qn.fromPoints(d)}constructor(t,l){this.min=t,this.max=l,this.center=Eo([],Va([],this.min,this.max),.5)}quadrant(t){const l=[t%2==0,t<2],d=Gd(this.min),m=Gd(this.max);for(let y=0;y<l.length;y++)d[y]=l[y]?this.min[y]:this.center[y],m[y]=l[y]?this.center[y]:this.max[y];return m[2]=this.max[2],new qn(d,m)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,l=this.max;return[[t[0],t[1],t[2]],[l[0],t[1],t[2]],[l[0],l[1],t[2]],[t[0],l[1],t[2]],[t[0],t[1],l[2]],[l[0],t[1],l[2]],[l[0],l[1],l[2]],[t[0],l[1],l[2]]]}intersects(t){const l=this.getCorners();let d=!0;for(let m=0;m<t.planes.length;m++){const y=t.planes[m];let w=0;for(let S=0;S<l.length;S++)w+=Ro(y,l[S])+y[3]>=0;if(w===0)return 0;w!==l.length&&(d=!1)}if(d)return 2;for(let m=0;m<3;m++){let y=Number.MAX_VALUE,w=-Number.MAX_VALUE;for(let S=0;S<t.points.length;S++){const I=t.points[S][m]-this.min[m];y=Math.min(y,I),w=Math.max(w,I)}if(w<0||y>this.max[m]-this.min[m])return 0}return 1}}function Jd(s,t,l,d,m,y,w,S,I){if(y&&s.queryGeometry.isAboveHorizon)return!1;y&&(I*=s.pixelToTileUnitsFactor);const C=s.tileID.canonical,z=l.projection.upVectorScale(C,l.center.lat,l.worldSize).metersToTile;for(const N of t)for(const $ of N){const Z=$.add(S),Q=m&&l.elevation?l.elevation.exaggeration()*m.getElevationAt(Z.x,Z.y,!0):0,re=l.projection.projectTilePoint(Z.x,Z.y,C);if(Q>0){const Te=l.projection.upVector(C,Z.x,Z.y);re.x+=Te[0]*z*Q,re.y+=Te[1]*z*Q,re.z+=Te[2]*z*Q}const ue=y?Z:pm(re.x,re.y,re.z,d),Se=y?s.tilespaceRays.map(Te=>gm(Te,Q)):s.queryGeometry.screenGeometry,Le=qs([],[re.x,re.y,re.z,1],d);if(!w&&y?I*=Le[3]/l.cameraToCenterDistance:w&&!y&&(I*=l.cameraToCenterDistance/Le[3]),y){const Te=An(($.y/Gi+C.y)/(1<<C.z));I/=l.projection.pixelsPerMeter(Te,1)/Bo(1,Te)}if(nm(Se,ue,I))return!0}return!1}function pm(s,t,l,d){const m=qs([],[s,t,l,1],d);return new J(m[0]/m[3],m[1]/m[3])}const ef=Tl(0,0,0),mm=Tl(0,0,1);function gm(s,t){const l=fh();return ef[2]=t,s.intersectsPlane(ef,mm,l),new J(l[0],l[1])}class tf extends lh{}function rf(s,{width:t,height:l},d,m){if(m){if(m instanceof Uint8ClampedArray)m=new Uint8Array(m.buffer);else if(m.length!==t*l*d)throw new RangeError("mismatched image size")}else m=new Uint8Array(t*l*d);return s.width=t,s.height=l,s.data=m,s}function nf(s,t,l){const{width:d,height:m}=t;d===s.width&&m===s.height||(xh(s,t,{x:0,y:0},{x:0,y:0},{width:Math.min(s.width,d),height:Math.min(s.height,m)},l),s.width=d,s.height=m,s.data=t.data)}function xh(s,t,l,d,m,y){if(m.width===0||m.height===0)return t;if(m.width>s.width||m.height>s.height||l.x>s.width-m.width||l.y>s.height-m.height)throw new RangeError("out of range source coordinates for image copy");if(m.width>t.width||m.height>t.height||d.x>t.width-m.width||d.y>t.height-m.height)throw new RangeError("out of range destination coordinates for image copy");const w=s.data,S=t.data;for(let I=0;I<m.height;I++){const C=((l.y+I)*s.width+l.x)*y,z=((d.y+I)*t.width+d.x)*y;for(let N=0;N<m.width*y;N++)S[z+N]=w[C+N]}return t}_i(tf,"HeatmapBucket",{omit:["layers"]});class ja{constructor(t,l){rf(this,t,1,l)}resize(t){nf(this,new ja(t),1)}clone(){return new ja({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,l,d,m,y){xh(t,l,d,m,y,1)}}class lo{constructor(t,l){rf(this,t,4,l)}resize(t){nf(this,new lo(t),4)}replace(t,l){l?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new lo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,l,d,m,y){xh(t,l,d,m,y,4)}}_i(ja,"AlphaImage"),_i(lo,"RGBAImage");var _m={paint:new Ht({"heatmap-radius":new Ve(it.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ve(it.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new tt(it.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Jt(it.paint_heatmap["heatmap-color"]),"heatmap-opacity":new tt(it.paint_heatmap["heatmap-opacity"])})};function vh(s){const t={},l=s.resolution||256,d=s.clips?s.clips.length:1,m=s.image||new lo({width:l,height:d}),y=(w,S,I)=>{t[s.evaluationKey]=I;const C=s.expression.evaluate(t);m.data[w+S+0]=Math.floor(255*C.r/C.a),m.data[w+S+1]=Math.floor(255*C.g/C.a),m.data[w+S+2]=Math.floor(255*C.b/C.a),m.data[w+S+3]=Math.floor(255*C.a)};if(s.clips)for(let w=0,S=0;w<d;++w,S+=4*l)for(let I=0,C=0;I<l;I++,C+=4){const z=I/(l-1),{start:N,end:$}=s.clips[w];y(S,C,N*(1-z)+$*z)}else for(let w=0,S=0;w<l;w++,S+=4)y(0,S,w/(l-1));return m}var ym={paint:new Ht({"hillshade-illumination-direction":new tt(it.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new tt(it.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new tt(it.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new tt(it.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new tt(it.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new tt(it.paint_hillshade["hillshade-accent-color"])})};const xm=Wt([{name:"a_pos",components:2,type:"Int16"}],4),{members:vm}=xm;var pc={exports:{}};function Tu(s,t,l){l=l||2;var d,m,y,w,S,I,C,z=t&&t.length,N=z?t[0]*l:s.length,$=of(s,0,N,l,!0),Z=[];if(!$||$.next===$.prev)return Z;if(z&&($=function(re,ue,Se,Le){var Te,Ce,Ne,Oe=[];for(Te=0,Ce=ue.length;Te<Ce;Te++)(Ne=of(re,ue[Te]*Le,Te<Ce-1?ue[Te+1]*Le:re.length,Le,!1))===Ne.next&&(Ne.steiner=!0),Oe.push(Im(Ne));for(Oe.sort(Sm),Te=0;Te<Oe.length;Te++)Se=Mm(Oe[Te],Se);return Se}(s,t,$,l)),s.length>80*l){d=y=s[0],m=w=s[1];for(var Q=l;Q<N;Q+=l)(S=s[Q])<d&&(d=S),(I=s[Q+1])<m&&(m=I),S>y&&(y=S),I>w&&(w=I);C=(C=Math.max(y-d,w-m))!==0?32767/C:0}return mc($,Z,l,d,m,C,0),Z}function of(s,t,l,d,m){var y,w;if(m===Eh(s,t,l,d)>0)for(y=t;y<l;y+=d)w=lf(y,s[y],s[y+1],w);else for(y=l-d;y>=t;y-=d)w=lf(y,s[y],s[y+1],w);return w&&Su(w,w.next)&&(_c(w),w=w.next),w}function Zs(s,t){if(!s)return s;t||(t=s);var l,d=s;do if(l=!1,d.steiner||!Su(d,d.next)&&nn(d.prev,d,d.next)!==0)d=d.next;else{if(_c(d),(d=t=d.prev)===d.next)break;l=!0}while(l||d!==t);return t}function mc(s,t,l,d,m,y,w){if(s){!w&&y&&function(z,N,$,Z){var Q=z;do Q.z===0&&(Q.z=bh(Q.x,Q.y,N,$,Z)),Q.prevZ=Q.prev,Q.nextZ=Q.next,Q=Q.next;while(Q!==z);Q.prevZ.nextZ=null,Q.prevZ=null,function(re){var ue,Se,Le,Te,Ce,Ne,Oe,st,rt=1;do{for(Se=re,re=null,Ce=null,Ne=0;Se;){for(Ne++,Le=Se,Oe=0,ue=0;ue<rt&&(Oe++,Le=Le.nextZ);ue++);for(st=rt;Oe>0||st>0&&Le;)Oe!==0&&(st===0||!Le||Se.z<=Le.z)?(Te=Se,Se=Se.nextZ,Oe--):(Te=Le,Le=Le.nextZ,st--),Ce?Ce.nextZ=Te:re=Te,Te.prevZ=Ce,Ce=Te;Se=Le}Ce.nextZ=null,rt*=2}while(Ne>1)}(Q)}(s,d,m,y);for(var S,I,C=s;s.prev!==s.next;)if(S=s.prev,I=s.next,y?wm(s,d,m,y):bm(s))t.push(S.i/l|0),t.push(s.i/l|0),t.push(I.i/l|0),_c(s),s=I.next,C=I.next;else if((s=I)===C){w?w===1?mc(s=Em(Zs(s),t,l),t,l,d,m,y,2):w===2&&Tm(s,t,l,d,m,y):mc(Zs(s),t,l,d,m,y,1);break}}}function bm(s){var t=s.prev,l=s,d=s.next;if(nn(t,l,d)>=0)return!1;for(var m=t.x,y=l.x,w=d.x,S=t.y,I=l.y,C=d.y,z=m<y?m<w?m:w:y<w?y:w,N=S<I?S<C?S:C:I<C?I:C,$=m>y?m>w?m:w:y>w?y:w,Z=S>I?S>C?S:C:I>C?I:C,Q=d.next;Q!==t;){if(Q.x>=z&&Q.x<=$&&Q.y>=N&&Q.y<=Z&&Sl(m,S,y,I,w,C,Q.x,Q.y)&&nn(Q.prev,Q,Q.next)>=0)return!1;Q=Q.next}return!0}function wm(s,t,l,d){var m=s.prev,y=s,w=s.next;if(nn(m,y,w)>=0)return!1;for(var S=m.x,I=y.x,C=w.x,z=m.y,N=y.y,$=w.y,Z=S<I?S<C?S:C:I<C?I:C,Q=z<N?z<$?z:$:N<$?N:$,re=S>I?S>C?S:C:I>C?I:C,ue=z>N?z>$?z:$:N>$?N:$,Se=bh(Z,Q,t,l,d),Le=bh(re,ue,t,l,d),Te=s.prevZ,Ce=s.nextZ;Te&&Te.z>=Se&&Ce&&Ce.z<=Le;){if(Te.x>=Z&&Te.x<=re&&Te.y>=Q&&Te.y<=ue&&Te!==m&&Te!==w&&Sl(S,z,I,N,C,$,Te.x,Te.y)&&nn(Te.prev,Te,Te.next)>=0||(Te=Te.prevZ,Ce.x>=Z&&Ce.x<=re&&Ce.y>=Q&&Ce.y<=ue&&Ce!==m&&Ce!==w&&Sl(S,z,I,N,C,$,Ce.x,Ce.y)&&nn(Ce.prev,Ce,Ce.next)>=0))return!1;Ce=Ce.nextZ}for(;Te&&Te.z>=Se;){if(Te.x>=Z&&Te.x<=re&&Te.y>=Q&&Te.y<=ue&&Te!==m&&Te!==w&&Sl(S,z,I,N,C,$,Te.x,Te.y)&&nn(Te.prev,Te,Te.next)>=0)return!1;Te=Te.prevZ}for(;Ce&&Ce.z<=Le;){if(Ce.x>=Z&&Ce.x<=re&&Ce.y>=Q&&Ce.y<=ue&&Ce!==m&&Ce!==w&&Sl(S,z,I,N,C,$,Ce.x,Ce.y)&&nn(Ce.prev,Ce,Ce.next)>=0)return!1;Ce=Ce.nextZ}return!0}function Em(s,t,l){var d=s;do{var m=d.prev,y=d.next.next;!Su(m,y)&&af(m,d,d.next,y)&&gc(m,y)&&gc(y,m)&&(t.push(m.i/l|0),t.push(d.i/l|0),t.push(y.i/l|0),_c(d),_c(d.next),d=s=y),d=d.next}while(d!==s);return Zs(d)}function Tm(s,t,l,d,m,y){var w=s;do{for(var S=w.next.next;S!==w.prev;){if(w.i!==S.i&&Cm(w,S)){var I=sf(w,S);return w=Zs(w,w.next),I=Zs(I,I.next),mc(w,t,l,d,m,y,0),void mc(I,t,l,d,m,y,0)}S=S.next}w=w.next}while(w!==s)}function Sm(s,t){return s.x-t.x}function Mm(s,t){var l=function(m,y){var w,S=y,I=m.x,C=m.y,z=-1/0;do{if(C<=S.y&&C>=S.next.y&&S.next.y!==S.y){var N=S.x+(C-S.y)*(S.next.x-S.x)/(S.next.y-S.y);if(N<=I&&N>z&&(z=N,w=S.x<S.next.x?S:S.next,N===I))return w}S=S.next}while(S!==y);if(!w)return null;var $,Z=w,Q=w.x,re=w.y,ue=1/0;S=w;do I>=S.x&&S.x>=Q&&I!==S.x&&Sl(C<re?I:z,C,Q,re,C<re?z:I,C,S.x,S.y)&&($=Math.abs(C-S.y)/(I-S.x),gc(S,m)&&($<ue||$===ue&&(S.x>w.x||S.x===w.x&&Am(w,S)))&&(w=S,ue=$)),S=S.next;while(S!==Z);return w}(s,t);if(!l)return t;var d=sf(l,s);return Zs(d,d.next),Zs(l,l.next)}function Am(s,t){return nn(s.prev,s,t.prev)<0&&nn(t.next,s,s.next)<0}function bh(s,t,l,d,m){return(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=(s-l)*m|0)|s<<8))|s<<4))|s<<2))|s<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-d)*m|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Im(s){var t=s,l=s;do(t.x<l.x||t.x===l.x&&t.y<l.y)&&(l=t),t=t.next;while(t!==s);return l}function Sl(s,t,l,d,m,y,w,S){return(m-w)*(t-S)>=(s-w)*(y-S)&&(s-w)*(d-S)>=(l-w)*(t-S)&&(l-w)*(y-S)>=(m-w)*(d-S)}function Cm(s,t){return s.next.i!==t.i&&s.prev.i!==t.i&&!function(l,d){var m=l;do{if(m.i!==l.i&&m.next.i!==l.i&&m.i!==d.i&&m.next.i!==d.i&&af(m,m.next,l,d))return!0;m=m.next}while(m!==l);return!1}(s,t)&&(gc(s,t)&&gc(t,s)&&function(l,d){var m=l,y=!1,w=(l.x+d.x)/2,S=(l.y+d.y)/2;do m.y>S!=m.next.y>S&&m.next.y!==m.y&&w<(m.next.x-m.x)*(S-m.y)/(m.next.y-m.y)+m.x&&(y=!y),m=m.next;while(m!==l);return y}(s,t)&&(nn(s.prev,s,t.prev)||nn(s,t.prev,t))||Su(s,t)&&nn(s.prev,s,s.next)>0&&nn(t.prev,t,t.next)>0)}function nn(s,t,l){return(t.y-s.y)*(l.x-t.x)-(t.x-s.x)*(l.y-t.y)}function Su(s,t){return s.x===t.x&&s.y===t.y}function af(s,t,l,d){var m=Au(nn(s,t,l)),y=Au(nn(s,t,d)),w=Au(nn(l,d,s)),S=Au(nn(l,d,t));return m!==y&&w!==S||!(m!==0||!Mu(s,l,t))||!(y!==0||!Mu(s,d,t))||!(w!==0||!Mu(l,s,d))||!(S!==0||!Mu(l,t,d))}function Mu(s,t,l){return t.x<=Math.max(s.x,l.x)&&t.x>=Math.min(s.x,l.x)&&t.y<=Math.max(s.y,l.y)&&t.y>=Math.min(s.y,l.y)}function Au(s){return s>0?1:s<0?-1:0}function gc(s,t){return nn(s.prev,s,s.next)<0?nn(s,t,s.next)>=0&&nn(s,s.prev,t)>=0:nn(s,t,s.prev)<0||nn(s,s.next,t)<0}function sf(s,t){var l=new wh(s.i,s.x,s.y),d=new wh(t.i,t.x,t.y),m=s.next,y=t.prev;return s.next=t,t.prev=s,l.next=m,m.prev=l,d.next=l,l.prev=d,y.next=d,d.prev=y,d}function lf(s,t,l,d){var m=new wh(s,t,l);return d?(m.next=d.next,m.prev=d,d.next.prev=m,d.next=m):(m.prev=m,m.next=m),m}function _c(s){s.next.prev=s.prev,s.prev.next=s.next,s.prevZ&&(s.prevZ.nextZ=s.nextZ),s.nextZ&&(s.nextZ.prevZ=s.prevZ)}function wh(s,t,l){this.i=s,this.x=t,this.y=l,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Eh(s,t,l,d){for(var m=0,y=t,w=l-d;y<l;y+=d)m+=(s[w]-s[y])*(s[y+1]+s[w+1]),w=y;return m}function km(s,t,l,d,m){cf(s,t,l||0,d||s.length-1,m||Pm)}function cf(s,t,l,d,m){for(;d>l;){if(d-l>600){var y=d-l+1,w=t-l+1,S=Math.log(y),I=.5*Math.exp(2*S/3),C=.5*Math.sqrt(S*I*(y-I)/y)*(w-y/2<0?-1:1);cf(s,t,Math.max(l,Math.floor(t-w*I/y+C)),Math.min(d,Math.floor(t+(y-w)*I/y+C)),m)}var z=s[t],N=l,$=d;for(yc(s,l,t),m(s[d],z)>0&&yc(s,l,d);N<$;){for(yc(s,N,$),N++,$--;m(s[N],z)<0;)N++;for(;m(s[$],z)>0;)$--}m(s[l],z)===0?yc(s,l,$):yc(s,++$,d),$<=t&&(l=$+1),t<=$&&(d=$-1)}}function yc(s,t,l){var d=s[t];s[t]=s[l],s[l]=d}function Pm(s,t){return s<t?-1:s>t?1:0}function Th(s,t){const l=s.length;if(l<=1)return[s];const d=[];let m,y;for(let w=0;w<l;w++){const S=It(s[w]);S!==0&&(s[w].area=Math.abs(S),y===void 0&&(y=S<0),y===S<0?(m&&d.push(m),m=[s[w]]):m.push(s[w]))}if(m&&d.push(m),t>1)for(let w=0;w<d.length;w++)d[w].length<=t||(km(d[w],t,1,d[w].length-1,Dm),d[w]=d[w].slice(0,t));return d}function Dm(s,t){return t.area-s.area}function Sh(s,t,l){const d=l.patternDependencies;let m=!1;for(const y of t){const w=y.paint.get(`${s}-pattern`);w.isConstant()||(m=!0);const S=w.constantOr(null);S&&(m=!0,d[S.to]=!0,d[S.from]=!0)}return m}function Mh(s,t,l,d,m){const y=m.patternDependencies;for(const w of t){const S=w.paint.get(`${s}-pattern`).value;if(S.kind!=="constant"){let I=S.evaluate({zoom:d-1},l,{},m.availableImages),C=S.evaluate({zoom:d},l,{},m.availableImages),z=S.evaluate({zoom:d+1},l,{},m.availableImages);I=I&&I.name?I.name:I,C=C&&C.name?C.name:C,z=z&&z.name?z.name:z,y[I]=!0,y[C]=!0,y[z]=!0,l.patterns[w.id]={min:I,mid:C,max:z}}}return l}pc.exports=Tu,pc.exports.default=Tu,Tu.deviation=function(s,t,l,d){var m=t&&t.length,y=Math.abs(Eh(s,0,m?t[0]*l:s.length,l));if(m)for(var w=0,S=t.length;w<S;w++)y-=Math.abs(Eh(s,t[w]*l,w<S-1?t[w+1]*l:s.length,l));var I=0;for(w=0;w<d.length;w+=3){var C=d[w]*l,z=d[w+1]*l,N=d[w+2]*l;I+=Math.abs((s[C]-s[N])*(s[z+1]-s[C+1])-(s[C]-s[z])*(s[N+1]-s[C+1]))}return y===0&&I===0?0:Math.abs((I-y)/y)},Tu.flatten=function(s){for(var t=s[0][0].length,l={vertices:[],holes:[],dimensions:t},d=0,m=0;m<s.length;m++){for(var y=0;y<s[m].length;y++)for(var w=0;w<t;w++)l.vertices.push(s[m][y][w]);m>0&&l.holes.push(d+=s[m-1].length)}return l};class Iu{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(l=>l.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new er,this.indexArray=new Ln,this.indexArray2=new bo,this.programConfigurations=new $s(t.layers,t.zoom),this.segments=new sn,this.segments2=new sn,this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id),this.projection=t.projection}populate(t,l,d,m){this.hasPattern=Sh("fill",this.layers,l);const y=this.layers[0].layout.get("fill-sort-key"),w=[];for(const{feature:S,id:I,index:C,sourceLayerIndex:z}of t){const N=this.layers[0]._featureFilter.needGeometry,$=Vs(S,N);if(!this.layers[0]._featureFilter.filter(new Me(this.zoom),$,d))continue;const Z=y?y.evaluate($,{},d,l.availableImages):void 0,Q={id:I,properties:S.properties,type:S.type,sourceLayerIndex:z,index:C,geometry:N?$.geometry:$a(S,d,m),patterns:{},sortKey:Z};w.push(Q)}y&&w.sort((S,I)=>S.sortKey-I.sortKey);for(const S of w){const{geometry:I,index:C,sourceLayerIndex:z}=S;if(this.hasPattern){const N=Mh("fill",this.layers,S,this.zoom,l);this.patternFeatures.push(N)}else this.addFeature(S,I,C,d,{},l.availableImages);l.featureIndex.insert(t[C].feature,I,C,z,this.index)}}update(t,l,d,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,l,this.stateDependentLayers,d,m)}addFeatures(t,l,d,m,y){for(const w of this.patternFeatures)this.addFeature(w,w.geometry,w.index,l,d,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,vm),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,l,d,m,y,w=[]){for(const S of Th(l,500)){let I=0;for(const Q of S)I+=Q.length;const C=this.segments.prepareSegment(I,this.layoutVertexArray,this.indexArray),z=C.vertexLength,N=[],$=[];for(const Q of S){if(Q.length===0)continue;Q!==S[0]&&$.push(N.length/2);const re=this.segments2.prepareSegment(Q.length,this.layoutVertexArray,this.indexArray2),ue=re.vertexLength;this.layoutVertexArray.emplaceBack(Q[0].x,Q[0].y),this.indexArray2.emplaceBack(ue+Q.length-1,ue),N.push(Q[0].x),N.push(Q[0].y);for(let Se=1;Se<Q.length;Se++)this.layoutVertexArray.emplaceBack(Q[Se].x,Q[Se].y),this.indexArray2.emplaceBack(ue+Se-1,ue+Se),N.push(Q[Se].x),N.push(Q[Se].y);re.vertexLength+=Q.length,re.primitiveLength+=Q.length}const Z=pc.exports(N,$);for(let Q=0;Q<Z.length;Q+=3)this.indexArray.emplaceBack(z+Z[Q],z+Z[Q+1],z+Z[Q+2]);C.vertexLength+=I,C.primitiveLength+=Z.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,d,y,w,m)}}_i(Iu,"FillBucket",{omit:["layers","patternFeatures"]});const Bm=new Ht({"fill-sort-key":new Ve(it.layout_fill["fill-sort-key"])});var Rm={paint:new Ht({"fill-antialias":new tt(it.paint_fill["fill-antialias"]),"fill-opacity":new Ve(it.paint_fill["fill-opacity"]),"fill-color":new Ve(it.paint_fill["fill-color"]),"fill-outline-color":new Ve(it.paint_fill["fill-outline-color"]),"fill-translate":new tt(it.paint_fill["fill-translate"]),"fill-translate-anchor":new tt(it.paint_fill["fill-translate-anchor"]),"fill-pattern":new ri(it.paint_fill["fill-pattern"])}),layout:Bm};const Lm=Wt([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),zm=Wt([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Om=Wt([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Fm}=Lm;var Cu={},Nm=J,uf=Ml;function Ml(s,t,l,d,m){this.properties={},this.extent=l,this.type=0,this._pbf=s,this._geometry=-1,this._keys=d,this._values=m,s.readFields(Um,this,t)}function Um(s,t,l){s==1?t.id=l.readVarint():s==2?function(d,m){for(var y=d.readVarint()+d.pos;d.pos<y;){var w=m._keys[d.readVarint()],S=m._values[d.readVarint()];m.properties[w]=S}}(l,t):s==3?t.type=l.readVarint():s==4&&(t._geometry=l.pos)}function $m(s){for(var t,l,d=0,m=0,y=s.length,w=y-1;m<y;w=m++)d+=((l=s[w]).x-(t=s[m]).x)*(t.y+l.y);return d}Ml.types=["Unknown","Point","LineString","Polygon"],Ml.prototype.loadGeometry=function(){var s=this._pbf;s.pos=this._geometry;for(var t,l=s.readVarint()+s.pos,d=1,m=0,y=0,w=0,S=[];s.pos<l;){if(m<=0){var I=s.readVarint();d=7&I,m=I>>3}if(m--,d===1||d===2)y+=s.readSVarint(),w+=s.readSVarint(),d===1&&(t&&S.push(t),t=[]),t.push(new Nm(y,w));else{if(d!==7)throw new Error("unknown command "+d);t&&t.push(t[0].clone())}}return t&&S.push(t),S},Ml.prototype.bbox=function(){var s=this._pbf;s.pos=this._geometry;for(var t=s.readVarint()+s.pos,l=1,d=0,m=0,y=0,w=1/0,S=-1/0,I=1/0,C=-1/0;s.pos<t;){if(d<=0){var z=s.readVarint();l=7&z,d=z>>3}if(d--,l===1||l===2)(m+=s.readSVarint())<w&&(w=m),m>S&&(S=m),(y+=s.readSVarint())<I&&(I=y),y>C&&(C=y);else if(l!==7)throw new Error("unknown command "+l)}return[w,I,S,C]},Ml.prototype.toGeoJSON=function(s,t,l){var d,m,y=this.extent*Math.pow(2,l),w=this.extent*s,S=this.extent*t,I=this.loadGeometry(),C=Ml.types[this.type];function z(Z){for(var Q=0;Q<Z.length;Q++){var re=Z[Q];Z[Q]=[360*(re.x+w)/y-180,360/Math.PI*Math.atan(Math.exp((180-360*(re.y+S)/y)*Math.PI/180))-90]}}switch(this.type){case 1:var N=[];for(d=0;d<I.length;d++)N[d]=I[d][0];z(I=N);break;case 2:for(d=0;d<I.length;d++)z(I[d]);break;case 3:for(I=function(Z){var Q=Z.length;if(Q<=1)return[Z];for(var re,ue,Se=[],Le=0;Le<Q;Le++){var Te=$m(Z[Le]);Te!==0&&(ue===void 0&&(ue=Te<0),ue===Te<0?(re&&Se.push(re),re=[Z[Le]]):re.push(Z[Le]))}return re&&Se.push(re),Se}(I),d=0;d<I.length;d++)for(m=0;m<I[d].length;m++)z(I[d][m])}I.length===1?I=I[0]:C="Multi"+C;var $={type:"Feature",geometry:{type:C,coordinates:I},properties:this.properties};return"id"in this&&($.id=this.id),$};var Vm=uf,hf=df;function df(s,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=s,this._keys=[],this._values=[],this._features=[],s.readFields(jm,this,t),this.length=this._features.length}function jm(s,t,l){s===15?t.version=l.readVarint():s===1?t.name=l.readString():s===5?t.extent=l.readVarint():s===2?t._features.push(l.pos):s===3?t._keys.push(l.readString()):s===4&&t._values.push(function(d){for(var m=null,y=d.readVarint()+d.pos;d.pos<y;){var w=d.readVarint()>>3;m=w===1?d.readString():w===2?d.readFloat():w===3?d.readDouble():w===4?d.readVarint64():w===5?d.readVarint():w===6?d.readSVarint():w===7?d.readBoolean():null}return m}(l))}df.prototype.feature=function(s){if(s<0||s>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[s];var t=this._pbf.readVarint()+this._pbf.pos;return new Vm(this._pbf,t,this.extent,this._keys,this._values)};var Gm=hf;function qm(s,t,l){if(s===3){var d=new Gm(l,l.readVarint()+l.pos);d.length&&(t[d.name]=d)}}var Ah=Cu.VectorTile=function(s,t){this.layers=s.readFields(qm,{},t)},ku=Cu.VectorTileFeature=uf;function Pu(s,t,l,d){const m=[],y=d===0?(w,S,I,C,z,N)=>{w.push(new J(N,I+(N-S)/(C-S)*(z-I)))}:(w,S,I,C,z,N)=>{w.push(new J(S+(N-I)/(z-I)*(C-S),N))};for(const w of s){const S=[];for(const I of w){if(I.length<=2)continue;const C=[];for(let $=0;$<I.length-1;$++){const Z=I[$].x,Q=I[$].y,re=I[$+1].x,ue=I[$+1].y,Se=d===0?Z:Q,Le=d===0?re:ue;Se<t?Le>t&&y(C,Z,Q,re,ue,t):Se>l?Le<l&&y(C,Z,Q,re,ue,l):C.push(I[$]),Le<t&&Se>=t&&y(C,Z,Q,re,ue,t),Le>l&&Se<=l&&y(C,Z,Q,re,ue,l)}let z=I[I.length-1];const N=d===0?z.x:z.y;N>=t&&N<=l&&C.push(z),C.length&&(z=C[C.length-1],C[0].x===z.x&&C[0].y===z.y||C.push(C[0]),S.push(C))}S.length&&m.push(S)}return m}Cu.VectorTileLayer=hf;const Zm=ku.types,Xm=Math.pow(2,13);function xc(s,t,l,d,m,y,w,S){s.emplaceBack((t<<1)+w,(l<<1)+y,(Math.floor(d*Xm)<<1)+m,Math.round(S))}function vc(s,t,l){s.emplaceBack(t.x,t.y,t.z,l[0]*16384,l[1]*16384,l[2]*16384)}class ff{constructor(){this.acc=new J(0,0),this.polyCount=[]}startRing(t){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new J(t.x,t.y),this.max=new J(t.x,t.y))}append(t,l){this.currentPolyCount.edges++,this.acc._add(t);const d=this.min,m=this.max;t.x<d.x?d.x=t.x:t.x>m.x&&(m.x=t.x),t.y<d.y?d.y=t.y:t.y>m.y&&(m.y=t.y),((t.x===0||t.x===Gi)&&t.x===l.x)!=((t.y===0||t.y===Gi)&&t.y===l.y)&&this.processBorderOverlap(t,l),l.x<0!=t.x<0&&this.addBorderIntersection(0,ur(l.y,t.y,(0-l.x)/(t.x-l.x))),l.x>Gi!=t.x>Gi&&this.addBorderIntersection(1,ur(l.y,t.y,(Gi-l.x)/(t.x-l.x))),l.y<0!=t.y<0&&this.addBorderIntersection(2,ur(l.x,t.x,(0-l.y)/(t.y-l.y))),l.y>Gi!=t.y>Gi&&this.addBorderIntersection(3,ur(l.x,t.x,(Gi-l.y)/(t.y-l.y)))}addBorderIntersection(t,l){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const d=this.borders[t];l<d[0]&&(d[0]=l),l>d[1]&&(d[1]=l)}processBorderOverlap(t,l){if(t.x===l.x){if(t.y===l.y)return;const d=t.x===0?0:1;this.addBorderIntersection(d,l.y),this.addBorderIntersection(d,t.y)}else{const d=t.y===0?2:3;this.addBorderIntersection(d,l.x),this.addBorderIntersection(d,t.x)}}centroid(){const t=this.polyCount.reduce((l,d)=>l+d.edges,0);return t!==0?this.acc.div(t)._round():new J(0,0)}span(){return new J(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((t,l)=>t+ +(l[0]!==Number.MAX_VALUE),0)}}class bc{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(l=>l.id),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.layoutVertexArray=new Sr,this.centroidVertexArray=new yd,this.indexArray=new Ln,this.programConfigurations=new $s(t.layers,t.zoom),this.segments=new sn,this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id),this.enableTerrain=t.enableTerrain}populate(t,l,d,m){this.features=[],this.hasPattern=Sh("fill-extrusion",this.layers,l),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=function(y){const w=Math.exp(Math.PI*(1-y.y/(1<<y.z)*2));return 80150034*w/(w*w+1)/Gi/(1<<y.z)}(d),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:y,id:w,index:S,sourceLayerIndex:I}of t){const C=this.layers[0]._featureFilter.needGeometry,z=Vs(y,C);if(!this.layers[0]._featureFilter.filter(new Me(this.zoom),z,d))continue;const N={id:w,sourceLayerIndex:I,index:S,geometry:C?z.geometry:$a(y,d,m),properties:y.properties,type:y.type,patterns:{}},$=this.layoutVertexArray.length;this.hasPattern?this.features.push(Mh("fill-extrusion",this.layers,N,this.zoom,l)):this.addFeature(N,N.geometry,S,d,{},l.availableImages,m),l.featureIndex.insert(y,N.geometry,S,I,this.index,$)}this.sortBorders()}addFeatures(t,l,d,m,y){for(const w of this.features){const{geometry:S}=w;this.addFeature(w,S,w.index,l,d,m,y)}this.sortBorders()}update(t,l,d,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,l,this.stateDependentLayers,d,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Fm),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,Om.members,!0))),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.centroidVertexArray.length!==0&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,zm.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,l,d,m,y,w,S){const I=[new J(0,0),new J(Gi,Gi)],C=S.projection,z=C.name==="globe",N=this.enableTerrain&&!z?new ff:null,$=Zm[t.type]==="Polygon";z&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new sd);const Z=Th(l,500);for(let Se=Z.length-1;Se>=0;Se--){const Le=Z[Se];(Le.length===0||(Q=Le[0]).every(Te=>Te.x<=0)||Q.every(Te=>Te.x>=Gi)||Q.every(Te=>Te.y<=0)||Q.every(Te=>Te.y>=Gi))&&Z.splice(Se,1)}var Q;let re;if(z)re=vf(Z,I,m);else{re=[];for(const Se of Z)re.push({polygon:Se,bounds:I})}const ue=$?this.edgeRadius:0;for(const{polygon:Se,bounds:Le}of re){let Te=0,Ce=0;for(const Oe of Se)$&&!Oe[0].equals(Oe[Oe.length-1])&&Oe.push(Oe[0]),Ce+=$?Oe.length-1:Oe.length;const Ne=this.segments.prepareSegment(($?5:4)*Ce,this.layoutVertexArray,this.indexArray);if($){const Oe=[],st=[];Te=Ne.vertexLength;for(const mt of Se){let Ft,ct;mt.length&&mt!==Se[0]&&st.push(Oe.length/2),Ft=mt[1].sub(mt[0])._perp()._unit();for(let Et=1;Et<mt.length;Et++){const Mt=mt[Et],Lt=mt[Et===mt.length-1?1:Et+1];let{x:Vt,y:gt}=Mt;if(ue){ct=Lt.sub(Mt)._perp()._unit();const xi=Ft.add(ct)._unit(),qi=ue*Math.min(4,1/(Ft.x*xi.x+Ft.y*xi.y));Vt+=qi*xi.x,gt+=qi*xi.y,Ft=ct}xc(this.layoutVertexArray,Vt,gt,0,0,1,1,0),Ne.vertexLength++,Oe.push(Mt.x,Mt.y),z&&vc(this.layoutVertexExtArray,C.projectTilePoint(Vt,gt,m),C.upVector(m,Vt,gt))}}const rt=pc.exports(Oe,st);for(let mt=0;mt<rt.length;mt+=3)this.indexArray.emplaceBack(Te+rt[mt],Te+rt[mt+2],Te+rt[mt+1]),Ne.primitiveLength++}for(const Oe of Se){N&&Oe.length&&N.startRing(Oe[0]);let st,rt,mt,Ft=Oe.length>4&&_f(Oe[Oe.length-2],Oe[0],Oe[1]),ct=ue?Hm(Oe[Oe.length-2],Oe[0],Oe[1],ue):0;rt=Oe[1].sub(Oe[0])._perp()._unit();let Et=!0;for(let Mt=1,Lt=0;Mt<Oe.length;Mt++){let Vt=Oe[Mt-1],gt=Oe[Mt];const xi=Oe[Mt===Oe.length-1?1:Mt+1];if(N&&$&&N.currentPolyCount.top++,gf(gt,Vt,Le)){ue&&(rt=xi.sub(gt)._perp()._unit(),Et=!Et);continue}N&&N.append(gt,Vt);const qi=gt.sub(Vt)._perp(),ki=qi.x/(Math.abs(qi.x)+Math.abs(qi.y)),Si=qi.y>0?1:0,ai=Vt.dist(gt);if(Lt+ai>32768&&(Lt=0),ue){mt=xi.sub(gt)._perp()._unit();let pr=mf(Vt,gt,xi,pf(rt,mt),ue);isNaN(pr)&&(pr=0);const Yi=gt.sub(Vt)._unit();Vt=Vt.add(Yi.mult(ct))._round(),gt=gt.add(Yi.mult(-pr))._round(),ct=pr,rt=mt}const ji=Ne.vertexLength,Qi=Oe.length>4&&_f(Vt,gt,xi);let Ji=yf(Lt,Ft,Et);if(xc(this.layoutVertexArray,Vt.x,Vt.y,ki,Si,0,0,Ji),xc(this.layoutVertexArray,Vt.x,Vt.y,ki,Si,0,1,Ji),Lt+=ai,Ji=yf(Lt,Qi,!Et),Ft=Qi,xc(this.layoutVertexArray,gt.x,gt.y,ki,Si,0,0,Ji),xc(this.layoutVertexArray,gt.x,gt.y,ki,Si,0,1,Ji),Ne.vertexLength+=4,this.indexArray.emplaceBack(ji+0,ji+1,ji+2),this.indexArray.emplaceBack(ji+1,ji+3,ji+2),Ne.primitiveLength+=2,ue){const pr=Te+(Mt===1?Oe.length-2:Mt-2),Yi=Mt===1?Te:pr+1;if(this.indexArray.emplaceBack(ji+1,pr,ji+3),this.indexArray.emplaceBack(pr,Yi,ji+3),Ne.primitiveLength+=2,st===void 0&&(st=ji),!gf(xi,Oe[Mt],Le)){const jr=Mt===Oe.length-1?st:Ne.vertexLength;this.indexArray.emplaceBack(ji+2,ji+3,jr),this.indexArray.emplaceBack(ji+3,jr+1,jr),this.indexArray.emplaceBack(ji+3,Yi,jr+1),Ne.primitiveLength+=3}Et=!Et}if(z){const pr=this.layoutVertexExtArray,Yi=C.projectTilePoint(Vt.x,Vt.y,m),jr=C.projectTilePoint(gt.x,gt.y,m),tr=C.upVector(m,Vt.x,Vt.y),lr=C.upVector(m,gt.x,gt.y);vc(pr,Yi,tr),vc(pr,Yi,tr),vc(pr,jr,lr),vc(pr,jr,lr)}}$&&(Te+=Oe.length-1)}}if(N&&N.polyCount.length>0){if(N.borders){N.vertexArrayOffset=this.centroidVertexArray.length;const Se=N.borders,Le=this.featuresOnBorder.push(N)-1;for(let Te=0;Te<4;Te++)Se[Te][0]!==Number.MAX_VALUE&&this.borders[Te].push(Le)}this.encodeCentroid(N.borders?void 0:N.centroid(),N)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,d,y,w,m)}sortBorders(){for(let t=0;t<4;t++)this.borders[t].sort((l,d)=>this.featuresOnBorder[l].borders[t][0]-this.featuresOnBorder[d].borders[t][0])}encodeCentroid(t,l,d=!0){let m,y;if(t)if(t.y!==0){const S=l.span()._mult(this.tileToMeter);m=(Math.max(t.x,1)<<3)+Math.min(7,Math.round(S.x/10)),y=(Math.max(t.y,1)<<3)+Math.min(7,Math.round(S.y/10))}else m=Math.ceil(7*(t.x+450)),y=0;else m=0,y=+d;let w=d?this.centroidVertexArray.length:l.vertexArrayOffset;for(const S of l.polyCount){d&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*S.edges+S.top);for(let I=0;I<S.top;I++)this.centroidVertexArray.emplace(w++,m,y);for(let I=0;I<2*S.edges;I++)this.centroidVertexArray.emplace(w++,0,y),this.centroidVertexArray.emplace(w++,m,y)}}}function pf(s,t){const l=s.add(t)._unit();return s.x*l.x+s.y*l.y}function Hm(s,t,l,d){const m=t.sub(s)._perp()._unit(),y=l.sub(t)._perp()._unit();return mf(s,t,l,pf(m,y),d)}function mf(s,t,l,d,m){const y=Math.sqrt(1-d*d);return Math.min(s.dist(t)/3,t.dist(l)/3,m*y/d)}function gf(s,t,l){return s.x<l[0].x&&t.x<l[0].x||s.x>l[1].x&&t.x>l[1].x||s.y<l[0].y&&t.y<l[0].y||s.y>l[1].y&&t.y>l[1].y}function _f(s,t,l){if(s.x<0||s.x>=Gi||t.x<0||t.x>=Gi||l.x<0||l.x>=Gi)return!1;const d=l.sub(t),m=d.perp(),y=s.sub(t);return(d.x*y.x+d.y*y.y)/Math.sqrt((d.x*d.x+d.y*d.y)*(y.x*y.x+y.y*y.y))>-.866&&m.x*y.x+m.y*y.y<0}function yf(s,t,l){const d=t?2|s:-3&s;return l?1|d:-2&d}function xf(){const s=Math.PI/32,t=Math.tan(s),l=yu;return l*Math.sqrt(1+2*t*t)-l}function vf(s,t,l){const d=1<<l.z,m=wo(l.x/d),y=wo((l.x+1)/d),w=An(l.y/d),S=An((l.y+1)/d);return function(I,C,z,N,$=0,Z){const Q=[];if(!I.length||!z||!N)return Q;const re=(Oe,st)=>{for(const rt of Oe)Q.push({polygon:rt,bounds:st})},ue=Math.ceil(Math.log2(z)),Se=Math.ceil(Math.log2(N)),Le=ue-Se,Te=[];for(let Oe=0;Oe<Math.abs(Le);Oe++)Te.push(Le>0?0:1);for(let Oe=0;Oe<Math.min(ue,Se);Oe++)Te.push(0),Te.push(1);let Ce=I;if(Ce=Pu(Ce,C[0].y-$,C[1].y+$,1),Ce=Pu(Ce,C[0].x-$,C[1].x+$,0),!Ce.length)return Q;const Ne=[];for(Te.length?Ne.push({polygons:Ce,bounds:C,depth:0}):re(Ce,C);Ne.length;){const Oe=Ne.pop(),st=Oe.depth,rt=Te[st],mt=Oe.bounds[0],Ft=Oe.bounds[1],ct=rt===0?mt.x:mt.y,Et=rt===0?Ft.x:Ft.y,Mt=Z?Z(rt,ct,Et):.5*(ct+Et),Lt=Pu(Oe.polygons,ct-$,Mt+$,rt),Vt=Pu(Oe.polygons,Mt-$,Et+$,rt);if(Lt.length){const gt=[mt,new J(rt===0?Mt:Ft.x,rt===1?Mt:Ft.y)];Te.length>st+1?Ne.push({polygons:Lt,bounds:gt,depth:st+1}):re(Lt,gt)}if(Vt.length){const gt=[new J(rt===0?Mt:mt.x,rt===1?Mt:mt.y),Ft];Te.length>st+1?Ne.push({polygons:Vt,bounds:gt,depth:st+1}):re(Vt,gt)}}return Q}(s,t,Math.ceil((y-m)/11.25),Math.ceil((w-S)/11.25),1,(I,C,z)=>{if(I===0)return .5*(C+z);{const N=An((l.y+C/Gi)/d);return(va(.5*(An((l.y+z/Gi)/d)+N))*d-l.y)*Gi}})}_i(bc,"FillExtrusionBucket",{omit:["layers","features"]}),_i(ff,"PartMetadata");const Wm=new Ht({"fill-extrusion-edge-radius":new tt(it["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var Ym={paint:new Ht({"fill-extrusion-opacity":new tt(it["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ve(it["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new tt(it["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new tt(it["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new ri(it["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ve(it["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ve(it["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new tt(it["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new tt(it["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new tt(it["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"])}),layout:Wm};function bf(s,t,l){var d=2*Math.PI*6378137/256/Math.pow(2,l);return[s*d-2*Math.PI*6378137/2,t*d-2*Math.PI*6378137/2]}class Du{constructor(t,l,d){this.z=t,this.x=l,this.y=d,this.key=wc(0,t,t,l,d)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,l){const d=function(y,w,S){var I=bf(256*y,256*(w=Math.pow(2,S)-w-1),S),C=bf(256*(y+1),256*(w+1),S);return I[0]+","+I[1]+","+C[0]+","+C[1]}(this.x,this.y,this.z),m=function(y,w,S){let I,C="";for(let z=y;z>0;z--)I=1<<z-1,C+=(w&I?1:0)+(S&I?2:0);return C}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(l==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",m).replace("{bbox-epsg-3857}",d)}toString(){return`${this.z}/${this.x}/${this.y}`}}class wf{constructor(t,l){this.wrap=t,this.canonical=l,this.key=wc(t,l.z,l.z,l.x,l.y)}}class Zn{constructor(t,l,d,m,y){this.overscaledZ=t,this.wrap=l,this.canonical=new Du(d,+m,+y),this.key=l===0&&t===d?this.canonical.key:wc(l,t,d,m,y)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const l=this.canonical.z-t;return t>this.canonical.z?new Zn(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Zn(t,this.wrap,t,this.canonical.x>>l,this.canonical.y>>l)}calculateScaledKey(t,l=!0){if(this.overscaledZ===t&&l)return this.key;if(t>this.canonical.z)return wc(this.wrap*+l,t,this.canonical.z,this.canonical.x,this.canonical.y);{const d=this.canonical.z-t;return wc(this.wrap*+l,t,t,this.canonical.x>>d,this.canonical.y>>d)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const l=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>l&&t.canonical.y===this.canonical.y>>l}children(t){if(this.overscaledZ>=t)return[new Zn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const l=this.canonical.z+1,d=2*this.canonical.x,m=2*this.canonical.y;return[new Zn(l,this.wrap,l,d,m),new Zn(l,this.wrap,l,d+1,m),new Zn(l,this.wrap,l,d,m+1),new Zn(l,this.wrap,l,d+1,m+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new Zn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new Zn(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new wf(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function wc(s,t,l,d,m){const y=1<<Math.min(l,22);let w=y*(m%y)+d%y;return s&&l<22&&(w+=y*y*((s<0?-2*s-1:2*s)%(1<<2*(22-l)))),16*(32*w+l)+(t-l)}_i(Du,"CanonicalTileID"),_i(Zn,"OverscaledTileID",{omit:["projMatrix"]});class Al extends J{constructor(t,l,d){super(t,l),this.z=d}}function Ec(s,t){return s.x*t.x+s.y*t.y}function Ef(s,t){if(s.length===1){let l=0;const d=t[l++];let m;for(;!m||d.equals(m);)if(m=t[l++],!m)return 1/0;for(;l<t.length;l++){const y=t[l],w=s[0],S=m.sub(d),I=y.sub(d),C=w.sub(d),z=Ec(S,S),N=Ec(S,I),$=Ec(I,I),Z=Ec(C,S),Q=Ec(C,I),re=z*$-N*N,ue=($*Z-N*Q)/re,Se=(z*Q-N*Z)/re,Le=d.z*(1-ue-Se)+m.z*ue+y.z*Se;if(isFinite(Le))return Le}return 1/0}{let l=1/0;for(const d of t)l=Math.min(l,d.z);return l}}function Tf(s,t,l,d,m,y,w,S){const I=w*m.getElevationAt(s,t,!0,!0),C=y[0]!==0,z=C?y[1]===0?w*(y[0]/7-450):w*function(N,$,Z){const Q=Math.floor($[0]/8),re=Math.floor($[1]/8),ue=10*($[0]-8*Q),Se=10*($[1]-8*re),Le=N.getElevationAt(Q,re,!0,!0),Te=N.getMeterToDEM(Z),Ce=Math.floor(.5*(ue*Te-1)),Ne=Math.floor(.5*(Se*Te-1)),Oe=N.tileCoordToPixel(Q,re),st=2*Ce+1,rt=2*Ne+1,mt=function(Vt,gt,xi,qi,ki){return[Vt.getElevationAtPixel(gt,xi,!0),Vt.getElevationAtPixel(gt+ki,xi,!0),Vt.getElevationAtPixel(gt,xi+ki,!0),Vt.getElevationAtPixel(gt+qi,xi+ki,!0)]}(N,Oe.x-Ce,Oe.y-Ne,st,rt),Ft=Math.abs(mt[0]-mt[1]),ct=Math.abs(mt[2]-mt[3]),Et=Math.abs(mt[0]-mt[2])+Math.abs(mt[1]-mt[3]),Mt=Math.min(.25,.5*Te*(Ft+ct)/st),Lt=Math.min(.25,.5*Te*Et/rt);return Le+Math.max(Mt*ue,Lt*Se)}(m,y,S):I;return{base:I+(l===0)?-1:l,top:C?Math.max(z+d,I+l+2):I+d}}const Km=Wt([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:Qm}=Km,Jm=Wt([{name:"a_packed",components:4,type:"Float32"}]),{members:eg}=Jm,tg=ku.types,ig=Math.cos(Math.PI/180*37.5);class Bu{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(l=>l.id),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(l=>{this.gradients[l.id]={}}),this.layoutVertexArray=new vr,this.layoutVertexArray2=new fn,this.indexArray=new Ln,this.programConfigurations=new $s(t.layers,t.zoom),this.segments=new sn,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(l=>l.isStateDependent()).map(l=>l.id)}populate(t,l,d,m){this.hasPattern=Sh("line",this.layers,l);const y=this.layers[0].layout.get("line-sort-key"),w=[];for(const{feature:z,id:N,index:$,sourceLayerIndex:Z}of t){const Q=this.layers[0]._featureFilter.needGeometry,re=Vs(z,Q);if(!this.layers[0]._featureFilter.filter(new Me(this.zoom),re,d))continue;const ue=y?y.evaluate(re,{},d):void 0,Se={id:N,properties:z.properties,type:z.type,sourceLayerIndex:Z,index:$,geometry:Q?re.geometry:$a(z,d,m),patterns:{},sortKey:ue};w.push(Se)}y&&w.sort((z,N)=>z.sortKey-N.sortKey);const{lineAtlas:S,featureIndex:I}=l,C=this.addConstantDashes(S);for(const z of w){const{geometry:N,index:$,sourceLayerIndex:Z}=z;if(C&&this.addFeatureDashes(z,S),this.hasPattern){const Q=Mh("line",this.layers,z,this.zoom,l);this.patternFeatures.push(Q)}else this.addFeature(z,N,$,d,S.positions,l.availableImages);I.insert(t[$].feature,N,$,Z,this.index)}}addConstantDashes(t){let l=!1;for(const d of this.layers){const m=d.paint.get("line-dasharray").value,y=d.layout.get("line-cap").value;if(m.kind!=="constant"||y.kind!=="constant")l=!0;else{const w=y.value,S=m.value;if(!S)continue;t.addDash(S.from,w),t.addDash(S.to,w),S.other&&t.addDash(S.other,w)}}return l}addFeatureDashes(t,l){const d=this.zoom;for(const m of this.layers){const y=m.paint.get("line-dasharray").value,w=m.layout.get("line-cap").value;if(y.kind==="constant"&&w.kind==="constant")continue;let S,I,C,z,N,$;if(y.kind==="constant"){const ue=y.value;if(!ue)continue;S=ue.other||ue.to,I=ue.to,C=ue.from}else S=y.evaluate({zoom:d-1},t),I=y.evaluate({zoom:d},t),C=y.evaluate({zoom:d+1},t);w.kind==="constant"?z=N=$=w.value:(z=w.evaluate({zoom:d-1},t),N=w.evaluate({zoom:d},t),$=w.evaluate({zoom:d+1},t)),l.addDash(S,z),l.addDash(I,N),l.addDash(C,$);const Z=l.getKey(S,z),Q=l.getKey(I,N),re=l.getKey(C,$);t.patterns[m.id]={min:Z,mid:Q,max:re}}}update(t,l,d,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,l,this.stateDependentLayers,d,m)}addFeatures(t,l,d,m,y){for(const w of this.patternFeatures)this.addFeature(w,w.geometry,w.index,l,d,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,eg)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Qm),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,l,d,m,y,w){const S=this.layers[0].layout,I=S.get("line-join").evaluate(t,{}),C=S.get("line-cap").evaluate(t,{}),z=S.get("line-miter-limit"),N=S.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const $ of l)this.addLine($,t,I,C,z,N);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,d,y,w,m)}addLine(t,l,d,m,y,w){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Se=0;Se<t.length-1;Se++)this.totalDistance+=t[Se].dist(t[Se+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const S=tg[l.type]==="Polygon";let I=t.length;for(;I>=2&&t[I-1].equals(t[I-2]);)I--;let C=0;for(;C<I-1&&t[C].equals(t[C+1]);)C++;if(I<(S?3:2))return;d==="bevel"&&(y=1.05);const z=this.overscaling<=16?122880/(512*this.overscaling):0,N=this.segments.prepareSegment(10*I,this.layoutVertexArray,this.indexArray);let $,Z,Q,re,ue;this.e1=this.e2=-1,S&&($=t[I-2],ue=t[C].sub($)._unit()._perp());for(let Se=C;Se<I;Se++){if(Q=Se===I-1?S?t[C+1]:void 0:t[Se+1],Q&&t[Se].equals(Q))continue;ue&&(re=ue),$&&(Z=$),$=t[Se],ue=Q?Q.sub($)._unit()._perp():re,re=re||ue;let Le=re.add(ue);Le.x===0&&Le.y===0||Le._unit();const Te=re.x*ue.x+re.y*ue.y,Ce=Le.x*ue.x+Le.y*ue.y,Ne=Ce!==0?1/Ce:1/0,Oe=2*Math.sqrt(2-2*Ce),st=Ce<ig&&Z&&Q,rt=re.x*ue.y-re.y*ue.x>0;if(st&&Se>C){const ct=$.dist(Z);if(ct>2*z){const Et=$.sub($.sub(Z)._mult(z/ct)._round());this.updateDistance(Z,Et),this.addCurrentVertex(Et,re,0,0,N),Z=Et}}const mt=Z&&Q;let Ft=mt?d:S?"butt":m;if(mt&&Ft==="round"&&(Ne<w?Ft="miter":Ne<=2&&(Ft="fakeround")),Ft==="miter"&&Ne>y&&(Ft="bevel"),Ft==="bevel"&&(Ne>2&&(Ft="flipbevel"),Ne<y&&(Ft="miter")),Z&&this.updateDistance(Z,$),Ft==="miter")Le._mult(Ne),this.addCurrentVertex($,Le,0,0,N);else if(Ft==="flipbevel"){if(Ne>100)Le=ue.mult(-1);else{const ct=Ne*re.add(ue).mag()/re.sub(ue).mag();Le._perp()._mult(ct*(rt?-1:1))}this.addCurrentVertex($,Le,0,0,N),this.addCurrentVertex($,Le.mult(-1),0,0,N)}else if(Ft==="bevel"||Ft==="fakeround"){const ct=-Math.sqrt(Ne*Ne-1),Et=rt?ct:0,Mt=rt?0:ct;if(Z&&this.addCurrentVertex($,re,Et,Mt,N),Ft==="fakeround"){const Lt=Math.round(180*Oe/Math.PI/20);for(let Vt=1;Vt<Lt;Vt++){let gt=Vt/Lt;if(gt!==.5){const qi=gt-.5;gt+=gt*qi*(gt-1)*((1.0904+Te*(Te*(3.55645-1.43519*Te)-3.2452))*qi*qi+(.848013+Te*(.215638*Te-1.06021)))}const xi=ue.sub(re)._mult(gt)._add(re)._unit()._mult(rt?-1:1);this.addHalfVertex($,xi.x,xi.y,!1,rt,0,N)}}Q&&this.addCurrentVertex($,ue,-Et,-Mt,N)}else if(Ft==="butt")this.addCurrentVertex($,Le,0,0,N);else if(Ft==="square"){const ct=Z?1:-1;Z||this.addCurrentVertex($,Le,ct,ct,N),this.addCurrentVertex($,Le,0,0,N),Z&&this.addCurrentVertex($,Le,ct,ct,N)}else Ft==="round"&&(Z&&(this.addCurrentVertex($,re,0,0,N),this.addCurrentVertex($,re,1,1,N,!0)),Q&&(this.addCurrentVertex($,ue,-1,-1,N,!0),this.addCurrentVertex($,ue,0,0,N)));if(st&&Se<I-1){const ct=$.dist(Q);if(ct>2*z){const Et=$.add(Q.sub($)._mult(z/ct)._round());this.updateDistance($,Et),this.addCurrentVertex(Et,ue,0,0,N),$=Et}}}}addCurrentVertex(t,l,d,m,y,w=!1){const S=l.y*m-l.x,I=-l.y-l.x*m;this.addHalfVertex(t,l.x+l.y*d,l.y-l.x*d,w,!1,d,y),this.addHalfVertex(t,S,I,w,!0,-m,y)}addHalfVertex({x:t,y:l},d,m,y,w,S,I){this.layoutVertexArray.emplaceBack((t<<1)+(y?1:0),(l<<1)+(w?1:0),Math.round(63*d)+128,Math.round(63*m)+128,1+(S===0?0:S<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const C=I.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,C),I.primitiveLength++),w?this.e2=C:this.e1=C}updateScaledDistance(){if(this.lineClips){const t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,l){this.distance+=t.dist(l),this.updateScaledDistance()}}_i(Bu,"LineBucket",{omit:["layers","patternFeatures"]});const rg=new Ht({"line-cap":new Ve(it.layout_line["line-cap"]),"line-join":new Ve(it.layout_line["line-join"]),"line-miter-limit":new tt(it.layout_line["line-miter-limit"]),"line-round-limit":new tt(it.layout_line["line-round-limit"]),"line-sort-key":new Ve(it.layout_line["line-sort-key"])});var Sf={paint:new Ht({"line-opacity":new Ve(it.paint_line["line-opacity"]),"line-color":new Ve(it.paint_line["line-color"]),"line-translate":new tt(it.paint_line["line-translate"]),"line-translate-anchor":new tt(it.paint_line["line-translate-anchor"]),"line-width":new Ve(it.paint_line["line-width"]),"line-gap-width":new Ve(it.paint_line["line-gap-width"]),"line-offset":new Ve(it.paint_line["line-offset"]),"line-blur":new Ve(it.paint_line["line-blur"]),"line-dasharray":new ri(it.paint_line["line-dasharray"]),"line-pattern":new ri(it.paint_line["line-pattern"]),"line-gradient":new Jt(it.paint_line["line-gradient"]),"line-trim-offset":new tt(it.paint_line["line-trim-offset"])}),layout:rg};const Mf=new class extends Ve{possiblyEvaluate(s,t){return t=new Me(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,zoomHistory:t.zoomHistory,transition:t.transition}),super.possiblyEvaluate(s,t)}evaluate(s,t,l,d){return t=je({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(s,t,l,d)}}(Sf.paint.properties["line-width"].specification);function Af(s,t){return t>0?t+2*s:s}Mf.useIntegerZoom=!0;const ng=Wt([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),og=Wt([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),ag=Wt([{name:"a_projected_pos",components:4,type:"Float32"}],4);Wt([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const sg=Wt([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),lg=Wt([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);Wt([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const If=Wt([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),cg=Wt([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Wt([{name:"triangle",components:3,type:"Uint16"}]),Wt([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Wt([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),Wt([{type:"Float32",name:"offsetX"}]),Wt([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var In=24;const Ea=128;function Ih(s,t){const{expression:l}=t;if(l.kind==="constant")return{kind:"constant",layoutSize:l.evaluate(new Me(s+1))};if(l.kind==="source")return{kind:"source"};{const{zoomStops:d,interpolationType:m}=l;let y=0;for(;y<d.length&&d[y]<=s;)y++;y=Math.max(0,y-1);let w=y;for(;w<d.length&&d[w]<s+1;)w++;w=Math.min(d.length-1,w);const S=d[y],I=d[w];return l.kind==="composite"?{kind:"composite",minZoom:S,maxZoom:I,interpolationType:m}:{kind:"camera",minZoom:S,maxZoom:I,minSize:l.evaluate(new Me(S)),maxSize:l.evaluate(new Me(I)),interpolationType:m}}}function Ru(s,{uSize:t,uSizeT:l},{lowerSize:d,upperSize:m}){return s.kind==="source"?d/Ea:s.kind==="composite"?ur(d/Ea,m/Ea,l):t}function Il(s,t){let l=0,d=0;if(s.kind==="constant")d=s.layoutSize;else if(s.kind!=="source"){const{interpolationType:m,minZoom:y,maxZoom:w}=s,S=m?We(Xe.interpolationFactor(m,t,y,w),0,1):0;s.kind==="camera"?d=ur(s.minSize,s.maxSize,S):l=S}return{uSizeT:l,uSize:d}}var ug=Object.freeze({__proto__:null,getSizeData:Ih,evaluateSizeForFeature:Ru,evaluateSizeForZoom:Il,SIZE_PACK_FACTOR:Ea});function hg(s,t,l){return s.sections.forEach(d=>{d.text=function(m,y,w){const S=y.layout.get("text-transform").evaluate(w,{});return S==="uppercase"?m=m.toLocaleUpperCase():S==="lowercase"&&(m=m.toLocaleLowerCase()),ze.applyArabicShaping&&(m=ze.applyArabicShaping(m)),m}(d.text,t,l)}),s}const Tc={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};function dg(s){return s==="\uFE36"||s==="\uFE48"||s==="\uFE38"||s==="\uFE44"||s==="\uFE42"||s==="\uFE3E"||s==="\uFE3C"||s==="\uFE3A"||s==="\uFE18"||s==="\uFE40"||s==="\uFE10"||s==="\uFE13"||s==="\uFE14"||s==="\uFF40"||s==="\uFFE3"||s==="\uFE11"||s==="\uFE12"}function fg(s){return s==="\uFE35"||s==="\uFE47"||s==="\uFE37"||s==="\uFE43"||s==="\uFE41"||s==="\uFE3D"||s==="\uFE3B"||s==="\uFE39"||s==="\uFE17"||s==="\uFE3F"}var Sc=Lr,Cf=function(s,t,l,d,m){var y,w,S=8*m-d-1,I=(1<<S)-1,C=I>>1,z=-7,N=l?m-1:0,$=l?-1:1,Z=s[t+N];for(N+=$,y=Z&(1<<-z)-1,Z>>=-z,z+=S;z>0;y=256*y+s[t+N],N+=$,z-=8);for(w=y&(1<<-z)-1,y>>=-z,z+=d;z>0;w=256*w+s[t+N],N+=$,z-=8);if(y===0)y=1-C;else{if(y===I)return w?NaN:1/0*(Z?-1:1);w+=Math.pow(2,d),y-=C}return(Z?-1:1)*w*Math.pow(2,y-d)},kf=function(s,t,l,d,m,y){var w,S,I,C=8*y-m-1,z=(1<<C)-1,N=z>>1,$=m===23?Math.pow(2,-24)-Math.pow(2,-77):0,Z=d?0:y-1,Q=d?1:-1,re=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(S=isNaN(t)?1:0,w=z):(w=Math.floor(Math.log(t)/Math.LN2),t*(I=Math.pow(2,-w))<1&&(w--,I*=2),(t+=w+N>=1?$/I:$*Math.pow(2,1-N))*I>=2&&(w++,I/=2),w+N>=z?(S=0,w=z):w+N>=1?(S=(t*I-1)*Math.pow(2,m),w+=N):(S=t*Math.pow(2,N-1)*Math.pow(2,m),w=0));m>=8;s[l+Z]=255&S,Z+=Q,S/=256,m-=8);for(w=w<<m|S,C+=m;C>0;s[l+Z]=255&w,Z+=Q,w/=256,C-=8);s[l+Z-Q]|=128*re};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function Lr(s){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(s)?s:new Uint8Array(s||0),this.pos=0,this.type=0,this.length=this.buf.length}Lr.Varint=0,Lr.Fixed64=1,Lr.Bytes=2,Lr.Fixed32=5;var Ch=4294967296,Pf=1/Ch,Df=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function Ga(s){return s.type===Lr.Bytes?s.readVarint()+s.pos:s.pos+1}function Cl(s,t,l){return l?4294967296*t+(s>>>0):4294967296*(t>>>0)+(s>>>0)}function Bf(s,t,l){var d=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));l.realloc(d);for(var m=l.pos-1;m>=s;m--)l.buf[m+d]=l.buf[m]}function pg(s,t){for(var l=0;l<s.length;l++)t.writeVarint(s[l])}function mg(s,t){for(var l=0;l<s.length;l++)t.writeSVarint(s[l])}function gg(s,t){for(var l=0;l<s.length;l++)t.writeFloat(s[l])}function _g(s,t){for(var l=0;l<s.length;l++)t.writeDouble(s[l])}function yg(s,t){for(var l=0;l<s.length;l++)t.writeBoolean(s[l])}function xg(s,t){for(var l=0;l<s.length;l++)t.writeFixed32(s[l])}function vg(s,t){for(var l=0;l<s.length;l++)t.writeSFixed32(s[l])}function bg(s,t){for(var l=0;l<s.length;l++)t.writeFixed64(s[l])}function wg(s,t){for(var l=0;l<s.length;l++)t.writeSFixed64(s[l])}function Lu(s,t){return(s[t]|s[t+1]<<8|s[t+2]<<16)+16777216*s[t+3]}function kl(s,t,l){s[l]=t,s[l+1]=t>>>8,s[l+2]=t>>>16,s[l+3]=t>>>24}function Rf(s,t){return(s[t]|s[t+1]<<8|s[t+2]<<16)+(s[t+3]<<24)}function Eg(s,t,l){t.glyphs=[],s===1&&l.readMessage(Tg,t)}function Tg(s,t,l){if(s===3){const{id:d,bitmap:m,width:y,height:w,left:S,top:I,advance:C}=l.readMessage(Sg,{});t.glyphs.push({id:d,bitmap:new ja({width:y+6,height:w+6},m),metrics:{width:y,height:w,left:S,top:I,advance:C}})}else s===4?t.ascender=l.readSVarint():s===5&&(t.descender=l.readSVarint())}function Sg(s,t,l){s===1?t.id=l.readVarint():s===2?t.bitmap=l.readBytes():s===3?t.width=l.readVarint():s===4?t.height=l.readVarint():s===5?t.left=l.readSVarint():s===6?t.top=l.readSVarint():s===7&&(t.advance=l.readVarint())}function kh(s){let t=0,l=0;for(const w of s)t+=w.w*w.h,l=Math.max(l,w.w);s.sort((w,S)=>S.h-w.h);const d=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),l),h:1/0}];let m=0,y=0;for(const w of s)for(let S=d.length-1;S>=0;S--){const I=d[S];if(!(w.w>I.w||w.h>I.h)){if(w.x=I.x,w.y=I.y,y=Math.max(y,w.y+w.h),m=Math.max(m,w.x+w.w),w.w===I.w&&w.h===I.h){const C=d.pop();S<d.length&&(d[S]=C)}else w.h===I.h?(I.x+=w.w,I.w-=w.w):w.w===I.w?(I.y+=w.h,I.h-=w.h):(d.push({x:I.x+w.w,y:I.y,w:I.w-w.w,h:w.h}),I.y+=w.h,I.h-=w.h);break}}return{w:m,h:y,fill:t/(m*y)||0}}Lr.prototype={destroy:function(){this.buf=null},readFields:function(s,t,l){for(l=l||this.length;this.pos<l;){var d=this.readVarint(),m=d>>3,y=this.pos;this.type=7&d,s(m,t,this),this.pos===y&&this.skip(d)}return t},readMessage:function(s,t){return this.readFields(s,t,this.readVarint()+this.pos)},readFixed32:function(){var s=Lu(this.buf,this.pos);return this.pos+=4,s},readSFixed32:function(){var s=Rf(this.buf,this.pos);return this.pos+=4,s},readFixed64:function(){var s=Lu(this.buf,this.pos)+Lu(this.buf,this.pos+4)*Ch;return this.pos+=8,s},readSFixed64:function(){var s=Lu(this.buf,this.pos)+Rf(this.buf,this.pos+4)*Ch;return this.pos+=8,s},readFloat:function(){var s=Cf(this.buf,this.pos,!0,23,4);return this.pos+=4,s},readDouble:function(){var s=Cf(this.buf,this.pos,!0,52,8);return this.pos+=8,s},readVarint:function(s){var t,l,d=this.buf;return t=127&(l=d[this.pos++]),l<128?t:(t|=(127&(l=d[this.pos++]))<<7,l<128?t:(t|=(127&(l=d[this.pos++]))<<14,l<128?t:(t|=(127&(l=d[this.pos++]))<<21,l<128?t:function(m,y,w){var S,I,C=w.buf;if(S=(112&(I=C[w.pos++]))>>4,I<128||(S|=(127&(I=C[w.pos++]))<<3,I<128)||(S|=(127&(I=C[w.pos++]))<<10,I<128)||(S|=(127&(I=C[w.pos++]))<<17,I<128)||(S|=(127&(I=C[w.pos++]))<<24,I<128)||(S|=(1&(I=C[w.pos++]))<<31,I<128))return Cl(m,S,y);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(l=d[this.pos]))<<28,s,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var s=this.readVarint();return s%2==1?(s+1)/-2:s/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var s=this.readVarint()+this.pos,t=this.pos;return this.pos=s,s-t>=12&&Df?function(l,d,m){return Df.decode(l.subarray(d,m))}(this.buf,t,s):function(l,d,m){for(var y="",w=d;w<m;){var S,I,C,z=l[w],N=null,$=z>239?4:z>223?3:z>191?2:1;if(w+$>m)break;$===1?z<128&&(N=z):$===2?(192&(S=l[w+1]))==128&&(N=(31&z)<<6|63&S)<=127&&(N=null):$===3?(I=l[w+2],(192&(S=l[w+1]))==128&&(192&I)==128&&((N=(15&z)<<12|(63&S)<<6|63&I)<=2047||N>=55296&&N<=57343)&&(N=null)):$===4&&(I=l[w+2],C=l[w+3],(192&(S=l[w+1]))==128&&(192&I)==128&&(192&C)==128&&((N=(15&z)<<18|(63&S)<<12|(63&I)<<6|63&C)<=65535||N>=1114112)&&(N=null)),N===null?(N=65533,$=1):N>65535&&(N-=65536,y+=String.fromCharCode(N>>>10&1023|55296),N=56320|1023&N),y+=String.fromCharCode(N),w+=$}return y}(this.buf,t,s)},readBytes:function(){var s=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,s);return this.pos=s,t},readPackedVarint:function(s,t){if(this.type!==Lr.Bytes)return s.push(this.readVarint(t));var l=Ga(this);for(s=s||[];this.pos<l;)s.push(this.readVarint(t));return s},readPackedSVarint:function(s){if(this.type!==Lr.Bytes)return s.push(this.readSVarint());var t=Ga(this);for(s=s||[];this.pos<t;)s.push(this.readSVarint());return s},readPackedBoolean:function(s){if(this.type!==Lr.Bytes)return s.push(this.readBoolean());var t=Ga(this);for(s=s||[];this.pos<t;)s.push(this.readBoolean());return s},readPackedFloat:function(s){if(this.type!==Lr.Bytes)return s.push(this.readFloat());var t=Ga(this);for(s=s||[];this.pos<t;)s.push(this.readFloat());return s},readPackedDouble:function(s){if(this.type!==Lr.Bytes)return s.push(this.readDouble());var t=Ga(this);for(s=s||[];this.pos<t;)s.push(this.readDouble());return s},readPackedFixed32:function(s){if(this.type!==Lr.Bytes)return s.push(this.readFixed32());var t=Ga(this);for(s=s||[];this.pos<t;)s.push(this.readFixed32());return s},readPackedSFixed32:function(s){if(this.type!==Lr.Bytes)return s.push(this.readSFixed32());var t=Ga(this);for(s=s||[];this.pos<t;)s.push(this.readSFixed32());return s},readPackedFixed64:function(s){if(this.type!==Lr.Bytes)return s.push(this.readFixed64());var t=Ga(this);for(s=s||[];this.pos<t;)s.push(this.readFixed64());return s},readPackedSFixed64:function(s){if(this.type!==Lr.Bytes)return s.push(this.readSFixed64());var t=Ga(this);for(s=s||[];this.pos<t;)s.push(this.readSFixed64());return s},skip:function(s){var t=7&s;if(t===Lr.Varint)for(;this.buf[this.pos++]>127;);else if(t===Lr.Bytes)this.pos=this.readVarint()+this.pos;else if(t===Lr.Fixed32)this.pos+=4;else{if(t!==Lr.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(s,t){this.writeVarint(s<<3|t)},realloc:function(s){for(var t=this.length||16;t<this.pos+s;)t*=2;if(t!==this.length){var l=new Uint8Array(t);l.set(this.buf),this.buf=l,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(s){this.realloc(4),kl(this.buf,s,this.pos),this.pos+=4},writeSFixed32:function(s){this.realloc(4),kl(this.buf,s,this.pos),this.pos+=4},writeFixed64:function(s){this.realloc(8),kl(this.buf,-1&s,this.pos),kl(this.buf,Math.floor(s*Pf),this.pos+4),this.pos+=8},writeSFixed64:function(s){this.realloc(8),kl(this.buf,-1&s,this.pos),kl(this.buf,Math.floor(s*Pf),this.pos+4),this.pos+=8},writeVarint:function(s){(s=+s||0)>268435455||s<0?function(t,l){var d,m;if(t>=0?(d=t%4294967296|0,m=t/4294967296|0):(m=~(-t/4294967296),4294967295^(d=~(-t%4294967296))?d=d+1|0:(d=0,m=m+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");l.realloc(10),function(y,w,S){S.buf[S.pos++]=127&y|128,y>>>=7,S.buf[S.pos++]=127&y|128,y>>>=7,S.buf[S.pos++]=127&y|128,y>>>=7,S.buf[S.pos++]=127&y|128,S.buf[S.pos]=127&(y>>>=7)}(d,0,l),function(y,w){var S=(7&y)<<4;w.buf[w.pos++]|=S|((y>>>=3)?128:0),y&&(w.buf[w.pos++]=127&y|((y>>>=7)?128:0),y&&(w.buf[w.pos++]=127&y|((y>>>=7)?128:0),y&&(w.buf[w.pos++]=127&y|((y>>>=7)?128:0),y&&(w.buf[w.pos++]=127&y|((y>>>=7)?128:0),y&&(w.buf[w.pos++]=127&y)))))}(m,l)}(s,this):(this.realloc(4),this.buf[this.pos++]=127&s|(s>127?128:0),s<=127||(this.buf[this.pos++]=127&(s>>>=7)|(s>127?128:0),s<=127||(this.buf[this.pos++]=127&(s>>>=7)|(s>127?128:0),s<=127||(this.buf[this.pos++]=s>>>7&127))))},writeSVarint:function(s){this.writeVarint(s<0?2*-s-1:2*s)},writeBoolean:function(s){this.writeVarint(Boolean(s))},writeString:function(s){s=String(s),this.realloc(4*s.length),this.pos++;var t=this.pos;this.pos=function(d,m,y){for(var w,S,I=0;I<m.length;I++){if((w=m.charCodeAt(I))>55295&&w<57344){if(!S){w>56319||I+1===m.length?(d[y++]=239,d[y++]=191,d[y++]=189):S=w;continue}if(w<56320){d[y++]=239,d[y++]=191,d[y++]=189,S=w;continue}w=S-55296<<10|w-56320|65536,S=null}else S&&(d[y++]=239,d[y++]=191,d[y++]=189,S=null);w<128?d[y++]=w:(w<2048?d[y++]=w>>6|192:(w<65536?d[y++]=w>>12|224:(d[y++]=w>>18|240,d[y++]=w>>12&63|128),d[y++]=w>>6&63|128),d[y++]=63&w|128)}return y}(this.buf,s,this.pos);var l=this.pos-t;l>=128&&Bf(t,l,this),this.pos=t-1,this.writeVarint(l),this.pos+=l},writeFloat:function(s){this.realloc(4),kf(this.buf,s,this.pos,!0,23,4),this.pos+=4},writeDouble:function(s){this.realloc(8),kf(this.buf,s,this.pos,!0,52,8),this.pos+=8},writeBytes:function(s){var t=s.length;this.writeVarint(t),this.realloc(t);for(var l=0;l<t;l++)this.buf[this.pos++]=s[l]},writeRawMessage:function(s,t){this.pos++;var l=this.pos;s(t,this);var d=this.pos-l;d>=128&&Bf(l,d,this),this.pos=l-1,this.writeVarint(d),this.pos+=d},writeMessage:function(s,t,l){this.writeTag(s,Lr.Bytes),this.writeRawMessage(t,l)},writePackedVarint:function(s,t){t.length&&this.writeMessage(s,pg,t)},writePackedSVarint:function(s,t){t.length&&this.writeMessage(s,mg,t)},writePackedBoolean:function(s,t){t.length&&this.writeMessage(s,yg,t)},writePackedFloat:function(s,t){t.length&&this.writeMessage(s,gg,t)},writePackedDouble:function(s,t){t.length&&this.writeMessage(s,_g,t)},writePackedFixed32:function(s,t){t.length&&this.writeMessage(s,xg,t)},writePackedSFixed32:function(s,t){t.length&&this.writeMessage(s,vg,t)},writePackedFixed64:function(s,t){t.length&&this.writeMessage(s,bg,t)},writePackedSFixed64:function(s,t){t.length&&this.writeMessage(s,wg,t)},writeBytesField:function(s,t){this.writeTag(s,Lr.Bytes),this.writeBytes(t)},writeFixed32Field:function(s,t){this.writeTag(s,Lr.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(s,t){this.writeTag(s,Lr.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(s,t){this.writeTag(s,Lr.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(s,t){this.writeTag(s,Lr.Fixed64),this.writeSFixed64(t)},writeVarintField:function(s,t){this.writeTag(s,Lr.Varint),this.writeVarint(t)},writeSVarintField:function(s,t){this.writeTag(s,Lr.Varint),this.writeSVarint(t)},writeStringField:function(s,t){this.writeTag(s,Lr.Bytes),this.writeString(t)},writeFloatField:function(s,t){this.writeTag(s,Lr.Fixed32),this.writeFloat(t)},writeDoubleField:function(s,t){this.writeTag(s,Lr.Fixed64),this.writeDouble(t)},writeBooleanField:function(s,t){this.writeVarintField(s,Boolean(t))}};class Ph{constructor(t,{pixelRatio:l,version:d,stretchX:m,stretchY:y,content:w}){this.paddedRect=t,this.pixelRatio=l,this.stretchX=m,this.stretchY=y,this.content=w,this.version=d}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Lf{constructor(t,l){const d={},m={};this.haveRenderCallbacks=[];const y=[];this.addImages(t,d,y),this.addImages(l,m,y);const{w,h:S}=kh(y),I=new lo({width:w||1,height:S||1});for(const C in t){const z=t[C],N=d[C].paddedRect;lo.copy(z.data,I,{x:0,y:0},{x:N.x+1,y:N.y+1},z.data)}for(const C in l){const z=l[C],N=m[C].paddedRect,$=N.x+1,Z=N.y+1,Q=z.data.width,re=z.data.height;lo.copy(z.data,I,{x:0,y:0},{x:$,y:Z},z.data),lo.copy(z.data,I,{x:0,y:re-1},{x:$,y:Z-1},{width:Q,height:1}),lo.copy(z.data,I,{x:0,y:0},{x:$,y:Z+re},{width:Q,height:1}),lo.copy(z.data,I,{x:Q-1,y:0},{x:$-1,y:Z},{width:1,height:re}),lo.copy(z.data,I,{x:0,y:0},{x:$+Q,y:Z},{width:1,height:re})}this.image=I,this.iconPositions=d,this.patternPositions=m}addImages(t,l,d){for(const m in t){const y=t[m],w={x:0,y:0,w:y.data.width+2,h:y.data.height+2};d.push(w),l[m]=new Ph(w,y),y.hasRenderCallback&&this.haveRenderCallbacks.push(m)}}patchUpdatedImages(t,l){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(d=>t.hasImage(d)),t.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const d in t.updatedImages)this.patchUpdatedImage(this.iconPositions[d],t.getImage(d),l),this.patchUpdatedImage(this.patternPositions[d],t.getImage(d),l)}patchUpdatedImage(t,l,d){if(!t||!l||t.version===l.version)return;t.version=l.version;const[m,y]=t.tl;d.update(l.data,void 0,{x:m,y})}}_i(Ph,"ImagePosition"),_i(Lf,"ImageAtlas");const To={horizontal:1,vertical:2,horizontalOnly:3};class Mc{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,l){const d=new Mc;return d.scale=t||1,d.fontStack=l,d}static forImage(t){const l=new Mc;return l.imageName=t,l}}class Pl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,l){const d=new Pl;for(let m=0;m<t.sections.length;m++){const y=t.sections[m];y.image?d.addImageSection(y):d.addTextSection(y,l)}return d}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCharCode(t){return this.text.charCodeAt(t)}verticalizePunctuation(t){this.text=function(l,d){let m="";for(let y=0;y<l.length;y++){const w=l.charCodeAt(y+1)||null,S=l.charCodeAt(y-1)||null;m+=!d&&(w&&k(w)&&!Tc[l[y+1]]||S&&k(S)&&!Tc[l[y-1]])||!Tc[l[y]]?l[y]:Tc[l[y]]}return m}(this.text,t)}trim(){let t=0;for(let d=0;d<this.text.length&&zu[this.text.charCodeAt(d)];d++)t++;let l=this.text.length;for(let d=this.text.length-1;d>=0&&d>=t&&zu[this.text.charCodeAt(d)];d--)l--;this.text=this.text.substring(t,l),this.sectionIndex=this.sectionIndex.slice(t,l)}substring(t,l){const d=new Pl;return d.text=this.text.substring(t,l),d.sectionIndex=this.sectionIndex.slice(t,l),d.sections=this.sections,d}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,l)=>Math.max(t,this.sections[l].scale),0)}addTextSection(t,l){this.text+=t.text,this.sections.push(Mc.forText(t.scale,t.fontStack||l));const d=this.sections.length-1;for(let m=0;m<t.text.length;++m)this.sectionIndex.push(d)}addImageSection(t){const l=t.image?t.image.name:"";if(l.length===0)return void yi("Can't add FormattedSection with an empty image.");const d=this.getNextImageSectionCharCode();d?(this.text+=String.fromCharCode(d),this.sections.push(Mc.forImage(l)),this.sectionIndex.push(this.sections.length-1)):yi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Dh(s,t,l,d,m,y,w,S,I,C,z,N,$,Z,Q,re){const ue=Pl.fromFeature(s,m);let Se;N===To.vertical&&ue.verticalizePunctuation($);const{processBidirectionalText:Le,processStyledBidirectionalText:Te}=ze;if(Le&&ue.sections.length===1){Se=[];const Oe=Le(ue.toString(),Bh(ue,C,y,t,d,Z,Q));for(const st of Oe){const rt=new Pl;rt.text=st,rt.sections=ue.sections;for(let mt=0;mt<st.length;mt++)rt.sectionIndex.push(0);Se.push(rt)}}else if(Te){Se=[];const Oe=Te(ue.text,ue.sectionIndex,Bh(ue,C,y,t,d,Z,Q));for(const st of Oe){const rt=new Pl;rt.text=st[0],rt.sectionIndex=st[1],rt.sections=ue.sections,Se.push(rt)}}else Se=function(Oe,st){const rt=[],mt=Oe.text;let Ft=0;for(const ct of st)rt.push(Oe.substring(Ft,ct)),Ft=ct;return Ft<mt.length&&rt.push(Oe.substring(Ft,mt.length)),rt}(ue,Bh(ue,C,y,t,d,Z,Q));const Ce=[],Ne={positionedLines:Ce,text:ue.toString(),top:z[1],bottom:z[1],left:z[0],right:z[0],writingMode:N,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Oe,st,rt,mt,Ft,ct,Et,Mt,Lt,Vt,gt,xi){let qi=0,ki=0,Si=0;const ai=Mt==="right"?1:Mt==="left"?0:.5;let ji=!1;for(const tr of Ft){const lr=tr.getSections();for(const Mr of lr){if(Mr.imageName)continue;const Ur=st[Mr.fontStack];if(Ur&&(ji=Ur.ascender!==void 0&&Ur.descender!==void 0,!ji))break}if(!ji)break}let Qi=0;for(const tr of Ft){tr.trim();const lr=tr.getMaxScale(),Mr=(lr-1)*In,Ur={positionedGlyphs:[],lineOffset:0};Oe.positionedLines[Qi]=Ur;const zr=Ur.positionedGlyphs;let $r=0;if(!tr.length()){ki+=ct,++Qi;continue}let Gr=0,Qr=0;for(let wr=0;wr<tr.length();wr++){const cn=tr.getSection(wr),on=tr.getSectionIndex(wr),mr=tr.getCharCode(wr);let Wr=cn.scale,pn=null,Ar=null,tn=null,zn=In,bn=0;const wn=!(Lt===To.horizontal||!gt&&!A(mr)||gt&&(zu[mr]||(Ji=mr,iu(Ji)||Os(Ji)||ru(Ji)||oc(Ji)||g(Ji))));if(cn.imageName){const Xn=mt[cn.imageName];if(!Xn)continue;tn=cn.imageName,Oe.iconsInText=Oe.iconsInText||!0,Ar=Xn.paddedRect;const En=Xn.displaySize;Wr=Wr*In/xi,pn={width:En[0],height:En[1],left:1,top:-3,advance:wn?En[1]:En[0],localGlyph:!1},bn=ji?-pn.height*Wr:lr*In-17-En[1]*Wr,zn=pn.advance;const Xa=(wn?En[0]:En[1])*Wr-In*lr;Xa>0&&Xa>$r&&($r=Xa)}else{const Xn=rt[cn.fontStack];if(!Xn)continue;Xn[mr]&&(Ar=Xn[mr]);const En=st[cn.fontStack];if(!En)continue;const Xa=En.glyphs[mr];if(!Xa)continue;if(pn=Xa.metrics,zn=mr!==8203?In:0,ji){const Ul=En.ascender!==void 0?Math.abs(En.ascender):0,Fc=En.descender!==void 0?Math.abs(En.descender):0,Nc=(Ul+Fc)*Wr;Gr<Nc&&(Gr=Nc,Qr=(Ul-Fc)/2*Wr),bn=-Ul*Wr}else bn=(lr-Wr)*In-17}wn?(Oe.verticalizable=!0,zr.push({glyph:mr,imageName:tn,x:qi,y:ki+bn,vertical:wn,scale:Wr,localGlyph:pn.localGlyph,fontStack:cn.fontStack,sectionIndex:on,metrics:pn,rect:Ar}),qi+=zn*Wr+Vt):(zr.push({glyph:mr,imageName:tn,x:qi,y:ki+bn,vertical:wn,scale:Wr,localGlyph:pn.localGlyph,fontStack:cn.fontStack,sectionIndex:on,metrics:pn,rect:Ar}),qi+=pn.advance*Wr+Vt)}zr.length!==0&&(Si=Math.max(qi-Vt,Si),ji?Uf(zr,ai,$r,Qr,ct*lr/2):Uf(zr,ai,$r,0,ct/2)),qi=0;const vn=ct*lr+$r;Ur.lineOffset=Math.max($r,Mr),ki+=vn,++Qi}var Ji;const pr=ki,{horizontalAlign:Yi,verticalAlign:jr}=Rh(Et);(function(tr,lr,Mr,Ur,zr,$r){const Gr=(lr-Mr)*zr,Qr=-$r*Ur;for(const vn of tr)for(const wr of vn.positionedGlyphs)wr.x+=Gr,wr.y+=Qr})(Oe.positionedLines,ai,Yi,jr,Si,pr),Oe.top+=-jr*pr,Oe.bottom=Oe.top+pr,Oe.left+=-Yi*Si,Oe.right=Oe.left+Si,Oe.hasBaseline=ji}(Ne,t,l,d,Se,w,S,I,N,C,$,re),!function(Oe){for(const st of Oe)if(st.positionedGlyphs.length!==0)return!1;return!0}(Ce)&&Ne}const zu={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Mg={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function zf(s,t,l,d,m,y){if(t.imageName){const w=d[t.imageName];return w?w.displaySize[0]*t.scale*In/y+m:0}{const w=l[t.fontStack],S=w&&w.glyphs[s];return S?S.metrics.advance*t.scale+m:0}}function Of(s,t,l,d){const m=Math.pow(s-t,2);return d?s<t?m/2:2*m:m+Math.abs(l)*l}function Ag(s,t,l){let d=0;return s===10&&(d-=1e4),l&&(d+=150),s!==40&&s!==65288||(d+=50),t!==41&&t!==65289||(d+=50),d}function Ff(s,t,l,d,m,y){let w=null,S=Of(t,l,m,y);for(const I of d){const C=Of(t-I.x,l,m,y)+I.badness;C<=S&&(w=I,S=C)}return{index:s,x:t,priorBreak:w,badness:S}}function Nf(s){return s?Nf(s.priorBreak).concat(s.index):[]}function Bh(s,t,l,d,m,y,w){if(y!=="point")return[];if(!s)return[];const S=[],I=function($,Z,Q,re,ue,Se){let Le=0;for(let Te=0;Te<$.length();Te++){const Ce=$.getSection(Te);Le+=zf($.getCharCode(Te),Ce,re,ue,Z,Se)}return Le/Math.max(1,Math.ceil(Le/Q))}(s,t,l,d,m,w),C=s.text.indexOf("\u200B")>=0;let z=0;for(let $=0;$<s.length();$++){const Z=s.getSection($),Q=s.getCharCode($);if(zu[Q]||(z+=zf(Q,Z,d,m,t,w)),$<s.length()-1){const re=!((N=Q)<11904||!(gl(N)||ml(N)||yl(N)||hu(N)||su(N)||tc(N)||ou(N)||Fs(N)||lu(N)||nc(N)||rc(N)||c(N)||pl(N)||ic(N)||nu(N)||au(N)||Ns(N)||du(N)||cu(N)||_l(N)));(Mg[Q]||re||Z.imageName)&&S.push(Ff($+1,z,I,S,Ag(Q,s.getCharCode($+1),re&&C),!1))}}var N;return Nf(Ff(s.length(),z,I,S,0,!0))}function Rh(s){let t=.5,l=.5;switch(s){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(s){case"bottom":case"bottom-right":case"bottom-left":l=1;break;case"top":case"top-right":case"top-left":l=0}return{horizontalAlign:t,verticalAlign:l}}function Uf(s,t,l,d,m){if(!(t||l||d||m))return;const y=s.length-1,w=s[y],S=(w.x+w.metrics.advance*w.scale)*t;for(let I=0;I<=y;I++)s[I].x-=S,s[I].y+=l+d+m}function Ig(s,t,l){const{horizontalAlign:d,verticalAlign:m}=Rh(l),y=t[0]-s.displaySize[0]*d,w=t[1]-s.displaySize[1]*m;return{image:s,top:w,bottom:w+s.displaySize[1],left:y,right:y+s.displaySize[0]}}function $f(s,t,l,d,m,y){const w=s.image;let S;if(w.content){const ue=w.content,Se=w.pixelRatio||1;S=[ue[0]/Se,ue[1]/Se,w.displaySize[0]-ue[2]/Se,w.displaySize[1]-ue[3]/Se]}const I=t.left*y,C=t.right*y;let z,N,$,Z;l==="width"||l==="both"?(Z=m[0]+I-d[3],N=m[0]+C+d[1]):(Z=m[0]+(I+C-w.displaySize[0])/2,N=Z+w.displaySize[0]);const Q=t.top*y,re=t.bottom*y;return l==="height"||l==="both"?(z=m[1]+Q-d[0],$=m[1]+re+d[2]):(z=m[1]+(Q+re-w.displaySize[1])/2,$=z+w.displaySize[1]),{image:w,top:z,right:N,bottom:$,left:Z,collisionPadding:S}}class qa extends J{constructor(t,l,d,m,y){super(t,l),this.angle=m,this.z=d,y!==void 0&&(this.segment=y)}clone(){return new qa(this.x,this.y,this.z,this.angle,this.segment)}}function Vf(s,t,l,d,m){if(t.segment===void 0)return!0;let y=t,w=t.segment+1,S=0;for(;S>-l/2;){if(w--,w<0)return!1;S-=s[w].dist(y),y=s[w]}S+=s[w].dist(s[w+1]),w++;const I=[];let C=0;for(;S<l/2;){const z=s[w],N=s[w+1];if(!N)return!1;let $=s[w-1].angleTo(z)-z.angleTo(N);for($=Math.abs(($+3*Math.PI)%(2*Math.PI)-Math.PI),I.push({distance:S,angleDelta:$}),C+=$;S-I[0].distance>d;)C-=I.shift().angleDelta;if(C>m)return!1;w++,S+=z.dist(N)}return!0}function jf(s){let t=0;for(let l=0;l<s.length-1;l++)t+=s[l].dist(s[l+1]);return t}function Gf(s,t,l){return s?.6*t*l:0}function qf(s,t){return Math.max(s?s.right-s.left:0,t?t.right-t.left:0)}function Cg(s,t,l,d,m,y){const w=Gf(l,m,y),S=qf(l,d)*y;let I=0;const C=jf(s)/2;for(let z=0;z<s.length-1;z++){const N=s[z],$=s[z+1],Z=N.dist($);if(I+Z>C){const Q=(C-I)/Z,re=ur(N.x,$.x,Q),ue=ur(N.y,$.y,Q),Se=new qa(re,ue,0,$.angleTo(N),z);return!w||Vf(s,Se,S,w,t)?Se:void 0}I+=Z}}function kg(s,t,l,d,m,y,w,S,I){const C=Gf(d,y,w),z=qf(d,m),N=z*w,$=s[0].x===0||s[0].x===I||s[0].y===0||s[0].y===I;return t-N<t/4&&(t=N+t/4),Zf(s,$?t/2*S%t:(z/2+2*y)*w*S%t,t,C,l,N,$,!1,I)}function Zf(s,t,l,d,m,y,w,S,I){const C=y/2,z=jf(s);let N=0,$=t-l,Z=[];for(let Q=0;Q<s.length-1;Q++){const re=s[Q],ue=s[Q+1],Se=re.dist(ue),Le=ue.angleTo(re);for(;$+l<N+Se;){$+=l;const Te=($-N)/Se,Ce=ur(re.x,ue.x,Te),Ne=ur(re.y,ue.y,Te);if(Ce>=0&&Ce<I&&Ne>=0&&Ne<I&&$-C>=0&&$+C<=z){const Oe=new qa(Ce,Ne,0,Le,Q);Oe._round(),d&&!Vf(s,Oe,y,d,m)||Z.push(Oe)}}N+=Se}return S||Z.length||w||(Z=Zf(s,N/2,l,d,m,y,w,!0,I)),Z}function Xf(s,t,l,d,m){const y=[];for(let w=0;w<s.length;w++){const S=s[w];let I;for(let C=0;C<S.length-1;C++){let z=S[C],N=S[C+1];z.x<t&&N.x<t||(z.x<t?z=new J(t,z.y+(t-z.x)/(N.x-z.x)*(N.y-z.y))._round():N.x<t&&(N=new J(t,z.y+(t-z.x)/(N.x-z.x)*(N.y-z.y))._round()),z.y<l&&N.y<l||(z.y<l?z=new J(z.x+(l-z.y)/(N.y-z.y)*(N.x-z.x),l)._round():N.y<l&&(N=new J(z.x+(l-z.y)/(N.y-z.y)*(N.x-z.x),l)._round()),z.x>=d&&N.x>=d||(z.x>=d?z=new J(d,z.y+(d-z.x)/(N.x-z.x)*(N.y-z.y))._round():N.x>=d&&(N=new J(d,z.y+(d-z.x)/(N.x-z.x)*(N.y-z.y))._round()),z.y>=m&&N.y>=m||(z.y>=m?z=new J(z.x+(m-z.y)/(N.y-z.y)*(N.x-z.x),m)._round():N.y>=m&&(N=new J(z.x+(m-z.y)/(N.y-z.y)*(N.x-z.x),m)._round()),I&&z.equals(I[I.length-1])||(I=[z],y.push(I)),I.push(N)))))}}return y}_i(qa,"Anchor");const Ac=1e20;function Hf(s,t,l,d,m,y,w,S,I){for(let C=t;C<t+d;C++)Wf(s,l*y+C,y,m,w,S,I);for(let C=l;C<l+m;C++)Wf(s,C*y+t,1,d,w,S,I)}function Wf(s,t,l,d,m,y,w){y[0]=0,w[0]=-Ac,w[1]=Ac,m[0]=s[t];for(let S=1,I=0,C=0;S<d;S++){m[S]=s[t+S*l];const z=S*S;do{const N=y[I];C=(m[S]-m[N]+z-N*N)/(S-N)/2}while(C<=w[I]&&--I>-1);I++,y[I]=S,w[I]=C,w[I+1]=Ac}for(let S=0,I=0;S<d;S++){for(;w[I+1]<S;)I++;const C=y[I],z=S-C;s[t+S*l]=m[C]+z*z}}const Lh={none:0,ideographs:1,all:2};class Dl{constructor(t,l,d){this.requestManager=t,this.localGlyphMode=l,this.localFontFamily=d,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t){this.url=t}getGlyphs(t,l){const d=[];for(const m in t)for(const y of t[m])d.push({stack:m,id:y});$t(d,({stack:m,id:y},w)=>{let S=this.entries[m];S||(S=this.entries[m]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let I=S.glyphs[y];if(I!==void 0)return void w(null,{stack:m,id:y,glyph:I});if(I=this._tinySDF(S,m,y),I)return S.glyphs[y]=I,void w(null,{stack:m,id:y,glyph:I});const C=Math.floor(y/256);if(256*C>65535)return void w(new Error("glyphs > 65535 not supported"));if(S.ranges[C])return void w(null,{stack:m,id:y,glyph:I});let z=S.requests[C];z||(z=S.requests[C]=[],Dl.loadGlyphRange(m,C,this.url,this.requestManager,(N,$)=>{if($){S.ascender=$.ascender,S.descender=$.descender;for(const Z in $.glyphs)this._doesCharSupportLocalGlyph(+Z)||(S.glyphs[+Z]=$.glyphs[+Z]);S.ranges[C]=!0}for(const Z of z)Z(N,$);delete S.requests[C]})),z.push((N,$)=>{N?w(N):$&&w(null,{stack:m,id:y,glyph:$.glyphs[y]||null})})},(m,y)=>{if(m)l(m);else if(y){const w={};for(const{stack:S,id:I,glyph:C}of y)w[S]===void 0&&(w[S]={}),w[S].glyphs===void 0&&(w[S].glyphs={}),w[S].glyphs[I]=C&&{id:C.id,bitmap:C.bitmap.clone(),metrics:C.metrics},w[S].ascender=this.entries[S].ascender,w[S].descender=this.entries[S].descender;l(null,w)}})}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==Lh.none&&(this.localGlyphMode===Lh.all?!!this.localFontFamily:!!this.localFontFamily&&(nc(t)||uu(t)||pl(t)||Ns(t)||Fs(t)))}_tinySDF(t,l,d){const m=this.localFontFamily;if(!m||!this._doesCharSupportLocalGlyph(d))return;let y=t.tinySDF;if(!y){let re="400";/bold/i.test(l)?re="900":/medium/i.test(l)?re="500":/light/i.test(l)&&(re="200"),y=t.tinySDF=new Dl.TinySDF({fontFamily:m,fontWeight:re,fontSize:48,buffer:6,radius:16}),y.fontWeight=re}if(this.localGlyphs[y.fontWeight][d])return this.localGlyphs[y.fontWeight][d];const w=String.fromCharCode(d),{data:S,width:I,height:C,glyphWidth:z,glyphHeight:N,glyphLeft:$,glyphTop:Z,glyphAdvance:Q}=y.draw(w);return this.localGlyphs[y.fontWeight][d]={id:d,bitmap:new ja({width:I,height:C},S),metrics:{width:z/2,height:N/2,left:$/2,top:Z/2-27,advance:Q/2,localGlyph:!0}}}}function Yf(s,t,l,d){const m=[],y=s.image,w=y.pixelRatio,S=y.paddedRect.w-2,I=y.paddedRect.h-2,C=s.right-s.left,z=s.bottom-s.top,N=y.stretchX||[[0,S]],$=y.stretchY||[[0,I]],Z=(ct,Et)=>ct+Et[1]-Et[0],Q=N.reduce(Z,0),re=$.reduce(Z,0),ue=S-Q,Se=I-re;let Le=0,Te=Q,Ce=0,Ne=re,Oe=0,st=ue,rt=0,mt=Se;if(y.content&&d){const ct=y.content;Le=Ou(N,0,ct[0]),Ce=Ou($,0,ct[1]),Te=Ou(N,ct[0],ct[2]),Ne=Ou($,ct[1],ct[3]),Oe=ct[0]-Le,rt=ct[1]-Ce,st=ct[2]-ct[0]-Te,mt=ct[3]-ct[1]-Ne}const Ft=(ct,Et,Mt,Lt)=>{const Vt=Fu(ct.stretch-Le,Te,C,s.left),gt=Nu(ct.fixed-Oe,st,ct.stretch,Q),xi=Fu(Et.stretch-Ce,Ne,z,s.top),qi=Nu(Et.fixed-rt,mt,Et.stretch,re),ki=Fu(Mt.stretch-Le,Te,C,s.left),Si=Nu(Mt.fixed-Oe,st,Mt.stretch,Q),ai=Fu(Lt.stretch-Ce,Ne,z,s.top),ji=Nu(Lt.fixed-rt,mt,Lt.stretch,re),Qi=new J(Vt,xi),Ji=new J(ki,xi),pr=new J(ki,ai),Yi=new J(Vt,ai),jr=new J(gt/w,qi/w),tr=new J(Si/w,ji/w),lr=t*Math.PI/180;if(lr){const zr=Math.sin(lr),$r=Math.cos(lr),Gr=[$r,-zr,zr,$r];Qi._matMult(Gr),Ji._matMult(Gr),Yi._matMult(Gr),pr._matMult(Gr)}const Mr=ct.stretch+ct.fixed,Ur=Et.stretch+Et.fixed;return{tl:Qi,tr:Ji,bl:Yi,br:pr,tex:{x:y.paddedRect.x+1+Mr,y:y.paddedRect.y+1+Ur,w:Mt.stretch+Mt.fixed-Mr,h:Lt.stretch+Lt.fixed-Ur},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:jr,pixelOffsetBR:tr,minFontScaleX:st/w/C,minFontScaleY:mt/w/z,isSDF:l}};if(d&&(y.stretchX||y.stretchY)){const ct=Kf(N,ue,Q),Et=Kf($,Se,re);for(let Mt=0;Mt<ct.length-1;Mt++){const Lt=ct[Mt],Vt=ct[Mt+1];for(let gt=0;gt<Et.length-1;gt++)m.push(Ft(Lt,Et[gt],Vt,Et[gt+1]))}}else m.push(Ft({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:S+1},{fixed:0,stretch:I+1}));return m}function Ou(s,t,l){let d=0;for(const m of s)d+=Math.max(t,Math.min(l,m[1]))-Math.max(t,Math.min(l,m[0]));return d}function Kf(s,t,l){const d=[{fixed:-1,stretch:0}];for(const[m,y]of s){const w=d[d.length-1];d.push({fixed:m-w.stretch,stretch:w.stretch}),d.push({fixed:m-w.stretch,stretch:w.stretch+(y-m)})}return d.push({fixed:t+1,stretch:l}),d}function Fu(s,t,l,d){return s/t*l+d}function Nu(s,t,l,d){return s-t*l/d}function Pg(s,t,l,d){const m=t+s.positionedLines[d].lineOffset;return d===0?l+m/2:l+(m+(t+s.positionedLines[d-1].lineOffset))/2}Dl.loadGlyphRange=function(s,t,l,d,m){const y=256*t,w=y+255,S=d.transformRequest(d.normalizeGlyphsURL(l).replace("{fontstack}",s).replace("{range}",`${y}-${w}`),Kt.Glyphs);Xi(S,(I,C)=>{if(I)m(I);else if(C){const z={},N=function($){return new Sc($).readFields(Eg,{})}(C);for(const $ of N.glyphs)z[$.id]=$;m(null,{glyphs:z,ascender:N.ascender,descender:N.descender})}})},Dl.TinySDF=class{constructor({fontSize:s=24,buffer:t=3,radius:l=8,cutoff:d=.25,fontFamily:m="sans-serif",fontWeight:y="normal",fontStyle:w="normal"}={}){this.buffer=t,this.cutoff=d,this.radius=l;const S=this.size=s+4*t,I=this._createCanvas(S),C=this.ctx=I.getContext("2d",{willReadFrequently:!0});C.font=`${w} ${y} ${s}px ${m}`,C.textBaseline="alphabetic",C.textAlign="left",C.fillStyle="black",this.gridOuter=new Float64Array(S*S),this.gridInner=new Float64Array(S*S),this.f=new Float64Array(S),this.z=new Float64Array(S+1),this.v=new Uint16Array(S)}_createCanvas(s){const t=document.createElement("canvas");return t.width=t.height=s,t}draw(s){const{width:t,actualBoundingBoxAscent:l,actualBoundingBoxDescent:d,actualBoundingBoxLeft:m,actualBoundingBoxRight:y}=this.ctx.measureText(s),w=Math.ceil(l),S=Math.min(this.size-this.buffer,Math.ceil(y-m)),I=Math.min(this.size-this.buffer,w+Math.ceil(d)),C=S+2*this.buffer,z=I+2*this.buffer,N=Math.max(C*z,0),$=new Uint8ClampedArray(N),Z={data:$,width:C,height:z,glyphWidth:S,glyphHeight:I,glyphTop:w,glyphLeft:0,glyphAdvance:t};if(S===0||I===0)return Z;const{ctx:Q,buffer:re,gridInner:ue,gridOuter:Se}=this;Q.clearRect(re,re,S,I),Q.fillText(s,re,re+w);const Le=Q.getImageData(re,re,S,I);Se.fill(Ac,0,N),ue.fill(0,0,N);for(let Te=0;Te<I;Te++)for(let Ce=0;Ce<S;Ce++){const Ne=Le.data[4*(Te*S+Ce)+3]/255;if(Ne===0)continue;const Oe=(Te+re)*C+Ce+re;if(Ne===1)Se[Oe]=0,ue[Oe]=Ac;else{const st=.5-Ne;Se[Oe]=st>0?st*st:0,ue[Oe]=st<0?st*st:0}}Hf(Se,0,0,C,z,C,this.f,this.v,this.z),Hf(ue,re,re,S,I,C,this.f,this.v,this.z);for(let Te=0;Te<N;Te++){const Ce=Math.sqrt(Se[Te])-Math.sqrt(ue[Te]);$[Te]=Math.round(255-255*(Ce/this.radius+this.cutoff))}return Z}};class Dg{constructor(t=[],l=Bg){if(this.data=t,this.length=this.data.length,this.compare=l,this.length>0)for(let d=(this.length>>1)-1;d>=0;d--)this._down(d)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const t=this.data[0],l=this.data.pop();return this.length--,this.length>0&&(this.data[0]=l,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:l,compare:d}=this,m=l[t];for(;t>0;){const y=t-1>>1,w=l[y];if(d(m,w)>=0)break;l[t]=w,t=y}l[t]=m}_down(t){const{data:l,compare:d}=this,m=this.length>>1,y=l[t];for(;t<m;){let w=1+(t<<1),S=l[w];const I=w+1;if(I<this.length&&d(l[I],S)<0&&(w=I,S=l[I]),d(S,y)>=0)break;l[t]=S,t=w}l[t]=y}}function Bg(s,t){return s<t?-1:s>t?1:0}function Rg(s,t=1,l=!1){let d=1/0,m=1/0,y=-1/0,w=-1/0;const S=s[0];for(let Z=0;Z<S.length;Z++){const Q=S[Z];(!Z||Q.x<d)&&(d=Q.x),(!Z||Q.y<m)&&(m=Q.y),(!Z||Q.x>y)&&(y=Q.x),(!Z||Q.y>w)&&(w=Q.y)}const I=Math.min(y-d,w-m);let C=I/2;const z=new Dg([],Lg);if(I===0)return new J(d,m);for(let Z=d;Z<y;Z+=I)for(let Q=m;Q<w;Q+=I)z.push(new Bl(Z+C,Q+C,C,s));let N=function(Z){let Q=0,re=0,ue=0;const Se=Z[0];for(let Le=0,Te=Se.length,Ce=Te-1;Le<Te;Ce=Le++){const Ne=Se[Le],Oe=Se[Ce],st=Ne.x*Oe.y-Oe.x*Ne.y;re+=(Ne.x+Oe.x)*st,ue+=(Ne.y+Oe.y)*st,Q+=3*st}return new Bl(re/Q,ue/Q,0,Z)}(s),$=z.length;for(;z.length;){const Z=z.pop();(Z.d>N.d||!N.d)&&(N=Z,l&&console.log("found best %d after %d probes",Math.round(1e4*Z.d)/1e4,$)),Z.max-N.d<=t||(C=Z.h/2,z.push(new Bl(Z.p.x-C,Z.p.y-C,C,s)),z.push(new Bl(Z.p.x+C,Z.p.y-C,C,s)),z.push(new Bl(Z.p.x-C,Z.p.y+C,C,s)),z.push(new Bl(Z.p.x+C,Z.p.y+C,C,s)),$+=4)}return l&&(console.log(`num probes: ${$}`),console.log(`best distance: ${N.d}`)),N.p}function Lg(s,t){return t.max-s.max}function Bl(s,t,l,d){this.p=new J(s,t),this.h=l,this.d=function(m,y){let w=!1,S=1/0;for(let I=0;I<y.length;I++){const C=y[I];for(let z=0,N=C.length,$=N-1;z<N;$=z++){const Z=C[z],Q=C[$];Z.y>m.y!=Q.y>m.y&&m.x<(Q.x-Z.x)*(m.y-Z.y)/(Q.y-Z.y)+Z.x&&(w=!w),S=Math.min(S,Ld(m,Z,Q))}}return(w?1:-1)*Math.sqrt(S)}(this.p,d),this.max=this.d+this.h*Math.SQRT2}const zh=Number.POSITIVE_INFINITY,zg=Math.sqrt(2);function Qf(s,t){return t[1]!==zh?function(l,d,m){let y=0,w=0;switch(d=Math.abs(d),m=Math.abs(m),l){case"top-right":case"top-left":case"top":w=m-7;break;case"bottom-right":case"bottom-left":case"bottom":w=7-m}switch(l){case"top-right":case"bottom-right":case"right":y=-d;break;case"top-left":case"bottom-left":case"left":y=d}return[y,w]}(s,t[0],t[1]):function(l,d){let m=0,y=0;d<0&&(d=0);const w=d/zg;switch(l){case"top-right":case"top-left":y=w-7;break;case"bottom-right":case"bottom-left":y=7-w;break;case"bottom":y=7-d;break;case"top":y=d-7}switch(l){case"top-right":case"bottom-right":m=-w;break;case"top-left":case"bottom-left":m=w;break;case"left":m=d;break;case"right":m=-d}return[m,y]}(s,t[0])}function Og(s,t,l,d,m,y,w,S,I,C){s.createArrays(),s.tilePixelRatio=Gi/(512*s.overscaling),s.compareText={},s.iconsNeedLinear=!1;const z=s.layers[0].layout,N=s.layers[0]._unevaluatedLayout._values,$={};if(s.textSizeData.kind==="composite"){const{minZoom:re,maxZoom:ue}=s.textSizeData;$.compositeTextSizes=[N["text-size"].possiblyEvaluate(new Me(re),S),N["text-size"].possiblyEvaluate(new Me(ue),S)]}if(s.iconSizeData.kind==="composite"){const{minZoom:re,maxZoom:ue}=s.iconSizeData;$.compositeIconSizes=[N["icon-size"].possiblyEvaluate(new Me(re),S),N["icon-size"].possiblyEvaluate(new Me(ue),S)]}$.layoutTextSize=N["text-size"].possiblyEvaluate(new Me(I+1),S),$.layoutIconSize=N["icon-size"].possiblyEvaluate(new Me(I+1),S),$.textMaxSize=N["text-size"].possiblyEvaluate(new Me(18),S);const Z=z.get("text-rotation-alignment")==="map"&&z.get("symbol-placement")!=="point",Q=z.get("text-size");for(const re of s.features){const ue=z.get("text-font").evaluate(re,{},S).join(","),Se=Q.evaluate(re,{},S),Le=$.layoutTextSize.evaluate(re,{},S),Te=($.layoutIconSize.evaluate(re,{},S),{horizontal:{},vertical:void 0}),Ce=re.text;let Ne,Oe=[0,0];if(Ce){const mt=Ce.toString(),Ft=z.get("text-letter-spacing").evaluate(re,{},S)*In,ct=z.get("text-line-height").evaluate(re,{},S)*In,Et=x(mt)?Ft:0,Mt=z.get("text-anchor").evaluate(re,{},S),Lt=z.get("text-variable-anchor");if(!Lt){const Si=z.get("text-radial-offset").evaluate(re,{},S);Oe=Si?Qf(Mt,[Si*In,zh]):z.get("text-offset").evaluate(re,{},S).map(ai=>ai*In)}let Vt=Z?"center":z.get("text-justify").evaluate(re,{},S);const gt=z.get("symbol-placement"),xi=gt==="point",qi=gt==="point"?z.get("text-max-width").evaluate(re,{},S)*In:0,ki=Si=>{s.allowVerticalPlacement&&p(mt)&&(Te.vertical=Dh(Ce,t,l,m,ue,qi,ct,Mt,Si,Et,Oe,To.vertical,!0,gt,Le,Se))};if(!Z&&Lt){const Si=Vt==="auto"?Lt.map(ji=>Oh(ji)):[Vt];let ai=!1;for(let ji=0;ji<Si.length;ji++){const Qi=Si[ji];if(!Te.horizontal[Qi])if(ai)Te.horizontal[Qi]=Te.horizontal[0];else{const Ji=Dh(Ce,t,l,m,ue,qi,ct,"center",Qi,Et,Oe,To.horizontal,!1,gt,Le,Se);Ji&&(Te.horizontal[Qi]=Ji,ai=Ji.positionedLines.length===1)}}ki("left")}else{if(Vt==="auto"&&(Vt=Oh(Mt)),xi||z.get("text-writing-mode").indexOf("horizontal")>=0||!p(mt)){const Si=Dh(Ce,t,l,m,ue,qi,ct,Mt,Vt,Et,Oe,To.horizontal,!1,gt,Le,Se);Si&&(Te.horizontal[Vt]=Si)}ki(gt==="point"?"left":Vt)}}let st=!1;if(re.icon&&re.icon.name){const mt=d[re.icon.name];mt&&(Ne=Ig(m[re.icon.name],z.get("icon-offset").evaluate(re,{},S),z.get("icon-anchor").evaluate(re,{},S)),st=mt.sdf,s.sdfIcons===void 0?s.sdfIcons=mt.sdf:s.sdfIcons!==mt.sdf&&yi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(mt.pixelRatio!==s.pixelRatio||z.get("icon-rotate").constantOr(1)!==0)&&(s.iconsNeedLinear=!0))}const rt=ep(Te.horizontal)||Te.vertical;s.iconsInText||(s.iconsInText=!!rt&&rt.iconsInText),(rt||Ne)&&Fg(s,re,Te,Ne,d,$,Le,0,Oe,st,w,S,C)}y&&s.generateCollisionDebugBuffers(I,s.collisionBoxArray)}function Oh(s){switch(s){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Fg(s,t,l,d,m,y,w,S,I,C,z,N,$){let Z=y.textMaxSize.evaluate(t,{},N);Z===void 0&&(Z=w);const Q=s.layers[0].layout,re=Q.get("icon-offset").evaluate(t,{},N),ue=ep(l.horizontal)||l.vertical,Se=$.name==="globe",Le=w/24,Te=s.tilePixelRatio*Z/24,Ce=(Et=s.overscaling,s.zoom>18&&Et>2&&(Et>>=1),Math.max(Gi/(512*Et),1)*Q.get("symbol-spacing")),Ne=Q.get("text-padding")*s.tilePixelRatio,Oe=Q.get("icon-padding")*s.tilePixelRatio,st=ce(Q.get("text-max-angle")),rt=Q.get("text-rotation-alignment")==="map"&&Q.get("symbol-placement")!=="point",mt=Q.get("icon-rotation-alignment")==="map"&&Q.get("symbol-placement")!=="point",Ft=Q.get("symbol-placement"),ct=Ce/2;var Et;const Mt=Q.get("icon-text-fit");let Lt;d&&Mt!=="none"&&(s.allowVerticalPlacement&&l.vertical&&(Lt=$f(d,l.vertical,Mt,Q.get("icon-text-fit-padding"),re,Le)),ue&&(d=$f(d,ue,Mt,Q.get("icon-text-fit-padding"),re,Le)));const Vt=(gt,xi,qi)=>{if(xi.x<0||xi.x>=Gi||xi.y<0||xi.y>=Gi)return;let ki=null;if(Se){const{x:Si,y:ai,z:ji}=$.projectTilePoint(xi.x,xi.y,qi);ki={anchor:new qa(Si,ai,ji,0,void 0),up:$.upVector(qi,xi.x,xi.y)}}(function(Si,ai,ji,Qi,Ji,pr,Yi,jr,tr,lr,Mr,Ur,zr,$r,Gr,Qr,vn,wr,cn,on,mr,Wr,pn,Ar,tn){const zn=Si.addToLineVertexArray(ai,Qi);let bn,wn,Xn,En,Xa,Ul,Fc,Nc=0,Fp=0,Np=0,Up=0,Jh=-1,ed=-1;const Ia={};let $p=xl.exports("");const Ys=ji?ji.anchor:ai;let td=0,rd=0;if(tr._unevaluatedLayout.getValue("text-radial-offset")===void 0?[td,rd]=tr.layout.get("text-offset").evaluate(mr,{},tn).map(co=>co*In):(td=tr.layout.get("text-radial-offset").evaluate(mr,{},tn)*In,rd=zh),Si.allowVerticalPlacement&&Ji.vertical){const co=Ji.vertical;if(Gr)Ul=Fh(co),jr&&(Fc=Fh(jr));else{const uo=tr.layout.get("text-rotate").evaluate(mr,{},tn)+90;Xn=Uu(lr,Ys,ai,Mr,Ur,zr,co,$r,uo,Qr),jr&&(En=Uu(lr,Ys,ai,Mr,Ur,zr,jr,wr,uo))}}if(pr){const co=tr.layout.get("icon-rotate").evaluate(mr,{},tn),uo=tr.layout.get("icon-text-fit")!=="none",Uc=Yf(pr,co,pn,uo),od=jr?Yf(jr,co,pn,uo):void 0;wn=Uu(lr,Ys,ai,Mr,Ur,zr,pr,wr,co),Nc=4*Uc.length;const Vp=Si.iconSizeData;let Ks=null;Vp.kind==="source"?(Ks=[Ea*tr.layout.get("icon-size").evaluate(mr,{},tn)],Ks[0]>ds&&yi(`${Si.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Vp.kind==="composite"&&(Ks=[Ea*Wr.compositeIconSizes[0].evaluate(mr,{},tn),Ea*Wr.compositeIconSizes[1].evaluate(mr,{},tn)],(Ks[0]>ds||Ks[1]>ds)&&yi(`${Si.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),Si.addSymbols(Si.icon,Uc,Ks,on,cn,mr,!1,ji,ai,zn.lineStartIndex,zn.lineLength,-1,Ar,tn),Jh=Si.icon.placedSymbolArray.length-1,od&&(Fp=4*od.length,Si.addSymbols(Si.icon,od,Ks,on,cn,mr,To.vertical,ji,ai,zn.lineStartIndex,zn.lineLength,-1,Ar,tn),ed=Si.icon.placedSymbolArray.length-1)}for(const co in Ji.horizontal){const uo=Ji.horizontal[co];bn||($p=xl.exports(uo.text),Gr?Xa=Fh(uo):bn=Uu(lr,Ys,ai,Mr,Ur,zr,uo,$r,tr.layout.get("text-rotate").evaluate(mr,{},tn),Qr));const Uc=uo.positionedLines.length===1;if(Np+=Jf(Si,ji,ai,uo,Yi,tr,Gr,mr,Qr,zn,Ji.vertical?To.horizontal:To.horizontalOnly,Uc?Object.keys(Ji.horizontal):[co],Ia,Jh,Wr,Ar,tn),Uc)break}Ji.vertical&&(Up+=Jf(Si,ji,ai,Ji.vertical,Yi,tr,Gr,mr,Qr,zn,To.vertical,["vertical"],Ia,ed,Wr,Ar,tn));let ys=-1;const nd=(co,uo)=>co?Math.max(co,uo):uo;ys=nd(Xa,ys),ys=nd(Ul,ys),ys=nd(Fc,ys);const g0=ys>-1?1:0;Si.glyphOffsetArray.length>=ps.MAX_GLYPHS&&yi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),mr.sortKey!==void 0&&Si.addToSortKeyRanges(Si.symbolInstances.length,mr.sortKey),Si.symbolInstances.emplaceBack(Ys.x,Ys.y,Ys.z,ai.x,ai.y,Ia.right>=0?Ia.right:-1,Ia.center>=0?Ia.center:-1,Ia.left>=0?Ia.left:-1,Ia.vertical>=0?Ia.vertical:-1,Jh,ed,$p,bn!==void 0?bn:Si.collisionBoxArray.length,bn!==void 0?bn+1:Si.collisionBoxArray.length,Xn!==void 0?Xn:Si.collisionBoxArray.length,Xn!==void 0?Xn+1:Si.collisionBoxArray.length,wn!==void 0?wn:Si.collisionBoxArray.length,wn!==void 0?wn+1:Si.collisionBoxArray.length,En||Si.collisionBoxArray.length,En?En+1:Si.collisionBoxArray.length,Mr,Np,Up,Nc,Fp,g0,0,td,rd,ys)})(s,xi,ki,gt,l,d,m,Lt,s.layers[0],s.collisionBoxArray,t.index,t.sourceLayerIndex,s.index,Ne,rt,I,0,Oe,mt,re,t,y,C,z,N)};if(Ft==="line")for(const gt of Xf(t.geometry,0,0,Gi,Gi)){const xi=kg(gt,Ce,st,l.vertical||ue,d,24,Te,s.overscaling,Gi);for(const qi of xi){const ki=ue;ki&&Ng(s,ki.text,ct,qi)||Vt(gt,qi,N)}}else if(Ft==="line-center"){for(const gt of t.geometry)if(gt.length>1){const xi=Cg(gt,st,l.vertical||ue,d,24,Te);xi&&Vt(gt,xi,N)}}else if(t.type==="Polygon")for(const gt of Th(t.geometry,0)){const xi=Rg(gt,16);Vt(gt[0],new qa(xi.x,xi.y,0,0,void 0),N)}else if(t.type==="LineString")for(const gt of t.geometry)Vt(gt,new qa(gt[0].x,gt[0].y,0,0,void 0),N);else if(t.type==="Point")for(const gt of t.geometry)for(const xi of gt)Vt([xi],new qa(xi.x,xi.y,0,0,void 0),N)}const ds=32640;function Jf(s,t,l,d,m,y,w,S,I,C,z,N,$,Z,Q,re,ue){const Se=function(Ce,Ne,Oe,st,rt,mt,Ft,ct){const Et=[];if(Ne.positionedLines.length===0)return Et;const Mt=st.layout.get("text-rotate").evaluate(mt,{})*Math.PI/180,Lt=function(ki){const Si=ki[0],ai=ki[1],ji=Si*ai;return ji>0?[Si,-ai]:ji<0?[-Si,ai]:Si===0?[ai,Si]:[ai,-Si]}(Oe);let Vt=Math.abs(Ne.top-Ne.bottom);for(const ki of Ne.positionedLines)Vt-=ki.lineOffset;const gt=Ne.positionedLines.length,xi=Vt/gt;let qi=Ne.top-Oe[1];for(let ki=0;ki<gt;++ki){const Si=Ne.positionedLines[ki];qi=Pg(Ne,xi,qi,ki);for(const ai of Si.positionedGlyphs){if(!ai.rect)continue;const ji=ai.rect||{};let Qi=4,Ji=!0,pr=1,Yi=0;if(ai.imageName){const Ar=Ft[ai.imageName];if(!Ar)continue;if(Ar.sdf){yi("SDF images are not supported in formatted text and will be ignored.");continue}Ji=!1,pr=Ar.pixelRatio,Qi=1/pr}const jr=(rt||ct)&&ai.vertical,tr=ai.metrics.advance*ai.scale/2,lr=ai.metrics,Mr=ai.rect;if(Mr===null)continue;ct&&Ne.verticalizable&&(Yi=ai.imageName?tr-ai.metrics.width*ai.scale/2:0);const Ur=rt?[ai.x+tr,ai.y]:[0,0];let zr=[0,0],$r=[0,0],Gr=!1;rt||(jr?($r=[ai.x+tr+Lt[0],ai.y+Lt[1]-Yi],Gr=!0):zr=[ai.x+tr+Oe[0],ai.y+Oe[1]-Yi]);const Qr=Mr.w*ai.scale/(pr*(ai.localGlyph?2:1)),vn=Mr.h*ai.scale/(pr*(ai.localGlyph?2:1));let wr,cn,on,mr;if(jr){const Ar=ai.y-qi,tn=new J(-tr,tr-Ar),zn=-Math.PI/2,bn=new J(...$r);wr=new J(-tr+zr[0],zr[1]),wr._rotateAround(zn,tn)._add(bn),wr.x+=-Ar+tr,wr.y-=(lr.left-Qi)*ai.scale;const wn=ai.imageName?lr.advance*ai.scale:In*ai.scale,Xn=String.fromCharCode(ai.glyph);dg(Xn)?wr.x+=(1-Qi)*ai.scale:fg(Xn)?wr.x+=wn-lr.height*ai.scale+(-Qi-1)*ai.scale:wr.x+=ai.imageName||lr.width+2*Qi===Mr.w&&lr.height+2*Qi===Mr.h?(wn-vn)/2:(wn-(lr.height+2*Qi)*ai.scale)/2,cn=new J(wr.x,wr.y-Qr),on=new J(wr.x+vn,wr.y),mr=new J(wr.x+vn,wr.y-Qr)}else{const Ar=(lr.left-Qi)*ai.scale-tr+zr[0],tn=(-lr.top-Qi)*ai.scale+zr[1],zn=Ar+Qr,bn=tn+vn;wr=new J(Ar,tn),cn=new J(zn,tn),on=new J(Ar,bn),mr=new J(zn,bn)}if(Mt){let Ar;Ar=rt?new J(0,0):Gr?new J(Lt[0],Lt[1]):new J(Oe[0],Oe[1]),wr._rotateAround(Mt,Ar),cn._rotateAround(Mt,Ar),on._rotateAround(Mt,Ar),mr._rotateAround(Mt,Ar)}const Wr=new J(0,0),pn=new J(0,0);Et.push({tl:wr,tr:cn,bl:on,br:mr,tex:ji,writingMode:Ne.writingMode,glyphOffset:Ur,sectionIndex:ai.sectionIndex,isSDF:Ji,pixelOffsetTL:Wr,pixelOffsetBR:pn,minFontScaleX:0,minFontScaleY:0})}}return Et}(0,d,I,y,w,S,m,s.allowVerticalPlacement),Le=s.textSizeData;let Te=null;Le.kind==="source"?(Te=[Ea*y.layout.get("text-size").evaluate(S,{},ue)],Te[0]>ds&&yi(`${s.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Le.kind==="composite"&&(Te=[Ea*Q.compositeTextSizes[0].evaluate(S,{},ue),Ea*Q.compositeTextSizes[1].evaluate(S,{},ue)],(Te[0]>ds||Te[1]>ds)&&yi(`${s.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),s.addSymbols(s.text,Se,Te,I,w,S,z,t,l,C.lineStartIndex,C.lineLength,Z,re,ue);for(const Ce of N)$[Ce]=s.text.placedSymbolArray.length-1;return 4*Se.length}function ep(s){for(const t in s)return s[t];return null}function Uu(s,t,l,d,m,y,w,S,I,C){let z=w.top,N=w.bottom,$=w.left,Z=w.right;const Q=w.collisionPadding;if(Q&&($-=Q[0],z-=Q[1],Z+=Q[2],N+=Q[3]),I){const re=new J($,z),ue=new J(Z,z),Se=new J($,N),Le=new J(Z,N),Te=ce(I);let Ce=new J(0,0);C&&(Ce=new J(C[0],C[1])),re._rotateAround(Te,Ce),ue._rotateAround(Te,Ce),Se._rotateAround(Te,Ce),Le._rotateAround(Te,Ce),$=Math.min(re.x,ue.x,Se.x,Le.x),Z=Math.max(re.x,ue.x,Se.x,Le.x),z=Math.min(re.y,ue.y,Se.y,Le.y),N=Math.max(re.y,ue.y,Se.y,Le.y)}return s.emplaceBack(t.x,t.y,t.z,l.x,l.y,$,z,Z,N,S,d,m,y),s.length-1}function Fh(s){s.collisionPadding&&(s.top-=s.collisionPadding[1],s.bottom+=s.collisionPadding[3]);const t=s.bottom-s.top;return t>0?Math.max(10,t):null}function Ng(s,t,l,d){const m=s.compareText;if(t in m){const y=m[t];for(let w=y.length-1;w>=0;w--)if(d.dist(y[w])<l)return!0}else m[t]=[];return m[t].push(d),!1}const Ug=Wt([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:tp}=Ug,ip=Wt([{name:"a_pos_3",components:3,type:"Int16"}]);var Ic=Wt([{name:"a_pos",type:"Int16",components:2}]);const Za=Gi/Math.PI/2,Nh=2*Bo(1,0)*Za*Math.PI,Rl=64,Ll=[Rl,32,16],Jo=-Za,ea=Za,$g=[new qn([Jo,Jo,Jo],[ea,ea,ea]),new qn([Jo,Jo,Jo],[0,0,ea]),new qn([0,Jo,Jo],[ea,0,ea]),new qn([Jo,0,Jo],[0,ea,ea]),new qn([0,0,Jo],[ea,ea,ea])];function rp(s,t,l,d=!0){const m=Eo([],s._camera.position,s.worldSize),y=[t,l,1,1];qs(y,y,s.pixelMatrixInverse),Xd(y,y,1/y[3]);const w=Gn([],Qo([],y,m)),S=s.globeMatrix,I=[S[12],S[13],S[14]],C=Qo([],I,m),z=cc(C),N=Gn([],C),$=s.worldSize/(2*Math.PI),Z=Ro(N,w),Q=Math.asin($/z);if(Q<Math.acos(Z)){if(!d)return null;const Ft=[],ct=[];Eo(Ft,w,z/Z),Gn(ct,Qo(ct,Ft,C)),Gn(w,Va(w,C,Eo(w,ct,Math.tan(Q)*z)))}const re=[];new gh(m,w).closestPointOnSphere(I,$,re);const ue=Gn([],Gt(S,0)),Se=Gn([],Gt(S,1)),Le=Gn([],Gt(S,2)),Te=Ro(ue,re),Ce=Ro(Se,re),Ne=Ro(Le,re),Oe=ee(Math.asin(-Ce/$));let st=ee(Math.atan2(Te,Ne));st=s.center.lng+function(Ft,ct){const Et=(ct-Ft+180)%360-180;return Et<-180?Et+360:Et}(s.center.lng,st);const rt=xa(st),mt=We(va(Oe),0,1);return new bl(rt,mt)}class Vg{constructor(t,l,d){this.a=Qo([],t,d),this.b=Qo([],l,d),this.center=d;const m=Gn([],this.a),y=Gn([],this.b);this.angle=Math.acos(Ro(m,y))}}function Uh(s,t){if(s.angle===0)return null;let l;return l=s.a[t]===0?1/s.angle*.5*Math.PI:1/s.angle*Math.atan(s.b[t]/s.a[t]/Math.sin(s.angle)-1/Math.tan(s.angle)),l<0||l>1?null:function(d,m,y,w){const S=Math.sin(y);return d*(Math.sin((1-w)*y)/S)+m*(Math.sin(w*y)/S)}(s.a[t],s.b[t],s.angle,We(l,0,1))+s.center[t]}function Ta(s){if(s.z<=1)return $g[s.z+2*s.y+s.x];const t=$h($u(s));return qn.fromPoints(t)}function Xs(s,t,l){return Eo(s,s,1-l),dc(s,s,t,l)}function np(s,t){const l=Ol(t.zoom);if(l===0)return Ta(s);const d=$u(s),m=$h(d),y=xa(d.getWest())*t.worldSize,w=xa(d.getEast())*t.worldSize,S=va(d.getNorth())*t.worldSize,I=va(d.getSouth())*t.worldSize,C=[y,S,0],z=[w,S,0],N=[y,I,0],$=[w,I,0],Z=hh([],t.globeMatrix);return ln(C,C,Z),ln(z,z,Z),ln(N,N,Z),ln($,$,Z),m[0]=Xs(m[0],N,l),m[1]=Xs(m[1],$,l),m[2]=Xs(m[2],z,l),m[3]=Xs(m[3],C,l),qn.fromPoints(m)}function op(s,t,l){for(const d of s)ln(d,d,t),Eo(d,d,l)}function jg(s,t,l){const d=t/s.worldSize,m=s.globeMatrix;if(l.z<=1){const rt=Ta(l).getCorners();return op(rt,m,d),qn.fromPoints(rt)}const y=$u(l),w=$h(y);op(w,m,d);const S=Number.MAX_VALUE,I=[-S,-S,-S],C=[S,S,S];if(y.contains(s.center)){for(const Ft of w)uc(C,C,Ft),hc(I,I,Ft);I[2]=0;const rt=s.point,mt=[rt.x*d,rt.y*d,0];return uc(C,C,mt),hc(I,I,mt),new qn(C,I)}const z=[m[12]*d,m[13]*d,m[14]*d],N=y.getCenter(),$=We(s.center.lat,-85.051129,ba),Z=We(N.lat,-85.051129,ba),Q=xa(s.center.lng),re=va($);let ue=Q-xa(N.lng);const Se=re-va(Z);ue>.5?ue-=1:ue<-.5&&(ue+=1);let Le=0;Math.abs(ue)>Math.abs(Se)?Le=ue>=0?1:3:(Le=Se>=0?0:2,dc(z,z,[m[4]*d,m[5]*d,m[6]*d],-Math.sin(ce(Se>=0?y.getSouth():y.getNorth()))*Za));const Te=w[Le],Ce=w[(Le+1)%4],Ne=new Vg(Te,Ce,z),Oe=[Uh(Ne,0)||Te[0],Uh(Ne,1)||Te[1],Uh(Ne,2)||Te[2]],st=Ol(s.zoom);if(st>0){const rt=function({x:Ft,y:ct,z:Et},Mt,Lt,Vt,gt){const xi=1/(1<<Et);let qi=Ft*xi,ki=qi+xi,Si=ct*xi,ai=Si+xi,ji=0;const Qi=(qi+ki)/2-Vt;return Qi>.5?ji=-1:Qi<-.5&&(ji=1),qi=((qi+ji)*Mt-(Vt*=Mt))*Lt+Vt,ki=((ki+ji)*Mt-Vt)*Lt+Vt,Si=(Si*Mt-(gt*=Mt))*Lt+gt,ai=(ai*Mt-gt)*Lt+gt,[[qi,ai,0],[ki,ai,0],[ki,Si,0],[qi,Si,0]]}(l,t,s._pixelsPerMercatorPixel,Q,re);for(let Ft=0;Ft<w.length;Ft++)Xs(w[Ft],rt[Ft],st);const mt=Va([],rt[Le],rt[(Le+1)%4]);Eo(mt,mt,.5),Xs(Oe,mt,st)}for(const rt of w)uc(C,C,rt),hc(I,I,rt);return C[2]=Math.min(Te[2],Ce[2]),uc(C,C,Oe),hc(I,I,Oe),new qn(C,I)}function $u({x:s,y:t,z:l}){const d=1/(1<<l),m=new _r(wo(s*d),An((t+1)*d)),y=new _r(wo((s+1)*d),An(t*d));return new hs(m,y)}function $h(s){const t=ce(s.getNorth()),l=ce(s.getSouth()),d=Math.cos(t),m=Math.cos(l),y=Math.sin(t),w=Math.sin(l),S=s.getWest(),I=s.getEast();return[zl(m,w,S),zl(m,w,I),zl(d,y,I),zl(d,y,S)]}function zl(s,t,l,d=Za){return l=ce(l),[s*Math.sin(l)*d,-t*d,s*Math.cos(l)*d]}function Cc(s,t,l){return zl(Math.cos(ce(s)),Math.sin(ce(s)),t,l)}function kc(s,t,l,d){const m=1<<l.z,y=(s/Gi+l.x)/m;return Cc(An((t/Gi+l.y)/m),wo(y),d)}function Vu({min:s,max:t}){return 16383/Math.max(t[0]-s[0],t[1]-s[1],t[2]-s[2])}const ap=new Float64Array(16);function Pc(s){const t=Vu(s),l=Vd(ap,[t,t,t]);return lc(l,l,((d=[])[0]=-(m=s.min)[0],d[1]=-m[1],d[2]=-m[2],d));var d,m}function Vh(s){const t=(d=s.min,(l=ap)[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=d[0],l[13]=d[1],l[14]=d[2],l[15]=1,l);var l,d;const m=1/Vu(s);return Gs(t,t,[m,m,m])}function sp(s,t,l,d,m){const y=function(I){const C=Gi/(2*Math.PI);return I/(2*Math.PI)/C}(l),w=[s,t,-l/(2*Math.PI)],S=wa(new Float64Array(16));return lc(S,S,w),Gs(S,S,[y,y,y]),dh(S,S,ce(-m)),Eu(S,S,ce(-d)),S}function Ol(s){return Zt(5,6,s)}function lp(s,t){const l=Cc(t.lat,t.lng),d=function(Q){const re=Cc(Q._center.lat,Q._center.lng);let ue=mh([],Tl(0,1,0),re);const Se=jd([],-Q.angle,re);ue=ln(ue,ue,Se),jd(Se,-Q._pitch,ue);const Le=Gn([],re);return Eo(Le,Le,Q.cameraToCenterDistance/Q.pixelsPerMeter*Nh),ln(Le,Le,Se),Va([],re,Le)}(s);return w=(m=ph([],d,l))[0],S=m[1],I=m[2],C=(y=l)[0],z=y[1],N=y[2],Z=($=Math.sqrt(w*w+S*S+I*I)*Math.sqrt(C*C+z*z+N*N))&&Ro(m,y)/$,Math.acos(Math.min(Math.max(Z,-1),1));var m,y,w,S,I,C,z,N,$,Z}const cp=ce(85),Gg=Math.cos(cp),qg=Math.sin(cp);function up(s,t){const l=s.fovAboveCenter,d=s.elevation?s.elevation.getMinElevationBelowMSL()*t:0,m=(s._camera.position[2]*s.worldSize-d)/Math.cos(s._pitch),y=Math.sin(l)*m/Math.sin(Math.max(Math.PI/2-s._pitch-l,.01)),w=Math.sin(s._pitch)*y+m;return Math.min(1.01*w,m*(1/s._horizonShift))}function Hs(s,t){if(!t.isReprojectedInTileSpace)return{scale:1<<s.z,x:s.x,y:s.y,x2:s.x+1,y2:s.y+1,projection:t};const l=Math.pow(2,-s.z),d=s.x*l,m=(s.x+1)*l,y=s.y*l,w=(s.y+1)*l,S=wo(d),I=wo(m),C=An(y),z=An(w),N=t.project(S,C),$=t.project(I,C),Z=t.project(I,z),Q=t.project(S,z);let re=Math.min(N.x,$.x,Z.x,Q.x),ue=Math.min(N.y,$.y,Z.y,Q.y),Se=Math.max(N.x,$.x,Z.x,Q.x),Le=Math.max(N.y,$.y,Z.y,Q.y);const Te=l/16;function Ce(Oe,st,rt,mt,Ft,ct){const Et=(rt+Ft)/2,Mt=(mt+ct)/2,Lt=t.project(wo(Et),An(Mt)),Vt=Math.max(0,re-Lt.x,ue-Lt.y,Lt.x-Se,Lt.y-Le);re=Math.min(re,Lt.x),Se=Math.max(Se,Lt.x),ue=Math.min(ue,Lt.y),Le=Math.max(Le,Lt.y),Vt>Te&&(Ce(Oe,Lt,rt,mt,Et,Mt),Ce(Lt,st,Et,Mt,Ft,ct))}Ce(N,$,d,y,m,y),Ce($,Z,m,y,m,w),Ce(Z,Q,m,w,d,w),Ce(Q,N,d,w,d,y),re-=Te,ue-=Te,Se+=Te,Le+=Te;const Ne=1/Math.max(Se-re,Le-ue);return{scale:Ne,x:re*Ne,y:ue*Ne,x2:Se*Ne,y2:Le*Ne,projection:t}}const Zg=wa(new Float32Array(16));class fs{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,l){return{x:0,y:0,z:0}}unproject(t,l){return new _r(0,0)}projectTilePoint(t,l,d){return{x:t,y:l,z:0}}locationPoint(t,l,d=!0){return t._coordinatePoint(t.locationCoordinate(l),d)}pixelsPerMeter(t,l){return Bo(1,t)*l}pixelSpaceConversion(t,l,d){return 1}farthestPixelDistance(t){return up(t,t.pixelsPerMeter)}pointCoordinate(t,l,d,m){const y=t.horizonLineFromTop(!1),w=new J(l,Math.max(y,d));return t.rayIntersectionCoordinate(t.pointRayIntersection(w,m))}pointCoordinate3D(t,l,d){const m=new J(l,d);if(t.elevation)return t.elevation.pointCoordinate(m);{const y=this.pointCoordinate(t,m.x,m.y,0);return[y.x,y.y,y.z]}}isPointAboveHorizon(t,l){if(t.elevation)return!this.pointCoordinate3D(t,l.x,l.y);const d=t.horizonLineFromTop();return l.y<d}createInversionMatrix(t,l){return Zg}createTileMatrix(t,l,d){let m,y,w;const S=d.canonical,I=wa(new Float64Array(16));if(this.isReprojectedInTileSpace){const C=Hs(S,this);m=1,y=C.x+d.wrap*C.scale,w=C.y,Gs(I,I,[m/C.scale,m/C.scale,t.pixelsPerMeter/l])}else m=l/t.zoomScale(S.z),y=(S.x+Math.pow(2,S.z)*d.wrap)*m,w=S.y*m;return lc(I,I,[y,w,0]),Gs(I,I,[m/Gi,m/Gi,1]),I}upVector(t,l,d){return[0,0,1]}upVectorScale(t,l,d){return{metersToTile:1}}}class Xg extends fs{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[l,d]=this.parallels=t.parallels||[29.5,45.5],m=Math.sin(ce(l));this.n=(m+Math.sin(ce(d)))/2,this.c=1+m*(2*this.n-m),this.r0=Math.sqrt(this.c)/this.n}project(t,l){const{n:d,c:m,r0:y}=this,w=ce(t-this.center[0]),S=ce(l),I=Math.sqrt(m-2*d*Math.sin(S))/d;return{x:I*Math.sin(w*d),y:I*Math.cos(w*d)-y,z:0}}unproject(t,l){const{n:d,c:m,r0:y}=this,w=y+l;let S=Math.atan2(t,Math.abs(w))*Math.sign(w);w*d<0&&(S-=Math.PI*Math.sign(t)*Math.sign(w));const I=ce(this.center[0])*d;S=ti(S,-Math.PI-I,Math.PI-I);const C=We(ee(S/d)+this.center[0],-180,180),z=Math.asin(We((m-(t*t+w*w)*d*d)/(2*d),-1,1)),N=We(ee(z),-85.051129,ba);return new _r(C,N)}}const Dc=1.340264,Bc=-.081106,Rc=893e-6,Lc=.003796,ju=Math.sqrt(3)/2;class Hg extends fs{project(t,l){l=l/180*Math.PI,t=t/180*Math.PI;const d=Math.asin(ju*Math.sin(l)),m=d*d,y=m*m*m;return{x:.5*(t*Math.cos(d)/(ju*(Dc+3*Bc*m+y*(7*Rc+9*Lc*m)))/Math.PI+.5),y:1-.5*(d*(Dc+Bc*m+y*(Rc+Lc*m))/Math.PI+1),z:0}}unproject(t,l){t=(2*t-.5)*Math.PI;let d=l=(2*(1-l)-1)*Math.PI,m=d*d,y=m*m*m;for(let z,N,$,Z=0;Z<12&&(N=d*(Dc+Bc*m+y*(Rc+Lc*m))-l,$=Dc+3*Bc*m+y*(7*Rc+9*Lc*m),z=N/$,d=We(d-z,-Math.PI/3,Math.PI/3),m=d*d,y=m*m*m,!(Math.abs(z)<1e-12));++Z);const w=ju*t*(Dc+3*Bc*m+y*(7*Rc+9*Lc*m))/Math.cos(d),S=Math.asin(Math.sin(d)/ju),I=We(180*w/Math.PI,-180,180),C=We(180*S/Math.PI,-85.051129,ba);return new _r(I,C)}}class Wg extends fs{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,l){return{x:.5+t/360,y:.5-l/360,z:0}}unproject(t,l){const d=360*(t-.5),m=We(360*(.5-l),-85.051129,ba);return new _r(d,m)}}const Fl=Math.PI/2;function Gu(s){return Math.tan((Fl+s)/2)}class Yg extends fs{constructor(t){super(t),this.center=t.center||[0,30];const[l,d]=this.parallels=t.parallels||[30,30];let m=ce(l),y=ce(d);this.southernCenter=m+y<0,this.southernCenter&&(m=-m,y=-y);const w=Math.cos(m),S=Gu(m);this.n=m===y?Math.sin(m):Math.log(w/Math.cos(y))/Math.log(Gu(y)/S),this.f=w*Math.pow(Gu(m),this.n)/this.n}project(t,l){l=ce(l),this.southernCenter&&(l=-l),t=ce(t-this.center[0]);const d=1e-6,{n:m,f:y}=this;y>0?l<-Fl+d&&(l=-Fl+d):l>Fl-d&&(l=Fl-d);const w=y/Math.pow(Gu(l),m);let S=w*Math.sin(m*t),I=y-w*Math.cos(m*t);return S=.5*(S/Math.PI+.5),I=.5*(I/Math.PI+.5),{x:S,y:this.southernCenter?I:1-I,z:0}}unproject(t,l){t=(2*t-.5)*Math.PI,this.southernCenter&&(l=1-l),l=(2*(1-l)-.5)*Math.PI;const{n:d,f:m}=this,y=m-l,w=Math.sign(y),S=Math.sign(d)*Math.sqrt(t*t+y*y);let I=Math.atan2(t,Math.abs(y))*w;y*d<0&&(I-=Math.PI*Math.sign(t)*w);const C=We(ee(I/d)+this.center[0],-180,180),z=We(ee(2*Math.atan(Math.pow(m/S,1/d))-Fl),-85.051129,ba);return new _r(C,this.southernCenter?-z:z)}}class hp extends fs{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,l){return{x:xa(t),y:va(l),z:0}}unproject(t,l){const d=wo(t),m=An(l);return new _r(d,m)}}const dp=ce(ba);class Kg extends fs{project(t,l){const d=(l=ce(l))*l,m=d*d;return{x:.5*((t=ce(t))*(.8707-.131979*d+m*(m*(.003971*d-.001529*m)-.013791))/Math.PI+.5),y:1-.5*(l*(1.007226+d*(.015085+m*(.028874*d-.044475-.005916*m)))/Math.PI+1),z:0}}unproject(t,l){t=(2*t-.5)*Math.PI;let d=l=(2*(1-l)-1)*Math.PI,m=25,y=0,w=d*d;do{w=d*d;const C=w*w;y=(d*(1.007226+w*(.015085+C*(.028874*w-.044475-.005916*C)))-l)/(1.007226+w*(.045255+C*(.259866*w-.311325-.005916*11*C))),d=We(d-y,-dp,dp)}while(Math.abs(y)>1e-6&&--m>0);w=d*d;const S=We(ee(t/(.8707+w*(w*(w*w*w*(.003971-.001529*w)-.013791)-.131979))),-180,180),I=ee(d);return new _r(S,I)}}const fp=ce(ba);class Qg extends fs{project(t,l){l=ce(l),t=ce(t);const d=Math.cos(l),m=2/Math.PI,y=Math.acos(d*Math.cos(t/2)),w=Math.sin(y)/y,S=.5*(t*m+2*d*Math.sin(t/2)/w)||0,I=.5*(l+Math.sin(l)/w)||0;return{x:.5*(S/Math.PI+.5),y:1-.5*(I/Math.PI+1),z:0}}unproject(t,l){let d=t=(2*t-.5)*Math.PI,m=l=(2*(1-l)-1)*Math.PI,y=25;const w=1e-6;let S=0,I=0;do{const C=Math.cos(m),z=Math.sin(m),N=2*z*C,$=z*z,Z=C*C,Q=Math.cos(d/2),re=Math.sin(d/2),ue=2*Q*re,Se=re*re,Le=1-Z*Q*Q,Te=Le?1/Le:0,Ce=Le?Math.acos(C*Q)*Math.sqrt(1/Le):0,Ne=.5*(2*Ce*C*re+2*d/Math.PI)-t,Oe=.5*(Ce*z+m)-l,st=.5*Te*(Z*Se+Ce*C*Q*$)+1/Math.PI,rt=Te*(ue*N/4-Ce*z*re),mt=.125*Te*(N*re-Ce*z*Z*ue),Ft=.5*Te*($*Q+Ce*Se*C)+.5,ct=rt*mt-Ft*st;S=(Oe*rt-Ne*Ft)/ct,I=(Ne*mt-Oe*st)/ct,d=We(d-S,-Math.PI,Math.PI),m=We(m-I,-fp,fp)}while((Math.abs(S)>w||Math.abs(I)>w)&&--y>0);return new _r(ee(d),ee(m))}}class pp extends fs{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(ce(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,l){const{scale:d,cosPhi:m}=this;return{x:ce(t)*m*d+.5,y:-Math.sin(ce(l))/m*d+.5,z:0}}unproject(t,l){const{scale:d,cosPhi:m}=this,y=-(l-.5)/d,w=We(ee((t-.5)/d)/m,-180,180),S=Math.asin(We(y*m,-1,1)),I=We(ee(S),-85.051129,ba);return new _r(w,I)}}class Jg extends hp{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug","custom"],this.range=[3,5]}projectTilePoint(t,l,d){const m=kc(t,l,d);return ln(m,m,Pc(Ta(d))),{x:m[0],y:m[1],z:m[2]}}locationPoint(t,l){const d=Cc(l.lat,l.lng),m=Gn([],d),y=t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(l),t._centerAltitude):t._centerAltitude;dc(d,d,m,Bo(1,0)*Gi*y);const w=wa(new Float64Array(16));return El(w,t.pixelMatrix,t.globeMatrix),ln(d,d,w),new J(d[0],d[1])}pixelsPerMeter(t,l){return Bo(1,0)*l}pixelSpaceConversion(t,l,d){const m=Bo(1,t)*l,y=ur(Bo(1,45)*l,m,d);return this.pixelsPerMeter(t,l)/y}createTileMatrix(t,l,d){const m=Vh(Ta(d.canonical));return El(new Float64Array(16),t.globeMatrix,m)}createInversionMatrix(t,l){const{center:d}=t,m=Pc(Ta(l));return Eu(m,m,ce(d.lng)),dh(m,m,ce(d.lat)),Gs(m,m,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(m)}pointCoordinate(t,l,d,m){return rp(t,l,d,!0)||new bl(0,0)}pointCoordinate3D(t,l,d){const m=this.pointCoordinate(t,l,d,0);return[m.x,m.y,m.z]}isPointAboveHorizon(t,l){return!rp(t,l.x,l.y,!1)}farthestPixelDistance(t){const l=function(m,y){const w=m.cameraToCenterDistance,S=m._centerAltitude*y,I=m._camera,C=m._camera.forward(),z=Va([],Eo([],C,-w),[0,0,S]),N=m.worldSize/(2*Math.PI),$=[0,0,-N],Z=m.width/m.height,Q=Math.tan(m.fovAboveCenter),re=Eo([],I.up(),Q),ue=Eo([],I.right(),Q*Z),Se=Gn([],Va([],Va([],C,re),ue)),Le=[];let Te;if(new gh(z,Se).closestPointOnSphere($,N,Le)){const Ce=Va([],Le,$),Ne=Qo([],Ce,z);Te=Math.cos(m.fovAboveCenter)*cc(Ne)}else{const Ce=Qo([],z,$),Ne=Qo([],$,z);Gn(Ne,Ne);const Oe=cc(Ce)-N;Te=Math.sqrt(Oe*(Oe+2*N));const st=Math.acos(Te/(N+Oe))-Math.acos(Ro(C,Ne));Te*=Math.cos(st)}return 1.01*Te}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),d=Ol(t.zoom);if(d>0){const m=up(t,Bo(1,t.center.lat)*t.worldSize),y=t.worldSize/(2*Math.PI),w=Math.max(t.width,t.height)/t.worldSize*Math.PI;return ur(l,m+y*(1-Math.cos(w)),Math.pow(d,10))}return l}upVector(t,l,d){return kc(l,d,t,1)}upVectorScale(t){return{metersToTile:Nh*Vu(Ta(t))}}}function mp(s){const t=s.parallels,l=!!t&&Math.abs(t[0]+t[1])<.01;switch(s.name){case"mercator":return new hp(s);case"equirectangular":return new Wg(s);case"naturalEarth":return new Kg(s);case"equalEarth":return new Hg(s);case"winkelTripel":return new Qg(s);case"albers":return l?new pp(s):new Xg(s);case"lambertConformalConic":return l?new pp(s):new Yg(s);case"globe":return new Jg(s)}throw new Error(`Invalid projection name: ${s.name}`)}const e0=ku.types,t0=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function qu(s,t,l,d,m,y,w,S,I,C,z,N,$){const Z=S?Math.min(ds,Math.round(S[0])):0,Q=S?Math.min(ds,Math.round(S[1])):0;s.emplaceBack(t,l,Math.round(32*d),Math.round(32*m),y,w,(Z<<1)+(I?1:0),Q,16*C,16*z,256*N,256*$)}function Zu(s,t,l,d,m,y,w){s.emplaceBack(t,l,d,m,y,w)}function Xu(s,t,l,d,m){s.emplaceBack(t,l,d,m),s.emplaceBack(t,l,d,m),s.emplaceBack(t,l,d,m),s.emplaceBack(t,l,d,m)}function i0(s){for(const t of s.sections)if(V(t.text))return!0;return!1}class jh{constructor(t){this.layoutVertexArray=new Hr,this.indexArray=new Ln,this.programConfigurations=t,this.segments=new sn,this.dynamicLayoutVertexArray=new fn,this.opacityVertexArray=new rn,this.placedSymbolArray=new ud,this.globeExtVertexArray=new xr}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(t,l,d,m){this.isEmpty()||(d&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ng.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,l),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,ag.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,t0,!0),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,og.members,!0)),this.opacityVertexBuffer.itemSize=1),(d||m)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}}_i(jh,"SymbolBuffers");class Gh{constructor(t,l,d){this.layoutVertexArray=new t,this.layoutAttributes=l,this.indexArray=new d,this.segments=new sn,this.collisionVertexArray=new Fa,this.collisionVertexArrayExt=new vo}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,sg.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,lg.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}_i(Gh,"CollisionBuffers");class ps{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(w=>w.id),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=wa([]),this.placementViewportMatrix=wa([]);const l=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Ih(this.zoom,l["text-size"]),this.iconSizeData=Ih(this.zoom,l["icon-size"]);const d=this.layers[0].layout,m=d.get("symbol-sort-key"),y=d.get("symbol-z-order");this.canOverlap=d.get("text-allow-overlap")||d.get("icon-allow-overlap")||d.get("text-ignore-placement")||d.get("icon-ignore-placement"),this.sortFeaturesByKey=y!=="viewport-y"&&m.constantOr(1)!==void 0,this.sortFeaturesByY=(y==="viewport-y"||y==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=d.get("text-writing-mode").map(w=>To[w]),this.stateDependentLayerIds=this.layers.filter(w=>w.isStateDependent()).map(w=>w.id),this.sourceID=t.sourceID,this.projection=t.projection}createArrays(){this.text=new jh(new $s(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new jh(new $s(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new fd,this.lineVertexArray=new pd,this.symbolInstances=new dd}calculateGlyphDependencies(t,l,d,m,y){for(let w=0;w<t.length;w++)if(l[t.charCodeAt(w)]=!0,m&&y){const S=Tc[t.charAt(w)];S&&(l[S.charCodeAt(0)]=!0)}}populate(t,l,d,m){const y=this.layers[0],w=y.layout,S=this.projection.name==="globe",I=w.get("text-font"),C=w.get("text-field"),z=w.get("icon-image"),N=(C.value.kind!=="constant"||C.value.value instanceof Mi&&!C.value.value.isEmpty()||C.value.value.toString().length>0)&&(I.value.kind!=="constant"||I.value.value.length>0),$=z.value.kind!=="constant"||!!z.value.value||Object.keys(z.parameters).length>0,Z=w.get("symbol-sort-key");if(this.features=[],!N&&!$)return;const Q=l.iconDependencies,re=l.glyphDependencies,ue=l.availableImages,Se=new Me(this.zoom);for(const{feature:Le,id:Te,index:Ce,sourceLayerIndex:Ne}of t){const Oe=y._featureFilter.needGeometry,st=Vs(Le,Oe);if(!y._featureFilter.filter(Se,st,d))continue;if(Oe||(st.geometry=$a(Le,d,m)),S&&Le.type!==1&&d.z<=5){const ct=st.geometry,Et=.98078528056,Mt=(Lt,Vt)=>Ro(kc(Lt.x,Lt.y,d,1),kc(Vt.x,Vt.y,d,1))<Et;for(let Lt=0;Lt<ct.length;Lt++)ct[Lt]=im(ct[Lt],Mt)}let rt,mt;if(N){const ct=y.getValueAndResolveTokens("text-field",st,d,ue),Et=Mi.factory(ct);i0(Et)&&(this.hasRTLText=!0),(!this.hasRTLText||ge()==="unavailable"||this.hasRTLText&&ze.isParsed())&&(rt=hg(Et,y,st))}if($){const ct=y.getValueAndResolveTokens("icon-image",st,d,ue);mt=ct instanceof Oi?ct:Oi.fromString(ct)}if(!rt&&!mt)continue;const Ft=this.sortFeaturesByKey?Z.evaluate(st,{},d):void 0;if(this.features.push({id:Te,text:rt,icon:mt,index:Ce,sourceLayerIndex:Ne,geometry:st.geometry,properties:Le.properties,type:e0[Le.type],sortKey:Ft}),mt&&(Q[mt.name]=!0),rt){const ct=I.evaluate(st,{},d).join(","),Et=w.get("text-rotation-alignment")==="map"&&w.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(To.vertical)>=0;for(const Mt of rt.sections)if(Mt.image)Q[Mt.image.name]=!0;else{const Lt=p(rt.toString()),Vt=Mt.fontStack||ct,gt=re[Vt]=re[Vt]||{};this.calculateGlyphDependencies(Mt.text,gt,Et,this.allowVerticalPlacement,Lt)}}}w.get("symbol-placement")==="line"&&(this.features=function(Le){const Te={},Ce={},Ne=[];let Oe=0;function st(ct){Ne.push(Le[ct]),Oe++}function rt(ct,Et,Mt){const Lt=Ce[ct];return delete Ce[ct],Ce[Et]=Lt,Ne[Lt].geometry[0].pop(),Ne[Lt].geometry[0]=Ne[Lt].geometry[0].concat(Mt[0]),Lt}function mt(ct,Et,Mt){const Lt=Te[Et];return delete Te[Et],Te[ct]=Lt,Ne[Lt].geometry[0].shift(),Ne[Lt].geometry[0]=Mt[0].concat(Ne[Lt].geometry[0]),Lt}function Ft(ct,Et,Mt){const Lt=Mt?Et[0][Et[0].length-1]:Et[0][0];return`${ct}:${Lt.x}:${Lt.y}`}for(let ct=0;ct<Le.length;ct++){const Et=Le[ct],Mt=Et.geometry,Lt=Et.text?Et.text.toString():null;if(!Lt){st(ct);continue}const Vt=Ft(Lt,Mt),gt=Ft(Lt,Mt,!0);if(Vt in Ce&&gt in Te&&Ce[Vt]!==Te[gt]){const xi=mt(Vt,gt,Mt),qi=rt(Vt,gt,Ne[xi].geometry);delete Te[Vt],delete Ce[gt],Ce[Ft(Lt,Ne[qi].geometry,!0)]=qi,Ne[xi].geometry=null}else Vt in Ce?rt(Vt,gt,Mt):gt in Te?mt(Vt,gt,Mt):(st(ct),Te[Vt]=Oe-1,Ce[gt]=Oe-1)}return Ne.filter(ct=>ct.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Le,Te)=>Le.sortKey-Te.sortKey)}update(t,l,d,m){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,l,this.layers,d,m),this.icon.programConfigurations.updatePaintArrays(t,l,this.layers,d,m))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=mp(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,l){const d=this.lineVertexArray.length,m=t.segment;if(m!==void 0){let y=t.dist(l[m+1]),w=t.dist(l[m]);const S={};for(let I=m+1;I<l.length;I++)S[I]={x:l[I].x,y:l[I].y,tileUnitDistanceFromAnchor:y},I<l.length-1&&(y+=l[I+1].dist(l[I]));for(let I=m||0;I>=0;I--)S[I]={x:l[I].x,y:l[I].y,tileUnitDistanceFromAnchor:w},I>0&&(w+=l[I-1].dist(l[I]));for(let I=0;I<l.length;I++){const C=S[I];this.lineVertexArray.emplaceBack(C.x,C.y,C.tileUnitDistanceFromAnchor)}}return{lineStartIndex:d,lineLength:this.lineVertexArray.length-d}}addSymbols(t,l,d,m,y,w,S,I,C,z,N,$,Z,Q){const re=t.indexArray,ue=t.layoutVertexArray,Se=t.globeExtVertexArray,Le=t.segments.prepareSegment(4*l.length,ue,re,this.canOverlap?w.sortKey:void 0),Te=this.glyphOffsetArray.length,Ce=Le.vertexLength,Ne=this.allowVerticalPlacement&&S===To.vertical?Math.PI/2:0,Oe=w.text&&w.text.sections;for(let rt=0;rt<l.length;rt++){const{tl:mt,tr:Ft,bl:ct,br:Et,tex:Mt,pixelOffsetTL:Lt,pixelOffsetBR:Vt,minFontScaleX:gt,minFontScaleY:xi,glyphOffset:qi,isSDF:ki,sectionIndex:Si}=l[rt],ai=Le.vertexLength,ji=qi[1];if(qu(ue,C.x,C.y,mt.x,ji+mt.y,Mt.x,Mt.y,d,ki,Lt.x,Lt.y,gt,xi),qu(ue,C.x,C.y,Ft.x,ji+Ft.y,Mt.x+Mt.w,Mt.y,d,ki,Vt.x,Lt.y,gt,xi),qu(ue,C.x,C.y,ct.x,ji+ct.y,Mt.x,Mt.y+Mt.h,d,ki,Lt.x,Vt.y,gt,xi),qu(ue,C.x,C.y,Et.x,ji+Et.y,Mt.x+Mt.w,Mt.y+Mt.h,d,ki,Vt.x,Vt.y,gt,xi),I){const Qi=I.anchor,Ji=I.up;Zu(Se,Qi.x,Qi.y,Qi.z,Ji[0],Ji[1],Ji[2]),Zu(Se,Qi.x,Qi.y,Qi.z,Ji[0],Ji[1],Ji[2]),Zu(Se,Qi.x,Qi.y,Qi.z,Ji[0],Ji[1],Ji[2]),Zu(Se,Qi.x,Qi.y,Qi.z,Ji[0],Ji[1],Ji[2]),Xu(t.dynamicLayoutVertexArray,Qi.x,Qi.y,Qi.z,Ne)}else Xu(t.dynamicLayoutVertexArray,C.x,C.y,C.z,Ne);re.emplaceBack(ai,ai+1,ai+2),re.emplaceBack(ai+1,ai+2,ai+3),Le.vertexLength+=4,Le.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(qi[0]),rt!==l.length-1&&Si===l[rt+1].sectionIndex||t.programConfigurations.populatePaintArrays(ue.length,w,w.index,{},Z,Q,Oe&&Oe[Si])}const st=I?I.anchor:C;t.placedSymbolArray.emplaceBack(st.x,st.y,st.z,C.x,C.y,Te,this.glyphOffsetArray.length-Te,Ce,z,N,C.segment,d?d[0]:0,d?d[1]:0,m[0],m[1],S,0,!1,0,$,0)}_commitLayoutVertex(t,l,d,m,y,w,S){t.emplaceBack(l,d,m,y,w,Math.round(S.x),Math.round(S.y))}_addCollisionDebugVertices(t,l,d,m,y,w,S){const I=d.segments.prepareSegment(4,d.layoutVertexArray,d.indexArray),C=I.vertexLength,z=S.tileAnchorX,N=S.tileAnchorY;for(let Z=0;Z<4;Z++)d.collisionVertexArray.emplaceBack(0,0,0,0);d.collisionVertexArrayExt.emplaceBack(l,-t.padding,-t.padding),d.collisionVertexArrayExt.emplaceBack(l,t.padding,-t.padding),d.collisionVertexArrayExt.emplaceBack(l,t.padding,t.padding),d.collisionVertexArrayExt.emplaceBack(l,-t.padding,t.padding),this._commitLayoutVertex(d.layoutVertexArray,m,y,w,z,N,new J(t.x1,t.y1)),this._commitLayoutVertex(d.layoutVertexArray,m,y,w,z,N,new J(t.x2,t.y1)),this._commitLayoutVertex(d.layoutVertexArray,m,y,w,z,N,new J(t.x2,t.y2)),this._commitLayoutVertex(d.layoutVertexArray,m,y,w,z,N,new J(t.x1,t.y2)),I.vertexLength+=4;const $=d.indexArray;$.emplaceBack(C,C+1),$.emplaceBack(C+1,C+2),$.emplaceBack(C+2,C+3),$.emplaceBack(C+3,C),I.primitiveLength+=4}_addTextDebugCollisionBoxes(t,l,d,m,y,w){for(let S=m;S<y;S++){const I=d.get(S),C=this.getSymbolInstanceTextSize(t,w,l,S);this._addCollisionDebugVertices(I,C,this.textCollisionBox,I.projectedAnchorX,I.projectedAnchorY,I.projectedAnchorZ,w)}}_addIconDebugCollisionBoxes(t,l,d,m,y,w){for(let S=m;S<y;S++){const I=d.get(S),C=this.getSymbolInstanceIconSize(t,l,w.placedIconSymbolIndex);this._addCollisionDebugVertices(I,C,this.iconCollisionBox,I.projectedAnchorX,I.projectedAnchorY,I.projectedAnchorZ,w)}}generateCollisionDebugBuffers(t,l){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Gh(Rr,If.members,bo),this.iconCollisionBox=new Gh(Rr,If.members,bo);const d=Il(this.iconSizeData,t),m=Il(this.textSizeData,t);for(let y=0;y<this.symbolInstances.length;y++){const w=this.symbolInstances.get(y);this._addTextDebugCollisionBoxes(m,t,l,w.textBoxStartIndex,w.textBoxEndIndex,w),this._addTextDebugCollisionBoxes(m,t,l,w.verticalTextBoxStartIndex,w.verticalTextBoxEndIndex,w),this._addIconDebugCollisionBoxes(d,t,l,w.iconBoxStartIndex,w.iconBoxEndIndex,w),this._addIconDebugCollisionBoxes(d,t,l,w.verticalIconBoxStartIndex,w.verticalIconBoxEndIndex,w)}}getSymbolInstanceTextSize(t,l,d,m){const y=this.text.placedSymbolArray.get(l.rightJustifiedTextSymbolIndex>=0?l.rightJustifiedTextSymbolIndex:l.centerJustifiedTextSymbolIndex>=0?l.centerJustifiedTextSymbolIndex:l.leftJustifiedTextSymbolIndex>=0?l.leftJustifiedTextSymbolIndex:l.verticalPlacedTextSymbolIndex>=0?l.verticalPlacedTextSymbolIndex:m),w=Ru(this.textSizeData,t,y)/In;return this.tilePixelRatio*w}getSymbolInstanceIconSize(t,l,d){const m=this.icon.placedSymbolArray.get(d),y=Ru(this.iconSizeData,t,m);return this.tilePixelRatio*y}_commitDebugCollisionVertexUpdate(t,l,d){t.emplaceBack(l,-d,-d),t.emplaceBack(l,d,-d),t.emplaceBack(l,d,d),t.emplaceBack(l,-d,d)}_updateTextDebugCollisionBoxes(t,l,d,m,y,w){for(let S=m;S<y;S++){const I=d.get(S),C=this.getSymbolInstanceTextSize(t,w,l,S);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,C,I.padding)}}_updateIconDebugCollisionBoxes(t,l,d,m,y,w){for(let S=m;S<y;S++){const I=d.get(S),C=this.getSymbolInstanceIconSize(t,l,w);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,C,I.padding)}}updateCollisionDebugBuffers(t,l){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const d=Il(this.iconSizeData,t),m=Il(this.textSizeData,t);for(let y=0;y<this.symbolInstances.length;y++){const w=this.symbolInstances.get(y);this._updateTextDebugCollisionBoxes(m,t,l,w.textBoxStartIndex,w.textBoxEndIndex,w),this._updateTextDebugCollisionBoxes(m,t,l,w.verticalTextBoxStartIndex,w.verticalTextBoxEndIndex,w),this._updateIconDebugCollisionBoxes(d,t,l,w.iconBoxStartIndex,w.iconBoxEndIndex,w.placedIconSymbolIndex),this._updateIconDebugCollisionBoxes(d,t,l,w.verticalIconBoxStartIndex,w.verticalIconBoxEndIndex,w.placedIconSymbolIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,l,d,m,y,w,S,I,C){const z={};for(let N=l;N<d;N++){const $=t.get(N);z.textBox={x1:$.x1,y1:$.y1,x2:$.x2,y2:$.y2,padding:$.padding,projectedAnchorX:$.projectedAnchorX,projectedAnchorY:$.projectedAnchorY,projectedAnchorZ:$.projectedAnchorZ,tileAnchorX:$.tileAnchorX,tileAnchorY:$.tileAnchorY},z.textFeatureIndex=$.featureIndex;break}for(let N=m;N<y;N++){const $=t.get(N);z.verticalTextBox={x1:$.x1,y1:$.y1,x2:$.x2,y2:$.y2,padding:$.padding,projectedAnchorX:$.projectedAnchorX,projectedAnchorY:$.projectedAnchorY,projectedAnchorZ:$.projectedAnchorZ,tileAnchorX:$.tileAnchorX,tileAnchorY:$.tileAnchorY},z.verticalTextFeatureIndex=$.featureIndex;break}for(let N=w;N<S;N++){const $=t.get(N);z.iconBox={x1:$.x1,y1:$.y1,x2:$.x2,y2:$.y2,padding:$.padding,projectedAnchorX:$.projectedAnchorX,projectedAnchorY:$.projectedAnchorY,projectedAnchorZ:$.projectedAnchorZ,tileAnchorX:$.tileAnchorX,tileAnchorY:$.tileAnchorY},z.iconFeatureIndex=$.featureIndex;break}for(let N=I;N<C;N++){const $=t.get(N);z.verticalIconBox={x1:$.x1,y1:$.y1,x2:$.x2,y2:$.y2,padding:$.padding,projectedAnchorX:$.projectedAnchorX,projectedAnchorY:$.projectedAnchorY,projectedAnchorZ:$.projectedAnchorZ,tileAnchorX:$.tileAnchorX,tileAnchorY:$.tileAnchorY},z.verticalIconFeatureIndex=$.featureIndex;break}return z}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let l=0;l<this.symbolInstances.length;l++){const d=this.symbolInstances.get(l);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,d.textBoxStartIndex,d.textBoxEndIndex,d.verticalTextBoxStartIndex,d.verticalTextBoxEndIndex,d.iconBoxStartIndex,d.iconBoxEndIndex,d.verticalIconBoxStartIndex,d.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(t,l){const d=t.placedSymbolArray.get(l),m=d.vertexStartIndex+4*d.numGlyphs;for(let y=d.vertexStartIndex;y<m;y+=4)t.indexArray.emplaceBack(y,y+1,y+2),t.indexArray.emplaceBack(y+1,y+2,y+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const l=Math.sin(t),d=Math.cos(t),m=[],y=[],w=[];for(let S=0;S<this.symbolInstances.length;++S){w.push(S);const I=this.symbolInstances.get(S);m.push(0|Math.round(l*I.tileAnchorX+d*I.tileAnchorY)),y.push(I.featureIndex)}return w.sort((S,I)=>m[S]-m[I]||y[I]-y[S]),w}addToSortKeyRanges(t,l){const d=this.sortKeyRanges[this.sortKeyRanges.length-1];d&&d.sortKey===l?d.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:l,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const l of this.symbolInstanceIndexes){const d=this.symbolInstances.get(l);this.featureSortOrder.push(d.featureIndex),[d.rightJustifiedTextSymbolIndex,d.centerJustifiedTextSymbolIndex,d.leftJustifiedTextSymbolIndex].forEach((m,y,w)=>{m>=0&&w.indexOf(m)===y&&this.addIndicesForPlacedSymbol(this.text,m)}),d.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,d.verticalPlacedTextSymbolIndex),d.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,d.placedIconSymbolIndex),d.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,d.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}_i(ps,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),ps.MAX_GLYPHS=65535,ps.addDynamicAttributes=Xu;const r0=new Ht({"symbol-placement":new tt(it.layout_symbol["symbol-placement"]),"symbol-spacing":new tt(it.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new tt(it.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ve(it.layout_symbol["symbol-sort-key"]),"symbol-z-order":new tt(it.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new tt(it.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new tt(it.layout_symbol["icon-ignore-placement"]),"icon-optional":new tt(it.layout_symbol["icon-optional"]),"icon-rotation-alignment":new tt(it.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ve(it.layout_symbol["icon-size"]),"icon-text-fit":new tt(it.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new tt(it.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ve(it.layout_symbol["icon-image"]),"icon-rotate":new Ve(it.layout_symbol["icon-rotate"]),"icon-padding":new tt(it.layout_symbol["icon-padding"]),"icon-keep-upright":new tt(it.layout_symbol["icon-keep-upright"]),"icon-offset":new Ve(it.layout_symbol["icon-offset"]),"icon-anchor":new Ve(it.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new tt(it.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new tt(it.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new tt(it.layout_symbol["text-rotation-alignment"]),"text-field":new Ve(it.layout_symbol["text-field"]),"text-font":new Ve(it.layout_symbol["text-font"]),"text-size":new Ve(it.layout_symbol["text-size"]),"text-max-width":new Ve(it.layout_symbol["text-max-width"]),"text-line-height":new Ve(it.layout_symbol["text-line-height"]),"text-letter-spacing":new Ve(it.layout_symbol["text-letter-spacing"]),"text-justify":new Ve(it.layout_symbol["text-justify"]),"text-radial-offset":new Ve(it.layout_symbol["text-radial-offset"]),"text-variable-anchor":new tt(it.layout_symbol["text-variable-anchor"]),"text-anchor":new Ve(it.layout_symbol["text-anchor"]),"text-max-angle":new tt(it.layout_symbol["text-max-angle"]),"text-writing-mode":new tt(it.layout_symbol["text-writing-mode"]),"text-rotate":new Ve(it.layout_symbol["text-rotate"]),"text-padding":new tt(it.layout_symbol["text-padding"]),"text-keep-upright":new tt(it.layout_symbol["text-keep-upright"]),"text-transform":new Ve(it.layout_symbol["text-transform"]),"text-offset":new Ve(it.layout_symbol["text-offset"]),"text-allow-overlap":new tt(it.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new tt(it.layout_symbol["text-ignore-placement"]),"text-optional":new tt(it.layout_symbol["text-optional"])});var qh={paint:new Ht({"icon-opacity":new Ve(it.paint_symbol["icon-opacity"]),"icon-color":new Ve(it.paint_symbol["icon-color"]),"icon-halo-color":new Ve(it.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ve(it.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ve(it.paint_symbol["icon-halo-blur"]),"icon-translate":new tt(it.paint_symbol["icon-translate"]),"icon-translate-anchor":new tt(it.paint_symbol["icon-translate-anchor"]),"text-opacity":new Ve(it.paint_symbol["text-opacity"]),"text-color":new Ve(it.paint_symbol["text-color"],{runtimeType:Jn,getOverride:s=>s.textColor,hasOverride:s=>!!s.textColor}),"text-halo-color":new Ve(it.paint_symbol["text-halo-color"]),"text-halo-width":new Ve(it.paint_symbol["text-halo-width"]),"text-halo-blur":new Ve(it.paint_symbol["text-halo-blur"]),"text-translate":new tt(it.paint_symbol["text-translate"]),"text-translate-anchor":new tt(it.paint_symbol["text-translate-anchor"])}),layout:r0};class gp{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:So,this.defaultValue=t}evaluate(t){if(t.formattedSection){const l=this.defaultValue.property.overrides;if(l&&l.hasOverride(t.formattedSection))return l.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}_i(gp,"FormatSectionOverride",{omit:["defaultValue"]});class Hu extends Ko{constructor(t){super(t,qh)}recalculate(t,l){super.recalculate(t,l),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const d=this.layout.get("text-writing-mode");if(d){const m=[];for(const y of d)m.indexOf(y)<0&&m.push(y);this.layout._values["text-writing-mode"]=m}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(t,l,d,m){const y=this.layout.get(t).evaluate(l,{},d,m),w=this._unevaluatedLayout._values[t];return w.isDataDriven()||ks(w.value)||!y?y:function(S,I){return I.replace(/{([^{}]+)}/g,(C,z)=>z in S?String(S[z]):"")}(l.properties,y)}createBucket(t){return new ps(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of qh.paint.overridableProperties){if(!Hu.hasPaintOverride(this.layout,t))continue;const l=this.paint.get(t),d=new gp(l),m=new Cs(d,l.property.specification);let y=null;y=l.value.kind==="constant"||l.value.kind==="source"?new rl("source",m):new nl("composite",m,l.value.zoomStops,l.value._interpolationType),this.paint._values[t]=new wt(l.property,y,l.parameters)}}_handleOverridablePaintPropertyUpdate(t,l,d){return!(!this.layout||l.isDataDriven()||d.isDataDriven())&&Hu.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,l){const d=t.get("text-field"),m=qh.paint.properties[l];let y=!1;const w=S=>{for(const I of S)if(m.overrides&&m.overrides.hasOverride(I))return void(y=!0)};if(d.value.kind==="constant"&&d.value.value instanceof Mi)w(d.value.value.sections);else if(d.value.kind==="source"){const S=C=>{y||(C instanceof Dr&&ni(C.value)===na?w(C.value.sections):C instanceof an?w(C.sections):C.eachChild(S))},I=d.value;I._styleExpression&&S(I._styleExpression.expression)}return y}getProgramConfiguration(t){return new us(this,t)}}var n0={paint:new Ht({"background-color":new tt(it.paint_background["background-color"]),"background-pattern":new qt(it.paint_background["background-pattern"]),"background-opacity":new tt(it.paint_background["background-opacity"])})},o0={paint:new Ht({"raster-opacity":new tt(it.paint_raster["raster-opacity"]),"raster-hue-rotate":new tt(it.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new tt(it.paint_raster["raster-brightness-min"]),"raster-brightness-max":new tt(it.paint_raster["raster-brightness-max"]),"raster-saturation":new tt(it.paint_raster["raster-saturation"]),"raster-contrast":new tt(it.paint_raster["raster-contrast"]),"raster-resampling":new tt(it.paint_raster["raster-resampling"]),"raster-fade-duration":new tt(it.paint_raster["raster-fade-duration"])})};class a0 extends Ko{constructor(t){super(t,{}),this.implementation=t}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}var s0={paint:new Ht({"sky-type":new tt(it.paint_sky["sky-type"]),"sky-atmosphere-sun":new tt(it.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new tt(it.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new tt(it.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new tt(it.paint_sky["sky-gradient-radius"]),"sky-gradient":new Jt(it.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new tt(it.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new tt(it.paint_sky["sky-atmosphere-color"]),"sky-opacity":new tt(it.paint_sky["sky-opacity"])})};function Zh(s,t,l){const d=[0,0,1],m=Yd([]);return Qd(m,m,l?-ce(s)+Math.PI:ce(s)),Kd(m,m,-ce(t)),Zd(d,d,m),Gn(d,d)}const l0={circle:class extends Ko{constructor(s){super(s,cm)}createBucket(s){return new lh(s)}queryRadius(s){const t=s;return wl("circle-radius",this,t)+wl("circle-stroke-width",this,t)+bu(this.paint.get("circle-translate"))}queryIntersectsFeature(s,t,l,d,m,y,w,S){const I=Nd(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),y.angle,s.pixelToTileUnitsFactor),C=this.paint.get("circle-radius").evaluate(t,l)+this.paint.get("circle-stroke-width").evaluate(t,l);return Jd(s,d,y,w,S,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",I,C)}getProgramIds(){return["circle"]}getProgramConfiguration(s){return new us(this,s)}},heatmap:class extends Ko{createBucket(s){return new tf(s)}constructor(s){super(s,_m),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(s){s==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=vh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(s){return wl("heatmap-radius",this,s)}queryIntersectsFeature(s,t,l,d,m,y,w,S){const I=this.paint.get("heatmap-radius").evaluate(t,l);return Jd(s,d,y,w,S,!0,!0,new J(0,0),I)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(s){return new us(this,s)}},hillshade:class extends Ko{constructor(s){super(s,ym)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}},fill:class extends Ko{constructor(s){super(s,Rm)}getProgramIds(){const s=this.paint.get("fill-pattern"),t=s&&s.constantOr(1),l=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&l.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),l}getProgramConfiguration(s){return new us(this,s)}recalculate(s,t){super.recalculate(s,t);const l=this.paint._values["fill-outline-color"];l.value.kind==="constant"&&l.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(s){return new Iu(s)}queryRadius(){return bu(this.paint.get("fill-translate"))}queryIntersectsFeature(s,t,l,d,m,y){return!s.queryGeometry.isAboveHorizon&&Rd(Fd(s.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),y.angle,s.pixelToTileUnitsFactor),d)}isTileClipped(){return!0}},"fill-extrusion":class extends Ko{constructor(s){super(s,Ym)}createBucket(s){return new bc(s)}queryRadius(){return bu(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(s){return new us(this,s)}queryIntersectsFeature(s,t,l,d,m,y,w,S,I){const C=Nd(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),y.angle,s.pixelToTileUnitsFactor),z=this.paint.get("fill-extrusion-height").evaluate(t,l),N=this.paint.get("fill-extrusion-base").evaluate(t,l),$=[0,0],Z=S&&y.elevation,Q=y.elevation?y.elevation.exaggeration():1,re=s.tile.getBucket(this);if(Z&&re instanceof bc){const Ce=re.centroidVertexArray,Ne=I+1;if(Ne<Ce.length){const Oe=Ce.get(Ne);$[0]=Oe.a_centroid_pos0,$[1]=Oe.a_centroid_pos1}}if($[0]===0&&$[1]===1)return!1;y.projection.name==="globe"&&(d=vf([d],[new J(0,0),new J(Gi,Gi)],s.tileID.canonical).map(Ce=>Ce.polygon).flat());const ue=Z?S:null,[Se,Le]=function(Ce,Ne,Oe,st,rt,mt,Ft,ct,Et,Mt,Lt){return Ce.projection.name==="globe"?function(Vt,gt,xi,qi,ki,Si,ai,ji,Qi,Ji,pr){const Yi=[],jr=[],tr=Vt.projection.upVectorScale(pr,Vt.center.lat,Vt.worldSize).metersToTile,lr=[0,0,0,1],Mr=[0,0,0,1],Ur=($r,Gr,Qr,vn)=>{$r[0]=Gr,$r[1]=Qr,$r[2]=vn,$r[3]=1},zr=xf();xi>0&&(xi+=zr),qi+=zr;for(const $r of gt){const Gr=[],Qr=[];for(const vn of $r){const wr=vn.x+ki.x,cn=vn.y+ki.y,on=Vt.projection.projectTilePoint(wr,cn,pr),mr=Vt.projection.upVector(pr,vn.x,vn.y);let Wr=xi,pn=qi;if(ai){const Ar=Tf(wr,cn,xi,qi,ai,ji,Qi,Ji);Wr+=Ar.base,pn+=Ar.top}xi!==0?Ur(lr,on.x+mr[0]*tr*Wr,on.y+mr[1]*tr*Wr,on.z+mr[2]*tr*Wr):Ur(lr,on.x,on.y,on.z),Ur(Mr,on.x+mr[0]*tr*pn,on.y+mr[1]*tr*pn,on.z+mr[2]*tr*pn),ln(lr,lr,Si),ln(Mr,Mr,Si),Gr.push(new Al(lr[0],lr[1],lr[2])),Qr.push(new Al(Mr[0],Mr[1],Mr[2]))}Yi.push(Gr),jr.push(Qr)}return[Yi,jr]}(Ce,Ne,Oe,st,rt,mt,Ft,ct,Et,Mt,Lt):Ft?function(Vt,gt,xi,qi,ki,Si,ai,ji,Qi){const Ji=[],pr=[],Yi=[0,0,0,1];for(const jr of Vt){const tr=[],lr=[];for(const Mr of jr){const Ur=Mr.x+qi.x,zr=Mr.y+qi.y,$r=Tf(Ur,zr,gt,xi,Si,ai,ji,Qi);Yi[0]=Ur,Yi[1]=zr,Yi[2]=$r.base,Yi[3]=1,qs(Yi,Yi,ki),Yi[3]=Math.max(Yi[3],1e-5);const Gr=new Al(Yi[0]/Yi[3],Yi[1]/Yi[3],Yi[2]/Yi[3]);Yi[0]=Ur,Yi[1]=zr,Yi[2]=$r.top,Yi[3]=1,qs(Yi,Yi,ki),Yi[3]=Math.max(Yi[3],1e-5);const Qr=new Al(Yi[0]/Yi[3],Yi[1]/Yi[3],Yi[2]/Yi[3]);tr.push(Gr),lr.push(Qr)}Ji.push(tr),pr.push(lr)}return[Ji,pr]}(Ne,Oe,st,rt,mt,Ft,ct,Et,Mt):function(Vt,gt,xi,qi,ki){const Si=[],ai=[],ji=ki[8]*gt,Qi=ki[9]*gt,Ji=ki[10]*gt,pr=ki[11]*gt,Yi=ki[8]*xi,jr=ki[9]*xi,tr=ki[10]*xi,lr=ki[11]*xi;for(const Mr of Vt){const Ur=[],zr=[];for(const $r of Mr){const Gr=$r.x+qi.x,Qr=$r.y+qi.y,vn=ki[0]*Gr+ki[4]*Qr+ki[12],wr=ki[1]*Gr+ki[5]*Qr+ki[13],cn=ki[2]*Gr+ki[6]*Qr+ki[14],on=ki[3]*Gr+ki[7]*Qr+ki[15],mr=vn+ji,Wr=wr+Qi,pn=cn+Ji,Ar=Math.max(on+pr,1e-5),tn=vn+Yi,zn=wr+jr,bn=cn+tr,wn=Math.max(on+lr,1e-5);Ur.push(new Al(mr/Ar,Wr/Ar,pn/Ar)),zr.push(new Al(tn/wn,zn/wn,bn/wn))}Si.push(Ur),ai.push(zr)}return[Si,ai]}(Ne,Oe,st,rt,mt)}(y,d,N,z,C,w,ue,$,Q,y.center.lat,s.tileID.canonical),Te=s.queryGeometry;return function(Ce,Ne,Oe){let st=1/0;Rd(Oe,Ne)&&(st=Ef(Oe,Ne[0]));for(let rt=0;rt<Ne.length;rt++){const mt=Ne[rt],Ft=Ce[rt];for(let ct=0;ct<mt.length-1;ct++){const Et=mt[ct],Mt=[Et,mt[ct+1],Ft[ct+1],Ft[ct],Et];Bd(Oe,Mt)&&(st=Math.min(st,Ef(Oe,Mt)))}}return st!==1/0&&st}(Se,Le,Te.isPointQuery()?Te.screenBounds:Te.screenGeometry)}},line:class extends Ko{constructor(s){super(s,Sf),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(s){if(s==="line-gradient"){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof Uo,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(s,t){super.recalculate(s,t),this.paint._values["line-floorwidth"]=Mf.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,s)}createBucket(s){return new Bu(s)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(s){return new us(this,s)}queryRadius(s){const t=s,l=Af(wl("line-width",this,t),wl("line-gap-width",this,t)),d=wl("line-offset",this,t);return l/2+Math.abs(d)+bu(this.paint.get("line-translate"))}queryIntersectsFeature(s,t,l,d,m,y){if(s.queryGeometry.isAboveHorizon)return!1;const w=Fd(s.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),y.angle,s.pixelToTileUnitsFactor),S=s.pixelToTileUnitsFactor/2*Af(this.paint.get("line-width").evaluate(t,l),this.paint.get("line-gap-width").evaluate(t,l)),I=this.paint.get("line-offset").evaluate(t,l);return I&&(d=function(C,z){const N=[],$=new J(0,0);for(let Z=0;Z<C.length;Z++){const Q=C[Z],re=[];for(let ue=0;ue<Q.length;ue++){const Se=Q[ue-1],Le=Q[ue],Te=Q[ue+1],Ce=ue===0?$:Le.sub(Se)._unit()._perp(),Ne=ue===Q.length-1?$:Te.sub(Le)._unit()._perp(),Oe=Ce._add(Ne)._unit();Oe._mult(1/(Oe.x*Ne.x+Oe.y*Ne.y)),re.push(Oe._mult(z)._add(Le))}N.push(re)}return N}(d,I*s.pixelToTileUnitsFactor)),function(C,z,N){for(let $=0;$<z.length;$++){const Z=z[$];if(C.length>=3){for(let Q=0;Q<Z.length;Q++)if(js(C,Z[Q]))return!0}if(om(C,Z,N))return!0}return!1}(w,d,S)}isTileClipped(){return!0}},symbol:Hu,background:class extends Ko{constructor(s){super(s,n0)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends Ko{constructor(s){super(s,o0)}getProgramIds(){return["raster"]}},sky:class extends Ko{constructor(s){super(s,s0),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(s){s==="sky-gradient"?this._updateColorRamp():s!=="sky-atmosphere-sun"&&s!=="sky-atmosphere-halo-color"&&s!=="sky-atmosphere-color"&&s!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=vh({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(s){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=s.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(s,t){if(this.paint.get("sky-type")==="atmosphere"){const d=this.paint.get("sky-atmosphere-sun"),m=!d,y=s.style.light,w=y.properties.get("position");return m&&y.properties.get("anchor")==="viewport"&&yi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),m?Zh(w.azimuthal,90-w.polar,t):Zh(d[0],90-d[1],t)}const l=this.paint.get("sky-gradient-center");return Zh(l[0],90-l[1],t)}is3D(){return!1}isSky(){return!0}markSkyboxValid(s){this._skyboxInvalidated=!1,this._lightPosition=s.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const s=this.paint.get("sky-type");return s==="atmosphere"?["skyboxCapture","skybox"]:s==="gradient"?["skyboxGradient"]:null}}};class zc{constructor(t,l,d,m){this.context=t,this.format=d,this.texture=t.gl.createTexture(),this.update(l,m)}update(t,l,d){const{width:m,height:y}=t,{context:w}=this,{gl:S}=w,{HTMLImageElement:I,HTMLCanvasElement:C,HTMLVideoElement:z,ImageData:N,ImageBitmap:$}=b;if(S.bindTexture(S.TEXTURE_2D,this.texture),w.pixelStoreUnpackFlipY.set(!1),w.pixelStoreUnpack.set(1),w.pixelStoreUnpackPremultiplyAlpha.set(this.format===S.RGBA&&(!l||l.premultiply!==!1)),d||this.size&&this.size[0]===m&&this.size[1]===y){const{x:Z,y:Q}=d||{x:0,y:0};t instanceof I||t instanceof C||t instanceof z||t instanceof N||$&&t instanceof $?S.texSubImage2D(S.TEXTURE_2D,0,Z,Q,S.RGBA,S.UNSIGNED_BYTE,t):S.texSubImage2D(S.TEXTURE_2D,0,Z,Q,m,y,S.RGBA,S.UNSIGNED_BYTE,t.data)}else this.size=[m,y],t instanceof I||t instanceof C||t instanceof z||t instanceof N||$&&t instanceof $?S.texImage2D(S.TEXTURE_2D,0,this.format,this.format,S.UNSIGNED_BYTE,t):S.texImage2D(S.TEXTURE_2D,0,this.format,m,y,0,this.format,S.UNSIGNED_BYTE,t.data);this.useMipmap=Boolean(l&&l.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&S.generateMipmap(S.TEXTURE_2D)}bind(t,l){const{context:d}=this,{gl:m}=d;m.bindTexture(m.TEXTURE_2D,this.texture),t!==this.filter&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,t),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,this.useMipmap?t===m.NEAREST?m.NEAREST_MIPMAP_NEAREST:m.LINEAR_MIPMAP_NEAREST:t),this.filter=t),l!==this.wrap&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,l),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,l),this.wrap=l)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class c0{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class u0{constructor(){this.tasks={},this.taskQueue=[],Dt(["process"],this),this.invoker=new c0(this.process),this.nextId=0}add(t,l){const d=this.nextId++,m=function({type:y,isSymbolTile:w,zoom:S}){return S=S||0,y==="message"?0:y!=="maybePrepare"||w?y!=="parseTile"||w?y==="parseTile"&&w?300-S:y==="maybePrepare"&&w?400-S:500:200-S:100-S}(l);if(m===0){kt();try{t()}finally{}return{cancel:()=>{}}}return this.tasks[d]={fn:t,metadata:l,priority:m,id:d},this.taskQueue.push(d),this.invoker.trigger(),{cancel:()=>{delete this.tasks[d]}}}process(){kt();try{if(this.taskQueue=this.taskQueue.filter(d=>!!this.tasks[d]),!this.taskQueue.length)return;const t=this.pick();if(t===null)return;const l=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!l)return;l.fn()}finally{}}pick(){let t=null,l=1/0;for(let m=0;m<this.taskQueue.length;m++){const y=this.tasks[this.taskQueue[m]];y.priority<l&&(l=y.priority,t=m)}if(t===null)return null;const d=this.taskQueue[t];return this.taskQueue.splice(t,1),d}remove(){this.invoker.remove()}}class _p{constructor(t){this._stringToNumber={},this._numberToString=[];for(let l=0;l<t.length;l++){const d=t[l];this._stringToNumber[d]=l,this._numberToString[l]=d}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}const h0=["tile","layer","source","sourceLayer","state"];class yp{constructor(t,l,d,m,y){this.type="Feature",this._vectorTileFeature=t,this._z=l,this._x=d,this._y=m,this.properties=t.properties,this.id=y}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",geometry:this.geometry,properties:this.properties};this.id!==void 0&&(t.id=this.id);for(const l of h0)this[l]!==void 0&&(t[l]=this[l]);return t}}const Lo=32,Sa=33,ms=new Uint16Array(8184);for(let s=0;s<2046;s++){let t=s+2,l=0,d=0,m=0,y=0,w=0,S=0;for(1&t?m=y=w=Lo:l=d=S=Lo;(t>>=1)>1;){const C=l+m>>1,z=d+y>>1;1&t?(m=l,y=d,l=w,d=S):(l=m,d=y,m=w,y=S),w=C,S=z}const I=4*s;ms[I+0]=l,ms[I+1]=d,ms[I+2]=m,ms[I+3]=y}const Ma=new Uint16Array(2178),gs=new Uint8Array(1089),Wu=new Uint16Array(1089);function xp(s){return s===0?-.03125:s===32?.03125:0}var vp=Wt([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const bp={type:2,extent:Gi,loadGeometry:()=>[[new J(0,0),new J(8193,0),new J(8193,8193),new J(0,8193),new J(0,0)]]};class Xh{constructor(t,l,d,m,y){this.tileID=t,this.uid=Bt(),this.uses=0,this.tileSize=l,this.tileZoom=d,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=y,this.expiredRequestCount=0,this.state="loading",m&&m.transform&&(this.projection=m.transform.projection)}registerFadeDuration(t){const l=t+this.timeAdded;l<Re.now()||this.fadeEndTime&&l<this.fadeEndTime||(this.fadeEndTime=l)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=Hs(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,l,d){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(m,y){const w={};if(!y)return w;for(const S of m){const I=S.layerIds.map(C=>y.getLayer(C)).filter(Boolean);if(I.length!==0){S.layers=I,S.stateDependentLayerIds&&(S.stateDependentLayers=S.stateDependentLayerIds.map(C=>I.filter(z=>z.id===C)[0]));for(const C of I)w[C.id]=S}}return w}(t.buckets,l.style),this.hasSymbolBuckets=!1;for(const m in this.buckets){const y=this.buckets[m];if(y instanceof ps){if(this.hasSymbolBuckets=!0,!d)break;y.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const m in this.buckets){const y=this.buckets[m];if(y instanceof ps&&y.hasRTLText){this.hasRTLText=!0,ze.isLoading()||ze.isLoaded()||ge()!=="deferred"||Be();break}}this.queryPadding=0;for(const m in this.buckets){const y=this.buckets[m];this.queryPadding=Math.max(this.queryPadding,l.style.getLayer(m).queryRadius(y))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas)}else this.collisionBoxArray=new th}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(t){return this.buckets[t.id]}upload(t){for(const d in this.buckets){const m=this.buckets[d];m.uploadPending()&&m.upload(t)}const l=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new zc(t,this.imageAtlas.image,l.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new zc(t,this.glyphAtlasImage,l.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new zc(t,this.lineAtlas.image,l.ALPHA),this.lineAtlas.uploaded=!0)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,l,d,m,y,w,S,I){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:m,pixelPosMatrix:S,transform:w,params:y,tileTransform:this.tileTransform},t,l,d):{}}querySourceFeatures(t,l){const d=this.latestFeatureIndex;if(!d||!d.rawTileData)return;const m=d.loadVTLayers(),y=l?l.sourceLayer:"",w=m._geojsonTileLayer||m[y];if(!w)return;const S=al(l&&l.filter),{z:I,x:C,y:z}=this.tileID.canonical,N={z:I,x:C,y:z};for(let $=0;$<w.length;$++){const Z=w.feature($);if(S.needGeometry){const ue=Vs(Z,!0);if(!S.filter(new Me(this.tileID.overscaledZ),ue,this.tileID.canonical))continue}else if(!S.filter(new Me(this.tileID.overscaledZ),Z))continue;const Q=d.getId(Z,y),re=new yp(Z,I,C,z,Q);re.tile=N,t.push(re)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const l=this.expirationTime;if(t.cacheControl){const d=Ri(t.cacheControl);d["max-age"]&&(this.expirationTime=Date.now()+1e3*d["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const d=Date.now();let m=!1;if(this.expirationTime>d)m=!1;else if(l)if(this.expirationTime<l)m=!0;else{const y=this.expirationTime-l;y?this.expirationTime=d+Math.max(y,3e4):m=!0}else m=!0;m?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,l){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(t).length===0||!l)return;const d=this.latestFeatureIndex.loadVTLayers(),m=l.style.listImages();for(const y in this.buckets){if(!l.style.hasLayer(y))continue;const w=this.buckets[y],S=w.layers[0].sourceLayer||"_geojsonTileLayer",I=d[S],C=t[S];if(!I||!C||Object.keys(C).length===0)continue;if(w.update(C,I,m,this.imageAtlas&&this.imageAtlas.patternPositions||{}),w instanceof Bu||w instanceof Iu){const N=l.style._getSourceCache(w.layers[0].source);l._terrain&&l._terrain.enabled&&N&&w.programConfigurations.needsUpload&&l._terrain._clearRenderCacheForTile(N.id,this.tileID)}const z=l&&l.style&&l.style.getLayer(y);z&&(this.queryPadding=Math.max(this.queryPadding,z.queryRadius(w)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Re.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=Re.now()+t}setTexture(t,l){const d=l.context,m=d.gl;this.texture=this.texture||l.getTileTexture(t.width),this.texture?this.texture.update(t,{useMipmap:!0}):(this.texture=new zc(d,t,m.RGBA,{useMipmap:!0}),this.texture.bind(m.LINEAR,m.CLAMP_TO_EDGE),d.extTextureFilterAnisotropic&&m.texParameterf(m.TEXTURE_2D,d.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,d.extTextureFilterAnisotropicMax))}setDependencies(t,l){const d={};for(const m of l)d[m]=!0;this.dependencies[t]=d}hasDependency(t,l){for(const d of t){const m=this.dependencies[d];if(m){for(const y of l)if(m[y])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,l){if(!l||l.name==="mercator"||this._tileDebugBuffer)return;const d=$a(bp,this.tileID.canonical,this.tileTransform)[0],m=new er,y=new ac;for(let w=0;w<d.length;w++){const{x:S,y:I}=d[w];m.emplaceBack(S,I),y.emplaceBack(w)}y.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(y),this._tileDebugBuffer=t.createVertexBuffer(m,Ic.members),this._tileDebugSegments=sn.simpleSegment(0,0,m.length,y.length)}_makeTileBoundsBuffers(t,l){if(this._tileBoundsBuffer||!l||l.name==="mercator")return;const d=$a(bp,this.tileID.canonical,this.tileTransform)[0];let m,y;if(this.isRaster){const w=function(S,I){const C=Hs(S,I),z=Math.pow(2,S.z);for(let ue=0;ue<Sa;ue++)for(let Se=0;Se<Sa;Se++){const Le=wo((S.x+(Se+xp(Se))/Lo)/z),Te=An((S.y+(ue+xp(ue))/Lo)/z),Ce=I.project(Le,Te),Ne=ue*Sa+Se;Ma[2*Ne+0]=Math.round((Ce.x*C.scale-C.x)*Gi),Ma[2*Ne+1]=Math.round((Ce.y*C.scale-C.y)*Gi)}gs.fill(0),Wu.fill(0);for(let ue=2045;ue>=0;ue--){const Se=4*ue,Le=ms[Se+0],Te=ms[Se+1],Ce=ms[Se+2],Ne=ms[Se+3],Oe=Le+Ce>>1,st=Te+Ne>>1,rt=Oe+st-Te,mt=st+Le-Oe,Ft=Te*Sa+Le,ct=Ne*Sa+Ce,Et=st*Sa+Oe,Mt=Math.hypot((Ma[2*Ft+0]+Ma[2*ct+0])/2-Ma[2*Et+0],(Ma[2*Ft+1]+Ma[2*ct+1])/2-Ma[2*Et+1])>=16;if(gs[Et]=gs[Et]||(Mt?1:0),ue<1022){const Lt=(Te+mt>>1)*Sa+(Le+rt>>1),Vt=(Ne+mt>>1)*Sa+(Ce+rt>>1);gs[Et]=gs[Et]||gs[Lt]||gs[Vt]}}const N=new Sr,$=new Ln;let Z=0;function Q(ue,Se){const Le=Se*Sa+ue;return Wu[Le]===0&&(N.emplaceBack(Ma[2*Le+0],Ma[2*Le+1],ue*Gi/Lo,Se*Gi/Lo),Wu[Le]=++Z),Wu[Le]-1}function re(ue,Se,Le,Te,Ce,Ne){const Oe=ue+Le>>1,st=Se+Te>>1;if(Math.abs(ue-Ce)+Math.abs(Se-Ne)>1&&gs[st*Sa+Oe])re(Ce,Ne,ue,Se,Oe,st),re(Le,Te,Ce,Ne,Oe,st);else{const rt=Q(ue,Se),mt=Q(Le,Te),Ft=Q(Ce,Ne);$.emplaceBack(rt,mt,Ft)}}return re(0,0,Lo,Lo,Lo,0),re(Lo,Lo,0,0,0,Lo),{vertices:N,indices:$}}(this.tileID.canonical,l);m=w.vertices,y=w.indices}else{m=new Sr,y=new Ln;for(const{x:S,y:I}of d)m.emplaceBack(S,I,0,0);const w=pc.exports(m.int16,void 0,4);for(let S=0;S<w.length;S+=3)y.emplaceBack(w[S],w[S+1],w[S+2])}this._tileBoundsBuffer=t.createVertexBuffer(m,vp.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(y),this._tileBoundsSegments=sn.simpleSegment(0,0,m.length,y.length)}_makeGlobeTileDebugBuffers(t,l){const d=l.projection;if(!d||d.name!=="globe"||l.freezeTileCoverage)return;const m=this.tileID.canonical,y=Pc(np(m,l)),w=Ol(l.zoom);let S;w>0&&(S=hh(new Float64Array(16),l.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,m,l,y,S,w),this._makeGlobeTileDebugTextBuffer(t,m,l,y,S,w)}_globePoint(t,l,d,m,y,w,S){let I=kc(t,l,d);if(w){const C=1<<d.z,z=xa(m.center.lng),N=va(m.center.lat),$=(d.x+.5)/C-z;let Z=0;$>.5?Z=-1:$<-.5&&(Z=1);let Q=(t/Gi+d.x)/C+Z,re=(l/Gi+d.y)/C;Q=(Q-z)*m._pixelsPerMercatorPixel+z,re=(re-N)*m._pixelsPerMercatorPixel+N;const ue=[Q*m.worldSize,re*m.worldSize,0];ln(ue,ue,w),I=Xs(I,ue,S)}return ln(I,I,y)}_makeGlobeTileDebugBorderBuffer(t,l,d,m,y,w){const S=new er,I=new ac,C=new Tr,z=($,Z,Q,re,ue)=>{const Se=(Q-$)/(ue-1),Le=(re-Z)/(ue-1),Te=S.length;for(let Ce=0;Ce<ue;Ce++){const Ne=$+Ce*Se,Oe=Z+Ce*Le;S.emplaceBack(Ne,Oe);const st=this._globePoint(Ne,Oe,l,d,m,y,w);C.emplaceBack(st[0],st[1],st[2]),I.emplaceBack(Te+Ce)}},N=Gi;z(0,0,N,0,16),z(N,0,N,N,16),z(N,N,0,N,16),z(0,N,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(I),this._tileDebugBuffer=t.createVertexBuffer(S,Ic.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(C,ip.members),this._tileDebugSegments=sn.simpleSegment(0,0,S.length,I.length)}_makeGlobeTileDebugTextBuffer(t,l,d,m,y,w){const S=new er,I=new Ln,C=new Tr,z=25;I.reserve(32),S.reserve(z),C.reserve(z);const N=($,Z)=>z*$+Z;for(let $=0;$<z;$++){const Z=2048*$;for(let Q=0;Q<z;Q++){const re=2048*Q;S.emplaceBack(re,Z);const ue=this._globePoint(re,Z,l,d,m,y,w);C.emplaceBack(ue[0],ue[1],ue[2])}}for(let $=0;$<4;$++)for(let Z=0;Z<4;Z++){const Q=N($,Z),re=N($,Z+1),ue=N($+1,Z),Se=N($+1,Z+1);I.emplaceBack(Q,re,ue),I.emplaceBack(ue,re,Se)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(I),this._tileDebugTextBuffer=t.createVertexBuffer(S,Ic.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(C,ip.members),this._tileDebugTextSegments=sn.simpleSegment(0,0,z,32)}}class d0{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,l,d){const m=String(l);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][m]=this.stateChanges[t][m]||{},je(this.stateChanges[t][m],d),this.deletedStates[t]===null){this.deletedStates[t]={};for(const y in this.state[t])y!==m&&(this.deletedStates[t][y]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][m]===null){this.deletedStates[t][m]={};for(const y in this.state[t][m])d[y]||(this.deletedStates[t][m][y]=null)}else for(const y in d)this.deletedStates[t]&&this.deletedStates[t][m]&&this.deletedStates[t][m][y]===null&&delete this.deletedStates[t][m][y]}removeFeatureState(t,l,d){if(this.deletedStates[t]===null)return;const m=String(l);if(this.deletedStates[t]=this.deletedStates[t]||{},d&&l!==void 0)this.deletedStates[t][m]!==null&&(this.deletedStates[t][m]=this.deletedStates[t][m]||{},this.deletedStates[t][m][d]=null);else if(l!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][m])for(d in this.deletedStates[t][m]={},this.stateChanges[t][m])this.deletedStates[t][m][d]=null;else this.deletedStates[t][m]=null;else this.deletedStates[t]=null}getState(t,l){const d=String(l),m=je({},(this.state[t]||{})[d],(this.stateChanges[t]||{})[d]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const y=this.deletedStates[t][l];if(y===null)return{};for(const w in y)delete m[w]}return m}initializeTileState(t,l){t.setFeatureState(this.state,l)}coalesceChanges(t,l){const d={};for(const m in this.stateChanges){this.state[m]=this.state[m]||{};const y={};for(const w in this.stateChanges[m])this.state[m][w]||(this.state[m][w]={}),je(this.state[m][w],this.stateChanges[m][w]),y[w]=this.state[m][w];d[m]=y}for(const m in this.deletedStates){this.state[m]=this.state[m]||{};const y={};if(this.deletedStates[m]===null)for(const w in this.state[m])y[w]={},this.state[m][w]={};else for(const w in this.deletedStates[m]){if(this.deletedStates[m][w]===null)this.state[m][w]={};else for(const S of Object.keys(this.deletedStates[m][w]))delete this.state[m][w][S];y[w]=this.state[m][w]}d[m]=d[m]||{},je(d[m],y)}if(this.stateChanges={},this.deletedStates={},Object.keys(d).length!==0)for(const m in t)t[m].setFeatureState(d,l)}}class wp{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,l){const d=this.toIdx(t,l);return{min:this.minimums[d],max:this.maximums[d]}}isLeaf(t,l){return this.leaves[this.toIdx(t,l)]}toIdx(t,l){return l*this.size+t}}function Ep(s,t,l,d){let m=0,y=Number.MAX_VALUE;for(let w=0;w<3;w++)if(Math.abs(d[w])<1e-15){if(l[w]<s[w]||l[w]>t[w])return null}else{const S=1/d[w];let I=(s[w]-l[w])*S,C=(t[w]-l[w])*S;if(I>C){const z=I;I=C,C=z}if(I>m&&(m=I),C<y&&(y=C),m>y)return null}return m}function Tp(s,t,l,d,m,y,w,S,I,C,z){const N=d-s,$=m-t,Z=y-l,Q=w-s,re=S-t,ue=I-l,Se=z[1]*ue-z[2]*re,Le=z[2]*Q-z[0]*ue,Te=z[0]*re-z[1]*Q,Ce=N*Se+$*Le+Z*Te;if(Math.abs(Ce)<1e-15)return null;const Ne=1/Ce,Oe=C[0]-s,st=C[1]-t,rt=C[2]-l,mt=(Oe*Se+st*Le+rt*Te)*Ne;if(mt<0||mt>1)return null;const Ft=st*Z-rt*$,ct=rt*N-Oe*Z,Et=Oe*$-st*N,Mt=(z[0]*Ft+z[1]*ct+z[2]*Et)*Ne;return Mt<0||mt+Mt>1?null:(Q*Ft+re*ct+ue*Et)*Ne}function Sp(s,t,l){return(s-t)/(l-t)}function Mp(s,t,l,d,m,y,w,S,I){const C=1<<l,z=y-d,N=w-m,$=(s+1)/C*z+d,Z=(t+0)/C*N+m,Q=(t+1)/C*N+m;S[0]=(s+0)/C*z+d,S[1]=Z,I[0]=$,I[1]=Q}class Ap{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const l=function(y){const w=Math.ceil(Math.log2(y.dim/8)),S=[];let I=Math.ceil(Math.pow(2,w));const C=1/I,z=(Z,Q,re,ue,Se)=>{const Le=ue?1:0,Te=(Z+1)*re-Le,Ce=Q*re,Ne=(Q+1)*re-Le;Se[0]=Z*re,Se[1]=Ce,Se[2]=Te,Se[3]=Ne};let N=new wp(I);const $=[];for(let Z=0;Z<I*I;Z++){z(Z%I,Math.floor(Z/I),C,!1,$);const Q=_s($[0],$[1],y),re=_s($[2],$[1],y),ue=_s($[2],$[3],y),Se=_s($[0],$[3],y);N.minimums.push(Math.min(Q,re,ue,Se)),N.maximums.push(Math.max(Q,re,ue,Se)),N.leaves.push(1)}for(S.push(N),I/=2;I>=1;I/=2){const Z=S[S.length-1];N=new wp(I);for(let Q=0;Q<I*I;Q++){z(Q%I,Math.floor(Q/I),2,!0,$);const re=Z.getElevation($[0],$[1]),ue=Z.getElevation($[2],$[1]),Se=Z.getElevation($[2],$[3]),Le=Z.getElevation($[0],$[3]),Te=Z.isLeaf($[0],$[1]),Ce=Z.isLeaf($[2],$[1]),Ne=Z.isLeaf($[2],$[3]),Oe=Z.isLeaf($[0],$[3]),st=Math.min(re.min,ue.min,Se.min,Le.min),rt=Math.max(re.max,ue.max,Se.max,Le.max),mt=Te&&Ce&&Ne&&Oe;N.maximums.push(rt),N.minimums.push(st),N.leaves.push(rt-st<=5&&mt?1:0)}S.push(N)}return S}(this.dem),d=l.length-1,m=l[d];this._addNode(m.minimums[0],m.maximums[0],m.leaves[0]),this._construct(l,0,0,d,0)}raycastRoot(t,l,d,m,y,w,S=1){return Ep([t,l,-100],[d,m,this.maximums[0]*S],y,w)}raycast(t,l,d,m,y,w,S=1){if(!this.nodeCount)return null;const I=this.raycastRoot(t,l,d,m,y,w,S);if(I==null)return null;const C=[],z=[],N=[],$=[],Z=[{idx:0,t:I,nodex:0,nodey:0,depth:0}];for(;Z.length>0;){const{idx:Q,t:re,nodex:ue,nodey:Se,depth:Le}=Z.pop();if(this.leaves[Q]){Mp(ue,Se,Le,t,l,d,m,N,$);const Ce=1<<Le,Ne=(ue+0)/Ce,Oe=(ue+1)/Ce,st=(Se+0)/Ce,rt=(Se+1)/Ce,mt=_s(Ne,st,this.dem)*S,Ft=_s(Oe,st,this.dem)*S,ct=_s(Oe,rt,this.dem)*S,Et=_s(Ne,rt,this.dem)*S,Mt=Tp(N[0],N[1],mt,$[0],N[1],Ft,$[0],$[1],ct,y,w),Lt=Tp($[0],$[1],ct,N[0],$[1],Et,N[0],N[1],mt,y,w),Vt=Math.min(Mt!==null?Mt:Number.MAX_VALUE,Lt!==null?Lt:Number.MAX_VALUE);if(Vt!==Number.MAX_VALUE)return Vt;{const gt=dc([],y,w,re);if(Ip(mt,Ft,Et,ct,Sp(gt[0],N[0],$[0]),Sp(gt[1],N[1],$[1]))>=gt[2])return re}continue}let Te=0;for(let Ce=0;Ce<this._siblingOffset.length;Ce++){Mp((ue<<1)+this._siblingOffset[Ce][0],(Se<<1)+this._siblingOffset[Ce][1],Le+1,t,l,d,m,N,$),N[2]=-100,$[2]=this.maximums[this.childOffsets[Q]+Ce]*S;const Ne=Ep(N,$,y,w);if(Ne!=null){const Oe=Ne;C[Ce]=Oe;let st=!1;for(let rt=0;rt<Te&&!st;rt++)Oe>=C[z[rt]]&&(z.splice(rt,0,Ce),st=!0);st||(z[Te]=Ce),Te++}}for(let Ce=0;Ce<Te;Ce++){const Ne=z[Ce];Z.push({idx:this.childOffsets[Q]+Ne,t:C[Ne],nodex:(ue<<1)+this._siblingOffset[Ne][0],nodey:(Se<<1)+this._siblingOffset[Ne][1],depth:Le+1})}}return null}_addNode(t,l,d){return this.minimums.push(t),this.maximums.push(l),this.leaves.push(d),this.childOffsets.push(0),this.nodeCount++}_construct(t,l,d,m,y){if(t[m].isLeaf(l,d)===1)return;this.childOffsets[y]||(this.childOffsets[y]=this.nodeCount);const w=m-1,S=t[w];let I=0,C=0;for(let z=0;z<this._siblingOffset.length;z++){const N=2*l+this._siblingOffset[z][0],$=2*d+this._siblingOffset[z][1],Z=S.getElevation(N,$),Q=S.isLeaf(N,$),re=this._addNode(Z.min,Z.max,Q);Q&&(I|=1<<z),C||(C=re)}for(let z=0;z<this._siblingOffset.length;z++)I&1<<z||this._construct(t,2*l+this._siblingOffset[z][0],2*d+this._siblingOffset[z][1],w,C+z)}}function Ip(s,t,l,d,m,y){return ur(ur(s,l,y),ur(t,d,y),m)}function _s(s,t,l){const d=l.dim,m=We(s*d-.5,0,d-1),y=We(t*d-.5,0,d-1),w=Math.floor(m),S=Math.floor(y),I=Math.min(w+1,d-1),C=Math.min(S+1,d-1);return Ip(l.get(w,S),l.get(I,S),l.get(w,C),l.get(I,C),m-w,y-S)}const Cp={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class Yu{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,l,d,m=!1,y=!1){if(this.uid=t,l.height!==l.width)throw new RangeError("DEM tiles must be square");if(d&&d!=="mapbox"&&d!=="terrarium")return yi(`"${d}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=l.height;const w=this.dim=l.height-2,S=new Uint32Array(l.data.buffer);if(this.pixels=new Uint8Array(l.data.buffer),this.encoding=d||"mapbox",this.borderReady=m,!m){for(let I=0;I<w;I++)S[this._idx(-1,I)]=S[this._idx(0,I)],S[this._idx(w,I)]=S[this._idx(w-1,I)],S[this._idx(I,-1)]=S[this._idx(I,0)],S[this._idx(I,w)]=S[this._idx(I,w-1)];S[this._idx(-1,-1)]=S[this._idx(0,0)],S[this._idx(w,-1)]=S[this._idx(w-1,0)],S[this._idx(-1,w)]=S[this._idx(0,w-1)],S[this._idx(w,w)]=S[this._idx(w-1,w-1)],y&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new Ap(this)}get(t,l,d=!1){d&&(t=We(t,-1,this.dim),l=We(l,-1,this.dim));const m=4*this._idx(t,l);return(this.encoding==="terrarium"?this._unpackTerrarium:this._unpackMapbox)(this.pixels[m],this.pixels[m+1],this.pixels[m+2])}static getUnpackVector(t){return Cp[t]}get unpackVector(){return Cp[this.encoding]}_idx(t,l){if(t<-1||t>=this.dim+1||l<-1||l>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(l+1)*this.stride+(t+1)}_unpackMapbox(t,l,d){return(256*t*256+256*l+d)/10-1e4}_unpackTerrarium(t,l,d){return 256*t+l+d/256-32768}static pack(t,l){const d=[0,0,0,0],m=Yu.getUnpackVector(l);let y=Math.floor((t+m[3])/m[2]);return d[2]=y%256,y=Math.floor(y/256),d[1]=y%256,y=Math.floor(y/256),d[0]=y,d}getPixels(){return new lo({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,l,d){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let m=l*this.dim,y=l*this.dim+this.dim,w=d*this.dim,S=d*this.dim+this.dim;switch(l){case-1:m=y-1;break;case 1:y=m+1}switch(d){case-1:w=S-1;break;case 1:S=w+1}const I=-l*this.dim,C=-d*this.dim;for(let z=w;z<S;z++)for(let N=m;N<y;N++){const $=4*this._idx(N,z),Z=4*this._idx(N+I,z+C);this.pixels[$+0]=t.pixels[Z+0],this.pixels[$+1]=t.pixels[Z+1],this.pixels[$+2]=t.pixels[Z+2],this.pixels[$+3]=t.pixels[Z+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}_i(Yu,"DEMData"),_i(Ap,"DemMinMaxQuadTree",{omit:["dem"]});class f0{constructor(t,l){this.max=t,this.onRemove=l,this.reset()}reset(){for(const t in this.data)for(const l of this.data[t])l.timeout&&clearTimeout(l.timeout),this.onRemove(l.value);return this.data={},this.order=[],this}add(t,l,d){const m=t.wrapped().key;this.data[m]===void 0&&(this.data[m]=[]);const y={value:l,timeout:void 0};if(d!==void 0&&(y.timeout=setTimeout(()=>{this.remove(t,y)},d)),this.data[m].push(y),this.order.push(m),this.order.length>this.max){const w=this._getAndRemoveByKey(this.order[0]);w&&this.onRemove(w)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const l=this.data[t].shift();return l.timeout&&clearTimeout(l.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),l.value}getByKey(t){const l=this.data[t];return l?l[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,l){if(!this.has(t))return this;const d=t.wrapped().key,m=l===void 0?0:this.data[d].indexOf(l),y=this.data[d][m];return this.data[d].splice(m,1),y.timeout&&clearTimeout(y.timeout),this.data[d].length===0&&delete this.data[d],this.onRemove(y.value),this.order.splice(this.order.indexOf(d),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const l=this._getAndRemoveByKey(this.order[0]);l&&this.onRemove(l)}return this}filter(t){const l=[];for(const d in this.data)for(const m of this.data[d])t(m.value)||l.push(m);for(const d of l)this.remove(d.value.tileID,d)}}class Nl{constructor(t,l,d){this.func=t,this.mask=l,this.range=d}}Nl.ReadOnly=!1,Nl.ReadWrite=!0,Nl.disabled=new Nl(519,Nl.ReadOnly,[0,1]);const Hh=7680;class Wh{constructor(t,l,d,m,y,w){this.test=t,this.ref=l,this.mask=d,this.fail=m,this.depthFail=y,this.pass=w}}Wh.disabled=new Wh({func:519,mask:0},0,0,Hh,Hh,Hh);class Aa{constructor(t,l,d){this.blendFunction=t,this.blendColor=l,this.mask=d}}Aa.Replace=[1,0],Aa.disabled=new Aa(Aa.Replace,Ke.transparent,[!1,!1,!1,!1]),Aa.unblended=new Aa(Aa.Replace,Ke.transparent,[!0,!0,!0,!0]),Aa.alphaBlended=new Aa([1,771],Ke.transparent,[!0,!0,!0,!0]);const Yh=1029,Kh=2305;class ta{constructor(t,l,d){this.enable=t,this.mode=l,this.frontFace=d}}ta.disabled=new ta(!1,Yh,Kh),ta.backCCW=new ta(!0,Yh,Kh),ta.backCW=new ta(!0,Yh,2304),ta.frontCW=new ta(!0,1028,2304),ta.frontCCW=new ta(!0,1028,Kh);class Ws extends sr{constructor(t,l,d){super(),this.id=t,this._onlySymbols=d,l.on("data",m=>{m.dataType==="source"&&m.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&m.dataType==="source"&&m.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),l.on("error",()=>{this._sourceErrored=!0}),this._source=l,this._tiles={},this._cache=new f0(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._loadedParentTiles={},this._coveredTiles={},this._state=new d0,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const l=this._tiles[t];if(l.state!=="loaded"&&l.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,l){return t.isSymbolTile=this._onlySymbols,this._source.loadTile(t,l)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,()=>{})}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t,()=>{})}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const l in this._tiles){const d=this._tiles[l];d.upload(t),d.prepare(this.map.style.imageManager)}}getIds(){return oi(this._tiles).map(t=>t.tileID).sort(kp).map(t=>t.key)}getRenderableIds(t){const l=[];for(const d in this._tiles)this._isIdRenderable(+d,t)&&l.push(this._tiles[d]);return t?l.sort((d,m)=>{const y=d.tileID,w=m.tileID,S=new J(y.canonical.x,y.canonical.y)._rotate(this.transform.angle),I=new J(w.canonical.x,w.canonical.y)._rotate(this.transform.angle);return y.overscaledZ-w.overscaledZ||I.y-S.y||I.x-S.x}).map(d=>d.tileID.key):l.map(d=>d.tileID).sort(kp).map(d=>d.key)}hasRenderableParent(t){const l=this.findLoadedParent(t,0);return!!l&&this._isIdRenderable(l.tileID.key)}_isIdRenderable(t,l){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(l||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,l){const d=this._tiles[t];d&&(d.state!=="loading"&&(d.state=l),this._loadTile(d,this._tileLoaded.bind(this,d,t,l)))}_tileLoaded(t,l,d,m){if(m)if(t.state="errored",m.status!==404)this._source.fire(new dr(m,{tile:t}));else if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const y=this.map.painter.terrain;this.update(this.transform,y.getScaledDemTileSize(),!0),y.resetTileLookupCache(this.id)}else this.update(this.transform);else t.timeAdded=Re.now(),d==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(l,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new fi("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const l=this.getRenderableIds();for(let m=0;m<l.length;m++){const y=l[m];if(t.neighboringTiles&&t.neighboringTiles[y]){const w=this.getTileByID(y);d(t,w),d(w,t)}}function d(m,y){if(!m.dem||m.dem.borderReady)return;m.needsHillshadePrepare=!0,m.needsDEMTextureUpload=!0;let w=y.tileID.canonical.x-m.tileID.canonical.x;const S=y.tileID.canonical.y-m.tileID.canonical.y,I=Math.pow(2,m.tileID.canonical.z),C=y.tileID.key;w===0&&S===0||Math.abs(S)>1||(Math.abs(w)>1&&(Math.abs(w+I)===1?w+=I:Math.abs(w-I)===1&&(w-=I)),y.dem&&m.dem&&(m.dem.backfillBorder(y.dem,w,S),m.neighboringTiles&&m.neighboringTiles[C]&&(m.neighboringTiles[C].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,l,d,m){for(const y in this._tiles){let w=this._tiles[y];if(m[y]||!w.hasData()||w.tileID.overscaledZ<=l||w.tileID.overscaledZ>d)continue;let S=w.tileID;for(;w&&w.tileID.overscaledZ>l+1;){const C=w.tileID.scaledTo(w.tileID.overscaledZ-1);w=this._tiles[C.key],w&&w.hasData()&&(S=C)}let I=S;for(;I.overscaledZ>l;)if(I=I.scaledTo(I.overscaledZ-1),t[I.key]){m[S.key]=S;break}}}findLoadedParent(t,l){if(t.key in this._loadedParentTiles){const d=this._loadedParentTiles[t.key];return d&&d.tileID.overscaledZ>=l?d:null}for(let d=t.overscaledZ-1;d>=l;d--){const m=t.scaledTo(d),y=this._getLoadedTile(m);if(y)return y}}_getLoadedTile(t){const l=this._tiles[t.key];return l&&l.hasData()?l:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,l){l=l||this._source.tileSize;const d=Math.ceil(t.width/l)+1,m=Math.ceil(t.height/l)+1,y=Math.floor(d*m*5),w=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,y):y,S=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,w):w;this._cache.setMaxSize(S)}handleWrapJump(t){const l=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,l){const d={};for(const m in this._tiles){const y=this._tiles[m];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+l),d[y.tileID.key]=y}this._tiles=d;for(const m in this._timers)clearTimeout(this._timers[m]),delete this._timers[m];for(const m in this._tiles)this._setTileReloadTimer(+m,this._tiles[m])}}update(t,l,d){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!d)return;let m;this.updateCacheSize(t,l),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?m=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(S=>new Zn(S.canonical.z,S.wrap,S.canonical.z,S.canonical.x,S.canonical.y)):(m=t.coveringTiles({tileSize:l||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!d,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(m=m.filter(S=>this._source.hasTile(S)))):m=[];const y=this._updateRetainedTiles(m);if(Pp(this._source.type)&&m.length!==0){const S={},I={},C=Object.keys(y);for(const N of C){const $=y[N],Z=this._tiles[N];if(!Z||Z.fadeEndTime&&Z.fadeEndTime<=Re.now())continue;const Q=this.findLoadedParent($,Math.max($.overscaledZ-Ws.maxOverzooming,this._source.minzoom));Q&&(this._addTile(Q.tileID),S[Q.tileID.key]=Q.tileID),I[N]=$}const z=m[m.length-1].overscaledZ;for(const N in this._tiles){const $=this._tiles[N];if(y[N]||!$.hasData())continue;let Z=$.tileID;for(;Z.overscaledZ>z;){Z=Z.scaledTo(Z.overscaledZ-1);const Q=this._tiles[Z.key];if(Q&&Q.hasData()&&I[Z.key]){y[N]=$.tileID;break}}}for(const N in S)y[N]||(this._coveredTiles[N]=!0,y[N]=S[N])}for(const S in y)this._tiles[S].clearFadeHold();const w=function(S,I){const C=[];for(const z in S)z in I||C.push(z);return C}(this._tiles,y);for(const S of w){const I=this._tiles[S];I.hasSymbolBuckets&&!I.holdingForFade()?I.setHoldDuration(this.map._fadeDuration):I.hasSymbolBuckets&&!I.symbolFadeFinished()||this._removeTile(+S)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const l={};if(t.length===0)return l;const d={},m=t.reduce((C,z)=>Math.min(C,z.overscaledZ),1/0),y=t[0].overscaledZ,w=Math.max(y-Ws.maxOverzooming,this._source.minzoom),S=Math.max(y+Ws.maxUnderzooming,this._source.minzoom),I={};for(const C of t){const z=this._addTile(C);l[C.key]=C,z.hasData()||m<this._source.maxzoom&&(I[C.key]=C)}this._retainLoadedChildren(I,m,S,l);for(const C of t){let z=this._tiles[C.key];if(z.hasData())continue;if(C.canonical.z>=this._source.maxzoom){const $=C.children(this._source.maxzoom)[0],Z=this.getTile($);if(Z&&Z.hasData()){l[$.key]=$;continue}}else{const $=C.children(this._source.maxzoom);if(l[$[0].key]&&l[$[1].key]&&l[$[2].key]&&l[$[3].key])continue}let N=z.wasRequested();for(let $=C.overscaledZ-1;$>=w;--$){const Z=C.scaledTo($);if(d[Z.key]||(d[Z.key]=!0,z=this.getTile(Z),!z&&N&&(z=this._addTile(Z)),z&&(l[Z.key]=Z,N=z.wasRequested(),z.hasData())))break}}return l}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const l=[];let d,m=this._tiles[t].tileID;for(;m.overscaledZ>0;){if(m.key in this._loadedParentTiles){d=this._loadedParentTiles[m.key];break}l.push(m.key);const y=m.scaledTo(m.overscaledZ-1);if(d=this._getLoadedTile(y),d)break;m=y}for(const y of l)this._loadedParentTiles[y]=d}}_addTile(t){let l=this._tiles[t.key];if(l)return l;l=this._cache.getAndRemove(t),l&&(this._setTileReloadTimer(t.key,l),l.tileID=t,this._state.initializeTileState(l,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,l)));const d=Boolean(l);if(!d){const m=this.map?this.map.painter:null;l=new Xh(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,m,this._isRaster),this._loadTile(l,this._tileLoaded.bind(this,l,t.key,l.state))}return l?(l.uses++,this._tiles[t.key]=l,d||this._source.fire(new fi("dataloading",{tile:l,coord:l.tileID,dataType:"source"})),l):null}_setTileReloadTimer(t,l){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const d=l.getExpiryTimeout();d&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},d))}_removeTile(t){const l=this._tiles[t];l&&(l.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),l.uses>0||(l.hasData()&&l.state!=="reloading"?this._cache.add(l.tileID,l,l.getExpiryTimeout()):(l.aborted=!0,this._abortTile(l),this._unloadTile(l))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,l,d){const m=[],y=this.transform;if(!y)return m;const w=y.projection.name==="globe",S=xa(y.center.lng);for(const I in this._tiles){const C=this._tiles[I];if(d&&C.clearQueryDebugViz(),C.holdingForFade())continue;let z;if(w){const N=C.tileID.canonical;if(N.z===0){const $=[Math.abs(We(S,...Oc(N,-1))-S),Math.abs(We(S,...Oc(N,1))-S)];z=[0,2*$.indexOf(Math.min(...$))-1]}else{const $=[Math.abs(We(S,...Oc(N,-1))-S),Math.abs(We(S,...Oc(N,0))-S),Math.abs(We(S,...Oc(N,1))-S)];z=[$.indexOf(Math.min(...$))-1]}}else z=[0];for(const N of z){const $=t.containsTile(C,y,l,N);$&&m.push($)}}return m}getVisibleCoordinates(t){const l=this.getRenderableIds(t).map(d=>this._tiles[d].tileID);for(const d of l)d.projMatrix=this.transform.calculateProjMatrix(d.toUnwrapped());return l}hasTransition(){if(this._source.hasTransition())return!0;if(Pp(this._source.type))for(const t in this._tiles){const l=this._tiles[t];if(l.fadeEndTime!==void 0&&l.fadeEndTime>=Re.now())return!0}return!1}setFeatureState(t,l,d){this._state.updateState(t=t||"_geojsonTileLayer",l,d)}removeFeatureState(t,l,d){this._state.removeFeatureState(t=t||"_geojsonTileLayer",l,d)}getFeatureState(t,l){return this._state.getState(t=t||"_geojsonTileLayer",l)}setDependencies(t,l,d){const m=this._tiles[t];m&&m.setDependencies(l,d)}reloadTilesForDependencies(t,l){for(const d in this._tiles)this._tiles[d].hasDependency(t,l)&&this._reloadTile(+d,"reloading");this._cache.filter(d=>!d.hasDependency(t,l))}_preloadTiles(t,l){const d=new Map,m=Array.isArray(t)?t:[t],y=this.map.painter.terrain,w=this.usedForTerrain&&y?y.getScaledDemTileSize():this._source.tileSize;for(const S of m){const I=S.coveringTiles({tileSize:w,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const C of I)d.set(C.key,C);this.usedForTerrain&&S.updateElevation(!1)}$t(Array.from(d.values()),(S,I)=>{const C=new Xh(S,this._source.tileSize*S.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(C,z=>{this._source.type==="raster-dem"&&C.dem&&this._backfillDEM(C),I(z,C)})},l)}}function kp(s,t){const l=Math.abs(2*s.wrap)-+(s.wrap<0),d=Math.abs(2*t.wrap)-+(t.wrap<0);return s.overscaledZ-t.overscaledZ||d-l||t.canonical.y-s.canonical.y||t.canonical.x-s.canonical.x}function Pp(s){return s==="raster"||s==="image"||s==="video"||s==="custom"}function Oc(s,t){const l=1<<s.z;return[s.x/l+t,(s.x+1)/l+t]}Ws.maxOverzooming=10,Ws.maxUnderzooming=3;class Ku{constructor(t,l,d){this._demTile=t,this._dem=this._demTile.dem,this._scale=l,this._offset=d}static create(t,l,d){const m=d||t.findDEMTileFor(l);if(!m||!m.dem)return;const y=m.dem,w=m.tileID,S=1<<l.canonical.z-w.canonical.z;return new Ku(m,m.tileSize/Gi/S,[(l.canonical.x/S-w.canonical.x)*y.dim,(l.canonical.y/S-w.canonical.y)*y.dim])}tileCoordToPixel(t,l){const d=l*this._scale+this._offset[1],m=Math.floor(t*this._scale+this._offset[0]),y=Math.floor(d);return new J(m,y)}getElevationAt(t,l,d,m){const y=t*this._scale+this._offset[0],w=l*this._scale+this._offset[1],S=Math.floor(y),I=Math.floor(w),C=this._dem;return m=!!m,d?ur(ur(C.get(S,I,m),C.get(S,I+1,m),w-I),ur(C.get(S+1,I,m),C.get(S+1,I+1,m),w-I),y-S):C.get(S,I,m)}getElevationAtPixel(t,l,d){return this._dem.get(t,l,!!d)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*Bo(1,t)*this._dem.stride}}class Dp{constructor(t,l){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new ss(Gi,16,0),this.featureIndexArray=new gd,this.promoteId=l}insert(t,l,d,m,y,w=0){const S=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(d,m,y,w);const I=this.grid;for(let C=0;C<l.length;C++){const z=l[C],N=[1/0,1/0,-1/0,-1/0];for(let $=0;$<z.length;$++){const Z=z[$];N[0]=Math.min(N[0],Z.x),N[1]=Math.min(N[1],Z.y),N[2]=Math.max(N[2],Z.x),N[3]=Math.max(N[3],Z.y)}N[0]<Gi&&N[1]<Gi&&N[2]>=0&&N[3]>=0&&I.insert(S,N[0],N[1],N[2],N[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Ah(new Sc(this.rawTileData)).layers,this.sourceLayerCoder=new _p(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,l,d,m){this.loadVTLayers();const y=t.params||{},w=al(y.filter),S=t.tileResult,I=t.transform,C=S.bufferedTilespaceBounds,z=this.grid.query(C.min.x,C.min.y,C.max.x,C.max.y,(Q,re,ue,Se)=>Od(S.bufferedTilespaceGeometry,Q,re,ue,Se));z.sort(p0);let N=null;I.elevation&&z.length>0&&(N=Ku.create(I.elevation,this.tileID));const $={};let Z;for(let Q=0;Q<z.length;Q++){const re=z[Q];if(re===Z)continue;Z=re;const ue=this.featureIndexArray.get(re);let Se=null;this.loadMatchingFeature($,ue,w,y.layers,y.availableImages,l,d,m,(Le,Te,Ce,Ne=0)=>(Se||(Se=$a(Le,this.tileID.canonical,t.tileTransform)),Te.queryIntersectsFeature(S,Le,Ce,Se,this.z,t.transform,t.pixelPosMatrix,N,Ne)))}return $}loadMatchingFeature(t,l,d,m,y,w,S,I,C){const{featureIndex:z,bucketIndex:N,sourceLayerIndex:$,layoutVertexArrayOffset:Z}=l,Q=this.bucketLayerIDs[N];if(m&&!function(Le,Te){for(let Ce=0;Ce<Le.length;Ce++)if(Te.indexOf(Le[Ce])>=0)return!0;return!1}(m,Q))return;const re=this.sourceLayerCoder.decode($),ue=this.vtLayers[re].feature(z);if(d.needGeometry){const Le=Vs(ue,!0);if(!d.filter(new Me(this.tileID.overscaledZ),Le,this.tileID.canonical))return}else if(!d.filter(new Me(this.tileID.overscaledZ),ue))return;const Se=this.getId(ue,re);for(let Le=0;Le<Q.length;Le++){const Te=Q[Le];if(m&&m.indexOf(Te)<0)continue;const Ce=w[Te];if(!Ce)continue;let Ne={};Se!==void 0&&I&&(Ne=I.getState(Ce.sourceLayer||"_geojsonTileLayer",Se));const Oe=je({},S[Te]);Oe.paint=Bp(Oe.paint,Ce.paint,ue,Ne,y),Oe.layout=Bp(Oe.layout,Ce.layout,ue,Ne,y);const st=!C||C(ue,Ce,Ne,Z);if(!st)continue;const rt=new yp(ue,this.z,this.x,this.y,Se);rt.layer=Oe;let mt=t[Te];mt===void 0&&(mt=t[Te]=[]),mt.push({featureIndex:z,feature:rt,intersectionZ:st})}}lookupSymbolFeatures(t,l,d,m,y,w,S,I){const C={};this.loadVTLayers();const z=al(y);for(const N of t)this.loadMatchingFeature(C,{bucketIndex:d,sourceLayerIndex:m,featureIndex:N,layoutVertexArrayOffset:0},z,w,S,I,l);return C}loadFeature(t){const{featureIndex:l,sourceLayerIndex:d}=t;this.loadVTLayers();const m=this.sourceLayerCoder.decode(d),y=this.vtFeatures[m];if(y[l])return y[l];const w=this.vtLayers[m].feature(l);return y[l]=w,w}hasLayer(t){for(const l of this.bucketLayerIDs)for(const d of l)if(t===d)return!0;return!1}getId(t,l){let d=t.id;if(this.promoteId){const m=typeof this.promoteId=="string"?this.promoteId:this.promoteId[l];m!=null&&(d=t.properties[m]),typeof d=="boolean"&&(d=Number(d))}return d}}function Bp(s,t,l,d,m){return pi(s,(y,w)=>{const S=t instanceof bt?t.get(w):null;return S&&S.evaluate?S.evaluate(l,d,m):S})}function p0(s,t){return t-s}_i(Dp,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});class Rp{constructor(t,l){this.width=t,this.height=l,this.nextRow=0,this.image=new ja({width:t,height:l}),this.positions={},this.uploaded=!1}getDash(t,l){const d=this.getKey(t,l);return this.positions[d]}trim(){const t=this.width,l=this.height=At(this.nextRow);this.image.resize({width:t,height:l})}getKey(t,l){return t.join(",")+l}getDashRanges(t,l,d){const m=[];let y=t.length%2==1?-t[t.length-1]*d:0,w=t[0]*d,S=!0;m.push({left:y,right:w,isDash:S,zeroLength:t[0]===0});let I=t[0];for(let C=1;C<t.length;C++){S=!S;const z=t[C];y=I*d,I+=z,w=I*d,m.push({left:y,right:w,isDash:S,zeroLength:z===0})}return m}addRoundDash(t,l,d){const m=l/2;for(let y=-d;y<=d;y++){const w=this.width*(this.nextRow+d+y);let S=0,I=t[S];for(let C=0;C<this.width;C++){C/I.right>1&&(I=t[++S]);const z=Math.abs(C-I.left),N=Math.abs(C-I.right),$=Math.min(z,N);let Z;const Q=y/d*(m+1);if(I.isDash){const re=m-Math.abs(Q);Z=Math.sqrt($*$+re*re)}else Z=m-Math.sqrt($*$+Q*Q);this.image.data[w+C]=Math.max(0,Math.min(255,Z+128))}}}addRegularDash(t,l){for(let I=t.length-1;I>=0;--I){const C=t[I],z=t[I+1];C.zeroLength?t.splice(I,1):z&&z.isDash===C.isDash&&(z.left=C.left,t.splice(I,1))}const d=t[0],m=t[t.length-1];d.isDash===m.isDash&&(d.left=m.left-this.width,m.right=d.right+this.width);const y=this.width*this.nextRow;let w=0,S=t[w];for(let I=0;I<this.width;I++){I/S.right>1&&(S=t[++w]);const C=Math.abs(I-S.left),z=Math.abs(I-S.right),N=Math.min(C,z);this.image.data[y+I]=Math.max(0,Math.min(255,(S.isDash?N:-N)+l+128))}}addDash(t,l){const d=this.getKey(t,l);if(this.positions[d])return this.positions[d];const m=l==="round",y=m?7:0,w=2*y+1;if(this.nextRow+w>this.height)return yi("LineAtlas out of space"),null;t.length===0&&t.push(1);let S=0;for(let z=0;z<t.length;z++)t[z]<0&&(yi("Negative value is found in line dasharray, replacing values with 0"),t[z]=0),S+=t[z];if(S!==0){const z=this.width/S,N=this.getDashRanges(t,this.width,z);m?this.addRoundDash(N,z,y):this.addRegularDash(N,l==="square"?.5*z:0)}const I=this.nextRow+y;this.nextRow+=w;const C={tl:[I,y],br:[S,0]};return this.positions[d]=C,C}}_i(Rp,"LineAtlas");class Lp{constructor(t){const l={},d=[];for(const S in t){const I=t[S],C=l[S]={};for(const z in I.glyphs){const N=I.glyphs[+z];if(!N||N.bitmap.width===0||N.bitmap.height===0)continue;const $=N.metrics.localGlyph?2:1,Z={x:0,y:0,w:N.bitmap.width+2*$,h:N.bitmap.height+2*$};d.push(Z),C[z]=Z}}const{w:m,h:y}=kh(d),w=new ja({width:m||1,height:y||1});for(const S in t){const I=t[S];for(const C in I.glyphs){const z=I.glyphs[+C];if(!z||z.bitmap.width===0||z.bitmap.height===0)continue;const N=l[S][C],$=z.metrics.localGlyph?2:1;ja.copy(z.bitmap,w,{x:0,y:0},{x:N.x+$,y:N.y+$},z.bitmap)}}this.image=w,this.positions=l}}_i(Lp,"GlyphAtlas");class m0{constructor(t){this.tileID=new Zn(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.returnDependencies=!!t.returnDependencies,this.promoteId=t.promoteId,this.enableTerrain=!!t.enableTerrain,this.isSymbolTile=t.isSymbolTile,this.tileTransform=Hs(t.tileID.canonical,t.projection),this.projection=t.projection}parse(t,l,d,m,y){this.status="parsing",this.data=t,this.collisionBoxArray=new th;const w=new _p(Object.keys(t.layers).sort()),S=new Dp(this.tileID,this.promoteId);S.bucketLayerIDs=[];const I={},C=new Rp(256,256),z={featureIndex:S,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:C,availableImages:d},N=l.familiesBySource[this.source];for(const Ne in N){const Oe=t.layers[Ne];if(!Oe)continue;let st=!1,rt=!1;for(const ct of N[Ne])ct[0].type==="symbol"?st=!0:rt=!0;if(this.isSymbolTile===!0&&!st||this.isSymbolTile===!1&&!rt)continue;Oe.version===1&&yi(`Vector tile source "${this.source}" layer "${Ne}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const mt=w.encode(Ne),Ft=[];for(let ct=0;ct<Oe.length;ct++){const Et=Oe.feature(ct),Mt=S.getId(Et,Ne);Ft.push({feature:Et,id:Mt,index:ct,sourceLayerIndex:mt})}for(const ct of N[Ne]){const Et=ct[0];this.isSymbolTile!==void 0&&Et.type==="symbol"!==this.isSymbolTile||Et.minzoom&&this.zoom<Math.floor(Et.minzoom)||Et.maxzoom&&this.zoom>=Et.maxzoom||Et.visibility!=="none"&&(Qh(ct,this.zoom,d),(I[Et.id]=Et.createBucket({index:S.bucketLayerIDs.length,layers:ct,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:mt,sourceID:this.source,enableTerrain:this.enableTerrain,projection:this.projection.spec,availableImages:d})).populate(Ft,z,this.tileID.canonical,this.tileTransform),S.bucketLayerIDs.push(ct.map(Mt=>Mt.id)))}}let $,Z,Q,re;C.trim();const ue={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Se=pi(z.glyphDependencies,Ne=>Object.keys(Ne).map(Number));Object.keys(Se).length?m.send("getGlyphs",{uid:this.uid,stacks:Se},(Ne,Oe)=>{$||($=Ne,Z=Oe,Ce.call(this))},void 0,!1,ue):Z={};const Le=Object.keys(z.iconDependencies);Le.length?m.send("getImages",{icons:Le,source:this.source,tileID:this.tileID,type:"icons"},(Ne,Oe)=>{$||($=Ne,Q=Oe,Ce.call(this))},void 0,!1,ue):Q={};const Te=Object.keys(z.patternDependencies);function Ce(){if($)return y($);if(Z&&Q&&re){const Ne=new Lp(Z),Oe=new Lf(Q,re);for(const st in I){const rt=I[st];rt instanceof ps?(Qh(rt.layers,this.zoom,d),Og(rt,Z,Ne.positions,Q,Oe.iconPositions,this.showCollisionBoxes,d,this.tileID.canonical,this.tileZoom,this.projection)):rt.hasPattern&&(rt instanceof Bu||rt instanceof Iu||rt instanceof bc)&&(Qh(rt.layers,this.zoom,d),rt.addFeatures(z,this.tileID.canonical,Oe.patternPositions,d,this.tileTransform))}this.status="done",y(null,{buckets:oi(I).filter(st=>!st.isEmpty()),featureIndex:S,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ne.image,lineAtlas:C,imageAtlas:Oe,glyphMap:this.returnDependencies?Z:null,iconMap:this.returnDependencies?Q:null,glyphPositions:this.returnDependencies?Ne.positions:null})}}Te.length?m.send("getImages",{icons:Te,source:this.source,tileID:this.tileID,type:"patterns"},(Ne,Oe)=>{$||($=Ne,re=Oe,Ce.call(this))},void 0,!1,ue):re={},Ce.call(this)}}function Qh(s,t,l){const d=new Me(t);for(const m of s)m.recalculate(d,l)}class zp{constructor(t){this.entries={},this.scheduler=t}request(t,l,d,m){const y=this.entries[t]=this.entries[t]||{callbacks:[]};if(y.result){const[w,S]=y.result;return this.scheduler?this.scheduler.add(()=>{m(w,S)},l):m(w,S),()=>{}}return y.callbacks.push(m),y.cancel||(y.cancel=d((w,S)=>{y.result=[w,S];for(const I of y.callbacks)this.scheduler?this.scheduler.add(()=>{I(w,S)},l):I(w,S);setTimeout(()=>delete this.entries[t],3e3)})),()=>{y.result||(y.callbacks=y.callbacks.filter(w=>w!==m),y.callbacks.length||(y.cancel(),delete this.entries[t]))}}}function Op(s,t,l){const d=JSON.stringify(s.request);return s.data&&(this.deduped.entries[d]={result:[null,s.data]}),this.deduped.request(d,{type:"parseTile",isSymbolTile:s.isSymbolTile,zoom:s.tileZoom},m=>{const y=Xi(s.request,(w,S,I,C)=>{w?m(w):S&&m(null,{vectorTile:l?void 0:new Ah(new Sc(S)),rawData:S,cacheControl:I,expires:C})});return()=>{y.cancel(),m()}},t)}o.ARRAY_TYPE=so,o.AUTH_ERR_MSG=gn,o.Aabb=qn,o.Actor=class{constructor(s,t,l){this.target=s,this.parent=t,this.mapId=l,this.callbacks={},this.cancelCallbacks={},Dt(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=kt()?s:b,this.scheduler=new u0}send(s,t,l,d,m=!1,y){const w=Math.round(1e18*Math.random()).toString(36).substring(0,10);l&&(l.metadata=y,this.callbacks[w]=l);const S=zi(this.globalScope)?void 0:[];return this.target.postMessage({id:w,type:s,hasCallback:!!l,targetMapId:d,mustQueue:m,sourceMapId:this.mapId,data:zs(t,S)},S),{cancel:()=>{l&&delete this.callbacks[w],this.target.postMessage({id:w,type:"<cancel>",targetMapId:d,sourceMapId:this.mapId})}}}receive(s){const t=s.data,l=t.id;if(l&&(!t.targetMapId||this.mapId===t.targetMapId))if(t.type==="<cancel>"){const d=this.cancelCallbacks[l];delete this.cancelCallbacks[l],d&&d.cancel()}else if(t.mustQueue||kt()){const d=this.callbacks[l];this.cancelCallbacks[l]=this.scheduler.add(()=>this.processTask(l,t),d&&d.metadata||{type:"message"})}else this.processTask(l,t)}processTask(s,t){if(t.type==="<response>"){const l=this.callbacks[s];delete this.callbacks[s],l&&(t.error?l(ga(t.error)):l(null,ga(t.data)))}else{const l=zi(this.globalScope)?void 0:[],d=t.hasCallback?(y,w)=>{delete this.cancelCallbacks[s],this.target.postMessage({id:s,type:"<response>",sourceMapId:this.mapId,error:y?zs(y):null,data:zs(w,l)},l)}:y=>{},m=ga(t.data);if(this.parent[t.type])this.parent[t.type](t.sourceMapId,m,d);else if(this.parent.getWorkerSource){const y=t.type.split(".");this.parent.getWorkerSource(t.sourceMapId,y[0],m.source)[y[1]](m,d)}else d(new Error(`Could not find function ${t.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},o.CanonicalTileID=Du,o.Color=Ke,o.ColorMode=Aa,o.CullFaceMode=ta,o.DEMData=Yu,o.DataConstantProperty=tt,o.DedupedRequest=zp,o.DepthMode=Nl,o.EXTENT=Gi,o.Elevation=class{isDataAvailableAtPoint(s){const t=this._source();if(this.isUsingMockSource()||!t||s.y<0||s.y>1)return!1;const l=t.getSource().maxzoom,d=1<<l,m=Math.floor(s.x),y=Math.floor((s.x-m)*d),w=Math.floor(s.y*d),S=this.findDEMTileFor(new Zn(l,m,l,y,w));return!(!S||!S.dem)}getAtPointOrZero(s,t=0){return this.getAtPoint(s,t)||0}getAtPoint(s,t,l=!0){if(this.isUsingMockSource())return null;t==null&&(t=null);const d=this._source();if(!d||s.y<0||s.y>1)return t;const m=d.getSource().maxzoom,y=1<<m,w=Math.floor(s.x),S=s.x-w,I=new Zn(m,w,m,Math.floor(S*y),Math.floor(s.y*y)),C=this.findDEMTileFor(I);if(!C||!C.dem)return t;const z=C.dem,N=1<<C.tileID.canonical.z,$=(S*N-C.tileID.canonical.x)*z.dim,Z=(s.y*N-C.tileID.canonical.y)*z.dim,Q=Math.floor($),re=Math.floor(Z);return(l?this.exaggeration():1)*ur(ur(z.get(Q,re),z.get(Q,re+1),Z-re),ur(z.get(Q+1,re),z.get(Q+1,re+1),Z-re),$-Q)}getAtTileOffset(s,t,l){const d=1<<s.canonical.z;return this.getAtPointOrZero(new bl(s.wrap+(s.canonical.x+t/Gi)/d,(s.canonical.y+l/Gi)/d))}getAtTileOffsetFunc(s,t,l,d){return m=>{const y=this.getAtTileOffset(s,m.x,m.y),w=d.upVector(s.canonical,m.x,m.y);return Eo(w,w,y*d.upVectorScale(s.canonical,t,l).metersToTile),w}}getForTilePoints(s,t,l,d){if(this.isUsingMockSource())return!1;const m=Ku.create(this,s,d);return!!m&&(t.forEach(y=>{y[2]=this.exaggeration()*m.getElevationAt(y[0],y[1],l)}),!0)}getMinMaxForTile(s){if(this.isUsingMockSource())return null;const t=this.findDEMTileFor(s);if(!t||!t.dem)return null;const l=t.dem.tree,d=t.tileID,m=1<<s.canonical.z-d.canonical.z;let y=s.canonical.x/m-d.canonical.x,w=s.canonical.y/m-d.canonical.y,S=0;for(let I=0;I<s.canonical.z-d.canonical.z&&!l.leaves[S];I++){y*=2,w*=2;const C=2*Math.floor(w)+Math.floor(y);S=l.childOffsets[S]+C,y%=1,w%=1}return{min:this.exaggeration()*l.minimums[S],max:this.exaggeration()*l.maximums[S]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(s,t,l){throw new Error("Pure virtual method called.")}pointCoordinate(s){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(s){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},o.ErrorEvent=dr,o.EvaluationParameters=Me,o.Event=fi,o.Evented=sr,o.FillExtrusionBucket=bc,o.Frustum=yh,o.FrustumCorners=_h,o.GLOBE_METERS_TO_ECEF=Nh,o.GLOBE_RADIUS=Za,o.GLOBE_SCALE_MATCH_LATITUDE=45,o.GLOBE_ZOOM_THRESHOLD_MAX=6,o.GLOBE_ZOOM_THRESHOLD_MIN=5,o.GlobeSharedBuffers=class{constructor(s){this._createGrid(s),this._createPoles(s)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const s of this._poleSegments)s.destroy();for(const s of this._gridSegments)s.destroy();if(this._wireframeIndexBuffer){this._wireframeIndexBuffer.destroy();for(const s of this._wireframeSegments)s.destroy()}}_createGrid(s){const t=new er,l=new Ln,d=65;for(let m=0;m<d;m++)for(let y=0;y<d;y++)t.emplaceBack(y,m);this._gridSegments=[];for(let m=0,y=0;m<Ll.length;m++){const w=Ll[m];for(let I=0;I<w;I++)for(let C=0;C<64;C++){const z=I*d+C;l.emplaceBack(z+1,z,z+d),l.emplaceBack(z+d,z+d+1,z+1)}const S=64*w*2;this._gridSegments.push(sn.simpleSegment(0,y,(w+1)*d,S)),y+=S}this._gridBuffer=s.createVertexBuffer(t,Ic.members),this._gridIndexBuffer=s.createIndexBuffer(l,!0)}_createPoles(s){const t=new Ln;for(let m=0;m<=Rl;m++)t.emplaceBack(0,m+1,m+2);this._poleIndexBuffer=s.createIndexBuffer(t,!0);const l=new Do,d=new Do;this._poleSegments=[];for(let m=0,y=0;m<5;m++){const w=360/(1<<m);l.emplaceBack(0,-Za,0,.5,0),d.emplaceBack(0,-Za,0,.5,1);for(let S=0;S<=Rl;S++){const I=S/Rl,C=ur(0,w,I),[z,N,$]=zl(Gg,qg,C,Za);l.emplaceBack(z,N,$,I,0),d.emplaceBack(z,N,$,I,1)}this._poleSegments.push(sn.simpleSegment(y,0,66,64)),y+=66}this._poleNorthVertexBuffer=s.createVertexBuffer(l,tp,!1),this._poleSouthVertexBuffer=s.createVertexBuffer(d,tp,!1)}getGridBuffers(s){return[this._gridBuffer,this._gridIndexBuffer,this._gridSegments[s]]}getPoleBuffers(s){return[this._poleNorthVertexBuffer,this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[s]]}getWirefameBuffers(s,t){if(!this._wireframeSegments){const l=new bo,d=Rl,m=d+1;this._wireframeSegments=[];for(let y=0,w=0;y<Ll.length;y++){const S=Ll[y];for(let C=0;C<S;C++)for(let z=0;z<d;z++){const N=C*m+z;l.emplaceBack(N,N+1),l.emplaceBack(N,N+m),l.emplaceBack(N,N+m+1)}const I=S*d*3;this._wireframeSegments.push(sn.simpleSegment(0,w,(S+1)*m,I)),w+=I}this._wireframeIndexBuffer=s.createIndexBuffer(l)}return[this._gridBuffer,this._wireframeIndexBuffer,this._wireframeSegments[t]]}},o.GlyphManager=Dl,o.ImagePosition=Ph,o.LivePerformanceUtils=ut,o.LngLat=_r,o.LngLatBounds=hs,o.LocalGlyphMode=Lh,o.MAX_MERCATOR_LATITUDE=ba,o.MercatorCoordinate=bl,o.ONE_EM=In,o.OverscaledTileID=Zn,o.PerformanceMarkers=Ze,o.Properties=Ht,o.RGBAImage=lo,o.Ray=gh,o.RequestManager=class{constructor(s,t,l){this._transformRequestFn=s,this._customAccessToken=t,this._silenceAuthErrors=!!l,this._createSkuToken()}_createSkuToken(){const s=function(){let t="";for(let l=0;l<10;l++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",oe,t].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=s.token,this._skuTokenExpiresAt=s.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(s,t){return this._transformRequestFn&&this._transformRequestFn(s,t)||{url:s}}normalizeStyleURL(s,t){if(!Er(s))return s;const l=kr(s);return l.path=`/styles/v1${l.path}`,this._makeAPIURL(l,this._customAccessToken||t)}normalizeGlyphsURL(s,t){if(!Er(s))return s;const l=kr(s);return l.path=`/fonts/v1${l.path}`,this._makeAPIURL(l,this._customAccessToken||t)}normalizeSourceURL(s,t,l,d){if(!Er(s))return s;const m=kr(s);return m.path=`/v4/${m.authority}.json`,m.params.push("secure"),l&&m.params.push(`language=${l}`),d&&m.params.push(`worldview=${d}`),this._makeAPIURL(m,this._customAccessToken||t)}normalizeSpriteURL(s,t,l,d){const m=kr(s);return Er(s)?(m.path=`/styles/v1${m.path}/sprite${t}${l}`,this._makeAPIURL(m,this._customAccessToken||d)):(m.path+=`${t}${l}`,ye(m))}normalizeTileURL(s,t,l){if(this._isSkuTokenExpired()&&this._createSkuToken(),s&&!Er(s))return s;const d=kr(s);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${t||l&&d.authority!=="raster"&&l===512?"@2x":""}${L.supported?".webp":"$1"}`),d.authority==="raster"?d.path=`/${P.RASTER_URL_PREFIX}${d.path}`:(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path=`/${P.TILE_URL_VERSION}${d.path}`);const m=this._customAccessToken||function(y){for(const w of y){const S=w.match(/^access_token=(.*)$/);if(S)return S[1]}return null}(d.params)||P.ACCESS_TOKEN;return P.REQUIRE_ACCESS_TOKEN&&m&&this._skuToken&&d.params.push(`sku=${this._skuToken}`),this._makeAPIURL(d,m)}canonicalizeTileURL(s,t){const l=kr(s);if(!l.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!l.path.match(/\.[\w]+$/))return s;let d="mapbox://";l.path.match(/^\/raster\/v1\//)?d+=`raster/${l.path.replace(`/${P.RASTER_URL_PREFIX}/`,"")}`:d+=`tiles/${l.path.replace(`/${P.TILE_URL_VERSION}/`,"")}`;let m=l.params;return t&&(m=m.filter(y=>!y.match(/^access_token=/))),m.length&&(d+=`?${m.join("&")}`),d}canonicalizeTileset(s,t){const l=!!t&&Er(t),d=[];for(const m of s.tiles||[])un(m)?d.push(this.canonicalizeTileURL(m,l)):d.push(m);return d}_makeAPIURL(s,t){const l="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",d=kr(P.API_URL);if(s.protocol=d.protocol,s.authority=d.authority,s.protocol==="http"){const m=s.params.indexOf("secure");m>=0&&s.params.splice(m,1)}if(d.path!=="/"&&(s.path=`${d.path}${s.path}`),!P.REQUIRE_ACCESS_TOKEN)return ye(s);if(t=t||P.ACCESS_TOKEN,!this._silenceAuthErrors){if(!t)throw new Error(`An API access token is required to use Mapbox GL. ${l}`);if(t[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${l}`)}return s.params=s.params.filter(m=>m.indexOf("access_token")===-1),s.params.push(`access_token=${t||""}`),ye(s)}},o.ResourceType=Kt,o.SegmentVector=sn,o.SourceCache=Ws,o.StencilMode=Wh,o.StructArrayLayout1ui2=ac,o.StructArrayLayout2f1f2i16=jn,o.StructArrayLayout2i4=er,o.StructArrayLayout2ui4=bo,o.StructArrayLayout3f12=vo,o.StructArrayLayout3ui6=Ln,o.StructArrayLayout4i8=Sr,o.StructArrayLayout5f20=Do,o.Texture=zc,o.Tile=Xh,o.Transitionable=lt,o.Uniform1f=gu,o.Uniform1i=class extends Na{constructor(s){super(s),this.current=0}set(s,t,l){this.fetchUniformLocation(s,t)&&this.current!==l&&(this.current=l,this.gl.uniform1i(this.location,l))}},o.Uniform2f=class extends Na{constructor(s){super(s),this.current=[0,0]}set(s,t,l){this.fetchUniformLocation(s,t)&&(l[0]===this.current[0]&&l[1]===this.current[1]||(this.current=l,this.gl.uniform2f(this.location,l[0],l[1])))}},o.Uniform3f=class extends Na{constructor(s){super(s),this.current=[0,0,0]}set(s,t,l){this.fetchUniformLocation(s,t)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]||(this.current=l,this.gl.uniform3f(this.location,l[0],l[1],l[2])))}},o.Uniform4f=Sd,o.UniformColor=Md,o.UniformMatrix2f=class extends Na{constructor(s){super(s),this.current=Wp}set(s,t,l){if(this.fetchUniformLocation(s,t)){for(let d=0;d<4;d++)if(l[d]!==this.current[d]){this.current=l,this.gl.uniformMatrix2fv(this.location,!1,l);break}}}},o.UniformMatrix3f=class extends Na{constructor(s){super(s),this.current=Hp}set(s,t,l){if(this.fetchUniformLocation(s,t)){for(let d=0;d<9;d++)if(l[d]!==this.current[d]){this.current=l,this.gl.uniformMatrix3fv(this.location,!1,l);break}}}},o.UniformMatrix4f=class extends Na{constructor(s){super(s),this.current=Xp}set(s,t,l){if(this.fetchUniformLocation(s,t)){if(l[12]!==this.current[12]||l[0]!==this.current[0])return this.current=l,void this.gl.uniformMatrix4fv(this.location,!1,l);for(let d=1;d<16;d++)if(l[d]!==this.current[d]){this.current=l,this.gl.uniformMatrix4fv(this.location,!1,l);break}}}},o.UnwrappedTileID=wf,o.ValidationError=hi,o.VectorTileFeature=ku,o.VectorTileWorkerSource=class extends sr{constructor(s,t,l,d,m){super(),this.actor=s,this.layerIndex=t,this.availableImages=l,this.loadVectorData=m||Op,this.loading={},this.loaded={},this.deduped=new zp(s.scheduler),this.isSpriteLoaded=d,this.scheduler=s.scheduler}loadTile(s,t){const l=s.uid,d=s&&s.request,m=d&&d.collectResourceTiming,y=this.loading[l]=new m0(s);y.abort=this.loadVectorData(s,(w,S)=>{const I=!this.loading[l];if(delete this.loading[l],I||w||!S)return y.status="done",I||(this.loaded[l]=y),t(w);const C=S.rawData,z={};S.expires&&(z.expires=S.expires),S.cacheControl&&(z.cacheControl=S.cacheControl),y.vectorTile=S.vectorTile||new Ah(new Sc(C));const N=()=>{y.parse(y.vectorTile,this.layerIndex,this.availableImages,this.actor,($,Z)=>{if($||!Z)return t($);const Q={};if(m){const re=bi(d);re.length>0&&(Q.resourceTiming=JSON.parse(JSON.stringify(re)))}t(null,je({rawTileData:C.slice(0)},Z,z,Q))})};this.isSpriteLoaded?N():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(N,{type:"parseTile",isSymbolTile:s.isSymbolTile,zoom:s.tileZoom}):N()}),this.loaded=this.loaded||{},this.loaded[l]=y})}reloadTile(s,t){const l=this.loaded,d=s.uid,m=this;if(l&&l[d]){const y=l[d];y.showCollisionBoxes=s.showCollisionBoxes,y.enableTerrain=!!s.enableTerrain,y.projection=s.projection,y.tileTransform=Hs(s.tileID.canonical,s.projection);const w=(S,I)=>{const C=y.reloadCallback;C&&(delete y.reloadCallback,y.parse(y.vectorTile,m.layerIndex,this.availableImages,m.actor,C)),t(S,I)};y.status==="parsing"?y.reloadCallback=w:y.status==="done"&&(y.vectorTile?y.parse(y.vectorTile,this.layerIndex,this.availableImages,this.actor,w):w())}}abortTile(s,t){const l=s.uid,d=this.loading[l];d&&(d.abort&&d.abort(),delete this.loading[l]),t()}removeTile(s,t){const l=this.loaded,d=s.uid;l&&l[d]&&delete l[d],t()}},o.WritingMode=To,o.ZoomHistory=tu,o.add=Va,o.addDynamicAttributes=Xu,o.adjoint=function(s,t){var l=t[0],d=t[1],m=t[2],y=t[3],w=t[4],S=t[5],I=t[6],C=t[7],z=t[8];return s[0]=w*z-S*C,s[1]=m*C-d*z,s[2]=d*S-m*w,s[3]=S*I-y*z,s[4]=l*z-m*I,s[5]=m*y-l*S,s[6]=y*C-w*I,s[7]=d*I-l*C,s[8]=l*w-d*y,s},o.asyncAll=$t,o.bezier=Pe,o.bindAll=Dt,o.boundsAttributes=vp,o.bufferConvexPolygon=function(s,t){const l=[];for(let d=0;d<s.length;d++){const m=ti(d-1,-1,s.length-1),y=ti(d+1,-1,s.length-1),w=s[d],S=s[y],I=s[m].sub(w).unit(),C=S.sub(w).unit(),z=C.angleWithSep(I.x,I.y),N=I.add(C).unit().mult(-1*t/Math.sin(z/2));l.push(w.add(N))}return l},o.cacheEntryPossiblyAdded=function(s){Rt++,Rt>Xt&&(s.getActor().send("enforceCacheSizeLimit",xt),Rt=0)},o.calculateGlobeLabelMatrix=function(s,t){const{x:l,y:d}=s.point,m=sp(l,d,s.worldSize/s._pixelsPerMercatorPixel,0,0);return El(m,m,Vh(Ta(t)))},o.calculateGlobeMatrix=function(s){const{x:t,y:l}=s.point,{lng:d,lat:m}=s._center;return sp(t,l,s.worldSize,d,m)},o.calculateGlobeMercatorMatrix=function(s){const t=s.pixelsPerMeter,l=t/Bo(1,s.center.lat),d=wa(new Float64Array(16));return lc(d,d,[s.point.x,s.point.y,0]),Gs(d,d,[l,l,t]),Float32Array.from(d)},o.circumferenceAtLatitude=nh,o.clamp=We,o.clearTileCache=function(s){if(!Nt())return;const t=b.caches.delete(di);s&&t.catch(s).then(()=>s())},o.clipLine=Xf,o.clone=function(s){var t=new so(16);return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],t[4]=s[4],t[5]=s[5],t[6]=s[6],t[7]=s[7],t[8]=s[8],t[9]=s[9],t[10]=s[10],t[11]=s[11],t[12]=s[12],t[13]=s[13],t[14]=s[14],t[15]=s[15],t},o.clone$1=vi,o.collisionCircleLayout=cg,o.config=P,o.conjugate=function(s,t){return s[0]=-t[0],s[1]=-t[1],s[2]=-t[2],s[3]=t[3],s},o.create=function(){var s=new so(16);return so!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=0,s[12]=0,s[13]=0,s[14]=0),s[0]=1,s[5]=1,s[10]=1,s[15]=1,s},o.create$1=Ud,o.createExpression=za,o.createLayout=Wt,o.createStyleLayer=function(s){return s.type==="custom"?new a0(s):new l0[s.type](s)},o.cross=mh,o.degToRad=ce,o.distance=function(s,t){return Math.hypot(t[0]-s[0],t[1]-s[1],t[2]-s[2])},o.div=function(s,t,l){return s[0]=t[0]/l[0],s[1]=t[1]/l[1],s[2]=t[2]/l[2],s},o.dot=Ro,o.earthRadius=yu,o.ease=Qe,o.easeCubicInOut=Ie,o.ecefToLatLng=function([s,t,l]){const d=Math.hypot(s,t,l),m=Math.atan2(s,l),y=.5*Math.PI-Math.acos(-t/d);return new _r(ee(m),ee(y))},o.emitValidationErrors=ec,o.endsWith=Ct,o.enforceCacheSizeLimit=function(s){Yt(),si&&si.then(t=>{t.keys().then(l=>{for(let d=0;d<l.length-s;d++)t.delete(l[d])})})},o.evaluateSizeForFeature=Ru,o.evaluateSizeForZoom=Il,o.evaluateVariableOffset=Qf,o.evented=be,o.exactEquals=function(s,t){return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]&&s[3]===t[3]},o.exactEquals$1=function(s,t){return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]},o.exported=Re,o.exported$1=L,o.extend=je,o.extend$1=Or,o.fillExtrusionHeightLift=xf,o.filterObject=yt,o.fromMat4=function(s,t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],s},o.fromQuat=function(s,t){var l=t[0],d=t[1],m=t[2],y=t[3],w=l+l,S=d+d,I=m+m,C=l*w,z=d*w,N=d*S,$=m*w,Z=m*S,Q=m*I,re=y*w,ue=y*S,Se=y*I;return s[0]=1-N-Q,s[1]=z+Se,s[2]=$-ue,s[3]=0,s[4]=z-Se,s[5]=1-C-Q,s[6]=Z+re,s[7]=0,s[8]=$+ue,s[9]=Z-re,s[10]=1-C-N,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s},o.fromRotation=function(s,t){var l=Math.sin(t),d=Math.cos(t);return s[0]=d,s[1]=l,s[2]=0,s[3]=-l,s[4]=d,s[5]=0,s[6]=0,s[7]=0,s[8]=1,s},o.fromScaling=Vd,o.furthestTileCorner=function(s){const t=Math.round((s+45+360)%360/90)%4;return he[t]},o.getAABBPointSquareDist=function(s,t,l){let d=0;for(let m=0;m<2;++m){const y=l?l[m]:0;s[m]>y&&(d+=(s[m]-y)*(s[m]-y)),t[m]<y&&(d+=(y-t[m])*(y-t[m]))}return d},o.getAnchorAlignment=Rh,o.getAnchorJustification=Oh,o.getBounds=function(s){let t=1/0,l=1/0,d=-1/0,m=-1/0;for(const y of s)t=Math.min(t,y.x),l=Math.min(l,y.y),d=Math.max(d,y.x),m=Math.max(m,y.y);return{min:new J(t,l),max:new J(d,m)}},o.getColumn=Gt,o.getGridMatrix=function(s,t,l,d){const m=t.getNorth(),y=t.getSouth(),w=t.getWest(),S=t.getEast(),I=1<<s.z,C=S-w,z=m-y,N=C/Rl,$=-z/Ll[l],Z=[0,N,0,$,0,0,m,w,0];if(s.z>0){const Q=180/d;$d(Z,Z,[Q/C+1,0,0,0,Q/z+1,0,-.5*Q/N,.5*Q/$,1])}return Z[2]=I,Z[5]=s.x,Z[8]=s.y,Z},o.getImage=mn,o.getJSON=function(s,t){return Fi(je(s,{type:"json"}),t)},o.getLatitudinalLod=function(s){const t=80.051129;s=We(s,-80.051129,t)/t*90;const l=Math.pow(Math.abs(Math.sin(ce(s))),3);return Math.round(l*(Ll.length-1))},o.getMapSessionAPI=Ge,o.getPerformanceMeasurement=bi,o.getProjection=mp,o.getRTLTextPluginStatus=ge,o.getReferrer=Ii,o.getTilePoint=function(s,{x:t,y:l},d=0){return new J(((t-d)*s.scale-s.x)*Gi,(l*s.scale-s.y)*Gi)},o.getTileVec3=function(s,t,l=0){return Tl(((t.x-l)*s.scale-s.x)*Gi,(t.y*s.scale-s.y)*Gi,Cd(t.z,t.y))},o.getVideo=function(s,t){const l=b.document.createElement("video");l.muted=!0,l.onloadstart=function(){t(null,l)};for(let d=0;d<s.length;d++){const m=b.document.createElement("source");rr(s[d])||(l.crossOrigin="Anonymous"),m.src=s[d],l.appendChild(m)}return{cancel:()=>{}}},o.globeCenterToScreenPoint=function(s){const t=[0,0,0],l=wa(new Float64Array(16));return El(l,s.pixelMatrix,s.globeMatrix),ln(t,t,l),new J(t[0],t[1])},o.globeDenormalizeECEF=Vh,o.globeECEFOrigin=function(s,t){const l=[0,0,0];return ln(l,l,Pc(Ta(t.canonical))),ln(l,l,s),l},o.globeNormalizeECEF=Pc,o.globePixelsToTileUnits=function(s,t){return Gi/(512*Math.pow(2,s))*Vu(Ta(t))},o.globePoleMatrixForTile=function(s,t,l){const d=wa(new Float64Array(16)),m=(t/(1<<s)-.5)*Math.PI*2;return Eu(d,l.globeMatrix,m),Float32Array.from(d)},o.globeTileBounds=Ta,o.globeTiltAtLngLat=lp,o.globeToMercatorTransition=Ol,o.globeUseCustomAntiAliasing=function(s,t,l){const d=Ol(l.zoom),m=s.style.map._antialias,y=!!t.extStandardDerivatives,w=t.extStandardDerivativesForceOff||s.terrain&&s.terrain.exaggeration()>0;return d===0&&!m&&!w&&y},o.identity=wa,o.identity$1=Yd,o.invert=hh,o.isFullscreen=function(){return!!b.document.fullscreenElement||!!b.document.webkitFullscreenElement},o.isLngLatBehindGlobe=function(s,t){return lp(s,t)>Math.PI/2*1.01},o.isMapAuthenticated=function(s){return De.has(s)},o.isMapboxURL=Er,o.isSafariWithAntialiasingBug=function(s){const t=s.navigator?s.navigator.userAgent:null;return!!zi(s)&&t&&(t.match("Version/15.4")||t.match("Version/15.5")||t.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},o.latFromMercatorY=An,o.latLngToECEF=Cc,o.len=dm,o.length=cc,o.length$1=function(s){return Math.hypot(s[0],s[1],s[2],s[3])},o.lngFromMercatorX=wo,o.loadVectorTile=Op,o.makeRequest=Fi,o.mapValue=function(s,t,l,d,m){return We((s-t)/(l-t)*(m-d)+d,d,m)},o.mercatorScale=kd,o.mercatorXfromLng=xa,o.mercatorYfromLat=va,o.mercatorZfromAltitude=Bo,o.mul=um,o.mul$1=hm,o.multiply=El,o.multiply$1=$d,o.multiply$2=qd,o.nextPowerOfTwo=At,o.normalize=Gn,o.normalize$1=fm,o.normalize$2=Hd,o.number=ur,o.ortho=function(s,t,l,d,m,y,w){var S=1/(t-l),I=1/(d-m),C=1/(y-w);return s[0]=-2*S,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*I,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*C,s[11]=0,s[12]=(t+l)*S,s[13]=(m+d)*I,s[14]=(w+y)*C,s[15]=1,s},o.pbf=Sc,o.perspective=function(s,t,l,d,m){var y,w=1/Math.tan(t/2);return s[0]=w/l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=w,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,m!=null&&m!==1/0?(s[10]=(m+d)*(y=1/(d-m)),s[14]=2*m*d*y):(s[10]=-1,s[14]=-2*d),s},o.pick=function(s,t){const l={};for(let d=0;d<t.length;d++){const m=t[d];m in s&&(l[m]=s[m])}return l},o.plugin=ze,o.pointGeometry=J,o.polygonContainsPoint=js,o.polygonIntersectsBox=Od,o.polygonIntersectsPolygon=Bd,o.polygonizeBounds=function(s,t,l=0,d=!0){const m=new J(l,l),y=s.sub(m),w=t.add(m),S=[y,new J(w.x,y.y),w,new J(y.x,w.y)];return d&&S.push(y.clone()),S},o.posAttributes=Ic,o.postMapLoadEvent=pe,o.postPerformanceEvent=ke,o.postTurnstileEvent=H,o.potpack=kh,o.prevPowerOfTwo=function(s){return s<=1?1:Math.pow(2,Math.floor(Math.log(s)/Math.LN2))},o.radToDeg=ee,o.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],o.registerForPluginStateChange=function(s){return s({pluginStatus:fe,pluginURL:ve}),be.on("pluginStateChange",s),s},o.removeAuthState=function(s){De.delete(s)},o.renderColorRamp=vh,o.resample=Pd,o.rotateX=dh,o.rotateX$1=Kd,o.rotateY=Eu,o.rotateY$1=Qd,o.rotateZ=function(s,t,l){var d=Math.sin(l),m=Math.cos(l),y=t[0],w=t[1],S=t[2],I=t[3],C=t[4],z=t[5],N=t[6],$=t[7];return t!==s&&(s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s[0]=y*m+C*d,s[1]=w*m+z*d,s[2]=S*m+N*d,s[3]=I*m+$*d,s[4]=C*m-y*d,s[5]=z*m-w*d,s[6]=N*m-S*d,s[7]=$*m-I*d,s},o.rotateZ$1=function(s,t,l){l*=.5;var d=t[0],m=t[1],y=t[2],w=t[3],S=Math.sin(l),I=Math.cos(l);return s[0]=d*I+m*S,s[1]=m*I-d*S,s[2]=y*I+w*S,s[3]=w*I-y*S,s},o.scale=Gs,o.scale$1=Xd,o.scale$2=Eo,o.scaleAndAdd=dc,o.set=function(s,t,l,d){return s[0]=t,s[1]=l,s[2]=d,s},o.setCacheLimits=function(s,t){xt=s,Xt=t},o.setColumn=function(s,t,l){s[4*t+0]=l[0],s[4*t+1]=l[1],s[4*t+2]=l[2],s[4*t+3]=l[3]},o.setRTLTextPlugin=function(s,t,l=!1){if(fe===G||fe===ie||fe===le)throw new Error("setRTLTextPlugin cannot be called multiple times.");ve=Re.resolveURL(s),fe=G,_e=t,de(),l||Be()},o.smoothstep=Zt,o.spec=it,o.squaredLength=function(s){var t=s[0],l=s[1],d=s[2];return t*t+l*l+d*d},o.storeAuthState=function(s,t){t?De.add(s):De.delete(s)},o.sub=Qo,o.subtract=ph,o.symbolSize=ug,o.tileAABB=function(s,t,l,d,m,y,w,S,I){if(I.name==="globe")return jg(s,t,new Du(l,d,m));const C=Hs({z:l,x:d,y:m},I);return new qn([(y+C.x/C.scale)*t,t*(C.y/C.scale),w],[(y+C.x2/C.scale)*t,t*(C.y2/C.scale),S])},o.tileCornersToBounds=$u,o.tileTransform=Hs,o.transformMat3=function(s,t,l){var d=t[0],m=t[1],y=t[2];return s[0]=d*l[0]+m*l[3]+y*l[6],s[1]=d*l[1]+m*l[4]+y*l[7],s[2]=d*l[2]+m*l[5]+y*l[8],s},o.transformMat4=ln,o.transformMat4$1=qs,o.transformQuat=Zd,o.transitionTileAABBinECEF=np,o.translate=lc,o.transpose=function(s,t){if(s===t){var l=t[1],d=t[2],m=t[5];s[1]=t[3],s[2]=t[6],s[3]=l,s[5]=t[7],s[6]=d,s[7]=m}else s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=t[1],s[4]=t[4],s[5]=t[7],s[6]=t[2],s[7]=t[5],s[8]=t[8];return s},o.triggerPluginCompletionEvent=me,o.uniqueId=Bt,o.updateGlobeVertexNormal=function(s,t,l,d,m){const y=5*t+2;s.float32[y+0]=l,s.float32[y+1]=d,s.float32[y+2]=m},o.validateCustomStyleLayer=function(s){const t=[],l=s.id;return l===void 0&&t.push({message:`layers.${l}: missing required property "id"`}),s.render===void 0&&t.push({message:`layers.${l}: missing required method "render"`}),s.renderingMode&&s.renderingMode!=="2d"&&s.renderingMode!=="3d"&&t.push({message:`layers.${l}: property "renderingMode" must be either "2d" or "3d"`}),t},o.validateFilter=s=>Wo(Rs(s)),o.validateFog=s=>Wo(Kc(s)),o.validateLayer=s=>Wo(Yl(s)),o.validateLight=s=>Wo(Ls(s)),o.validateSource=s=>Wo(dl(s)),o.validateStyle=Qc,o.validateTerrain=s=>Wo(Kl(s)),o.values=oi,o.vectorTile=Cu,o.version=E,o.warnOnce=yi,o.window=b,o.wrap=ti}),f(["./shared"],function(o){function b(ne){if(typeof ne=="number"||typeof ne=="boolean"||typeof ne=="string"||ne==null)return JSON.stringify(ne);if(Array.isArray(ne)){let te="[";for(const pe of ne)te+=`${b(pe)},`;return`${te}]`}let H="{";for(const te of Object.keys(ne).sort())H+=`${te}:${b(ne[te])},`;return`${H}}`}function E(ne){let H="";for(const te of o.refProperties)H+=`/${b(ne[te])}`;return H}class M{constructor(H){this.keyCache={},H&&this.replace(H)}replace(H){this._layerConfigs={},this._layers={},this.update(H,[])}update(H,te){for(const we of H)this._layerConfigs[we.id]=we,(this._layers[we.id]=o.createStyleLayer(we)).compileFilter(),this.keyCache[we.id]&&delete this.keyCache[we.id];for(const we of te)delete this.keyCache[we],delete this._layerConfigs[we],delete this._layers[we];this.familiesBySource={};const pe=function(we,ke){const $e={};for(let De=0;De<we.length;De++){const Ze=ke&&ke[we[De].id]||E(we[De]);ke&&(ke[we[De].id]=Ze);let ut=$e[Ze];ut||(ut=$e[Ze]=[]),ut.push(we[De])}const Ge=[];for(const De in $e)Ge.push($e[De]);return Ge}(o.values(this._layerConfigs),this.keyCache);for(const we of pe){const ke=we.map(Ut=>this._layers[Ut.id]),$e=ke[0];if($e.visibility==="none")continue;const Ge=$e.source||"";let De=this.familiesBySource[Ge];De||(De=this.familiesBySource[Ge]={});const Ze=$e.sourceLayer||"_geojsonTileLayer";let ut=De[Ze];ut||(ut=De[Ze]=[]),ut.push(ke)}}}class P{loadTile(H,te){const{uid:pe,encoding:we,rawImageData:ke,padding:$e,buildQuadTree:Ge}=H,De=o.window.ImageBitmap&&ke instanceof o.window.ImageBitmap?this.getImageData(ke,$e):ke;te(null,new o.DEMData(pe,De,we,$e<1,Ge))}getImageData(H,te){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(H.width,H.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=H.width,this.offscreenCanvas.height=H.height,this.offscreenCanvasContext.drawImage(H,0,0,H.width,H.height);const pe=this.offscreenCanvasContext.getImageData(-te,-te,H.width+2*te,H.height+2*te);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),pe}}var L=function ne(H,te){var pe,we=H&&H.type;if(we==="FeatureCollection")for(pe=0;pe<H.features.length;pe++)ne(H.features[pe],te);else if(we==="GeometryCollection")for(pe=0;pe<H.geometries.length;pe++)ne(H.geometries[pe],te);else if(we==="Feature")ne(H.geometry,te);else if(we==="Polygon")D(H.coordinates,te);else if(we==="MultiPolygon")for(pe=0;pe<H.coordinates.length;pe++)D(H.coordinates[pe],te);return H};function D(ne,H){if(ne.length!==0){U(ne[0],H);for(var te=1;te<ne.length;te++)U(ne[te],!H)}}function U(ne,H){for(var te=0,pe=0,we=0,ke=ne.length,$e=ke-1;we<ke;$e=we++){var Ge=(ne[we][0]-ne[$e][0])*(ne[$e][1]+ne[we][1]),De=te+Ge;pe+=Math.abs(te)>=Math.abs(Ge)?te-De+Ge:Ge-De+te,te=De}te+pe>=0!=!!H&&ne.reverse()}const X=o.VectorTileFeature.prototype.toGeoJSON;class K{constructor(H){this._feature=H,this.extent=o.EXTENT,this.type=H.type,this.properties=H.tags,"id"in H&&!isNaN(H.id)&&(this.id=parseInt(H.id,10))}loadGeometry(){if(this._feature.type===1){const H=[];for(const te of this._feature.geometry)H.push([new o.pointGeometry(te[0],te[1])]);return H}{const H=[];for(const te of this._feature.geometry){const pe=[];for(const we of te)pe.push(new o.pointGeometry(we[0],we[1]));H.push(pe)}return H}}toGeoJSON(H,te,pe){return X.call(this,H,te,pe)}}class q{constructor(H){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=o.EXTENT,this.length=H.length,this._features=H}feature(H){return new K(this._features[H])}}var oe={exports:{}},W=o.pointGeometry,Y=o.vectorTile.VectorTileFeature,J=Ee;function Ee(ne,H){this.options=H||{},this.features=ne,this.length=ne.length}function xe(ne,H){this.id=typeof ne.id=="number"?ne.id:void 0,this.type=ne.type,this.rawGeometry=ne.type===1?[ne.geometry]:ne.geometry,this.properties=ne.tags,this.extent=H||4096}Ee.prototype.feature=function(ne){return new xe(this.features[ne],this.options.extent)},xe.prototype.loadGeometry=function(){var ne=this.rawGeometry;this.geometry=[];for(var H=0;H<ne.length;H++){for(var te=ne[H],pe=[],we=0;we<te.length;we++)pe.push(new W(te[we][0],te[we][1]));this.geometry.push(pe)}return this.geometry},xe.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var ne=this.geometry,H=1/0,te=-1/0,pe=1/0,we=-1/0,ke=0;ke<ne.length;ke++)for(var $e=ne[ke],Ge=0;Ge<$e.length;Ge++){var De=$e[Ge];H=Math.min(H,De.x),te=Math.max(te,De.x),pe=Math.min(pe,De.y),we=Math.max(we,De.y)}return[H,pe,te,we]},xe.prototype.toGeoJSON=Y.prototype.toGeoJSON;var se=o.pbf,ce=J;function ee(ne){var H=new se;return function(te,pe){for(var we in te.layers)pe.writeMessage(3,he,te.layers[we])}(ne,H),H.finish()}function he(ne,H){var te;H.writeVarintField(15,ne.version||1),H.writeStringField(1,ne.name||""),H.writeVarintField(5,ne.extent||4096);var pe={keys:[],values:[],keycache:{},valuecache:{}};for(te=0;te<ne.length;te++)pe.feature=ne.feature(te),H.writeMessage(2,Ie,pe);var we=pe.keys;for(te=0;te<we.length;te++)H.writeStringField(3,we[te]);var ke=pe.values;for(te=0;te<ke.length;te++)H.writeMessage(4,ti,ke[te])}function Ie(ne,H){var te=ne.feature;te.id!==void 0&&H.writeVarintField(1,te.id),H.writeMessage(2,Pe,ne),H.writeVarintField(3,te.type),H.writeMessage(4,Zt,te)}function Pe(ne,H){var te=ne.feature,pe=ne.keys,we=ne.values,ke=ne.keycache,$e=ne.valuecache;for(var Ge in te.properties){var De=te.properties[Ge],Ze=ke[Ge];if(De!==null){Ze===void 0&&(pe.push(Ge),ke[Ge]=Ze=pe.length-1),H.writeVarint(Ze);var ut=typeof De;ut!=="string"&&ut!=="boolean"&&ut!=="number"&&(De=JSON.stringify(De));var Ut=ut+":"+De,ft=$e[Ut];ft===void 0&&(we.push(De),$e[Ut]=ft=we.length-1),H.writeVarint(ft)}}}function Qe(ne,H){return(H<<3)+(7&ne)}function We(ne){return ne<<1^ne>>31}function Zt(ne,H){for(var te=ne.loadGeometry(),pe=ne.type,we=0,ke=0,$e=te.length,Ge=0;Ge<$e;Ge++){var De=te[Ge],Ze=1;pe===1&&(Ze=De.length),H.writeVarint(Qe(1,Ze));for(var ut=pe===3?De.length-1:De.length,Ut=0;Ut<ut;Ut++){Ut===1&&pe!==1&&H.writeVarint(Qe(2,ut-1));var ft=De[Ut].x-we,bi=De[Ut].y-ke;H.writeVarint(We(ft)),H.writeVarint(We(bi)),we+=ft,ke+=bi}pe===3&&H.writeVarint(Qe(7,1))}}function ti(ne,H){var te=typeof ne;te==="string"?H.writeStringField(1,ne):te==="boolean"?H.writeBooleanField(7,ne):te==="number"&&(ne%1!=0?H.writeDoubleField(3,ne):ne<0?H.writeSVarintField(6,ne):H.writeVarintField(5,ne))}function $t(ne,H,te,pe,we,ke){if(we-pe<=te)return;const $e=pe+we>>1;oi(ne,H,$e,pe,we,ke%2),$t(ne,H,te,pe,$e-1,ke+1),$t(ne,H,te,$e+1,we,ke+1)}function oi(ne,H,te,pe,we,ke){for(;we>pe;){if(we-pe>600){const Ze=we-pe+1,ut=te-pe+1,Ut=Math.log(Ze),ft=.5*Math.exp(2*Ut/3),bi=.5*Math.sqrt(Ut*ft*(Ze-ft)/Ze)*(ut-Ze/2<0?-1:1);oi(ne,H,te,Math.max(pe,Math.floor(te-ut*ft/Ze+bi)),Math.min(we,Math.floor(te+(Ze-ut)*ft/Ze+bi)),ke)}const $e=H[2*te+ke];let Ge=pe,De=we;for(je(ne,H,pe,te),H[2*we+ke]>$e&&je(ne,H,pe,we);Ge<De;){for(je(ne,H,Ge,De),Ge++,De--;H[2*Ge+ke]<$e;)Ge++;for(;H[2*De+ke]>$e;)De--}H[2*pe+ke]===$e?je(ne,H,pe,De):(De++,je(ne,H,De,we)),De<=te&&(pe=De+1),te<=De&&(we=De-1)}}function je(ne,H,te,pe){_t(ne,te,pe),_t(H,2*te,2*pe),_t(H,2*te+1,2*pe+1)}function _t(ne,H,te){const pe=ne[H];ne[H]=ne[te],ne[te]=pe}function Bt(ne,H,te,pe){const we=ne-te,ke=H-pe;return we*we+ke*ke}oe.exports=ee,oe.exports.fromVectorTileJs=ee,oe.exports.fromGeojsonVt=function(ne,H){H=H||{};var te={};for(var pe in ne)te[pe]=new ce(ne[pe].features,H),te[pe].name=pe,te[pe].version=H.version,te[pe].extent=H.extent;return ee({layers:te})},oe.exports.GeoJSONWrapper=ce;const dt=ne=>ne[0],At=ne=>ne[1];class Tt{constructor(H,te=dt,pe=At,we=64,ke=Float64Array){this.nodeSize=we,this.points=H;const $e=H.length<65536?Uint16Array:Uint32Array,Ge=this.ids=new $e(H.length),De=this.coords=new ke(2*H.length);for(let Ze=0;Ze<H.length;Ze++)Ge[Ze]=Ze,De[2*Ze]=te(H[Ze]),De[2*Ze+1]=pe(H[Ze]);$t(Ge,De,we,0,Ge.length-1,0)}range(H,te,pe,we){return function(ke,$e,Ge,De,Ze,ut,Ut){const ft=[0,ke.length-1,0],bi=[];let wi,gi;for(;ft.length;){const Di=ft.pop(),Hi=ft.pop(),Re=ft.pop();if(Hi-Re<=Ut){for(let fi=Re;fi<=Hi;fi++)wi=$e[2*fi],gi=$e[2*fi+1],wi>=Ge&&wi<=Ze&&gi>=De&&gi<=ut&&bi.push(ke[fi]);continue}const vt=Math.floor((Re+Hi)/2);wi=$e[2*vt],gi=$e[2*vt+1],wi>=Ge&&wi<=Ze&&gi>=De&&gi<=ut&&bi.push(ke[vt]);const Pt=(Di+1)%2;(Di===0?Ge<=wi:De<=gi)&&(ft.push(Re),ft.push(vt-1),ft.push(Pt)),(Di===0?Ze>=wi:ut>=gi)&&(ft.push(vt+1),ft.push(Hi),ft.push(Pt))}return bi}(this.ids,this.coords,H,te,pe,we,this.nodeSize)}within(H,te,pe){return function(we,ke,$e,Ge,De,Ze){const ut=[0,we.length-1,0],Ut=[],ft=De*De;for(;ut.length;){const bi=ut.pop(),wi=ut.pop(),gi=ut.pop();if(wi-gi<=Ze){for(let Pt=gi;Pt<=wi;Pt++)Bt(ke[2*Pt],ke[2*Pt+1],$e,Ge)<=ft&&Ut.push(we[Pt]);continue}const Di=Math.floor((gi+wi)/2),Hi=ke[2*Di],Re=ke[2*Di+1];Bt(Hi,Re,$e,Ge)<=ft&&Ut.push(we[Di]);const vt=(bi+1)%2;(bi===0?$e-De<=Hi:Ge-De<=Re)&&(ut.push(gi),ut.push(Di-1),ut.push(vt)),(bi===0?$e+De>=Hi:Ge+De>=Re)&&(ut.push(Di+1),ut.push(wi),ut.push(vt))}return Ut}(this.ids,this.coords,H,te,pe,this.nodeSize)}}const Dt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ne=>ne},Ct=Math.fround||(pi=new Float32Array(1),ne=>(pi[0]=+ne,pi[0]));var pi;class yt{constructor(H){this.options=Pi(Object.create(Dt),H),this.trees=new Array(this.options.maxZoom+1)}load(H){const{log:te,minZoom:pe,maxZoom:we,nodeSize:ke}=this.options;te&&console.time("total time");const $e=`prepare ${H.length} points`;te&&console.time($e),this.points=H;let Ge=[];for(let De=0;De<H.length;De++)H[De].geometry&&Ge.push($i(H[De],De));this.trees[we+1]=new Tt(Ge,zi,ht,ke,Float32Array),te&&console.timeEnd($e);for(let De=we;De>=pe;De--){const Ze=+Date.now();Ge=this._cluster(Ge,De),this.trees[De]=new Tt(Ge,zi,ht,ke,Float32Array),te&&console.log("z%d: %d clusters in %dms",De,Ge.length,+Date.now()-Ze)}return te&&console.timeEnd("total time"),this}getClusters(H,te){let pe=((H[0]+180)%360+360)%360-180;const we=Math.max(-90,Math.min(90,H[1]));let ke=H[2]===180?180:((H[2]+180)%360+360)%360-180;const $e=Math.max(-90,Math.min(90,H[3]));if(H[2]-H[0]>=360)pe=-180,ke=180;else if(pe>ke){const ut=this.getClusters([pe,we,180,$e],te),Ut=this.getClusters([-180,we,ke,$e],te);return ut.concat(Ut)}const Ge=this.trees[this._limitZoom(te)],De=Ge.range(It(pe),kt($e),It(ke),kt(we)),Ze=[];for(const ut of De){const Ut=Ge.points[ut];Ze.push(Ut.numPoints?yi(Ut):this.points[Ut.index])}return Ze}getChildren(H){const te=this._getOriginId(H),pe=this._getOriginZoom(H),we="No cluster with the specified id.",ke=this.trees[pe];if(!ke)throw new Error(we);const $e=ke.points[te];if(!$e)throw new Error(we);const Ge=this.options.radius/(this.options.extent*Math.pow(2,pe-1)),De=ke.within($e.x,$e.y,Ge),Ze=[];for(const ut of De){const Ut=ke.points[ut];Ut.parentId===H&&Ze.push(Ut.numPoints?yi(Ut):this.points[Ut.index])}if(Ze.length===0)throw new Error(we);return Ze}getLeaves(H,te,pe){const we=[];return this._appendLeaves(we,H,te=te||10,pe=pe||0,0),we}getTile(H,te,pe){const we=this.trees[this._limitZoom(H)],ke=Math.pow(2,H),{extent:$e,radius:Ge}=this.options,De=Ge/$e,Ze=(pe-De)/ke,ut=(pe+1+De)/ke,Ut={features:[]};return this._addTileFeatures(we.range((te-De)/ke,Ze,(te+1+De)/ke,ut),we.points,te,pe,ke,Ut),te===0&&this._addTileFeatures(we.range(1-De/ke,Ze,1,ut),we.points,ke,pe,ke,Ut),te===ke-1&&this._addTileFeatures(we.range(0,Ze,De/ke,ut),we.points,-1,pe,ke,Ut),Ut.features.length?Ut:null}getClusterExpansionZoom(H){let te=this._getOriginZoom(H)-1;for(;te<=this.options.maxZoom;){const pe=this.getChildren(H);if(te++,pe.length!==1)break;H=pe[0].properties.cluster_id}return te}_appendLeaves(H,te,pe,we,ke){const $e=this.getChildren(te);for(const Ge of $e){const De=Ge.properties;if(De&&De.cluster?ke+De.point_count<=we?ke+=De.point_count:ke=this._appendLeaves(H,De.cluster_id,pe,we,ke):ke<we?ke++:H.push(Ge),H.length===pe)break}return ke}_addTileFeatures(H,te,pe,we,ke,$e){for(const Ge of H){const De=te[Ge],Ze=De.numPoints;let ut,Ut,ft;if(Ze)ut=mi(De),Ut=De.x,ft=De.y;else{const gi=this.points[De.index];ut=gi.properties,Ut=It(gi.geometry.coordinates[0]),ft=kt(gi.geometry.coordinates[1])}const bi={type:1,geometry:[[Math.round(this.options.extent*(Ut*ke-pe)),Math.round(this.options.extent*(ft*ke-we))]],tags:ut};let wi;Ze?wi=De.id:this.options.generateId?wi=De.index:this.points[De.index].id&&(wi=this.points[De.index].id),wi!==void 0&&(bi.id=wi),$e.features.push(bi)}}_limitZoom(H){return Math.max(this.options.minZoom,Math.min(Math.floor(+H),this.options.maxZoom+1))}_cluster(H,te){const pe=[],{radius:we,extent:ke,reduce:$e,minPoints:Ge}=this.options,De=we/(ke*Math.pow(2,te));for(let Ze=0;Ze<H.length;Ze++){const ut=H[Ze];if(ut.zoom<=te)continue;ut.zoom=te;const Ut=this.trees[te+1],ft=Ut.within(ut.x,ut.y,De),bi=ut.numPoints||1;let wi=bi;for(const gi of ft){const Di=Ut.points[gi];Di.zoom>te&&(wi+=Di.numPoints||1)}if(wi>bi&&wi>=Ge){let gi=ut.x*bi,Di=ut.y*bi,Hi=$e&&bi>1?this._map(ut,!0):null;const Re=(Ze<<5)+(te+1)+this.points.length;for(const vt of ft){const Pt=Ut.points[vt];if(Pt.zoom<=te)continue;Pt.zoom=te;const fi=Pt.numPoints||1;gi+=Pt.x*fi,Di+=Pt.y*fi,Pt.parentId=Re,$e&&(Hi||(Hi=this._map(ut,!0)),$e(Hi,this._map(Pt)))}ut.parentId=Re,pe.push(vi(gi/wi,Di/wi,Re,wi,Hi))}else if(pe.push(ut),wi>1)for(const gi of ft){const Di=Ut.points[gi];Di.zoom<=te||(Di.zoom=te,pe.push(Di))}}return pe}_getOriginId(H){return H-this.points.length>>5}_getOriginZoom(H){return(H-this.points.length)%32}_map(H,te){if(H.numPoints)return te?Pi({},H.properties):H.properties;const pe=this.points[H.index].properties,we=this.options.map(pe);return te&&we===pe?Pi({},we):we}}function vi(ne,H,te,pe,we){return{x:Ct(ne),y:Ct(H),zoom:1/0,id:te,parentId:-1,numPoints:pe,properties:we}}function $i(ne,H){const[te,pe]=ne.geometry.coordinates;return{x:Ct(It(te)),y:Ct(kt(pe)),zoom:1/0,index:H,parentId:-1}}function yi(ne){return{type:"Feature",id:ne.id,properties:mi(ne),geometry:{type:"Point",coordinates:[(H=ne.x,360*(H-.5)),Ri(ne.y)]}};var H}function mi(ne){const H=ne.numPoints,te=H>=1e4?`${Math.round(H/1e3)}k`:H>=1e3?Math.round(H/100)/10+"k":H;return Pi(Pi({},ne.properties),{cluster:!0,cluster_id:ne.id,point_count:H,point_count_abbreviated:te})}function It(ne){return ne/360+.5}function kt(ne){const H=Math.sin(ne*Math.PI/180),te=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return te<0?0:te>1?1:te}function Ri(ne){const H=(180-360*ne)*Math.PI/180;return 360*Math.atan(Math.exp(H))/Math.PI-90}function Pi(ne,H){for(const te in H)ne[te]=H[te];return ne}function zi(ne){return ne.x}function ht(ne){return ne.y}function Gt(ne,H,te,pe){for(var we,ke=pe,$e=te-H>>1,Ge=te-H,De=ne[H],Ze=ne[H+1],ut=ne[te],Ut=ne[te+1],ft=H+3;ft<te;ft+=3){var bi=di(ne[ft],ne[ft+1],De,Ze,ut,Ut);if(bi>ke)we=ft,ke=bi;else if(bi===ke){var wi=Math.abs(ft-$e);wi<Ge&&(we=ft,Ge=wi)}}ke>pe&&(we-H>3&&Gt(ne,H,we,pe),ne[we+2]=ke,te-we>3&&Gt(ne,we,te,pe))}function di(ne,H,te,pe,we,ke){var $e=we-te,Ge=ke-pe;if($e!==0||Ge!==0){var De=((ne-te)*$e+(H-pe)*Ge)/($e*$e+Ge*Ge);De>1?(te=we,pe=ke):De>0&&(te+=$e*De,pe+=Ge*De)}return($e=ne-te)*$e+(Ge=H-pe)*Ge}function si(ne,H,te,pe){var we={id:ne===void 0?null:ne,type:H,geometry:te,tags:pe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(ke){var $e=ke.geometry,Ge=ke.type;if(Ge==="Point"||Ge==="MultiPoint"||Ge==="LineString")Ae(ke,$e);else if(Ge==="Polygon"||Ge==="MultiLineString")for(var De=0;De<$e.length;De++)Ae(ke,$e[De]);else if(Ge==="MultiPolygon")for(De=0;De<$e.length;De++)for(var Ze=0;Ze<$e[De].length;Ze++)Ae(ke,$e[De][Ze])}(we),we}function Ae(ne,H){for(var te=0;te<H.length;te+=3)ne.minX=Math.min(ne.minX,H[te]),ne.minY=Math.min(ne.minY,H[te+1]),ne.maxX=Math.max(ne.maxX,H[te]),ne.maxY=Math.max(ne.maxY,H[te+1])}function xt(ne,H,te,pe){if(H.geometry){var we=H.geometry.coordinates,ke=H.geometry.type,$e=Math.pow(te.tolerance/((1<<te.maxZoom)*te.extent),2),Ge=[],De=H.id;if(te.promoteId?De=H.properties[te.promoteId]:te.generateId&&(De=pe||0),ke==="Point")Xt(we,Ge);else if(ke==="MultiPoint")for(var Ze=0;Ze<we.length;Ze++)Xt(we[Ze],Ge);else if(ke==="LineString")Nt(we,Ge,$e,!1);else if(ke==="MultiLineString"){if(te.lineMetrics){for(Ze=0;Ze<we.length;Ze++)Nt(we[Ze],Ge=[],$e,!1),ne.push(si(De,"LineString",Ge,H.properties));return}Yt(we,Ge,$e,!1)}else if(ke==="Polygon")Yt(we,Ge,$e,!0);else{if(ke!=="MultiPolygon"){if(ke==="GeometryCollection"){for(Ze=0;Ze<H.geometry.geometries.length;Ze++)xt(ne,{id:De,geometry:H.geometry.geometries[Ze],properties:H.properties},te,pe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Ze=0;Ze<we.length;Ze++){var ut=[];Yt(we[Ze],ut,$e,!0),Ge.push(ut)}}ne.push(si(De,ke,Ge,H.properties))}}function Xt(ne,H){H.push(ii(ne[0])),H.push(Rt(ne[1])),H.push(0)}function Nt(ne,H,te,pe){for(var we,ke,$e=0,Ge=0;Ge<ne.length;Ge++){var De=ii(ne[Ge][0]),Ze=Rt(ne[Ge][1]);H.push(De),H.push(Ze),H.push(0),Ge>0&&($e+=pe?(we*Ze-De*ke)/2:Math.sqrt(Math.pow(De-we,2)+Math.pow(Ze-ke,2))),we=De,ke=Ze}var ut=H.length-3;H[2]=1,Gt(H,0,ut,te),H[ut+2]=1,H.size=Math.abs($e),H.start=0,H.end=H.size}function Yt(ne,H,te,pe){for(var we=0;we<ne.length;we++){var ke=[];Nt(ne[we],ke,te,pe),H.push(ke)}}function ii(ne){return ne/360+.5}function Rt(ne){var H=Math.sin(ne*Math.PI/180),te=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return te<0?0:te>1?1:te}function Kt(ne,H,te,pe,we,ke,$e,Ge){if(pe/=H,ke>=(te/=H)&&$e<pe)return ne;if($e<te||ke>=pe)return null;for(var De=[],Ze=0;Ze<ne.length;Ze++){var ut=ne[Ze],Ut=ut.geometry,ft=ut.type,bi=we===0?ut.minX:ut.minY,wi=we===0?ut.maxX:ut.maxY;if(bi>=te&&wi<pe)De.push(ut);else if(!(wi<te||bi>=pe)){var gi=[];if(ft==="Point"||ft==="MultiPoint")Li(Ut,gi,te,pe,we);else if(ft==="LineString")Ii(Ut,gi,te,pe,we,!1,Ge.lineMetrics);else if(ft==="MultiLineString")Xi(Ut,gi,te,pe,we,!1);else if(ft==="Polygon")Xi(Ut,gi,te,pe,we,!0);else if(ft==="MultiPolygon")for(var Di=0;Di<Ut.length;Di++){var Hi=[];Xi(Ut[Di],Hi,te,pe,we,!0),Hi.length&&gi.push(Hi)}if(gi.length){if(Ge.lineMetrics&&ft==="LineString"){for(Di=0;Di<gi.length;Di++)De.push(si(ut.id,ft,gi[Di],ut.tags));continue}ft!=="LineString"&&ft!=="MultiLineString"||(gi.length===1?(ft="LineString",gi=gi[0]):ft="MultiLineString"),ft!=="Point"&&ft!=="MultiPoint"||(ft=gi.length===3?"Point":"MultiPoint"),De.push(si(ut.id,ft,gi,ut.tags))}}}return De.length?De:null}function Li(ne,H,te,pe,we){for(var ke=0;ke<ne.length;ke+=3){var $e=ne[ke+we];$e>=te&&$e<=pe&&(H.push(ne[ke]),H.push(ne[ke+1]),H.push(ne[ke+2]))}}function Ii(ne,H,te,pe,we,ke,$e){for(var Ge,De,Ze=Fi(ne),ut=we===0?Ki:Ci,Ut=ne.start,ft=0;ft<ne.length-3;ft+=3){var bi=ne[ft],wi=ne[ft+1],gi=ne[ft+2],Di=ne[ft+3],Hi=ne[ft+4],Re=we===0?bi:wi,vt=we===0?Di:Hi,Pt=!1;$e&&(Ge=Math.sqrt(Math.pow(bi-Di,2)+Math.pow(wi-Hi,2))),Re<te?vt>te&&(De=ut(Ze,bi,wi,Di,Hi,te),$e&&(Ze.start=Ut+Ge*De)):Re>pe?vt<pe&&(De=ut(Ze,bi,wi,Di,Hi,pe),$e&&(Ze.start=Ut+Ge*De)):rr(Ze,bi,wi,gi),vt<te&&Re>=te&&(De=ut(Ze,bi,wi,Di,Hi,te),Pt=!0),vt>pe&&Re<=pe&&(De=ut(Ze,bi,wi,Di,Hi,pe),Pt=!0),!ke&&Pt&&($e&&(Ze.end=Ut+Ge*De),H.push(Ze),Ze=Fi(ne)),$e&&(Ut+=Ge)}var fi=ne.length-3;bi=ne[fi],wi=ne[fi+1],gi=ne[fi+2],(Re=we===0?bi:wi)>=te&&Re<=pe&&rr(Ze,bi,wi,gi),fi=Ze.length-3,ke&&fi>=3&&(Ze[fi]!==Ze[0]||Ze[fi+1]!==Ze[1])&&rr(Ze,Ze[0],Ze[1],Ze[2]),Ze.length&&H.push(Ze)}function Fi(ne){var H=[];return H.size=ne.size,H.start=ne.start,H.end=ne.end,H}function Xi(ne,H,te,pe,we,ke){for(var $e=0;$e<ne.length;$e++)Ii(ne[$e],H,te,pe,we,ke,!1)}function rr(ne,H,te,pe){ne.push(H),ne.push(te),ne.push(pe)}function Ki(ne,H,te,pe,we,ke){var $e=(ke-H)/(pe-H);return ne.push(ke),ne.push(te+(we-te)*$e),ne.push(1),$e}function Ci(ne,H,te,pe,we,ke){var $e=(ke-te)/(we-te);return ne.push(H+(pe-H)*$e),ne.push(ke),ne.push(1),$e}function Ir(ne,H){for(var te=[],pe=0;pe<ne.length;pe++){var we,ke=ne[pe],$e=ke.type;if($e==="Point"||$e==="MultiPoint"||$e==="LineString")we=mn(ke.geometry,H);else if($e==="MultiLineString"||$e==="Polygon"){we=[];for(var Ge=0;Ge<ke.geometry.length;Ge++)we.push(mn(ke.geometry[Ge],H))}else if($e==="MultiPolygon")for(we=[],Ge=0;Ge<ke.geometry.length;Ge++){for(var De=[],Ze=0;Ze<ke.geometry[Ge].length;Ze++)De.push(mn(ke.geometry[Ge][Ze],H));we.push(De)}te.push(si(ke.id,$e,we,ke.tags))}return te}function mn(ne,H){var te=[];te.size=ne.size,ne.start!==void 0&&(te.start=ne.start,te.end=ne.end);for(var pe=0;pe<ne.length;pe+=3)te.push(ne[pe]+H,ne[pe+1],ne[pe+2]);return te}function gn(ne,H){if(ne.transformed)return ne;var te,pe,we,ke=1<<ne.z,$e=ne.x,Ge=ne.y;for(te=0;te<ne.features.length;te++){var De=ne.features[te],Ze=De.geometry,ut=De.type;if(De.geometry=[],ut===1)for(pe=0;pe<Ze.length;pe+=2)De.geometry.push(Er(Ze[pe],Ze[pe+1],H,ke,$e,Ge));else for(pe=0;pe<Ze.length;pe++){var Ut=[];for(we=0;we<Ze[pe].length;we+=2)Ut.push(Er(Ze[pe][we],Ze[pe][we+1],H,ke,$e,Ge));De.geometry.push(Ut)}}return ne.transformed=!0,ne}function Er(ne,H,te,pe,we,ke){return[Math.round(te*(ne*pe-we)),Math.round(te*(H*pe-ke))]}function un(ne,H,te,pe,we){for(var ke=H===we.maxZoom?0:we.tolerance/((1<<H)*we.extent),$e={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:te,y:pe,z:H,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Ge=0;Ge<ne.length;Ge++){$e.numFeatures++,ar($e,ne[Ge],ke,we);var De=ne[Ge].minX,Ze=ne[Ge].minY,ut=ne[Ge].maxX,Ut=ne[Ge].maxY;De<$e.minX&&($e.minX=De),Ze<$e.minY&&($e.minY=Ze),ut>$e.maxX&&($e.maxX=ut),Ut>$e.maxY&&($e.maxY=Ut)}return $e}function ar(ne,H,te,pe){var we=H.geometry,ke=H.type,$e=[];if(ke==="Point"||ke==="MultiPoint")for(var Ge=0;Ge<we.length;Ge+=3)$e.push(we[Ge]),$e.push(we[Ge+1]),ne.numPoints++,ne.numSimplified++;else if(ke==="LineString")Jr($e,we,ne,te,!1,!1);else if(ke==="MultiLineString"||ke==="Polygon")for(Ge=0;Ge<we.length;Ge++)Jr($e,we[Ge],ne,te,ke==="Polygon",Ge===0);else if(ke==="MultiPolygon")for(var De=0;De<we.length;De++){var Ze=we[De];for(Ge=0;Ge<Ze.length;Ge++)Jr($e,Ze[Ge],ne,te,!0,Ge===0)}if($e.length){var ut=H.tags||null;if(ke==="LineString"&&pe.lineMetrics){for(var Ut in ut={},H.tags)ut[Ut]=H.tags[Ut];ut.mapbox_clip_start=we.start/we.size,ut.mapbox_clip_end=we.end/we.size}var ft={geometry:$e,type:ke==="Polygon"||ke==="MultiPolygon"?3:ke==="LineString"||ke==="MultiLineString"?2:1,tags:ut};H.id!==null&&(ft.id=H.id),ne.features.push(ft)}}function Jr(ne,H,te,pe,we,ke){var $e=pe*pe;if(pe>0&&H.size<(we?$e:pe))te.numPoints+=H.length/3;else{for(var Ge=[],De=0;De<H.length;De+=3)(pe===0||H[De+2]>$e)&&(te.numSimplified++,Ge.push(H[De]),Ge.push(H[De+1])),te.numPoints++;we&&function(Ze,ut){for(var Ut=0,ft=0,bi=Ze.length,wi=bi-2;ft<bi;wi=ft,ft+=2)Ut+=(Ze[ft]-Ze[wi])*(Ze[ft+1]+Ze[wi+1]);if(Ut>0===ut)for(ft=0,bi=Ze.length;ft<bi/2;ft+=2){var gi=Ze[ft],Di=Ze[ft+1];Ze[ft]=Ze[bi-2-ft],Ze[ft+1]=Ze[bi-1-ft],Ze[bi-2-ft]=gi,Ze[bi-1-ft]=Di}}(Ge,ke),ne.push(Ge)}}function qr(ne,H){var te=(H=this.options=function(we,ke){for(var $e in ke)we[$e]=ke[$e];return we}(Object.create(this.options),H)).debug;if(te&&console.time("preprocess data"),H.maxZoom<0||H.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(H.promoteId&&H.generateId)throw new Error("promoteId and generateId cannot be used together.");var pe=function(we,ke){var $e=[];if(we.type==="FeatureCollection")for(var Ge=0;Ge<we.features.length;Ge++)xt($e,we.features[Ge],ke,Ge);else xt($e,we.type==="Feature"?we:{geometry:we},ke);return $e}(ne,H);this.tiles={},this.tileCoords=[],te&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",H.indexMaxZoom,H.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),pe=function(we,ke){var $e=ke.buffer/ke.extent,Ge=we,De=Kt(we,1,-1-$e,$e,0,-1,2,ke),Ze=Kt(we,1,1-$e,2+$e,0,-1,2,ke);return(De||Ze)&&(Ge=Kt(we,1,-$e,1+$e,0,-1,2,ke)||[],De&&(Ge=Ir(De,1).concat(Ge)),Ze&&(Ge=Ge.concat(Ir(Ze,-1)))),Ge}(pe,H),pe.length&&this.splitTile(pe,0,0,0),te&&(pe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function kr(ne,H,te){return 32*((1<<ne)*te+H)+ne}function ye(ne,H){const te=ne.tileID.canonical;if(!this._geoJSONIndex)return H(null,null);const pe=this._geoJSONIndex.getTile(te.z,te.x,te.y);if(!pe)return H(null,null);const we=new q(pe.features);let ke=oe.exports(we);ke.byteOffset===0&&ke.byteLength===ke.buffer.byteLength||(ke=new Uint8Array(ke)),H(null,{vectorTile:we,rawData:ke.buffer})}qr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},qr.prototype.splitTile=function(ne,H,te,pe,we,ke,$e){for(var Ge=[ne,H,te,pe],De=this.options,Ze=De.debug;Ge.length;){pe=Ge.pop(),te=Ge.pop(),H=Ge.pop(),ne=Ge.pop();var ut=1<<H,Ut=kr(H,te,pe),ft=this.tiles[Ut];if(!ft&&(Ze>1&&console.time("creation"),ft=this.tiles[Ut]=un(ne,H,te,pe,De),this.tileCoords.push({z:H,x:te,y:pe}),Ze)){Ze>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",H,te,pe,ft.numFeatures,ft.numPoints,ft.numSimplified),console.timeEnd("creation"));var bi="z"+H;this.stats[bi]=(this.stats[bi]||0)+1,this.total++}if(ft.source=ne,we){if(H===De.maxZoom||H===we)continue;var wi=1<<we-H;if(te!==Math.floor(ke/wi)||pe!==Math.floor($e/wi))continue}else if(H===De.indexMaxZoom||ft.numPoints<=De.indexMaxPoints)continue;if(ft.source=null,ne.length!==0){Ze>1&&console.time("clipping");var gi,Di,Hi,Re,vt,Pt,fi=.5*De.buffer/De.extent,dr=.5-fi,sr=.5+fi,it=1+fi;gi=Di=Hi=Re=null,vt=Kt(ne,ut,te-fi,te+sr,0,ft.minX,ft.maxX,De),Pt=Kt(ne,ut,te+dr,te+it,0,ft.minX,ft.maxX,De),ne=null,vt&&(gi=Kt(vt,ut,pe-fi,pe+sr,1,ft.minY,ft.maxY,De),Di=Kt(vt,ut,pe+dr,pe+it,1,ft.minY,ft.maxY,De),vt=null),Pt&&(Hi=Kt(Pt,ut,pe-fi,pe+sr,1,ft.minY,ft.maxY,De),Re=Kt(Pt,ut,pe+dr,pe+it,1,ft.minY,ft.maxY,De),Pt=null),Ze>1&&console.timeEnd("clipping"),Ge.push(gi||[],H+1,2*te,2*pe),Ge.push(Di||[],H+1,2*te,2*pe+1),Ge.push(Hi||[],H+1,2*te+1,2*pe),Ge.push(Re||[],H+1,2*te+1,2*pe+1)}}},qr.prototype.getTile=function(ne,H,te){var pe=this.options,we=pe.extent,ke=pe.debug;if(ne<0||ne>24)return null;var $e=1<<ne,Ge=kr(ne,H=(H%$e+$e)%$e,te);if(this.tiles[Ge])return gn(this.tiles[Ge],we);ke>1&&console.log("drilling down to z%d-%d-%d",ne,H,te);for(var De,Ze=ne,ut=H,Ut=te;!De&&Ze>0;)Ze--,ut=Math.floor(ut/2),Ut=Math.floor(Ut/2),De=this.tiles[kr(Ze,ut,Ut)];return De&&De.source?(ke>1&&console.log("found parent tile z%d-%d-%d",Ze,ut,Ut),ke>1&&console.time("drilling down"),this.splitTile(De.source,Ze,ut,Ut,ne,H,te),ke>1&&console.timeEnd("drilling down"),this.tiles[Ge]?gn(this.tiles[Ge],we):null):null};class qe extends o.VectorTileWorkerSource{constructor(H,te,pe,we,ke){super(H,te,pe,we,ye),ke&&(this.loadGeoJSON=ke)}loadData(H,te){const pe=H&&H.request,we=pe&&pe.collectResourceTiming;this.loadGeoJSON(H,(ke,$e)=>{if(ke||!$e)return te(ke);if(typeof $e!="object")return te(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`));{L($e,!0);try{if(H.filter){const De=o.createExpression(H.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(De.result==="error")throw new Error(De.value.map(ut=>`${ut.key}: ${ut.message}`).join(", "));const Ze=$e.features.filter(ut=>De.value.evaluate({zoom:0},ut));$e={type:"FeatureCollection",features:Ze}}this._geoJSONIndex=H.cluster?new yt(function({superclusterOptions:De,clusterProperties:Ze}){if(!Ze||!De)return De;const ut={},Ut={},ft={accumulated:null,zoom:0},bi={properties:null},wi=Object.keys(Ze);for(const gi of wi){const[Di,Hi]=Ze[gi],Re=o.createExpression(Hi),vt=o.createExpression(typeof Di=="string"?[Di,["accumulated"],["get",gi]]:Di);ut[gi]=Re.value,Ut[gi]=vt.value}return De.map=gi=>{bi.properties=gi;const Di={};for(const Hi of wi)Di[Hi]=ut[Hi].evaluate(ft,bi);return Di},De.reduce=(gi,Di)=>{bi.properties=Di;for(const Hi of wi)ft.accumulated=gi[Hi],gi[Hi]=Ut[Hi].evaluate(ft,bi)},De}(H)).load($e.features):function(De,Ze){return new qr(De,Ze)}($e,H.geojsonVtOptions)}catch(De){return te(De)}this.loaded={};const Ge={};if(we){const De=o.getPerformanceMeasurement(pe);De&&(Ge.resourceTiming={},Ge.resourceTiming[H.source]=JSON.parse(JSON.stringify(De)))}te(null,Ge)}})}reloadTile(H,te){const pe=this.loaded;return pe&&pe[H.uid]?super.reloadTile(H,te):this.loadTile(H,te)}loadGeoJSON(H,te){if(H.request)o.getJSON(H.request,te);else{if(typeof H.data!="string")return te(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`));try{return te(null,JSON.parse(H.data))}catch{return te(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(H,te){try{te(null,this._geoJSONIndex.getClusterExpansionZoom(H.clusterId))}catch(pe){te(pe)}}getClusterChildren(H,te){try{te(null,this._geoJSONIndex.getChildren(H.clusterId))}catch(pe){te(pe)}}getClusterLeaves(H,te){try{te(null,this._geoJSONIndex.getLeaves(H.clusterId,H.limit,H.offset))}catch(pe){te(pe)}}}class at{constructor(H){this.self=H,this.actor=new o.Actor(H,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=o.getProjection({name:"mercator"}),this.workerSourceTypes={vector:o.VectorTileWorkerSource,geojson:qe},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(te,pe)=>{if(this.workerSourceTypes[te])throw new Error(`Worker source with name "${te}" already registered.`);this.workerSourceTypes[te]=pe},this.self.registerRTLTextPlugin=te=>{if(o.plugin.isParsed())throw new Error("RTL text plugin already registered.");o.plugin.applyArabicShaping=te.applyArabicShaping,o.plugin.processBidirectionalText=te.processBidirectionalText,o.plugin.processStyledBidirectionalText=te.processStyledBidirectionalText}}clearCaches(H,te,pe){delete this.layerIndexes[H],delete this.availableImages[H],delete this.workerSources[H],delete this.demWorkerSources[H],pe()}checkIfReady(H,te,pe){pe()}setReferrer(H,te){this.referrer=te}spriteLoaded(H,te){this.isSpriteLoaded[H]=te;for(const pe in this.workerSources[H]){const we=this.workerSources[H][pe];for(const ke in we)we[ke]instanceof o.VectorTileWorkerSource&&(we[ke].isSpriteLoaded=te,we[ke].fire(new o.Event("isSpriteLoaded")))}}setImages(H,te,pe){this.availableImages[H]=te;for(const we in this.workerSources[H]){const ke=this.workerSources[H][we];for(const $e in ke)ke[$e].availableImages=te}pe()}enableTerrain(H,te,pe){this.terrain=te,pe()}setProjection(H,te){this.projections[H]=o.getProjection(te)}setLayers(H,te,pe){this.getLayerIndex(H).replace(te),pe()}updateLayers(H,te,pe){this.getLayerIndex(H).update(te.layers,te.removedIds),pe()}loadTile(H,te,pe){const we=this.enableTerrain?o.extend({enableTerrain:this.terrain},te):te;we.projection=this.projections[H]||this.defaultProjection,this.getWorkerSource(H,te.type,te.source).loadTile(we,pe)}loadDEMTile(H,te,pe){const we=this.enableTerrain?o.extend({buildQuadTree:this.terrain},te):te;this.getDEMWorkerSource(H,te.source).loadTile(we,pe)}reloadTile(H,te,pe){const we=this.enableTerrain?o.extend({enableTerrain:this.terrain},te):te;we.projection=this.projections[H]||this.defaultProjection,this.getWorkerSource(H,te.type,te.source).reloadTile(we,pe)}abortTile(H,te,pe){this.getWorkerSource(H,te.type,te.source).abortTile(te,pe)}removeTile(H,te,pe){this.getWorkerSource(H,te.type,te.source).removeTile(te,pe)}removeSource(H,te,pe){if(!this.workerSources[H]||!this.workerSources[H][te.type]||!this.workerSources[H][te.type][te.source])return;const we=this.workerSources[H][te.type][te.source];delete this.workerSources[H][te.type][te.source],we.removeSource!==void 0?we.removeSource(te,pe):pe()}loadWorkerSource(H,te,pe){try{this.self.importScripts(te.url),pe()}catch(we){pe(we.toString())}}syncRTLPluginState(H,te,pe){try{o.plugin.setState(te);const we=o.plugin.getPluginURL();if(o.plugin.isLoaded()&&!o.plugin.isParsed()&&we!=null){this.self.importScripts(we);const ke=o.plugin.isParsed();pe(ke?void 0:new Error(`RTL Text Plugin failed to import scripts from ${we}`),ke)}}catch(we){pe(we.toString())}}getAvailableImages(H){let te=this.availableImages[H];return te||(te=[]),te}getLayerIndex(H){let te=this.layerIndexes[H];return te||(te=this.layerIndexes[H]=new M),te}getWorkerSource(H,te,pe){if(this.workerSources[H]||(this.workerSources[H]={}),this.workerSources[H][te]||(this.workerSources[H][te]={}),!this.workerSources[H][te][pe]){const we={send:(ke,$e,Ge,De,Ze,ut)=>{this.actor.send(ke,$e,Ge,H,Ze,ut)},scheduler:this.actor.scheduler};this.workerSources[H][te][pe]=new this.workerSourceTypes[te](we,this.getLayerIndex(H),this.getAvailableImages(H),this.isSpriteLoaded[H])}return this.workerSources[H][te][pe]}getDEMWorkerSource(H,te){return this.demWorkerSources[H]||(this.demWorkerSources[H]={}),this.demWorkerSources[H][te]||(this.demWorkerSources[H][te]=new P),this.demWorkerSources[H][te]}enforceCacheSizeLimit(H,te){o.enforceCacheSizeLimit(te)}getWorkerPerformanceMetrics(H,te,pe){pe(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new at(self)),at}),f(["./shared"],function(o){function b(g,c){if(Array.isArray(g)){if(!Array.isArray(c)||g.length!==c.length)return!1;for(let p=0;p<g.length;p++)if(!b(g[p],c[p]))return!1;return!0}if(typeof g=="object"&&g!==null&&c!==null){if(typeof c!="object"||Object.keys(g).length!==Object.keys(c).length)return!1;for(const p in g)if(!b(g[p],c[p]))return!1;return!0}return g===c}var E=M;function M(g){return!function(c){return typeof window>"u"||typeof document>"u"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var x,T,A=new Blob([""],{type:"text/javascript"}),k=URL.createObjectURL(A);try{T=new Worker(k),x=!0}catch{x=!1}return T&&T.terminate(),URL.revokeObjectURL(k),x}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var x=document.createElement("canvas");x.width=x.height=1;var T=x.getContext("2d");if(!T)return!1;var A=T.getImageData(0,0,1,1);return A&&A.width===x.width}()?(P[p=c&&c.failIfMajorPerformanceCaveat]===void 0&&(P[p]=function(x){var T,A=function(k){var O=document.createElement("canvas"),F=Object.create(M.webGLContextAttributes);return F.failIfMajorPerformanceCaveat=k,O.getContext("webgl",F)||O.getContext("experimental-webgl",F)}(x);if(!A)return!1;try{T=A.createShader(A.VERTEX_SHADER)}catch{return!1}return!(!T||A.isContextLost())&&(A.shaderSource(T,"void main() {}"),A.compileShader(T),A.getShaderParameter(T,A.COMPILE_STATUS)===!0)}(p)),P[p]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var p}(g)}var P={};function L(g,c,p){const x=o.window.document.createElement(g);return c!==void 0&&(x.className=c),p&&p.appendChild(x),x}function D(g,c,p){const x=o.window.document.createElementNS("http://www.w3.org/2000/svg",g);for(const T of Object.keys(c))x.setAttributeNS(null,T,c[T]);return p&&p.appendChild(x),x}M.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const U=o.window.document&&o.window.document.documentElement.style,X=U&&U.userSelect!==void 0?"userSelect":"WebkitUserSelect";let K;function q(){U&&X&&(K=U[X],U[X]="none")}function oe(){U&&X&&(U[X]=K)}function W(g){g.preventDefault(),g.stopPropagation(),o.window.removeEventListener("click",W,!0)}function Y(){o.window.addEventListener("click",W,!0),o.window.setTimeout(()=>{o.window.removeEventListener("click",W,!0)},0)}function J(g,c){const p=g.getBoundingClientRect();return se(g,p,c)}function Ee(g,c){const p=g.getBoundingClientRect(),x=[];for(let T=0;T<c.length;T++)x.push(se(g,p,c[T]));return x}function xe(g){return o.window.InstallTrigger!==void 0&&g.button===2&&g.ctrlKey&&o.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:g.button}function se(g,c,p){const x=g.offsetWidth===c.width?1:g.offsetWidth/c.width;return new o.pointGeometry((p.clientX-c.left)*x,(p.clientY-c.top)*x)}function ce(g,c){var p=c[0],x=c[1],T=c[2],A=c[3],k=p*A-T*x;return k?(g[0]=A*(k=1/k),g[1]=-x*k,g[2]=-T*k,g[3]=p*k,g):null}function ee(g){const{userImage:c}=g;return!!(c&&c.render&&c.render())&&(g.data.replace(new Uint8Array(c.data.buffer)),!0)}class he extends o.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new o.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(c){if(this.loaded!==c&&(this.loaded=c,c)){for(const{ids:p,callback:x}of this.requestors)this._notify(p,x);this.requestors=[]}}hasImage(c){return!!this.getImage(c)}getImage(c){return this.images[c]}addImage(c,p){this._validate(c,p)&&(this.images[c]=p)}_validate(c,p){let x=!0;return this._validateStretch(p.stretchX,p.data&&p.data.width)||(this.fire(new o.ErrorEvent(new Error(`Image "${c}" has invalid "stretchX" value`))),x=!1),this._validateStretch(p.stretchY,p.data&&p.data.height)||(this.fire(new o.ErrorEvent(new Error(`Image "${c}" has invalid "stretchY" value`))),x=!1),this._validateContent(p.content,p)||(this.fire(new o.ErrorEvent(new Error(`Image "${c}" has invalid "content" value`))),x=!1),x}_validateStretch(c,p){if(!c)return!0;let x=0;for(const T of c){if(T[0]<x||T[1]<T[0]||p<T[1])return!1;x=T[1]}return!0}_validateContent(c,p){return!(c&&(c.length!==4||c[0]<0||p.data.width<c[0]||c[1]<0||p.data.height<c[1]||c[2]<0||p.data.width<c[2]||c[3]<0||p.data.height<c[3]||c[2]<c[0]||c[3]<c[1]))}updateImage(c,p){p.version=this.images[c].version+1,this.images[c]=p,this.updatedImages[c]=!0}removeImage(c){const p=this.images[c];delete this.images[c],delete this.patterns[c],p.userImage&&p.userImage.onRemove&&p.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(c,p){let x=!0;if(!this.isLoaded())for(const T of c)this.images[T]||(x=!1);this.isLoaded()||x?this._notify(c,p):this.requestors.push({ids:c,callback:p})}_notify(c,p){const x={};for(const T of c){this.images[T]||this.fire(new o.Event("styleimagemissing",{id:T}));const A=this.images[T];A?x[T]={data:A.data.clone(),pixelRatio:A.pixelRatio,sdf:A.sdf,version:A.version,stretchX:A.stretchX,stretchY:A.stretchY,content:A.content,hasRenderCallback:Boolean(A.userImage&&A.userImage.render)}:o.warnOnce(`Image "${T}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}p(null,x)}getPixelSize(){const{width:c,height:p}=this.atlasImage;return{width:c,height:p}}getPattern(c){const p=this.patterns[c],x=this.getImage(c);if(!x)return null;if(p&&p.position.version===x.version)return p.position;if(p)p.position.version=x.version;else{const T={w:x.data.width+2,h:x.data.height+2,x:0,y:0},A=new o.ImagePosition(T,x);this.patterns[c]={bin:T,position:A}}return this._updatePatternAtlas(),this.patterns[c].position}bind(c){const p=c.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new o.Texture(c,this.atlasImage,p.RGBA),this.atlasTexture.bind(p.LINEAR,p.CLAMP_TO_EDGE)}_updatePatternAtlas(){const c=[];for(const A in this.patterns)c.push(this.patterns[A].bin);const{w:p,h:x}=o.potpack(c),T=this.atlasImage;T.resize({width:p||1,height:x||1});for(const A in this.patterns){const{bin:k}=this.patterns[A],O=k.x+1,F=k.y+1,V=this.images[A].data,G=V.width,ie=V.height;o.RGBAImage.copy(V,T,{x:0,y:0},{x:O,y:F},{width:G,height:ie}),o.RGBAImage.copy(V,T,{x:0,y:ie-1},{x:O,y:F-1},{width:G,height:1}),o.RGBAImage.copy(V,T,{x:0,y:0},{x:O,y:F+ie},{width:G,height:1}),o.RGBAImage.copy(V,T,{x:G-1,y:0},{x:O-1,y:F},{width:1,height:ie}),o.RGBAImage.copy(V,T,{x:0,y:0},{x:O+G,y:F},{width:1,height:ie})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(c){for(const p of c){if(this.callbackDispatchedThisFrame[p])continue;this.callbackDispatchedThisFrame[p]=!0;const x=this.images[p];ee(x)&&this.updateImage(p,x)}}}const Ie=new o.Properties({anchor:new o.DataConstantProperty(o.spec.light.anchor),position:new class{constructor(){this.specification=o.spec.light.position}possiblyEvaluate(g,c){return function([p,x,T]){const A=o.degToRad(x+90),k=o.degToRad(T);return{x:p*Math.cos(A)*Math.sin(k),y:p*Math.sin(A)*Math.sin(k),z:p*Math.cos(k),azimuthal:x,polar:T}}(g.expression.evaluate(c))}interpolate(g,c,p){return{x:o.number(g.x,c.x,p),y:o.number(g.y,c.y,p),z:o.number(g.z,c.z,p),azimuthal:o.number(g.azimuthal,c.azimuthal,p),polar:o.number(g.polar,c.polar,p)}}},color:new o.DataConstantProperty(o.spec.light.color),intensity:new o.DataConstantProperty(o.spec.light.intensity)}),Pe="-transition";class Qe extends o.Evented{constructor(c){super(),this._transitionable=new o.Transitionable(Ie),this.setLight(c),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(c,p={}){if(!this._validate(o.validateLight,c,p))for(const x in c){const T=c[x];o.endsWith(x,Pe)?this._transitionable.setTransition(x.slice(0,-Pe.length),T):this._transitionable.setValue(x,T)}}updateTransitions(c){this._transitioning=this._transitionable.transitioned(c,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(c){this.properties=this._transitioning.possiblyEvaluate(c)}_validate(c,p,x){return(!x||x.validate!==!1)&&o.emitValidationErrors(this,c.call(o.validateStyle,o.extend({value:p,style:{glyphs:!0,sprite:!0},styleSpec:o.spec})))}}const We=new o.Properties({source:new o.DataConstantProperty(o.spec.terrain.source),exaggeration:new o.DataConstantProperty(o.spec.terrain.exaggeration)}),Zt="-transition";class ti extends o.Evented{constructor(c,p){super(),this._transitionable=new o.Transitionable(We),this.set(c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=p}get(){return this._transitionable.serialize()}set(c){for(const p in c){const x=c[p];o.endsWith(p,Zt)?this._transitionable.setTransition(p.slice(0,-Zt.length),x):this._transitionable.setValue(p,x)}}updateTransitions(c){this._transitioning=this._transitionable.transitioned(c,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(c){this.properties=this._transitioning.possiblyEvaluate(c)}}function $t(g,c,p,x){const T=o.smoothstep(45,65,p),[A,k]=oi(g,x),O=o.length(c);let F=1-Math.min(1,Math.exp((O-A)/(k-A)*-6));return F*=F*F,F=Math.min(1,1.00747*F),F*T*g.alpha}function oi(g,c){const p=.5/Math.tan(.5*c);return[g.range[0]+p,g.range[1]+p]}const je=new o.Properties({range:new o.DataConstantProperty(o.spec.fog.range),color:new o.DataConstantProperty(o.spec.fog.color),"high-color":new o.DataConstantProperty(o.spec.fog["high-color"]),"space-color":new o.DataConstantProperty(o.spec.fog["space-color"]),"horizon-blend":new o.DataConstantProperty(o.spec.fog["horizon-blend"]),"star-intensity":new o.DataConstantProperty(o.spec.fog["star-intensity"])}),_t="-transition";class Bt extends o.Evented{constructor(c,p){super(),this._transitionable=new o.Transitionable(je),this.set(c),this._transitioning=this._transitionable.untransitioned(),this._transform=p}get state(){const c=this._transform,p=c.projection.name==="globe",x=o.globeToMercatorTransition(c.zoom),T=this.properties.get("range"),A=[.5,3];return{range:p?[o.number(A[0],T[0],x),o.number(A[1],T[1],x)]:T,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(c,p={}){if(!this._validate(o.validateFog,c,p)){for(const x of Object.keys(o.spec.fog))c&&c[x]===void 0&&(c[x]=o.spec.fog[x].default);for(const x in c){const T=c[x];o.endsWith(x,_t)?this._transitionable.setTransition(x.slice(0,-_t.length),T):this._transitionable.setValue(x,T)}}}getOpacity(c){if(!this._transform.projection.supportsFog)return 0;const p=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:o.smoothstep(45,65,c))*p.a}getOpacityAtLatLng(c,p){return this._transform.projection.supportsFog?function(x,T,A){const k=o.MercatorCoordinate.fromLngLat(T),O=A.elevation?A.elevation.getAtPointOrZero(k):0,F=[k.x,k.y,O];return o.transformMat4(F,F,A.mercatorFogMatrix),$t(x,F,A.pitch,A._fov)}(this.state,c,p):0}getFovAdjustedRange(c){return this._transform.projection.supportsFog?oi(this.state,c):[0,1]}updateTransitions(c){this._transitioning=this._transitionable.transitioned(c,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(c){this.properties=this._transitioning.possiblyEvaluate(c)}_validate(c,p,x){return(!x||x.validate!==!1)&&o.emitValidationErrors(this,c.call(o.validateStyle,o.extend({value:p,style:{glyphs:!0,sprite:!0},styleSpec:o.spec})))}}class dt{constructor(c,p){this.workerPool=c,this.actors=[],this.currentActor=0,this.id=o.uniqueId();const x=this.workerPool.acquire(this.id);for(let T=0;T<x.length;T++){const A=new dt.Actor(x[T],p,this.id);A.name=`Worker ${T}`,this.actors.push(A)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(c,p,x){o.asyncAll(this.actors,(T,A)=>{T.send(c,p,A)},x=x||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(c=>{c.remove()}),this.actors=[],this.workerPool.release(this.id)}}function At(g,c,p){return c*(o.EXTENT/(g.tileSize*Math.pow(2,p-g.tileID.overscaledZ)))}dt.Actor=o.Actor;class Tt{constructor(c,p,x,T){this.screenBounds=c,this.cameraPoint=p,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=x,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,T)}static createFromScreenPoints(c,p){let x,T;if(c instanceof o.pointGeometry||typeof c[0]=="number"){const A=o.pointGeometry.convert(c);x=[A],T=p.isPointAboveHorizon(A)}else{const A=o.pointGeometry.convert(c[0]),k=o.pointGeometry.convert(c[1]);x=[A,k],T=o.polygonizeBounds(A,k).every(O=>p.isPointAboveHorizon(O))}return new Tt(x,p.getCameraPoint(),T,p)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(c){return o.polygonizeBounds(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],c)}bufferedCameraGeometry(c){const p=this.screenBounds[0],x=this.screenBounds.length===1?this.screenBounds[0].add(new o.pointGeometry(1,1)):this.screenBounds[1],T=o.polygonizeBounds(p,x,0,!1);return this.cameraPoint.y>x.y&&(this.cameraPoint.x>p.x&&this.cameraPoint.x<x.x?T.splice(3,0,this.cameraPoint):this.cameraPoint.x>=x.x?T[2]=this.cameraPoint:this.cameraPoint.x<=p.x&&(T[3]=this.cameraPoint)),o.bufferConvexPolygon(T,c)}bufferedCameraGeometryGlobe(c){const p=this.screenBounds[0],x=this.screenBounds.length===1?this.screenBounds[0].add(new o.pointGeometry(1,1)):this.screenBounds[1],T=o.polygonizeBounds(p,x,c),A=this.cameraPoint.clone();switch(3*((A.y>p.y)+(A.y>x.y))+((A.x>p.x)+(A.x>x.x))){case 0:T[0]=A,T[4]=A.clone();break;case 1:T.splice(1,0,A);break;case 2:T[1]=A;break;case 3:T.splice(4,0,A);break;case 5:T.splice(2,0,A);break;case 6:T[3]=A;break;case 7:T.splice(3,0,A);break;case 8:T[2]=A}return T}containsTile(c,p,x,T=0){const A=c.queryPadding/p._pixelsPerMercatorPixel+1,k=x?this._bufferedCameraMercator(A,p):this._bufferedScreenMercator(A,p);let O=c.tileID.wrap+(k.unwrapped?T:0);const F=k.polygon.map(me=>o.getTilePoint(c.tileTransform,me,O));if(!o.polygonIntersectsBox(F,0,0,o.EXTENT,o.EXTENT))return;O=c.tileID.wrap+(this.screenGeometryMercator.unwrapped?T:0);const V=this.screenGeometryMercator.polygon.map(me=>o.getTileVec3(c.tileTransform,me,O)),G=V.map(me=>new o.pointGeometry(me[0],me[1])),ie=p.getFreeCameraOptions().position||new o.MercatorCoordinate(0,0,0),le=o.getTileVec3(c.tileTransform,ie,O),_e=V.map(me=>{const de=o.sub(me,me,le);return o.normalize(de,de),new o.Ray(le,de)}),fe=At(c,1,p.zoom)*p._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:G,tilespaceRays:_e,bufferedTilespaceGeometry:F,bufferedTilespaceBounds:(ve=o.getBounds(F),ve.min.x=o.clamp(ve.min.x,0,o.EXTENT),ve.min.y=o.clamp(ve.min.y,0,o.EXTENT),ve.max.x=o.clamp(ve.max.x,0,o.EXTENT),ve.max.y=o.clamp(ve.max.y,0,o.EXTENT),ve),tile:c,tileID:c.tileID,pixelToTileUnitsFactor:fe};var ve}_bufferedScreenMercator(c,p){const x=pi(c);if(this._screenRaycastCache[x])return this._screenRaycastCache[x];{let T;return T=p.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(c),p):{polygon:this.bufferedScreenGeometry(c).map(A=>p.pointCoordinate3D(A)),unwrapped:!0},this._screenRaycastCache[x]=T,T}}_bufferedCameraMercator(c,p){const x=pi(c);if(this._cameraRaycastCache[x])return this._cameraRaycastCache[x];{let T;return T=p.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(c),p):{polygon:this.bufferedCameraGeometry(c).map(A=>p.pointCoordinate3D(A)),unwrapped:!0},this._cameraRaycastCache[x]=T,T}}_projectAndResample(c,p){const x=function(A,k){const O=o.multiply([],k.pixelMatrix,k.globeMatrix),F=[0,-o.GLOBE_RADIUS,0,1],V=[0,o.GLOBE_RADIUS,0,1],G=[0,0,0,1];o.transformMat4$1(F,F,O),o.transformMat4$1(V,V,O),o.transformMat4$1(G,G,O);const ie=new o.pointGeometry(F[0]/F[3],F[1]/F[3]),le=new o.pointGeometry(V[0]/V[3],V[1]/V[3]),_e=o.polygonContainsPoint(A,ie)&&F[3]<G[3],fe=o.polygonContainsPoint(A,le)&&V[3]<G[3];if(!_e&&!fe)return null;const ve=function(Fe,Je,lt){for(let ot=1;ot<Fe.length;ot++){const zt=Ct(Je.pointCoordinate3D(Fe[ot-1]).x),He=Ct(Je.pointCoordinate3D(Fe[ot]).x);if(lt<0){if(zt<He)return{idx:ot,t:-zt/(He-1-zt)}}else if(He<zt)return{idx:ot,t:(1-zt)/(He+1-zt)}}return null}(A,k,_e?-1:1);if(!ve)return null;const{idx:me,t:de}=ve;let be=me>1?Dt(A.slice(0,me),k):[],ge=me<A.length?Dt(A.slice(me),k):[];be=be.map(Fe=>new o.pointGeometry(Ct(Fe.x),Fe.y)),ge=ge.map(Fe=>new o.pointGeometry(Ct(Fe.x),Fe.y));const Be=[...be];Be.length===0&&Be.push(ge[ge.length-1]);const ze=o.number(Be[Be.length-1].y,(ge.length===0?be[0]:ge[0]).y,de);let Me;return Me=_e?[new o.pointGeometry(0,ze),new o.pointGeometry(0,0),new o.pointGeometry(1,0),new o.pointGeometry(1,ze)]:[new o.pointGeometry(1,ze),new o.pointGeometry(1,1),new o.pointGeometry(0,1),new o.pointGeometry(0,ze)],Be.push(...Me),ge.length===0?Be.push(be[0]):Be.push(...ge),{polygon:Be.map(Fe=>new o.MercatorCoordinate(Fe.x,Fe.y)),unwrapped:!1}}(c,p);if(x)return x;const T=function(A,k){let O=!1,F=-1/0,V=0;for(let ie=0;ie<A.length-1;ie++)A[ie].x>F&&(F=A[ie].x,V=ie);for(let ie=0;ie<A.length-1;ie++){const le=(V+ie)%(A.length-1),_e=A[le],fe=A[le+1];Math.abs(_e.x-fe.x)>.5&&(_e.x<fe.x?(_e.x+=1,le===0&&(A[A.length-1].x+=1)):(fe.x+=1,le+1===A.length-1&&(A[0].x+=1)),O=!0)}const G=o.mercatorXfromLng(k.center.lng);return O&&G<Math.abs(G-1)&&A.forEach(ie=>{ie.x-=1}),{polygon:A,unwrapped:O}}(Dt(c,p).map(A=>new o.pointGeometry(Ct(A.x),A.y)),p);return{polygon:T.polygon.map(A=>new o.MercatorCoordinate(A.x,A.y)),unwrapped:T.unwrapped}}}function Dt(g,c){return o.resample(g,p=>{const x=c.pointCoordinate3D(p);p.x=x.x,p.y=x.y},1/256)}function Ct(g){return g<0?1+g%1:g%1}function pi(g){return 100*g|0}function yt(g,c,p,x,T){const A=function(k,O){if(k)return T(k);if(O){g.url&&O.tiles&&g.tiles&&delete g.tiles;const F=o.pick(o.extend(O,g),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);O.vector_layers&&(F.vectorLayers=O.vector_layers,F.vectorLayerIds=F.vectorLayers.map(V=>V.id)),F.tiles=c.canonicalizeTileset(F,g.url),T(null,F)}};return g.url?o.getJSON(c.transformRequest(c.normalizeSourceURL(g.url,null,p,x),o.ResourceType.Source),A):o.exported.frame(()=>A(null,g))}class vi{constructor(c,p,x){this.bounds=o.LngLatBounds.convert(this.validateBounds(c)),this.minzoom=p||0,this.maxzoom=x||24}validateBounds(c){return Array.isArray(c)&&c.length===4?[Math.max(-180,c[0]),Math.max(-90,c[1]),Math.min(180,c[2]),Math.min(90,c[3])]:[-180,-90,180,90]}contains(c){const p=Math.pow(2,c.z),x=Math.floor(o.mercatorXfromLng(this.bounds.getWest())*p),T=Math.floor(o.mercatorYfromLat(this.bounds.getNorth())*p),A=Math.ceil(o.mercatorXfromLng(this.bounds.getEast())*p),k=Math.ceil(o.mercatorYfromLat(this.bounds.getSouth())*p);return c.x>=x&&c.x<A&&c.y>=T&&c.y<k}}class $i{constructor(c,p,x){this.context=c;const T=c.gl;this.buffer=T.createBuffer(),this.dynamicDraw=Boolean(x),this.context.unbindVAO(),c.bindElementBuffer.set(this.buffer),T.bufferData(T.ELEMENT_ARRAY_BUFFER,p.arrayBuffer,this.dynamicDraw?T.DYNAMIC_DRAW:T.STATIC_DRAW),this.dynamicDraw||p.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(c){const p=this.context.gl;this.context.unbindVAO(),this.bind(),p.bufferSubData(p.ELEMENT_ARRAY_BUFFER,0,c.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const yi={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class mi{constructor(c,p,x,T){this.length=p.length,this.attributes=x,this.itemSize=p.bytesPerElement,this.dynamicDraw=T,this.context=c;const A=c.gl;this.buffer=A.createBuffer(),c.bindVertexBuffer.set(this.buffer),A.bufferData(A.ARRAY_BUFFER,p.arrayBuffer,this.dynamicDraw?A.DYNAMIC_DRAW:A.STATIC_DRAW),this.dynamicDraw||p.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(c){const p=this.context.gl;this.bind(),p.bufferSubData(p.ARRAY_BUFFER,0,c.arrayBuffer)}enableAttributes(c,p){for(let x=0;x<this.attributes.length;x++){const T=p.attributes[this.attributes[x].name];T!==void 0&&c.enableVertexAttribArray(T)}}setVertexAttribPointers(c,p,x){for(let T=0;T<this.attributes.length;T++){const A=this.attributes[T],k=p.attributes[A.name];k!==void 0&&c.vertexAttribPointer(k,A.components,c[yi[A.type]],!1,this.itemSize,A.offset+this.itemSize*(x||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class It{constructor(c){this.gl=c.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(c){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class kt extends It{getDefault(){return o.Color.transparent}set(c){const p=this.current;(c.r!==p.r||c.g!==p.g||c.b!==p.b||c.a!==p.a||this.dirty)&&(this.gl.clearColor(c.r,c.g,c.b,c.a),this.current=c,this.dirty=!1)}}class Ri extends It{getDefault(){return 1}set(c){(c!==this.current||this.dirty)&&(this.gl.clearDepth(c),this.current=c,this.dirty=!1)}}class Pi extends It{getDefault(){return 0}set(c){(c!==this.current||this.dirty)&&(this.gl.clearStencil(c),this.current=c,this.dirty=!1)}}class zi extends It{getDefault(){return[!0,!0,!0,!0]}set(c){const p=this.current;(c[0]!==p[0]||c[1]!==p[1]||c[2]!==p[2]||c[3]!==p[3]||this.dirty)&&(this.gl.colorMask(c[0],c[1],c[2],c[3]),this.current=c,this.dirty=!1)}}class ht extends It{getDefault(){return!0}set(c){(c!==this.current||this.dirty)&&(this.gl.depthMask(c),this.current=c,this.dirty=!1)}}class Gt extends It{getDefault(){return 255}set(c){(c!==this.current||this.dirty)&&(this.gl.stencilMask(c),this.current=c,this.dirty=!1)}}class di extends It{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(c){const p=this.current;(c.func!==p.func||c.ref!==p.ref||c.mask!==p.mask||this.dirty)&&(this.gl.stencilFunc(c.func,c.ref,c.mask),this.current=c,this.dirty=!1)}}class si extends It{getDefault(){const c=this.gl;return[c.KEEP,c.KEEP,c.KEEP]}set(c){const p=this.current;(c[0]!==p[0]||c[1]!==p[1]||c[2]!==p[2]||this.dirty)&&(this.gl.stencilOp(c[0],c[1],c[2]),this.current=c,this.dirty=!1)}}class Ae extends It{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;c?p.enable(p.STENCIL_TEST):p.disable(p.STENCIL_TEST),this.current=c,this.dirty=!1}}class xt extends It{getDefault(){return[0,1]}set(c){const p=this.current;(c[0]!==p[0]||c[1]!==p[1]||this.dirty)&&(this.gl.depthRange(c[0],c[1]),this.current=c,this.dirty=!1)}}class Xt extends It{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;c?p.enable(p.DEPTH_TEST):p.disable(p.DEPTH_TEST),this.current=c,this.dirty=!1}}class Nt extends It{getDefault(){return this.gl.LESS}set(c){(c!==this.current||this.dirty)&&(this.gl.depthFunc(c),this.current=c,this.dirty=!1)}}class Yt extends It{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;c?p.enable(p.BLEND):p.disable(p.BLEND),this.current=c,this.dirty=!1}}class ii extends It{getDefault(){const c=this.gl;return[c.ONE,c.ZERO]}set(c){const p=this.current;(c[0]!==p[0]||c[1]!==p[1]||this.dirty)&&(this.gl.blendFunc(c[0],c[1]),this.current=c,this.dirty=!1)}}class Rt extends It{getDefault(){return o.Color.transparent}set(c){const p=this.current;(c.r!==p.r||c.g!==p.g||c.b!==p.b||c.a!==p.a||this.dirty)&&(this.gl.blendColor(c.r,c.g,c.b,c.a),this.current=c,this.dirty=!1)}}class Kt extends It{getDefault(){return this.gl.FUNC_ADD}set(c){(c!==this.current||this.dirty)&&(this.gl.blendEquation(c),this.current=c,this.dirty=!1)}}class Li extends It{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;c?p.enable(p.CULL_FACE):p.disable(p.CULL_FACE),this.current=c,this.dirty=!1}}class Ii extends It{getDefault(){return this.gl.BACK}set(c){(c!==this.current||this.dirty)&&(this.gl.cullFace(c),this.current=c,this.dirty=!1)}}class Fi extends It{getDefault(){return this.gl.CCW}set(c){(c!==this.current||this.dirty)&&(this.gl.frontFace(c),this.current=c,this.dirty=!1)}}class Xi extends It{getDefault(){return null}set(c){(c!==this.current||this.dirty)&&(this.gl.useProgram(c),this.current=c,this.dirty=!1)}}class rr extends It{getDefault(){return this.gl.TEXTURE0}set(c){(c!==this.current||this.dirty)&&(this.gl.activeTexture(c),this.current=c,this.dirty=!1)}}class Ki extends It{getDefault(){const c=this.gl;return[0,0,c.drawingBufferWidth,c.drawingBufferHeight]}set(c){const p=this.current;(c[0]!==p[0]||c[1]!==p[1]||c[2]!==p[2]||c[3]!==p[3]||this.dirty)&&(this.gl.viewport(c[0],c[1],c[2],c[3]),this.current=c,this.dirty=!1)}}class Ci extends It{getDefault(){return null}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;p.bindFramebuffer(p.FRAMEBUFFER,c),this.current=c,this.dirty=!1}}class Ir extends It{getDefault(){return null}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;p.bindRenderbuffer(p.RENDERBUFFER,c),this.current=c,this.dirty=!1}}class mn extends It{getDefault(){return null}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;p.bindTexture(p.TEXTURE_2D,c),this.current=c,this.dirty=!1}}class gn extends It{getDefault(){return null}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;p.bindBuffer(p.ARRAY_BUFFER,c),this.current=c,this.dirty=!1}}class Er extends It{getDefault(){return null}set(c){const p=this.gl;p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,c),this.current=c,this.dirty=!1}}class un extends It{constructor(c){super(c),this.vao=c.extVertexArrayObject}getDefault(){return null}set(c){this.vao&&(c!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(c),this.current=c,this.dirty=!1)}}class ar extends It{getDefault(){return 4}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;p.pixelStorei(p.UNPACK_ALIGNMENT,c),this.current=c,this.dirty=!1}}class Jr extends It{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,c),this.current=c,this.dirty=!1}}class qr extends It{getDefault(){return!1}set(c){if(c===this.current&&!this.dirty)return;const p=this.gl;p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,c),this.current=c,this.dirty=!1}}class kr extends It{constructor(c,p){super(c),this.context=c,this.parent=p}getDefault(){return null}}class ye extends kr{setDirty(){this.dirty=!0}set(c){if(c===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const p=this.gl;p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,c,0),this.current=c,this.dirty=!1}}class qe extends kr{attachment(){return this.gl.DEPTH_ATTACHMENT}set(c){if(c===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const p=this.gl;p.framebufferRenderbuffer(p.FRAMEBUFFER,this.attachment(),p.RENDERBUFFER,c),this.current=c,this.dirty=!1}}class at extends qe{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class ne{constructor(c,p,x,T){this.context=c,this.width=p,this.height=x;const A=this.framebuffer=c.gl.createFramebuffer();this.colorAttachment=new ye(c,A),T&&(this.depthAttachment=new qe(c,A))}destroy(){const c=this.context.gl,p=this.colorAttachment.get();if(p&&c.deleteTexture(p),this.depthAttachment){const x=this.depthAttachment.get();x&&c.deleteRenderbuffer(x)}c.deleteFramebuffer(this.framebuffer)}}class H{constructor(c){this.gl=c,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new kt(this),this.clearDepth=new Ri(this),this.clearStencil=new Pi(this),this.colorMask=new zi(this),this.depthMask=new ht(this),this.stencilMask=new Gt(this),this.stencilFunc=new di(this),this.stencilOp=new si(this),this.stencilTest=new Ae(this),this.depthRange=new xt(this),this.depthTest=new Xt(this),this.depthFunc=new Nt(this),this.blend=new Yt(this),this.blendFunc=new ii(this),this.blendColor=new Rt(this),this.blendEquation=new Kt(this),this.cullFace=new Li(this),this.cullFaceSide=new Ii(this),this.frontFace=new Fi(this),this.program=new Xi(this),this.activeTexture=new rr(this),this.viewport=new Ki(this),this.bindFramebuffer=new Ci(this),this.bindRenderbuffer=new Ir(this),this.bindTexture=new mn(this),this.bindVertexBuffer=new gn(this),this.bindElementBuffer=new Er(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new un(this),this.pixelStoreUnpack=new ar(this),this.pixelStoreUnpackPremultiplyAlpha=new Jr(this),this.pixelStoreUnpackFlipY=new qr(this),this.extTextureFilterAnisotropic=c.getExtension("EXT_texture_filter_anisotropic")||c.getExtension("MOZ_EXT_texture_filter_anisotropic")||c.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=c.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extStandardDerivativesForceOff=!1,this.extDebugRendererInfo=c.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=c.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=c.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.extTextureHalfFloat=c.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(c.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=c.getExtension("EXT_color_buffer_half_float")),this.extStandardDerivatives=c.getExtension("OES_standard_derivatives"),this.extTimerQuery=c.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=c.getParameter(c.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(c,p){return new $i(this,c,p)}createVertexBuffer(c,p,x){return new mi(this,c,p,x)}createRenderbuffer(c,p,x){const T=this.gl,A=T.createRenderbuffer();return this.bindRenderbuffer.set(A),T.renderbufferStorage(T.RENDERBUFFER,c,p,x),this.bindRenderbuffer.set(null),A}createFramebuffer(c,p,x){return new ne(this,c,p,x)}clear({color:c,depth:p,stencil:x}){const T=this.gl;let A=0;c&&(A|=T.COLOR_BUFFER_BIT,this.clearColor.set(c),this.colorMask.set([!0,!0,!0,!0])),p!==void 0&&(A|=T.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(p),this.depthMask.set(!0)),x!==void 0&&(A|=T.STENCIL_BUFFER_BIT,this.clearStencil.set(x),this.stencilMask.set(255)),T.clear(A)}setCullFace(c){c.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(c.mode),this.frontFace.set(c.frontFace))}setDepthMode(c){c.func!==this.gl.ALWAYS||c.mask?(this.depthTest.set(!0),this.depthFunc.set(c.func),this.depthMask.set(c.mask),this.depthRange.set(c.range)):this.depthTest.set(!1)}setStencilMode(c){c.test.func!==this.gl.ALWAYS||c.mask?(this.stencilTest.set(!0),this.stencilMask.set(c.mask),this.stencilOp.set([c.fail,c.depthFail,c.pass]),this.stencilFunc.set({func:c.test.func,ref:c.ref,mask:c.test.mask})):this.stencilTest.set(!1)}setColorMode(c){b(c.blendFunction,o.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(c.blendFunction),this.blendColor.set(c.blendColor)),this.colorMask.set(c.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class te extends o.Evented{constructor(c,p,x,T){super(),this.id=c,this.dispatcher=x,this.setEventedParent(T),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=o.extend({type:"raster"},p),o.extend(this,o.pick(p,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new o.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=yt(this._options,this.map._requestManager,null,null,(c,p)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new o.ErrorEvent(c)):p&&(o.extend(this,p),p.bounds&&(this.tileBounds=new vi(p.bounds,this.minzoom,this.maxzoom)),o.postTurnstileEvent(p.tiles),this.fire(new o.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(c){this.map=c,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return o.extend({},this._options)}hasTile(c){return!this.tileBounds||this.tileBounds.contains(c.canonical)}loadTile(c,p){const x=o.exported.devicePixelRatio>=2,T=this.map._requestManager.normalizeTileURL(c.tileID.canonical.url(this.tiles,this.scheme),x,this.tileSize);c.request=o.getImage(this.map._requestManager.transformRequest(T,o.ResourceType.Tile),(A,k,O,F)=>(delete c.request,c.aborted?(c.state="unloaded",p(null)):A?(c.state="errored",p(A)):k?(this.map._refreshExpiredTiles&&c.setExpiryData({cacheControl:O,expires:F}),c.setTexture(k,this.map.painter),c.state="loaded",o.cacheEntryPossiblyAdded(this.dispatcher),void p(null)):p(null)))}static loadTileData(c,p,x){c.setTexture(p,x)}static unloadTileData(c,p){c.texture&&p.saveTileTexture(c.texture)}abortTile(c,p){c.request&&(c.request.cancel(),delete c.request),p()}unloadTile(c,p){c.texture&&this.map.painter.saveTileTexture(c.texture),p()}hasTransition(){return!1}}let pe;function we(g,c,p,x,T,A,k,O){const F=[g,p,T,c,x,A,1,1,1],V=[k,O,1],G=o.adjoint([],F),[ie,le,_e]=o.transformMat3(V,V,o.transpose(G,G));return o.multiply$1(F,[ie,0,0,0,le,0,0,0,_e],F)}class ke extends o.Evented{constructor(c,p,x,T){super(),this.id=c,this.dispatcher=x,this.coordinates=p.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(T),this.options=p,this._dirty=!1}load(c,p){this._loaded=p||!1,this.fire(new o.Event("dataloading",{dataType:"source"})),this.url=this.options.url,this._imageRequest=o.getImage(this.map._requestManager.transformRequest(this.url,o.ResourceType.Image),(x,T)=>{if(this._imageRequest=null,this._loaded=!0,x)this.fire(new o.ErrorEvent(x));else if(T){const{HTMLImageElement:A}=o.window;this.image=T instanceof A?o.exported.getImageData(T):T,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,c&&(this.coordinates=c),this._finishLoading()}})}loaded(){return this._loaded}updateImage(c){return this.image&&c.url?(this._imageRequest&&c.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=c.url,this.load(c.coordinates,this._loaded),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new o.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(c){this.map=c,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),this.texture&&this.texture.destroy()}setCoordinates(c){this.coordinates=c,this._boundsArray=void 0;const p=c.map(o.MercatorCoordinate.fromLngLat);return this.tileID=function(x){let T=1/0,A=1/0,k=-1/0,O=-1/0;for(const ie of x)T=Math.min(T,ie.x),A=Math.min(A,ie.y),k=Math.max(k,ie.x),O=Math.max(O,ie.y);const F=Math.max(k-T,O-A),V=Math.max(0,Math.floor(-Math.log(F)/Math.LN2)),G=Math.pow(2,V);return new o.CanonicalTileID(V,Math.floor((T+k)/2*G),Math.floor((A+O)/2*G))}(p),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new o.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(c){for(const F in this.tiles){const V=this.tiles[F];V.state!=="loaded"&&(V.state="loaded",V.texture=this.texture)}if(this._boundsArray)return;const p=o.tileTransform(this.tileID,this.map.transform.projection),[x,T,A,k]=this.coordinates.map(F=>{const V=p.projection.project(F[0],F[1]);return o.getTilePoint(p,V)._round()});this.perspectiveTransform=function(F,V,G,ie,le,_e,fe,ve,me,de){const be=we(0,0,F,0,0,V,F,V),ge=we(G,ie,le,_e,fe,ve,me,de);return o.multiply$1(ge,o.adjoint(be,be),ge),[ge[6]/ge[8]*F/o.EXTENT,ge[7]/ge[8]*V/o.EXTENT]}(this.width,this.height,x.x,x.y,T.x,T.y,k.x,k.y,A.x,A.y);const O=this._boundsArray=new o.StructArrayLayout4i8;O.emplaceBack(x.x,x.y,0,0),O.emplaceBack(T.x,T.y,o.EXTENT,0),O.emplaceBack(k.x,k.y,0,o.EXTENT),O.emplaceBack(A.x,A.y,o.EXTENT,o.EXTENT),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=c.createVertexBuffer(O,o.boundsAttributes.members),this.boundsSegments=o.SegmentVector.simpleSegment(0,0,4,2)}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const c=this.map.painter.context,p=c.gl;this._dirty&&(this.texture?this.texture.update(this.image):(this.texture=new o.Texture(c,this.image,p.RGBA),this.texture.bind(p.LINEAR,p.CLAMP_TO_EDGE)),this._dirty=!1),this._prepareData(c)}loadTile(c,p){this.tileID&&this.tileID.equals(c.tileID.canonical)?(this.tiles[String(c.tileID.wrap)]=c,c.buckets={},p(null)):(c.state="errored",p(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const $e={vector:class extends o.Evented{constructor(g,c,p,x){if(super(),this.id=g,this.dispatcher=p,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,o.extend(this,o.pick(c,["url","scheme","tileSize","promoteId"])),this._options=o.extend({type:"vector"},c),this._collectResourceTiming=c.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(x),this._tileWorkers={},this._deduped=new o.DedupedRequest}load(g){this._loaded=!1,this.fire(new o.Event("dataloading",{dataType:"source"}));const c=Array.isArray(this.map._language)?this.map._language.join():this.map._language,p=this.map._worldview;this._tileJSONRequest=yt(this._options,this.map._requestManager,c,p,(x,T)=>{this._tileJSONRequest=null,this._loaded=!0,x?(c&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${c}`),p&&p.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${p}`),this.fire(new o.ErrorEvent(x))):T&&(o.extend(this,T),T.bounds&&(this.tileBounds=new vi(T.bounds,this.minzoom,this.maxzoom)),o.postTurnstileEvent(T.tiles,this.map._requestManager._customAccessToken),this.fire(new o.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.Event("data",{dataType:"source",sourceDataType:"content"}))),g&&g(x)})}loaded(){return this._loaded}hasTile(g){return!this.tileBounds||this.tileBounds.contains(g.canonical)}onAdd(g){this.map=g,this.load()}reload(){this.cancelTileJSONRequest(),this.load(()=>{const g=this.map.style._getSourceCaches(this.id);for(const c of g)c.clearTiles()})}setSourceProperty(g){g(),this.reload()}setTiles(g){return this._options.tiles=g,this.reload(),this}setUrl(g){return this.url=g,this._options.url=g,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return o.extend({},this._options)}loadTile(g,c){const p=this.map._requestManager.normalizeTileURL(g.tileID.canonical.url(this.tiles,this.scheme)),x={request:this.map._requestManager.transformRequest(p,o.ResourceType.Tile),data:void 0,uid:g.uid,tileID:g.tileID,tileZoom:g.tileZoom,zoom:g.tileID.overscaledZ,tileSize:this.tileSize*g.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:o.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:g.isSymbolTile};if(x.request.collectResourceTiming=this._collectResourceTiming,g.actor&&g.state!=="expired")g.state==="loading"?g.reloadCallback=c:g.request=g.actor.send("reloadTile",x,T.bind(this));else if(g.actor=this._tileWorkers[p]=this._tileWorkers[p]||this.dispatcher.getActor(),this.dispatcher.ready)g.request=g.actor.send("loadTile",x,T.bind(this),void 0,!0);else{const A=o.loadVectorTile.call({deduped:this._deduped},x,(k,O)=>{k||!O?T.call(this,k):(x.data={cacheControl:O.cacheControl,expires:O.expires,rawData:O.rawData.slice(0)},g.actor&&g.actor.send("loadTile",x,T.bind(this),void 0,!0))},!0);g.request={cancel:A}}function T(A,k){return delete g.request,g.aborted?c(null):A&&A.status!==404?c(A):(k&&k.resourceTiming&&(g.resourceTiming=k.resourceTiming),this.map._refreshExpiredTiles&&k&&g.setExpiryData(k),g.loadVectorData(k,this.map.painter),o.cacheEntryPossiblyAdded(this.dispatcher),c(null),void(g.reloadCallback&&(this.loadTile(g,g.reloadCallback),g.reloadCallback=null)))}}abortTile(g){g.request&&(g.request.cancel(),delete g.request),g.actor&&g.actor.send("abortTile",{uid:g.uid,type:this.type,source:this.id})}unloadTile(g){g.unloadVectorData(),g.actor&&g.actor.send("removeTile",{uid:g.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}},raster:te,"raster-dem":class extends te{constructor(g,c,p,x){super(g,c,p,x),this.type="raster-dem",this.maxzoom=22,this._options=o.extend({type:"raster-dem"},c),this.encoding=c.encoding||"mapbox"}loadTile(g,c){const p=this.map._requestManager.normalizeTileURL(g.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function x(T,A){T&&(g.state="errored",c(T)),A&&(g.dem=A,g.dem.onDeserialize(),g.needsHillshadePrepare=!0,g.needsDEMTextureUpload=!0,g.state="loaded",c(null))}g.request=o.getImage(this.map._requestManager.transformRequest(p,o.ResourceType.Tile),function(T,A,k,O){if(delete g.request,g.aborted)g.state="unloaded",c(null);else if(T)g.state="errored",c(T);else if(A){this.map._refreshExpiredTiles&&g.setExpiryData({cacheControl:k,expires:O});const F=o.window.ImageBitmap&&A instanceof o.window.ImageBitmap&&(pe==null&&(pe=o.window.OffscreenCanvas&&new o.window.OffscreenCanvas(1,1).getContext("2d")&&typeof o.window.createImageBitmap=="function"),pe),V=1-(A.width-o.prevPowerOfTwo(A.width))/2;V<1||g.neighboringTiles||(g.neighboringTiles=this._getNeighboringTiles(g.tileID));const G=F?A:o.exported.getImageData(A,V),ie={uid:g.uid,coord:g.tileID,source:this.id,rawImageData:G,encoding:this.encoding,padding:V};g.actor&&g.state!=="expired"||(g.actor=this.dispatcher.getActor(),g.actor.send("loadDEMTile",ie,x.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(g){const c=g.canonical,p=Math.pow(2,c.z),x=(c.x-1+p)%p,T=c.x===0?g.wrap-1:g.wrap,A=(c.x+1+p)%p,k=c.x+1===p?g.wrap+1:g.wrap,O={};return O[new o.OverscaledTileID(g.overscaledZ,T,c.z,x,c.y).key]={backfilled:!1},O[new o.OverscaledTileID(g.overscaledZ,k,c.z,A,c.y).key]={backfilled:!1},c.y>0&&(O[new o.OverscaledTileID(g.overscaledZ,T,c.z,x,c.y-1).key]={backfilled:!1},O[new o.OverscaledTileID(g.overscaledZ,g.wrap,c.z,c.x,c.y-1).key]={backfilled:!1},O[new o.OverscaledTileID(g.overscaledZ,k,c.z,A,c.y-1).key]={backfilled:!1}),c.y+1<p&&(O[new o.OverscaledTileID(g.overscaledZ,T,c.z,x,c.y+1).key]={backfilled:!1},O[new o.OverscaledTileID(g.overscaledZ,g.wrap,c.z,c.x,c.y+1).key]={backfilled:!1},O[new o.OverscaledTileID(g.overscaledZ,k,c.z,A,c.y+1).key]={backfilled:!1}),O}unloadTile(g){g.demTexture&&this.map.painter.saveTileTexture(g.demTexture),g.fbo&&(g.fbo.destroy(),delete g.fbo),g.dem&&delete g.dem,delete g.neighboringTiles,g.state="unloaded"}},geojson:class extends o.Evented{constructor(g,c,p,x){super(),this.id=g,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=p.getActor(),this.setEventedParent(x),this._data=c.data,this._options=o.extend({},c),this._collectResourceTiming=c.collectResourceTiming,c.maxzoom!==void 0&&(this.maxzoom=c.maxzoom),c.type&&(this.type=c.type),c.attribution&&(this.attribution=c.attribution),this.promoteId=c.promoteId;const T=o.EXTENT/this.tileSize;this.workerOptions=o.extend({source:this.id,cluster:c.cluster||!1,geojsonVtOptions:{buffer:(c.buffer!==void 0?c.buffer:128)*T,tolerance:(c.tolerance!==void 0?c.tolerance:.375)*T,extent:o.EXTENT,maxZoom:this.maxzoom,lineMetrics:c.lineMetrics||!1,generateId:c.generateId||!1},superclusterOptions:{maxZoom:c.clusterMaxZoom!==void 0?c.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,c.clusterMinPoints||2),extent:o.EXTENT,radius:(c.clusterRadius!==void 0?c.clusterRadius:50)*T,log:!1,generateId:c.generateId||!1},clusterProperties:c.clusterProperties,filter:c.filter},c.workerOptions)}onAdd(g){this.map=g,this.setData(this._data)}setData(g){return this._data=g,this._updateWorkerData(),this}getClusterExpansionZoom(g,c){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:g,source:this.id},c),this}getClusterChildren(g,c){return this.actor.send("geojson.getClusterChildren",{clusterId:g,source:this.id},c),this}getClusterLeaves(g,c,p,x){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:g,limit:c,offset:p},x),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new o.Event("dataloading",{dataType:"source"})),this._loaded=!1;const g=o.extend({},this.workerOptions),c=this._data;typeof c=="string"?(g.request=this.map._requestManager.transformRequest(o.exported.resolveURL(c),o.ResourceType.Source),g.request.collectResourceTiming=this._collectResourceTiming):g.data=JSON.stringify(c),this._pendingLoad=this.actor.send(`${this.type}.loadData`,g,(p,x)=>{if(this._loaded=!0,this._pendingLoad=null,p)this.fire(new o.ErrorEvent(p));else{const T={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&x&&x.resourceTiming&&x.resourceTiming[this.id]&&(T.resourceTiming=x.resourceTiming[this.id]),this.fire(new o.Event("data",T)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(g,c){const p=g.actor?"reloadTile":"loadTile";g.actor=this.actor,g.request=this.actor.send(p,{type:this.type,uid:g.uid,tileID:g.tileID,tileZoom:g.tileZoom,zoom:g.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:o.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(x,T)=>(delete g.request,g.unloadVectorData(),g.aborted?c(null):x?c(x):(g.loadVectorData(T,this.map.painter,p==="reloadTile"),c(null))),void 0,p==="loadTile")}abortTile(g){g.request&&(g.request.cancel(),delete g.request),g.aborted=!0}unloadTile(g){g.unloadVectorData(),this.actor.send("removeTile",{uid:g.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return o.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends ke{constructor(g,c,p,x){super(g,c,p,x),this.roundZoom=!0,this.type="video",this.options=c}load(){this._loaded=!1;const g=this.options;this.urls=[];for(const c of g.urls)this.urls.push(this.map._requestManager.transformRequest(c,o.ResourceType.Source).url);o.getVideo(this.urls,(c,p)=>{this._loaded=!0,c?this.fire(new o.ErrorEvent(c)):p&&(this.video=p,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(g){if(this.video){const c=this.video.seekable;g<c.start(0)||g>c.end(0)?this.fire(new o.ErrorEvent(new o.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${c.start(0)} and ${c.end(0)}-second mark.`))):this.video.currentTime=g}}getVideo(){return this.video}onAdd(g){this.map||(this.map=g,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const g=this.map.painter.context,c=g.gl;this.texture?this.video.paused||(this.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE),c.texSubImage2D(c.TEXTURE_2D,0,0,0,c.RGBA,c.UNSIGNED_BYTE,this.video)):(this.texture=new o.Texture(g,this.video,c.RGBA),this.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(g)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:ke,canvas:class extends ke{constructor(g,c,p,x){super(g,c,p,x),c.coordinates?Array.isArray(c.coordinates)&&c.coordinates.length===4&&!c.coordinates.some(T=>!Array.isArray(T)||T.length!==2||T.some(A=>typeof A!="number"))||this.fire(new o.ErrorEvent(new o.ValidationError(`sources.${g}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new o.ErrorEvent(new o.ValidationError(`sources.${g}`,null,'missing required property "coordinates"'))),c.animate&&typeof c.animate!="boolean"&&this.fire(new o.ErrorEvent(new o.ValidationError(`sources.${g}`,null,'optional "animate" property must be a boolean value'))),c.canvas?typeof c.canvas=="string"||c.canvas instanceof o.window.HTMLCanvasElement||this.fire(new o.ErrorEvent(new o.ValidationError(`sources.${g}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new o.ErrorEvent(new o.ValidationError(`sources.${g}`,null,'missing required property "canvas"'))),this.options=c,this.animate=c.animate===void 0||c.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof o.window.HTMLCanvasElement?this.options.canvas:o.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new o.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(g){this.map=g,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let g=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,g=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,g=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const c=this.map.painter.context;this.texture?(g||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new o.Texture(c,this.canvas,c.gl.RGBA,{premultiply:!0}),this._prepareData(c)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const g of[this.canvas.width,this.canvas.height])if(isNaN(g)||g<=0)return!0;return!1}},custom:class extends o.Evented{constructor(g,c,p,x){super(),this.id=g,this.type="custom",this._dataType="raster",this._dispatcher=p,this._implementation=c,this.setEventedParent(x),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new o.ErrorEvent(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new o.ErrorEvent(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new vi(this._implementation.bounds,this.minzoom,this.maxzoom)),c.update=this._update.bind(this),c.clearTiles=this._clearTiles.bind(this),c.coveringTiles=this._coveringTiles.bind(this),o.extend(this,o.pick(c,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return o.pick(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new o.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.Event("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(g){this._map=g,this._loaded=!1,this.fire(new o.Event("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(g),this.load()}onRemove(g){this._implementation.onRemove&&this._implementation.onRemove(g)}hasTile(g){if(this._implementation.hasTile){const{x:c,y:p,z:x}=g.canonical;return this._implementation.hasTile({x:c,y:p,z:x})}return!this.tileBounds||this.tileBounds.contains(g.canonical)}loadTile(g,c){const{x:p,y:x,z:T}=g.tileID.canonical,A=new o.window.AbortController;g.request=Promise.resolve(this._implementation.loadTile({x:p,y:x,z:T},{signal:A.signal})).then(function(k){return delete g.request,g.aborted?(g.state="unloaded",c(null)):k===void 0?(g.state="errored",c(null)):k===null?(this.loadTileData(g,{width:this.tileSize,height:this.tileSize,data:null}),g.state="loaded",c(null)):function(O){return O instanceof o.window.ImageData||O instanceof o.window.HTMLCanvasElement||O instanceof o.window.ImageBitmap||O instanceof o.window.HTMLImageElement}(k)?(this.loadTileData(g,k),g.state="loaded",void c(null)):(g.state="errored",c(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch(k=>{k.code!==20&&(g.state="errored",c(k))}),g.request.cancel=()=>A.abort()}loadTileData(g,c){te.loadTileData(g,c,this._map.painter)}unloadTileData(g){te.unloadTileData(g,this._map.painter)}unloadTile(g,c){if(this.unloadTileData(g),this._implementation.unloadTile){const{x:p,y:x,z:T}=g.tileID.canonical;this._implementation.unloadTile({x:p,y:x,z:T})}c()}abortTile(g,c){g.request&&g.request.cancel&&(g.request.cancel(),delete g.request),c()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(g=>({x:g.canonical.x,y:g.canonical.y,z:g.canonical.z}))}_clearTiles(){this._map.style._clearSource(this.id)}_update(){this.fire(new o.Event("data",{dataType:"source",sourceDataType:"content"}))}}},Ge=function(g,c,p,x){const T=new $e[c.type](g,c,p,x);if(T.id!==g)throw new Error(`Expected Source id to be ${g} instead of ${T.id}`);return o.bindAll(["load","abort","unload","serialize","prepare"],T),T};function De(g,c){const p=o.identity([]);return o.scale(p,p,[.5*g.width,.5*-g.height,1]),o.translate(p,p,[1,-1,0]),o.multiply(p,p,g.calculateProjMatrix(c.toUnwrapped())),Float32Array.from(p)}function Ze(g,c,p,x,T,A,k,O=!1){const F=g.tilesIn(x,k,O);F.sort(Ut);const V=[];for(const ie of F)V.push({wrappedTileID:ie.tile.tileID.wrapped().key,queryResults:ie.tile.queryRenderedFeatures(c,p,g._state,ie,T,A,De(g.transform,ie.tile.tileID),O)});const G=function(ie){const le={},_e={};for(const fe of ie){const ve=fe.queryResults,me=fe.wrappedTileID,de=_e[me]=_e[me]||{};for(const be in ve){const ge=ve[be],Be=de[be]=de[be]||{},ze=le[be]=le[be]||[];for(const Me of ge)Be[Me.featureIndex]||(Be[Me.featureIndex]=!0,ze.push(Me))}}return le}(V);for(const ie in G)G[ie].forEach(le=>{const _e=le.feature,fe=_e.layer;fe&&fe.type!=="background"&&fe.type!=="sky"&&(_e.source=fe.source,fe["source-layer"]&&(_e.sourceLayer=fe["source-layer"]),_e.state=_e.id!==void 0?g.getFeatureState(fe["source-layer"],_e.id):{})});return G}function ut(g,c){const p=g.getRenderableIds().map(A=>g.getTileByID(A)),x=[],T={};for(let A=0;A<p.length;A++){const k=p[A],O=k.tileID.canonical.key;T[O]||(T[O]=!0,k.querySourceFeatures(x,c))}return x}function Ut(g,c){const p=g.tileID,x=c.tileID;return p.overscaledZ-x.overscaledZ||p.canonical.y-x.canonical.y||p.wrap-x.wrap||p.canonical.x-x.canonical.x}function ft(){return Us.workerClass!=null?new Us.workerClass:new o.window.Worker(Us.workerUrl)}const bi="mapboxgl_preloaded_worker_pool";class wi{constructor(){this.active={}}acquire(c){if(!this.workers)for(this.workers=[];this.workers.length<wi.workerCount;)this.workers.push(new ft);return this.active[c]=!0,this.workers.slice()}release(c){delete this.active[c],this.numActive()===0&&(this.workers.forEach(p=>{p.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[bi]}numActive(){return Object.keys(this.active).length}}let gi;function Di(){return gi||(gi=new wi),gi}function Hi(g,c){const p={};for(const x in g)x!=="ref"&&(p[x]=g[x]);return o.refProperties.forEach(x=>{x in c&&(p[x]=c[x])}),p}function Re(g){g=g.slice();const c=Object.create(null);for(let p=0;p<g.length;p++)c[g[p].id]=g[p];for(let p=0;p<g.length;p++)"ref"in g[p]&&(g[p]=Hi(g[p],c[g[p].ref]));return g}wi.workerCount=2;const vt={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function Pt(g,c,p){p.push({command:vt.addSource,args:[g,c[g]]})}function fi(g,c,p){c.push({command:vt.removeSource,args:[g]}),p[g]=!0}function dr(g,c,p,x){fi(g,p,x),Pt(g,c,p)}function sr(g,c,p){let x;for(x in g[p])if(g[p].hasOwnProperty(x)&&x!=="data"&&!b(g[p][x],c[p][x]))return!1;for(x in c[p])if(c[p].hasOwnProperty(x)&&x!=="data"&&!b(g[p][x],c[p][x]))return!1;return!0}function it(g,c,p,x,T,A){let k;for(k in c=c||{},g=g||{})g.hasOwnProperty(k)&&(b(g[k],c[k])||p.push({command:A,args:[x,k,c[k],T]}));for(k in c)c.hasOwnProperty(k)&&!g.hasOwnProperty(k)&&(b(g[k],c[k])||p.push({command:A,args:[x,k,c[k],T]}))}function Or(g){return g.id}function Fr(g,c){return g[c.id]=c,g}class Vr{constructor(c,p){this.reset(c,p)}reset(c,p){this.points=c||[],this._distances=[0];for(let x=1;x<this.points.length;x++)this._distances[x]=this._distances[x-1]+this.points[x].dist(this.points[x-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(p||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(c){if(this.points.length===1)return this.points[0];c=o.clamp(c,0,1);let p=1,x=this._distances[p];const T=c*this.paddedLength+this.padding;for(;x<T&&p<this._distances.length;)x=this._distances[++p];const A=p-1,k=this._distances[A],O=x-k,F=O>0?(T-k)/O:0;return this.points[A].mult(1-F).add(this.points[p].mult(F))}}class xs{constructor(c,p,x){const T=this.boxCells=[],A=this.circleCells=[];this.xCellCount=Math.ceil(c/x),this.yCellCount=Math.ceil(p/x);for(let k=0;k<this.xCellCount*this.yCellCount;k++)T.push([]),A.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=c,this.height=p,this.xScale=this.xCellCount/c,this.yScale=this.yCellCount/p,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(c,p,x,T,A){this._forEachCell(p,x,T,A,this._insertBoxCell,this.boxUid++),this.boxKeys.push(c),this.bboxes.push(p),this.bboxes.push(x),this.bboxes.push(T),this.bboxes.push(A)}insertCircle(c,p,x,T){this._forEachCell(p-T,x-T,p+T,x+T,this._insertCircleCell,this.circleUid++),this.circleKeys.push(c),this.circles.push(p),this.circles.push(x),this.circles.push(T)}_insertBoxCell(c,p,x,T,A,k){this.boxCells[A].push(k)}_insertCircleCell(c,p,x,T,A,k){this.circleCells[A].push(k)}_query(c,p,x,T,A,k){if(x<0||c>this.width||T<0||p>this.height)return!A&&[];const O=[];if(c<=0&&p<=0&&this.width<=x&&this.height<=T){if(A)return!0;for(let F=0;F<this.boxKeys.length;F++)O.push({key:this.boxKeys[F],x1:this.bboxes[4*F],y1:this.bboxes[4*F+1],x2:this.bboxes[4*F+2],y2:this.bboxes[4*F+3]});for(let F=0;F<this.circleKeys.length;F++){const V=this.circles[3*F],G=this.circles[3*F+1],ie=this.circles[3*F+2];O.push({key:this.circleKeys[F],x1:V-ie,y1:G-ie,x2:V+ie,y2:G+ie})}return k?O.filter(k):O}return this._forEachCell(c,p,x,T,this._queryCell,O,{hitTest:A,seenUids:{box:{},circle:{}}},k),A?O.length>0:O}_queryCircle(c,p,x,T,A){const k=c-x,O=c+x,F=p-x,V=p+x;if(O<0||k>this.width||V<0||F>this.height)return!T&&[];const G=[];return this._forEachCell(k,F,O,V,this._queryCellCircle,G,{hitTest:T,circle:{x:c,y:p,radius:x},seenUids:{box:{},circle:{}}},A),T?G.length>0:G}query(c,p,x,T,A){return this._query(c,p,x,T,!1,A)}hitTest(c,p,x,T,A){return this._query(c,p,x,T,!0,A)}hitTestCircle(c,p,x,T){return this._queryCircle(c,p,x,!0,T)}_queryCell(c,p,x,T,A,k,O,F){const V=O.seenUids,G=this.boxCells[A];if(G!==null){const le=this.bboxes;for(const _e of G)if(!V.box[_e]){V.box[_e]=!0;const fe=4*_e;if(c<=le[fe+2]&&p<=le[fe+3]&&x>=le[fe+0]&&T>=le[fe+1]&&(!F||F(this.boxKeys[_e]))){if(O.hitTest)return k.push(!0),!0;k.push({key:this.boxKeys[_e],x1:le[fe],y1:le[fe+1],x2:le[fe+2],y2:le[fe+3]})}}}const ie=this.circleCells[A];if(ie!==null){const le=this.circles;for(const _e of ie)if(!V.circle[_e]){V.circle[_e]=!0;const fe=3*_e;if(this._circleAndRectCollide(le[fe],le[fe+1],le[fe+2],c,p,x,T)&&(!F||F(this.circleKeys[_e]))){if(O.hitTest)return k.push(!0),!0;{const ve=le[fe],me=le[fe+1],de=le[fe+2];k.push({key:this.circleKeys[_e],x1:ve-de,y1:me-de,x2:ve+de,y2:me+de})}}}}}_queryCellCircle(c,p,x,T,A,k,O,F){const V=O.circle,G=O.seenUids,ie=this.boxCells[A];if(ie!==null){const _e=this.bboxes;for(const fe of ie)if(!G.box[fe]){G.box[fe]=!0;const ve=4*fe;if(this._circleAndRectCollide(V.x,V.y,V.radius,_e[ve+0],_e[ve+1],_e[ve+2],_e[ve+3])&&(!F||F(this.boxKeys[fe])))return k.push(!0),!0}}const le=this.circleCells[A];if(le!==null){const _e=this.circles;for(const fe of le)if(!G.circle[fe]){G.circle[fe]=!0;const ve=3*fe;if(this._circlesCollide(_e[ve],_e[ve+1],_e[ve+2],V.x,V.y,V.radius)&&(!F||F(this.circleKeys[fe])))return k.push(!0),!0}}}_forEachCell(c,p,x,T,A,k,O,F){const V=this._convertToXCellCoord(c),G=this._convertToYCellCoord(p),ie=this._convertToXCellCoord(x),le=this._convertToYCellCoord(T);for(let _e=V;_e<=ie;_e++)for(let fe=G;fe<=le;fe++)if(A.call(this,c,p,x,T,this.xCellCount*fe+_e,k,O,F))return}_convertToXCellCoord(c){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(c*this.xScale)))}_convertToYCellCoord(c){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(c*this.yScale)))}_circlesCollide(c,p,x,T,A,k){const O=T-c,F=A-p,V=x+k;return V*V>O*O+F*F}_circleAndRectCollide(c,p,x,T,A,k,O){const F=(k-T)/2,V=Math.abs(c-(T+F));if(V>F+x)return!1;const G=(O-A)/2,ie=Math.abs(p-(A+G));if(ie>G+x)return!1;if(V<=F||ie<=G)return!0;const le=V-F,_e=ie-G;return le*le+_e*_e<=x*x}}const Qn=Math.tan(85*Math.PI/180);function Cn(g,c,p,x,T,A,k){const O=o.create();if(p)if(A.name==="globe"){const F=o.calculateGlobeLabelMatrix(T,c);o.multiply(O,O,F)}else{const F=ce([],k);O[0]=F[0],O[1]=F[1],O[4]=F[2],O[5]=F[3],x||o.rotateZ(O,O,T.angle)}else o.multiply(O,T.labelPlaneMatrix,g);return O}function Hn(g,c,p,x,T,A,k){const O=Cn(g,c,p,x,T,A,k);return A.name==="globe"&&p||(O[2]=O[6]=O[10]=O[14]=0),O}function So(g,c,p,x,T,A,k){if(p){if(A.name==="globe"){const O=Cn(g,c,p,x,T,A,k);return o.invert(O,O),o.multiply(O,g,O),O}{const O=o.clone(g),F=o.identity([]);return F[0]=k[0],F[1]=k[1],F[4]=k[2],F[5]=k[3],o.multiply(O,O,F),x||o.rotateZ(O,O,-T.angle),O}}return T.glCoordMatrix}function Qt(g,c,p=0){const x=[g.x,g.y,p,1];p?o.transformMat4$1(x,x,c):j(x,x,c);const T=x[3];return{point:[x[0]/T,x[1]/T,x[2]/T],signedDistanceFromCamera:T}}function Wi(g,c){const p=[g[0],g[1],g[2],1];o.transformMat4$1(p,p,c);const x=p[3];return{point:[p[0]/x,p[1]/x,p[2]/x],signedDistanceFromCamera:x}}function ir(g,c){return Math.min(.5+g/c*.5,1.5)}function Jn(g,c){const p=g[0]/g[3],x=g[1]/g[3];return p>=-c[0]&&p<=c[0]&&x>=-c[1]&&x<=c[1]}function ia(g,c,p,x,T,A,k,O,F,V){const G=p.transform,ie=x?g.textSizeData:g.iconSizeData,le=o.evaluateSizeForZoom(ie,p.transform.zoom),_e=G.projection.name==="globe",fe=[256/p.width*2+1,256/p.height*2+1],ve=x?g.text.dynamicLayoutVertexArray:g.icon.dynamicLayoutVertexArray;ve.clear();let me=null;_e&&(me=x?g.text.globeExtVertexArray:g.icon.globeExtVertexArray);const de=g.lineVertexArray,be=x?g.text.placedSymbolArray:g.icon.placedSymbolArray,ge=p.transform.width/p.transform.height;let Be=!1;for(let ze=0;ze<be.length;ze++){const Me=be.get(ze);if(Me.writingMode!==o.WritingMode.vertical||Be||ze!==0&&be.get(ze-1).writingMode===o.WritingMode.horizontal||(Be=!0),(Me.hidden||Me.writingMode===o.WritingMode.vertical)&&!Be){B(Me.numGlyphs,ve);continue}Be=!1;const Fe=new o.pointGeometry(Me.tileAnchorX,Me.tileAnchorY),Je=F?F(Fe):[0,0,0],lt=G.projection.projectTilePoint(Fe.x,Fe.y,V.canonical),ot=[lt.x+Je[0],lt.y+Je[1],lt.z+Je[2]],zt=[...ot,1];if(o.transformMat4$1(zt,zt,c),!Jn(zt,fe)){B(Me.numGlyphs,ve);continue}const He=ir(p.transform.cameraToCenterDistance,zt[3]),wt=o.evaluateSizeForFeature(ie,le,Me),bt=k?wt/He:wt*He,tt=Qt(new o.pointGeometry(ot[0],ot[1]),T,ot[2]);if(tt.signedDistanceFromCamera<=0){B(Me.numGlyphs,ve);continue}let Ve={};const ri=k?null:F,qt=na(Me,bt,!1,O,c,T,A,g.glyphOffsetArray,de,ve,me,tt.point,Fe,Ve,ge,ri,G.projection,V,k);Be=qt.useVertical,ri&&qt.needsFlipping&&(Ve={}),(qt.notEnoughRoom||Be||qt.needsFlipping&&na(Me,bt,!0,O,c,T,A,g.glyphOffsetArray,de,ve,me,tt.point,Fe,Ve,ge,ri,G.projection,V,k).notEnoughRoom)&&B(Me.numGlyphs,ve)}x?(g.text.dynamicLayoutVertexBuffer.updateData(ve),me&&g.text.globeExtVertexBuffer.updateData(me)):(g.icon.dynamicLayoutVertexBuffer.updateData(ve),me&&g.icon.globeExtVertexBuffer.updateData(me))}function nr(g,c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve){const me=O.glyphStartIndex+O.numGlyphs,de=O.lineStartIndex,be=O.lineStartIndex+O.lineLength,ge=c.getoffsetX(O.glyphStartIndex),Be=c.getoffsetX(me-1),ze=Pr(g*ge,p,x,T,A,k,O.segment,de,be,F,V,G,ie,le,!0,_e,fe,ve);if(!ze)return null;const Me=Pr(g*Be,p,x,T,A,k,O.segment,de,be,F,V,G,ie,le,!0,_e,fe,ve);return Me?{first:ze,last:Me}:null}function ra(g,c,p,x){return g.writingMode===o.WritingMode.horizontal&&Math.abs(p.y-c.y)>Math.abs(p.x-c.x)*x?{useVertical:!0}:g.writingMode===o.WritingMode.vertical?c.y<p.y?{needsFlipping:!0}:null:g.flipState!==0&&function(T,A,k){const O=(A.x-T.x)*k;return O===0||Math.abs((A.y-T.y)/O)>Qn}(c,p,x)?g.flipState===1?{needsFlipping:!0}:null:c.x>p.x?{needsFlipping:!0}:null}function na(g,c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve,me,de,be){const ge=c/24,Be=g.lineOffsetX*ge,ze=g.lineOffsetY*ge;let Me=[];if(g.numGlyphs>1){const Fe=g.glyphStartIndex+g.numGlyphs,Je=g.lineStartIndex,lt=g.lineStartIndex+g.lineLength,ot=nr(ge,O,Be,ze,p,ie,le,g,F,A,_e,ve,!1,me,de,be);if(!ot)return{notEnoughRoom:!0};const zt=Wi(ot.first.point,k).point,He=Wi(ot.last.point,k).point,wt=new o.pointGeometry(zt[0],zt[1]),bt=new o.pointGeometry(He[0],He[1]);if(x&&!p){const tt=ra(g,wt,bt,fe);if(g.flipState=tt&&tt.needsFlipping?1:2,tt)return tt}Me=[ot.first];for(let tt=g.glyphStartIndex+1;tt<Fe-1;tt++){const Ve=Pr(ge*O.getoffsetX(tt),Be,ze,p,ie,le,g.segment,Je,lt,F,A,_e,ve,!1,!1,me,de,be);if(!Ve)return{notEnoughRoom:!0};Me.push(Ve)}Me.push(ot.last)}else{if(x&&!p){const Je=Qt(le,T).point,lt=g.lineStartIndex+g.segment+1,ot=new o.pointGeometry(F.getx(lt),F.gety(lt)),zt=Qt(ot,T),He=zt.signedDistanceFromCamera>0?zt.point:kn(le,ot,Je,1,T,void 0,me,de.canonical),wt=ra(g,new o.pointGeometry(Je[0],Je[1]),new o.pointGeometry(He[0],He[1]),fe);if(g.flipState=wt&&wt.needsFlipping?1:2,wt)return wt}const Fe=Pr(ge*O.getoffsetX(g.glyphStartIndex),Be,ze,p,ie,le,g.segment,g.lineStartIndex,g.lineStartIndex+g.lineLength,F,A,_e,ve,!1,!1,me,de,be);if(!Fe)return{notEnoughRoom:!0};Me=[Fe]}if(G)for(const Fe of Me)o.updateGlobeVertexNormal(G,V.length+0,Fe.up[0],Fe.up[1],Fe.up[2]),o.updateGlobeVertexNormal(G,V.length+1,Fe.up[0],Fe.up[1],Fe.up[2]),o.updateGlobeVertexNormal(G,V.length+2,Fe.up[0],Fe.up[1],Fe.up[2]),o.updateGlobeVertexNormal(G,V.length+3,Fe.up[0],Fe.up[1],Fe.up[2]),o.addDynamicAttributes(V,Fe.point[0],Fe.point[1],Fe.point[2],Fe.angle);else for(const Fe of Me)o.addDynamicAttributes(V,Fe.point[0],Fe.point[1],Fe.point[2],Fe.angle);return{}}function oa(g,c,p,x,T){const A=x.projectTilePoint(g.x,g.y,c);if(!T)return Qt(A,p,A.z);const k=T(g);return Qt(new o.pointGeometry(A.x+k[0],A.y+k[1]),p,A.z+k[2])}function kn(g,c,p,x,T,A,k,O){const F=oa(g.add(g.sub(c)._unit()),O,T,k,A).point,V=o.sub([],p,F);return o.scaleAndAdd([],p,V,x/o.length(V))}function Pr(g,c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve,me,de){const be=x?g-c:g+c;let ge=be>0?1:-1,Be=0;x&&(ge*=-1,Be=Math.PI),ge<0&&(Be+=Math.PI);let ze=ge>0?O+k:O+k+1,Me=T,Fe=T,Je=0,lt=0;const ot=Math.abs(be),zt=[],He=[];let wt=A;const bt=()=>{const Wt=ze-ge;return Je===0?A:new o.pointGeometry(V.getx(Wt),V.gety(Wt))},tt=()=>{const Wt=bt();return kn(Wt,wt||Wt,Fe,ot-Je+1,G,le,ve,me.canonical)};for(;Je+lt<=ot;){if(ze+=ge,ze<O||ze>=F)return null;if(Fe=Me,zt.push(Me),_e&&He.push(wt||bt()),Me=ie[ze],Me===void 0){wt=new o.pointGeometry(V.getx(ze),V.gety(ze));const Wt=oa(wt,me.canonical,G,ve,le);Me=Wt.signedDistanceFromCamera>0?ie[ze]=Wt.point:tt()}else wt=null;Je+=lt,lt=o.distance(Fe,Me)}wt=wt||new o.pointGeometry(V.getx(ze),V.gety(ze));const Ve=bt();fe&&le&&(ie[ze]=Me=ie[ze]===void 0?Me:tt(),lt=o.distance(Fe,Me));const ri=(ot-Je)/lt,qt=wt.sub(Ve).mult(ri)._add(Ve),Jt=o.sub([],Me,Fe),Ht=o.scaleAndAdd([],Fe,Jt,ri);let Ai=[0,0,1],Vi=Jt[0],Ni=Jt[1];if(de&&(Ai=ve.upVector(me.canonical,qt.x,qt.y),Ai[0]!==0||Ai[1]!==0||Ai[2]!==1)){const Wt=[1,0,0],Zi=[0,1,0];Wt[0]=Ai[2],Wt[1]=0,Wt[2]=-Ai[0],o.cross(Zi,Ai,Wt),o.normalize(Wt,Wt),o.normalize(Zi,Zi),Vi=o.dot(Jt,Wt),Ni=o.dot(Jt,Zi)}if(p){const Wt=o.cross([],Ai,Jt);o.normalize(Wt,Wt),o.scaleAndAdd(Ht,Ht,Wt,p*ge)}const Bi=Be+Math.atan2(Ni,Vi);return zt.push(Ht),_e&&He.push(qt),{point:Ht,angle:Bi,path:zt,tilePath:He,up:Ai}}const Qs=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function B(g,c){for(let p=0;p<g;p++){const x=c.length;c.resize(x+4),c.float32.set(Qs,4*x)}}function j(g,c,p){const x=c[0],T=c[1];return g[0]=p[0]*x+p[4]*T+p[12],g[1]=p[1]*x+p[5]*T+p[13],g[3]=p[3]*x+p[7]*T+p[15],g}const ae=100;class Ue{constructor(c,p,x=new xs(c.width+200,c.height+200,25),T=new xs(c.width+200,c.height+200,25)){this.transform=c,this.grid=x,this.ignoredGrid=T,this.pitchfactor=Math.cos(c._pitch)*c.cameraToCenterDistance,this.screenRightBoundary=c.width+ae,this.screenBottomBoundary=c.height+ae,this.gridRightBoundary=c.width+200,this.gridBottomBoundary=c.height+200,this.fogState=p}placeCollisionBox(c,p,x,T,A,k,O,F){let V=x.projectedAnchorX,G=x.projectedAnchorY,ie=x.projectedAnchorZ;const le=x.elevation,_e=x.tileID;if(le&&_e){const ze=c.getProjection().upVector(_e.canonical,x.tileAnchorX,x.tileAnchorY),Me=c.getProjection().upVectorScale(_e.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;V+=ze[0]*le*Me,G+=ze[1]*le*Me,ie+=ze[2]*le*Me}const fe=this.projectAndGetPerspectiveRatio(O,[V,G,ie],x.tileID,c.projection.name==="globe"||!!le||this.transform.pitch>0,c.getProjection()),ve=k*fe.perspectiveRatio,me=(x.x1*p+T.x-x.padding)*ve+fe.point.x,de=(x.y1*p+T.y-x.padding)*ve+fe.point.y,be=(x.x2*p+T.x+x.padding)*ve+fe.point.x,ge=(x.y2*p+T.y+x.padding)*ve+fe.point.y,Be=fe.perspectiveRatio<=.55||fe.occluded;return!this.isInsideGrid(me,de,be,ge)||!A&&this.grid.hitTest(me,de,be,ge,F)||Be?{box:[],offscreen:!1,occluded:fe.occluded}:{box:[me,de,be,ge],offscreen:this.isOffscreen(me,de,be,ge),occluded:!1}}placeCollisionCircles(c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve){const me=[],de=this.transform.elevation,be=de?de.getAtTileOffsetFunc(ve,this.transform.center.lat,this.transform.worldSize,c.getProjection()):Ve=>[0,0,0],ge=new o.pointGeometry(x.tileAnchorX,x.tileAnchorY),Be=c.getProjection().projectTilePoint(x.tileAnchorX,x.tileAnchorY,ve.canonical),ze=be(ge),Me=[Be.x+ze[0],Be.y+ze[1],Be.z+ze[2]],Fe=c.projection.name==="globe",Je=this.projectAndGetPerspectiveRatio(O,[Me[0],Me[1],Me[2]],ve,Fe||!!de||this.transform.pitch>0,c.getProjection()),{perspectiveRatio:lt}=Je,ot=(ie?k/lt:k*lt)/o.ONE_EM,zt=Qt(new o.pointGeometry(Me[0],Me[1]),F,Me[2]).point,He=Je.signedDistanceFromCamera>0?nr(ot,A,x.lineOffsetX*ot,x.lineOffsetY*ot,!1,zt,ge,x,T,F,{},de&&!ie?be:null,ie&&!!de,c.getProjection(),ve,ie):null;let wt=!1,bt=!1,tt=!0;if(He&&!Je.occluded){const Ve=.5*_e*lt+fe,ri=new o.pointGeometry(-100,-100),qt=new o.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),Jt=new Vr,Ht=He.first,Ai=He.last;let Vi=[];for(let Wt=Ht.path.length-1;Wt>=1;Wt--)Vi.push(Ht.path[Wt]);for(let Wt=1;Wt<Ai.path.length;Wt++)Vi.push(Ai.path[Wt]);const Ni=2.5*Ve;if(V){const Wt=Vi.map(de&&!Fe?(Zi,er)=>{const Tr=be(er<Ht.path.length-1?Ht.tilePath[Ht.path.length-1-er]:Ai.tilePath[er-Ht.path.length+2]);return Zi[2]=Tr[2],Wi(Zi,V)}:Zi=>Wi(Zi,V));Vi=Wt.some(Zi=>Zi.signedDistanceFromCamera<=0)?[]:Wt.map(Zi=>Zi.point)}let Bi=[];if(Vi.length>0){const Wt=Vi.map(vr=>new o.pointGeometry(vr[0],vr[1]));let Zi=1/0,er=-1/0,Tr=1/0,Sr=-1/0;for(let vr=0;vr<Wt.length;vr++)Zi=Math.min(Zi,Wt[vr].x),Tr=Math.min(Tr,Wt[vr].y),er=Math.max(er,Wt[vr].x),Sr=Math.max(Sr,Wt[vr].y);Bi=Zi>=ri.x&&er<=qt.x&&Tr>=ri.y&&Sr<=qt.y?[Wt]:er<ri.x||Zi>qt.x||Sr<ri.y||Tr>qt.y?[]:o.clipLine([Wt],ri.x,ri.y,qt.x,qt.y)}for(const Wt of Bi){Jt.reset(Wt,.25*Ve);let Zi=0;Zi=Jt.length<=.5*Ve?1:Math.ceil(Jt.paddedLength/Ni)+1;for(let er=0;er<Zi;er++){const Tr=er/Math.max(Zi-1,1),Sr=Jt.lerp(Tr),vr=Sr.x+ae,fn=Sr.y+ae;me.push(vr,fn,Ve,0);const Rn=vr-Ve,Po=fn-Ve,Nr=vr+Ve,Hr=fn+Ve;if(tt=tt&&this.isOffscreen(Rn,Po,Nr,Hr),bt=bt||this.isInsideGrid(Rn,Po,Nr,Hr),!p&&this.grid.hitTestCircle(vr,fn,Ve,le)&&(wt=!0,!G))return{circles:[],offscreen:!1,collisionDetected:wt,occluded:!1}}}}return{circles:!G&&wt||!bt?[]:me,offscreen:tt,collisionDetected:wt,occluded:Je.occluded}}queryRenderedSymbols(c){if(c.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const p=[];let x=1/0,T=1/0,A=-1/0,k=-1/0;for(const G of c){const ie=new o.pointGeometry(G.x+ae,G.y+ae);x=Math.min(x,ie.x),T=Math.min(T,ie.y),A=Math.max(A,ie.x),k=Math.max(k,ie.y),p.push(ie)}const O=this.grid.query(x,T,A,k).concat(this.ignoredGrid.query(x,T,A,k)),F={},V={};for(const G of O){const ie=G.key;if(F[ie.bucketInstanceId]===void 0&&(F[ie.bucketInstanceId]={}),F[ie.bucketInstanceId][ie.featureIndex])continue;const le=[new o.pointGeometry(G.x1,G.y1),new o.pointGeometry(G.x2,G.y1),new o.pointGeometry(G.x2,G.y2),new o.pointGeometry(G.x1,G.y2)];o.polygonIntersectsPolygon(p,le)&&(F[ie.bucketInstanceId][ie.featureIndex]=!0,V[ie.bucketInstanceId]===void 0&&(V[ie.bucketInstanceId]=[]),V[ie.bucketInstanceId].push(ie.featureIndex))}return V}insertCollisionBox(c,p,x,T,A){(p?this.ignoredGrid:this.grid).insert({bucketInstanceId:x,featureIndex:T,collisionGroupID:A},c[0],c[1],c[2],c[3])}insertCollisionCircles(c,p,x,T,A){const k=p?this.ignoredGrid:this.grid,O={bucketInstanceId:x,featureIndex:T,collisionGroupID:A};for(let F=0;F<c.length;F+=4)k.insertCircle(O,c[F],c[F+1],c[F+2])}projectAndGetPerspectiveRatio(c,p,x,T,A){const k=[p[0],p[1],p[2],1];let O=!1;if(p[2]||this.transform.pitch>0){o.transformMat4$1(k,k,c);const F=A.name==="globe";this.fogState&&x&&!F&&(O=function(V,G,ie,le,_e,fe){const ve=fe.calculateFogTileMatrix(_e),me=[G,ie,le];return o.transformMat4(me,me,ve),$t(V,me,fe.pitch,fe._fov)}(this.fogState,p[0],p[1],p[2],x.toUnwrapped(),this.transform)>.9)}else j(k,k,c);return{point:new o.pointGeometry((k[0]/k[3]+1)/2*this.transform.width+ae,(-k[1]/k[3]+1)/2*this.transform.height+ae),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(A)/k[3]*.5,1.5),signedDistanceFromCamera:k[3],occluded:T&&k[2]>k[3]||O}}isOffscreen(c,p,x,T){return x<ae||c>=this.screenRightBoundary||T<ae||p>this.screenBottomBoundary}isInsideGrid(c,p,x,T){return x>=0&&c<this.gridRightBoundary&&T>=0&&p<this.gridBottomBoundary}getViewportMatrix(){const c=o.identity([]);return o.translate(c,c,[-100,-100,0]),c}}function nt(g,c,p){const x=c.createTileMatrix(g,g.worldSize,p.toUnwrapped());return o.multiply(new Float32Array(16),g.projMatrix,x)}function Ye(g,c,p){if(c.projection.name===p.projection.name)return g.projMatrix;const x=p.clone();return x.setProjection(c.projection),nt(x,c.getProjection(),g)}function et(g,c,p){return c.name===p.projection.name?g.projMatrix:nt(p,c,g)}class jt{constructor(c,p,x,T){this.opacity=c?Math.max(0,Math.min(1,c.opacity+(c.placed?p:-p))):T&&x?1:0,this.placed=x}isHidden(){return this.opacity===0&&!this.placed}}class Ot{constructor(c,p,x,T,A,k=!1){this.text=new jt(c?c.text:null,p,x,A),this.icon=new jt(c?c.icon:null,p,T,A),this.clipped=k}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ei{constructor(c,p,x,T=!1){this.text=c,this.icon=p,this.skipFade=x,this.clipped=T}}class Ke{constructor(){this.invProjMatrix=o.create(),this.viewportMatrix=o.create(),this.circles=[]}}class ci{constructor(c,p,x,T,A){this.bucketInstanceId=c,this.featureIndex=p,this.sourceLayerIndex=x,this.bucketIndex=T,this.tileID=A}}class Ei{constructor(c){this.crossSourceCollisions=c,this.maxGroupID=0,this.collisionGroups={}}get(c){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[c]){const p=++this.maxGroupID;this.collisionGroups[c]={ID:p,predicate:x=>x.collisionGroupID===p}}return this.collisionGroups[c]}}function Mi(g,c,p,x,T){const{horizontalAlign:A,verticalAlign:k}=o.getAnchorAlignment(g),O=-(A-.5)*c,F=-(k-.5)*p,V=o.evaluateVariableOffset(g,x);return new o.pointGeometry(O+V[0]*T,F+V[1]*T)}function Oi(g,c,p,x,T){const A=new o.pointGeometry(g,c);return p&&A._rotate(x?T:-T),A}class Yr{constructor(c,p,x,T,A){this.transform=c.clone(),this.projection=c.projection.name,this.collisionIndex=new Ue(this.transform,A),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=p,this.retainedQueryData={},this.collisionGroups=new Ei(x),this.collisionCircleArrays={},this.prevPlacement=T,T&&(T.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(c,p,x,T){const A=x.getBucket(p),k=x.latestFeatureIndex;if(!A||!k||p.id!==A.layerIds[0])return;const O=A.layers[0].layout,F=x.collisionBoxArray,V=Math.pow(2,this.transform.zoom-x.tileID.overscaledZ),G=x.tileSize/o.EXTENT,ie=x.tileID.toUnwrapped();this.transform.setProjection(A.projection);const le=(_e=x.tileID,fe=A.getProjection(),ve=this.transform,fe.name===this.projection?ve.calculateProjMatrix(_e.toUnwrapped()):nt(ve,fe,_e));var _e,fe,ve;const me=O.get("text-pitch-alignment")==="map",de=O.get("text-rotation-alignment")==="map";p.compileFilter();const be=p.dynamicFilter(),ge=p.dynamicFilterNeedsFeature(),Be=this.transform.calculatePixelsToTileUnitsMatrix(x),ze=Hn(le,x.tileID.canonical,me,de,this.transform,A.getProjection(),Be);let Me=null;if(me){const lt=So(le,x.tileID.canonical,me,de,this.transform,A.getProjection(),Be);Me=o.multiply([],this.transform.labelPlaneMatrix,lt)}let Fe=null;be&&x.latestFeatureIndex&&(Fe={unwrappedTileID:ie,dynamicFilter:be,dynamicFilterNeedsFeature:ge,featureIndex:x.latestFeatureIndex}),this.retainedQueryData[A.bucketInstanceId]=new ci(A.bucketInstanceId,k,A.sourceLayerIndex,A.index,x.tileID);const Je={bucket:A,layout:O,posMatrix:le,textLabelPlaneMatrix:ze,labelToScreenMatrix:Me,clippingData:Fe,scale:V,textPixelRatio:G,holdingForFade:x.holdingForFade(),collisionBoxArray:F,partiallyEvaluatedTextSize:o.evaluateSizeForZoom(A.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:o.evaluateSizeForZoom(A.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(A.sourceID)};if(T)for(const lt of A.sortKeyRanges){const{sortKey:ot,symbolInstanceStart:zt,symbolInstanceEnd:He}=lt;c.push({sortKey:ot,symbolInstanceStart:zt,symbolInstanceEnd:He,parameters:Je})}else c.push({symbolInstanceStart:0,symbolInstanceEnd:A.symbolInstances.length,parameters:Je})}attemptAnchorPlacement(c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve,me,de,be){const ge=[le.textOffset0,le.textOffset1],Be=Mi(c,x,T,ge,A),ze=this.collisionIndex.placeCollisionBox(fe,A,p,Oi(Be.x,Be.y,k,O,this.transform.angle),ie,F,V,G.predicate);if(me){const Me=fe.getSymbolInstanceIconSize(be,this.transform.zoom,le.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(fe,Me,me,Oi(Be.x,Be.y,k,O,this.transform.angle),ie,F,V,G.predicate).box.length===0)return}if(ze.box.length>0){let Me;return this.prevPlacement&&this.prevPlacement.variableOffsets[le.crossTileID]&&this.prevPlacement.placements[le.crossTileID]&&this.prevPlacement.placements[le.crossTileID].text&&(Me=this.prevPlacement.variableOffsets[le.crossTileID].anchor),this.variableOffsets[le.crossTileID]={textOffset:ge,width:x,height:T,anchor:c,textScale:A,prevAnchor:Me},this.markUsedJustification(fe,c,le,ve),fe.allowVerticalPlacement&&(this.markUsedOrientation(fe,ve,le),this.placedOrientations[le.crossTileID]=ve),{shift:Be,placedGlyphBoxes:ze}}}placeLayerBucketPart(c,p,x,T){const{bucket:A,layout:k,posMatrix:O,textLabelPlaneMatrix:F,labelToScreenMatrix:V,clippingData:G,textPixelRatio:ie,holdingForFade:le,collisionBoxArray:_e,partiallyEvaluatedTextSize:fe,partiallyEvaluatedIconSize:ve,collisionGroup:me}=c.parameters,de=k.get("text-optional"),be=k.get("icon-optional"),ge=k.get("text-allow-overlap"),Be=k.get("icon-allow-overlap"),ze=k.get("text-rotation-alignment")==="map",Me=k.get("text-pitch-alignment")==="map",Fe=k.get("icon-text-fit")!=="none",Je=k.get("symbol-z-order")==="viewport-y";this.transform.setProjection(A.projection);let lt=ge&&(Be||!A.hasIconData()||be),ot=Be&&(ge||!A.hasTextData()||de);!A.collisionArrays&&_e&&A.deserializeCollisionBoxes(_e),x&&T&&A.updateCollisionDebugBuffers(this.transform.zoom,_e);const zt=(He,wt,bt)=>{if(G){const Nr={zoom:this.transform.zoom,pitch:this.transform.pitch};let Hr=null;if(G.dynamicFilterNeedsFeature){const xr=this.retainedQueryData[A.bucketInstanceId];Hr=G.featureIndex.loadFeature({featureIndex:He.featureIndex,bucketIndex:xr.bucketIndex,sourceLayerIndex:xr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,G.dynamicFilter)(Nr,Hr,this.retainedQueryData[A.bucketInstanceId].tileID.canonical,new o.pointGeometry(He.tileAnchorX,He.tileAnchorY),this.transform.calculateDistanceTileData(G.unwrappedTileID)))return this.placements[He.crossTileID]=new ei(!1,!1,!1,!0),void(p[He.crossTileID]=!0)}if(p[He.crossTileID])return;if(le)return void(this.placements[He.crossTileID]=new ei(!1,!1,!1));let tt=!1,Ve=!1,ri=!0,qt=!1,Jt=!1,Ht=null,Ai={box:null,offscreen:null,occluded:null},Vi={box:null,offscreen:null,occluded:null},Ni=null,Bi=null,Wt=null,Zi=0,er=0,Tr=0;bt.textFeatureIndex?Zi=bt.textFeatureIndex:He.useRuntimeCollisionCircles&&(Zi=He.featureIndex),bt.verticalTextFeatureIndex&&(er=bt.verticalTextFeatureIndex);const Sr=Nr=>{Nr.tileID=this.retainedQueryData[A.bucketInstanceId].tileID,(this.transform.elevation||Nr.elevation)&&(Nr.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[A.bucketInstanceId].tileID,Nr.tileAnchorX,Nr.tileAnchorY):0)},vr=bt.textBox;if(vr){Sr(vr);const Nr=xr=>{let rn=o.WritingMode.horizontal;if(A.allowVerticalPlacement&&!xr&&this.prevPlacement){const Mn=this.prevPlacement.placedOrientations[He.crossTileID];Mn&&(this.placedOrientations[He.crossTileID]=Mn,rn=Mn,this.markUsedOrientation(A,rn,He))}return rn},Hr=(xr,rn)=>{if(A.allowVerticalPlacement&&He.numVerticalGlyphVertices>0&&bt.verticalTextBox){for(const Mn of A.writingModes)if(Mn===o.WritingMode.vertical?(Ai=rn(),Vi=Ai):Ai=xr(),Ai&&Ai.box&&Ai.box.length)break}else Ai=xr()};if(k.get("text-variable-anchor")){let xr=k.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[He.crossTileID]){const Rr=this.prevPlacement.variableOffsets[He.crossTileID];xr.indexOf(Rr.anchor)>0&&(xr=xr.filter(jn=>jn!==Rr.anchor),xr.unshift(Rr.anchor))}const rn=(Rr,jn,Fa)=>{const vo=A.getSymbolInstanceTextSize(fe,He,this.transform.zoom,wt),Ln=(Rr.x2-Rr.x1)*vo+2*Rr.padding,ls=(Rr.y2-Rr.y1)*vo+2*Rr.padding,_a=Fe&&!Be?jn:null;_a&&Sr(_a);let xn={box:[],offscreen:!1,occluded:!1};const Do=ge?2*xr.length:xr.length;for(let ya=0;ya<Do;++ya){const bo=this.attemptAnchorPlacement(xr[ya%xr.length],Rr,Ln,ls,vo,ze,Me,ie,O,me,ya>=xr.length,He,wt,A,Fa,_a,fe,ve);if(bo&&(xn=bo.placedGlyphBoxes,xn&&xn.box&&xn.box.length)){tt=!0,Ht=bo.shift;break}}return xn};Hr(()=>rn(vr,bt.iconBox,o.WritingMode.horizontal),()=>{const Rr=bt.verticalTextBox;return Rr&&Sr(Rr),A.allowVerticalPlacement&&!(Ai&&Ai.box&&Ai.box.length)&&He.numVerticalGlyphVertices>0&&Rr?rn(Rr,bt.verticalIconBox,o.WritingMode.vertical):{box:null,offscreen:null,occluded:null}}),Ai&&(tt=Ai.box,ri=Ai.offscreen,qt=Ai.occluded);const Mn=Nr(Ai&&Ai.box);if(!tt&&this.prevPlacement){const Rr=this.prevPlacement.variableOffsets[He.crossTileID];Rr&&(this.variableOffsets[He.crossTileID]=Rr,this.markUsedJustification(A,Rr.anchor,He,Mn))}}else{const xr=(rn,Mn)=>{const Rr=A.getSymbolInstanceTextSize(fe,He,this.transform.zoom,wt),jn=this.collisionIndex.placeCollisionBox(A,Rr,rn,new o.pointGeometry(0,0),ge,ie,O,me.predicate);return jn&&jn.box&&jn.box.length&&(this.markUsedOrientation(A,Mn,He),this.placedOrientations[He.crossTileID]=Mn),jn};Hr(()=>xr(vr,o.WritingMode.horizontal),()=>{const rn=bt.verticalTextBox;return A.allowVerticalPlacement&&He.numVerticalGlyphVertices>0&&rn?(Sr(rn),xr(rn,o.WritingMode.vertical)):{box:null,offscreen:null,occluded:null}}),Nr(Ai&&Ai.box&&Ai.box.length)}}if(Ni=Ai,tt=Ni&&Ni.box&&Ni.box.length>0,ri=Ni&&Ni.offscreen,qt=Ni&&Ni.occluded,He.useRuntimeCollisionCircles){const Nr=A.text.placedSymbolArray.get(He.centerJustifiedTextSymbolIndex>=0?He.centerJustifiedTextSymbolIndex:He.verticalPlacedTextSymbolIndex),Hr=o.evaluateSizeForFeature(A.textSizeData,fe,Nr),xr=k.get("text-padding");Bi=this.collisionIndex.placeCollisionCircles(A,ge,Nr,A.lineVertexArray,A.glyphOffsetArray,Hr,O,F,V,x,Me,me.predicate,He.collisionCircleDiameter*Hr/o.ONE_EM,xr,this.retainedQueryData[A.bucketInstanceId].tileID),tt=ge||Bi.circles.length>0&&!Bi.collisionDetected,ri=ri&&Bi.offscreen,qt=Bi.occluded}if(bt.iconFeatureIndex&&(Tr=bt.iconFeatureIndex),bt.iconBox){const Nr=Hr=>{Sr(Hr);const xr=Fe&&Ht?Oi(Ht.x,Ht.y,ze,Me,this.transform.angle):new o.pointGeometry(0,0),rn=A.getSymbolInstanceIconSize(ve,this.transform.zoom,He.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(A,rn,Hr,xr,Be,ie,O,me.predicate)};Vi&&Vi.box&&Vi.box.length&&bt.verticalIconBox?(Wt=Nr(bt.verticalIconBox),Ve=Wt.box.length>0):(Wt=Nr(bt.iconBox),Ve=Wt.box.length>0),ri=ri&&Wt.offscreen,Jt=Wt.occluded}const fn=de||He.numHorizontalGlyphVertices===0&&He.numVerticalGlyphVertices===0,Rn=be||He.numIconVertices===0;if(fn||Rn?Rn?fn||(Ve=Ve&&tt):tt=Ve&&tt:Ve=tt=Ve&&tt,tt&&Ni&&Ni.box&&this.collisionIndex.insertCollisionBox(Ni.box,k.get("text-ignore-placement"),A.bucketInstanceId,Vi&&Vi.box&&er?er:Zi,me.ID),Ve&&Wt&&this.collisionIndex.insertCollisionBox(Wt.box,k.get("icon-ignore-placement"),A.bucketInstanceId,Tr,me.ID),Bi&&(tt&&this.collisionIndex.insertCollisionCircles(Bi.circles,k.get("text-ignore-placement"),A.bucketInstanceId,Zi,me.ID),x)){const Nr=A.bucketInstanceId;let Hr=this.collisionCircleArrays[Nr];Hr===void 0&&(Hr=this.collisionCircleArrays[Nr]=new Ke);for(let xr=0;xr<Bi.circles.length;xr+=4)Hr.circles.push(Bi.circles[xr+0]),Hr.circles.push(Bi.circles[xr+1]),Hr.circles.push(Bi.circles[xr+2]),Hr.circles.push(Bi.collisionDetected?1:0)}const Po=A.projection.name!=="globe";lt=lt&&(Po||!qt),ot=ot&&(Po||!Jt),this.placements[He.crossTileID]=new ei(tt||lt,Ve||ot,ri||A.justReloaded),p[He.crossTileID]=!0};if(Je){const He=A.getSortedSymbolIndexes(this.transform.angle);for(let wt=He.length-1;wt>=0;--wt){const bt=He[wt];zt(A.symbolInstances.get(bt),bt,A.collisionArrays[bt])}}else for(let He=c.symbolInstanceStart;He<c.symbolInstanceEnd;He++)zt(A.symbolInstances.get(He),He,A.collisionArrays[He]);if(x&&A.bucketInstanceId in this.collisionCircleArrays){const He=this.collisionCircleArrays[A.bucketInstanceId];o.invert(He.invProjMatrix,O),He.viewportMatrix=this.collisionIndex.getViewportMatrix()}A.justReloaded=!1}markUsedJustification(c,p,x,T){let A;A=T===o.WritingMode.vertical?x.verticalPlacedTextSymbolIndex:{left:x.leftJustifiedTextSymbolIndex,center:x.centerJustifiedTextSymbolIndex,right:x.rightJustifiedTextSymbolIndex}[o.getAnchorJustification(p)];const k=[x.leftJustifiedTextSymbolIndex,x.centerJustifiedTextSymbolIndex,x.rightJustifiedTextSymbolIndex,x.verticalPlacedTextSymbolIndex];for(const O of k)O>=0&&(c.text.placedSymbolArray.get(O).crossTileID=A>=0&&O!==A?0:x.crossTileID)}markUsedOrientation(c,p,x){const T=p===o.WritingMode.horizontal||p===o.WritingMode.horizontalOnly?p:0,A=p===o.WritingMode.vertical?p:0,k=[x.leftJustifiedTextSymbolIndex,x.centerJustifiedTextSymbolIndex,x.rightJustifiedTextSymbolIndex].filter(O=>O!==-1);for(const O of k)c.text.placedSymbolArray.get(O).placedOrientation=T;x.verticalPlacedTextSymbolIndex!==-1&&(c.text.placedSymbolArray.get(x.verticalPlacedTextSymbolIndex).placedOrientation=A)}commit(c){this.commitTime=c,this.zoomAtLastRecencyCheck=this.transform.zoom;const p=this.prevPlacement;let x=!1;this.prevZoomAdjustment=p?p.zoomAdjustment(this.transform.zoom):0;const T=p?p.symbolFadeChange(c):1,A=p?p.opacities:{},k=p?p.variableOffsets:{},O=p?p.placedOrientations:{};for(const F in this.placements){const V=this.placements[F],G=A[F];G?(this.opacities[F]=new Ot(G,T,V.text,V.icon,null,V.clipped),x=x||V.text!==G.text.placed||V.icon!==G.icon.placed):(this.opacities[F]=new Ot(null,T,V.text,V.icon,V.skipFade,V.clipped),x=x||V.text||V.icon)}for(const F in A){const V=A[F];if(!this.opacities[F]){const G=new Ot(V,T,!1,!1);G.isHidden()||(this.opacities[F]=G,x=x||V.text.placed||V.icon.placed)}}for(const F in k)this.variableOffsets[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.variableOffsets[F]=k[F]);for(const F in O)this.placedOrientations[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.placedOrientations[F]=O[F]);x?this.lastPlacementChangeTime=c:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=p?p.lastPlacementChangeTime:c)}updateLayerOpacities(c,p){const x={};for(const T of p){const A=T.getBucket(c);A&&T.latestFeatureIndex&&c.id===A.layerIds[0]&&this.updateBucketOpacities(A,x,T.collisionBoxArray)}}updateBucketOpacities(c,p,x){c.hasTextData()&&c.text.opacityVertexArray.clear(),c.hasIconData()&&c.icon.opacityVertexArray.clear(),c.hasIconCollisionBoxData()&&c.iconCollisionBox.collisionVertexArray.clear(),c.hasTextCollisionBoxData()&&c.textCollisionBox.collisionVertexArray.clear();const T=c.layers[0].layout,A=!!c.layers[0].dynamicFilter(),k=new Ot(null,0,!1,!1,!0),O=T.get("text-allow-overlap"),F=T.get("icon-allow-overlap"),V=T.get("text-variable-anchor"),G=T.get("text-rotation-alignment")==="map",ie=T.get("text-pitch-alignment")==="map",le=T.get("icon-text-fit")!=="none",_e=new Ot(null,0,O&&(F||!c.hasIconData()||T.get("icon-optional")),F&&(O||!c.hasTextData()||T.get("text-optional")),!0);!c.collisionArrays&&x&&(c.hasIconCollisionBoxData()||c.hasTextCollisionBoxData())&&c.deserializeCollisionBoxes(x);const fe=(me,de,be)=>{for(let ge=0;ge<de/4;ge++)me.opacityVertexArray.emplaceBack(be)};let ve=0;for(let me=0;me<c.symbolInstances.length;me++){const de=c.symbolInstances.get(me),{numHorizontalGlyphVertices:be,numVerticalGlyphVertices:ge,crossTileID:Be}=de;let ze=this.opacities[Be];p[Be]?ze=k:ze||(ze=_e,this.opacities[Be]=ze),p[Be]=!0;const Me=be>0||ge>0,Fe=de.numIconVertices>0,Je=this.placedOrientations[de.crossTileID],lt=Je===o.WritingMode.vertical,ot=Je===o.WritingMode.horizontal||Je===o.WritingMode.horizontalOnly;if(!Me&&!Fe||ze.isHidden()||ve++,Me){const zt=or(ze.text);fe(c.text,be,lt?an:zt),fe(c.text,ge,ot?an:zt);const He=ze.text.isHidden();[de.rightJustifiedTextSymbolIndex,de.centerJustifiedTextSymbolIndex,de.leftJustifiedTextSymbolIndex].forEach(tt=>{tt>=0&&(c.text.placedSymbolArray.get(tt).hidden=He||lt?1:0)}),de.verticalPlacedTextSymbolIndex>=0&&(c.text.placedSymbolArray.get(de.verticalPlacedTextSymbolIndex).hidden=He||ot?1:0);const wt=this.variableOffsets[de.crossTileID];wt&&this.markUsedJustification(c,wt.anchor,de,Je);const bt=this.placedOrientations[de.crossTileID];bt&&(this.markUsedJustification(c,"left",de,bt),this.markUsedOrientation(c,bt,de))}if(Fe){const zt=or(ze.icon);de.placedIconSymbolIndex>=0&&(fe(c.icon,de.numIconVertices,lt?an:zt),c.icon.placedSymbolArray.get(de.placedIconSymbolIndex).hidden=ze.icon.isHidden()),de.verticalPlacedIconSymbolIndex>=0&&(fe(c.icon,de.numVerticalIconVertices,ot?an:zt),c.icon.placedSymbolArray.get(de.verticalPlacedIconSymbolIndex).hidden=ze.icon.isHidden())}if(c.hasIconCollisionBoxData()||c.hasTextCollisionBoxData()){const zt=c.collisionArrays[me];if(zt){let He=new o.pointGeometry(0,0),wt=!0;if(zt.textBox||zt.verticalTextBox){if(V){const tt=this.variableOffsets[Be];tt?(He=Mi(tt.anchor,tt.width,tt.height,tt.textOffset,tt.textScale),G&&He._rotate(ie?this.transform.angle:-this.transform.angle)):wt=!1}A&&(wt=!ze.clipped),zt.textBox&&St(c.textCollisionBox.collisionVertexArray,ze.text.placed,!wt||lt,He.x,He.y),zt.verticalTextBox&&St(c.textCollisionBox.collisionVertexArray,ze.text.placed,!wt||ot,He.x,He.y)}const bt=wt&&Boolean(!ot&&zt.verticalIconBox);zt.iconBox&&St(c.iconCollisionBox.collisionVertexArray,ze.icon.placed,bt,le?He.x:0,le?He.y:0),zt.verticalIconBox&&St(c.iconCollisionBox.collisionVertexArray,ze.icon.placed,!bt,le?He.x:0,le?He.y:0)}}}if(c.fullyClipped=ve===0,c.sortFeatures(this.transform.angle),this.retainedQueryData[c.bucketInstanceId]&&(this.retainedQueryData[c.bucketInstanceId].featureSortOrder=c.featureSortOrder),c.hasTextData()&&c.text.opacityVertexBuffer&&c.text.opacityVertexBuffer.updateData(c.text.opacityVertexArray),c.hasIconData()&&c.icon.opacityVertexBuffer&&c.icon.opacityVertexBuffer.updateData(c.icon.opacityVertexArray),c.hasIconCollisionBoxData()&&c.iconCollisionBox.collisionVertexBuffer&&c.iconCollisionBox.collisionVertexBuffer.updateData(c.iconCollisionBox.collisionVertexArray),c.hasTextCollisionBoxData()&&c.textCollisionBox.collisionVertexBuffer&&c.textCollisionBox.collisionVertexBuffer.updateData(c.textCollisionBox.collisionVertexArray),c.bucketInstanceId in this.collisionCircleArrays){const me=this.collisionCircleArrays[c.bucketInstanceId];c.placementInvProjMatrix=me.invProjMatrix,c.placementViewportMatrix=me.viewportMatrix,c.collisionCircleArray=me.circles,delete this.collisionCircleArrays[c.bucketInstanceId]}}symbolFadeChange(c){return this.fadeDuration===0?1:(c-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(c){return Math.max(0,(this.transform.zoom-c)/1.5)}hasTransitions(c){return this.stale||c-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(c,p){const x=this.zoomAtLastRecencyCheck===p?1-this.zoomAdjustment(p):1;return this.zoomAtLastRecencyCheck=p,this.commitTime+this.fadeDuration*x>c}setStale(){this.stale=!0}}function St(g,c,p,x,T){g.emplaceBack(c?1:0,p?1:0,x||0,T||0),g.emplaceBack(c?1:0,p?1:0,x||0,T||0),g.emplaceBack(c?1:0,p?1:0,x||0,T||0),g.emplaceBack(c?1:0,p?1:0,x||0,T||0)}const ni=Math.pow(2,25),gr=Math.pow(2,24),yr=Math.pow(2,17),Dr=Math.pow(2,16),Ti=Math.pow(2,9),ho=Math.pow(2,8),eo=Math.pow(2,1);function or(g){if(g.opacity===0&&!g.placed)return 0;if(g.opacity===1&&g.placed)return 4294967295;const c=g.placed?1:0,p=Math.floor(127*g.opacity);return p*ni+c*gr+p*yr+c*Dr+p*Ti+c*ho+p*eo+c}const an=0;class hn{constructor(c){this._sortAcrossTiles=c.layout.get("symbol-z-order")!=="viewport-y"&&c.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(c,p,x,T,A){const k=this._bucketParts;for(;this._currentTileIndex<c.length;)if(p.getBucketParts(k,T,c[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,A())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,k.sort((O,F)=>O.sortKey-F.sortKey));this._currentPartIndex<k.length;){const O=k[this._currentPartIndex];if(p.placeLayerBucketPart(O,this._seenCrossTileIDs,x,O.symbolInstanceStart===0),this._currentPartIndex++,A())return!0}return!1}}class vs{constructor(c,p,x,T,A,k,O,F){this.placement=new Yr(c,A,k,O,F),this._currentPlacementIndex=p.length-1,this._forceFullPlacement=x,this._showCollisionBoxes=T,this._done=!1}isDone(){return this._done}continuePlacement(c,p,x){const T=o.exported.now(),A=()=>{const k=o.exported.now()-T;return!this._forceFullPlacement&&k>2};for(;this._currentPlacementIndex>=0;){const k=p[c[this._currentPlacementIndex]],O=this.placement.collisionIndex.transform.zoom;if(k.type==="symbol"&&(!k.minzoom||k.minzoom<=O)&&(!k.maxzoom||k.maxzoom>O)){if(this._inProgressLayer||(this._inProgressLayer=new hn(k)),this._inProgressLayer.continuePlacement(x[k.source],this.placement,this._showCollisionBoxes,k,A))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(c){return this.placement.commit(c),this.placement}}const Ha=512/o.EXTENT/2;class yn{constructor(c,p,x){this.tileID=c,this.indexedSymbolInstances={},this.bucketInstanceId=x;for(let T=0;T<p.length;T++){const A=p.get(T),k=A.key;this.indexedSymbolInstances[k]||(this.indexedSymbolInstances[k]=[]),this.indexedSymbolInstances[k].push({crossTileID:A.crossTileID,coord:this.getScaledCoordinates(A,c)})}}getScaledCoordinates(c,p){const x=Ha/Math.pow(2,p.canonical.z-this.tileID.canonical.z);return{x:Math.floor((p.canonical.x*o.EXTENT+c.tileAnchorX)*x),y:Math.floor((p.canonical.y*o.EXTENT+c.tileAnchorY)*x)}}findMatches(c,p,x){const T=this.tileID.canonical.z<p.canonical.z?1:Math.pow(2,this.tileID.canonical.z-p.canonical.z);for(let A=0;A<c.length;A++){const k=c.get(A);if(k.crossTileID)continue;const O=this.indexedSymbolInstances[k.key];if(!O)continue;const F=this.getScaledCoordinates(k,p);for(const V of O)if(Math.abs(V.coord.x-F.x)<=T&&Math.abs(V.coord.y-F.y)<=T&&!x[V.crossTileID]){x[V.crossTileID]=!0,k.crossTileID=V.crossTileID;break}}}}class Js{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class bs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(c){const p=Math.round((c-this.lng)/360);if(p!==0)for(const x in this.indexes){const T=this.indexes[x],A={};for(const k in T){const O=T[k];O.tileID=O.tileID.unwrapTo(O.tileID.wrap+p),A[O.tileID.key]=O}this.indexes[x]=A}this.lng=c}addBucket(c,p,x){if(this.indexes[c.overscaledZ]&&this.indexes[c.overscaledZ][c.key]){if(this.indexes[c.overscaledZ][c.key].bucketInstanceId===p.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(c.overscaledZ,this.indexes[c.overscaledZ][c.key])}for(let A=0;A<p.symbolInstances.length;A++)p.symbolInstances.get(A).crossTileID=0;this.usedCrossTileIDs[c.overscaledZ]||(this.usedCrossTileIDs[c.overscaledZ]={});const T=this.usedCrossTileIDs[c.overscaledZ];for(const A in this.indexes){const k=this.indexes[A];if(Number(A)>c.overscaledZ)for(const O in k){const F=k[O];F.tileID.isChildOf(c)&&F.findMatches(p.symbolInstances,c,T)}else{const O=k[c.scaledTo(Number(A)).key];O&&O.findMatches(p.symbolInstances,c,T)}}for(let A=0;A<p.symbolInstances.length;A++){const k=p.symbolInstances.get(A);k.crossTileID||(k.crossTileID=x.generate(),T[k.crossTileID]=!0)}return this.indexes[c.overscaledZ]===void 0&&(this.indexes[c.overscaledZ]={}),this.indexes[c.overscaledZ][c.key]=new yn(c,p.symbolInstances,p.bucketInstanceId),!0}removeBucketCrossTileIDs(c,p){for(const x in p.indexedSymbolInstances)for(const T of p.indexedSymbolInstances[x])delete this.usedCrossTileIDs[c][T.crossTileID]}removeStaleBuckets(c){let p=!1;for(const x in this.indexes){const T=this.indexes[x];for(const A in T)c[T[A].bucketInstanceId]||(this.removeBucketCrossTileIDs(x,T[A]),delete T[A],p=!0)}return p}}class zo{constructor(){this.layerIndexes={},this.crossTileIDs=new Js,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(c,p,x,T){let A=this.layerIndexes[c.id];A===void 0&&(A=this.layerIndexes[c.id]=new bs);let k=!1;const O={};T.name!=="globe"&&A.handleWrapJump(x);for(const F of p){const V=F.getBucket(c);V&&c.id===V.layerIds[0]&&(V.bucketInstanceId||(V.bucketInstanceId=++this.maxBucketInstanceId),A.addBucket(F.tileID,V,this.crossTileIDs)&&(k=!0),O[V.bucketInstanceId]=!0)}return A.removeStaleBuckets(O)&&(k=!0),k}pruneUnusedLayers(c){const p={};c.forEach(x=>{p[x]=!0});for(const x in this.layerIndexes)p[x]||delete this.layerIndexes[x]}}const On=(g,c)=>o.emitValidationErrors(g,c&&c.filter(p=>p.identifier!=="source.canvas")),Oo=o.pick(vt,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),fo=o.pick(vt,["setCenter","setZoom","setBearing","setPitch"]),Wa={version:8,layers:[],sources:{}},Ya={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class _n extends o.Evented{constructor(c,p={}){super(),this.map=c,this.dispatcher=new dt(Di(),this),this.imageManager=new he,this.imageManager.setEventedParent(this),this.glyphManager=new o.GlyphManager(c._requestManager,p.localFontFamily?o.LocalGlyphMode.all:p.localIdeographFontFamily?o.LocalGlyphMode.ideographs:o.LocalGlyphMode.none,p.localFontFamily||p.localIdeographFontFamily),this.crossTileSymbolIndex=new zo,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new o.ZoomHistory,this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",o.getReferrer());const x=this;this._rtlTextPluginCallback=_n.registerForPluginStateChange(T=>{x.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:T.pluginStatus,pluginURL:T.pluginURL},(A,k)=>{if(o.triggerPluginCompletionEvent(A),k&&k.every(O=>O))for(const O in x._sourceCaches){const F=x._sourceCaches[O],V=F.getSource().type;V!=="vector"&&V!=="geojson"||F.reload()}})}),this.on("data",T=>{if(T.dataType!=="source"||T.sourceDataType!=="metadata")return;const A=this.getSource(T.sourceId);if(A&&A.vectorLayerIds)for(const k in this._layers){const O=this._layers[k];O.source===A.id&&this._validateLayer(O)}})}loadURL(c,p={}){this.fire(new o.Event("dataloading",{dataType:"style"}));const x=typeof p.validate=="boolean"?p.validate:!o.isMapboxURL(c);c=this.map._requestManager.normalizeStyleURL(c,p.accessToken);const T=this.map._requestManager.transformRequest(c,o.ResourceType.Style);this._request=o.getJSON(T,(A,k)=>{this._request=null,A?this.fire(new o.ErrorEvent(A)):k&&this._load(k,x)})}loadJSON(c,p={}){this.fire(new o.Event("dataloading",{dataType:"style"})),this._request=o.exported.frame(()=>{this._request=null,this._load(c,p.validate!==!1)})}loadEmpty(){this.fire(new o.Event("dataloading",{dataType:"style"})),this._load(Wa,!1)}_updateLayerCount(c,p){const x=p?1:-1;c.is3D()&&(this._num3DLayers+=x),c.type==="circle"&&(this._numCircleLayers+=x),c.type==="symbol"&&(this._numSymbolLayers+=x)}_load(c,p){if(p&&On(this,o.validateStyle(c)))return;this._loaded=!0,this.stylesheet=o.clone$1(c),this._updateMapProjection();for(const T in c.sources)this.addSource(T,c.sources[T],{validate:!1});this._changed=!1,c.sprite?this._loadSprite(c.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(c.glyphs);const x=Re(this.stylesheet.layers);this._order=x.map(T=>T.id),this._layers={},this._serializedLayers={};for(let T of x)T=o.createStyleLayer(T),T.setEventedParent(this,{layer:{id:T.id}}),this._layers[T.id]=T,this._serializedLayers[T.id]=T.serialize(),this._updateLayerCount(T,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new Qe(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new o.Event("data",{dataType:"style"})),this.fire(new o.Event("style.load"))}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}setProjection(c){c?this.stylesheet.projection=c:delete this.stylesheet.projection,this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.stylesheet.projection)}_loadSprite(c){this._spriteRequest=function(p,x,T){let A,k,O;const F=o.exported.devicePixelRatio>1?"@2x":"";let V=o.getJSON(x.transformRequest(x.normalizeSpriteURL(p,F,".json"),o.ResourceType.SpriteJSON),(le,_e)=>{V=null,O||(O=le,A=_e,ie())}),G=o.getImage(x.transformRequest(x.normalizeSpriteURL(p,F,".png"),o.ResourceType.SpriteImage),(le,_e)=>{G=null,O||(O=le,k=_e,ie())});function ie(){if(O)T(O);else if(A&&k){const le=o.exported.getImageData(k),_e={};for(const fe in A){const{width:ve,height:me,x:de,y:be,sdf:ge,pixelRatio:Be,stretchX:ze,stretchY:Me,content:Fe}=A[fe],Je=new o.RGBAImage({width:ve,height:me});o.RGBAImage.copy(le,Je,{x:de,y:be},{x:0,y:0},{width:ve,height:me}),_e[fe]={data:Je,pixelRatio:Be,sdf:ge,stretchX:ze,stretchY:Me,content:Fe}}T(null,_e)}}return{cancel(){V&&(V.cancel(),V=null),G&&(G.cancel(),G=null)}}}(c,this.map._requestManager,(p,x)=>{if(this._spriteRequest=null,p)this.fire(new o.ErrorEvent(p));else if(x)for(const T in x)this.imageManager.addImage(T,x[T]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new o.Event("data",{dataType:"style"}))})}_validateLayer(c){const p=this.getSource(c.source);if(!p)return;const x=c.sourceLayer;x&&(p.type==="geojson"||p.vectorLayerIds&&p.vectorLayerIds.indexOf(x)===-1)&&this.fire(new o.ErrorEvent(new Error(`Source layer "${x}" does not exist on source "${p.id}" as specified by style layer "${c.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const c in this._sourceCaches)if(!this._sourceCaches[c].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(c){const p=[];for(const x of c){const T=this._layers[x];T.type!=="custom"&&p.push(T.serialize())}return p}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const c in this._sourceCaches)if(this._sourceCaches[c].hasTransition())return!0;for(const c in this._layers)if(this._layers[c].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(c){return!!this.terrain&&Ya[c.type]}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(c){if(!this._loaded)return;const p=this._changed;if(this._changed){const T=Object.keys(this._updatedLayers),A=Object.keys(this._removedLayers);(T.length||A.length)&&this._updateWorkerLayers(T,A);for(const k in this._updatedSources){const O=this._updatedSources[k];O==="reload"?this._reloadSource(k):O==="clear"&&this._clearSource(k)}this._updateTilesForChangedImages();for(const k in this._updatedPaintProps)this._layers[k].updateTransitions(c);this.light.updateTransitions(c),this.fog&&this.fog.updateTransitions(c),this._resetUpdates()}const x={};for(const T in this._sourceCaches){const A=this._sourceCaches[T];x[T]=A.used,A.used=!1}for(const T of this._order){const A=this._layers[T];if(A.recalculate(c,this._availableImages),!A.isHidden(c.zoom)){const O=this._getLayerSourceCache(A);O&&(O.used=!0)}const k=this.map.painter;if(k){const O=A.getProgramIds();if(!O)continue;const F=A.getProgramConfiguration(c.zoom);for(const V of O)k.useProgram(V,F)}}for(const T in x){const A=this._sourceCaches[T];x[T]!==A.used&&A.getSource().fire(new o.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:A.getSource().id}))}this.light.recalculate(c),this.terrain&&this.terrain.recalculate(c),this.fog&&this.fog.recalculate(c),this.z=c.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),p&&this.fire(new o.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const c=Object.keys(this._changedImages);if(c.length){for(const p in this._sourceCaches)this._sourceCaches[p].reloadTilesForDependencies(["icons","patterns"],c);this._changedImages={}}}_updateWorkerLayers(c,p){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(c),removedIds:p})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(c){if(this._checkLoaded(),On(this,o.validateStyle(c)))return!1;(c=o.clone$1(c)).layers=Re(c.layers);const p=function(T,A){if(!T)return[{command:vt.setStyle,args:[A]}];let k=[];try{if(!b(T.version,A.version))return[{command:vt.setStyle,args:[A]}];b(T.center,A.center)||k.push({command:vt.setCenter,args:[A.center]}),b(T.zoom,A.zoom)||k.push({command:vt.setZoom,args:[A.zoom]}),b(T.bearing,A.bearing)||k.push({command:vt.setBearing,args:[A.bearing]}),b(T.pitch,A.pitch)||k.push({command:vt.setPitch,args:[A.pitch]}),b(T.sprite,A.sprite)||k.push({command:vt.setSprite,args:[A.sprite]}),b(T.glyphs,A.glyphs)||k.push({command:vt.setGlyphs,args:[A.glyphs]}),b(T.transition,A.transition)||k.push({command:vt.setTransition,args:[A.transition]}),b(T.light,A.light)||k.push({command:vt.setLight,args:[A.light]}),b(T.fog,A.fog)||k.push({command:vt.setFog,args:[A.fog]}),b(T.projection,A.projection)||k.push({command:vt.setProjection,args:[A.projection]});const O={},F=[];(function(ie,le,_e,fe){let ve;for(ve in le=le||{},ie=ie||{})ie.hasOwnProperty(ve)&&(le.hasOwnProperty(ve)||fi(ve,_e,fe));for(ve in le)le.hasOwnProperty(ve)&&(ie.hasOwnProperty(ve)?b(ie[ve],le[ve])||(ie[ve].type==="geojson"&&le[ve].type==="geojson"&&sr(ie,le,ve)?_e.push({command:vt.setGeoJSONSourceData,args:[ve,le[ve].data]}):dr(ve,le,_e,fe)):Pt(ve,le,_e))})(T.sources,A.sources,F,O);const V=[];T.layers&&T.layers.forEach(ie=>{ie.source&&O[ie.source]?k.push({command:vt.removeLayer,args:[ie.id]}):V.push(ie)});let G=T.terrain;G&&O[G.source]&&(k.push({command:vt.setTerrain,args:[void 0]}),G=void 0),k=k.concat(F),b(G,A.terrain)||k.push({command:vt.setTerrain,args:[A.terrain]}),function(ie,le,_e){le=le||[];const fe=(ie=ie||[]).map(Or),ve=le.map(Or),me=ie.reduce(Fr,{}),de=le.reduce(Fr,{}),be=fe.slice(),ge=Object.create(null);let Be,ze,Me,Fe,Je,lt,ot;for(Be=0,ze=0;Be<fe.length;Be++)Me=fe[Be],de.hasOwnProperty(Me)?ze++:(_e.push({command:vt.removeLayer,args:[Me]}),be.splice(be.indexOf(Me,ze),1));for(Be=0,ze=0;Be<ve.length;Be++)Me=ve[ve.length-1-Be],be[be.length-1-Be]!==Me&&(me.hasOwnProperty(Me)?(_e.push({command:vt.removeLayer,args:[Me]}),be.splice(be.lastIndexOf(Me,be.length-ze),1)):ze++,lt=be[be.length-Be],_e.push({command:vt.addLayer,args:[de[Me],lt]}),be.splice(be.length-Be,0,Me),ge[Me]=!0);for(Be=0;Be<ve.length;Be++)if(Me=ve[Be],Fe=me[Me],Je=de[Me],!ge[Me]&&!b(Fe,Je))if(b(Fe.source,Je.source)&&b(Fe["source-layer"],Je["source-layer"])&&b(Fe.type,Je.type)){for(ot in it(Fe.layout,Je.layout,_e,Me,null,vt.setLayoutProperty),it(Fe.paint,Je.paint,_e,Me,null,vt.setPaintProperty),b(Fe.filter,Je.filter)||_e.push({command:vt.setFilter,args:[Me,Je.filter]}),b(Fe.minzoom,Je.minzoom)&&b(Fe.maxzoom,Je.maxzoom)||_e.push({command:vt.setLayerZoomRange,args:[Me,Je.minzoom,Je.maxzoom]}),Fe)Fe.hasOwnProperty(ot)&&ot!=="layout"&&ot!=="paint"&&ot!=="filter"&&ot!=="metadata"&&ot!=="minzoom"&&ot!=="maxzoom"&&(ot.indexOf("paint.")===0?it(Fe[ot],Je[ot],_e,Me,ot.slice(6),vt.setPaintProperty):b(Fe[ot],Je[ot])||_e.push({command:vt.setLayerProperty,args:[Me,ot,Je[ot]]}));for(ot in Je)Je.hasOwnProperty(ot)&&!Fe.hasOwnProperty(ot)&&ot!=="layout"&&ot!=="paint"&&ot!=="filter"&&ot!=="metadata"&&ot!=="minzoom"&&ot!=="maxzoom"&&(ot.indexOf("paint.")===0?it(Fe[ot],Je[ot],_e,Me,ot.slice(6),vt.setPaintProperty):b(Fe[ot],Je[ot])||_e.push({command:vt.setLayerProperty,args:[Me,ot,Je[ot]]}))}else _e.push({command:vt.removeLayer,args:[Me]}),lt=be[be.lastIndexOf(Me)+1],_e.push({command:vt.addLayer,args:[Je,lt]})}(V,A.layers,k)}catch(O){console.warn("Unable to compute style diff:",O),k=[{command:vt.setStyle,args:[A]}]}return k}(this.serialize(),c).filter(T=>!(T.command in fo));if(p.length===0)return!1;const x=p.filter(T=>!(T.command in Oo));if(x.length>0)throw new Error(`Unimplemented: ${x.map(T=>T.command).join(", ")}.`);return p.forEach(T=>{T.command!=="setTransition"&&T.command!=="setProjection"&&this[T.command].apply(this,T.args)}),this.stylesheet=c,this._updateMapProjection(),!0}addImage(c,p){return this.getImage(c)?this.fire(new o.ErrorEvent(new Error("An image with this name already exists."))):(this.imageManager.addImage(c,p),this._afterImageUpdated(c),this)}updateImage(c,p){this.imageManager.updateImage(c,p)}getImage(c){return this.imageManager.getImage(c)}removeImage(c){return this.getImage(c)?(this.imageManager.removeImage(c),this._afterImageUpdated(c),this):this.fire(new o.ErrorEvent(new Error("No image with this name exists.")))}_afterImageUpdated(c){this._availableImages=this.imageManager.listImages(),this._changedImages[c]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new o.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(c,p,x={}){if(this._checkLoaded(),this.getSource(c)!==void 0)throw new Error("There is already a source with this ID");if(!p.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(p).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(p.type)>=0&&this._validate(o.validateSource,`sources.${c}`,p,null,x))return;this.map&&this.map._collectResourceTiming&&(p.collectResourceTiming=!0);const T=Ge(c,p,this.dispatcher,this);T.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(c),source:T.serialize(),sourceId:c}));const A=k=>{const O=(k?"symbol:":"other:")+c,F=this._sourceCaches[O]=new o.SourceCache(O,T,k);(k?this._symbolSourceCaches:this._otherSourceCaches)[c]=F,F.style=this,F.onAdd(this.map)};A(!1),p.type!=="vector"&&p.type!=="geojson"||A(!0),T.onAdd&&T.onAdd(this.map),this._changed=!0}removeSource(c){this._checkLoaded();const p=this.getSource(c);if(!p)throw new Error("There is no source with this ID");for(const T in this._layers)if(this._layers[T].source===c)return this.fire(new o.ErrorEvent(new Error(`Source "${c}" cannot be removed while layer "${T}" is using it.`)));if(this.terrain&&this.terrain.get().source===c)return this.fire(new o.ErrorEvent(new Error(`Source "${c}" cannot be removed while terrain is using it.`)));const x=this._getSourceCaches(c);for(const T of x)delete this._sourceCaches[T.id],delete this._updatedSources[T.id],T.fire(new o.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:T.getSource().id})),T.setEventedParent(null),T.clearTiles();return delete this._otherSourceCaches[c],delete this._symbolSourceCaches[c],p.setEventedParent(null),p.onRemove&&p.onRemove(this.map),this._changed=!0,this}setGeoJSONSourceData(c,p){this._checkLoaded(),this.getSource(c).setData(p),this._changed=!0}getSource(c){const p=this._getSourceCache(c);return p&&p.getSource()}_getSources(){const c=[];for(const p in this._otherSourceCaches){const x=this._getSourceCache(p);x&&c.push(x.getSource())}return c}addLayer(c,p,x={}){this._checkLoaded();const T=c.id;if(this.getLayer(T))return void this.fire(new o.ErrorEvent(new Error(`Layer with id "${T}" already exists on this map`)));let A;if(c.type==="custom"){if(On(this,o.validateCustomStyleLayer(c)))return;A=o.createStyleLayer(c)}else{if(typeof c.source=="object"&&(this.addSource(T,c.source),c=o.clone$1(c),c=o.extend(c,{source:T})),this._validate(o.validateLayer,`layers.${T}`,c,{arrayIndex:-1},x))return;A=o.createStyleLayer(c),this._validateLayer(A),A.setEventedParent(this,{layer:{id:T}}),this._serializedLayers[A.id]=A.serialize(),this._updateLayerCount(A,!0)}const k=p?this._order.indexOf(p):this._order.length;if(p&&k===-1)return void this.fire(new o.ErrorEvent(new Error(`Layer with id "${p}" does not exist on this map.`)));this._order.splice(k,0,T),this._layerOrderChanged=!0,this._layers[T]=A;const O=this._getLayerSourceCache(A);if(this._removedLayers[T]&&A.source&&O&&A.type!=="custom"){const F=this._removedLayers[T];delete this._removedLayers[T],F.type!==A.type?this._updatedSources[A.source]="clear":(this._updatedSources[A.source]="reload",O.pause())}this._updateLayer(A),A.onAdd&&A.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(c,p){if(this._checkLoaded(),this._changed=!0,!this._layers[c])return void this.fire(new o.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be moved.`)));if(c===p)return;const x=this._order.indexOf(c);this._order.splice(x,1);const T=p?this._order.indexOf(p):this._order.length;p&&T===-1?this.fire(new o.ErrorEvent(new Error(`Layer with id "${p}" does not exist on this map.`))):(this._order.splice(T,0,c),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(c){this._checkLoaded();const p=this._layers[c];if(!p)return void this.fire(new o.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be removed.`)));p.setEventedParent(null),this._updateLayerCount(p,!1);const x=this._order.indexOf(c);this._order.splice(x,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[c]=p,delete this._layers[c],delete this._serializedLayers[c],delete this._updatedLayers[c],delete this._updatedPaintProps[c],p.onRemove&&p.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(c){return this._layers[c]}hasLayer(c){return c in this._layers}hasLayerType(c){for(const p in this._layers)if(this._layers[p].type===c)return!0;return!1}setLayerZoomRange(c,p,x){this._checkLoaded();const T=this.getLayer(c);T?T.minzoom===p&&T.maxzoom===x||(p!=null&&(T.minzoom=p),x!=null&&(T.maxzoom=x),this._updateLayer(T)):this.fire(new o.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(c,p,x={}){this._checkLoaded();const T=this.getLayer(c);if(T){if(!b(T.filter,p))return p==null?(T.filter=void 0,void this._updateLayer(T)):void(this._validate(o.validateFilter,`layers.${T.id}.filter`,p,{layerType:T.type},x)||(T.filter=o.clone$1(p),this._updateLayer(T)))}else this.fire(new o.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be filtered.`)))}getFilter(c){const p=this.getLayer(c);return p&&o.clone$1(p.filter)}setLayoutProperty(c,p,x,T={}){this._checkLoaded();const A=this.getLayer(c);A?b(A.getLayoutProperty(p),x)||(A.setLayoutProperty(p,x,T),this._updateLayer(A)):this.fire(new o.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(c,p){const x=this.getLayer(c);if(x)return x.getLayoutProperty(p);this.fire(new o.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style.`)))}setPaintProperty(c,p,x,T={}){this._checkLoaded();const A=this.getLayer(c);A?b(A.getPaintProperty(p),x)||(A.setPaintProperty(p,x,T)&&this._updateLayer(A),this._changed=!0,this._updatedPaintProps[c]=!0):this.fire(new o.ErrorEvent(new Error(`The layer '${c}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(c,p){const x=this.getLayer(c);return x&&x.getPaintProperty(p)}setFeatureState(c,p){this._checkLoaded();const x=c.source,T=c.sourceLayer,A=this.getSource(x);if(!A)return void this.fire(new o.ErrorEvent(new Error(`The source '${x}' does not exist in the map's style.`)));const k=A.type;if(k==="geojson"&&T)return void this.fire(new o.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(k==="vector"&&!T)return void this.fire(new o.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));c.id===void 0&&this.fire(new o.ErrorEvent(new Error("The feature id parameter must be provided.")));const O=this._getSourceCaches(x);for(const F of O)F.setFeatureState(T,c.id,p)}removeFeatureState(c,p){this._checkLoaded();const x=c.source,T=this.getSource(x);if(!T)return void this.fire(new o.ErrorEvent(new Error(`The source '${x}' does not exist in the map's style.`)));const A=T.type,k=A==="vector"?c.sourceLayer:void 0;if(A==="vector"&&!k)return void this.fire(new o.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(p&&typeof c.id!="string"&&typeof c.id!="number")return void this.fire(new o.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const O=this._getSourceCaches(x);for(const F of O)F.removeFeatureState(k,c.id,p)}getFeatureState(c){this._checkLoaded();const p=c.source,x=c.sourceLayer,T=this.getSource(p);if(T){if(T.type!=="vector"||x)return c.id===void 0&&this.fire(new o.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(p)[0].getFeatureState(x,c.id);this.fire(new o.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new o.ErrorEvent(new Error(`The source '${p}' does not exist in the map's style.`)))}getTransition(){return o.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const c={};for(const p in this._sourceCaches){const x=this._sourceCaches[p].getSource();c[x.id]||(c[x.id]=x.serialize())}return o.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.getTerrain()||void 0,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:c,layers:this._serializeLayers(this._order)},p=>p!==void 0)}_updateLayer(c){this._updatedLayers[c.id]=!0;const p=this._getLayerSourceCache(c);c.source&&!this._updatedSources[c.source]&&p&&p.getSource().type!=="raster"&&(this._updatedSources[c.source]="reload",p.pause()),this._changed=!0,c.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(c){const p=k=>this._layers[k].type==="fill-extrusion",x={},T=[];for(let k=this._order.length-1;k>=0;k--){const O=this._order[k];if(p(O)){x[O]=k;for(const F of c){const V=F[O];if(V)for(const G of V)T.push(G)}}}T.sort((k,O)=>O.intersectionZ-k.intersectionZ);const A=[];for(let k=this._order.length-1;k>=0;k--){const O=this._order[k];if(p(O))for(let F=T.length-1;F>=0;F--){const V=T[F].feature;if(x[V.layer.id]<k)break;A.push(V),T.pop()}else for(const F of c){const V=F[O];if(V)for(const G of V)A.push(G.feature)}}return A}queryRenderedFeatures(c,p,x){p&&p.filter&&this._validate(o.validateFilter,"queryRenderedFeatures.filter",p.filter,null,p);const T={};if(p&&p.layers){if(!Array.isArray(p.layers))return this.fire(new o.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const F of p.layers){const V=this._layers[F];if(!V)return this.fire(new o.ErrorEvent(new Error(`The layer '${F}' does not exist in the map's style and cannot be queried for features.`))),[];T[V.source]=!0}}const A=[];p.availableImages=this._availableImages;const k=p&&p.layers?p.layers.some(F=>{const V=this.getLayer(F);return V&&V.is3D()}):this.has3DLayers(),O=Tt.createFromScreenPoints(c,x);for(const F in this._sourceCaches){const V=this._sourceCaches[F].getSource().id;p.layers&&!T[V]||A.push(Ze(this._sourceCaches[F],this._layers,this._serializedLayers,O,p,x,k,!!this.map._showQueryGeometry))}return this.placement&&A.push(function(F,V,G,ie,le,_e,fe){const ve={},me=_e.queryRenderedSymbols(ie),de=[];for(const be of Object.keys(me).map(Number))de.push(fe[be]);de.sort(Ut);for(const be of de){const ge=be.featureIndex.lookupSymbolFeatures(me[be.bucketInstanceId],V,be.bucketIndex,be.sourceLayerIndex,le.filter,le.layers,le.availableImages,F);for(const Be in ge){const ze=ve[Be]=ve[Be]||[],Me=ge[Be];Me.sort((Fe,Je)=>{const lt=be.featureSortOrder;if(lt){const ot=lt.indexOf(Fe.featureIndex);return lt.indexOf(Je.featureIndex)-ot}return Je.featureIndex-Fe.featureIndex});for(const Fe of Me)ze.push(Fe)}}for(const be in ve)ve[be].forEach(ge=>{const Be=ge.feature,ze=G(F[be]).getFeatureState(Be.layer["source-layer"],Be.id);Be.source=Be.layer.source,Be.layer["source-layer"]&&(Be.sourceLayer=Be.layer["source-layer"]),Be.state=ze});return ve}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),O.screenGeometry,p,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(A)}querySourceFeatures(c,p){p&&p.filter&&this._validate(o.validateFilter,"querySourceFeatures.filter",p.filter,null,p);const x=this._getSourceCaches(c);let T=[];for(const A of x)T=T.concat(ut(A,p));return T}addSourceType(c,p,x){return _n.getSourceType(c)?x(new Error(`A source type called "${c}" already exists.`)):(_n.setSourceType(c,p),p.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:c,url:p.workerSourceURL},x):x(null,null))}getLight(){return this.light.getLight()}setLight(c,p={}){this._checkLoaded();const x=this.light.getLight();let T=!1;for(const k in c)if(!b(c[k],x[k])){T=!0;break}if(!T)return;const A=this._setTransitionParameters({duration:300,delay:0});this.light.setLight(c,p),this.light.updateTransitions(A)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(c,p=1){if(this._checkLoaded(),!c)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(p===1){if(typeof c.source=="object"){const x="terrain-dem-src";this.addSource(x,c.source),c=o.clone$1(c),c=o.extend(c,{source:x})}if(this._validate(o.validateTerrain,"terrain",c))return}if(!this.terrain||this.terrain&&p!==this.terrain.drapeRenderMode)this._createTerrain(c,p);else{const x=this.terrain,T=x.get();for(const A of Object.keys(o.spec.terrain))!c.hasOwnProperty(A)&&o.spec.terrain[A].default&&(c[A]=o.spec.terrain[A].default);for(const A in c)if(!b(c[A],T[A])){x.set(c),this.stylesheet.terrain=c;const k=this._setTransitionParameters({duration:0});x.updateTransitions(k);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(c){const p=this.fog=new Bt(c,this.map.transform);this.stylesheet.fog=c;const x=this._setTransitionParameters({duration:0});p.updateTransitions(x)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const c of this.map._markers)c._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(c){if(this._checkLoaded(),!c)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const p=this.fog,x=p.get();Object.keys(c).length===0&&p.set(c);for(const T in c)if(!b(c[T],x[T])){p.set(c),this.stylesheet.fog=c;const A=this._setTransitionParameters({duration:0});p.updateTransitions(A);break}}else this._createFog(c);this._markersNeedUpdate=!0}_setTransitionParameters(c){return{now:o.exported.now(),transition:o.extend(c,this.stylesheet.transition)}}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const c=this._order.filter(x=>this.isLayerDraped(this._layers[x])),p=this._order.filter(x=>!this.isLayerDraped(this._layers[x]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...c),this._drapedFirstOrder.push(...p)}_createTerrain(c,p){const x=this.terrain=new ti(c,p);this.stylesheet.terrain=c,this.dispatcher.broadcast("enableTerrain",!this.terrainSetForDrapingOnly()),this._force3DLayerUpdate();const T=this._setTransitionParameters({duration:0});x.updateTransitions(T)}_force3DLayerUpdate(){for(const c in this._layers){const p=this._layers[c];p.type==="fill-extrusion"&&this._updateLayer(p)}}_forceSymbolLayerUpdate(){for(const c in this._layers){const p=this._layers[c];p.type==="symbol"&&this._updateLayer(p)}}_validate(c,p,x,T,A={}){return(!A||A.validate!==!1)&&On(this,c.call(o.validateStyle,o.extend({key:p,style:this.serialize(),value:x,styleSpec:o.spec},T)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),o.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const c in this._layers)this._layers[c].setEventedParent(null);for(const c in this._sourceCaches)this._sourceCaches[c].clearTiles(),this._sourceCaches[c].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(c){const p=this._getSourceCaches(c);for(const x of p)x.clearTiles()}_reloadSource(c){const p=this._getSourceCaches(c);for(const x of p)x.resume(),x.reload()}_reloadSources(){for(const c of this._getSources())c.reload&&c.reload()}_updateSources(c){for(const p in this._sourceCaches)this._sourceCaches[p].update(c)}_generateCollisionBoxes(){for(const c in this._sourceCaches){const p=this._sourceCaches[c];p.resume(),p.reload()}}_updatePlacement(c,p,x,T,A=!1){let k=!1,O=!1;const F={};for(const V of this._order){const G=this._layers[V];if(G.type!=="symbol")continue;if(!F[G.source]){const le=this._getLayerSourceCache(G);if(!le)continue;F[G.source]=le.getRenderableIds(!0).map(_e=>le.getTileByID(_e)).sort((_e,fe)=>fe.tileID.overscaledZ-_e.tileID.overscaledZ||(_e.tileID.isLessThan(fe.tileID)?-1:1))}const ie=this.crossTileSymbolIndex.addLayer(G,F[G.source],c.center.lng,c.projection);k=k||ie}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),A=A||this._layerOrderChanged||x===0,this._layerOrderChanged&&this.fire(new o.Event("neworder")),(A||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(o.exported.now(),c.zoom))&&(this.pauseablePlacement=new vs(c,this._order,A,p,x,T,this.placement,this.fog&&c.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,F),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(o.exported.now()),O=!0),k&&this.pauseablePlacement.placement.setStale()),O||k)for(const V of this._order){const G=this._layers[V];G.type==="symbol"&&this.placement.updateLayerOpacities(G,F[G.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(o.exported.now())}_releaseSymbolFadeTiles(){for(const c in this._sourceCaches)this._sourceCaches[c].releaseSymbolFadeTiles()}getImages(c,p,x){this.imageManager.getImages(p.icons,x),this._updateTilesForChangedImages();const T=A=>{A&&A.setDependencies(p.tileID.key,p.type,p.icons)};T(this._otherSourceCaches[p.source]),T(this._symbolSourceCaches[p.source])}getGlyphs(c,p,x){this.glyphManager.getGlyphs(p.stacks,x)}getResource(c,p,x){return o.makeRequest(p,x)}_getSourceCache(c){return this._otherSourceCaches[c]}_getLayerSourceCache(c){return c.type==="symbol"?this._symbolSourceCaches[c.source]:this._otherSourceCaches[c.source]}_getSourceCaches(c){const p=[];return this._otherSourceCaches[c]&&p.push(this._otherSourceCaches[c]),this._symbolSourceCaches[c]&&p.push(this._symbolSourceCaches[c]),p}_isSourceCacheLoaded(c){const p=this._getSourceCaches(c);return p.length===0?(this.fire(new o.ErrorEvent(new Error(`There is no source with ID '${c}'`))),!1):p.every(x=>x.loaded())}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}_n.getSourceType=function(g){return $e[g]},_n.setSourceType=function(g,c){$e[g]=c},_n.registerForPluginStateChange=o.registerForPluginStateChange;var ws=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#define HALF_PI PI/2.0
#define QUARTER_PI PI/4.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0`,Ka="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",el=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform sampler2D u_dem;uniform sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {return currentElevation(apos);}
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,Ca=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,aa=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump float u_fog_temporal_offset;varying vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`;let ka={},Pa={};const po=[];to(ws,po),to(el,po),to(Ca,po),to(aa,po),ka=fr("",el),Pa=fr(aa,Ca);const Fo=fr(`
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}`,`
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),Es=ws,Qa=`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`;var Ts={background:fr(`uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:fr(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:fr(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:fr("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:fr(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:fr(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:fr("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:fr("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:fr("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",`attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;
#endif
varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:fr(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:fr(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:fr(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:fr(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:fr(`varying vec4 v_color;
#ifdef RENDER_SHADOWS
varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#ifdef ZERO_ROOF_RADIUS
varying vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
varying highp vec3 v_normal;
#endif
void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
vec3 normal=v_normal;
#endif
float z;vec4 color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);color=mix(v_color,v_roof_color,z);
#else
color=v_color;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);color.rgb=color.rgb*shade;
#endif
#ifdef RENDER_SHADOWS
#ifdef ZERO_ROOF_RADIUS
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#endif
color.xyz=shadowed_color_normal(color.xyz,normalize(normal),v_pos_light_view_0,v_pos_light_view_1,v_depth);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec4 v_color;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;
#endif
#ifdef ZERO_ROOF_RADIUS
varying vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
varying highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
v_normal=normal;
#endif
base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
v_pos_light_view_0=u_light_matrix_0*vec4(pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1);v_depth=gl_Position.w;
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);directional*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#ifdef ZERO_ROOF_RADIUS
v_roof_color=vec4(0.0,0.0,0.0,1.0);float roof_radiance=clamp(u_lightpos.z,0.0,1.0);roof_radiance=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roof_radiance);v_roof_color.rgb+=clamp(color.rgb*roof_radiance*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionPattern:fr(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);directional*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),hillshadePrepare:fr(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:fr(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:fr(`uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
uniform float u_border_width;uniform vec4 u_border_color;float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
#ifdef RENDER_LINE_GRADIENT
highp vec4 out_color=texture2D(u_gradient_image,v_uv.xy);
#else
vec4 out_color=color;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);}}
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef RENDER_LINE_ALPHA_DISCARD
if (alpha < u_alpha_discard_threshold) {discard;}
#endif
#ifdef RENDER_LINE_BORDER
float edgeBlur=(u_border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);
#ifdef RENDER_LINE_BORDER_AUTO
float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}
#else
out_color.rgb=mix(u_border_color.rgb,out_color.rgb,smoothAlpha);
#endif
}
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
attribute highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash_from
#pragma mapbox: define lowp vec4 dash_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash_from
#pragma mapbox: initialize lowp vec4 dash_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:fr(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:fr(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:fr(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}`),symbolSDF:fr(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}`),symbolTextAndIcon:fr(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}`),terrainRaster:fr(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#endif
void main() {vec4 color=texture2D(u_image0,v_pos0);
#ifdef RENDER_SHADOWS
color.xyz=shadowed_color(color.xyz,v_pos_light_view_0,v_pos_light_view_1,v_depth);
#endif
#ifdef FOG
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#endif
const float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;
#ifdef TERRAIN_WIREFRAME
elevation+=u_skirt_height*u_skirt_height*wireframeOffset;
#endif
vec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;
#endif
}`),terrainDepth:fr(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:fr(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Ka),skyboxGradient:fr(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Ka),skyboxCapture:fr(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:fr(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture2D(u_image0,v_pos0);color=vec4(raster.rgb*antialias,raster.a*antialias);
#else
color=texture2D(u_image0,v_pos0);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;
#ifdef GLOBE_POLES
attribute vec3 a_globe_pos;attribute vec2 a_uv;
#else
attribute vec2 a_pos;
#endif
varying vec2 v_pos0;const float wireframeOffset=1e3;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 latLng=u_grid_matrix*vec3(a_pos,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;
#ifdef GLOBE_POLES
vec3 up_vector=normalize(globe_pos)*u_tile_up_scale;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);
#ifdef TERRAIN_WIREFRAME
height+=wireframeOffset;
#endif
globe_pos+=up_vector*height;
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:fr(`uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec3 u_start_color;uniform vec4 u_color;uniform vec4 u_space_color;uniform vec4 u_high_color;uniform float u_star_intensity;uniform float u_star_size;uniform float u_star_density;uniform float u_horizon_angle;uniform mat4 u_rotation_matrix;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;highp float random(highp vec3 p) {p=fract(p*vec3(23.2342,97.1231,91.2342));p+=dot(p.zxy,p.yxz+123.1234);return fract(p.x*p.y);}float stars(vec3 p,float scale,vec2 offset) {vec2 uv_scale=(u_viewport/u_star_size)*scale;vec3 position=vec3(p.xy*uv_scale+offset*u_viewport,p.z);vec3 q=fract(position)-0.5;vec3 id=floor(position);float random_visibility=step(random(id),u_star_density);float circle=smoothstep(0.5+u_star_intensity,0.5,length(q));return circle*random_visibility;}void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {discard;return;}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(dot(dir,horizon_dir)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;float closest_point_to_center=length(closest_point-u_globe_pos);float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c =mix(color_stop_2,c2,t);float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);vec2 uv=gl_FragCoord.xy/u_viewport-0.5;float aspect_ratio=u_viewport.x/u_viewport.y;vec4 uv_dir=vec4(normalize(vec3(uv.x*aspect_ratio,uv.y,1.0)),1.0);uv_dir=u_rotation_matrix*uv_dir;vec3 n=abs(uv_dir.xyz);vec2 uv_remap=(n.x > n.y && n.x > n.z) ? uv_dir.yz/uv_dir.x:
(n.y > n.x && n.y > n.z) ? uv_dir.zx/uv_dir.y:
uv_dir.xy/uv_dir.z;uv_remap.x/=aspect_ratio;vec3 D=vec3(uv_remap,1.0);highp float star_field=0.0;if (u_star_intensity > 0.0) {star_field+=stars(D,1.2,vec2(0.0,0.0));star_field+=stars(D,1.0,vec2(1.0,0.0));star_field+=stars(D,0.8,vec2(0.0,1.0));star_field+=stars(D,0.6,vec2(1.0,1.0));star_field*=(1.0-pow(t,0.25+(1.0-u_high_color.a)*0.75));c+=star_field*alpha_2;}c=dither(c,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=vec4(c,a);}`,`attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`)};function to(g,c){const p=g.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let x of p)if(x=x.trim(),x[0]==="#"&&x.includes("if")&&!x.includes("endif")){x=x.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const T=x.split(" ");for(const A of T)c.includes(A)||c.push(A)}}function fr(g,c){const p=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,x=c.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),T={},A=[...po];return to(g,A),to(c,A),{fragmentSource:g=g.replace(p,(k,O,F,V,G)=>(T[G]=!0,O==="define"?`
#ifndef HAS_UNIFORM_u_${G}
varying ${F} ${V} ${G};
#else
uniform ${F} ${V} u_${G};
#endif
`:`
#ifdef HAS_UNIFORM_u_${G}
    ${F} ${V} ${G} = u_${G};
#endif
`)),vertexSource:c=c.replace(p,(k,O,F,V,G)=>{const ie=V==="float"?"vec2":"vec4",le=G.match(/color/)?"color":ie;return T[G]?O==="define"?`
#ifndef HAS_UNIFORM_u_${G}
uniform lowp float u_${G}_t;
attribute ${F} ${ie} a_${G};
varying ${F} ${V} ${G};
#else
uniform ${F} ${V} u_${G};
#endif
`:le==="vec4"?`
#ifndef HAS_UNIFORM_u_${G}
    ${G} = a_${G};
#else
    ${F} ${V} ${G} = u_${G};
#endif
`:`
#ifndef HAS_UNIFORM_u_${G}
    ${G} = unpack_mix_${le}(a_${G}, u_${G}_t);
#else
    ${F} ${V} ${G} = u_${G};
#endif
`:O==="define"?`
#ifndef HAS_UNIFORM_u_${G}
uniform lowp float u_${G}_t;
attribute ${F} ${ie} a_${G};
#else
uniform ${F} ${V} u_${G};
#endif
`:le==="vec4"?`
#ifndef HAS_UNIFORM_u_${G}
    ${F} ${V} ${G} = a_${G};
#else
    ${F} ${V} ${G} = u_${G};
#endif
`:`
#ifndef HAS_UNIFORM_u_${G}
    ${F} ${V} ${G} = unpack_mix_${le}(a_${G}, u_${G}_t);
#else
    ${F} ${V} ${G} = u_${G};
#endif
`}),staticAttributes:x,usedDefines:A}}class sa{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(c,p,x,T,A,k,O){this.context=c;let F=this.boundPaintVertexBuffers.length!==T.length;for(let G=0;!F&&G<T.length;G++)this.boundPaintVertexBuffers[G]!==T[G]&&(F=!0);let V=this.boundDynamicVertexBuffers.length!==O.length;for(let G=0;!V&&G<O.length;G++)this.boundDynamicVertexBuffers[G]!==O[G]&&(V=!0);if(!c.extVertexArrayObject||!this.vao||this.boundProgram!==p||this.boundLayoutVertexBuffer!==x||F||V||this.boundIndexBuffer!==A||this.boundVertexOffset!==k)this.freshBind(p,x,T,A,k,O);else{c.bindVertexArrayOES.set(this.vao);for(const G of O)G&&G.bind();A&&A.dynamicDraw&&A.bind()}}freshBind(c,p,x,T,A,k){let O;const F=c.numAttributes,V=this.context,G=V.gl;if(V.extVertexArrayObject)this.vao&&this.destroy(),this.vao=V.extVertexArrayObject.createVertexArrayOES(),V.bindVertexArrayOES.set(this.vao),O=0,this.boundProgram=c,this.boundLayoutVertexBuffer=p,this.boundPaintVertexBuffers=x,this.boundIndexBuffer=T,this.boundVertexOffset=A,this.boundDynamicVertexBuffers=k;else{O=V.currentNumAttributes||0;for(let ie=F;ie<O;ie++)G.disableVertexAttribArray(ie)}p.enableAttributes(G,c),p.bind(),p.setVertexAttribPointers(G,c,A);for(const ie of x)ie.enableAttributes(G,c),ie.bind(),ie.setVertexAttribPointers(G,c,A);for(const ie of k)ie&&(ie.enableAttributes(G,c),ie.bind(),ie.setVertexAttribPointers(G,c,A));T&&T.bind(),V.currentNumAttributes=F}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function la(g,c){const p=Math.pow(2,c.canonical.z),x=c.canonical.y;return[new o.MercatorCoordinate(0,x/p).toLngLat().lat,new o.MercatorCoordinate(0,(x+1)/p).toLngLat().lat]}function io(g,c,p,x,T,A,k){const O=g.context,F=O.gl,V=p.fbo;if(!V)return;g.prepareDrawTile();const G=g.useProgram("hillshade");O.activeTexture.set(F.TEXTURE0),F.bindTexture(F.TEXTURE_2D,V.colorAttachment.get());const ie=((ve,me,de,be)=>{const ge=de.paint.get("hillshade-shadow-color"),Be=de.paint.get("hillshade-highlight-color"),ze=de.paint.get("hillshade-accent-color");let Me=de.paint.get("hillshade-illumination-direction")*(Math.PI/180);de.paint.get("hillshade-illumination-anchor")==="viewport"&&(Me-=ve.transform.angle);const Fe=!ve.options.moving;return{u_matrix:be||ve.transform.calculateProjMatrix(me.tileID.toUnwrapped(),Fe),u_image:0,u_latrange:la(0,me.tileID),u_light:[de.paint.get("hillshade-exaggeration"),Me],u_shadow:ge,u_highlight:Be,u_accent:ze}})(g,p,x,g.terrain?c.projMatrix:null);g.prepareDrawProgram(O,G,c.toUnwrapped());const{tileBoundsBuffer:le,tileBoundsIndexBuffer:_e,tileBoundsSegments:fe}=g.getTileBoundsBuffers(p);G.draw(O,F.TRIANGLES,T,A,k,o.CullFaceMode.disabled,ie,x.id,le,_e,fe)}function Fn(g,c,p){if(!c.needsDEMTextureUpload)return;const x=g.context,T=x.gl;x.pixelStoreUnpackPremultiplyAlpha.set(!1),c.demTexture=c.demTexture||g.getTileTexture(p.stride);const A=p.getPixels();c.demTexture?c.demTexture.update(A,{premultiply:!1}):c.demTexture=new o.Texture(x,A,T.RGBA,{premultiply:!1}),c.needsDEMTextureUpload=!1}function Mo(g,c,p,x,T,A){const k=g.context,O=k.gl;if(!c.dem)return;const F=c.dem;if(k.activeTexture.set(O.TEXTURE1),Fn(g,c,F),!c.demTexture)return;c.demTexture.bind(O.NEAREST,O.CLAMP_TO_EDGE);const V=F.dim;k.activeTexture.set(O.TEXTURE0);let G=c.fbo;if(!G){const fe=new o.Texture(k,{width:V,height:V,data:null},O.RGBA);fe.bind(O.LINEAR,O.CLAMP_TO_EDGE),G=c.fbo=k.createFramebuffer(V,V,!0),G.colorAttachment.set(fe.texture)}k.bindFramebuffer.set(G.framebuffer),k.viewport.set([0,0,V,V]);const{tileBoundsBuffer:ie,tileBoundsIndexBuffer:le,tileBoundsSegments:_e}=g.getMercatorTileBoundsBuffers();g.useProgram("hillshadePrepare").draw(k,O.TRIANGLES,x,T,A,o.CullFaceMode.disabled,((fe,ve)=>{const me=ve.stride,de=o.create();return o.ortho(de,0,o.EXTENT,-o.EXTENT,0,0,1),o.translate(de,de,[0,-o.EXTENT,0]),{u_matrix:de,u_image:1,u_dimension:[me,me],u_zoom:fe.overscaledZ,u_unpack:ve.unpackVector}})(c.tileID,F),p.id,ie,le,_e),c.needsHillshadePrepare=!1}const No=g=>({u_matrix:new o.UniformMatrix4f(g),u_image0:new o.Uniform1i(g),u_skirt_height:new o.Uniform1f(g)}),ro=(g,c)=>({u_matrix:g,u_image0:0,u_skirt_height:c}),Ja=(g,c,p,x,T,A,k,O,F,V,G,ie,le,_e)=>({u_proj_matrix:Float32Array.from(g),u_globe_matrix:c,u_normalize_matrix:Float32Array.from(x),u_merc_matrix:p,u_zoom_transition:T,u_merc_center:A,u_image0:0,u_frustum_tl:k,u_frustum_tr:O,u_frustum_br:F,u_frustum_bl:V,u_globe_pos:G,u_globe_radius:ie,u_viewport:le,u_grid_matrix:_e?Float32Array.from(_e):new Float32Array(9)});function Ao(g,c){return g!=null&&c!=null&&!(!g.hasData()||!c.hasData())&&g.demTexture!=null&&c.demTexture!=null&&g.tileID.key!==c.tileID.key}const Nn=new class{constructor(){this.operations={}}newMorphing(g,c,p,x,T){if(g in this.operations){const A=this.operations[g];A.to.tileID.key!==p.tileID.key&&(A.queued=p)}else this.operations[g]={startTime:x,phase:0,duration:T,from:c,to:p,queued:null}}getMorphValuesForProxy(g){if(!(g in this.operations))return null;const c=this.operations[g];return{from:c.from,to:c.to,phase:c.phase}}update(g){for(const c in this.operations){const p=this.operations[c];for(p.phase=(g-p.startTime)/p.duration;p.phase>=1||!this._validOp(p);)if(!this._nextOp(p,g)){delete this.operations[c];break}}}_nextOp(g,c){return!!g.queued&&(g.from=g.to,g.to=g.queued,g.queued=null,g.phase=0,g.startTime=c,!0)}_validOp(g){return g.from.hasData()&&g.to.hasData()}},Uo={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function ur(g,c){const p=1<<g.z;return!c&&(g.x===0||g.x===p-1)||g.y===0||g.y===p-1}const ca=g=>({u_matrix:g});function Ss(g,c,p,x,T){if(T>0){const A=o.exported.now(),k=(A-g.timeAdded)/T,O=c?(A-c.timeAdded)/T:-1,F=p.getSource(),V=x.coveringZoomLevel({tileSize:F.tileSize,roundZoom:F.roundZoom}),G=!c||Math.abs(c.tileID.overscaledZ-V)>Math.abs(g.tileID.overscaledZ-V),ie=G&&g.refreshedUponExpiration?1:o.clamp(G?k:1-O,0,1);return g.refreshedUponExpiration&&k>=1&&(g.refreshedUponExpiration=!1),c?{opacity:1,mix:1-ie}:{opacity:ie,mix:0}}return{opacity:1,mix:0}}class Ms extends o.SourceCache{constructor(c){const p={type:"raster-dem",maxzoom:c.transform.maxZoom},x=new dt(Di(),null),T=Ge("mock-dem",p,x,c.style);super("mock-dem",T,!1),T.setEventedParent(this),this._sourceLoaded=!0}_loadTile(c,p){c.state="loaded",p(null)}}class As extends o.SourceCache{constructor(c){const p=Ge("proxy",{type:"geojson",maxzoom:c.transform.maxZoom},new dt(Di(),null),c.style);super("proxy",p,!1),p.setEventedParent(this),this.map=this.getSource().map=c,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(c,p,x){if(c.freezeTileCoverage)return;this.transform=c;const T=c.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((A,k)=>{if(A[k.key]="",!this._tiles[k.key]){const O=new o.Tile(k,this._source.tileSize*k.overscaleFactor(),c.tileZoom);O.state="loaded",this._tiles[k.key]=O}return A},{});for(const A in this._tiles)A in T||(this.freeFBO(A),this._tiles[A].unloadVectorData(),delete this._tiles[A])}freeFBO(c){const p=this.proxyCachedFBO[c];if(p!==void 0){const x=Object.values(p);this.renderCachePool.push(...x),delete this.proxyCachedFBO[c]}}deallocRenderCache(){this.renderCache.forEach(c=>c.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class $o extends o.OverscaledTileID{constructor(c,p,x){super(c.overscaledZ,c.wrap,c.canonical.z,c.canonical.x,c.canonical.y),this.proxyTileKey=p,this.projMatrix=x}}class Vo extends o.Elevation{constructor(c,p){super(),this.painter=c,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[x,T,A]=function(F){const V=new o.StructArrayLayout4i8,G=new o.StructArrayLayout3ui6,ie=131;V.reserve(17161),G.reserve(33800);const le=o.EXTENT/128,_e=o.EXTENT+le/2,fe=_e+le;for(let me=-le;me<fe;me+=le)for(let de=-le;de<fe;de+=le){const be=de<0||de>_e||me<0||me>_e?24575:0,ge=o.clamp(Math.round(de),0,o.EXTENT),Be=o.clamp(Math.round(me),0,o.EXTENT);V.emplaceBack(ge+be,Be,ge,Be)}const ve=(me,de)=>{const be=de*ie+me;G.emplaceBack(be+1,be,be+ie),G.emplaceBack(be+ie,be+ie+1,be+1)};for(let me=1;me<129;me++)for(let de=1;de<129;de++)ve(de,me);return[0,129].forEach(me=>{for(let de=0;de<130;de++)ve(de,me),ve(me,de)}),[V,G,32768]}(),k=c.context;this.gridBuffer=k.createVertexBuffer(x,o.boundsAttributes.members),this.gridIndexBuffer=k.createIndexBuffer(T),this.gridSegments=o.SegmentVector.simpleSegment(0,0,x.length,T.length),this.gridNoSkirtSegments=o.SegmentVector.simpleSegment(0,0,x.length,A),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new As(p.map),this.orthoMatrix=o.create(),o.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,o.EXTENT,0,o.EXTENT,0,1);const O=k.gl;this._overlapStencilMode=new o.StencilMode({func:O.GEQUAL,mask:255},0,255,O.KEEP,O.KEEP,O.REPLACE),this._previousZoom=c.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=p,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Ms(p.map)}set style(c){c.on("data",this._onStyleDataEvent.bind(this)),c.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=c,this._checkRenderCacheEfficiency()}update(c,p,x){if(c&&c.terrain){this._style!==c&&(this.style=c),this.enabled=!0;const T=c.terrain.properties;this.sourceCache=c.terrain.drapeRenderMode===0?this._mockSourceCache:c._getSourceCache(T.get("source")),this._exaggeration=T.get("exaggeration");const A=()=>{this.sourceCache.used&&o.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const k=this.getScaledDemTileSize();this.sourceCache.update(p,k,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,A(),this._initializing=!0),A(),p.updateElevation(!x),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(p),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(c){this._findCoveringTileCache[c]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const c=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||c.efficiency!==100&&o.warnOnce(`Terrain render cache efficiency is not optimal (${c.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${c.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(c){c.coord&&c.dataType==="source"?this._clearRenderCacheForTile(c.sourceCacheId,c.coord):c.dataType==="style"&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const c in this._style._sourceCaches)this._style._sourceCaches[c].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(c=>c.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0)}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const c=2*this.proxySourceCache.getSource().tileSize;return[c,c]}set useVertexMorphing(c){this._useVertexMorphing=c}updateTileBinding(c){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const p=this.proxySourceCache,x=this.painter.transform;this._initializing&&(this._initializing=x._centerAltitude===0&&this.getAtPointOrZero(o.MercatorCoordinate.fromLngLat(x.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const T=this.proxyCoords=p.getIds().map(F=>{const V=p.getTileByID(F).tileID;return V.projMatrix=x.calculateProjMatrix(V.toUnwrapped()),V});(function(F,V){const G=V.transform.pointCoordinate(V.transform.getCameraPoint()),ie=new o.pointGeometry(G.x,G.y);F.sort((le,_e)=>{if(_e.overscaledZ-le.overscaledZ)return _e.overscaledZ-le.overscaledZ;const fe=new o.pointGeometry(le.canonical.x+(1<<le.canonical.z)*le.wrap,le.canonical.y),ve=new o.pointGeometry(_e.canonical.x+(1<<_e.canonical.z)*_e.wrap,_e.canonical.y),me=ie.mult(1<<le.canonical.z);return me.x-=.5,me.y-=.5,me.distSqr(fe)-me.distSqr(ve)})})(T,this.painter),this._previousZoom=x.zoom;const A=this.proxyToSource||{};this.proxyToSource={},T.forEach(F=>{this.proxyToSource[F.key]={}}),this.terrainTileForTile={};const k=this._style._sourceCaches;for(const F in k){const V=k[F];if(!V.used||(V!==this.sourceCache&&this.resetTileLookupCache(V.id),this._setupProxiedCoordsForOrtho(V,c[F],A),V.usedForTerrain))continue;const G=c[F];V.getSource().reparseOverscaled&&this._assignTerrainTiles(G)}this.proxiedCoords[p.id]=T.map(F=>new $o(F,F.key,this.orthoMatrix)),this._assignTerrainTiles(T),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(A),this.renderingToTexture=!1,this._updateTimestamp=o.exported.now();const O={};this._visibleDemTiles=[];for(const F of this.proxyCoords){const V=this.terrainTileForTile[F.key];if(!V)continue;const G=V.tileID.key;G in O||(this._visibleDemTiles.push(V),O[G]=G)}}_assignTerrainTiles(c){this._initializing||c.forEach(p=>{if(this.terrainTileForTile[p.key])return;const x=this._findTileCoveringTileID(p,this.sourceCache);x&&(this.terrainTileForTile[p.key]=x)})}_prepareDEMTextures(){const c=this.painter.context,p=c.gl;for(const x in this.terrainTileForTile){const T=this.terrainTileForTile[x],A=T.dem;!A||T.demTexture&&!T.needsDEMTextureUpload||(c.activeTexture.set(p.TEXTURE1),Fn(this.painter,T,A))}}_prepareDemTileUniforms(c,p,x,T){if(!p||p.demTexture==null)return!1;const A=c.tileID.canonical,k=Math.pow(2,p.tileID.canonical.z-A.z),O=T||"";return x[`u_dem_tl${O}`]=[A.x*k%1,A.y*k%1],x[`u_dem_scale${O}`]=k,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const c=this.painter.context,p=c.gl;if(!this._emptyDepthBufferTexture){const x=new o.RGBAImage({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new o.Texture(c,x,p.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let c=0;const p=this._visibleDemTiles.reduce((x,T)=>{if(!T.dem)return x;const A=T.dem.tree.minimums[0];return A>0&&c++,x+A},0);return c?p/c:0}_updateEmptyDEMTexture(){const c=this.painter.context,p=c.gl;c.activeTexture.set(p.TEXTURE2);const x=this._getLoadedAreaMinimum(),T=new o.RGBAImage({width:1,height:1},new Uint8Array(o.DEMData.pack(x,this.sourceCache.getSource().encoding)));this._emptyDEMTextureDirty=!1;let A=this._emptyDEMTexture;return A?A.update(T,{premultiply:!1}):A=this._emptyDEMTexture=new o.Texture(c,T,p.RGBA,{premultiply:!1}),A}setupElevationDraw(c,p,x){const T=this.painter.context,A=T.gl,k=(O=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:o.DEMData.getUnpackVector(O),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0});var O;k.u_dem_size=this.sourceCache.getSource().tileSize,k.u_exaggeration=this.exaggeration();let F=null,V=null,G=1;if(x&&x.morphing&&this._useVertexMorphing){const ie=x.morphing.srcDemTile,le=x.morphing.dstDemTile;G=x.morphing.phase,ie&&le&&(this._prepareDemTileUniforms(c,ie,k,"_prev")&&(V=ie),this._prepareDemTileUniforms(c,le,k)&&(F=le))}if(V&&F?(T.activeTexture.set(A.TEXTURE2),F.demTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE,A.NEAREST),T.activeTexture.set(A.TEXTURE4),V.demTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE,A.NEAREST),k.u_dem_lerp=G):(F=this.terrainTileForTile[c.tileID.key],T.activeTexture.set(A.TEXTURE2),(this._prepareDemTileUniforms(c,F,k)?F.demTexture:this.emptyDEMTexture).bind(A.NEAREST,A.CLAMP_TO_EDGE)),T.activeTexture.set(A.TEXTURE3),x&&x.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE),this._depthFBO&&(k.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE),k.u_depth_size_inv=[1,1]),x&&x.useMeterToDem&&F){const ie=(1<<F.tileID.canonical.z)*o.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;k.u_meter_to_dem=ie}if(x&&x.labelPlaneMatrixInv&&(k.u_label_plane_matrix_inv=x.labelPlaneMatrixInv),p.setTerrainUniformValues(T,k),this.painter.transform.projection.name==="globe"){const ie=this.globeUniformValues(this.painter.transform,c.tileID.canonical,x&&x.useDenormalizedUpVectorScale);p.setGlobeUniformValues(T,ie)}}globeUniformValues(c,p,x){const T=c.projection;return{u_tile_tl_up:T.upVector(p,0,0),u_tile_tr_up:T.upVector(p,o.EXTENT,0),u_tile_br_up:T.upVector(p,o.EXTENT,o.EXTENT),u_tile_bl_up:T.upVector(p,0,o.EXTENT),u_tile_up_scale:x?o.GLOBE_METERS_TO_ECEF:T.upVectorScale(p,c.center.lat,c.worldSize).metersToTile}}renderToBackBuffer(c){const p=this.painter,x=this.painter.context;c.length!==0&&(x.bindFramebuffer.set(null),x.viewport.set([0,0,p.width,p.height]),p.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(T,A,k,O,F){if(T.transform.projection.name==="globe")(function(V,G,ie,le,_e){const fe=V.context,ve=fe.gl;let me,de;const be=V.options.showTerrainWireframe?2:0,ge=V.transform,Be=o.globeUseCustomAntiAliasing(V,fe,ge),ze=(tt,Ve)=>{if(de===tt)return;const ri=[Uo[tt],"PROJECTION_GLOBE_VIEW"];Be&&ri.push("CUSTOM_ANTIALIASING"),Ve&&ri.push(Uo[be]),me=V.useProgram("globeRaster",null,ri),de=tt},Me=V.colorModeForRenderPass(),Fe=new o.DepthMode(ve.LEQUAL,o.DepthMode.ReadWrite,V.depthRangeFor3D);Nn.update(_e);const Je=o.calculateGlobeMercatorMatrix(ge),lt=[o.mercatorXfromLng(ge.center.lng),o.mercatorYfromLat(ge.center.lat)],ot=be?[!1,!0]:[!1],zt=V.globeSharedBuffers,He=[ge.width*o.exported.devicePixelRatio,ge.height*o.exported.devicePixelRatio],wt=Float32Array.from(ge.globeMatrix),bt={useDenormalizedUpVectorScale:!0};if(ot.forEach(tt=>{de=-1;const Ve=tt?ve.LINES:ve.TRIANGLES;for(const ri of le){const qt=ie.getTile(ri),Jt=o.StencilMode.disabled,Ht=G.prevTerrainTileForTile[ri.key],Ai=G.terrainTileForTile[ri.key];Ao(Ht,Ai)&&Nn.newMorphing(ri.key,Ht,Ai,_e,250),fe.activeTexture.set(ve.TEXTURE0),qt.texture.bind(ve.LINEAR,ve.CLAMP_TO_EDGE);const Vi=Nn.getMorphValuesForProxy(ri.key),Ni=Vi?1:0;Vi&&o.extend$1(bt,{morphing:{srcDemTile:Vi.from,dstDemTile:Vi.to,phase:o.easeCubicInOut(Vi.phase)}});const Bi=o.tileCornersToBounds(ri.canonical),Wt=o.getLatitudinalLod(Bi.getCenter().lat),Zi=o.getGridMatrix(ri.canonical,Bi,Wt,ge.worldSize/ge._pixelsPerMercatorPixel),er=o.globeNormalizeECEF(o.globeTileBounds(ri.canonical)),Tr=Ja(ge.projMatrix,wt,Je,er,o.globeToMercatorTransition(ge.zoom),lt,ge.frustumCorners.TL,ge.frustumCorners.TR,ge.frustumCorners.BR,ge.frustumCorners.BL,ge.globeCenterInViewSpace,ge.globeRadius,He,Zi);if(ze(Ni,tt),G.setupElevationDraw(qt,me,bt),V.prepareDrawProgram(fe,me,ri.toUnwrapped()),zt){const[Sr,vr,fn]=tt?zt.getWirefameBuffers(V.context,Wt):zt.getGridBuffers(Wt);me.draw(fe,Ve,Fe,Jt,Me,o.CullFaceMode.backCCW,Tr,"globe_raster",Sr,vr,fn)}}}),zt){const tt=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Be&&tt.push("CUSTOM_ANTIALIASING"),me=V.useProgram("globeRaster",null,tt);for(const Ve of le){const{x:ri,y:qt,z:Jt}=Ve.canonical,Ht=qt===0,Ai=qt===(1<<Jt)-1,[Vi,Ni,Bi,Wt]=zt.getPoleBuffers(Jt);if(Wt&&(Ht||Ai)){const Zi=ie.getTile(Ve);fe.activeTexture.set(ve.TEXTURE0),Zi.texture.bind(ve.LINEAR,ve.CLAMP_TO_EDGE);let er=o.globePoleMatrixForTile(Jt,ri,ge);const Tr=o.globeNormalizeECEF(o.globeTileBounds(Ve.canonical)),Sr=(vr,fn)=>vr.draw(fe,ve.TRIANGLES,Fe,o.StencilMode.disabled,Me,o.CullFaceMode.disabled,Ja(ge.projMatrix,er,er,Tr,0,lt,ge.frustumCorners.TL,ge.frustumCorners.TR,ge.frustumCorners.BR,ge.frustumCorners.BL,ge.globeCenterInViewSpace,ge.globeRadius,He),"globe_pole_raster",fn,Bi,Wt);G.setupElevationDraw(Zi,me,bt),V.prepareDrawProgram(fe,me,Ve.toUnwrapped()),Ht&&Sr(me,Vi),Ai&&(er=o.scale(o.create(),er,[1,-1,1]),Sr(me,Ni))}}}})(T,A,k,O,F);else{const V=T.context,G=V.gl;let ie,le;const _e=T.options.showTerrainWireframe?2:0,fe=(ge,Be)=>{if(le===ge)return;const ze=[Uo[ge]];Be&&ze.push(Uo[_e]),ie=T.useProgram("terrainRaster",null,ze),le=ge},ve=T.colorModeForRenderPass(),me=new o.DepthMode(G.LEQUAL,o.DepthMode.ReadWrite,T.depthRangeFor3D);Nn.update(F);const de=T.transform,be=6*Math.pow(1.5,22-de.zoom)*A.exaggeration();(_e?[!1,!0]:[!1]).forEach(ge=>{le=-1;const Be=ge?G.LINES:G.TRIANGLES,[ze,Me]=ge?A.getWirefameBuffer():[A.gridIndexBuffer,A.gridSegments];for(const Fe of O){const Je=k.getTile(Fe),lt=o.StencilMode.disabled,ot=A.prevTerrainTileForTile[Fe.key],zt=A.terrainTileForTile[Fe.key];Ao(ot,zt)&&Nn.newMorphing(Fe.key,ot,zt,F,250),V.activeTexture.set(G.TEXTURE0),Je.texture.bind(G.LINEAR,G.CLAMP_TO_EDGE,G.LINEAR_MIPMAP_NEAREST);const He=Nn.getMorphValuesForProxy(Fe.key),wt=He?1:0;let bt;He&&(bt={morphing:{srcDemTile:He.from,dstDemTile:He.to,phase:o.easeCubicInOut(He.phase)}});const tt=ro(Fe.projMatrix,ur(Fe.canonical,de.renderWorldCopies)?be/10:be);fe(wt,ge),A.setupElevationDraw(Je,ie,bt),T.prepareDrawProgram(V,ie,Fe.toUnwrapped()),ie.draw(V,Be,me,lt,ve,o.CullFaceMode.backCCW,tt,"terrain_raster",A.gridBuffer,ze,Me)}})}}(p,this,this.proxySourceCache,c,this._updateTimestamp),this.renderingToTexture=!0,p.gpuTimingDeferredRenderEnd(),c.splice(0,c.length))}renderBatch(c){if(this._drapedRenderBatches.length===0)return c+1;this.renderingToTexture=!0;const p=this.painter,x=this.painter.context,T=this.proxySourceCache,A=this.proxiedCoords[T.id],k=this._drapedRenderBatches.shift(),O=[],F=p.style.order;let V=0;for(const G of A){const ie=T.getTileByID(G.proxyTileKey),le=T.proxyCachedFBO[G.key]?T.proxyCachedFBO[G.key][c]:void 0,_e=le!==void 0?T.renderCache[le]:this.pool[V++],fe=le!==void 0;if(ie.texture=_e.tex,fe&&!_e.dirty){O.push(ie.tileID);continue}let ve;x.bindFramebuffer.set(_e.fb.framebuffer),this.renderedToTile=!1,_e.dirty&&(x.clear({color:o.Color.transparent,stencil:0}),_e.dirty=!1);for(let me=k.start;me<=k.end;++me){const de=p.style._layers[F[me]];if(de.isHidden(p.transform.zoom))continue;const be=p.style._getLayerSourceCache(de),ge=be?this.proxyToSource[G.key][be.id]:[G];if(!ge)continue;const Be=ge;x.viewport.set([0,0,_e.fb.width,_e.fb.height]),ve!==(be?be.id:null)&&(this._setupStencil(_e,ge,de,be),ve=be?be.id:null),p.renderLayer(p,be,de,Be)}this.renderedToTile?(_e.dirty=!0,O.push(ie.tileID)):fe||--V,V===5&&(V=0,this.renderToBackBuffer(O))}return this.renderToBackBuffer(O),this.renderingToTexture=!1,x.bindFramebuffer.set(null),x.viewport.set([0,0,p.width,p.height]),k.end+1}postRender(){}renderCacheEfficiency(c){const p=c.order.length;if(p===0)return{efficiency:100};let x,T=0,A=0,k=!1;for(let O=0;O<p;++O){const F=c._layers[c.order[O]];this._style.isLayerDraped(F)?(k&&++T,++A):k||(k=!0,x=F.id)}return A===0?{efficiency:100}:{efficiency:100*(1-T/A),firstUndrapedLayer:x}}getMinElevationBelowMSL(){let c=0;return this._visibleDemTiles.filter(p=>p.dem).forEach(p=>{c=Math.min(c,p.dem.tree.minimums[0])}),c===0?c:(c-30)*this._exaggeration}raycast(c,p,x){if(!this._visibleDemTiles)return null;const T=this._visibleDemTiles.filter(A=>A.dem).map(A=>{const k=A.tileID,O=1<<k.overscaledZ,{x:F,y:V}=k.canonical,G=F/O,ie=(F+1)/O,le=V/O,_e=(V+1)/O;return{minx:G,miny:le,maxx:ie,maxy:_e,t:A.dem.tree.raycastRoot(G,le,ie,_e,c,p,x),tile:A}});T.sort((A,k)=>(A.t!==null?A.t:Number.MAX_VALUE)-(k.t!==null?k.t:Number.MAX_VALUE));for(const A of T){if(A.t==null)return null;const k=A.tile.dem.tree.raycast(A.minx,A.miny,A.maxx,A.maxy,c,p,x);if(k!=null)return k}return null}_createFBO(){const c=this.painter.context,p=c.gl,x=this.drapeBufferSize;c.activeTexture.set(p.TEXTURE0);const T=new o.Texture(c,{width:x[0],height:x[1],data:null},p.RGBA);T.bind(p.LINEAR,p.CLAMP_TO_EDGE);const A=c.createFramebuffer(x[0],x[1],!1);return A.colorAttachment.set(T.texture),A.depthAttachment=new at(c,A.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=c.createRenderbuffer(c.gl.DEPTH_STENCIL,x[0],x[1]),this._stencilRef=0,A.depthAttachment.set(this._sharedDepthStencil),c.clear({stencil:0})):A.depthAttachment.set(this._sharedDepthStencil),c.extTextureFilterAnisotropic&&!c.extTextureFilterAnisotropicForceOff&&p.texParameterf(p.TEXTURE_2D,c.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.extTextureFilterAnisotropicMax),{fb:A,tex:T,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const c in this._style._sourceCaches)if(this._style._sourceCaches[c].hasTransition())return!0;return this._style.order.some(c=>{const p=this._style._layers[c],x=p.isHidden(this.painter.transform.zoom),T=p.getCrossfadeParameters(),A=!!T&&T.t!==1,k=p.hasTransition();return p.type!=="custom"&&!x&&(A||k)})}_clearRasterFadeFromRenderCache(){let c=!1;for(const p in this._style._sourceCaches)if(this._style._sourceCaches[p]._source instanceof te){c=!0;break}if(c)for(let p=0;p<this._style.order.length;++p){const x=this._style._layers[this._style.order[p]],T=x.isHidden(this.painter.transform.zoom),A=this._style._getLayerSourceCache(x);if(x.type!=="raster"||T||!A)continue;const k=x.paint.get("raster-fade-duration");for(const O of this.proxyCoords){const F=this.proxyToSource[O.key][A.id];if(F)for(const V of F){const G=Ss(A.getTile(V),A.findLoadedParent(V,0),A,this.painter.transform,k);(G.opacity!==1||G.mix!==0)&&this._clearRenderCacheForTile(A.id,V)}}}}_setupDrapedRenderBatches(){const c=this._style.order,p=c.length;if(p===0)return;const x=[];let T,A=0,k=this._style._layers[c[A]];for(;!this._style.isLayerDraped(k)&&k.isHidden(this.painter.transform.zoom)&&++A<p;)k=this._style._layers[c[A]];for(;A<p;++A){const O=this._style._layers[c[A]];O.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(O)?T===void 0&&(T=A):T!==void 0&&(x.push({start:T,end:A-1}),T=void 0))}T!==void 0&&x.push({start:T,end:A-1}),this._drapedRenderBatches=x}_setupRenderCache(c){const p=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,p.renderCache.length>p.renderCachePool.length){const k=Object.values(p.proxyCachedFBO);p.proxyCachedFBO={};for(let O=0;O<k.length;++O){const F=Object.values(k[O]);p.renderCachePool.push(...F)}}return}this._clearRasterFadeFromRenderCache();const x=this.proxyCoords,T=this._tilesDirty;for(let k=x.length-1;k>=0;k--){const O=x[k];if(p.getTileByID(O.key),p.proxyCachedFBO[O.key]!==void 0){const F=c[O.key],V=this.proxyToSource[O.key];let G=0;for(const ie in V){const le=V[ie],_e=F[ie];if(!_e||_e.length!==le.length||le.some((fe,ve)=>fe!==_e[ve]||T[ie]&&T[ie].hasOwnProperty(fe.key))){G=-1;break}++G}for(const ie in p.proxyCachedFBO[O.key])p.renderCache[p.proxyCachedFBO[O.key][ie]].dirty=G<0||G!==Object.values(F).length}}const A=[...this._drapedRenderBatches];A.sort((k,O)=>O.end-O.start-(k.end-k.start));for(const k of A)for(const O of x){if(p.proxyCachedFBO[O.key])continue;let F=p.renderCachePool.pop();F===void 0&&p.renderCache.length<50&&(F=p.renderCache.length,p.renderCache.push(this._createFBO())),F!==void 0&&(p.proxyCachedFBO[O.key]={},p.proxyCachedFBO[O.key][k.start]=F,p.renderCache[F].dirty=!0)}this._tilesDirty={}}_setupStencil(c,p,x,T){if(!T||!this._sourceTilesOverlap[T.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const A=this.painter.context,k=A.gl;if(p.length<=1)return void(this._overlapStencilType=!1);let O;if(x.isTileClipped())O=p.length,this._overlapStencilMode.test={func:k.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(p[0].overscaledZ>p[p.length-1].overscaledZ))return void(this._overlapStencilType=!1);O=1,this._overlapStencilMode.test={func:k.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+O>255&&(A.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=O,this._overlapStencilMode.ref=this._stencilRef,x.isTileClipped()&&this._renderTileClippingMasks(p,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(c){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[c.key]),this._overlapStencilMode):o.StencilMode.disabled}_renderTileClippingMasks(c,p){const x=this.painter,T=this.painter.context,A=T.gl;x._tileClippingMaskIDs={},T.setColorMode(o.ColorMode.disabled),T.setDepthMode(o.DepthMode.disabled);const k=x.useProgram("clippingMask");for(const O of c){const F=x._tileClippingMaskIDs[O.key]=--p;k.draw(T,A.TRIANGLES,o.DepthMode.disabled,new o.StencilMode({func:A.ALWAYS,mask:0},F,255,A.KEEP,A.KEEP,A.REPLACE),o.ColorMode.disabled,o.CullFaceMode.disabled,ca(O.projMatrix),"$clipping",x.tileExtentBuffer,x.quadTriangleIndexBuffer,x.tileExtentSegments)}}pointCoordinate(c){const p=this.painter.transform;if(c.x<0||c.x>p.width||c.y<0||c.y>p.height)return null;const x=[c.x,c.y,1,1];o.transformMat4$1(x,x,p.pixelMatrixInverse),o.scale$1(x,x,1/x[3]),x[0]/=p.worldSize,x[1]/=p.worldSize;const T=p._camera.position,A=o.mercatorZfromAltitude(1,p.center.lat),k=[T[0],T[1],T[2]/A,0],O=o.subtract([],x.slice(0,3),k);o.normalize(O,O);const F=this.raycast(k,O,this._exaggeration);return F!==null&&F?(o.scaleAndAdd(k,k,O,F),k[3]=k[2],k[2]*=A,k):null}drawDepth(){const c=this.painter,p=c.context,x=this.proxySourceCache,T=Math.ceil(c.width),A=Math.ceil(c.height);if(!this._depthFBO||this._depthFBO.width===T&&this._depthFBO.height===A||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const k=p.gl,O=p.createFramebuffer(T,A,!0);p.activeTexture.set(k.TEXTURE0);const F=new o.Texture(p,{width:T,height:A,data:null},k.RGBA);F.bind(k.NEAREST,k.CLAMP_TO_EDGE),O.colorAttachment.set(F.texture);const V=p.createRenderbuffer(p.gl.DEPTH_COMPONENT16,T,A);O.depthAttachment.set(V),this._depthFBO=O,this._depthTexture=F}p.bindFramebuffer.set(this._depthFBO.framebuffer),p.viewport.set([0,0,T,A]),function(k,O,F,V){if(k.transform.projection.name==="globe")return;const G=k.context,ie=G.gl;G.clear({depth:1});const le=k.useProgram("terrainDepth"),_e=new o.DepthMode(ie.LESS,o.DepthMode.ReadWrite,k.depthRangeFor3D);for(const fe of V){const ve=F.getTile(fe),me=ro(fe.projMatrix,0);O.setupElevationDraw(ve,le),le.draw(G,ie.TRIANGLES,_e,o.StencilMode.disabled,o.ColorMode.unblended,o.CullFaceMode.backCCW,me,"terrain_depth",O.gridBuffer,O.gridIndexBuffer,O.gridNoSkirtSegments)}}(c,this,x,this.proxyCoords)}_setupProxiedCoordsForOrtho(c,p,x){if(c.getSource()instanceof ke)return this._setupProxiedCoordsForImageSource(c,p,x);this._findCoveringTileCache[c.id]=this._findCoveringTileCache[c.id]||{};const T=this.proxiedCoords[c.id]=[],A=this.proxyCoords;for(let O=0;O<A.length;O++){const F=A[O],V=this._findTileCoveringTileID(F,c);if(V){const G=this._createProxiedId(F,V,x[F.key]&&x[F.key][c.id]);T.push(G),this.proxyToSource[F.key][c.id]=[G]}}let k=!1;for(let O=0;O<p.length;O++){const F=c.getTile(p[O]);if(!F||!F.hasData())continue;const V=this._findTileCoveringTileID(F.tileID,this.proxySourceCache);if(V&&V.tileID.canonical.z!==F.tileID.canonical.z){const G=this.proxyToSource[V.tileID.key][c.id],ie=this._createProxiedId(V.tileID,F,x[V.tileID.key]&&x[V.tileID.key][c.id]);G?G.splice(G.length-1,0,ie):this.proxyToSource[V.tileID.key][c.id]=[ie],T.push(ie),k=!0}}this._sourceTilesOverlap[c.id]=k}_setupProxiedCoordsForImageSource(c,p,x){if(!c.getSource().loaded())return;const T=this.proxiedCoords[c.id]=[],A=this.proxyCoords,k=c.getSource(),O=new o.pointGeometry(k.tileID.x,k.tileID.y)._div(1<<k.tileID.z),F=k.coordinates.map(o.MercatorCoordinate.fromLngLat).reduce((G,ie)=>(G.min.x=Math.min(G.min.x,ie.x-O.x),G.min.y=Math.min(G.min.y,ie.y-O.y),G.max.x=Math.max(G.max.x,ie.x-O.x),G.max.y=Math.max(G.max.y,ie.y-O.y),G),{min:new o.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new o.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),V=(G,ie)=>{const le=G.wrap+G.canonical.x/(1<<G.canonical.z),_e=G.canonical.y/(1<<G.canonical.z),fe=o.EXTENT/(1<<G.canonical.z),ve=ie.wrap+ie.canonical.x/(1<<ie.canonical.z),me=ie.canonical.y/(1<<ie.canonical.z);return le+fe<ve+F.min.x||le>ve+F.max.x||_e+fe<me+F.min.y||_e>me+F.max.y};for(let G=0;G<A.length;G++){const ie=A[G];for(let le=0;le<p.length;le++){const _e=c.getTile(p[le]);if(!_e||!_e.hasData()||V(ie,_e.tileID))continue;const fe=this._createProxiedId(ie,_e,x[ie.key]&&x[ie.key][c.id]),ve=this.proxyToSource[ie.key][c.id];ve?ve.push(fe):this.proxyToSource[ie.key][c.id]=[fe],T.push(fe)}}}_createProxiedId(c,p,x){let T=this.orthoMatrix;if(x){const A=x.find(k=>k.key===p.tileID.key);if(A)return A}if(p.tileID.key!==c.key){const A=c.canonical.z-p.tileID.canonical.z;let k,O,F;T=o.create();const V=p.tileID.wrap-c.wrap<<c.overscaledZ;A>0?(k=o.EXTENT>>A,O=k*((p.tileID.canonical.x<<A)-c.canonical.x+V),F=k*((p.tileID.canonical.y<<A)-c.canonical.y)):(k=o.EXTENT<<-A,O=o.EXTENT*(p.tileID.canonical.x-(c.canonical.x+V<<-A)),F=o.EXTENT*(p.tileID.canonical.y-(c.canonical.y<<-A))),o.ortho(T,0,k,0,k,0,1),o.translate(T,T,[O,F,0])}return new $o(p.tileID,c.key,T)}_findTileCoveringTileID(c,p){let x=p.getTile(c);if(x&&x.hasData())return x;const T=this._findCoveringTileCache[p.id],A=T[c.key];if(x=A?p.getTileByID(A):null,x&&x.hasData()||A===null)return x;let k=x?x.tileID:c,O=k.overscaledZ;const F=p.getSource().minzoom,V=[];if(!A){const ie=p.getSource().maxzoom;if(c.canonical.z>=ie){const le=c.canonical.z-ie;p.getSource().reparseOverscaled?(O=Math.max(c.canonical.z+2,p.transform.tileZoom),k=new o.OverscaledTileID(O,c.wrap,ie,c.canonical.x>>le,c.canonical.y>>le)):le!==0&&(O=ie,k=new o.OverscaledTileID(O,c.wrap,ie,c.canonical.x>>le,c.canonical.y>>le))}k.key!==c.key&&(V.push(k.key),x=p.getTile(k))}const G=ie=>{V.forEach(le=>{T[le]=ie}),V.length=0};for(O-=1;O>=F&&(!x||!x.hasData());O--){x&&G(x.tileID.key);const ie=k.calculateScaledKey(O);if(x=p.getTileByID(ie),x&&x.hasData())break;const le=T[ie];if(le===null)break;le===void 0?V.push(ie):x=p.getTileByID(le)}return G(x?x.tileID.key:null),x&&x.hasData()?x:null}findDEMTileFor(c){return this.enabled?this._findTileCoveringTileID(c,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(c,p){let x=this._tilesDirty[c];x||(x=this._tilesDirty[c]={}),x[p.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const c=function(p){let x=0;const T=new o.StructArrayLayout2ui4,A=131;for(let k=1;k<129;k++){for(let O=1;O<129;O++)x=k*A+O,T.emplaceBack(x,x+1),T.emplaceBack(x,x+A),T.emplaceBack(x+1,x+A),k===128&&T.emplaceBack(x+A,x+A+1);T.emplaceBack(x+1,x+1+A)}return T}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(c),this.wireframeSegments=o.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,c.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}class tl{static cacheKey(c,p,x,T){let A=`${p}${T?T.cacheKey:""}`;for(const k of x)c.usedDefines.includes(k)&&(A+=`/${k}`);return A}constructor(c,p,x,T,A,k){const O=c.gl;this.program=O.createProgram();const F=function(me){const de=[];for(let be=0;be<me.length;be++){if(me[be]===null)continue;const ge=me[be].split(" ");de.push(ge.pop())}return de}(x.staticAttributes),V=T?T.getBinderAttributes():[],G=F.concat(V);let ie=T?T.defines():[];ie=ie.concat(k.map(me=>`#define ${me}`));const le=ie.concat(c.extStandardDerivatives?`#extension GL_OES_standard_derivatives : enable
`.concat(Qa):Qa,Qa,Es,Fo.fragmentSource,Pa.fragmentSource,x.fragmentSource).join(`
`),_e=ie.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,Es,Fo.vertexSource,Pa.vertexSource,ka.vertexSource,x.vertexSource).join(`
`),fe=O.createShader(O.FRAGMENT_SHADER);if(O.isContextLost())return void(this.failedToCreate=!0);O.shaderSource(fe,le),O.compileShader(fe),O.attachShader(this.program,fe);const ve=O.createShader(O.VERTEX_SHADER);if(O.isContextLost())this.failedToCreate=!0;else{O.shaderSource(ve,_e),O.compileShader(ve),O.attachShader(this.program,ve),this.attributes={},this.numAttributes=G.length;for(let me=0;me<this.numAttributes;me++)G[me]&&(O.bindAttribLocation(this.program,me,G[me]),this.attributes[G[me]]=me);O.linkProgram(this.program),O.deleteShader(ve),O.deleteShader(fe),this.fixedUniforms=A(c),this.binderUniforms=T?T.getUniforms(c):[],k.includes("TERRAIN")&&(this.terrainUniforms=(me=>({u_dem:new o.Uniform1i(me),u_dem_prev:new o.Uniform1i(me),u_dem_unpack:new o.Uniform4f(me),u_dem_tl:new o.Uniform2f(me),u_dem_scale:new o.Uniform1f(me),u_dem_tl_prev:new o.Uniform2f(me),u_dem_scale_prev:new o.Uniform1f(me),u_dem_size:new o.Uniform1f(me),u_dem_lerp:new o.Uniform1f(me),u_exaggeration:new o.Uniform1f(me),u_depth:new o.Uniform1i(me),u_depth_size_inv:new o.Uniform2f(me),u_meter_to_dem:new o.Uniform1f(me),u_label_plane_matrix_inv:new o.UniformMatrix4f(me)}))(c)),k.includes("GLOBE")&&(this.globeUniforms=(me=>({u_tile_tl_up:new o.Uniform3f(me),u_tile_tr_up:new o.Uniform3f(me),u_tile_br_up:new o.Uniform3f(me),u_tile_bl_up:new o.Uniform3f(me),u_tile_up_scale:new o.Uniform1f(me)}))(c)),k.includes("FOG")&&(this.fogUniforms=(me=>({u_fog_matrix:new o.UniformMatrix4f(me),u_fog_range:new o.Uniform2f(me),u_fog_color:new o.Uniform4f(me),u_fog_horizon_blend:new o.Uniform1f(me),u_fog_temporal_offset:new o.Uniform1f(me),u_frustum_tl:new o.Uniform3f(me),u_frustum_tr:new o.Uniform3f(me),u_frustum_br:new o.Uniform3f(me),u_frustum_bl:new o.Uniform3f(me),u_globe_pos:new o.Uniform3f(me),u_globe_radius:new o.Uniform1f(me),u_globe_transition:new o.Uniform1f(me),u_is_globe:new o.Uniform1i(me),u_viewport:new o.Uniform2f(me)}))(c))}}setTerrainUniformValues(c,p){if(!this.terrainUniforms)return;const x=this.terrainUniforms;if(!this.failedToCreate){c.program.set(this.program);for(const T in p)x[T]&&x[T].set(this.program,T,p[T])}}setGlobeUniformValues(c,p){if(!this.globeUniforms)return;const x=this.globeUniforms;if(!this.failedToCreate){c.program.set(this.program);for(const T in p)x[T]&&x[T].set(this.program,T,p[T])}}setFogUniformValues(c,p){if(!this.fogUniforms)return;const x=this.fogUniforms;if(!this.failedToCreate){c.program.set(this.program);for(const T in p)x[T].set(this.program,T,p[T])}}draw(c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve){const me=c.gl;if(this.failedToCreate)return;c.program.set(this.program),c.setDepthMode(x),c.setStencilMode(T),c.setColorMode(A),c.setCullFace(k);for(const be of Object.keys(this.fixedUniforms))this.fixedUniforms[be].set(this.program,be,O[be]);fe&&fe.setUniforms(this.program,c,this.binderUniforms,le,{zoom:_e});const de={[me.LINES]:2,[me.TRIANGLES]:3,[me.LINE_STRIP]:1}[p];for(const be of ie.get()){const ge=be.vaos||(be.vaos={});(ge[F]||(ge[F]=new sa)).bind(c,this,V,fe?fe.getPaintVertexBuffers():[],G,be.vertexOffset,ve||[]),me.drawElements(p,be.primitiveLength*de,me.UNSIGNED_SHORT,be.primitiveOffset*de*2)}}}function mo(g,c,p){const x=1/At(p,1,c.transform.tileZoom),T=Math.pow(2,p.tileID.overscaledZ),A=p.tileSize*Math.pow(2,c.transform.tileZoom)/T,k=A*(p.tileID.canonical.x+p.tileID.wrap*T),O=A*p.tileID.canonical.y;return{u_image:0,u_texsize:p.imageAtlasTexture.size,u_scale:[x,g.fromScale,g.toScale],u_fade:g.t,u_pixel_coord_upper:[k>>16,O>>16],u_pixel_coord_lower:[65535&k,65535&O]}}const Is=o.create(),no=(g,c,p,x,T,A,k,O,F,V,G)=>{const ie=c.style.light,le=ie.properties.get("position"),_e=[le.x,le.y,le.z],fe=o.create$1();ie.properties.get("anchor")==="viewport"&&(o.fromRotation(fe,-c.transform.angle),o.transformMat3(_e,_e,fe));const ve=ie.properties.get("color"),me=c.transform,de={u_matrix:g,u_lightpos:_e,u_lightintensity:ie.properties.get("intensity"),u_lightcolor:[ve.r,ve.g,ve.b],u_vertical_gradient:+p,u_opacity:x,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Is,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:T,u_edge_radius:A};return me.projection.name==="globe"&&(de.u_tile_id=[k.canonical.x,k.canonical.y,1<<k.canonical.z],de.u_zoom_transition=F,de.u_inv_rot_matrix=G,de.u_merc_center=V,de.u_up_dir=me.projection.upVector(new o.CanonicalTileID(0,0,0),V[0]*o.EXTENT,V[1]*o.EXTENT),de.u_height_lift=O),de},es=(g,c,p,x,T,A,k,O,F,V,G,ie,le)=>{const _e=no(g,c,p,x,T,A,k,V,G,ie,le),fe={u_height_factor:-Math.pow(2,k.overscaledZ)/F.tileSize/8};return o.extend(_e,mo(O,c,F),fe)},ts=g=>({u_matrix:g}),ua=(g,c,p,x)=>o.extend(ts(g),mo(p,c,x)),is=(g,c)=>({u_matrix:g,u_world:c}),il=(g,c,p,x,T)=>o.extend(ua(g,c,p,x),{u_world:T}),ha=o.create(),da=(g,c,p,x,T,A)=>{const k=g.transform,O=k.projection.name==="globe";let F;if(A.paint.get("circle-pitch-alignment")==="map")if(O){const G=o.globePixelsToTileUnits(k.zoom,c.canonical)*k._pixelsPerMercatorPixel;F=Float32Array.from([G,0,0,G])}else F=k.calculatePixelsToTileUnitsMatrix(p);else F=new Float32Array([k.pixelsToGLUnits[0],0,0,k.pixelsToGLUnits[1]]);const V={u_camera_to_center_distance:k.cameraToCenterDistance,u_matrix:g.translatePosMatrix(c.projMatrix,p,A.paint.get("circle-translate"),A.paint.get("circle-translate-anchor")),u_device_pixel_ratio:o.exported.devicePixelRatio,u_extrude_scale:F,u_inv_rot_matrix:ha,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(O){V.u_inv_rot_matrix=x,V.u_merc_center=T,V.u_tile_id=[c.canonical.x,c.canonical.y,1<<c.canonical.z],V.u_zoom_transition=o.globeToMercatorTransition(k.zoom);const G=T[0]*o.EXTENT,ie=T[1]*o.EXTENT;V.u_up_dir=k.projection.upVector(new o.CanonicalTileID(0,0,0),G,ie)}return V},fa=g=>{const c=[];return g.paint.get("circle-pitch-alignment")==="map"&&c.push("PITCH_WITH_MAP"),g.paint.get("circle-pitch-scale")==="map"&&c.push("SCALE_WITH_MAP"),c},Da=(g,c,p,x)=>{const T=o.EXTENT/p.tileSize;return{u_matrix:g,u_camera_to_center_distance:c.getCameraToCenterDistance(x),u_extrude_scale:[c.pixelsToGLUnits[0]/T,c.pixelsToGLUnits[1]/T]}},rs=(g,c,p=1)=>({u_matrix:g,u_color:c,u_overlay:0,u_overlay_scale:p}),Xe=o.create(),pt=(g,c,p,x,T,A,k)=>{const O=g.transform,F=O.projection.name==="globe",V=F?o.globePixelsToTileUnits(O.zoom,c.canonical)*O._pixelsPerMercatorPixel:At(p,1,A),G={u_matrix:c.projMatrix,u_extrude_scale:V,u_intensity:k,u_inv_rot_matrix:Xe,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(F){G.u_inv_rot_matrix=x,G.u_merc_center=T,G.u_tile_id=[c.canonical.x,c.canonical.y,1<<c.canonical.z],G.u_zoom_transition=o.globeToMercatorTransition(O.zoom);const ie=T[0]*o.EXTENT,le=T[1]*o.EXTENT;G.u_up_dir=O.projection.upVector(new o.CanonicalTileID(0,0,0),ie,le)}return G},ui=(g,c,p,x,T,A,k,O)=>{const F=g.transform,V=F.calculatePixelsToTileUnitsMatrix(c),G={u_matrix:cr(g,c,p,T),u_pixels_to_tile_units:V,u_device_pixel_ratio:k,u_units_to_pixels:[1/F.pixelsToGLUnits[0],1/F.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:A,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0,u_alpha_discard_threshold:0,u_trim_offset:O};if(Zr(p)){const ie=Br(c,g.transform);G.u_texsize=c.lineAtlasTexture.size,G.u_scale=[ie,x.fromScale,x.toScale],G.u_mix=x.t}return G},Ui=(g,c,p,x,T,A)=>{const k=g.transform,O=Br(c,k);return{u_matrix:cr(g,c,p,T),u_texsize:c.imageAtlasTexture.size,u_pixels_to_tile_units:k.calculatePixelsToTileUnitsMatrix(c),u_device_pixel_ratio:A,u_image:0,u_scale:[O,x.fromScale,x.toScale],u_fade:x.t,u_units_to_pixels:[1/k.pixelsToGLUnits[0],1/k.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Br(g,c){return 1/At(g,1,c.tileZoom)}function cr(g,c,p,x){return g.translatePosMatrix(x||c.tileID.projMatrix,c,p.paint.get("line-translate"),p.paint.get("line-translate-anchor"))}function Zr(g){const c=g.paint.get("line-dasharray").value;return c.value||c.kind!=="constant"}const Kr=(g,c,p,x,T,A)=>{return{u_matrix:g,u_tl_parent:c,u_scale_parent:p,u_fade_t:x.mix,u_opacity:x.opacity*T.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:T.paint.get("raster-brightness-min"),u_brightness_high:T.paint.get("raster-brightness-max"),u_saturation_factor:(O=T.paint.get("raster-saturation"),O>0?1-1/(1.001-O):-O),u_contrast_factor:(k=T.paint.get("raster-contrast"),k>0?1/(1-k):1+k),u_spin_weights:Wn(T.paint.get("raster-hue-rotate")),u_perspective_transform:A};var k,O};function Wn(g){g*=Math.PI/180;const c=Math.sin(g),p=Math.cos(g);return[(2*p+1)/3,(-Math.sqrt(3)*c-p+1)/3,(Math.sqrt(3)*c-p+1)/3]}const Xr=o.create(),en=(g,c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve)=>{const me=T.transform,de={u_is_size_zoom_constant:+(g==="constant"||g==="source"),u_is_size_feature_constant:+(g==="constant"||g==="camera"),u_size_t:c?c.uSizeT:0,u_size:c?c.uSize:0,u_camera_to_center_distance:me.cameraToCenterDistance,u_rotate_symbol:+p,u_aspect_ratio:me.width/me.height,u_fade_change:T.options.fadeDuration?T.symbolFadeChange:1,u_matrix:A,u_label_plane_matrix:k,u_coord_matrix:O,u_is_text:+F,u_pitch_with_map:+x,u_texsize:V,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Xr,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Xr,u_up_vector:[0,-1,0]};return ve.name==="globe"&&(de.u_tile_id=[G.canonical.x,G.canonical.y,1<<G.canonical.z],de.u_zoom_transition=ie,de.u_inv_rot_matrix=_e,de.u_merc_center=le,de.u_camera_forward=me._camera.forward(),de.u_ecef_origin=o.globeECEFOrigin(me.globeMatrix,G.toUnwrapped()),de.u_tile_matrix=Float32Array.from(me.globeMatrix),de.u_up_vector=fe),de},Pn=(g,c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve,me)=>o.extend(en(g,c,p,x,T,A,k,O,F,V,ie,le,_e,fe,ve,me),{u_gamma_scale:x?T.transform.cameraToCenterDistance*Math.cos(T.terrain?0:T.transform._pitch):1,u_device_pixel_ratio:o.exported.devicePixelRatio,u_is_halo:+G}),go=(g,c,p,x,T,A,k,O,F,V,G,ie,le,_e,fe,ve)=>o.extend(Pn(g,c,p,x,T,A,k,O,!0,F,!0,G,ie,le,_e,fe,ve),{u_texsize_icon:V,u_texture_icon:1}),dn=(g,c,p)=>({u_matrix:g,u_opacity:c,u_color:p}),_o=(g,c,p,x,T,A)=>o.extend(function(k,O,F,V){const G=F.imageManager.getPattern(k.from.toString()),ie=F.imageManager.getPattern(k.to.toString()),{width:le,height:_e}=F.imageManager.getPixelSize(),fe=Math.pow(2,V.tileID.overscaledZ),ve=V.tileSize*Math.pow(2,F.transform.tileZoom)/fe,me=ve*(V.tileID.canonical.x+V.tileID.wrap*fe),de=ve*V.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:G.tl,u_pattern_br_a:G.br,u_pattern_tl_b:ie.tl,u_pattern_br_b:ie.br,u_texsize:[le,_e],u_mix:O.t,u_pattern_size_a:G.displaySize,u_pattern_size_b:ie.displaySize,u_scale_a:O.fromScale,u_scale_b:O.toScale,u_tile_units_to_pixels:1/At(V,1,F.transform.tileZoom),u_pixel_coord_upper:[me>>16,de>>16],u_pixel_coord_lower:[65535&me,65535&de]}}(x,A,p,T),{u_matrix:g,u_opacity:c}),yo={fillExtrusion:g=>({u_matrix:new o.UniformMatrix4f(g),u_lightpos:new o.Uniform3f(g),u_lightintensity:new o.Uniform1f(g),u_lightcolor:new o.Uniform3f(g),u_vertical_gradient:new o.Uniform1f(g),u_opacity:new o.Uniform1f(g),u_edge_radius:new o.Uniform1f(g),u_ao:new o.Uniform2f(g),u_tile_id:new o.Uniform3f(g),u_zoom_transition:new o.Uniform1f(g),u_inv_rot_matrix:new o.UniformMatrix4f(g),u_merc_center:new o.Uniform2f(g),u_up_dir:new o.Uniform3f(g),u_height_lift:new o.Uniform1f(g)}),fillExtrusionPattern:g=>({u_matrix:new o.UniformMatrix4f(g),u_lightpos:new o.Uniform3f(g),u_lightintensity:new o.Uniform1f(g),u_lightcolor:new o.Uniform3f(g),u_vertical_gradient:new o.Uniform1f(g),u_height_factor:new o.Uniform1f(g),u_edge_radius:new o.Uniform1f(g),u_ao:new o.Uniform2f(g),u_tile_id:new o.Uniform3f(g),u_zoom_transition:new o.Uniform1f(g),u_inv_rot_matrix:new o.UniformMatrix4f(g),u_merc_center:new o.Uniform2f(g),u_up_dir:new o.Uniform3f(g),u_height_lift:new o.Uniform1f(g),u_image:new o.Uniform1i(g),u_texsize:new o.Uniform2f(g),u_pixel_coord_upper:new o.Uniform2f(g),u_pixel_coord_lower:new o.Uniform2f(g),u_scale:new o.Uniform3f(g),u_fade:new o.Uniform1f(g),u_opacity:new o.Uniform1f(g)}),fill:g=>({u_matrix:new o.UniformMatrix4f(g)}),fillPattern:g=>({u_matrix:new o.UniformMatrix4f(g),u_image:new o.Uniform1i(g),u_texsize:new o.Uniform2f(g),u_pixel_coord_upper:new o.Uniform2f(g),u_pixel_coord_lower:new o.Uniform2f(g),u_scale:new o.Uniform3f(g),u_fade:new o.Uniform1f(g)}),fillOutline:g=>({u_matrix:new o.UniformMatrix4f(g),u_world:new o.Uniform2f(g)}),fillOutlinePattern:g=>({u_matrix:new o.UniformMatrix4f(g),u_world:new o.Uniform2f(g),u_image:new o.Uniform1i(g),u_texsize:new o.Uniform2f(g),u_pixel_coord_upper:new o.Uniform2f(g),u_pixel_coord_lower:new o.Uniform2f(g),u_scale:new o.Uniform3f(g),u_fade:new o.Uniform1f(g)}),circle:g=>({u_camera_to_center_distance:new o.Uniform1f(g),u_extrude_scale:new o.UniformMatrix2f(g),u_device_pixel_ratio:new o.Uniform1f(g),u_matrix:new o.UniformMatrix4f(g),u_inv_rot_matrix:new o.UniformMatrix4f(g),u_merc_center:new o.Uniform2f(g),u_tile_id:new o.Uniform3f(g),u_zoom_transition:new o.Uniform1f(g),u_up_dir:new o.Uniform3f(g)}),collisionBox:g=>({u_matrix:new o.UniformMatrix4f(g),u_camera_to_center_distance:new o.Uniform1f(g),u_extrude_scale:new o.Uniform2f(g)}),collisionCircle:g=>({u_matrix:new o.UniformMatrix4f(g),u_inv_matrix:new o.UniformMatrix4f(g),u_camera_to_center_distance:new o.Uniform1f(g),u_viewport_size:new o.Uniform2f(g)}),debug:g=>({u_color:new o.UniformColor(g),u_matrix:new o.UniformMatrix4f(g),u_overlay:new o.Uniform1i(g),u_overlay_scale:new o.Uniform1f(g)}),clippingMask:g=>({u_matrix:new o.UniformMatrix4f(g)}),heatmap:g=>({u_extrude_scale:new o.Uniform1f(g),u_intensity:new o.Uniform1f(g),u_matrix:new o.UniformMatrix4f(g),u_inv_rot_matrix:new o.UniformMatrix4f(g),u_merc_center:new o.Uniform2f(g),u_tile_id:new o.Uniform3f(g),u_zoom_transition:new o.Uniform1f(g),u_up_dir:new o.Uniform3f(g)}),heatmapTexture:g=>({u_image:new o.Uniform1i(g),u_color_ramp:new o.Uniform1i(g),u_opacity:new o.Uniform1f(g)}),hillshade:g=>({u_matrix:new o.UniformMatrix4f(g),u_image:new o.Uniform1i(g),u_latrange:new o.Uniform2f(g),u_light:new o.Uniform2f(g),u_shadow:new o.UniformColor(g),u_highlight:new o.UniformColor(g),u_accent:new o.UniformColor(g)}),hillshadePrepare:g=>({u_matrix:new o.UniformMatrix4f(g),u_image:new o.Uniform1i(g),u_dimension:new o.Uniform2f(g),u_zoom:new o.Uniform1f(g),u_unpack:new o.Uniform4f(g)}),line:g=>({u_matrix:new o.UniformMatrix4f(g),u_pixels_to_tile_units:new o.UniformMatrix2f(g),u_device_pixel_ratio:new o.Uniform1f(g),u_units_to_pixels:new o.Uniform2f(g),u_dash_image:new o.Uniform1i(g),u_gradient_image:new o.Uniform1i(g),u_image_height:new o.Uniform1f(g),u_texsize:new o.Uniform2f(g),u_scale:new o.Uniform3f(g),u_mix:new o.Uniform1f(g),u_alpha_discard_threshold:new o.Uniform1f(g),u_trim_offset:new o.Uniform2f(g)}),linePattern:g=>({u_matrix:new o.UniformMatrix4f(g),u_texsize:new o.Uniform2f(g),u_pixels_to_tile_units:new o.UniformMatrix2f(g),u_device_pixel_ratio:new o.Uniform1f(g),u_image:new o.Uniform1i(g),u_units_to_pixels:new o.Uniform2f(g),u_scale:new o.Uniform3f(g),u_fade:new o.Uniform1f(g),u_alpha_discard_threshold:new o.Uniform1f(g)}),raster:g=>({u_matrix:new o.UniformMatrix4f(g),u_tl_parent:new o.Uniform2f(g),u_scale_parent:new o.Uniform1f(g),u_fade_t:new o.Uniform1f(g),u_opacity:new o.Uniform1f(g),u_image0:new o.Uniform1i(g),u_image1:new o.Uniform1i(g),u_brightness_low:new o.Uniform1f(g),u_brightness_high:new o.Uniform1f(g),u_saturation_factor:new o.Uniform1f(g),u_contrast_factor:new o.Uniform1f(g),u_spin_weights:new o.Uniform3f(g),u_perspective_transform:new o.Uniform2f(g)}),symbolIcon:g=>({u_is_size_zoom_constant:new o.Uniform1i(g),u_is_size_feature_constant:new o.Uniform1i(g),u_size_t:new o.Uniform1f(g),u_size:new o.Uniform1f(g),u_camera_to_center_distance:new o.Uniform1f(g),u_rotate_symbol:new o.Uniform1i(g),u_aspect_ratio:new o.Uniform1f(g),u_fade_change:new o.Uniform1f(g),u_matrix:new o.UniformMatrix4f(g),u_label_plane_matrix:new o.UniformMatrix4f(g),u_coord_matrix:new o.UniformMatrix4f(g),u_is_text:new o.Uniform1i(g),u_pitch_with_map:new o.Uniform1i(g),u_texsize:new o.Uniform2f(g),u_tile_id:new o.Uniform3f(g),u_zoom_transition:new o.Uniform1f(g),u_inv_rot_matrix:new o.UniformMatrix4f(g),u_merc_center:new o.Uniform2f(g),u_camera_forward:new o.Uniform3f(g),u_tile_matrix:new o.UniformMatrix4f(g),u_up_vector:new o.Uniform3f(g),u_ecef_origin:new o.Uniform3f(g),u_texture:new o.Uniform1i(g)}),symbolSDF:g=>({u_is_size_zoom_constant:new o.Uniform1i(g),u_is_size_feature_constant:new o.Uniform1i(g),u_size_t:new o.Uniform1f(g),u_size:new o.Uniform1f(g),u_camera_to_center_distance:new o.Uniform1f(g),u_rotate_symbol:new o.Uniform1i(g),u_aspect_ratio:new o.Uniform1f(g),u_fade_change:new o.Uniform1f(g),u_matrix:new o.UniformMatrix4f(g),u_label_plane_matrix:new o.UniformMatrix4f(g),u_coord_matrix:new o.UniformMatrix4f(g),u_is_text:new o.Uniform1i(g),u_pitch_with_map:new o.Uniform1i(g),u_texsize:new o.Uniform2f(g),u_texture:new o.Uniform1i(g),u_gamma_scale:new o.Uniform1f(g),u_device_pixel_ratio:new o.Uniform1f(g),u_tile_id:new o.Uniform3f(g),u_zoom_transition:new o.Uniform1f(g),u_inv_rot_matrix:new o.UniformMatrix4f(g),u_merc_center:new o.Uniform2f(g),u_camera_forward:new o.Uniform3f(g),u_tile_matrix:new o.UniformMatrix4f(g),u_up_vector:new o.Uniform3f(g),u_ecef_origin:new o.Uniform3f(g),u_is_halo:new o.Uniform1i(g)}),symbolTextAndIcon:g=>({u_is_size_zoom_constant:new o.Uniform1i(g),u_is_size_feature_constant:new o.Uniform1i(g),u_size_t:new o.Uniform1f(g),u_size:new o.Uniform1f(g),u_camera_to_center_distance:new o.Uniform1f(g),u_rotate_symbol:new o.Uniform1i(g),u_aspect_ratio:new o.Uniform1f(g),u_fade_change:new o.Uniform1f(g),u_matrix:new o.UniformMatrix4f(g),u_label_plane_matrix:new o.UniformMatrix4f(g),u_coord_matrix:new o.UniformMatrix4f(g),u_is_text:new o.Uniform1i(g),u_pitch_with_map:new o.Uniform1i(g),u_texsize:new o.Uniform2f(g),u_texsize_icon:new o.Uniform2f(g),u_texture:new o.Uniform1i(g),u_texture_icon:new o.Uniform1i(g),u_gamma_scale:new o.Uniform1f(g),u_device_pixel_ratio:new o.Uniform1f(g),u_is_halo:new o.Uniform1i(g)}),background:g=>({u_matrix:new o.UniformMatrix4f(g),u_opacity:new o.Uniform1f(g),u_color:new o.UniformColor(g)}),backgroundPattern:g=>({u_matrix:new o.UniformMatrix4f(g),u_opacity:new o.Uniform1f(g),u_image:new o.Uniform1i(g),u_pattern_tl_a:new o.Uniform2f(g),u_pattern_br_a:new o.Uniform2f(g),u_pattern_tl_b:new o.Uniform2f(g),u_pattern_br_b:new o.Uniform2f(g),u_texsize:new o.Uniform2f(g),u_mix:new o.Uniform1f(g),u_pattern_size_a:new o.Uniform2f(g),u_pattern_size_b:new o.Uniform2f(g),u_scale_a:new o.Uniform1f(g),u_scale_b:new o.Uniform1f(g),u_pixel_coord_upper:new o.Uniform2f(g),u_pixel_coord_lower:new o.Uniform2f(g),u_tile_units_to_pixels:new o.Uniform1f(g)}),terrainRaster:No,terrainDepth:No,skybox:g=>({u_matrix:new o.UniformMatrix4f(g),u_sun_direction:new o.Uniform3f(g),u_cubemap:new o.Uniform1i(g),u_opacity:new o.Uniform1f(g),u_temporal_offset:new o.Uniform1f(g)}),skyboxGradient:g=>({u_matrix:new o.UniformMatrix4f(g),u_color_ramp:new o.Uniform1i(g),u_center_direction:new o.Uniform3f(g),u_radius:new o.Uniform1f(g),u_opacity:new o.Uniform1f(g),u_temporal_offset:new o.Uniform1f(g)}),skyboxCapture:g=>({u_matrix_3f:new o.UniformMatrix3f(g),u_sun_direction:new o.Uniform3f(g),u_sun_intensity:new o.Uniform1f(g),u_color_tint_r:new o.Uniform4f(g),u_color_tint_m:new o.Uniform4f(g),u_luminance:new o.Uniform1f(g)}),globeRaster:g=>({u_proj_matrix:new o.UniformMatrix4f(g),u_globe_matrix:new o.UniformMatrix4f(g),u_normalize_matrix:new o.UniformMatrix4f(g),u_merc_matrix:new o.UniformMatrix4f(g),u_zoom_transition:new o.Uniform1f(g),u_merc_center:new o.Uniform2f(g),u_image0:new o.Uniform1i(g),u_grid_matrix:new o.UniformMatrix3f(g),u_frustum_tl:new o.Uniform3f(g),u_frustum_tr:new o.Uniform3f(g),u_frustum_br:new o.Uniform3f(g),u_frustum_bl:new o.Uniform3f(g),u_globe_pos:new o.Uniform3f(g),u_globe_radius:new o.Uniform1f(g),u_viewport:new o.Uniform2f(g)}),globeAtmosphere:g=>({u_frustum_tl:new o.Uniform3f(g),u_frustum_tr:new o.Uniform3f(g),u_frustum_br:new o.Uniform3f(g),u_frustum_bl:new o.Uniform3f(g),u_horizon:new o.Uniform1f(g),u_transition:new o.Uniform1f(g),u_fadeout_range:new o.Uniform1f(g),u_color:new o.Uniform4f(g),u_high_color:new o.Uniform4f(g),u_space_color:new o.Uniform4f(g),u_star_intensity:new o.Uniform1f(g),u_star_density:new o.Uniform1f(g),u_star_size:new o.Uniform1f(g),u_temporal_offset:new o.Uniform1f(g),u_horizon_angle:new o.Uniform1f(g),u_rotation_matrix:new o.UniformMatrix4f(g)})};let jo;function Io(g,c,p,x,T,A,k){const O=g.context,F=O.gl,V=g.transform,G=g.useProgram("collisionBox"),ie=[];let le=0,_e=0;for(let Be=0;Be<x.length;Be++){const ze=x[Be],Me=c.getTile(ze),Fe=Me.getBucket(p);if(!Fe)continue;const Je=Ye(ze,Fe,V);let lt=Je;T[0]===0&&T[1]===0||(lt=g.translatePosMatrix(Je,Me,T,A));const ot=k?Fe.textCollisionBox:Fe.iconCollisionBox,zt=Fe.collisionCircleArray;if(zt.length>0){const He=o.create(),wt=lt;o.mul(He,Fe.placementInvProjMatrix,V.glCoordMatrix),o.mul(He,He,Fe.placementViewportMatrix),ie.push({circleArray:zt,circleOffset:_e,transform:wt,invTransform:He,projection:Fe.getProjection()}),le+=zt.length/4,_e=le}ot&&(g.terrain&&g.terrain.setupElevationDraw(Me,G),G.draw(O,F.LINES,o.DepthMode.disabled,o.StencilMode.disabled,g.colorModeForRenderPass(),o.CullFaceMode.disabled,Da(lt,V,Me,Fe.getProjection()),p.id,ot.layoutVertexBuffer,ot.indexBuffer,ot.segments,null,V.zoom,null,[ot.collisionVertexBuffer,ot.collisionVertexBufferExt]))}if(!k||!ie.length)return;const fe=g.useProgram("collisionCircle"),ve=new o.StructArrayLayout2f1f2i16;ve.resize(4*le),ve._trim();let me=0;for(const Be of ie)for(let ze=0;ze<Be.circleArray.length/4;ze++){const Me=4*ze,Fe=Be.circleArray[Me+0],Je=Be.circleArray[Me+1],lt=Be.circleArray[Me+2],ot=Be.circleArray[Me+3];ve.emplace(me++,Fe,Je,lt,ot,0),ve.emplace(me++,Fe,Je,lt,ot,1),ve.emplace(me++,Fe,Je,lt,ot,2),ve.emplace(me++,Fe,Je,lt,ot,3)}(!jo||jo.length<2*le)&&(jo=function(Be){const ze=2*Be,Me=new o.StructArrayLayout3ui6;Me.resize(ze),Me._trim();for(let Fe=0;Fe<ze;Fe++){const Je=6*Fe;Me.uint16[Je+0]=4*Fe+0,Me.uint16[Je+1]=4*Fe+1,Me.uint16[Je+2]=4*Fe+2,Me.uint16[Je+3]=4*Fe+2,Me.uint16[Je+4]=4*Fe+3,Me.uint16[Je+5]=4*Fe+0}return Me}(le));const de=O.createIndexBuffer(jo,!0),be=O.createVertexBuffer(ve,o.collisionCircleLayout.members,!0);for(const Be of ie){const ze={u_matrix:Be.transform,u_inv_matrix:Be.invTransform,u_camera_to_center_distance:(ge=V).getCameraToCenterDistance(Be.projection),u_viewport_size:[ge.width,ge.height]};fe.draw(O,F.TRIANGLES,o.DepthMode.disabled,o.StencilMode.disabled,g.colorModeForRenderPass(),o.CullFaceMode.disabled,ze,p.id,be,de,o.SegmentVector.simpleSegment(0,2*Be.circleOffset,Be.circleArray.length,Be.circleArray.length/2),null,V.zoom)}var ge;be.destroy(),de.destroy()}const Go=o.create();function qo(g,c,p,x,T,A){const{horizontalAlign:k,verticalAlign:O}=o.getAnchorAlignment(g),F=-(k-.5)*c,V=-(O-.5)*p,G=o.evaluateVariableOffset(g,x);return new o.pointGeometry((F/T+G[0])*A,(V/T+G[1])*A)}function $l(g,c,p,x,T,A,k,O,F,V,G){const ie=g.text.placedSymbolArray,le=g.text.dynamicLayoutVertexArray,_e=g.icon.dynamicLayoutVertexArray,fe={},ve=et(O,g.getProjection(),A),me=A.elevation,de=g.getProjection().upVectorScale(O.canonical,A.center.lat,A.worldSize);le.clear();for(let be=0;be<ie.length;be++){const ge=ie.get(be),Be=g.allowVerticalPlacement&&!ge.placedOrientation,ze=ge.hidden||!ge.crossTileID||Be?null:x[ge.crossTileID];if(ze){const Me=new o.pointGeometry(ge.tileAnchorX,ge.tileAnchorY),Fe=g.getProjection().upVector(O.canonical,Me.x,Me.y),Je=me?me.getAtTileOffset(O,Me.x,Me.y):0,lt=Wi([ge.projectedAnchorX+Je*Fe[0]*de.metersToTile,ge.projectedAnchorY+Je*Fe[1]*de.metersToTile,ge.projectedAnchorZ+Je*Fe[2]*de.metersToTile],p?ve:k),ot=ir(A.getCameraToCenterDistance(g.getProjection()),lt.signedDistanceFromCamera);let zt=T.evaluateSizeForFeature(g.textSizeData,V,ge)*ot/o.ONE_EM;p&&(zt*=g.tilePixelRatio/F);const{width:He,height:wt,anchor:bt,textOffset:tt,textScale:Ve}=ze,ri=qo(bt,He,wt,tt,Ve,zt);let qt;if(p){const Ht=Me.add(ri),{x:Ai,y:Vi,z:Ni}=g.getProjection().projectTilePoint(Ht.x,Ht.y,O.canonical);qt=Wi([Ai+Je*Fe[0]*de.metersToTile,Vi+Je*Fe[1]*de.metersToTile,Ni+Je*Fe[2]*de.metersToTile],k).point}else{const Ht=c?ri.rotate(-A.angle):ri;qt=[lt.point[0]+Ht.x,lt.point[1]+Ht.y,0]}const Jt=g.allowVerticalPlacement&&ge.placedOrientation===o.WritingMode.vertical?Math.PI/2:0;for(let Ht=0;Ht<ge.numGlyphs;Ht++)o.addDynamicAttributes(le,qt[0],qt[1],qt[2],Jt);G&&ge.associatedIconIndex>=0&&(fe[ge.associatedIconIndex]={shiftedAnchor:qt,angle:Jt})}else B(ge.numGlyphs,le)}if(G){_e.clear();const be=g.icon.placedSymbolArray;for(let ge=0;ge<be.length;ge++){const Be=be.get(ge);if(Be.hidden)B(Be.numGlyphs,_e);else{const ze=fe[ge];if(ze)for(let Me=0;Me<Be.numGlyphs;Me++)o.addDynamicAttributes(_e,ze.shiftedAnchor[0],ze.shiftedAnchor[1],ze.shiftedAnchor[2],ze.angle);else B(Be.numGlyphs,_e)}}g.icon.dynamicLayoutVertexBuffer.updateData(_e)}g.text.dynamicLayoutVertexBuffer.updateData(le)}function Vl(g,c,p){return p.iconsInText&&c?"symbolTextAndIcon":g?"symbolSDF":"symbolIcon"}function Cr(g,c,p,x,T,A,k,O,F,V,G,ie){const le=g.context,_e=le.gl,fe=g.transform,ve=O==="map",me=F==="map",de=ve&&p.layout.get("symbol-placement")!=="point",be=ve&&!me&&!de,ge=p.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Be=!1;const ze=g.depthModeForSublayer(0,o.DepthMode.ReadOnly),Me=[o.mercatorXfromLng(fe.center.lng),o.mercatorYfromLat(fe.center.lat)],Fe=p.layout.get("text-variable-anchor"),Je=fe.projection.name==="globe",lt=[],ot=[0,-1,0];let zt=ot;!Je&&!fe.mercatorFromTransition||ve||(zt=function(He){const wt=He._camera.getWorldToCamera(He.worldSize,1),bt=o.multiply([],wt,He.globeMatrix);o.invert(bt,bt);const tt=[0,0,0],Ve=[0,1,0,0];return o.transformMat4$1(Ve,Ve,bt),tt[0]=Ve[0],tt[1]=Ve[1],tt[2]=Ve[2],o.normalize(tt,tt),tt}(fe));for(const He of x){const wt=c.getTile(He),bt=wt.getBucket(p);if(!bt||bt.projection.name==="mercator"&&Je)continue;const tt=T?bt.text:bt.icon;if(!tt||bt.fullyClipped||!tt.segments.get().length)continue;const Ve=tt.programConfigurations.get(p.id),ri=T||bt.sdfIcons,qt=T?bt.textSizeData:bt.iconSizeData,Jt=me||fe.pitch!==0,Ht=o.evaluateSizeForZoom(qt,fe.zoom);let Ai,Vi,Ni,Bi,Wt=[0,0],Zi=null;if(T){if(Vi=wt.glyphAtlasTexture,Ni=_e.LINEAR,Ai=wt.glyphAtlasTexture.size,bt.iconsInText){Wt=wt.imageAtlasTexture.size,Zi=wt.imageAtlasTexture;const xn=qt.kind==="composite"||qt.kind==="camera";Bi=Jt||g.options.rotating||g.options.zooming||xn?_e.LINEAR:_e.NEAREST}}else{const xn=p.layout.get("icon-size").constantOr(0)!==1||bt.iconsNeedLinear;Vi=wt.imageAtlasTexture,Ni=ri||g.options.rotating||g.options.zooming||xn||Jt?_e.LINEAR:_e.NEAREST,Ai=wt.imageAtlasTexture.size}const er=bt.projection.name==="globe",Tr=er?zt:ot,Sr=er?o.globeToMercatorTransition(fe.zoom):0,vr=et(He,bt.getProjection(),fe),fn=fe.calculatePixelsToTileUnitsMatrix(wt),Rn=Cn(vr,wt.tileID.canonical,me,ve,fe,bt.getProjection(),fn),Po=g.terrain&&me&&de?o.invert(o.create(),Rn):Go,Nr=So(vr,wt.tileID.canonical,me,ve,fe,bt.getProjection(),fn),Hr=Fe&&bt.hasTextData(),xr=p.layout.get("icon-text-fit")!=="none"&&Hr&&bt.hasIconData();if(de){const xn=fe.elevation,Do=xn?xn.getAtTileOffsetFunc(He,fe.center.lat,fe.worldSize,bt.getProjection()):bo=>[0,0,0],ya=Hn(vr,wt.tileID.canonical,me,ve,fe,bt.getProjection(),fn);ia(bt,vr,g,T,ya,Nr,me,V,Do,He)}const rn=de||T&&Fe||xr,Mn=g.translatePosMatrix(vr,wt,A,k),Rr=rn?Go:Rn,jn=g.translatePosMatrix(Nr,wt,A,k,!0),Fa=bt.getProjection().createInversionMatrix(fe,He.canonical),vo=[];g.terrainRenderModeElevated()&&me&&vo.push("PITCH_WITH_MAP_TERRAIN"),er&&vo.push("PROJECTION_GLOBE_VIEW"),rn&&vo.push("PROJECTED_POS_ON_VIEWPORT");const Ln=ri&&p.paint.get(T?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let ls;ls=ri?bt.iconsInText?go(qt.kind,Ht,be,me,g,Mn,Rr,jn,Ai,Wt,He,Sr,Me,Fa,Tr,bt.getProjection()):Pn(qt.kind,Ht,be,me,g,Mn,Rr,jn,T,Ai,!0,He,Sr,Me,Fa,Tr,bt.getProjection()):en(qt.kind,Ht,be,me,g,Mn,Rr,jn,T,Ai,He,Sr,Me,Fa,Tr,bt.getProjection());const _a={program:g.useProgram(Vl(ri,T,bt),Ve,vo),buffers:tt,uniformValues:ls,atlasTexture:Vi,atlasTextureIcon:Zi,atlasInterpolation:Ni,atlasInterpolationIcon:Bi,isSDF:ri,hasHalo:Ln,tile:wt,labelPlaneMatrixInv:Po};if(ge&&bt.canOverlap){Be=!0;const xn=tt.segments.get();for(const Do of xn)lt.push({segments:new o.SegmentVector([Do]),sortKey:Do.sortKey,state:_a})}else lt.push({segments:tt.segments,sortKey:0,state:_a})}Be&&lt.sort((He,wt)=>He.sortKey-wt.sortKey);for(const He of lt){const wt=He.state;if(g.terrain&&g.terrain.setupElevationDraw(wt.tile,wt.program,{useDepthForOcclusion:!Je,labelPlaneMatrixInv:wt.labelPlaneMatrixInv}),le.activeTexture.set(_e.TEXTURE0),wt.atlasTexture.bind(wt.atlasInterpolation,_e.CLAMP_TO_EDGE),wt.atlasTextureIcon&&(le.activeTexture.set(_e.TEXTURE1),wt.atlasTextureIcon&&wt.atlasTextureIcon.bind(wt.atlasInterpolationIcon,_e.CLAMP_TO_EDGE)),wt.isSDF){const bt=wt.uniformValues;wt.hasHalo&&(bt.u_is_halo=1,br(wt.buffers,He.segments,p,g,wt.program,ze,G,ie,bt)),bt.u_is_halo=0}br(wt.buffers,He.segments,p,g,wt.program,ze,G,ie,wt.uniformValues)}}function br(g,c,p,x,T,A,k,O,F){const V=x.context,G=[g.dynamicLayoutVertexBuffer,g.opacityVertexBuffer,g.globeExtVertexBuffer];T.draw(V,V.gl.TRIANGLES,A,k,O,o.CullFaceMode.disabled,F,p.id,g.layoutVertexBuffer,g.indexBuffer,c,p.paint,x.transform.zoom,g.programConfigurations.get(p.id),G)}function Ba(g,c,p,x,T,A,k){const O=g.context.gl,F=p.paint.get("fill-pattern"),V=F&&F.constantOr(1),G=p.getCrossfadeParameters();let ie,le,_e,fe,ve;k?(le=V&&!p.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ie=O.LINES):(le=V?"fillPattern":"fill",ie=O.TRIANGLES);for(const me of x){const de=c.getTile(me);if(V&&!de.patternsLoaded())continue;const be=de.getBucket(p);if(!be)continue;g.prepareDrawTile();const ge=be.programConfigurations.get(p.id),Be=g.useProgram(le,ge);V&&(g.context.activeTexture.set(O.TEXTURE0),de.imageAtlasTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),ge.updatePaintBuffers(G));const ze=F.constantOr(null);if(ze&&de.imageAtlas){const Fe=de.imageAtlas,Je=Fe.patternPositions[ze.to.toString()],lt=Fe.patternPositions[ze.from.toString()];Je&&lt&&ge.setConstantPatternPositions(Je,lt)}const Me=g.translatePosMatrix(me.projMatrix,de,p.paint.get("fill-translate"),p.paint.get("fill-translate-anchor"));if(k){fe=be.indexBuffer2,ve=be.segments2;const Fe=g.terrain&&g.terrain.renderingToTexture?g.terrain.drapeBufferSize:[O.drawingBufferWidth,O.drawingBufferHeight];_e=le==="fillOutlinePattern"&&V?il(Me,g,G,de,Fe):is(Me,Fe)}else fe=be.indexBuffer,ve=be.segments,_e=V?ua(Me,g,G,de):ts(Me);g.prepareDrawProgram(g.context,Be,me.toUnwrapped()),Be.draw(g.context,ie,T,g.stencilModeForClipping(me),A,o.CullFaceMode.disabled,_e,p.id,be.layoutVertexBuffer,fe,ve,p.paint,g.transform.zoom,ge)}}function oo(g,c,p,x,T,A,k){const O=g.context,F=O.gl,V=g.transform,G=p.paint.get("fill-extrusion-pattern"),ie=G.constantOr(1),le=p.getCrossfadeParameters(),_e=p.paint.get("fill-extrusion-opacity"),fe=[p.paint.get("fill-extrusion-ambient-occlusion-intensity"),p.paint.get("fill-extrusion-ambient-occlusion-radius")],ve=p.layout.get("fill-extrusion-edge-radius"),me=V.projection.name==="globe"?o.fillExtrusionHeightLift():0,de=V.projection.name==="globe",be=de?o.globeToMercatorTransition(V.zoom):0,ge=[o.mercatorXfromLng(V.center.lng),o.mercatorYfromLat(V.center.lat)],Be=[];de&&(Be.push("PROJECTION_GLOBE_VIEW"),g.style.terrainSetForDrapingOnly()&&Be.push("TERRAIN")),fe[0]>0&&Be.push("FAUX_AO");for(const ze of x){const Me=c.getTile(ze),Fe=Me.getBucket(p);if(!Fe||Fe.projection.name!==V.projection.name)continue;const Je=Fe.programConfigurations.get(p.id),lt=g.useProgram(ie?"fillExtrusionPattern":"fillExtrusion",Je,Be);if(g.terrain){const Ve=g.terrain;if(g.style.terrainSetForDrapingOnly())Ve.setupElevationDraw(Me,lt,{useMeterToDem:!0});else{if(!Fe.enableTerrain)continue;if(Ve.setupElevationDraw(Me,lt,{useMeterToDem:!0}),Ra(O,c,ze,Fe,p,Ve),!Fe.centroidVertexBuffer){const ri=lt.attributes.a_centroid_pos;ri!==void 0&&F.vertexAttrib2f(ri,0,0)}}}ie&&(g.context.activeTexture.set(F.TEXTURE0),Me.imageAtlasTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),Je.updatePaintBuffers(le));const ot=G.constantOr(null);if(ot&&Me.imageAtlas){const Ve=Me.imageAtlas,ri=Ve.patternPositions[ot.to.toString()],qt=Ve.patternPositions[ot.from.toString()];ri&&qt&&Je.setConstantPatternPositions(ri,qt)}const zt=g.translatePosMatrix(ze.projMatrix,Me,p.paint.get("fill-extrusion-translate"),p.paint.get("fill-extrusion-translate-anchor")),He=V.projection.createInversionMatrix(V,ze.canonical),wt=p.paint.get("fill-extrusion-vertical-gradient"),bt=ie?es(zt,g,wt,_e,fe,ve,ze,le,Me,me,be,ge,He):no(zt,g,wt,_e,fe,ve,ze,me,be,ge,He);g.prepareDrawProgram(O,lt,ze.toUnwrapped());const tt=[];g.terrain&&tt.push(Fe.centroidVertexBuffer),de&&tt.push(Fe.layoutVertexExtBuffer),lt.draw(O,O.gl.TRIANGLES,T,A,k,o.CullFaceMode.backCCW,bt,p.id,Fe.layoutVertexBuffer,Fe.indexBuffer,Fe.segments,p.paint,g.transform.zoom,Je,tt)}}function Ra(g,c,p,x,T,A){const k=[de=>{let be=de.canonical.x-1,ge=de.wrap;return be<0&&(be=(1<<de.canonical.z)-1,ge--),new o.OverscaledTileID(de.overscaledZ,ge,de.canonical.z,be,de.canonical.y)},de=>{let be=de.canonical.x+1,ge=de.wrap;return be===1<<de.canonical.z&&(be=0,ge++),new o.OverscaledTileID(de.overscaledZ,ge,de.canonical.z,be,de.canonical.y)},de=>new o.OverscaledTileID(de.overscaledZ,de.wrap,de.canonical.z,de.canonical.x,(de.canonical.y===0?1<<de.canonical.z:de.canonical.y)-1),de=>new o.OverscaledTileID(de.overscaledZ,de.wrap,de.canonical.z,de.canonical.x,de.canonical.y===(1<<de.canonical.z)-1?0:de.canonical.y+1)],O=de=>{const be=c.getSource().minzoom,ge=ze=>{const Me=c.getTileByID(ze);if(Me&&Me.hasData())return Me.getBucket(T)},Be=[0,-1,1];for(const ze of Be){if(de.overscaledZ+ze<be)continue;const Me=ge(de.calculateScaledKey(de.overscaledZ+ze));if(Me)return Me}},F=[0,0,0],V=(de,be)=>(F[0]=Math.min(de.min.y,be.min.y),F[1]=Math.max(de.max.y,be.max.y),F[2]=o.EXTENT-be.min.x>de.max.x?be.min.x-o.EXTENT:de.max.x,F),G=(de,be)=>(F[0]=Math.min(de.min.x,be.min.x),F[1]=Math.max(de.max.x,be.max.x),F[2]=o.EXTENT-be.min.y>de.max.y?be.min.y-o.EXTENT:de.max.y,F),ie=[(de,be)=>V(de,be),(de,be)=>V(be,de),(de,be)=>G(de,be),(de,be)=>G(be,de)],le=new o.pointGeometry(0,0);let _e,fe,ve;const me=(de,be,ge,Be,ze)=>{const Me=[[Be?ge:de,Be?de:ge,0],[Be?ge:be,Be?be:ge,0]],Fe=ze<0?o.EXTENT+ze:ze,Je=[Be?Fe:(de+be)/2,Be?(de+be)/2:Fe,0];return ge===0&&ze<0||ge!==0&&ze>0?A.getForTilePoints(ve,[Je],!0,fe):Me.push(Je),A.getForTilePoints(p,Me,!0,_e),Math.max(Me[0][2],Me[1][2],Je[2])/A.exaggeration()};for(let de=0;de<4;de++){const be=(de<2?1:5)-de,ge=x.borders[de];if(ge.length===0)continue;const Be=ve=k[de](p),ze=O(Be);if(!(ze&&ze instanceof o.FillExtrusionBucket&&ze.enableTerrain)||x.borderDoneWithNeighborZ[de]===ze.canonical.z&&ze.borderDoneWithNeighborZ[be]===x.canonical.z||(fe=A.findDEMTileFor(Be),!fe||!fe.dem))continue;if(!_e){const lt=A.findDEMTileFor(p);if(!lt||!lt.dem)return;_e=lt}const Me=ze.borders[be];let Fe=0;const Je=ze.borderDoneWithNeighborZ[be]!==x.canonical.z;if(x.canonical.z===ze.canonical.z){for(let lt=0;lt<ge.length;lt++){const ot=x.featuresOnBorder[ge[lt]],zt=ot.borders[de];let He;for(;Fe<Me.length&&(He=ze.featuresOnBorder[Me[Fe]],!(He.borders[be][1]>zt[0]+3));)Je&&ze.encodeCentroid(void 0,He,!1),Fe++;if(He&&Fe<Me.length){const wt=Fe;let bt=0;for(;!(He.borders[be][0]>zt[1]-3)&&(bt++,++Fe!==Me.length);)He=ze.featuresOnBorder[Me[Fe]];if(He=ze.featuresOnBorder[Me[wt]],ot.intersectsCount()>1||He.intersectsCount()>1||bt!==1){bt!==1&&(Fe=wt),x.encodeCentroid(void 0,ot,!1),Je&&ze.encodeCentroid(void 0,He,!1);continue}const tt=ie[de](ot,He),Ve=de%2?o.EXTENT-1:0;le.x=me(tt[0],Math.min(o.EXTENT-1,tt[1]),Ve,de<2,tt[2]),le.y=0,x.encodeCentroid(le,ot,!1),Je&&ze.encodeCentroid(le,He,!1)}else x.encodeCentroid(void 0,ot,!1)}x.borderDoneWithNeighborZ[de]=ze.canonical.z,x.needsCentroidUpdate=!0,Je&&(ze.borderDoneWithNeighborZ[be]=x.canonical.z,ze.needsCentroidUpdate=!0)}else{for(const lt of ge)x.encodeCentroid(void 0,x.featuresOnBorder[lt],!1);if(Je){for(const lt of Me)ze.encodeCentroid(void 0,ze.featuresOnBorder[lt],!1);ze.borderDoneWithNeighborZ[be]=x.canonical.z,ze.needsCentroidUpdate=!0}x.borderDoneWithNeighborZ[de]=ze.canonical.z,x.needsCentroidUpdate=!0}}(x.needsCentroidUpdate||!x.centroidVertexBuffer&&x.centroidVertexArray.length!==0)&&x.uploadCentroid(g)}const Tn=new o.Color(1,0,0,1),ao=new o.Color(0,1,0,1),xo=new o.Color(0,0,1,1),pa=new o.Color(1,0,1,1),ma=new o.Color(0,1,1,1);function Un(g,c,p){const x=g.context,T=g.transform,A=x.gl,k=T.projection.name==="globe",O=k?["PROJECTION_GLOBE_VIEW"]:null;let F=p.projMatrix;if(k&&o.globeToMercatorTransition(T.zoom)>0){const ot=o.transitionTileAABBinECEF(p.canonical,T),zt=o.globeDenormalizeECEF(ot);F=o.multiply(new Float32Array(16),T.globeMatrix,zt),o.multiply(F,T.projMatrix,F)}const V=g.useProgram("debug",null,O),G=c.getTileByID(p.key);g.terrain&&g.terrain.setupElevationDraw(G,V);const ie=o.DepthMode.disabled,le=o.StencilMode.disabled,_e=g.colorModeForRenderPass(),fe="$debug";x.activeTexture.set(A.TEXTURE0),g.emptyTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),k?G._makeGlobeTileDebugBuffers(g.context,T):G._makeDebugTileBoundsBuffers(g.context,T.projection);const ve=G._tileDebugBuffer||g.debugBuffer,me=G._tileDebugIndexBuffer||g.debugIndexBuffer,de=G._tileDebugSegments||g.debugSegments;V.draw(x,A.LINE_STRIP,ie,le,_e,o.CullFaceMode.disabled,rs(F,o.Color.red),fe,ve,me,de,null,null,null,[G._globeTileDebugBorderBuffer]);const be=G.latestRawTileData,ge=Math.floor((be&&be.byteLength||0)/1024),Be=c.getTile(p).tileSize,ze=512/Math.min(Be,512)*(p.overscaledZ/T.zoom)*.5;let Me=p.canonical.toString();p.overscaledZ!==p.canonical.z&&(Me+=` => ${p.overscaledZ}`),Me+=` ${ge}kb`,function(ot,zt){ot.initDebugOverlayCanvas();const He=ot.debugOverlayCanvas,wt=ot.context.gl,bt=ot.debugOverlayCanvas.getContext("2d");bt.clearRect(0,0,He.width,He.height),bt.shadowColor="white",bt.shadowBlur=2,bt.lineWidth=1.5,bt.strokeStyle="white",bt.textBaseline="top",bt.font="bold 36px Open Sans, sans-serif",bt.fillText(zt,5,5),bt.strokeText(zt,5,5),ot.debugOverlayTexture.update(He),ot.debugOverlayTexture.bind(wt.LINEAR,wt.CLAMP_TO_EDGE)}(g,Me);const Fe=G._tileDebugTextBuffer||g.debugBuffer,Je=G._tileDebugTextIndexBuffer||g.quadTriangleIndexBuffer,lt=G._tileDebugTextSegments||g.debugSegments;V.draw(x,A.TRIANGLES,ie,le,o.ColorMode.alphaBlended,o.CullFaceMode.disabled,rs(F,o.Color.transparent,ze),fe,Fe,Je,lt,null,null,null,[G._globeTileDebugTextBuffer])}function Dn(g,c,p,x){$n(g,0,c+p/2,g.transform.width,p,x)}function ns(g,c,p,x){$n(g,c-p/2,0,p,g.transform.height,x)}function $n(g,c,p,x,T,A){const k=g.context,O=k.gl;O.enable(O.SCISSOR_TEST),O.scissor(c*o.exported.devicePixelRatio,p*o.exported.devicePixelRatio,x*o.exported.devicePixelRatio,T*o.exported.devicePixelRatio),k.clear({color:A}),O.disable(O.SCISSOR_TEST)}const Co=o.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:La}=Co;function Bn(g,c,p,x){g.emplaceBack(c,p,x)}class hr{constructor(c){this.vertexArray=new o.StructArrayLayout3f12,this.indices=new o.StructArrayLayout3ui6,Bn(this.vertexArray,-1,-1,1),Bn(this.vertexArray,1,-1,1),Bn(this.vertexArray,-1,1,1),Bn(this.vertexArray,1,1,1),Bn(this.vertexArray,-1,-1,-1),Bn(this.vertexArray,1,-1,-1),Bn(this.vertexArray,-1,1,-1),Bn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=c.createVertexBuffer(this.vertexArray,La),this.indexBuffer=c.createIndexBuffer(this.indices),this.segment=o.SegmentVector.simpleSegment(0,0,36,12)}}function Vn(g,c,p,x,T,A){const k=g.gl,O=c.paint.get("sky-atmosphere-color"),F=c.paint.get("sky-atmosphere-halo-color"),V=c.paint.get("sky-atmosphere-sun-intensity"),G=((ie,le,_e,fe,ve)=>({u_matrix_3f:ie,u_sun_direction:le,u_sun_intensity:_e,u_color_tint_r:[fe.r,fe.g,fe.b,fe.a],u_color_tint_m:[ve.r,ve.g,ve.b,ve.a],u_luminance:5e-5}))(o.fromMat4(o.create$1(),x),T,V,O,F);k.framebufferTexture2D(k.FRAMEBUFFER,k.COLOR_ATTACHMENT0,k.TEXTURE_CUBE_MAP_POSITIVE_X+A,c.skyboxTexture,0),p.draw(g,k.TRIANGLES,o.DepthMode.disabled,o.StencilMode.disabled,o.ColorMode.unblended,o.CullFaceMode.frontCW,G,"skyboxCapture",c.skyboxGeometry.vertexBuffer,c.skyboxGeometry.indexBuffer,c.skyboxGeometry.segment)}const os=o.createLayout([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class $c{constructor(c){const p=new o.StructArrayLayout5f20;p.emplaceBack(-1,1,1,0,0),p.emplaceBack(1,1,1,1,0),p.emplaceBack(1,-1,1,1,1),p.emplaceBack(-1,-1,1,0,1);const x=new o.StructArrayLayout3ui6;x.emplaceBack(0,1,2),x.emplaceBack(2,3,0),this.vertexBuffer=c.createVertexBuffer(p,os.members),this.indexBuffer=c.createIndexBuffer(x),this.segments=o.SegmentVector.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const as={symbol:function(g,c,p,x,T){if(g.renderPass!=="translucent")return;const A=o.StencilMode.disabled,k=g.colorModeForRenderPass();p.layout.get("text-variable-anchor")&&function(O,F,V,G,ie,le,_e){const fe=F.transform,ve=ie==="map",me=le==="map";for(const de of O){const be=G.getTile(de),ge=be.getBucket(V);if(!ge||!ge.text||!ge.text.segments.get().length)continue;const Be=o.evaluateSizeForZoom(ge.textSizeData,fe.zoom),ze=et(de,ge.getProjection(),fe),Me=fe.calculatePixelsToTileUnitsMatrix(be),Fe=Cn(ze,be.tileID.canonical,me,ve,fe,ge.getProjection(),Me),Je=V.layout.get("icon-text-fit")!=="none"&&ge.hasIconData();if(Be){const lt=Math.pow(2,fe.zoom-be.tileID.overscaledZ);$l(ge,ve,me,_e,o.symbolSize,fe,Fe,de,lt,Be,Je)}}}(x,g,p,c,p.layout.get("text-rotation-alignment"),p.layout.get("text-pitch-alignment"),T),p.paint.get("icon-opacity").constantOr(1)!==0&&Cr(g,c,p,x,!1,p.paint.get("icon-translate"),p.paint.get("icon-translate-anchor"),p.layout.get("icon-rotation-alignment"),p.layout.get("icon-pitch-alignment"),p.layout.get("icon-keep-upright"),A,k),p.paint.get("text-opacity").constantOr(1)!==0&&Cr(g,c,p,x,!0,p.paint.get("text-translate"),p.paint.get("text-translate-anchor"),p.layout.get("text-rotation-alignment"),p.layout.get("text-pitch-alignment"),p.layout.get("text-keep-upright"),A,k),c.map.showCollisionBoxes&&(Io(g,c,p,x,p.paint.get("text-translate"),p.paint.get("text-translate-anchor"),!0),Io(g,c,p,x,p.paint.get("icon-translate"),p.paint.get("icon-translate-anchor"),!1))},circle:function(g,c,p,x){if(g.renderPass!=="translucent")return;const T=p.paint.get("circle-opacity"),A=p.paint.get("circle-stroke-width"),k=p.paint.get("circle-stroke-opacity"),O=p.layout.get("circle-sort-key").constantOr(1)!==void 0;if(T.constantOr(1)===0&&(A.constantOr(1)===0||k.constantOr(1)===0))return;const F=g.context,V=F.gl,G=g.transform,ie=g.depthModeForSublayer(0,o.DepthMode.ReadOnly),le=o.StencilMode.disabled,_e=g.colorModeForRenderPass(),fe=G.projection.name==="globe",ve=[o.mercatorXfromLng(G.center.lng),o.mercatorYfromLat(G.center.lat)],me=[];for(let be=0;be<x.length;be++){const ge=x[be],Be=c.getTile(ge),ze=Be.getBucket(p);if(!ze||ze.projection.name!==G.projection.name)continue;const Me=ze.programConfigurations.get(p.id),Fe=fa(p);fe&&Fe.push("PROJECTION_GLOBE_VIEW");const Je=g.useProgram("circle",Me,Fe),lt=ze.layoutVertexBuffer,ot=ze.globeExtVertexBuffer,zt=ze.indexBuffer,He=G.projection.createInversionMatrix(G,ge.canonical),wt={programConfiguration:Me,program:Je,layoutVertexBuffer:lt,globeExtVertexBuffer:ot,indexBuffer:zt,uniformValues:da(g,ge,Be,He,ve,p),tile:Be};if(O){const bt=ze.segments.get();for(const tt of bt)me.push({segments:new o.SegmentVector([tt]),sortKey:tt.sortKey,state:wt})}else me.push({segments:ze.segments,sortKey:0,state:wt})}O&&me.sort((be,ge)=>be.sortKey-ge.sortKey);const de={useDepthForOcclusion:!fe};for(const be of me){const{programConfiguration:ge,program:Be,layoutVertexBuffer:ze,globeExtVertexBuffer:Me,indexBuffer:Fe,uniformValues:Je,tile:lt}=be.state,ot=be.segments;g.terrain&&g.terrain.setupElevationDraw(lt,Be,de),g.prepareDrawProgram(F,Be,lt.tileID.toUnwrapped()),Be.draw(F,V.TRIANGLES,ie,le,_e,o.CullFaceMode.disabled,Je,p.id,ze,Fe,ot,p.paint,G.zoom,ge,[Me])}},heatmap:function(g,c,p,x){if(p.paint.get("heatmap-opacity")!==0)if(g.renderPass==="offscreen"){const T=g.context,A=T.gl,k=o.StencilMode.disabled,O=new o.ColorMode([A.ONE,A.ONE],o.Color.transparent,[!0,!0,!0,!0]);(function(_e,fe,ve,me){const de=_e.gl,be=fe.width*me,ge=fe.height*me;_e.activeTexture.set(de.TEXTURE1),_e.viewport.set([0,0,be,ge]);let Be=ve.heatmapFbo;if(!Be||Be&&(Be.width!==be||Be.height!==ge)){Be&&Be.destroy();const ze=de.createTexture();de.bindTexture(de.TEXTURE_2D,ze),de.texParameteri(de.TEXTURE_2D,de.TEXTURE_WRAP_S,de.CLAMP_TO_EDGE),de.texParameteri(de.TEXTURE_2D,de.TEXTURE_WRAP_T,de.CLAMP_TO_EDGE),de.texParameteri(de.TEXTURE_2D,de.TEXTURE_MIN_FILTER,de.LINEAR),de.texParameteri(de.TEXTURE_2D,de.TEXTURE_MAG_FILTER,de.LINEAR),Be=ve.heatmapFbo=_e.createFramebuffer(be,ge,!1),function(Me,Fe,Je,lt,ot,zt){const He=Me.gl;He.texImage2D(He.TEXTURE_2D,0,He.RGBA,ot,zt,0,He.RGBA,Me.extRenderToTextureHalfFloat?Me.extTextureHalfFloat.HALF_FLOAT_OES:He.UNSIGNED_BYTE,null),lt.colorAttachment.set(Je)}(_e,0,ze,Be,be,ge)}else de.bindTexture(de.TEXTURE_2D,Be.colorAttachment.get()),_e.bindFramebuffer.set(Be.framebuffer)})(T,g,p,g.transform.projection.name==="globe"?.5:.25),T.clear({color:o.Color.transparent});const F=g.transform,V=F.projection.name==="globe",G=V?["PROJECTION_GLOBE_VIEW"]:null,ie=V?o.CullFaceMode.frontCCW:o.CullFaceMode.disabled,le=[o.mercatorXfromLng(F.center.lng),o.mercatorYfromLat(F.center.lat)];for(let _e=0;_e<x.length;_e++){const fe=x[_e];if(c.hasRenderableParent(fe))continue;const ve=c.getTile(fe),me=ve.getBucket(p);if(!me||me.projection.name!==F.projection.name)continue;const de=me.programConfigurations.get(p.id),be=g.useProgram("heatmap",de,G),{zoom:ge}=g.transform;g.terrain&&g.terrain.setupElevationDraw(ve,be),g.prepareDrawProgram(T,be,fe.toUnwrapped());const Be=F.projection.createInversionMatrix(F,fe.canonical);be.draw(T,A.TRIANGLES,o.DepthMode.disabled,k,O,ie,pt(g,fe,ve,Be,le,ge,p.paint.get("heatmap-intensity")),p.id,me.layoutVertexBuffer,me.indexBuffer,me.segments,p.paint,g.transform.zoom,de,V?[me.globeExtVertexBuffer]:null)}T.viewport.set([0,0,g.width,g.height])}else g.renderPass==="translucent"&&(g.context.setColorMode(g.colorModeForRenderPass()),function(T,A){const k=T.context,O=k.gl,F=A.heatmapFbo;if(!F)return;k.activeTexture.set(O.TEXTURE0),O.bindTexture(O.TEXTURE_2D,F.colorAttachment.get()),k.activeTexture.set(O.TEXTURE1);let V=A.colorRampTexture;V||(V=A.colorRampTexture=new o.Texture(k,A.colorRamp,O.RGBA)),V.bind(O.LINEAR,O.CLAMP_TO_EDGE),T.useProgram("heatmapTexture").draw(k,O.TRIANGLES,o.DepthMode.disabled,o.StencilMode.disabled,T.colorModeForRenderPass(),o.CullFaceMode.disabled,((G,ie,le,_e)=>({u_image:0,u_color_ramp:1,u_opacity:ie.paint.get("heatmap-opacity")}))(0,A),A.id,T.viewportBuffer,T.quadTriangleIndexBuffer,T.viewportSegments,A.paint,T.transform.zoom)}(g,p))},line:function(g,c,p,x){if(g.renderPass!=="translucent")return;const T=p.paint.get("line-opacity"),A=p.paint.get("line-width");if(T.constantOr(1)===0||A.constantOr(1)===0)return;const k=g.depthModeForSublayer(0,o.DepthMode.ReadOnly),O=g.colorModeForRenderPass(),F=g.terrain&&g.terrain.renderingToTexture?1:o.exported.devicePixelRatio,V=p.paint.get("line-dasharray"),G=V.constantOr(1),ie=p.layout.get("line-cap"),le=p.paint.get("line-pattern"),_e=le.constantOr(1),fe=p.paint.get("line-gradient"),ve=p.getCrossfadeParameters(),me=_e?"linePattern":"line",de=g.context,be=de.gl,ge=(ze=>{const Me=[];Zr(ze)&&Me.push("RENDER_LINE_DASH"),ze.paint.get("line-gradient")&&Me.push("RENDER_LINE_GRADIENT");const Fe=ze.paint.get("line-trim-offset");Fe[0]===0&&Fe[1]===0||Me.push("RENDER_LINE_TRIM_OFFSET");const Je=ze.paint.get("line-pattern").constantOr(1),lt=ze.paint.get("line-opacity").constantOr(1)!==1;return!Je&&lt&&Me.push("RENDER_LINE_ALPHA_DISCARD"),Me})(p);let Be=ge.includes("RENDER_LINE_ALPHA_DISCARD");g.terrain&&g.terrain.clipOrMaskOverlapStencilType()&&(Be=!1);for(const ze of x){const Me=c.getTile(ze);if(_e&&!Me.patternsLoaded())continue;const Fe=Me.getBucket(p);if(!Fe)continue;g.prepareDrawTile();const Je=Fe.programConfigurations.get(p.id),lt=g.useProgram(me,Je,ge),ot=le.constantOr(null);if(ot&&Me.imageAtlas){const qt=Me.imageAtlas,Jt=qt.patternPositions[ot.to.toString()],Ht=qt.patternPositions[ot.from.toString()];Jt&&Ht&&Je.setConstantPatternPositions(Jt,Ht)}const zt=V.constantOr(null),He=ie.constantOr(null);if(!_e&&zt&&He&&Me.lineAtlas){const qt=Me.lineAtlas,Jt=qt.getDash(zt.to,He),Ht=qt.getDash(zt.from,He);Jt&&Ht&&Je.setConstantPatternPositions(Jt,Ht)}let[wt,bt]=p.paint.get("line-trim-offset");(He==="round"||He==="square")&&wt!==bt&&(wt===0&&(wt-=1),bt===1&&(bt+=1));const tt=g.terrain?ze.projMatrix:null,Ve=_e?Ui(g,Me,p,ve,tt,F):ui(g,Me,p,ve,tt,Fe.lineClipsArray.length,F,[wt,bt]);if(fe){const qt=Fe.gradients[p.id];let Jt=qt.texture;if(p.gradientVersion!==qt.version){let Ht=256;if(p.stepInterpolant){const Ai=c.getSource().maxzoom,Vi=ze.canonical.z===Ai?Math.ceil(1<<g.transform.maxZoom-ze.canonical.z):1;Ht=o.clamp(o.nextPowerOfTwo(Fe.maxLineLength/o.EXTENT*1024*Vi),256,de.maxTextureSize)}qt.gradient=o.renderColorRamp({expression:p.gradientExpression(),evaluationKey:"lineProgress",resolution:Ht,image:qt.gradient||void 0,clips:Fe.lineClipsArray}),qt.texture?qt.texture.update(qt.gradient):qt.texture=new o.Texture(de,qt.gradient,be.RGBA),qt.version=p.gradientVersion,Jt=qt.texture}de.activeTexture.set(be.TEXTURE1),Jt.bind(p.stepInterpolant?be.NEAREST:be.LINEAR,be.CLAMP_TO_EDGE)}G&&(de.activeTexture.set(be.TEXTURE0),Me.lineAtlasTexture.bind(be.LINEAR,be.REPEAT),Je.updatePaintBuffers(ve)),_e&&(de.activeTexture.set(be.TEXTURE0),Me.imageAtlasTexture.bind(be.LINEAR,be.CLAMP_TO_EDGE),Je.updatePaintBuffers(ve)),g.prepareDrawProgram(de,lt,ze.toUnwrapped());const ri=qt=>{lt.draw(de,be.TRIANGLES,k,qt,O,o.CullFaceMode.disabled,Ve,p.id,Fe.layoutVertexBuffer,Fe.indexBuffer,Fe.segments,p.paint,g.transform.zoom,Je,[Fe.layoutVertexBuffer2])};if(Be){const qt=g.stencilModeForClipping(ze).ref;qt===0&&g.terrain&&de.clear({stencil:0});const Jt={func:be.EQUAL,mask:255};Ve.u_alpha_discard_threshold=.8,ri(new o.StencilMode(Jt,qt,255,be.KEEP,be.KEEP,be.INVERT)),Ve.u_alpha_discard_threshold=0,ri(new o.StencilMode(Jt,qt,255,be.KEEP,be.KEEP,be.KEEP))}else ri(g.stencilModeForClipping(ze))}Be&&(g.resetStencilClippingMasks(),g.terrain&&de.clear({stencil:0}))},fill:function(g,c,p,x){const T=p.paint.get("fill-color"),A=p.paint.get("fill-opacity");if(A.constantOr(1)===0)return;const k=g.colorModeForRenderPass(),O=p.paint.get("fill-pattern"),F=g.opaquePassEnabledForLayer()&&!O.constantOr(1)&&T.constantOr(o.Color.transparent).a===1&&A.constantOr(0)===1?"opaque":"translucent";if(g.renderPass===F){const V=g.depthModeForSublayer(1,g.renderPass==="opaque"?o.DepthMode.ReadWrite:o.DepthMode.ReadOnly);Ba(g,c,p,x,V,k,!1)}if(g.renderPass==="translucent"&&p.paint.get("fill-antialias")){const V=g.depthModeForSublayer(p.getPaintProperty("fill-outline-color")?2:0,o.DepthMode.ReadOnly);Ba(g,c,p,x,V,k,!0)}},"fill-extrusion":function(g,c,p,x){const T=p.paint.get("fill-extrusion-opacity");if(T!==0&&g.renderPass==="translucent"){const A=new o.DepthMode(g.context.gl.LEQUAL,o.DepthMode.ReadWrite,g.depthRangeFor3D);if(T!==1||p.paint.get("fill-extrusion-pattern").constantOr(1))oo(g,c,p,x,A,o.StencilMode.disabled,o.ColorMode.disabled),oo(g,c,p,x,A,g.stencilModeFor3D(),g.colorModeForRenderPass()),g.resetStencilClippingMasks();else{const k=g.colorModeForRenderPass();oo(g,c,p,x,A,o.StencilMode.disabled,k)}}},hillshade:function(g,c,p,x){if(g.renderPass!=="offscreen"&&g.renderPass!=="translucent")return;const T=g.context,A=g.depthModeForSublayer(0,o.DepthMode.ReadOnly),k=g.colorModeForRenderPass(),O=g.terrain&&g.terrain.renderingToTexture,[F,V]=g.renderPass!=="translucent"||O?[{},x]:g.stencilConfigForOverlap(x);for(const G of V){const ie=c.getTile(G);if(ie.needsHillshadePrepare&&g.renderPass==="offscreen")Mo(g,ie,p,A,o.StencilMode.disabled,k);else if(g.renderPass==="translucent"){const le=O&&g.terrain?g.terrain.stencilModeForRTTOverlap(G):F[G.overscaledZ];io(g,G,ie,p,A,le,k)}}T.viewport.set([0,0,g.width,g.height]),g.resetStencilClippingMasks()},raster:function(g,c,p,x,T,A){if(g.renderPass!=="translucent"||p.paint.get("raster-opacity")===0||!x.length)return;const k=g.context,O=k.gl,F=c.getSource(),V=g.useProgram("raster"),G=g.colorModeForRenderPass(),ie=g.terrain&&g.terrain.renderingToTexture,[le,_e]=F instanceof ke||ie?[{},x]:g.stencilConfigForOverlap(x),fe=_e[_e.length-1].overscaledZ,ve=!g.options.moving;for(const me of _e){const de=ie?o.DepthMode.disabled:g.depthModeForSublayer(me.overscaledZ-fe,p.paint.get("raster-opacity")===1?o.DepthMode.ReadWrite:o.DepthMode.ReadOnly,O.LESS),be=me.toUnwrapped(),ge=c.getTile(me);if(ie&&(!ge||!ge.hasData()))continue;const Be=ie?me.projMatrix:g.transform.calculateProjMatrix(be,ve),ze=g.terrain&&ie?g.terrain.stencilModeForRTTOverlap(me):le[me.overscaledZ],Me=A?0:p.paint.get("raster-fade-duration");ge.registerFadeDuration(Me);const Fe=c.findLoadedParent(me,0),Je=Ss(ge,Fe,c,g.transform,Me);let lt,ot;g.terrain&&g.terrain.prepareDrawTile();const zt=p.paint.get("raster-resampling")==="nearest"?O.NEAREST:O.LINEAR;k.activeTexture.set(O.TEXTURE0),ge.texture.bind(zt,O.CLAMP_TO_EDGE),k.activeTexture.set(O.TEXTURE1),Fe?(Fe.texture.bind(zt,O.CLAMP_TO_EDGE),lt=Math.pow(2,Fe.tileID.overscaledZ-ge.tileID.overscaledZ),ot=[ge.tileID.canonical.x*lt%1,ge.tileID.canonical.y*lt%1]):ge.texture.bind(zt,O.CLAMP_TO_EDGE);const He=Kr(Be,ot||[0,0],lt||1,Je,p,F instanceof ke?F.perspectiveTransform:[0,0]);if(g.prepareDrawProgram(k,V,be),F instanceof ke)F.boundsBuffer&&F.boundsSegments&&V.draw(k,O.TRIANGLES,de,o.StencilMode.disabled,G,o.CullFaceMode.disabled,He,p.id,F.boundsBuffer,g.quadTriangleIndexBuffer,F.boundsSegments);else{const{tileBoundsBuffer:wt,tileBoundsIndexBuffer:bt,tileBoundsSegments:tt}=g.getTileBoundsBuffers(ge);V.draw(k,O.TRIANGLES,de,ze,G,o.CullFaceMode.disabled,He,p.id,wt,bt,tt)}}g.resetStencilClippingMasks()},background:function(g,c,p,x){const T=p.paint.get("background-color"),A=p.paint.get("background-opacity");if(A===0)return;const k=g.context,O=k.gl,F=g.transform,V=F.tileSize,G=p.paint.get("background-pattern");if(g.isPatternMissing(G))return;const ie=!G&&T.a===1&&A===1&&g.opaquePassEnabledForLayer()?"opaque":"translucent";if(g.renderPass!==ie)return;const le=o.StencilMode.disabled,_e=g.depthModeForSublayer(0,ie==="opaque"?o.DepthMode.ReadWrite:o.DepthMode.ReadOnly),fe=g.colorModeForRenderPass(),ve=g.useProgram(G?"backgroundPattern":"background");let me,de=x;de||(me=g.getBackgroundTiles(),de=Object.values(me).map(ge=>ge.tileID)),G&&(k.activeTexture.set(O.TEXTURE0),g.imageManager.bind(g.context));const be=p.getCrossfadeParameters();for(const ge of de){const Be=ge.toUnwrapped(),ze=x?ge.projMatrix:g.transform.calculateProjMatrix(Be);g.prepareDrawTile();const Me=c?c.getTile(ge):me?me[ge.key]:new o.Tile(ge,V,F.zoom,g),Fe=G?_o(ze,A,g,G,{tileID:ge,tileSize:V},be):dn(ze,A,T);g.prepareDrawProgram(k,ve,Be);const{tileBoundsBuffer:Je,tileBoundsIndexBuffer:lt,tileBoundsSegments:ot}=g.getTileBoundsBuffers(Me);ve.draw(k,O.TRIANGLES,_e,le,fe,o.CullFaceMode.disabled,Fe,p.id,Je,lt,ot)}},sky:function(g,c,p){const x=g.transform,T=x.projection.name==="mercator"||x.projection.name==="globe"?1:o.smoothstep(7,8,x.zoom),A=p.paint.get("sky-opacity")*T;if(A===0)return;const k=g.context,O=p.paint.get("sky-type"),F=new o.DepthMode(k.gl.LEQUAL,o.DepthMode.ReadOnly,[0,1]),V=g.frameCounter/1e3%1;O==="atmosphere"?g.renderPass==="offscreen"?p.needsSkyboxCapture(g)&&(function(G,ie,le,_e){const fe=G.context,ve=fe.gl;let me=ie.skyboxFbo;if(!me){me=ie.skyboxFbo=fe.createFramebuffer(32,32,!1),ie.skyboxGeometry=new hr(fe),ie.skyboxTexture=fe.gl.createTexture(),ve.bindTexture(ve.TEXTURE_CUBE_MAP,ie.skyboxTexture),ve.texParameteri(ve.TEXTURE_CUBE_MAP,ve.TEXTURE_WRAP_S,ve.CLAMP_TO_EDGE),ve.texParameteri(ve.TEXTURE_CUBE_MAP,ve.TEXTURE_WRAP_T,ve.CLAMP_TO_EDGE),ve.texParameteri(ve.TEXTURE_CUBE_MAP,ve.TEXTURE_MIN_FILTER,ve.LINEAR),ve.texParameteri(ve.TEXTURE_CUBE_MAP,ve.TEXTURE_MAG_FILTER,ve.LINEAR);for(let Be=0;Be<6;++Be)ve.texImage2D(ve.TEXTURE_CUBE_MAP_POSITIVE_X+Be,0,ve.RGBA,32,32,0,ve.RGBA,ve.UNSIGNED_BYTE,null)}fe.bindFramebuffer.set(me.framebuffer),fe.viewport.set([0,0,32,32]);const de=ie.getCenter(G,!0),be=G.useProgram("skyboxCapture"),ge=new Float64Array(16);o.identity(ge),o.rotateY(ge,ge,.5*-Math.PI),Vn(fe,ie,be,ge,de,0),o.identity(ge),o.rotateY(ge,ge,.5*Math.PI),Vn(fe,ie,be,ge,de,1),o.identity(ge),o.rotateX(ge,ge,.5*-Math.PI),Vn(fe,ie,be,ge,de,2),o.identity(ge),o.rotateX(ge,ge,.5*Math.PI),Vn(fe,ie,be,ge,de,3),o.identity(ge),Vn(fe,ie,be,ge,de,4),o.identity(ge),o.rotateY(ge,ge,Math.PI),Vn(fe,ie,be,ge,de,5),fe.viewport.set([0,0,G.width,G.height])}(g,p),p.markSkyboxValid(g)):g.renderPass==="sky"&&function(G,ie,le,_e,fe){const ve=G.context,me=ve.gl,de=G.transform,be=G.useProgram("skybox");ve.activeTexture.set(me.TEXTURE0),me.bindTexture(me.TEXTURE_CUBE_MAP,ie.skyboxTexture);const ge=((Be,ze,Me,Fe,Je)=>({u_matrix:Be,u_sun_direction:ze,u_cubemap:0,u_opacity:Fe,u_temporal_offset:Je}))(de.skyboxMatrix,ie.getCenter(G,!1),0,_e,fe);G.prepareDrawProgram(ve,be),be.draw(ve,me.TRIANGLES,le,o.StencilMode.disabled,G.colorModeForRenderPass(),o.CullFaceMode.backCW,ge,"skybox",ie.skyboxGeometry.vertexBuffer,ie.skyboxGeometry.indexBuffer,ie.skyboxGeometry.segment)}(g,p,F,A,V):O==="gradient"&&g.renderPass==="sky"&&function(G,ie,le,_e,fe){const ve=G.context,me=ve.gl,de=G.transform,be=G.useProgram("skyboxGradient");ie.skyboxGeometry||(ie.skyboxGeometry=new hr(ve)),ve.activeTexture.set(me.TEXTURE0);let ge=ie.colorRampTexture;ge||(ge=ie.colorRampTexture=new o.Texture(ve,ie.colorRamp,me.RGBA)),ge.bind(me.LINEAR,me.CLAMP_TO_EDGE);const Be=((ze,Me,Fe,Je,lt)=>({u_matrix:ze,u_color_ramp:0,u_center_direction:Me,u_radius:o.degToRad(Fe),u_opacity:Je,u_temporal_offset:lt}))(de.skyboxMatrix,ie.getCenter(G,!1),ie.paint.get("sky-gradient-radius"),_e,fe);G.prepareDrawProgram(ve,be),be.draw(ve,me.TRIANGLES,le,o.StencilMode.disabled,G.colorModeForRenderPass(),o.CullFaceMode.backCW,Be,"skyboxGradient",ie.skyboxGeometry.vertexBuffer,ie.skyboxGeometry.indexBuffer,ie.skyboxGeometry.segment)}(g,p,F,A,V)},debug:function(g,c,p){for(let x=0;x<p.length;x++)Un(g,c,p[x])},custom:function(g,c,p){const x=g.context,T=p.implementation;if(g.transform.projection.unsupportedLayers&&g.transform.projection.unsupportedLayers.includes("custom"))o.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.");else if(g.renderPass==="offscreen"){const A=T.prerender;A&&(g.setCustomLayerDefaults(),x.setColorMode(g.colorModeForRenderPass()),A.call(T,x.gl,g.transform.customLayerMatrix()),x.setDirty(),g.setBaseState())}else if(g.renderPass==="translucent"){g.setCustomLayerDefaults(),x.setColorMode(g.colorModeForRenderPass()),x.setStencilMode(o.StencilMode.disabled);const A=T.renderingMode==="3d"?new o.DepthMode(g.context.gl.LEQUAL,o.DepthMode.ReadWrite,g.depthRangeFor3D):g.depthModeForSublayer(0,o.DepthMode.ReadOnly);x.setDepthMode(A),T.render(x.gl,g.transform.customLayerMatrix()),x.setDirty(),g.setBaseState(),x.bindFramebuffer.set(null)}}};class Qu{constructor(c,p){this.context=new H(c),this.transform=p,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=o.SourceCache.maxUnderzooming+o.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new zo,this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={}}updateTerrain(c,p){const x=!!c&&!!c.terrain&&this.transform.projection.supportsTerrain;if(!(x||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Vo(this,c));const T=this._terrain;this.transform.elevation=x?T:null,T.update(c,this.transform,p)}_updateFog(c){const p=c.fog;if(!p||this.transform.projection.name==="globe"||p.getOpacity(this.transform.pitch)<1||p.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[x,T]=p.getFovAdjustedRange(this.transform._fov);if(x>T)return void(this.transform.fogCullDistSq=null);const A=x+.78*(T-x);this.transform.fogCullDistSq=A*A}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(c,p){if(this.width=c*o.exported.devicePixelRatio,this.height=p*o.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const x of this.style.order)this.style._layers[x].resize()}setup(){const c=this.context,p=new o.StructArrayLayout2i4;p.emplaceBack(0,0),p.emplaceBack(o.EXTENT,0),p.emplaceBack(0,o.EXTENT),p.emplaceBack(o.EXTENT,o.EXTENT),this.tileExtentBuffer=c.createVertexBuffer(p,o.posAttributes.members),this.tileExtentSegments=o.SegmentVector.simpleSegment(0,0,4,2);const x=new o.StructArrayLayout2i4;x.emplaceBack(0,0),x.emplaceBack(o.EXTENT,0),x.emplaceBack(0,o.EXTENT),x.emplaceBack(o.EXTENT,o.EXTENT),this.debugBuffer=c.createVertexBuffer(x,o.posAttributes.members),this.debugSegments=o.SegmentVector.simpleSegment(0,0,4,5);const T=new o.StructArrayLayout2i4;T.emplaceBack(-1,-1),T.emplaceBack(1,-1),T.emplaceBack(-1,1),T.emplaceBack(1,1),this.viewportBuffer=c.createVertexBuffer(T,o.posAttributes.members),this.viewportSegments=o.SegmentVector.simpleSegment(0,0,4,2);const A=new o.StructArrayLayout4i8;A.emplaceBack(0,0,0,0),A.emplaceBack(o.EXTENT,0,o.EXTENT,0),A.emplaceBack(0,o.EXTENT,0,o.EXTENT),A.emplaceBack(o.EXTENT,o.EXTENT,o.EXTENT,o.EXTENT),this.mercatorBoundsBuffer=c.createVertexBuffer(A,o.boundsAttributes.members),this.mercatorBoundsSegments=o.SegmentVector.simpleSegment(0,0,4,2);const k=new o.StructArrayLayout3ui6;k.emplaceBack(0,1,2),k.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=c.createIndexBuffer(k);const O=new o.StructArrayLayout1ui2;for(const V of[0,1,3,2,0])O.emplaceBack(V);this.debugIndexBuffer=c.createIndexBuffer(O),this.emptyTexture=new o.Texture(c,new o.RGBAImage({width:1,height:1},Uint8Array.of(0,0,0,0)),c.gl.RGBA),this.identityMat=o.create();const F=this.context.gl;this.stencilClearMode=new o.StencilMode({func:F.ALWAYS,mask:0},0,255,F.ZERO,F.ZERO,F.ZERO),this.loadTimeStamps.push(o.window.performance.now()),this.atmosphereBuffer=new $c(this.context)}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(c){return c._makeTileBoundsBuffers(this.context,this.transform.projection),c._tileBoundsBuffer?{tileBoundsBuffer:c._tileBoundsBuffer,tileBoundsIndexBuffer:c._tileBoundsIndexBuffer,tileBoundsSegments:c._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const c=this.context,p=c.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(c,p.TRIANGLES,o.DepthMode.disabled,this.stencilClearMode,o.ColorMode.disabled,o.CullFaceMode.disabled,ca(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(c,p,x){if(!p||this.currentStencilSource===p.id||!c.isTileClipped()||!x||x.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let O=!1;for(const F of x)if(this._tileClippingMaskIDs[F.key]===void 0){O=!0;break}if(!O)return}this.currentStencilSource=p.id;const T=this.context,A=T.gl;this.nextStencilID+x.length>256&&this.clearStencil(),T.setColorMode(o.ColorMode.disabled),T.setDepthMode(o.DepthMode.disabled);const k=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const O of x){const F=p.getTile(O),V=this._tileClippingMaskIDs[O.key]=this.nextStencilID++,{tileBoundsBuffer:G,tileBoundsIndexBuffer:ie,tileBoundsSegments:le}=this.getTileBoundsBuffers(F);k.draw(T,A.TRIANGLES,o.DepthMode.disabled,new o.StencilMode({func:A.ALWAYS,mask:0},V,255,A.KEEP,A.KEEP,A.REPLACE),o.ColorMode.disabled,o.CullFaceMode.disabled,ca(O.projMatrix),"$clipping",G,ie,le)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const c=this.nextStencilID++,p=this.context.gl;return new o.StencilMode({func:p.NOTEQUAL,mask:255},c,255,p.KEEP,p.KEEP,p.REPLACE)}stencilModeForClipping(c){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(c);const p=this.context.gl;return new o.StencilMode({func:p.EQUAL,mask:255},this._tileClippingMaskIDs[c.key],0,p.KEEP,p.KEEP,p.REPLACE)}stencilConfigForOverlap(c){const p=this.context.gl,x=c.sort((k,O)=>O.overscaledZ-k.overscaledZ),T=x[x.length-1].overscaledZ,A=x[0].overscaledZ-T+1;if(A>1){this.currentStencilSource=void 0,this.nextStencilID+A>256&&this.clearStencil();const k={};for(let O=0;O<A;O++)k[O+T]=new o.StencilMode({func:p.GEQUAL,mask:255},O+this.nextStencilID,255,p.KEEP,p.KEEP,p.REPLACE);return this.nextStencilID+=A,[k,x]}return[{[T]:o.StencilMode.disabled},x]}colorModeForRenderPass(){const c=this.context.gl;return this._showOverdrawInspector?new o.ColorMode([c.CONSTANT_COLOR,c.ONE],new o.Color(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?o.ColorMode.unblended:o.ColorMode.alphaBlended}depthModeForSublayer(c,p,x){if(!this.opaquePassEnabledForLayer())return o.DepthMode.disabled;const T=1-((1+this.currentLayer)*this.numSublayers+c)*this.depthEpsilon;return new o.DepthMode(x||this.context.gl.LEQUAL,p,[T,T])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(c,p){this.style=c,this.options=p,this.imageManager=c.imageManager,this.glyphManager=c.glyphManager,this.symbolFadeChange=c.placement.symbolFadeChange(o.exported.now()),this.imageManager.beginFrame();const x=this.style.order,T=this.style._sourceCaches;for(const F in T){const V=T[F];V.used&&V.prepare(this.context)}const A={},k={},O={};for(const F in T){const V=T[F];A[F]=V.getVisibleCoordinates(),k[F]=A[F].slice().reverse(),O[F]=V.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let F=0;F<x.length;F++)if(this.style._layers[x[F]].is3D()){this.opaquePassCutoff=F;break}if(this.terrain&&(this.terrain.updateTileBinding(O),this.opaquePassCutoff=0),this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new o.GlobeSharedBuffers(this.context)),o.isMapAuthenticated(this.context.gl)){this.renderPass="offscreen";for(const F of x){const V=this.style._layers[F],G=c._getLayerSourceCache(V);if(!V.hasOffscreenPass()||V.isHidden(this.transform.zoom))continue;const ie=G?k[G.id]:void 0;(V.type==="custom"||V.isSky()||ie&&ie.length)&&this.renderLayer(this,G,V,ie)}if(this.depthRangeFor3D=[0,1-(c.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]),this.context.clear({color:p.showOverdrawInspector?o.Color.black:o.Color.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=p.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=x.length-1;this.currentLayer>=0;this.currentLayer--){const F=this.style._layers[x[this.currentLayer]],V=c._getLayerSourceCache(F);if(F.isSky())continue;const G=V?k[V.id]:void 0;this._renderTileClippingMasks(F,V,G),this.renderLayer(this,V,F,G)}if(this.style.fog&&this.transform.projection.supportsFog&&function(F,V){const G=F.context,ie=G.gl,le=F.transform,_e=new o.DepthMode(ie.LEQUAL,o.DepthMode.ReadOnly,[0,1]),fe=F.useProgram("globeAtmosphere",null,le.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"]),ve=o.globeToMercatorTransition(le.zoom),me=V.properties.get("color").toArray01(),de=V.properties.get("high-color").toArray01(),be=V.properties.get("space-color").toArray01PremultipliedAlpha(),ge=o.identity$1([]);o.rotateY$1(ge,ge,-o.degToRad(le._center.lng)),o.rotateX$1(ge,ge,o.degToRad(le._center.lat)),o.rotateZ$1(ge,ge,le.angle),o.rotateX$1(ge,ge,-le._pitch);const Be=o.fromQuat(new Float32Array(16),ge),ze=o.mapValue(V.properties.get("star-intensity"),0,1,0,.25),Me=5e-4,Fe=o.mapValue(V.properties.get("horizon-blend"),0,1,Me,.25),Je=o.globeUseCustomAntiAliasing(F,G,le)&&Fe===Me?le.worldSize/(2*Math.PI*1.025)-1:le.globeRadius,lt=F.frameCounter/1e3%1,ot=o.length(le.globeCenterInViewSpace),zt=Math.sqrt(Math.pow(ot,2)-Math.pow(Je,2)),He=Math.acos(zt/ot),wt=((tt,Ve,ri,qt,Jt,Ht,Ai,Vi,Ni,Bi,Wt,Zi,er,Tr)=>({u_frustum_tl:tt,u_frustum_tr:Ve,u_frustum_br:ri,u_frustum_bl:qt,u_horizon:Jt,u_transition:Ht,u_fadeout_range:Ai,u_color:Vi,u_high_color:Ni,u_space_color:Bi,u_star_intensity:Wt,u_star_size:5*o.exported.devicePixelRatio,u_star_density:0,u_temporal_offset:Zi,u_horizon_angle:er,u_rotation_matrix:Tr}))(le.frustumCorners.TL,le.frustumCorners.TR,le.frustumCorners.BR,le.frustumCorners.BL,le.frustumCorners.horizon,ve,Fe,me,de,be,ze,lt,He,Be);F.prepareDrawProgram(G,fe);const bt=F.atmosphereBuffer;bt&&fe.draw(G,ie.TRIANGLES,_e,o.StencilMode.disabled,o.ColorMode.alphaBlended,o.CullFaceMode.backCW,wt,"skybox",bt.vertexBuffer,bt.indexBuffer,bt.segments)}(this,this.style.fog),this.renderPass="sky",(o.globeToMercatorTransition(this.transform.zoom)>0||this.transform.projection.name!=="globe")&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<x.length;this.currentLayer++){const F=this.style._layers[x[this.currentLayer]],V=c._getLayerSourceCache(F);F.isSky()&&this.renderLayer(this,V,F,V?k[V.id]:void 0)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<x.length;){const F=this.style._layers[x[this.currentLayer]],V=c._getLayerSourceCache(F);if(F.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(F)){if(F.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const G=V?(F.type==="symbol"?O:k)[V.id]:void 0;this._renderTileClippingMasks(F,V,V?A[V.id]:void 0),this.renderLayer(this,V,F,G),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let F=null;o.values(this.style._layers).forEach(V=>{const G=c._getLayerSourceCache(V);G&&!V.isHidden(this.transform.zoom)&&(!F||F.getSource().maxzoom<G.getSource().maxzoom)&&(F=G)}),F&&this.options.showTileBoundaries&&as.debug(this,F,F.getVisibleCoordinates())}this.options.showPadding&&function(F){const V=F.transform.padding;Dn(F,F.transform.height-(V.top||0),3,Tn),Dn(F,V.bottom||0,3,ao),ns(F,V.left||0,3,xo),ns(F,F.transform.width-(V.right||0),3,pa);const G=F.transform.centerPoint;(function(ie,le,_e,fe){$n(ie,le-1,_e-10,2,20,fe),$n(ie,le-10,_e-1,20,2,fe)})(F,G.x,F.transform.height-G.y,ma)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(o.window.performance.now()),this.saveCanvasCopy())}}renderLayer(c,p,x,T){x.isHidden(this.transform.zoom)||(x.type==="background"||x.type==="sky"||x.type==="custom"||T&&T.length)&&(this.id=x.id,this.gpuTimingStart(x),c.transform.projection.unsupportedLayers&&c.transform.projection.unsupportedLayers.includes(x.type)||as[x.type](c,p,x,T,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(c){if(!this.options.gpuTiming)return;const p=this.context.extTimerQuery;let x=this.gpuTimers[c.id];x||(x=this.gpuTimers[c.id]={calls:0,cpuTime:0,query:p.createQueryEXT()}),x.calls++,p.beginQueryEXT(p.TIME_ELAPSED_EXT,x.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const c=this.context.extTimerQuery,p=c.createQueryEXT();this.deferredRenderGpuTimeQueries.push(p),c.beginQueryEXT(c.TIME_ELAPSED_EXT,p)}}gpuTimingDeferredRenderEnd(){if(!this.options.gpuTimingDeferredRender)return;const c=this.context.extTimerQuery;c.endQueryEXT(c.TIME_ELAPSED_EXT)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const c=this.context.extTimerQuery;c.endQueryEXT(c.TIME_ELAPSED_EXT)}collectGpuTimers(){const c=this.gpuTimers;return this.gpuTimers={},c}collectDeferredRenderGpuQueries(){const c=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],c}queryGpuTimers(c){const p={};for(const x in c){const T=c[x],A=this.context.extTimerQuery,k=A.getQueryObjectEXT(T.query,A.QUERY_RESULT_EXT)/1e6;A.deleteQueryEXT(T.query),p[x]=k}return p}queryGpuTimeDeferredRender(c){if(!this.options.gpuTimingDeferredRender)return 0;const p=this.context.extTimerQuery;let x=0;for(const T of c)x+=p.getQueryObjectEXT(T,p.QUERY_RESULT_EXT)/1e6,p.deleteQueryEXT(T);return x}translatePosMatrix(c,p,x,T,A){if(!x[0]&&!x[1])return c;const k=A?T==="map"?this.transform.angle:0:T==="viewport"?-this.transform.angle:0;if(k){const V=Math.sin(k),G=Math.cos(k);x=[x[0]*G-x[1]*V,x[0]*V+x[1]*G]}const O=[A?x[0]:At(p,x[0],this.transform.zoom),A?x[1]:At(p,x[1],this.transform.zoom),0],F=new Float32Array(16);return o.translate(F,c,O),F}saveTileTexture(c){const p=this._tileTextures[c.size[0]];p?p.push(c):this._tileTextures[c.size[0]]=[c]}getTileTexture(c){const p=this._tileTextures[c];return p&&p.length>0?p.pop():null}isPatternMissing(c){if(!c)return!1;if(!c.from||!c.to)return!0;const p=this.imageManager.getPattern(c.from.toString()),x=this.imageManager.getPattern(c.to.toString());return!p||!x}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}currentGlobalDefines(){const c=this.terrain&&this.terrain.renderingToTexture,p=this.style&&this.style.fog,x=[];return this.terrainRenderModeElevated()&&x.push("TERRAIN"),this.transform.projection.name==="globe"&&x.push("GLOBE"),p&&!c&&p.getOpacity(this.transform.pitch)!==0&&x.push("FOG"),c&&x.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&x.push("OVERDRAW_INSPECTOR"),x}useProgram(c,p,x){this.cache=this.cache||{};const T=x||[],A=this.currentGlobalDefines().concat(T),k=tl.cacheKey(Ts[c],c,A,p);return this.cache[k]||(this.cache[k]=new tl(this.context,c,Ts[c],p,yo[c],A)),this.cache[k]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const c=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(c.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=o.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new o.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this.atmosphereBuffer&&this.atmosphereBuffer.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}prepareDrawProgram(c,p,x){if(this.terrain&&this.terrain.renderingToTexture)return;const T=this.style.fog;if(T){const A=T.getOpacity(this.transform.pitch),k=((O,F,V,G,ie,le,_e,fe,ve,me,de)=>{const be=O.transform,ge=F.properties.get("color").toArray01();ge[3]=G;const Be=O.frameCounter/1e3%1;return{u_fog_matrix:V?be.calculateFogTileMatrix(V):O.identityMat,u_fog_range:F.getFovAdjustedRange(be._fov),u_fog_color:ge,u_fog_horizon_blend:F.properties.get("horizon-blend"),u_fog_temporal_offset:Be,u_frustum_tl:ie,u_frustum_tr:le,u_frustum_br:_e,u_frustum_bl:fe,u_globe_pos:ve,u_globe_radius:me,u_viewport:de,u_globe_transition:o.globeToMercatorTransition(be.zoom),u_is_globe:+(be.projection.name==="globe")}})(this,T,x,A,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*o.exported.devicePixelRatio,this.transform.height*o.exported.devicePixelRatio]);p.setFogUniformValues(c,k)}}setTileLoadedFlag(c){this.tileLoaded=c}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1}canvasCopy(){const c=this.context.gl,p=c.createTexture();return c.bindTexture(c.TEXTURE_2D,p),c.copyTexImage2D(c.TEXTURE_2D,0,c.RGBA,0,0,c.drawingBufferWidth,c.drawingBufferHeight,0),p}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const c=this.style&&this.style.fog;return!!c&&c.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const c=this._backgroundTiles,p=this._backgroundTiles={},x=this.transform.coveringTiles({tileSize:512});for(const T of x)p[T.key]=c[T.key]||new o.Tile(T,512,this.transform.tileZoom,this);return p}clearBackgroundTiles(){this._backgroundTiles={}}}class jl{constructor(c=0,p=0,x=0,T=0){if(isNaN(c)||c<0||isNaN(p)||p<0||isNaN(x)||x<0||isNaN(T)||T<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=c,this.bottom=p,this.left=x,this.right=T}interpolate(c,p,x){return p.top!=null&&c.top!=null&&(this.top=o.number(c.top,p.top,x)),p.bottom!=null&&c.bottom!=null&&(this.bottom=o.number(c.bottom,p.bottom,x)),p.left!=null&&c.left!=null&&(this.left=o.number(c.left,p.left,x)),p.right!=null&&c.right!=null&&(this.right=o.number(c.right,p.right,x)),this}getCenter(c,p){const x=o.clamp((this.left+c-this.right)/2,0,c),T=o.clamp((this.top+p-this.bottom)/2,0,p);return new o.pointGeometry(x,T)}equals(c){return this.top===c.top&&this.bottom===c.bottom&&this.left===c.left&&this.right===c.right}clone(){return new jl(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Gl(g,c){const p=o.getColumn(g,3);o.fromQuat(g,c),o.setColumn(g,3,p)}function ql(g,c){const p=o.identity$1([]);return o.rotateZ$1(p,p,-c),o.rotateX$1(p,p,-g),p}function Cs(g,c){const p=[g[0],g[1],0],x=[c[0],c[1],0];if(o.length(p)>=1e-15){const k=o.normalize([],p);o.scale$2(x,k,o.dot(x,k)),c[0]=x[0],c[1]=x[1]}const T=o.cross([],c,g);if(o.len(T)<1e-15)return null;const A=Math.atan2(-T[1],T[0]);return ql(Math.atan2(Math.sqrt(g[0]*g[0]+g[1]*g[1]),-g[2]),A)}class ks{constructor(c,p){this.position=c,this.orientation=p}get position(){return this._position}set position(c){if(c){const p=c instanceof o.MercatorCoordinate?c:new o.MercatorCoordinate(c[0],c[1],c[2]);this._renderWorldCopies&&(p.x=o.wrap(p.x,0,1)),this._position=p}else this._position=null}lookAtPoint(c,p){if(this.orientation=null,!this.position)return;const x=this._elevation?this._elevation.getAtPointOrZero(o.MercatorCoordinate.fromLngLat(c)):0,T=this.position,A=o.MercatorCoordinate.fromLngLat(c,x),k=[A.x-T.x,A.y-T.y,A.z-T.z];p||(p=[0,0,1]),p[2]=Math.abs(p[2]),this.orientation=Cs(k,p)}setPitchBearing(c,p){this.orientation=ql(o.degToRad(c),o.degToRad(-p))}}class za{constructor(c,p){this._transform=o.identity([]),this.orientation=p,this.position=c}get mercatorPosition(){const c=this.position;return new o.MercatorCoordinate(c[0],c[1],c[2])}get position(){const c=o.getColumn(this._transform,3);return[c[0],c[1],c[2]]}set position(c){var p;c&&o.setColumn(this._transform,3,[(p=c)[0],p[1],p[2],1])}get orientation(){return this._orientation}set orientation(c){this._orientation=c||o.identity$1([]),c&&Gl(this._transform,this._orientation)}getPitchBearing(){const c=this.forward(),p=this.right();return{bearing:Math.atan2(-p[1],p[0]),pitch:Math.atan2(Math.sqrt(c[0]*c[0]+c[1]*c[1]),-c[2])}}setPitchBearing(c,p){this._orientation=ql(c,p),Gl(this._transform,this._orientation)}forward(){const c=o.getColumn(this._transform,2);return[-c[0],-c[1],-c[2]]}up(){const c=o.getColumn(this._transform,1);return[-c[0],-c[1],-c[2]]}right(){const c=o.getColumn(this._transform,0);return[c[0],c[1],c[2]]}getCameraToWorld(c,p){const x=new Float64Array(16);return o.invert(x,this.getWorldToCamera(c,p)),x}getWorldToCameraPosition(c,p,x){const T=this.position;o.scale$2(T,T,-c);const A=new Float64Array(16);return o.fromScaling(A,[x,x,x]),o.translate(A,A,T),A[10]*=p,A}getWorldToCamera(c,p){const x=new Float64Array(16),T=new Float64Array(4),A=this.position;return o.conjugate(T,this._orientation),o.scale$2(A,A,-c),o.fromQuat(x,T),o.translate(x,x,A),x[1]*=-1,x[5]*=-1,x[9]*=-1,x[13]*=-1,x[8]*=p,x[9]*=p,x[10]*=p,x[11]*=p,x}getCameraToClipPerspective(c,p,x,T){const A=new Float64Array(16);return o.perspective(A,c,p,x,T),A}getDistanceToElevation(c){const p=c===0?0:o.mercatorZfromAltitude(c,this.position[1]),x=this.forward();return(p-this.position[2])/x[2]}clone(){return new za([...this.position],[...this.orientation])}}function rl(g,c){const p=Ps(g.projection,g.zoom,g.width,g.height),x=function(A,k,O,F,V){const G=new o.LngLat(O.lng-180*Zo,O.lat),ie=new o.LngLat(O.lng+180*Zo,O.lat),le=A.project(G.lng,G.lat),_e=A.project(ie.lng,ie.lat),fe=-Math.atan2(_e.y-le.y,_e.x-le.x),ve=o.MercatorCoordinate.fromLngLat(O);ve.y=o.clamp(ve.y,-.999975,.999975);const me=ve.toLngLat(),de=A.project(me.lng,me.lat),be=o.MercatorCoordinate.fromLngLat(me);be.x+=Zo;const ge=be.toLngLat(),Be=A.project(ge.lng,ge.lat),ze=hi(Be.x-de.x,Be.y-de.y,fe),Me=o.MercatorCoordinate.fromLngLat(me);Me.y+=Zo;const Fe=Me.toLngLat(),Je=A.project(Fe.lng,Fe.lat),lt=hi(Je.x-de.x,Je.y-de.y,fe),ot=Math.abs(ze.x)/Math.abs(lt.y),zt=o.identity([]);o.rotateZ(zt,zt,-fe*(1-(V?0:F)));const He=o.identity([]);return o.scale(He,He,[1,1-(1-ot)*F,1]),He[4]=-lt.x/lt.y*F,o.rotateZ(He,He,fe),o.multiply(He,zt,He),He}(g.projection,0,g.center,p,c),T=nl(g);return o.scale(x,x,[T,T,1]),x}function nl(g){const c=g.projection,p=Ps(g.projection,g.zoom,g.width,g.height),x=Ds(c,g.center),T=Ds(c,o.LngLat.convert(c.center));return Math.pow(2,x*p+(1-p)*T)}function Ps(g,c,p,x,T=1/0){const A=g.range;if(!A)return 0;const k=Math.min(T,Math.max(p,x)),O=Math.log(k/1024)/Math.LN2;return o.smoothstep(A[0]+O,A[1]+O,c)}const Zo=1/4e4;function Ds(g,c){const p=o.clamp(c.lat,-o.MAX_MERCATOR_LATITUDE,o.MAX_MERCATOR_LATITUDE),x=new o.LngLat(c.lng-180*Zo,p),T=new o.LngLat(c.lng+180*Zo,p),A=g.project(x.lng,p),k=g.project(T.lng,p),O=o.MercatorCoordinate.fromLngLat(x),F=o.MercatorCoordinate.fromLngLat(T),V=k.x-A.x,G=k.y-A.y,ie=F.x-O.x,le=F.y-O.y,_e=Math.sqrt((ie*ie+le*le)/(V*V+G*G));return Math.log(_e)/Math.LN2}function hi(g,c,p){const x=Math.cos(p),T=Math.sin(p);return{x:g*x-c*T,y:g*T+c*x}}class Yn{constructor(c,p,x,T,A,k,O){this.tileSize=512,this._renderWorldCopies=A===void 0||A,this._minZoom=c||0,this._maxZoom=p||22,this._minPitch=x??0,this._maxPitch=T??60,this.setProjection(k),this.setMaxBounds(O),this.width=0,this.height=0,this._center=new o.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new jl,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new za,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1}clone(){const c=new Yn(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return c._elevation=this._elevation,c._centerAltitude=this._centerAltitude,c._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,c.tileSize=this.tileSize,c.mercatorFromTransition=this.mercatorFromTransition,c.width=this.width,c.height=this.height,c.cameraElevationReference=this.cameraElevationReference,c._center=this._center,c._setZoom(this.zoom),c._seaLevelZoom=this._seaLevelZoom,c.angle=this.angle,c._fov=this._fov,c._pitch=this._pitch,c._nearZ=this._nearZ,c._farZ=this._farZ,c._averageElevation=this._averageElevation,c._unmodified=this._unmodified,c._edgeInsets=this._edgeInsets.clone(),c._camera=this._camera.clone(),c._calcMatrices(),c.freezeTileCoverage=this.freezeTileCoverage,c.frustumCorners=this.frustumCorners,c}get elevation(){return this._elevation}set elevation(c){this._elevation!==c&&(this._elevation=c,this._updateCameraOnTerrain(),this._calcMatrices())}updateElevation(c){const p=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||p)&&this._updateCameraOnTerrain(),(c||p)&&this._constrainCameraAltitude(),this._calcMatrices()}getProjection(){return o.pick(this.projection,["name","center","parallels"])}setProjection(c){this.projectionOptions=c||{name:"mercator"};const p=this.projection?this.getProjection():void 0;this.projection=o.getProjection(this.projectionOptions);const x=!b(p,this.getProjection());return x&&this._calcMatrices(),this.mercatorFromTransition=!1,x}setMercatorFromTransition(){const c=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=o.getProjection({name:"mercator"});const p=c!==this.projection.name;return p&&this._calcMatrices(),p}get minZoom(){return this._minZoom}set minZoom(c){this._minZoom!==c&&(this._minZoom=c,this.zoom=Math.max(this.zoom,c))}get maxZoom(){return this._maxZoom}set maxZoom(c){this._maxZoom!==c&&(this._maxZoom=c,this.zoom=Math.min(this.zoom,c))}get minPitch(){return this._minPitch}set minPitch(c){this._minPitch!==c&&(this._minPitch=c,this.pitch=Math.max(this.pitch,c))}get maxPitch(){return this._maxPitch}set maxPitch(c){this._maxPitch!==c&&(this._maxPitch=c,this.pitch=Math.min(this.pitch,c))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(c){c===void 0?c=!0:c===null&&(c=!1),this._renderWorldCopies=c}get worldSize(){return this.tileSize*this.scale}get cameraWorldSize(){const c=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(c))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return o.mercatorZfromAltitude(this.center.lat,this.cameraWorldSize)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new o.pointGeometry(this.width,this.height)}get bearing(){return o.wrap(this.rotation,-180,180)}set bearing(c){this.rotation=c}get rotation(){return-this.angle/Math.PI*180}set rotation(c){const p=-c*Math.PI/180;var x;this.angle!==p&&(this._unmodified=!1,this.angle=p,this._calcMatrices(),this.rotationMatrix=(x=new o.ARRAY_TYPE(4),o.ARRAY_TYPE!=Float32Array&&(x[1]=0,x[2]=0),x[0]=1,x[3]=1,x),function(T,A,k){var O=A[0],F=A[1],V=A[2],G=A[3],ie=Math.sin(k),le=Math.cos(k);T[0]=O*le+V*ie,T[1]=F*le+G*ie,T[2]=O*-ie+V*le,T[3]=F*-ie+G*le}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(c){const p=o.clamp(c,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==p&&(this._unmodified=!1,this._pitch=p,this._calcMatrices())}get aspect(){return this.width/this.height}get fovX(){return this._fov}get fovY(){const c=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/c)}set fov(c){c=Math.max(.01,Math.min(60,c)),this._fov!==c&&(this._unmodified=!1,this._fov=o.degToRad(c),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(c){this._averageElevation=c,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(c){const p=Math.min(Math.max(c,this.minZoom),this.maxZoom);this._zoom!==p&&(this._unmodified=!1,this._setZoom(p),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(c){this._zoom=c,this.scale=this.zoomScale(c),this.tileZoom=Math.floor(c),this.zoomFraction=c-this.tileZoom}_updateCameraOnTerrain(){if(!this._elevation||!this._elevation.isDataAvailableAtPoint(this.locationCoordinate(this.center)))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;this._centerAltitude=c.getAtPointOrZero(this.locationCoordinate(this.center)),this._centerAltitudeValidForExaggeration=c.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const c=this._elevation,p=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],x=this.horizonLineFromTop();let T=0,A=0;for(let k=0;k<p.length;k++){const O=new o.pointGeometry(p[k][0]*this.width,x+p[k][1]*(this.height-x)),F=c.pointCoordinate(O);if(!F)continue;const V=1/Math.hypot(F[0]-this._camera.position[0],F[1]-this._camera.position[1]);T+=F[3]*V,A+=V}return A===0?NaN:T/A}get center(){return this._center}set center(c){c.lat===this._center.lat&&c.lng===this._center.lng||(this._unmodified=!1,this._center=c,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const c=this._seaLevelZoom,p=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),x=this.pixelsPerMeter/this.worldSize*p,T=this._mercatorZfromZoom(c),A=this._mercatorZfromZoom(this._maxZoom),k=Math.max(T-x,A);this._setZoom(this._zoomFromMercatorZ(k))}get padding(){return this._edgeInsets.toJSON()}set padding(c){this._edgeInsets.equals(c)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,c,1),this._calcMatrices())}computeZoomRelativeTo(c){const p=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,c.toAltitude()));let x;x=c.z<this._camera.position[2]?[p.x,p.y,p.z]:[c.x,c.y,c.z];const T=o.length(o.sub([],this._camera.position,x));return o.clamp(this._zoomFromMercatorZ(T),this._minZoom,this._maxZoom)}setFreeCameraOptions(c){if(!this.height||!c.position&&!c.orientation)return;this._updateCameraState();let p=!1;if(c.orientation&&!o.exactEquals(c.orientation,this._camera.orientation)&&(p=this._setCameraOrientation(c.orientation)),c.position){const x=[c.position.x,c.position.y,c.position.z];o.exactEquals$1(x,this._camera.position)||(this._setCameraPosition(x),p=!0)}p&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const c=this._camera.position,p=new ks;return p.position=new o.MercatorCoordinate(c[0],c[1],c[2]),p.orientation=this._camera.orientation,p._elevation=this.elevation,p._renderWorldCopies=this.renderWorldCopies,p}_setCameraOrientation(c){if(!o.length$1(c))return!1;o.normalize$1(c,c);const p=o.transformQuat([],[0,0,-1],c),x=o.transformQuat([],[0,-1,0],c);if(x[2]<0)return!1;const T=Cs(p,x);return!!T&&(this._camera.orientation=T,!0)}_setCameraPosition(c){const p=this.zoomScale(this.minZoom)*this.tileSize,x=this.zoomScale(this.maxZoom)*this.tileSize,T=this.cameraToCenterDistance;c[2]=o.clamp(c[2],T/x,T/p),this._camera.position=c}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(c){return this._edgeInsets.equals(c)}interpolatePadding(c,p,x){this._unmodified=!1,this._edgeInsets.interpolate(c,p,x),this._constrain(),this._calcMatrices()}coveringZoomLevel(c){const p=(c.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/c.tileSize));return Math.max(0,p)}getVisibleUnwrappedCoordinates(c){const p=[new o.UnwrappedTileID(0,c)];if(this.renderWorldCopies){const x=this.pointCoordinate(new o.pointGeometry(0,0)),T=this.pointCoordinate(new o.pointGeometry(this.width,0)),A=this.pointCoordinate(new o.pointGeometry(this.width,this.height)),k=this.pointCoordinate(new o.pointGeometry(0,this.height)),O=Math.floor(Math.min(x.x,T.x,A.x,k.x)),F=Math.floor(Math.max(x.x,T.x,A.x,k.x)),V=1;for(let G=O-V;G<=F+V;G++)G!==0&&p.push(new o.UnwrappedTileID(G,c))}return p}coveringTiles(c){let p=this.coveringZoomLevel(c);const x=p,T=this.elevation&&!c.isTerrainDEM,A=this.projection.name==="mercator";if(c.minzoom!==void 0&&p<c.minzoom)return[];c.maxzoom!==void 0&&p>c.maxzoom&&(p=c.maxzoom);const k=this.locationCoordinate(this.center),O=this.center.lat,F=1<<p,V=[F*k.x,F*k.y,0],G=this.projection.name==="globe",ie=!G,le=o.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,p,ie),_e=G?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),fe=F*o.mercatorZfromAltitude(1,this.center.lat),ve=this._camera.position[2]/o.mercatorZfromAltitude(1,this.center.lat),me=[F*_e.x,F*_e.y,ve*(ie?1:fe)],de=this.cameraToCenterDistance/c.tileSize*(c.roundZoom?1:.502),be=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?p:0,ge=c.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,Be=c.isTerrainDEM?-ge:this._elevation?this._elevation.getMinElevationBelowMSL():0,ze=this.projection.isReprojectedInTileSpace?nl(this):1,Me=Ve=>{const qt=new o.MercatorCoordinate(Ve.x+25e-6,Ve.y,Ve.z),Jt=new o.MercatorCoordinate(Ve.x,Ve.y+25e-6,Ve.z),Ht=Ve.toLngLat(),Ai=qt.toLngLat(),Vi=Jt.toLngLat(),Ni=this.locationCoordinate(Ht),Bi=this.locationCoordinate(Ai),Wt=this.locationCoordinate(Vi),Zi=Math.hypot(Bi.x-Ni.x,Bi.y-Ni.y),er=Math.hypot(Wt.x-Ni.x,Wt.y-Ni.y);return Math.sqrt(Zi*er)*ze/25e-6},Fe=Ve=>{const ri=ge,qt=Be;return{aabb:o.tileAABB(this,F,0,0,0,Ve,qt,ri,this.projection),zoom:0,x:0,y:0,minZ:qt,maxZ:ri,wrap:Ve,fullyVisible:!1}},Je=[];let lt=[];const ot=p,zt=c.reparseOverscaled?x:p,He=Ve=>Ve*Ve,wt=He((ve-this._centerAltitude)*fe),bt=Ve=>{if(!this._elevation||!Ve.tileID||!A)return;const ri=this._elevation.getMinMaxForTile(Ve.tileID),qt=Ve.aabb;ri?(qt.min[2]=ri.min,qt.max[2]=ri.max,qt.center[2]=(qt.min[2]+qt.max[2])/2):(Ve.shouldSplit=tt(Ve),Ve.shouldSplit||(qt.min[2]=qt.max[2]=qt.center[2]=this._centerAltitude))},tt=Ve=>{if(Ve.zoom<be)return!0;if(Ve.zoom===ot)return!1;if(Ve.shouldSplit!=null)return Ve.shouldSplit;const ri=Ve.aabb.distanceX(me),qt=Ve.aabb.distanceY(me);let Jt=wt,Ht=1;if(G){Jt=He(Ve.aabb.distanceZ(me));const Ni=Math.pow(2,Ve.zoom),Bi=o.latFromMercatorY((Ve.y+1)/Ni),Wt=o.latFromMercatorY(Ve.y/Ni),Zi=Math.min(Math.max(O,Bi),Wt),er=o.circumferenceAtLatitude(Zi)/o.circumferenceAtLatitude(O);if(Ht=Zi===O?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,er/this._mercatorScaleRatio),this.zoom<=o.GLOBE_ZOOM_THRESHOLD_MIN&&Ve.zoom===ot-1&&er>=.9)return!0}else if(T&&(Jt=He(Ve.aabb.distanceZ(me)*fe)),this.projection.isReprojectedInTileSpace&&x<=5){const Ni=Math.pow(2,Ve.zoom),Bi=Me(new o.MercatorCoordinate((Ve.x+.5)/Ni,(Ve.y+.5)/Ni));Ht=Bi>.85?1:Bi}const Ai=ri*ri+qt*qt+Jt,Vi=He((1<<ot-Ve.zoom)*de*Ht*((Ni,Bi)=>{if(Bi*He(.707)<Ni)return 1;const Wt=Math.sqrt(Bi/Ni);return Wt/(1.4144271570014144+(Math.pow(1.1,Wt-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(Jt,wt),Ai));return Ai<Vi};if(this.renderWorldCopies)for(let Ve=1;Ve<=3;Ve++)Je.push(Fe(-Ve)),Je.push(Fe(Ve));for(Je.push(Fe(0));Je.length>0;){const Ve=Je.pop(),ri=Ve.x,qt=Ve.y;let Jt=Ve.fullyVisible;if(!Jt){const Ht=Ve.aabb.intersects(le);if(Ht===0)continue;Jt=Ht===2}if(Ve.zoom!==ot&&tt(Ve))for(let Ht=0;Ht<4;Ht++){const Ai=(ri<<1)+Ht%2,Vi=(qt<<1)+(Ht>>1),Ni={aabb:A?Ve.aabb.quadrant(Ht):o.tileAABB(this,F,Ve.zoom+1,Ai,Vi,Ve.wrap,Ve.minZ,Ve.maxZ,this.projection),zoom:Ve.zoom+1,x:Ai,y:Vi,wrap:Ve.wrap,fullyVisible:Jt,tileID:void 0,shouldSplit:void 0,minZ:Ve.minZ,maxZ:Ve.maxZ};T&&!G&&(Ni.tileID=new o.OverscaledTileID(Ve.zoom+1===ot?zt:Ve.zoom+1,Ve.wrap,Ve.zoom+1,Ai,Vi),bt(Ni)),Je.push(Ni)}else{const Ht=Ve.zoom===ot?zt:Ve.zoom;if(c.minzoom&&c.minzoom>Ht)continue;const Ai=V[0]-(.5+ri+(Ve.wrap<<Ve.zoom))*(1<<p-Ve.zoom),Vi=V[1]-.5-qt,Ni=Ve.tileID?Ve.tileID:new o.OverscaledTileID(Ht,Ve.wrap,Ve.zoom,ri,qt);lt.push({tileID:Ni,distanceSq:Ai*Ai+Vi*Vi})}}if(this.fogCullDistSq){const Ve=this.fogCullDistSq,ri=this.horizonLineFromTop();lt=lt.filter(qt=>{const Jt=[0,0,0,1],Ht=[o.EXTENT,o.EXTENT,0,1],Ai=this.calculateFogTileMatrix(qt.tileID.toUnwrapped());o.transformMat4$1(Jt,Jt,Ai),o.transformMat4$1(Ht,Ht,Ai);const Vi=o.getAABBPointSquareDist(Jt,Ht);if(Vi===0)return!0;let Ni=!1;const Bi=this._elevation;if(Bi&&Vi>Ve&&ri!==0){const Wt=this.calculateProjMatrix(qt.tileID.toUnwrapped());let Zi;c.isTerrainDEM||(Zi=Bi.getMinMaxForTile(qt.tileID)),Zi||(Zi={min:Be,max:ge});const er=o.furthestTileCorner(this.rotation),Tr=[er[0]*o.EXTENT,er[1]*o.EXTENT,Zi.max];o.transformMat4(Tr,Tr,Wt),Ni=(1-Tr[1])*this.height*.5<ri}return Vi<Ve||Ni})}return lt.sort((Ve,ri)=>Ve.distanceSq-ri.distanceSq).map(Ve=>Ve.tileID)}resize(c,p){this.width=c,this.height=p,this.pixelsToGLUnits=[2/c,-2/p],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(c){return Math.pow(2,c)}scaleZoom(c){return Math.log(c)/Math.LN2}project(c){const p=o.clamp(c.lat,-o.MAX_MERCATOR_LATITUDE,o.MAX_MERCATOR_LATITUDE),x=this.projection.project(c.lng,p);return new o.pointGeometry(x.x*this.worldSize,x.y*this.worldSize)}unproject(c){return this.projection.unproject(c.x/this.worldSize,c.y/this.worldSize)}get point(){return this.project(this.center)}setLocationAtPoint(c,p){let x,T;const A=this.centerPoint;if(this.projection.name==="globe"){const O=this.worldSize;x=(p.x-A.x)/O,T=(p.y-A.y)/O}else{const O=this.pointCoordinate(p),F=this.pointCoordinate(A);x=O.x-F.x,T=O.y-F.y}const k=this.locationCoordinate(c);this.setLocation(new o.MercatorCoordinate(k.x-x,k.y-T))}setLocation(c){this.center=this.coordinateLocation(c),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(c){return this.projection.locationPoint(this,c)}locationPoint3D(c){return this.projection.locationPoint(this,c,!0)}pointLocation(c){return this.coordinateLocation(this.pointCoordinate(c))}pointLocation3D(c){return this.coordinateLocation(this.pointCoordinate3D(c))}locationCoordinate(c,p){const x=p?o.mercatorZfromAltitude(p,c.lat):void 0,T=this.projection.project(c.lng,c.lat);return new o.MercatorCoordinate(T.x,T.y,x)}coordinateLocation(c){return this.projection.unproject(c.x,c.y)}pointRayIntersection(c,p){const x=p??this._centerAltitude,T=[c.x,c.y,0,1],A=[c.x,c.y,1,1];o.transformMat4$1(T,T,this.pixelMatrixInverse),o.transformMat4$1(A,A,this.pixelMatrixInverse);const k=A[3];o.scale$1(T,T,1/T[3]),o.scale$1(A,A,1/k);const O=T[2],F=A[2];return{p0:T,p1:A,t:O===F?0:(x-O)/(F-O)}}screenPointToMercatorRay(c){const p=[c.x,c.y,0,1],x=[c.x,c.y,1,1];return o.transformMat4$1(p,p,this.pixelMatrixInverse),o.transformMat4$1(x,x,this.pixelMatrixInverse),o.scale$1(p,p,1/p[3]),o.scale$1(x,x,1/x[3]),p[2]=o.mercatorZfromAltitude(p[2],this._center.lat)*this.worldSize,x[2]=o.mercatorZfromAltitude(x[2],this._center.lat)*this.worldSize,o.scale$1(p,p,1/this.worldSize),o.scale$1(x,x,1/this.worldSize),new o.Ray([p[0],p[1],p[2]],o.normalize([],o.sub([],x,p)))}rayIntersectionCoordinate(c){const{p0:p,p1:x,t:T}=c,A=o.mercatorZfromAltitude(p[2],this._center.lat),k=o.mercatorZfromAltitude(x[2],this._center.lat);return new o.MercatorCoordinate(o.number(p[0],x[0],T)/this.worldSize,o.number(p[1],x[1],T)/this.worldSize,o.number(A,k,T))}pointCoordinate(c,p=this._centerAltitude){return this.projection.pointCoordinate(this,c.x,c.y,p)}pointCoordinate3D(c){if(!this.elevation)return this.pointCoordinate(c);let p=this.projection.pointCoordinate3D(this,c.x,c.y);if(p)return new o.MercatorCoordinate(p[0],p[1],p[2]);let x=0,T=this.horizonLineFromTop();if(c.y>T)return this.pointCoordinate(c);const A=.02*T,k=c.clone();for(let O=0;O<10&&T-x>A;O++){k.y=o.number(x,T,.66);const F=this.projection.pointCoordinate3D(this,k.x,k.y);F?(T=k.y,p=F):x=k.y}return p?new o.MercatorCoordinate(p[0],p[1],p[2]):this.pointCoordinate(c)}isPointAboveHorizon(c){return this.projection.isPointAboveHorizon(this,c)}_coordinatePoint(c,p){const x=p&&this.elevation?this.elevation.getAtPointOrZero(c,this._centerAltitude):this._centerAltitude,T=[c.x*this.worldSize,c.y*this.worldSize,x+c.toAltitude(),1];return o.transformMat4$1(T,T,this.pixelMatrix),T[3]>0?new o.pointGeometry(T[0]/T[3],T[1]/T[3]):new o.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getGlobeBounds(){const{top:c,left:p}=this._edgeInsets,x=this.height-this._edgeInsets.bottom,T=this.width-this._edgeInsets.right,A=this.pointCoordinate3D(new o.pointGeometry(p,c)),k=this.pointCoordinate3D(new o.pointGeometry(T,c)),O=this.pointCoordinate3D(new o.pointGeometry(T,x)),F=this.pointCoordinate3D(new o.pointGeometry(p,x));let V=Math.min(A.x,F.x),G=Math.max(k.x,O.x),ie=Math.min(A.y,k.y),le=Math.max(F.y,O.y);const _e=Math.pow(2,-this.zoom)/16,fe=(de,be,ge,Be)=>{const ze=(de+ge)/2,Me=(be+Be)/2,Fe=new o.pointGeometry(ze,Me),Je=this.pointCoordinate3D(Fe),lt=Math.max(0,V-Je.x,ie-Je.y,Je.x-G,Je.y-le);V=Math.min(V,Je.x),G=Math.max(G,Je.x),ie=Math.min(ie,Je.y),le=Math.max(le,Je.y),lt>_e&&(fe(de,be,ze,Me),fe(ze,Me,ge,Be))};fe(p,c,T,c),fe(T,c,T,x),fe(T,x,p,x),fe(p,x,p,c);const ve=new o.LngLat(o.lngFromMercatorX(G),o.latFromMercatorY(ie)),me=new o.LngLat(o.lngFromMercatorX(V),o.latFromMercatorY(le));return new o.LngLatBounds(me,ve)}_getBounds(c,p){if(this.projection.name==="globe")return this._getGlobeBounds();const x=new o.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),T=new o.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),A=new o.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),k=new o.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let O=this.pointCoordinate(x,c),F=this.pointCoordinate(T,c);const V=this.pointCoordinate(A,p),G=this.pointCoordinate(k,p),ie=(le,_e)=>(_e.y-le.y)/(_e.x-le.x);return O.y>1&&F.y>=0?O=new o.MercatorCoordinate((1-G.y)/ie(G,O)+G.x,1):O.y<0&&F.y<=1&&(O=new o.MercatorCoordinate(-G.y/ie(G,O)+G.x,0)),F.y>1&&O.y>=0?F=new o.MercatorCoordinate((1-V.y)/ie(V,F)+V.x,1):F.y<0&&O.y<=1&&(F=new o.MercatorCoordinate(-V.y/ie(V,F)+V.x,0)),new o.LngLatBounds().extend(this.coordinateLocation(O)).extend(this.coordinateLocation(F)).extend(this.coordinateLocation(G)).extend(this.coordinateLocation(V))}_getBounds3D(){const c=this.elevation;if(!c.visibleDemTiles.length||c.isUsingMockSource())return this._getBounds(0,0);const p=c.visibleDemTiles.reduce((x,T)=>{if(T.dem){const A=T.dem.tree;x.min=Math.min(x.min,A.minimums[0]),x.max=Math.max(x.max,A.maximums[0])}return x},{min:Number.MAX_VALUE,max:0});return this._getBounds(p.min*c.exaggeration(),p.max*c.exaggeration())}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0)}horizonLineFromTop(c=!0){const p=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,x=this.height/2-p*(1-this._horizonShift);return c?Math.max(0,x):x}getMaxBounds(){return this.maxBounds}setMaxBounds(c){this.maxBounds=c,this.minLat=-o.MAX_MERCATOR_LATITUDE,this.maxLat=o.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,c&&(this.minLat=c.getSouth(),this.maxLat=c.getNorth(),this.minLng=c.getWest(),this.maxLng=c.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=o.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=o.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=o.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=o.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(c,p){return this.projection.createTileMatrix(this,p,c)}calculateDistanceTileData(c){const p=c.key,x=this._distanceTileDataCache;if(x[p])return x[p];const T=c.canonical,A=1/this.height,k=this.cameraWorldSize/this.zoomScale(T.z),O=(T.x+Math.pow(2,T.z)*c.wrap)*k,F=T.y*k,V=this.point,G=this.angle,ie=Math.sin(-G),le=-Math.cos(-G);return x[p]={bearing:[ie,le],center:[(V.x-O)*A,(V.y-F)*A],scale:k/o.EXTENT*A},x[p]}calculateFogTileMatrix(c){const p=c.key,x=this._fogTileMatrixCache;if(x[p])return x[p];const T=this.projection.createTileMatrix(this,this.cameraWorldSize,c);return o.multiply(T,this.worldToFogMatrix,T),x[p]=new Float32Array(T),x[p]}calculateProjMatrix(c,p=!1){const x=c.key,T=p?this._alignedProjMatrixCache:this._projMatrixCache;if(T[x])return T[x];const A=this.calculatePosMatrix(c,this.worldSize);return o.multiply(A,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:p?this.alignedProjMatrix:this.projMatrix,A),T[x]=new Float32Array(A),T[x]}calculatePixelsToTileUnitsMatrix(c){const p=c.tileID.key,x=this._pixelsToTileUnitsCache;if(x[p])return x[p];const T=function(A,k){const{scale:O}=A.tileTransform,F=O*o.EXTENT/(A.tileSize*Math.pow(2,k.zoom-A.tileID.overscaledZ+A.tileID.canonical.z));return V=new Float32Array(4),le=(G=k.inverseAdjustmentMatrix)[1],_e=G[2],fe=G[3],me=(ie=[F,F])[1],V[0]=G[0]*(ve=ie[0]),V[1]=le*ve,V[2]=_e*me,V[3]=fe*me,V;var V,G,ie,le,_e,fe,ve,me}(c,this);return x[p]=T,x[p]}customLayerMatrix(){return this.mercatorMatrix.slice()}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const c=this._elevation;this._updateCameraState();const p=o.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,x=this._computeCameraPosition(p),T=this._camera.forward(),A=o.mercatorZfromAltitude(1,this._center.lat);x[2]/=A,T[2]/=A,o.normalize(T,T);const k=c.raycast(x,T,c.exaggeration());if(k){const O=o.scaleAndAdd([],x,T,k),F=new o.MercatorCoordinate(O[0],O[1],o.mercatorZfromAltitude(O[2],o.latFromMercatorY(O[1]))),V=(F.z+o.length([F.x-x[0],F.y-x[1],F.z-x[2]*A]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(V),this._centerAltitude=F.toAltitude(),this._center=this.coordinateLocation(F),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCameraAltitude(){if(!this._elevation)return;const c=this._elevation;this._updateCameraState();const p=o.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,x=this._computeCameraPosition(p),T=c.getAtPointOrZero(new o.MercatorCoordinate(...x)),A=this._minimumHeightOverTerrain()*Math.cos(o.degToRad(this._maxPitch)),k=this._camera.position[2]-this.pixelsPerMeter/this.worldSize*T;if(k<A){const O=this.locationCoordinate(this._center,this._centerAltitude),F=[O.x-x[0],O.y-x[1],O.z-x[2]],V=o.length(F);F[2]-=(A-k)/this._pixelsPerMercatorPixel;const G=o.length(F);if(G===0)return;o.scale$2(F,F,V/G*this._pixelsPerMercatorPixel),this._camera.position=[O.x-F[0],O.y-F[1],O.z*this._pixelsPerMercatorPixel-F[2]],this._camera.orientation=Cs(F,this._camera.up()),this._updateStateFromCamera()}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const c=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||c){const le=this.center;return le.lat=o.clamp(le.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!c)&&(le.lng=o.clamp(le.lng,this.minLng,this.maxLng)),this.center=le,void(this._constraining=!1)}const p=this._unmodified,{x,y:T}=this.point;let A=0,k=x,O=T;const F=this.width/2,V=this.height/2,G=this.worldMinY*this.scale,ie=this.worldMaxY*this.scale;if(T-V<G&&(O=G+V),T+V>ie&&(O=ie-V),ie-G<this.height&&(A=Math.max(A,this.height/(ie-G)),O=(ie+G)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const le=this.worldMinX*this.scale,_e=this.worldMaxX*this.scale,fe=this.worldSize/2-(le+_e)/2;k=(x+fe+this.worldSize)%this.worldSize-fe,k-F<le&&(k=le+F),k+F>_e&&(k=_e-F),_e-le<this.width&&(A=Math.max(A,this.width/(_e-le)),k=(_e+le)/2)}k===x&&O===T||(this.center=this.unproject(new o.pointGeometry(k,O))),A&&(this.zoom+=this.scaleZoom(A)),this._constrainCameraAltitude(),this._unmodified=p,this._constraining=!1}_minZoomForBounds(){let c=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(c=Math.max(c,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),c}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const c=this.centerOffset,p=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=o.mercatorZfromAltitude(1,this.center.lat)/o.mercatorZfromAltitude(1,o.GLOBE_SCALE_MATCH_LATITUDE));const x=Ps(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,x),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const T=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?p:1),A=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);A[8]=2*-c.x/this.width,A[9]=2*c.y/this.height;let k=o.mul([],A,T);if(this.projection.isReprojectedInTileSpace){const ze=this.locationCoordinate(this.center),Me=o.identity([]);o.translate(Me,Me,[ze.x*this.worldSize,ze.y*this.worldSize,0]),o.multiply(Me,Me,rl(this)),o.translate(Me,Me,[-ze.x*this.worldSize,-ze.y*this.worldSize,0]),o.multiply(k,k,Me),this.inverseAdjustmentMatrix=function(Fe){const Je=rl(Fe,!0);return ce([],[Je[0],Je[1],Je[4],Je[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=o.scale([],k,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=k,this.invProjMatrix=o.invert(new Float64Array(16),this.projMatrix);const O=o.invert([],A);this.frustumCorners=o.FrustumCorners.fromInvProjectionMatrix(O,this.horizonLineFromTop(),this.height);const F=new Float32Array(16);o.identity(F),o.scale(F,F,[1,-1,1]),o.rotateX(F,F,this._pitch),o.rotateZ(F,F,this.angle);const V=o.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),G=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;V[8]=2*-c.x/this.width,V[9]=2*(c.y+G)/this.height,this.skyboxMatrix=o.multiply(F,V,F);const ie=this.point,le=ie.x,_e=ie.y,fe=this.width%2/2,ve=this.height%2/2,me=Math.cos(this.angle),de=Math.sin(this.angle),be=le-Math.round(le)+me*fe+de*ve,ge=_e-Math.round(_e)+me*ve+de*fe,Be=new Float64Array(k);if(o.translate(Be,Be,[be>.5?be-1:be,ge>.5?ge-1:ge,0]),this.alignedProjMatrix=Be,k=o.create(),o.scale(k,k,[this.width/2,-this.height/2,1]),o.translate(k,k,[1,-1,0]),this.labelPlaneMatrix=k,k=o.create(),o.scale(k,k,[1,-1,1]),o.translate(k,k,[-1,-1,0]),o.scale(k,k,[2/this.width,2/this.height,1]),this.glCoordMatrix=k,this.pixelMatrix=o.multiply(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},k=o.invert(new Float64Array(16),this.pixelMatrix),!k)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=k,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=o.calculateGlobeMatrix(this);const ze=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=o.transformMat4(ze,ze,T),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=k;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const c=this.cameraWorldSize,p=this.cameraPixelsPerMeter,x=this._camera.position,T=1/this.height/this._pixelsPerMercatorPixel,A=[c,c,p];o.scale$2(A,A,T),o.scale$2(x,x,-1),o.multiply$2(x,x,A);const k=o.create();o.translate(k,k,x),o.scale(k,k,A),this.mercatorFogMatrix=k,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(c,p,T)}_computeCameraPosition(c){const p=(c=c||this.pixelsPerMeter)/this.pixelsPerMeter,x=this._camera.forward(),T=this.point,A=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*p-c/this.worldSize*this._centerAltitude;return[T.x/this.worldSize-x[0]*A,T.y/this.worldSize-x[1]*A,c/this.worldSize*this._centerAltitude-x[2]*A]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(c){const p=this._maxCameraBoundsDistance()*Math.cos(this._pitch),x=this._camera.position[2],T=c[2];let A=1;this.projection.wrap&&(this.center=this.center.wrap()),T>0&&(A=Math.min((p-x)/T,1)),this._camera.position=o.scaleAndAdd([],this._camera.position,c,A),this._updateStateFromCamera()}_updateStateFromCamera(){const c=this._camera.position,p=this._camera.forward(),{pitch:x,bearing:T}=this._camera.getPitchBearing(),A=o.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,k=this._mercatorZfromZoom(this._maxZoom)*Math.cos(o.degToRad(this._maxPitch)),O=Math.max((c[2]-A)/Math.cos(x),k),F=this._zoomFromMercatorZ(O);o.scaleAndAdd(c,c,p,O),this._pitch=o.clamp(x,o.degToRad(this.minPitch),o.degToRad(this.maxPitch)),this.angle=o.wrap(T,-Math.PI,Math.PI),this._setZoom(o.clamp(F,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new o.MercatorCoordinate(c[0],c[1],c[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(c){return Math.pow(2,c)*this.tileSize}_mercatorZfromZoom(c){return this.cameraToCenterDistance/this._worldSizeFromZoom(c)}_minimumHeightOverTerrain(){const c=Math.min((this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(c)}_zoomFromMercatorZ(c){return this.scaleZoom(this.cameraToCenterDistance/(c*this.tileSize))}zoomFromMercatorZAdjusted(c){const p=k=>{const O=this.getCameraToCenterDistance(this.projection,k);return this.scaleZoom(O/(c*this.tileSize))};let x,T=p(this.zoom),A=Math.abs(T-p(T));for(;x!==A;)T=p(T),x=A,A=Math.abs(T-p(T));return T}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(o.warnOnce("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(c,p){const x=Math.min(c.x,p.x),T=Math.max(c.x,p.x),A=Math.min(c.y,p.y),k=Math.max(c.y,p.y);if(A<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const O=[new o.pointGeometry(x,A),new o.pointGeometry(T,k),new o.pointGeometry(x,k),new o.pointGeometry(T,A)],F=this.renderWorldCopies?-3:0,V=this.renderWorldCopies?4:1;for(const G of O){const ie=this.pointRayIntersection(G);if(ie.t<0)return!0;const le=this.rayIntersectionCoordinate(ie);if(le.x<F||le.y<0||le.x>V||le.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+o.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new o.pointGeometry(0,0),new o.pointGeometry(this.width,this.height))}zoomDeltaToMovement(c,p){const x=o.length(o.sub([],this._camera.position,c)),T=this._zoomFromMercatorZ(x)+p;return x-this._mercatorZfromZoom(T)}getCameraPoint(){if(this.projection.name==="globe"){const c=function(p,x){const T=[p[0],p[1],p[2],1];o.transformMat4$1(T,T,x);const A=Math.max(T[3],1e-6);return[T[0]/A,T[1]/A,T[2]/A,A]}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new o.pointGeometry(c[0],c[1])}{const c=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new o.pointGeometry(0,c))}}getCameraToCenterDistance(c,p=this.zoom){const x=Ps(c,p,this.width,this.height,1024),T=c.pixelSpaceConversion(this.center.lat,this.worldSize,x);return .5/Math.tan(.5*this._fov)*this.height*T}getWorldToCameraMatrix(){const c=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&o.multiply(c,c,this.globeMatrix),c}}function Zl(g,c){let p=!1,x=null;const T=()=>{x=null,p&&(g(),x=setTimeout(T,c),p=!1)};return()=>(p=!0,x||T(),x)}class Vc{constructor(c){this._hashName=c&&encodeURIComponent(c),o.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Zl(this._updateHashUnthrottled.bind(this),300)}addTo(c){return this._map=c,o.window.addEventListener("hashchange",this._onHashChange,!1),c.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),o.window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const c=this._map;if(!c)return"";const p=Xl(c);if(this._hashName){const x=this._hashName;let T=!1;const A=o.window.location.hash.slice(1).split("&").map(k=>{const O=k.split("=")[0];return O===x?(T=!0,`${O}=${p}`):k}).filter(k=>k);return T||A.push(`${x}=${p}`),`#${A.join("&")}`}return`#${p}`}_getCurrentHash(){const c=o.window.location.hash.replace("#","");if(this._hashName){let p;return c.split("&").map(x=>x.split("=")).forEach(x=>{x[0]===this._hashName&&(p=x)}),(p&&p[1]||"").split("/")}return c.split("/")}_onHashChange(){const c=this._map;if(!c)return!1;const p=this._getCurrentHash();if(p.length>=3&&!p.some(x=>isNaN(x))){const x=c.dragRotate.isEnabled()&&c.touchZoomRotate.isEnabled()?+(p[3]||0):c.getBearing();return c.jumpTo({center:[+p[2],+p[1]],zoom:+p[0],bearing:x,pitch:+(p[4]||0)}),!0}return!1}_updateHashUnthrottled(){const c=o.window.location.href.replace(/(#.+)?$/,this.getHashString());o.window.history.replaceState(o.window.history.state,null,c)}}function Xl(g,c){const p=g.getCenter(),x=Math.round(100*g.getZoom())/100,T=Math.ceil((x*Math.LN2+Math.log(512/360/.5))/Math.LN10),A=Math.pow(10,T),k=Math.round(p.lng*A)/A,O=Math.round(p.lat*A)/A,F=g.getBearing(),V=g.getPitch();let G=c?`/${k}/${O}/${x}`:`${x}/${O}/${k}`;return(F||V)&&(G+="/"+Math.round(10*F)/10),V&&(G+=`/${Math.round(V)}`),G}const Xo={linearity:.3,easing:o.bezier(0,0,.3,1)},jc=o.extend({deceleration:2500,maxSpeed:1400},Xo),ol=o.extend({deceleration:20,maxSpeed:1400},Xo),Hl=o.extend({deceleration:1e3,maxSpeed:360},Xo),al=o.extend({deceleration:1e3,maxSpeed:90},Xo);class Gc{constructor(c){this._map=c,this.clear()}clear(){this._inertiaBuffer=[]}record(c){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:o.exported.now(),settings:c})}_drainInertiaBuffer(){const c=this._inertiaBuffer,p=o.exported.now();for(;c.length>0&&p-c[0].time>160;)c.shift()}_onMoveEnd(c){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const p={zoom:0,bearing:0,pitch:0,pan:new o.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:A}of this._inertiaBuffer)p.zoom+=A.zoomDelta||0,p.bearing+=A.bearingDelta||0,p.pitch+=A.pitchDelta||0,A.panDelta&&p.pan._add(A.panDelta),A.around&&(p.around=A.around),A.pinchAround&&(p.pinchAround=A.pinchAround);const x=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,T={};if(p.pan.mag()){const A=Ho(p.pan.mag(),x,o.extend({},jc,c||{}));T.offset=p.pan.mult(A.amount/p.pan.mag()),T.center=this._map.transform.center,Bs(T,A)}if(p.zoom){const A=Ho(p.zoom,x,ol);T.zoom=this._map.transform.zoom+A.amount,Bs(T,A)}if(p.bearing){const A=Ho(p.bearing,x,Hl);T.bearing=this._map.transform.bearing+o.clamp(A.amount,-179,179),Bs(T,A)}if(p.pitch){const A=Ho(p.pitch,x,al);T.pitch=this._map.transform.pitch+A.amount,Bs(T,A)}if(T.zoom||T.bearing){const A=p.pinchAround===void 0?p.around:p.pinchAround;T.around=A?this._map.unproject(A):this._map.getCenter()}return this.clear(),T.noMoveStart=!0,T}}function Bs(g,c){(!g.duration||g.duration<c.duration)&&(g.duration=c.duration,g.easing=c.easing)}function Ho(g,c,p){const{maxSpeed:x,linearity:T,deceleration:A}=p,k=o.clamp(g*T/(c/1e3),-x,x),O=Math.abs(k)/(A*T);return{easing:p.easing,duration:1e3*O,amount:k*(O/2)}}class Kn extends o.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(c,p,x,T={}){const A=J(p.getCanvasContainer(),x),k=p.unproject(A);super(c,o.extend({point:A,lngLat:k,originalEvent:x},T)),this._defaultPrevented=!1,this.target=p}}class sl extends o.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(c,p,x){const T=c==="touchend"?x.changedTouches:x.touches,A=Ee(p.getCanvasContainer(),T),k=A.map(F=>p.unproject(F)),O=A.reduce((F,V,G,ie)=>F.add(V.div(ie.length)),new o.pointGeometry(0,0));super(c,{points:A,point:O,lngLats:k,lngLat:p.unproject(O),originalEvent:x}),this._defaultPrevented=!1}}class qc extends o.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(c,p,x){super(c,{originalEvent:x}),this._defaultPrevented=!1}}class ll{constructor(c,p){this._map=c,this._clickTolerance=p.clickTolerance}reset(){this._mousedownPos=void 0}wheel(c){return this._firePreventable(new qc(c.type,this._map,c))}mousedown(c,p){return this._mousedownPos=p,this._firePreventable(new Kn(c.type,this._map,c))}mouseup(c){this._map.fire(new Kn(c.type,this._map,c))}preclick(c){const p=o.extend({},c);p.type="preclick",this._map.fire(new Kn(p.type,this._map,p))}click(c,p){this._mousedownPos&&this._mousedownPos.dist(p)>=this._clickTolerance||(this.preclick(c),this._map.fire(new Kn(c.type,this._map,c)))}dblclick(c){return this._firePreventable(new Kn(c.type,this._map,c))}mouseover(c){this._map.fire(new Kn(c.type,this._map,c))}mouseout(c){this._map.fire(new Kn(c.type,this._map,c))}touchstart(c){return this._firePreventable(new sl(c.type,this._map,c))}touchmove(c){this._map.fire(new sl(c.type,this._map,c))}touchend(c){this._map.fire(new sl(c.type,this._map,c))}touchcancel(c){this._map.fire(new sl(c.type,this._map,c))}_firePreventable(c){if(this._map.fire(c),c.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Wl{constructor(c){this._map=c}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(c){this._map.fire(new Kn(c.type,this._map,c))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Kn("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(c){this._delayContextMenu?this._contextMenuEvent=c:this._map.fire(new Kn(c.type,this._map,c)),this._map.listens("contextmenu")&&c.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Zc{constructor(c,p){this._map=c,this._el=c.getCanvasContainer(),this._container=c.getContainer(),this._clickTolerance=p.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(c,p){this.isEnabled()&&c.shiftKey&&c.button===0&&(q(),this._startPos=this._lastPos=p,this._active=!0)}mousemoveWindow(c,p){if(!this._active)return;const x=p,T=this._startPos,A=this._lastPos;if(!T||!A||A.equals(x)||!this._box&&x.dist(T)<this._clickTolerance)return;this._lastPos=x,this._box||(this._box=L("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",c));const k=Math.min(T.x,x.x),O=Math.max(T.x,x.x),F=Math.min(T.y,x.y),V=Math.max(T.y,x.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${k}px,${F}px)`,this._box.style.width=O-k+"px",this._box.style.height=V-F+"px")})}mouseupWindow(c,p){if(!this._active)return;const x=this._startPos,T=p;if(x&&c.button===0){if(this.reset(),Y(),x.x!==T.x||x.y!==T.y)return this._map.fire(new o.Event("boxzoomend",{originalEvent:c})),{cameraAnimation:A=>A.fitScreenCoordinates(x,T,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",c)}}keydown(c){this._active&&c.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",c))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),oe(),delete this._startPos,delete this._lastPos}_fireEvent(c,p){return this._map.fire(new o.Event(c,{originalEvent:p}))}}function cl(g,c){const p={};for(let x=0;x<g.length;x++)p[g[x].identifier]=c[x];return p}class ul{constructor(c){this.reset(),this.numTouches=c.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(c,p,x){(this.centroid||x.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=c.timeStamp),x.length===this.numTouches&&(this.centroid=function(T){const A=new o.pointGeometry(0,0);for(const k of T)A._add(k);return A.div(T.length)}(p),this.touches=cl(x,p)))}touchmove(c,p,x){if(this.aborted||!this.centroid)return;const T=cl(x,p);for(const A in this.touches){const k=this.touches[A],O=T[A];(!O||O.dist(k)>30)&&(this.aborted=!0)}}touchend(c,p,x){if((!this.centroid||c.timeStamp-this.startTime>500)&&(this.aborted=!0),x.length===0){const T=!this.aborted&&this.centroid;if(this.reset(),T)return T}}}class Rs{constructor(c){this.singleTap=new ul(c),this.numTaps=c.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(c,p,x){this.singleTap.touchstart(c,p,x)}touchmove(c,p,x){this.singleTap.touchmove(c,p,x)}touchend(c,p,x){const T=this.singleTap.touchend(c,p,x);if(T){const A=c.timeStamp-this.lastTime<500,k=!this.lastTap||this.lastTap.dist(T)<30;if(A&&k||this.reset(),this.count++,this.lastTime=c.timeStamp,this.lastTap=T,this.count===this.numTaps)return this.reset(),T}}}class Xc{constructor(){this._zoomIn=new Rs({numTouches:1,numTaps:2}),this._zoomOut=new Rs({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(c,p,x){this._zoomIn.touchstart(c,p,x),this._zoomOut.touchstart(c,p,x)}touchmove(c,p,x){this._zoomIn.touchmove(c,p,x),this._zoomOut.touchmove(c,p,x)}touchend(c,p,x){const T=this._zoomIn.touchend(c,p,x),A=this._zoomOut.touchend(c,p,x);return T?(this._active=!0,c.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:k=>k.easeTo({duration:300,zoom:k.getZoom()+1,around:k.unproject(T)},{originalEvent:c})}):A?(this._active=!0,c.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:k=>k.easeTo({duration:300,zoom:k.getZoom()-1,around:k.unproject(A)},{originalEvent:c})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Hc={0:1,2:2};class hl{constructor(c){this.reset(),this._clickTolerance=c.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(c,p){return!1}_move(c,p){return{}}mousedown(c,p){if(this._lastPoint)return;const x=xe(c);this._correctButton(c,x)&&(this._lastPoint=p,this._eventButton=x)}mousemoveWindow(c,p){const x=this._lastPoint;if(x){if(c.preventDefault(),this._eventButton!=null&&function(T,A){const k=Hc[A];return T.buttons===void 0||(T.buttons&k)!==k}(c,this._eventButton))this.reset();else if(this._moved||!(p.dist(x)<this._clickTolerance))return this._moved=!0,this._lastPoint=p,this._move(x,p)}}mouseupWindow(c){this._lastPoint&&xe(c)===this._eventButton&&(this._moved&&Y(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wc extends hl{mousedown(c,p){super.mousedown(c,p),this._lastPoint&&(this._active=!0)}_correctButton(c,p){return p===0&&!c.ctrlKey}_move(c,p){return{around:p,panDelta:p.sub(c)}}}class Yl extends hl{_correctButton(c,p){return p===0&&c.ctrlKey||p===2}_move(c,p){const x=.8*(p.x-c.x);if(x)return this._active=!0,{bearingDelta:x}}contextmenu(c){c.preventDefault()}}class Oa extends hl{_correctButton(c,p){return p===0&&c.ctrlKey||p===2}_move(c,p){const x=-.5*(p.y-c.y);if(x)return this._active=!0,{pitchDelta:x}}contextmenu(c){c.preventDefault()}}class Yc{constructor(c,p){this._map=c,this._el=c.getCanvasContainer(),this._minTouches=1,this._clickTolerance=p.clickTolerance||1,this.reset(),o.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new o.pointGeometry(0,0)}touchstart(c,p,x){return this._calculateTransform(c,p,x)}touchmove(c,p,x){if(this._active&&!(x.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(x.length===1&&!o.isFullscreen())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return c.cancelable&&c.preventDefault(),this._calculateTransform(c,p,x)}}touchend(c,p,x){this._calculateTransform(c,p,x),this._active&&x.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(c,p,x){x.length>0&&(this._active=!0);const T=cl(x,p),A=new o.pointGeometry(0,0),k=new o.pointGeometry(0,0);let O=0;for(const V in T){const G=T[V],ie=this._touches[V];ie&&(A._add(G),k._add(G.sub(ie)),O++,T[V]=G)}if(this._touches=T,O<this._minTouches||!k.mag())return;const F=k.div(O);return this._sum._add(F),this._sum.mag()<this._clickTolerance?void 0:{around:A.div(O),panDelta:F}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=L("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")},500)}}class dl{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(c){}_move(c,p,x){return{}}touchstart(c,p,x){this._firstTwoTouches||x.length<2||(this._firstTwoTouches=[x[0].identifier,x[1].identifier],this._start([p[0],p[1]]))}touchmove(c,p,x){const T=this._firstTwoTouches;if(!T)return;c.preventDefault();const[A,k]=T,O=Ls(x,p,A),F=Ls(x,p,k);if(!O||!F)return;const V=this._aroundCenter?null:O.add(F).div(2);return this._move([O,F],V,c)}touchend(c,p,x){if(!this._firstTwoTouches)return;const[T,A]=this._firstTwoTouches,k=Ls(x,p,T),O=Ls(x,p,A);k&&O||(this._active&&Y(),this.reset())}touchcancel(){this.reset()}enable(c){this._enabled=!0,this._aroundCenter=!!c&&c.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Ls(g,c,p){for(let x=0;x<g.length;x++)if(g[x].identifier===p)return c[x]}function Kl(g,c){return Math.log(g/c)/Math.LN2}class Kc extends dl{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(c){this._startDistance=this._distance=c[0].dist(c[1])}_move(c,p){const x=this._distance;if(this._distance=c[0].dist(c[1]),this._active||!(Math.abs(Kl(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Kl(this._distance,x),pinchAround:p}}}function Ql(g,c){return 180*g.angleWith(c)/Math.PI}class Sn extends dl{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(c){this._startVector=this._vector=c[0].sub(c[1]),this._minDiameter=c[0].dist(c[1])}_move(c,p){const x=this._vector;if(this._vector=c[0].sub(c[1]),x&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Ql(this._vector,x),pinchAround:p}}_isBelowThreshold(c){this._minDiameter=Math.min(this._minDiameter,c.mag());const p=25/(Math.PI*this._minDiameter)*360,x=this._startVector;if(!x)return!1;const T=Ql(c,x);return Math.abs(T)<p}}function Jl(g){return Math.abs(g.y)>Math.abs(g.x)}class Qc extends dl{constructor(c){super(),this._map=c}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(c){this._lastPoints=c,Jl(c[0].sub(c[1]))&&(this._valid=!1)}_move(c,p,x){const T=this._lastPoints;if(!T)return;const A=c[0].sub(T[0]),k=c[1].sub(T[1]);return this._map._cooperativeGestures&&!o.isFullscreen()&&x.touches.length<3||(this._valid=this.gestureBeginsVertically(A,k,x.timeStamp),!this._valid)?void 0:(this._lastPoints=c,this._active=!0,{pitchDelta:(A.y+k.y)/2*-.5})}gestureBeginsVertically(c,p,x){if(this._valid!==void 0)return this._valid;const T=c.mag()>=2,A=p.mag()>=2;if(!T&&!A)return;if(!T||!A)return this._firstMove==null&&(this._firstMove=x),x-this._firstMove<100&&void 0;const k=c.y>0==p.y>0;return Jl(c)&&Jl(p)&&k}}const Ju={panStep:100,bearingStep:15,pitchStep:10};class eh{constructor(){const c=Ju;this._panStep=c.panStep,this._bearingStep=c.bearingStep,this._pitchStep=c.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(c){if(c.altKey||c.ctrlKey||c.metaKey)return;let p=0,x=0,T=0,A=0,k=0;switch(c.keyCode){case 61:case 107:case 171:case 187:p=1;break;case 189:case 109:case 173:p=-1;break;case 37:c.shiftKey?x=-1:(c.preventDefault(),A=-1);break;case 39:c.shiftKey?x=1:(c.preventDefault(),A=1);break;case 38:c.shiftKey?T=1:(c.preventDefault(),k=-1);break;case 40:c.shiftKey?T=-1:(c.preventDefault(),k=1);break;default:return}return this._rotationDisabled&&(x=0,T=0),{cameraAnimation:O=>{const F=O.getZoom();O.easeTo({duration:300,easeId:"keyboardHandler",easing:Wo,zoom:p?Math.round(F)+p*(c.shiftKey?2:1):F,bearing:O.getBearing()+x*this._bearingStep,pitch:O.getPitch()+T*this._pitchStep,offset:[-A*this._panStep,-k*this._panStep],center:O.getCenter()},{originalEvent:c})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Wo(g){return g*(2-g)}const ec=4.000244140625;class ss{constructor(c,p){this._map=c,this._el=c.getCanvasContainer(),this._handler=p,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,o.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(c){this._defaultZoomRate=c}setWheelZoomRate(c){this._wheelZoomRate=c}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(c){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!c&&c.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(c){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(c.ctrlKey||c.metaKey||this.isZooming()||o.isFullscreen()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let p=c.deltaMode===o.window.WheelEvent.DOM_DELTA_LINE?40*c.deltaY:c.deltaY;const x=o.exported.now(),T=x-(this._lastWheelEventTime||0);this._lastWheelEventTime=x,p!==0&&p%ec==0?this._type="wheel":p!==0&&Math.abs(p)<4?this._type="trackpad":T>400?(this._type=null,this._lastValue=p,this._timeout=setTimeout(this._onTimeout,40,c)):this._type||(this._type=Math.abs(T*p)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,p+=this._lastValue)),c.shiftKey&&p&&(p/=4),this._type&&(this._lastWheelEvent=c,this._delta-=p,this._active||this._start(c)),c.preventDefault()}_onTimeout(c){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(c)}_start(c){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const p=J(this._el,c);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:p,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const c=this._map.transform;this._type==="wheel"&&c.projection.wrap&&(c._center.lng>=180||c._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const p=()=>c._terrainEnabled()&&this._aroundCoord?c.computeZoomRelativeTo(this._aroundCoord):c.zoom;if(this._delta!==0){const F=this._type==="wheel"&&Math.abs(this._delta)>ec?this._wheelZoomRate:this._defaultZoomRate;let V=2/(1+Math.exp(-Math.abs(this._delta*F)));this._delta<0&&V!==0&&(V=1/V);const G=p(),ie=Math.pow(2,G),le=typeof this._targetZoom=="number"?c.zoomScale(this._targetZoom):ie;this._targetZoom=Math.min(c.maxZoom,Math.max(c.minZoom,c.scaleZoom(le*V))),this._type==="wheel"&&(this._startZoom=G,this._easing=this._smoothOutEasing(200)),this._delta=0}const x=typeof this._targetZoom=="number"?this._targetZoom:p(),T=this._startZoom,A=this._easing;let k,O=!1;if(this._type==="wheel"&&T&&A){const F=Math.min((o.exported.now()-this._lastWheelEventTime)/200,1),V=A(F);k=o.number(T,x,V),F<1?this._frameId||(this._frameId=!0):O=!0}else k=x,O=!0;return this._active=!0,O&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!O,zoomDelta:k-p(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(c){let p=o.ease;if(this._prevEase){const x=this._prevEase,T=(o.exported.now()-x.start)/x.duration,A=x.easing(T+.01)-x.easing(T),k=.27/Math.sqrt(A*A+1e-4)*.01,O=Math.sqrt(.0729-k*k);p=o.bezier(k,O,.25,1)}return this._prevEase={start:o.exported.now(),duration:c,easing:p},p}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=L("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(o.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")},200)}}class ko{constructor(c,p){this._clickZoom=c,this._tapZoom=p}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class fl{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(c,p){return c.preventDefault(),{cameraAnimation:x=>{x.easeTo({duration:300,zoom:x.getZoom()+(c.shiftKey?-1:1),around:x.unproject(p)},{originalEvent:c})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class _i{constructor(){this._tap=new Rs({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(c,p,x){this._swipePoint||(this._tapTime&&c.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?x.length>0&&(this._swipePoint=p[0],this._swipeTouch=x[0].identifier):this._tap.touchstart(c,p,x))}touchmove(c,p,x){if(this._tapTime){if(this._swipePoint){if(x[0].identifier!==this._swipeTouch)return;const T=p[0],A=T.y-this._swipePoint.y;return this._swipePoint=T,c.preventDefault(),this._active=!0,{zoomDelta:A/128}}}else this._tap.touchmove(c,p,x)}touchend(c,p,x){this._tapTime?this._swipePoint&&x.length===0&&this.reset():this._tap.touchend(c,p,x)&&(this._tapTime=c.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Jc{constructor(c,p,x){this._el=c,this._mousePan=p,this._touchPan=x}enable(c){this._inertiaOptions=c||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class eu{constructor(c,p,x){this._pitchWithRotate=c.pitchWithRotate,this._mouseRotate=p,this._mousePitch=x}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class zs{constructor(c,p,x,T){this._el=c,this._touchZoom=p,this._touchRotate=x,this._tapDragZoom=T,this._rotationDisabled=!1,this._enabled=!0}enable(c){this._touchZoom.enable(c),this._rotationDisabled||this._touchRotate.enable(c),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const ga=g=>g.zoom||g.drag||g.pitch||g.rotate;class tu extends o.Event{}class iu{constructor(){this.constants=[1,1,.01],this.radius=0}setup(c,p){const x=o.sub([],p,c);this.radius=o.length(x[2]<0?o.div([],x,this.constants):[x[0],x[1],0])}projectRay(c){o.div(c,c,this.constants),o.normalize(c,c),o.mul$1(c,c,this.constants);const p=o.scale$2([],c,this.radius);if(p[2]>0){const x=o.scale$2([],[0,0,1],o.dot(p,[0,0,1])),T=o.scale$2([],o.normalize([],[p[0],p[1],0]),this.radius),A=o.add([],p,o.scale$2([],o.sub([],o.add([],T,x),p),2));p[0]=A[0],p[1]=A[1]}return p}}function Os(g){return g.panDelta&&g.panDelta.mag()||g.zoomDelta||g.bearingDelta||g.pitchDelta}class ru{constructor(c,p){this._map=c,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Gc(c),this._bearingSnap=p.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new iu,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(p),o.bindAll(["handleEvent","handleWindowEvent"],this);const x=this._el;this._listeners=[[x,"touchstart",{passive:!0}],[x,"touchmove",{passive:!1}],[x,"touchend",void 0],[x,"touchcancel",void 0],[x,"mousedown",void 0],[x,"mousemove",void 0],[x,"mouseup",void 0],[o.window.document,"mousemove",{capture:!0}],[o.window.document,"mouseup",void 0],[x,"mouseover",void 0],[x,"mouseout",void 0],[x,"dblclick",void 0],[x,"click",void 0],[x,"keydown",{capture:!1}],[x,"keyup",void 0],[x,"wheel",{passive:!1}],[x,"contextmenu",void 0],[o.window,"blur",void 0]];for(const[T,A,k]of this._listeners)T.addEventListener(A,T===o.window.document?this.handleWindowEvent:this.handleEvent,k)}destroy(){for(const[c,p,x]of this._listeners)c.removeEventListener(p,c===o.window.document?this.handleWindowEvent:this.handleEvent,x)}_addDefaultHandlers(c){const p=this._map,x=p.getCanvasContainer();this._add("mapEvent",new ll(p,c));const T=p.boxZoom=new Zc(p,c);this._add("boxZoom",T);const A=new Xc,k=new fl;p.doubleClickZoom=new ko(k,A),this._add("tapZoom",A),this._add("clickZoom",k);const O=new _i;this._add("tapDragZoom",O);const F=p.touchPitch=new Qc(p);this._add("touchPitch",F);const V=new Yl(c),G=new Oa(c);p.dragRotate=new eu(c,V,G),this._add("mouseRotate",V,["mousePitch"]),this._add("mousePitch",G,["mouseRotate"]);const ie=new Wc(c),le=new Yc(p,c);p.dragPan=new Jc(x,ie,le),this._add("mousePan",ie),this._add("touchPan",le,["touchZoom","touchRotate"]);const _e=new Sn,fe=new Kc;p.touchZoomRotate=new zs(x,fe,_e,O),this._add("touchRotate",_e,["touchPan","touchZoom"]),this._add("touchZoom",fe,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Wl(p));const ve=p.scrollZoom=new ss(p,this);this._add("scrollZoom",ve,["mousePan"]);const me=p.keyboard=new eh;this._add("keyboard",me);for(const de of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])c.interactive&&c[de]&&p[de].enable(c[de])}_add(c,p,x){this._handlers.push({handlerName:c,handler:p,allowed:x}),this._handlersById[c]=p}stop(c){if(!this._updatingCamera){for(const{handler:p}of this._handlers)p.reset();this._inertia.clear(),this._fireEvents({},{},c),this._changes=[]}}isActive(){for(const{handler:c}of this._handlers)if(c.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!ga(this._eventsInProgress)||this.isZooming()}_blockedByActive(c,p,x){for(const T in c)if(T!==x&&(!p||p.indexOf(T)<0))return!0;return!1}handleWindowEvent(c){this.handleEvent(c,`${c.type}Window`)}_getMapTouches(c){const p=[];for(const x of c)this._el.contains(x.target)&&p.push(x);return p}handleEvent(c,p){this._updatingCamera=!0;const x=c.type==="renderFrame",T=x?void 0:c,A={needsRenderFrame:!1},k={},O={},F=c.touches?this._getMapTouches(c.touches):void 0,V=F?Ee(this._el,F):x?void 0:J(this._el,c);for(const{handlerName:le,handler:_e,allowed:fe}of this._handlers){if(!_e.isEnabled())continue;let ve;this._blockedByActive(O,fe,le)?_e.reset():_e[p||c.type]&&(ve=_e[p||c.type](c,V,F),this.mergeHandlerResult(A,k,ve,le,T),ve&&ve.needsRenderFrame&&this._triggerRenderFrame()),(ve||_e.isActive())&&(O[le]=_e)}const G={};for(const le in this._previousActiveHandlers)O[le]||(G[le]=T);this._previousActiveHandlers=O,(Object.keys(G).length||Os(A))&&(this._changes.push([A,k,G]),this._triggerRenderFrame()),(Object.keys(O).length||Os(A))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ie}=A;ie&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ie(this._map))}mergeHandlerResult(c,p,x,T,A){if(!x)return;o.extend(c,x);const k={handlerName:T,originalEvent:x.originalEvent||A};x.zoomDelta!==void 0&&(p.zoom=k),x.panDelta!==void 0&&(p.drag=k),x.pitchDelta!==void 0&&(p.pitch=k),x.bearingDelta!==void 0&&(p.rotate=k)}_applyChanges(){const c={},p={},x={};for(const[T,A,k]of this._changes)T.panDelta&&(c.panDelta=(c.panDelta||new o.pointGeometry(0,0))._add(T.panDelta)),T.zoomDelta&&(c.zoomDelta=(c.zoomDelta||0)+T.zoomDelta),T.bearingDelta&&(c.bearingDelta=(c.bearingDelta||0)+T.bearingDelta),T.pitchDelta&&(c.pitchDelta=(c.pitchDelta||0)+T.pitchDelta),T.around!==void 0&&(c.around=T.around),T.aroundCoord!==void 0&&(c.aroundCoord=T.aroundCoord),T.pinchAround!==void 0&&(c.pinchAround=T.pinchAround),T.noInertia&&(c.noInertia=T.noInertia),o.extend(p,A),o.extend(x,k);this._updateMapTransform(c,p,x),this._changes=[]}_updateMapTransform(c,p,x){const T=this._map,A=T.transform,k=be=>[be.x,be.y,be.z];if((be=>{const ge=this._eventsInProgress.drag;return ge&&!this._handlersById[ge.handlerName].isActive()})()&&!Os(c)){const be=A.zoom;A.cameraElevationReference="sea",A.recenterOnTerrain(),A.cameraElevationReference="ground",be!==A.zoom&&this._map._update(!0)}if(!Os(c))return void this._fireEvents(p,x,!0);let{panDelta:O,zoomDelta:F,bearingDelta:V,pitchDelta:G,around:ie,aroundCoord:le,pinchAround:_e}=c;_e!==void 0&&(ie=_e),(be=>p.drag&&!this._eventsInProgress.drag)()&&ie&&(this._dragOrigin=k(A.pointCoordinate3D(ie)),this._trackingEllipsoid.setup(A._camera.position,this._dragOrigin)),A.cameraElevationReference="sea",T._stop(!0),ie=ie||T.transform.centerPoint,V&&(A.bearing+=V),G&&(A.pitch+=G),A._updateCameraState();const fe=[0,0,0];if(O)if(A.projection.name==="mercator"){const be=this._trackingEllipsoid.projectRay(A.screenPointToMercatorRay(ie).dir),ge=this._trackingEllipsoid.projectRay(A.screenPointToMercatorRay(ie.sub(O)).dir);fe[0]=ge[0]-be[0],fe[1]=ge[1]-be[1]}else{const be=A.pointCoordinate(ie);if(A.projection.name==="globe"){O=O.rotate(-A.angle);const ge=A._pixelsPerMercatorPixel/A.worldSize;fe[0]=-O.x*o.mercatorScale(o.latFromMercatorY(be.y))*ge,fe[1]=-O.y*o.mercatorScale(A.center.lat)*ge}else{const ge=A.pointCoordinate(ie.sub(O));be&&ge&&(fe[0]=ge.x-be.x,fe[1]=ge.y-be.y)}}const ve=A.zoom,me=[0,0,0];if(F){const be=k(le||A.pointCoordinate3D(ie)),ge={dir:o.normalize([],o.sub([],be,A._camera.position))};if(ge.dir[2]<0){const Be=A.zoomDeltaToMovement(be,F);o.scale$2(me,ge.dir,Be)}}const de=o.add(fe,fe,me);A._translateCameraConstrained(de),F&&Math.abs(A.zoom-ve)>1e-4&&A.recenterOnTerrain(),A.cameraElevationReference="ground",this._map._update(),c.noInertia||this._inertia.record(c),this._fireEvents(p,x,!0)}_fireEvents(c,p,x){const T=ga(this._eventsInProgress),A=ga(c),k={};for(const G in c){const{originalEvent:ie}=c[G];this._eventsInProgress[G]||(k[`${G}start`]=ie),this._eventsInProgress[G]=c[G]}!T&&A&&this._fireEvent("movestart",A.originalEvent);for(const G in k)this._fireEvent(G,k[G]);A&&this._fireEvent("move",A.originalEvent);for(const G in c){const{originalEvent:ie}=c[G];this._fireEvent(G,ie)}const O={};let F;for(const G in this._eventsInProgress){const{handlerName:ie,originalEvent:le}=this._eventsInProgress[G];this._handlersById[ie].isActive()||(delete this._eventsInProgress[G],F=p[ie]||le,O[`${G}end`]=F)}for(const G in O)this._fireEvent(G,O[G]);const V=ga(this._eventsInProgress);if(x&&(T||A)&&!V){this._updatingCamera=!0;const G=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),ie=le=>le!==0&&-this._bearingSnap<le&&le<this._bearingSnap;G?(ie(G.bearing||this._map.getBearing())&&(G.bearing=0),this._map.easeTo(G,{originalEvent:F})):(this._map.fire(new o.Event("moveend",{originalEvent:F})),ie(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(c,p){this._map.fire(new o.Event(c,p?{originalEvent:p}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(c=>{this._frameId=void 0,this.handleEvent(new tu("renderFrame",{timeStamp:c})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const tc="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class nu extends o.Evented{constructor(c,p){super(),this._moving=!1,this._zooming=!1,this.transform=c,this._bearingSnap=p.bearingSnap,o.bindAll(["_renderFrameCallback"],this)}getCenter(){return new o.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(c,p){return this.jumpTo({center:c},p)}panBy(c,p,x){return c=o.pointGeometry.convert(c).mult(-1),this.panTo(this.transform.center,o.extend({offset:c},p),x)}panTo(c,p,x){return this.easeTo(o.extend({center:c},p),x)}getZoom(){return this.transform.zoom}setZoom(c,p){return this.jumpTo({zoom:c},p),this}zoomTo(c,p,x){return this.easeTo(o.extend({zoom:c},p),x)}zoomIn(c,p){return this.zoomTo(this.getZoom()+1,c,p),this}zoomOut(c,p){return this.zoomTo(this.getZoom()-1,c,p),this}getBearing(){return this.transform.bearing}setBearing(c,p){return this.jumpTo({bearing:c},p),this}getPadding(){return this.transform.padding}setPadding(c,p){return this.jumpTo({padding:c},p),this}rotateTo(c,p,x){return this.easeTo(o.extend({bearing:c},p),x)}resetNorth(c,p){return this.rotateTo(0,o.extend({duration:1e3},c),p),this}resetNorthPitch(c,p){return this.easeTo(o.extend({bearing:0,pitch:0,duration:1e3},c),p),this}snapToNorth(c,p){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(c,p):this}getPitch(){return this.transform.pitch}setPitch(c,p){return this.jumpTo({pitch:c},p),this}cameraForBounds(c,p){c=o.LngLatBounds.convert(c);const x=p&&p.bearing||0,T=c.getNorthWest(),A=c.getSouthEast();return this._cameraForBounds(this.transform,T,A,x,p)}_extendCameraOptions(c){const p={top:0,bottom:0,right:0,left:0};if(typeof(c=o.extend({padding:p,offset:[0,0],maxZoom:this.transform.maxZoom},c)).padding=="number"){const x=c.padding;c.padding={top:x,bottom:x,right:x,left:x}}return c.padding=o.extend(p,c.padding),c}_minimumAABBFrustumDistance(c,p){const x=p.max[0]-p.min[0],T=p.max[1]-p.min[1];return x/T>c.aspect?x/(2*Math.tan(.5*c.fovX)*c.aspect):T/(2*Math.tan(.5*c.fovY)*c.aspect)}_cameraForBoundsOnGlobe(c,p,x,T,A){const k=c.clone(),O=this._extendCameraOptions(A);k.bearing=T;const F=o.LngLat.convert(p),V=o.LngLat.convert(x),G=.5*(F.lat+V.lat),ie=.5*(F.lng+V.lng),le=o.latLngToECEF(G,ie),_e=o.normalize([],le),fe=o.normalize([],o.cross([],_e,[0,1,0])),ve=o.cross([],fe,_e),me=[fe[0],fe[1],fe[2],0,ve[0],ve[1],ve[2],0,_e[0],_e[1],_e[2],0,0,0,0,1],de=[le,o.latLngToECEF(F.lat,F.lng),o.latLngToECEF(V.lat,F.lng),o.latLngToECEF(V.lat,V.lng),o.latLngToECEF(F.lat,V.lng),o.latLngToECEF(G,F.lng),o.latLngToECEF(G,V.lng),o.latLngToECEF(F.lat,ie),o.latLngToECEF(V.lat,ie)];let be=o.Aabb.fromPoints(de.map(qt=>[o.dot(fe,qt),o.dot(ve,qt),o.dot(_e,qt)]));const ge=o.transformMat4([],be.center,me);o.squaredLength(ge)===0&&o.set(ge,0,0,1),o.normalize(ge,ge),o.scale$2(ge,ge,o.GLOBE_RADIUS),k.center=o.ecefToLatLng(ge);const Be=k.getWorldToCameraMatrix(),ze=o.invert(new Float64Array(16),Be);be=o.Aabb.applyTransform(be,o.multiply([],Be,me)),o.transformMat4(ge,ge,Be);const Me=.5*(be.max[2]-be.min[2]),Fe=this._minimumAABBFrustumDistance(k,be),Je=o.scale$2([],[0,0,1],Me),lt=o.add(Je,ge,Je),ot=Fe+(k.pitch===0?0:o.distance(ge,lt)),zt=k.globeCenterInViewSpace,He=o.sub([],ge,[zt[0],zt[1],zt[2]]);o.normalize(He,He),o.scale$2(He,He,ot);const wt=o.add([],ge,He);o.transformMat4(wt,wt,ze);const bt=o.earthRadius/o.GLOBE_RADIUS,tt=o.length(wt),Ve=o.mercatorZfromAltitude(tt*bt-o.earthRadius,0),ri=Math.min(k.zoomFromMercatorZAdjusted(Ve),O.maxZoom);return ri>.5*(o.GLOBE_ZOOM_THRESHOLD_MIN+o.GLOBE_ZOOM_THRESHOLD_MAX)?(k.setProjection({name:"mercator"}),k.zoom=ri,this._cameraForBounds(k,p,x,T,A)):{center:k.center,zoom:ri,bearing:T}}queryTerrainElevation(c,p){const x=this.transform.elevation;return x?(p=o.extend({},{exaggerated:!0},p),x.getAtPoint(o.MercatorCoordinate.fromLngLat(c),null,p.exaggerated)):null}_cameraForBounds(c,p,x,T,A){if(c.projection.name==="globe")return this._cameraForBoundsOnGlobe(c,p,x,T,A);const k=c.clone(),O=this._extendCameraOptions(A),F=k.padding;k.bearing=T;const V=o.LngLat.convert(p),G=o.LngLat.convert(x),ie=new o.LngLat(V.lng,G.lat),le=new o.LngLat(G.lng,V.lat),_e=k.project(V),fe=k.project(G),ve=this.queryTerrainElevation(V),me=this.queryTerrainElevation(G),de=this.queryTerrainElevation(ie),be=this.queryTerrainElevation(le),ge=[[_e.x,_e.y,Math.min(ve||0,me||0,de||0,be||0)],[fe.x,fe.y,Math.max(ve||0,me||0,de||0,be||0)]];let Be=o.Aabb.fromPoints(ge);const ze=k.getWorldToCameraMatrix(),Me=o.invert(new Float64Array(16),ze);Be=o.Aabb.applyTransform(Be,ze);const Fe=o.sub([],Be.max,Be.min),Je=F.left||0,lt=F.right||0,ot=F.bottom||0,zt=F.top||0,{left:He,right:wt,top:bt,bottom:tt}=O.padding,Ve=.5*(Je+lt),ri=.5*(zt+ot),qt=Math.min(k.scaleZoom(k.scale*Math.min((k.width-(Je+lt+He+wt))/Fe[0],(k.height-(ot+zt+tt+bt))/Fe[1])),O.maxZoom),Jt=k.scale/k.zoomScale(qt);Be=new o.Aabb([Be.min[0]-(He+Ve)*Jt,Be.min[1]-(tt+ri)*Jt,Be.min[2]],[Be.max[0]+(wt+Ve)*Jt,Be.max[1]+(bt+ri)*Jt,Be.max[2]]);const Ht=.5*Fe[2],Ai=this._minimumAABBFrustumDistance(k,Be),Vi=[0,0,1,0];o.transformMat4$1(Vi,Vi,ze),o.normalize$2(Vi,Vi);const Ni=o.scale$2([],Vi,Ai+Ht),Bi=o.add([],Be.center,Ni),Wt=(typeof O.offset.x=="number"&&typeof O.offset.y=="number"?new o.pointGeometry(O.offset.x,O.offset.y):o.pointGeometry.convert(O.offset)).rotate(-o.degToRad(T));Be.center[0]-=Wt.x*Jt,Be.center[1]+=Wt.y*Jt,o.transformMat4(Be.center,Be.center,Me),o.transformMat4(Bi,Bi,Me);const Zi=[Be.center[0],Be.center[1],Bi[2]*k.pixelsPerMeter];o.scale$2(Zi,Zi,1/k.worldSize);const er=o.lngFromMercatorX(Zi[0]),Tr=o.latFromMercatorY(Zi[1]),Sr=Math.min(k._zoomFromMercatorZ(Zi[2]),O.maxZoom),vr=new o.LngLat(er,Tr);return k.mercatorFromTransition&&Sr<.5*(o.GLOBE_ZOOM_THRESHOLD_MIN+o.GLOBE_ZOOM_THRESHOLD_MAX)?(k.setProjection({name:"globe"}),k.zoom=Sr,this._cameraForBounds(k,p,x,T,A)):{center:vr,zoom:Sr,bearing:T}}fitBounds(c,p,x){const T=this.cameraForBounds(c,p);return this._fitInternal(T,p,x)}fitScreenCoordinates(c,p,x,T,A){const k=o.pointGeometry.convert(c),O=o.pointGeometry.convert(p),F=new o.pointGeometry(Math.min(k.x,O.x),Math.min(k.y,O.y)),V=new o.pointGeometry(Math.max(k.x,O.x),Math.max(k.y,O.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(k,O))return this;const G=this.transform.pointLocation3D(F),ie=this.transform.pointLocation3D(V),le=this.transform.pointLocation3D(new o.pointGeometry(F.x,V.y)),_e=this.transform.pointLocation3D(new o.pointGeometry(V.x,F.y)),fe=[Math.min(G.lng,ie.lng,le.lng,_e.lng),Math.min(G.lat,ie.lat,le.lat,_e.lat)],ve=[Math.max(G.lng,ie.lng,le.lng,_e.lng),Math.max(G.lat,ie.lat,le.lat,_e.lat)],me=this._cameraForBounds(this.transform,fe,ve,x,T);return this._fitInternal(me,T,A)}_fitInternal(c,p,x){return c?(delete(p=o.extend(c,p)).padding,p.linear?this.easeTo(p,x):this.flyTo(p,x)):this}jumpTo(c,p){this.stop();const x=c.preloadOnly?this.transform.clone():this.transform;let T=!1,A=!1,k=!1;return"zoom"in c&&x.zoom!==+c.zoom&&(T=!0,x.zoom=+c.zoom),c.center!==void 0&&(x.center=o.LngLat.convert(c.center)),"bearing"in c&&x.bearing!==+c.bearing&&(A=!0,x.bearing=+c.bearing),"pitch"in c&&x.pitch!==+c.pitch&&(k=!0,x.pitch=+c.pitch),c.padding==null||x.isPaddingEqual(c.padding)||(x.padding=c.padding),c.preloadOnly?(this._preloadTiles(x),this):(this.fire(new o.Event("movestart",p)).fire(new o.Event("move",p)),T&&this.fire(new o.Event("zoomstart",p)).fire(new o.Event("zoom",p)).fire(new o.Event("zoomend",p)),A&&this.fire(new o.Event("rotatestart",p)).fire(new o.Event("rotate",p)).fire(new o.Event("rotateend",p)),k&&this.fire(new o.Event("pitchstart",p)).fire(new o.Event("pitch",p)).fire(new o.Event("pitchend",p)),this.fire(new o.Event("moveend",p)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||o.warnOnce(tc),this.transform.getFreeCameraOptions()}setFreeCameraOptions(c,p){const x=this.transform;if(!x.projection.supportsFreeCamera)return o.warnOnce(tc),this;this.stop();const T=x.zoom,A=x.pitch,k=x.bearing;x.setFreeCameraOptions(c);const O=T!==x.zoom,F=A!==x.pitch,V=k!==x.bearing;return this.fire(new o.Event("movestart",p)).fire(new o.Event("move",p)),O&&this.fire(new o.Event("zoomstart",p)).fire(new o.Event("zoom",p)).fire(new o.Event("zoomend",p)),V&&this.fire(new o.Event("rotatestart",p)).fire(new o.Event("rotate",p)).fire(new o.Event("rotateend",p)),F&&this.fire(new o.Event("pitchstart",p)).fire(new o.Event("pitch",p)).fire(new o.Event("pitchend",p)),this.fire(new o.Event("moveend",p)),this}easeTo(c,p){this._stop(!1,c.easeId),((c=o.extend({offset:[0,0],duration:500,easing:o.ease},c)).animate===!1||!c.essential&&o.exported.prefersReducedMotion)&&(c.duration=0);const x=this.transform,T=this.getZoom(),A=this.getBearing(),k=this.getPitch(),O=this.getPadding(),F="zoom"in c?+c.zoom:T,V="bearing"in c?this._normalizeBearing(c.bearing,A):A,G="pitch"in c?+c.pitch:k,ie="padding"in c?c.padding:x.padding,le=o.pointGeometry.convert(c.offset);let _e,fe,ve;if(x.projection.name==="globe"){const lt=o.MercatorCoordinate.fromLngLat(x.center),ot=le.rotate(-x.angle);lt.x+=ot.x/x.worldSize,lt.y+=ot.y/x.worldSize;const zt=lt.toLngLat(),He=o.LngLat.convert(c.center||zt);this._normalizeCenter(He),_e=x.centerPoint.add(ot),fe=new o.pointGeometry(lt.x,lt.y).mult(x.worldSize),ve=new o.pointGeometry(o.mercatorXfromLng(He.lng),o.mercatorYfromLat(He.lat)).mult(x.worldSize).sub(fe)}else{_e=x.centerPoint.add(le);const lt=x.pointLocation(_e),ot=o.LngLat.convert(c.center||lt);this._normalizeCenter(ot),fe=x.project(lt),ve=x.project(ot).sub(fe)}const me=x.zoomScale(F-T);let de,be;c.around&&(de=o.LngLat.convert(c.around),be=x.locationPoint(de));const ge=this._zooming||F!==T,Be=this._rotating||A!==V,ze=this._pitching||G!==k,Me=!x.isPaddingEqual(ie),Fe=lt=>ot=>{if(ge&&(lt.zoom=o.number(T,F,ot)),Be&&(lt.bearing=o.number(A,V,ot)),ze&&(lt.pitch=o.number(k,G,ot)),Me&&(lt.interpolatePadding(O,ie,ot),_e=lt.centerPoint.add(le)),de)lt.setLocationAtPoint(de,be);else{const zt=lt.zoomScale(lt.zoom-T),He=F>T?Math.min(2,me):Math.max(.5,me),wt=Math.pow(He,1-ot),bt=lt.unproject(fe.add(ve.mult(ot*wt)).mult(zt));lt.setLocationAtPoint(lt.renderWorldCopies?bt.wrap():bt,_e)}return c.preloadOnly||this._fireMoveEvents(p),lt};if(c.preloadOnly){const lt=this._emulate(Fe,c.duration,x);return this._preloadTiles(lt),this}const Je={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=ge,this._rotating=Be,this._pitching=ze,this._padding=Me,this._easeId=c.easeId,this._prepareEase(p,c.noMoveStart,Je),this._ease(Fe(x),lt=>{x.recenterOnTerrain(),this._afterEase(p,lt)},c),this}_prepareEase(c,p,x={}){this._moving=!0,this.transform.cameraElevationReference="sea",p||x.moving||this.fire(new o.Event("movestart",c)),this._zooming&&!x.zooming&&this.fire(new o.Event("zoomstart",c)),this._rotating&&!x.rotating&&this.fire(new o.Event("rotatestart",c)),this._pitching&&!x.pitching&&this.fire(new o.Event("pitchstart",c))}_fireMoveEvents(c){this.fire(new o.Event("move",c)),this._zooming&&this.fire(new o.Event("zoom",c)),this._rotating&&this.fire(new o.Event("rotate",c)),this._pitching&&this.fire(new o.Event("pitch",c))}_afterEase(c,p){if(this._easeId&&p&&this._easeId===p)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const x=this._zooming,T=this._rotating,A=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,x&&this.fire(new o.Event("zoomend",c)),T&&this.fire(new o.Event("rotateend",c)),A&&this.fire(new o.Event("pitchend",c)),this.fire(new o.Event("moveend",c))}flyTo(c,p){if(!c.essential&&o.exported.prefersReducedMotion){const Jt=o.pick(c,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Jt,p)}this.stop(),c=o.extend({offset:[0,0],speed:1.2,curve:1.42,easing:o.ease},c);const x=this.transform,T=this.getZoom(),A=this.getBearing(),k=this.getPitch(),O=this.getPadding(),F="zoom"in c?o.clamp(+c.zoom,x.minZoom,x.maxZoom):T,V="bearing"in c?this._normalizeBearing(c.bearing,A):A,G="pitch"in c?+c.pitch:k,ie="padding"in c?c.padding:x.padding,le=x.zoomScale(F-T),_e=o.pointGeometry.convert(c.offset);let fe=x.centerPoint.add(_e);const ve=x.pointLocation(fe),me=o.LngLat.convert(c.center||ve);this._normalizeCenter(me);const de=x.project(ve),be=x.project(me).sub(de);let ge=c.curve;const Be=Math.max(x.width,x.height),ze=Be/le,Me=be.mag();if("minZoom"in c){const Jt=o.clamp(Math.min(c.minZoom,T,F),x.minZoom,x.maxZoom),Ht=Be/x.zoomScale(Jt-T);ge=Math.sqrt(Ht/Me*2)}const Fe=ge*ge;function Je(Jt){const Ht=(ze*ze-Be*Be+(Jt?-1:1)*Fe*Fe*Me*Me)/(2*(Jt?ze:Be)*Fe*Me);return Math.log(Math.sqrt(Ht*Ht+1)-Ht)}function lt(Jt){return(Math.exp(Jt)-Math.exp(-Jt))/2}function ot(Jt){return(Math.exp(Jt)+Math.exp(-Jt))/2}const zt=Je(0);let He=function(Jt){return ot(zt)/ot(zt+ge*Jt)},wt=function(Jt){return Be*((ot(zt)*(lt(Ht=zt+ge*Jt)/ot(Ht))-lt(zt))/Fe)/Me;var Ht},bt=(Je(1)-zt)/ge;if(Math.abs(Me)<1e-6||!isFinite(bt)){if(Math.abs(Be-ze)<1e-6)return this.easeTo(c,p);const Jt=ze<Be?-1:1;bt=Math.abs(Math.log(ze/Be))/ge,wt=function(){return 0},He=function(Ht){return Math.exp(Jt*ge*Ht)}}c.duration="duration"in c?+c.duration:1e3*bt/("screenSpeed"in c?+c.screenSpeed/ge:+c.speed),c.maxDuration&&c.duration>c.maxDuration&&(c.duration=0);const tt=A!==V,Ve=G!==k,ri=!x.isPaddingEqual(ie),qt=Jt=>Ht=>{const Ai=Ht*bt,Vi=1/He(Ai);Jt.zoom=Ht===1?F:T+Jt.scaleZoom(Vi),tt&&(Jt.bearing=o.number(A,V,Ht)),Ve&&(Jt.pitch=o.number(k,G,Ht)),ri&&(Jt.interpolatePadding(O,ie,Ht),fe=Jt.centerPoint.add(_e));const Ni=Ht===1?me:Jt.unproject(de.add(be.mult(wt(Ai))).mult(Vi));return Jt.setLocationAtPoint(Jt.renderWorldCopies?Ni.wrap():Ni,fe),Jt._updateCameraOnTerrain(),c.preloadOnly||this._fireMoveEvents(p),Jt};if(c.preloadOnly){const Jt=this._emulate(qt,c.duration,x);return this._preloadTiles(Jt),this}return this._zooming=!0,this._rotating=tt,this._pitching=Ve,this._padding=ri,this._prepareEase(p,!1),this._ease(qt(x),()=>this._afterEase(p),c),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(c,p){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const x=this._onEaseEnd;this._onEaseEnd=void 0,x.call(this,p)}if(!c){const x=this.handlers;x&&x.stop(!1)}return this}_ease(c,p,x){x.animate===!1||x.duration===0?(c(1),p()):(this._easeStart=o.exported.now(),this._easeOptions=x,this._onEaseFrame=c,this._onEaseEnd=p,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const c=Math.min((o.exported.now()-this._easeStart)/this._easeOptions.duration,1),p=this._onEaseFrame;p&&p(this._easeOptions.easing(c)),c<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(c,p){c=o.wrap(c,-180,180);const x=Math.abs(c-p);return Math.abs(c-360-p)<x&&(c-=360),Math.abs(c+360-p)<x&&(c+=360),c}_normalizeCenter(c){const p=this.transform;if(!p.renderWorldCopies||p.maxBounds)return;const x=c.lng-p.center.lng;c.lng+=x>180?-360:x<-180?360:0}_emulate(c,p,x){const T=Math.ceil(15*p/1e3),A=[],k=c(x.clone());for(let O=0;O<=T;O++){const F=k(O/T);A.push(F.clone())}return A}}class ic{constructor(c={}){this.options=c,o.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(c){const p=this.options&&this.options.compact;return this._map=c,this._container=L("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=L("button","mapboxgl-ctrl-attrib-button",this._container),L("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=L("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),p&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),p===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(c,p){const x=this._map._getUIString(`AttributionControl.${p}`);c.setAttribute("aria-label",x),c.removeAttribute("title"),c.firstElementChild&&c.firstElementChild.setAttribute("title",x)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let c=this._editLink;c||(c=this._editLink=this._container.querySelector(".mapbox-improve-map"));const p=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||o.config.ACCESS_TOKEN}];if(c){const x=p.reduce((T,A,k)=>(A.value&&(T+=`${A.key}=${A.value}${k<p.length-1?"&":""}`),T),"?");c.href=`${o.config.FEEDBACK_URL}/${x}#${Xl(this._map,!0)}`,c.rel="noopener nofollow",this._setElementTitle(c,"MapFeedback")}}_updateData(c){!c||c.sourceDataType!=="metadata"&&c.sourceDataType!=="visibility"&&c.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let c=[];if(this._map.style.stylesheet){const T=this._map.style.stylesheet;this.styleOwner=T.owner,this.styleId=T.id}const p=this._map.style._sourceCaches;for(const T in p){const A=p[T];if(A.used){const k=A.getSource();k.attribution&&c.indexOf(k.attribution)<0&&c.push(k.attribution)}}c.sort((T,A)=>T.length-A.length),c=c.filter((T,A)=>{for(let k=A+1;k<c.length;k++)if(c[k].indexOf(T)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?c=[...this.options.customAttribution,...c]:c.unshift(this.options.customAttribution));const x=c.join(" | ");x!==this._attribHTML&&(this._attribHTML=x,c.length?(this._innerContainer.innerHTML=x,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Fs{constructor(){o.bindAll(["_updateLogo","_updateCompact"],this)}onAdd(c){this._map=c,this._container=L("div","mapboxgl-ctrl");const p=L("a","mapboxgl-ctrl-logo");return p.target="_blank",p.rel="noopener nofollow",p.href="https://www.mapbox.com/",p.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),p.setAttribute("rel","noopener nofollow"),this._container.appendChild(p),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(c){c&&c.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const c=this._map.style._sourceCaches;if(Object.entries(c).length===0)return!0;for(const p in c){const x=c[p].getSource();if(x.hasOwnProperty("mapbox_logo")&&!x.mapbox_logo)return!1}return!0}_updateCompact(){const c=this._container.children;if(c.length){const p=c[0];this._map.getCanvasContainer().offsetWidth<250?p.classList.add("mapboxgl-compact"):p.classList.remove("mapboxgl-compact")}}}class pl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(c){const p=++this._id;return this._queue.push({callback:c,id:p,cancelled:!1}),p}remove(c){const p=this._currentlyRunning,x=p?this._queue.concat(p):this._queue;for(const T of x)if(T.id===c)return void(T.cancelled=!0)}run(c=0){const p=this._currentlyRunning=this._queue;this._queue=[];for(const x of p)if(!x.cancelled&&(x.callback(c),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Ns(g,c,p){if(g=new o.LngLat(g.lng,g.lat),c){const x=new o.LngLat(g.lng-360,g.lat),T=new o.LngLat(g.lng+360,g.lat),A=360*Math.ceil(Math.abs(g.lng-p.center.lng)/360),k=p.locationPoint(g).distSqr(c),O=c.x<0||c.y<0||c.x>p.width||c.y>p.height;p.locationPoint(x).distSqr(c)<k&&(O||Math.abs(x.lng-p.center.lng)<A)?g=x:p.locationPoint(T).distSqr(c)<k&&(O||Math.abs(T.lng-p.center.lng)<A)&&(g=T)}for(;Math.abs(g.lng-p.center.lng)>180;){const x=p.locationPoint(g);if(x.x>=0&&x.y>=0&&x.x<=p.width&&x.y<=p.height)break;g.lng>p.center.lng?g.lng-=360:g.lng+=360}return g}const ml={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class gl extends o.Evented{constructor(c,p){if(super(),(c instanceof o.window.HTMLElement||p)&&(c=o.extend({element:c},p)),o.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=c&&c.anchor||"center",this._color=c&&c.color||"#3FB1CE",this._scale=c&&c.scale||1,this._draggable=c&&c.draggable||!1,this._clickTolerance=c&&c.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=c&&c.rotation||0,this._rotationAlignment=c&&c.rotationAlignment||"auto",this._pitchAlignment=c&&c.pitchAlignment&&c.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=c&&c.occludedOpacity||.2,c&&c.element)this._element=c.element,this._offset=o.pointGeometry.convert(c&&c.offset||[0,0]);else{this._defaultMarker=!0,this._element=L("div");const T=41,A=27,k=D("svg",{display:"block",height:T*this._scale+"px",width:A*this._scale+"px",viewBox:`0 0 ${A} ${T}`},this._element),O=D("radialGradient",{id:"shadowGradient"},D("defs",{},k));D("stop",{offset:"10%","stop-opacity":.4},O),D("stop",{offset:"100%","stop-opacity":.05},O),D("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},k),D("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},k),D("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},k),D("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},k),this._offset=o.pointGeometry.convert(c&&c.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",T=>{T.preventDefault()}),this._element.addEventListener("mousedown",T=>{T.preventDefault()});const x=this._element.classList;for(const T in ml)x.remove(`mapboxgl-marker-anchor-${T}`);x.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(c){return c===this._map||(this.remove(),this._map=c,c.getCanvasContainer().appendChild(this._element),c.on("move",this._updateMoving),c.on("moveend",this._update),c.on("remove",this._clearFadeTimer),c._addMarker(this),this.setDraggable(this._draggable),this._update(),c.on("click",this._onMapClick)),this}remove(){const c=this._map;return c&&(c.off("click",this._onMapClick),c.off("move",this._updateMoving),c.off("moveend",this._update),c.off("mousedown",this._addDragHandler),c.off("touchstart",this._addDragHandler),c.off("mouseup",this._onUp),c.off("touchend",this._onUp),c.off("mousemove",this._onMove),c.off("touchmove",this._onMove),c.off("remove",this._clearFadeTimer),c._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(c){return this._lngLat=o.LngLat.convert(c),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(c){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),c){if(!("offset"in c.options)){const T=Math.sqrt(Math.pow(13.5,2)/2);c.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[T,-1*(38.1-13.5+T)],"bottom-right":[-T,-1*(38.1-13.5+T)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=c,c._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(c){const p=c.code,x=c.charCode||c.keyCode;p!=="Space"&&p!=="Enter"&&x!==32&&x!==13||this.togglePopup()}_onMapClick(c){const p=c.originalEvent.target,x=this._element;this._popup&&(p===x||x.contains(p))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const c=this._popup;return c?(c.isOpen()?(c.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(c.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const c=this._map,p=this._pos;if(!c||!p)return!1;const x=c.unproject(p),T=c.getFreeCameraOptions();if(!T.position)return!1;const A=T.position.toLngLat();return A.distanceTo(x)<.9*A.distanceTo(this._lngLat)}_evaluateOpacity(){const c=this._map;if(!c)return;const p=this._pos;if(!p||p.x<0||p.x>c.transform.width||p.y<0||p.y>c.transform.height)return void this._clearFadeTimer();const x=c.unproject(p);let T;c._showingGlobe()&&o.isLngLatBehindGlobe(c.transform,this._lngLat)?T=0:(T=1-c._queryFogOpacity(x),c.transform._terrainEnabled()&&c.getTerrain()&&this._behindTerrain()&&(T*=this._occludedOpacity)),this._element.style.opacity=`${T}`,this._element.style.pointerEvents=T>0?"auto":"none",this._popup&&this._popup._setOpacity(T),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const c=this._pos;if(!c||!this._map)return;const p=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${c.x}px,${c.y}px)
            ${ml[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${p.x}px,${p.y}px)
        `}_calculateXYTransform(){const c=this._pos,p=this._map,x=this.getPitchAlignment();if(!p||!c||x!=="map")return"";if(!p._showingGlobe()){const F=p.getPitch();return F?`rotateX(${F}deg)`:""}const T=o.radToDeg(o.globeTiltAtLngLat(p.transform,this._lngLat)),A=c.sub(o.globeCenterToScreenPoint(p.transform)),k=Math.abs(A.x)+Math.abs(A.y);if(k===0)return"";const O=T/k;return`rotateX(${-A.y*O}deg) rotateY(${A.x*O}deg)`}_calculateZTransform(){const c=this._pos,p=this._map;if(!p||!c)return"";let x=0;const T=this.getRotationAlignment();if(T==="map")if(p._showingGlobe()){const A=p.project(new o.LngLat(this._lngLat.lng,this._lngLat.lat+.001)),k=p.project(new o.LngLat(this._lngLat.lng,this._lngLat.lat-.001)).sub(A);x=o.radToDeg(Math.atan2(k.y,k.x))-90}else x=-p.getBearing();else if(T==="horizon"){const A=o.smoothstep(4,6,p.getZoom()),k=o.globeCenterToScreenPoint(p.transform);k.y+=A*p.transform.height;const O=c.sub(k),F=o.radToDeg(Math.atan2(O.y,O.x));x=(F>90?F-270:F+90)*(1-A)}return x+=this._rotation,x?`rotateZ(${x}deg)`:""}_update(c){o.window.cancelAnimationFrame(this._updateFrameId);const p=this._map;p&&(p.transform.renderWorldCopies&&(this._lngLat=Ns(this._lngLat,this._pos,p.transform)),this._pos=p.project(this._lngLat),c===!0?this._updateFrameId=o.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),p._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(p._showingGlobe()||p.getTerrain()||p.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(c){return this._offset=o.pointGeometry.convert(c),this._update(),this}_onMove(c){const p=this._map;if(!p)return;const x=this._pointerdownPos,T=this._positionDelta;if(x&&T){if(!this._isDragging){const A=this._clickTolerance||p._clickTolerance;if(c.point.dist(x)<A)return;this._isDragging=!0}this._pos=c.point.sub(T),this._lngLat=p.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new o.Event("dragstart"))),this.fire(new o.Event("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const c=this._map;c&&(c.off("mousemove",this._onMove),c.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new o.Event("dragend")),this._state="inactive"}_addDragHandler(c){const p=this._map,x=this._pos;p&&x&&this._element.contains(c.originalEvent.target)&&(c.preventDefault(),this._positionDelta=c.point.sub(x),this._pointerdownPos=c.point,this._state="pending",p.on("mousemove",this._onMove),p.on("touchmove",this._onMove),p.once("mouseup",this._onUp),p.once("touchend",this._onUp))}setDraggable(c){this._draggable=!!c;const p=this._map;return p&&(c?(p.on("mousedown",this._addDragHandler),p.on("touchstart",this._addDragHandler)):(p.off("mousedown",this._addDragHandler),p.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(c){return this._rotation=c||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(c){return this._rotationAlignment=c||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(c){return this._pitchAlignment=c||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(c){return this._occludedOpacity=c||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const ou={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},au=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function rc(g=new o.pointGeometry(0,0),c="bottom"){if(typeof g=="number"){const p=Math.round(Math.sqrt(.5*Math.pow(g,2)));switch(c){case"top":return new o.pointGeometry(0,g);case"top-left":return new o.pointGeometry(p,p);case"top-right":return new o.pointGeometry(-p,p);case"bottom":return new o.pointGeometry(0,-g);case"bottom-left":return new o.pointGeometry(p,-p);case"bottom-right":return new o.pointGeometry(-p,-p);case"left":return new o.pointGeometry(g,0);case"right":return new o.pointGeometry(-g,0)}return new o.pointGeometry(0,0)}return g instanceof o.pointGeometry||Array.isArray(g)?o.pointGeometry.convert(g):o.pointGeometry.convert(g[c]||[0,0])}class su{constructor(c){this.jumpTo(c)}getValue(c){if(c<=this._startTime)return this._start;if(c>=this._endTime)return this._end;const p=o.easeCubicInOut((c-this._startTime)/(this._endTime-this._startTime));return this._start*(1-p)+this._end*p}isEasing(c){return c>=this._startTime&&c<=this._endTime}jumpTo(c){this._startTime=-1/0,this._endTime=-1/0,this._start=c,this._end=c}easeTo(c,p,x){this._start=this.getValue(p),this._end=c,this._startTime=p,this._endTime=p+x}}const lu={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},nc={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function _l(g){g.parentNode&&g.parentNode.removeChild(g)}const cu={showCompass:!0,showZoom:!0,visualizePitch:!1};class uu{constructor(c,p,x=!1){this._clickTolerance=10,this.element=p,this.mouseRotate=new Yl({clickTolerance:c.dragRotate._mouseRotate._clickTolerance}),this.map=c,x&&(this.mousePitch=new Oa({clickTolerance:c.dragRotate._mousePitch._clickTolerance})),o.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),p.addEventListener("mousedown",this.mousedown),p.addEventListener("touchstart",this.touchstart,{passive:!1}),p.addEventListener("touchmove",this.touchmove),p.addEventListener("touchend",this.touchend),p.addEventListener("touchcancel",this.reset)}down(c,p){this.mouseRotate.mousedown(c,p),this.mousePitch&&this.mousePitch.mousedown(c,p),q()}move(c,p){const x=this.map,T=this.mouseRotate.mousemoveWindow(c,p),A=T&&T.bearingDelta;if(A&&x.setBearing(x.getBearing()+A),this.mousePitch){const k=this.mousePitch.mousemoveWindow(c,p),O=k&&k.pitchDelta;O&&x.setPitch(x.getPitch()+O)}}off(){const c=this.element;c.removeEventListener("mousedown",this.mousedown),c.removeEventListener("touchstart",this.touchstart,{passive:!1}),c.removeEventListener("touchmove",this.touchmove),c.removeEventListener("touchend",this.touchend),c.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){oe(),o.window.removeEventListener("mousemove",this.mousemove),o.window.removeEventListener("mouseup",this.mouseup)}mousedown(c){this.down(o.extend({},c,{ctrlKey:!0,preventDefault:()=>c.preventDefault()}),J(this.element,c)),o.window.addEventListener("mousemove",this.mousemove),o.window.addEventListener("mouseup",this.mouseup)}mousemove(c){this.move(c,J(this.element,c))}mouseup(c){this.mouseRotate.mouseupWindow(c),this.mousePitch&&this.mousePitch.mouseupWindow(c),this.offTemp()}touchstart(c){c.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Ee(this.element,c.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>c.preventDefault()},this._startPos))}touchmove(c){c.targetTouches.length!==1?this.reset():(this._lastPos=Ee(this.element,c.targetTouches)[0],this.move({preventDefault:()=>c.preventDefault()},this._lastPos))}touchend(c){c.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const hu={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},oc={maxWidth:100,unit:"metric"};function du(g,c,p){const x=yl(c),T=x/c,A={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"}[p];this._map._requestDomTask(()=>{this._container.style.width=g*T+"px",this._container.innerHTML=`${x}&nbsp;${A}`})}function yl(g){const c=Math.pow(10,`${Math.floor(g)}`.length-1);let p=g/c;return p=p>=10?10:p>=5?5:p>=3?3:p>=2?2:p>=1?1:function(x){const T=Math.pow(10,Math.ceil(-Math.log(x)/Math.LN10));return Math.round(x*T)/T}(p),c*p}const Us={version:o.version,supported:E,setRTLTextPlugin:o.setRTLTextPlugin,getRTLTextPluginStatus:o.getRTLTextPluginStatus,Map:class extends nu{constructor(g){if(o.LivePerformanceUtils.mark(o.PerformanceMarkers.create),(g=o.extend({},nc,g)).minZoom!=null&&g.maxZoom!=null&&g.minZoom>g.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(g.minPitch!=null&&g.maxPitch!=null&&g.minPitch>g.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(g.minPitch!=null&&g.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(g.maxPitch!=null&&g.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(g.antialias&&o.isSafariWithAntialiasingBug(o.window)&&(g.antialias=!1,o.warnOnce("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Yn(g.minZoom,g.maxZoom,g.minPitch,g.maxPitch,g.renderWorldCopies),g),this._interactive=g.interactive,this._minTileCacheSize=g.minTileCacheSize,this._maxTileCacheSize=g.maxTileCacheSize,this._failIfMajorPerformanceCaveat=g.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=g.preserveDrawingBuffer,this._antialias=g.antialias,this._trackResize=g.trackResize,this._bearingSnap=g.bearingSnap,this._refreshExpiredTiles=g.refreshExpiredTiles,this._fadeDuration=g.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=g.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=g.collectResourceTiming,this._optimizeForTerrain=g.optimizeForTerrain,this._language=this._parseLanguage(g.language),this._worldview=g.worldview,this._renderTaskQueue=new pl,this._domRenderTaskQueue=new pl,this._controls=[],this._markers=[],this._popups=[],this._mapId=o.uniqueId(),this._locale=o.extend({},lu,g.locale),this._clickTolerance=g.clickTolerance,this._cooperativeGestures=g.cooperativeGestures,this._performanceMetricsCollection=g.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new su(0),this._interactionRange=[1/0,-1/0],this._useExplicitProjection=!1,this._requestManager=new o.RequestManager(g.transformRequest,g.accessToken,g.testMode),this._silenceAuthErrors=!!g.testMode,typeof g.container=="string"){if(this._container=o.window.document.getElementById(g.container),!this._container)throw new Error(`Container '${g.container}' not found.`)}else{if(!(g.container instanceof o.window.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=g.container}if(this._container.childNodes.length>0&&o.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),g.maxBounds&&this.setMaxBounds(g.maxBounds),o.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),o.window!==void 0&&(o.window.addEventListener("online",this._onWindowOnline,!1),o.window.addEventListener("resize",this._onWindowResize,!1),o.window.addEventListener("orientationchange",this._onWindowResize,!1),o.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new ru(this,g),this._localFontFamily=g.localFontFamily,this._localIdeographFontFamily=g.localIdeographFontFamily,g.style&&this.setStyle(g.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),g.projection&&this.setProjection(g.projection),this._hash=g.hash&&new Vc(typeof g.hash=="string"&&g.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:g.center,zoom:g.zoom,bearing:g.bearing,pitch:g.pitch}),g.bounds&&(this.resize(),this.fitBounds(g.bounds,o.extend({},g.fitBoundsOptions,{duration:0})))),this.resize(),g.attributionControl&&this.addControl(new ic({customAttribution:g.customAttribution})),this._logoControl=new Fs,this.addControl(this._logoControl,g.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",c=>{this._update(c.dataType==="style"),this.fire(new o.Event(`${c.dataType}data`,c))}),this.on("dataloading",c=>{this.fire(new o.Event(`${c.dataType}dataloading`,c))})}_getMapId(){return this._mapId}addControl(g,c){if(c===void 0&&(c=g.getDefaultPosition?g.getDefaultPosition():"top-right"),!g||!g.onAdd)return this.fire(new o.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const p=g.onAdd(this);this._controls.push(g);const x=this._controlPositions[c];return c.indexOf("bottom")!==-1?x.insertBefore(p,x.firstChild):x.appendChild(p),this}removeControl(g){if(!g||!g.onRemove)return this.fire(new o.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const c=this._controls.indexOf(g);return c>-1&&this._controls.splice(c,1),g.onRemove(this),this}hasControl(g){return this._controls.indexOf(g)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(g){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const c=!this._moving;return c&&this.fire(new o.Event("movestart",g)).fire(new o.Event("move",g)),this.fire(new o.Event("resize",g)),c&&this.fire(new o.Event("moveend",g)),this}getBounds(){return this.transform.projection.name==="globe"&&o.warnOnce('Globe projection does not support getBounds API, this API may behave unexpectedly when viewing the poles."'),this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(g){return this.transform.setMaxBounds(o.LngLatBounds.convert(g)),this._update()}setMinZoom(g){if((g=g??-2)>=-2&&g<=this.transform.maxZoom)return this.transform.minZoom=g,this._update(),this.getZoom()<g?this.setZoom(g):this.fire(new o.Event("zoomstart")).fire(new o.Event("zoom")).fire(new o.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(g){if((g=g??22)>=this.transform.minZoom)return this.transform.maxZoom=g,this._update(),this.getZoom()>g?this.setZoom(g):this.fire(new o.Event("zoomstart")).fire(new o.Event("zoom")).fire(new o.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(g){if((g=g??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(g>=0&&g<=this.transform.maxPitch)return this.transform.minPitch=g,this._update(),this.getPitch()<g?this.setPitch(g):this.fire(new o.Event("pitchstart")).fire(new o.Event("pitch")).fire(new o.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(g){if((g=g??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(g>=this.transform.minPitch)return this.transform.maxPitch=g,this._update(),this.getPitch()>g?this.setPitch(g):this.fire(new o.Event("pitchstart")).fire(new o.Event("pitch")).fire(new o.Event("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(g){return this.transform.renderWorldCopies=g,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(g){return g==="auto"?o.window.navigator.language:Array.isArray(g)?g.length===0?void 0:g.map(c=>c==="auto"?o.window.navigator.language:c):g}setLanguage(g){const c=this._parseLanguage(g);if(!this.style||c===this._language)return this;this._language=c,this.style._reloadSources();for(const p of this._controls)p._setLanguage&&p._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(g){return this.style&&g!==this._worldview?(this._worldview=g,this.style._reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(g){return this._lazyInitEmptyStyle(),g?typeof g=="string"&&(g={name:g}):g=null,this._useExplicitProjection=!!g,this._prioritizeAndUpdateProjection(g,this.style.stylesheet?this.style.stylesheet.projection:null)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const g=this.transform,c=g.projection.name;let p;c==="globe"&&g.zoom>=o.GLOBE_ZOOM_THRESHOLD_MAX?(g.setMercatorFromTransition(),p=!0):c==="mercator"&&g.zoom<o.GLOBE_ZOOM_THRESHOLD_MAX&&(g.setProjection({name:"globe"}),p=!0),p&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(g,c){return this._updateProjection(g||c||{name:"mercator"})}_updateProjection(g){let c;if(c=g.name==="globe"&&this.transform.zoom>=o.GLOBE_ZOOM_THRESHOLD_MAX?this.transform.setMercatorFromTransition():this.transform.setProjection(g),this.style.applyProjectionUpdate(),c){this.painter.clearBackgroundTiles();for(const p in this.style._sourceCaches)this.style._sourceCaches[p].clearTiles();this._update(!0),this._forceMarkerAndPopupUpdate(!0)}return this}project(g){return this.transform.locationPoint3D(o.LngLat.convert(g))}unproject(g){return this.transform.pointLocation3D(o.pointGeometry.convert(g))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_createDelegatedListener(g,c,p){if(g==="mouseenter"||g==="mouseover"){let x=!1;const T=k=>{const O=c.filter(V=>this.getLayer(V)),F=O.length?this.queryRenderedFeatures(k.point,{layers:O}):[];F.length?x||(x=!0,p.call(this,new Kn(g,this,k.originalEvent,{features:F}))):x=!1},A=()=>{x=!1};return{layers:new Set(c),listener:p,delegates:{mousemove:T,mouseout:A}}}if(g==="mouseleave"||g==="mouseout"){let x=!1;const T=k=>{const O=c.filter(F=>this.getLayer(F));(O.length?this.queryRenderedFeatures(k.point,{layers:O}):[]).length?x=!0:x&&(x=!1,p.call(this,new Kn(g,this,k.originalEvent)))},A=k=>{x&&(x=!1,p.call(this,new Kn(g,this,k.originalEvent)))};return{layers:new Set(c),listener:p,delegates:{mousemove:T,mouseout:A}}}{const x=T=>{const A=c.filter(O=>this.getLayer(O)),k=A.length?this.queryRenderedFeatures(T.point,{layers:A}):[];k.length&&(T.features=k,p.call(this,T),delete T.features)};return{layers:new Set(c),listener:p,delegates:{[g]:x}}}}on(g,c,p){if(p===void 0)return super.on(g,c);Array.isArray(c)||(c=[c]);const x=this._createDelegatedListener(g,c,p);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[g]=this._delegatedListeners[g]||[],this._delegatedListeners[g].push(x);for(const T in x.delegates)this.on(T,x.delegates[T]);return this}once(g,c,p){if(p===void 0)return super.once(g,c);Array.isArray(c)||(c=[c]);const x=this._createDelegatedListener(g,c,p);for(const T in x.delegates)this.once(T,x.delegates[T]);return this}off(g,c,p){if(p===void 0)return super.off(g,c);c=new Set(Array.isArray(c)?c:[c]);const x=(A,k)=>{if(A.size!==k.size)return!1;for(const O of A)if(!k.has(O))return!1;return!0},T=this._delegatedListeners?this._delegatedListeners[g]:void 0;return T&&(A=>{for(let k=0;k<A.length;k++){const O=A[k];if(O.listener===p&&x(O.layers,c)){for(const F in O.delegates)this.off(F,O.delegates[F]);return A.splice(k,1),this}}})(T),this}queryRenderedFeatures(g,c){return this.style?(c!==void 0||g===void 0||g instanceof o.pointGeometry||Array.isArray(g)||(c=g,g=void 0),this.style.queryRenderedFeatures(g=g||[[0,0],[this.transform.width,this.transform.height]],c=c||{},this.transform)):[]}querySourceFeatures(g,c){return this.style.querySourceFeatures(g,c)}setStyle(g,c){return(c=o.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},c)).diff!==!1&&c.localIdeographFontFamily===this._localIdeographFontFamily&&c.localFontFamily===this._localFontFamily&&this.style&&g?(this._diffStyle(g,c),this):(this._localIdeographFontFamily=c.localIdeographFontFamily,this._localFontFamily=c.localFontFamily,this._updateStyle(g,c))}_getUIString(g){const c=this._locale[g];if(c==null)throw new Error(`Missing UI string '${g}'`);return c}_updateStyle(g,c){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),g&&(this.style=new _n(this,c||{}),this.style.setEventedParent(this,{style:this.style}),typeof g=="string"?this.style.loadURL(g):this.style.loadJSON(g)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new _n(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(g,c){if(typeof g=="string"){const p=this._requestManager.normalizeStyleURL(g),x=this._requestManager.transformRequest(p,o.ResourceType.Style);o.getJSON(x,(T,A)=>{T?this.fire(new o.ErrorEvent(T)):A&&this._updateDiff(A,c)})}else typeof g=="object"&&this._updateDiff(g,c)}_updateDiff(g,c){try{this.style.setState(g)&&this._update(!0)}catch(p){o.warnOnce(`Unable to perform style diff: ${p.message||p.error||p}.  Rebuilding the style from scratch.`),this._updateStyle(g,c)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(o.warnOnce("There is no style added to the map."),!1)}addSource(g,c){return this._lazyInitEmptyStyle(),this.style.addSource(g,c),this._update(!0)}isSourceLoaded(g){return!!this.style&&this.style._isSourceCacheLoaded(g)}areTilesLoaded(){const g=this.style&&this.style._sourceCaches;for(const c in g){const p=g[c]._tiles;for(const x in p){const T=p[x];if(T.state!=="loaded"&&T.state!=="errored")return!1}}return!0}addSourceType(g,c,p){this._lazyInitEmptyStyle(),this.style.addSourceType(g,c,p)}removeSource(g){return this.style.removeSource(g),this._updateTerrain(),this._update(!0)}getSource(g){return this.style.getSource(g)}addImage(g,c,{pixelRatio:p=1,sdf:x=!1,stretchX:T,stretchY:A,content:k}={}){if(this._lazyInitEmptyStyle(),c instanceof o.window.HTMLImageElement||o.window.ImageBitmap&&c instanceof o.window.ImageBitmap){const{width:O,height:F,data:V}=o.exported.getImageData(c);this.style.addImage(g,{data:new o.RGBAImage({width:O,height:F},V),pixelRatio:p,stretchX:T,stretchY:A,content:k,sdf:x,version:0})}else if(c.width===void 0||c.height===void 0)this.fire(new o.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:O,height:F}=c,V=c;this.style.addImage(g,{data:new o.RGBAImage({width:O,height:F},new Uint8Array(V.data)),pixelRatio:p,stretchX:T,stretchY:A,content:k,sdf:x,version:0,userImage:V}),V.onAdd&&V.onAdd(this,g)}}updateImage(g,c){const p=this.style.getImage(g);if(!p)return void this.fire(new o.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const x=c instanceof o.window.HTMLImageElement||o.window.ImageBitmap&&c instanceof o.window.ImageBitmap?o.exported.getImageData(c):c,{width:T,height:A}=x;T!==void 0&&A!==void 0?T===p.data.width&&A===p.data.height?(p.data.replace(x.data,!(c instanceof o.window.HTMLImageElement||o.window.ImageBitmap&&c instanceof o.window.ImageBitmap)),this.style.updateImage(g,p)):this.fire(new o.ErrorEvent(new Error(`The width and height of the updated image (${T}, ${A})
                must be that same as the previous version of the image
                (${p.data.width}, ${p.data.height})`))):this.fire(new o.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(g){return g?!!this.style.getImage(g):(this.fire(new o.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(g){this.style.removeImage(g)}loadImage(g,c){o.getImage(this._requestManager.transformRequest(g,o.ResourceType.Image),(p,x)=>{c(p,x instanceof o.window.HTMLImageElement?o.exported.getImageData(x):x)})}listImages(){return this.style.listImages()}addLayer(g,c){return this._lazyInitEmptyStyle(),this.style.addLayer(g,c),this._update(!0)}moveLayer(g,c){return this.style.moveLayer(g,c),this._update(!0)}removeLayer(g){return this.style.removeLayer(g),this._update(!0)}getLayer(g){return this.style.getLayer(g)}setLayerZoomRange(g,c,p){return this.style.setLayerZoomRange(g,c,p),this._update(!0)}setFilter(g,c,p={}){return this.style.setFilter(g,c,p),this._update(!0)}getFilter(g){return this.style.getFilter(g)}setPaintProperty(g,c,p,x={}){return this.style.setPaintProperty(g,c,p,x),this._update(!0)}getPaintProperty(g,c){return this.style.getPaintProperty(g,c)}setLayoutProperty(g,c,p,x={}){return this.style.setLayoutProperty(g,c,p,x),this._update(!0)}getLayoutProperty(g,c){return this.style.getLayoutProperty(g,c)}setLight(g,c={}){return this._lazyInitEmptyStyle(),this.style.setLight(g,c),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(g){return this._lazyInitEmptyStyle(),!g&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(g),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(g){return this._lazyInitEmptyStyle(),this.style.setFog(g),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(g){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(o.LngLat.convert(g),this.transform):0}setFeatureState(g,c){return this.style.setFeatureState(g,c),this._update()}removeFeatureState(g,c){return this.style.removeFeatureState(g,c),this._update()}getFeatureState(g){return this.style.getFeatureState(g)}_updateContainerDimensions(){if(!this._container)return;const g=this._container.getBoundingClientRect().width||400,c=this._container.getBoundingClientRect().height||300;let p,x,T,A=this._container;for(;A&&(!x||!T);){const k=o.window.getComputedStyle(A).transform;k&&k!=="none"&&(p=k.match(/matrix.*\((.+)\)/)[1].split(", "),p[0]&&p[0]!=="0"&&p[0]!=="1"&&(x=p[0]),p[3]&&p[3]!=="0"&&p[3]!=="1"&&(T=p[3])),A=A.parentElement}this._containerWidth=x?Math.abs(g/x):g,this._containerHeight=T?Math.abs(c/T):c}_detectMissingCSS(){o.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&o.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const g=this._container;g.classList.add("mapboxgl-map"),(this._missingCSSCanary=L("div","mapboxgl-canary",g)).style.visibility="hidden",this._detectMissingCSS();const c=this._canvasContainer=L("div","mapboxgl-canvas-container",g);this._interactive&&c.classList.add("mapboxgl-interactive"),this._canvas=L("canvas","mapboxgl-canvas",c),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const p=this._controlContainer=L("div","mapboxgl-control-container",g),x=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(T=>{x[T]=L("div",`mapboxgl-ctrl-${T}`,p)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(g,c){const p=o.exported.devicePixelRatio||1;this._canvas.width=p*Math.ceil(g),this._canvas.height=p*Math.ceil(c),this._canvas.style.width=`${g}px`,this._canvas.style.height=`${c}px`}_addMarker(g){this._markers.push(g)}_removeMarker(g){const c=this._markers.indexOf(g);c!==-1&&this._markers.splice(c,1)}_addPopup(g){this._popups.push(g)}_removePopup(g){const c=this._popups.indexOf(g);c!==-1&&this._popups.splice(c,1)}_setupPainter(){const g=o.extend({},E.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),c=this._canvas.getContext("webgl",g)||this._canvas.getContext("experimental-webgl",g);c?(o.storeAuthState(c,!0),this.painter=new Qu(c,this.transform),this.on("data",p=>{p.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),o.exported$1.testSupport(c)):this.fire(new o.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(g){g.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new o.Event("webglcontextlost",{originalEvent:g}))}_contextRestored(g){this._setupPainter(),this.resize(),this._update(),this.fire(new o.Event("webglcontextrestored",{originalEvent:g}))}_onMapScroll(g){if(g.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(g){return this.style?(this._styleDirty=this._styleDirty||g,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(g){return this._update(),this._renderTaskQueue.add(g)}_cancelRenderFrame(g){this._renderTaskQueue.remove(g)}_requestDomTask(g){!this.loaded()||this.loaded()&&!this.isMoving()?g():this._domRenderTaskQueue.add(g)}_render(g){let c;const p=this.painter.context.extTimerQuery,x=o.exported.now();if(this.listens("gpu-timing-frame")&&(c=p.createQueryEXT(),p.beginQueryEXT(p.TIME_ELAPSED_EXT,c)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],o.window.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],o.window.performance.now())),this._renderTaskQueue.run(g),this._domRenderTaskQueue.run(g),this._removed)return;this._updateProjectionTransition();let T=!1;const A=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const F=this.transform.zoom,V=this.transform.pitch,G=o.exported.now();this.style.zoomHistory.update(F,G);const ie=new o.EvaluationParameters(F,{now:G,fadeDuration:A,pitch:V,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),le=ie.crossFadingFactor();le===1&&le===this._crossFadingFactor||(T=!0,this._crossFadingFactor=le),this.style.update(ie)}this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let k=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),k=this._updateAverageElevation(x),this.style._updateSources(this.transform),this._forceMarkerAndPopupUpdate()):k=this._updateAverageElevation(x),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,A,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:A,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new o.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new o.Event("load"))),this.style&&(this.style.hasTransitions()||T)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),c){const F=o.exported.now()-x;p.endQueryEXT(p.TIME_ELAPSED_EXT,c),setTimeout(()=>{const V=p.getQueryObjectEXT(c,p.QUERY_RESULT_EXT)/1e6;p.deleteQueryEXT(c),this.fire(new o.Event("gpu-timing-frame",{cpuTime:F,gpuTime:V})),o.window.performance.mark("frame-gpu",{startTime:x,detail:{gpuTime:V}})},50)}if(this.listens("gpu-timing-layer")){const F=this.painter.collectGpuTimers();setTimeout(()=>{const V=this.painter.queryGpuTimers(F);this.fire(new o.Event("gpu-timing-layer",{layerTimes:V}))},50)}if(this.listens("gpu-timing-deferred-render")){const F=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const V=this.painter.queryGpuTimeDeferredRender(F);this.fire(new o.Event("gpu-timing-deferred-render",{gpuTime:V}))},50)}const O=this._sourcesDirty||this._styleDirty||this._placementDirty||k;if(O||this._repaint)this.triggerRepaint();else{const F=!this.isMoving()&&this.loaded();if(F&&(k=this._updateAverageElevation(x,!0)),k)this.triggerRepaint();else if(this._triggerFrame(!1),F&&(this.fire(new o.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const V=this._calculateSpeedIndex();this.fire(new o.Event("speedindexcompleted",{speedIndex:V})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||O||(this._fullyLoaded=!0,o.LivePerformanceUtils.mark(o.PerformanceMarkers.fullLoad),this._performanceMetricsCollection&&o.postPerformanceEvent(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.painter.transform.projection,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(g){for(const c of this._markers)g&&!this.getRenderWorldCopies()&&(c._lngLat=c._lngLat.wrap()),c._update();for(const c of this._popups)!g||this.getRenderWorldCopies()||c._trackPointer||(c._lngLat=c._lngLat.wrap()),c._update()}_updateAverageElevation(g,c=!1){const p=x=>(this.transform.averageElevation=x,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&p(0);if((c||g-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(g)){const x=this.transform.averageElevation;let T=this.transform.sampleAverageElevation(),A=!1;this.transform.elevation&&(A=this.transform.elevation.exaggeration()!==this._averageElevationExaggeration,this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(T)?T=0:this._averageElevationLastSampledAt=g;const k=Math.abs(x-T);if(k>1){if(this._isInitialLoad||A)return this._averageElevation.jumpTo(T),p(T);this._averageElevation.easeTo(T,g,300)}else if(k>1e-4)return this._averageElevation.jumpTo(T),p(T)}return!!this._averageElevation.isEasing(g)&&p(this._averageElevation.getValue(g))}_authenticate(){o.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,g=>{if(g&&(g.message===o.AUTH_ERR_MSG||g.status===401)){const c=this.painter.context.gl;o.storeAuthState(c,!1),this._logoControl instanceof Fs&&this._logoControl._updateLogo(),c&&c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT|c.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new o.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),o.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming())}_calculateSpeedIndex(){const g=this.painter.canvasCopy(),c=this.painter.getCanvasCopiesAndTimestamps();c.timeStamps.push(performance.now());const p=this.painter.context.gl,x=p.createFramebuffer();function T(A){p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,A,0);const k=new Uint8Array(p.drawingBufferWidth*p.drawingBufferHeight*4);return p.readPixels(0,0,p.drawingBufferWidth,p.drawingBufferHeight,p.RGBA,p.UNSIGNED_BYTE,k),k}return p.bindFramebuffer(p.FRAMEBUFFER,x),this._canvasPixelComparison(T(g),c.canvasCopies.map(T),c.timeStamps)}_canvasPixelComparison(g,c,p){let x=p[1]-p[0];const T=g.length/4;for(let A=0;A<c.length;A++){const k=c[A];let O=0;for(let F=0;F<k.length;F+=4)k[F]===g[F]&&k[F+1]===g[F+1]&&k[F+2]===g[F+2]&&k[F+3]===g[F+3]&&(O+=1);x+=(p[A+2]-p[A+1])*(1-O/T)}return x}remove(){this._hash&&this._hash.remove();for(const c of this._controls)c.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),o.window!==void 0&&(o.window.removeEventListener("resize",this._onWindowResize,!1),o.window.removeEventListener("orientationchange",this._onWindowResize,!1),o.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),o.window.removeEventListener("online",this._onWindowOnline,!1));const g=this.painter.context.gl.getExtension("WEBGL_lose_context");g&&g.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),_l(this._canvasContainer),_l(this._controlContainer),_l(this._missingCSSCanary),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),o.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new o.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(g){this._renderNextFrame=this._renderNextFrame||g,this.style&&!this._frame&&(this._frame=o.exported.frame(c=>{const p=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,p&&this._render(c)}))}_preloadTiles(g){const c=this.style?Object.values(this.style._sourceCaches):[];return o.asyncAll(c,(p,x)=>p._preloadTiles(g,x),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(g){this._trackResize&&this.resize({originalEvent:g})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(g){this._showTileBoundaries!==g&&(this._showTileBoundaries=g,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(g){this._showTerrainWireframe!==g&&(this._showTerrainWireframe=g,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(g){this._speedIndexTiming!==g&&(this._speedIndexTiming=g,this._update())}get showPadding(){return!!this._showPadding}set showPadding(g){this._showPadding!==g&&(this._showPadding=g,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(g){this._showCollisionBoxes!==g&&(this._showCollisionBoxes=g,g?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(g){this._showOverdrawInspector!==g&&(this._showOverdrawInspector=g,this._update())}get repaint(){return!!this._repaint}set repaint(g){this._repaint!==g&&(this._repaint=g,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(g){this._vertices=g,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(g){this._showTileAABBs!==g&&(this._showTileAABBs=g,g&&this._update())}_setCacheLimits(g,c){o.setCacheLimits(g,c)}get version(){return o.version}},NavigationControl:class{constructor(g){this.options=o.extend({},cu,g),this._container=L("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",c=>c.preventDefault()),this.options.showZoom&&(o.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",c=>{this._map&&this._map.zoomIn({},{originalEvent:c})}),L("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",c=>{this._map&&this._map.zoomOut({},{originalEvent:c})}),L("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(o.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",c=>{const p=this._map;p&&(this.options.visualizePitch?p.resetNorthPitch({},{originalEvent:c}):p.resetNorth({},{originalEvent:c}))}),this._compassIcon=L("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const g=this._map;if(!g)return;const c=g.getZoom(),p=c===g.getMaxZoom(),x=c===g.getMinZoom();this._zoomInButton.disabled=p,this._zoomOutButton.disabled=x,this._zoomInButton.setAttribute("aria-disabled",p.toString()),this._zoomOutButton.setAttribute("aria-disabled",x.toString())}_rotateCompassArrow(){const g=this._map;if(!g)return;const c=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(g.transform.pitch*(Math.PI/180)),.5)}) rotateX(${g.transform.pitch}deg) rotateZ(${g.transform.angle*(180/Math.PI)}deg)`:`rotate(${g.transform.angle*(180/Math.PI)}deg)`;g._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=c)})}onAdd(g){return this._map=g,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),g.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&g.on("pitch",this._rotateCompassArrow),g.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new uu(g,this._compass,this.options.visualizePitch)),this._container}onRemove(){const g=this._map;g&&(this._container.remove(),this.options.showZoom&&g.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&g.off("pitch",this._rotateCompassArrow),g.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(g,c){const p=L("button",g,this._container);return p.type="button",p.addEventListener("click",c),p}_setButtonTitle(g,c){if(!this._map)return;const p=this._map._getUIString(`NavigationControl.${c}`);g.setAttribute("aria-label",p),g.firstElementChild&&g.firstElementChild.setAttribute("title",p)}},GeolocateControl:class extends o.Evented{constructor(g){super(),this.options=o.extend({geolocation:o.window.navigator.geolocation},hu,g),o.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Zl(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(g){return this._map=g,this._container=L("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(g){const c=(p=!!this.options.geolocation)=>{this._supportsGeolocation=p,g(p)};this._supportsGeolocation!==void 0?g(this._supportsGeolocation):o.window.navigator.permissions!==void 0?o.window.navigator.permissions.query({name:"geolocation"}).then(p=>c(p.state!=="denied")).catch(()=>c()):c()}_isOutOfMapMaxBounds(g){const c=this._map.getMaxBounds(),p=g.coords;return!!c&&(p.longitude<c.getWest()||p.longitude>c.getEast()||p.latitude<c.getSouth()||p.latitude>c.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(g){if(this._map){if(this._isOutOfMapMaxBounds(g))return this._setErrorState(),this.fire(new o.Event("outofmaxbounds",g)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=g,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(g),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(g),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new o.Event("geolocate",g)),this._finish()}}_updateCamera(g){const c=new o.LngLat(g.coords.longitude,g.coords.latitude),p=g.coords.accuracy,x=this._map.getBearing(),T=o.extend({bearing:x},this.options.fitBoundsOptions);this._map.fitBounds(c.toBounds(p),T,{geolocateSource:!0})}_updateMarker(g){if(g){const c=new o.LngLat(g.coords.longitude,g.coords.latitude);this._accuracyCircleMarker.setLngLat(c).addTo(this._map),this._userLocationDotMarker.setLngLat(c).addTo(this._map),this._accuracy=g.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const g=this._map.transform,c=o.mercatorZfromAltitude(1,g._center.lat)*g.worldSize,p=Math.ceil(2*this._accuracy*c);this._circleElement.style.width=`${p}px`,this._circleElement.style.height=`${p}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(g){if(this._map){if(this.options.trackUserLocation)if(g.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const c=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",c),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",c),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(g.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new o.Event("error",g)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(g){if(this._container.addEventListener("contextmenu",c=>c.preventDefault()),this._geolocateButton=L("button","mapboxgl-ctrl-geolocate",this._container),L("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",g===!1){o.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const c=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",c),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",c)}else{const c=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",c),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",c)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=L("div","mapboxgl-user-location"),this._dotElement.appendChild(L("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(L("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new gl({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=L("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new gl({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",c=>{c.geolocateSource||this._watchState!=="ACTIVE_LOCK"||c.originalEvent&&c.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new o.Event("trackuserlocationend")))})}_onDeviceOrientation(g){this._userLocationDotMarker&&(g.webkitCompassHeading?this._heading=g.webkitCompassHeading:g.absolute===!0&&(this._heading=-1*g.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return o.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new o.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new o.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let g;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(g={maximumAge:6e5,timeout:0},this._noTimeout=!0):(g=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,g),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const g=()=>{o.window.addEventListener("ondeviceorientationabsolute"in o.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};o.window.DeviceMotionEvent!==void 0&&typeof o.window.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(c=>{c==="granted"&&g()}).catch(console.error):g()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),o.window.removeEventListener("deviceorientation",this._onDeviceOrientation),o.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:ic,ScaleControl:class{constructor(g){this.options=o.extend({},oc,g),function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"narrow",unit:"meter"}),!0}catch{return!1}}()||(this._setScale=du.bind(this)),o.bindAll(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const g=this.options.maxWidth||100,c=this._map,p=c._containerHeight/2,x=c._containerWidth/2-g/2,T=c.unproject([x,p]),A=c.unproject([x+g,p]),k=T.distanceTo(A);if(this.options.unit==="imperial"){const O=3.2808*k;O>5280?this._setScale(g,O/5280,"mile"):this._setScale(g,O,"foot")}else this.options.unit==="nautical"?this._setScale(g,k/1852,"nautical-mile"):k>=1e3?this._setScale(g,k/1e3,"kilometer"):this._setScale(g,k,"meter")}_setScale(g,c,p){const x=yl(c),T=x/c;this._map._requestDomTask(()=>{this._container.style.width=g*T+"px",this._container.innerHTML=p!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"narrow",unit:p}).format(x):`${x}&nbsp;nm`})}onAdd(g){return this._map=g,this._language=g.getLanguage(),this._container=L("div","mapboxgl-ctrl mapboxgl-ctrl-scale",g.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(g){this._language=g,this._update()}setUnit(g){this.options.unit=g,this._update()}},FullscreenControl:class{constructor(g){this._fullscreen=!1,g&&g.container&&(g.container instanceof o.window.HTMLElement?this._container=g.container:o.warnOnce("Full screen control 'container' must be a DOM element.")),o.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in o.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in o.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(g){return this._map=g,this._container||(this._container=this._map.getContainer()),this._controlContainer=L("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",o.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,o.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!o.window.document.fullscreenEnabled&&!o.window.document.webkitFullscreenEnabled)}_setupUI(){const g=this._fullscreenButton=L("button","mapboxgl-ctrl-fullscreen",this._controlContainer);L("span","mapboxgl-ctrl-icon",g).setAttribute("aria-hidden","true"),g.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),o.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const g=this._getTitle();this._fullscreenButton.setAttribute("aria-label",g),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",g)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(o.window.document.fullscreenElement||o.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?o.window.document.exitFullscreen?o.window.document.exitFullscreen():o.window.document.webkitCancelFullScreen&&o.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends o.Evented{constructor(g){super(),this.options=o.extend(Object.create(ou),g),o.bindAll(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(g&&g.className?g.className.trim().split(/\s+/):[])}addTo(g){return this._map&&this.remove(),this._map=g,this.options.closeOnClick&&g.on("preclick",this._onClose),this.options.closeOnMove&&g.on("move",this._onClose),g.on("remove",this.remove),this._update(),g._addPopup(this),this._focusFirstElement(),this._trackPointer?(g.on("mousemove",this._onMouseEvent),g.on("mouseup",this._onMouseEvent),g._canvasContainer.classList.add("mapboxgl-track-pointer")):g.on("move",this._update),this.fire(new o.Event("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const g=this._map;return g&&(g.off("move",this._update),g.off("move",this._onClose),g.off("preclick",this._onClose),g.off("click",this._onClose),g.off("remove",this.remove),g.off("mousemove",this._onMouseEvent),g.off("mouseup",this._onMouseEvent),g.off("drag",this._onMouseEvent),g._canvasContainer&&g._canvasContainer.classList.remove("mapboxgl-track-pointer"),g._removePopup(this),this._map=void 0),this.fire(new o.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(g){this._lngLat=o.LngLat.convert(g),this._pos=null,this._trackPointer=!1,this._update();const c=this._map;return c&&(c.on("move",this._update),c.off("mousemove",this._onMouseEvent),c._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const g=this._map;return g&&(g.off("move",this._update),g.on("mousemove",this._onMouseEvent),g.on("drag",this._onMouseEvent),g._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(g){return this.setDOMContent(o.window.document.createTextNode(g))}setHTML(g){const c=o.window.document.createDocumentFragment(),p=o.window.document.createElement("body");let x;for(p.innerHTML=g;x=p.firstChild,x;)c.appendChild(x);return this.setDOMContent(c)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(g){return this.options.maxWidth=g,this._update(),this}setDOMContent(g){let c=this._content;if(c)for(;c.hasChildNodes();)c.firstChild&&c.removeChild(c.firstChild);else c=this._content=L("div","mapboxgl-popup-content",this._container||void 0);if(c.appendChild(g),this.options.closeButton){const p=this._closeButton=L("button","mapboxgl-popup-close-button",c);p.type="button",p.setAttribute("aria-label","Close popup"),p.setAttribute("aria-hidden","true"),p.innerHTML="&#215;",p.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(g){return this._classList.add(g),this._updateClassList(),this}removeClassName(g){return this._classList.delete(g),this._updateClassList(),this}setOffset(g){return this.options.offset=g,this._update(),this}toggleClassName(g){let c;return this._classList.delete(g)?c=!1:(this._classList.add(g),c=!0),this._updateClassList(),c}_onMouseEvent(g){this._update(g.point)}_getAnchor(g){if(this.options.anchor)return this.options.anchor;const c=this._map,p=this._container,x=this._pos;if(!c||!p||!x)return"bottom";const T=p.offsetWidth,A=p.offsetHeight,k=x.x<T/2,O=x.x>c.transform.width-T/2;if(x.y+g<A)return k?"top-left":O?"top-right":"top";if(x.y>c.transform.height-A){if(k)return"bottom-left";if(O)return"bottom-right"}return k?"left":O?"right":"bottom"}_updateClassList(){const g=this._container;if(!g)return;const c=[...this._classList];c.push("mapboxgl-popup"),this._anchor&&c.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&c.push("mapboxgl-popup-track-pointer"),g.className=c.join(" ")}_update(g){const c=this._map,p=this._content;if(!c||!this._lngLat&&!this._trackPointer||!p)return;let x=this._container;if(x||(x=this._container=L("div","mapboxgl-popup",c.getContainer()),this._tip=L("div","mapboxgl-popup-tip",x),x.appendChild(p)),this.options.maxWidth&&x.style.maxWidth!==this.options.maxWidth&&(x.style.maxWidth=this.options.maxWidth),c.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Ns(this._lngLat,this._pos,c.transform)),!this._trackPointer||g){const T=this._pos=this._trackPointer&&g?g:c.project(this._lngLat),A=rc(this.options.offset),k=this._anchor=this._getAnchor(A.y),O=rc(this.options.offset,k),F=T.add(O).round();c._requestDomTask(()=>{this._container&&k&&(this._container.style.transform=`${ml[k]} translate(${F.x}px,${F.y}px)`)})}if(!this._marker&&c._showingGlobe()){const T=o.isLngLatBehindGlobe(c.transform,this._lngLat)?0:1;this._setOpacity(T)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const g=this._container.querySelector(au);g&&g.focus()}_onClose(){this.remove()}_setOpacity(g){this._container&&(this._container.style.opacity=`${g}`),this._content&&(this._content.style.pointerEvents=g?"auto":"none")}},Marker:gl,Style:_n,LngLat:o.LngLat,LngLatBounds:o.LngLatBounds,Point:o.pointGeometry,MercatorCoordinate:o.MercatorCoordinate,FreeCameraOptions:ks,Evented:o.Evented,config:o.config,prewarm:function(){Di().acquire(bi)},clearPrewarmedResources:function(){const g=gi;g&&(g.isPreloaded()&&g.numActive()===1?(g.release(bi),gi=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return o.config.ACCESS_TOKEN},set accessToken(g){o.config.ACCESS_TOKEN=g},get baseApiUrl(){return o.config.API_URL},set baseApiUrl(g){o.config.API_URL=g},get workerCount(){return wi.workerCount},set workerCount(g){wi.workerCount=g},get maxParallelImageRequests(){return o.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(g){o.config.MAX_PARALLEL_IMAGE_REQUESTS=g},clearStorage(g){o.clearTileCache(g)},workerUrl:"",workerClass:null,setNow:o.exported.setNow,restoreNow:o.exported.restoreNow};return Us});var _=u;return _})})(mapboxGl);var mapboxgl=mapboxGl.exports,d2r=Math.PI/180,r2d=180/Math.PI;function tileToBBOX(e){var r=tile2lon(e[0]+1,e[2]),n=tile2lon(e[0],e[2]),a=tile2lat(e[1]+1,e[2]),u=tile2lat(e[1],e[2]);return[n,a,r,u]}function tileToGeoJSON(e){var r=tileToBBOX(e),n={type:"Polygon",coordinates:[[[r[0],r[3]],[r[0],r[1]],[r[2],r[1]],[r[2],r[3]],[r[0],r[3]]]]};return n}function tile2lon(e,r){return e/Math.pow(2,r)*360-180}function tile2lat(e,r){var n=Math.PI-2*Math.PI*e/Math.pow(2,r);return r2d*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))}function pointToTile(e,r,n){var a=pointToTileFraction(e,r,n);return a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a}function getChildren(e){return[[e[0]*2,e[1]*2,e[2]+1],[e[0]*2+1,e[1]*2,e[2]+1],[e[0]*2+1,e[1]*2+1,e[2]+1],[e[0]*2,e[1]*2+1,e[2]+1]]}function getParent(e){return[e[0]>>1,e[1]>>1,e[2]-1]}function getSiblings(e){return getChildren(getParent(e))}function hasSiblings(e,r){for(var n=getSiblings(e),a=0;a<n.length;a++)if(!hasTile(r,n[a]))return!1;return!0}function hasTile(e,r){for(var n=0;n<e.length;n++)if(tilesEqual(e[n],r))return!0;return!1}function tilesEqual(e,r){return e[0]===r[0]&&e[1]===r[1]&&e[2]===r[2]}function tileToQuadkey(e){for(var r="",n=e[2];n>0;n--){var a=0,u=1<<n-1;(e[0]&u)!==0&&a++,(e[1]&u)!==0&&(a+=2),r+=a.toString()}return r}function quadkeyToTile(e){for(var r=0,n=0,a=e.length,u=a;u>0;u--){var f=1<<u-1,_=+e[a-u];_===1&&(r|=f),_===2&&(n|=f),_===3&&(r|=f,n|=f)}return[r,n,a]}function bboxToTile(e){var r=pointToTile(e[0],e[1],32),n=pointToTile(e[2],e[3],32),a=[r[0],r[1],n[0],n[1]],u=getBboxZoom(a);if(u===0)return[0,0,0];var f=a[0]>>>32-u,_=a[1]>>>32-u;return[f,_,u]}function getBboxZoom(e){for(var r=28,n=0;n<r;n++){var a=1<<32-(n+1);if((e[0]&a)!==(e[2]&a)||(e[1]&a)!==(e[3]&a))return n}return r}function pointToTileFraction(e,r,n){var a=Math.sin(r*d2r),u=Math.pow(2,n),f=u*(e/360+.5),_=u*(.5-.25*Math.log((1+a)/(1-a))/Math.PI);return f=f%u,f<0&&(f=f+u),[f,_,n]}var tilebelt={tileToGeoJSON,tileToBBOX,getChildren,getParent,getSiblings,hasTile,hasSiblings,tilesEqual,tileToQuadkey,quadkeyToTile,pointToTile,bboxToTile,pointToTileFraction},earthRadius=63710088e-1,factors={centimeters:earthRadius*100,centimetres:earthRadius*100,degrees:earthRadius/111325,feet:earthRadius*3.28084,inches:earthRadius*39.37,kilometers:earthRadius/1e3,kilometres:earthRadius/1e3,meters:earthRadius,metres:earthRadius,miles:earthRadius/1609.344,millimeters:earthRadius*1e3,millimetres:earthRadius*1e3,nauticalmiles:earthRadius/1852,radians:1,yards:earthRadius*1.0936};function feature(e,r,n){n===void 0&&(n={});var a={type:"Feature"};return(n.id===0||n.id)&&(a.id=n.id),n.bbox&&(a.bbox=n.bbox),a.properties=r||{},a.geometry=e,a}function point(e,r,n){if(n===void 0&&(n={}),!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!isNumber(e[0])||!isNumber(e[1]))throw new Error("coordinates must contain numbers");var a={type:"Point",coordinates:e};return feature(a,r,n)}function polygon(e,r,n){n===void 0&&(n={});for(var a=0,u=e;a<u.length;a++){var f=u[a];if(f.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var _=0;_<f[f.length-1].length;_++)if(f[f.length-1][_]!==f[0][_])throw new Error("First and last Position are not equivalent.")}var o={type:"Polygon",coordinates:e};return feature(o,r,n)}function radiansToLength(e,r){r===void 0&&(r="kilometers");var n=factors[r];if(!n)throw new Error(r+" units is invalid");return e*n}function lengthToRadians(e,r){r===void 0&&(r="kilometers");var n=factors[r];if(!n)throw new Error(r+" units is invalid");return e/n}function radiansToDegrees(e){var r=e%(2*Math.PI);return r*180/Math.PI}function degreesToRadians(e){var r=e%360;return r*Math.PI/180}function isNumber(e){return!isNaN(e)&&e!==null&&!Array.isArray(e)}function geomEach(e,r){var n,a,u,f,_,o,b,E,M,P,L=0,D=e.type==="FeatureCollection",U=e.type==="Feature",X=D?e.features.length:1;for(n=0;n<X;n++){for(o=D?e.features[n].geometry:U?e.geometry:e,E=D?e.features[n].properties:U?e.properties:{},M=D?e.features[n].bbox:U?e.bbox:void 0,P=D?e.features[n].id:U?e.id:void 0,b=o?o.type==="GeometryCollection":!1,_=b?o.geometries.length:1,u=0;u<_;u++){if(f=b?o.geometries[u]:o,f===null){if(r(null,L,E,M,P)===!1)return!1;continue}switch(f.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(r(f,L,E,M,P)===!1)return!1;break}case"GeometryCollection":{for(a=0;a<f.geometries.length;a++)if(r(f.geometries[a],L,E,M,P)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}L++}}function geomReduce(e,r,n){var a=n;return geomEach(e,function(u,f,_,o,b){f===0&&n===void 0?a=u:a=r(a,u,f,_,o,b)}),a}function getCoord(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if(e.type==="Feature"&&e.geometry!==null&&e.geometry.type==="Point")return e.geometry.coordinates;if(e.type==="Point")return e.coordinates}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return e;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function distance(e,r,n){n===void 0&&(n={});var a=getCoord(e),u=getCoord(r),f=degreesToRadians(u[1]-a[1]),_=degreesToRadians(u[0]-a[0]),o=degreesToRadians(a[1]),b=degreesToRadians(u[1]),E=Math.pow(Math.sin(f/2),2)+Math.pow(Math.sin(_/2),2)*Math.cos(o)*Math.cos(b);return radiansToLength(2*Math.atan2(Math.sqrt(E),Math.sqrt(1-E)),n.units)}function bboxPolygon(e,r){r===void 0&&(r={});var n=Number(e[0]),a=Number(e[1]),u=Number(e[2]),f=Number(e[3]);if(e.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var _=[n,a],o=[n,f],b=[u,f],E=[u,a];return polygon([[_,E,b,o,_]],r.properties,{bbox:e,id:r.id})}function destination(e,r,n,a){a===void 0&&(a={});var u=getCoord(e),f=degreesToRadians(u[0]),_=degreesToRadians(u[1]),o=degreesToRadians(n),b=lengthToRadians(r,a.units),E=Math.asin(Math.sin(_)*Math.cos(b)+Math.cos(_)*Math.sin(b)*Math.cos(o)),M=f+Math.atan2(Math.sin(o)*Math.sin(b)*Math.cos(_),Math.cos(b)-Math.sin(_)*Math.sin(E)),P=radiansToDegrees(M),L=radiansToDegrees(E);return point([P,L],a.properties)}function bearing(e,r,n){if(n===void 0&&(n={}),n.final===!0)return calculateFinalBearing(e,r);var a=getCoord(e),u=getCoord(r),f=degreesToRadians(a[0]),_=degreesToRadians(u[0]),o=degreesToRadians(a[1]),b=degreesToRadians(u[1]),E=Math.sin(_-f)*Math.cos(b),M=Math.cos(o)*Math.sin(b)-Math.sin(o)*Math.cos(b)*Math.cos(_-f);return radiansToDegrees(Math.atan2(E,M))}function calculateFinalBearing(e,r){var n=bearing(r,e);return n=(n+180)%360,n}function midpoint(e,r){var n=distance(e,r),a=bearing(e,r),u=destination(e,n/2,a);return u}var RADIUS=6378137;function area(e){return geomReduce(e,function(r,n){return r+calculateArea(n)},0)}function calculateArea(e){var r=0,n;switch(e.type){case"Polygon":return polygonArea(e.coordinates);case"MultiPolygon":for(n=0;n<e.coordinates.length;n++)r+=polygonArea(e.coordinates[n]);return r;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function polygonArea(e){var r=0;if(e&&e.length>0){r+=Math.abs(ringArea(e[0]));for(var n=1;n<e.length;n++)r-=Math.abs(ringArea(e[n]))}return r}function ringArea(e){var r,n,a,u,f,_,o,b=0,E=e.length;if(E>2){for(o=0;o<E;o++)o===E-2?(u=E-2,f=E-1,_=0):o===E-1?(u=E-1,f=0,_=1):(u=o,f=o+1,_=o+2),r=e[u],n=e[f],a=e[_],b+=(rad(a[0])-rad(r[0]))*Math.sin(rad(n[1]));b=b*RADIUS*RADIUS/2}return b}function rad(e){return e*Math.PI/180}const bitMethods={getBit(e){return this.data[getSlot(e)]&1<<getShift(e)?1:0},setBit(e){this.data[getSlot(e)]|=1<<getShift(e)},clearBit(e){this.data[getSlot(e)]&=~(1<<getShift(e))},toggleBit(e){this.data[getSlot(e)]^=1<<getShift(e)},getBitXY(e,r){return e>=this.width||r>=this.height?0:this.getBit(r*this.width+e)},setBitXY(e,r){this.setBit(r*this.width+e)},clearBitXY(e,r){this.clearBit(r*this.width+e)},toggleBitXY(e,r){this.toggleBit(r*this.width+e)}};function getSlot(e){return e>>3}function getShift(e){return 7-(e&7)}function setBitMethods(e){for(const r in bitMethods)e.prototype[r]=bitMethods[r]}function checkProcessable(e,r={}){let{bitDepth:n,alpha:a,colorModel:u,components:f,channels:_}=r;if(typeof e!="string"||e.length===0)throw new TypeError("processName must be a string");if(n&&(Array.isArray(n)||(n=[n]),!n.includes(this.bitDepth)))throw new TypeError(`The process: ${e} can only be applied if bit depth is in: ${n}`);if(a&&(Array.isArray(a)||(a=[a]),!a.includes(this.alpha)))throw new TypeError(`The process: ${e} can only be applied if alpha is in: ${a}`);if(u&&(Array.isArray(u)||(u=[u]),!u.includes(this.colorModel)))throw new TypeError(`The process: ${e} can only be applied if color model is in: ${u}`);if(f&&(Array.isArray(f)||(f=[f]),!f.includes(this.components))){let o=`The process: ${e} can only be applied if the number of components is in: ${f}`;throw f.length===1&&f[0]===1?new TypeError(`${o}.\rYou should transform your image using "image.grey()" before applying the algorithm.`):new TypeError(o)}if(_&&(Array.isArray(_)||(_=[_]),!_.includes(this.channels)))throw new TypeError(`The process: ${e} can only be applied if the number of channels is in: ${_}`)}function createBlob(e,r){e=e||[],r=r||{},typeof r=="string"&&(r={type:r});try{return new Blob(e,r)}catch(f){if(f.name!=="TypeError")throw f;for(var n=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,a=new n,u=0;u<e.length;u+=1)a.append(e[u]);return a.getBlob(r.type)}}function dataURLToBlob(e){var r=e.match(/data:([^;]+)/)[1],n=e.replace(/^[^,]+,/,""),a=binaryStringToArrayBuffer(atob(n));return createBlob([a],{type:r})}function canvasToBlob(e,r,n){return typeof e.toBlob=="function"?new Promise(function(a){e.toBlob(a,r,n)}):Promise.resolve(dataURLToBlob(e.toDataURL(r,n)))}function binaryStringToArrayBuffer(e){for(var r=e.length,n=new ArrayBuffer(r),a=new Uint8Array(n),u=-1;++u<r;)a[u]=e.charCodeAt(u);return n}(function(e){if(e.TextEncoder&&e.TextDecoder)return!1;function r(a="utf-8"){if(a!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${a}') is invalid.`)}Object.defineProperty(r.prototype,"encoding",{value:"utf-8"}),r.prototype.encode=function(a,u={stream:!1}){if(u.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let f=0;const _=a.length;let o=0,b=Math.max(32,_+(_>>1)+7),E=new Uint8Array(b>>3<<3);for(;f<_;){let M=a.charCodeAt(f++);if(M>=55296&&M<=56319){if(f<_){const P=a.charCodeAt(f);(P&64512)===56320&&(++f,M=((M&1023)<<10)+(P&1023)+65536)}if(M>=55296&&M<=56319)continue}if(o+4>E.length){b+=8,b*=1+f/a.length*2,b=b>>3<<3;const P=new Uint8Array(b);P.set(E),E=P}if((M&4294967168)===0){E[o++]=M;continue}else if((M&4294965248)===0)E[o++]=M>>6&31|192;else if((M&4294901760)===0)E[o++]=M>>12&15|224,E[o++]=M>>6&63|128;else if((M&4292870144)===0)E[o++]=M>>18&7|240,E[o++]=M>>12&63|128,E[o++]=M>>6&63|128;else continue;E[o++]=M&63|128}return E.slice(0,o)};function n(a="utf-8",u={fatal:!1}){if(a!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${a}') is invalid.`);if(u.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(n.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(n.prototype,"fatal",{value:!1}),Object.defineProperty(n.prototype,"ignoreBOM",{value:!1}),n.prototype.decode=function(a,u={stream:!1}){if(u.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const f=new Uint8Array(a);let _=0;const o=f.length,b=[];for(;_<o;){const E=f[_++];if(E===0)break;if((E&128)===0)b.push(E);else if((E&224)===192){const M=f[_++]&63;b.push((E&31)<<6|M)}else if((E&240)===224){const M=f[_++]&63,P=f[_++]&63;b.push((E&31)<<12|M<<6|P)}else if((E&248)===240){const M=f[_++]&63,P=f[_++]&63,L=f[_++]&63;let D=(E&7)<<18|M<<12|P<<6|L;D>65535&&(D-=65536,b.push(D>>>10&1023|55296),D=56320|D&1023),b.push(D)}}return String.fromCharCode.apply(null,b)},e.TextEncoder=r,e.TextDecoder=n})(typeof window<"u"?window:typeof self<"u"?self:globalThis);function decode$5(e,r="utf8"){return new TextDecoder(r).decode(e)}const encoder$1=new TextEncoder;function encode$3(e){return encoder$1.encode(e)}const defaultByteLength$1=1024*8;class IOBuffer$4{constructor(r=defaultByteLength$1,n={}){let a=!1;typeof r=="number"?r=new ArrayBuffer(r):(a=!0,this.lastWrittenByte=r.byteLength);const u=n.offset?n.offset>>>0:0,f=r.byteLength-u;let _=u;(ArrayBuffer.isView(r)||r instanceof IOBuffer$4)&&(r.byteLength!==r.buffer.byteLength&&(_=r.byteOffset+u),r=r.buffer),a?this.lastWrittenByte=f:this.lastWrittenByte=0,this.buffer=r,this.length=f,this.byteLength=f,this.byteOffset=_,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,_,f),this._mark=0,this._marks=[]}available(r=1){return this.offset+r<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(r=1){return this.offset+=r,this}back(r=1){return this.offset-=r,this}seek(r){return this.offset=r,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const r=this._marks.pop();if(r===void 0)throw new Error("Mark stack empty");return this.seek(r),this}rewind(){return this.offset=0,this}ensureAvailable(r=1){if(!this.available(r)){const a=(this.offset+r)*2,u=new Uint8Array(a);u.set(new Uint8Array(this.buffer)),this.buffer=u.buffer,this.length=this.byteLength=a,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(r=1){const n=new Uint8Array(r);for(let a=0;a<r;a++)n[a]=this.readByte();return n}readInt16(){const r=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,r}readUint16(){const r=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,r}readInt32(){const r=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,r}readUint32(){const r=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,r}readFloat32(){const r=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,r}readFloat64(){const r=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,r}readBigInt64(){const r=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,r}readBigUint64(){const r=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,r}readChar(){return String.fromCharCode(this.readInt8())}readChars(r=1){let n="";for(let a=0;a<r;a++)n+=this.readChar();return n}readUtf8(r=1){return decode$5(this.readBytes(r))}decodeText(r=1,n="utf-8"){return decode$5(this.readBytes(r),n)}writeBoolean(r){return this.writeUint8(r?255:0),this}writeInt8(r){return this.ensureAvailable(1),this._data.setInt8(this.offset++,r),this._updateLastWrittenByte(),this}writeUint8(r){return this.ensureAvailable(1),this._data.setUint8(this.offset++,r),this._updateLastWrittenByte(),this}writeByte(r){return this.writeUint8(r)}writeBytes(r){this.ensureAvailable(r.length);for(let n=0;n<r.length;n++)this._data.setUint8(this.offset++,r[n]);return this._updateLastWrittenByte(),this}writeInt16(r){return this.ensureAvailable(2),this._data.setInt16(this.offset,r,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(r){return this.ensureAvailable(2),this._data.setUint16(this.offset,r,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(r){return this.ensureAvailable(4),this._data.setInt32(this.offset,r,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(r){return this.ensureAvailable(4),this._data.setUint32(this.offset,r,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(r){return this.ensureAvailable(4),this._data.setFloat32(this.offset,r,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(r){return this.ensureAvailable(8),this._data.setFloat64(this.offset,r,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(r){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,r,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(r){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,r,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(r){return this.writeUint8(r.charCodeAt(0))}writeChars(r){for(let n=0;n<r.length;n++)this.writeUint8(r.charCodeAt(n));return this}writeUtf8(r){return this.writeBytes(encode$3(r))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}var IOBuffer$5=Object.freeze(Object.defineProperty({__proto__:null,IOBuffer:IOBuffer$4},Symbol.toStringTag,{value:"Module"})),require$$0$4=getAugmentedNamespace(IOBuffer$5),constants$7={BITMAPV5HEADER:{LogicalColorSpace:{LCS_CALIBRATED_RGB:0,LCS_sRGB:1934772034,LCS_WINDOWS_COLOR_SPACE:1466527264},Compression:{BI_RGB:0,BI_RLE8:1,BI_RLE4:2,BI_BITFIELDS:3,BI_JPEG:4,BI_PNG:5,BI_CMYK:11,BI_CMYKRLE8:12,BI_CMYKRLE4:13},GamutMappingIntent:{LCS_GM_ABS_COLORIMETRIC:8,LCS_GM_BUSINESS:1,LCS_GM_GRAPHICS:2,LCS_GM_IMAGES:4}}};const{IOBuffer:IOBuffer$3}=require$$0$4,constants$6=constants$7,tableLeft=[];for(let e=0;e<=8;e++)tableLeft.push(255<<e);class BMPEncoder extends IOBuffer$3{constructor(r){if(r.bitDepth!==1)throw new Error("Only bitDepth of 1 is supported");if(!r.height||!r.width)throw new Error("ImageData width and height are required");super(r.data),this.width=r.width,this.height=r.height,this.bitDepth=r.bitDepth,this.channels=r.channels,this.components=r.components}encode(){this.encoded=new IOBuffer$3,this.encoded.skip(14),this.writeBitmapV5Header(),this.writeColorTable();const r=this.encoded.offset;return this.writePixelArray(),this.encoded.rewind(),this.writeBitmapFileHeader(r),this.encoded.toArray()}writePixelArray(){let r=this.encoded;const n=Math.floor((this.bitDepth*this.width+31)/32)*4,a=Math.ceil(this.bitDepth*this.width/8),u=n-a,f=this.bitDepth*this.width%8,_=f===0?0:8-f,o=n*this.height;let b,E,M=0,P=0,L=8;r.mark(),E=this.readUint8();for(let D=this.height-1;D>=0;D--){const U=D===0;r.reset(),r.skip(D*n);for(let X=0;X<a;X++){const K=X===a-1;P<=_&&K?(r.writeByte(E<<P),(_===0||_===P)&&!U&&(b=E,E=this.readByte())):P===0?(b=E,E=this.readUint8(),r.writeByte(b)):(b=E,E=this.readUint8(),r.writeByte(b<<P&tableLeft[P]|E>>L)),K&&(M+=f||0,r.skip(u),P=M%8,L=8-P)}}n>a&&(r.reset(),r.skip(o-1),r.writeUint8(0))}writeColorTable(){this.encoded.writeUint32(0).writeUint32(16777215)}writeBitmapFileHeader(r){this.encoded.writeChars("BM").writeInt32(this.encoded.lastWrittenByte).writeUint16(0).writeUint16(0).writeUint32(r)}writeBitmapV5Header(){const n=Math.floor((this.bitDepth*this.width+31)/32)*4*this.height;this.encoded.writeUint32(124).writeInt32(this.width).writeInt32(this.height).writeUint16(1).writeUint16(this.bitDepth).writeUint32(constants$6.BITMAPV5HEADER.Compression.BI_RGB).writeUint32(n).writeInt32(0).writeInt32(0).writeUint32(Math.pow(2,this.bitDepth)).writeUint32(Math.pow(2,this.bitDepth)).writeUint32(4278190080).writeUint32(16711680).writeUint32(65280).writeUint32(255).writeUint32(constants$6.BITMAPV5HEADER.LogicalColorSpace.LCS_sRGB).skip(36).skip(12).writeUint32(constants$6.BITMAPV5HEADER.GamutMappingIntent.LCS_GM_IMAGES).skip(12)}}var BMPEncoder_1=BMPEncoder;const Encoder=BMPEncoder_1;var encode$2=function(r){return new Encoder(r).encode()};/*! pako 2.0.4 https://github.com/nodeca/pako @license (MIT AND Zlib) */const Z_FIXED$1=4,Z_BINARY=0,Z_TEXT=1,Z_UNKNOWN$1=2;function zero$1(e){let r=e.length;for(;--r>=0;)e[r]=0}const STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,MIN_MATCH$1=3,MAX_MATCH$1=258,LENGTH_CODES$1=29,LITERALS$1=256,L_CODES$1=LITERALS$1+1+LENGTH_CODES$1,D_CODES$1=30,BL_CODES$1=19,HEAP_SIZE$1=2*L_CODES$1+1,MAX_BITS$1=15,Buf_size=16,MAX_BL_BITS=7,END_BLOCK=256,REP_3_6=16,REPZ_3_10=17,REPZ_11_138=18,extra_lbits=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),extra_dbits=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),extra_blbits=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),bl_order=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),DIST_CODE_LEN=512,static_ltree=new Array((L_CODES$1+2)*2);zero$1(static_ltree);const static_dtree=new Array(D_CODES$1*2);zero$1(static_dtree);const _dist_code=new Array(DIST_CODE_LEN);zero$1(_dist_code);const _length_code=new Array(MAX_MATCH$1-MIN_MATCH$1+1);zero$1(_length_code);const base_length=new Array(LENGTH_CODES$1);zero$1(base_length);const base_dist=new Array(D_CODES$1);zero$1(base_dist);function StaticTreeDesc(e,r,n,a,u){this.static_tree=e,this.extra_bits=r,this.extra_base=n,this.elems=a,this.max_length=u,this.has_stree=e&&e.length}let static_l_desc,static_d_desc,static_bl_desc;function TreeDesc(e,r){this.dyn_tree=e,this.max_code=0,this.stat_desc=r}const d_code=e=>e<256?_dist_code[e]:_dist_code[256+(e>>>7)],put_short=(e,r)=>{e.pending_buf[e.pending++]=r&255,e.pending_buf[e.pending++]=r>>>8&255},send_bits=(e,r,n)=>{e.bi_valid>Buf_size-n?(e.bi_buf|=r<<e.bi_valid&65535,put_short(e,e.bi_buf),e.bi_buf=r>>Buf_size-e.bi_valid,e.bi_valid+=n-Buf_size):(e.bi_buf|=r<<e.bi_valid&65535,e.bi_valid+=n)},send_code=(e,r,n)=>{send_bits(e,n[r*2],n[r*2+1])},bi_reverse=(e,r)=>{let n=0;do n|=e&1,e>>>=1,n<<=1;while(--r>0);return n>>>1},bi_flush=e=>{e.bi_valid===16?(put_short(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=e.bi_buf&255,e.bi_buf>>=8,e.bi_valid-=8)},gen_bitlen=(e,r)=>{const n=r.dyn_tree,a=r.max_code,u=r.stat_desc.static_tree,f=r.stat_desc.has_stree,_=r.stat_desc.extra_bits,o=r.stat_desc.extra_base,b=r.stat_desc.max_length;let E,M,P,L,D,U,X=0;for(L=0;L<=MAX_BITS$1;L++)e.bl_count[L]=0;for(n[e.heap[e.heap_max]*2+1]=0,E=e.heap_max+1;E<HEAP_SIZE$1;E++)M=e.heap[E],L=n[n[M*2+1]*2+1]+1,L>b&&(L=b,X++),n[M*2+1]=L,!(M>a)&&(e.bl_count[L]++,D=0,M>=o&&(D=_[M-o]),U=n[M*2],e.opt_len+=U*(L+D),f&&(e.static_len+=U*(u[M*2+1]+D)));if(X!==0){do{for(L=b-1;e.bl_count[L]===0;)L--;e.bl_count[L]--,e.bl_count[L+1]+=2,e.bl_count[b]--,X-=2}while(X>0);for(L=b;L!==0;L--)for(M=e.bl_count[L];M!==0;)P=e.heap[--E],!(P>a)&&(n[P*2+1]!==L&&(e.opt_len+=(L-n[P*2+1])*n[P*2],n[P*2+1]=L),M--)}},gen_codes=(e,r,n)=>{const a=new Array(MAX_BITS$1+1);let u=0,f,_;for(f=1;f<=MAX_BITS$1;f++)a[f]=u=u+n[f-1]<<1;for(_=0;_<=r;_++){let o=e[_*2+1];o!==0&&(e[_*2]=bi_reverse(a[o]++,o))}},tr_static_init=()=>{let e,r,n,a,u;const f=new Array(MAX_BITS$1+1);for(n=0,a=0;a<LENGTH_CODES$1-1;a++)for(base_length[a]=n,e=0;e<1<<extra_lbits[a];e++)_length_code[n++]=a;for(_length_code[n-1]=a,u=0,a=0;a<16;a++)for(base_dist[a]=u,e=0;e<1<<extra_dbits[a];e++)_dist_code[u++]=a;for(u>>=7;a<D_CODES$1;a++)for(base_dist[a]=u<<7,e=0;e<1<<extra_dbits[a]-7;e++)_dist_code[256+u++]=a;for(r=0;r<=MAX_BITS$1;r++)f[r]=0;for(e=0;e<=143;)static_ltree[e*2+1]=8,e++,f[8]++;for(;e<=255;)static_ltree[e*2+1]=9,e++,f[9]++;for(;e<=279;)static_ltree[e*2+1]=7,e++,f[7]++;for(;e<=287;)static_ltree[e*2+1]=8,e++,f[8]++;for(gen_codes(static_ltree,L_CODES$1+1,f),e=0;e<D_CODES$1;e++)static_dtree[e*2+1]=5,static_dtree[e*2]=bi_reverse(e,5);static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS$1+1,L_CODES$1,MAX_BITS$1),static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES$1,MAX_BITS$1),static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES$1,MAX_BL_BITS)},init_block=e=>{let r;for(r=0;r<L_CODES$1;r++)e.dyn_ltree[r*2]=0;for(r=0;r<D_CODES$1;r++)e.dyn_dtree[r*2]=0;for(r=0;r<BL_CODES$1;r++)e.bl_tree[r*2]=0;e.dyn_ltree[END_BLOCK*2]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0},bi_windup=e=>{e.bi_valid>8?put_short(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},copy_block=(e,r,n,a)=>{bi_windup(e),a&&(put_short(e,n),put_short(e,~n)),e.pending_buf.set(e.window.subarray(r,r+n),e.pending),e.pending+=n},smaller=(e,r,n,a)=>{const u=r*2,f=n*2;return e[u]<e[f]||e[u]===e[f]&&a[r]<=a[n]},pqdownheap=(e,r,n)=>{const a=e.heap[n];let u=n<<1;for(;u<=e.heap_len&&(u<e.heap_len&&smaller(r,e.heap[u+1],e.heap[u],e.depth)&&u++,!smaller(r,a,e.heap[u],e.depth));)e.heap[n]=e.heap[u],n=u,u<<=1;e.heap[n]=a},compress_block=(e,r,n)=>{let a,u,f=0,_,o;if(e.last_lit!==0)do a=e.pending_buf[e.d_buf+f*2]<<8|e.pending_buf[e.d_buf+f*2+1],u=e.pending_buf[e.l_buf+f],f++,a===0?send_code(e,u,r):(_=_length_code[u],send_code(e,_+LITERALS$1+1,r),o=extra_lbits[_],o!==0&&(u-=base_length[_],send_bits(e,u,o)),a--,_=d_code(a),send_code(e,_,n),o=extra_dbits[_],o!==0&&(a-=base_dist[_],send_bits(e,a,o)));while(f<e.last_lit);send_code(e,END_BLOCK,r)},build_tree=(e,r)=>{const n=r.dyn_tree,a=r.stat_desc.static_tree,u=r.stat_desc.has_stree,f=r.stat_desc.elems;let _,o,b=-1,E;for(e.heap_len=0,e.heap_max=HEAP_SIZE$1,_=0;_<f;_++)n[_*2]!==0?(e.heap[++e.heap_len]=b=_,e.depth[_]=0):n[_*2+1]=0;for(;e.heap_len<2;)E=e.heap[++e.heap_len]=b<2?++b:0,n[E*2]=1,e.depth[E]=0,e.opt_len--,u&&(e.static_len-=a[E*2+1]);for(r.max_code=b,_=e.heap_len>>1;_>=1;_--)pqdownheap(e,n,_);E=f;do _=e.heap[1],e.heap[1]=e.heap[e.heap_len--],pqdownheap(e,n,1),o=e.heap[1],e.heap[--e.heap_max]=_,e.heap[--e.heap_max]=o,n[E*2]=n[_*2]+n[o*2],e.depth[E]=(e.depth[_]>=e.depth[o]?e.depth[_]:e.depth[o])+1,n[_*2+1]=n[o*2+1]=E,e.heap[1]=E++,pqdownheap(e,n,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],gen_bitlen(e,r),gen_codes(n,b,e.bl_count)},scan_tree=(e,r,n)=>{let a,u=-1,f,_=r[0*2+1],o=0,b=7,E=4;for(_===0&&(b=138,E=3),r[(n+1)*2+1]=65535,a=0;a<=n;a++)f=_,_=r[(a+1)*2+1],!(++o<b&&f===_)&&(o<E?e.bl_tree[f*2]+=o:f!==0?(f!==u&&e.bl_tree[f*2]++,e.bl_tree[REP_3_6*2]++):o<=10?e.bl_tree[REPZ_3_10*2]++:e.bl_tree[REPZ_11_138*2]++,o=0,u=f,_===0?(b=138,E=3):f===_?(b=6,E=3):(b=7,E=4))},send_tree=(e,r,n)=>{let a,u=-1,f,_=r[0*2+1],o=0,b=7,E=4;for(_===0&&(b=138,E=3),a=0;a<=n;a++)if(f=_,_=r[(a+1)*2+1],!(++o<b&&f===_)){if(o<E)do send_code(e,f,e.bl_tree);while(--o!==0);else f!==0?(f!==u&&(send_code(e,f,e.bl_tree),o--),send_code(e,REP_3_6,e.bl_tree),send_bits(e,o-3,2)):o<=10?(send_code(e,REPZ_3_10,e.bl_tree),send_bits(e,o-3,3)):(send_code(e,REPZ_11_138,e.bl_tree),send_bits(e,o-11,7));o=0,u=f,_===0?(b=138,E=3):f===_?(b=6,E=3):(b=7,E=4)}},build_bl_tree=e=>{let r;for(scan_tree(e,e.dyn_ltree,e.l_desc.max_code),scan_tree(e,e.dyn_dtree,e.d_desc.max_code),build_tree(e,e.bl_desc),r=BL_CODES$1-1;r>=3&&e.bl_tree[bl_order[r]*2+1]===0;r--);return e.opt_len+=3*(r+1)+5+5+4,r},send_all_trees=(e,r,n,a)=>{let u;for(send_bits(e,r-257,5),send_bits(e,n-1,5),send_bits(e,a-4,4),u=0;u<a;u++)send_bits(e,e.bl_tree[bl_order[u]*2+1],3);send_tree(e,e.dyn_ltree,r-1),send_tree(e,e.dyn_dtree,n-1)},detect_data_type=e=>{let r=4093624447,n;for(n=0;n<=31;n++,r>>>=1)if(r&1&&e.dyn_ltree[n*2]!==0)return Z_BINARY;if(e.dyn_ltree[9*2]!==0||e.dyn_ltree[10*2]!==0||e.dyn_ltree[13*2]!==0)return Z_TEXT;for(n=32;n<LITERALS$1;n++)if(e.dyn_ltree[n*2]!==0)return Z_TEXT;return Z_BINARY};let static_init_done=!1;const _tr_init$1=e=>{static_init_done||(tr_static_init(),static_init_done=!0),e.l_desc=new TreeDesc(e.dyn_ltree,static_l_desc),e.d_desc=new TreeDesc(e.dyn_dtree,static_d_desc),e.bl_desc=new TreeDesc(e.bl_tree,static_bl_desc),e.bi_buf=0,e.bi_valid=0,init_block(e)},_tr_stored_block$1=(e,r,n,a)=>{send_bits(e,(STORED_BLOCK<<1)+(a?1:0),3),copy_block(e,r,n,!0)},_tr_align$1=e=>{send_bits(e,STATIC_TREES<<1,3),send_code(e,END_BLOCK,static_ltree),bi_flush(e)},_tr_flush_block$1=(e,r,n,a)=>{let u,f,_=0;e.level>0?(e.strm.data_type===Z_UNKNOWN$1&&(e.strm.data_type=detect_data_type(e)),build_tree(e,e.l_desc),build_tree(e,e.d_desc),_=build_bl_tree(e),u=e.opt_len+3+7>>>3,f=e.static_len+3+7>>>3,f<=u&&(u=f)):u=f=n+5,n+4<=u&&r!==-1?_tr_stored_block$1(e,r,n,a):e.strategy===Z_FIXED$1||f===u?(send_bits(e,(STATIC_TREES<<1)+(a?1:0),3),compress_block(e,static_ltree,static_dtree)):(send_bits(e,(DYN_TREES<<1)+(a?1:0),3),send_all_trees(e,e.l_desc.max_code+1,e.d_desc.max_code+1,_+1),compress_block(e,e.dyn_ltree,e.dyn_dtree)),init_block(e),a&&bi_windup(e)},_tr_tally$1=(e,r,n)=>(e.pending_buf[e.d_buf+e.last_lit*2]=r>>>8&255,e.pending_buf[e.d_buf+e.last_lit*2+1]=r&255,e.pending_buf[e.l_buf+e.last_lit]=n&255,e.last_lit++,r===0?e.dyn_ltree[n*2]++:(e.matches++,r--,e.dyn_ltree[(_length_code[n]+LITERALS$1+1)*2]++,e.dyn_dtree[d_code(r)*2]++),e.last_lit===e.lit_bufsize-1);var _tr_init_1=_tr_init$1,_tr_stored_block_1=_tr_stored_block$1,_tr_flush_block_1=_tr_flush_block$1,_tr_tally_1=_tr_tally$1,_tr_align_1=_tr_align$1,trees={_tr_init:_tr_init_1,_tr_stored_block:_tr_stored_block_1,_tr_flush_block:_tr_flush_block_1,_tr_tally:_tr_tally_1,_tr_align:_tr_align_1};const adler32=(e,r,n,a)=>{let u=e&65535|0,f=e>>>16&65535|0,_=0;for(;n!==0;){_=n>2e3?2e3:n,n-=_;do u=u+r[a++]|0,f=f+u|0;while(--_);u%=65521,f%=65521}return u|f<<16|0};var adler32_1=adler32;const makeTable=()=>{let e,r=[];for(var n=0;n<256;n++){e=n;for(var a=0;a<8;a++)e=e&1?3988292384^e>>>1:e>>>1;r[n]=e}return r},crcTable$1=new Uint32Array(makeTable()),crc32=(e,r,n,a)=>{const u=crcTable$1,f=a+n;e^=-1;for(let _=a;_<f;_++)e=e>>>8^u[(e^r[_])&255];return e^-1};var crc32_1=crc32,messages={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},constants$2$1={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init,_tr_stored_block,_tr_flush_block,_tr_tally,_tr_align}=trees,{Z_NO_FLUSH:Z_NO_FLUSH$2,Z_PARTIAL_FLUSH,Z_FULL_FLUSH:Z_FULL_FLUSH$1,Z_FINISH:Z_FINISH$3,Z_BLOCK:Z_BLOCK$1,Z_OK:Z_OK$3,Z_STREAM_END:Z_STREAM_END$3,Z_STREAM_ERROR:Z_STREAM_ERROR$2,Z_DATA_ERROR:Z_DATA_ERROR$2,Z_BUF_ERROR:Z_BUF_ERROR$1,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$1,Z_FILTERED,Z_HUFFMAN_ONLY,Z_RLE,Z_FIXED,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY$1,Z_UNKNOWN,Z_DEFLATED:Z_DEFLATED$2}=constants$2$1,MAX_MEM_LEVEL=9,MAX_WBITS$1=15,DEF_MEM_LEVEL=8,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,MIN_MATCH=3,MAX_MATCH=258,MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1,PRESET_DICT=32,INIT_STATE=42,EXTRA_STATE=69,NAME_STATE=73,COMMENT_STATE=91,HCRC_STATE=103,BUSY_STATE=113,FINISH_STATE=666,BS_NEED_MORE=1,BS_BLOCK_DONE=2,BS_FINISH_STARTED=3,BS_FINISH_DONE=4,OS_CODE=3,err=(e,r)=>(e.msg=messages[r],r),rank=e=>(e<<1)-(e>4?9:0),zero=e=>{let r=e.length;for(;--r>=0;)e[r]=0};let HASH_ZLIB=(e,r,n)=>(r<<e.hash_shift^n)&e.hash_mask,HASH=HASH_ZLIB;const flush_pending=e=>{const r=e.state;let n=r.pending;n>e.avail_out&&(n=e.avail_out),n!==0&&(e.output.set(r.pending_buf.subarray(r.pending_out,r.pending_out+n),e.next_out),e.next_out+=n,r.pending_out+=n,e.total_out+=n,e.avail_out-=n,r.pending-=n,r.pending===0&&(r.pending_out=0))},flush_block_only=(e,r)=>{_tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,r),e.block_start=e.strstart,flush_pending(e.strm)},put_byte=(e,r)=>{e.pending_buf[e.pending++]=r},putShortMSB=(e,r)=>{e.pending_buf[e.pending++]=r>>>8&255,e.pending_buf[e.pending++]=r&255},read_buf=(e,r,n,a)=>{let u=e.avail_in;return u>a&&(u=a),u===0?0:(e.avail_in-=u,r.set(e.input.subarray(e.next_in,e.next_in+u),n),e.state.wrap===1?e.adler=adler32_1(e.adler,r,u,n):e.state.wrap===2&&(e.adler=crc32_1(e.adler,r,u,n)),e.next_in+=u,e.total_in+=u,u)},longest_match=(e,r)=>{let n=e.max_chain_length,a=e.strstart,u,f,_=e.prev_length,o=e.nice_match;const b=e.strstart>e.w_size-MIN_LOOKAHEAD?e.strstart-(e.w_size-MIN_LOOKAHEAD):0,E=e.window,M=e.w_mask,P=e.prev,L=e.strstart+MAX_MATCH;let D=E[a+_-1],U=E[a+_];e.prev_length>=e.good_match&&(n>>=2),o>e.lookahead&&(o=e.lookahead);do if(u=r,!(E[u+_]!==U||E[u+_-1]!==D||E[u]!==E[a]||E[++u]!==E[a+1])){a+=2,u++;do;while(E[++a]===E[++u]&&E[++a]===E[++u]&&E[++a]===E[++u]&&E[++a]===E[++u]&&E[++a]===E[++u]&&E[++a]===E[++u]&&E[++a]===E[++u]&&E[++a]===E[++u]&&a<L);if(f=MAX_MATCH-(L-a),a=L-MAX_MATCH,f>_){if(e.match_start=r,_=f,f>=o)break;D=E[a+_-1],U=E[a+_]}}while((r=P[r&M])>b&&--n!==0);return _<=e.lookahead?_:e.lookahead},fill_window=e=>{const r=e.w_size;let n,a,u,f,_;do{if(f=e.window_size-e.lookahead-e.strstart,e.strstart>=r+(r-MIN_LOOKAHEAD)){e.window.set(e.window.subarray(r,r+r),0),e.match_start-=r,e.strstart-=r,e.block_start-=r,a=e.hash_size,n=a;do u=e.head[--n],e.head[n]=u>=r?u-r:0;while(--a);a=r,n=a;do u=e.prev[--n],e.prev[n]=u>=r?u-r:0;while(--a);f+=r}if(e.strm.avail_in===0)break;if(a=read_buf(e.strm,e.window,e.strstart+e.lookahead,f),e.lookahead+=a,e.lookahead+e.insert>=MIN_MATCH)for(_=e.strstart-e.insert,e.ins_h=e.window[_],e.ins_h=HASH(e,e.ins_h,e.window[_+1]);e.insert&&(e.ins_h=HASH(e,e.ins_h,e.window[_+MIN_MATCH-1]),e.prev[_&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=_,_++,e.insert--,!(e.lookahead+e.insert<MIN_MATCH)););}while(e.lookahead<MIN_LOOKAHEAD&&e.strm.avail_in!==0)},deflate_stored=(e,r)=>{let n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(fill_window(e),e.lookahead===0&&r===Z_NO_FLUSH$2)return BS_NEED_MORE;if(e.lookahead===0)break}e.strstart+=e.lookahead,e.lookahead=0;const a=e.block_start+n;if((e.strstart===0||e.strstart>=a)&&(e.lookahead=e.strstart-a,e.strstart=a,flush_block_only(e,!1),e.strm.avail_out===0)||e.strstart-e.block_start>=e.w_size-MIN_LOOKAHEAD&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}return e.insert=0,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):(e.strstart>e.block_start&&(flush_block_only(e,!1),e.strm.avail_out===0),BS_NEED_MORE)},deflate_fast=(e,r)=>{let n,a;for(;;){if(e.lookahead<MIN_LOOKAHEAD){if(fill_window(e),e.lookahead<MIN_LOOKAHEAD&&r===Z_NO_FLUSH$2)return BS_NEED_MORE;if(e.lookahead===0)break}if(n=0,e.lookahead>=MIN_MATCH&&(e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+MIN_MATCH-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),n!==0&&e.strstart-n<=e.w_size-MIN_LOOKAHEAD&&(e.match_length=longest_match(e,n)),e.match_length>=MIN_MATCH)if(a=_tr_tally(e,e.strstart-e.match_start,e.match_length-MIN_MATCH),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=MIN_MATCH){e.match_length--;do e.strstart++,e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+MIN_MATCH-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!==0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+1]);else a=_tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(a&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}return e.insert=e.strstart<MIN_MATCH-1?e.strstart:MIN_MATCH-1,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):e.last_lit&&(flush_block_only(e,!1),e.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_slow=(e,r)=>{let n,a,u;for(;;){if(e.lookahead<MIN_LOOKAHEAD){if(fill_window(e),e.lookahead<MIN_LOOKAHEAD&&r===Z_NO_FLUSH$2)return BS_NEED_MORE;if(e.lookahead===0)break}if(n=0,e.lookahead>=MIN_MATCH&&(e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+MIN_MATCH-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=MIN_MATCH-1,n!==0&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-MIN_LOOKAHEAD&&(e.match_length=longest_match(e,n),e.match_length<=5&&(e.strategy===Z_FILTERED||e.match_length===MIN_MATCH&&e.strstart-e.match_start>4096)&&(e.match_length=MIN_MATCH-1)),e.prev_length>=MIN_MATCH&&e.match_length<=e.prev_length){u=e.strstart+e.lookahead-MIN_MATCH,a=_tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-MIN_MATCH),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=u&&(e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+MIN_MATCH-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!==0);if(e.match_available=0,e.match_length=MIN_MATCH-1,e.strstart++,a&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}else if(e.match_available){if(a=_tr_tally(e,0,e.window[e.strstart-1]),a&&flush_block_only(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return BS_NEED_MORE}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(a=_tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<MIN_MATCH-1?e.strstart:MIN_MATCH-1,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):e.last_lit&&(flush_block_only(e,!1),e.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_rle=(e,r)=>{let n,a,u,f;const _=e.window;for(;;){if(e.lookahead<=MAX_MATCH){if(fill_window(e),e.lookahead<=MAX_MATCH&&r===Z_NO_FLUSH$2)return BS_NEED_MORE;if(e.lookahead===0)break}if(e.match_length=0,e.lookahead>=MIN_MATCH&&e.strstart>0&&(u=e.strstart-1,a=_[u],a===_[++u]&&a===_[++u]&&a===_[++u])){f=e.strstart+MAX_MATCH;do;while(a===_[++u]&&a===_[++u]&&a===_[++u]&&a===_[++u]&&a===_[++u]&&a===_[++u]&&a===_[++u]&&a===_[++u]&&u<f);e.match_length=MAX_MATCH-(f-u),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=MIN_MATCH?(n=_tr_tally(e,1,e.match_length-MIN_MATCH),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=_tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}return e.insert=0,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):e.last_lit&&(flush_block_only(e,!1),e.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_huff=(e,r)=>{let n;for(;;){if(e.lookahead===0&&(fill_window(e),e.lookahead===0)){if(r===Z_NO_FLUSH$2)return BS_NEED_MORE;break}if(e.match_length=0,n=_tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}return e.insert=0,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):e.last_lit&&(flush_block_only(e,!1),e.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE};function Config(e,r,n,a,u){this.good_length=e,this.max_lazy=r,this.nice_length=n,this.max_chain=a,this.func=u}const configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],lm_init=e=>{e.window_size=2*e.w_size,zero(e.head),e.max_lazy_match=configuration_table[e.level].max_lazy,e.good_match=configuration_table[e.level].good_length,e.nice_match=configuration_table[e.level].nice_length,e.max_chain_length=configuration_table[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=MIN_MATCH-1,e.match_available=0,e.ins_h=0};function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Z_DEFLATED$2,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(HEAP_SIZE*2),this.dyn_dtree=new Uint16Array((2*D_CODES+1)*2),this.bl_tree=new Uint16Array((2*BL_CODES+1)*2),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(MAX_BITS+1),this.heap=new Uint16Array(2*L_CODES+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*L_CODES+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const deflateResetKeep=e=>{if(!e||!e.state)return err(e,Z_STREAM_ERROR$2);e.total_in=e.total_out=0,e.data_type=Z_UNKNOWN;const r=e.state;return r.pending=0,r.pending_out=0,r.wrap<0&&(r.wrap=-r.wrap),r.status=r.wrap?INIT_STATE:BUSY_STATE,e.adler=r.wrap===2?0:1,r.last_flush=Z_NO_FLUSH$2,_tr_init(r),Z_OK$3},deflateReset=e=>{const r=deflateResetKeep(e);return r===Z_OK$3&&lm_init(e.state),r},deflateSetHeader=(e,r)=>!e||!e.state||e.state.wrap!==2?Z_STREAM_ERROR$2:(e.state.gzhead=r,Z_OK$3),deflateInit2=(e,r,n,a,u,f)=>{if(!e)return Z_STREAM_ERROR$2;let _=1;if(r===Z_DEFAULT_COMPRESSION$1&&(r=6),a<0?(_=0,a=-a):a>15&&(_=2,a-=16),u<1||u>MAX_MEM_LEVEL||n!==Z_DEFLATED$2||a<8||a>15||r<0||r>9||f<0||f>Z_FIXED)return err(e,Z_STREAM_ERROR$2);a===8&&(a=9);const o=new DeflateState;return e.state=o,o.strm=e,o.wrap=_,o.gzhead=null,o.w_bits=a,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=u+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+MIN_MATCH-1)/MIN_MATCH),o.window=new Uint8Array(o.w_size*2),o.head=new Uint16Array(o.hash_size),o.prev=new Uint16Array(o.w_size),o.lit_bufsize=1<<u+6,o.pending_buf_size=o.lit_bufsize*4,o.pending_buf=new Uint8Array(o.pending_buf_size),o.d_buf=1*o.lit_bufsize,o.l_buf=(1+2)*o.lit_bufsize,o.level=r,o.strategy=f,o.method=n,deflateReset(e)},deflateInit=(e,r)=>deflateInit2(e,r,Z_DEFLATED$2,MAX_WBITS$1,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY$1),deflate$2=(e,r)=>{let n,a;if(!e||!e.state||r>Z_BLOCK$1||r<0)return e?err(e,Z_STREAM_ERROR$2):Z_STREAM_ERROR$2;const u=e.state;if(!e.output||!e.input&&e.avail_in!==0||u.status===FINISH_STATE&&r!==Z_FINISH$3)return err(e,e.avail_out===0?Z_BUF_ERROR$1:Z_STREAM_ERROR$2);u.strm=e;const f=u.last_flush;if(u.last_flush=r,u.status===INIT_STATE)if(u.wrap===2)e.adler=0,put_byte(u,31),put_byte(u,139),put_byte(u,8),u.gzhead?(put_byte(u,(u.gzhead.text?1:0)+(u.gzhead.hcrc?2:0)+(u.gzhead.extra?4:0)+(u.gzhead.name?8:0)+(u.gzhead.comment?16:0)),put_byte(u,u.gzhead.time&255),put_byte(u,u.gzhead.time>>8&255),put_byte(u,u.gzhead.time>>16&255),put_byte(u,u.gzhead.time>>24&255),put_byte(u,u.level===9?2:u.strategy>=Z_HUFFMAN_ONLY||u.level<2?4:0),put_byte(u,u.gzhead.os&255),u.gzhead.extra&&u.gzhead.extra.length&&(put_byte(u,u.gzhead.extra.length&255),put_byte(u,u.gzhead.extra.length>>8&255)),u.gzhead.hcrc&&(e.adler=crc32_1(e.adler,u.pending_buf,u.pending,0)),u.gzindex=0,u.status=EXTRA_STATE):(put_byte(u,0),put_byte(u,0),put_byte(u,0),put_byte(u,0),put_byte(u,0),put_byte(u,u.level===9?2:u.strategy>=Z_HUFFMAN_ONLY||u.level<2?4:0),put_byte(u,OS_CODE),u.status=BUSY_STATE);else{let _=Z_DEFLATED$2+(u.w_bits-8<<4)<<8,o=-1;u.strategy>=Z_HUFFMAN_ONLY||u.level<2?o=0:u.level<6?o=1:u.level===6?o=2:o=3,_|=o<<6,u.strstart!==0&&(_|=PRESET_DICT),_+=31-_%31,u.status=BUSY_STATE,putShortMSB(u,_),u.strstart!==0&&(putShortMSB(u,e.adler>>>16),putShortMSB(u,e.adler&65535)),e.adler=1}if(u.status===EXTRA_STATE)if(u.gzhead.extra){for(n=u.pending;u.gzindex<(u.gzhead.extra.length&65535)&&!(u.pending===u.pending_buf_size&&(u.gzhead.hcrc&&u.pending>n&&(e.adler=crc32_1(e.adler,u.pending_buf,u.pending-n,n)),flush_pending(e),n=u.pending,u.pending===u.pending_buf_size));)put_byte(u,u.gzhead.extra[u.gzindex]&255),u.gzindex++;u.gzhead.hcrc&&u.pending>n&&(e.adler=crc32_1(e.adler,u.pending_buf,u.pending-n,n)),u.gzindex===u.gzhead.extra.length&&(u.gzindex=0,u.status=NAME_STATE)}else u.status=NAME_STATE;if(u.status===NAME_STATE)if(u.gzhead.name){n=u.pending;do{if(u.pending===u.pending_buf_size&&(u.gzhead.hcrc&&u.pending>n&&(e.adler=crc32_1(e.adler,u.pending_buf,u.pending-n,n)),flush_pending(e),n=u.pending,u.pending===u.pending_buf_size)){a=1;break}u.gzindex<u.gzhead.name.length?a=u.gzhead.name.charCodeAt(u.gzindex++)&255:a=0,put_byte(u,a)}while(a!==0);u.gzhead.hcrc&&u.pending>n&&(e.adler=crc32_1(e.adler,u.pending_buf,u.pending-n,n)),a===0&&(u.gzindex=0,u.status=COMMENT_STATE)}else u.status=COMMENT_STATE;if(u.status===COMMENT_STATE)if(u.gzhead.comment){n=u.pending;do{if(u.pending===u.pending_buf_size&&(u.gzhead.hcrc&&u.pending>n&&(e.adler=crc32_1(e.adler,u.pending_buf,u.pending-n,n)),flush_pending(e),n=u.pending,u.pending===u.pending_buf_size)){a=1;break}u.gzindex<u.gzhead.comment.length?a=u.gzhead.comment.charCodeAt(u.gzindex++)&255:a=0,put_byte(u,a)}while(a!==0);u.gzhead.hcrc&&u.pending>n&&(e.adler=crc32_1(e.adler,u.pending_buf,u.pending-n,n)),a===0&&(u.status=HCRC_STATE)}else u.status=HCRC_STATE;if(u.status===HCRC_STATE&&(u.gzhead.hcrc?(u.pending+2>u.pending_buf_size&&flush_pending(e),u.pending+2<=u.pending_buf_size&&(put_byte(u,e.adler&255),put_byte(u,e.adler>>8&255),e.adler=0,u.status=BUSY_STATE)):u.status=BUSY_STATE),u.pending!==0){if(flush_pending(e),e.avail_out===0)return u.last_flush=-1,Z_OK$3}else if(e.avail_in===0&&rank(r)<=rank(f)&&r!==Z_FINISH$3)return err(e,Z_BUF_ERROR$1);if(u.status===FINISH_STATE&&e.avail_in!==0)return err(e,Z_BUF_ERROR$1);if(e.avail_in!==0||u.lookahead!==0||r!==Z_NO_FLUSH$2&&u.status!==FINISH_STATE){let _=u.strategy===Z_HUFFMAN_ONLY?deflate_huff(u,r):u.strategy===Z_RLE?deflate_rle(u,r):configuration_table[u.level].func(u,r);if((_===BS_FINISH_STARTED||_===BS_FINISH_DONE)&&(u.status=FINISH_STATE),_===BS_NEED_MORE||_===BS_FINISH_STARTED)return e.avail_out===0&&(u.last_flush=-1),Z_OK$3;if(_===BS_BLOCK_DONE&&(r===Z_PARTIAL_FLUSH?_tr_align(u):r!==Z_BLOCK$1&&(_tr_stored_block(u,0,0,!1),r===Z_FULL_FLUSH$1&&(zero(u.head),u.lookahead===0&&(u.strstart=0,u.block_start=0,u.insert=0))),flush_pending(e),e.avail_out===0))return u.last_flush=-1,Z_OK$3}return r!==Z_FINISH$3?Z_OK$3:u.wrap<=0?Z_STREAM_END$3:(u.wrap===2?(put_byte(u,e.adler&255),put_byte(u,e.adler>>8&255),put_byte(u,e.adler>>16&255),put_byte(u,e.adler>>24&255),put_byte(u,e.total_in&255),put_byte(u,e.total_in>>8&255),put_byte(u,e.total_in>>16&255),put_byte(u,e.total_in>>24&255)):(putShortMSB(u,e.adler>>>16),putShortMSB(u,e.adler&65535)),flush_pending(e),u.wrap>0&&(u.wrap=-u.wrap),u.pending!==0?Z_OK$3:Z_STREAM_END$3)},deflateEnd=e=>{if(!e||!e.state)return Z_STREAM_ERROR$2;const r=e.state.status;return r!==INIT_STATE&&r!==EXTRA_STATE&&r!==NAME_STATE&&r!==COMMENT_STATE&&r!==HCRC_STATE&&r!==BUSY_STATE&&r!==FINISH_STATE?err(e,Z_STREAM_ERROR$2):(e.state=null,r===BUSY_STATE?err(e,Z_DATA_ERROR$2):Z_OK$3)},deflateSetDictionary=(e,r)=>{let n=r.length;if(!e||!e.state)return Z_STREAM_ERROR$2;const a=e.state,u=a.wrap;if(u===2||u===1&&a.status!==INIT_STATE||a.lookahead)return Z_STREAM_ERROR$2;if(u===1&&(e.adler=adler32_1(e.adler,r,n,0)),a.wrap=0,n>=a.w_size){u===0&&(zero(a.head),a.strstart=0,a.block_start=0,a.insert=0);let b=new Uint8Array(a.w_size);b.set(r.subarray(n-a.w_size,n),0),r=b,n=a.w_size}const f=e.avail_in,_=e.next_in,o=e.input;for(e.avail_in=n,e.next_in=0,e.input=r,fill_window(a);a.lookahead>=MIN_MATCH;){let b=a.strstart,E=a.lookahead-(MIN_MATCH-1);do a.ins_h=HASH(a,a.ins_h,a.window[b+MIN_MATCH-1]),a.prev[b&a.w_mask]=a.head[a.ins_h],a.head[a.ins_h]=b,b++;while(--E);a.strstart=b,a.lookahead=MIN_MATCH-1,fill_window(a)}return a.strstart+=a.lookahead,a.block_start=a.strstart,a.insert=a.lookahead,a.lookahead=0,a.match_length=a.prev_length=MIN_MATCH-1,a.match_available=0,e.next_in=_,e.input=o,e.avail_in=f,a.wrap=u,Z_OK$3};var deflateInit_1=deflateInit,deflateInit2_1=deflateInit2,deflateReset_1=deflateReset,deflateResetKeep_1=deflateResetKeep,deflateSetHeader_1=deflateSetHeader,deflate_2$1=deflate$2,deflateEnd_1=deflateEnd,deflateSetDictionary_1=deflateSetDictionary,deflateInfo="pako deflate (from Nodeca project)",deflate_1$2={deflateInit:deflateInit_1,deflateInit2:deflateInit2_1,deflateReset:deflateReset_1,deflateResetKeep:deflateResetKeep_1,deflateSetHeader:deflateSetHeader_1,deflate:deflate_2$1,deflateEnd:deflateEnd_1,deflateSetDictionary:deflateSetDictionary_1,deflateInfo};const _has=(e,r)=>Object.prototype.hasOwnProperty.call(e,r);var assign=function(e){const r=Array.prototype.slice.call(arguments,1);for(;r.length;){const n=r.shift();if(!!n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const a in n)_has(n,a)&&(e[a]=n[a])}}return e},flattenChunks=e=>{let r=0;for(let a=0,u=e.length;a<u;a++)r+=e[a].length;const n=new Uint8Array(r);for(let a=0,u=0,f=e.length;a<f;a++){let _=e[a];n.set(_,u),u+=_.length}return n},common={assign,flattenChunks};let STR_APPLY_UIA_OK=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{STR_APPLY_UIA_OK=!1}const _utf8len=new Uint8Array(256);for(let e=0;e<256;e++)_utf8len[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let r,n,a,u,f,_=e.length,o=0;for(u=0;u<_;u++)n=e.charCodeAt(u),(n&64512)===55296&&u+1<_&&(a=e.charCodeAt(u+1),(a&64512)===56320&&(n=65536+(n-55296<<10)+(a-56320),u++)),o+=n<128?1:n<2048?2:n<65536?3:4;for(r=new Uint8Array(o),f=0,u=0;f<o;u++)n=e.charCodeAt(u),(n&64512)===55296&&u+1<_&&(a=e.charCodeAt(u+1),(a&64512)===56320&&(n=65536+(n-55296<<10)+(a-56320),u++)),n<128?r[f++]=n:n<2048?(r[f++]=192|n>>>6,r[f++]=128|n&63):n<65536?(r[f++]=224|n>>>12,r[f++]=128|n>>>6&63,r[f++]=128|n&63):(r[f++]=240|n>>>18,r[f++]=128|n>>>12&63,r[f++]=128|n>>>6&63,r[f++]=128|n&63);return r};const buf2binstring=(e,r)=>{if(r<65534&&e.subarray&&STR_APPLY_UIA_OK)return String.fromCharCode.apply(null,e.length===r?e:e.subarray(0,r));let n="";for(let a=0;a<r;a++)n+=String.fromCharCode(e[a]);return n};var buf2string=(e,r)=>{const n=r||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,r));let a,u;const f=new Array(n*2);for(u=0,a=0;a<n;){let _=e[a++];if(_<128){f[u++]=_;continue}let o=_utf8len[_];if(o>4){f[u++]=65533,a+=o-1;continue}for(_&=o===2?31:o===3?15:7;o>1&&a<n;)_=_<<6|e[a++]&63,o--;if(o>1){f[u++]=65533;continue}_<65536?f[u++]=_:(_-=65536,f[u++]=55296|_>>10&1023,f[u++]=56320|_&1023)}return buf2binstring(f,u)},utf8border=(e,r)=>{r=r||e.length,r>e.length&&(r=e.length);let n=r-1;for(;n>=0&&(e[n]&192)===128;)n--;return n<0||n===0?r:n+_utf8len[e[n]]>r?n:r},strings={string2buf,buf2string,utf8border};function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var zstream=ZStream;const toString$1$1=Object.prototype.toString,{Z_NO_FLUSH:Z_NO_FLUSH$1,Z_SYNC_FLUSH,Z_FULL_FLUSH,Z_FINISH:Z_FINISH$2,Z_OK:Z_OK$2,Z_STREAM_END:Z_STREAM_END$2,Z_DEFAULT_COMPRESSION,Z_DEFAULT_STRATEGY,Z_DEFLATED:Z_DEFLATED$1}=constants$2$1;function Deflate$1(e){this.options=common.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED$1,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY},e||{});let r=this.options;r.raw&&r.windowBits>0?r.windowBits=-r.windowBits:r.gzip&&r.windowBits>0&&r.windowBits<16&&(r.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let n=deflate_1$2.deflateInit2(this.strm,r.level,r.method,r.windowBits,r.memLevel,r.strategy);if(n!==Z_OK$2)throw new Error(messages[n]);if(r.header&&deflate_1$2.deflateSetHeader(this.strm,r.header),r.dictionary){let a;if(typeof r.dictionary=="string"?a=strings.string2buf(r.dictionary):toString$1$1.call(r.dictionary)==="[object ArrayBuffer]"?a=new Uint8Array(r.dictionary):a=r.dictionary,n=deflate_1$2.deflateSetDictionary(this.strm,a),n!==Z_OK$2)throw new Error(messages[n]);this._dict_set=!0}}Deflate$1.prototype.push=function(e,r){const n=this.strm,a=this.options.chunkSize;let u,f;if(this.ended)return!1;for(r===~~r?f=r:f=r===!0?Z_FINISH$2:Z_NO_FLUSH$1,typeof e=="string"?n.input=strings.string2buf(e):toString$1$1.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){if(n.avail_out===0&&(n.output=new Uint8Array(a),n.next_out=0,n.avail_out=a),(f===Z_SYNC_FLUSH||f===Z_FULL_FLUSH)&&n.avail_out<=6){this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;continue}if(u=deflate_1$2.deflate(n,f),u===Z_STREAM_END$2)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),u=deflate_1$2.deflateEnd(this.strm),this.onEnd(u),this.ended=!0,u===Z_OK$2;if(n.avail_out===0){this.onData(n.output);continue}if(f>0&&n.next_out>0){this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;continue}if(n.avail_in===0)break}return!0};Deflate$1.prototype.onData=function(e){this.chunks.push(e)};Deflate$1.prototype.onEnd=function(e){e===Z_OK$2&&(this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function deflate$1(e,r){const n=new Deflate$1(r);if(n.push(e,!0),n.err)throw n.msg||messages[n.err];return n.result}function deflateRaw$1(e,r){return r=r||{},r.raw=!0,deflate$1(e,r)}function gzip$1(e,r){return r=r||{},r.gzip=!0,deflate$1(e,r)}var Deflate_1$1=Deflate$1,deflate_2=deflate$1,deflateRaw_1$1=deflateRaw$1,gzip_1$1=gzip$1,constants$1$1=constants$2$1,deflate_1$1={Deflate:Deflate_1$1,deflate:deflate_2,deflateRaw:deflateRaw_1$1,gzip:gzip_1$1,constants:constants$1$1};const BAD$1=30,TYPE$1=12;var inffast=function(r,n){let a,u,f,_,o,b,E,M,P,L,D,U,X,K,q,oe,W,Y,J,Ee,xe,se,ce,ee;const he=r.state;a=r.next_in,ce=r.input,u=a+(r.avail_in-5),f=r.next_out,ee=r.output,_=f-(n-r.avail_out),o=f+(r.avail_out-257),b=he.dmax,E=he.wsize,M=he.whave,P=he.wnext,L=he.window,D=he.hold,U=he.bits,X=he.lencode,K=he.distcode,q=(1<<he.lenbits)-1,oe=(1<<he.distbits)-1;e:do{U<15&&(D+=ce[a++]<<U,U+=8,D+=ce[a++]<<U,U+=8),W=X[D&q];t:for(;;){if(Y=W>>>24,D>>>=Y,U-=Y,Y=W>>>16&255,Y===0)ee[f++]=W&65535;else if(Y&16){J=W&65535,Y&=15,Y&&(U<Y&&(D+=ce[a++]<<U,U+=8),J+=D&(1<<Y)-1,D>>>=Y,U-=Y),U<15&&(D+=ce[a++]<<U,U+=8,D+=ce[a++]<<U,U+=8),W=K[D&oe];i:for(;;){if(Y=W>>>24,D>>>=Y,U-=Y,Y=W>>>16&255,Y&16){if(Ee=W&65535,Y&=15,U<Y&&(D+=ce[a++]<<U,U+=8,U<Y&&(D+=ce[a++]<<U,U+=8)),Ee+=D&(1<<Y)-1,Ee>b){r.msg="invalid distance too far back",he.mode=BAD$1;break e}if(D>>>=Y,U-=Y,Y=f-_,Ee>Y){if(Y=Ee-Y,Y>M&&he.sane){r.msg="invalid distance too far back",he.mode=BAD$1;break e}if(xe=0,se=L,P===0){if(xe+=E-Y,Y<J){J-=Y;do ee[f++]=L[xe++];while(--Y);xe=f-Ee,se=ee}}else if(P<Y){if(xe+=E+P-Y,Y-=P,Y<J){J-=Y;do ee[f++]=L[xe++];while(--Y);if(xe=0,P<J){Y=P,J-=Y;do ee[f++]=L[xe++];while(--Y);xe=f-Ee,se=ee}}}else if(xe+=P-Y,Y<J){J-=Y;do ee[f++]=L[xe++];while(--Y);xe=f-Ee,se=ee}for(;J>2;)ee[f++]=se[xe++],ee[f++]=se[xe++],ee[f++]=se[xe++],J-=3;J&&(ee[f++]=se[xe++],J>1&&(ee[f++]=se[xe++]))}else{xe=f-Ee;do ee[f++]=ee[xe++],ee[f++]=ee[xe++],ee[f++]=ee[xe++],J-=3;while(J>2);J&&(ee[f++]=ee[xe++],J>1&&(ee[f++]=ee[xe++]))}}else if((Y&64)===0){W=K[(W&65535)+(D&(1<<Y)-1)];continue i}else{r.msg="invalid distance code",he.mode=BAD$1;break e}break}}else if((Y&64)===0){W=X[(W&65535)+(D&(1<<Y)-1)];continue t}else if(Y&32){he.mode=TYPE$1;break e}else{r.msg="invalid literal/length code",he.mode=BAD$1;break e}break}}while(a<u&&f<o);J=U>>3,a-=J,U-=J<<3,D&=(1<<U)-1,r.next_in=a,r.next_out=f,r.avail_in=a<u?5+(u-a):5-(a-u),r.avail_out=f<o?257+(o-f):257-(f-o),he.hold=D,he.bits=U};const MAXBITS=15,ENOUGH_LENS$1=852,ENOUGH_DISTS$1=592,CODES$1=0,LENS$1=1,DISTS$1=2,lbase=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),lext=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),dbase=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),dext=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),inflate_table=(e,r,n,a,u,f,_,o)=>{const b=o.bits;let E=0,M=0,P=0,L=0,D=0,U=0,X=0,K=0,q=0,oe=0,W,Y,J,Ee,xe,se=null,ce=0,ee;const he=new Uint16Array(MAXBITS+1),Ie=new Uint16Array(MAXBITS+1);let Pe=null,Qe=0,We,Zt,ti;for(E=0;E<=MAXBITS;E++)he[E]=0;for(M=0;M<a;M++)he[r[n+M]]++;for(D=b,L=MAXBITS;L>=1&&he[L]===0;L--);if(D>L&&(D=L),L===0)return u[f++]=1<<24|64<<16|0,u[f++]=1<<24|64<<16|0,o.bits=1,0;for(P=1;P<L&&he[P]===0;P++);for(D<P&&(D=P),K=1,E=1;E<=MAXBITS;E++)if(K<<=1,K-=he[E],K<0)return-1;if(K>0&&(e===CODES$1||L!==1))return-1;for(Ie[1]=0,E=1;E<MAXBITS;E++)Ie[E+1]=Ie[E]+he[E];for(M=0;M<a;M++)r[n+M]!==0&&(_[Ie[r[n+M]]++]=M);if(e===CODES$1?(se=Pe=_,ee=19):e===LENS$1?(se=lbase,ce-=257,Pe=lext,Qe-=257,ee=256):(se=dbase,Pe=dext,ee=-1),oe=0,M=0,E=P,xe=f,U=D,X=0,J=-1,q=1<<D,Ee=q-1,e===LENS$1&&q>ENOUGH_LENS$1||e===DISTS$1&&q>ENOUGH_DISTS$1)return 1;for(;;){We=E-X,_[M]<ee?(Zt=0,ti=_[M]):_[M]>ee?(Zt=Pe[Qe+_[M]],ti=se[ce+_[M]]):(Zt=32+64,ti=0),W=1<<E-X,Y=1<<U,P=Y;do Y-=W,u[xe+(oe>>X)+Y]=We<<24|Zt<<16|ti|0;while(Y!==0);for(W=1<<E-1;oe&W;)W>>=1;if(W!==0?(oe&=W-1,oe+=W):oe=0,M++,--he[E]===0){if(E===L)break;E=r[n+_[M]]}if(E>D&&(oe&Ee)!==J){for(X===0&&(X=D),xe+=P,U=E-X,K=1<<U;U+X<L&&(K-=he[U+X],!(K<=0));)U++,K<<=1;if(q+=1<<U,e===LENS$1&&q>ENOUGH_LENS$1||e===DISTS$1&&q>ENOUGH_DISTS$1)return 1;J=oe&Ee,u[J]=D<<24|U<<16|xe-f|0}}return oe!==0&&(u[xe+oe]=E-X<<24|64<<16|0),o.bits=D,0};var inftrees=inflate_table;const CODES=0,LENS=1,DISTS=2,{Z_FINISH:Z_FINISH$1,Z_BLOCK,Z_TREES,Z_OK:Z_OK$1,Z_STREAM_END:Z_STREAM_END$1,Z_NEED_DICT:Z_NEED_DICT$1,Z_STREAM_ERROR:Z_STREAM_ERROR$1,Z_DATA_ERROR:Z_DATA_ERROR$1,Z_MEM_ERROR:Z_MEM_ERROR$1,Z_BUF_ERROR,Z_DEFLATED}=constants$2$1,HEAD=1,FLAGS=2,TIME=3,OS=4,EXLEN=5,EXTRA=6,NAME=7,COMMENT=8,HCRC=9,DICTID=10,DICT=11,TYPE=12,TYPEDO=13,STORED=14,COPY_=15,COPY=16,TABLE=17,LENLENS=18,CODELENS=19,LEN_=20,LEN=21,LENEXT=22,DIST=23,DISTEXT=24,MATCH=25,LIT=26,CHECK=27,LENGTH=28,DONE=29,BAD=30,MEM=31,SYNC=32,ENOUGH_LENS=852,ENOUGH_DISTS=592,MAX_WBITS=15,DEF_WBITS=MAX_WBITS,zswap32=e=>(e>>>24&255)+(e>>>8&65280)+((e&65280)<<8)+((e&255)<<24);function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const inflateResetKeep=e=>{if(!e||!e.state)return Z_STREAM_ERROR$1;const r=e.state;return e.total_in=e.total_out=r.total=0,e.msg="",r.wrap&&(e.adler=r.wrap&1),r.mode=HEAD,r.last=0,r.havedict=0,r.dmax=32768,r.head=null,r.hold=0,r.bits=0,r.lencode=r.lendyn=new Int32Array(ENOUGH_LENS),r.distcode=r.distdyn=new Int32Array(ENOUGH_DISTS),r.sane=1,r.back=-1,Z_OK$1},inflateReset=e=>{if(!e||!e.state)return Z_STREAM_ERROR$1;const r=e.state;return r.wsize=0,r.whave=0,r.wnext=0,inflateResetKeep(e)},inflateReset2=(e,r)=>{let n;if(!e||!e.state)return Z_STREAM_ERROR$1;const a=e.state;return r<0?(n=0,r=-r):(n=(r>>4)+1,r<48&&(r&=15)),r&&(r<8||r>15)?Z_STREAM_ERROR$1:(a.window!==null&&a.wbits!==r&&(a.window=null),a.wrap=n,a.wbits=r,inflateReset(e))},inflateInit2=(e,r)=>{if(!e)return Z_STREAM_ERROR$1;const n=new InflateState;e.state=n,n.window=null;const a=inflateReset2(e,r);return a!==Z_OK$1&&(e.state=null),a},inflateInit=e=>inflateInit2(e,DEF_WBITS);let virgin=!0,lenfix,distfix;const fixedtables=e=>{if(virgin){lenfix=new Int32Array(512),distfix=new Int32Array(32);let r=0;for(;r<144;)e.lens[r++]=8;for(;r<256;)e.lens[r++]=9;for(;r<280;)e.lens[r++]=7;for(;r<288;)e.lens[r++]=8;for(inftrees(LENS,e.lens,0,288,lenfix,0,e.work,{bits:9}),r=0;r<32;)e.lens[r++]=5;inftrees(DISTS,e.lens,0,32,distfix,0,e.work,{bits:5}),virgin=!1}e.lencode=lenfix,e.lenbits=9,e.distcode=distfix,e.distbits=5},updatewindow=(e,r,n,a)=>{let u;const f=e.state;return f.window===null&&(f.wsize=1<<f.wbits,f.wnext=0,f.whave=0,f.window=new Uint8Array(f.wsize)),a>=f.wsize?(f.window.set(r.subarray(n-f.wsize,n),0),f.wnext=0,f.whave=f.wsize):(u=f.wsize-f.wnext,u>a&&(u=a),f.window.set(r.subarray(n-a,n-a+u),f.wnext),a-=u,a?(f.window.set(r.subarray(n-a,n),0),f.wnext=a,f.whave=f.wsize):(f.wnext+=u,f.wnext===f.wsize&&(f.wnext=0),f.whave<f.wsize&&(f.whave+=u))),0},inflate$2=(e,r)=>{let n,a,u,f,_,o,b,E,M,P,L,D,U,X,K=0,q,oe,W,Y,J,Ee,xe,se;const ce=new Uint8Array(4);let ee,he;const Ie=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!e||!e.state||!e.output||!e.input&&e.avail_in!==0)return Z_STREAM_ERROR$1;n=e.state,n.mode===TYPE&&(n.mode=TYPEDO),_=e.next_out,u=e.output,b=e.avail_out,f=e.next_in,a=e.input,o=e.avail_in,E=n.hold,M=n.bits,P=o,L=b,se=Z_OK$1;e:for(;;)switch(n.mode){case HEAD:if(n.wrap===0){n.mode=TYPEDO;break}for(;M<16;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if(n.wrap&2&&E===35615){n.check=0,ce[0]=E&255,ce[1]=E>>>8&255,n.check=crc32_1(n.check,ce,2,0),E=0,M=0,n.mode=FLAGS;break}if(n.flags=0,n.head&&(n.head.done=!1),!(n.wrap&1)||(((E&255)<<8)+(E>>8))%31){e.msg="incorrect header check",n.mode=BAD;break}if((E&15)!==Z_DEFLATED){e.msg="unknown compression method",n.mode=BAD;break}if(E>>>=4,M-=4,xe=(E&15)+8,n.wbits===0)n.wbits=xe;else if(xe>n.wbits){e.msg="invalid window size",n.mode=BAD;break}n.dmax=1<<n.wbits,e.adler=n.check=1,n.mode=E&512?DICTID:TYPE,E=0,M=0;break;case FLAGS:for(;M<16;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if(n.flags=E,(n.flags&255)!==Z_DEFLATED){e.msg="unknown compression method",n.mode=BAD;break}if(n.flags&57344){e.msg="unknown header flags set",n.mode=BAD;break}n.head&&(n.head.text=E>>8&1),n.flags&512&&(ce[0]=E&255,ce[1]=E>>>8&255,n.check=crc32_1(n.check,ce,2,0)),E=0,M=0,n.mode=TIME;case TIME:for(;M<32;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}n.head&&(n.head.time=E),n.flags&512&&(ce[0]=E&255,ce[1]=E>>>8&255,ce[2]=E>>>16&255,ce[3]=E>>>24&255,n.check=crc32_1(n.check,ce,4,0)),E=0,M=0,n.mode=OS;case OS:for(;M<16;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}n.head&&(n.head.xflags=E&255,n.head.os=E>>8),n.flags&512&&(ce[0]=E&255,ce[1]=E>>>8&255,n.check=crc32_1(n.check,ce,2,0)),E=0,M=0,n.mode=EXLEN;case EXLEN:if(n.flags&1024){for(;M<16;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}n.length=E,n.head&&(n.head.extra_len=E),n.flags&512&&(ce[0]=E&255,ce[1]=E>>>8&255,n.check=crc32_1(n.check,ce,2,0)),E=0,M=0}else n.head&&(n.head.extra=null);n.mode=EXTRA;case EXTRA:if(n.flags&1024&&(D=n.length,D>o&&(D=o),D&&(n.head&&(xe=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(a.subarray(f,f+D),xe)),n.flags&512&&(n.check=crc32_1(n.check,a,D,f)),o-=D,f+=D,n.length-=D),n.length))break e;n.length=0,n.mode=NAME;case NAME:if(n.flags&2048){if(o===0)break e;D=0;do xe=a[f+D++],n.head&&xe&&n.length<65536&&(n.head.name+=String.fromCharCode(xe));while(xe&&D<o);if(n.flags&512&&(n.check=crc32_1(n.check,a,D,f)),o-=D,f+=D,xe)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=COMMENT;case COMMENT:if(n.flags&4096){if(o===0)break e;D=0;do xe=a[f+D++],n.head&&xe&&n.length<65536&&(n.head.comment+=String.fromCharCode(xe));while(xe&&D<o);if(n.flags&512&&(n.check=crc32_1(n.check,a,D,f)),o-=D,f+=D,xe)break e}else n.head&&(n.head.comment=null);n.mode=HCRC;case HCRC:if(n.flags&512){for(;M<16;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if(E!==(n.check&65535)){e.msg="header crc mismatch",n.mode=BAD;break}E=0,M=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=TYPE;break;case DICTID:for(;M<32;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}e.adler=n.check=zswap32(E),E=0,M=0,n.mode=DICT;case DICT:if(n.havedict===0)return e.next_out=_,e.avail_out=b,e.next_in=f,e.avail_in=o,n.hold=E,n.bits=M,Z_NEED_DICT$1;e.adler=n.check=1,n.mode=TYPE;case TYPE:if(r===Z_BLOCK||r===Z_TREES)break e;case TYPEDO:if(n.last){E>>>=M&7,M-=M&7,n.mode=CHECK;break}for(;M<3;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}switch(n.last=E&1,E>>>=1,M-=1,E&3){case 0:n.mode=STORED;break;case 1:if(fixedtables(n),n.mode=LEN_,r===Z_TREES){E>>>=2,M-=2;break e}break;case 2:n.mode=TABLE;break;case 3:e.msg="invalid block type",n.mode=BAD}E>>>=2,M-=2;break;case STORED:for(E>>>=M&7,M-=M&7;M<32;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if((E&65535)!==(E>>>16^65535)){e.msg="invalid stored block lengths",n.mode=BAD;break}if(n.length=E&65535,E=0,M=0,n.mode=COPY_,r===Z_TREES)break e;case COPY_:n.mode=COPY;case COPY:if(D=n.length,D){if(D>o&&(D=o),D>b&&(D=b),D===0)break e;u.set(a.subarray(f,f+D),_),o-=D,f+=D,b-=D,_+=D,n.length-=D;break}n.mode=TYPE;break;case TABLE:for(;M<14;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if(n.nlen=(E&31)+257,E>>>=5,M-=5,n.ndist=(E&31)+1,E>>>=5,M-=5,n.ncode=(E&15)+4,E>>>=4,M-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=BAD;break}n.have=0,n.mode=LENLENS;case LENLENS:for(;n.have<n.ncode;){for(;M<3;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}n.lens[Ie[n.have++]]=E&7,E>>>=3,M-=3}for(;n.have<19;)n.lens[Ie[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,ee={bits:n.lenbits},se=inftrees(CODES,n.lens,0,19,n.lencode,0,n.work,ee),n.lenbits=ee.bits,se){e.msg="invalid code lengths set",n.mode=BAD;break}n.have=0,n.mode=CODELENS;case CODELENS:for(;n.have<n.nlen+n.ndist;){for(;K=n.lencode[E&(1<<n.lenbits)-1],q=K>>>24,oe=K>>>16&255,W=K&65535,!(q<=M);){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if(W<16)E>>>=q,M-=q,n.lens[n.have++]=W;else{if(W===16){for(he=q+2;M<he;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if(E>>>=q,M-=q,n.have===0){e.msg="invalid bit length repeat",n.mode=BAD;break}xe=n.lens[n.have-1],D=3+(E&3),E>>>=2,M-=2}else if(W===17){for(he=q+3;M<he;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}E>>>=q,M-=q,xe=0,D=3+(E&7),E>>>=3,M-=3}else{for(he=q+7;M<he;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}E>>>=q,M-=q,xe=0,D=11+(E&127),E>>>=7,M-=7}if(n.have+D>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=BAD;break}for(;D--;)n.lens[n.have++]=xe}}if(n.mode===BAD)break;if(n.lens[256]===0){e.msg="invalid code -- missing end-of-block",n.mode=BAD;break}if(n.lenbits=9,ee={bits:n.lenbits},se=inftrees(LENS,n.lens,0,n.nlen,n.lencode,0,n.work,ee),n.lenbits=ee.bits,se){e.msg="invalid literal/lengths set",n.mode=BAD;break}if(n.distbits=6,n.distcode=n.distdyn,ee={bits:n.distbits},se=inftrees(DISTS,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,ee),n.distbits=ee.bits,se){e.msg="invalid distances set",n.mode=BAD;break}if(n.mode=LEN_,r===Z_TREES)break e;case LEN_:n.mode=LEN;case LEN:if(o>=6&&b>=258){e.next_out=_,e.avail_out=b,e.next_in=f,e.avail_in=o,n.hold=E,n.bits=M,inffast(e,L),_=e.next_out,u=e.output,b=e.avail_out,f=e.next_in,a=e.input,o=e.avail_in,E=n.hold,M=n.bits,n.mode===TYPE&&(n.back=-1);break}for(n.back=0;K=n.lencode[E&(1<<n.lenbits)-1],q=K>>>24,oe=K>>>16&255,W=K&65535,!(q<=M);){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if(oe&&(oe&240)===0){for(Y=q,J=oe,Ee=W;K=n.lencode[Ee+((E&(1<<Y+J)-1)>>Y)],q=K>>>24,oe=K>>>16&255,W=K&65535,!(Y+q<=M);){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}E>>>=Y,M-=Y,n.back+=Y}if(E>>>=q,M-=q,n.back+=q,n.length=W,oe===0){n.mode=LIT;break}if(oe&32){n.back=-1,n.mode=TYPE;break}if(oe&64){e.msg="invalid literal/length code",n.mode=BAD;break}n.extra=oe&15,n.mode=LENEXT;case LENEXT:if(n.extra){for(he=n.extra;M<he;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}n.length+=E&(1<<n.extra)-1,E>>>=n.extra,M-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=DIST;case DIST:for(;K=n.distcode[E&(1<<n.distbits)-1],q=K>>>24,oe=K>>>16&255,W=K&65535,!(q<=M);){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if((oe&240)===0){for(Y=q,J=oe,Ee=W;K=n.distcode[Ee+((E&(1<<Y+J)-1)>>Y)],q=K>>>24,oe=K>>>16&255,W=K&65535,!(Y+q<=M);){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}E>>>=Y,M-=Y,n.back+=Y}if(E>>>=q,M-=q,n.back+=q,oe&64){e.msg="invalid distance code",n.mode=BAD;break}n.offset=W,n.extra=oe&15,n.mode=DISTEXT;case DISTEXT:if(n.extra){for(he=n.extra;M<he;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}n.offset+=E&(1<<n.extra)-1,E>>>=n.extra,M-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=BAD;break}n.mode=MATCH;case MATCH:if(b===0)break e;if(D=L-b,n.offset>D){if(D=n.offset-D,D>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=BAD;break}D>n.wnext?(D-=n.wnext,U=n.wsize-D):U=n.wnext-D,D>n.length&&(D=n.length),X=n.window}else X=u,U=_-n.offset,D=n.length;D>b&&(D=b),b-=D,n.length-=D;do u[_++]=X[U++];while(--D);n.length===0&&(n.mode=LEN);break;case LIT:if(b===0)break e;u[_++]=n.length,b--,n.mode=LEN;break;case CHECK:if(n.wrap){for(;M<32;){if(o===0)break e;o--,E|=a[f++]<<M,M+=8}if(L-=b,e.total_out+=L,n.total+=L,L&&(e.adler=n.check=n.flags?crc32_1(n.check,u,L,_-L):adler32_1(n.check,u,L,_-L)),L=b,(n.flags?E:zswap32(E))!==n.check){e.msg="incorrect data check",n.mode=BAD;break}E=0,M=0}n.mode=LENGTH;case LENGTH:if(n.wrap&&n.flags){for(;M<32;){if(o===0)break e;o--,E+=a[f++]<<M,M+=8}if(E!==(n.total&4294967295)){e.msg="incorrect length check",n.mode=BAD;break}E=0,M=0}n.mode=DONE;case DONE:se=Z_STREAM_END$1;break e;case BAD:se=Z_DATA_ERROR$1;break e;case MEM:return Z_MEM_ERROR$1;case SYNC:default:return Z_STREAM_ERROR$1}return e.next_out=_,e.avail_out=b,e.next_in=f,e.avail_in=o,n.hold=E,n.bits=M,(n.wsize||L!==e.avail_out&&n.mode<BAD&&(n.mode<CHECK||r!==Z_FINISH$1))&&updatewindow(e,e.output,e.next_out,L-e.avail_out),P-=e.avail_in,L-=e.avail_out,e.total_in+=P,e.total_out+=L,n.total+=L,n.wrap&&L&&(e.adler=n.check=n.flags?crc32_1(n.check,u,L,e.next_out-L):adler32_1(n.check,u,L,e.next_out-L)),e.data_type=n.bits+(n.last?64:0)+(n.mode===TYPE?128:0)+(n.mode===LEN_||n.mode===COPY_?256:0),(P===0&&L===0||r===Z_FINISH$1)&&se===Z_OK$1&&(se=Z_BUF_ERROR),se},inflateEnd=e=>{if(!e||!e.state)return Z_STREAM_ERROR$1;let r=e.state;return r.window&&(r.window=null),e.state=null,Z_OK$1},inflateGetHeader=(e,r)=>{if(!e||!e.state)return Z_STREAM_ERROR$1;const n=e.state;return(n.wrap&2)===0?Z_STREAM_ERROR$1:(n.head=r,r.done=!1,Z_OK$1)},inflateSetDictionary=(e,r)=>{const n=r.length;let a,u,f;return!e||!e.state||(a=e.state,a.wrap!==0&&a.mode!==DICT)?Z_STREAM_ERROR$1:a.mode===DICT&&(u=1,u=adler32_1(u,r,n,0),u!==a.check)?Z_DATA_ERROR$1:(f=updatewindow(e,r,n,n),f?(a.mode=MEM,Z_MEM_ERROR$1):(a.havedict=1,Z_OK$1))};var inflateReset_1=inflateReset,inflateReset2_1=inflateReset2,inflateResetKeep_1=inflateResetKeep,inflateInit_1=inflateInit,inflateInit2_1=inflateInit2,inflate_2$1=inflate$2,inflateEnd_1=inflateEnd,inflateGetHeader_1=inflateGetHeader,inflateSetDictionary_1=inflateSetDictionary,inflateInfo="pako inflate (from Nodeca project)",inflate_1$2={inflateReset:inflateReset_1,inflateReset2:inflateReset2_1,inflateResetKeep:inflateResetKeep_1,inflateInit:inflateInit_1,inflateInit2:inflateInit2_1,inflate:inflate_2$1,inflateEnd:inflateEnd_1,inflateGetHeader:inflateGetHeader_1,inflateSetDictionary:inflateSetDictionary_1,inflateInfo};function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var gzheader=GZheader;const toString$3=Object.prototype.toString,{Z_NO_FLUSH,Z_FINISH,Z_OK,Z_STREAM_END,Z_NEED_DICT,Z_STREAM_ERROR,Z_DATA_ERROR,Z_MEM_ERROR}=constants$2$1;function Inflate$1(e){this.options=common.assign({chunkSize:1024*64,windowBits:15,to:""},e||{});const r=this.options;r.raw&&r.windowBits>=0&&r.windowBits<16&&(r.windowBits=-r.windowBits,r.windowBits===0&&(r.windowBits=-15)),r.windowBits>=0&&r.windowBits<16&&!(e&&e.windowBits)&&(r.windowBits+=32),r.windowBits>15&&r.windowBits<48&&(r.windowBits&15)===0&&(r.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let n=inflate_1$2.inflateInit2(this.strm,r.windowBits);if(n!==Z_OK)throw new Error(messages[n]);if(this.header=new gzheader,inflate_1$2.inflateGetHeader(this.strm,this.header),r.dictionary&&(typeof r.dictionary=="string"?r.dictionary=strings.string2buf(r.dictionary):toString$3.call(r.dictionary)==="[object ArrayBuffer]"&&(r.dictionary=new Uint8Array(r.dictionary)),r.raw&&(n=inflate_1$2.inflateSetDictionary(this.strm,r.dictionary),n!==Z_OK)))throw new Error(messages[n])}Inflate$1.prototype.push=function(e,r){const n=this.strm,a=this.options.chunkSize,u=this.options.dictionary;let f,_,o;if(this.ended)return!1;for(r===~~r?_=r:_=r===!0?Z_FINISH:Z_NO_FLUSH,toString$3.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(a),n.next_out=0,n.avail_out=a),f=inflate_1$2.inflate(n,_),f===Z_NEED_DICT&&u&&(f=inflate_1$2.inflateSetDictionary(n,u),f===Z_OK?f=inflate_1$2.inflate(n,_):f===Z_DATA_ERROR&&(f=Z_NEED_DICT));n.avail_in>0&&f===Z_STREAM_END&&n.state.wrap>0&&e[n.next_in]!==0;)inflate_1$2.inflateReset(n),f=inflate_1$2.inflate(n,_);switch(f){case Z_STREAM_ERROR:case Z_DATA_ERROR:case Z_NEED_DICT:case Z_MEM_ERROR:return this.onEnd(f),this.ended=!0,!1}if(o=n.avail_out,n.next_out&&(n.avail_out===0||f===Z_STREAM_END))if(this.options.to==="string"){let b=strings.utf8border(n.output,n.next_out),E=n.next_out-b,M=strings.buf2string(n.output,b);n.next_out=E,n.avail_out=a-E,E&&n.output.set(n.output.subarray(b,b+E),0),this.onData(M)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(!(f===Z_OK&&o===0)){if(f===Z_STREAM_END)return f=inflate_1$2.inflateEnd(this.strm),this.onEnd(f),this.ended=!0,!0;if(n.avail_in===0)break}}return!0};Inflate$1.prototype.onData=function(e){this.chunks.push(e)};Inflate$1.prototype.onEnd=function(e){e===Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function inflate$1(e,r){const n=new Inflate$1(r);if(n.push(e),n.err)throw n.msg||messages[n.err];return n.result}function inflateRaw$1(e,r){return r=r||{},r.raw=!0,inflate$1(e,r)}var Inflate_1$1=Inflate$1,inflate_2=inflate$1,inflateRaw_1$1=inflateRaw$1,ungzip$1=inflate$1,constants$5=constants$2$1,inflate_1$1={Inflate:Inflate_1$1,inflate:inflate_2,inflateRaw:inflateRaw_1$1,ungzip:ungzip$1,constants:constants$5};const{Deflate,deflate,deflateRaw,gzip}=deflate_1$1,{Inflate,inflate,inflateRaw,ungzip}=inflate_1$1;var deflate_1=deflate,Inflate_1=Inflate,inflate_1=inflate;const pngSignature=[137,80,78,71,13,10,26,10],crcTable=[];for(let e=0;e<256;e++){let r=e;for(let n=0;n<8;n++)r&1?r=3988292384^r>>>1:r=r>>>1;crcTable[e]=r}const initialCrc=4294967295;function updateCrc(e,r,n){let a=e;for(let u=0;u<n;u++)a=crcTable[(a^r[u])&255]^a>>>8;return a}function crc(e,r){return(updateCrc(initialCrc,e,r)^initialCrc)>>>0}var ColorType;(function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.GREYSCALE=0]="GREYSCALE",e[e.TRUECOLOUR=2]="TRUECOLOUR",e[e.INDEXED_COLOUR=3]="INDEXED_COLOUR",e[e.GREYSCALE_ALPHA=4]="GREYSCALE_ALPHA",e[e.TRUECOLOUR_ALPHA=6]="TRUECOLOUR_ALPHA"})(ColorType||(ColorType={}));var CompressionMethod;(function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.DEFLATE=0]="DEFLATE"})(CompressionMethod||(CompressionMethod={}));var FilterMethod;(function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.ADAPTIVE=0]="ADAPTIVE"})(FilterMethod||(FilterMethod={}));var InterlaceMethod;(function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.NO_INTERLACE=0]="NO_INTERLACE",e[e.ADAM7=1]="ADAM7"})(InterlaceMethod||(InterlaceMethod={}));const empty=new Uint8Array(0),NULL="\0",uint16=new Uint16Array([255]),uint8=new Uint8Array(uint16.buffer),osIsLittleEndian=uint8[0]===255;class PngDecoder extends IOBuffer$4{constructor(r,n={}){super(r);const{checkCrc:a=!1}=n;this._checkCrc=a,this._inflator=new Inflate_1,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._end=!1,this._hasPalette=!1,this._palette=[],this._compressionMethod=CompressionMethod.UNKNOWN,this._filterMethod=FilterMethod.UNKNOWN,this._interlaceMethod=InterlaceMethod.UNKNOWN,this._colorType=-1,this.setBigEndian()}decode(){for(this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(let r=0;r<pngSignature.length;r++)if(this.readUint8()!==pngSignature[r])throw new Error(`wrong PNG signature. Byte at ${r} should be ${pngSignature[r]}.`)}decodeChunk(){const r=this.readUint32(),n=this.readChars(4),a=this.offset;switch(n){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(r);break;case"IDAT":this.decodeIDAT(r);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(r);break;case"iCCP":this.decodeiCCP(r);break;case"tEXt":this.decodetEXt(r);break;case"pHYs":this.decodepHYs();break;default:this.skip(r);break}if(this.offset-a!==r)throw new Error(`Length mismatch while decoding chunk ${n}`);if(this._checkCrc){const u=this.readUint32(),f=r+4,_=crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-f-4,f),f);if(_!==u)throw new Error(`CRC mismatch for chunk ${n}. Expected ${u}, found ${_}`)}else this.skip(4)}decodeIHDR(){const r=this._png;r.width=this.readUint32(),r.height=this.readUint32(),r.depth=checkBitDepth(this.readUint8());const n=this.readUint8();this._colorType=n;let a;switch(n){case ColorType.GREYSCALE:a=1;break;case ColorType.TRUECOLOUR:a=3;break;case ColorType.INDEXED_COLOUR:a=1;break;case ColorType.GREYSCALE_ALPHA:a=2;break;case ColorType.TRUECOLOUR_ALPHA:a=4;break;default:throw new Error(`Unknown color type: ${n}`)}if(this._png.channels=a,this._compressionMethod=this.readUint8(),this._compressionMethod!==CompressionMethod.DEFLATE)throw new Error(`Unsupported compression method: ${this._compressionMethod}`);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodePLTE(r){if(r%3!==0)throw new RangeError(`PLTE field length must be a multiple of 3. Got ${r}`);const n=r/3;this._hasPalette=!0;const a=[];this._palette=a;for(let u=0;u<n;u++)a.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(r){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,r)),this.skip(r)}decodetRNS(r){if(this._colorType===3){if(r>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${r} vs ${this._palette.length})`);let n=0;for(;n<r;n++){const a=this.readByte();this._palette[n].push(a)}for(;n<this._palette.length;n++)this._palette[n].push(255)}}decodeiCCP(r){let n="",a;for(;(a=this.readChar())!==NULL;)n+=a;const u=this.readUint8();if(u!==CompressionMethod.DEFLATE)throw new Error(`Unsupported iCCP compression method: ${u}`);const f=this.readBytes(r-n.length-2);this._png.iccEmbeddedProfile={name:n,profile:inflate_1(f)}}decodetEXt(r){let n="",a;for(;(a=this.readChar())!==NULL;)n+=a;this._png.text[n]=this.readChars(r-n.length-1)}decodepHYs(){const r=this.readUint32(),n=this.readUint32(),a=this.readByte();this._png.resolution={x:r,y:n,unit:a}}decodeImage(){if(this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);const r=this._inflator.result;if(this._filterMethod!==FilterMethod.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod===InterlaceMethod.NO_INTERLACE)this.decodeInterlaceNull(r);else throw new Error(`Interlace method ${this._interlaceMethod} not supported`)}decodeInterlaceNull(r){const n=this._png.height,a=this._png.channels*this._png.depth/8,u=this._png.width*a,f=new Uint8Array(this._png.height*u);let _=empty,o=0,b,E;for(let M=0;M<n;M++){switch(b=r.subarray(o+1,o+1+u),E=f.subarray(M*u,(M+1)*u),r[o]){case 0:unfilterNone(b,E,u);break;case 1:unfilterSub(b,E,u,a);break;case 2:unfilterUp(b,E,_,u);break;case 3:unfilterAverage(b,E,_,u,a);break;case 4:unfilterPaeth(b,E,_,u,a);break;default:throw new Error(`Unsupported filter: ${r[o]}`)}_=E,o+=u+1}if(this._hasPalette&&(this._png.palette=this._palette),this._png.depth===16){const M=new Uint16Array(f.buffer);if(osIsLittleEndian)for(let P=0;P<M.length;P++)M[P]=swap16(M[P]);this._png.data=M}else this._png.data=f}}function unfilterNone(e,r,n){for(let a=0;a<n;a++)r[a]=e[a]}function unfilterSub(e,r,n,a){let u=0;for(;u<a;u++)r[u]=e[u];for(;u<n;u++)r[u]=e[u]+r[u-a]&255}function unfilterUp(e,r,n,a){let u=0;if(n.length===0)for(;u<a;u++)r[u]=e[u];else for(;u<a;u++)r[u]=e[u]+n[u]&255}function unfilterAverage(e,r,n,a,u){let f=0;if(n.length===0){for(;f<u;f++)r[f]=e[f];for(;f<a;f++)r[f]=e[f]+(r[f-u]>>1)&255}else{for(;f<u;f++)r[f]=e[f]+(n[f]>>1)&255;for(;f<a;f++)r[f]=e[f]+(r[f-u]+n[f]>>1)&255}}function unfilterPaeth(e,r,n,a,u){let f=0;if(n.length===0){for(;f<u;f++)r[f]=e[f];for(;f<a;f++)r[f]=e[f]+r[f-u]&255}else{for(;f<u;f++)r[f]=e[f]+n[f]&255;for(;f<a;f++)r[f]=e[f]+paethPredictor(r[f-u],n[f],n[f-u])&255}}function paethPredictor(e,r,n){const a=e+r-n,u=Math.abs(a-e),f=Math.abs(a-r),_=Math.abs(a-n);return u<=f&&u<=_?e:f<=_?r:n}function swap16(e){return(e&255)<<8|e>>8&255}function checkBitDepth(e){if(e!==1&&e!==2&&e!==4&&e!==8&&e!==16)throw new Error(`invalid bit depth: ${e}`);return e}const defaultZlibOptions={level:3};class PngEncoder extends IOBuffer$4{constructor(r,n={}){super(),this._colorType=ColorType.UNKNOWN,this._zlibOptions=Object.assign({},defaultZlibOptions,n.zlib),this._png=this._checkData(r),this.setBigEndian()}encode(){return this.encodeSignature(),this.encodeIHDR(),this.encodeData(),this.encodeIEND(),this.toArray()}encodeSignature(){this.writeBytes(pngSignature)}encodeIHDR(){this.writeUint32(13),this.writeChars("IHDR"),this.writeUint32(this._png.width),this.writeUint32(this._png.height),this.writeByte(this._png.depth),this.writeByte(this._colorType),this.writeByte(CompressionMethod.DEFLATE),this.writeByte(FilterMethod.ADAPTIVE),this.writeByte(InterlaceMethod.NO_INTERLACE),this.writeCrc(17)}encodeIEND(){this.writeUint32(0),this.writeChars("IEND"),this.writeCrc(4)}encodeIDAT(r){this.writeUint32(r.length),this.writeChars("IDAT"),this.writeBytes(r),this.writeCrc(r.length+4)}encodeData(){const{width:r,height:n,channels:a,depth:u,data:f}=this._png,_=a*r,o=new IOBuffer$4().setBigEndian();let b=0;for(let P=0;P<n;P++)if(o.writeByte(0),u===8)b=writeDataBytes(f,o,_,b);else if(u===16)b=writeDataUint16(f,o,_,b);else throw new Error("unreachable");const E=o.toArray(),M=deflate_1(E,this._zlibOptions);this.encodeIDAT(M)}_checkData(r){const{colorType:n,channels:a,depth:u}=getColorType(r),f={width:checkInteger(r.width,"width"),height:checkInteger(r.height,"height"),channels:a,data:r.data,depth:u,text:{}};this._colorType=n;const _=f.width*f.height*a;if(f.data.length!==_)throw new RangeError(`wrong data size. Found ${f.data.length}, expected ${_}`);return f}writeCrc(r){this.writeUint32(crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-r,r),r))}}function checkInteger(e,r){if(Number.isInteger(e)&&e>0)return e;throw new TypeError(`${r} must be a positive integer`)}function getColorType(e){const{channels:r=4,depth:n=8}=e;if(r!==4&&r!==3&&r!==2&&r!==1)throw new RangeError(`unsupported number of channels: ${r}`);if(n!==8&&n!==16)throw new RangeError(`unsupported bit depth: ${n}`);const a={channels:r,depth:n,colorType:ColorType.UNKNOWN};switch(r){case 4:a.colorType=ColorType.TRUECOLOUR_ALPHA;break;case 3:a.colorType=ColorType.TRUECOLOUR;break;case 1:a.colorType=ColorType.GREYSCALE;break;case 2:a.colorType=ColorType.GREYSCALE_ALPHA;break;default:throw new Error("unsupported number of channels")}return a}function writeDataBytes(e,r,n,a){for(let u=0;u<n;u++)r.writeByte(e[a++]);return a}function writeDataUint16(e,r,n,a){for(let u=0;u<n;u++)r.writeUint16(e[a++]);return a}var ResolutionUnitSpecifier;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.METRE=1]="METRE"})(ResolutionUnitSpecifier||(ResolutionUnitSpecifier={}));function decodePng(e,r){return new PngDecoder(e,r).decode()}function encodePng$1(e,r){return new PngEncoder(e,r).encode()}var encoder={exports:{}};(function(e){function r(a){var u=Math.floor,f=new Array(64),_=new Array(64),o=new Array(64),b=new Array(64),E,M,P,L,D=new Array(65535),U=new Array(65535),X=new Array(64),K=new Array(64),q=[],oe=0,W=7,Y=new Array(64),J=new Array(64),Ee=new Array(64),xe=new Array(256),se=new Array(2048),ce,ee=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],he=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],Ie=[0,1,2,3,4,5,6,7,8,9,10,11],Pe=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],Qe=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],We=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],Zt=[0,1,2,3,4,5,6,7,8,9,10,11],ti=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],$t=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function oi(ht){for(var Gt=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],di=0;di<64;di++){var si=u((Gt[di]*ht+50)/100);si<1?si=1:si>255&&(si=255),f[ee[di]]=si}for(var Ae=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],xt=0;xt<64;xt++){var Xt=u((Ae[xt]*ht+50)/100);Xt<1?Xt=1:Xt>255&&(Xt=255),_[ee[xt]]=Xt}for(var Nt=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],Yt=0,ii=0;ii<8;ii++)for(var Rt=0;Rt<8;Rt++)o[Yt]=1/(f[ee[Yt]]*Nt[ii]*Nt[Rt]*8),b[Yt]=1/(_[ee[Yt]]*Nt[ii]*Nt[Rt]*8),Yt++}function je(ht,Gt){for(var di=0,si=0,Ae=new Array,xt=1;xt<=16;xt++){for(var Xt=1;Xt<=ht[xt];Xt++)Ae[Gt[si]]=[],Ae[Gt[si]][0]=di,Ae[Gt[si]][1]=xt,si++,di++;di*=2}return Ae}function _t(){E=je(he,Ie),M=je(We,Zt),P=je(Pe,Qe),L=je(ti,$t)}function Bt(){for(var ht=1,Gt=2,di=1;di<=15;di++){for(var si=ht;si<Gt;si++)U[32767+si]=di,D[32767+si]=[],D[32767+si][1]=di,D[32767+si][0]=si;for(var Ae=-(Gt-1);Ae<=-ht;Ae++)U[32767+Ae]=di,D[32767+Ae]=[],D[32767+Ae][1]=di,D[32767+Ae][0]=Gt-1+Ae;ht<<=1,Gt<<=1}}function dt(){for(var ht=0;ht<256;ht++)se[ht]=19595*ht,se[ht+256>>0]=38470*ht,se[ht+512>>0]=7471*ht+32768,se[ht+768>>0]=-11059*ht,se[ht+1024>>0]=-21709*ht,se[ht+1280>>0]=32768*ht+8421375,se[ht+1536>>0]=-27439*ht,se[ht+1792>>0]=-5329*ht}function At(ht){for(var Gt=ht[0],di=ht[1]-1;di>=0;)Gt&1<<di&&(oe|=1<<W),di--,W--,W<0&&(oe==255?(Tt(255),Tt(0)):Tt(oe),W=7,oe=0)}function Tt(ht){q.push(ht)}function Dt(ht){Tt(ht>>8&255),Tt(ht&255)}function Ct(ht,Gt){var di,si,Ae,xt,Xt,Nt,Yt,ii,Rt=0,Kt,Li=8,Ii=64;for(Kt=0;Kt<Li;++Kt){di=ht[Rt],si=ht[Rt+1],Ae=ht[Rt+2],xt=ht[Rt+3],Xt=ht[Rt+4],Nt=ht[Rt+5],Yt=ht[Rt+6],ii=ht[Rt+7];var Fi=di+ii,Xi=di-ii,rr=si+Yt,Ki=si-Yt,Ci=Ae+Nt,Ir=Ae-Nt,mn=xt+Xt,gn=xt-Xt,Er=Fi+mn,un=Fi-mn,ar=rr+Ci,Jr=rr-Ci;ht[Rt]=Er+ar,ht[Rt+4]=Er-ar;var qr=(Jr+un)*.707106781;ht[Rt+2]=un+qr,ht[Rt+6]=un-qr,Er=gn+Ir,ar=Ir+Ki,Jr=Ki+Xi;var kr=(Er-Jr)*.382683433,ye=.5411961*Er+kr,qe=1.306562965*Jr+kr,at=ar*.707106781,ne=Xi+at,H=Xi-at;ht[Rt+5]=H+ye,ht[Rt+3]=H-ye,ht[Rt+1]=ne+qe,ht[Rt+7]=ne-qe,Rt+=8}for(Rt=0,Kt=0;Kt<Li;++Kt){di=ht[Rt],si=ht[Rt+8],Ae=ht[Rt+16],xt=ht[Rt+24],Xt=ht[Rt+32],Nt=ht[Rt+40],Yt=ht[Rt+48],ii=ht[Rt+56];var te=di+ii,pe=di-ii,we=si+Yt,ke=si-Yt,$e=Ae+Nt,Ge=Ae-Nt,De=xt+Xt,Ze=xt-Xt,ut=te+De,Ut=te-De,ft=we+$e,bi=we-$e;ht[Rt]=ut+ft,ht[Rt+32]=ut-ft;var wi=(bi+Ut)*.707106781;ht[Rt+16]=Ut+wi,ht[Rt+48]=Ut-wi,ut=Ze+Ge,ft=Ge+ke,bi=ke+pe;var gi=(ut-bi)*.382683433,Di=.5411961*ut+gi,Hi=1.306562965*bi+gi,Re=ft*.707106781,vt=pe+Re,Pt=pe-Re;ht[Rt+40]=Pt+Di,ht[Rt+24]=Pt-Di,ht[Rt+8]=vt+Hi,ht[Rt+56]=vt-Hi,Rt++}var fi;for(Kt=0;Kt<Ii;++Kt)fi=ht[Kt]*Gt[Kt],X[Kt]=fi>0?fi+.5|0:fi-.5|0;return X}function pi(){Dt(65504),Dt(16),Tt(74),Tt(70),Tt(73),Tt(70),Tt(0),Tt(1),Tt(1),Tt(0),Dt(1),Dt(1),Tt(0),Tt(0)}function yt(ht){if(!!ht){Dt(65505),ht[0]===69&&ht[1]===120&&ht[2]===105&&ht[3]===102?Dt(ht.length+2):(Dt(ht.length+5+2),Tt(69),Tt(120),Tt(105),Tt(102),Tt(0));for(var Gt=0;Gt<ht.length;Gt++)Tt(ht[Gt])}}function vi(ht,Gt){Dt(65472),Dt(17),Tt(8),Dt(Gt),Dt(ht),Tt(3),Tt(1),Tt(17),Tt(0),Tt(2),Tt(17),Tt(1),Tt(3),Tt(17),Tt(1)}function $i(){Dt(65499),Dt(132),Tt(0);for(var ht=0;ht<64;ht++)Tt(f[ht]);Tt(1);for(var Gt=0;Gt<64;Gt++)Tt(_[Gt])}function yi(){Dt(65476),Dt(418),Tt(0);for(var ht=0;ht<16;ht++)Tt(he[ht+1]);for(var Gt=0;Gt<=11;Gt++)Tt(Ie[Gt]);Tt(16);for(var di=0;di<16;di++)Tt(Pe[di+1]);for(var si=0;si<=161;si++)Tt(Qe[si]);Tt(1);for(var Ae=0;Ae<16;Ae++)Tt(We[Ae+1]);for(var xt=0;xt<=11;xt++)Tt(Zt[xt]);Tt(17);for(var Xt=0;Xt<16;Xt++)Tt(ti[Xt+1]);for(var Nt=0;Nt<=161;Nt++)Tt($t[Nt])}function mi(ht){typeof ht>"u"||ht.constructor!==Array||ht.forEach(Gt=>{if(typeof Gt=="string"){Dt(65534);var di=Gt.length;Dt(di+2);var si;for(si=0;si<di;si++)Tt(Gt.charCodeAt(si))}})}function It(){Dt(65498),Dt(12),Tt(3),Tt(1),Tt(0),Tt(2),Tt(17),Tt(3),Tt(17),Tt(0),Tt(63),Tt(0)}function kt(ht,Gt,di,si,Ae){for(var xt=Ae[0],Xt=Ae[240],Nt,Yt=16,ii=63,Rt=64,Kt=Ct(ht,Gt),Li=0;Li<Rt;++Li)K[ee[Li]]=Kt[Li];var Ii=K[0]-di;di=K[0],Ii==0?At(si[0]):(Nt=32767+Ii,At(si[U[Nt]]),At(D[Nt]));for(var Fi=63;Fi>0&&K[Fi]==0;Fi--);if(Fi==0)return At(xt),di;for(var Xi=1,rr;Xi<=Fi;){for(var Ki=Xi;K[Xi]==0&&Xi<=Fi;++Xi);var Ci=Xi-Ki;if(Ci>=Yt){rr=Ci>>4;for(var Ir=1;Ir<=rr;++Ir)At(Xt);Ci=Ci&15}Nt=32767+K[Xi],At(Ae[(Ci<<4)+U[Nt]]),At(D[Nt]),Xi++}return Fi!=ii&&At(xt),di}function Ri(){for(var ht=String.fromCharCode,Gt=0;Gt<256;Gt++)xe[Gt]=ht(Gt)}this.encode=function(ht,Gt){new Date().getTime(),Gt&&Pi(Gt),q=new Array,oe=0,W=7,Dt(65496),pi(),mi(ht.comments),yt(ht.exifBuffer),$i(),vi(ht.width,ht.height),yi(),It();var di=0,si=0,Ae=0;oe=0,W=7,this.encode.displayName="_encode_";for(var xt=ht.data,Xt=ht.width,Nt=ht.height,Yt=Xt*4,ii,Rt=0,Kt,Li,Ii,Fi,Xi,rr,Ki,Ci;Rt<Nt;){for(ii=0;ii<Yt;){for(Fi=Yt*Rt+ii,Xi=Fi,rr=-1,Ki=0,Ci=0;Ci<64;Ci++)Ki=Ci>>3,rr=(Ci&7)*4,Xi=Fi+Ki*Yt+rr,Rt+Ki>=Nt&&(Xi-=Yt*(Rt+1+Ki-Nt)),ii+rr>=Yt&&(Xi-=ii+rr-Yt+4),Kt=xt[Xi++],Li=xt[Xi++],Ii=xt[Xi++],Y[Ci]=(se[Kt]+se[Li+256>>0]+se[Ii+512>>0]>>16)-128,J[Ci]=(se[Kt+768>>0]+se[Li+1024>>0]+se[Ii+1280>>0]>>16)-128,Ee[Ci]=(se[Kt+1280>>0]+se[Li+1536>>0]+se[Ii+1792>>0]>>16)-128;di=kt(Y,o,di,E,P),si=kt(J,b,si,M,L),Ae=kt(Ee,b,Ae,M,L),ii+=32}Rt+=8}if(W>=0){var Ir=[];Ir[1]=W+1,Ir[0]=(1<<W+1)-1,At(Ir)}return Dt(65497),Buffer.from(q)};function Pi(ht){if(ht<=0&&(ht=1),ht>100&&(ht=100),ce!=ht){var Gt=0;ht<50?Gt=Math.floor(5e3/ht):Gt=Math.floor(200-ht*2),oi(Gt),ce=ht}}function zi(){var ht=new Date().getTime();a||(a=50),Ri(),_t(),Bt(),dt(),Pi(a),new Date().getTime()-ht}zi()}e.exports=n;function n(a,u){typeof u>"u"&&(u=50);var f=new r(u),_=f.encode(a,u);return{data:_,width:a.width,height:a.height}}})(encoder);var decoder={exports:{}};(function(e){var r=function(){var u=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),f=4017,_=799,o=3406,b=2276,E=1567,M=3784,P=5793,L=2896;function D(){}function U(J,Ee){for(var xe=0,se=[],ce,ee,he=16;he>0&&!J[he-1];)he--;se.push({children:[],index:0});var Ie=se[0],Pe;for(ce=0;ce<he;ce++){for(ee=0;ee<J[ce];ee++){for(Ie=se.pop(),Ie.children[Ie.index]=Ee[xe];Ie.index>0;){if(se.length===0)throw new Error("Could not recreate Huffman Table");Ie=se.pop()}for(Ie.index++,se.push(Ie);se.length<=ce;)se.push(Pe={children:[],index:0}),Ie.children[Ie.index]=Pe.children,Ie=Pe;xe++}ce+1<he&&(se.push(Pe={children:[],index:0}),Ie.children[Ie.index]=Pe.children,Ie=Pe)}return se[0].children}function X(J,Ee,xe,se,ce,ee,he,Ie,Pe,Qe){xe.precision,xe.samplesPerLine,xe.scanLines;var We=xe.mcusPerLine,Zt=xe.progressive;xe.maxH,xe.maxV;var ti=Ee,$t=0,oi=0;function je(){if(oi>0)return oi--,$t>>oi&1;if($t=J[Ee++],$t==255){var Nt=J[Ee++];if(Nt)throw new Error("unexpected marker: "+($t<<8|Nt).toString(16))}return oi=7,$t>>>7}function _t(Nt){for(var Yt=Nt,ii;(ii=je())!==null;){if(Yt=Yt[ii],typeof Yt=="number")return Yt;if(typeof Yt!="object")throw new Error("invalid huffman sequence")}return null}function Bt(Nt){for(var Yt=0;Nt>0;){var ii=je();if(ii===null)return;Yt=Yt<<1|ii,Nt--}return Yt}function dt(Nt){var Yt=Bt(Nt);return Yt>=1<<Nt-1?Yt:Yt+(-1<<Nt)+1}function At(Nt,Yt){var ii=_t(Nt.huffmanTableDC),Rt=ii===0?0:dt(ii);Yt[0]=Nt.pred+=Rt;for(var Kt=1;Kt<64;){var Li=_t(Nt.huffmanTableAC),Ii=Li&15,Fi=Li>>4;if(Ii===0){if(Fi<15)break;Kt+=16;continue}Kt+=Fi;var Xi=u[Kt];Yt[Xi]=dt(Ii),Kt++}}function Tt(Nt,Yt){var ii=_t(Nt.huffmanTableDC),Rt=ii===0?0:dt(ii)<<Pe;Yt[0]=Nt.pred+=Rt}function Dt(Nt,Yt){Yt[0]|=je()<<Pe}var Ct=0;function pi(Nt,Yt){if(Ct>0){Ct--;return}for(var ii=ee,Rt=he;ii<=Rt;){var Kt=_t(Nt.huffmanTableAC),Li=Kt&15,Ii=Kt>>4;if(Li===0){if(Ii<15){Ct=Bt(Ii)+(1<<Ii)-1;break}ii+=16;continue}ii+=Ii;var Fi=u[ii];Yt[Fi]=dt(Li)*(1<<Pe),ii++}}var yt=0,vi;function $i(Nt,Yt){for(var ii=ee,Rt=he,Kt=0;ii<=Rt;){var Li=u[ii],Ii=Yt[Li]<0?-1:1;switch(yt){case 0:var Fi=_t(Nt.huffmanTableAC),Xi=Fi&15,Kt=Fi>>4;if(Xi===0)Kt<15?(Ct=Bt(Kt)+(1<<Kt),yt=4):(Kt=16,yt=1);else{if(Xi!==1)throw new Error("invalid ACn encoding");vi=dt(Xi),yt=Kt?2:3}continue;case 1:case 2:Yt[Li]?Yt[Li]+=(je()<<Pe)*Ii:(Kt--,Kt===0&&(yt=yt==2?3:0));break;case 3:Yt[Li]?Yt[Li]+=(je()<<Pe)*Ii:(Yt[Li]=vi<<Pe,yt=0);break;case 4:Yt[Li]&&(Yt[Li]+=(je()<<Pe)*Ii);break}ii++}yt===4&&(Ct--,Ct===0&&(yt=0))}function yi(Nt,Yt,ii,Rt,Kt){var Li=ii/We|0,Ii=ii%We,Fi=Li*Nt.v+Rt,Xi=Ii*Nt.h+Kt;Nt.blocks[Fi]===void 0&&Qe.tolerantDecoding||Yt(Nt,Nt.blocks[Fi][Xi])}function mi(Nt,Yt,ii){var Rt=ii/Nt.blocksPerLine|0,Kt=ii%Nt.blocksPerLine;Nt.blocks[Rt]===void 0&&Qe.tolerantDecoding||Yt(Nt,Nt.blocks[Rt][Kt])}var It=se.length,kt,Ri,Pi,zi,ht,Gt;Zt?ee===0?Gt=Ie===0?Tt:Dt:Gt=Ie===0?pi:$i:Gt=At;var di=0,si,Ae;It==1?Ae=se[0].blocksPerLine*se[0].blocksPerColumn:Ae=We*xe.mcusPerColumn,ce||(ce=Ae);for(var xt,Xt;di<Ae;){for(Ri=0;Ri<It;Ri++)se[Ri].pred=0;if(Ct=0,It==1)for(kt=se[0],ht=0;ht<ce;ht++)mi(kt,Gt,di),di++;else for(ht=0;ht<ce;ht++){for(Ri=0;Ri<It;Ri++)for(kt=se[Ri],xt=kt.h,Xt=kt.v,Pi=0;Pi<Xt;Pi++)for(zi=0;zi<xt;zi++)yi(kt,Gt,di,Pi,zi);if(di++,di===Ae)break}if(di===Ae)do{if(J[Ee]===255&&J[Ee+1]!==0)break;Ee+=1}while(Ee<J.length-2);if(oi=0,si=J[Ee]<<8|J[Ee+1],si<65280)throw new Error("marker was not found");if(si>=65488&&si<=65495)Ee+=2;else break}return Ee-ti}function K(J,Ee){var xe=[],se=Ee.blocksPerLine,ce=Ee.blocksPerColumn,ee=se<<3,he=new Int32Array(64),Ie=new Uint8Array(64);function Pe(Bt,dt,At){var Tt=Ee.quantizationTable,Dt,Ct,pi,yt,vi,$i,yi,mi,It,kt=At,Ri;for(Ri=0;Ri<64;Ri++)kt[Ri]=Bt[Ri]*Tt[Ri];for(Ri=0;Ri<8;++Ri){var Pi=8*Ri;if(kt[1+Pi]==0&&kt[2+Pi]==0&&kt[3+Pi]==0&&kt[4+Pi]==0&&kt[5+Pi]==0&&kt[6+Pi]==0&&kt[7+Pi]==0){It=P*kt[0+Pi]+512>>10,kt[0+Pi]=It,kt[1+Pi]=It,kt[2+Pi]=It,kt[3+Pi]=It,kt[4+Pi]=It,kt[5+Pi]=It,kt[6+Pi]=It,kt[7+Pi]=It;continue}Dt=P*kt[0+Pi]+128>>8,Ct=P*kt[4+Pi]+128>>8,pi=kt[2+Pi],yt=kt[6+Pi],vi=L*(kt[1+Pi]-kt[7+Pi])+128>>8,mi=L*(kt[1+Pi]+kt[7+Pi])+128>>8,$i=kt[3+Pi]<<4,yi=kt[5+Pi]<<4,It=Dt-Ct+1>>1,Dt=Dt+Ct+1>>1,Ct=It,It=pi*M+yt*E+128>>8,pi=pi*E-yt*M+128>>8,yt=It,It=vi-yi+1>>1,vi=vi+yi+1>>1,yi=It,It=mi+$i+1>>1,$i=mi-$i+1>>1,mi=It,It=Dt-yt+1>>1,Dt=Dt+yt+1>>1,yt=It,It=Ct-pi+1>>1,Ct=Ct+pi+1>>1,pi=It,It=vi*b+mi*o+2048>>12,vi=vi*o-mi*b+2048>>12,mi=It,It=$i*_+yi*f+2048>>12,$i=$i*f-yi*_+2048>>12,yi=It,kt[0+Pi]=Dt+mi,kt[7+Pi]=Dt-mi,kt[1+Pi]=Ct+yi,kt[6+Pi]=Ct-yi,kt[2+Pi]=pi+$i,kt[5+Pi]=pi-$i,kt[3+Pi]=yt+vi,kt[4+Pi]=yt-vi}for(Ri=0;Ri<8;++Ri){var zi=Ri;if(kt[8+zi]==0&&kt[16+zi]==0&&kt[24+zi]==0&&kt[32+zi]==0&&kt[40+zi]==0&&kt[48+zi]==0&&kt[56+zi]==0){It=P*At[Ri+0]+8192>>14,kt[0+zi]=It,kt[8+zi]=It,kt[16+zi]=It,kt[24+zi]=It,kt[32+zi]=It,kt[40+zi]=It,kt[48+zi]=It,kt[56+zi]=It;continue}Dt=P*kt[0+zi]+2048>>12,Ct=P*kt[32+zi]+2048>>12,pi=kt[16+zi],yt=kt[48+zi],vi=L*(kt[8+zi]-kt[56+zi])+2048>>12,mi=L*(kt[8+zi]+kt[56+zi])+2048>>12,$i=kt[24+zi],yi=kt[40+zi],It=Dt-Ct+1>>1,Dt=Dt+Ct+1>>1,Ct=It,It=pi*M+yt*E+2048>>12,pi=pi*E-yt*M+2048>>12,yt=It,It=vi-yi+1>>1,vi=vi+yi+1>>1,yi=It,It=mi+$i+1>>1,$i=mi-$i+1>>1,mi=It,It=Dt-yt+1>>1,Dt=Dt+yt+1>>1,yt=It,It=Ct-pi+1>>1,Ct=Ct+pi+1>>1,pi=It,It=vi*b+mi*o+2048>>12,vi=vi*o-mi*b+2048>>12,mi=It,It=$i*_+yi*f+2048>>12,$i=$i*f-yi*_+2048>>12,yi=It,kt[0+zi]=Dt+mi,kt[56+zi]=Dt-mi,kt[8+zi]=Ct+yi,kt[48+zi]=Ct-yi,kt[16+zi]=pi+$i,kt[40+zi]=pi-$i,kt[24+zi]=yt+vi,kt[32+zi]=yt-vi}for(Ri=0;Ri<64;++Ri){var ht=128+(kt[Ri]+8>>4);dt[Ri]=ht<0?0:ht>255?255:ht}}Y(ee*ce*8);for(var Qe,We,Zt=0;Zt<ce;Zt++){var ti=Zt<<3;for(Qe=0;Qe<8;Qe++)xe.push(new Uint8Array(ee));for(var $t=0;$t<se;$t++){Pe(Ee.blocks[Zt][$t],Ie,he);var oi=0,je=$t<<3;for(We=0;We<8;We++){var _t=xe[ti+We];for(Qe=0;Qe<8;Qe++)_t[je+Qe]=Ie[oi++]}}}return xe}function q(J){return J<0?0:J>255?255:J}D.prototype={load:function(Ee){var xe=new XMLHttpRequest;xe.open("GET",Ee,!0),xe.responseType="arraybuffer",xe.onload=function(){var se=new Uint8Array(xe.response||xe.mozResponseArrayBuffer);this.parse(se),this.onload&&this.onload()}.bind(this),xe.send(null)},parse:function(Ee){var xe=this.opts.maxResolutionInMP*1e3*1e3,se=0;Ee.length;function ce(){var Ii=Ee[se]<<8|Ee[se+1];return se+=2,Ii}function ee(){var Ii=ce(),Fi=Ee.subarray(se,se+Ii-2);return se+=Fi.length,Fi}function he(Ii){var Fi=1,Xi=1,rr,Ki;for(Ki in Ii.components)Ii.components.hasOwnProperty(Ki)&&(rr=Ii.components[Ki],Fi<rr.h&&(Fi=rr.h),Xi<rr.v&&(Xi=rr.v));var Ci=Math.ceil(Ii.samplesPerLine/8/Fi),Ir=Math.ceil(Ii.scanLines/8/Xi);for(Ki in Ii.components)if(Ii.components.hasOwnProperty(Ki)){rr=Ii.components[Ki];var mn=Math.ceil(Math.ceil(Ii.samplesPerLine/8)*rr.h/Fi),gn=Math.ceil(Math.ceil(Ii.scanLines/8)*rr.v/Xi),Er=Ci*rr.h,un=Ir*rr.v,ar=un*Er,Jr=[];Y(ar*256);for(var qr=0;qr<un;qr++){for(var kr=[],ye=0;ye<Er;ye++)kr.push(new Int32Array(64));Jr.push(kr)}rr.blocksPerLine=mn,rr.blocksPerColumn=gn,rr.blocks=Jr}Ii.maxH=Fi,Ii.maxV=Xi,Ii.mcusPerLine=Ci,Ii.mcusPerColumn=Ir}var Ie=null,Pe=null,Qe,We,Zt=[],ti=[],$t=[],oi=[],je=ce(),_t=-1;if(this.comments=[],je!=65496)throw new Error("SOI not found");for(je=ce();je!=65497;){var Bt,dt;switch(je){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var At=ee();if(je===65534){var Tt=String.fromCharCode.apply(null,At);this.comments.push(Tt)}je===65504&&At[0]===74&&At[1]===70&&At[2]===73&&At[3]===70&&At[4]===0&&(Ie={version:{major:At[5],minor:At[6]},densityUnits:At[7],xDensity:At[8]<<8|At[9],yDensity:At[10]<<8|At[11],thumbWidth:At[12],thumbHeight:At[13],thumbData:At.subarray(14,14+3*At[12]*At[13])}),je===65505&&At[0]===69&&At[1]===120&&At[2]===105&&At[3]===102&&At[4]===0&&(this.exifBuffer=At.subarray(5,At.length)),je===65518&&At[0]===65&&At[1]===100&&At[2]===111&&At[3]===98&&At[4]===101&&At[5]===0&&(Pe={version:At[6],flags0:At[7]<<8|At[8],flags1:At[9]<<8|At[10],transformCode:At[11]});break;case 65499:for(var Dt=ce(),Ct=Dt+se-2;se<Ct;){var pi=Ee[se++];Y(256);var yt=new Int32Array(64);if(pi>>4===0)for(dt=0;dt<64;dt++){var vi=u[dt];yt[vi]=Ee[se++]}else if(pi>>4===1)for(dt=0;dt<64;dt++){var vi=u[dt];yt[vi]=ce()}else throw new Error("DQT: invalid table spec");Zt[pi&15]=yt}break;case 65472:case 65473:case 65474:ce(),Qe={},Qe.extended=je===65473,Qe.progressive=je===65474,Qe.precision=Ee[se++],Qe.scanLines=ce(),Qe.samplesPerLine=ce(),Qe.components={},Qe.componentsOrder=[];var $i=Qe.scanLines*Qe.samplesPerLine;if($i>xe){var yi=Math.ceil(($i-xe)/1e6);throw new Error(`maxResolutionInMP limit exceeded by ${yi}MP`)}var mi=Ee[se++],It;for(Bt=0;Bt<mi;Bt++){It=Ee[se];var kt=Ee[se+1]>>4,Ri=Ee[se+1]&15,Pi=Ee[se+2];if(kt<=0||Ri<=0)throw new Error("Invalid sampling factor, expected values above 0");Qe.componentsOrder.push(It),Qe.components[It]={h:kt,v:Ri,quantizationIdx:Pi},se+=3}he(Qe),ti.push(Qe);break;case 65476:var zi=ce();for(Bt=2;Bt<zi;){var ht=Ee[se++],Gt=new Uint8Array(16),di=0;for(dt=0;dt<16;dt++,se++)di+=Gt[dt]=Ee[se];Y(16+di);var si=new Uint8Array(di);for(dt=0;dt<di;dt++,se++)si[dt]=Ee[se];Bt+=17+di,(ht>>4===0?oi:$t)[ht&15]=U(Gt,si)}break;case 65501:ce(),We=ce();break;case 65500:ce(),ce();break;case 65498:ce();var Ae=Ee[se++],xt=[],Xt;for(Bt=0;Bt<Ae;Bt++){Xt=Qe.components[Ee[se++]];var Nt=Ee[se++];Xt.huffmanTableDC=oi[Nt>>4],Xt.huffmanTableAC=$t[Nt&15],xt.push(Xt)}var Yt=Ee[se++],ii=Ee[se++],Rt=Ee[se++],Kt=X(Ee,se,Qe,xt,We,Yt,ii,Rt>>4,Rt&15,this.opts);se+=Kt;break;case 65535:Ee[se]!==255&&se--;break;default:if(Ee[se-3]==255&&Ee[se-2]>=192&&Ee[se-2]<=254){se-=3;break}else if(je===224||je==225){if(_t!==-1)throw new Error(`first unknown JPEG marker at offset ${_t.toString(16)}, second unknown JPEG marker ${je.toString(16)} at offset ${(se-1).toString(16)}`);_t=se-1;const Ii=ce();if(Ee[se+Ii-2]===255){se+=Ii-2;break}}throw new Error("unknown JPEG marker "+je.toString(16))}je=ce()}if(ti.length!=1)throw new Error("only single frame JPEGs supported");for(var Bt=0;Bt<ti.length;Bt++){var Li=ti[Bt].components;for(var dt in Li)Li[dt].quantizationTable=Zt[Li[dt].quantizationIdx],delete Li[dt].quantizationIdx}this.width=Qe.samplesPerLine,this.height=Qe.scanLines,this.jfif=Ie,this.adobe=Pe,this.components=[];for(var Bt=0;Bt<Qe.componentsOrder.length;Bt++){var Xt=Qe.components[Qe.componentsOrder[Bt]];this.components.push({lines:K(Qe,Xt),scaleX:Xt.h/Qe.maxH,scaleY:Xt.v/Qe.maxV})}},getData:function(Ee,xe){var se=this.width/Ee,ce=this.height/xe,ee,he,Ie,Pe,Qe,We,Zt,ti,$t,oi,je=0,_t,Bt,dt,At,Tt,Dt,Ct,pi,yt,vi,$i,yi=Ee*xe*this.components.length;Y(yi);var mi=new Uint8Array(yi);switch(this.components.length){case 1:for(ee=this.components[0],oi=0;oi<xe;oi++)for(Qe=ee.lines[0|oi*ee.scaleY*ce],$t=0;$t<Ee;$t++)_t=Qe[0|$t*ee.scaleX*se],mi[je++]=_t;break;case 2:for(ee=this.components[0],he=this.components[1],oi=0;oi<xe;oi++)for(Qe=ee.lines[0|oi*ee.scaleY*ce],We=he.lines[0|oi*he.scaleY*ce],$t=0;$t<Ee;$t++)_t=Qe[0|$t*ee.scaleX*se],mi[je++]=_t,_t=We[0|$t*he.scaleX*se],mi[je++]=_t;break;case 3:for($i=!0,this.adobe&&this.adobe.transformCode?$i=!0:typeof this.opts.colorTransform<"u"&&($i=!!this.opts.colorTransform),ee=this.components[0],he=this.components[1],Ie=this.components[2],oi=0;oi<xe;oi++)for(Qe=ee.lines[0|oi*ee.scaleY*ce],We=he.lines[0|oi*he.scaleY*ce],Zt=Ie.lines[0|oi*Ie.scaleY*ce],$t=0;$t<Ee;$t++)$i?(_t=Qe[0|$t*ee.scaleX*se],Bt=We[0|$t*he.scaleX*se],dt=Zt[0|$t*Ie.scaleX*se],pi=q(_t+1.402*(dt-128)),yt=q(_t-.3441363*(Bt-128)-.71413636*(dt-128)),vi=q(_t+1.772*(Bt-128))):(pi=Qe[0|$t*ee.scaleX*se],yt=We[0|$t*he.scaleX*se],vi=Zt[0|$t*Ie.scaleX*se]),mi[je++]=pi,mi[je++]=yt,mi[je++]=vi;break;case 4:if(!this.adobe)throw new Error("Unsupported color mode (4 components)");for($i=!1,this.adobe&&this.adobe.transformCode?$i=!0:typeof this.opts.colorTransform<"u"&&($i=!!this.opts.colorTransform),ee=this.components[0],he=this.components[1],Ie=this.components[2],Pe=this.components[3],oi=0;oi<xe;oi++)for(Qe=ee.lines[0|oi*ee.scaleY*ce],We=he.lines[0|oi*he.scaleY*ce],Zt=Ie.lines[0|oi*Ie.scaleY*ce],ti=Pe.lines[0|oi*Pe.scaleY*ce],$t=0;$t<Ee;$t++)$i?(_t=Qe[0|$t*ee.scaleX*se],Bt=We[0|$t*he.scaleX*se],dt=Zt[0|$t*Ie.scaleX*se],At=ti[0|$t*Pe.scaleX*se],Tt=255-q(_t+1.402*(dt-128)),Dt=255-q(_t-.3441363*(Bt-128)-.71413636*(dt-128)),Ct=255-q(_t+1.772*(Bt-128))):(Tt=Qe[0|$t*ee.scaleX*se],Dt=We[0|$t*he.scaleX*se],Ct=Zt[0|$t*Ie.scaleX*se],At=ti[0|$t*Pe.scaleX*se]),mi[je++]=255-Tt,mi[je++]=255-Dt,mi[je++]=255-Ct,mi[je++]=255-At;break;default:throw new Error("Unsupported color mode")}return mi},copyToImageData:function(Ee,xe){var se=Ee.width,ce=Ee.height,ee=Ee.data,he=this.getData(se,ce),Ie=0,Pe=0,Qe,We,Zt,ti,$t,oi,je,_t,Bt;switch(this.components.length){case 1:for(We=0;We<ce;We++)for(Qe=0;Qe<se;Qe++)Zt=he[Ie++],ee[Pe++]=Zt,ee[Pe++]=Zt,ee[Pe++]=Zt,xe&&(ee[Pe++]=255);break;case 3:for(We=0;We<ce;We++)for(Qe=0;Qe<se;Qe++)je=he[Ie++],_t=he[Ie++],Bt=he[Ie++],ee[Pe++]=je,ee[Pe++]=_t,ee[Pe++]=Bt,xe&&(ee[Pe++]=255);break;case 4:for(We=0;We<ce;We++)for(Qe=0;Qe<se;Qe++)$t=he[Ie++],oi=he[Ie++],Zt=he[Ie++],ti=he[Ie++],je=255-q($t*(1-ti/255)+ti),_t=255-q(oi*(1-ti/255)+ti),Bt=255-q(Zt*(1-ti/255)+ti),ee[Pe++]=je,ee[Pe++]=_t,ee[Pe++]=Bt,xe&&(ee[Pe++]=255);break;default:throw new Error("Unsupported color mode")}}};var oe=0,W=0;function Y(J=0){var Ee=oe+J;if(Ee>W){var xe=Math.ceil((Ee-W)/1024/1024);throw new Error(`maxMemoryUsageInMB limit exceeded by at least ${xe}MB`)}oe=Ee}return D.resetMaxMemoryUsage=function(J){oe=0,W=J},D.getBytesAllocated=function(){return oe},D.requestMemoryAllocation=Y,D}();e.exports=n;function n(a,u={}){var f={colorTransform:void 0,useTArray:!1,formatAsRGBA:!0,tolerantDecoding:!0,maxResolutionInMP:100,maxMemoryUsageInMB:512},_={...f,...u},o=new Uint8Array(a),b=new r;b.opts=_,r.resetMaxMemoryUsage(_.maxMemoryUsageInMB*1024*1024),b.parse(o);var E=_.formatAsRGBA?4:3,M=b.width*b.height*E;try{r.requestMemoryAllocation(M);var P={width:b.width,height:b.height,exifBuffer:b.exifBuffer,data:_.useTArray?new Uint8Array(M):Buffer.alloc(M)};b.comments.length>0&&(P.comments=b.comments)}catch(L){throw L instanceof RangeError?new Error("Could not allocate enough memory for the image. Required: "+M):L instanceof ReferenceError&&L.message==="Buffer is not defined"?new Error("Buffer is not globally defined in this environment. Consider setting useTArray to true"):L}return b.copyToImageData(P,_.formatAsRGBA),P}})(decoder);var encode$1=encoder.exports,decode$4=decoder.exports,jpegJs={encode:encode$1,decode:decode$4};let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=new Uint8Array(256);for(let e=0;e<chars.length;e++)lookup[chars.charCodeAt(e)]=e;function encode(e){let r,n=e.length,a="";for(r=0;r<n;r+=3)a+=chars[e[r]>>2],a+=chars[(e[r]&3)<<4|e[r+1]>>4],a+=chars[(e[r+1]&15)<<2|e[r+2]>>6],a+=chars[e[r+2]&63];return n%3===2?a=`${a.substring(0,a.length-1)}=`:n%3===1&&(a=`${a.substring(0,a.length-2)}==`),a}function decode$3(e){let r=e.length*.75,n=e.length,a=0,u,f,_,o;e[e.length-1]==="="&&(r--,e[e.length-2]==="="&&r--);const b=new Uint8Array(r);for(let E=0;E<n;E+=4)u=lookup[e.charCodeAt(E)],f=lookup[e.charCodeAt(E+1)],_=lookup[e.charCodeAt(E+2)],o=lookup[e.charCodeAt(E+3)],b[a++]=u<<2|f>>4,b[a++]=(f&15)<<4|_>>2,b[a++]=(_&3)<<6|o&63;return b}function toBase64URL(e,r){const n=encode(e);return`data:${r};base64,${n}`}const ImageData=self.ImageData,DOMImage=self.Image;function createCanvas(e,r){let n=self.document.createElement("canvas");return n.width=e,n.height=r,n}function fetchBinary(e,{withCredentials:r=!1}={}){return new Promise(function(n,a){let u=new self.XMLHttpRequest;u.open("GET",e,!0),u.responseType="arraybuffer",u.withCredentials=r,u.onload=function(f){this.status!==200?a(f):n(this.response)},u.onerror=a,u.send()})}function createWriteStream(){throw new Error("createWriteStream does not exist in the browser")}function writeFile(){throw new Error("writeFile does not exist in the browser")}function getType(e){return e.includes("/")||(e=`image/${e}`),e}function encodeJpeg(e,r={}){const n={width:e.width,height:e.height,data:e.getRGBAData()};return jpegJs.encode(n,r.quality).data}function encodePng(e,r){const n={width:e.width,height:e.height,channels:e.channels,depth:e.bitDepth,data:e.data};return(n.depth===1||n.depth===32)&&(n.depth=8,n.channels=4,n.data=e.getRGBAData()),encodePng$1(n,r)}const exportMethods={save(e,r={}){const{useCanvas:n=!1,encoder:a=void 0}=r;let{format:u}=r;if(!u){const f=/\.(?<format>[a-zA-Z]+)$/.exec(e);f&&(u=f.groups.format.toLowerCase())}if(!u)throw new Error("file format not provided");return new Promise((f,_)=>{let o,b;switch(u.toLowerCase()){case"png":{n?o=this.getCanvas().pngStream():b=encodePng(this,a);break}case"jpg":case"jpeg":n?o=this.getCanvas().jpegStream():b=encodeJpeg(this,a);break;case"bmp":b=encode$2(this,a);break;default:throw new RangeError(`invalid output format: ${u}`)}if(o){let E=createWriteStream();E.on("finish",f),E.on("error",_),o.pipe(E)}else b&&writeFile()})},toDataURL(e="image/png",r={}){typeof e=="object"&&(r=e,e="image/png");const{useCanvas:n=!1,encoder:a=void 0}=r;e=getType(e);function u(f,_){const o=f(_,a);return toBase64URL(o,e)}return e==="image/bmp"?u(encode$2,this):e==="image/png"&&!n?u(encodePng,this):e==="image/jpeg"&&!n?u(encodeJpeg,this):this.getCanvas().toDataURL(e)},toBuffer(e={}){const{format:r="png",encoder:n=void 0}=e;switch(r.toLowerCase()){case"png":return encodePng(this,n);case"jpeg":case"jpg":return encodeJpeg(this,n);case"bmp":return encode$2(this,n);default:throw new RangeError(`invalid output format: ${r}`)}},toBase64(e="image/png",r={}){if(r.async)return this.toDataURL(e,r).then(function(n){return n.substring(n.indexOf(",")+1)});{const n=this.toDataURL(e,r);return n.substring(n.indexOf(",")+1)}},toBlob(e="image/png",r=.8){return canvasToBlob(this.getCanvas(),e,r)},getCanvas(){const e=new ImageData(this.getRGBAData({clamped:!0}),this.width,this.height);let r=createCanvas(this.width,this.height);return r.getContext("2d").putImageData(e,0,0),r}};function setExportMethods(e){for(const r in exportMethods)e.prototype[r]=exportMethods[r]}var hasOwn$1={exports:{}};const name="has-own",version="1.0.1",description="A safer .hasOwnProperty() - hasOwn(name, obj)",main="index.js",scripts={test:"make test"},author="Aaron Heckmann <aaron.heckmann+github@gmail.com>",license="MIT",repository={type:"git",url:"git://github.com/aheckmann/has-own.git"},homepage="https://github.com/aheckmann/has-own/",devDependencies={mocha:"^6.2.2"};var require$$0$3={name,version,description,main,scripts,author,license,repository,homepage,devDependencies};(function(e,r){var n=Object.prototype.hasOwnProperty;e.exports=r=function(u,f){return n.call(f,u)},r.version=require$$0$3.version})(hasOwn$1,hasOwn$1.exports);var hasOwn=hasOwn$1.exports;let computedPropertyDescriptor$1={configurable:!0,enumerable:!1,get:void 0};function extendMethod(e,r,n={}){let{inPlace:a=!1,returnThis:u=!0,partialArgs:f=[]}=n;return a?Image.prototype[e]=function(..._){this.computed=null;let o=r.apply(this,[...f,..._]);return u?this:o}:Image.prototype[e]=function(..._){return r.apply(this,[...f,..._])},Image}function extendProperty(e,r,n={}){let{partialArgs:a=[]}=n;return computedPropertyDescriptor$1.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(e,this.computed))return this.computed[e];let u=r.apply(this,a);return this.computed[e]=u,u},Object.defineProperty(Image.prototype,e,computedPropertyDescriptor$1),Image}const GREY$1="GREY",RGB$1="RGB",HSL="HSL",HSV="HSV",CMYK$1="CMYK";var ColorModel=Object.freeze(Object.defineProperty({__proto__:null,GREY:GREY$1,RGB:RGB$1,HSL,HSV,CMYK:CMYK$1},Symbol.toStringTag,{value:"Module"}));function getRGBAData(e={}){const{clamped:r}=e;this.checkProcessable("getRGBAData",{components:[1,3],bitDepth:[1,8,16,32]});const n=this.width*this.height*4;let a=r?new Uint8ClampedArray(n):new Uint8Array(n);return this.bitDepth===1?fillDataFromBinary(this,a):this.bitDepth===32?(this.checkProcessable("getRGBAData",{alpha:0}),this.components===1?fillDataFromGrey32(this,a):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB32(this,a))):this.components===1?fillDataFromGrey(this,a):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB(this,a)),this.alpha===1?(this.checkProcessable("getRGBAData",{bitDepth:[8,16]}),copyAlpha(this,a)):fillAlpha(this,a),a}function fillDataFromBinary(e,r){for(let n=0;n<e.size;n++){const a=e.getBit(n);r[n*4]=a*255,r[n*4+1]=a*255,r[n*4+2]=a*255}}function fillDataFromGrey32(e,r){const n=e.min[0],u=e.max[0]-n;for(let f=0;f<e.size;f++){const _=Math.floor(255*(e.data[f]-n)/u);r[f*4]=_,r[f*4+1]=_,r[f*4+2]=_}}function fillDataFromRGB32(e,r){const n=Math.min(...e.min),u=Math.max(...e.max)-n;for(let f=0;f<e.size;f++){const _=Math.floor(255*(e.data[f*3]-n)/u),o=Math.floor(255*(e.data[f*3+1]-n)/u),b=Math.floor(255*(e.data[f*3+2]-n)/u);r[f*4]=_,r[f*4+1]=o,r[f*4+2]=b}}function fillDataFromGrey(e,r){for(let n=0;n<e.size;n++)r[n*4]=e.data[n*e.channels]>>>e.bitDepth-8,r[n*4+1]=e.data[n*e.channels]>>>e.bitDepth-8,r[n*4+2]=e.data[n*e.channels]>>>e.bitDepth-8}function fillDataFromRGB(e,r){for(let n=0;n<e.size;n++)r[n*4]=e.data[n*e.channels]>>>e.bitDepth-8,r[n*4+1]=e.data[n*e.channels+1]>>>e.bitDepth-8,r[n*4+2]=e.data[n*e.channels+2]>>>e.bitDepth-8}function copyAlpha(e,r){for(let n=0;n<e.size;n++)r[n*4+3]=e.data[n*e.channels+e.components]>>e.bitDepth-8}function fillAlpha(e,r){for(let n=0;n<e.size;n++)r[n*4+3]=255}const BINARY="BINARY",GREY="GREY",GREYA="GREYA",RGB="RGB",RGBA="RGBA",CMYK="CMYK",CMYKA="CMYKA",kinds={};kinds[BINARY]={components:1,alpha:0,bitDepth:1,colorModel:GREY$1};kinds[GREYA]={components:1,alpha:1,bitDepth:8,colorModel:GREY$1};kinds[GREY]={components:1,alpha:0,bitDepth:8,colorModel:GREY$1};kinds[RGBA]={components:3,alpha:1,bitDepth:8,colorModel:RGB$1};kinds[RGB]={components:3,alpha:0,bitDepth:8,colorModel:RGB$1};kinds[CMYK]={components:4,alpha:0,bitDepth:8,colorModel:CMYK$1};kinds[CMYKA]={components:4,alpha:1,bitDepth:8,colorModel:CMYK$1};function getKind(e){const r=kinds[e];if(!r)throw new RangeError(`invalid image kind: ${e}`);return r}const validBitDepth=[1,8,16,32];function verifyKindDefinition(e){const{components:r,alpha:n,bitDepth:a,colorModel:u}=e;if(!Number.isInteger(r)||r<=0)throw new RangeError(`invalid components: ${r}. Must be a positive integer`);if(n!==0&&n!==1&&typeof n!="boolean")throw new TypeError(`invalid alpha: ${n}: must be a boolean, 0 or 1`);if(!validBitDepth.includes(a))throw new RangeError(`invalid bitDepth: ${a}. Must be one of ${validBitDepth.join(", ")}`);if(!ColorModel[u])throw new RangeError(`invalid colorModel: ${u}. Must be one of ${Object.keys(ColorModel).join(", ")}`)}function getTheoreticalPixelArraySize(e,r,n){let a=r*e;return n===1&&(a=Math.ceil(a/8)),a}function createPixelArray(e,r,n,a,u,f){const _=a*e;let o;switch(u){case 1:o=new Uint8Array(Math.ceil(_/8));break;case 8:o=new Uint8Array(_);break;case 16:o=new Uint16Array(_);break;case 32:o=new Float32Array(_);break;default:throw new Error(`Cannot create pixel array for bit depth ${u}`)}if(n)for(let b=r;b<o.length;b+=a)o[b]=f;return o}const defaultByteLength=1024*8,charArray=[];class IOBuffer$2{constructor(r,n){n=n||{},r===void 0&&(r=defaultByteLength),typeof r=="number"&&(r=new ArrayBuffer(r));let a=r.byteLength;const u=n.offset?n.offset>>>0:0;r.buffer&&(a=r.byteLength-u,r.byteLength!==r.buffer.byteLength?r=r.buffer.slice(r.byteOffset+u,r.byteOffset+r.byteLength):u?r=r.buffer.slice(u):r=r.buffer),this.buffer=r,this.length=a,this.byteLength=a,this.byteOffset=0,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer),this._increment=a||defaultByteLength,this._mark=0}available(r){return r===void 0&&(r=1),this.offset+r<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){this.littleEndian=!0}isBigEndian(){return!this.littleEndian}setBigEndian(){this.littleEndian=!1}skip(r){r===void 0&&(r=1),this.offset+=r}seek(r){this.offset=r}mark(){this._mark=this.offset}reset(){this.offset=this._mark}rewind(){this.offset=0}ensureAvailable(r){if(r===void 0&&(r=1),!this.available(r)){const n=this._increment+this._increment;this._increment=n;const a=this.length+n,u=new Uint8Array(a);u.set(new Uint8Array(this.buffer)),this.buffer=u.buffer,this.length=a,this._data=new DataView(this.buffer)}}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(r){r===void 0&&(r=1);for(var n=new Uint8Array(r),a=0;a<r;a++)n[a]=this.readByte();return n}readInt16(){var r=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,r}readUint16(){var r=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,r}readInt32(){var r=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,r}readUint32(){var r=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,r}readFloat32(){var r=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,r}readFloat64(){var r=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,r}readChar(){return String.fromCharCode(this.readInt8())}readChars(r){r===void 0&&(r=1),charArray.length=r;for(var n=0;n<r;n++)charArray[n]=this.readChar();return charArray.join("")}writeBoolean(r){this.writeUint8(r?255:0)}writeInt8(r){this.ensureAvailable(1),this._data.setInt8(this.offset++,r)}writeUint8(r){this.ensureAvailable(1),this._data.setUint8(this.offset++,r)}writeByte(r){this.writeUint8(r)}writeBytes(r){this.ensureAvailable(r.length);for(var n=0;n<r.length;n++)this._data.setUint8(this.offset++,r[n])}writeInt16(r){this.ensureAvailable(2),this._data.setInt16(this.offset,r,this.littleEndian),this.offset+=2}writeUint16(r){this.ensureAvailable(2),this._data.setUint16(this.offset,r,this.littleEndian),this.offset+=2}writeInt32(r){this.ensureAvailable(4),this._data.setInt32(this.offset,r,this.littleEndian),this.offset+=4}writeUint32(r){this.ensureAvailable(4),this._data.setUint32(this.offset,r,this.littleEndian),this.offset+=4}writeFloat32(r){this.ensureAvailable(4),this._data.setFloat32(this.offset,r,this.littleEndian),this.offset+=4}writeFloat64(r){this.ensureAvailable(8),this._data.setFloat64(this.offset,r,this.littleEndian),this.offset+=8}writeChar(r){this.writeUint8(r.charCodeAt(0))}writeChars(r){for(var n=0;n<r.length;n++)this.writeUint8(r.charCodeAt(n))}toArray(){return new Uint8Array(this.buffer,0,this.offset)}}var IOBuffer_1=IOBuffer$2,src$4={};const tagsById$5={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName$5={};for(var i$2 in tagsById$5)tagsByName$5[tagsById$5[i$2]]=i$2;var standard$1={tagsById:tagsById$5,tagsByName:tagsByName$5};const tagsById$4={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$4={};for(var i$1 in tagsById$4)tagsByName$4[tagsById$4[i$1]]=i$1;var exif$1={tagsById:tagsById$4,tagsByName:tagsByName$4};const tagsById$3={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$3={};for(var i in tagsById$3)tagsByName$3[tagsById$3[i]]=i;var gps$1={tagsById:tagsById$3,tagsByName:tagsByName$3};const tags$1={standard:standard$1,exif:exif$1,gps:gps$1};class IFD$2{constructor(r){if(!r)throw new Error("missing kind");this.data=null,this.fields=new Map,this.kind=r,this._map=null}get(r){if(typeof r=="number")return this.fields.get(r);if(typeof r=="string")return this.fields.get(tags$1[this.kind].tagsByName[r]);throw new Error("expected a number or string")}get map(){if(!this._map){this._map={};const n=tags$1[this.kind].tagsById;for(var r of this.fields.keys())n[r]&&(this._map[n[r]]=this.fields.get(r))}return this._map}}var ifd=IFD$2;const Ifd=ifd,dateTimeRegex$1=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd$1 extends Ifd{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){var r=new Date,n=dateTimeRegex$1.exec(this.dateTime);return r.setFullYear(n[1],n[2]-1,n[3]),r.setHours(n[4],n[5],n[6]),r}get newSubfileType(){return this.get(254)}get imageWidth(){return this.get(256)}get imageLength(){return this.get(257)}get bitsPerSample(){return this.get(258)}get compression(){return this.get(259)||1}get type(){return this.get(262)}get fillOrder(){return this.get(266)||1}get documentName(){return this.get(269)}get imageDescription(){return this.get(270)}get stripOffsets(){return alwaysArray$1(this.get(273))}get orientation(){return this.get(274)}get samplesPerPixel(){return this.get(277)}get rowsPerStrip(){return this.get(278)}get stripByteCounts(){return alwaysArray$1(this.get(279))}get minSampleValue(){return this.get(280)||0}get maxSampleValue(){return this.get(281)||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get(282)}get yResolution(){return this.get(283)}get planarConfiguration(){return this.get(284)||1}get resolutionUnit(){return this.get(296)||2}get dateTime(){return this.get(306)}get predictor(){return this.get(317)||1}get sampleFormat(){return this.get(339)||1}get sMinSampleValue(){return this.get(340)||this.minSampleValue}get sMaxSampleValue(){return this.get(341)||this.maxSampleValue}}function alwaysArray$1(e){return typeof e=="number"?[e]:e}var tiffIfd=TiffIfd$1,ifdValue={},types$1=new Map([[1,[1,readByte$1]],[2,[1,readASCII$1]],[3,[2,readShort$1]],[4,[4,readLong$1]],[5,[8,readRational$1]],[6,[1,readSByte$1]],[7,[1,readByte$1]],[8,[2,readSShort$1]],[9,[4,readSLong$1]],[10,[8,readSRational$1]],[11,[4,readFloat$1]],[12,[8,readDouble$1]]]);ifdValue.getByteLength=function(e,r){return types$1.get(e)[0]*r};ifdValue.readData=function(e,r,n){return types$1.get(r)[1](e,n)};function readByte$1(e,r){if(r===1)return e.readUint8();for(var n=new Uint8Array(r),a=0;a<r;a++)n[a]=e.readUint8();return n}function readASCII$1(e,r){for(var n=[],a="",u=0;u<r;u++){var f=String.fromCharCode(e.readUint8());f==="\0"?(n.push(a),a=""):a+=f}return n.length===1?n[0]:n}function readShort$1(e,r){if(r===1)return e.readUint16();for(var n=new Uint16Array(r),a=0;a<r;a++)n[a]=e.readUint16();return n}function readLong$1(e,r){if(r===1)return e.readUint32();for(var n=new Uint32Array(r),a=0;a<r;a++)n[a]=e.readUint32();return n}function readRational$1(e,r){if(r===1)return e.readUint32()/e.readUint32();for(var n=new Array(r),a=0;a<r;a++)n[a]=e.readUint32()/e.readUint32();return n}function readSByte$1(e,r){if(r===1)return e.readInt8();for(var n=new Int8Array(r),a=0;a<r;a++)n[a]=e.readInt8();return n}function readSShort$1(e,r){if(r===1)return e.readInt16();for(var n=new Int16Array(r),a=0;a<r;a++)n[a]=e.readInt16();return n}function readSLong$1(e,r){if(r===1)return e.readInt32();for(var n=new Int32Array(r),a=0;a<r;a++)n[a]=e.readInt32();return n}function readSRational$1(e,r){if(r===1)return e.readInt32()/e.readInt32();for(var n=new Array(r),a=0;a<r;a++)n[a]=e.readInt32()/e.readInt32();return n}function readFloat$1(e,r){if(r===1)return e.readFloat32();for(var n=new Float32Array(r),a=0;a<r;a++)n[a]=e.readFloat32();return n}function readDouble$1(e,r){if(r===1)return e.readFloat64();for(var n=new Float64Array(r),a=0;a<r;a++)n[a]=e.readFloat64();return n}const IOBuffer$1=IOBuffer_1,IFD$1=ifd,TiffIFD=tiffIfd,IFDValue=ifdValue,defaultOptions$d={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder$2 extends IOBuffer$1{constructor(r,n){super(r,n),this._nextIFD=0}decode(r){r=Object.assign({},defaultOptions$d,r);const n=[];for(this.decodeHeader();this._nextIFD;)if(n.push(this.decodeIFD(r)),r.onlyFirst)return n[0];return n}decodeHeader(){let r=this.readUint16();if(r===18761)this.setLittleEndian();else if(r===19789)this.setBigEndian();else throw new Error("invalid byte order: 0x"+r.toString(16));if(r=this.readUint16(),r!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(r){this.seek(this._nextIFD);var n;r.kind?n=new IFD$1(r.kind):n=new TiffIFD;const a=this.readUint16();for(var u=0;u<a;u++)this.decodeIFDEntry(n);return r.ignoreImageData||this.decodeImageData(n),this._nextIFD=this.readUint32(),n}decodeIFDEntry(r){const n=this.offset,a=this.readUint16(),u=this.readUint16(),f=this.readUint32();if(u<1||u>12){this.skip(4);return}IFDValue.getByteLength(u,f)>4&&this.seek(this.readUint32());const o=IFDValue.readData(this,u,f);if(r.fields.set(a,o),a===34665||a===34853){let b=this.offset,E;a===34665?E="exif":a===34853&&(E="gps"),this._nextIFD=o,r[E]=this.decodeIFD({kind:E,ignoreImageData:!0}),this.offset=b}this.seek(n),this.skip(12)}decodeImageData(r){const n=r.orientation;switch(n&&n!==1&&unsupported$1("orientation",n),r.type){case 1:case 2:this.readStripData(r);break;default:unsupported$1("image type",r.type);break}}readStripData(r){const n=r.width,a=r.height,u=validateBitDepth(r.bitsPerSample),f=r.sampleFormat;let _=n*a;const o=getDataArray$1(_,1,u,f),b=r.compression,M=r.rowsPerStrip*n,P=r.stripOffsets,L=r.stripByteCounts;for(var D=0,U=0;U<P.length;U++){var X=this.getStripData(b,P[U],L[U]),K=_>M?M:_;_-=K,u===8?D=fill8bit$1(o,X,D,K):u===16?D=fill16bit$1(o,X,D,K,this.isLittleEndian()):u===32&&f===3?D=fillFloat32$1(o,X,D,K,this.isLittleEndian()):unsupported$1("bitDepth",u)}r.data=o}getStripData(r,n,a){switch(r){case 1:return new DataView(this.buffer,n,a);case 2:case 32773:return unsupported$1("Compression",r);default:throw new Error("invalid compression: "+r)}}}var tiffDecoder=TIFFDecoder$2;function getDataArray$1(e,r,n,a){return n===8?new Uint8Array(e*r):n===16?new Uint16Array(e*r):n===32&&a===3?new Float32Array(e*r):unsupported$1("bit depth / sample format",n+" / "+a)}function fill8bit$1(e,r,n,a){for(var u=0;u<a;u++)e[n++]=r.getUint8(u);return n}function fill16bit$1(e,r,n,a,u){for(var f=0;f<a*2;f+=2)e[n++]=r.getUint16(f,u);return n}function fillFloat32$1(e,r,n,a,u){for(var f=0;f<a*4;f+=4)e[n++]=r.getFloat32(f,u);return n}function unsupported$1(e,r){throw new Error("Unsupported "+e+": "+r)}function validateBitDepth(e){if(e.length){const n=e;e=n[0];for(var r=0;r<n.length;r++)n[r]!==e&&unsupported$1("bit depth",n)}return e}const TIFFDecoder$1=tiffDecoder;var decode$2=function(r,n){return new TIFFDecoder$1(r,n).decode(n)};src$4.decode=decode$2;const IOBuffer=IOBuffer_1,tiff=src$4;function decode$1(e){const r=new IOBuffer(e),n={};if(r.setBigEndian(),r.readUint16()!==65496)throw new Error("SOI marker not found. Not a valid JPEG file");if(r.readUint16()===65505){r.readUint16();const f=r.readBytes(6);if(f[0]===69&&f[1]===120&&f[2]===105&&f[3]===102&&f[4]===0&&f[5]===0){const _=tiff.decode(r,{onlyFirst:!0,ignoreImageData:!0,offset:r.offset});n.exif=_}}return n}var decode_1=decode$1,decode=decode_1,imageType$2={exports:{}},fileType$1={exports:{}};(function(module){const toBytes=e=>[...e].map(r=>r.charCodeAt(0)),xpiZipFilename=toBytes("META-INF/mozilla.rsa"),oxmlContentTypes=toBytes("[Content_Types].xml"),oxmlRels=toBytes("_rels/.rels");function readUInt64LE(e,r=0){let n=e[r],a=1,u=0;for(;++u<8;)a*=256,n+=e[r+u]*a;return n}const fileType=e=>{if(!(e instanceof Uint8Array||e instanceof ArrayBuffer||Buffer.isBuffer(e)))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`Buffer\` or \`ArrayBuffer\`, got \`${typeof e}\``);const r=e instanceof Uint8Array?e:new Uint8Array(e);if(!(r&&r.length>1))return null;const n=(u,f)=>{f=Object.assign({offset:0},f);for(let _=0;_<u.length;_++)if(f.mask){if(u[_]!==(f.mask[_]&r[_+f.offset]))return!1}else if(u[_]!==r[_+f.offset])return!1;return!0},a=(u,f)=>n(toBytes(u),f);if(n([255,216,255]))return{ext:"jpg",mime:"image/jpeg"};if(n([137,80,78,71,13,10,26,10]))return{ext:"png",mime:"image/png"};if(n([71,73,70]))return{ext:"gif",mime:"image/gif"};if(n([87,69,66,80],{offset:8}))return{ext:"webp",mime:"image/webp"};if(n([70,76,73,70]))return{ext:"flif",mime:"image/flif"};if((n([73,73,42,0])||n([77,77,0,42]))&&n([67,82],{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(n([73,73,42,0])||n([77,77,0,42]))return{ext:"tif",mime:"image/tiff"};if(n([66,77]))return{ext:"bmp",mime:"image/bmp"};if(n([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(n([56,66,80,83]))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(n([80,75,3,4])){if(n([109,105,109,101,116,121,112,101,97,112,112,108,105,99,97,116,105,111,110,47,101,112,117,98,43,122,105,112],{offset:30}))return{ext:"epub",mime:"application/epub+zip"};if(n(xpiZipFilename,{offset:30}))return{ext:"xpi",mime:"application/x-xpinstall"};if(a("mimetypeapplication/vnd.oasis.opendocument.text",{offset:30}))return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};if(a("mimetypeapplication/vnd.oasis.opendocument.spreadsheet",{offset:30}))return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};if(a("mimetypeapplication/vnd.oasis.opendocument.presentation",{offset:30}))return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};const u=(b,E=0)=>b.findIndex((M,P,L)=>P>=E&&L[P]===80&&L[P+1]===75&&L[P+2]===3&&L[P+3]===4);let f=0,_=!1,o=null;do{const b=f+30;if(_||(_=n(oxmlContentTypes,{offset:b})||n(oxmlRels,{offset:b})),o||(a("word/",{offset:b})?o={ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}:a("ppt/",{offset:b})?o={ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}:a("xl/",{offset:b})&&(o={ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),_&&o)return o;f=u(r,b)}while(f>=0);if(o)return o}if(n([80,75])&&(r[2]===3||r[2]===5||r[2]===7)&&(r[3]===4||r[3]===6||r[3]===8))return{ext:"zip",mime:"application/zip"};if(n([117,115,116,97,114],{offset:257}))return{ext:"tar",mime:"application/x-tar"};if(n([82,97,114,33,26,7])&&(r[6]===0||r[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(n([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(n([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(n([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(n([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(n([51,103,112,53])||n([0,0,0])&&n([102,116,121,112],{offset:4})&&(n([109,112,52,49],{offset:8})||n([109,112,52,50],{offset:8})||n([105,115,111,109],{offset:8})||n([105,115,111,50],{offset:8})||n([109,109,112,52],{offset:8})||n([77,52,86],{offset:8})||n([100,97,115,104],{offset:8})))return{ext:"mp4",mime:"video/mp4"};if(n([77,84,104,100]))return{ext:"mid",mime:"audio/midi"};if(n([26,69,223,163])){const u=r.subarray(4,4100),f=u.findIndex((_,o,b)=>b[o]===66&&b[o+1]===130);if(f!==-1){const _=f+3,o=b=>[...b].every((E,M)=>u[_+M]===E.charCodeAt(0));if(o("matroska"))return{ext:"mkv",mime:"video/x-matroska"};if(o("webm"))return{ext:"webm",mime:"video/webm"}}}if(n([0,0,0,20,102,116,121,112,113,116,32,32])||n([102,114,101,101],{offset:4})||n([102,116,121,112,113,116,32,32],{offset:4})||n([109,100,97,116],{offset:4})||n([109,111,111,118],{offset:4})||n([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(n([82,73,70,70])){if(n([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(n([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/vnd.wave"};if(n([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(n([48,38,178,117,142,102,207,17,166,217])){let u=30;do{const f=readUInt64LE(r,u+16);if(n([145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101],{offset:u})){if(n([64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43],{offset:u+24}))return{ext:"wma",mime:"audio/x-ms-wma"};if(n([192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43],{offset:u+24}))return{ext:"wmv",mime:"video/x-ms-asf"};break}u+=f}while(u+24<=r.length);return{ext:"asf",mime:"application/vnd.ms-asf"}}if(n([0,0,1,186])||n([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(n([102,116,121,112,51,103],{offset:4}))return{ext:"3gp",mime:"video/3gpp"};for(let u=0;u<2&&u<r.length-16;u++){if(n([73,68,51],{offset:u})||n([255,226],{offset:u,mask:[255,226]}))return{ext:"mp3",mime:"audio/mpeg"};if(n([255,228],{offset:u,mask:[255,228]}))return{ext:"mp2",mime:"audio/mpeg"};if(n([255,248],{offset:u,mask:[255,252]}))return{ext:"mp2",mime:"audio/mpeg"};if(n([255,240],{offset:u,mask:[255,252]}))return{ext:"mp4",mime:"audio/mpeg"}}if(n([102,116,121,112,77,52,65],{offset:4}))return{ext:"m4a",mime:"audio/mp4"};if(n([79,112,117,115,72,101,97,100],{offset:28}))return{ext:"opus",mime:"audio/opus"};if(n([79,103,103,83]))return n([128,116,104,101,111,114,97],{offset:28})?{ext:"ogv",mime:"video/ogg"}:n([1,118,105,100,101,111,0],{offset:28})?{ext:"ogm",mime:"video/ogg"}:n([127,70,76,65,67],{offset:28})?{ext:"oga",mime:"audio/ogg"}:n([83,112,101,101,120,32,32],{offset:28})?{ext:"spx",mime:"audio/ogg"}:n([1,118,111,114,98,105,115],{offset:28})?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"};if(n([102,76,97,67]))return{ext:"flac",mime:"audio/x-flac"};if(n([77,65,67,32]))return{ext:"ape",mime:"audio/ape"};if(n([119,118,112,107]))return{ext:"wv",mime:"audio/wavpack"};if(n([35,33,65,77,82,10]))return{ext:"amr",mime:"audio/amr"};if(n([37,80,68,70]))return{ext:"pdf",mime:"application/pdf"};if(n([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if((r[0]===67||r[0]===70)&&n([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(n([123,92,114,116,102]))return{ext:"rtf",mime:"application/rtf"};if(n([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(n([119,79,70,70])&&(n([0,1,0,0],{offset:4})||n([79,84,84,79],{offset:4})))return{ext:"woff",mime:"font/woff"};if(n([119,79,70,50])&&(n([0,1,0,0],{offset:4})||n([79,84,84,79],{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(n([76,80],{offset:34})&&(n([0,0,1],{offset:8})||n([1,0,2],{offset:8})||n([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(n([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(n([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(n([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(n([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(n([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(n([37,33]))return{ext:"ps",mime:"application/postscript"};if(n([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(n([83,81,76,105]))return{ext:"sqlite",mime:"application/x-sqlite3"};if(n([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(n([67,114,50,52]))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(n([77,83,67,70])||n([73,83,99,40]))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(n([33,60,97,114,99,104,62,10,100,101,98,105,97,110,45,98,105,110,97,114,121]))return{ext:"deb",mime:"application/x-deb"};if(n([33,60,97,114,99,104,62]))return{ext:"ar",mime:"application/x-unix-archive"};if(n([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(n([31,160])||n([31,157]))return{ext:"Z",mime:"application/x-compress"};if(n([76,90,73,80]))return{ext:"lz",mime:"application/x-lzip"};if(n([208,207,17,224,161,177,26,225]))return{ext:"msi",mime:"application/x-msi"};if(n([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(n([71],{offset:4})&&(n([71],{offset:192})||n([71],{offset:196})))return{ext:"mts",mime:"video/mp2t"};if(n([66,76,69,78,68,69,82]))return{ext:"blend",mime:"application/x-blender"};if(n([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(n([0,0,0,12,106,80,32,32,13,10,135,10])){if(n([106,112,50,32],{offset:20}))return{ext:"jp2",mime:"image/jp2"};if(n([106,112,120,32],{offset:20}))return{ext:"jpx",mime:"image/jpx"};if(n([106,112,109,32],{offset:20}))return{ext:"jpm",mime:"image/jpm"};if(n([109,106,112,50],{offset:20}))return{ext:"mj2",mime:"image/mj2"}}if(n([70,79,82,77]))return{ext:"aif",mime:"audio/aiff"};if(a("<?xml "))return{ext:"xml",mime:"application/xml"};if(n([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(n([102,116,121,112],{offset:4})){if(n([109,105,102,49],{offset:8}))return{ext:"heic",mime:"image/heif"};if(n([109,115,102,49],{offset:8}))return{ext:"heic",mime:"image/heif-sequence"};if(n([104,101,105,99],{offset:8})||n([104,101,105,120],{offset:8}))return{ext:"heic",mime:"image/heic"};if(n([104,101,118,99],{offset:8})||n([104,101,118,120],{offset:8}))return{ext:"heic",mime:"image/heic-sequence"}}return n([171,75,84,88,32,49,49,187,13,10,26,10])?{ext:"ktx",mime:"image/ktx"}:n([68,73,67,77],{offset:128})?{ext:"dcm",mime:"application/dicom"}:n([77,80,43])?{ext:"mpc",mime:"audio/x-musepack"}:n([77,80,67,75])?{ext:"mpc",mime:"audio/x-musepack"}:n([66,69,71,73,78,58])?{ext:"ics",mime:"text/calendar"}:n([103,108,84,70,2,0,0,0])?{ext:"glb",mime:"model/gltf-binary"}:n([212,195,178,161])||n([161,178,195,212])?{ext:"pcap",mime:"application/vnd.tcpdump.pcap"}:null};module.exports=fileType,module.exports.default=fileType,Object.defineProperty(fileType,"minimumBytes",{value:4100}),module.exports.stream=readableStream=>new Promise((resolve,reject)=>{const stream=eval("require")("stream");readableStream.once("readable",()=>{const e=new stream.PassThrough,r=readableStream.read(module.exports.minimumBytes)||readableStream.read();try{e.fileType=fileType(r)}catch(n){reject(n)}readableStream.unshift(r),stream.pipeline?resolve(stream.pipeline(readableStream,e,()=>{})):resolve(readableStream.pipe(e))})})})(fileType$1);const fileType=fileType$1.exports,imageExts=new Set(["jpg","png","gif","webp","flif","cr2","tif","bmp","jxr","psd","ico","bpg","jp2","jpm","jpx","heic","cur","dcm"]),imageType=e=>{const r=fileType(e);return imageExts.has(r&&r.ext)?r:null};imageType$2.exports=imageType;imageType$2.exports.default=imageType;Object.defineProperty(imageType,"minimumBytes",{value:fileType.minimumBytes});var imageType$1=imageType$2.exports;function guessStripByteCounts(e){if(e.compression!==1)throw new Error("missing mandatory StripByteCounts field in compressed image");const r=e.rowsPerStrip*e.width*e.samplesPerPixel*(e.bitsPerSample/8);return new Array(e.stripOffsets.length).fill(r)}function applyHorizontalDifferencing8Bit(e,r,n){let a=0;for(;a<e.length;){for(let u=n;u<r*n;u+=n)for(let f=0;f<n;f++)e[a+u+f]=e[a+u+f]+e[a+u-(n-f)]&255;a+=r*n}}function applyHorizontalDifferencing16Bit(e,r,n){let a=0;for(;a<e.length;){for(let u=n;u<r*n;u+=n)for(let f=0;f<n;f++)e[a+u+f]=e[a+u+f]+e[a+u-(n-f)]&65535;a+=r*n}}const tagsById$2={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$2={};for(let e in tagsById$2)tagsByName$2[tagsById$2[e]]=Number(e);var exif=Object.freeze(Object.defineProperty({__proto__:null,tagsById:tagsById$2,tagsByName:tagsByName$2},Symbol.toStringTag,{value:"Module"}));const tagsById$1={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$1={};for(let e in tagsById$1)tagsByName$1[tagsById$1[e]]=Number(e);var gps=Object.freeze(Object.defineProperty({__proto__:null,tagsById:tagsById$1,tagsByName:tagsByName$1},Symbol.toStringTag,{value:"Module"}));const tagsById={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName={};for(let e in tagsById)tagsByName[tagsById[e]]=Number(e);var standard=Object.freeze(Object.defineProperty({__proto__:null,tagsById,tagsByName},Symbol.toStringTag,{value:"Module"}));const tags={standard,exif,gps};class IFD{constructor(r){if(!r)throw new Error("missing kind");this.data=new Uint8Array,this.fields=new Map,this.kind=r,this._hasMap=!1,this._map={}}get(r){if(typeof r=="number")return this.fields.get(r);if(typeof r=="string")return this.fields.get(tags[this.kind].tagsByName[r]);throw new Error("expected a number or string")}get map(){if(!this._hasMap){const r=tags[this.kind].tagsById;for(let n of this.fields.keys())r[n]&&(this._map[r[n]]=this.fields.get(n));this._hasMap=!0}return this._map}}let types=new Map([[1,[1,readByte]],[2,[1,readASCII]],[3,[2,readShort]],[4,[4,readLong]],[5,[8,readRational]],[6,[1,readSByte]],[7,[1,readByte]],[8,[2,readSShort]],[9,[4,readSLong]],[10,[8,readSRational]],[11,[4,readFloat]],[12,[8,readDouble]]]);function getByteLength(e,r){const n=types.get(e);if(!n)throw new Error(`type not found: ${e}`);return n[0]*r}function readData(e,r,n){const a=types.get(r);if(!a)throw new Error(`type not found: ${r}`);return a[1](e,n)}function readByte(e,r){if(r===1)return e.readUint8();let n=new Uint8Array(r);for(let a=0;a<r;a++)n[a]=e.readUint8();return n}function readASCII(e,r){let n=[],a="";for(let u=0;u<r;u++){let f=String.fromCharCode(e.readUint8());f==="\0"?(n.push(a),a=""):a+=f}return n.length===1?n[0]:n}function readShort(e,r){if(r===1)return e.readUint16();let n=new Uint16Array(r);for(let a=0;a<r;a++)n[a]=e.readUint16();return n}function readLong(e,r){if(r===1)return e.readUint32();let n=new Uint32Array(r);for(let a=0;a<r;a++)n[a]=e.readUint32();return n}function readRational(e,r){if(r===1)return e.readUint32()/e.readUint32();let n=new Array(r);for(let a=0;a<r;a++)n[a]=e.readUint32()/e.readUint32();return n}function readSByte(e,r){if(r===1)return e.readInt8();let n=new Int8Array(r);for(let a=0;a<r;a++)n[a]=e.readInt8();return n}function readSShort(e,r){if(r===1)return e.readInt16();let n=new Int16Array(r);for(let a=0;a<r;a++)n[a]=e.readInt16();return n}function readSLong(e,r){if(r===1)return e.readInt32();let n=new Int32Array(r);for(let a=0;a<r;a++)n[a]=e.readInt32();return n}function readSRational(e,r){if(r===1)return e.readInt32()/e.readInt32();let n=new Array(r);for(let a=0;a<r;a++)n[a]=e.readInt32()/e.readInt32();return n}function readFloat(e,r){if(r===1)return e.readFloat32();let n=new Float32Array(r);for(let a=0;a<r;a++)n[a]=e.readFloat32();return n}function readDouble(e,r){if(r===1)return e.readFloat64();let n=new Float64Array(r);for(let a=0;a<r;a++)n[a]=e.readFloat64();return n}const CLEAR_CODE=256,EOI_CODE=257,TABLE_START=258,MIN_BIT_LENGTH=9;let stringTable=[];function initializeStringTable(){if(stringTable.length===0){for(let r=0;r<256;r++)stringTable.push([r]);const e=[];for(let r=256;r<4096;r++)stringTable.push(e)}}const andTable=[511,1023,2047,4095],bitJumps=[0,0,0,0,0,0,0,0,0,511,1023,2047,4095];class LzwDecoder{constructor(r){this.nextData=0,this.nextBits=0,this.bytePointer=0,this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH,this.stripArray=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),this.outData=new IOBuffer$4(r.byteLength),this.initializeTable()}decode(){let r=0,n=0;for(;(r=this.getNextCode())!==EOI_CODE;)if(r===CLEAR_CODE){if(this.initializeTable(),r=this.getNextCode(),r===EOI_CODE)break;this.writeString(this.stringFromCode(r)),n=r}else if(this.isInTable(r))this.writeString(this.stringFromCode(r)),this.addStringToTable(this.stringFromCode(n).concat(this.stringFromCode(r)[0])),n=r;else{const u=this.stringFromCode(n).concat(this.stringFromCode(n)[0]);this.writeString(u),this.addStringToTable(u),n=r}const a=this.outData.toArray();return new DataView(a.buffer,a.byteOffset,a.byteLength)}initializeTable(){initializeStringTable(),this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH}writeString(r){this.outData.writeBytes(r)}stringFromCode(r){return stringTable[r]}isInTable(r){return r<this.tableLength}addStringToTable(r){if(stringTable[this.tableLength++]=r,stringTable.length>4096)throw stringTable=[],new Error("LZW decoding error. Please open an issue at https://github.com/image-js/tiff/issues/new/choose (include a test image).");this.tableLength===bitJumps[this.currentBitLength]&&this.currentBitLength++}getNextCode(){this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8,this.nextBits<this.currentBitLength&&(this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8);const r=this.nextData>>this.nextBits-this.currentBitLength&andTable[this.currentBitLength-9];return this.nextBits-=this.currentBitLength,this.bytePointer>this.stripArray.length?257:r}}function decompressLzw(e){return new LzwDecoder(e).decode()}const dateTimeRegex=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd extends IFD{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){let r=new Date,n=dateTimeRegex.exec(this.dateTime);if(n===null)throw new Error(`invalid dateTime: ${this.dateTime}`);return r.setFullYear(Number(n[1]),Number(n[2])-1,Number(n[3])),r.setHours(Number(n[4]),Number(n[5]),Number(n[6])),r}get newSubfileType(){return this.get("NewSubfileType")}get imageWidth(){return this.get("ImageWidth")}get imageLength(){return this.get("ImageLength")}get bitsPerSample(){const r=this.get("BitsPerSample");return r&&typeof r!="number"?r[0]:r}get alpha(){const r=this.extraSamples;return r?r[0]!==0:!1}get associatedAlpha(){const r=this.extraSamples;return r?r[0]===1:!1}get extraSamples(){return alwaysArray(this.get("ExtraSamples"))}get compression(){return this.get("Compression")||1}get type(){return this.get("PhotometricInterpretation")}get fillOrder(){return this.get("FillOrder")||1}get documentName(){return this.get("DocumentName")}get imageDescription(){return this.get("ImageDescription")}get stripOffsets(){return alwaysArray(this.get("StripOffsets"))}get orientation(){return this.get("Orientation")}get samplesPerPixel(){return this.get("SamplesPerPixel")||1}get rowsPerStrip(){return this.get("RowsPerStrip")}get stripByteCounts(){return alwaysArray(this.get("StripByteCounts"))}get minSampleValue(){return this.get("MinSampleValue")||0}get maxSampleValue(){return this.get("MaxSampleValue")||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get("XResolution")}get yResolution(){return this.get("YResolution")}get planarConfiguration(){return this.get("PlanarConfiguration")||1}get resolutionUnit(){return this.get("ResolutionUnit")||2}get dateTime(){return this.get("DateTime")}get predictor(){return this.get("Predictor")||1}get sampleFormat(){return this.get("SampleFormat")||1}get sMinSampleValue(){return this.get("SMinSampleValue")||this.minSampleValue}get sMaxSampleValue(){return this.get("SMaxSampleValue")||this.maxSampleValue}get palette(){const r=2**this.bitsPerSample,n=this.get("ColorMap");if(!n)return;if(n.length!==3*r)throw new Error(`ColorMap size must be ${r}`);const a=[];for(let u=0;u<r;u++)a.push([n[u],n[u+r],n[u+2*r]]);return a}}function alwaysArray(e){return typeof e=="number"?[e]:e}function decompressZlib(e){const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=inflate_1(r);return new DataView(n.buffer,n.byteOffset,n.byteLength)}const defaultOptions$c={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder extends IOBuffer$4{constructor(r){super(r),this._nextIFD=0}get isMultiPage(){let r=0;for(this.decodeHeader();this._nextIFD;)if(r++,this.decodeIFD({ignoreImageData:!0},!0),r===2)return!0;if(r===1)return!1;throw unsupported("ifdCount",r)}get pageCount(){let r=0;for(this.decodeHeader();this._nextIFD;)r++,this.decodeIFD({ignoreImageData:!0},!0);if(r>0)return r;throw unsupported("ifdCount",r)}decode(r={}){r=Object.assign({},defaultOptions$c,r);const n=[];for(this.decodeHeader();this._nextIFD;)if(n.push(this.decodeIFD(r,!0)),r.onlyFirst)return[n[0]];return n}decodeHeader(){const r=this.readUint16();if(r===18761)this.setLittleEndian();else if(r===19789)this.setBigEndian();else throw new Error(`invalid byte order: 0x${r.toString(16)}`);if(this.readUint16()!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(r,n){this.seek(this._nextIFD);let a;if(n)a=new TiffIfd;else{if(!r.kind)throw new Error("kind is missing");a=new IFD(r.kind)}const u=this.readUint16();for(let f=0;f<u;f++)this.decodeIFDEntry(a);if(!r.ignoreImageData){if(!(a instanceof TiffIfd))throw new Error("must be a tiff ifd");this.decodeImageData(a)}return this._nextIFD=this.readUint32(),a}decodeIFDEntry(r){const n=this.offset,a=this.readUint16(),u=this.readUint16(),f=this.readUint32();if(u<1||u>12){this.skip(4);return}getByteLength(u,f)>4&&this.seek(this.readUint32());const o=readData(this,u,f);if(r.fields.set(a,o),a===34665||a===34853){let b=this.offset,E="exif";a===34665?E="exif":a===34853&&(E="gps"),this._nextIFD=o,r[E]=this.decodeIFD({kind:E,ignoreImageData:!0},!1),this.offset=b}this.seek(n),this.skip(12)}decodeImageData(r){const n=r.orientation;if(n&&n!==1)throw unsupported("orientation",n);switch(r.type){case 0:case 1:case 2:case 3:this.readStripData(r);break;default:throw unsupported("image type",r.type)}if(this.applyPredictor(r),this.convertAlpha(r),r.type===0){const a=r.bitsPerSample,u=Math.pow(2,a)-1;for(let f=0;f<r.data.length;f++)r.data[f]=u-r.data[f]}}readStripData(r){const n=r.width,a=r.height,u=r.bitsPerSample,f=r.sampleFormat,_=n*a*r.samplesPerPixel,o=getDataArray(_,u,f),E=r.rowsPerStrip*n*r.samplesPerPixel,M=r.stripOffsets,P=r.stripByteCounts||guessStripByteCounts(r);let L=_,D=0;for(let U=0;U<M.length;U++){let X=new DataView(this.buffer,this.byteOffset+M[U],P[U]),K=L>E?E:L;L-=K;let q=X;switch(r.compression){case 1:break;case 5:{q=decompressLzw(X);break}case 8:{q=decompressZlib(X);break}case 2:throw unsupported("Compression","CCITT Group 3");case 32773:throw unsupported("Compression","PackBits");default:throw unsupported("Compression",r.compression)}D=this.fillUncompressed(u,f,o,q,D,K)}r.data=o}fillUncompressed(r,n,a,u,f,_){if(r===8)return fill8bit(a,u,f,_);if(r===16)return fill16bit(a,u,f,_,this.isLittleEndian());if(r===32&&n===3)return fillFloat32(a,u,f,_,this.isLittleEndian());throw unsupported("bitDepth",r)}applyPredictor(r){const n=r.bitsPerSample;switch(r.predictor){case 1:break;case 2:{if(n===8)applyHorizontalDifferencing8Bit(r.data,r.width,r.components);else if(n===16)applyHorizontalDifferencing16Bit(r.data,r.width,r.components);else throw new Error(`Horizontal differencing is only supported for images with a bit depth of ${n}`);break}default:throw new Error(`invalid predictor: ${r.predictor}`)}}convertAlpha(r){if(r.alpha&&r.associatedAlpha){const{data:n,components:a,maxSampleValue:u}=r;for(let f=0;f<n.length;f+=a){const _=n[f+a-1];for(let o=0;o<a-1;o++)n[f+o]=Math.round(n[f+o]*u/_)}}}}function getDataArray(e,r,n){if(r===8)return new Uint8Array(e);if(r===16)return new Uint16Array(e);if(r===32&&n===3)return new Float32Array(e);throw unsupported("bit depth / sample format",`${r} / ${n}`)}function fill8bit(e,r,n,a){for(let u=0;u<a;u++)e[n++]=r.getUint8(u);return n}function fill16bit(e,r,n,a,u){for(let f=0;f<a*2;f+=2)e[n++]=r.getUint16(f,u);return n}function fillFloat32(e,r,n,a,u){for(let f=0;f<a*4;f+=4)e[n++]=r.getFloat32(f,u);return n}function unsupported(e,r){return new Error(`Unsupported ${e}: ${r}`)}function decodeTIFF(e,r){return new TIFFDecoder(e).decode(r)}function matchAndCrop(e={}){let{algorithm:r="matchToPrevious",ignoreBorder:n=[0,0]}=e;this.checkProcessable("matchAndCrop",{bitDepth:[8,16]});let a=r==="matchToPrevious",u=this[0],f=[];f[0]={position:[0,0],image:this[0]};let _=[0,0];for(let L=1;L<this.length;L++){let D=u.getBestMatch(this[L],{border:n});f[L]={position:[D[0]+_[0],D[1]+_[1]],image:this[L]},a&&(_[0]+=D[0],_[1]+=D[1],u=this[L])}let o=0,b=0,E=0,M=0;for(let L=0;L<f.length;L++){let D=f[L];D.position[0]>o&&(o=D.position[0]),D.position[0]<b&&(b=D.position[0]),D.position[1]>E&&(E=D.position[1]),D.position[1]<M&&(M=D.position[1])}b=0-b,M=0-M;for(let L=0;L<f.length;L++){let D=f[L];D.crop=D.image.crop({x:o-D.position[0],y:E-D.position[1],width:u.width-b-o,height:u.height-M-E})}let P=[];for(let L=0;L<f.length;L++)P[L]=f[L].crop;return new Stack(P)}function min$2(){this.checkProcessable("min",{bitDepth:[8,16]});let e=this[0].min;for(let r=1;r<this.length;r++)for(let n=0;n<e.length;n++)e[n]=Math.min(e[n],this[r].min[n]);return e}function max$2(){this.checkProcessable("min",{bitDepth:[8,16]});let e=this[0].max;for(let r=1;r<this.length;r++)for(let n=0;n<e.length;n++)e[n]=Math.max(e[n],this[r].max[n]);return e}function median$2(e){let r=e.reduce((_,o)=>_+o);if(r===0)throw new Error("unreachable");let n=0,a=0,u=r/2,f;for(;;){if(e[n]>0){if(f!==void 0)return(f+n)/2;if(a+=e[n],a>u)return n;a===u&&(f=n)}n++}}function mean$2(e){let r=0,n=0;for(let a=0;a<e.length;a++)r+=e[a],n+=e[a]*a;return r===0?0:n/r}function median$1(){this.checkProcessable("median",{bitDepth:[8,16]});let e=this.getHistograms({maxSlots:this[0].maxValue+1}),r=new Array(e.length);for(let n=0;n<e.length;n++){let a=e[n];r[n]=median$2(a)}return r}function histogram(e){this.checkProcessable("min",{bitDepth:[8,16]});let r=this[0].getHistogram(e);for(let n=1;n<this.length;n++){let a=this[n].getHistogram(e);for(let u=0;u<r.length;u++)r[u]+=a[u]}return r}function histograms(e){this.checkProcessable("min",{bitDepth:[8,16]});let r=this[0].getHistograms(e),n=r[0].length;for(let a=1;a<this.length;a++){let u=this[a].getHistograms(e);for(let f=0;f<r.length;f++)for(let _=0;_<n;_++)r[f][_]+=u[f][_]}return r}function averageImage(){this.checkProcessable("averageImage",{bitDepth:[8,16]});let e=new Uint32Array(this[0].data.length);for(let a=0;a<this.length;a++){let u=this[a];for(let f=0;f<this[0].data.length;f++)e[f]+=u.data[f]}let r=Image.createFrom(this[0]),n=r.data;for(let a=0;a<this[0].data.length;a++)n[a]=e[a]/this.length;return r}function maxImage(){this.checkProcessable("max",{bitDepth:[8,16]});let e=Image.createFrom(this[0]);e.data.fill(0);for(const r of this)for(let n=0;n<e.data.length;n++)e.data[n]=Math.max(r.data[n],e.data[n]);return e}function minImage(){this.checkProcessable("max",{bitDepth:[8,16]});let e=Image.createFrom(this[0]);e.data.fill(e.maxValue);for(const r of this)for(let n=0;n<e.data.length;n++)e.data[n]=Math.min(r.data[n],e.data[n]);return e}function extend$5(e){e.extendMethod("matchAndCrop",matchAndCrop),e.extendMethod("getMin",min$2),e.extendMethod("getMax",max$2),e.extendMethod("getMedian",median$1),e.extendMethod("getHistogram",histogram),e.extendMethod("getHistograms",histograms),e.extendMethod("getAverage",averageImage),e.extendMethod("getAverageImage",averageImage),e.extendMethod("getMaxImage",maxImage),e.extendMethod("getMinImage",minImage)}let computedPropertyDescriptor={configurable:!0,enumerable:!1,get:void 0};class Stack extends Array{constructor(r){if(Array.isArray(r)){super(r.length);for(let n=0;n<r.length;n++)this[n]=r[n]}else typeof r=="number"?super(r):super();this.computed=null}static load(r){return Promise.all(r.map(Image.load)).then(n=>new Stack(n))}static extendMethod(r,n,a={}){let{inPlace:u=!1,returnThis:f=!0,partialArgs:_=[]}=a;return u?Stack.prototype[r]=function(...o){this.computed=null;let b=n.apply(this,[..._,...o]);return f?this:b}:Stack.prototype[r]=function(...o){return n.apply(this,[..._,...o])},Stack}static extendProperty(r,n,a={}){let{partialArgs:u=[]}=a;return computedPropertyDescriptor.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(r,this.computed))return this.computed[r];let f=n.apply(this,u);return this.computed[r]=f,f},Object.defineProperty(Stack.prototype,r,computedPropertyDescriptor),Stack}checkProcessable(r,n={}){if(typeof r!="string")throw new TypeError("checkProcessable requires as first parameter the processName (a string)");if(this.size===0)throw new TypeError(`The process: ${r} can not be applied on an empty stack`);this[0].checkProcessable(r,n);for(let a=1;a<this.length;a++){if((n.sameSize===void 0||n.sameSize)&&this[0].width!==this[a].width)throw new TypeError(`The process: ${r} can not be applied if width is not identical in all images`);if((n.sameSize===void 0||n.sameSize)&&this[0].height!==this[a].height)throw new TypeError(`The process: ${r} can not be applied if height is not identical in all images`);if((n.sameAlpha===void 0||n.sameAlpha)&&this[0].alpha!==this[a].alpha)throw new TypeError(`The process: ${r} can not be applied if alpha is not identical in all images`);if((n.sameBitDepth===void 0||n.sameBitDepth)&&this[0].bitDepth!==this[a].bitDepth)throw new TypeError(`The process: ${r} can not be applied if bitDepth is not identical in all images`);if((n.sameColorModel===void 0||n.sameColorModel)&&this[0].colorModel!==this[a].colorModel)throw new TypeError(`The process: ${r} can not be applied if colorModel is not identical in all images`);if((n.sameNumberChannels===void 0||n.sameNumberChannels)&&this[0].channels!==this[a].channels)throw new TypeError(`The process: ${r} can not be applied if channels is not identical in all images`)}}}Array[Symbol.species]||(Stack.prototype.map=function(e,r){if(typeof e!="function")throw new TypeError(`${e} is not a function`);let n=new Stack(this.length);for(let a=0;a<this.length;a++)n[a]=e.call(r,this[a],a,this);return n});extend$5(Stack);const isDataURL=/^data:[a-z]+\/(?:[a-z]+);base64,/;function load(e,r){if(typeof e=="string")return loadURL(e,r);if(e instanceof ArrayBuffer)return Promise.resolve(loadBinary(new Uint8Array(e),void 0,r&&r.ignorePalette));if(e.buffer)return Promise.resolve(loadBinary(e,void 0,r&&r.ignorePalette));throw new Error('argument to "load" must be a string or buffer.')}function loadBinary(e,r,n){const a=imageType$1(e);if(a)switch(a.mime){case"image/png":return loadPNG(e);case"image/jpeg":return loadJPEG(e);case"image/tiff":return loadTIFF(e,n);default:return loadGeneric(u(a.mime))}return loadGeneric(u("application/octet-stream"));function u(f){return r||toBase64URL(e,f)}}function loadURL(e,r){const n=e.slice(0,64).match(isDataURL);let a;return n!==null?a=Promise.resolve(decode$3(e.slice(n[0].length))):a=fetchBinary(e,r),a.then(u=>{const f=new Uint8Array(u);return loadBinary(f,n?e:void 0,r&&r.ignorePalette)})}function loadPNG(e){const r=decodePng(e);let n=r.channels,a,u=0;return n===2||n===4?(a=n-1,u=1):a=n,r.palette?loadPNGFromPalette(r):new Image(r.width,r.height,r.data,{components:a,alpha:u,bitDepth:r.depth})}function loadPNGFromPalette(e){const r=e.width*e.height,n=e.palette[0].length,a=new Uint8Array(r*n),u=8/e.depth,f=e.depth<8?u:1,_=parseInt("1".repeat(e.depth),2),o=n===4;let b=0;for(let E=0;E<r;E++){const M=Math.floor(E/f);let P=e.data[M];e.depth<8&&(P=P>>>e.depth*(u-1-E%u)&_);const L=e.palette[P];a[b++]=L[0],a[b++]=L[1],a[b++]=L[2],o&&(a[b++]=L[3])}return new Image(e.width,e.height,a,{components:3,alpha:o,bitDepth:8})}function loadJPEG(e){const r=decode(e);let n;r.exif&&(n=getMetadata(r.exif));const a=jpegJs.decode(e,{useTArray:!0,maxMemoryUsageInMB:1024});let u=new Image(a.width,a.height,a.data,{meta:n});if(n&&n.tiff.tags.Orientation){const f=n.tiff.tags.Orientation;f>2&&(u=u.rotate({3:180,4:180,5:90,6:90,7:270,8:270}[f])),[2,4,5,7].includes(f)&&(u=u.flipX())}return u}function loadTIFF(e,r){let n=decodeTIFF(e);return n.length===1?getImageFromIFD(n[0],r):new Stack(n.map(function(a){return getImageFromIFD(a,r)}))}function getMetadata(e){const r={tiff:{fields:e.fields,tags:e.map}};return e.exif&&(r.exif=e.exif),e.gps&&(r.gps=e.gps),r}function getImageFromIFD(e,r){if(!r&&e.type===3){const n=new Uint16Array(3*e.width*e.height),a=e.palette;let u=0;for(let f=0;f<e.data.length;f++){const _=e.data[f],o=a[_];n[u++]=o[0],n[u++]=o[1],n[u++]=o[2]}return new Image(e.width,e.height,n,{components:3,alpha:e.alpha,colorModel:RGB$1,bitDepth:16,meta:getMetadata(e)})}else return new Image(e.width,e.height,e.data,{components:e.type===2?3:1,alpha:e.alpha,colorModel:e.type===2?RGB$1:GREY$1,bitDepth:e.bitsPerSample.length?e.bitsPerSample[0]:e.bitsPerSample,meta:getMetadata(e)})}function loadGeneric(e,r){return r=r||{},new Promise(function(n,a){let u=new DOMImage;u.onload=function(){let f=u.width,_=u.height,b=createCanvas(f,_).getContext("2d");b.drawImage(u,0,0,f,_);let E=b.getImageData(0,0,f,_).data;n(new Image(f,_,E,r))},u.onerror=function(){a(new Error(`Could not load ${e}`))},u.src=e})}const valueMethods={getValueXY(e,r,n){return this.data[(r*this.width+e)*this.channels+n]},setValueXY(e,r,n,a){return this.data[(r*this.width+e)*this.channels+n]=a,this.computed=null,this},getValue(e,r){return this.data[e*this.channels+r]},setValue(e,r,n){return this.data[e*this.channels+r]=n,this.computed=null,this},getPixelXY(e,r){return this.getPixel(r*this.width+e)},setPixelXY(e,r,n){return this.setPixel(r*this.width+e,n)},getPixel(e){const r=new Array(this.channels),n=e*this.channels;for(let a=0;a<this.channels;a++)r[a]=this.data[n+a];return r},setPixel(e,r){const n=e*this.channels;for(let a=0;a<r.length;a++)this.data[n+a]=r[a];return this.computed=null,this}};function setValueMethods(e){for(const r in valueMethods)e.prototype[r]=valueMethods[r]}function getImageParameters(e){return{width:e.width,height:e.height,components:e.components,alpha:e.alpha,colorModel:e.colorModel,bitDepth:e.bitDepth}}function getOutputImage(e,r,n,a={}){const{out:u}=r;if(u===void 0)return a.copy?e.clone():Image.createFrom(e,n);{if(!Image.isImage(u))throw new TypeError("out must be an Image object");const f=Object.assign(getImageParameters(e),n);for(const _ in f)if(u[_]!==f[_])throw new RangeError(`cannot use out. Its ${_} must be "${f[_]}" (found "${u[_]}")`);return u}}function getOutputImageOrInPlace(e,r,n){if(r.inPlace!==void 0&&typeof r.inPlace!="boolean")throw new TypeError("inPlace option must be a boolean");if(r.inPlace){if(r.out!==void 0)throw new TypeError("out option must not be set if inPlace option is true");return e}return getOutputImage(e,r,null,n)}function abs(e={}){this.checkProcessable("abs",{bitDepth:[32]});const r=getOutputImageOrInPlace(this,e);return absolute(this,r),r}function absolute(e,r){for(let n=0;n<e.data.length;n++)r.data[n]=Math.abs(e.data[n])}function copyAlphaChannel(e,r){if(e.alpha===1&&r.alpha===1)for(let n=0;n<e.size;n++)r.data[n*r.channels+r.components]=e.data[n*e.channels+e.components]}function invert(e={}){this.checkProcessable("invert",{bitDepth:[1,8,16]});const r=getOutputImageOrInPlace(this,e);return this.bitDepth===1?invertBinary(this,r):(invertColor(this,r),this!==r&&copyAlphaChannel(this,r)),r}function invertBinary(e,r){for(let n=0;n<e.data.length;n++)r.data[n]=~e.data[n]}function invertColor(e,r){for(let n=0;n<e.data.length;n+=e.channels)for(let a=0;a<e.components;a++)r.data[n+a]=e.maxValue-e.data[n+a]}function flipX(){this.checkProcessable("flipX",{bitDepth:[8,16]});for(let e=0;e<this.height;e++){let r=e*this.width*this.channels;for(let n=0;n<Math.floor(this.width/2);n++){let a=n*this.channels+r,u=(this.width-n-1)*this.channels+r;for(let f=0;f<this.channels;f++){let _=this.data[a+f];this.data[a+f]=this.data[u+f],this.data[u+f]=_}}}return this}function flipY(){this.checkProcessable("flipY",{bitDepth:[8,16]});for(let e=0;e<Math.floor(this.height/2);e++)for(let r=0;r<this.width;r++){let n=r*this.channels+e*this.width*this.channels,a=r*this.channels+(this.height-1-e)*this.channels*this.width;for(let u=0;u<this.channels;u++){let f=this.data[n+u];this.data[n+u]=this.data[a+u],this.data[a+u]=f}}return this}function blurFilter(e={}){const{radius:r=1}=e;if(r<1)throw new Error("radius must be greater than 1");const n=2*r+1,a=new Array(n);for(let u=0;u<n;u++){a[u]=new Array(n);for(let f=0;f<n;f++)a[u][f]=1/(n*n)}return this.convolution(a)}var medianQuickselect_min={exports:{}};(function(e){(function(){function r(u){for(var f=0,_=u.length-1,o=void 0,b=void 0,E=void 0,M=a(f,_);;){if(_<=f)return u[M];if(_==f+1)return u[f]>u[_]&&n(u,f,_),u[M];for(o=a(f,_),u[o]>u[_]&&n(u,o,_),u[f]>u[_]&&n(u,f,_),u[o]>u[f]&&n(u,o,f),n(u,o,f+1),b=f+1,E=_;;){do b++;while(u[f]>u[b]);do E--;while(u[E]>u[f]);if(E<b)break;n(u,b,E)}n(u,f,E),E<=M&&(f=b),E>=M&&(_=E-1)}}var n=function(f,_,o){var b;return b=[f[o],f[_]],f[_]=b[0],f[o]=b[1],b},a=function(f,_){return~~((f+_)/2)};e.exports?e.exports=r:window.median=r})()})(medianQuickselect_min);var quickSelectMedian=medianQuickselect_min.exports;function validateArrayOfChannels(e,r={}){let{channels:n,allowAlpha:a,defaultAlpha:u}=r;return typeof a!="boolean"&&(a=!0),typeof n>"u"?allChannels(e,u):validateChannels(e,n,a)}function allChannels(e,r){let n=r?e.channels:e.components,a=new Array(n);for(let u=0;u<n;u++)a[u]=u;return a}function validateChannels(e,r,n){Array.isArray(r)||(r=[r]);for(let a=0;a<r.length;a++)r[a]=validateChannel(e,r[a],n);return r}function validateChannel(e,r,n=!0){if(r===void 0)throw new RangeError(`validateChannel : the channel has to be >=0 and <${e.channels}`);if(typeof r=="string"){switch(e.colorModel){case GREY$1:break;case RGB$1:if("rgb".includes(r))switch(r){case"r":r=0;break;case"g":r=1;break;case"b":r=2;break}break;case HSL:if("hsl".includes(r))switch(r){case"h":r=0;break;case"s":r=1;break;case"l":r=2;break}break;case HSV:if("hsv".includes(r))switch(r){case"h":r=0;break;case"s":r=1;break;case"v":r=2;break}break;case CMYK$1:if("cmyk".includes(r))switch(r){case"c":r=0;break;case"m":r=1;break;case"y":r=2;break;case"k":r=3;break}break;default:throw new Error(`Unexpected color model: ${e.colorModel}`)}if(r==="a"){if(!e.alpha)throw new Error("validateChannel : the image does not contain alpha channel");r=e.components}if(typeof r=="string")throw new Error(`validateChannel : undefined channel: ${r}`)}if(r>=e.channels)throw new RangeError(`validateChannel : the channel has to be >=0 and <${e.channels}`);if(!n&&r>=e.components)throw new RangeError("validateChannel : alpha channel may not be selected");return r}function medianFilter(e={}){let{radius:r=1,border:n="copy",channels:a}=e;if(this.checkProcessable("medianFilter",{bitDepth:[8,16]}),r<1)throw new Error("radius must be greater than 0");a=validateArrayOfChannels(this,a);let u=r,f=r,_=Image.createFrom(this),o=(u*2+1)*(f*2+1),b=new Array(o);for(let E=0;E<a.length;E++){let M=a[E];for(let P=f;P<this.height-f;P++)for(let L=u;L<this.width-u;L++){let D=0;for(let X=-f;X<=f;X++)for(let K=-u;K<=u;K++){let q=((P+X)*this.width+L+K)*this.channels+M;b[D++]=this.data[q]}let U=(P*this.width+L)*this.channels+M;_.data[U]=quickSelectMedian(b)}}if(this.alpha&&!a.includes(this.channels))for(let E=this.components;E<this.data.length;E=E+this.channels)_.data[E]=this.data[E];return _.setBorder({size:[u,f],algorithm:n}),_}function gaussianFilter(e={}){let{radius:r=1,sigma:n,channels:a,border:u="copy"}=e;this.checkProcessable("gaussian",{bitDepth:[8,16]});const f=getKernel(r,n);return this.convolution([f,f],{border:u,channels:a,algorithm:"separable"})}function getKernel(e,r){const n=e*2+1,a=new Array(n),u=r||((n-1)*.5-1)*.3+.8,f=-.5/(u*u);let _=0;for(let o=0;o<n;o++){const b=o-e,E=Math.exp(f*b*b);a[o]=E,_+=E}for(let o=0;o<n;o++)a[o]/=_;return a}const SOBEL_X=[[-1,0,1],[-2,0,2],[-1,0,1]],SOBEL_Y=[[-1,-2,-1],[0,0,0],[1,2,1]],SCHARR_X=[[3,0,-3],[10,0,-10],[3,0,-3]],SCHARR_Y=[[3,10,3],[0,0,0],[-3,-10,-3]];var src$3={},fftlib={};(function(e){(function(){var r;r=e;var n={release:"0.3.0",date:"2013-03"};r.toString=function(){return"version "+n.release+", released "+n.date};for(var a=0,u=null,f=null,_={init:function(E){if(E!==0&&(E&E-1)===0)a=E,_._initArray(),_._makeBitReversalTable(),_._makeCosSinTable();else throw new Error("init: radix-2 required")},fft1d:function(E,M){_.fft(E,M,1)},ifft1d:function(E,M){var P=1/a;_.fft(E,M,-1);for(var L=0;L<a;L++)E[L]*=P,M[L]*=P},bt1d:function(E,M){_.fft(E,M,-1)},fft2d:function(E,M){for(var P=[],L=[],D=0,U=0;U<a;U++){D=U*a;for(var X=0;X<a;X++)P[X]=E[X+D],L[X]=M[X+D];_.fft1d(P,L);for(var K=0;K<a;K++)E[K+D]=P[K],M[K+D]=L[K]}for(var q=0;q<a;q++){for(var oe=0;oe<a;oe++)D=q+oe*a,P[oe]=E[D],L[oe]=M[D];_.fft1d(P,L);for(var W=0;W<a;W++)D=q+W*a,E[D]=P[W],M[D]=L[W]}},ifft2d:function(E,M){for(var P=[],L=[],D=0,U=0;U<a;U++){D=U*a;for(var X=0;X<a;X++)P[X]=E[X+D],L[X]=M[X+D];_.ifft1d(P,L);for(var K=0;K<a;K++)E[K+D]=P[K],M[K+D]=L[K]}for(var q=0;q<a;q++){for(var oe=0;oe<a;oe++)D=q+oe*a,P[oe]=E[D],L[oe]=M[D];_.ifft1d(P,L);for(var W=0;W<a;W++)D=q+W*a,E[D]=P[W],M[D]=L[W]}},fft:function(E,M,P){for(var L,D,U,X,K,q,oe,W,Y,J=a>>2,Ee=0;Ee<a;Ee++)X=u[Ee],Ee<X&&(K=E[Ee],E[Ee]=E[X],E[X]=K,K=M[Ee],M[Ee]=M[X],M[X]=K);for(var xe=1;xe<a;xe<<=1){D=0,L=a/(xe<<1);for(var se=0;se<xe;se++){q=f[D+J],oe=P*f[D];for(var ce=se;ce<a;ce+=xe<<1)U=ce+xe,W=q*E[U]+oe*M[U],Y=q*M[U]-oe*E[U],E[U]=E[ce]-W,E[ce]+=W,M[U]=M[ce]-Y,M[ce]+=Y;D+=L}}},_initArray:function(){typeof Uint32Array<"u"?u=new Uint32Array(a):u=[],typeof Float64Array<"u"?f=new Float64Array(a*1.25):f=[]},_paddingZero:function(){},_makeBitReversalTable:function(){var E=0,M=0,P=0;for(u[0]=0;++E<a;){for(P=a>>1;P<=M;)M-=P,P>>=1;M+=P,u[E]=M}},_makeCosSinTable:function(){var E=a>>1,M=a>>2,P=a>>3,L=E+M,D=Math.sin(Math.PI/a),U=2*D*D,X=Math.sqrt(U*(2-U)),K=f[M]=1,q=f[0]=0;D=2*U;for(var oe=1;oe<P;oe++)K-=U,U+=D*K,q+=X,X-=D*q,f[oe]=q,f[M-oe]=K;P!==0&&(f[P]=Math.sqrt(.5));for(var W=0;W<M;W++)f[E-W]=f[W];for(var Y=0;Y<L;Y++)f[Y+E]=-f[Y]}},o=["init","fft1d","ifft1d","fft2d","ifft2d"],b=0;b<o.length;b++)r[o[b]]=_[o[b]];return r.bt=_.bt1d,r.fft=_.fft1d,r.ifft=_.ifft1d,r}).call(commonjsGlobal)})(fftlib);var FFT=fftlib,FFTUtils$1={DEBUG:!1,ifft2DArray:function(e,r,n){var a=new Array(r*n),u=r/2,f=(n-1)*2;FFT.init(u);for(var _={re:new Array(u),im:new Array(u)},o=0;o<n;o++){for(var b=u-1;b>=0;b--)_.re[b]=e[b*2*n+o],_.im[b]=e[(b*2+1)*n+o];FFT.bt(_.re,_.im);for(var b=u-1;b>=0;b--)a[b*2*n+o]=_.re[b],a[(b*2+1)*n+o]=_.im[b]}var E=new Array(u*f);FFT.init(f);for(var M={re:new Array(f),im:new Array(f)},P=f*u,b=0;b<r;b+=2){M.re[0]=a[b*n],M.im[0]=a[(b+1)*n];for(var o=1;o<n;o++)M.re[o]=a[b*n+o],M.im[o]=a[(b+1)*n+o],M.re[f-o]=a[b*n+o],M.im[f-o]=-a[(b+1)*n+o];FFT.bt(M.re,M.im);for(var L=b/2*f,o=f-1;o>=0;o--)E[L+o]=M.re[o]/P}return E},fft2DArray:function(e,r,n,a){Object.assign({},{inplace:!0});var u=n/2+1,f=r*2,_=new Array(f*u);FFT.init(n);for(var o={re:new Array(n),im:new Array(n)},b={re:new Array(n),im:new Array(n)},E={re:new Array(n),im:new Array(n)},M,P,L,D,U,X=0;X<r/2;X++){M=X*2*n,o.re=e.slice(M,M+n),M=(X*2+1)*n,o.im=e.slice(M,M+n),FFT.fft1d(o.re,o.im),this.reconstructTwoRealFFT(o,b,E),P=X*4*u,L=(X*4+1)*u,D=(X*4+2)*u,U=(X*4+3)*u;for(var K=u-1;K>=0;K--)_[P+K]=b.re[K],_[L+K]=b.im[K],_[D+K]=E.re[K],_[U+K]=E.im[K]}b=null,E=null;var q=new Array(f*u);FFT.init(r);for(var oe={re:new Array(r),im:new Array(r)},W=u-1;W>=0;W--){for(var X=r-1;X>=0;X--)oe.re[X]=_[X*2*u+W],oe.im[X]=_[(X*2+1)*u+W],isNaN(oe.re[X])&&(oe.re[X]=0),isNaN(oe.im[X])&&(oe.im[X]=0);FFT.fft1d(oe.re,oe.im);for(var X=r-1;X>=0;X--)q[X*2*u+W]=oe.re[X],q[(X*2+1)*u+W]=oe.im[X]}return q},reconstructTwoRealFFT:function(e,r,n){var a=e.re.length;r.re[0]=e.re[0],r.im[0]=0,n.re[0]=e.im[0],n.im[0]=0;for(var u,f,_,o,b,E=a/2;E>0;E--)b=a-E,u=.5*(e.re[E]-e.re[b]),f=.5*(e.re[E]+e.re[b]),_=.5*(e.im[E]-e.im[b]),o=.5*(e.im[E]+e.im[b]),r.re[E]=f,r.im[E]=_,r.re[b]=f,r.im[b]=-_,n.re[E]=o,n.im[E]=-u,n.re[b]=o,n.im[b]=u},convolute2DI:function(e,r,n,a){for(var u,f,_=0;_<n/2;_++)for(var o=0;o<a;o++)u=e[_*2*a+o]*r[_*2*a+o]-e[(_*2+1)*a+o]*r[(_*2+1)*a+o],f=e[_*2*a+o]*r[(_*2+1)*a+o]+e[(_*2+1)*a+o]*r[_*2*a+o],e[_*2*a+o]=u,e[(_*2+1)*a+o]=f},convolute:function(e,r,n,a,u){for(var f=new Array(a*n),_=0;_<n*a;_++)f[_]=e[_];f=this.fft2DArray(f,n,a);for(var o=r.length,b=r[0].length,E=new Array(a*n),_=0;_<a*n;_++)E[_]=0;for(var M,P,L=Math.floor((o-1)/2),D=Math.floor((b-1)/2),U=0;U<o;U++){M=(U-L+n)%n;for(var X=0;X<b;X++)P=(X-D+a)%a,E[M*a+P]=r[U][X]}E=this.fft2DArray(E,n,a);var K=n*2,q=a/2+1;return this.convolute2DI(f,E,K,q),this.ifft2DArray(f,K,q)},toRadix2:function(e,r,n){var a,u,f,_,o=n,b=r;if(!(n!==0&&(n&n-1)===0)){for(o=0;n>>++o!=0;);o=1<<o}if(!(r!==0&&(r&r-1)===0)){for(b=0;r>>++b!=0;);b=1<<b}if(b==r&&o==n)return{data:e,rows:r,cols:n};var E=new Array(b*o),M=Math.floor((b-r)/2)-r,P=Math.floor((o-n)/2)-n;for(a=0;a<b;a++)for(f=a*o,_=(a-M)%r*n,u=0;u<o;u++)E[f+u]=e[_+(u-P)%n];return{data:E,rows:b,cols:o}},crop:function(e,r,n,a,u,f){if(r==a&&n==u)return e;Object.assign({},f);var _=new Array(u*a),o=Math.floor((r-a)/2),b=Math.floor((n-u)/2),E,M,P,L;for(P=0;P<a;P++)for(E=P*u,M=(P+o)*n,L=0;L<u;L++)_[E+L]=e[M+(L+b)];return _}},FFTUtils_1=FFTUtils$1;src$3.FFTUtils=FFTUtils_1;src$3.FFT=fftlib;var FFTUtils=src$3.FFTUtils;function convolutionFFT(e,r,n){var a=matrix2Array(e),u=a.data,f=Object.assign({normalize:!1,divisor:1,rows:a.rows,cols:a.cols},n),_,o;if(f.rows&&f.cols)_=f.rows,o=f.cols;else throw new Error("Invalid number of rows or columns "+_+" "+o);var b=f.divisor,E,M,P=r.length,L=r[0].length;if(f.normalize)for(b=0,E=0;E<P;E++)for(M=0;M<L;M++)b+=r[E][M];if(b===0)throw new RangeError("convolution: The divisor is equal to zero");var D=FFTUtils.toRadix2(u,_,o),U=FFTUtils.convolute(D.data,r,D.rows,D.cols);if(U=FFTUtils.crop(U,D.rows,D.cols,_,o),b!=0&&b!=1)for(E=0;E<U.length;E++)U[E]/=b;return U}function convolutionDirect(e,r,n){var a=matrix2Array(e),u=a.data,f=Object.assign({normalize:!1,divisor:1,rows:a.rows,cols:a.cols},n),_,o;if(f.rows&&f.cols)_=f.rows,o=f.cols;else throw new Error("Invalid number of rows or columns "+_+" "+o);var b=f.divisor,E=r.length,M=r[0].length,P,L,D,U,X,K,q,oe,W;if(f.normalize)for(b=0,P=0;P<E;P++)for(L=0;L<M;L++)b+=r[P][L];if(b===0)throw new RangeError("convolution: The divisor is equal to zero");var Y=new Array(_*o),J=Math.floor(E/2),Ee=Math.floor(M/2);for(U=0;U<_;U++)for(D=0;D<o;D++){for(K=0,L=0;L<E;L++)for(P=0;P<M;P++)q=r[E-L-1][M-P-1],oe=(U+L-J+_)%_,W=(D+P-Ee+o)%o,X=oe*o+W,K+=u[X]*q;X=U*o+D,Y[X]=K/b}return Y}function LoG(e,r,n){var a=1e3;n&&n.factor&&(a=n.factor);var u=new Array(r),f,_,o,b;a*=-1;var E=(r-1)/2,M=2*e*e;for(f=0;f<r;f++)for(u[f]=new Array(r),b=(f-E)*(f-E),_=0;_<r;_++)o=-((_-E)*(_-E)+b)/M,u[f][_]=Math.round(a*(1+o)*Math.exp(o));return u}function matrix2Array(e){var r=e,n,a;if(typeof e[0]!="number"){n=e.length,a=e[0].length,r=new Array(n*a);for(var u=0;u<n;u++)for(var f=0;f<a;f++)r[u*a+f]=e[u][f]}else{var _=Math.sqrt(e.length);Number.isInteger(_)&&(n=_,a=_)}return{data:r,rows:n,cols:a}}var src$2={fft:convolutionFFT,direct:convolutionDirect,kernelFactory:{LoG},matrix2Array},_isFinite=Number.isFinite||function(e){return!(typeof e!="number"||e!==e||e===1/0||e===-1/0)},isFinite$1=_isFinite,isInteger=Number.isInteger||function(e){return typeof e=="number"&&isFinite$1(e)&&Math.floor(e)===e};function validateKernel(e){let r,n;if(Array.isArray(e))if(Array.isArray(e[0])){if((e.length&1)===0||(e[0].length&1)===0)throw new RangeError("validateKernel: Kernel rows and columns should be odd numbers");r=Math.floor(e.length/2),n=Math.floor(e[0].length/2)}else{let a=Math.sqrt(e.length);if(isInteger(a))n=r=Math.floor(Math.sqrt(e.length)/2);else throw new RangeError("validateKernel: Kernel array should be a square");let u=new Array(a);for(let f=0;f<a;f++){u[f]=new Array(a);for(let _=0;_<a;_++)u[f][_]=e[f*a+_]}e=u}else throw new Error(`validateKernel: Invalid Kernel: ${e}`);return{kernel:e,kWidth:n,kHeight:r}}function clamp(e,r){return Math.round(Math.min(Math.max(e,0),r.maxValue))}function directConvolution(e,r,n){if(n===void 0){const f=e.length+r.length-1;n=new Array(f)}fill(n);for(var a=0;a<e.length;a++)for(var u=0;u<r.length;u++)n[a+u]+=e[a]*r[u];return n}function fill(e){for(var r=0;r<e.length;r++)e[r]=0}function convolutionSeparable(e,r,n,a){const u=new Array(e.length);let f,_,o,b;b=r[1],o=(b.length-1)/2,_=new Array(n+b.length-1),f=new Array(n);for(let E=0;E<a;E++){for(let M=0;M<n;M++)f[M]=e[E*n+M];directConvolution(f,b,_);for(let M=0;M<n;M++)u[E*n+M]=_[o+M]}b=r[0],o=(b.length-1)/2,_=new Array(a+b.length-1),f=new Array(a);for(let E=0;E<n;E++){for(let M=0;M<a;M++)f[M]=u[M*n+E];directConvolution(f,b,_);for(let M=0;M<a;M++)u[M*n+E]=_[o+M]}return u}const toString$2=Object.prototype.toString;function isAnyArray(e){return toString$2.call(e).endsWith("Array]")}function max$1(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(e))throw new TypeError("input must be an array");if(e.length===0)throw new TypeError("input must not be empty");var n=r.fromIndex,a=n===void 0?0:n,u=r.toIndex,f=u===void 0?e.length:u;if(a<0||a>=e.length||!Number.isInteger(a))throw new Error("fromIndex must be a positive integer smaller than length");if(f<=a||f>e.length||!Number.isInteger(f))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var _=e[a],o=a+1;o<f;o++)e[o]>_&&(_=e[o]);return _}function min$1(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(e))throw new TypeError("input must be an array");if(e.length===0)throw new TypeError("input must not be empty");var n=r.fromIndex,a=n===void 0?0:n,u=r.toIndex,f=u===void 0?e.length:u;if(a<0||a>=e.length||!Number.isInteger(a))throw new Error("fromIndex must be a positive integer smaller than length");if(f<=a||f>e.length||!Number.isInteger(f))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var _=e[a],o=a+1;o<f;o++)e[o]<_&&(_=e[o]);return _}function rescale(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(isAnyArray(e)){if(e.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var n;if(r.output!==void 0){if(!isAnyArray(r.output))throw new TypeError("output option must be an array if specified");n=r.output}else n=new Array(e.length);var a=min$1(e),u=max$1(e);if(a===u)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var f=r.min,_=f===void 0?r.autoMinMax?a:0:f,o=r.max,b=o===void 0?r.autoMinMax?u:1:o;if(_>=b)throw new RangeError("min option must be smaller than max option");for(var E=(b-_)/(u-a),M=0;M<e.length;M++)n[M]=(e[M]-a)*E+_;return n}const indent=" ".repeat(2),indentData=" ".repeat(4);function inspectMatrix(){return inspectMatrixWithOptions(this)}function inspectMatrixWithOptions(e,r={}){const{maxRows:n=15,maxColumns:a=10,maxNumSize:u=8}=r;return`${e.constructor.name} {
${indent}[
${indentData}${inspectData(e,n,a,u)}
${indent}]
${indent}rows: ${e.rows}
${indent}columns: ${e.columns}
}`}function inspectData(e,r,n,a){const{rows:u,columns:f}=e,_=Math.min(u,r),o=Math.min(f,n),b=[];for(let E=0;E<_;E++){let M=[];for(let P=0;P<o;P++)M.push(formatNumber(e.get(E,P),a));b.push(`${M.join(" ")}`)}return o!==f&&(b[b.length-1]+=` ... ${f-n} more columns`),_!==u&&b.push(`... ${u-r} more rows`),b.join(`
${indentData}`)}function formatNumber(e,r){const n=String(e);if(n.length<=r)return n.padEnd(r," ");const a=e.toPrecision(r-2);if(a.length<=r)return a;const u=e.toExponential(r-2),f=u.indexOf("e"),_=u.slice(f);return u.slice(0,r-_.length)+_}function installMathOperations(e,r){e.prototype.add=function(a){return typeof a=="number"?this.addS(a):this.addM(a)},e.prototype.addS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)+a);return this},e.prototype.addM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)+a.get(u,f));return this},e.add=function(a,u){return new r(a).add(u)},e.prototype.sub=function(a){return typeof a=="number"?this.subS(a):this.subM(a)},e.prototype.subS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)-a);return this},e.prototype.subM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)-a.get(u,f));return this},e.sub=function(a,u){return new r(a).sub(u)},e.prototype.subtract=e.prototype.sub,e.prototype.subtractS=e.prototype.subS,e.prototype.subtractM=e.prototype.subM,e.subtract=e.sub,e.prototype.mul=function(a){return typeof a=="number"?this.mulS(a):this.mulM(a)},e.prototype.mulS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)*a);return this},e.prototype.mulM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)*a.get(u,f));return this},e.mul=function(a,u){return new r(a).mul(u)},e.prototype.multiply=e.prototype.mul,e.prototype.multiplyS=e.prototype.mulS,e.prototype.multiplyM=e.prototype.mulM,e.multiply=e.mul,e.prototype.div=function(a){return typeof a=="number"?this.divS(a):this.divM(a)},e.prototype.divS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)/a);return this},e.prototype.divM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)/a.get(u,f));return this},e.div=function(a,u){return new r(a).div(u)},e.prototype.divide=e.prototype.div,e.prototype.divideS=e.prototype.divS,e.prototype.divideM=e.prototype.divM,e.divide=e.div,e.prototype.mod=function(a){return typeof a=="number"?this.modS(a):this.modM(a)},e.prototype.modS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)%a);return this},e.prototype.modM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)%a.get(u,f));return this},e.mod=function(a,u){return new r(a).mod(u)},e.prototype.modulus=e.prototype.mod,e.prototype.modulusS=e.prototype.modS,e.prototype.modulusM=e.prototype.modM,e.modulus=e.mod,e.prototype.and=function(a){return typeof a=="number"?this.andS(a):this.andM(a)},e.prototype.andS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)&a);return this},e.prototype.andM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)&a.get(u,f));return this},e.and=function(a,u){return new r(a).and(u)},e.prototype.or=function(a){return typeof a=="number"?this.orS(a):this.orM(a)},e.prototype.orS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)|a);return this},e.prototype.orM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)|a.get(u,f));return this},e.or=function(a,u){return new r(a).or(u)},e.prototype.xor=function(a){return typeof a=="number"?this.xorS(a):this.xorM(a)},e.prototype.xorS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)^a);return this},e.prototype.xorM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)^a.get(u,f));return this},e.xor=function(a,u){return new r(a).xor(u)},e.prototype.leftShift=function(a){return typeof a=="number"?this.leftShiftS(a):this.leftShiftM(a)},e.prototype.leftShiftS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)<<a);return this},e.prototype.leftShiftM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)<<a.get(u,f));return this},e.leftShift=function(a,u){return new r(a).leftShift(u)},e.prototype.signPropagatingRightShift=function(a){return typeof a=="number"?this.signPropagatingRightShiftS(a):this.signPropagatingRightShiftM(a)},e.prototype.signPropagatingRightShiftS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)>>a);return this},e.prototype.signPropagatingRightShiftM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)>>a.get(u,f));return this},e.signPropagatingRightShift=function(a,u){return new r(a).signPropagatingRightShift(u)},e.prototype.rightShift=function(a){return typeof a=="number"?this.rightShiftS(a):this.rightShiftM(a)},e.prototype.rightShiftS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)>>>a);return this},e.prototype.rightShiftM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,this.get(u,f)>>>a.get(u,f));return this},e.rightShift=function(a,u){return new r(a).rightShift(u)},e.prototype.zeroFillRightShift=e.prototype.rightShift,e.prototype.zeroFillRightShiftS=e.prototype.rightShiftS,e.prototype.zeroFillRightShiftM=e.prototype.rightShiftM,e.zeroFillRightShift=e.rightShift,e.prototype.not=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,~this.get(a,u));return this},e.not=function(a){return new r(a).not()},e.prototype.abs=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.abs(this.get(a,u)));return this},e.abs=function(a){return new r(a).abs()},e.prototype.acos=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.acos(this.get(a,u)));return this},e.acos=function(a){return new r(a).acos()},e.prototype.acosh=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.acosh(this.get(a,u)));return this},e.acosh=function(a){return new r(a).acosh()},e.prototype.asin=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.asin(this.get(a,u)));return this},e.asin=function(a){return new r(a).asin()},e.prototype.asinh=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.asinh(this.get(a,u)));return this},e.asinh=function(a){return new r(a).asinh()},e.prototype.atan=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.atan(this.get(a,u)));return this},e.atan=function(a){return new r(a).atan()},e.prototype.atanh=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.atanh(this.get(a,u)));return this},e.atanh=function(a){return new r(a).atanh()},e.prototype.cbrt=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.cbrt(this.get(a,u)));return this},e.cbrt=function(a){return new r(a).cbrt()},e.prototype.ceil=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.ceil(this.get(a,u)));return this},e.ceil=function(a){return new r(a).ceil()},e.prototype.clz32=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.clz32(this.get(a,u)));return this},e.clz32=function(a){return new r(a).clz32()},e.prototype.cos=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.cos(this.get(a,u)));return this},e.cos=function(a){return new r(a).cos()},e.prototype.cosh=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.cosh(this.get(a,u)));return this},e.cosh=function(a){return new r(a).cosh()},e.prototype.exp=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.exp(this.get(a,u)));return this},e.exp=function(a){return new r(a).exp()},e.prototype.expm1=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.expm1(this.get(a,u)));return this},e.expm1=function(a){return new r(a).expm1()},e.prototype.floor=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.floor(this.get(a,u)));return this},e.floor=function(a){return new r(a).floor()},e.prototype.fround=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.fround(this.get(a,u)));return this},e.fround=function(a){return new r(a).fround()},e.prototype.log=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.log(this.get(a,u)));return this},e.log=function(a){return new r(a).log()},e.prototype.log1p=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.log1p(this.get(a,u)));return this},e.log1p=function(a){return new r(a).log1p()},e.prototype.log10=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.log10(this.get(a,u)));return this},e.log10=function(a){return new r(a).log10()},e.prototype.log2=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.log2(this.get(a,u)));return this},e.log2=function(a){return new r(a).log2()},e.prototype.round=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.round(this.get(a,u)));return this},e.round=function(a){return new r(a).round()},e.prototype.sign=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.sign(this.get(a,u)));return this},e.sign=function(a){return new r(a).sign()},e.prototype.sin=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.sin(this.get(a,u)));return this},e.sin=function(a){return new r(a).sin()},e.prototype.sinh=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.sinh(this.get(a,u)));return this},e.sinh=function(a){return new r(a).sinh()},e.prototype.sqrt=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.sqrt(this.get(a,u)));return this},e.sqrt=function(a){return new r(a).sqrt()},e.prototype.tan=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.tan(this.get(a,u)));return this},e.tan=function(a){return new r(a).tan()},e.prototype.tanh=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.tanh(this.get(a,u)));return this},e.tanh=function(a){return new r(a).tanh()},e.prototype.trunc=function(){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.set(a,u,Math.trunc(this.get(a,u)));return this},e.trunc=function(a){return new r(a).trunc()},e.pow=function(a,u){return new r(a).pow(u)},e.prototype.pow=function(a){return typeof a=="number"?this.powS(a):this.powM(a)},e.prototype.powS=function(a){for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,Math.pow(this.get(u,f),a));return this},e.prototype.powM=function(a){if(a=r.checkMatrix(a),this.rows!==a.rows||this.columns!==a.columns)throw new RangeError("Matrices dimensions must be equal");for(let u=0;u<this.rows;u++)for(let f=0;f<this.columns;f++)this.set(u,f,Math.pow(this.get(u,f),a.get(u,f)));return this}}function checkRowIndex(e,r,n){let a=n?e.rows:e.rows-1;if(r<0||r>a)throw new RangeError("Row index out of range")}function checkColumnIndex(e,r,n){let a=n?e.columns:e.columns-1;if(r<0||r>a)throw new RangeError("Column index out of range")}function checkRowVector(e,r){if(r.to1DArray&&(r=r.to1DArray()),r.length!==e.columns)throw new RangeError("vector size must be the same as the number of columns");return r}function checkColumnVector(e,r){if(r.to1DArray&&(r=r.to1DArray()),r.length!==e.rows)throw new RangeError("vector size must be the same as the number of rows");return r}function checkRowIndices(e,r){if(!isAnyArray(r))throw new TypeError("row indices must be an array");for(let n=0;n<r.length;n++)if(r[n]<0||r[n]>=e.rows)throw new RangeError("row indices are out of range")}function checkColumnIndices(e,r){if(!isAnyArray(r))throw new TypeError("column indices must be an array");for(let n=0;n<r.length;n++)if(r[n]<0||r[n]>=e.columns)throw new RangeError("column indices are out of range")}function checkRange(e,r,n,a,u){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(checkNumber("startRow",r),checkNumber("endRow",n),checkNumber("startColumn",a),checkNumber("endColumn",u),r>n||a>u||r<0||r>=e.rows||n<0||n>=e.rows||a<0||a>=e.columns||u<0||u>=e.columns)throw new RangeError("Submatrix indices are out of range")}function newArray$1(e,r=0){let n=[];for(let a=0;a<e;a++)n.push(r);return n}function checkNumber(e,r){if(typeof r!="number")throw new TypeError(`${e} must be a number`)}function checkNonEmpty(e){if(e.isEmpty())throw new Error("Empty matrix has no elements to index")}function sumByRow(e){let r=newArray$1(e.rows);for(let n=0;n<e.rows;++n)for(let a=0;a<e.columns;++a)r[n]+=e.get(n,a);return r}function sumByColumn(e){let r=newArray$1(e.columns);for(let n=0;n<e.rows;++n)for(let a=0;a<e.columns;++a)r[a]+=e.get(n,a);return r}function sumAll(e){let r=0;for(let n=0;n<e.rows;n++)for(let a=0;a<e.columns;a++)r+=e.get(n,a);return r}function productByRow(e){let r=newArray$1(e.rows,1);for(let n=0;n<e.rows;++n)for(let a=0;a<e.columns;++a)r[n]*=e.get(n,a);return r}function productByColumn(e){let r=newArray$1(e.columns,1);for(let n=0;n<e.rows;++n)for(let a=0;a<e.columns;++a)r[a]*=e.get(n,a);return r}function productAll(e){let r=1;for(let n=0;n<e.rows;n++)for(let a=0;a<e.columns;a++)r*=e.get(n,a);return r}function varianceByRow(e,r,n){const a=e.rows,u=e.columns,f=[];for(let _=0;_<a;_++){let o=0,b=0,E=0;for(let M=0;M<u;M++)E=e.get(_,M)-n[_],o+=E,b+=E*E;r?f.push((b-o*o/u)/(u-1)):f.push((b-o*o/u)/u)}return f}function varianceByColumn(e,r,n){const a=e.rows,u=e.columns,f=[];for(let _=0;_<u;_++){let o=0,b=0,E=0;for(let M=0;M<a;M++)E=e.get(M,_)-n[_],o+=E,b+=E*E;r?f.push((b-o*o/a)/(a-1)):f.push((b-o*o/a)/a)}return f}function varianceAll(e,r,n){const a=e.rows,u=e.columns,f=a*u;let _=0,o=0,b=0;for(let E=0;E<a;E++)for(let M=0;M<u;M++)b=e.get(E,M)-n,_+=b,o+=b*b;return r?(o-_*_/f)/(f-1):(o-_*_/f)/f}function centerByRow(e,r){for(let n=0;n<e.rows;n++)for(let a=0;a<e.columns;a++)e.set(n,a,e.get(n,a)-r[n])}function centerByColumn(e,r){for(let n=0;n<e.rows;n++)for(let a=0;a<e.columns;a++)e.set(n,a,e.get(n,a)-r[a])}function centerAll(e,r){for(let n=0;n<e.rows;n++)for(let a=0;a<e.columns;a++)e.set(n,a,e.get(n,a)-r)}function getScaleByRow(e){const r=[];for(let n=0;n<e.rows;n++){let a=0;for(let u=0;u<e.columns;u++)a+=Math.pow(e.get(n,u),2)/(e.columns-1);r.push(Math.sqrt(a))}return r}function scaleByRow(e,r){for(let n=0;n<e.rows;n++)for(let a=0;a<e.columns;a++)e.set(n,a,e.get(n,a)/r[n])}function getScaleByColumn(e){const r=[];for(let n=0;n<e.columns;n++){let a=0;for(let u=0;u<e.rows;u++)a+=Math.pow(e.get(u,n),2)/(e.rows-1);r.push(Math.sqrt(a))}return r}function scaleByColumn(e,r){for(let n=0;n<e.rows;n++)for(let a=0;a<e.columns;a++)e.set(n,a,e.get(n,a)/r[a])}function getScaleAll(e){const r=e.size-1;let n=0;for(let a=0;a<e.columns;a++)for(let u=0;u<e.rows;u++)n+=Math.pow(e.get(u,a),2)/r;return Math.sqrt(n)}function scaleAll(e,r){for(let n=0;n<e.rows;n++)for(let a=0;a<e.columns;a++)e.set(n,a,e.get(n,a)/r)}class AbstractMatrix{static from1DArray(r,n,a){if(r*n!==a.length)throw new RangeError("data length does not match given dimensions");let f=new Matrix$2(r,n);for(let _=0;_<r;_++)for(let o=0;o<n;o++)f.set(_,o,a[_*n+o]);return f}static rowVector(r){let n=new Matrix$2(1,r.length);for(let a=0;a<r.length;a++)n.set(0,a,r[a]);return n}static columnVector(r){let n=new Matrix$2(r.length,1);for(let a=0;a<r.length;a++)n.set(a,0,r[a]);return n}static zeros(r,n){return new Matrix$2(r,n)}static ones(r,n){return new Matrix$2(r,n).fill(1)}static rand(r,n,a={}){if(typeof a!="object")throw new TypeError("options must be an object");const{random:u=Math.random}=a;let f=new Matrix$2(r,n);for(let _=0;_<r;_++)for(let o=0;o<n;o++)f.set(_,o,u());return f}static randInt(r,n,a={}){if(typeof a!="object")throw new TypeError("options must be an object");const{min:u=0,max:f=1e3,random:_=Math.random}=a;if(!Number.isInteger(u))throw new TypeError("min must be an integer");if(!Number.isInteger(f))throw new TypeError("max must be an integer");if(u>=f)throw new RangeError("min must be smaller than max");let o=f-u,b=new Matrix$2(r,n);for(let E=0;E<r;E++)for(let M=0;M<n;M++){let P=u+Math.round(_()*o);b.set(E,M,P)}return b}static eye(r,n,a){n===void 0&&(n=r),a===void 0&&(a=1);let u=Math.min(r,n),f=this.zeros(r,n);for(let _=0;_<u;_++)f.set(_,_,a);return f}static diag(r,n,a){let u=r.length;n===void 0&&(n=u),a===void 0&&(a=n);let f=Math.min(u,n,a),_=this.zeros(n,a);for(let o=0;o<f;o++)_.set(o,o,r[o]);return _}static min(r,n){r=this.checkMatrix(r),n=this.checkMatrix(n);let a=r.rows,u=r.columns,f=new Matrix$2(a,u);for(let _=0;_<a;_++)for(let o=0;o<u;o++)f.set(_,o,Math.min(r.get(_,o),n.get(_,o)));return f}static max(r,n){r=this.checkMatrix(r),n=this.checkMatrix(n);let a=r.rows,u=r.columns,f=new this(a,u);for(let _=0;_<a;_++)for(let o=0;o<u;o++)f.set(_,o,Math.max(r.get(_,o),n.get(_,o)));return f}static checkMatrix(r){return AbstractMatrix.isMatrix(r)?r:new Matrix$2(r)}static isMatrix(r){return r!=null&&r.klass==="Matrix"}get size(){return this.rows*this.columns}apply(r){if(typeof r!="function")throw new TypeError("callback must be a function");for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)r.call(this,n,a);return this}to1DArray(){let r=[];for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)r.push(this.get(n,a));return r}to2DArray(){let r=[];for(let n=0;n<this.rows;n++){r.push([]);for(let a=0;a<this.columns;a++)r[n].push(this.get(n,a))}return r}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let r=0;r<this.rows;r++)for(let n=0;n<=r;n++)if(this.get(r,n)!==this.get(n,r))return!1;return!0}return!1}isEchelonForm(){let r=0,n=0,a=-1,u=!0,f=!1;for(;r<this.rows&&u;){for(n=0,f=!1;n<this.columns&&f===!1;)this.get(r,n)===0?n++:this.get(r,n)===1&&n>a?(f=!0,a=n):(u=!1,f=!0);r++}return u}isReducedEchelonForm(){let r=0,n=0,a=-1,u=!0,f=!1;for(;r<this.rows&&u;){for(n=0,f=!1;n<this.columns&&f===!1;)this.get(r,n)===0?n++:this.get(r,n)===1&&n>a?(f=!0,a=n):(u=!1,f=!0);for(let _=n+1;_<this.rows;_++)this.get(r,_)!==0&&(u=!1);r++}return u}echelonForm(){let r=this.clone(),n=0,a=0;for(;n<r.rows&&a<r.columns;){let u=n;for(let f=n;f<r.rows;f++)r.get(f,a)>r.get(u,a)&&(u=f);if(r.get(u,a)===0)a++;else{r.swapRows(n,u);let f=r.get(n,a);for(let _=a;_<r.columns;_++)r.set(n,_,r.get(n,_)/f);for(let _=n+1;_<r.rows;_++){let o=r.get(_,a)/r.get(n,a);r.set(_,a,0);for(let b=a+1;b<r.columns;b++)r.set(_,b,r.get(_,b)-r.get(n,b)*o)}n++,a++}}return r}reducedEchelonForm(){let r=this.echelonForm(),n=r.columns,a=r.rows,u=a-1;for(;u>=0;)if(r.maxRow(u)===0)u--;else{let f=0,_=!1;for(;f<a&&_===!1;)r.get(u,f)===1?_=!0:f++;for(let o=0;o<u;o++){let b=r.get(o,f);for(let E=f;E<n;E++){let M=r.get(o,E)-b*r.get(u,E);r.set(o,E,M)}}u--}return r}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{rows:n=1,columns:a=1}=r;if(!Number.isInteger(n)||n<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(a)||a<=0)throw new TypeError("columns must be a positive integer");let u=new Matrix$2(this.rows*n,this.columns*a);for(let f=0;f<n;f++)for(let _=0;_<a;_++)u.setSubMatrix(this,this.rows*f,this.columns*_);return u}fill(r){for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,r);return this}neg(){return this.mulS(-1)}getRow(r){checkRowIndex(this,r);let n=[];for(let a=0;a<this.columns;a++)n.push(this.get(r,a));return n}getRowVector(r){return Matrix$2.rowVector(this.getRow(r))}setRow(r,n){checkRowIndex(this,r),n=checkRowVector(this,n);for(let a=0;a<this.columns;a++)this.set(r,a,n[a]);return this}swapRows(r,n){checkRowIndex(this,r),checkRowIndex(this,n);for(let a=0;a<this.columns;a++){let u=this.get(r,a);this.set(r,a,this.get(n,a)),this.set(n,a,u)}return this}getColumn(r){checkColumnIndex(this,r);let n=[];for(let a=0;a<this.rows;a++)n.push(this.get(a,r));return n}getColumnVector(r){return Matrix$2.columnVector(this.getColumn(r))}setColumn(r,n){checkColumnIndex(this,r),n=checkColumnVector(this,n);for(let a=0;a<this.rows;a++)this.set(a,r,n[a]);return this}swapColumns(r,n){checkColumnIndex(this,r),checkColumnIndex(this,n);for(let a=0;a<this.rows;a++){let u=this.get(a,r);this.set(a,r,this.get(a,n)),this.set(a,n,u)}return this}addRowVector(r){r=checkRowVector(this,r);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,this.get(n,a)+r[a]);return this}subRowVector(r){r=checkRowVector(this,r);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,this.get(n,a)-r[a]);return this}mulRowVector(r){r=checkRowVector(this,r);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,this.get(n,a)*r[a]);return this}divRowVector(r){r=checkRowVector(this,r);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,this.get(n,a)/r[a]);return this}addColumnVector(r){r=checkColumnVector(this,r);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,this.get(n,a)+r[n]);return this}subColumnVector(r){r=checkColumnVector(this,r);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,this.get(n,a)-r[n]);return this}mulColumnVector(r){r=checkColumnVector(this,r);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,this.get(n,a)*r[n]);return this}divColumnVector(r){r=checkColumnVector(this,r);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)this.set(n,a,this.get(n,a)/r[n]);return this}mulRow(r,n){checkRowIndex(this,r);for(let a=0;a<this.columns;a++)this.set(r,a,this.get(r,a)*n);return this}mulColumn(r,n){checkColumnIndex(this,r);for(let a=0;a<this.rows;a++)this.set(a,r,this.get(a,r)*n);return this}max(r){if(this.isEmpty())return NaN;switch(r){case"row":{const n=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.get(a,u)>n[a]&&(n[a]=this.get(a,u));return n}case"column":{const n=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.get(a,u)>n[u]&&(n[u]=this.get(a,u));return n}case void 0:{let n=this.get(0,0);for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.get(a,u)>n&&(n=this.get(a,u));return n}default:throw new Error(`invalid option: ${r}`)}}maxIndex(){checkNonEmpty(this);let r=this.get(0,0),n=[0,0];for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.get(a,u)>r&&(r=this.get(a,u),n[0]=a,n[1]=u);return n}min(r){if(this.isEmpty())return NaN;switch(r){case"row":{const n=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.get(a,u)<n[a]&&(n[a]=this.get(a,u));return n}case"column":{const n=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.get(a,u)<n[u]&&(n[u]=this.get(a,u));return n}case void 0:{let n=this.get(0,0);for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.get(a,u)<n&&(n=this.get(a,u));return n}default:throw new Error(`invalid option: ${r}`)}}minIndex(){checkNonEmpty(this);let r=this.get(0,0),n=[0,0];for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)this.get(a,u)<r&&(r=this.get(a,u),n[0]=a,n[1]=u);return n}maxRow(r){if(checkRowIndex(this,r),this.isEmpty())return NaN;let n=this.get(r,0);for(let a=1;a<this.columns;a++)this.get(r,a)>n&&(n=this.get(r,a));return n}maxRowIndex(r){checkRowIndex(this,r),checkNonEmpty(this);let n=this.get(r,0),a=[r,0];for(let u=1;u<this.columns;u++)this.get(r,u)>n&&(n=this.get(r,u),a[1]=u);return a}minRow(r){if(checkRowIndex(this,r),this.isEmpty())return NaN;let n=this.get(r,0);for(let a=1;a<this.columns;a++)this.get(r,a)<n&&(n=this.get(r,a));return n}minRowIndex(r){checkRowIndex(this,r),checkNonEmpty(this);let n=this.get(r,0),a=[r,0];for(let u=1;u<this.columns;u++)this.get(r,u)<n&&(n=this.get(r,u),a[1]=u);return a}maxColumn(r){if(checkColumnIndex(this,r),this.isEmpty())return NaN;let n=this.get(0,r);for(let a=1;a<this.rows;a++)this.get(a,r)>n&&(n=this.get(a,r));return n}maxColumnIndex(r){checkColumnIndex(this,r),checkNonEmpty(this);let n=this.get(0,r),a=[0,r];for(let u=1;u<this.rows;u++)this.get(u,r)>n&&(n=this.get(u,r),a[0]=u);return a}minColumn(r){if(checkColumnIndex(this,r),this.isEmpty())return NaN;let n=this.get(0,r);for(let a=1;a<this.rows;a++)this.get(a,r)<n&&(n=this.get(a,r));return n}minColumnIndex(r){checkColumnIndex(this,r),checkNonEmpty(this);let n=this.get(0,r),a=[0,r];for(let u=1;u<this.rows;u++)this.get(u,r)<n&&(n=this.get(u,r),a[0]=u);return a}diag(){let r=Math.min(this.rows,this.columns),n=[];for(let a=0;a<r;a++)n.push(this.get(a,a));return n}norm(r="frobenius"){let n=0;if(r==="max")return this.max();if(r==="frobenius"){for(let a=0;a<this.rows;a++)for(let u=0;u<this.columns;u++)n=n+this.get(a,u)*this.get(a,u);return Math.sqrt(n)}else throw new RangeError(`unknown norm type: ${r}`)}cumulativeSum(){let r=0;for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)r+=this.get(n,a),this.set(n,a,r);return this}dot(r){AbstractMatrix.isMatrix(r)&&(r=r.to1DArray());let n=this.to1DArray();if(n.length!==r.length)throw new RangeError("vectors do not have the same size");let a=0;for(let u=0;u<n.length;u++)a+=n[u]*r[u];return a}mmul(r){r=Matrix$2.checkMatrix(r);let n=this.rows,a=this.columns,u=r.columns,f=new Matrix$2(n,u),_=new Float64Array(a);for(let o=0;o<u;o++){for(let b=0;b<a;b++)_[b]=r.get(b,o);for(let b=0;b<n;b++){let E=0;for(let M=0;M<a;M++)E+=this.get(b,M)*_[M];f.set(b,o,E)}}return f}strassen2x2(r){r=Matrix$2.checkMatrix(r);let n=new Matrix$2(2,2);const a=this.get(0,0),u=r.get(0,0),f=this.get(0,1),_=r.get(0,1),o=this.get(1,0),b=r.get(1,0),E=this.get(1,1),M=r.get(1,1),P=(a+E)*(u+M),L=(o+E)*u,D=a*(_-M),U=E*(b-u),X=(a+f)*M,K=(o-a)*(u+_),q=(f-E)*(b+M),oe=P+U-X+q,W=D+X,Y=L+U,J=P-L+D+K;return n.set(0,0,oe),n.set(0,1,W),n.set(1,0,Y),n.set(1,1,J),n}strassen3x3(r){r=Matrix$2.checkMatrix(r);let n=new Matrix$2(3,3);const a=this.get(0,0),u=this.get(0,1),f=this.get(0,2),_=this.get(1,0),o=this.get(1,1),b=this.get(1,2),E=this.get(2,0),M=this.get(2,1),P=this.get(2,2),L=r.get(0,0),D=r.get(0,1),U=r.get(0,2),X=r.get(1,0),K=r.get(1,1),q=r.get(1,2),oe=r.get(2,0),W=r.get(2,1),Y=r.get(2,2),J=(a+u+f-_-o-M-P)*K,Ee=(a-_)*(-D+K),xe=o*(-L+D+X-K-q-oe+Y),se=(-a+_+o)*(L-D+K),ce=(_+o)*(-L+D),ee=a*L,he=(-a+E+M)*(L-U+q),Ie=(-a+E)*(U-q),Pe=(E+M)*(-L+U),Qe=(a+u+f-o-b-E-M)*q,We=M*(-L+U+X-K-q-oe+W),Zt=(-f+M+P)*(K+oe-W),ti=(f-P)*(K-W),$t=f*oe,oi=(M+P)*(-oe+W),je=(-f+o+b)*(q+oe-Y),_t=(f-b)*(q-Y),Bt=(o+b)*(-oe+Y),dt=u*X,At=b*W,Tt=_*U,Dt=E*D,Ct=P*Y,pi=ee+$t+dt,yt=J+se+ce+ee+Zt+$t+oi,vi=ee+he+Pe+Qe+$t+je+Bt,$i=Ee+xe+se+ee+$t+je+_t,yi=Ee+se+ce+ee+At,mi=$t+je+_t+Bt+Tt,It=ee+he+Ie+We+Zt+ti+$t,kt=Zt+ti+$t+oi+Dt,Ri=ee+he+Ie+Pe+Ct;return n.set(0,0,pi),n.set(0,1,yt),n.set(0,2,vi),n.set(1,0,$i),n.set(1,1,yi),n.set(1,2,mi),n.set(2,0,It),n.set(2,1,kt),n.set(2,2,Ri),n}mmulStrassen(r){r=Matrix$2.checkMatrix(r);let n=this.clone(),a=n.rows,u=n.columns,f=r.rows,_=r.columns;u!==f&&console.warn(`Multiplying ${a} x ${u} and ${f} x ${_} matrix: dimensions do not match.`);function o(P,L,D){let U=P.rows,X=P.columns;if(U===L&&X===D)return P;{let K=AbstractMatrix.zeros(L,D);return K=K.setSubMatrix(P,0,0),K}}let b=Math.max(a,f),E=Math.max(u,_);n=o(n,b,E),r=o(r,b,E);function M(P,L,D,U){if(D<=512||U<=512)return P.mmul(L);D%2===1&&U%2===1?(P=o(P,D+1,U+1),L=o(L,D+1,U+1)):D%2===1?(P=o(P,D+1,U),L=o(L,D+1,U)):U%2===1&&(P=o(P,D,U+1),L=o(L,D,U+1));let X=parseInt(P.rows/2,10),K=parseInt(P.columns/2,10),q=P.subMatrix(0,X-1,0,K-1),oe=L.subMatrix(0,X-1,0,K-1),W=P.subMatrix(0,X-1,K,P.columns-1),Y=L.subMatrix(0,X-1,K,L.columns-1),J=P.subMatrix(X,P.rows-1,0,K-1),Ee=L.subMatrix(X,L.rows-1,0,K-1),xe=P.subMatrix(X,P.rows-1,K,P.columns-1),se=L.subMatrix(X,L.rows-1,K,L.columns-1),ce=M(AbstractMatrix.add(q,xe),AbstractMatrix.add(oe,se),X,K),ee=M(AbstractMatrix.add(J,xe),oe,X,K),he=M(q,AbstractMatrix.sub(Y,se),X,K),Ie=M(xe,AbstractMatrix.sub(Ee,oe),X,K),Pe=M(AbstractMatrix.add(q,W),se,X,K),Qe=M(AbstractMatrix.sub(J,q),AbstractMatrix.add(oe,Y),X,K),We=M(AbstractMatrix.sub(W,xe),AbstractMatrix.add(Ee,se),X,K),Zt=AbstractMatrix.add(ce,Ie);Zt.sub(Pe),Zt.add(We);let ti=AbstractMatrix.add(he,Pe),$t=AbstractMatrix.add(ee,Ie),oi=AbstractMatrix.sub(ce,ee);oi.add(he),oi.add(Qe);let je=AbstractMatrix.zeros(2*Zt.rows,2*Zt.columns);return je=je.setSubMatrix(Zt,0,0),je=je.setSubMatrix(ti,Zt.rows,0),je=je.setSubMatrix($t,0,Zt.columns),je=je.setSubMatrix(oi,Zt.rows,Zt.columns),je.subMatrix(0,D-1,0,U-1)}return M(n,r,b,E)}scaleRows(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{min:n=0,max:a=1}=r;if(!Number.isFinite(n))throw new TypeError("min must be a number");if(!Number.isFinite(a))throw new TypeError("max must be a number");if(n>=a)throw new RangeError("min must be smaller than max");let u=new Matrix$2(this.rows,this.columns);for(let f=0;f<this.rows;f++){const _=this.getRow(f);_.length>0&&rescale(_,{min:n,max:a,output:_}),u.setRow(f,_)}return u}scaleColumns(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{min:n=0,max:a=1}=r;if(!Number.isFinite(n))throw new TypeError("min must be a number");if(!Number.isFinite(a))throw new TypeError("max must be a number");if(n>=a)throw new RangeError("min must be smaller than max");let u=new Matrix$2(this.rows,this.columns);for(let f=0;f<this.columns;f++){const _=this.getColumn(f);_.length&&rescale(_,{min:n,max:a,output:_}),u.setColumn(f,_)}return u}flipRows(){const r=Math.ceil(this.columns/2);for(let n=0;n<this.rows;n++)for(let a=0;a<r;a++){let u=this.get(n,a),f=this.get(n,this.columns-1-a);this.set(n,a,f),this.set(n,this.columns-1-a,u)}return this}flipColumns(){const r=Math.ceil(this.rows/2);for(let n=0;n<this.columns;n++)for(let a=0;a<r;a++){let u=this.get(a,n),f=this.get(this.rows-1-a,n);this.set(a,n,f),this.set(this.rows-1-a,n,u)}return this}kroneckerProduct(r){r=Matrix$2.checkMatrix(r);let n=this.rows,a=this.columns,u=r.rows,f=r.columns,_=new Matrix$2(n*u,a*f);for(let o=0;o<n;o++)for(let b=0;b<a;b++)for(let E=0;E<u;E++)for(let M=0;M<f;M++)_.set(u*o+E,f*b+M,this.get(o,b)*r.get(E,M));return _}kroneckerSum(r){if(r=Matrix$2.checkMatrix(r),!this.isSquare()||!r.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let n=this.rows,a=r.rows,u=this.kroneckerProduct(Matrix$2.eye(a,a)),f=Matrix$2.eye(n,n).kroneckerProduct(r);return u.add(f)}transpose(){let r=new Matrix$2(this.columns,this.rows);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)r.set(a,n,this.get(n,a));return r}sortRows(r=compareNumbers){for(let n=0;n<this.rows;n++)this.setRow(n,this.getRow(n).sort(r));return this}sortColumns(r=compareNumbers){for(let n=0;n<this.columns;n++)this.setColumn(n,this.getColumn(n).sort(r));return this}subMatrix(r,n,a,u){checkRange(this,r,n,a,u);let f=new Matrix$2(n-r+1,u-a+1);for(let _=r;_<=n;_++)for(let o=a;o<=u;o++)f.set(_-r,o-a,this.get(_,o));return f}subMatrixRow(r,n,a){if(n===void 0&&(n=0),a===void 0&&(a=this.columns-1),n>a||n<0||n>=this.columns||a<0||a>=this.columns)throw new RangeError("Argument out of range");let u=new Matrix$2(r.length,a-n+1);for(let f=0;f<r.length;f++)for(let _=n;_<=a;_++){if(r[f]<0||r[f]>=this.rows)throw new RangeError(`Row index out of range: ${r[f]}`);u.set(f,_-n,this.get(r[f],_))}return u}subMatrixColumn(r,n,a){if(n===void 0&&(n=0),a===void 0&&(a=this.rows-1),n>a||n<0||n>=this.rows||a<0||a>=this.rows)throw new RangeError("Argument out of range");let u=new Matrix$2(a-n+1,r.length);for(let f=0;f<r.length;f++)for(let _=n;_<=a;_++){if(r[f]<0||r[f]>=this.columns)throw new RangeError(`Column index out of range: ${r[f]}`);u.set(_-n,f,this.get(_,r[f]))}return u}setSubMatrix(r,n,a){if(r=Matrix$2.checkMatrix(r),r.isEmpty())return this;let u=n+r.rows-1,f=a+r.columns-1;checkRange(this,n,u,a,f);for(let _=0;_<r.rows;_++)for(let o=0;o<r.columns;o++)this.set(n+_,a+o,r.get(_,o));return this}selection(r,n){checkRowIndices(this,r),checkColumnIndices(this,n);let a=new Matrix$2(r.length,n.length);for(let u=0;u<r.length;u++){let f=r[u];for(let _=0;_<n.length;_++){let o=n[_];a.set(u,_,this.get(f,o))}}return a}trace(){let r=Math.min(this.rows,this.columns),n=0;for(let a=0;a<r;a++)n+=this.get(a,a);return n}clone(){let r=new Matrix$2(this.rows,this.columns);for(let n=0;n<this.rows;n++)for(let a=0;a<this.columns;a++)r.set(n,a,this.get(n,a));return r}sum(r){switch(r){case"row":return sumByRow(this);case"column":return sumByColumn(this);case void 0:return sumAll(this);default:throw new Error(`invalid option: ${r}`)}}product(r){switch(r){case"row":return productByRow(this);case"column":return productByColumn(this);case void 0:return productAll(this);default:throw new Error(`invalid option: ${r}`)}}mean(r){const n=this.sum(r);switch(r){case"row":{for(let a=0;a<this.rows;a++)n[a]/=this.columns;return n}case"column":{for(let a=0;a<this.columns;a++)n[a]/=this.rows;return n}case void 0:return n/this.size;default:throw new Error(`invalid option: ${r}`)}}variance(r,n={}){if(typeof r=="object"&&(n=r,r=void 0),typeof n!="object")throw new TypeError("options must be an object");const{unbiased:a=!0,mean:u=this.mean(r)}=n;if(typeof a!="boolean")throw new TypeError("unbiased must be a boolean");switch(r){case"row":{if(!isAnyArray(u))throw new TypeError("mean must be an array");return varianceByRow(this,a,u)}case"column":{if(!isAnyArray(u))throw new TypeError("mean must be an array");return varianceByColumn(this,a,u)}case void 0:{if(typeof u!="number")throw new TypeError("mean must be a number");return varianceAll(this,a,u)}default:throw new Error(`invalid option: ${r}`)}}standardDeviation(r,n){typeof r=="object"&&(n=r,r=void 0);const a=this.variance(r,n);if(r===void 0)return Math.sqrt(a);for(let u=0;u<a.length;u++)a[u]=Math.sqrt(a[u]);return a}center(r,n={}){if(typeof r=="object"&&(n=r,r=void 0),typeof n!="object")throw new TypeError("options must be an object");const{center:a=this.mean(r)}=n;switch(r){case"row":{if(!isAnyArray(a))throw new TypeError("center must be an array");return centerByRow(this,a),this}case"column":{if(!isAnyArray(a))throw new TypeError("center must be an array");return centerByColumn(this,a),this}case void 0:{if(typeof a!="number")throw new TypeError("center must be a number");return centerAll(this,a),this}default:throw new Error(`invalid option: ${r}`)}}scale(r,n={}){if(typeof r=="object"&&(n=r,r=void 0),typeof n!="object")throw new TypeError("options must be an object");let a=n.scale;switch(r){case"row":{if(a===void 0)a=getScaleByRow(this);else if(!isAnyArray(a))throw new TypeError("scale must be an array");return scaleByRow(this,a),this}case"column":{if(a===void 0)a=getScaleByColumn(this);else if(!isAnyArray(a))throw new TypeError("scale must be an array");return scaleByColumn(this,a),this}case void 0:{if(a===void 0)a=getScaleAll(this);else if(typeof a!="number")throw new TypeError("scale must be a number");return scaleAll(this,a),this}default:throw new Error(`invalid option: ${r}`)}}toString(r){return inspectMatrixWithOptions(this,r)}}AbstractMatrix.prototype.klass="Matrix";typeof Symbol<"u"&&(AbstractMatrix.prototype[Symbol.for("nodejs.util.inspect.custom")]=inspectMatrix);function compareNumbers(e,r){return e-r}function isArrayOfNumbers(e){return e.every(r=>typeof r=="number")}AbstractMatrix.random=AbstractMatrix.rand;AbstractMatrix.randomInt=AbstractMatrix.randInt;AbstractMatrix.diagonal=AbstractMatrix.diag;AbstractMatrix.prototype.diagonal=AbstractMatrix.prototype.diag;AbstractMatrix.identity=AbstractMatrix.eye;AbstractMatrix.prototype.negate=AbstractMatrix.prototype.neg;AbstractMatrix.prototype.tensorProduct=AbstractMatrix.prototype.kroneckerProduct;class Matrix$2 extends AbstractMatrix{constructor(r,n){if(super(),Matrix$2.isMatrix(r))return r.clone();if(Number.isInteger(r)&&r>=0)if(this.data=[],Number.isInteger(n)&&n>=0)for(let a=0;a<r;a++)this.data.push(new Float64Array(n));else throw new TypeError("nColumns must be a positive integer");else if(isAnyArray(r)){const a=r;if(r=a.length,n=r?a[0].length:0,typeof n!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let u=0;u<r;u++){if(a[u].length!==n)throw new RangeError("Inconsistent array dimensions");if(!isArrayOfNumbers(a[u]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(a[u]))}}else throw new TypeError("First argument must be a positive number or an array");this.rows=r,this.columns=n}set(r,n,a){return this.data[r][n]=a,this}get(r,n){return this.data[r][n]}removeRow(r){return checkRowIndex(this,r),this.data.splice(r,1),this.rows-=1,this}addRow(r,n){return n===void 0&&(n=r,r=this.rows),checkRowIndex(this,r,!0),n=Float64Array.from(checkRowVector(this,n)),this.data.splice(r,0,n),this.rows+=1,this}removeColumn(r){checkColumnIndex(this,r);for(let n=0;n<this.rows;n++){const a=new Float64Array(this.columns-1);for(let u=0;u<r;u++)a[u]=this.data[n][u];for(let u=r+1;u<this.columns;u++)a[u-1]=this.data[n][u];this.data[n]=a}return this.columns-=1,this}addColumn(r,n){typeof n>"u"&&(n=r,r=this.columns),checkColumnIndex(this,r,!0),n=checkColumnVector(this,n);for(let a=0;a<this.rows;a++){const u=new Float64Array(this.columns+1);let f=0;for(;f<r;f++)u[f]=this.data[a][f];for(u[f++]=n[a];f<this.columns+1;f++)u[f]=this.data[a][f-1];this.data[a]=u}return this.columns+=1,this}}installMathOperations(AbstractMatrix,Matrix$2);class BaseView extends AbstractMatrix{constructor(r,n,a){super(),this.matrix=r,this.rows=n,this.columns=a}}class MatrixColumnView extends BaseView{constructor(r,n){checkColumnIndex(r,n),super(r,r.rows,1),this.column=n}set(r,n,a){return this.matrix.set(r,this.column,a),this}get(r){return this.matrix.get(r,this.column)}}class MatrixColumnSelectionView extends BaseView{constructor(r,n){checkColumnIndices(r,n),super(r,r.rows,n.length),this.columnIndices=n}set(r,n,a){return this.matrix.set(r,this.columnIndices[n],a),this}get(r,n){return this.matrix.get(r,this.columnIndices[n])}}class MatrixFlipColumnView extends BaseView{constructor(r){super(r,r.rows,r.columns)}set(r,n,a){return this.matrix.set(r,this.columns-n-1,a),this}get(r,n){return this.matrix.get(r,this.columns-n-1)}}class MatrixFlipRowView extends BaseView{constructor(r){super(r,r.rows,r.columns)}set(r,n,a){return this.matrix.set(this.rows-r-1,n,a),this}get(r,n){return this.matrix.get(this.rows-r-1,n)}}class MatrixRowView extends BaseView{constructor(r,n){checkRowIndex(r,n),super(r,1,r.columns),this.row=n}set(r,n,a){return this.matrix.set(this.row,n,a),this}get(r,n){return this.matrix.get(this.row,n)}}class MatrixRowSelectionView extends BaseView{constructor(r,n){checkRowIndices(r,n),super(r,n.length,r.columns),this.rowIndices=n}set(r,n,a){return this.matrix.set(this.rowIndices[r],n,a),this}get(r,n){return this.matrix.get(this.rowIndices[r],n)}}class MatrixSelectionView extends BaseView{constructor(r,n,a){checkRowIndices(r,n),checkColumnIndices(r,a),super(r,n.length,a.length),this.rowIndices=n,this.columnIndices=a}set(r,n,a){return this.matrix.set(this.rowIndices[r],this.columnIndices[n],a),this}get(r,n){return this.matrix.get(this.rowIndices[r],this.columnIndices[n])}}class MatrixSubView extends BaseView{constructor(r,n,a,u,f){checkRange(r,n,a,u,f),super(r,a-n+1,f-u+1),this.startRow=n,this.startColumn=u}set(r,n,a){return this.matrix.set(this.startRow+r,this.startColumn+n,a),this}get(r,n){return this.matrix.get(this.startRow+r,this.startColumn+n)}}class MatrixTransposeView$1 extends BaseView{constructor(r){super(r,r.columns,r.rows)}set(r,n,a){return this.matrix.set(n,r,a),this}get(r,n){return this.matrix.get(n,r)}}class WrapperMatrix1D extends AbstractMatrix{constructor(r,n={}){const{rows:a=1}=n;if(r.length%a!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=a,this.columns=r.length/a,this.data=r}set(r,n,a){let u=this._calculateIndex(r,n);return this.data[u]=a,this}get(r,n){let a=this._calculateIndex(r,n);return this.data[a]}_calculateIndex(r,n){return r*this.columns+n}}class WrapperMatrix2D extends AbstractMatrix{constructor(r){super(),this.data=r,this.rows=r.length,this.columns=r[0].length}set(r,n,a){return this.data[r][n]=a,this}get(r,n){return this.data[r][n]}}function wrap(e,r){if(isAnyArray(e))return e[0]&&isAnyArray(e[0])?new WrapperMatrix2D(e):new WrapperMatrix1D(e,r);throw new Error("the argument is not an array")}class LuDecomposition{constructor(r){r=WrapperMatrix2D.checkMatrix(r);let n=r.clone(),a=n.rows,u=n.columns,f=new Float64Array(a),_=1,o,b,E,M,P,L,D,U,X;for(o=0;o<a;o++)f[o]=o;for(U=new Float64Array(a),b=0;b<u;b++){for(o=0;o<a;o++)U[o]=n.get(o,b);for(o=0;o<a;o++){for(X=Math.min(o,b),P=0,E=0;E<X;E++)P+=n.get(o,E)*U[E];U[o]-=P,n.set(o,b,U[o])}for(M=b,o=b+1;o<a;o++)Math.abs(U[o])>Math.abs(U[M])&&(M=o);if(M!==b){for(E=0;E<u;E++)L=n.get(M,E),n.set(M,E,n.get(b,E)),n.set(b,E,L);D=f[M],f[M]=f[b],f[b]=D,_=-_}if(b<a&&n.get(b,b)!==0)for(o=b+1;o<a;o++)n.set(o,b,n.get(o,b)/n.get(b,b))}this.LU=n,this.pivotVector=f,this.pivotSign=_}isSingular(){let r=this.LU,n=r.columns;for(let a=0;a<n;a++)if(r.get(a,a)===0)return!0;return!1}solve(r){r=Matrix$2.checkMatrix(r);let n=this.LU;if(n.rows!==r.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let u=r.columns,f=r.subMatrixRow(this.pivotVector,0,u-1),_=n.columns,o,b,E;for(E=0;E<_;E++)for(o=E+1;o<_;o++)for(b=0;b<u;b++)f.set(o,b,f.get(o,b)-f.get(E,b)*n.get(o,E));for(E=_-1;E>=0;E--){for(b=0;b<u;b++)f.set(E,b,f.get(E,b)/n.get(E,E));for(o=0;o<E;o++)for(b=0;b<u;b++)f.set(o,b,f.get(o,b)-f.get(E,b)*n.get(o,E))}return f}get determinant(){let r=this.LU;if(!r.isSquare())throw new Error("Matrix must be square");let n=this.pivotSign,a=r.columns;for(let u=0;u<a;u++)n*=r.get(u,u);return n}get lowerTriangularMatrix(){let r=this.LU,n=r.rows,a=r.columns,u=new Matrix$2(n,a);for(let f=0;f<n;f++)for(let _=0;_<a;_++)f>_?u.set(f,_,r.get(f,_)):f===_?u.set(f,_,1):u.set(f,_,0);return u}get upperTriangularMatrix(){let r=this.LU,n=r.rows,a=r.columns,u=new Matrix$2(n,a);for(let f=0;f<n;f++)for(let _=0;_<a;_++)f<=_?u.set(f,_,r.get(f,_)):u.set(f,_,0);return u}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function hypotenuse$1(e,r){let n=0;return Math.abs(e)>Math.abs(r)?(n=r/e,Math.abs(e)*Math.sqrt(1+n*n)):r!==0?(n=e/r,Math.abs(r)*Math.sqrt(1+n*n)):0}class QrDecomposition{constructor(r){r=WrapperMatrix2D.checkMatrix(r);let n=r.clone(),a=r.rows,u=r.columns,f=new Float64Array(u),_,o,b,E;for(b=0;b<u;b++){let M=0;for(_=b;_<a;_++)M=hypotenuse$1(M,n.get(_,b));if(M!==0){for(n.get(b,b)<0&&(M=-M),_=b;_<a;_++)n.set(_,b,n.get(_,b)/M);for(n.set(b,b,n.get(b,b)+1),o=b+1;o<u;o++){for(E=0,_=b;_<a;_++)E+=n.get(_,b)*n.get(_,o);for(E=-E/n.get(b,b),_=b;_<a;_++)n.set(_,o,n.get(_,o)+E*n.get(_,b))}}f[b]=-M}this.QR=n,this.Rdiag=f}solve(r){r=Matrix$2.checkMatrix(r);let n=this.QR,a=n.rows;if(r.rows!==a)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let u=r.columns,f=r.clone(),_=n.columns,o,b,E,M;for(E=0;E<_;E++)for(b=0;b<u;b++){for(M=0,o=E;o<a;o++)M+=n.get(o,E)*f.get(o,b);for(M=-M/n.get(E,E),o=E;o<a;o++)f.set(o,b,f.get(o,b)+M*n.get(o,E))}for(E=_-1;E>=0;E--){for(b=0;b<u;b++)f.set(E,b,f.get(E,b)/this.Rdiag[E]);for(o=0;o<E;o++)for(b=0;b<u;b++)f.set(o,b,f.get(o,b)-f.get(E,b)*n.get(o,E))}return f.subMatrix(0,_-1,0,u-1)}isFullRank(){let r=this.QR.columns;for(let n=0;n<r;n++)if(this.Rdiag[n]===0)return!1;return!0}get upperTriangularMatrix(){let r=this.QR,n=r.columns,a=new Matrix$2(n,n),u,f;for(u=0;u<n;u++)for(f=0;f<n;f++)u<f?a.set(u,f,r.get(u,f)):u===f?a.set(u,f,this.Rdiag[u]):a.set(u,f,0);return a}get orthogonalMatrix(){let r=this.QR,n=r.rows,a=r.columns,u=new Matrix$2(n,a),f,_,o,b;for(o=a-1;o>=0;o--){for(f=0;f<n;f++)u.set(f,o,0);for(u.set(o,o,1),_=o;_<a;_++)if(r.get(o,o)!==0){for(b=0,f=o;f<n;f++)b+=r.get(f,o)*u.get(f,_);for(b=-b/r.get(o,o),f=o;f<n;f++)u.set(f,_,u.get(f,_)+b*r.get(f,o))}}return u}}class SingularValueDecomposition{constructor(r,n={}){if(r=WrapperMatrix2D.checkMatrix(r),r.isEmpty())throw new Error("Matrix must be non-empty");let a=r.rows,u=r.columns;const{computeLeftSingularVectors:f=!0,computeRightSingularVectors:_=!0,autoTranspose:o=!1}=n;let b=Boolean(f),E=Boolean(_),M=!1,P;if(a<u)if(!o)P=r.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{P=r.transpose(),a=P.rows,u=P.columns,M=!0;let ee=b;b=E,E=ee}else P=r.clone();let L=Math.min(a,u),D=Math.min(a+1,u),U=new Float64Array(D),X=new Matrix$2(a,L),K=new Matrix$2(u,u),q=new Float64Array(u),oe=new Float64Array(a),W=new Float64Array(D);for(let ee=0;ee<D;ee++)W[ee]=ee;let Y=Math.min(a-1,u),J=Math.max(0,Math.min(u-2,a)),Ee=Math.max(Y,J);for(let ee=0;ee<Ee;ee++){if(ee<Y){U[ee]=0;for(let he=ee;he<a;he++)U[ee]=hypotenuse$1(U[ee],P.get(he,ee));if(U[ee]!==0){P.get(ee,ee)<0&&(U[ee]=-U[ee]);for(let he=ee;he<a;he++)P.set(he,ee,P.get(he,ee)/U[ee]);P.set(ee,ee,P.get(ee,ee)+1)}U[ee]=-U[ee]}for(let he=ee+1;he<u;he++){if(ee<Y&&U[ee]!==0){let Ie=0;for(let Pe=ee;Pe<a;Pe++)Ie+=P.get(Pe,ee)*P.get(Pe,he);Ie=-Ie/P.get(ee,ee);for(let Pe=ee;Pe<a;Pe++)P.set(Pe,he,P.get(Pe,he)+Ie*P.get(Pe,ee))}q[he]=P.get(ee,he)}if(b&&ee<Y)for(let he=ee;he<a;he++)X.set(he,ee,P.get(he,ee));if(ee<J){q[ee]=0;for(let he=ee+1;he<u;he++)q[ee]=hypotenuse$1(q[ee],q[he]);if(q[ee]!==0){q[ee+1]<0&&(q[ee]=0-q[ee]);for(let he=ee+1;he<u;he++)q[he]/=q[ee];q[ee+1]+=1}if(q[ee]=-q[ee],ee+1<a&&q[ee]!==0){for(let he=ee+1;he<a;he++)oe[he]=0;for(let he=ee+1;he<a;he++)for(let Ie=ee+1;Ie<u;Ie++)oe[he]+=q[Ie]*P.get(he,Ie);for(let he=ee+1;he<u;he++){let Ie=-q[he]/q[ee+1];for(let Pe=ee+1;Pe<a;Pe++)P.set(Pe,he,P.get(Pe,he)+Ie*oe[Pe])}}if(E)for(let he=ee+1;he<u;he++)K.set(he,ee,q[he])}}let xe=Math.min(u,a+1);if(Y<u&&(U[Y]=P.get(Y,Y)),a<xe&&(U[xe-1]=0),J+1<xe&&(q[J]=P.get(J,xe-1)),q[xe-1]=0,b){for(let ee=Y;ee<L;ee++){for(let he=0;he<a;he++)X.set(he,ee,0);X.set(ee,ee,1)}for(let ee=Y-1;ee>=0;ee--)if(U[ee]!==0){for(let he=ee+1;he<L;he++){let Ie=0;for(let Pe=ee;Pe<a;Pe++)Ie+=X.get(Pe,ee)*X.get(Pe,he);Ie=-Ie/X.get(ee,ee);for(let Pe=ee;Pe<a;Pe++)X.set(Pe,he,X.get(Pe,he)+Ie*X.get(Pe,ee))}for(let he=ee;he<a;he++)X.set(he,ee,-X.get(he,ee));X.set(ee,ee,1+X.get(ee,ee));for(let he=0;he<ee-1;he++)X.set(he,ee,0)}else{for(let he=0;he<a;he++)X.set(he,ee,0);X.set(ee,ee,1)}}if(E)for(let ee=u-1;ee>=0;ee--){if(ee<J&&q[ee]!==0)for(let he=ee+1;he<u;he++){let Ie=0;for(let Pe=ee+1;Pe<u;Pe++)Ie+=K.get(Pe,ee)*K.get(Pe,he);Ie=-Ie/K.get(ee+1,ee);for(let Pe=ee+1;Pe<u;Pe++)K.set(Pe,he,K.get(Pe,he)+Ie*K.get(Pe,ee))}for(let he=0;he<u;he++)K.set(he,ee,0);K.set(ee,ee,1)}let se=xe-1,ce=Number.EPSILON;for(;xe>0;){let ee,he;for(ee=xe-2;ee>=-1&&ee!==-1;ee--){const Ie=Number.MIN_VALUE+ce*Math.abs(U[ee]+Math.abs(U[ee+1]));if(Math.abs(q[ee])<=Ie||Number.isNaN(q[ee])){q[ee]=0;break}}if(ee===xe-2)he=4;else{let Ie;for(Ie=xe-1;Ie>=ee&&Ie!==ee;Ie--){let Pe=(Ie!==xe?Math.abs(q[Ie]):0)+(Ie!==ee+1?Math.abs(q[Ie-1]):0);if(Math.abs(U[Ie])<=ce*Pe){U[Ie]=0;break}}Ie===ee?he=3:Ie===xe-1?he=1:(he=2,ee=Ie)}switch(ee++,he){case 1:{let Ie=q[xe-2];q[xe-2]=0;for(let Pe=xe-2;Pe>=ee;Pe--){let Qe=hypotenuse$1(U[Pe],Ie),We=U[Pe]/Qe,Zt=Ie/Qe;if(U[Pe]=Qe,Pe!==ee&&(Ie=-Zt*q[Pe-1],q[Pe-1]=We*q[Pe-1]),E)for(let ti=0;ti<u;ti++)Qe=We*K.get(ti,Pe)+Zt*K.get(ti,xe-1),K.set(ti,xe-1,-Zt*K.get(ti,Pe)+We*K.get(ti,xe-1)),K.set(ti,Pe,Qe)}break}case 2:{let Ie=q[ee-1];q[ee-1]=0;for(let Pe=ee;Pe<xe;Pe++){let Qe=hypotenuse$1(U[Pe],Ie),We=U[Pe]/Qe,Zt=Ie/Qe;if(U[Pe]=Qe,Ie=-Zt*q[Pe],q[Pe]=We*q[Pe],b)for(let ti=0;ti<a;ti++)Qe=We*X.get(ti,Pe)+Zt*X.get(ti,ee-1),X.set(ti,ee-1,-Zt*X.get(ti,Pe)+We*X.get(ti,ee-1)),X.set(ti,Pe,Qe)}break}case 3:{const Ie=Math.max(Math.abs(U[xe-1]),Math.abs(U[xe-2]),Math.abs(q[xe-2]),Math.abs(U[ee]),Math.abs(q[ee])),Pe=U[xe-1]/Ie,Qe=U[xe-2]/Ie,We=q[xe-2]/Ie,Zt=U[ee]/Ie,ti=q[ee]/Ie,$t=((Qe+Pe)*(Qe-Pe)+We*We)/2,oi=Pe*We*(Pe*We);let je=0;($t!==0||oi!==0)&&($t<0?je=0-Math.sqrt($t*$t+oi):je=Math.sqrt($t*$t+oi),je=oi/($t+je));let _t=(Zt+Pe)*(Zt-Pe)+je,Bt=Zt*ti;for(let dt=ee;dt<xe-1;dt++){let At=hypotenuse$1(_t,Bt);At===0&&(At=Number.MIN_VALUE);let Tt=_t/At,Dt=Bt/At;if(dt!==ee&&(q[dt-1]=At),_t=Tt*U[dt]+Dt*q[dt],q[dt]=Tt*q[dt]-Dt*U[dt],Bt=Dt*U[dt+1],U[dt+1]=Tt*U[dt+1],E)for(let Ct=0;Ct<u;Ct++)At=Tt*K.get(Ct,dt)+Dt*K.get(Ct,dt+1),K.set(Ct,dt+1,-Dt*K.get(Ct,dt)+Tt*K.get(Ct,dt+1)),K.set(Ct,dt,At);if(At=hypotenuse$1(_t,Bt),At===0&&(At=Number.MIN_VALUE),Tt=_t/At,Dt=Bt/At,U[dt]=At,_t=Tt*q[dt]+Dt*U[dt+1],U[dt+1]=-Dt*q[dt]+Tt*U[dt+1],Bt=Dt*q[dt+1],q[dt+1]=Tt*q[dt+1],b&&dt<a-1)for(let Ct=0;Ct<a;Ct++)At=Tt*X.get(Ct,dt)+Dt*X.get(Ct,dt+1),X.set(Ct,dt+1,-Dt*X.get(Ct,dt)+Tt*X.get(Ct,dt+1)),X.set(Ct,dt,At)}q[xe-2]=_t;break}case 4:{if(U[ee]<=0&&(U[ee]=U[ee]<0?-U[ee]:0,E))for(let Ie=0;Ie<=se;Ie++)K.set(Ie,ee,-K.get(Ie,ee));for(;ee<se&&!(U[ee]>=U[ee+1]);){let Ie=U[ee];if(U[ee]=U[ee+1],U[ee+1]=Ie,E&&ee<u-1)for(let Pe=0;Pe<u;Pe++)Ie=K.get(Pe,ee+1),K.set(Pe,ee+1,K.get(Pe,ee)),K.set(Pe,ee,Ie);if(b&&ee<a-1)for(let Pe=0;Pe<a;Pe++)Ie=X.get(Pe,ee+1),X.set(Pe,ee+1,X.get(Pe,ee)),X.set(Pe,ee,Ie);ee++}xe--;break}}}if(M){let ee=K;K=X,X=ee}this.m=a,this.n=u,this.s=U,this.U=X,this.V=K}solve(r){let n=r,a=this.threshold,u=this.s.length,f=Matrix$2.zeros(u,u);for(let L=0;L<u;L++)Math.abs(this.s[L])<=a?f.set(L,L,0):f.set(L,L,1/this.s[L]);let _=this.U,o=this.rightSingularVectors,b=o.mmul(f),E=o.rows,M=_.rows,P=Matrix$2.zeros(E,M);for(let L=0;L<E;L++)for(let D=0;D<M;D++){let U=0;for(let X=0;X<u;X++)U+=b.get(L,X)*_.get(D,X);P.set(L,D,U)}return P.mmul(n)}solveForDiagonal(r){return this.solve(Matrix$2.diag(r))}inverse(){let r=this.V,n=this.threshold,a=r.rows,u=r.columns,f=new Matrix$2(a,this.s.length);for(let M=0;M<a;M++)for(let P=0;P<u;P++)Math.abs(this.s[P])>n&&f.set(M,P,r.get(M,P)/this.s[P]);let _=this.U,o=_.rows,b=_.columns,E=new Matrix$2(a,o);for(let M=0;M<a;M++)for(let P=0;P<o;P++){let L=0;for(let D=0;D<b;D++)L+=f.get(M,D)*_.get(P,D);E.set(M,P,L)}return E}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let r=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,n=0,a=this.s;for(let u=0,f=a.length;u<f;u++)a[u]>r&&n++;return n}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return Matrix$2.diag(this.s)}}function inverse(e,r=!1){return e=WrapperMatrix2D.checkMatrix(e),r?new SingularValueDecomposition(e).inverse():solve(e,Matrix$2.eye(e.rows))}function solve(e,r,n=!1){return e=WrapperMatrix2D.checkMatrix(e),r=WrapperMatrix2D.checkMatrix(r),n?new SingularValueDecomposition(e).solve(r):e.isSquare()?new LuDecomposition(e).solve(r):new QrDecomposition(e).solve(r)}function determinant(e){if(e=Matrix$2.checkMatrix(e),e.isSquare()){if(e.columns===0)return 1;let r,n,a,u;if(e.columns===2)return r=e.get(0,0),n=e.get(0,1),a=e.get(1,0),u=e.get(1,1),r*u-n*a;if(e.columns===3){let f,_,o;return f=new MatrixSelectionView(e,[1,2],[1,2]),_=new MatrixSelectionView(e,[1,2],[0,2]),o=new MatrixSelectionView(e,[1,2],[0,1]),r=e.get(0,0),n=e.get(0,1),a=e.get(0,2),r*determinant(f)-n*determinant(_)+a*determinant(o)}else return new LuDecomposition(e).determinant}else throw Error("determinant can only be calculated for a square matrix")}function xrange(e,r){let n=[];for(let a=0;a<e;a++)a!==r&&n.push(a);return n}function dependenciesOneRow(e,r,n,a=1e-9,u=1e-9){if(e>u)return new Array(r.rows+1).fill(0);{let f=r.addRow(n,[0]);for(let _=0;_<f.rows;_++)Math.abs(f.get(_,0))<a&&f.set(_,0,0);return f.to1DArray()}}function linearDependencies(e,r={}){const{thresholdValue:n=1e-9,thresholdError:a=1e-9}=r;e=Matrix$2.checkMatrix(e);let u=e.rows,f=new Matrix$2(u,u);for(let _=0;_<u;_++){let o=Matrix$2.columnVector(e.getRow(_)),b=e.subMatrixRow(xrange(u,_)).transpose(),M=new SingularValueDecomposition(b).solve(o),P=Matrix$2.sub(o,b.mmul(M)).abs().max();f.setRow(_,dependenciesOneRow(P,M,_,n,a))}return f}function pseudoInverse(e,r=Number.EPSILON){if(e=Matrix$2.checkMatrix(e),e.isEmpty())return e.transpose();let n=new SingularValueDecomposition(e,{autoTranspose:!0}),a=n.leftSingularVectors,u=n.rightSingularVectors,f=n.diagonal;for(let _=0;_<f.length;_++)Math.abs(f[_])>r?f[_]=1/f[_]:f[_]=0;return u.mmul(Matrix$2.diag(f).mmul(a.transpose()))}function covariance(e,r=e,n={}){e=new Matrix$2(e);let a=!1;if(typeof r=="object"&&!Matrix$2.isMatrix(r)&&!isAnyArray(r)?(n=r,r=e,a=!0):r=new Matrix$2(r),e.rows!==r.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:u=!0}=n;u&&(e=e.center("column"),a||(r=r.center("column")));const f=e.transpose().mmul(r);for(let _=0;_<f.rows;_++)for(let o=0;o<f.columns;o++)f.set(_,o,f.get(_,o)*(1/(e.rows-1)));return f}function correlation(e,r=e,n={}){e=new Matrix$2(e);let a=!1;if(typeof r=="object"&&!Matrix$2.isMatrix(r)&&!isAnyArray(r)?(n=r,r=e,a=!0):r=new Matrix$2(r),e.rows!==r.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:u=!0,scale:f=!0}=n;u&&(e.center("column"),a||r.center("column")),f&&(e.scale("column"),a||r.scale("column"));const _=e.standardDeviation("column",{unbiased:!0}),o=a?_:r.standardDeviation("column",{unbiased:!0}),b=e.transpose().mmul(r);for(let E=0;E<b.rows;E++)for(let M=0;M<b.columns;M++)b.set(E,M,b.get(E,M)*(1/(_[E]*o[M]))*(1/(e.rows-1)));return b}class EigenvalueDecomposition{constructor(r,n={}){const{assumeSymmetric:a=!1}=n;if(r=WrapperMatrix2D.checkMatrix(r),!r.isSquare())throw new Error("Matrix is not a square matrix");if(r.isEmpty())throw new Error("Matrix must be non-empty");let u=r.columns,f=new Matrix$2(u,u),_=new Float64Array(u),o=new Float64Array(u),b=r,E,M,P=!1;if(a?P=!0:P=r.isSymmetric(),P){for(E=0;E<u;E++)for(M=0;M<u;M++)f.set(E,M,b.get(E,M));tred2(u,o,_,f),tql2(u,o,_,f)}else{let L=new Matrix$2(u,u),D=new Float64Array(u);for(M=0;M<u;M++)for(E=0;E<u;E++)L.set(E,M,b.get(E,M));orthes(u,L,D,f),hqr2(u,o,_,f,L)}this.n=u,this.e=o,this.d=_,this.V=f}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let r=this.n,n=this.e,a=this.d,u=new Matrix$2(r,r),f,_;for(f=0;f<r;f++){for(_=0;_<r;_++)u.set(f,_,0);u.set(f,f,a[f]),n[f]>0?u.set(f,f+1,n[f]):n[f]<0&&u.set(f,f-1,n[f])}return u}}function tred2(e,r,n,a){let u,f,_,o,b,E,M,P;for(b=0;b<e;b++)n[b]=a.get(e-1,b);for(o=e-1;o>0;o--){for(P=0,_=0,E=0;E<o;E++)P=P+Math.abs(n[E]);if(P===0)for(r[o]=n[o-1],b=0;b<o;b++)n[b]=a.get(o-1,b),a.set(o,b,0),a.set(b,o,0);else{for(E=0;E<o;E++)n[E]/=P,_+=n[E]*n[E];for(u=n[o-1],f=Math.sqrt(_),u>0&&(f=-f),r[o]=P*f,_=_-u*f,n[o-1]=u-f,b=0;b<o;b++)r[b]=0;for(b=0;b<o;b++){for(u=n[b],a.set(b,o,u),f=r[b]+a.get(b,b)*u,E=b+1;E<=o-1;E++)f+=a.get(E,b)*n[E],r[E]+=a.get(E,b)*u;r[b]=f}for(u=0,b=0;b<o;b++)r[b]/=_,u+=r[b]*n[b];for(M=u/(_+_),b=0;b<o;b++)r[b]-=M*n[b];for(b=0;b<o;b++){for(u=n[b],f=r[b],E=b;E<=o-1;E++)a.set(E,b,a.get(E,b)-(u*r[E]+f*n[E]));n[b]=a.get(o-1,b),a.set(o,b,0)}}n[o]=_}for(o=0;o<e-1;o++){if(a.set(e-1,o,a.get(o,o)),a.set(o,o,1),_=n[o+1],_!==0){for(E=0;E<=o;E++)n[E]=a.get(E,o+1)/_;for(b=0;b<=o;b++){for(f=0,E=0;E<=o;E++)f+=a.get(E,o+1)*a.get(E,b);for(E=0;E<=o;E++)a.set(E,b,a.get(E,b)-f*n[E])}}for(E=0;E<=o;E++)a.set(E,o+1,0)}for(b=0;b<e;b++)n[b]=a.get(e-1,b),a.set(e-1,b,0);a.set(e-1,e-1,1),r[0]=0}function tql2(e,r,n,a){let u,f,_,o,b,E,M,P,L,D,U,X,K,q,oe,W;for(_=1;_<e;_++)r[_-1]=r[_];r[e-1]=0;let Y=0,J=0,Ee=Number.EPSILON;for(E=0;E<e;E++){for(J=Math.max(J,Math.abs(n[E])+Math.abs(r[E])),M=E;M<e&&!(Math.abs(r[M])<=Ee*J);)M++;if(M>E)do{for(u=n[E],P=(n[E+1]-u)/(2*r[E]),L=hypotenuse$1(P,1),P<0&&(L=-L),n[E]=r[E]/(P+L),n[E+1]=r[E]*(P+L),D=n[E+1],f=u-n[E],_=E+2;_<e;_++)n[_]-=f;for(Y=Y+f,P=n[M],U=1,X=U,K=U,q=r[E+1],oe=0,W=0,_=M-1;_>=E;_--)for(K=X,X=U,W=oe,u=U*r[_],f=U*P,L=hypotenuse$1(P,r[_]),r[_+1]=oe*L,oe=r[_]/L,U=P/L,P=U*n[_]-oe*u,n[_+1]=f+oe*(U*u+oe*n[_]),b=0;b<e;b++)f=a.get(b,_+1),a.set(b,_+1,oe*a.get(b,_)+U*f),a.set(b,_,U*a.get(b,_)-oe*f);P=-oe*W*K*q*r[E]/D,r[E]=oe*P,n[E]=U*P}while(Math.abs(r[E])>Ee*J);n[E]=n[E]+Y,r[E]=0}for(_=0;_<e-1;_++){for(b=_,P=n[_],o=_+1;o<e;o++)n[o]<P&&(b=o,P=n[o]);if(b!==_)for(n[b]=n[_],n[_]=P,o=0;o<e;o++)P=a.get(o,_),a.set(o,_,a.get(o,b)),a.set(o,b,P)}}function orthes(e,r,n,a){let u=0,f=e-1,_,o,b,E,M,P,L;for(P=u+1;P<=f-1;P++){for(L=0,E=P;E<=f;E++)L=L+Math.abs(r.get(E,P-1));if(L!==0){for(b=0,E=f;E>=P;E--)n[E]=r.get(E,P-1)/L,b+=n[E]*n[E];for(o=Math.sqrt(b),n[P]>0&&(o=-o),b=b-n[P]*o,n[P]=n[P]-o,M=P;M<e;M++){for(_=0,E=f;E>=P;E--)_+=n[E]*r.get(E,M);for(_=_/b,E=P;E<=f;E++)r.set(E,M,r.get(E,M)-_*n[E])}for(E=0;E<=f;E++){for(_=0,M=f;M>=P;M--)_+=n[M]*r.get(E,M);for(_=_/b,M=P;M<=f;M++)r.set(E,M,r.get(E,M)-_*n[M])}n[P]=L*n[P],r.set(P,P-1,L*o)}}for(E=0;E<e;E++)for(M=0;M<e;M++)a.set(E,M,E===M?1:0);for(P=f-1;P>=u+1;P--)if(r.get(P,P-1)!==0){for(E=P+1;E<=f;E++)n[E]=r.get(E,P-1);for(M=P;M<=f;M++){for(o=0,E=P;E<=f;E++)o+=n[E]*a.get(E,M);for(o=o/n[P]/r.get(P,P-1),E=P;E<=f;E++)a.set(E,M,a.get(E,M)+o*n[E])}}}function hqr2(e,r,n,a,u){let f=e-1,_=0,o=e-1,b=Number.EPSILON,E=0,M=0,P=0,L=0,D=0,U=0,X=0,K=0,q,oe,W,Y,J,Ee,xe,se,ce,ee,he,Ie,Pe,Qe,We;for(q=0;q<e;q++)for((q<_||q>o)&&(n[q]=u.get(q,q),r[q]=0),oe=Math.max(q-1,0);oe<e;oe++)M=M+Math.abs(u.get(q,oe));for(;f>=_;){for(Y=f;Y>_&&(U=Math.abs(u.get(Y-1,Y-1))+Math.abs(u.get(Y,Y)),U===0&&(U=M),!(Math.abs(u.get(Y,Y-1))<b*U));)Y--;if(Y===f)u.set(f,f,u.get(f,f)+E),n[f]=u.get(f,f),r[f]=0,f--,K=0;else if(Y===f-1){if(xe=u.get(f,f-1)*u.get(f-1,f),P=(u.get(f-1,f-1)-u.get(f,f))/2,L=P*P+xe,X=Math.sqrt(Math.abs(L)),u.set(f,f,u.get(f,f)+E),u.set(f-1,f-1,u.get(f-1,f-1)+E),se=u.get(f,f),L>=0){for(X=P>=0?P+X:P-X,n[f-1]=se+X,n[f]=n[f-1],X!==0&&(n[f]=se-xe/X),r[f-1]=0,r[f]=0,se=u.get(f,f-1),U=Math.abs(se)+Math.abs(X),P=se/U,L=X/U,D=Math.sqrt(P*P+L*L),P=P/D,L=L/D,oe=f-1;oe<e;oe++)X=u.get(f-1,oe),u.set(f-1,oe,L*X+P*u.get(f,oe)),u.set(f,oe,L*u.get(f,oe)-P*X);for(q=0;q<=f;q++)X=u.get(q,f-1),u.set(q,f-1,L*X+P*u.get(q,f)),u.set(q,f,L*u.get(q,f)-P*X);for(q=_;q<=o;q++)X=a.get(q,f-1),a.set(q,f-1,L*X+P*a.get(q,f)),a.set(q,f,L*a.get(q,f)-P*X)}else n[f-1]=se+P,n[f]=se+P,r[f-1]=X,r[f]=-X;f=f-2,K=0}else{if(se=u.get(f,f),ce=0,xe=0,Y<f&&(ce=u.get(f-1,f-1),xe=u.get(f,f-1)*u.get(f-1,f)),K===10){for(E+=se,q=_;q<=f;q++)u.set(q,q,u.get(q,q)-se);U=Math.abs(u.get(f,f-1))+Math.abs(u.get(f-1,f-2)),se=ce=.75*U,xe=-.4375*U*U}if(K===30&&(U=(ce-se)/2,U=U*U+xe,U>0)){for(U=Math.sqrt(U),ce<se&&(U=-U),U=se-xe/((ce-se)/2+U),q=_;q<=f;q++)u.set(q,q,u.get(q,q)-U);E+=U,se=ce=xe=.964}for(K=K+1,J=f-2;J>=Y&&(X=u.get(J,J),D=se-X,U=ce-X,P=(D*U-xe)/u.get(J+1,J)+u.get(J,J+1),L=u.get(J+1,J+1)-X-D-U,D=u.get(J+2,J+1),U=Math.abs(P)+Math.abs(L)+Math.abs(D),P=P/U,L=L/U,D=D/U,!(J===Y||Math.abs(u.get(J,J-1))*(Math.abs(L)+Math.abs(D))<b*(Math.abs(P)*(Math.abs(u.get(J-1,J-1))+Math.abs(X)+Math.abs(u.get(J+1,J+1))))));)J--;for(q=J+2;q<=f;q++)u.set(q,q-2,0),q>J+2&&u.set(q,q-3,0);for(W=J;W<=f-1&&(Qe=W!==f-1,W!==J&&(P=u.get(W,W-1),L=u.get(W+1,W-1),D=Qe?u.get(W+2,W-1):0,se=Math.abs(P)+Math.abs(L)+Math.abs(D),se!==0&&(P=P/se,L=L/se,D=D/se)),se!==0);W++)if(U=Math.sqrt(P*P+L*L+D*D),P<0&&(U=-U),U!==0){for(W!==J?u.set(W,W-1,-U*se):Y!==J&&u.set(W,W-1,-u.get(W,W-1)),P=P+U,se=P/U,ce=L/U,X=D/U,L=L/P,D=D/P,oe=W;oe<e;oe++)P=u.get(W,oe)+L*u.get(W+1,oe),Qe&&(P=P+D*u.get(W+2,oe),u.set(W+2,oe,u.get(W+2,oe)-P*X)),u.set(W,oe,u.get(W,oe)-P*se),u.set(W+1,oe,u.get(W+1,oe)-P*ce);for(q=0;q<=Math.min(f,W+3);q++)P=se*u.get(q,W)+ce*u.get(q,W+1),Qe&&(P=P+X*u.get(q,W+2),u.set(q,W+2,u.get(q,W+2)-P*D)),u.set(q,W,u.get(q,W)-P),u.set(q,W+1,u.get(q,W+1)-P*L);for(q=_;q<=o;q++)P=se*a.get(q,W)+ce*a.get(q,W+1),Qe&&(P=P+X*a.get(q,W+2),a.set(q,W+2,a.get(q,W+2)-P*D)),a.set(q,W,a.get(q,W)-P),a.set(q,W+1,a.get(q,W+1)-P*L)}}}if(M!==0){for(f=e-1;f>=0;f--)if(P=n[f],L=r[f],L===0)for(Y=f,u.set(f,f,1),q=f-1;q>=0;q--){for(xe=u.get(q,q)-P,D=0,oe=Y;oe<=f;oe++)D=D+u.get(q,oe)*u.get(oe,f);if(r[q]<0)X=xe,U=D;else if(Y=q,r[q]===0?u.set(q,f,xe!==0?-D/xe:-D/(b*M)):(se=u.get(q,q+1),ce=u.get(q+1,q),L=(n[q]-P)*(n[q]-P)+r[q]*r[q],Ee=(se*U-X*D)/L,u.set(q,f,Ee),u.set(q+1,f,Math.abs(se)>Math.abs(X)?(-D-xe*Ee)/se:(-U-ce*Ee)/X)),Ee=Math.abs(u.get(q,f)),b*Ee*Ee>1)for(oe=q;oe<=f;oe++)u.set(oe,f,u.get(oe,f)/Ee)}else if(L<0)for(Y=f-1,Math.abs(u.get(f,f-1))>Math.abs(u.get(f-1,f))?(u.set(f-1,f-1,L/u.get(f,f-1)),u.set(f-1,f,-(u.get(f,f)-P)/u.get(f,f-1))):(We=cdiv(0,-u.get(f-1,f),u.get(f-1,f-1)-P,L),u.set(f-1,f-1,We[0]),u.set(f-1,f,We[1])),u.set(f,f-1,0),u.set(f,f,1),q=f-2;q>=0;q--){for(ee=0,he=0,oe=Y;oe<=f;oe++)ee=ee+u.get(q,oe)*u.get(oe,f-1),he=he+u.get(q,oe)*u.get(oe,f);if(xe=u.get(q,q)-P,r[q]<0)X=xe,D=ee,U=he;else if(Y=q,r[q]===0?(We=cdiv(-ee,-he,xe,L),u.set(q,f-1,We[0]),u.set(q,f,We[1])):(se=u.get(q,q+1),ce=u.get(q+1,q),Ie=(n[q]-P)*(n[q]-P)+r[q]*r[q]-L*L,Pe=(n[q]-P)*2*L,Ie===0&&Pe===0&&(Ie=b*M*(Math.abs(xe)+Math.abs(L)+Math.abs(se)+Math.abs(ce)+Math.abs(X))),We=cdiv(se*D-X*ee+L*he,se*U-X*he-L*ee,Ie,Pe),u.set(q,f-1,We[0]),u.set(q,f,We[1]),Math.abs(se)>Math.abs(X)+Math.abs(L)?(u.set(q+1,f-1,(-ee-xe*u.get(q,f-1)+L*u.get(q,f))/se),u.set(q+1,f,(-he-xe*u.get(q,f)-L*u.get(q,f-1))/se)):(We=cdiv(-D-ce*u.get(q,f-1),-U-ce*u.get(q,f),X,L),u.set(q+1,f-1,We[0]),u.set(q+1,f,We[1]))),Ee=Math.max(Math.abs(u.get(q,f-1)),Math.abs(u.get(q,f))),b*Ee*Ee>1)for(oe=q;oe<=f;oe++)u.set(oe,f-1,u.get(oe,f-1)/Ee),u.set(oe,f,u.get(oe,f)/Ee)}for(q=0;q<e;q++)if(q<_||q>o)for(oe=q;oe<e;oe++)a.set(q,oe,u.get(q,oe));for(oe=e-1;oe>=_;oe--)for(q=_;q<=o;q++){for(X=0,W=_;W<=Math.min(oe,o);W++)X=X+a.get(q,W)*u.get(W,oe);a.set(q,oe,X)}}}function cdiv(e,r,n,a){let u,f;return Math.abs(n)>Math.abs(a)?(u=a/n,f=n+u*a,[(e+u*r)/f,(r-u*e)/f]):(u=n/a,f=a+u*n,[(u*e+r)/f,(u*r-e)/f])}class CholeskyDecomposition{constructor(r){if(r=WrapperMatrix2D.checkMatrix(r),!r.isSymmetric())throw new Error("Matrix is not symmetric");let n=r,a=n.rows,u=new Matrix$2(a,a),f=!0,_,o,b;for(o=0;o<a;o++){let E=0;for(b=0;b<o;b++){let M=0;for(_=0;_<b;_++)M+=u.get(b,_)*u.get(o,_);M=(n.get(o,b)-M)/u.get(b,b),u.set(o,b,M),E=E+M*M}for(E=n.get(o,o)-E,f&=E>0,u.set(o,o,Math.sqrt(Math.max(E,0))),b=o+1;b<a;b++)u.set(o,b,0)}this.L=u,this.positiveDefinite=Boolean(f)}isPositiveDefinite(){return this.positiveDefinite}solve(r){r=WrapperMatrix2D.checkMatrix(r);let n=this.L,a=n.rows;if(r.rows!==a)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let u=r.columns,f=r.clone(),_,o,b;for(b=0;b<a;b++)for(o=0;o<u;o++){for(_=0;_<b;_++)f.set(b,o,f.get(b,o)-f.get(_,o)*n.get(b,_));f.set(b,o,f.get(b,o)/n.get(b,b))}for(b=a-1;b>=0;b--)for(o=0;o<u;o++){for(_=b+1;_<a;_++)f.set(b,o,f.get(b,o)-f.get(_,o)*n.get(_,b));f.set(b,o,f.get(b,o)/n.get(b,b))}return f}get lowerTriangularMatrix(){return this.L}}class nipals{constructor(r,n={}){r=WrapperMatrix2D.checkMatrix(r);let{Y:a}=n;const{scaleScores:u=!1,maxIterations:f=1e3,terminationCriteria:_=1e-10}=n;let o;if(a){if(isAnyArray(a)&&typeof a[0]=="number"?a=Matrix$2.columnVector(a):a=WrapperMatrix2D.checkMatrix(a),a.rows!==r.rows)throw new Error("Y should have the same number of rows as X");o=a.getColumnVector(0)}else o=r.getColumnVector(0);let b=1,E,M,P,L;for(let D=0;D<f&&b>_;D++)P=r.transpose().mmul(o).div(o.transpose().mmul(o).get(0,0)),P=P.div(P.norm()),E=r.mmul(P).div(P.transpose().mmul(P).get(0,0)),D>0&&(b=E.clone().sub(L).pow(2).sum()),L=E.clone(),a?(M=a.transpose().mmul(E).div(E.transpose().mmul(E).get(0,0)),M=M.div(M.norm()),o=a.mmul(M).div(M.transpose().mmul(M).get(0,0))):o=E;if(a){let D=r.transpose().mmul(E).div(E.transpose().mmul(E).get(0,0));D=D.div(D.norm());let U=r.clone().sub(E.clone().mmul(D.transpose())),X=o.transpose().mmul(E).div(E.transpose().mmul(E).get(0,0)),K=a.clone().sub(E.clone().mulS(X.get(0,0)).mmul(M.transpose()));this.t=E,this.p=D.transpose(),this.w=P.transpose(),this.q=M,this.u=o,this.s=E.transpose().mmul(E),this.xResidual=U,this.yResidual=K,this.betas=X}else this.w=P.transpose(),this.s=E.transpose().mmul(E).sqrt(),u?this.t=E.clone().div(this.s.get(0,0)):this.t=E,this.xResidual=r.sub(E.mmul(P.transpose()))}}var src$1=Object.freeze(Object.defineProperty({__proto__:null,AbstractMatrix,default:Matrix$2,Matrix:Matrix$2,wrap,WrapperMatrix1D,WrapperMatrix2D,solve,inverse,determinant,linearDependencies,pseudoInverse,covariance,correlation,SingularValueDecomposition,SVD:SingularValueDecomposition,EigenvalueDecomposition,EVD:EigenvalueDecomposition,CholeskyDecomposition,CHO:CholeskyDecomposition,LuDecomposition,LU:LuDecomposition,QrDecomposition,QR:QrDecomposition,Nipals:nipals,NIPALS:nipals,MatrixColumnView,MatrixColumnSelectionView,MatrixFlipColumnView,MatrixFlipRowView,MatrixRowView,MatrixRowSelectionView,MatrixSelectionView,MatrixSubView,MatrixTransposeView:MatrixTransposeView$1},Symbol.toStringTag,{value:"Module"}));function getSeparatedKernel(e){const r=new SingularValueDecomposition(e,{autoTranspose:!0});if(r.rank!==1)return null;const n=Math.sqrt(r.s[0]),a=r.U.to2DArray().map(f=>f[0]*n),u=r.V.to2DArray().map(f=>f[0]*n);return[a,u]}function convolution(e,r={}){let{channels:n,bitDepth:a,normalize:u=!1,divisor:f=1,border:_="copy",algorithm:o="auto"}=r,b={};a&&(b.bitDepth=a);let E=Image.createFrom(this,b);if(n=validateArrayOfChannels(this,n),o!=="separable")({kernel:e}=validateKernel(e));else if(!Array.isArray(e)||e.length!==2)throw new RangeError("separable convolution requires two arrays of numbers to represent the kernel");if(o==="auto"){let Y=getSeparatedKernel(e);Y!==null?(o="separable",e=Y):(e.length>9||e[0].length>9)&&this.width<=4096&&this.height<=4096?o="fft":o="direct"}let M,P;o==="separable"?(M=Math.floor(e[0].length/2),P=Math.floor(e[1].length/2)):(M=Math.floor(e.length/2),P=Math.floor(e[0].length/2));let L=E.isClamped,D=new Array(this.height*this.width),U,X,K,q,oe,W;for(q=0;q<n.length;q++){for(oe=n[q],K=0;K<this.height;K++)for(X=0;X<this.width;X++)U=K*this.width+X,D[U]=this.data[U*this.channels+oe];if(o==="direct")W=src$2.direct(D,e,{rows:this.height,cols:this.width,normalize:u,divisor:f});else if(o==="separable"){if(W=convolutionSeparable(D,e,this.width,this.height),u){f=0;for(let Y=0;Y<e[0].length;Y++)for(let J=0;J<e[1].length;J++)f+=e[0][Y]*e[1][J]}if(f!==1)for(let Y=0;Y<W.length;Y++)W[Y]/=f}else W=src$2.fft(D,e,{rows:this.height,cols:this.width,normalize:u,divisor:f});for(K=0;K<this.height;K++)for(X=0;X<this.width;X++)U=K*this.width+X,L?E.data[U*this.channels+oe]=clamp(W[U],E):E.data[U*this.channels+oe]=W[U]}if(this.alpha&&!n.includes(this.channels))for(X=this.components;X<this.data.length;X=X+this.channels)E.data[X]=this.data[X];return _!=="periodic"&&E.setBorder({size:[P,M],algorithm:_}),E}function gradientFilter(e={}){let{direction:r="xy",border:n="copy",kernelX:a,kernelY:u,channels:f,bitDepth:_=this.bitDepth}=e;switch(this.checkProcessable("gradientFilter",{bitDepth:[8,16]}),r){case"x":if(!a)throw new Error("kernelX option is missing");return convolution.call(this,a,{channels:f,border:n,bitDepth:_});case"y":if(!u)throw new Error("kernelY option is missing");return convolution.call(this,u,{channels:f,border:n,bitDepth:_});case"xy":{if(!a)throw new Error("kernelX option is missing");if(!u)throw new Error("kernelY option is missing");const o=convolution.call(this,a,{channels:f,border:n,bitDepth:32}),b=convolution.call(this,u,{channels:f,border:n,bitDepth:32});return o.hypotenuse(b,{bitDepth:_,channels:f})}default:throw new Error(`Unknown parameter direction: ${r}`)}}function sobelFilter(e){return gradientFilter.call(this,Object.assign({},e,{kernelX:SOBEL_X,kernelY:SOBEL_Y}))}function scharrFilter(e){return gradientFilter.call(this,Object.assign({},e,{kernelX:SCHARR_X,kernelY:SCHARR_Y}))}var newArray_1=newArray;function newArray(e,r){e=e||0;for(var n=new Array(e),a=0;a<e;a++)n[a]=r;return n}function level(e={}){let{algorithm:r="range",channels:n,min:a=this.min,max:u=this.max}=e;switch(this.checkProcessable("level",{bitDepth:[8,16,32]}),n=validateArrayOfChannels(this,{channels:n}),n.length!==this.channel&&(Array.isArray(a)&&a.length===this.channels&&(a=a.filter((f,_)=>n.includes(_))),Array.isArray(u)&&u.length===this.channels&&(u=u.filter((f,_)=>n.includes(_)))),r){case"range":a<0&&(a=0),u>this.maxValue&&(u=this.maxValue),Array.isArray(a)||(a=newArray_1(n.length,a)),Array.isArray(u)||(u=newArray_1(n.length,u)),processImage(this,a,u,n);break;default:throw new Error(`level: algorithm not implement: ${r}`)}return this}function processImage(e,r,n,a){let u=1e-5,f=new Array(a.length);for(let _=0;_<a.length;_++)r[_]===0&&n[_]===e.maxValue||n[_]===r[_]?f[_]=0:f[_]=(e.maxValue+1-u)/(n[_]-r[_]),r[_]+=(.5-u/2)/f[_];for(let _=0;_<a.length;_++){let o=a[_];if(f[_]!==0)for(let b=0;b<e.data.length;b+=e.channels)e.data[b+o]=Math.min(Math.max(0,(e.data[b+o]-r[_])*f[_]+.5|0),e.maxValue)}}var toString$1=Object.prototype.toString,isArrayType=function e(r){return toString$1.call(r).substr(-6,5)==="Array"};function checkNumberArray(e){if(isNaN(e)){if(e instanceof Image)return e.data;if(!isArrayType(e))throw new Error("checkNumberArray: the value should be either a number, array or Image");return e}else{if(e<=0)throw new Error("checkNumberArray: the value must be greater than 0");return e}}function add(e,r={}){let{channels:n}=r;if(this.checkProcessable("add",{bitDepth:[8,16]}),n=validateArrayOfChannels(this,{channels:n}),e=checkNumberArray(e),isNaN(e)){if(this.data.length!==e.length)throw new Error("add: the data size is different");for(let a=0;a<n.length;a++){let u=n[a];for(let f=0;f<this.data.length;f+=this.channels)this.data[f+u]=Math.max(0,Math.min(this.maxValue,this.data[f+u]+e[f+u]>>0))}}else for(let a=0;a<n.length;a++){let u=n[a];for(let f=0;f<this.data.length;f+=this.channels)this.data[f+u]=Math.min(this.maxValue,this.data[f+u]+e>>0)}return this}function subtract(e,r={}){let{channels:n}=r;if(this.checkProcessable("subtract",{bitDepth:[8,16]}),n=validateArrayOfChannels(this,{channels:n}),e=checkNumberArray(e),isNaN(e)){if(this.data.length!==e.length)throw new Error("subtract: the data size is different");for(let a=0;a<n.length;a++){let u=n[a];for(let f=0;f<this.data.length;f+=this.channels)this.data[f+u]=Math.max(0,Math.min(this.maxValue,this.data[f+u]-e[f+u]>>0))}}else for(let a=0;a<n.length;a++){let u=n[a];for(let f=0;f<this.data.length;f+=this.channels)this.data[f+u]=Math.max(0,this.data[f+u]-e>>0)}return this}function subtractImage(e,r={}){let{channels:n,absolute:a=!1}=r;if(this.checkProcessable("subtractImage",{bitDepth:[8,16]}),this.width!==e.width||this.height!==e.height)throw new Error("subtractImage: both images must have the same size");if(this.alpha!==e.alpha||this.bitDepth!==e.bitDepth)throw new Error("subtractImage: both images must have the same alpha and bitDepth");if(this.channels!==e.channels)throw new Error("subtractImage: both images must have the same number of channels");let u=this.clone();n=validateArrayOfChannels(this,{channels:n});for(let f=0;f<n.length;f++){let _=n[f];for(let o=_;o<this.data.length;o+=this.channels){let b=this.data[o]-e.data[o];a?u.data[o]=Math.abs(b):u.data[o]=Math.max(b,0)}}return u}function hypotenuse(e,r={}){let{bitDepth:n=this.bitDepth,channels:a}=r;if(this.checkProcessable("hypotenuse",{bitDepth:[8,16,32]}),this.width!==e.width||this.height!==e.height)throw new Error("hypotenuse: both images must have the same size");if(this.alpha!==e.alpha||this.bitDepth!==e.bitDepth)throw new Error("hypotenuse: both images must have the same alpha and bitDepth");if(this.channels!==e.channels)throw new Error("hypotenuse: both images must have the same number of channels");let u=Image.createFrom(this,{bitDepth:n});a=validateArrayOfChannels(this,{channels:a});let f=u.isClamped;for(let _=0;_<a.length;_++){let o=a[_];for(let b=o;b<this.data.length;b+=this.channels){let E=Math.hypot(this.data[b],e.data[b]);f?u.data[b]=Math.min(Math.max(Math.round(E),0),u.maxValue):u.data[b]=E}}return u}function multiply(e,r={}){let{channels:n}=r;if(this.checkProcessable("multiply",{bitDepth:[8,16]}),e<=0)throw new Error("multiply: the value must be greater than 0");if(n=validateArrayOfChannels(this,{channels:n}),e=checkNumberArray(e),isNaN(e)){if(this.data.length!==e.length)throw new Error("multiply: the data size is different");for(let a=0;a<n.length;a++){let u=n[a];for(let f=0;f<this.data.length;f+=this.channels)this.data[f+u]=Math.max(0,Math.min(this.maxValue,this.data[f+u]*e[f+u]>>0))}}else for(let a=0;a<n.length;a++){let u=n[a];for(let f=0;f<this.data.length;f+=this.channels)this.data[f+u]=Math.min(this.maxValue,this.data[f+u]*e>>0)}return this}function divide(e,r={}){let{channels:n}=r;if(this.checkProcessable("divide",{bitDepth:[8,16]}),n=validateArrayOfChannels(this,{channels:n}),e=checkNumberArray(e),isNaN(e)){if(this.data.length!==e.length)throw new Error("divide: the: the data size is different");for(let a=0;a<n.length;a++){let u=n[a];for(let f=0;f<this.data.length;f+=this.channels)this.data[f+u]=Math.max(0,Math.min(this.maxValue,this.data[f+u]/e[f+u]>>0))}}else for(let a=0;a<n.length;a++){let u=n[a];for(let f=0;f<this.data.length;f+=this.channels)this.data[f+u]=Math.min(this.maxValue,this.data[f+u]/e>>0)}return this}class BaseRegression{constructor(){if(new.target===BaseRegression)throw new Error("BaseRegression must be subclassed")}predict(r){if(typeof r=="number")return this._predict(r);if(isAnyArray(r)){const n=[];for(let a=0;a<r.length;a++)n.push(this._predict(r[a]));return n}else throw new TypeError("x must be a number or array")}_predict(){throw new Error("_predict must be implemented")}train(){}toString(){return""}toLaTeX(){return""}score(r,n){if(!isAnyArray(r)||!isAnyArray(n)||r.length!==n.length)throw new Error("x and y must be arrays of the same length");const a=r.length,u=new Array(a);for(let D=0;D<a;D++)u[D]=this._predict(r[D]);let f=0,_=0,o=0,b=0,E=0,M=0,P=0;for(let D=0;D<a;D++)f+=u[D],_+=n[D],E+=u[D]*u[D],M+=n[D]*n[D],P+=u[D]*n[D],n[D]!==0&&(o+=(n[D]-u[D])*(n[D]-u[D])/n[D]),b+=(n[D]-u[D])*(n[D]-u[D]);const L=(a*P-f*_)/Math.sqrt((a*E-f*f)*(a*M-_*_));return{r:L,r2:L*L,chi2:o,rmsd:Math.sqrt(b/a)}}}var require$$0$2=getAugmentedNamespace(src$1);function squaredEuclidean$4(e,r){let n=0;for(let a=0;a<e.length;a++)n+=(e[a]-r[a])*(e[a]-r[a]);return n}function euclidean$2(e,r){return Math.sqrt(squaredEuclidean$4(e,r))}var euclidean$3=Object.freeze(Object.defineProperty({__proto__:null,squaredEuclidean:squaredEuclidean$4,euclidean:euclidean$2},Symbol.toStringTag,{value:"Module"})),require$$0$1=getAugmentedNamespace(euclidean$3);const{squaredEuclidean:squaredEuclidean$3}=require$$0$1,defaultOptions$b={sigma:1};class GaussianKernel$1{constructor(r){r=Object.assign({},defaultOptions$b,r),this.sigma=r.sigma,this.divisor=2*r.sigma*r.sigma}compute(r,n){const a=squaredEuclidean$3(r,n);return Math.exp(-a/this.divisor)}}var gaussianKernel=GaussianKernel$1;const defaultOptions$a={degree:1,constant:1,scale:1};class PolynomialKernel$1{constructor(r){r=Object.assign({},defaultOptions$a,r),this.degree=r.degree,this.constant=r.constant,this.scale=r.scale}compute(r,n){for(var a=0,u=0;u<r.length;u++)a+=r[u]*n[u];return Math.pow(this.scale*a+this.constant,this.degree)}}var polynomialKernel=PolynomialKernel$1;const defaultOptions$9={alpha:.01,constant:-Math.E};class SigmoidKernel$1{constructor(r){r=Object.assign({},defaultOptions$9,r),this.alpha=r.alpha,this.constant=r.constant}compute(r,n){for(var a=0,u=0;u<r.length;u++)a+=r[u]*n[u];return Math.tanh(this.alpha*a+this.constant)}}var sigmoidKernel=SigmoidKernel$1;const defaultOptions$8={sigma:1,degree:1};class ANOVAKernel$1{constructor(r){r=Object.assign({},defaultOptions$8,r),this.sigma=r.sigma,this.degree=r.degree}compute(r,n){for(var a=0,u=Math.min(r.length,n.length),f=1;f<=u;++f)a+=Math.pow(Math.exp(-this.sigma*Math.pow(Math.pow(r[f-1],f)-Math.pow(n[f-1],f),2)),this.degree);return a}}var anovaKernel=ANOVAKernel$1;const{squaredEuclidean:squaredEuclidean$2}=require$$0$1,defaultOptions$7={sigma:1};class CauchyKernel$1{constructor(r){r=Object.assign({},defaultOptions$7,r),this.sigma=r.sigma}compute(r,n){return 1/(1+squaredEuclidean$2(r,n)/(this.sigma*this.sigma))}}var cauchyKernel=CauchyKernel$1;const{euclidean:euclidean$1}=require$$0$1,defaultOptions$6={sigma:1};class ExponentialKernel$1{constructor(r){r=Object.assign({},defaultOptions$6,r),this.sigma=r.sigma,this.divisor=2*r.sigma*r.sigma}compute(r,n){const a=euclidean$1(r,n);return Math.exp(-a/this.divisor)}}var exponentialKernel=ExponentialKernel$1;class HistogramIntersectionKernel{compute(r,n){for(var a=Math.min(r.length,n.length),u=0,f=0;f<a;++f)u+=Math.min(r[f],n[f]);return u}}var histogramIntersectionKernel=HistogramIntersectionKernel;const{euclidean}=require$$0$1,defaultOptions$5={sigma:1};class LaplacianKernel$1{constructor(r){r=Object.assign({},defaultOptions$5,r),this.sigma=r.sigma}compute(r,n){const a=euclidean(r,n);return Math.exp(-a/this.sigma)}}var laplacianKernel=LaplacianKernel$1;const{squaredEuclidean:squaredEuclidean$1}=require$$0$1,defaultOptions$4={constant:1};class MultiquadraticKernel$1{constructor(r){r=Object.assign({},defaultOptions$4,r),this.constant=r.constant}compute(r,n){return Math.sqrt(squaredEuclidean$1(r,n)+this.constant*this.constant)}}var multiquadraticKernel=MultiquadraticKernel$1;const{squaredEuclidean}=require$$0$1,defaultOptions$3={constant:1};class RationalQuadraticKernel{constructor(r){r=Object.assign({},defaultOptions$3,r),this.constant=r.constant}compute(r,n){const a=squaredEuclidean(r,n);return 1-a/(a+this.constant)}}var rationalQuadraticKernel=RationalQuadraticKernel;const{Matrix:Matrix$1,MatrixTransposeView}=require$$0$2,GaussianKernel=gaussianKernel,PolynomialKernel=polynomialKernel,SigmoidKernel=sigmoidKernel,ANOVAKernel=anovaKernel,CauchyKernel=cauchyKernel,ExponentialKernel=exponentialKernel,HistogramKernel=histogramIntersectionKernel,LaplacianKernel=laplacianKernel,MultiquadraticKernel=multiquadraticKernel,RationalKernel=rationalQuadraticKernel,kernelType={gaussian:GaussianKernel,rbf:GaussianKernel,polynomial:PolynomialKernel,poly:PolynomialKernel,anova:ANOVAKernel,cauchy:CauchyKernel,exponential:ExponentialKernel,histogram:HistogramKernel,min:HistogramKernel,laplacian:LaplacianKernel,multiquadratic:MultiquadraticKernel,rational:RationalKernel,sigmoid:SigmoidKernel,mlp:SigmoidKernel};class Kernel{constructor(r,n){if(this.kernelType=r,r!=="linear")if(typeof r=="string"){r=r.toLowerCase();var a=kernelType[r];if(a)this.kernelFunction=new a(n);else throw new Error(`unsupported kernel type: ${r}`)}else if(typeof r=="object"&&typeof r.compute=="function")this.kernelFunction=r;else throw new TypeError("first argument must be a valid kernel type or instance")}compute(r,n){if(r=Matrix$1.checkMatrix(r),n===void 0?n=r:n=Matrix$1.checkMatrix(n),this.kernelType==="linear")return r.mmul(new MatrixTransposeView(n));const a=new Matrix$1(r.rows,n.rows);if(r===n)for(let u=0;u<r.rows;u++)for(let f=u;f<r.rows;f++){const _=this.kernelFunction.compute(r.getRow(u),r.getRow(f));a.set(u,f,_),a.set(f,u,_)}else for(let u=0;u<r.rows;u++)for(let f=0;f<n.rows;f++)a.set(u,f,this.kernelFunction.compute(r.getRow(u),n.getRow(f)));return a}}var kernel=Kernel;const defaultOptions$2={lambda:.1,kernelType:"gaussian",kernelOptions:{},computeCoefficient:!1};class KernelRidgeRegression extends BaseRegression{constructor(r,n,a){if(super(),r===!0)this.alpha=n.alpha,this.inputs=n.inputs,this.kernelType=n.kernelType,this.kernelOptions=n.kernelOptions,this.kernel=new kernel(n.kernelType,n.kernelOptions);else{r=Matrix$2.checkMatrix(r),a=Object.assign({},defaultOptions$2,a);const u=new kernel(a.kernelType,a.kernelOptions),f=u.compute(r),_=r.rows;f.add(Matrix$2.eye(_,_).mul(a.lambda)),this.alpha=solve(f,n),this.inputs=r,this.kernelType=a.kernelType,this.kernelOptions=a.kernelOptions,this.kernel=u}}_predict(r){return this.kernel.compute([r],this.inputs).mmul(this.alpha).getRow(0)}toJSON(){return{name:"kernelRidgeRegression",alpha:this.alpha,inputs:this.inputs,kernelType:this.kernelType,kernelOptions:this.kernelOptions}}static load(r){if(r.name!=="kernelRidgeRegression")throw new TypeError("not a KRR model");return new KernelRidgeRegression(!0,r)}}function background$1(e,r,n){const a=new KernelRidgeRegression(e,r,n),u=new Array(this.size);for(let o=0;o<this.width;o++)for(let b=0;b<this.height;b++)u[b*this.width+o]=[o,b];const f=a.predict(u),_=Image.createFrom(this);for(let o=0;o<this.size;o++)_.data[o]=Math.min(this.maxValue,Math.max(0,f[o][0]));return _}function dilate(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:n=1}=e;if(this.checkProcessable("dilate",{bitDepth:[1,8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("dilate: The number of rows and columns of the kernel must be odd");let a=!0;e:for(const f of r)for(const _ of f)if(_!==1){a=!1;break e}let u=this;for(let f=0;f<n;f++)if(this.bitDepth===1)if(a){const _=u.clone();u=dilateOnceBinaryOnlyOnes(u,_,r.length,r[0].length)}else{const _=Image.createFrom(u);u=dilateOnceBinary(u,_,r)}else if(a){const _=Image.createFrom(u);u=dilateOnceGreyOnlyOnes(u,_,r.length,r[0].length)}else{const _=Image.createFrom(u);u=dilateOnceGrey(u,_,r)}return u}function dilateOnceGrey(e,r,n){const a=n.length,u=n[0].length;let f=(a-1)/2,_=(u-1)/2;for(let o=0;o<e.height;o++)for(let b=0;b<e.width;b++){let E=0;for(let M=0;M<u;M++)for(let P=0;P<a;P++){if(n[P][M]!==1)continue;let L=P-f+b,D=M-_+o;if(L<0||D<0||L>=e.width||D>=e.height)continue;const U=e.getValueXY(L,D,0);U>E&&(E=U)}r.setValueXY(b,o,0,E)}return r}function dilateOnceGreyOnlyOnes(e,r,n,a){const u=(n-1)/2,f=(a-1)/2,_=[];for(let o=0;o<e.width;o++)_.push(0);for(let o=0;o<e.height;o++){for(let b=0;b<e.width;b++){let E=0;for(let M=Math.max(0,o-f);M<Math.min(e.height,o+f+1);M++){const P=e.getValueXY(b,M,0);P>E&&(E=P)}_[b]=E}for(let b=0;b<e.width;b++){let E=0;for(let M=Math.max(0,b-u);M<Math.min(e.width,b+u+1);M++)_[M]>E&&(E=_[M]);r.setValueXY(b,o,0,E)}}return r}function dilateOnceBinary(e,r,n){const a=n.length,u=n[0].length;let f=(a-1)/2,_=(u-1)/2;for(let o=0;o<e.height;o++)for(let b=0;b<e.width;b++){let E=0;e:for(let M=0;M<u;M++)for(let P=0;P<a;P++){if(n[P][M]!==1)continue;let L=P-f+b,D=M-_+o;if(D<0||L<0||L>=e.width||D>=e.height)continue;if(e.getBitXY(L,D)===1){E=1;break e}}E===1&&r.setBitXY(b,o)}return r}function dilateOnceBinaryOnlyOnes(e,r,n,a){const u=(n-1)/2,f=(a-1)/2,_=[];for(let o=0;o<e.width;o++)_.push(1);for(let o=0;o<e.height;o++){for(let b=0;b<e.width;b++){_[b]=0;for(let E=Math.max(0,o-f);E<Math.min(e.height,o+f+1);E++)if(e.getBitXY(b,E)===1){_[b]=1;break}}for(let b=0;b<e.width;b++)if(r.getBitXY(b,o)!==1){for(let E=Math.max(0,b-u);E<Math.min(e.width,b+u+1);E++)if(_[E]===1){r.setBitXY(b,o);break}}}return r}function erode(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:n=1}=e;if(this.checkProcessable("erode",{bitDepth:[1,8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("erode: The number of rows and columns of the kernel must be odd");let a=!0;e:for(const f of r)for(const _ of f)if(_!==1){a=!1;break e}let u=this;for(let f=0;f<n;f++)if(this.bitDepth===1)if(a){const _=u.clone();u=erodeOnceBinaryOnlyOnes(u,_,r.length,r[0].length)}else{const _=Image.createFrom(u);u=erodeOnceBinary(u,_,r)}else if(a){const _=Image.createFrom(u);u=erodeOnceGreyOnlyOnes(u,_,r.length,r[0].length)}else{const _=Image.createFrom(u);u=erodeOnceGrey(u,_,r)}return u}function erodeOnceGrey(e,r,n){const a=n.length,u=n[0].length;let f=(a-1)/2,_=(u-1)/2;for(let o=0;o<e.height;o++)for(let b=0;b<e.width;b++){let E=e.maxValue;for(let M=0;M<u;M++)for(let P=0;P<a;P++){if(n[P][M]!==1)continue;let L=P-f+b,D=M-_+o;if(L<0||D<0||L>=e.width||D>=e.height)continue;const U=e.getValueXY(L,D,0);U<E&&(E=U)}r.setValueXY(b,o,0,E)}return r}function erodeOnceGreyOnlyOnes(e,r,n,a){const u=(n-1)/2,f=(a-1)/2,_=[];for(let o=0;o<e.width;o++)_.push(0);for(let o=0;o<e.height;o++){for(let b=0;b<e.width;b++){let E=e.maxValue;for(let M=Math.max(0,o-f);M<Math.min(e.height,o+f+1);M++){const P=e.getValueXY(b,M,0);P<E&&(E=P)}_[b]=E}for(let b=0;b<e.width;b++){let E=e.maxValue;for(let M=Math.max(0,b-u);M<Math.min(e.width,b+u+1);M++)_[M]<E&&(E=_[M]);r.setValueXY(b,o,0,E)}}return r}function erodeOnceBinary(e,r,n){const a=n.length,u=n[0].length;let f=(a-1)/2,_=(u-1)/2;for(let o=0;o<e.height;o++)for(let b=0;b<e.width;b++){let E=1;e:for(let M=0;M<u;M++)for(let P=0;P<a;P++){if(n[P][M]!==1)continue;let L=P-f+b,D=M-_+o;if(D<0||L<0||L>=e.width||D>=e.height)continue;if(e.getBitXY(L,D)===0){E=0;break e}}E===1&&r.setBitXY(b,o)}return r}function erodeOnceBinaryOnlyOnes(e,r,n,a){const u=(n-1)/2,f=(a-1)/2,_=[];for(let o=0;o<e.width;o++)_.push(0);for(let o=0;o<e.height;o++){for(let b=0;b<e.width;b++){_[b]=1;for(let E=Math.max(0,o-f);E<Math.min(e.height,o+f+1);E++)if(e.getBitXY(b,E)===0){_[b]=0;break}}for(let b=0;b<e.width;b++)if(r.getBitXY(b,o)!==0){for(let E=Math.max(0,b-u);E<Math.min(e.width,b+u+1);E++)if(_[E]===0){r.clearBitXY(b,o);break}}}return r}function open(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:n=1}=e;if(this.checkProcessable("open",{bitDepth:[8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("open: The number of rows and columns of the kernel must be odd");let a=this;for(let u=0;u<n;u++)a=a.erode({kernel:r}),a=a.dilate({kernel:r});return a}function close(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:n=1}=e;if(this.checkProcessable("close",{bitDepth:[1,8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("close: The number of rows and columns of the kernel must be odd");let a=this;for(let u=0;u<n;u++)a=a.dilate({kernel:r}).erode({kernel:r});return a}function topHat(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:n=1}=e;if(this.checkProcessable("topHat",{bitDepth:[8,16],components:1,alpha:0}),r.length%2===0||r[0].length%2===0)throw new TypeError("topHat: The number of rows and columns of the kernel must be odd");let a=this;for(let u=0;u<n;u++)a=a.open({kernel:r}).subtractImage(a,{absolute:!0});return a}function blackHat(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:n=1}=e;if(this.checkProcessable("blackHat",{bitDepth:[8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("blackHat: The number of rows and columns of the kernel must be odd");let a=this;for(let u=0;u<n;u++)a=a.close({kernel:r}).subtractImage(a,{absolute:!0});return a}function morphologicalGradient(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:n=1}=e;if(this.checkProcessable("morphologicalGradient",{bitDepth:[8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("morphologicalGradient: The number of rows and columns of the kernel must be odd");let a=this;for(let u=0;u<n;u++){let f=a.dilate({kernel:r}),_=a.erode({kernel:r});a=f.subtractImage(_,{absolute:!0})}return a}function order4Points(e){let r=0,n=0,a=0,u=0,f=e[0][0],_=0;for(let E=1;E<e.length;E++)e[E][0]<f&&(f=e[E][0],_=E);let o=e[(_+1)%e.length][0],b=(_+1)%e.length;for(let E=1;E<e.length;E++)e[E][0]<o&&E!==_&&(o=e[E][0],b=E);return e[b][1]<e[_][1]?(r=e[b],u=e[_],_!==(b+1)%4?(n=e[(b+1)%4],a=e[(b+2)%4]):(n=e[(b+2)%4],a=e[(b+3)%4])):(u=e[b],r=e[_],b!==(_+1)%4?(n=e[(_+1)%4],a=e[(_+2)%4]):(n=e[(_+2)%4],a=e[(_+3)%4])),[r,n,a,u]}function distance2Points(e,r){return Math.sqrt(Math.pow(e[0]-r[0],2)+Math.pow(e[1]-r[1],2))}function crossVect(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]}function dotVect(e,r){return e[0]*r[0]+e[1]*r[1]+e[2]*r[2]}function computeWidthAndHeigth(e,r,n,a,u,f){let _=Math.max(distance2Points(e,r),distance2Points(a,n)),o=Math.max(distance2Points(e,a),distance2Points(r,n)),b=0,E=0,M=Math.ceil(u/2),P=Math.ceil(f/2),L=_/o,D=[e[0],e[1],1],U=[r[0],r[1],1],X=[a[0],a[1],1],K=[n[0],n[1],1],q=dotVect(crossVect(D,K),X)/dotVect(crossVect(U,K),X),oe=dotVect(crossVect(D,K),U)/dotVect(crossVect(X,K),U),W=[q*U[0]-D[0],q*U[1]-D[1],q*U[2]-D[2]],Y=[oe*X[0]-D[0],oe*X[1]-D[1],oe*X[2]-D[2]],J=W[0],Ee=W[1],xe=W[2],se=Y[0],ce=Y[1],ee=Y[2],he=1/(xe*ee)*(J*se-(J*ee+xe*se)*M+xe*ee*M*M+(Ee*ce-(Ee*ee+xe*ce)*P+xe*ee*P*P));he>=0?he=Math.sqrt(he):he=Math.sqrt(-he);let Ie=new Matrix$2([[he,0,M],[0,he,P],[0,0,1]]),Pe=Ie.transpose(),Qe=inverse(Pe),We=inverse(Ie),Zt=Matrix$2.rowVector(W),ti=Matrix$2.rowVector(Y),$t=Math.sqrt(dotVect(Zt.mmul(Qe).mmul(We).to1DArray(),W)/dotVect(ti.mmul(Qe).mmul(We).to1DArray(),Y));return $t===0||L===0?(b=Math.ceil(_),E=Math.ceil(o)):$t<L?(b=Math.ceil(_),E=Math.ceil(b/$t)):(E=Math.ceil(o),b=Math.ceil($t*E)),[b,E]}function projectionPoint(e,r,n,a,u,f,_,o,b,E,M,P){let[L,D]=[(n*e+a*r+u)/(b*e+E*r+1),(f*e+_*r+o)/(b*e+E*r+1)];return M.getValueXY(Math.floor(L),Math.floor(D),P)}function warpingFourPoints(e,r={}){let{calculateRatio:n=!0}=r;if(e.length!==4)throw new Error(`The array pts must have four elements, which are the four corners. Currently, pts have ${e.length} elements`);let[a,u,f,_]=e,o=[a,u,f,_],[b,E,M,P]=order4Points(o),L,D;n?[L,D]=computeWidthAndHeigth(b,E,M,P,this.width,this.height):(L=Math.ceil(Math.max(distance2Points(b,E),distance2Points(P,M))),D=Math.ceil(Math.max(distance2Points(b,P),distance2Points(E,M))));let U=Image.createFrom(this,{width:L,height:D}),[X,K]=b,[q,oe]=E,[W,Y]=M,[J,Ee]=P,[xe,se]=[0,0],[ce,ee]=[0,L-1],[he,Ie]=[D-1,L-1],[Pe,Qe]=[D-1,0],We=new Matrix$2([[xe,se,1,0,0,0,-xe*X,-se*X],[ce,ee,1,0,0,0,-ce*q,-ee*q],[he,Ie,1,0,0,0,-he*W,-se*W],[Pe,Qe,1,0,0,0,-Pe*J,-Qe*J],[0,0,0,xe,se,1,-xe*K,-se*K],[0,0,0,ce,ee,1,-ce*oe,-ee*oe],[0,0,0,he,Ie,1,-he*Y,-Ie*Y],[0,0,0,Pe,Qe,1,-Pe*Ee,-Qe*Ee]]),Zt=Matrix$2.columnVector([X,q,W,J,K,oe,Y,Ee]),$t=new SingularValueDecomposition(We).solve(Zt),[oi,je,_t,Bt,dt,At,Tt,Dt]=$t.to1DArray(),Ct=new Matrix$2(D,L);for(let pi=0;pi<this.channels;pi++){for(let yt=0;yt<D;yt++)for(let vi=0;vi<L;vi++)Ct.set(yt,vi,projectionPoint(yt,vi,oi,je,_t,Bt,dt,At,Tt,Dt,this,pi));U.setMatrix(Ct,{channel:pi})}return U}function crop(e={}){let{x:r=0,y:n=0,width:a=this.width-r,height:u=this.height-n}=e;if(this.checkProcessable("crop",{bitDepth:[1,8,16]}),r=Math.round(r),n=Math.round(n),a=Math.round(a),u=Math.round(u),r>this.width-1||n>this.height-1)throw new RangeError(`crop: origin (x:${r}, y:${n}) out of range (${this.width-1}; ${this.height-1})`);if(a<=0||u<=0)throw new RangeError(`crop: width and height (width:${a}; height:${u}) must be positive numbers`);if(r<0||n<0)throw new RangeError(`crop: x and y (x:${r}, y:${n}) must be positive numbers`);if(a>this.width-r||u>this.height-n)throw new RangeError(`crop: (x: ${r}, y:${n}, width:${a}, height:${u}) size is out of range`);let f=this;if(this.bitDepth===1){const _=new Image(a,u,{kind:"BINARY",parent:this});f=cropBinary(this,_,r,n,a,u)}else{const _=Image.createFrom(this,{width:a,height:u,position:[r,n]});f=cropDefault(this,_,r,n,a,u)}return f}function cropDefault(e,r,n,a,u,f){let _=u*e.channels,o=a+f,b=0,E=n*e.channels;for(let M=a;M<o;M++){let P=M*e.width*e.channels+E,L=P+_;for(;P<L;P++)r.data[b++]=e.data[P]}return r}function cropBinary(e,r,n,a,u,f){let _=u*e.channels,o=a+f,b=0,E=n*e.channels;for(let M=a;M<o;M++){let P=M*e.width*e.channels+E,L=P+_;for(;P<L;P++)e.getBit(P)&&r.setBit(b),++b}return r}function cropAlpha(e={}){this.checkProcessable("cropAlpha",{alpha:1});const{threshold:r=this.maxValue}=e;let n=findLeft(this,r,this.components);if(n===-1)throw new Error("Could not find new dimensions. Threshold may be too high.");let a=findTop(this,r,this.components,n),u=findBottom(this,r,this.components,n),f=findRight(this,r,this.components,n,a,u);return this.crop({x:n,y:a,width:f-n+1,height:u-a+1})}function findLeft(e,r,n){for(let a=0;a<e.width;a++)for(let u=0;u<e.height;u++)if(e.getValueXY(a,u,n)>=r)return a;return-1}function findTop(e,r,n,a){for(let u=0;u<e.height;u++)for(let f=a;f<e.width;f++)if(e.getValueXY(f,u,n)>=r)return u;return-1}function findBottom(e,r,n,a){for(let u=e.height-1;u>=0;u--)for(let f=a;f<e.width;f++)if(e.getValueXY(f,u,n)>=r)return u;return-1}function findRight(e,r,n,a,u,f){for(let _=e.width-1;_>=a;_--)for(let o=u;o<=f;o++)if(e.getValueXY(_,o,n)>=r)return _;return-1}function getFactor(e){if(typeof e=="string"){const r=e[e.length-1];e=parseFloat(e),r==="%"&&(e/=100)}return e}function getThreshold$1(e,r){if(!r)throw Error("getThreshold : the maxValue should be specified");if(typeof e=="string"){if(e[e.length-1]!=="%")throw Error("getThreshold : if the value is a string it must finish by %");return parseFloat(e)/100*r}else{if(typeof e=="number")return e<1?e*r:e;throw Error("getThreshold : the value is not valid")}}function factorDimensions(e,r,n){e=getFactor(e);let a=Math.round(e*r),u=Math.round(e*n);return a<=0&&(a=1),u<=0&&(u=1),{width:a,height:u}}function checkRow(e,r){if(r<0||r>=e.height)throw new RangeError(`row must be included between 0 and ${e.height-1}. Current value: ${r}`)}function checkColumn(e,r){if(r<0||r>=e.width)throw new RangeError(`column must be included between 0 and ${e.width-1}. Current value: ${r}`)}function checkChannel(e,r){if(r<0||r>=e.channels)throw new RangeError(`channel must be included between 0 and ${e.channels-1}. Current value: ${r}`)}const validInterpolations={nearestneighbor:"nearestNeighbor",nearestneighbour:"nearestNeighbor",bilinear:"bilinear"};function checkInterpolation(e){if(typeof e!="string")throw new TypeError("interpolation must be a string");if(e=e.toLowerCase(),!validInterpolations[e])throw new RangeError(`invalid interpolation algorithm: ${e}`);return validInterpolations[e]}function nearestNeighbor(e,r,n){const a=this.width/r,u=this.height/n;if(this.bitDepth>1)for(let f=0;f<r;f++){const _=Math.floor((f+.5)*a);for(let o=0;o<n;o++){const b=Math.floor((o+.5)*u);for(let E=0;E<this.channels;E++)e.setValueXY(f,o,E,this.getValueXY(_,b,E))}}else for(let f=0;f<r;f++){const _=Math.floor((f+.5)*a);for(let o=0;o<n;o++){const b=Math.floor((o+.5)*u);this.getBitXY(_,b)&&e.setBitXY(f,o)}}}function resize(e={}){const{factor:r=1,interpolation:n=validInterpolations.nearestneighbor,preserveAspectRatio:a=!0}=e,u=checkInterpolation(n);let f=e.width,_=e.height;if(f||(_&&a?f=Math.round(_*(this.width/this.height)):f=this.width),_||(a?_=Math.round(f*(this.height/this.width)):_=this.height),{width:f,height:_}=factorDimensions(r,f,_),f===this.width&&_===this.height){const M=this.clone();return M.position=[0,0],M}let o=Math.round((this.width-f)/2),b=Math.round((this.height-_)/2);const E=Image.createFrom(this,{width:f,height:_,position:[o,b]});switch(u){case validInterpolations.nearestneighbor:nearestNeighbor.call(this,E,f,_);break;default:throw new Error(`unsupported resize interpolation: ${u}`)}return E}function hsv(){this.checkProcessable("hsv",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let e=Image.createFrom(this,{colorModel:HSV}),r=0,n=this.data;for(let a=0;a<n.length;a+=this.channels){let u=n[a],f=n[a+1],_=n[a+2],o=Math.min(u,f,_),b=Math.max(u,f,_),E=b-o,M=0,P=b===0?0:E/b,L=b;if(b!==o){switch(b){case u:M=(f-_)/E+(f<_?6:0);break;case f:M=(_-u)/E+2;break;case _:M=(u-f)/E+4;break;default:throw new Error("unreachable")}M/=6}e.data[r++]=M*this.maxValue,e.data[r++]=P*this.maxValue,e.data[r++]=L,this.alpha&&(e.data[r++]=n[a+3])}return e}function hsl$1(){this.checkProcessable("hsl",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let e=Image.createFrom(this,{colorModel:HSL}),r=Math.floor(this.maxValue/2),n=0,a=this.data;for(let u=0;u<a.length;u+=this.channels){let f=a[u],_=a[u+1],o=a[u+2],b=Math.max(f,_,o),E=Math.min(f,_,o),M=0,P=0,L=(b+E)/2;if(b!==E){let D=b-E;switch(P=L>r?D/(2-b-E):D/(b+E),b){case f:M=(_-o)/D+(_<o?6:0);break;case _:M=(o-f)/D+2;break;case o:M=(f-_)/D+4;break;default:throw new Error("unreachable")}M/=6}e.data[n++]=M*this.maxValue,e.data[n++]=P*this.maxValue,e.data[n++]=L,this.alpha&&(e.data[n++]=a[u+3])}return e}function cmyk(){this.checkProcessable("cmyk",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let e=Image.createFrom(this,{components:4,colorModel:CMYK$1}),r=0,n=this.data;for(let a=0;a<n.length;a+=this.channels){let u=n[a],f=n[a+1],_=n[a+2],o=Math.min(this.maxValue-u,this.maxValue-f,this.maxValue-_),b=(this.maxValue-u-o)/(1-o/this.maxValue),E=(this.maxValue-f-o)/(1-o/this.maxValue),M=(this.maxValue-_-o)/(1-o/this.maxValue);e.data[r++]=Math.round(b),e.data[r++]=Math.round(E),e.data[r++]=Math.round(M),e.data[r++]=Math.round(o),this.alpha&&(e.data[r++]=n[a+3])}return e}function rgba8(){return new Image(this.width,this.height,this.getRGBAData(),{kind:"RGBA",parent:this})}const methods$1={luma709(e,r,n){return e*6966+r*23436+n*2366>>15},luma601(e,r,n){return e*9798+r*19235+n*3735>>15},maximum(e,r,n){return Math.max(e,r,n)},minimum(e,r,n){return Math.min(e,r,n)},average(e,r,n){return(e+r+n)/3>>0},minmax(e,r,n){return(Math.max(e,r,n)+Math.min(e,r,n))/2},red(e){return e},green(e,r){return r},blue(e,r,n){return n},cyan(e,r,n,a){let u=methods$1.black(e,r,n,a);return(a.maxValue-e-u)/(1-u/a.maxValue)>>0},magenta(e,r,n,a){let u=methods$1.black(e,r,n,a);return(a.maxValue-r-u)/(1-u/a.maxValue)>>0},yellow(e,r,n,a){let u=methods$1.black(e,r,n,a);return(a.maxValue-n-u)/(1-u/a.maxValue)>>0},black(e,r,n,a){return Math.min(a.maxValue-e,a.maxValue-r,a.maxValue-n)},hue(e,r,n,a){let u=methods$1.min(e,r,n),f=methods$1.max(e,r,n);if(f===u)return 0;let _=0,o=f-u;switch(f){case e:_=(r-n)/o+(r<n?6:0);break;case r:_=(n-e)/o+2;break;case n:_=(e-r)/o+4;break;default:throw new Error("unreachable")}return _/6*a.maxValue>>0},saturation(e,r,n,a){let u=methods$1.min(e,r,n),f=methods$1.max(e,r,n),_=f-u;return f===0?0:_/f*a.maxValue},lightness(e,r,n){let a=methods$1.min(e,r,n);return(methods$1.max(e,r,n)+a)/2}};Object.defineProperty(methods$1,"luminosity",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"luminance",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"min",{enumerable:!1,value:methods$1.minimum});Object.defineProperty(methods$1,"max",{enumerable:!1,value:methods$1.maximum});Object.defineProperty(methods$1,"brightness",{enumerable:!1,value:methods$1.maximum});Object.keys(methods$1).forEach(e=>{});function grey(e={}){let{algorithm:r="luma709",keepAlpha:n=!1,mergeAlpha:a=!0}=e;if(typeof r!="string"&&typeof r!="function")throw new TypeError("algorithm must be a string or a function");this.checkProcessable("grey",{bitDepth:[8,16],alpha:[0,1]}),this.components===1&&(r="red"),n&=this.alpha,a&=this.alpha,n&&(a=!1);let u=getOutputImage(this,e,{components:1,alpha:n,colorModel:GREY$1}),f;if(typeof r=="function")f=r;else if(f=methods$1[r.toLowerCase()],!f)throw new Error(`unsupported grey algorithm: ${r}`);let _=0;for(let o=0;o<this.data.length;o+=this.channels)a?u.data[_++]=clamp(f(this.data[o],this.data[o+1],this.data[o+2],this)*this.data[o+this.components]/this.maxValue,this):(u.data[_++]=clamp(f(this.data[o],this.data[o+1],this.data[o+2],this),this),u.alpha&&(u.data[_++]=this.data[o+this.components]));return u}function huang(e){let r=0;for(let M=0;M<e.length;M++)if(e[M]!==0){r=M;break}let n=e.length-1;for(let M=e.length-1;M>=r;M--)if(e[M]!==0){n=M;break}let a=1/(n-r),u=new Array(e.length),f=0,_=0;for(let M=r;M<e.length;M++)f+=M*e[M],_+=e[M],u[M]=f/_;let o=new Array(e.length);f=_=0;for(let M=n;M>0;M--)f+=M*e[M],_+=e[M],o[M-1]=f/_;let b=-1,E=Number.MAX_VALUE;for(let M=0;M<e.length;M++){let P=0,L;for(let D=0;D<=M;D++)L=1/(1+a*Math.abs(D-u[M])),L<1e-6||L>.999999||(P+=e[D]*(-L*Math.log(L)-(1-L)*Math.log(1-L)));for(let D=M+1;D<e.length;D++)L=1/(1+a*Math.abs(D-o[M])),L<1e-6||L>.999999||(P+=e[D]*(-L*Math.log(L)-(1-L)*Math.log(1-L)));P<E&&(E=P,b=M)}return b}function intermodes(e){let r=e.slice(),n=0;for(;!bimodalTest$1(r);){let u=0,f=0,_=r[0];for(let o=0;o<e.length-1;o++)u=f,f=_,_=r[o+1],r[o]=(u+f+_)/3;if(r[e.length-1]=(f+_)/3,n++,n>1e4)throw new Error("Intermodes Threshold not found after 10000 iterations")}let a=0;for(let u=1;u<e.length-1;u++)r[u-1]<r[u]&&r[u+1]<r[u]&&(a+=u);return Math.floor(a/2)}function bimodalTest$1(e){let r=!1,n=0;for(let a=1;a<e.length-1;a++)if(e[a-1]<e[a]&&e[a+1]<e[a]&&(n++,n>2))return!1;return n===2&&(r=!0),r}function isodata(e){let r,n,a,u,f=0;for(let _=1;_<e.length;_++)if(e[_]>0){f=_+1;break}for(;;){r=0,a=0;for(let _=0;_<f;_++)a=a+e[_],r=r+e[_]*_;u=0,n=0;for(let _=f+1;_<e.length;_++)n+=e[_],u+=e[_]*_;if(a>0&&n>0&&(r/=a,u/=n,f===Math.round((r+u)/2)))break;if(f++,f>e.length-2)throw new Error("Threshold not found")}return f}function li(e,r){let n,a,u,f,_,o,b,E,M,P,L,D;L=.5,P=0;for(let U=0;U<e.length;U++)P+=U*e[U];P/=r,b=P;do{o=b,n=o+.5|0,a=0,f=0;for(let U=0;U<=n;U++)a+=U*e[U],f+=e[U];E=f===0?0:a/f,u=0,_=0;for(let U=n+1;U<e.length;U++)u+=U*e[U],_+=e[U];M=_===0?0:u/_,D=(E-M)/(Math.log(E)-Math.log(M)),D<-Number.EPSILON?b=D-.5|0:b=D+.5|0}while(Math.abs(b-o)>L);return n}function maxEntropy(e,r){let n=new Array(e.length);for(let L=0;L<e.length;L++)n[L]=e[L]/r;let a=new Array(e.length),u=new Array(e.length);a[0]=n[0],u[0]=1-a[0];for(let L=1;L<e.length;L++)a[L]=a[L-1]+n[L],u[L]=1-a[L];let f=0;for(let L=0;L<e.length;L++)if(Math.abs(a[L])>=Number.EPSILON){f=L;break}let _=e.length-1;for(let L=e.length-1;L>=f;L--)if(Math.abs(u[L])>=Number.EPSILON){_=L;break}let o=-1,b,E=Number.MIN_VALUE,M,P;for(let L=f;L<=_;L++){M=0;for(let D=0;D<=L;D++)e[D]!==0&&(M-=n[D]/a[L]*Math.log(n[D]/a[L]));P=0;for(let D=L+1;D<e.length;D++)e[D]!==0&&(P-=n[D]/u[L]*Math.log(n[D]/u[L]));b=M+P,E<b&&(E=b,o=L)}return o}function mean$1(e,r){let n=0;for(let a=0;a<e.length;a++)n+=a*e[a];return Math.floor(n/r)}function minError(e,r){let n,a=-2,u,f,_,o,b,E,M,P,L,D,U,X=0;for(let K=0;K<e.length;K++)X+=K*e[K];for(X/=r,n=X;n!==a;){let K=sumA(e,n),q=sumA(e,e.length-1),oe=sumB(e,n),W=sumB(e,e.length-1),Y=sumC(e,n),J=sumC(e,e.length-1);if(u=oe/K,f=(W-oe)/(q-K),_=K/q,o=(q-K)/q,b=Y/K-u*u,E=(J-Y)/(q-K)-f*f,M=1/b-1/E,P=u/b-f/E,L=u*u/b-f*f/E+Math.log10(b*(o*o)/(E*(_*_))),D=P*P-M*L,D<0)return n;a=n,U=(P+Math.sqrt(D))/M,isNaN(U)?n=a:n=Math.floor(U)}return n}function sumA(e,r){let n=0;for(let a=0;a<=r;a++)n+=e[a];return n}function sumB(e,r){let n=0;for(let a=0;a<=r;a++)n+=a*e[a];return n}function sumC(e,r){let n=0;for(let a=0;a<=r;a++)n+=a*a*e[a];return n}function minimum(e){if(e.length<2)return 0;let r=0,n=-1,a=-1,u=new Array(e.length);for(let f=0;f<e.length;f++)u[f]=e[f],e[f]>0&&(a=f);for(;!bimodalTest(u);)if(u=smoothed(u),r++,r>1e4)return n;return n=minimumBetweenPeeks(u,a),n}function smoothed(e){let r=new Array(e.length);for(let n=1;n<e.length-1;n++)r[n]=(e[n-1]+e[n]+e[n+1])/3;return r[0]=(e[0]+e[1])/3,r[e.length-1]=(e[e.length-2]+e[e.length-1])/3,r}function minimumBetweenPeeks(e,r){let n;for(let a=1;a<r;a++)if(e[a-1]>e[a]&&e[a+1]>=e[a]){n=a;break}return n}function bimodalTest(e){let r=e.length,n=!1,a=0;for(let u=1;u<r-1;u++)if(e[u-1]<e[u]&&e[u+1]<e[u]&&(a++,a>2))return!1;return a===2&&(n=!0),n}function moments(e,r){let n=1,a=0,u=0,f=0,_=0,o,b,E,M,P,L,D=-1,U=e.length,X=new Array(U);for(let K=0;K<U;K++)X[K]=e[K]/r;for(let K=0;K<U;K++)a+=K*X[K],u+=K*K*X[K],f+=K*K*K*X[K];b=n*u-a*a,E=(-u*u+a*f)/b,M=(n*-f+u*a)/b,P=.5*(-M-Math.sqrt(M*M-4*E)),L=.5*(-M+Math.sqrt(M*M-4*E)),o=(L-a)/(L-P);for(let K=0;K<U;K++)if(_+=X[K],_>o){D=K;break}return D}function otsu(e,r){let n=0,a=0,u=0,f=0,_=0;for(let o=0;o<e.length;o++)_+=o*e[o];for(let o=0;o<e.length;o++){a=a+e[o];const b=r-a;if(a===0||b===0)continue;n=n+o*e[o];const E=(_-n)/b,M=a*b*(n/a-E)*(n/a-E);M>=u&&(f=o,u=M)}return f}function percentile(e){let r=-1,n=.5,a=new Array(e.length),u=partialSum(e,e.length-1),f=1;for(let _=0;_<e.length;_++)a[_]=Math.abs(partialSum(e,_)/u-n),a[_]<f&&(f=a[_],r=_);return r}function partialSum(e,r){let n=0;for(let a=0;a<=r;a++)n+=e[a];return n}function renyiEntropy(e,r){let n,a,u,f=new Array(e.length),_=new Array(e.length),o=new Array(e.length),b=0,E=0,M=0,P=0,L=0,D=0,X=1/(1-.5),q=1/(1-2);for(let J=0;J<e.length;J++)f[J]=e[J]/r;_[0]=f[0],o[0]=1-_[0];for(let J=1;J<e.length;J++)_[J]=_[J-1]+f[J],o[J]=1-_[J];a=0;for(let J=0;J<e.length;J++)if(Math.abs(_[J])>=Number.EPSILON){a=J;break}u=e.length-1;for(let J=e.length-1;J>=a;J--)if(Math.abs(o[J])>=Number.EPSILON){u=J;break}for(let J=a;J<=u;J++){let Ee=0,xe=0,se=0;for(let We=0;We<=J;We++)e[We]!==0&&(Ee-=f[We]/_[J]*Math.log(f[We]/_[J])),xe+=Math.sqrt(f[We]/_[J]),se+=f[We]*f[We]/(_[J]*_[J]);let ce=0,ee=0,he=0;for(let We=J+1;We<e.length;We++)e[We]!==0&&(ce-=f[We]/o[J]*Math.log(f[We]/o[J])),ee+=Math.sqrt(f[We]/o[J]),he+=f[We]*f[We]/(o[J]*o[J]);let Ie=Ee+ce,Pe=X*(xe*ee>0?Math.log(xe*ee):0),Qe=q*(se*he>0?Math.log(se*he):0);Ie>P&&(P=Ie,b=J),Pe>L&&(L=Pe,E=J),Qe>D&&(D=Qe,M=J)}let oe=[b,E,M];oe.sort((J,Ee)=>J-Ee);let W;Math.abs(oe[0]-oe[1])<=5?Math.abs(oe[1]-oe[2])<=5?W=[1,2,1]:W=[0,1,3]:Math.abs(oe[1]-oe[2])<=5?W=[3,1,0]:W=[1,2,1];let Y=_[oe[2]]-_[oe[0]];return n=Math.round(oe[0]*(_[oe[0]]+.25*Y*W[0])+.25*oe[1]*Y*W[1]+oe[2]*(o[oe[2]]+.25*Y*W[2])),n}function shanbhag(e,r){let n=new Array(e.length);for(let D=0;D<e.length;D++)n[D]=e[D]/r;let a=new Array(e.length),u=new Array(e.length);a[0]=n[0],u[0]=1-a[0];for(let D=1;D<e.length;D++)a[D]=a[D-1]+n[D],u[D]=1-a[D];let f=0;for(let D=0;D<e.length;D++)if(Math.abs(a[D])>=Number.EPSILON){f=D;break}let _=e.length-1;for(let D=e.length-1;D>=f;D--)if(Math.abs(u[D])>=Number.EPSILON){_=D;break}let o=-1,b=Number.MAX_VALUE,E,M,P,L;for(let D=f;D<=_;D++){P=0,E=.5/a[D];for(let U=1;U<=D;U++)P-=n[U]*Math.log(1-E*a[U-1]);P*=E,L=0,E=.5/u[D];for(let U=D+1;U<e.length;U++)L-=n[U]*Math.log(1-E*u[U]);L*=E,M=Math.abs(P-L),M<b&&(b=M,o=D)}return o}function triangle$1(e){let r=0,n=0,a=0,u=0;for(let P=0;P<e.length;P++)if(e[P]>0){r=P;break}r>0&&r--;for(let P=e.length-1;P>0;P--)if(e[P]>0){u=P;break}u<e.length-1&&u++;for(let P=0;P<e.length;P++)e[P]>n&&(a=P,n=e[P]);let f=!1;if(a-r<u-a){f=!0;let P=0,L=e.length-1;for(;P<L;){let D=e[P];e[P]=e[L],e[L]=D,P++,L--}r=e.length-1-u,a=e.length-1-a}if(r===a)return r;let _,o,b;_=e[a],o=r-a,b=Math.sqrt(_*_+o*o),_/=b,o/=b,b=_*r+o*e[r];let E=r,M=0;for(let P=r+1;P<=a;P++){let L=_*P+o*e[P]-b;L>M&&(E=P,M=L)}if(E--,f){let P=0,L=e.length-1;for(;P<L;){let D=e[P];e[P]=e[L],e[L]=D,P++,L--}return e.length-1-E}else return E}function yen(e,r){let n=new Array(e.length);for(let E=0;E<e.length;E++)n[E]=e[E]/r;let a=new Array(e.length);a[0]=n[0];for(let E=1;E<e.length;E++)a[E]=a[E-1]+n[E];let u=new Array(e.length);u[0]=n[0]*n[0];for(let E=1;E<e.length;E++)u[E]=u[E-1]+n[E]*n[E];let f=new Array(e.length);f[e.length-1]=0;for(let E=e.length-2;E>=0;E--)f[E]=f[E+1]+n[E+1]*n[E+1];let _=-1,o=Number.MIN_VALUE,b;for(let E=0;E<e.length;E++)b=-1*(u[E]*f[E]>0?Math.log(u[E]*f[E]):0)+2*(a[E]*(1-a[E])>0?Math.log(a[E]*(1-a[E])):0),b>o&&(o=b,_=E);return _}const methods={huang,intermodes,isodata,li,maxentropy:maxEntropy,mean:mean$1,minerror:minError,minimum,moments,otsu,percentile,renyientropy:renyiEntropy,shanbhag,triangle:triangle$1,yen},names={};Object.keys(methods).forEach(e=>{names[e]=e});function getThreshold(e={}){let{algorithm:r=names.otsu}=e;this.checkProcessable("getThreshold",{components:1,bitDepth:[8,16]});let n=methods[r.toLowerCase()];if(n){let a=this.getHistogram();return n(a,this.size)}else throw new Error(`unknown thresholding algorithm: ${r}`)}const THRESHOLD="threshold";function mask(e={}){let{algorithm:r=THRESHOLD,threshold:n=.5,useAlpha:a=!0,invert:u=!1}=e;this.checkProcessable("mask",{components:1,bitDepth:[8,16]}),r===THRESHOLD?n=getThreshold$1(n,this.maxValue):n=getThreshold.call(this,e);let f=new Image(this.width,this.height,{kind:"BINARY",parent:this}),_=0;if(this.alpha&&a)for(let o=0;o<this.data.length;o+=this.channels){let b=this.data[o]+(this.maxValue-this.data[o])*(this.maxValue-this.data[o+1])/this.maxValue;(u&&b<=n||!u&&b>=n)&&f.setBit(_),_++}else for(let o=0;o<this.data.length;o+=this.channels)(u&&this.data[o]<=n||!u&&this.data[o]>=n)&&f.setBit(_),_++;return f}function copyImage(e,r,n,a){let u=e.width,f=e.height,_=r.width,o=e.channels;for(let b=0;b<u;b++)for(let E=0;E<f;E++)for(let M=0;M<o;M++){let P=(E*u+b)*o+M,L=((a+E)*_+n+b)*o+M;r.data[L]=e.data[P]}}function pad(e={}){let{size:r=0,algorithm:n="copy",color:a}=e;if(this.checkProcessable("pad",{bitDepth:[8,16]}),n==="set"){if(a.length!==this.channels)throw new Error(`pad: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let b=0;b<a.length;b++)a[b]===0&&(a[b]=.001)}else a=newArray_1(this.channels,null);Array.isArray(r)||(r=[r,r]);let u=this.width+r[0]*2,f=this.height+r[1]*2,_=this.channels,o=Image.createFrom(this,{width:u,height:f});copyImage(this,o,r[0],r[1]);for(let b=r[0];b<u-r[0];b++)for(let E=0;E<_;E++){let M=a[E]||o.data[(r[1]*u+b)*_+E];for(let P=0;P<r[1];P++)o.data[(P*u+b)*_+E]=M;M=a[E]||o.data[((f-r[1]-1)*u+b)*_+E];for(let P=f-r[1];P<f;P++)o.data[(P*u+b)*_+E]=M}for(let b=0;b<f;b++)for(let E=0;E<_;E++){let M=a[E]||o.data[(b*u+r[0])*_+E];for(let P=0;P<r[0];P++)o.data[(b*u+P)*_+E]=M;M=a[E]||o.data[(b*u+u-r[0]-1)*_+E];for(let P=u-r[0];P<u;P++)o.data[(b*u+P)*_+E]=M}return o}function colorDepth(e=8){if(this.checkProcessable("colorDepth",{bitDepth:[1,8,16]}),![8,16].includes(e))throw Error("You need to specify the new colorDepth as 8 or 16");if(this.bitDepth===e)return this.clone();let r=Image.createFrom(this,{bitDepth:e});switch(e){case 8:if(this.bitDepth===1)for(let n=0;n<this.size;n++)this.getBit(n)&&(r.data[n]=255);else for(let n=0;n<this.data.length;n++)r.data[n]=this.data[n]>>8;break;case 16:if(this.bitDepth===1)for(let n=0;n<this.size;n++)this.getBit(n)&&(r.data[n]=65535);else for(let n=0;n<this.data.length;n++)r.data[n]=this.data[n]<<8|this.data[n];break;default:throw new Error("colorDepth conversion unexpected case")}return r}function rotateFree(e,r={}){const{interpolation:n=validInterpolations.nearestneighbor,width:a=this.width,height:u=this.height}=r;if(typeof e!="number")throw new TypeError("degrees must be a number");const f=checkInterpolation(n),_=e*Math.PI/180,o=Math.floor(Math.abs(a*Math.cos(_))+Math.abs(u*Math.sin(_))),b=Math.floor(Math.abs(u*Math.cos(_))+Math.abs(a*Math.sin(_))),E=Math.cos(-_),M=Math.sin(-_);let P=o/2,L=b/2;o%2===0?(P=P-.5,b%2===0?L=L-.5:L=Math.floor(L)):(P=Math.floor(P),b%2===0?L=L-.5:L=Math.floor(L));const D=Math.floor(a/2-P),U=Math.floor(u/2-L);if(this.bitDepth===1){const X=new Image(o,b,{kind:"BINARY",parent:this});switch(f){case validInterpolations.nearestneighbor:return rotateBinaryNearestNeighbor(this,X,D,U,P,L,E,M);case validInterpolations.bilinear:return rotateBinaryBilinear(this,X,D,U,P,L,E,M);default:throw new Error(`unsupported rotate interpolation: ${f}`)}}else{const X=Image.createFrom(this,{width:o,height:b});switch(f){case validInterpolations.nearestneighbor:return rotateNearestNeighbor(this,X,D,U,P,L,E,M);case validInterpolations.bilinear:return rotateBilinear(this,X,D,U,P,L,E,M);default:throw new Error(`unsupported rotate interpolation: ${f}`)}}}function rotateNearestNeighbor(e,r,n,a,u,f,_,o){for(let b=0;b<r.width;b+=1)for(let E=0;E<r.height;E+=1)for(let M=0;M<e.channels;M++){let P=Math.round((b-u)*_-(E-f)*o+u)+n,L=Math.round((E-f)*_+(b-u)*o+f)+a;P<0||P>=e.width||L<0||L>=e.height?e.alpha===1&&M===e.channels-1?r.setValueXY(b,E,M,0):r.setValueXY(b,E,M,e.maxValue):r.setValueXY(b,E,M,e.getValueXY(P,L,M))}return r}function rotateBinaryNearestNeighbor(e,r,n,a,u,f,_,o){for(let b=0;b<r.width;b+=1)for(let E=0;E<r.height;E+=1){let M=Math.round((b-u)*_-(E-f)*o+u)+n,P=Math.round((E-f)*_+(b-u)*o+f)+a;(M<0||M>=e.width||P<0||P>=e.height||e.getBitXY(M,P))&&r.setBitXY(b,E)}return r}function rotateBilinear(e,r,n,a,u,f,_,o){let b=e.width*e.channels;for(let E=0;E<r.height;E++)for(let M=0;M<r.width;M++){let P=(M-u)*_-(E-f)*o+u+n,L=(E-f)*_+(M-u)*o+f+a,D=P|0,U=L|0,X=P-D,K=L-U;for(let q=0;q<e.channels;q++)if(P<0||P>=e.width||L<0||L>=e.height)e.alpha===1&&q===e.channels-1?r.setValueXY(M,E,q,0):r.setValueXY(M,E,q,e.maxValue);else{let oe=(U*e.width+D)*e.channels+q,W=e.data[oe],Y=e.data[oe+e.channels],J=e.data[oe+b],Ee=e.data[oe+b+e.channels],xe=W+X*(Y-W)+K*(J-W)+X*K*(W-Y-J+Ee)|0;r.setValueXY(M,E,q,xe)}}return r}function rotateBinaryBilinear(e,r,n,a,u,f,_,o){let b=e.width;for(let E=0;E<r.height;E++)for(let M=0;M<r.width;M++){let P=(M-u)*_-(E-f)*o+u+n,L=(E-f)*_+(M-u)*o+f+a,D=P|0,U=L|0,X=P-D,K=L-U;if(P<0||P>=e.width||L<0||L>=e.height)r.setBitXY(M,E);else{let q=U*e.width+D,oe=e.getBit(q),W=e.getBit(q+1),Y=e.getBit(q+b),J=e.getBit(q+1+b);(oe|X&W-oe|K&Y-oe|X&K&oe-W-Y+J)>0&&r.setBitXY(M,E)}}return r}function rotate$1(e,r){if(this.checkProcessable("rotate",{bitDepth:[1,8,16]}),typeof e!="number")throw new TypeError("angle must be a number");switch(e<0&&(e=Math.ceil(-e/360)*360+e),e%360){case 0:return this.clone();case 90:return rotateRight.call(this);case 180:return rotate180.call(this);case 270:return rotateLeft.call(this);default:return rotateFree.call(this,e,r)}}function rotateLeft(){if(this.bitDepth===1){const e=new Image(this.height,this.width,{kind:"BINARY",parent:this}),r=e.height-1;for(let n=0;n<this.height;n++)for(let a=0;a<this.width;a++)this.getBitXY(a,n)&&e.setBitXY(n,r-a);return e}else{const e=Image.createFrom(this,{width:this.height,height:this.width}),r=e.height-1;for(let n=0;n<this.height;n++)for(let a=0;a<this.width;a++)for(let u=0;u<this.channels;u++)e.setValueXY(n,r-a,u,this.getValueXY(a,n,u));return e}}function rotateRight(){if(this.bitDepth===1){const e=new Image(this.height,this.width,{kind:"BINARY",parent:this}),r=e.width-1;for(let n=0;n<this.height;n++)for(let a=0;a<this.width;a++)this.getBitXY(a,n)&&e.setBitXY(r-n,a);return e}else{const e=Image.createFrom(this,{width:this.height,height:this.width}),r=e.width-1;for(let n=0;n<this.height;n++)for(let a=0;a<this.width;a++)for(let u=0;u<this.channels;u++)e.setValueXY(r-n,a,u,this.getValueXY(a,n,u));return e}}function rotate180(){if(this.bitDepth===1){const e=new Image(this.width,this.height,{kind:"BINARY",parent:this}),r=e.width-1,n=e.height-1;for(let a=0;a<this.height;a++)for(let u=0;u<this.width;u++)this.getBitXY(u,a)&&e.setBitXY(r-u,n-a);return e}else{const e=Image.createFrom(this),r=e.width-1,n=e.height-1;for(let a=0;a<this.height;a++)for(let u=0;u<this.width;u++)for(let f=0;f<this.channels;f++)e.setValueXY(r-u,n-a,f,this.getValueXY(u,a,f));return e}}function insert(e,r={}){const n=getImageParameters(e);this.checkProcessable("insert",n);let{x:a=0,y:u=0}=r;const f=getOutputImageOrInPlace(this,r,{copy:!0}),_=Math.min(f.height,u+e.height),o=Math.min(f.width,a+e.width);if(f.bitDepth===1)for(let b=u;b<_;b++)for(let E=a;E<o;E++)e.getBitXY(E-a,b-u)?f.setBitXY(E,b):f.clearBitXY(E,b);else for(let b=u;b<_;b++)for(let E=a;E<o;E++)f.setPixelXY(E,b,e.getPixelXY(E-a,b-u));return f}function setBorder(e={}){let{size:r=0,algorithm:n="copy",color:a}=e;if(this.checkProcessable("setBorder",{bitDepth:[8,16,32,64]}),n==="set"){if(a.length!==this.channels)throw new Error(`setBorder: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let o=0;o<a.length;o++)a[o]===0&&(a[o]=.001)}else a=newArray_1(this.channels,null);Array.isArray(r)||(r=[r,r]);let u=r[0],f=r[1],_=this.channels;for(let o=u;o<this.width-u;o++)for(let b=0;b<_;b++){let E=a[b]||this.data[(o+this.width*f)*_+b];for(let M=0;M<f;M++)this.data[(M*this.width+o)*_+b]=E;E=a[b]||this.data[(o+this.width*(this.height-f-1))*_+b];for(let M=this.height-f;M<this.height;M++)this.data[(M*this.width+o)*_+b]=E}for(let o=0;o<this.height;o++)for(let b=0;b<_;b++){let E=a[b]||this.data[(o*this.width+u)*_+b];for(let M=0;M<u;M++)this.data[(o*this.width+M)*_+b]=E;E=a[b]||this.data[(o*this.width+this.width-u-1)*_+b];for(let M=this.width-u;M<this.width;M++)this.data[(o*this.width+M)*_+b]=E}return this}function split(e={}){let{preserveAlpha:r=!0}=e;if(this.checkProcessable("split",{bitDepth:[8,16]}),this.components===1)return new Stack([this.clone()]);let n=new Stack,a=this.data;if(this.alpha&&r)for(let u=0;u<this.components;u++){let f=Image.createFrom(this,{components:1,alpha:!0,colorModel:GREY$1}),_=0;for(let o=0;o<a.length;o+=this.channels)f.data[_++]=a[o+u],f.data[_++]=a[o+this.components];n.push(f)}else for(let u=0;u<this.channels;u++){let f=Image.createFrom(this,{components:1,alpha:!1,colorModel:GREY$1}),_=0;for(let o=0;o<a.length;o+=this.channels)f.data[_++]=a[o+u];n.push(f)}return n}function getChannel(e,r={}){let{keepAlpha:n=!1,mergeAlpha:a=!1}=r;n&=this.alpha,a&=this.alpha,this.checkProcessable("getChannel",{bitDepth:[8,16]}),e=validateChannel(this,e);let u=Image.createFrom(this,{components:1,alpha:n,colorModel:GREY$1}),f=0;for(let _=0;_<this.data.length;_+=this.channels)a?u.data[f++]=this.data[_+e]*this.data[_+this.components]/this.maxValue:(u.data[f++]=this.data[_+e],n&&(u.data[f++]=this.data[_+this.components]));return u}function combineChannels(e=defaultCombineMethod,r={}){let{mergeAlpha:n=!1,keepAlpha:a=!1}=r;n&=this.alpha,a&=this.alpha,this.checkProcessable("combineChannels",{bitDepth:[8,16]});let u=Image.createFrom(this,{components:1,alpha:a,colorModel:GREY$1}),f=0;for(let _=0;_<this.size;_++){let o=e(this.getPixel(_));n?u.data[f++]=o*this.data[_*this.channels+this.components]/this.maxValue:(u.data[f++]=o,a&&(u.data[f++]=this.data[_*this.channels+this.components]))}return u}function defaultCombineMethod(e){return(e[0]+e[1]+e[2])/3}function setChannel(e,r){if(this.checkProcessable("setChannel",{bitDepth:[8,16]}),r.checkProcessable("setChannel (image parameter check)",{bitDepth:[this.bitDepth],alpha:[0],components:[1]}),r.width!==this.width||r.height!==this.height)throw new Error("Images must have exactly the same width and height");e=validateChannel(this,e);let n=e;for(let a=0;a<r.data.length;a++)this.data[n]=r.data[a],n+=this.channels;return this}function getSimilarity(e,r={}){let{shift:n=[0,0],average:a,channels:u,defaultAlpha:f,normalize:_,border:o=[0,0]}=r;if(this.checkProcessable("getSimilarity",{bitDepth:[8,16]}),Array.isArray(o)||(o=[o,o]),u=validateArrayOfChannels(this,{channels:u,defaultAlpha:f}),this.bitDepth!==e.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==e.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==e.colorModel)throw new Error("Both images must have the same colorModel");typeof a>"u"&&(a=!0);let b=Math.max(o[0],-n[0]),E=Math.min(this.width-o[0],this.width-n[0]),M=Math.max(o[1],-n[1]),P=Math.min(this.height-o[1],this.height-n[1]),L=newArray_1(u.length,0);for(let D=0;D<u.length;D++){let U=u[D],X=_?this.sum[U]:Math.max(this.sum[U],e.sum[U]),K=_?e.sum[U]:Math.max(this.sum[U],e.sum[U]);if(X!==0&&K!==0)for(let q=b;q<E;q++)for(let oe=M;oe<P;oe++){let W=q*this.multiplierX+oe*this.multiplierY+U,Y=W+n[0]*this.multiplierX+n[1]*this.multiplierY;L[D]+=Math.min(this.data[W]/X,e.data[Y]/K)}}return a?L.reduce((D,U)=>D+U)/L.length:L}function getPixelsGrid(e={}){let{sampling:r=[10,10],painted:n=!1,mask:a}=e;this.checkProcessable("getPixelsGrid",{bitDepth:[8,16],channels:1}),Array.isArray(r)||(r=[r,r]);const u=r[0],f=r[1],_=[],o=[],b=this.width/u,E=this.height/f;let M=Math.floor(b/2);for(let L=0;L<u;L++){let D=Math.floor(E/2);for(let U=0;U<f;U++){let X=Math.round(M),K=Math.round(D);(!a||a.getBitXY(X,K))&&(_.push([X,K]),o.push(this.getPixelXY(X,K))),D+=E}M+=b}const P={xyS:_,zS:o};return n&&(P.painted=this.rgba8().paintPoints(_)),P}function Matrix(e,r,n){const a=new Array(e);for(let u=0;u<e;u++)a[u]=new Array(r);if(n)for(let u=0;u<e;u++)for(let f=0;f<r;f++)a[u][f]=n;return a.width=e,a.height=r,Object.setPrototypeOf(a,Matrix.prototype),a}Matrix.prototype.localMin=function(e,r){let n=this[e][r],a=[e,r];for(let u=Math.max(0,e-1);u<Math.min(this.length,e+2);u++)for(let f=Math.max(0,r-1);f<Math.min(this[0].length,r+2);f++)this[u][f]<n&&(n=this[u][f],a=[u,f]);return{position:a,value:n}};Matrix.prototype.localMax=function(e,r){let n=this[e][r],a=[e,r];for(let u=Math.max(0,e-1);u<Math.min(this.length,e+2);u++)for(let f=Math.max(0,r-1);f<Math.min(this[0].length,r+2);f++)this[u][f]>n&&(n=this[u][f],a=[u,f]);return{position:a,value:n}};Matrix.prototype.localSearch=function(e,r,n){let a=[];for(let u=Math.max(0,e-1);u<Math.min(this.length,e+2);u++)for(let f=Math.max(0,r-1);f<Math.min(this[0].length,r+2);f++)this[u][f]===n&&a.push([u,f]);return a};function getBestMatch(e,r={}){let{border:n}=r;if(this.checkProcessable("getChannel",{bitDepth:[8,16]}),this.bitDepth!==e.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==e.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==e.colorModel)throw new Error("Both images must have the same colorModel");let a=new Matrix(e.width,e.height,-1/0),u=Math.floor(e.width/2),f=Math.floor(e.height/2),_=u,o=f,b=!1;for(;!b;){let E=a.localSearch(u,f,-1/0);for(let P=0;P<E.length;P++){let L=E[P],D=this.getSimilarity(e,{border:n,shift:[_-L[0],o-L[1]]});a[L[0]][L[1]]=D}let M=a.localMax(u,f);M.position[0]!==u||M.position[1]!==f?(u=M.position[0],f=M.position[1]):b=!0}return[u-_,f-o]}function getRow(e,r=0){this.checkProcessable("getRow",{bitDepth:[8,16]}),checkRow(this,e),checkChannel(this,r);let n=new Array(this.width),a=0,u=e*this.width*this.channels+r,f=u+this.width*this.channels;for(let _=u;_<f;_+=this.channels)n[a++]=this.data[_];return n}function getColumn(e,r=0){this.checkProcessable("getColumn",{bitDepth:[8,16]}),checkColumn(this,e),checkChannel(this,r);let n=new Array(this.height),a=0,u=this.width*this.channels;for(let f=r+e*this.channels;f<this.data.length;f+=u)n[a++]=this.data[f];return n}function getMatrix(e={}){let{channel:r}=e;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),r===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");r=0}let n=new Matrix$2(this.height,this.width);for(let a=0;a<this.height;a++)for(let u=0;u<this.width;u++)n.set(a,u,this.getValueXY(u,a,r));return n}function setMatrix(e,r={}){e=new Matrix$2(e);let{channel:n}=r;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),n===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");n=0}if(this.width!==e.columns||this.height!==e.rows)throw new RangeError("The size of the matrix must be equal to the size of the image");for(let a=0;a<this.height;a++)for(let u=0;u<this.width;u++)this.setValueXY(u,a,n,e.get(a,u))}function getPixelsArray(){this.checkProcessable("getPixelsArray",{bitDepth:[8,16,32]});let e=new Array(this.size),r=0;for(let n=0;n<this.data.length;n+=this.channels){let a=new Array(this.components);for(let u=0;u<this.components;u++)a[u]=this.data[n+u];e[r++]=a}return e}function getIntersection(e){let r=this,n=r.getClosestCommonParent(e),a=r.getRelativePosition(n,{defaultFurther:!0}),u=getRelativePositionForAllPixels(r,a),f=e.getRelativePosition(n,{defaultFurther:!0}),_=getRelativePositionForAllPixels(e,f),o=getCommonSurface(u,_),b={whitePixelsMask1:[],whitePixelsMask2:[],commonWhitePixels:[]};for(let E=0;E<o.length;E++){let M=o[E],P=[M[0]-a[0],M[1]-a[1]],L=[M[0]-f[0],M[1]-f[1]],D=r.getBitXY(P[0],P[1]),U=e.getBitXY(L[0],L[1]);D===1&&U===1&&b.commonWhitePixels.push(M)}for(let E=0;E<u.length;E++){let M,P;E!==0&&(M=Math.floor(E/r.width),P=E%r.width),r.getBitXY(M,P)===1&&b.whitePixelsMask1.push(u[E])}for(let E=0;E<_.length;E++){let M=0,P=0;E!==0&&(M=Math.floor(E/e.width),P=E%e.width),e.getBitXY(M,P)===1&&b.whitePixelsMask2.push(_[E])}return b}function getRelativePositionForAllPixels(e,r){let n=[];for(let a=0;a<e.height;a++)for(let u=0;u<e.width;u++){let f=[a,u];n.push([f[0]+r[0],f[1]+r[1]])}return n}function getCommonSurface(e,r){let n=0,a=0,u=[];for(;n<e.length&&a<r.length;)e[n][0]===r[a][0]&&e[n][1]===r[a][1]?(u.push(e[n]),n++,a++):e[n][0]<r[a][0]||e[n][0]===r[a][0]&&e[n][1]<r[a][1]?n++:a++;return u}function getClosestCommonParent(e){let r=getDepth$1(this),n=getDepth$1(e),a;if(r>=n?a=getFurthestParent(this,r):a=getFurthestParent(e,n),r===0||n===0)return a;let u=this,f=e;for(;r!==n;)if(r>n){if(u=u.parent,u===null)return a;r=r-1}else{if(f=f.parent,f===null)return a;n=n-1}for(;u!==f&&u!==null&&f!==null;)if(u=u.parent,f=f.parent,u===null||f===null)return a;return u!==f?a:u}function getDepth$1(e){let r=0,n=e;for(;n.parent!=null;)n=n.parent,r++;return r}function getFurthestParent(e,r){let n=e;for(;r>0;)n=n.parent,r=r-1;return n}const defaultOptions$1={lowThreshold:10,highThreshold:30,gaussianBlur:1.1},Gx=[[-1,0,1],[-2,0,2],[-1,0,1]],Gy=[[-1,-2,-1],[0,0,0],[1,2,1]],convOptions={bitDepth:32,mode:"periodic"};function cannyEdgeDetector(e,r){e.checkProcessable("Canny edge detector",{bitDepth:8,channels:1,components:1}),r=Object.assign({},defaultOptions$1,r);const n=e.width,a=e.height,u=e.maxValue,f={sigma:r.gaussianBlur,radius:3},_=e.gaussianFilter(f),o=_.convolution(Gy,convOptions),b=_.convolution(Gx,convOptions),E=b.hypotenuse(o),M=e.constructor,P=new M(n,a,{kind:"GREY",bitDepth:32}),L=new M(n,a,{kind:"GREY",bitDepth:32}),D=new M(n,a,{kind:"GREY"});for(var U=1;U<n-1;U++)for(var X=1;X<a-1;X++){var K=(Math.round(Math.atan2(b.getValueXY(U,X,0),o.getValueXY(U,X,0))*(5/Math.PI))+5)%5;K===0&&(E.getValueXY(U,X,0)<=E.getValueXY(U,X-1,0)||E.getValueXY(U,X,0)<=E.getValueXY(U,X+1,0))||K===1&&(E.getValueXY(U,X,0)<=E.getValueXY(U-1,X+1,0)||E.getValueXY(U,X,0)<=E.getValueXY(U+1,X-1,0))||K===2&&(E.getValueXY(U,X,0)<=E.getValueXY(U-1,X,0)||E.getValueXY(U,X,0)<=E.getValueXY(U+1,X,0))||K===3&&(E.getValueXY(U,X,0)<=E.getValueXY(U-1,X-1,0)||E.getValueXY(U,X,0)<=E.getValueXY(U+1,X+1,0))||P.setValueXY(U,X,0,E.getValueXY(U,X,0))}for(U=0;U<n*a;++U){var q=P.data[U],oe=0;q>r.highThreshold&&(oe++,D.data[U]=u),q>r.lowThreshold&&oe++,L.data[U]=oe}var W=[];for(U=1;U<n-1;++U)for(X=1;X<a-1;++X){if(L.getValueXY(U,X,0)!==1)continue;e:for(var Y=U-1;Y<U+2;++Y)for(var J=X-1;J<X+2;++J)if(L.getValueXY(Y,J,0)===2){W.push([U,X]),D.setValueXY(U,X,0,u);break e}}for(;W.length>0;){var Ee=[];for(U=0;U<W.length;++U)for(X=-1;X<2;++X)for(Y=-1;Y<2;++Y)if(!(X===0&&Y===0)){var xe=W[U][0]+X,se=W[U][1]+Y;L.getValueXY(xe,se,0)===1&&D.getValueXY(xe,se,0)===0&&(Ee.push([xe,se]),D.setValueXY(xe,se,0,u))}W=Ee}return D}function cannyEdge(e){return cannyEdgeDetector(this,e)}function extract(e,r={}){let{position:n}=r;if(this.checkProcessable("extract",{bitDepth:[1,8,16]}),!n&&(n=e.getRelativePosition(this),!n))throw new Error("extract : can not extract an image because the relative position can not be determined, try to specify manually the position as an array of 2 elements [x,y].");if(this.bitDepth>1){let a=Image.createFrom(this,{width:e.width,height:e.height,alpha:1,position:n,parent:this});for(let u=0;u<e.width;u++)for(let f=0;f<e.height;f++){for(let _=0;_<this.channels;_++){let o=this.getValueXY(u+n[0],f+n[1],_);a.setValueXY(u,f,_,o)}e.getBitXY(u,f)||a.setValueXY(u,f,this.components,0)}return a}else{let a=Image.createFrom(this,{width:e.width,height:e.height,position:n,parent:this});for(let u=0;u<e.height;u++)for(let f=0;f<e.width;f++)e.getBitXY(f,u)&&this.getBitXY(f+n[0],u+n[1])&&a.setBitXY(f,u);return a}}var fastList={exports:{}};(function(e,r){(function(){function n(u,f,_){this.next=_,_&&(_.prev=this),this.prev=f,f&&(f.next=this),this.data=u}function a(){if(!(this instanceof a))return new a;this._head=null,this._tail=null,this.length=0}a.prototype={push:function(u){this._tail=new n(u,this._tail,null),this._head||(this._head=this._tail),this.length++},pop:function(){if(this.length!==0){var u=this._tail;return this._tail=u.prev,u.prev&&(u.prev=this._tail.next=null),this.length--,this.length===1?this._head=this._tail:this.length===0&&(this._head=this._tail=null),u.data}},unshift:function(u){this._head=new n(u,null,this._head),this._tail||(this._tail=this._head),this.length++},shift:function(){if(this.length!==0){var u=this._head;return this._head=u.next,u.next&&(u.next=this._head.prev=null),this.length--,this.length===1?this._tail=this._head:this.length===0&&(this._head=this._tail=null),u.data}},item:function(u){u<0&&(u=this.length+u);for(var f=this._head;u-- >0&&f;)f=f.next;return f?f.data:void 0},slice:function(u,f){if(u||(u=0),f||(f=this.length),f<0&&(f=this.length+f),u<0&&(u=this.length+u),f===u)return[];if(f<u)throw new Error("invalid offset: "+u+","+f+" (length="+this.length+")");for(var _=f-u,o=new Array(_),b=0,E=this._head;u-- >0&&E;)E=E.next;for(;b<_&&E;)o[b++]=E.data,E=E.next;return o},drop:function(){a.call(this)},forEach:function(u,f){for(var _=this._head,o=0,b=this.length;o<b&&_;)u.call(f||this,_.data,o,this),_=_.next,o++},map:function(u,f){var _=new a;return this.forEach(function(o,b,E){_.push(u.call(f||E,o,b,E))}),_},filter:function(u,f){var _=new a;return this.forEach(function(o,b,E){u.call(f||E,o,b,E)&&_.push(o)}),_},reduce:function(u,f,_){var o=0,b=this._head,E=this.length;for(f||(o=1,f=b&&b.data,b=b&&b.next);o<E&&b;)f=u.call(_||this,f,b.data,this),o++,b=b.next;return f}},e.exports=a})()})(fastList);var LinkedList=fastList.exports;function floodFill(e={}){const{x:r=0,y:n=0,inPlace:a=!0}=e,u=a?this:Image.createFrom(this);if(this.checkProcessable("floodFill",{bitDepth:1}),this.getBitXY(r,n))return u;const _=new LinkedList;for(_.push(new Node(r,n));_.length>0;){const o=_.shift();u.setBitXY(o.x,o.y);for(let b=o.x+1;b<this.width&&(!u.getBitXY(b,o.y)&&!this.getBitXY(b,o.y));b++)u.setBitXY(b,o.y),o.y+1<this.height&&!this.getBitXY(b,o.y+1)&&_.push(new Node(b,o.y+1)),o.y-1>=0&&!this.getBitXY(b,o.y-1)&&_.push(new Node(b,o.y-1));for(let b=o.x-1;b>=0&&(!u.getBitXY(b,o.y)&&!this.getBitXY(b,o.y));b++)u.setBitXY(b,o.y),o.y+1<this.height&&!this.getBitXY(b,o.y+1)&&_.push(new Node(b,o.y+1)),o.y-1>=0&&!this.getBitXY(b,o.y-1)&&_.push(new Node(b,o.y-1))}return u}function Node(e,r){this.x=e,this.y=r}function _extends(){return _extends=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},_extends.apply(this,arguments)}function hsv2rgb(e,r,n){r=r/100,n=n/100;var a=[],u=n*r,f=e/60,_=u*(1-Math.abs(f%2-1)),o=n-u;return f>=0&&f<1?a=[u,_,0]:f>=1&&f<2?a=[_,u,0]:f>=2&&f<3?a=[0,u,_]:e>=3&&f<4?a=[0,_,u]:e>=4&&f<5?a=[_,0,u]:e>=5&&f<=6?a=[u,0,_]:a=[0,0,0],{r:Math.round(255*(a[0]+o)),g:Math.round(255*(a[1]+o)),b:Math.round(255*(a[2]+o))}}function hsl2hsv(e,r,n){return r*=(n<50?n:100-n)/100,{h:e,s:2*r/(n+r)*100,v:n+r}}function hsl2rgb$1(e,r,n){var a=hsl2hsv(e,r,n);return hsv2rgb(a.h,a.s,a.v)}var colors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]};function parse(e){return named(e)||hex3(e)||hex6(e)||rgb(e)||rgba$1(e)||hsl(e)||hsla(e)}function named(e){var r=colors[e.toLowerCase()];if(!!r)return{r:r[0],g:r[1],b:r[2],a:100}}function rgb(e){var r=e.match(/rgb\(([^)]+)\)/);if(r){var n=r[1].split(/ *, */).map(Number);return{r:n[0],g:n[1],b:n[2],a:100}}}function rgba$1(e){var r=e.match(/rgba\(([^)]+)\)/);if(r){var n=r[1].split(/ *, */).map(Number);return{r:n[0],g:n[1],b:n[2],a:n[3]*100}}}function hex6(e){if(e[0]==="#"&&e.length===7)return{r:parseInt(e.slice(1,3),16),g:parseInt(e.slice(3,5),16),b:parseInt(e.slice(5,7),16),a:100}}function hex3(e){if(e[0]==="#"&&e.length===4)return{r:parseInt(e[1]+e[1],16),g:parseInt(e[2]+e[2],16),b:parseInt(e[3]+e[3],16),a:100}}function hsl(e){var r=e.match(/hsl\(([^)]+)\)/);if(r){var n=r[1].split(/ *, */),a=parseInt(n[0],10),u=parseInt(n[1],10),f=parseInt(n[2],10),_=hsl2rgb$1(a,u,f);return _extends({},_,{a:100})}}function hsla(e){var r=e.match(/hsla\(([^)]+)\)/);if(r){var n=r[1].split(/ *, */),a=parseInt(n[0],10),u=parseInt(n[1],10),f=parseInt(n[2],10),_=parseInt(parseFloat(n[3])*100,10),o=hsl2rgb$1(a,u,f);return _extends({},o,{a:_})}}function css2array(e){let r=parse(e);return[r.r,r.g,r.b,Math.round(r.a*255/100)]}function hue2rgb(e,r,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(r-e)*6*n:n<1/2?r:n<2/3?e+(r-e)*(2/3-n)*6:e}function hsl2rgb(e,r,n){let a,u,f,_,o,b;return r/=100,n/=100,r===0?_=o=b=n*255:(n<=.5?u=n*(r+1):u=n+r-n*r,a=n*2-u,f=e/360,_=hue2rgb(a,u,f+1/3),o=hue2rgb(a,u,f),b=hue2rgb(a,u,f-1/3)),{r:_,g:o,b}}function getDistinctColors(e){let r=new Array(e),n=0;for(let a=0;a<360;a+=360/e){n++;let u=hsl2rgb(a,100,30+n%4*15);r[n-1]=[Math.round(u.r*255),Math.round(u.g*255),Math.round(u.b*255)]}return r}function getRandomColor(){return[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)]}function getColors(e){let{color:r,colors:n,randomColors:a,numberColors:u=50}=e;if(r&&!Array.isArray(r)&&(r=css2array(r)),r)return[r];if(n)return n=n.map(function(f){return Array.isArray(f)?f:css2array(f)}),n;if(a){n=new Array(u);for(let f=0;f<u;f++)n[f]=getRandomColor()}return getDistinctColors(u)}function paintLabels(e,r,n={}){let{color:a="blue",colors:u,font:f="12px Helvetica",rotate:_=0}=n;if(this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1}),!Array.isArray(e))throw Error("paintLabels: labels must be an array");if(!Array.isArray(r))throw Error("paintLabels: positions must be an array");if(a&&!Array.isArray(a)&&(a=css2array(a)),u?u=u.map(function(E){return Array.isArray(E)?E:css2array(E)}):u=[a],e.length!==r.length)throw Error("paintLabels: positions and labels must be arrays from the same size");Array.isArray(f)||(f=[f]),Array.isArray(_)||(_=[_]);let b=this.getCanvas().getContext("2d");for(let E=0;E<e.length;E++){b.save();let M=u[E%u.length];b.fillStyle=`rgba(${M[0]},${M[1]},${M[2]},${M[3]/this.maxValue})`,b.font=f[E%f.length];let P=r[E];b.translate(P[0],P[1]),b.rotate(_[E%_.length]/180*Math.PI),b.fillText(e[E],0,0),b.restore()}return this.data=Uint8Array.from(b.getImageData(0,0,this.width,this.height).data),this}function paintMasks(e,r={}){let{alpha:n=255,labels:a=[],labelsPosition:u=[],labelColor:f="blue",labelFont:_="12px Helvetica"}=r;this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1});let o=getColors(Object.assign({},r,{numberColors:e.length}));Array.isArray(e)||(e=[e]);for(let b=0;b<e.length;b++){let E=e[b],M=o[b%o.length];for(let P=0;P<E.width;P++)for(let L=0;L<E.height;L++)if(E.getBitXY(P,L))for(let D=0;D<Math.min(this.components,M.length);D++)if(n===255)this.setValueXY(P+E.position[0],L+E.position[1],D,M[D]);else{let U=this.getValueXY(P+E.position[0],L+E.position[1],D);U=Math.round((U*(255-n)+M[D]*n)/255),this.setValueXY(P+E.position[0],L+E.position[1],D,U)}}if(Array.isArray(a)&&a.length>0){let E=this.getCanvas().getContext("2d");E.fillStyle=f,E.font=_;for(let M=0;M<Math.min(e.length,a.length);M++){let P=u[M]?u[M]:e[M].position;E.fillText(a[M],P[0],P[1])}this.data=Uint8Array.from(E.getImageData(0,0,this.width,this.height).data)}return this}function zerosMatrix(e,r){let n=new Array(e);for(let a=0;a<e;a++)n[a]=new Array(r).fill(0);return n}const cross=[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],smallCross=[[0,1,0],[1,1,1],[0,1,0]];class Shape{constructor(r={}){let{kind:n="cross",shape:a,size:u,width:f,height:_,filled:o=!0}=r;if(u&&(f=u,_=u),a)switch(a.toLowerCase()){case"square":case"rectangle":this.matrix=rectangle(f,_,{filled:o});break;case"circle":case"ellipse":this.matrix=ellipse(f,_,{filled:o});break;case"triangle":this.matrix=triangle(f,_,{filled:o});break;default:throw new Error(`Shape: unexpected shape: ${a}`)}else if(n)switch(n.toLowerCase()){case"cross":this.matrix=cross;break;case"smallcross":this.matrix=smallCross;break;default:throw new Error(`Shape: unexpected kind: ${n}`)}else throw new Error("Shape: expected a kind or a shape option");this.height=this.matrix.length,this.width=this.matrix[0].length,this.halfHeight=this.height/2>>0,this.halfWidth=this.width/2>>0}getPoints(){let r=this.matrix,n=[];for(let a=0;a<r.length;a++)for(let u=0;u<r[0].length;u++)r[a][u]&&n.push([u-this.halfWidth,a-this.halfHeight]);return n}getMask(){let r=new Image(this.width,this.height,{kind:BINARY});for(let n=0;n<this.matrix.length;n++)for(let a=0;a<this.matrix[0].length;a++)this.matrix[n][a]&&r.setBitXY(a,n);return r}}function rectangle(e,r,n){const a=zerosMatrix(r,e);if(n.filled)for(let u=0;u<r;u++)for(let f=0;f<e;f++)a[u][f]=1;else{for(let u of[0,r-1])for(let f=0;f<e;f++)a[u][f]=1;for(let u=0;u<r;u++)for(let f of[0,e-1])a[u][f]=1}return a}function ellipse(e,r,n){const a=zerosMatrix(r,e);let u=1-r%2,f=1-e%2,_=Math.floor((e-1)/2),o=Math.floor((r-1)/2),b=_*_,E=o*o;if(n.filled)for(let M=0;M<=o;M++){let P=Math.floor(Math.sqrt(b-b*M*M/E));for(let L=_-P;L<=_;L++)a[o-M][L]=1,a[o+M+u][L]=1,a[o-M][e-L-1]=1,a[o+M+u][e-L-1]=1}else{for(let M=0;M<=o;M++){let P=Math.floor(Math.sqrt(b-b*M*M/E)),L=_-P;a[o-M][L]=1,a[o+M+u][L]=1,a[o-M][e-L-1]=1,a[o+M+u][e-L-1]=1}for(let M=0;M<=_;M++){let P=Math.floor(Math.sqrt(E-E*M*M/b)),L=o-P;a[L][_-M]=1,a[L][_+M+f]=1,a[r-L-1][_-M]=1,a[r-L-1][_+M+f]=1}}return a}function triangle(e,r,n){if(!n.filled)throw new Error("Non filled triangle is not implemented");const a=zerosMatrix(r,e);for(let u=0;u<r;u++){let f=Math.floor((1-u/r)*e/2);for(let _=f;_<e-f;_++)a[u][_]=1}return a}function paintPoints(e,r={}){let{shape:n}=r;this.checkProcessable("paintPoints",{bitDepth:[8,16]});let a=getColors(Object.assign({},r,{numberColors:e.length})),u=new Shape(n).getPoints(),f=Math.min(this.channels,a[0].length);for(let _=0;_<e.length;_++){let o=a[_%a.length],b=e[_][0],E=e[_][1];for(let M=0;M<u.length;M++){let P=u[M][0],L=u[M][1];if(b+P>=0&&E+L>=0&&b+P<this.width&&E+L<this.height){let D=(b+P+(E+L)*this.width)*this.channels;for(let U=0;U<f;U++)this.data[D+U]=o[U]}}}return this}function paintPolyline(e,r={}){let{color:n=[this.maxValue,0,0],closed:a=!1}=r;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]});let u=Math.min(this.channels,n.length);for(let f=0;f<e.length-1+a;f++){let _=e[f],o=e[(f+1)%e.length],b=o[0]-_[0],E=o[1]-_[1],M=Math.max(Math.abs(b),Math.abs(E)),P=b/M,L=E/M,D=_[0],U=_[1];for(let X=0;X<=M;X++){let K=Math.round(D),q=Math.round(U);if(K>=0&&q>=0&&K<this.width&&q<this.height)if(this.bitDepth===1)this.setBitXY(K,q);else{let oe=(K+q*this.width)*this.channels;for(let W=0;W<u;W++)this.data[oe+W]=n[W]}D=D+P,U=U+L}}return this}function paintPolylines(e,r={}){let n=Object.assign({},r);this.checkProcessable("paintPolylines",{bitDepth:[8,16]});let a=getColors(Object.assign({},r,{numberColors:e.length}));for(let u=0;u<e.length;u++)n.color=a[u%a.length],this.paintPolyline(e[u],n);return this}function paintPolygon(e,r={}){let{color:n=[this.maxValue,0,0],filled:a=!1}=r;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]}),r.closed=!0;let u=deleteDouble(e);if(a===!1)return this.paintPolyline(e,r);{let f=Array(this.height);for(let _=0;_<this.height;_++){f[_]=[];for(let o=0;o<this.width;o++)f[_].push(0)}for(let _=0;_<u.length;_++){const o=lineBetweenTwoPoints(u[_],u[(_+1)%u.length]);for(let b=0;b<this.height;b++)for(let E=0;E<this.width;E++)isAtTheRightOfTheLine(E,b,o,this.height)&&(f[b][E]=f[b][E]===0?1:0)}for(let _=0;_<this.height;_++)for(let o=0;o<this.width;o++)if(f[_][o]===1)if(this.bitDepth===1)this.setBitXY(o,_);else{let b=Math.min(this.channels,n.length),E=(o+_*this.width)*this.channels;for(let M=0;M<b;M++)this.data[E+M]=n[M]}return this.paintPolyline(e,r)}}function deleteDouble(e){let r=[];for(let n=0;n<e.length;n++)if(!(e[n][0]===e[(n+1)%e.length][0]&&e[n][1]===e[(n+1)%e.length][1])){if(e[n][0]===e[(n-1+e.length)%e.length][0]&&e[n][1]===e[(n-1+e.length)%e.length][1])continue;if(e[(n+1)%e.length][0]===e[(n-1+e.length)%e.length][0]&&e[(n-1+e.length)%e.length][1]===e[(n+1)%e.length][1])continue;r.push(e[n])}return r}function lineBetweenTwoPoints(e,r){if(e[0]===r[0])return{a:0,b:e[0],vertical:!0};{const n=(r[1]-e[1])/(r[0]-e[0]),a=e[1]-n*e[0];return{a:n,b:a,vertical:!1}}}function isAtTheRightOfTheLine(e,r,n,a){if(n.vertical===!0)return n.b<=e;if(n.a===0)return!1;{const u=(r-n.b)/n.a;return u<e&&u>=0&&u<=a}}function paintPolygons(e,r={}){let n=Object.assign({},r);this.checkProcessable("paintPolygons",{bitDepth:[8,16]});let a=getColors(Object.assign({},r,{numberColors:e.length}));for(let u=0;u<e.length;u++)n.color=a[u%a.length],this.paintPolygon(e[u],n);return this}function getHistogram(e={}){let{maxSlots:r=256,channel:n,useAlpha:a=!0}=e;if(this.checkProcessable("getHistogram",{bitDepth:[1,8,16]}),n===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");n=0}return getChannelHistogram.call(this,n,{useAlpha:a,maxSlots:r})}function getHistograms(e={}){const{maxSlots:r=256,useAlpha:n=!0}=e;this.checkProcessable("getHistograms",{bitDepth:[8,16]});let a=new Array(n?this.components:this.channels);for(let u=0;u<a.length;u++)a[u]=getChannelHistogram.call(this,u,{useAlpha:n,maxSlots:r});return a}function getChannelHistogram(e,r){let{useAlpha:n,maxSlots:a}=r;if(this.bitDepth===1){let b=[0,0];for(let E=0;E<this.height;E++)for(let M=0;M<this.width;M++){let P=this.getBitXY(E,M);P===0?b[0]+=1:P===1&&(b[1]+=1)}return b}let u=Math.log2(a);if(!isInteger(u))throw new RangeError("maxSlots must be a power of 2, for example: 64, 256, 1024");let f=0;this.bitDepth>u&&(f=this.bitDepth-u);let _=this.data,o=newArray_1(Math.pow(2,Math.min(this.bitDepth,u)),0);if(n&&this.alpha){let b=this.channels-e-1;for(let E=e;E<_.length;E+=this.channels)o[_[E]>>f]+=_[E+b]/this.maxValue}else for(let b=e;b<_.length;b+=this.channels)o[_[b]>>f]++;return o}function getColorHistogram(e={}){let{useAlpha:r=!0,nbSlots:n=512}=e;this.checkProcessable("getColorHistogram",{bitDepth:[8,16],components:[3]});let a=Math.log(n)/Math.log(8);if(a!==Math.floor(a))throw new RangeError("nbSlots must be a power of 8. Usually 8, 64, 512 or 4096");let u=this.bitDepth-a,f=this.data,_=newArray_1(Math.pow(8,a),0),o=Math.pow(2,a*2),b=Math.pow(2,a);for(let E=0;E<f.length;E+=this.channels){let M=(f[E]>>u)*o+(f[E+1]>>u)*b+(f[E+2]>>u);r&&this.alpha?_[M]+=f[E+this.channels-1]/this.maxValue:_[M]++}return _}function min(){this.checkProcessable("min",{bitDepth:[8,16,32]});let e=newArray_1(this.channels,1/0);for(let r=0;r<this.data.length;r+=this.channels)for(let n=0;n<this.channels;n++)this.data[r+n]<e[n]&&(e[n]=this.data[r+n]);return e}function max(){this.checkProcessable("max",{bitDepth:[8,16,32]});let e=newArray_1(this.channels,-1/0);for(let r=0;r<this.data.length;r+=this.channels)for(let n=0;n<this.channels;n++)this.data[r+n]>e[n]&&(e[n]=this.data[r+n]);return e}function sum(){this.checkProcessable("sum",{bitDepth:[8,16]});let e=newArray_1(this.channels,0);for(let r=0;r<this.data.length;r+=this.channels)for(let n=0;n<this.channels;n++)e[n]+=this.data[r+n];return e}function getMoment(e=0,r=0){this.checkProcessable("getMoment",{bitDepth:[1]});let n=0;for(let a=0;a<this.width;a++)for(let u=0;u<this.height;u++)this.getBitXY(a,u)===1&&(n+=a**e*u**r);return n}function localMaxima(e={}){let{mask:r,region:n=3,removeClosePoints:a=0,invert:u=!1,maxEquals:f=2}=e,_=this;this.checkProcessable("localMaxima",{bitDepth:[8,16],components:1}),n*=4;let o=u?0:1,b=[1,0,-1,0,1,1,-1,-1,2,0,-2,0,2,2,-2,-2],E=[0,1,0,-1,1,-1,1,-1,0,2,0,-2,2,-2,2,-2],M=n<=8?1:2,P=[];for(let L=M;L<_.height-M;L++)for(let D=M;D<_.width-M;D++){if(r&&r.getBitXY(D,L)!==o)continue;let U=0,X=0,K=_.data[D+L*_.width];for(let q=0;q<n;q++)u?_.data[D+b[q]+(L+E[q])*_.width]>K&&U++:_.data[D+b[q]+(L+E[q])*_.width]<K&&U++,_.data[D+b[q]+(L+E[q])*_.width]===K&&X++;U+X===n&&X<=f&&P.push([D,L])}if(a>0)for(let L=0;L<P.length;L++)for(let D=L+1;D<P.length;D++)Math.sqrt(Math.pow(P[L][0]-P[D][0],2)+Math.pow(P[L][1]-P[D][1],2))<a&&(P[L][0]=P[L][0]+P[D][0]>>1,P[L][1]=P[L][1]+P[D][1]>>1,P.splice(D,1),D--);return P}function mean(){let e=this.getHistograms({maxSlots:this.maxValue+1}),r=new Array(e.length);for(let n=0;n<e.length;n++){let a=e[n];r[n]=mean$2(a)}return r}function median(){let e=this.getHistograms({maxSlots:this.maxValue+1}),r=new Array(e.length);for(let n=0;n<e.length;n++){let a=e[n];r[n]=median$2(a)}return r}function points(){this.checkProcessable("points",{bitDepth:[1]});const e=[];for(let r=0;r<this.width;r++)for(let n=0;n<this.height;n++)this.getBitXY(r,n)===1&&e.push([r,n]);return e}function extendedPoints(){this.checkProcessable("extendedPoints",{bitDepth:[1]});const e=[];for(let r=0;r<this.height;r++)for(let n=0;n<this.width;n++)if(this.getBitXY(n,r)===1)for(e.push([n,r]),this.getBitXY(n+1,r)!==1?(e.push([n+1,r]),e.push([n+1,r+1]),this.getBitXY(n,r+1)!==1&&e.push([n,r+1])):this.getBitXY(n,r+1)!==1&&(e.push([n,r+1]),e.push([n+1,r+1]));n<this.width-2&&this.getBitXY(n+1,r)===1&&this.getBitXY(n+2,r)===1;)n++;return e}function getRelativePosition(e,r={}){if(this===e)return[0,0];let n=[0,0],a=this;for(;a;){if(a===e)return n;a.position&&(n[0]+=a.position[0],n[1]+=a.position[1]),a=a.parent}return r.defaultFurther?n:!1}function countAlphaPixels(e={}){let{alpha:r=1}=e;this.checkProcessable("countAlphaPixels",{bitDepth:[8,16],alpha:1});let n=0;if(r!==void 0){for(let a=this.components;a<this.data.length;a+=this.channels)this.data[a]===r&&n++;return n}else return this.size}function monotoneChainConvexHull$1(e,r={}){const{sorted:n}=r;n||(e=e.slice().sort(byXThenY));const a=e.length,u=new Array(a*2);let f=0;for(let o=0;o<a;o++){const b=e[o];for(;f>=2&&cw(u[f-2],u[f-1],b)<=0;)f--;u[f++]=b}const _=f+1;for(let o=a-2;o>=0;o--){const b=e[o];for(;f>=_&&cw(u[f-2],u[f-1],b)<=0;)f--;u[f++]=b}return u.slice(0,f-1)}function cw(e,r,n){return(r[1]-e[1])*(n[0]-e[0])-(r[0]-e[0])*(n[1]-e[1])}function byXThenY(e,r){return e[0]===r[0]?e[1]-r[1]:e[0]-r[0]}function monotoneChainConvexHull(){return monotoneChainConvexHull$1(this.extendedPoints,{sorted:!1})}function round(e){for(let r=0;r<e.length;r++)e[r][0]=Math.round(e[r][0]),e[r][1]=Math.round(e[r][1]);return e}function difference(e,r){return[e[0]-r[0],e[1]-r[1]]}function normalize(e){let r=Math.sqrt(e[0]**2+e[1]**2);return[e[0]/r,e[1]/r]}function rotate(e,r,n){n===void 0&&(n=new Array(r.length));let a=Math.cos(e),u=Math.sin(e);for(let f=0;f<n.length;++f)n[f]=[a*r[f][0]-u*r[f][1],u*r[f][0]+a*r[f][1]];return n}function perimeter(e){let r=0;for(let n=0;n<e.length;n++){let a=e[n][0],u=e[n][1],f=e[n===e.length-1?0:n+1][0],_=e[n===e.length-1?0:n+1][1];r+=Math.sqrt((f-a)**2+(_-u)**2)}return r}function surface(e){let r=0;for(let n=0;n<e.length;n++){let a=e[n][0],u=e[n===e.length-1?0:n+1][1],f=e[n===e.length-1?0:n+1][0],_=e[n][1];r+=a*u*.5,r-=f*_*.5}return Math.abs(r)}function minMax(e){let r=1/0,n=1/0,a=-1/0,u=-1/0;for(let f=0;f<e.length;f++)e[f][0]<r&&(r=e[f][0]),e[f][0]>a&&(a=e[f][0]),e[f][1]<n&&(n=e[f][1]),e[f][1]>u&&(u=e[f][1]);return[[r,n],[a,u]]}function moveToZeroZero(e,r){r===void 0&&(r=new Array(e.length).fill(0).map(()=>[]));let n=minMax(e),a=n[0][0],u=n[0][1];for(let f=0;f<e.length;f++)r[f][0]=e[f][0]-a,r[f][1]=e[f][1]-u;return r}function minimalBoundingRectangle(e={}){const{originalPoints:r=monotoneChainConvexHull.call(this)}=e;if(r.length===0)return[];if(r.length===1)return[r[0],r[0],r[0],r[0]];const n=new Array(r.length);let a=1/0,u=0,f;for(let _=0;_<n.length;_++){let o=getAngle$1(r[_],r[(_+1)%n.length]);rotate(-o,r,n);let b=n[_][0],E=n[_][1],M=n[(_+1)%n.length][0],P=n[(_+1)%n.length][1],L=!0,D=0,U=0,X=0;for(let W=0;W<n.length;W++){let Y=n[W][0],J=n[W][1],Ee=(Y-b)/(M-b);L===!0?(L=!1,D=Ee,U=Ee):(Ee<D&&(D=Ee),Ee>U&&(U=Ee));let xe=(-(M-b)*J+M*E-P*b)/(M-b);Math.abs(xe)>Math.abs(X)&&(X=xe)}let K=[b+D*(M-b),E],q=[b+U*(M-b),E],oe=Math.abs(X*(D-U)*(M-b));oe<a&&(u=o,a=oe,f=[K,q,[q[0],q[1]-X],[K[0],K[1]-X]])}return rotate(u,f,f),f}function getAngle$1(e,r){let n=difference(r,e),a=normalize(n),u=Math.acos(a[0]);return a[1]<0?-u:u}function extend$4(e){let r={inPlace:!0};e.extendMethod("invert",invert),e.extendMethod("abs",abs),e.extendMethod("level",level,r),e.extendMethod("add",add,r),e.extendMethod("subtract",subtract,r),e.extendMethod("subtractImage",subtractImage),e.extendMethod("multiply",multiply,r),e.extendMethod("divide",divide,r),e.extendMethod("hypotenuse",hypotenuse),e.extendMethod("background",background$1),e.extendMethod("flipX",flipX),e.extendMethod("flipY",flipY),e.extendMethod("blurFilter",blurFilter),e.extendMethod("medianFilter",medianFilter),e.extendMethod("gaussianFilter",gaussianFilter),e.extendMethod("sobelFilter",sobelFilter),e.extendMethod("gradientFilter",gradientFilter),e.extendMethod("scharrFilter",scharrFilter),e.extendMethod("dilate",dilate),e.extendMethod("erode",erode),e.extendMethod("open",open),e.extendMethod("close",close),e.extendMethod("topHat",topHat),e.extendMethod("blackHat",blackHat),e.extendMethod("morphologicalGradient",morphologicalGradient),e.extendMethod("warpingFourPoints",warpingFourPoints),e.extendMethod("crop",crop),e.extendMethod("cropAlpha",cropAlpha),e.extendMethod("resize",resize).extendMethod("scale",resize),e.extendMethod("hsv",hsv),e.extendMethod("hsl",hsl$1),e.extendMethod("cmyk",cmyk),e.extendMethod("rgba8",rgba8),e.extendMethod("grey",grey).extendMethod("gray",grey),e.extendMethod("mask",mask),e.extendMethod("pad",pad),e.extendMethod("colorDepth",colorDepth),e.extendMethod("setBorder",setBorder,r),e.extendMethod("rotate",rotate$1),e.extendMethod("rotateLeft",rotateLeft),e.extendMethod("rotateRight",rotateRight),e.extendMethod("insert",insert),e.extendMethod("getRow",getRow),e.extendMethod("getColumn",getColumn),e.extendMethod("getMatrix",getMatrix),e.extendMethod("setMatrix",setMatrix),e.extendMethod("getPixelsArray",getPixelsArray),e.extendMethod("getIntersection",getIntersection),e.extendMethod("getClosestCommonParent",getClosestCommonParent),e.extendMethod("getThreshold",getThreshold),e.extendMethod("split",split),e.extendMethod("getChannel",getChannel),e.extendMethod("combineChannels",combineChannels),e.extendMethod("setChannel",setChannel),e.extendMethod("getSimilarity",getSimilarity),e.extendMethod("getPixelsGrid",getPixelsGrid),e.extendMethod("getBestMatch",getBestMatch),e.extendMethod("cannyEdge",cannyEdge),e.extendMethod("convolution",convolution),e.extendMethod("extract",extract),e.extendMethod("floodFill",floodFill),e.extendMethod("paintLabels",paintLabels,r),e.extendMethod("paintMasks",paintMasks,r),e.extendMethod("paintPoints",paintPoints,r),e.extendMethod("paintPolyline",paintPolyline,r),e.extendMethod("paintPolylines",paintPolylines,r),e.extendMethod("paintPolygon",paintPolygon,r),e.extendMethod("paintPolygons",paintPolygons,r),e.extendMethod("countAlphaPixels",countAlphaPixels),e.extendMethod("monotoneChainConvexHull",monotoneChainConvexHull),e.extendMethod("minimalBoundingRectangle",minimalBoundingRectangle),e.extendMethod("getHistogram",getHistogram).extendProperty("histogram",getHistogram),e.extendMethod("getHistograms",getHistograms).extendProperty("histograms",getHistograms),e.extendMethod("getColorHistogram",getColorHistogram).extendProperty("colorHistogram",getColorHistogram),e.extendMethod("getMin",min).extendProperty("min",min),e.extendMethod("getMax",max).extendProperty("max",max),e.extendMethod("getSum",sum).extendProperty("sum",sum),e.extendMethod("getMoment",getMoment).extendProperty("moment",getMoment),e.extendMethod("getLocalMaxima",localMaxima),e.extendMethod("getMedian",median).extendProperty("median",median),e.extendMethod("getMean",mean).extendProperty("mean",mean),e.extendMethod("getPoints",points).extendProperty("points",points),e.extendMethod("getExtendedPoints",extendedPoints).extendProperty("extendedPoints",extendedPoints),e.extendMethod("getRelativePosition",getRelativePosition)}var quantities={exports:{}};(function(e,r){(function(n,a){e.exports=a()})(commonjsGlobal,function(){function n(ye){return typeof ye=="string"||ye instanceof String}var a=Number.isFinite||window.isFinite;function u(ye){return a(ye)}function f(ye){return ye}function _(ye){var qe={};return ye.filter(function(at){return qe.hasOwnProperty(at)?!1:qe[at]=!0})}function o(ye,qe){if(qe.length!==ye.length)return!1;for(var at=0;at<ye.length;at++)if(qe[at].compareArray&&!qe[at].compareArray(ye[at])||qe[at]!==ye[at])return!1;return!0}function b(ye,qe){Object.keys(qe).forEach(function(at){ye[at]=qe[at]})}function E(){for(var ye=1,qe=0,at=0;at<arguments.length;at++){var ne=arguments[at];qe=qe+L(ne),ye*=ne}return qe!==0?P(ye,qe):ye}function M(ye,qe){if(qe===0)throw new Error("Divide by zero");var at=Math.pow(10,L(qe)),ne=at/(at*qe);return E(ye,ne)}function P(ye,qe){return Math.round(ye*Math.pow(10,qe))/Math.pow(10,qe)}function L(ye){if(!isFinite(ye))return 0;for(var qe=0;ye%1!==0;)ye*=10,qe++;return qe}function D(){var ye;if(!this)return ye=Object.create(D.prototype),D.apply(ye,arguments),ye;ye=Error.apply(this,arguments),this.name="QtyError",this.message=ye.message,this.stack=ye.stack}D.prototype=Object.create(Error.prototype,{constructor:{value:D}});function U(ye,qe){throw new D("Incompatible units: "+ye+" and "+qe)}var X={"<googol>":[["googol"],1e100,"prefix"],"<kibi>":[["Ki","Kibi","kibi"],Math.pow(2,10),"prefix"],"<mebi>":[["Mi","Mebi","mebi"],Math.pow(2,20),"prefix"],"<gibi>":[["Gi","Gibi","gibi"],Math.pow(2,30),"prefix"],"<tebi>":[["Ti","Tebi","tebi"],Math.pow(2,40),"prefix"],"<pebi>":[["Pi","Pebi","pebi"],Math.pow(2,50),"prefix"],"<exi>":[["Ei","Exi","exi"],Math.pow(2,60),"prefix"],"<zebi>":[["Zi","Zebi","zebi"],Math.pow(2,70),"prefix"],"<yebi>":[["Yi","Yebi","yebi"],Math.pow(2,80),"prefix"],"<yotta>":[["Y","Yotta","yotta"],1e24,"prefix"],"<zetta>":[["Z","Zetta","zetta"],1e21,"prefix"],"<exa>":[["E","Exa","exa"],1e18,"prefix"],"<peta>":[["P","Peta","peta"],1e15,"prefix"],"<tera>":[["T","Tera","tera"],1e12,"prefix"],"<giga>":[["G","Giga","giga"],1e9,"prefix"],"<mega>":[["M","Mega","mega"],1e6,"prefix"],"<kilo>":[["k","kilo"],1e3,"prefix"],"<hecto>":[["h","Hecto","hecto"],100,"prefix"],"<deca>":[["da","Deca","deca","deka"],10,"prefix"],"<deci>":[["d","Deci","deci"],.1,"prefix"],"<centi>":[["c","Centi","centi"],.01,"prefix"],"<milli>":[["m","Milli","milli"],.001,"prefix"],"<micro>":[["u","\u03BC","\xB5","Micro","mc","micro"],1e-6,"prefix"],"<nano>":[["n","Nano","nano"],1e-9,"prefix"],"<pico>":[["p","Pico","pico"],1e-12,"prefix"],"<femto>":[["f","Femto","femto"],1e-15,"prefix"],"<atto>":[["a","Atto","atto"],1e-18,"prefix"],"<zepto>":[["z","Zepto","zepto"],1e-21,"prefix"],"<yocto>":[["y","Yocto","yocto"],1e-24,"prefix"],"<1>":[["1","<1>"],1,""],"<meter>":[["m","meter","meters","metre","metres"],1,"length",["<meter>"]],"<inch>":[["in","inch","inches",'"'],.0254,"length",["<meter>"]],"<foot>":[["ft","foot","feet","'"],.3048,"length",["<meter>"]],"<yard>":[["yd","yard","yards"],.9144,"length",["<meter>"]],"<mile>":[["mi","mile","miles"],1609.344,"length",["<meter>"]],"<naut-mile>":[["nmi","naut-mile"],1852,"length",["<meter>"]],"<league>":[["league","leagues"],4828,"length",["<meter>"]],"<furlong>":[["furlong","furlongs"],201.2,"length",["<meter>"]],"<rod>":[["rd","rod","rods"],5.029,"length",["<meter>"]],"<mil>":[["mil","mils"],254e-7,"length",["<meter>"]],"<angstrom>":[["ang","angstrom","angstroms"],1e-10,"length",["<meter>"]],"<fathom>":[["fathom","fathoms"],1.829,"length",["<meter>"]],"<pica>":[["pica","picas"],.00423333333,"length",["<meter>"]],"<point>":[["pt","point","points"],.000352777778,"length",["<meter>"]],"<redshift>":[["z","red-shift","redshift"],1302773e20,"length",["<meter>"]],"<AU>":[["AU","astronomical-unit"],1495979e5,"length",["<meter>"]],"<light-second>":[["ls","light-second"],299792500,"length",["<meter>"]],"<light-minute>":[["lmin","light-minute"],1798755e4,"length",["<meter>"]],"<light-year>":[["ly","light-year"],9460528e9,"length",["<meter>"]],"<parsec>":[["pc","parsec","parsecs"],3085678e10,"length",["<meter>"]],"<datamile>":[["DM","datamile"],1828.8,"length",["<meter>"]],"<kilogram>":[["kg","kilogram","kilograms"],1,"mass",["<kilogram>"]],"<AMU>":[["u","AMU","amu"],1660538921e-36,"mass",["<kilogram>"]],"<dalton>":[["Da","Dalton","Daltons","dalton","daltons"],1660538921e-36,"mass",["<kilogram>"]],"<slug>":[["slug","slugs"],14.5939029,"mass",["<kilogram>"]],"<short-ton>":[["tn","ton","short-ton"],907.18474,"mass",["<kilogram>"]],"<metric-ton>":[["tonne","metric-ton"],1e3,"mass",["<kilogram>"]],"<carat>":[["ct","carat","carats"],2e-4,"mass",["<kilogram>"]],"<pound>":[["lbs","lb","pound","pounds","#"],.45359237,"mass",["<kilogram>"]],"<ounce>":[["oz","ounce","ounces"],.0283495231,"mass",["<kilogram>"]],"<gram>":[["g","gram","grams","gramme","grammes"],.001,"mass",["<kilogram>"]],"<grain>":[["grain","grains","gr"],6479891e-11,"mass",["<kilogram>"]],"<dram>":[["dram","drams","dr"],.0017718452,"mass",["<kilogram>"]],"<stone>":[["stone","stones","st"],6.35029318,"mass",["<kilogram>"]],"<hectare>":[["hectare"],1e4,"area",["<meter>","<meter>"]],"<acre>":[["acre","acres"],4046.85642,"area",["<meter>","<meter>"]],"<sqft>":[["sqft"],1,"area",["<foot>","<foot>"]],"<liter>":[["l","L","liter","liters","litre","litres"],.001,"volume",["<meter>","<meter>","<meter>"]],"<gallon>":[["gal","gallon","gallons"],.0037854118,"volume",["<meter>","<meter>","<meter>"]],"<gallon-imp>":[["galimp","gallon-imp","gallons-imp"],.00454609,"volume",["<meter>","<meter>","<meter>"]],"<quart>":[["qt","quart","quarts"],.00094635295,"volume",["<meter>","<meter>","<meter>"]],"<pint>":[["pt","pint","pints"],.000473176475,"volume",["<meter>","<meter>","<meter>"]],"<pint-imp>":[["ptimp","pint-imp","pints-imp"],.00056826125,"volume",["<meter>","<meter>","<meter>"]],"<cup>":[["cu","cup","cups"],.000236588238,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce>":[["floz","fluid-ounce","fluid-ounces"],295735297e-13,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce-imp>":[["flozimp","floz-imp","fluid-ounce-imp","fluid-ounces-imp"],284130625e-13,"volume",["<meter>","<meter>","<meter>"]],"<tablespoon>":[["tb","tbsp","tbs","tablespoon","tablespoons"],147867648e-13,"volume",["<meter>","<meter>","<meter>"]],"<teaspoon>":[["tsp","teaspoon","teaspoons"],492892161e-14,"volume",["<meter>","<meter>","<meter>"]],"<bushel>":[["bu","bsh","bushel","bushels"],.035239072,"volume",["<meter>","<meter>","<meter>"]],"<oilbarrel>":[["bbl","oilbarrel","oilbarrels","oil-barrel","oil-barrels"],.158987294928,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel>":[["bl","bl-us","beerbarrel","beerbarrels","beer-barrel","beer-barrels"],.1173477658,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel-imp>":[["blimp","bl-imp","beerbarrel-imp","beerbarrels-imp","beer-barrel-imp","beer-barrels-imp"],.16365924,"volume",["<meter>","<meter>","<meter>"]],"<kph>":[["kph"],.277777778,"speed",["<meter>"],["<second>"]],"<mph>":[["mph"],.44704,"speed",["<meter>"],["<second>"]],"<knot>":[["kt","kn","kts","knot","knots"],.514444444,"speed",["<meter>"],["<second>"]],"<fps>":[["fps"],.3048,"speed",["<meter>"],["<second>"]],"<gee>":[["gee"],9.80665,"acceleration",["<meter>"],["<second>","<second>"]],"<Gal>":[["Gal"],.01,"acceleration",["<meter>"],["<second>","<second>"]],"<kelvin>":[["degK","kelvin"],1,"temperature",["<kelvin>"]],"<celsius>":[["degC","celsius","celsius","centigrade"],1,"temperature",["<kelvin>"]],"<fahrenheit>":[["degF","fahrenheit"],5/9,"temperature",["<kelvin>"]],"<rankine>":[["degR","rankine"],5/9,"temperature",["<kelvin>"]],"<temp-K>":[["tempK","temp-K"],1,"temperature",["<temp-K>"]],"<temp-C>":[["tempC","temp-C"],1,"temperature",["<temp-K>"]],"<temp-F>":[["tempF","temp-F"],5/9,"temperature",["<temp-K>"]],"<temp-R>":[["tempR","temp-R"],5/9,"temperature",["<temp-K>"]],"<second>":[["s","sec","secs","second","seconds"],1,"time",["<second>"]],"<minute>":[["min","mins","minute","minutes"],60,"time",["<second>"]],"<hour>":[["h","hr","hrs","hour","hours"],3600,"time",["<second>"]],"<day>":[["d","day","days"],3600*24,"time",["<second>"]],"<week>":[["wk","week","weeks"],7*3600*24,"time",["<second>"]],"<fortnight>":[["fortnight","fortnights"],1209600,"time",["<second>"]],"<year>":[["y","yr","year","years","annum"],31556926,"time",["<second>"]],"<decade>":[["decade","decades"],315569260,"time",["<second>"]],"<century>":[["century","centuries"],3155692600,"time",["<second>"]],"<pascal>":[["Pa","pascal","Pascal"],1,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<bar>":[["bar","bars"],1e5,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<mmHg>":[["mmHg"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inHg>":[["inHg"],3386.3881472,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<torr>":[["torr"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<atm>":[["atm","ATM","atmosphere","atmospheres"],101325,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<psi>":[["psi"],6894.76,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<cmh2o>":[["cmH2O","cmh2o"],98.0638,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inh2o>":[["inH2O","inh2o"],249.082052,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<poise>":[["P","poise"],.1,"viscosity",["<kilogram>"],["<meter>","<second>"]],"<stokes>":[["St","stokes"],1e-4,"viscosity",["<meter>","<meter>"],["<second>"]],"<mole>":[["mol","mole"],1,"substance",["<mole>"]],"<molar>":[["M","molar"],1e3,"concentration",["<mole>"],["<meter>","<meter>","<meter>"]],"<wtpercent>":[["wt%","wtpercent"],10,"concentration",["<kilogram>"],["<meter>","<meter>","<meter>"]],"<katal>":[["kat","katal","Katal"],1,"activity",["<mole>"],["<second>"]],"<unit>":[["U","enzUnit","unit"],16667e-19,"activity",["<mole>"],["<second>"]],"<farad>":[["F","farad","Farad"],1,"capacitance",["<second>","<second>","<second>","<second>","<ampere>","<ampere>"],["<meter>","<meter>","<kilogram>"]],"<coulomb>":[["C","coulomb","Coulomb"],1,"charge",["<ampere>","<second>"]],"<Ah>":[["Ah"],3600,"charge",["<ampere>","<second>"]],"<ampere>":[["A","Ampere","ampere","amp","amps"],1,"current",["<ampere>"]],"<siemens>":[["S","Siemens","siemens"],1,"conductance",["<second>","<second>","<second>","<ampere>","<ampere>"],["<kilogram>","<meter>","<meter>"]],"<henry>":[["H","Henry","henry"],1,"inductance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>","<ampere>"]],"<volt>":[["V","Volt","volt","volts"],1,"potential",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>"]],"<ohm>":[["Ohm","ohm","\u03A9","\u2126"],1,"resistance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>","<ampere>"]],"<weber>":[["Wb","weber","webers"],1,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<tesla>":[["T","tesla","teslas"],1,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<gauss>":[["G","gauss"],1e-4,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<maxwell>":[["Mx","maxwell","maxwells"],1e-8,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<oersted>":[["Oe","oersted","oersteds"],250/Math.PI,"magnetism",["<ampere>"],["<meter>"]],"<joule>":[["J","joule","Joule","joules"],1,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<erg>":[["erg","ergs"],1e-7,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<btu>":[["BTU","btu","BTUs"],1055.056,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<calorie>":[["cal","calorie","calories"],4.184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Calorie>":[["Cal","Calorie","Calories"],4184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<therm-US>":[["th","therm","therms","Therm","therm-US"],105480400,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Wh>":[["Wh"],3600,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<newton>":[["N","Newton","newton"],1,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<dyne>":[["dyn","dyne"],1e-5,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<pound-force>":[["lbf","pound-force"],4.448222,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<hertz>":[["Hz","hertz","Hertz"],1,"frequency",["<1>"],["<second>"]],"<radian>":[["rad","radian","radians"],1,"angle",["<radian>"]],"<degree>":[["deg","degree","degrees"],Math.PI/180,"angle",["<radian>"]],"<gradian>":[["gon","grad","gradian","grads"],Math.PI/200,"angle",["<radian>"]],"<steradian>":[["sr","steradian","steradians"],1,"solid_angle",["<steradian>"]],"<rotation>":[["rotation"],2*Math.PI,"angle",["<radian>"]],"<rpm>":[["rpm"],2*Math.PI/60,"angular_velocity",["<radian>"],["<second>"]],"<byte>":[["B","byte","bytes"],1,"information",["<byte>"]],"<bit>":[["b","bit","bits"],.125,"information",["<byte>"]],"<Bps>":[["Bps"],1,"information_rate",["<byte>"],["<second>"]],"<bps>":[["bps"],.125,"information_rate",["<byte>"],["<second>"]],"<dollar>":[["USD","dollar"],1,"currency",["<dollar>"]],"<cents>":[["cents"],.01,"currency",["<dollar>"]],"<candela>":[["cd","candela"],1,"luminosity",["<candela>"]],"<lumen>":[["lm","lumen"],1,"luminous_power",["<candela>","<steradian>"]],"<lux>":[["lux"],1,"illuminance",["<candela>","<steradian>"],["<meter>","<meter>"]],"<watt>":[["W","watt","watts"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere>":[["VA","volt-ampere"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere-reactive>":[["var","Var","VAr","VAR","volt-ampere-reactive"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<horsepower>":[["hp","horsepower"],745.699872,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<gray>":[["Gy","gray","grays"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<roentgen>":[["R","roentgen"],.00933,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<sievert>":[["Sv","sievert","sieverts"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<becquerel>":[["Bq","becquerel","becquerels"],1,"radiation",["<1>"],["<second>"]],"<curie>":[["Ci","curie","curies"],37e9,"radiation",["<1>"],["<second>"]],"<cpm>":[["cpm"],1/60,"rate",["<count>"],["<second>"]],"<dpm>":[["dpm"],1/60,"rate",["<count>"],["<second>"]],"<bpm>":[["bpm"],1/60,"rate",["<count>"],["<second>"]],"<dot>":[["dot","dots"],1,"resolution",["<each>"]],"<pixel>":[["pixel","px"],1,"resolution",["<each>"]],"<ppi>":[["ppi"],1,"resolution",["<pixel>"],["<inch>"]],"<dpi>":[["dpi"],1,"typography",["<dot>"],["<inch>"]],"<cell>":[["cells","cell"],1,"counting",["<each>"]],"<each>":[["each"],1,"counting",["<each>"]],"<count>":[["count"],1,"counting",["<each>"]],"<base-pair>":[["bp","base-pair"],1,"counting",["<each>"]],"<nucleotide>":[["nt","nucleotide"],1,"counting",["<each>"]],"<molecule>":[["molecule","molecules"],1,"counting",["<1>"]],"<dozen>":[["doz","dz","dozen"],12,"prefix_only",["<each>"]],"<percent>":[["%","percent"],.01,"prefix_only",["<1>"]],"<ppm>":[["ppm"],1e-6,"prefix_only",["<1>"]],"<ppt>":[["ppt"],1e-9,"prefix_only",["<1>"]],"<gross>":[["gr","gross"],144,"prefix_only",["<dozen>","<dozen>"]],"<decibel>":[["dB","decibel","decibels"],1,"logarithmic",["<decibel>"]]},K=["<meter>","<kilogram>","<second>","<mole>","<ampere>","<radian>","<kelvin>","<temp-K>","<byte>","<dollar>","<candela>","<each>","<steradian>","<decibel>"],q="<1>",oe=[q];function W(ye,qe){var at=qe[1],ne=qe[3]||[],H=qe[4]||[];if(!u(at))throw new D(ye+": Invalid unit definition. 'scalar' must be a number");ne.forEach(function(te){if(X[te]===void 0)throw new D(ye+": Invalid unit definition. Unit "+te+" in 'numerator' is not recognized")}),H.forEach(function(te){if(X[te]===void 0)throw new D(ye+": Invalid unit definition. Unit "+te+" in 'denominator' is not recognized")})}var Y={},J={},Ee={},xe={},se={};for(var ce in X)if(X.hasOwnProperty(ce)){var ee=X[ce];if(ee[2]==="prefix"){Y[ce]=ee[1];for(var he=0;he<ee[0].length;he++)J[ee[0][he]]=ce}else{W(ce,ee),Ee[ce]={scalar:ee[1],numerator:ee[3],denominator:ee[4]};for(var Ie=0;Ie<ee[0].length;Ie++)xe[ee[0][Ie]]=ce}se[ce]=ee[0][0]}function Pe(ye){var qe,at=[],ne=Object.keys(X);if(typeof ye>"u")for(qe=0;qe<ne.length;qe++)["","prefix"].indexOf(X[ne[qe]][2])===-1&&at.push(ne[qe].substr(1,ne[qe].length-2));else{if(this.getKinds().indexOf(ye)===-1)throw new D("Kind not recognized");for(qe=0;qe<ne.length;qe++)X[ne[qe]][2]===ye&&at.push(ne[qe].substr(1,ne[qe].length-2))}return at.sort(function(H,te){return H.toLowerCase()<te.toLowerCase()?-1:H.toLowerCase()>te.toLowerCase()?1:0})}function Qe(ye){if(!xe[ye])throw new D("Unit not recognized");return X[xe[ye]][0]}var We=["length","time","temperature","mass","current","substance","luminosity","currency","information","angle"];function Zt(){if(this.signature)return this.signature;for(var ye=ti.call(this),qe=0;qe<ye.length;qe++)ye[qe]*=Math.pow(20,qe);return ye.reduce(function(at,ne){return at+ne},0)}function ti(){if(!this.isBase())return ti.call(this.toBase());for(var ye=new Array(We.length),qe=0;qe<ye.length;qe++)ye[qe]=0;for(var at,ne,H=0;H<this.numerator.length;H++)(at=X[this.numerator[H]])&&(ne=We.indexOf(at[2]),ne>=0&&(ye[ne]=ye[ne]+1));for(var te=0;te<this.denominator.length;te++)(at=X[this.denominator[te]])&&(ne=We.indexOf(at[2]),ne>=0&&(ye[ne]=ye[ne]-1));return ye}var $t="[+-]",oi="\\d+",je=$t+"?"+oi,_t="\\."+oi,Bt="(?:"+oi+"(?:"+_t+")?)|(?:"+_t+")",dt="[Ee]"+je,At="(?:"+Bt+")(?:"+dt+")?",Tt=$t+"?\\s*"+At,Dt="("+Tt+")?\\s*([^/]*)(?:/(.+))?",Ct=new RegExp("^"+Dt+"$"),pi="\\^|\\*{2}",yt="[01234]",vi=new RegExp("([^ \\*\\d]+?)(?:"+pi+")?(-?"+yt+"(?![a-zA-Z]))"),$i=new RegExp("([^ \\*\\d]+?)(?:"+pi+")?("+yt+"(?![a-zA-Z]))");function yi(ye){n(ye)||(ye=ye.toString()),ye=ye.trim();var qe=Ct.exec(ye);if(!qe)throw new D(ye+": Quantity not recognized");var at=qe[1];at?(at=at.replace(/\s/g,""),this.scalar=parseFloat(at)):this.scalar=1;for(var ne=qe[2],H=qe[3],te,pe,we;qe=vi.exec(ne);){if(te=parseFloat(qe[2]),isNaN(te))throw new D("Unit exponent is not a number");if(te===0&&!Pi.test(qe[1]))throw new D("Unit not recognized");pe=qe[1]+" ",we="";for(var ke=0;ke<Math.abs(te);ke++)we+=pe;te>=0?ne=ne.replace(qe[0],we):(H=H?H+we:we,ne=ne.replace(qe[0],""))}for(;qe=$i.exec(H);){if(te=parseFloat(qe[2]),isNaN(te))throw new D("Unit exponent is not a number");if(te===0&&!Pi.test(qe[1]))throw new D("Unit not recognized");pe=qe[1]+" ",we="";for(var $e=0;$e<te;$e++)we+=pe;H=H.replace(qe[0],we)}ne&&(this.numerator=Gt(ne.trim())),H&&(this.denominator=Gt(H.trim()))}var mi=Object.keys(J).sort(function(ye,qe){return qe.length-ye.length}).join("|"),It=Object.keys(xe).sort(function(ye,qe){return qe.length-ye.length}).join("|"),kt="\\b|$",Ri="("+mi+")??("+It+")(?:"+kt+")",Pi=new RegExp("^\\s*("+Ri+"[\\s\\*]*)+$"),zi=new RegExp(Ri,"g"),ht={};function Gt(ye){var qe=ht[ye];if(qe)return qe;var at,ne=[];if(!Pi.test(ye))throw new D("Unit not recognized");for(;at=zi.exec(ye);)ne.push(at.slice(1));return ne=ne.map(function(H){return J[H[0]]?[J[H[0]],xe[H[1]]]:[xe[H[1]]]}),ne=ne.reduce(function(H,te){return H.concat(te)},[]),ne=ne.filter(function(H){return H}),ht[ye]=ne,ne}function di(ye){if(!n(ye))throw new D("Argument should be a string");try{return this(ye)}catch{return null}}function si(ye){return ye instanceof Ae}function Ae(ye,qe){if(xt.apply(null,arguments),!si(this))return new Ae(ye,qe);if(this.scalar=null,this.baseScalar=null,this.signature=null,this._conversionCache={},this.numerator=oe,this.denominator=oe,Xt(ye)?(this.scalar=ye.scalar,this.numerator=ye.numerator&&ye.numerator.length!==0?ye.numerator:oe,this.denominator=ye.denominator&&ye.denominator.length!==0?ye.denominator:oe):qe?(yi.call(this,qe),this.scalar=ye):yi.call(this,ye),this.denominator.join("*").indexOf("temp")>=0)throw new D("Cannot divide with temperatures");if(this.numerator.join("*").indexOf("temp")>=0){if(this.numerator.length>1)throw new D("Cannot multiply by temperatures");if(!o(this.denominator,oe))throw new D("Cannot divide with temperatures")}if(this.initValue=ye,Nt.call(this),this.isTemperature()&&this.baseScalar<0)throw new D("Temperatures must not be less than absolute zero")}Ae.prototype={constructor:Ae};function xt(ye,qe){if(qe){if(!(u(ye)&&n(qe)))throw new D("Only number accepted as initialization value when units are explicitly provided")}else if(!(n(ye)||u(ye)||si(ye)||Xt(ye)))throw new D("Only string, number or quantity accepted as single initialization value")}function Xt(ye){return ye&&typeof ye=="object"&&ye.hasOwnProperty("scalar")}function Nt(){if(this.baseScalar)return this.baseScalar;if(this.isBase())this.baseScalar=this.scalar,this.signature=Zt.call(this);else{var ye=this.toBase();this.baseScalar=ye.scalar,this.signature=ye.signature}}var Yt={"-312078":"elastance","-312058":"resistance","-312038":"inductance","-152058":"potential","-152040":"magnetism","-152038":"magnetism","-7997":"specific_volume","-79":"snap","-59":"jolt","-39":"acceleration","-38":"radiation","-20":"frequency","-19":"speed","-18":"viscosity","-17":"volumetric_flow","-1":"wavenumber",0:"unitless",1:"length",2:"area",3:"volume",20:"time",400:"temperature",7941:"yank",7942:"power",7959:"pressure",7961:"force",7962:"energy",7979:"viscosity",7981:"momentum",7982:"angular_momentum",7997:"density",7998:"area_density",8e3:"mass",152020:"radiation_exposure",159999:"magnetism",16e4:"current",160020:"charge",312058:"conductance",312078:"capacitance",3199980:"activity",3199997:"molar_concentration",32e5:"substance",63999998:"illuminance",64e6:"luminous_power",128e7:"currency","25599999980":"information_rate","25600000000":"information","511999999980":"angular_velocity","512000000000":"angle"};function ii(){return _(Object.keys(Yt).map(function(ye){return Yt[ye]}))}Ae.prototype.kind=function(){return Yt[this.signature.toString()]},b(Ae.prototype,{isDegrees:function(){return(this.signature===null||this.signature===400)&&this.numerator.length===1&&o(this.denominator,oe)&&(this.numerator[0].match(/<temp-[CFRK]>/)||this.numerator[0].match(/<(kelvin|celsius|rankine|fahrenheit)>/))},isTemperature:function(){return this.isDegrees()&&this.numerator[0].match(/<temp-[CFRK]>/)}});function Rt(ye,qe){var at=ye.units(),ne=qe.to(at),H=Ae(Ii(at));return Ae({scalar:ye.scalar-ne.scalar,numerator:H.numerator,denominator:H.denominator})}function Kt(ye,qe){var at=qe.to(Ii(ye.units()));return Ae({scalar:ye.scalar-at.scalar,numerator:ye.numerator,denominator:ye.denominator})}function Li(ye,qe){var at=qe.to(Ii(ye.units()));return Ae({scalar:ye.scalar+at.scalar,numerator:ye.numerator,denominator:ye.denominator})}function Ii(ye){if(ye==="tempK")return"degK";if(ye==="tempC")return"degC";if(ye==="tempF")return"degF";if(ye==="tempR")return"degR";throw new D("Unknown type for temp conversion from: "+ye)}function Fi(ye,qe){var at=Xi(ye),ne=qe.units(),H;if(ne==="degK")H=at.scalar;else if(ne==="degC")H=at.scalar;else if(ne==="degF")H=at.scalar*9/5;else if(ne==="degR")H=at.scalar*9/5;else throw new D("Unknown type for degree conversion to: "+ne);return Ae({scalar:H,numerator:qe.numerator,denominator:qe.denominator})}function Xi(ye){var qe=ye.units(),at;if(qe.match(/(deg)[CFRK]/))at=ye.baseScalar;else if(qe==="tempK")at=ye.scalar;else if(qe==="tempC")at=ye.scalar;else if(qe==="tempF")at=ye.scalar*5/9;else if(qe==="tempR")at=ye.scalar*5/9;else throw new D("Unknown type for temp conversion from: "+qe);return Ae({scalar:at,numerator:["<kelvin>"],denominator:oe})}function rr(ye,qe){var at=qe.units(),ne;if(at==="tempK")ne=ye.baseScalar;else if(at==="tempC")ne=ye.baseScalar-273.15;else if(at==="tempF")ne=ye.baseScalar*9/5-459.67;else if(at==="tempR")ne=ye.baseScalar*9/5;else throw new D("Unknown type for temp conversion to: "+at);return Ae({scalar:ne,numerator:qe.numerator,denominator:qe.denominator})}function Ki(ye){var qe=ye.units(),at;if(qe.match(/(deg)[CFRK]/))at=ye.baseScalar;else if(qe==="tempK")at=ye.scalar;else if(qe==="tempC")at=ye.scalar+273.15;else if(qe==="tempF")at=(ye.scalar+459.67)*5/9;else if(qe==="tempR")at=ye.scalar*5/9;else throw new D("Unknown type for temp conversion from: "+qe);return Ae({scalar:at,numerator:["<temp-K>"],denominator:oe})}b(Ae.prototype,{to:function(ye){var qe,at;if(ye==null)return this;if(!n(ye))return this.to(ye.units());if(qe=this._conversionCache[ye],qe)return qe;if(at=Ae(ye),at.units()===this.units())return this;if(!this.isCompatible(at))this.isInverse(at)?at=this.inverse().to(ye):U(this.units(),at.units());else if(at.isTemperature())at=rr(this,at);else if(at.isDegrees())at=Fi(this,at);else{var ne=M(this.baseScalar,at.baseScalar);at=Ae({scalar:ne,numerator:at.numerator,denominator:at.denominator})}return this._conversionCache[ye]=at,at},toBase:function(){if(this.isBase())return this;if(this.isTemperature())return Ki(this);var ye=Ir[this.units()];return ye||(ye=mn(this.numerator,this.denominator),Ir[this.units()]=ye),ye.mul(this.scalar)},toFloat:function(){if(this.isUnitless())return this.scalar;throw new D("Can't convert to Float unless unitless.  Use Unit#scalar")},toPrec:function(ye){if(n(ye)&&(ye=Ae(ye)),u(ye)&&(ye=Ae(ye+" "+this.units())),this.isUnitless()?ye.isUnitless()||U(this.units(),ye.units()):ye=ye.to(this.units()),ye.scalar===0)throw new D("Divide by zero");var qe=E(Math.round(this.scalar/ye.scalar),ye.scalar);return Ae(qe+this.units())}});function Ci(ye,qe){var at=Ae(ye),ne=Ae(qe);if(at.eq(ne))return f;var H;return at.isTemperature()?H=function(te){return at.mul(te).to(ne).scalar}:H=function(te){return te*at.baseScalar/ne.baseScalar},function(pe){var we,ke,$e;if(Array.isArray(pe)){for(ke=pe.length,$e=[],we=0;we<ke;we++)$e.push(H(pe[we]));return $e}else return H(pe)}}var Ir={};function mn(ye,qe){for(var at=[],ne=[],H=1,te,pe=0;pe<ye.length;pe++)te=ye[pe],Y[te]?H=E(H,Y[te]):Ee[te]&&(H*=Ee[te].scalar,Ee[te].numerator&&at.push(Ee[te].numerator),Ee[te].denominator&&ne.push(Ee[te].denominator));for(var we=0;we<qe.length;we++)te=qe[we],Y[te]?H/=Y[te]:Ee[te]&&(H/=Ee[te].scalar,Ee[te].numerator&&ne.push(Ee[te].numerator),Ee[te].denominator&&at.push(Ee[te].denominator));return at=at.reduce(function(ke,$e){return ke.concat($e)},[]),ne=ne.reduce(function(ke,$e){return ke.concat($e)},[]),Ae({scalar:H,numerator:at,denominator:ne})}Ae.parse=di,Ae.getUnits=Pe,Ae.getAliases=Qe,Ae.mulSafe=E,Ae.divSafe=M,Ae.getKinds=ii,Ae.swiftConverter=Ci,Ae.Error=D,b(Ae.prototype,{add:function(ye){if(n(ye)&&(ye=Ae(ye)),this.isCompatible(ye)||U(this.units(),ye.units()),this.isTemperature()&&ye.isTemperature())throw new D("Cannot add two temperatures");return this.isTemperature()?Li(this,ye):ye.isTemperature()?Li(ye,this):Ae({scalar:this.scalar+ye.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},sub:function(ye){if(n(ye)&&(ye=Ae(ye)),this.isCompatible(ye)||U(this.units(),ye.units()),this.isTemperature()&&ye.isTemperature())return Rt(this,ye);if(this.isTemperature())return Kt(this,ye);if(ye.isTemperature())throw new D("Cannot subtract a temperature from a differential degree unit");return Ae({scalar:this.scalar-ye.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},mul:function(ye){if(u(ye))return Ae({scalar:E(this.scalar,ye),numerator:this.numerator,denominator:this.denominator});if(n(ye)&&(ye=Ae(ye)),(this.isTemperature()||ye.isTemperature())&&!(this.isUnitless()||ye.isUnitless()))throw new D("Cannot multiply by temperatures");var qe=this,at=ye;qe.isCompatible(at)&&qe.signature!==400&&(at=at.to(qe));var ne=gn(qe.numerator,qe.denominator,at.numerator,at.denominator);return Ae({scalar:E(qe.scalar,at.scalar,ne[2]),numerator:ne[0],denominator:ne[1]})},div:function(ye){if(u(ye)){if(ye===0)throw new D("Divide by zero");return Ae({scalar:this.scalar/ye,numerator:this.numerator,denominator:this.denominator})}else n(ye)&&(ye=Ae(ye));if(ye.scalar===0)throw new D("Divide by zero");if(ye.isTemperature())throw new D("Cannot divide with temperatures");if(this.isTemperature()&&!ye.isUnitless())throw new D("Cannot divide with temperatures");var qe=this,at=ye;qe.isCompatible(at)&&qe.signature!==400&&(at=at.to(qe));var ne=gn(qe.numerator,qe.denominator,at.denominator,at.numerator);return Ae({scalar:E(qe.scalar,ne[2])/at.scalar,numerator:ne[0],denominator:ne[1]})},inverse:function(){if(this.isTemperature())throw new D("Cannot divide with temperatures");if(this.scalar===0)throw new D("Divide by zero");return Ae({scalar:1/this.scalar,numerator:this.denominator,denominator:this.numerator})}});function gn(ye,qe,at,ne){function H(ut){return ut!==q}ye=ye.filter(H),at=at.filter(H),qe=qe.filter(H),ne=ne.filter(H);var te={};function pe(ut,Ut){for(var ft,bi,wi,gi=0;gi<ut.length;gi++)if(Y[ut[gi]]?(ft=ut[gi+1],bi=ut[gi],wi=Y[bi],gi++):(ft=ut[gi],bi=null,wi=1),ft&&ft!==q)if(te[ft]){te[ft][0]+=Ut;var Di=te[ft][2]?Y[te[ft][2]]:1;te[ft][Ut===1?3:4]*=M(wi,Di)}else te[ft]=[Ut,ft,bi,1,1]}pe(ye,1),pe(qe,-1),pe(at,1),pe(ne,-1);var we=[],ke=[],$e=1;for(var Ge in te)if(te.hasOwnProperty(Ge)){var De=te[Ge],Ze;if(De[0]>0)for(Ze=0;Ze<De[0];Ze++)we.push(De[2]===null?De[1]:[De[2],De[1]]);else if(De[0]<0)for(Ze=0;Ze<-De[0];Ze++)ke.push(De[2]===null?De[1]:[De[2],De[1]]);$e*=M(De[3],De[4])}return we.length===0&&(we=oe),ke.length===0&&(ke=oe),we=we.reduce(function(ut,Ut){return ut.concat(Ut)},[]),ke=ke.reduce(function(ut,Ut){return ut.concat(Ut)},[]),[we,ke,$e]}b(Ae.prototype,{eq:function(ye){return this.compareTo(ye)===0},lt:function(ye){return this.compareTo(ye)===-1},lte:function(ye){return this.eq(ye)||this.lt(ye)},gt:function(ye){return this.compareTo(ye)===1},gte:function(ye){return this.eq(ye)||this.gt(ye)},compareTo:function(ye){if(n(ye))return this.compareTo(Ae(ye));if(this.isCompatible(ye)||U(this.units(),ye.units()),this.baseScalar<ye.baseScalar)return-1;if(this.baseScalar===ye.baseScalar)return 0;if(this.baseScalar>ye.baseScalar)return 1},same:function(ye){return this.scalar===ye.scalar&&this.units()===ye.units()}}),b(Ae.prototype,{isUnitless:function(){return[this.numerator,this.denominator].every(function(ye){return o(ye,oe)})},isCompatible:function(ye){return n(ye)?this.isCompatible(Ae(ye)):si(ye)&&ye.signature!==void 0?this.signature===ye.signature:!1},isInverse:function(ye){return this.inverse().isCompatible(ye)},isBase:function(){return this._isBase!==void 0?this._isBase:this.isDegrees()&&this.numerator[0].match(/<(kelvin|temp-K)>/)?(this._isBase=!0,this._isBase):(this.numerator.concat(this.denominator).forEach(function(ye){ye!==q&&K.indexOf(ye)===-1&&(this._isBase=!1)},this),this._isBase===!1?this._isBase:(this._isBase=!0,this._isBase))}});function Er(){}Er.prototype.get=function(ye){return arguments.length>1&&(ye=Array.apply(null,arguments)),ye.reduce(function(qe,at,ne){if(qe){var H=qe[at];return ne===ye.length-1?H?H.data:void 0:H}},this)},Er.prototype.set=function(ye,qe){return arguments.length>2&&(ye=Array.prototype.slice.call(arguments,0,-1),qe=arguments[arguments.length-1]),ye.reduce(function(at,ne,H){var te=at[ne];return te===void 0&&(te=at[ne]={}),H===ye.length-1?(te.data=qe,qe):te},this)};function un(ye,qe){return(ye+" "+qe).trim()}Ae.formatter=un,b(Ae.prototype,{units:function(){if(this._units!==void 0)return this._units;var ye=o(this.numerator,oe),qe=o(this.denominator,oe);if(ye&&qe)return this._units="",this._units;var at=Jr(this.numerator),ne=Jr(this.denominator);return this._units=at+(qe?"":"/"+ne),this._units},toString:function(ye,qe){var at;if(u(ye))at=this.units(),qe=ye;else if(n(ye))at=ye;else if(si(ye))return this.toPrec(ye).toString(qe);var ne=this.to(at),H=qe!==void 0?P(ne.scalar,qe):ne.scalar;return ne=(H+" "+ne.units()).trim(),ne},format:function(ye,qe){arguments.length===1&&typeof ye=="function"&&(qe=ye,ye=void 0),qe=qe||Ae.formatter;var at=this.to(ye);return qe.call(this,at.scalar,at.units())}});var ar=new Er;function Jr(ye){var qe=ar.get(ye);if(qe)return qe;var at=o(ye,oe);return at?qe="1":qe=kr(qr(ye)).join("*"),ar.set(ye,qe),qe}function qr(ye){for(var qe=[],at,ne,H=0;H<ye.length;H++)at=ye[H],ne=ye[H+1],Y[at]?(qe.push(se[at]+se[ne]),H++):qe.push(se[at]);return qe}function kr(ye){var qe=ye.reduce(function(at,ne){var H=at[ne];return H||at.push(H=at[ne]=[ne,0]),H[1]++,at},[]);return qe.map(function(at){return at[0]+(at[1]>1?at[1]:"")})}return Ae.version="1.7.6",Ae})})(quantities);var Qty=quantities.exports;function deepValue(e,r=""){let n=r.split(".");for(let a of n){if(e[a]===void 0)return;e=e[a]}return e}var orientation={exports:{}},twoProduct_1=twoProduct$1,SPLITTER=+(Math.pow(2,27)+1);function twoProduct$1(e,r,n){var a=e*r,u=SPLITTER*e,f=u-e,_=u-f,o=e-_,b=SPLITTER*r,E=b-r,M=b-E,P=r-M,L=a-_*M,D=L-o*M,U=D-_*P,X=o*P-U;return n?(n[0]=X,n[1]=a,n):[X,a]}var robustSum=linearExpansionSum;function scalarScalar$1(e,r){var n=e+r,a=n-e,u=n-a,f=r-a,_=e-u,o=_+f;return o?[o,n]:[n]}function linearExpansionSum(e,r){var n=e.length|0,a=r.length|0;if(n===1&&a===1)return scalarScalar$1(e[0],r[0]);var u=n+a,f=new Array(u),_=0,o=0,b=0,E=Math.abs,M=e[o],P=E(M),L=r[b],D=E(L),U,X;P<D?(X=M,o+=1,o<n&&(M=e[o],P=E(M))):(X=L,b+=1,b<a&&(L=r[b],D=E(L))),o<n&&P<D||b>=a?(U=M,o+=1,o<n&&(M=e[o],P=E(M))):(U=L,b+=1,b<a&&(L=r[b],D=E(L)));for(var K=U+X,q=K-U,oe=X-q,W=oe,Y=K,J,Ee,xe,se,ce;o<n&&b<a;)P<D?(U=M,o+=1,o<n&&(M=e[o],P=E(M))):(U=L,b+=1,b<a&&(L=r[b],D=E(L))),X=W,K=U+X,q=K-U,oe=X-q,oe&&(f[_++]=oe),J=Y+K,Ee=J-Y,xe=J-Ee,se=K-Ee,ce=Y-xe,W=ce+se,Y=J;for(;o<n;)U=M,X=W,K=U+X,q=K-U,oe=X-q,oe&&(f[_++]=oe),J=Y+K,Ee=J-Y,xe=J-Ee,se=K-Ee,ce=Y-xe,W=ce+se,Y=J,o+=1,o<n&&(M=e[o]);for(;b<a;)U=L,X=W,K=U+X,q=K-U,oe=X-q,oe&&(f[_++]=oe),J=Y+K,Ee=J-Y,xe=J-Ee,se=K-Ee,ce=Y-xe,W=ce+se,Y=J,b+=1,b<a&&(L=r[b]);return W&&(f[_++]=W),Y&&(f[_++]=Y),_||(f[_++]=0),f.length=_,f}var twoSum$1=fastTwoSum;function fastTwoSum(e,r,n){var a=e+r,u=a-e,f=a-u,_=r-u,o=e-f;return n?(n[0]=o+_,n[1]=a,n):[o+_,a]}var twoProduct=twoProduct_1,twoSum=twoSum$1,robustScale=scaleLinearExpansion;function scaleLinearExpansion(e,r){var n=e.length;if(n===1){var a=twoProduct(e[0],r);return a[0]?a:[a[1]]}var u=new Array(2*n),f=[.1,.1],_=[.1,.1],o=0;twoProduct(e[0],r,f),f[0]&&(u[o++]=f[0]);for(var b=1;b<n;++b){twoProduct(e[b],r,_);var E=f[1];twoSum(E,_[0],f),f[0]&&(u[o++]=f[0]);var M=_[1],P=f[1],L=M+P,D=L-M,U=P-D;f[1]=L,U&&(u[o++]=U)}return f[1]&&(u[o++]=f[1]),o===0&&(u[o++]=0),u.length=o,u}var robustDiff=robustSubtract;function scalarScalar(e,r){var n=e+r,a=n-e,u=n-a,f=r-a,_=e-u,o=_+f;return o?[o,n]:[n]}function robustSubtract(e,r){var n=e.length|0,a=r.length|0;if(n===1&&a===1)return scalarScalar(e[0],-r[0]);var u=n+a,f=new Array(u),_=0,o=0,b=0,E=Math.abs,M=e[o],P=E(M),L=-r[b],D=E(L),U,X;P<D?(X=M,o+=1,o<n&&(M=e[o],P=E(M))):(X=L,b+=1,b<a&&(L=-r[b],D=E(L))),o<n&&P<D||b>=a?(U=M,o+=1,o<n&&(M=e[o],P=E(M))):(U=L,b+=1,b<a&&(L=-r[b],D=E(L)));for(var K=U+X,q=K-U,oe=X-q,W=oe,Y=K,J,Ee,xe,se,ce;o<n&&b<a;)P<D?(U=M,o+=1,o<n&&(M=e[o],P=E(M))):(U=L,b+=1,b<a&&(L=-r[b],D=E(L))),X=W,K=U+X,q=K-U,oe=X-q,oe&&(f[_++]=oe),J=Y+K,Ee=J-Y,xe=J-Ee,se=K-Ee,ce=Y-xe,W=ce+se,Y=J;for(;o<n;)U=M,X=W,K=U+X,q=K-U,oe=X-q,oe&&(f[_++]=oe),J=Y+K,Ee=J-Y,xe=J-Ee,se=K-Ee,ce=Y-xe,W=ce+se,Y=J,o+=1,o<n&&(M=e[o]);for(;b<a;)U=L,X=W,K=U+X,q=K-U,oe=X-q,oe&&(f[_++]=oe),J=Y+K,Ee=J-Y,xe=J-Ee,se=K-Ee,ce=Y-xe,W=ce+se,Y=J,b+=1,b<a&&(L=-r[b]);return W&&(f[_++]=W),Y&&(f[_++]=Y),_||(f[_++]=0),f.length=_,f}(function(e){var r=twoProduct_1,n=robustSum,a=robustScale,u=robustDiff,f=5,_=11102230246251565e-32,o=(3+16*_)*_,b=(7+56*_)*_;function E(W,Y,J,Ee){return function(se,ce,ee){var he=W(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),W(Y(se[1],ce[0]),Y(-ce[1],se[0]))),Ie=W(Y(se[1],ee[0]),Y(-ee[1],se[0])),Pe=Ee(he,Ie);return Pe[Pe.length-1]}}function M(W,Y,J,Ee){return function(se,ce,ee,he){var Ie=W(W(J(W(Y(ee[1],he[0]),Y(-he[1],ee[0])),ce[2]),W(J(W(Y(ce[1],he[0]),Y(-he[1],ce[0])),-ee[2]),J(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),he[2]))),W(J(W(Y(ce[1],he[0]),Y(-he[1],ce[0])),se[2]),W(J(W(Y(se[1],he[0]),Y(-he[1],se[0])),-ce[2]),J(W(Y(se[1],ce[0]),Y(-ce[1],se[0])),he[2])))),Pe=W(W(J(W(Y(ee[1],he[0]),Y(-he[1],ee[0])),se[2]),W(J(W(Y(se[1],he[0]),Y(-he[1],se[0])),-ee[2]),J(W(Y(se[1],ee[0]),Y(-ee[1],se[0])),he[2]))),W(J(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),se[2]),W(J(W(Y(se[1],ee[0]),Y(-ee[1],se[0])),-ce[2]),J(W(Y(se[1],ce[0]),Y(-ce[1],se[0])),ee[2])))),Qe=Ee(Ie,Pe);return Qe[Qe.length-1]}}function P(W,Y,J,Ee){return function(se,ce,ee,he,Ie){var Pe=W(W(W(J(W(J(W(Y(he[1],Ie[0]),Y(-Ie[1],he[0])),ee[2]),W(J(W(Y(ee[1],Ie[0]),Y(-Ie[1],ee[0])),-he[2]),J(W(Y(ee[1],he[0]),Y(-he[1],ee[0])),Ie[2]))),ce[3]),W(J(W(J(W(Y(he[1],Ie[0]),Y(-Ie[1],he[0])),ce[2]),W(J(W(Y(ce[1],Ie[0]),Y(-Ie[1],ce[0])),-he[2]),J(W(Y(ce[1],he[0]),Y(-he[1],ce[0])),Ie[2]))),-ee[3]),J(W(J(W(Y(ee[1],Ie[0]),Y(-Ie[1],ee[0])),ce[2]),W(J(W(Y(ce[1],Ie[0]),Y(-Ie[1],ce[0])),-ee[2]),J(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),Ie[2]))),he[3]))),W(J(W(J(W(Y(ee[1],he[0]),Y(-he[1],ee[0])),ce[2]),W(J(W(Y(ce[1],he[0]),Y(-he[1],ce[0])),-ee[2]),J(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),he[2]))),-Ie[3]),W(J(W(J(W(Y(he[1],Ie[0]),Y(-Ie[1],he[0])),ce[2]),W(J(W(Y(ce[1],Ie[0]),Y(-Ie[1],ce[0])),-he[2]),J(W(Y(ce[1],he[0]),Y(-he[1],ce[0])),Ie[2]))),se[3]),J(W(J(W(Y(he[1],Ie[0]),Y(-Ie[1],he[0])),se[2]),W(J(W(Y(se[1],Ie[0]),Y(-Ie[1],se[0])),-he[2]),J(W(Y(se[1],he[0]),Y(-he[1],se[0])),Ie[2]))),-ce[3])))),W(W(J(W(J(W(Y(ce[1],Ie[0]),Y(-Ie[1],ce[0])),se[2]),W(J(W(Y(se[1],Ie[0]),Y(-Ie[1],se[0])),-ce[2]),J(W(Y(se[1],ce[0]),Y(-ce[1],se[0])),Ie[2]))),he[3]),W(J(W(J(W(Y(ce[1],he[0]),Y(-he[1],ce[0])),se[2]),W(J(W(Y(se[1],he[0]),Y(-he[1],se[0])),-ce[2]),J(W(Y(se[1],ce[0]),Y(-ce[1],se[0])),he[2]))),-Ie[3]),J(W(J(W(Y(ee[1],he[0]),Y(-he[1],ee[0])),ce[2]),W(J(W(Y(ce[1],he[0]),Y(-he[1],ce[0])),-ee[2]),J(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),he[2]))),se[3]))),W(J(W(J(W(Y(ee[1],he[0]),Y(-he[1],ee[0])),se[2]),W(J(W(Y(se[1],he[0]),Y(-he[1],se[0])),-ee[2]),J(W(Y(se[1],ee[0]),Y(-ee[1],se[0])),he[2]))),-ce[3]),W(J(W(J(W(Y(ce[1],he[0]),Y(-he[1],ce[0])),se[2]),W(J(W(Y(se[1],he[0]),Y(-he[1],se[0])),-ce[2]),J(W(Y(se[1],ce[0]),Y(-ce[1],se[0])),he[2]))),ee[3]),J(W(J(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),se[2]),W(J(W(Y(se[1],ee[0]),Y(-ee[1],se[0])),-ce[2]),J(W(Y(se[1],ce[0]),Y(-ce[1],se[0])),ee[2]))),-he[3]))))),Qe=W(W(W(J(W(J(W(Y(he[1],Ie[0]),Y(-Ie[1],he[0])),ee[2]),W(J(W(Y(ee[1],Ie[0]),Y(-Ie[1],ee[0])),-he[2]),J(W(Y(ee[1],he[0]),Y(-he[1],ee[0])),Ie[2]))),se[3]),J(W(J(W(Y(he[1],Ie[0]),Y(-Ie[1],he[0])),se[2]),W(J(W(Y(se[1],Ie[0]),Y(-Ie[1],se[0])),-he[2]),J(W(Y(se[1],he[0]),Y(-he[1],se[0])),Ie[2]))),-ee[3])),W(J(W(J(W(Y(ee[1],Ie[0]),Y(-Ie[1],ee[0])),se[2]),W(J(W(Y(se[1],Ie[0]),Y(-Ie[1],se[0])),-ee[2]),J(W(Y(se[1],ee[0]),Y(-ee[1],se[0])),Ie[2]))),he[3]),J(W(J(W(Y(ee[1],he[0]),Y(-he[1],ee[0])),se[2]),W(J(W(Y(se[1],he[0]),Y(-he[1],se[0])),-ee[2]),J(W(Y(se[1],ee[0]),Y(-ee[1],se[0])),he[2]))),-Ie[3]))),W(W(J(W(J(W(Y(ee[1],Ie[0]),Y(-Ie[1],ee[0])),ce[2]),W(J(W(Y(ce[1],Ie[0]),Y(-Ie[1],ce[0])),-ee[2]),J(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),Ie[2]))),se[3]),J(W(J(W(Y(ee[1],Ie[0]),Y(-Ie[1],ee[0])),se[2]),W(J(W(Y(se[1],Ie[0]),Y(-Ie[1],se[0])),-ee[2]),J(W(Y(se[1],ee[0]),Y(-ee[1],se[0])),Ie[2]))),-ce[3])),W(J(W(J(W(Y(ce[1],Ie[0]),Y(-Ie[1],ce[0])),se[2]),W(J(W(Y(se[1],Ie[0]),Y(-Ie[1],se[0])),-ce[2]),J(W(Y(se[1],ce[0]),Y(-ce[1],se[0])),Ie[2]))),ee[3]),J(W(J(W(Y(ce[1],ee[0]),Y(-ee[1],ce[0])),se[2]),W(J(W(Y(se[1],ee[0]),Y(-ee[1],se[0])),-ce[2]),J(W(Y(se[1],ce[0]),Y(-ce[1],se[0])),ee[2]))),-Ie[3])))),We=Ee(Pe,Qe);return We[We.length-1]}}function L(W){var Y=W===3?E:W===4?M:P;return Y(n,r,a,u)}var D=L(3),U=L(4),X=[function(){return 0},function(){return 0},function(Y,J){return J[0]-Y[0]},function(Y,J,Ee){var xe=(Y[1]-Ee[1])*(J[0]-Ee[0]),se=(Y[0]-Ee[0])*(J[1]-Ee[1]),ce=xe-se,ee;if(xe>0){if(se<=0)return ce;ee=xe+se}else if(xe<0){if(se>=0)return ce;ee=-(xe+se)}else return ce;var he=o*ee;return ce>=he||ce<=-he?ce:D(Y,J,Ee)},function(Y,J,Ee,xe){var se=Y[0]-xe[0],ce=J[0]-xe[0],ee=Ee[0]-xe[0],he=Y[1]-xe[1],Ie=J[1]-xe[1],Pe=Ee[1]-xe[1],Qe=Y[2]-xe[2],We=J[2]-xe[2],Zt=Ee[2]-xe[2],ti=ce*Pe,$t=ee*Ie,oi=ee*he,je=se*Pe,_t=se*Ie,Bt=ce*he,dt=Qe*(ti-$t)+We*(oi-je)+Zt*(_t-Bt),At=(Math.abs(ti)+Math.abs($t))*Math.abs(Qe)+(Math.abs(oi)+Math.abs(je))*Math.abs(We)+(Math.abs(_t)+Math.abs(Bt))*Math.abs(Zt),Tt=b*At;return dt>Tt||-dt>Tt?dt:U(Y,J,Ee,xe)}];function K(W){var Y=X[W.length];return Y||(Y=X[W.length]=L(W.length)),Y.apply(void 0,W)}function q(W,Y,J,Ee,xe,se,ce){return function(he,Ie,Pe,Qe,We){switch(arguments.length){case 0:case 1:return 0;case 2:return Ee(he,Ie);case 3:return xe(he,Ie,Pe);case 4:return se(he,Ie,Pe,Qe);case 5:return ce(he,Ie,Pe,Qe,We)}for(var Zt=new Array(arguments.length),ti=0;ti<arguments.length;++ti)Zt[ti]=arguments[ti];return W(Zt)}}function oe(){for(;X.length<=f;)X.push(L(X.length));e.exports=q.apply(void 0,[K].concat(X));for(var W=0;W<=f;++W)e.exports[W]=X[W]}oe()})(orientation);var robustPnp=robustPointInPolygon,orient=orientation.exports;function robustPointInPolygon(e,r){for(var n=r[0],a=r[1],u=e.length,f=1,_=u,o=0,b=u-1;o<_;b=o++){var E=e[o],M=e[b],P=E[1],L=M[1];if(L<P){if(L<a&&a<P){var D=orient(E,M,r);if(D===0)return 0;f^=0<D|0}else if(a===P){var U=e[(o+1)%u],X=U[1];if(P<X){var D=orient(E,M,r);if(D===0)return 0;f^=0<D|0}}}else if(P<L){if(P<a&&a<L){var D=orient(E,M,r);if(D===0)return 0;f^=D<0|0}else if(a===P){var U=e[(o+1)%u],X=U[1];if(X<P){var D=orient(E,M,r);if(D===0)return 0;f^=D<0|0}}}else if(a===P){var K=Math.min(E[0],M[0]),q=Math.max(E[0],M[0]);if(o===0){for(;b>0;){var oe=(b+u-1)%u,W=e[oe];if(W[1]!==a)break;var Y=W[0];K=Math.min(K,Y),q=Math.max(q,Y),b=oe}if(b===0)return K<=n&&n<=q?0:1;_=b+1}for(var J=e[(b+u-1)%u][1];o+1<_;){var W=e[o+1];if(W[1]!==a)break;var Y=W[0];K=Math.min(K,Y),q=Math.max(q,Y),o+=1}if(K<=n&&n<=q)return 0;var Ee=e[(o+1)%u][1];n<K&&J<a!=Ee<a&&(f^=1)}}return 2*f-1}var robustPointInPolygon$1=robustPnp;function feretDiameters(e={}){const{originalPoints:r=monotoneChainConvexHull.call(this)}=e;if(r.length===0)return{min:0,max:0,minLine:[],maxLine:[],aspectRatio:1};if(r.length===1)return{min:1,max:1,minLine:[r[0],r[0]],maxLine:[r[0],r[0]],aspectRatio:1};const n=new Array(r.length);let a=1/0,u=0,f=[];for(let E=0;E<r.length;E++){let M=getAngle(r[E],r[(E+1)%r.length]);rotate(-M,r,n);let P=0,L=[];for(let D=0;D<r.length;D++){let U=Math.abs(n[E][1]-n[D][1]);U>P&&(P=U,L=[],L.push([n[D][0],n[E][1]],[n[D][0],n[D][1]]))}P<a&&(a=P,u=M,f=L)}rotate(u,f,f);let _=0,o=[],b=0;for(let E=0;E<r.length-1;E++)for(let M=E+1;M<r.length;M++){let P=(r[E][0]-r[M][0])**2+(r[E][1]-r[M][1])**2;P>b&&(b=P,_=Math.sqrt(P),o=[r[E],r[M]])}return{min:a,minLine:f,max:_,maxLine:o,aspectRatio:a/_}}function getAngle(e,r){let n=difference(r,e),a=normalize(n),u=Math.acos(a[0]);return a[1]<0?-u:u}class Roi{constructor(r,n){this.map=r,this.id=n,this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.meanX=0,this.meanY=0,this.surface=0,this.computed={}}getMask(r={}){const{scale:n=1,kind:a=""}=r;let u;switch(a){case"contour":u=this.contourMask;break;case"box":u=this.boxMask;break;case"filled":u=this.filledMask;break;case"center":u=this.centerMask;break;case"mbr":u=this.mbrFilledMask;break;case"hull":u=this.convexHullFilledMask;break;case"hullContour":u=this.convexHullMask;break;case"mbrContour":u=this.mbrMask;break;case"feret":u=this.feretMask;break;default:u=this.mask}return n<1&&(u=u.resize({factor:n}),u.parent=this.mask.parent,u.position[0]+=this.minX,u.position[1]+=this.minY),u}get mean(){throw new Error("Roi mean not implemented yet")}get center(){return this.computed.center||(this.computed.center=[this.width/2>>0,this.height/2>>0]),this.computed.center}get ratio(){return this.width/this.height}get width(){return this.maxX-this.minX+1}get height(){return this.maxY-this.minY+1}_computExternalIDs(){let r=this.borderIDs,n=this.borderLengths;this.computed.externalIDs=[],this.computed.externalLengths=[];let a=this.internalIDs;for(let u=0;u<r.length;u++)a.includes(r[u])||(this.computed.externalIDs.push(r[u]),this.computed.externalLengths.push(n[u]))}get externalIDs(){return this.computed.externalIDs?this.computed.externalIDs:(this._computExternalIDs(),this.computed.externalIDs)}get externalLengths(){return this.computed.externalLengths?this.computed.externalLengths:(this._computExternalIDs(),this.computed.externalLengths)}_computeBorderIDs(){let r=getBorders(this);this.computed.borderIDs=r.ids,this.computed.borderLengths=r.lengths}get borderIDs(){return this.computed.borderIDs?this.computed.borderIDs:(this._computeBorderIDs(),this.computed.borderIDs)}get borderLengths(){return this.computed.borderLengths?this.computed.borderLengths:(this._computeBorderIDs(),this.computed.borderLengths)}get boxIDs(){return this.computed.boxIDs||(this.computed.boxIDs=getBoxIDs(this)),this.computed.boxIDs}get internalIDs(){return this.computed.internalIDs||(this.computed.internalIDs=getInternalIDs(this)),this.computed.internalIDs}get box(){return this.computed.box||(this.computed.box=getBox(this)),this.computed.box}get external(){return this.computed.external||(this.computed.external=getExternal(this)),this.computed.external}get holesInfo(){return this.computed.holesInfo||(this.computed.holesInfo=getHolesInfo(this)),this.computed.holesInfo}get border(){return this.computed.border||(this.computed.border=getBorder(this)),this.computed.border}get contourMask(){if(!this.computed.contourMask){let r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let n=0;n<this.width;n++)for(let a=0;a<this.height;a++)this.map.data[n+this.minX+(a+this.minY)*this.map.width]===this.id&&(n>0&&n<this.width-1&&a>0&&a<this.height-1?(this.map.data[n-1+this.minX+(a+this.minY)*this.map.width]!==this.id||this.map.data[n+1+this.minX+(a+this.minY)*this.map.width]!==this.id||this.map.data[n+this.minX+(a-1+this.minY)*this.map.width]!==this.id||this.map.data[n+this.minX+(a+1+this.minY)*this.map.width]!==this.id)&&r.setBitXY(n,a):r.setBitXY(n,a));this.computed.contourMask=r}return this.computed.contourMask}get boxMask(){if(!this.computed.boxMask){let r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let n=0;n<this.width;n++)r.setBitXY(n,0),r.setBitXY(n,this.height-1);for(let n=0;n<this.height;n++)r.setBitXY(0,n),r.setBitXY(this.width-1,n);this.computed.boxMask=r}return this.computed.boxMask}get mask(){if(!this.computed.mask){let r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let n=0;n<this.width;n++)for(let a=0;a<this.height;a++)this.map.data[n+this.minX+(a+this.minY)*this.map.width]===this.id&&r.setBitXY(n,a);this.computed.mask=r}return this.computed.mask}get filledMask(){if(!this.computed.filledMask){let r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let n=0;n<this.width;n++)for(let a=0;a<this.height;a++){let u=n+this.minX+(a+this.minY)*this.map.width;this.internalIDs.includes(this.map.data[u])&&r.setBitXY(n,a)}this.computed.filledMask=r}return this.computed.filledMask}get centerMask(){if(!this.computed.centerMask){let r=new Shape({kind:"smallCross"}).getMask();r.parent=this.map.parent,r.position=[this.minX+this.center[0]-1,this.minY+this.center[1]-1],this.computed.centerMask=r}return this.computed.centerMask}get convexHull(){if(!this.computed.convexHull){const r=[];for(let a=0;a<this.width;a++)for(let u=0;u<this.height;u++)this.map.data[a+this.minX+(u+this.minY)*this.map.width]===this.id&&(a>0&&a<this.width-1&&u>0&&u<this.height-1?(this.map.data[a-1+this.minX+(u+this.minY)*this.map.width]!==this.id||this.map.data[a+1+this.minX+(u+this.minY)*this.map.width]!==this.id||this.map.data[a+this.minX+(u-1+this.minY)*this.map.width]!==this.id||this.map.data[a+this.minX+(u+1+this.minY)*this.map.width]!==this.id)&&(r.push([a,u]),r.push([a+1,u]),r.push([a,u+1]),r.push([a+1,u+1])):(r.push([a,u]),r.push([a+1,u]),r.push([a,u+1]),r.push([a+1,u+1])));const n=monotoneChainConvexHull$1(r);this.computed.convexHull={polyline:n,surface:surface(n),perimeter:perimeter(n)}}return this.computed.convexHull}get convexHullMask(){if(!this.computed.convexHullMask){const r=this.convexHull,n=new Image(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});n.paintPolyline(r.polyline,{closed:!0}),this.computed.convexHullMask=n}return this.computed.convexHullMask}get convexHullFilledMask(){if(!this.computed.convexHullFilledMask){const r=this.convexHull,n=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let a=0;a<this.width;a++)for(let u=0;u<this.height;u++)robustPointInPolygon$1(r.polyline,[a,u])!==1&&n.setBitXY(a,u);this.computed.convexHullFilledMask=n}return this.computed.convexHullFilledMask}get mbr(){if(!this.computed.mbr){let r=minimalBoundingRectangle({originalPoints:this.convexHull.polyline});if(r.length===0)this.computed.mbr={width:0,height:0,surface:0,perimeter:0,rectangle:r};else{let n=r[0],a=r[1],u=r[2],f=Math.sqrt((n[0]-a[0])**2+(n[1]-a[1])**2),_=Math.sqrt((u[0]-a[0])**2+(u[1]-a[1])**2);this.computed.mbr={width:f,height:_,elongation:1-f/_,aspectRatio:f/_,surface:f*_,perimeter:(f+_)*2,rectangle:r}}}return this.computed.mbr}get fillRatio(){return this.surface/(this.surface+this.holesInfo.surface)}get feretDiameters(){return this.computed.feretDiameters||(this.computed.feretDiameters=feretDiameters({originalPoints:this.convexHull.polyline})),this.computed.feretDiameters}get eqpc(){return this.computed.eqpc||(this.computed.eqpc=2*Math.sqrt(this.surface/Math.PI)),this.computed.eqpc}get perimeterInfo(){return this.computed.perimeterInfo||(this.computed.perimeterInfo=getPerimeterInfo(this)),this.computed.perimeterInfo}get perimeter(){let r=this.perimeterInfo,n=2-Math.sqrt(2);return r.one+r.two*2+r.three*3+r.four*4-n*(r.two+r.three*2+r.four)}get ped(){return this.computed.ped||(this.computed.ped=this.perimeter/Math.PI),this.computed.ped}get feretMask(){if(!this.computed.feretMask){const r=new Image(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});r.paintPolyline(this.feretDiameters.minLine),r.paintPolyline(this.feretDiameters.maxLine),this.computed.feretMask=r}return this.computed.feretMask}get mbrMask(){if(!this.computed.mbrMask){let r=round(this.mbr.rectangle);if(r.length>0){const n=minMax(r),a=new Image(n[1][0]-n[0][0]+1,n[1][1]-n[0][1]+1,{kind:BINARY,position:[this.minX+n[0][0],this.minY+n[0][1]],parent:this.map.parent});r=moveToZeroZero(r),a.paintPolyline(r,{closed:!0}),this.computed.mbrMask=a}else this.computed.mbrMask=new Image(1,1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent})}return this.computed.mbrMask}get mbrFilledMask(){if(!this.computed.mbrFilledMask){const r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),n=this.mask.minimalBoundingRectangle();for(let a=0;a<this.width;a++)for(let u=0;u<this.height;u++)robustPointInPolygon$1(n,[a,u])!==1&&r.setBitXY(a,u);this.computed.mbrFilledMask=r}return this.computed.mbrFilledMask}get points(){if(!this.computed.points){let r=[];for(let n=0;n<this.height;n++)for(let a=0;a<this.width;a++){let u=(n+this.minY)*this.map.width+a+this.minX;this.map.data[u]===this.id&&r.push([a,n])}this.computed.points=r}return this.computed.points}get maxLengthPoints(){if(!this.computed.maxLengthPoints){let r=0,n;const a=this.points;for(let u=0;u<a.length;u++)for(let f=u+1;f<a.length;f++){let _=Math.pow(a[u][0]-a[f][0],2)+Math.pow(a[u][1]-a[f][1],2);_>=r&&(r=_,n=[a[u],a[f]])}this.computed.maxLengthPoints=n}return this.computed.maxLengthPoints}get maxLength(){if(!this.computed.maxLength){let r=Math.sqrt(Math.pow(this.maxLengthPoints[0][0]-this.maxLengthPoints[1][0],2)+Math.pow(this.maxLengthPoints[0][1]-this.maxLengthPoints[1][1],2));this.computed.maxLength=r}return this.computed.maxLength}get roundness(){return 4*this.surface/(Math.PI*this.feretDiameters.max**2)}get sphericity(){return 2*Math.sqrt(this.surface*Math.PI)/this.perimeter}get solidity(){return this.surface/this.convexHull.surface}get angle(){if(!this.computed.angle){let r=this.maxLengthPoints,n=-Math.atan2(r[0][1]-r[1][1],r[0][0]-r[1][0])*180/Math.PI;this.computed.angle=n}return this.computed.angle}toJSON(){return{id:this.id,minX:this.minX,maxX:this.maxX,minY:this.minY,maxY:this.maxY,meanX:this.meanX,meanY:this.meanY,height:this.height,width:this.width,surface:this.surface,mbrWidth:this.mbr.width,mbrHeight:this.mbr.height,mbrSurface:this.mbr.surface,eqpc:this.eqpc,ped:this.ped,feretDiameterMin:this.feretDiameters.min,feretDiameterMax:this.feretDiameters.max,aspectRatio:this.feretDiameters.aspectRatio,fillRatio:this.fillRatio,sphericity:this.sphericity,roundness:this.roundness,solidity:this.solidity,perimeter:this.perimeter}}}function getBorders(e){let r=e.map,n=r.data,a=new Set,u=new Map,f=new Set,_=[1,0,-1,0],o=[0,1,0,-1];for(let M=e.minX;M<=e.maxX;M++)for(let P=e.minY;P<=e.maxY;P++){let L=M+P*r.width;if(n[L]===e.id)for(let D=0;D<4;D++){let U=M+_[D],X=P+o[D];if(U>=0&&X>=0&&U<r.width&&X<r.height){let K=U+X*r.width;if(n[K]!==e.id&&!f.has(K)){f.add(K),a.add(n[K]);let q=u.get(n[K]);q?u.set(n[K],++q):u.set(n[K],1)}}}}let b=Array.from(a),E=b.map(function(M){return u.get(M)});return{ids:b,lengths:E}}function getBoxIDs(e){let r=new Set,n=e.map,a=n.data;for(let u of[0,e.height-1])for(let f=0;f<e.width;f++){let _=(u+e.minY)*n.width+f+e.minX;if(f-e.minX>0&&a[_]===e.id&&a[_-1]!==e.id){let o=a[_-1];r.add(o)}if(n.width-f-e.minX>1&&a[_]===e.id&&a[_+1]!==e.id){let o=a[_+1];r.add(o)}}for(let u of[0,e.width-1])for(let f=0;f<e.height;f++){let _=(f+e.minY)*n.width+u+e.minX;if(f-e.minY>0&&a[_]===e.id&&a[_-n.width]!==e.id){let o=a[_-n.width];r.add(o)}if(n.height-f-e.minY>1&&a[_]===e.id&&a[_+n.width]!==e.id){let o=a[_+n.width];r.add(o)}}return Array.from(r)}function getBox(e){let r=0,n=e.map,a=n.data,u=[0];e.height>1&&(u[1]=e.height-1);for(let _ of u)for(let o=1;o<e.width-1;o++){let b=(_+e.minY)*n.width+o+e.minX;a[b]===e.id&&r++}let f=[0];e.width>1&&(f[1]=e.width-1);for(let _ of f)for(let o=0;o<e.height;o++){let b=(o+e.minY)*n.width+_+e.minX;a[b]===e.id&&r++}return r}function getBorder(e){let r=0,n=e.map,a=n.data;for(let u=1;u<e.width-1;u++)for(let f=1;f<e.height-1;f++){let _=(f+e.minY)*n.width+u+e.minX;a[_]===e.id&&(a[_-1]!==e.id||a[_+1]!==e.id||a[_-n.width]!==e.id||a[_+n.width]!==e.id)&&r++}return r+e.box}function getPerimeterInfo(e){let r=e.map,n=r.data,a=0,u=0,f=0,_=0;for(let o=0;o<e.width;o++)for(let b=0;b<e.height;b++){let E=(b+e.minY)*r.width+o+e.minX;if(n[E]===e.id){let M=0;switch((o===0||e.externalIDs.includes(n[E-1]))&&M++,(o===e.width-1||e.externalIDs.includes(n[E+1]))&&M++,(b===0||e.externalIDs.includes(n[E-r.width]))&&M++,(b===e.height-1||e.externalIDs.includes(n[E+r.width]))&&M++,M){case 1:a++;break;case 2:u++;break;case 3:f++;break;case 4:_++;break}}}return{one:a,two:u,three:f,four:_}}function getExternal(e){let r=0,n=e.map,a=n.data;for(let u=1;u<e.width-1;u++)for(let f=1;f<e.height-1;f++){let _=(f+e.minY)*n.width+u+e.minX;a[_]===e.id&&(e.externalIDs.includes(a[_-1])||e.externalIDs.includes(a[_+1])||e.externalIDs.includes(a[_-n.width])||e.externalIDs.includes(a[_+n.width]))&&r++}return r+e.box}function getHolesInfo(e){let r=0,n=e.map.width,a=e.map.data;for(let u=1;u<e.width-1;u++)for(let f=1;f<e.height-1;f++){let _=(f+e.minY)*n+u+e.minX;e.internalIDs.includes(a[_])&&a[_]!==e.id&&r++}return{number:e.internalIDs.length-1,surface:r}}function getInternalIDs(e){let r=[e.id],n=e.map,a=n.data;if(e.height>2)for(let f=0;f<e.width;f++){let _=e.minY*n.width+f+e.minX;if(r.includes(a[_])){let o=a[_+n.width];!r.includes(o)&&!e.boxIDs.includes(o)&&r.push(o)}}let u=new Array(4);for(let f=1;f<e.width-1;f++)for(let _=1;_<e.height-1;_++){let o=(_+e.minY)*n.width+f+e.minX;if(r.includes(a[o])){u[0]=a[o-1],u[1]=a[o+1],u[2]=a[o-n.width],u[3]=a[o+n.width];for(let b=0;b<4;b++){let E=u[b];!r.includes(E)&&!e.boxIDs.includes(E)&&r.push(E)}}}return r}class RoiLayer{constructor(r,n){this.roiMap=r,this.options=n,this.roi=this.createRoi()}createRoi(){let r=this.roiMap.data,n={};this.roiMap.positive=0,this.roiMap.negative=0;for(let o=0;o<r.length;o++)r[o]&&!n[r[o]]&&(n[r[o]]=!0,r[o]>0?this.roiMap.positive++:this.roiMap.negative++);let a={};for(let o in n)a[o]=new Roi(this.roiMap,o*1);let u=this.roiMap.width,f=this.roiMap.height;for(let o=0;o<f;o++)for(let b=0;b<u;b++){let E=o*u+b;if(r[E]!==0){const M=r[E],P=a[M];b<P.minX&&(P.minX=b),b>P.maxX&&(P.maxX=b),o<P.minY&&(P.minY=o),o>P.maxY&&(P.maxY=o),P.meanX+=b,P.meanY+=o,P.surface++}}let _=[];for(let o in n)a[o].meanX/=a[o].surface,a[o].meanY/=a[o].surface,_.push(a[o]);return _}}function commonBorderLength(e){let r=e.data,n=[1,0,-1,0],a=[0,1,0,-1],u=e.minMax,f=-u.min,_=u.max+f,o=[];for(let E=0;E<=_;E++)o.push(Object.create(null));for(let E=0;E<e.width;E++)for(let M=0;M<e.height;M++){let P=E+M*e.width,L=r[P];if(L!==0){let D=Object.create(null),U=!1;for(let X=0;X<4;X++){let K=E+n[X],q=M+a[X];if(K>=0&&q>=0&&K<e.width&&q<e.height){let oe=r[K+q*e.width];L!==oe&&(U=!0,oe!==0&&D[oe]===void 0&&(D[oe]=!0,o[oe+f][L]?o[oe+f][L]++:o[oe+f][L]=1))}else U=!0}U&&(o[L+f][L]?o[L+f][L]++:o[L+f][L]=1)}}let b={};for(let E=0;E<o.length;E++)Object.keys(o[E]).length>0&&(b[E-f]=o[E]);return b}function mergeRoi(e={}){const{algorithm:r="commonBorderLength",minCommonBorderLength:n=5,maxCommonBorderLength:a=100,minCommonBorderRatio:u=.3,maxCommonBorderRatio:f=1}=e;let _=function(K,q,oe){return K[oe]>=n&&K[oe]<=a};typeof r=="function"&&(_=r),r.toLowerCase()==="commonborderratio"&&(_=function(K,q,oe){let W=Math.min(K[oe]/K[q],1);return W>=u&&W<=f});const o=this,b=o.commonBorderLength;let E={},M={};for(let K of Object.keys(b)){let q=b[K],oe=Object.keys(q);for(let W of oe)if(W!==K&&_(q,K,W)){let Y=W;M[W]&&(Y=M[W]);let J=K;if(M[K]&&(J=M[K]),Number(Y)!==J){let Ee=Math.min(Y,J),xe=Math.max(Y,J);if(E[Ee]||(E[Ee]={}),E[Ee][xe]=!0,M[xe]=Ee,E[xe]){for(let se of Object.keys(E[xe]))E[Ee][se]=!0,M[se]=Ee;delete E[xe]}}}}let P=o.minMax,L=-P.min,D=P.max+L,U=new Array(D+1).fill(0);for(let K of Object.keys(M))U[Number(K)+L]=M[K];let X=o.data;for(let K=0;K<X.length;K++){let q=X[K];if(q!==0){let oe=U[q+L];oe!==0&&(X[K]=oe)}}return o.computed={},o}class RoiMap{constructor(r,n){this.parent=r,this.width=r.width,this.height=r.height,this.data=n,this.negative=0,this.positive=0}get total(){return this.negative+this.positive}get minMax(){let r=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER;for(let a=0;a<this.data.length;a++)this.data[a]<r&&(r=this.data[a]),this.data[a]>n&&(n=this.data[a]);return{min:r,max:n}}get commonBorderLength(){return commonBorderLength(this)}mergeRoi(r={}){return mergeRoi.call(this,r)}mergeRois(r){const n=r[0],a=r.slice(1);for(let u=0;u<this.data.length;u++)a.includes(this.data[u])&&(this.data[u]=n)}rowsInfo(){let r=new Array(this.height),n=0;for(let a=0;a<this.data.length;a+=this.width){let u={row:n,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};r[n++]=u;let f={},_={},o=[],b=this.data[a],E=0;for(let M=a;M<a+this.width;M++){let P=this.data[M];b!==P&&(b=P,o.push(E),E=0),E++,P>0?(u.positivePixel++,f[P]||(f[P]=!0)):P<0?(u.negativePixel++,_[P]||(_[P]=!0)):u.zeroPixel++}o.push(E),u.medianChange=o.sort((M,P)=>M-P)[Math.floor(o.length/2)],u.positiveRoiIDs=Object.keys(f),u.negativeRoiIDs=Object.keys(_),u.positiveRoi=u.positiveRoiIDs.length,u.negativeRoi=u.negativeRoiIDs.length}return r}colsInfo(){let r=new Array(this.width),n=0;for(let a=0;a<this.width;a++){let u={col:n,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};r[n++]=u;let f={},_={},o=[],b=this.data[a],E=0;for(let M=a;M<a+this.data.length;M+=this.width){let P=this.data[M];b!==P&&(b=P,o.push(E),E=0),E++,P>0?(u.positivePixel++,f[P]||(f[P]=!0)):P<0?(u.negativePixel++,_[P]||(_[P]=!0)):u.zeroPixel++}o.push(E),u.medianChange=o.sort((M,P)=>M-P)[Math.floor(o.length/2)],u.positiveRoiIDs=Object.keys(f),u.negativeRoiIDs=Object.keys(_),u.positiveRoi=u.positiveRoiIDs.length,u.negativeRoi=u.negativeRoiIDs.length}return r}}function fromMask(e,r={}){const{allowCorners:n=!1}=r,a=65535;let u=new Int16Array(e.size),f=0,_=0,o=new Uint16Array(a+1),b=new Uint16Array(a+1);for(let M=0;M<e.width;M++)for(let P=0;P<e.height;P++)u[P*e.width+M]===0&&E(M,P);function E(M,P){let L=0,D=0,U=e.getBitXY(M,P),X=U?++f:--_;if(f>32767||_<-32768)throw new Error("Too many regions of interest");for(o[0]=M,b[0]=P;L<=D;){let K=o[L&a],q=b[L&a];if(u[q*e.width+K]=X,K>0&&u[q*e.width+K-1]===0&&e.getBitXY(K-1,q)===U&&(D++,o[D&a]=K-1,b[D&a]=q,u[q*e.width+K-1]=-32768),q>0&&u[(q-1)*e.width+K]===0&&e.getBitXY(K,q-1)===U&&(D++,o[D&a]=K,b[D&a]=q-1,u[(q-1)*e.width+K]=-32768),K<e.width-1&&u[q*e.width+K+1]===0&&e.getBitXY(K+1,q)===U&&(D++,o[D&a]=K+1,b[D&a]=q,u[q*e.width+K+1]=-32768),q<e.height-1&&u[(q+1)*e.width+K]===0&&e.getBitXY(K,q+1)===U&&(D++,o[D&a]=K,b[D&a]=q+1,u[(q+1)*e.width+K]=-32768),n&&(K>0&&q>0&&u[(q-1)*e.width+K-1]===0&&e.getBitXY(K-1,q-1)===U&&(D++,o[D&a]=K-1,b[D&a]=q-1,u[(q-1)*e.width+K-1]=-32768),K<e.width-1&&q>0&&u[(q-1)*e.width+K+1]===0&&e.getBitXY(K+1,q-1)===U&&(D++,o[D&a]=K+1,b[D&a]=q-1,u[(q-1)*e.width+K+1]=-32768),K>0&&q<e.height-1&&u[(q+1)*e.width+K-1]===0&&e.getBitXY(K-1,q+1)===U&&(D++,o[D&a]=K-1,b[D&a]=q+1,u[(q+1)*e.width+K-1]=-32768),K<e.width-1&&q<e.height-1&&u[(q+1)*e.width+K+1]===0&&e.getBitXY(K+1,q+1)===U&&(D++,o[D&a]=K+1,b[D&a]=q+1,u[(q+1)*e.width+K+1]=-32768)),L++,D-L>a)throw new Error("analyseMask can not finish, the array to manage internal data is not big enough.You could improve mask by changing MAX_ARRAY")}}return new RoiMap(e,u)}class DisjointSet{constructor(){this.nodes=new Map}add(r){var n=this.nodes.get(r);return n||(n=new DisjointSetNode(r),this.nodes.set(r,n)),n}union(r,n){const a=this.find(r),u=this.find(n);a!==u&&(a.rank<u.rank?a.parent=u:a.rank>u.rank?u.parent=a:(u.parent=a,a.rank++))}find(r){for(var n=r;n.parent!==null;)n=n.parent;for(var a=r;a.parent!==null;){var u=a;a=a.parent,u.parent=n}return n}connected(r,n){return this.find(r)===this.find(n)}}var DisjointSet_1=DisjointSet;function DisjointSetNode(e){this.value=e,this.parent=null,this.rank=0}var DisjointSet$1=DisjointSet_1;const direction4X=[-1,0],direction4Y=[0,-1],neighbours4=[null,null],direction8X=[-1,-1,0,1],direction8Y=[0,-1,-1,-1],neighbours8=[null,null,null,null];function fromMaskConnectedComponentLabelingAlgorithm(e,r={}){const{allowCorners:n=!1}=r;let a=4;n&&(a=8);let u,f,_;if(a===8)u=direction8X,f=direction8Y,_=neighbours8;else if(a===4)u=direction4X,f=direction4Y,_=neighbours4;else throw new RangeError(`unsupported neighbours count: ${a}`);const o=e.size,b=e.width,E=e.height,M=new Array(o),P=new Uint32Array(o),L=new DisjointSet$1;let D=1;for(let U=0;U<E;U++)for(let X=0;X<b;X++){const K=X+U*b;if(e.getBit(K)){let q=null;for(let oe=0;oe<_.length;oe++){const W=X+u[oe],Y=U+f[oe];if(W>=0&&Y>=0&&W<b&&Y<E){const J=W+Y*b;let Ee=M[J];Ee?(_[oe]=Ee,(!q||_[oe].value<q.value)&&(q=_[oe])):_[oe]=null}}if(!q)M[K]=L.add(D++);else{M[K]=q;for(let oe=0;oe<_.length;oe++)_[oe]&&_[oe]!==q&&L.union(q,_[oe])}}}for(let U=0;U<E;U++)for(let X=0;X<b;X++){const K=X+U*b;e.getBit(K)&&(P[K]=L.find(M[K]).value)}return new RoiMap(e,P)}function fromMaxima(e={}){let{allowCorner:r=!0,onlyTop:n=!1,invert:a=!1}=e,u=this;u.checkProcessable("fromMaxima",{components:[1]});const f=1,_=2;let o=0,b=0,E=new Int16Array(u.size),M=new Int8Array(u.size),P=new Float32Array(u.size),L=1048575,D=new Uint16Array(L+1),U=new Uint16Array(L+1),X=0,K=0,q=new Uint16Array(L+1),oe=new Uint16Array(L+1),W=0,Y=0;for(J(u);X<K;){let se=D[X&L],ce=U[X&L];xe(se,ce,_),X++}return new RoiMap(u,E);function J({maxima:se=!0}){for(let ce=1;ce<u.height-1;ce++)for(let ee=1;ee<u.width-1;ee++){let he=ee+ce*u.width;if(M[he]===0){let Ie=se?u.data[he]:-u.data[ee+ce*u.width];if(u.data[ce*u.width+ee-1]>Ie||u.data[ce*u.width+ee+1]>Ie||u.data[(ce-1)*u.width+ee]>Ie||u.data[(ce+1)*u.width+ee]>Ie||r&&(u.data[(ce-1)*u.width+ee-1]>Ie||u.data[(ce-1)*u.width+ee+1]>Ie||u.data[(ce+1)*u.width+ee-1]>Ie||u.data[(ce+1)*u.width+ee+1]>Ie))continue;E[he]=se?++o:--b,Ee(ee,ce)||(se?--o:++b)}}}function Ee(se,ce){let ee=K;W=0,Y=1,q[0]=se,oe[0]=ce;let he=!0;for(;W<Y;){let Ie=q[W&L],Pe=oe[W&L];he&=xe(Ie,Pe,f),W++}if(!he){for(let Ie=0;Ie<Y;Ie++){let Pe=q[Ie&L],We=oe[Ie&L]*u.width+Pe;E[We]=0}K=ee}return he}function xe(se,ce,ee){let he=E[ce*u.width+se],Ie=u.data[ce*u.width+se];for(let Pe=ce-1;Pe<=ce+1;Pe++)for(let Qe=se-1;Qe<=se+1;Qe++){let We=Pe*u.width+Qe;if(M[We]===0)switch(M[We]=1,P[We]=u.data[We]-Ie,ee){case f:if(P[We]===0){if(Qe===0||Pe===0||Qe===u.width-1||Pe===u.height-1)return!1;E[We]=he,q[Y&L]=Qe,oe[Y&L]=Pe,Y++}else{if(P[We]>0)return!1;n||(E[We]=he,D[K&L]=Qe,U[K&L]=Pe,K++)}break;case _:P[We]<=0&&(E[We]=he,D[K&L]=Qe,U[K&L]=Pe,K++);break;default:throw new Error("unreachable")}}return!0}}function fromPoints(e,r={}){let n=new Shape(r),a=new Int16Array(this.size),u=0,f=n.getPoints();for(let _=0;_<e.length;_++){u++;let o=e[_][0],b=e[_][1];for(let E=0;E<f.length;E++){let M=f[E][0],P=f[E][1];o+M>=0&&b+P>=0&&o+M<this.width&&b+P<this.height&&(a[o+M+(b+P)*this.width]=u)}}return new RoiMap(this,a)}var priorityQueue={exports:{}};(function(e,r){(function(n){e.exports=n()})(function(){return function n(a,u,f){function _(E,M){if(!u[E]){if(!a[E]){var P=typeof commonjsRequire=="function"&&commonjsRequire;if(!M&&P)return P(E,!0);if(o)return o(E,!0);var L=new Error("Cannot find module '"+E+"'");throw L.code="MODULE_NOT_FOUND",L}var D=u[E]={exports:{}};a[E][0].call(D.exports,function(U){var X=a[E][1][U];return _(X||U)},D,D.exports,n,a,u,f)}return u[E].exports}for(var o=typeof commonjsRequire=="function"&&commonjsRequire,b=0;b<f.length;b++)_(f[b]);return _}({1:[function(n,a,u){var f,_,o,b,E,M=function(L,D){for(var U in D)P.call(D,U)&&(L[U]=D[U]);function X(){this.constructor=L}return X.prototype=D.prototype,L.prototype=new X,L.__super__=D.prototype,L},P={}.hasOwnProperty;f=n("./PriorityQueue/AbstractPriorityQueue"),_=n("./PriorityQueue/ArrayStrategy"),b=n("./PriorityQueue/BinaryHeapStrategy"),o=n("./PriorityQueue/BHeapStrategy"),E=function(L){M(D,L);function D(U){U||(U={}),U.strategy||(U.strategy=b),U.comparator||(U.comparator=function(X,K){return(X||0)-(K||0)}),D.__super__.constructor.call(this,U)}return D}(f),E.ArrayStrategy=_,E.BinaryHeapStrategy=b,E.BHeapStrategy=o,a.exports=E},{"./PriorityQueue/AbstractPriorityQueue":2,"./PriorityQueue/ArrayStrategy":3,"./PriorityQueue/BHeapStrategy":4,"./PriorityQueue/BinaryHeapStrategy":5}],2:[function(n,a,u){a.exports=function(){function f(_){var o;if(_?.strategy==null)throw"Must pass options.strategy, a strategy";if(_?.comparator==null)throw"Must pass options.comparator, a comparator";this.priv=new _.strategy(_),this.length=(_!=null&&(o=_.initialValues)!=null?o.length:void 0)||0}return f.prototype.queue=function(_){this.length++,this.priv.queue(_)},f.prototype.dequeue=function(_){if(!this.length)throw"Empty queue";return this.length--,this.priv.dequeue()},f.prototype.peek=function(_){if(!this.length)throw"Empty queue";return this.priv.peek()},f.prototype.clear=function(){return this.length=0,this.priv.clear()},f}()},{}],3:[function(n,a,u){var f;f=function(_,o,b){var E,M,P;for(M=0,E=_.length;M<E;)P=M+E>>>1,b(_[P],o)>=0?M=P+1:E=P;return M},a.exports=function(){function _(o){var b;this.options=o,this.comparator=this.options.comparator,this.data=((b=this.options.initialValues)!=null?b.slice(0):void 0)||[],this.data.sort(this.comparator).reverse()}return _.prototype.queue=function(o){var b;b=f(this.data,o,this.comparator),this.data.splice(b,0,o)},_.prototype.dequeue=function(){return this.data.pop()},_.prototype.peek=function(){return this.data[this.data.length-1]},_.prototype.clear=function(){this.data.length=0},_}()},{}],4:[function(n,a,u){a.exports=function(){function f(_){var o,b,E,M,P,L,D,U;for(this.comparator=_?.comparator||function(X,K){return X-K},this.pageSize=_?.pageSize||512,this.length=0,D=0;1<<D<this.pageSize;)D+=1;if(1<<D!==this.pageSize)throw"pageSize must be a power of two";for(this._shift=D,this._emptyMemoryPageTemplate=o=[],b=0,P=this.pageSize;0<=P?b<P:b>P;0<=P?++b:--b)o.push(null);if(this._memory=[],this._mask=this.pageSize-1,_.initialValues)for(L=_.initialValues,E=0,M=L.length;E<M;E++)U=L[E],this.queue(U)}return f.prototype.queue=function(_){this.length+=1,this._write(this.length,_),this._bubbleUp(this.length,_)},f.prototype.dequeue=function(){var _,o;return _=this._read(1),o=this._read(this.length),this.length-=1,this.length>0&&(this._write(1,o),this._bubbleDown(1,o)),_},f.prototype.peek=function(){return this._read(1)},f.prototype.clear=function(){this.length=0,this._memory.length=0},f.prototype._write=function(_,o){var b;for(b=_>>this._shift;b>=this._memory.length;)this._memory.push(this._emptyMemoryPageTemplate.slice(0));return this._memory[b][_&this._mask]=o},f.prototype._read=function(_){return this._memory[_>>this._shift][_&this._mask]},f.prototype._bubbleUp=function(_,o){var b,E,M,P;for(b=this.comparator;_>1&&(E=_&this._mask,_<this.pageSize||E>3?M=_&~this._mask|E>>1:E<2?(M=_-this.pageSize>>this._shift,M+=M&~(this._mask>>1),M|=this.pageSize>>1):M=_-2,P=this._read(M),!(b(P,o)<0));)this._write(M,o),this._write(_,P),_=M},f.prototype._bubbleDown=function(_,o){var b,E,M,P,L;for(L=this.comparator;_<this.length;)if(_>this._mask&&!(_&this._mask-1)?b=E=_+2:_&this.pageSize>>1?(b=(_&~this._mask)>>1,b|=_&this._mask>>1,b=b+1<<this._shift,E=b+1):(b=_+(_&this._mask),E=b+1),b!==E&&E<=this.length)if(M=this._read(b),P=this._read(E),L(M,o)<0&&L(M,P)<=0)this._write(b,o),this._write(_,M),_=b;else if(L(P,o)<0)this._write(E,o),this._write(_,P),_=E;else break;else if(b<=this.length)if(M=this._read(b),L(M,o)<0)this._write(b,o),this._write(_,M),_=b;else break;else break},f}()},{}],5:[function(n,a,u){a.exports=function(){function f(_){var o;this.comparator=_?.comparator||function(b,E){return b-E},this.length=0,this.data=((o=_.initialValues)!=null?o.slice(0):void 0)||[],this._heapify()}return f.prototype._heapify=function(){var _,o,b;if(this.data.length>0)for(_=o=1,b=this.data.length;1<=b?o<b:o>b;_=1<=b?++o:--o)this._bubbleUp(_)},f.prototype.queue=function(_){this.data.push(_),this._bubbleUp(this.data.length-1)},f.prototype.dequeue=function(){var _,o;return o=this.data[0],_=this.data.pop(),this.data.length>0&&(this.data[0]=_,this._bubbleDown(0)),o},f.prototype.peek=function(){return this.data[0]},f.prototype.clear=function(){this.length=0,this.data.length=0},f.prototype._bubbleUp=function(_){for(var o,b;_>0&&(o=_-1>>>1,this.comparator(this.data[_],this.data[o])<0);)b=this.data[o],this.data[o]=this.data[_],this.data[_]=b,_=o},f.prototype._bubbleDown=function(_){var o,b,E,M,P;for(o=this.data.length-1;b=(_<<1)+1,M=b+1,E=_,b<=o&&this.comparator(this.data[b],this.data[E])<0&&(E=b),M<=o&&this.comparator(this.data[M],this.data[E])<0&&(E=M),E!==_;)P=this.data[E],this.data[E]=this.data[_],this.data[_]=P,_=E},f}()},{}]},{},[1])(1)})})(priorityQueue);var PriorityQueue=priorityQueue.exports;const dxs=[1,0,-1,0,1,1,-1,-1],dys=[0,1,0,-1,1,-1,1,-1];function fromWaterShed(e={}){let{points:r,mask:n,image:a,fillMaxValue:u=this.maxValue,invert:f=!1}=e,_=a||this;_.checkProcessable("fromWaterShed",{bitDepth:[8,16],components:1}),f=!f,r||(r=_.getLocalMaxima({invert:f,mask:n}));let o=f?0:1,b=new Int16Array(_.size),E=_.width,M=_.height,P=new PriorityQueue({comparator:(L,D)=>L[2]-D[2],strategy:PriorityQueue.BinaryHeapStrategy});for(let L=0;L<r.length;L++){let D=r[L][0]+r[L][1]*E;b[D]=L+1;let U=_.data[D];(f&&U<=u||!f&&U>=u)&&P.queue([r[L][0],r[L][1],U])}for(;P.length>0;){let L=P.dequeue(),D=L[0]+L[1]*E;for(let U=0;U<4;U++){let X=L[0]+dxs[U],K=L[1]+dys[U];if(X>=0&&K>=0&&X<E&&K<M){let q=X+K*E;if(!n||n.getBit(q)===o){let oe=_.data[q];(f&&oe<=u||!f&&oe>=u)&&b[q]===0&&(b[q]=b[D],P.queue([L[0]+dxs[U],L[1]+dys[U],oe]))}}}}return new RoiMap(_,b)}class RoiManager{constructor(r,n={}){this._image=r,this._options=n,this._options.label||(this._options.label="default"),this._layers={},this._painted=null}fromMaxima(r={}){let n=Object.assign({},this._options,r),a=fromMaxima.call(this._image,r);this._layers[n.label]=new RoiLayer(a,n)}fromPoints(r,n={}){let a=Object.assign({},this._options,n),u=fromPoints.call(this._image,r,n);return this._layers[a.label]=new RoiLayer(u,a),this}putMap(r,n={}){let a=new RoiMap(this._image,r),u=Object.assign({},this._options,n);return this._layers[u.label]=new RoiLayer(a,u),this}fromWaterShed(r={}){let n=Object.assign({},this._options,r),a=fromWaterShed.call(this._image,r);this._layers[n.label]=new RoiLayer(a,n)}fromMask(r,n={}){let a=Object.assign({},this._options,n),u=fromMask.call(this._image,r,n);return this._layers[a.label]=new RoiLayer(u,a),this}fromMaskConnectedComponentLabelingAlgorithm(r,n={}){let a=Object.assign({},this._options,n),u=fromMaskConnectedComponentLabelingAlgorithm.call(this._image,r,n);return this._layers[a.label]=new RoiLayer(u,a),this}getMap(r={}){let n=Object.assign({},this._options,r);return this._assertLayerWithLabel(n.label),this._layers[n.label].roiMap}rowsInfo(r={}){return this.getMap(r).rowsInfo()}colsInfo(r={}){return this.getMap(r).rowsInfo()}getRoiIds(r={}){let n=this.getRois(r);if(n){let a=new Array(n.length);for(let u=0;u<n.length;u++)a[u]=n[u].id;return a}throw new Error("ROIs not found")}getRois(r={}){let{label:n=this._options.label,positive:a=!0,negative:u=!0,minSurface:f=0,maxSurface:_=Number.POSITIVE_INFINITY,minWidth:o=0,maxWidth:b=Number.POSITIVE_INFINITY,minHeight:E=0,maxHeight:M=Number.POSITIVE_INFINITY,minRatio:P=0,maxRatio:L=Number.POSITIVE_INFINITY}=r;if(!this._layers[n])throw new Error(`this Roi layer (${n}) does not exist`);const D=this._layers[n].roi,U=[];for(const X of D)(X.id<0&&u||X.id>0&&a)&&X.surface>=f&&X.surface<=_&&X.width>=o&&X.width<=b&&X.height>=E&&X.height<=M&&X.ratio>=P&&X.ratio<=L&&U.push(X);return U}getRoi(r,n={}){const{label:a=this._options.label}=n;if(!this._layers[a])throw new Error(`this Roi layer (${a}) does not exist`);const u=this._layers[a].roi.find(f=>f.id===r);if(!u)throw new Error(`found no Roi with id ${r}`);return u}getMasks(r={}){let n=this.getRois(r),a=new Array(n.length);for(let u=0;u<n.length;u++)a[u]=n[u].getMask(r);return a}getAnalysisMasks(r={}){const{analysisProperty:n}=r;let a=`${n}Mask`,u=this.getRois(r);return u.length===0||!u[0][a]?[]:u.map(f=>f[a])}getData(r={}){let n=Object.assign({},this._options,r);return this._assertLayerWithLabel(n.label),this._layers[n.label].roiMap.data}paint(r={}){let{labelProperty:n,analysisProperty:a}=r;this._painted||(this._painted=this._image.rgba8());let u=this.getMasks(r);if(n){const f=this.getRois(r);r.labels=f.map(E=>deepValue(E,n));const _=Math.max(...r.labels);let o=!1,b=!1;if(n.includes("surface")?o=!0:/(?:perimeter|min|max|external|width|height|length)/.test(n)&&(b=!0),isFinite(_)){let E="";if(r.unit!=="pixel"&&r.pixelSize&&(b||o)){E=o?`${r.unit}^2`:r.unit;let M=o?"m^2":"m",P=o?r.pixelSize**2:r.pixelSize;const L=Qty.swiftConverter(M,E);r.labels=r.labels.map(D=>L(P*D))}_>50?r.labels=r.labels.map(M=>Math.round(M)+E):_>10?r.labels=r.labels.map(M=>M.toFixed(1)+E):r.labels=r.labels.map(M=>M.toFixed(2)+E)}r.labelsPosition=f.map(E=>[E.meanX,E.meanY])}if(this._painted.paintMasks(u,r),a){let f=this.getAnalysisMasks(r);this._painted.paintMasks(f,{color:r.analysisColor,alpha:r.analysisAlpha})}return this._painted}getMask(r={}){let n=new Image(this._image.width,this._image.height,{kind:"BINARY"}),a=this.getMasks(r);for(let u=0;u<a.length;u++){let f=a[u];for(let _=0;_<f.width;_++)for(let o=0;o<f.height;o++)f.getBitXY(_,o)&&n.setBitXY(_+f.position[0],o+f.position[1])}return n}resetPainted(r={}){const{image:n}=r;n?this._painted=this.image.rgba8():this._painted=this._image.rgba8()}mergeRoi(r={}){const n=this.getMap(r);return n.mergeRoi(r),this.putMap(n.data,r),this}mergeRois(r,n={}){if(!Array.isArray(r)||r.some(u=>!Number.isInteger(u)))throw new Error("Roi ids must be an array of integers");if(r.length<2)throw new Error("Roi ids must have at least two elements");if(new Set(r).size!==r.length)throw new Error("Roi ids must be all different");r.forEach(u=>this.getRoi(u));const a=this.getMap(n);return a.mergeRois(r),this.putMap(a.data,n),this}findCorrespondingRoi(r,n={}){let a=this.getRois(n),u=[];for(let f=0;f<a.length;f++){let _=a[f],o=_.minX,b=_.minY,E=_.points,M=Math.sign(_.id),P=correspondingRoisInformation(o,b,E,r,M);u.push(P)}return u}_assertLayerWithLabel(r){if(!this._layers[r])throw new Error(`no layer with label ${r}`)}}function correspondingRoisInformation(e,r,n,a,u){let f={id:[],surface:[],roiSurfaceCovered:[],same:0,opposite:0,total:0};for(let _=0;_<n.length;_++){let o=n[_],b=o[0],E=o[1],M=b+e+(E+r)*a.width,P=a.data[M];(P>0||P<0)&&(f.id.includes(P)?f.surface[f.id.indexOf(P)]+=1:(f.id.push(P),f.surface.push(1)))}for(let _=0;_<f.id.length;_++)Math.sign(f.id[_])===u?f.same+=f.surface[_]:f.opposite+=f.surface[_],f.roiSurfaceCovered[_]=f.surface[_]/n.length;return f.total=f.opposite+f.same,f}const objectToString$1=Object.prototype.toString;class Image{constructor(r,n,a,u){if(arguments.length===1?(u=r,{width:r,height:n,data:a}=u):a&&!a.length&&(u=a,{data:a}=u),r===void 0&&(r=1),n===void 0&&(n=1),u===void 0&&(u={}),typeof u!="object"||u===null)throw new TypeError("options must be an object");if(!Number.isInteger(r)||r<=0)throw new RangeError("width must be a positive integer");if(!Number.isInteger(n)||n<=0)throw new RangeError("height must be a positive integer");const{kind:f=RGBA}=u;if(typeof f!="string")throw new TypeError("kind must be a string");const _=getKind(f),o=Object.assign({},u);for(const X in _)o[X]===void 0&&(o[X]=_[X]);verifyKindDefinition(o);const{components:b,bitDepth:E,colorModel:M}=o,P=o.alpha+0,L=r*n,D=b+P,U=E===32?Number.MAX_VALUE:2**E-1;if(a===void 0)a=createPixelArray(L,b,P,D,E,U);else{const X=getTheoreticalPixelArraySize(L,D,E);if(a.length!==X)throw new RangeError(`incorrect data size: ${a.length}. Should be ${X}`)}this.width=r,this.height=n,this.data=a,this.size=L,this.components=b,this.alpha=P,this.bitDepth=E,this.maxValue=U,this.colorModel=M,this.channels=D,this.meta=u.meta||{},Object.defineProperty(this,"parent",{enumerable:!1,writable:!0,configurable:!0,value:u.parent||null}),this.position=u.position||[0,0],this.computed=null,this.sizes=[this.width,this.height],this.multiplierX=this.channels,this.multiplierY=this.channels*this.width,this.isClamped=this.bitDepth<32,this.borderSizes=[0,0]}get[Symbol.toStringTag](){return"IJSImage"}static isImage(r){return objectToString$1.call(r)==="[object IJSImage]"}static fromCanvas(r){const a=r.getContext("2d").getImageData(0,0,r.width,r.height);return new Image(a.width,a.height,a.data)}static createFrom(r,n){const a=getImageParameters(r);return Object.assign(a,{parent:r,position:[0,0]},n),new Image(a)}getRoiManager(r){return new RoiManager(this,r)}clone(){const r=this.data.slice();return new Image(this.width,this.height,r,this)}apply(r){for(let n=0;n<this.height;n++)for(let a=0;a<this.width;a++){let u=(n*this.width+a)*this.channels;r.call(this,u)}}}setValueMethods(Image);setBitMethods(Image);setExportMethods(Image);Image.prototype.checkProcessable=checkProcessable;Image.prototype.getRGBAData=getRGBAData;Image.load=load;Image.extendMethod=extendMethod;Image.extendProperty=extendProperty;extend$4(Image);var workerTemplate$1={},worker$1=function(){self.window=self;function e(){this._listeners={}}e.prototype.on=function(n,a){if(this._listeners[n])throw new RangeError("there is already a listener for "+n);if(typeof a!="function")throw new TypeError("callback argument must be a function");this._listeners[n]=a},e.prototype._send=function(n,a,u){u===void 0?u=[]:Array.isArray(u)||(u=[u]),self.postMessage({id:n,data:a},u)},e.prototype._trigger=function(n,a){if(!this._listeners[n])throw new Error("event "+n+" is not defined");this._listeners[n].apply(null,a)};var r=new e;self.onmessage=function(n){switch(n.data.action){case"exec":n.data.args.unshift(function(a,u){r._send(n.data.id,a,u)}),r._trigger(n.data.event,n.data.args);break;case"ping":r._send(n.data.id,"pong");break;default:throw new Error("unexpected action: "+n.data.action)}}},workerStr=worker$1.toString().split('"CODE";');workerTemplate$1.newWorkerURL=function e(r,n){var a=new Blob(["(",workerStr[0],"importScripts.apply(self, "+JSON.stringify(n)+`);
`,"(",r,")();",workerStr[1],")();"],{type:"application/javascript"});return URL.createObjectURL(a)};var workerTemplate=workerTemplate$1,CORES=navigator.hardwareConcurrency||1;function WorkerManager(e,r){if(typeof e!="string"&&typeof e!="function")throw new TypeError("func argument must be a function");if(r===void 0&&(r={}),typeof r!="object"||r===null)throw new TypeError("options argument must be an object");this._workerCode=e.toString(),r.maxWorkers===void 0||r.maxWorkers==="auto"?this._numWorkers=Math.min(CORES-1,1):r.maxWorkers>0?this._numWorkers=Math.min(r.maxWorkers,CORES):this._numWorkers=CORES,this._workers=new Map,this._timeout=r.timeout||0,this._terminateOnError=!!r.terminateOnError;var n=r.deps;typeof n=="string"&&(n=[n]),Array.isArray(n)||(n=void 0),this._id=0,this._terminated=!1,this._working=0,this._waiting=[],this._init(n)}WorkerManager.prototype._init=function(e){for(var r=workerTemplate.newWorkerURL(this._workerCode,e),n=0;n<this._numWorkers;n++){var a=new Worker(r);a.onmessage=this._onmessage.bind(this,a),a.onerror=this._onerror.bind(this,a),a.running=!1,a.id=n,this._workers.set(a,null)}URL.revokeObjectURL(r)};WorkerManager.prototype._onerror=function(e,r){if(!this._terminated){this._working--,e.running=!1;var n=this._workers.get(e);n&&n[1](r.message),this._workers.set(e,null),this._terminateOnError?this.terminate():this._exec()}};WorkerManager.prototype._onmessage=function(e,r){if(!this._terminated){this._working--,e.running=!1;var n=this._workers.get(e);n&&n[0](r.data.data),this._workers.set(e,null),this._exec()}};WorkerManager.prototype._exec=function(){for(var e of this._workers.keys()){if(this._working===this._numWorkers||this._waiting.length===0)return;if(!e.running)for(var r=0;r<this._waiting.length;r++){var n=this._waiting[r];if(!(typeof n[4]=="number"&&n[4]!==e.id)){this._waiting.splice(r,1),e.postMessage({action:"exec",event:n[0],args:n[1]},n[2]),e.running=!0,e.time=Date.now(),this._workers.set(e,n[3]),this._working++;break}}}};WorkerManager.prototype.terminate=function(){if(!this._terminated){for(var e of this._workers)e[0].terminate(),e[1]&&e[1][1](new Error("Terminated"));this._workers.clear(),this._waiting=[],this._working=0,this._terminated=!0}};WorkerManager.prototype.postAll=function(e,r){if(this._terminated)throw new Error("Cannot post (terminated)");var n=[];for(var a of this._workers.keys())n.push(this.post(e,r,[],a.id));return Promise.all(n)};WorkerManager.prototype.post=function(e,r,n,a){r===void 0&&(r=[]),n===void 0&&(n=[]),Array.isArray(r)||(r=[r]),Array.isArray(n)||(n=[n]);var u=this;return new Promise(function(f,_){if(u._terminated)throw new Error("Cannot post (terminated)");u._waiting.push([e,r,n,[f,_],a]),u._exec()})};var src=WorkerManager;const defaultOptions={regression:{kernelType:"polynomial",kernelOptions:{degree:2,constant:1}},threshold:.02,roi:{minSurface:100,positive:!1},sampling:20,include:[]};function run(e,r,n){r=Object.assign({},defaultOptions,r);const a=this.manager;return Array.isArray(e)?Promise.all(e.map(function(u){const f=runOnce(a,u,r);return typeof n=="function"&&f.then(n),f})):runOnce(a,e,r)}function runOnce(e,r,n){return e.post("data",[r,n]).then(function(a){for(let u in a)a[u]=new Image(a[u]);return a})}function work(){worker.on("data",function(e,r,n){r=new IJS(r);const a={},u=[],f=r.grey(),_=f.sobelFilter();D("sobel",_);const o=_.level().mask({threshold:n.threshold});D("mask",o);const b=_.getRoiManager();b.fromMask(o);const E=b.getMask(n.roi);D("realMask",E);const M=f.getPixelsGrid({sampling:n.sampling,mask:E}),P=r.getBackground(M.xyS,M.zS,n.regression);D("background",P);const L=r.subtract(P);a.result=L,u.push(L.data.buffer),e(a,u);function D(U,X){n.include.includes(U)&&(a[U]=X,u.push(X.data.buffer))}})}const background={run,work};function extend$3(e){e.extendMethod("background",background)}class Worker$1{constructor(){this._url=null,this._deps=[null]}checkUrl(){if(this._url===null)throw new Error("image worker must be initialized with an URL")}get url(){return this._url}set url(r){if(typeof r!="string")throw new TypeError("worker URL must be a string");this._url=r,this._deps[0]=r}static extendMethod(r,n){let a,u,f={};function _(...o){return a||(this.checkUrl(),u=this.url,a=new src(n.work,{deps:u}),f.manager=a),n.run.call(f,...o)}_.reset=function(){a&&(a.terminate(),a=new src(n.work,{deps:u}),f.manager=a)},Worker$1.prototype[r]=_}}extend$3(Worker$1);new Worker$1;function getTileInfo(e,r,n){let a={},u=Math.floor(n.getZoom()),f=40075016686e-3*Math.abs(Math.cos(r))/Math.pow(2,u),_=f/512,o=tilebelt.pointToTile(e,r,u);a.z=u,a.x=o[0],a.y=o[1],a.pointLng=e,a.pointLat=r,a.tileWidthInMeters=f,a.metersPerPixel=_,a.mapboxTileName=a.z+"-"+a.x+"-"+a.y,a.tile=[a.x,a.y,a.z],a.bbox=tilebelt.tileToBBOX(a.tile),a.polygon_bb=getTileGeoJsonBB(a.bbox),a.area_bb=getAreaBB(a.bbox);const b=new mapboxgl.LngLatBounds(a.bbox);a.bboxCT=b.getCenter(),a.bboxSW=b.getSouthWest(),a.bboxNE=b.getNorthEast(),a.bboxNW=b.getNorthWest(),a.bboxSE=b.getSouthEast(),a.bboxW=b.getWest().toFixed(5),a.bboxS=b.getSouth().toFixed(5),a.bboxE=b.getEast().toFixed(5),a.bboxN=b.getNorth().toFixed(5),a.topLeft=a.bboxNW,a.bottomLeft=a.bboxSW,a.topRight=a.bboxNE,a.bottomRight=a.bboxSE,a.center=a.bboxCT;const E=point([a.bboxNE.lng,a.bboxNE.lat]),M=point([a.bboxSW.lng,a.bboxNE.lat]),P=point([a.bboxNE.lng,a.bboxSW.lat]),L=point([a.bboxSW.lng,a.bboxSW.lat]),D=midpoint(E,P),U=midpoint(M,L);return a.distance=distance(D,U,"kilometers").toFixed(2),a.maxPngValue=65535,a.rgbFileName="terrain-rgb-"+a.mapboxTileName+".png",a.thirtyTwoFileName="thirtytwo-"+a.mapboxTileName+".png",a.tileInfoFileName="tile-info-"+a.mapboxTileName+".json",a.geoJsonFileName="geojson-"+a.mapboxTileName+".json",a}function getAreaBB(e){let r=bboxPolygon(e);return area(r)}function getTileGeoJsonBB(e){let r=bboxPolygon(e);return{type:"Feature",geometry:{type:r.geometry.type,coordinates:r.geometry.coordinates}}}function getFeaturesFromBB(e,r,n){r.swPt=e.project(r.bboxSW),r.nePt=e.project(r.bboxNE),r.nwPt=e.project(r.bboxNW),r.sePt=e.project(r.bboxSE);let a=e.queryRenderedFeatures([r.swPt,r.nePt]);return n===!0&&(a=getUniqueFeatures(a)),a}function getUniqueFeatures(e){const r=new Set,n=[];for(const a of e){const u=a.properties.name,f=a.geometry.type;let _=u+"-"+f;r.has(_)||(r.add(_),n.push(a))}return n}async function loadImageFromArray(e){return await Image.load(e)}function getHeightFromRgb(e,r,n){return-1e4+(e*256*256+r*256+n)*.1}function getHeightArray(e){let r=[],n=e.getPixelsArray();for(const a of n){let u=a[0],f=a[1],_=a[2],o=getHeightFromRgb(u,f,_);o=parseFloat(o),r.push(o)}return r}async function downloadTerrainRgb(e){return await(await fetch(e)).arrayBuffer()}async function unrealRemoteControl(e,r){let n,a={},u="";const f={method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};try{n=await fetch(r,f)}catch(_){u=_}return a.response=n,a.error=u,a}async function getMapboxTerrainRgb(e,r,n){let a,u=await fileUtils.fileExists(e,r.rgbFileName),f;return u===!1?a=await downloadTerrainRgb(n):a=await fileUtils.readFileFromDisk(e,r.rgbFileName),idbKeyval.set("rgbImageArrayBuffer",a),f=await loadImageFromArray(a),f}function convertImage(e,r,n,a,u){return new Image(e,r,n,{kind:u,bitDepth:a})}function createHeightMapImage(e,r,n){let a={},u=getHeightArray(e);idbKeyval.set("decodedHeightArray",u);let f=convertImage(e.width,e.height,u,r,n);return a.minElevation=f.min[0],a.maxElevation=f.max[0],a.image=f,a.decodedHeightArray=u,a}var mapUtils={getTileInfo,getFeaturesFromBB,getMapboxTerrainRgb,createHeightMapImage,loadImageFromArray,unrealRemoteControl,downloadTerrainRgb};function mitt(e){return{all:e=e||new Map,on:function(r,n){var a=e.get(r);a?a.push(n):e.set(r,[n])},off:function(r,n){var a=e.get(r);a&&(n?a.splice(a.indexOf(n)>>>0,1):e.set(r,[]))},emit:function(r,n){var a=e.get(r);a&&a.slice().map(function(u){u(n)}),(a=e.get("*"))&&a.slice().map(function(u){u(r,n)})}}}var emitter=mitt(),immutable=extend$2,hasOwnProperty=Object.prototype.hasOwnProperty;function extend$2(){for(var e={},r=0;r<arguments.length;r++){var n=arguments[r];for(var a in n)hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}var fuzzy$1={exports:{}};(function(e,r){(function(){var n={};e.exports=n,n.simpleFilter=function(a,u){return u.filter(function(f){return n.test(a,f)})},n.test=function(a,u){return n.match(a,u)!==null},n.match=function(a,u,f){f=f||{};var _=0,o=[],b=u.length,E=0,M=0,P=f.pre||"",L=f.post||"",D=f.caseSensitive&&u||u.toLowerCase(),U;a=f.caseSensitive&&a||a.toLowerCase();for(var X=0;X<b;X++)U=u[X],D[X]===a[_]?(U=P+U+L,_+=1,M+=1+M):M=0,E+=M,o[o.length]=U;return _===a.length?(E=D===a?1/0:E,{rendered:o.join(""),score:E}):null},n.filter=function(a,u,f){return!u||u.length===0?[]:typeof a!="string"?u:(f=f||{},u.reduce(function(_,o,b,E){var M=o;f.extract&&(M=f.extract(o));var P=n.match(a,M,f);return P!=null&&(_[_.length]={string:P.rendered,score:P.score,index:b,original:o}),_},[]).sort(function(_,o){var b=o.score-_.score;return b||_.index-o.index}))}})()})(fuzzy$1);var List$1=function(e){return this.component=e,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,e.el.parentNode.insertBefore(this.wrapper,e.el.nextSibling),this};List$1.prototype.show=function(){this.element.style.display="block"};List$1.prototype.hide=function(){this.element.style.display="none"};List$1.prototype.add=function(e){this.items.push(e)};List$1.prototype.clear=function(){this.items=[],this.active=0};List$1.prototype.isEmpty=function(){return!this.items.length};List$1.prototype.isVisible=function(){return this.element.style.display==="block"};List$1.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var e=0;e<this.items.length;e++)this.drawItem(this.items[e],this.active===e);this.show()};List$1.prototype.drawItem=function(e,r){var n=document.createElement("li"),a=document.createElement("a");r&&(n.className+=" active"),a.innerHTML=e.string,n.appendChild(a),this.element.appendChild(n),n.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),n.addEventListener("mouseup",function(){this.handleMouseUp.call(this,e)}.bind(this))};List$1.prototype.handleMouseUp=function(e){this.selectingListItem=!1,this.component.value(e.original),this.clear(),this.draw()};List$1.prototype.move=function(e){this.active=e,this.draw()};List$1.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};List$1.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};List$1.prototype.drawError=function(e){var r=document.createElement("li");r.innerHTML=e,this.element.appendChild(r),this.show()};var list=List$1,extend$1=immutable,fuzzy=fuzzy$1.exports,List=list,Suggestions$1=function(e,r,n){return n=n||{},this.options=extend$1({minLength:2,limit:5,filter:!0,hideOnBlur:!0},n),this.el=e,this.data=r||[],this.list=new List(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",function(a){this.handleKeyUp(a.keyCode)}.bind(this),!1),this.el.addEventListener("keydown",function(a){this.handleKeyDown(a)}.bind(this)),this.el.addEventListener("focus",function(){this.handleFocus()}.bind(this)),this.el.addEventListener("blur",function(){this.handleBlur()}.bind(this)),this.el.addEventListener("paste",function(a){this.handlePaste(a)}.bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};Suggestions$1.prototype.handleKeyUp=function(e){e===40||e===38||e===27||e===13||e===9||this.handleInputChange(this.el.value)};Suggestions$1.prototype.handleKeyDown=function(e){switch(e.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&e.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};Suggestions$1.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};Suggestions$1.prototype.handlePaste=function(e){if(e.clipboardData)this.handleInputChange(e.clipboardData.getData("Text"));else{var r=this;setTimeout(function(){r.handleInputChange(e.target.value)},100)}};Suggestions$1.prototype.handleInputChange=function(e){if(this.query=this.normalize(e),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates(function(r){for(var n=0;n<r.length&&(this.list.add(r[n]),n!==this.options.limit-1);n++);this.list.draw()}.bind(this))};Suggestions$1.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};Suggestions$1.prototype.update=function(e){this.data=e,this.handleKeyUp()};Suggestions$1.prototype.clear=function(){this.data=[],this.list.clear()};Suggestions$1.prototype.normalize=function(e){return e=e.toLowerCase(),e};Suggestions$1.prototype.match=function(e,r){return e.indexOf(r)>-1};Suggestions$1.prototype.value=function(e){if(this.selected=e,this.el.value=this.getItemValue(e),document.createEvent){var r=document.createEvent("HTMLEvents");r.initEvent("change",!0,!1),this.el.dispatchEvent(r)}else this.el.fireEvent("onchange")};Suggestions$1.prototype.getCandidates=function(e){var r={pre:"<strong>",post:"</strong>",extract:function(a){return this.getItemValue(a)}.bind(this)},n;this.options.filter?(n=fuzzy.filter(this.query,this.data,r),n=n.map(function(a){return{original:a.original,string:this.render(a.original,a.string)}}.bind(this))):n=this.data.map(function(a){var u=this.render(a);return{original:a,string:u}}.bind(this)),e(n)};Suggestions$1.prototype.getItemValue=function(e){return e};Suggestions$1.prototype.render=function(e,r){if(r)return r;for(var n=e.original?this.getItemValue(e.original):this.getItemValue(e),a=this.normalize(n),u=a.lastIndexOf(this.query);u>-1;){var f=u+this.query.length;n=n.slice(0,u)+"<strong>"+n.slice(u,f)+"</strong>"+n.slice(f),u=a.slice(0,u).lastIndexOf(this.query)}return n};Suggestions$1.prototype.renderError=function(e){this.list.drawError(e)};var suggestions$1=Suggestions$1,Suggestions=suggestions$1,suggestions=Suggestions;typeof window<"u"&&(window.Suggestions=Suggestions);var FUNC_ERROR_TEXT="Expected a function",NAN=0/0,symbolTag="[object Symbol]",reTrim=/^\s+|\s+$/g,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsOctal=/^0o[0-7]+$/i,freeParseInt=parseInt,freeGlobal=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf=typeof self=="object"&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),objectProto=Object.prototype,objectToString=objectProto.toString,nativeMax=Math.max,nativeMin=Math.min,now=function(){return root.Date.now()};function debounce$1(e,r,n){var a,u,f,_,o,b,E=0,M=!1,P=!1,L=!0;if(typeof e!="function")throw new TypeError(FUNC_ERROR_TEXT);r=toNumber(r)||0,isObject(n)&&(M=!!n.leading,P="maxWait"in n,f=P?nativeMax(toNumber(n.maxWait)||0,r):f,L="trailing"in n?!!n.trailing:L);function D(Ee){var xe=a,se=u;return a=u=void 0,E=Ee,_=e.apply(se,xe),_}function U(Ee){return E=Ee,o=setTimeout(q,r),M?D(Ee):_}function X(Ee){var xe=Ee-b,se=Ee-E,ce=r-xe;return P?nativeMin(ce,f-se):ce}function K(Ee){var xe=Ee-b,se=Ee-E;return b===void 0||xe>=r||xe<0||P&&se>=f}function q(){var Ee=now();if(K(Ee))return oe(Ee);o=setTimeout(q,X(Ee))}function oe(Ee){return o=void 0,L&&a?D(Ee):(a=u=void 0,_)}function W(){o!==void 0&&clearTimeout(o),E=0,a=b=u=o=void 0}function Y(){return o===void 0?_:oe(now())}function J(){var Ee=now(),xe=K(Ee);if(a=arguments,u=this,b=Ee,xe){if(o===void 0)return U(b);if(P)return o=setTimeout(q,r),D(b)}return o===void 0&&(o=setTimeout(q,r)),_}return J.cancel=W,J.flush=Y,J}function isObject(e){var r=typeof e;return!!e&&(r=="object"||r=="function")}function isObjectLike(e){return!!e&&typeof e=="object"}function isSymbol(e){return typeof e=="symbol"||isObjectLike(e)&&objectToString.call(e)==symbolTag}function toNumber(e){if(typeof e=="number")return e;if(isSymbol(e))return NAN;if(isObject(e)){var r=typeof e.valueOf=="function"?e.valueOf():e;e=isObject(r)?r+"":r}if(typeof e!="string")return e===0?e:+e;e=e.replace(reTrim,"");var n=reIsBinary.test(e);return n||reIsOctal.test(e)?freeParseInt(e.slice(2),n?2:8):reIsBadHex.test(e)?NAN:+e}var lodash_debounce=debounce$1,events$1={exports:{}},R=typeof Reflect=="object"?Reflect:null,ReflectApply=R&&typeof R.apply=="function"?R.apply:function e(r,n,a){return Function.prototype.apply.call(r,n,a)},ReflectOwnKeys;R&&typeof R.ownKeys=="function"?ReflectOwnKeys=R.ownKeys:Object.getOwnPropertySymbols?ReflectOwnKeys=function(r){return Object.getOwnPropertyNames(r).concat(Object.getOwnPropertySymbols(r))}:ReflectOwnKeys=function(r){return Object.getOwnPropertyNames(r)};function ProcessEmitWarning(e){console&&console.warn&&console.warn(e)}var NumberIsNaN=Number.isNaN||function e(r){return r!==r};function EventEmitter$2(){EventEmitter$2.init.call(this)}events$1.exports=EventEmitter$2;events$1.exports.once=once;EventEmitter$2.EventEmitter=EventEmitter$2;EventEmitter$2.prototype._events=void 0;EventEmitter$2.prototype._eventsCount=0;EventEmitter$2.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(EventEmitter$2,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(e){if(typeof e!="number"||e<0||NumberIsNaN(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");defaultMaxListeners=e}});EventEmitter$2.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};EventEmitter$2.prototype.setMaxListeners=function e(r){if(typeof r!="number"||r<0||NumberIsNaN(r))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+r+".");return this._maxListeners=r,this};function _getMaxListeners(e){return e._maxListeners===void 0?EventEmitter$2.defaultMaxListeners:e._maxListeners}EventEmitter$2.prototype.getMaxListeners=function e(){return _getMaxListeners(this)};EventEmitter$2.prototype.emit=function e(r){for(var n=[],a=1;a<arguments.length;a++)n.push(arguments[a]);var u=r==="error",f=this._events;if(f!==void 0)u=u&&f.error===void 0;else if(!u)return!1;if(u){var _;if(n.length>0&&(_=n[0]),_ instanceof Error)throw _;var o=new Error("Unhandled error."+(_?" ("+_.message+")":""));throw o.context=_,o}var b=f[r];if(b===void 0)return!1;if(typeof b=="function")ReflectApply(b,this,n);else for(var E=b.length,M=arrayClone(b,E),a=0;a<E;++a)ReflectApply(M[a],this,n);return!0};function _addListener(e,r,n,a){var u,f,_;if(checkListener(n),f=e._events,f===void 0?(f=e._events=Object.create(null),e._eventsCount=0):(f.newListener!==void 0&&(e.emit("newListener",r,n.listener?n.listener:n),f=e._events),_=f[r]),_===void 0)_=f[r]=n,++e._eventsCount;else if(typeof _=="function"?_=f[r]=a?[n,_]:[_,n]:a?_.unshift(n):_.push(n),u=_getMaxListeners(e),u>0&&_.length>u&&!_.warned){_.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+_.length+" "+String(r)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=r,o.count=_.length,ProcessEmitWarning(o)}return e}EventEmitter$2.prototype.addListener=function e(r,n){return _addListener(this,r,n,!1)};EventEmitter$2.prototype.on=EventEmitter$2.prototype.addListener;EventEmitter$2.prototype.prependListener=function e(r,n){return _addListener(this,r,n,!0)};function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(e,r,n){var a={fired:!1,wrapFn:void 0,target:e,type:r,listener:n},u=onceWrapper.bind(a);return u.listener=n,a.wrapFn=u,u}EventEmitter$2.prototype.once=function e(r,n){return checkListener(n),this.on(r,_onceWrap(this,r,n)),this};EventEmitter$2.prototype.prependOnceListener=function e(r,n){return checkListener(n),this.prependListener(r,_onceWrap(this,r,n)),this};EventEmitter$2.prototype.removeListener=function e(r,n){var a,u,f,_,o;if(checkListener(n),u=this._events,u===void 0)return this;if(a=u[r],a===void 0)return this;if(a===n||a.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete u[r],u.removeListener&&this.emit("removeListener",r,a.listener||n));else if(typeof a!="function"){for(f=-1,_=a.length-1;_>=0;_--)if(a[_]===n||a[_].listener===n){o=a[_].listener,f=_;break}if(f<0)return this;f===0?a.shift():spliceOne(a,f),a.length===1&&(u[r]=a[0]),u.removeListener!==void 0&&this.emit("removeListener",r,o||n)}return this};EventEmitter$2.prototype.off=EventEmitter$2.prototype.removeListener;EventEmitter$2.prototype.removeAllListeners=function e(r){var n,a,u;if(a=this._events,a===void 0)return this;if(a.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):a[r]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete a[r]),this;if(arguments.length===0){var f=Object.keys(a),_;for(u=0;u<f.length;++u)_=f[u],_!=="removeListener"&&this.removeAllListeners(_);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=a[r],typeof n=="function")this.removeListener(r,n);else if(n!==void 0)for(u=n.length-1;u>=0;u--)this.removeListener(r,n[u]);return this};function _listeners(e,r,n){var a=e._events;if(a===void 0)return[];var u=a[r];return u===void 0?[]:typeof u=="function"?n?[u.listener||u]:[u]:n?unwrapListeners(u):arrayClone(u,u.length)}EventEmitter$2.prototype.listeners=function e(r){return _listeners(this,r,!0)};EventEmitter$2.prototype.rawListeners=function e(r){return _listeners(this,r,!1)};EventEmitter$2.listenerCount=function(e,r){return typeof e.listenerCount=="function"?e.listenerCount(r):listenerCount.call(e,r)};EventEmitter$2.prototype.listenerCount=listenerCount;function listenerCount(e){var r=this._events;if(r!==void 0){var n=r[e];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}EventEmitter$2.prototype.eventNames=function e(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(e,r){for(var n=new Array(r),a=0;a<r;++a)n[a]=e[a];return n}function spliceOne(e,r){for(;r+1<e.length;r++)e[r]=e[r+1];e.pop()}function unwrapListeners(e){for(var r=new Array(e.length),n=0;n<r.length;++n)r[n]=e[n].listener||e[n];return r}function once(e,r){return new Promise(function(n,a){function u(_){e.removeListener(r,f),a(_)}function f(){typeof e.removeListener=="function"&&e.removeListener("error",u),n([].slice.call(arguments))}eventTargetAgnosticAddListener(e,r,f,{once:!0}),r!=="error"&&addErrorHandlerIfEventEmitter(e,u,{once:!0})})}function addErrorHandlerIfEventEmitter(e,r,n){typeof e.on=="function"&&eventTargetAgnosticAddListener(e,"error",r,n)}function eventTargetAgnosticAddListener(e,r,n,a){if(typeof e.on=="function")a.once?e.once(r,n):e.on(r,n);else if(typeof e.addEventListener=="function")e.addEventListener(r,function u(f){a.once&&e.removeEventListener(r,u),n(f)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}var exceptions$1={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}};function parseParam(e){var r=e.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return r?{key:r[1],value:r[2]}:null}function parseLink(e){var r=e.match(/<?([^>]*)>(.*)/);if(!r)return null;var n=r[1],a=r[2].split(";"),u=null,f=a.reduce(function(_,o){var b=parseParam(o);return b?b.key==="rel"?(u||(u=b.value),_):(_[b.key]=b.value,_):_},{});return u?{url:n,rel:u,params:f}:null}function parseLinkHeader$1(e){return e?e.split(/,\s*</).reduce(function(r,n){var a=parseLink(n);if(!a)return r;var u=a.rel.split(/\s+/);return u.forEach(function(f){r[f]||(r[f]={url:a.url,params:a.params})}),r},{}):{}}var parseLinkHeader_1=parseLinkHeader$1,parseLinkHeader=parseLinkHeader_1;function MapiResponse$1(e,r){this.request=e,this.headers=r.headers,this.rawBody=r.body,this.statusCode=r.statusCode;try{this.body=JSON.parse(r.body||"{}")}catch{this.body=r.body}this.links=parseLinkHeader(this.headers.link)}MapiResponse$1.prototype.hasNextPage=function e(){return!!this.links.next};MapiResponse$1.prototype.nextPage=function e(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};var mapiResponse=MapiResponse$1,constants$4={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"},constants$3=constants$4;function MapiError$1(e){var r=e.type||constants$3.ERROR_HTTP,n;if(e.body)try{n=JSON.parse(e.body)}catch{n=e.body}else n=null;var a=e.message||null;a||(typeof n=="string"?a=n:n&&typeof n.message=="string"?a=n.message:r===constants$3.ERROR_REQUEST_ABORTED&&(a="Request aborted")),this.message=a,this.type=r,this.statusCode=e.statusCode||null,this.request=e.request,this.body=n}var mapiError=MapiError$1;function parseSingleHeader(e){var r=e.indexOf(":"),n=e.substring(0,r).trim().toLowerCase(),a=e.substring(r+1).trim();return{name:n,value:a}}function parseHeaders$1(e){var r={};return e&&e.trim().split(/[\r|\n]+/).forEach(function(n){var a=parseSingleHeader(n);r[a.name]=a.value}),r}var parseHeaders_1=parseHeaders$1,MapiResponse=mapiResponse,MapiError=mapiError,constants$2=constants$4,parseHeaders=parseHeaders_1,requestsUnderway={};function browserAbort(e){var r=requestsUnderway[e.id];!r||(r.abort(),delete requestsUnderway[e.id])}function createResponse(e,r){return new MapiResponse(e,{body:r.response,headers:parseHeaders(r.getAllResponseHeaders()),statusCode:r.status})}function normalizeBrowserProgressEvent(e){var r=e.total,n=e.loaded,a=100*n/r;return{total:r,transferred:n,percent:a}}function sendRequestXhr(e,r){return new Promise(function(n,a){r.onprogress=function(_){e.emitter.emit(constants$2.EVENT_PROGRESS_DOWNLOAD,normalizeBrowserProgressEvent(_))};var u=e.file;u&&(r.upload.onprogress=function(_){e.emitter.emit(constants$2.EVENT_PROGRESS_UPLOAD,normalizeBrowserProgressEvent(_))}),r.onerror=function(_){a(_)},r.onabort=function(){var _=new MapiError({request:e,type:constants$2.ERROR_REQUEST_ABORTED});a(_)},r.onload=function(){if(delete requestsUnderway[e.id],r.status<200||r.status>=400){var _=new MapiError({request:e,body:r.response,statusCode:r.status});a(_);return}n(r)};var f=e.body;typeof f=="string"?r.send(f):f?r.send(JSON.stringify(f)):u?r.send(u):r.send(),requestsUnderway[e.id]=r}).then(function(n){return createResponse(e,n)})}function createRequestXhr(e,r){var n=e.url(r),a=new window.XMLHttpRequest;return a.open(e.method,n),Object.keys(e.headers).forEach(function(u){a.setRequestHeader(u,e.headers[u])}),a}function browserSend(e){return Promise.resolve().then(function(){var r=createRequestXhr(e,e.client.accessToken);return sendRequestXhr(e,r)})}var browserLayer={browserAbort,sendRequestXhr,browserSend,createRequestXhr},base64$1={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */(function(e,r){(function(n){var a=r,u=e&&e.exports==a&&e,f=typeof commonjsGlobal=="object"&&commonjsGlobal;(f.global===f||f.window===f)&&(n=f);var _=function(U){this.message=U};_.prototype=new Error,_.prototype.name="InvalidCharacterError";var o=function(U){throw new _(U)},b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",E=/[\t\n\f\r ]/g,M=function(U){U=String(U).replace(E,"");var X=U.length;X%4==0&&(U=U.replace(/==?$/,""),X=U.length),(X%4==1||/[^+a-zA-Z0-9/]/.test(U))&&o("Invalid character: the string to be decoded is not correctly encoded.");for(var K=0,q,oe,W="",Y=-1;++Y<X;)oe=b.indexOf(U.charAt(Y)),q=K%4?q*64+oe:oe,K++%4&&(W+=String.fromCharCode(255&q>>(-2*K&6)));return W},P=function(U){U=String(U),/[^\0-\xFF]/.test(U)&&o("The string to be encoded contains characters outside of the Latin1 range.");for(var X=U.length%3,K="",q=-1,oe,W,Y,J,Ee=U.length-X;++q<Ee;)oe=U.charCodeAt(q)<<16,W=U.charCodeAt(++q)<<8,Y=U.charCodeAt(++q),J=oe+W+Y,K+=b.charAt(J>>18&63)+b.charAt(J>>12&63)+b.charAt(J>>6&63)+b.charAt(J&63);return X==2?(oe=U.charCodeAt(q)<<8,W=U.charCodeAt(++q),J=oe+W,K+=b.charAt(J>>10)+b.charAt(J>>4&63)+b.charAt(J<<2&63)+"="):X==1&&(J=U.charCodeAt(q),K+=b.charAt(J>>2)+b.charAt(J<<4&63)+"=="),K},L={encode:P,decode:M,version:"0.1.0"};if(a&&!a.nodeType)if(u)u.exports=L;else for(var D in L)L.hasOwnProperty(D)&&(a[D]=L[D]);else n.base64=L})(commonjsGlobal)})(base64$1,base64$1.exports);var base64=base64$1.exports,tokenCache={};function parseToken$2(e){if(tokenCache[e])return tokenCache[e];var r=e.split("."),n=r[0],a=r[1];if(!a)throw new Error("Invalid token");var u=parsePaylod(a),f={usage:n,user:u.u};return has(u,"a")&&(f.authorization=u.a),has(u,"exp")&&(f.expires=u.exp*1e3),has(u,"iat")&&(f.created=u.iat*1e3),has(u,"scopes")&&(f.scopes=u.scopes),has(u,"client")&&(f.client=u.client),has(u,"ll")&&(f.lastLogin=u.ll),has(u,"iu")&&(f.impersonator=u.iu),tokenCache[e]=f,f}function parsePaylod(e){try{return JSON.parse(base64.decode(e))}catch{throw new Error("Invalid token")}}function has(e,r){return Object.prototype.hasOwnProperty.call(e,r)}var parseMapboxToken=parseToken$2,eventemitter3={exports:{}};(function(e){var r=Object.prototype.hasOwnProperty,n="~";function a(){}Object.create&&(a.prototype=Object.create(null),new a().__proto__||(n=!1));function u(b,E,M){this.fn=b,this.context=E,this.once=M||!1}function f(b,E,M,P,L){if(typeof M!="function")throw new TypeError("The listener must be a function");var D=new u(M,P||b,L),U=n?n+E:E;return b._events[U]?b._events[U].fn?b._events[U]=[b._events[U],D]:b._events[U].push(D):(b._events[U]=D,b._eventsCount++),b}function _(b,E){--b._eventsCount===0?b._events=new a:delete b._events[E]}function o(){this._events=new a,this._eventsCount=0}o.prototype.eventNames=function(){var E=[],M,P;if(this._eventsCount===0)return E;for(P in M=this._events)r.call(M,P)&&E.push(n?P.slice(1):P);return Object.getOwnPropertySymbols?E.concat(Object.getOwnPropertySymbols(M)):E},o.prototype.listeners=function(E){var M=n?n+E:E,P=this._events[M];if(!P)return[];if(P.fn)return[P.fn];for(var L=0,D=P.length,U=new Array(D);L<D;L++)U[L]=P[L].fn;return U},o.prototype.listenerCount=function(E){var M=n?n+E:E,P=this._events[M];return P?P.fn?1:P.length:0},o.prototype.emit=function(E,M,P,L,D,U){var X=n?n+E:E;if(!this._events[X])return!1;var K=this._events[X],q=arguments.length,oe,W;if(K.fn){switch(K.once&&this.removeListener(E,K.fn,void 0,!0),q){case 1:return K.fn.call(K.context),!0;case 2:return K.fn.call(K.context,M),!0;case 3:return K.fn.call(K.context,M,P),!0;case 4:return K.fn.call(K.context,M,P,L),!0;case 5:return K.fn.call(K.context,M,P,L,D),!0;case 6:return K.fn.call(K.context,M,P,L,D,U),!0}for(W=1,oe=new Array(q-1);W<q;W++)oe[W-1]=arguments[W];K.fn.apply(K.context,oe)}else{var Y=K.length,J;for(W=0;W<Y;W++)switch(K[W].once&&this.removeListener(E,K[W].fn,void 0,!0),q){case 1:K[W].fn.call(K[W].context);break;case 2:K[W].fn.call(K[W].context,M);break;case 3:K[W].fn.call(K[W].context,M,P);break;case 4:K[W].fn.call(K[W].context,M,P,L);break;default:if(!oe)for(J=1,oe=new Array(q-1);J<q;J++)oe[J-1]=arguments[J];K[W].fn.apply(K[W].context,oe)}}return!0},o.prototype.on=function(E,M,P){return f(this,E,M,P,!1)},o.prototype.once=function(E,M,P){return f(this,E,M,P,!0)},o.prototype.removeListener=function(E,M,P,L){var D=n?n+E:E;if(!this._events[D])return this;if(!M)return _(this,D),this;var U=this._events[D];if(U.fn)U.fn===M&&(!L||U.once)&&(!P||U.context===P)&&_(this,D);else{for(var X=0,K=[],q=U.length;X<q;X++)(U[X].fn!==M||L&&!U[X].once||P&&U[X].context!==P)&&K.push(U[X]);K.length?this._events[D]=K.length===1?K[0]:K:_(this,D)}return this},o.prototype.removeAllListeners=function(E){var M;return E?(M=n?n+E:E,this._events[M]&&_(this,M)):(this._events=new a,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o})(eventemitter3);function encodeArray(e){return e.map(encodeURIComponent).join(",")}function encodeValue(e){return Array.isArray(e)?encodeArray(e):encodeURIComponent(String(e))}function appendQueryParam(e,r,n){if(n===!1||n===null)return e;var a=/\?/.test(e)?"&":"?",u=encodeURIComponent(r);return n!==void 0&&n!==""&&n!==!0&&(u+="="+encodeValue(n)),""+e+a+u}function appendQueryObject(e,r){if(!r)return e;var n=e;return Object.keys(r).forEach(function(a){var u=r[a];u!==void 0&&(Array.isArray(u)&&(u=u.filter(function(f){return f!=null}).join(",")),n=appendQueryParam(n,a,u))}),n}function prependOrigin(e,r){if(!r||e.slice(0,4)==="http")return e;var n=e[0]==="/"?"":"/";return""+r.replace(/\/$/,"")+n+e}function interpolateRouteParams(e,r){return r?e.replace(/\/:([a-zA-Z0-9]+)/g,function(n,a){var u=r[a];if(u===void 0)throw new Error("Unspecified route parameter "+a);var f=encodeValue(u);return"/"+f}):e}var urlUtils$1={appendQueryObject,appendQueryParam,prependOrigin,interpolateRouteParams},parseToken$1=parseMapboxToken,xtend$3=immutable,EventEmitter$1=eventemitter3.exports,urlUtils=urlUtils$1,constants$1=constants$4,requestId=1;function MapiRequest$1(e,r){if(!e)throw new Error("MapiRequest requires a client");if(!r||!r.path||!r.method)throw new Error("MapiRequest requires an options object with path and method properties");var n={};r.body&&(n["content-type"]="application/json");var a=xtend$3(n,r.headers),u=Object.keys(a).reduce(function(f,_){return f[_.toLowerCase()]=a[_],f},{});this.id=requestId++,this._options=r,this.emitter=new EventEmitter$1,this.client=e,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=r.path,this.method=r.method,this.origin=r.origin||e.origin,this.query=r.query||{},this.params=r.params||{},this.body=r.body||null,this.file=r.file||null,this.encoding=r.encoding||"utf8",this.sendFileAs=r.sendFileAs||null,this.headers=u}MapiRequest$1.prototype.url=function e(r){var n=urlUtils.prependOrigin(this.path,this.origin);n=urlUtils.appendQueryObject(n,this.query);var a=this.params,u=r??this.client.accessToken;if(u){n=urlUtils.appendQueryParam(n,"access_token",u);var f=parseToken$1(u).user;a=xtend$3({ownerId:f},a)}return n=urlUtils.interpolateRouteParams(n,a),n};MapiRequest$1.prototype.send=function e(){var r=this;if(r.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return r.sent=!0,r.client.sendRequest(r).then(function(n){return r.response=n,r.emitter.emit(constants$1.EVENT_RESPONSE,n),n},function(n){throw r.error=n,r.emitter.emit(constants$1.EVENT_ERROR,n),n})};MapiRequest$1.prototype.abort=function e(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};MapiRequest$1.prototype.eachPage=function e(r){var n=this;function a(_){function o(){delete n._nextPageRequest;var b=_.nextPage();b&&(n._nextPageRequest=b,f(b))}r(null,_,o)}function u(_){r(_,null,function(){})}function f(_){_.send().then(a,u)}f(this)};MapiRequest$1.prototype.clone=function e(){return this._extend()};MapiRequest$1.prototype._extend=function e(r){var n=xtend$3(this._options,r);return new MapiRequest$1(this.client,n)};var mapiRequest=MapiRequest$1,parseToken=parseMapboxToken,MapiRequest=mapiRequest,constants=constants$4;function MapiClient$2(e){if(!e||!e.accessToken)throw new Error("Cannot create a client without an access token");parseToken(e.accessToken),this.accessToken=e.accessToken,this.origin=e.origin||constants.API_ORIGIN}MapiClient$2.prototype.createRequest=function e(r){return new MapiRequest(this,r)};var mapiClient=MapiClient$2,browser=browserLayer,MapiClient$1=mapiClient;function BrowserClient(e){MapiClient$1.call(this,e)}BrowserClient.prototype=Object.create(MapiClient$1.prototype);BrowserClient.prototype.constructor=BrowserClient;BrowserClient.prototype.sendRequest=browser.browserSend;BrowserClient.prototype.abortRequest=browser.browserAbort;function createBrowserClient(e){return new BrowserClient(e)}var browserClient=createBrowserClient,client=browserClient,mapboxSdk=client,toString=Object.prototype.toString,isPlainObj=function(e){var r;return toString.call(e)==="[object Object]"&&(r=Object.getPrototypeOf(e),r===null||r===Object.getPrototypeOf({}))},isPlainObject=isPlainObj,xtend$2=immutable,DEFAULT_ERROR_PATH="value",NEWLINE_INDENT=`
  `,v$2={};v$2.assert=function(e,r){return r=r||{},function(n){var a=validate(e,n);if(!!a){var u=processMessage(a,r);throw r.apiName&&(u=r.apiName+": "+u),new Error(u)}}};v$2.shape=function e(r){var n=objectEntries(r);return function(u){var f=validate(v$2.plainObject,u);if(f)return f;for(var _,o,b=[],E=0;E<n.length;E++)_=n[E].key,o=n[E].value,f=validate(o,u[_]),f&&b.push([_].concat(f));return b.length<2?b[0]:function(M){b=b.map(function(D){var U=D[0],X=processMessage(D,M).split(`
`).join(NEWLINE_INDENT);return"- "+U+": "+X});var P=M.path.join("."),L=P===DEFAULT_ERROR_PATH?"":" of "+P;return"The following properties"+L+" have invalid values:"+NEWLINE_INDENT+b.join(NEWLINE_INDENT)}}};v$2.strictShape=function e(r){var n=v$2.shape(r);return function(u){var f=n(u);if(f)return f;var _=Object.keys(u).reduce(function(o,b){return r[b]===void 0&&o.push(b),o},[]);if(_.length!==0)return function(){return"The following keys are invalid: "+_.join(", ")}}};v$2.arrayOf=function e(r){return createArrayValidator(r)};v$2.tuple=function e(){var r=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return createArrayValidator(r)};function createArrayValidator(e){var r=Array.isArray(e),n=function(a){return r?e[a]:e};return function(u){var f=validate(v$2.plainArray,u);if(f)return f;if(r&&u.length!==e.length)return"an array with "+e.length+" items";for(var _=0;_<u.length;_++)if(f=validate(n(_),u[_]),f)return[_].concat(f)}}v$2.required=function e(r){function n(a){return a==null?function(u){return formatErrorMessage(u,isArrayCulprit(u.path)?"cannot be undefined/null.":"is required.")}:r.apply(this,arguments)}return n.__required=!0,n};v$2.oneOfType=function e(){var r=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(a){var u=r.map(function(f){return validate(f,a)}).filter(Boolean);if(u.length===r.length)return u.every(function(f){return f.length===1&&typeof f[0]=="string"})?orList(u.map(function(f){return f[0]})):u.reduce(function(f,_){return _.length>f.length?_:f})}};v$2.equal=function e(r){return function(a){if(a!==r)return JSON.stringify(r)}};v$2.oneOf=function e(){var r=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),n=r.map(function(a){return v$2.equal(a)});return v$2.oneOfType.apply(this,n)};v$2.range=function e(r){var n=r[0],a=r[1];return function(f){var _=validate(v$2.number,f);if(_||f<n||f>a)return"number between "+n+" & "+a+" (inclusive)"}};v$2.any=function e(){};v$2.boolean=function e(r){if(typeof r!="boolean")return"boolean"};v$2.number=function e(r){if(typeof r!="number")return"number"};v$2.plainArray=function e(r){if(!Array.isArray(r))return"array"};v$2.plainObject=function e(r){if(!isPlainObject(r))return"object"};v$2.string=function e(r){if(typeof r!="string")return"string"};v$2.func=function e(r){if(typeof r!="function")return"function"};function validate(e,r){if(!(r==null&&!e.hasOwnProperty("__required"))){var n=e(r);if(n)return Array.isArray(n)?n:[n]}}function processMessage(e,r){var n=e.length,a=e[n-1],u=e.slice(0,n-1);return u.length===0&&(u=[DEFAULT_ERROR_PATH]),r=xtend$2(r,{path:u}),typeof a=="function"?a(r):formatErrorMessage(r,prettifyResult(a))}function orList(e){return e.length<2?e[0]:e.length===2?e.join(" or "):e.slice(0,-1).join(", ")+", or "+e.slice(-1)}function prettifyResult(e){return"must be "+addArticle(e)+"."}function addArticle(e){return/^an? /.test(e)?e:/^[aeiou]/i.test(e)?"an "+e:/^[a-z]/i.test(e)?"a "+e:e}function formatErrorMessage(e,r){var n=isArrayCulprit(e.path),a=e.path.join(".")+" "+r,u=n?"Item at position ":"";return u+a}function isArrayCulprit(e){return typeof e[e.length-1]=="number"||typeof e[0]=="number"}function objectEntries(e){return Object.keys(e||{}).map(function(r){return{key:r,value:e[r]}})}v$2.validate=validate;v$2.processMessage=processMessage;var lib$1=v$2,xtend$1=immutable,v$1=lib$1;function file(e){if(typeof window<"u")return e instanceof commonjsGlobal.Blob||e instanceof commonjsGlobal.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof e=="string"||e.pipe!==void 0))return"Filename or Readable stream"}function assertShape(e,r){return v$1.assert(v$1.strictShape(e),r)}function date(e){var r="date";if(typeof e=="boolean")return r;try{var n=new Date(e);if(n.getTime&&isNaN(n.getTime()))return r}catch{return r}}function coordinates(e){return v$1.tuple(v$1.number,v$1.number)(e)}var validator=xtend$1(v$1,{file,date,coordinates,assertShape});function pick$1(e,r){var n=function(a,u){return r.indexOf(a)!==-1&&u!==void 0};return typeof r=="function"&&(n=r),Object.keys(e).filter(function(a){return n(a,e[a])}).reduce(function(a,u){return a[u]=e[u],a},{})}var pick_1=pick$1;function objectMap$1(e,r){return Object.keys(e).reduce(function(n,a){return n[a]=r(a,e[a]),n},{})}var objectMap_1=objectMap$1,objectMap=objectMap_1;function stringifyBoolean(e){return objectMap(e,function(r,n){return typeof n=="boolean"?JSON.stringify(n):n})}var stringifyBooleans$1=stringifyBoolean,MapiClient=mapiClient,createClient=browserClient;function createServiceFactory$1(e){return function(r){var n;MapiClient.prototype.isPrototypeOf(r)?n=r:n=createClient(r);var a=Object.create(e);return a.client=n,a}}var createServiceFactory_1=createServiceFactory$1,xtend=immutable,v=validator,pick=pick_1,stringifyBooleans=stringifyBooleans$1,createServiceFactory=createServiceFactory_1,Geocoding={},featureTypes=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Geocoding.forwardGeocode=function(e){v.assertShape({query:v.required(v.string),mode:v.oneOf("mapbox.places","mapbox.places-permanent"),countries:v.arrayOf(v.string),proximity:v.oneOf(v.coordinates,"ip"),types:v.arrayOf(v.oneOf(featureTypes)),autocomplete:v.boolean,bbox:v.arrayOf(v.number),limit:v.number,language:v.arrayOf(v.string),routing:v.boolean,fuzzyMatch:v.boolean,worldview:v.string})(e),e.mode=e.mode||"mapbox.places";var r=stringifyBooleans(xtend({country:e.countries},pick(e,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(e,["mode","query"]),query:r})};Geocoding.reverseGeocode=function(e){v.assertShape({query:v.required(v.coordinates),mode:v.oneOf("mapbox.places","mapbox.places-permanent"),countries:v.arrayOf(v.string),types:v.arrayOf(v.oneOf(featureTypes)),bbox:v.arrayOf(v.number),limit:v.number,language:v.arrayOf(v.string),reverseMode:v.oneOf("distance","score"),routing:v.boolean,worldview:v.string})(e),e.mode=e.mode||"mapbox.places";var r=stringifyBooleans(xtend({country:e.countries},pick(e,["country","types","bbox","limit","language","reverseMode","routing","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(e,["mode","query"]),query:r})};var geocoding=createServiceFactory(Geocoding);let urlAlphabet="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",random=e=>crypto.getRandomValues(new Uint8Array(e)),customRandom=(e,r,n)=>{let a=(2<<Math.log(e.length-1)/Math.LN2)-1,u=-~(1.6*a*r/e.length);return(f=r)=>{let _="";for(;;){let o=n(u),b=u;for(;b--;)if(_+=e[o[b]&a]||"",_.length===f)return _}}},customAlphabet=(e,r=21)=>customRandom(e,r,random),nanoid$1=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((r,n)=>(n&=63,n<36?r+=n.toString(36):n<62?r+=(n-26).toString(36).toUpperCase():n>62?r+="-":r+="_",r),"");var index_browser=Object.freeze(Object.defineProperty({__proto__:null,nanoid:nanoid$1,customAlphabet,customRandom,urlAlphabet,random},Symbol.toStringTag,{value:"Module"})),require$$0=getAugmentedNamespace(index_browser),nanoid=require$$0.nanoid;function MapboxEventManager$1(e){this.origin=e.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=e.accessToken,this.version="0.2.0",this.sessionID=this.generateSessionID(),this.userAgent=this.getUserAgent(),this.options=e,this.send=this.send.bind(this),this.countries=e.countries?e.countries.split(","):null,this.types=e.types?e.types.split(","):null,this.bbox=e.bbox?e.bbox:null,this.language=e.language?e.language.split(","):null,this.limit=e.limit?+e.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(e),this.eventQueue=new Array,this.flushInterval=e.flushInterval||1e3,this.maxQueueSize=e.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}MapboxEventManager$1.prototype={select:function(e,r){var n=this.getSelectedIndex(e,r),a=this.getEventPayload("search.select",r);if(a.resultIndex=n,a.resultPlaceName=e.place_name,a.resultId=e.id,!(n===this.lastSentIndex&&a.queryString===this.lastSentInput||n==-1)&&(this.lastSentIndex=n,this.lastSentInput=a.queryString,!!a.queryString))return this.push(a)},start:function(e){var r=this.getEventPayload("search.start",e);if(!!r.queryString)return this.push(r)},keyevent:function(e,r){if(!!e.key&&!(e.metaKey||[9,27,37,39,13,38,40].indexOf(e.keyCode)!==-1)){var n=this.getEventPayload("search.keystroke",r);if(n.lastAction=e.key,!!n.queryString)return this.push(n)}},send:function(e,r){if(!this.enableEventLogging)return r?r():void 0;var n=this.getRequestOptions(e);this.request(n,function(a){if(a)return this.handleError(a,r);if(r)return r()}.bind(this))},getRequestOptions:function(e){Array.isArray(e)||(e=[e]);var r={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};return r},getEventPayload:function(e,r){var n;r.options.proximity?typeof r.options.proximity=="object"?n=[r.options.proximity.longitude,r.options.proximity.latitude]:r.options.proximity==="ip"?n=[999,999]:n=r.options.proximity:n=null;var a=r._map?r._map.getZoom():void 0,u={event:e,created:+new Date,sessionIdentifier:this.sessionID,country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:r.options.autocomplete,fuzzyMatch:r.options.fuzzyMatch,proximity:n,limit:r.options.limit,routing:r.options.routing,worldview:r.options.worldview,mapZoom:a,keyboardLocale:this.locale};return e==="search.select"?u.queryString=r.inputString:e!="search.select"&&r._inputEl?u.queryString=r._inputEl.value:u.queryString=r.inputString,u},request:function(e,r){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(this.readyState==4)return this.status==204?r(null):r(this.statusText)},n.open(e.method,e.host+"/"+e.path,!0);for(var a in e.headers){var u=e.headers[a];n.setRequestHeader(a,u)}n.send(e.body)},handleError:function(e,r){if(r)return r(e)},generateSessionID:function(){return nanoid()},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(e,r){if(!!r._typeahead){var n=r._typeahead.data,a=e.id,u=n.map(function(_){return _.id}),f=u.indexOf(a);return f}},shouldEnableLogging:function(e){return!(e.enableEventLogging===!1||e.origin&&e.origin!=="https://api.mapbox.com"||e.localGeocoder||e.filter)},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(e,r){this.eventQueue.push(e),(this.eventQueue.length>=this.maxQueueSize||r)&&this.flush()},remove:function(){this.flush()}};var events=MapboxEventManager$1,placeholder={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"\u05DC\u05D7\u05E4\u05E9",ja:"\u30B5\u30FC\u30C1",lv:"Mekl\u0113t",pt:"Procurar",sr:"\u041F\u0440\u0435\u0442\u0440\u0430\u0433\u0430",zh:"\u641C\u7D22",cs:"Vyhled\xE1v\xE1n\xED",hu:"Keres\xE9s",ka:"\u10EB\u10D8\u10D4\u10D1\u10D0",nb:"S\xF8ke",sk:"Vyh\u013Ead\xE1vanie",th:"\u0E04\u0E49\u0E19\u0E2B\u0E32",fi:"Hae",is:"Leita",ko:"\uC218\uC0C9",pl:"Szukaj",sl:"Iskanje",fa:"\u062C\u0633\u062A\u062C\u0648",ru:"\u041F\u043E\u0438\u0441\u043A"},localization$1={placeholder},subtag$1={exports:{}};(function(e){(function(r,n,a){e.exports?e.exports=a():r[n]=a()})(commonjsGlobal,"subtag",function(){var r="",n=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function a(b){return b.match(n)||[]}function u(b){return a(b).filter(function(E,M){return E&&M})}function f(b){return b=a(b),{language:b[1]||r,extlang:b[2]||r,script:b[3]||r,region:b[4]||r}}function _(b,E,M){Object.defineProperty(b,E,{value:M,enumerable:!0})}function o(b,E,M){function P(L){return a(L)[b]||r}_(P,"pattern",E),_(f,M,P)}return o(1,/^[a-zA-Z]{2,3}$/,"language"),o(2,/^[a-zA-Z]{3}$/,"extlang"),o(3,/^[a-zA-Z]{4}$/,"script"),o(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),_(f,"split",u),f})})(subtag$1);function Geolocation$1(){}Geolocation$1.prototype={isSupport:function(){return Boolean(window.navigator.geolocation)},getCurrentPosition:function(){const e={enableHighAccuracy:!0};return new Promise(function(r,n){window.navigator.geolocation.getCurrentPosition(r,n,e)})}};var geolocation=Geolocation$1;function transformFeatureToGeolocationText(e,r){const n=getAddressInfo(e),a=["address","street","place","country"];var u;if(typeof r=="function")return r(n);const f=a.indexOf(r);return f===-1?u=a:u=a.slice(f),u.reduce(function(_,o){return n[o]?(_!==""&&(_=_+", "),_+n[o]):_},"")}function getAddressInfo(e){const r=e.address||"",n=e.text||"",a=e.place_name||"",f={address:a.split(",")[0],houseNumber:r,street:n,placeName:a};return e.context.forEach(function(_){const o=_.id.split(".")[0];f[o]=_.text}),f}const REVERSE_GEOCODE_COORD_RGX=/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/;var utils$1={transformFeatureToGeolocationText,getAddressInfo,REVERSE_GEOCODE_COORD_RGX},Typeahead=suggestions,debounce=lodash_debounce,extend=immutable,EventEmitter=events$1.exports.EventEmitter,exceptions=exceptions$1,MapboxClient=mapboxSdk,mbxGeocoder=geocoding,MapboxEventManager=events,localization=localization$1,subtag=subtag$1.exports,Geolocation=geolocation,utils=utils$1;const GEOCODE_REQUEST_TYPE={FORWARD:0,LOCAL:1,REVERSE:2};function getFooterNode(){var e=document.createElement("div");return e.className="mapboxgl-ctrl-geocoder--powered-by",e.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',e}function MapboxGeocoder(e){this._eventEmitter=new EventEmitter,this.options=extend({},this.options,e),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new Geolocation}MapboxGeocoder.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",getItemValue:function(e){return e.place_name},render:function(e){var r=e.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+r[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+r.splice(1,r.length).join(",")+"</div></div>"}},addTo:function(e){function r(n,a){if(!document.body.contains(a))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const u=n.onAdd();a.appendChild(u)}if(e._controlContainer)e.addControl(this);else if(e instanceof HTMLElement)r(this,e);else if(typeof e=="string"){const n=document.querySelectorAll(e);if(n.length===0)throw new Error("Element ",e,"not found.");if(n.length>1)throw new Error("Geocoder can only be added to a single html element");r(this,n[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(e){if(e&&typeof e!="string"&&(this._map=e),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new MapboxEventManager(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this);var r=this.container=document.createElement("div");r.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var n=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",debounce(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",function(E){this.eventManager.keyevent(E,this)}.bind(this));var a=document.createElement("div");a.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var u=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(u),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),a.appendChild(this._clearEl),a.appendChild(this._loadingEl),r.appendChild(n),r.appendChild(this._inputEl),r.appendChild(a),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var f=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(f),a.appendChild(this._geolocateEl),this._showGeolocateButton()}var _=this._typeahead=new Typeahead(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit});this.setRenderFunction(this.options.render),_.getItemValue=this.options.getItemValue;var o=_.list.draw,b=this._footerNode=getFooterNode();return _.list.draw=function(){o.call(this),b.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),b.addEventListener("mouseup",function(){this.selectingListItem=!1}.bind(this)),this.element.appendChild(b)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),r},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then(function(e){this._hideLoadingIcon();const r={geometry:{type:"Point",coordinates:[e.coords.longitude,e.coords.latitude]}};this._handleMarker(r),this._fly(r),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(r),this._showClearButton(),this.fresh=!1;const n={limit:1,language:[this.options.language],query:r.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){const a=r.geometry.coordinates[0]+","+r.geometry.coordinates[1];this._setInputValue(a),this._eventEmitter.emit("result",{result:r})}else this.geocoderService.reverseGeocode(n).send().then(function(a){const u=a.body.features[0];if(u){const f=utils.transformFeatureToGeolocationText(u,this.options.addressAccuracy);this._setInputValue(f),u.user_coordinates=r.geometry.coordinates,this._eventEmitter.emit("result",{result:u})}else this._eventEmitter.emit("result",{result:{user_coordinates:r.geometry.coordinates}})}.bind(this))}.bind(this)).catch(function(e){e.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}.bind(this))},createIcon:function(e,r){var n=document.createElementNS("http://www.w3.org/2000/svg","svg");return n.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+e),n.setAttribute("viewBox","0 0 18 18"),n.setAttribute("xml:space","preserve"),n.setAttribute("width",18),n.setAttribute("height",18),n.innerHTML=r,n},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(e){this._inputEl.value=e,setTimeout(function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}.bind(this),1)},_onPaste:function(e){var r=(e.clipboardData||window.clipboardData).getData("text");r.length>=this.options.minLength&&this._geocode(r)},_onKeyDown:function(e){var r=27,n=9;if(e.keyCode===r&&this.options.clearAndBlurOnEsc)return this._clear(e),this._inputEl.blur();var a=e.target&&e.target.shadowRoot?e.target.shadowRoot.activeElement:e.target,u=a?a.value:"";if(!u)return this.fresh=!0,e.keyCode!==n&&this.clear(e),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(e.metaKey||[n,r,37,39,13,38,40].indexOf(e.keyCode)!==-1)&&a.value.length>=this.options.minLength&&this._geocode(a.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(e){this.options.clearOnBlur&&this._clearOnBlur(e),this.options.collapsed&&this._collapse()},_onChange:function(){var e=this._typeahead.selected;e&&JSON.stringify(e)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(e),this.options.marker&&this._mapboxgl&&this._handleMarker(e),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(e),this._eventEmitter.emit("result",{result:e}),this.eventManager.select(e,this))},_fly:function(e){var r;if(e.properties&&exceptions[e.properties.short_code])r=extend({},this.options.flyTo),this._map&&this._map.fitBounds(exceptions[e.properties.short_code].bbox,r);else if(e.bbox){var n=e.bbox;r=extend({},this.options.flyTo),this._map&&this._map.fitBounds([[n[0],n[1]],[n[2],n[3]]],r)}else{var a={zoom:this.options.zoom};r=extend({},a,this.options.flyTo),e.center?r.center=e.center:e.geometry&&e.geometry.type&&e.geometry.type==="Point"&&e.geometry.coordinates&&(r.center=e.geometry.coordinates),this._map&&this._map.flyTo(r)}},_requestType:function(e,r){var n;return e.localGeocoderOnly?n=GEOCODE_REQUEST_TYPE.LOCAL:e.reverseGeocode&&utils.REVERSE_GEOCODE_COORD_RGX.test(r)?n=GEOCODE_REQUEST_TYPE.REVERSE:n=GEOCODE_REQUEST_TYPE.FORWARD,n},_setupConfig:function(e,r){const n=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],a=/[\s,]+/;var u=this,f=n.reduce(function(o,b){if(u.options[b]===void 0||u.options[b]===null)return o;["countries","types","language"].indexOf(b)>-1?o[b]=u.options[b].split(a):o[b]=u.options[b];const E=typeof u.options[b].longitude=="number"&&typeof u.options[b].latitude=="number";if(b==="proximity"&&E){const M=u.options[b].longitude,P=u.options[b].latitude;o[b]=[M,P]}return o},{});switch(e){case GEOCODE_REQUEST_TYPE.REVERSE:{var _=r.split(a).map(function(o){return parseFloat(o,10)});u.options.flipCoordinates||_.reverse(),f.types&&f.types[0],f=extend(f,{query:_,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(o){o in f&&delete f[o]})}break;case GEOCODE_REQUEST_TYPE.FORWARD:{const o=r.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(o)&&(r=r.replace(/,/g," ")),f=extend(f,{query:r})}break}return f},_geocode:function(e){this.inputString=e,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:e});const r=this._requestType(this.options,e),n=this._setupConfig(r,e);var a;switch(r){case GEOCODE_REQUEST_TYPE.LOCAL:a=Promise.resolve();break;case GEOCODE_REQUEST_TYPE.FORWARD:a=this.geocoderService.forwardGeocode(n).send();break;case GEOCODE_REQUEST_TYPE.REVERSE:a=this.geocoderService.reverseGeocode(n).send();break}var u=this.options.localGeocoder?this.options.localGeocoder(e)||[]:[],f=[],_=null;return a.catch(function(o){_=o}.bind(this)).then(function(o){this._hideLoadingIcon();var b={};return o?o.statusCode=="200"&&(b=o.body,b.request=o.request,b.headers=o.headers):b={type:"FeatureCollection",features:[]},b.config=n,this.fresh&&(this.eventManager.start(this),this.fresh=!1),b.features=b.features?u.concat(b.features):u,this.options.externalGeocoder?(f=this.options.externalGeocoder(e,b.features)||Promise.resolve([]),f.then(function(E){return b.features=b.features?E.concat(b.features):E,b},function(){return b})):b}.bind(this)).then(function(o){if(_)throw _;this.options.filter&&o.features.length&&(o.features=o.features.filter(this.options.filter)),o.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",o),this._typeahead.update(o.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",o))}.bind(this)).catch(function(o){this._hideLoadingIcon(),this._hideAttribution(),u.length&&this.options.localGeocoder||f.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(u)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:u}),this._eventEmitter.emit("error",{error:o})}.bind(this)),a},_clear:function(e){e&&e.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(e){this._clear(e),this._inputEl.focus()},_clearOnBlur:function(e){var r=this;e.relatedTarget&&r._clear(e)},_onQueryResult:function(e){var r=e.body;if(!!r.features.length){var n=r.features[0];this._typeahead.selected=n,this._inputEl.value=n.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var e=this._map.getCenter().wrap();this.setProximity({longitude:e.lng,latitude:e.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(e){return this._geocode(e).then(this._onQueryResult),this},_renderError:function(){var e="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(e)},_renderLocationError:function(){var e="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(e)},_renderNoResults:function(){var e="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(e)},_renderUserDeniedGeolocationError:function(){var e="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(e)},_renderMessage:function(e){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(e)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var e=this.options.language.split(",")[0],r=subtag.language(e),n=localization.placeholder[r];if(n)return n}return"Search"},setInput:function(e){return this._inputEl.value=e,this._typeahead.selected=null,this._typeahead.clear(),e.length>=this.options.minLength&&this._geocode(e),this},setProximity:function(e,r=!0){return this.options.proximity=e,r&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(e){return e&&typeof e=="function"&&(this._typeahead.render=e),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(e){var r=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=e||this.options.language||r,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(e){return this.options.zoom=e,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(e){return this.options.flyTo=e,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(e){return this.placeholder=e||this._getPlaceholderText(),this._inputEl.placeholder=this.placeholder,this._inputEl.setAttribute("aria-label",this.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(e){return this.options.bbox=e,this},getCountries:function(){return this.options.countries},setCountries:function(e){return this.options.countries=e,this},getTypes:function(){return this.options.types},setTypes:function(e){return this.options.types=e,this},getMinLength:function(){return this.options.minLength},setMinLength:function(e){return this.options.minLength=e,this._typeahead&&(this._typeahead.options.minLength=e),this},getLimit:function(){return this.options.limit},setLimit:function(e){return this.options.limit=e,this._typeahead&&(this._typeahead.options.limit=e),this},getFilter:function(){return this.options.filter},setFilter:function(e){return this.options.filter=e,this},setOrigin:function(e){return this.options.origin=e,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(e){return this.options.accessToken=e,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(e){return this.options.autocomplete=e,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(e){return this.options.fuzzyMatch=e,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(e){return this.options.routing=e,this},getRouting:function(){return this.options.routing},setWorldview:function(e){return this.options.worldview=e,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(e){if(!!this._map){this._removeMarker();var r={color:"#4668F2"},n=extend({},r,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(n),e.center?this.mapMarker.setLngLat(e.center).addTo(this._map):e.geometry&&e.geometry.type&&e.geometry.type==="Point"&&e.geometry.coordinates&&this.mapMarker.setLngLat(e.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(e,r){return this._eventEmitter.on(e,r),this},off:function(e,r){return this._eventEmitter.removeListener(e,r),this.eventManager.remove(),this}};var lib=MapboxGeocoder,mapboxGlDraw$1={exports:{}};(function(e,r){(function(n,a){e.exports=a()})(commonjsGlobal,function(){var n=function(B,j){var ae={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},Ue={on:function(Ye,et,jt){if(ae[Ye]===void 0)throw new Error("Invalid event type: "+Ye);ae[Ye].push({selector:et,fn:jt})},render:function(Ye){j.store.featureChanged(Ye)}},nt=function(Ye,et){for(var jt=ae[Ye],Ot=jt.length;Ot--;){var ei=jt[Ot];if(ei.selector(et)){ei.fn.call(Ue,et)||j.store.render(),j.ui.updateMapClasses();break}}};return B.start.call(Ue),{render:B.render,stop:function(){B.stop&&B.stop()},trash:function(){B.trash&&(B.trash(),j.store.render())},combineFeatures:function(){B.combineFeatures&&B.combineFeatures()},uncombineFeatures:function(){B.uncombineFeatures&&B.uncombineFeatures()},drag:function(Ye){nt("drag",Ye)},click:function(Ye){nt("click",Ye)},mousemove:function(Ye){nt("mousemove",Ye)},mousedown:function(Ye){nt("mousedown",Ye)},mouseup:function(Ye){nt("mouseup",Ye)},mouseout:function(Ye){nt("mouseout",Ye)},keydown:function(Ye){nt("keydown",Ye)},keyup:function(Ye){nt("keyup",Ye)},touchstart:function(Ye){nt("touchstart",Ye)},touchmove:function(Ye){nt("touchmove",Ye)},touchend:function(Ye){nt("touchend",Ye)},tap:function(Ye){nt("tap",Ye)}}},a=6378137;function u(B){var j=0;if(B&&B.length>0){j+=Math.abs(f(B[0]));for(var ae=1;ae<B.length;ae++)j-=Math.abs(f(B[ae]))}return j}function f(B){var j,ae,Ue,nt,Ye,et,jt=0,Ot=B.length;if(Ot>2){for(et=0;et<Ot;et++)et===Ot-2?(Ue=Ot-2,nt=Ot-1,Ye=0):et===Ot-1?(Ue=Ot-1,nt=0,Ye=1):(Ue=et,nt=et+1,Ye=et+2),j=B[Ue],ae=B[nt],jt+=(_(B[Ye][0])-_(j[0]))*Math.sin(_(ae[1]));jt=jt*a*a/2}return jt}function _(B){return B*Math.PI/180}var o={geometry:function B(j){var ae,Ue=0;switch(j.type){case"Polygon":return u(j.coordinates);case"MultiPolygon":for(ae=0;ae<j.coordinates.length;ae++)Ue+=u(j.coordinates[ae]);return Ue;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(ae=0;ae<j.geometries.length;ae++)Ue+=B(j.geometries[ae]);return Ue}},ring:f},b="mapboxgl-ctrl",E="mapbox-gl-draw_ctrl-draw-btn",M="mapbox-gl-draw_line",P="mapbox-gl-draw_polygon",L="mapbox-gl-draw_point",D="mapbox-gl-draw_trash",U="mapbox-gl-draw_combine",X="mapbox-gl-draw_uncombine",K="mapboxgl-ctrl-group",q="active",oe="mapbox-gl-draw_boxselect",W="mapbox-gl-draw-hot",Y="mapbox-gl-draw-cold",J="add",Ee="move",xe="drag",se="pointer",ce="none",ee={POLYGON:"polygon",LINE:"line_string",POINT:"point"},he="Feature",Ie="Polygon",Pe="LineString",Qe="Point",We="FeatureCollection",Zt="Multi",ti="MultiPoint",$t="MultiLineString",oi="MultiPolygon",je={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select",STATIC:"static"},_t="draw.create",Bt="draw.delete",dt="draw.update",At="draw.selectionchange",Tt="draw.modechange",Dt="draw.actionable",Ct="draw.render",pi="draw.combine",yt="draw.uncombine",vi="move",$i="change_coordinates",yi="feature",mi="midpoint",It="vertex",kt="true",Ri="false",Pi=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],zi={Point:0,LineString:1,Polygon:2};function ht(B,j){var ae=zi[B.geometry.type]-zi[j.geometry.type];return ae===0&&B.geometry.type===Ie?B.area-j.area:ae}function Gt(B){if(this._items={},this._nums={},this._length=B?B.length:0,B)for(var j=0,ae=B.length;j<ae;j++)this.add(B[j]),B[j]!==void 0&&(typeof B[j]=="string"?this._items[B[j]]=j:this._nums[B[j]]=j)}Gt.prototype.add=function(B){return this.has(B)||(this._length++,typeof B=="string"?this._items[B]=this._length:this._nums[B]=this._length),this},Gt.prototype.delete=function(B){return this.has(B)===!1||(this._length--,delete this._items[B],delete this._nums[B]),this},Gt.prototype.has=function(B){return(typeof B=="string"||typeof B=="number")&&(this._items[B]!==void 0||this._nums[B]!==void 0)},Gt.prototype.values=function(){var B=this,j=[];return Object.keys(this._items).forEach(function(ae){j.push({k:ae,v:B._items[ae]})}),Object.keys(this._nums).forEach(function(ae){j.push({k:JSON.parse(ae),v:B._nums[ae]})}),j.sort(function(ae,Ue){return ae.v-Ue.v}).map(function(ae){return ae.k})},Gt.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};var di=[yi,mi,It],si={click:function(B,j,ae){return Ae(B,j,ae,ae.options.clickBuffer)},touch:function(B,j,ae){return Ae(B,j,ae,ae.options.touchBuffer)}};function Ae(B,j,ae,Ue){if(ae.map===null)return[];var nt=B?function(ei,Ke){return Ke===void 0&&(Ke=0),[[ei.point.x-Ke,ei.point.y-Ke],[ei.point.x+Ke,ei.point.y+Ke]]}(B,Ue):j,Ye={};ae.options.styles&&(Ye.layers=ae.options.styles.map(function(ei){return ei.id}));var et=ae.map.queryRenderedFeatures(nt,Ye).filter(function(ei){return di.indexOf(ei.properties.meta)!==-1}),jt=new Gt,Ot=[];return et.forEach(function(ei){var Ke=ei.properties.id;jt.has(Ke)||(jt.add(Ke),Ot.push(ei))}),function(ei){return ei.map(function(Ke){return Ke.geometry.type===Ie&&(Ke.area=o.geometry({type:he,property:{},geometry:Ke.geometry})),Ke}).sort(ht).map(function(Ke){return delete Ke.area,Ke})}(Ot)}function xt(B,j){var ae=si.click(B,null,j),Ue={mouse:ce};return ae[0]&&(Ue.mouse=ae[0].properties.active===kt?Ee:se,Ue.feature=ae[0].properties.meta),j.events.currentModeName().indexOf("draw")!==-1&&(Ue.mouse=J),j.ui.queueMapClasses(Ue),j.ui.updateMapClasses(),ae[0]}function Xt(B,j){var ae=B.x-j.x,Ue=B.y-j.y;return Math.sqrt(ae*ae+Ue*Ue)}function Nt(B,j,ae){ae===void 0&&(ae={});var Ue=ae.fineTolerance!=null?ae.fineTolerance:4,nt=ae.grossTolerance!=null?ae.grossTolerance:12,Ye=ae.interval!=null?ae.interval:500;B.point=B.point||j.point,B.time=B.time||j.time;var et=Xt(B.point,j.point);return et<Ue||et<nt&&j.time-B.time<Ye}function Yt(B,j,ae){ae===void 0&&(ae={});var Ue=ae.tolerance!=null?ae.tolerance:25,nt=ae.interval!=null?ae.interval:250;return B.point=B.point||j.point,B.time=B.time||j.time,Xt(B.point,j.point)<Ue&&j.time-B.time<nt}function ii(B,j){return B(j={exports:{}},j.exports),j.exports}var Rt=ii(function(B){var j=B.exports=function(ae,Ue){if(Ue||(Ue=16),ae===void 0&&(ae=128),ae<=0)return"0";for(var nt=Math.log(Math.pow(2,ae))/Math.log(Ue),Ye=2;nt===1/0;Ye*=2)nt=Math.log(Math.pow(2,ae/Ye))/Math.log(Ue)*Ye;var et=nt-Math.floor(nt),jt="";for(Ye=0;Ye<Math.floor(nt);Ye++)jt=Math.floor(Math.random()*Ue).toString(Ue)+jt;if(et){var Ot=Math.pow(Ue,et);jt=Math.floor(Math.random()*Ot).toString(Ue)+jt}var ei=parseInt(jt,Ue);return ei!==1/0&&ei>=Math.pow(2,ae)?j(ae,Ue):jt};j.rack=function(ae,Ue,nt){var Ye=function(jt){var Ot=0;do{if(Ot++>10){if(!nt)throw new Error("too many ID collisions, use more bits");ae+=nt}var ei=j(ae,Ue)}while(Object.hasOwnProperty.call(et,ei));return et[ei]=jt,ei},et=Ye.hats={};return Ye.get=function(jt){return Ye.hats[jt]},Ye.set=function(jt,Ot){return Ye.hats[jt]=Ot,Ye},Ye.bits=ae||128,Ye.base=Ue||16,Ye}}),Kt=function(B,j){this.ctx=B,this.properties=j.properties||{},this.coordinates=j.geometry.coordinates,this.id=j.id||Rt(),this.type=j.geometry.type};Kt.prototype.changed=function(){this.ctx.store.featureChanged(this.id)},Kt.prototype.incomingCoords=function(B){this.setCoordinates(B)},Kt.prototype.setCoordinates=function(B){this.coordinates=B,this.changed()},Kt.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))},Kt.prototype.setProperty=function(B,j){this.properties[B]=j},Kt.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:he,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))},Kt.prototype.internal=function(B){var j={id:this.id,meta:yi,"meta:type":this.type,active:Ri,mode:B};if(this.ctx.options.userProperties)for(var ae in this.properties)j["user_"+ae]=this.properties[ae];return{type:he,properties:j,geometry:{coordinates:this.getCoordinates(),type:this.type}}};var Li=function(B,j){Kt.call(this,B,j)};(Li.prototype=Object.create(Kt.prototype)).isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"},Li.prototype.updateCoordinate=function(B,j,ae){this.coordinates=arguments.length===3?[j,ae]:[B,j],this.changed()},Li.prototype.getCoordinate=function(){return this.getCoordinates()};var Ii=function(B,j){Kt.call(this,B,j)};(Ii.prototype=Object.create(Kt.prototype)).isValid=function(){return this.coordinates.length>1},Ii.prototype.addCoordinate=function(B,j,ae){this.changed();var Ue=parseInt(B,10);this.coordinates.splice(Ue,0,[j,ae])},Ii.prototype.getCoordinate=function(B){var j=parseInt(B,10);return JSON.parse(JSON.stringify(this.coordinates[j]))},Ii.prototype.removeCoordinate=function(B){this.changed(),this.coordinates.splice(parseInt(B,10),1)},Ii.prototype.updateCoordinate=function(B,j,ae){var Ue=parseInt(B,10);this.coordinates[Ue]=[j,ae],this.changed()};var Fi=function(B,j){Kt.call(this,B,j),this.coordinates=this.coordinates.map(function(ae){return ae.slice(0,-1)})};(Fi.prototype=Object.create(Kt.prototype)).isValid=function(){return this.coordinates.length!==0&&this.coordinates.every(function(B){return B.length>2})},Fi.prototype.incomingCoords=function(B){this.coordinates=B.map(function(j){return j.slice(0,-1)}),this.changed()},Fi.prototype.setCoordinates=function(B){this.coordinates=B,this.changed()},Fi.prototype.addCoordinate=function(B,j,ae){this.changed();var Ue=B.split(".").map(function(nt){return parseInt(nt,10)});this.coordinates[Ue[0]].splice(Ue[1],0,[j,ae])},Fi.prototype.removeCoordinate=function(B){this.changed();var j=B.split(".").map(function(Ue){return parseInt(Ue,10)}),ae=this.coordinates[j[0]];ae&&(ae.splice(j[1],1),ae.length<3&&this.coordinates.splice(j[0],1))},Fi.prototype.getCoordinate=function(B){var j=B.split(".").map(function(Ue){return parseInt(Ue,10)}),ae=this.coordinates[j[0]];return JSON.parse(JSON.stringify(ae[j[1]]))},Fi.prototype.getCoordinates=function(){return this.coordinates.map(function(B){return B.concat([B[0]])})},Fi.prototype.updateCoordinate=function(B,j,ae){this.changed();var Ue=B.split("."),nt=parseInt(Ue[0],10),Ye=parseInt(Ue[1],10);this.coordinates[nt]===void 0&&(this.coordinates[nt]=[]),this.coordinates[nt][Ye]=[j,ae]};var Xi={MultiPoint:Li,MultiLineString:Ii,MultiPolygon:Fi},rr=function(B,j,ae,Ue,nt){var Ye=ae.split("."),et=parseInt(Ye[0],10),jt=Ye[1]?Ye.slice(1).join("."):null;return B[et][j](jt,Ue,nt)},Ki=function(B,j){if(Kt.call(this,B,j),delete this.coordinates,this.model=Xi[j.geometry.type],this.model===void 0)throw new TypeError(j.geometry.type+" is not a valid type");this.features=this._coordinatesToFeatures(j.geometry.coordinates)};function Ci(B){this.map=B.map,this.drawConfig=JSON.parse(JSON.stringify(B.options||{})),this._ctx=B}(Ki.prototype=Object.create(Kt.prototype))._coordinatesToFeatures=function(B){var j=this,ae=this.model.bind(this);return B.map(function(Ue){return new ae(j.ctx,{id:Rt(),type:he,properties:{},geometry:{coordinates:Ue,type:j.type.replace("Multi","")}})})},Ki.prototype.isValid=function(){return this.features.every(function(B){return B.isValid()})},Ki.prototype.setCoordinates=function(B){this.features=this._coordinatesToFeatures(B),this.changed()},Ki.prototype.getCoordinate=function(B){return rr(this.features,"getCoordinate",B)},Ki.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(function(B){return B.type===Ie?B.getCoordinates():B.coordinates})))},Ki.prototype.updateCoordinate=function(B,j,ae){rr(this.features,"updateCoordinate",B,j,ae),this.changed()},Ki.prototype.addCoordinate=function(B,j,ae){rr(this.features,"addCoordinate",B,j,ae),this.changed()},Ki.prototype.removeCoordinate=function(B){rr(this.features,"removeCoordinate",B),this.changed()},Ki.prototype.getFeatures=function(){return this.features},Ci.prototype.setSelected=function(B){return this._ctx.store.setSelected(B)},Ci.prototype.setSelectedCoordinates=function(B){var j=this;this._ctx.store.setSelectedCoordinates(B),B.reduce(function(ae,Ue){return ae[Ue.feature_id]===void 0&&(ae[Ue.feature_id]=!0,j._ctx.store.get(Ue.feature_id).changed()),ae},{})},Ci.prototype.getSelected=function(){return this._ctx.store.getSelected()},Ci.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()},Ci.prototype.isSelected=function(B){return this._ctx.store.isSelected(B)},Ci.prototype.getFeature=function(B){return this._ctx.store.get(B)},Ci.prototype.select=function(B){return this._ctx.store.select(B)},Ci.prototype.deselect=function(B){return this._ctx.store.deselect(B)},Ci.prototype.deleteFeature=function(B,j){return j===void 0&&(j={}),this._ctx.store.delete(B,j)},Ci.prototype.addFeature=function(B){return this._ctx.store.add(B)},Ci.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()},Ci.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()},Ci.prototype.setActionableState=function(B){B===void 0&&(B={});var j={trash:B.trash||!1,combineFeatures:B.combineFeatures||!1,uncombineFeatures:B.uncombineFeatures||!1};return this._ctx.events.actionable(j)},Ci.prototype.changeMode=function(B,j,ae){return j===void 0&&(j={}),ae===void 0&&(ae={}),this._ctx.events.changeMode(B,j,ae)},Ci.prototype.updateUIClasses=function(B){return this._ctx.ui.queueMapClasses(B)},Ci.prototype.activateUIButton=function(B){return this._ctx.ui.setActiveButton(B)},Ci.prototype.featuresAt=function(B,j,ae){if(ae===void 0&&(ae="click"),ae!=="click"&&ae!=="touch")throw new Error("invalid buffer type");return si[ae](B,j,this._ctx)},Ci.prototype.newFeature=function(B){var j=B.geometry.type;return j===Qe?new Li(this._ctx,B):j===Pe?new Ii(this._ctx,B):j===Ie?new Fi(this._ctx,B):new Ki(this._ctx,B)},Ci.prototype.isInstanceOf=function(B,j){if(B===Qe)return j instanceof Li;if(B===Pe)return j instanceof Ii;if(B===Ie)return j instanceof Fi;if(B==="MultiFeature")return j instanceof Ki;throw new Error("Unknown feature class: "+B)},Ci.prototype.doRender=function(B){return this._ctx.store.featureChanged(B)},Ci.prototype.onSetup=function(){},Ci.prototype.onDrag=function(){},Ci.prototype.onClick=function(){},Ci.prototype.onMouseMove=function(){},Ci.prototype.onMouseDown=function(){},Ci.prototype.onMouseUp=function(){},Ci.prototype.onMouseOut=function(){},Ci.prototype.onKeyUp=function(){},Ci.prototype.onKeyDown=function(){},Ci.prototype.onTouchStart=function(){},Ci.prototype.onTouchMove=function(){},Ci.prototype.onTouchEnd=function(){},Ci.prototype.onTap=function(){},Ci.prototype.onStop=function(){},Ci.prototype.onTrash=function(){},Ci.prototype.onCombineFeature=function(){},Ci.prototype.onUncombineFeature=function(){},Ci.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};var Ir={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},mn=Object.keys(Ir);function gn(B){var j=Object.keys(B);return function(ae,Ue){Ue===void 0&&(Ue={});var nt={},Ye=j.reduce(function(et,jt){return et[jt]=B[jt],et},new Ci(ae));return{start:function(){var et=this;nt=Ye.onSetup(Ue),mn.forEach(function(jt){var Ot,ei=Ir[jt],Ke=function(){return!1};B[ei]&&(Ke=function(){return!0}),et.on(jt,Ke,(Ot=ei,function(ci){return Ye[Ot](nt,ci)}))})},stop:function(){Ye.onStop(nt)},trash:function(){Ye.onTrash(nt)},combineFeatures:function(){Ye.onCombineFeatures(nt)},uncombineFeatures:function(){Ye.onUncombineFeatures(nt)},render:function(et,jt){Ye.toDisplayFeatures(nt,et,jt)}}}}function Er(B){return[].concat(B).filter(function(j){return j!==void 0})}function un(){var B=this;if(!(B.ctx.map&&B.ctx.map.getSource(W)!==void 0))return Ot();var j=B.ctx.events.currentModeName();B.ctx.ui.queueMapClasses({mode:j});var ae=[],Ue=[];B.isDirty?Ue=B.getAllIds():(ae=B.getChangedIds().filter(function(ei){return B.get(ei)!==void 0}),Ue=B.sources.hot.filter(function(ei){return ei.properties.id&&ae.indexOf(ei.properties.id)===-1&&B.get(ei.properties.id)!==void 0}).map(function(ei){return ei.properties.id})),B.sources.hot=[];var nt=B.sources.cold.length;B.sources.cold=B.isDirty?[]:B.sources.cold.filter(function(ei){var Ke=ei.properties.id||ei.properties.parent;return ae.indexOf(Ke)===-1});var Ye=nt!==B.sources.cold.length||Ue.length>0;function et(ei,Ke){var ci=B.get(ei).internal(j);B.ctx.events.currentModeRender(ci,function(Ei){B.sources[Ke].push(Ei)})}if(ae.forEach(function(ei){return et(ei,"hot")}),Ue.forEach(function(ei){return et(ei,"cold")}),Ye&&B.ctx.map.getSource(Y).setData({type:We,features:B.sources.cold}),B.ctx.map.getSource(W).setData({type:We,features:B.sources.hot}),B._emitSelectionChange&&(B.ctx.map.fire(At,{features:B.getSelected().map(function(ei){return ei.toGeoJSON()}),points:B.getSelectedCoordinates().map(function(ei){return{type:he,properties:{},geometry:{type:Qe,coordinates:ei.coordinates}}})}),B._emitSelectionChange=!1),B._deletedFeaturesToEmit.length){var jt=B._deletedFeaturesToEmit.map(function(ei){return ei.toGeoJSON()});B._deletedFeaturesToEmit=[],B.ctx.map.fire(Bt,{features:jt})}function Ot(){B.isDirty=!1,B.clearChangedIds()}Ot(),B.ctx.map.fire(Ct,{})}function ar(B){var j,ae=this;this._features={},this._featureIds=new Gt,this._selectedFeatureIds=new Gt,this._selectedCoordinates=[],this._changedFeatureIds=new Gt,this._deletedFeaturesToEmit=[],this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=B,this.sources={hot:[],cold:[]},this.render=function(){j||(j=requestAnimationFrame(function(){j=null,un.call(ae)}))},this.isDirty=!1}function Jr(B,j){var ae=B._selectedCoordinates.filter(function(Ue){return B._selectedFeatureIds.has(Ue.feature_id)});B._selectedCoordinates.length===ae.length||j.silent||(B._emitSelectionChange=!0),B._selectedCoordinates=ae}ar.prototype.createRenderBatch=function(){var B=this,j=this.render,ae=0;return this.render=function(){ae++},function(){B.render=j,ae>0&&B.render()}},ar.prototype.setDirty=function(){return this.isDirty=!0,this},ar.prototype.featureChanged=function(B){return this._changedFeatureIds.add(B),this},ar.prototype.getChangedIds=function(){return this._changedFeatureIds.values()},ar.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this},ar.prototype.getAllIds=function(){return this._featureIds.values()},ar.prototype.add=function(B){return this.featureChanged(B.id),this._features[B.id]=B,this._featureIds.add(B.id),this},ar.prototype.delete=function(B,j){var ae=this;return j===void 0&&(j={}),Er(B).forEach(function(Ue){ae._featureIds.has(Ue)&&(ae._featureIds.delete(Ue),ae._selectedFeatureIds.delete(Ue),j.silent||ae._deletedFeaturesToEmit.indexOf(ae._features[Ue])===-1&&ae._deletedFeaturesToEmit.push(ae._features[Ue]),delete ae._features[Ue],ae.isDirty=!0)}),Jr(this,j),this},ar.prototype.get=function(B){return this._features[B]},ar.prototype.getAll=function(){var B=this;return Object.keys(this._features).map(function(j){return B._features[j]})},ar.prototype.select=function(B,j){var ae=this;return j===void 0&&(j={}),Er(B).forEach(function(Ue){ae._selectedFeatureIds.has(Ue)||(ae._selectedFeatureIds.add(Ue),ae._changedFeatureIds.add(Ue),j.silent||(ae._emitSelectionChange=!0))}),this},ar.prototype.deselect=function(B,j){var ae=this;return j===void 0&&(j={}),Er(B).forEach(function(Ue){ae._selectedFeatureIds.has(Ue)&&(ae._selectedFeatureIds.delete(Ue),ae._changedFeatureIds.add(Ue),j.silent||(ae._emitSelectionChange=!0))}),Jr(this,j),this},ar.prototype.clearSelected=function(B){return B===void 0&&(B={}),this.deselect(this._selectedFeatureIds.values(),{silent:B.silent}),this},ar.prototype.setSelected=function(B,j){var ae=this;return j===void 0&&(j={}),B=Er(B),this.deselect(this._selectedFeatureIds.values().filter(function(Ue){return B.indexOf(Ue)===-1}),{silent:j.silent}),this.select(B.filter(function(Ue){return!ae._selectedFeatureIds.has(Ue)}),{silent:j.silent}),this},ar.prototype.setSelectedCoordinates=function(B){return this._selectedCoordinates=B,this._emitSelectionChange=!0,this},ar.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this},ar.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()},ar.prototype.getSelected=function(){var B=this;return this._selectedFeatureIds.values().map(function(j){return B.get(j)})},ar.prototype.getSelectedCoordinates=function(){var B=this;return this._selectedCoordinates.map(function(j){return{coordinates:B.get(j.feature_id).getCoordinate(j.coord_path)}})},ar.prototype.isSelected=function(B){return this._selectedFeatureIds.has(B)},ar.prototype.setFeatureProperty=function(B,j,ae){this.get(B).setProperty(j,ae),this.featureChanged(B)},ar.prototype.storeMapConfig=function(){var B=this;Pi.forEach(function(j){B.ctx.map[j]&&(B._mapInitialConfig[j]=B.ctx.map[j].isEnabled())})},ar.prototype.restoreMapConfig=function(){var B=this;Object.keys(this._mapInitialConfig).forEach(function(j){B._mapInitialConfig[j]?B.ctx.map[j].enable():B.ctx.map[j].disable()})},ar.prototype.getInitialConfigValue=function(B){return this._mapInitialConfig[B]===void 0||this._mapInitialConfig[B]};var qr=function(){for(var B=arguments,j={},ae=0;ae<arguments.length;ae++){var Ue=B[ae];for(var nt in Ue)kr.call(Ue,nt)&&(j[nt]=Ue[nt])}return j},kr=Object.prototype.hasOwnProperty,ye=["mode","feature","mouse"];function qe(B){var j=null,ae=null,Ue={onRemove:function(){return B.map.off("load",Ue.connect),clearInterval(ae),Ue.removeLayers(),B.store.restoreMapConfig(),B.ui.removeButtons(),B.events.removeEventListeners(),B.ui.clearMapClasses(),B.map=null,B.container=null,B.store=null,j&&j.parentNode&&j.parentNode.removeChild(j),j=null,this},connect:function(){B.map.off("load",Ue.connect),clearInterval(ae),Ue.addLayers(),B.store.storeMapConfig(),B.events.addEventListeners()},onAdd:function(nt){var Ye=nt.fire;return nt.fire=function(et,jt){var Ot=arguments;return Ye.length===1&&arguments.length!==1&&(Ot=[qr({},{type:et},jt)]),Ye.apply(nt,Ot)},B.map=nt,B.events=function(et){var jt=Object.keys(et.options.modes).reduce(function(St,ni){return St[ni]=gn(et.options.modes[ni]),St},{}),Ot={},ei={},Ke={},ci=null,Ei=null;Ke.drag=function(St,ni){ni({point:St.point,time:new Date().getTime()})?(et.ui.queueMapClasses({mouse:xe}),Ei.drag(St)):St.originalEvent.stopPropagation()},Ke.mousedrag=function(St){Ke.drag(St,function(ni){return!Nt(Ot,ni)})},Ke.touchdrag=function(St){Ke.drag(St,function(ni){return!Yt(ei,ni)})},Ke.mousemove=function(St){if((St.originalEvent.buttons!==void 0?St.originalEvent.buttons:St.originalEvent.which)===1)return Ke.mousedrag(St);var ni=xt(St,et);St.featureTarget=ni,Ei.mousemove(St)},Ke.mousedown=function(St){Ot={time:new Date().getTime(),point:St.point};var ni=xt(St,et);St.featureTarget=ni,Ei.mousedown(St)},Ke.mouseup=function(St){var ni=xt(St,et);St.featureTarget=ni,Nt(Ot,{point:St.point,time:new Date().getTime()})?Ei.click(St):Ei.mouseup(St)},Ke.mouseout=function(St){Ei.mouseout(St)},Ke.touchstart=function(St){if(St.originalEvent.preventDefault(),et.options.touchEnabled){ei={time:new Date().getTime(),point:St.point};var ni=si.touch(St,null,et)[0];St.featureTarget=ni,Ei.touchstart(St)}},Ke.touchmove=function(St){if(St.originalEvent.preventDefault(),et.options.touchEnabled)return Ei.touchmove(St),Ke.touchdrag(St)},Ke.touchend=function(St){if(St.originalEvent.preventDefault(),et.options.touchEnabled){var ni=si.touch(St,null,et)[0];St.featureTarget=ni,Yt(ei,{time:new Date().getTime(),point:St.point})?Ei.tap(St):Ei.touchend(St)}};var Mi=function(St){return!(St===8||St===46||St>=48&&St<=57)};function Oi(St,ni,gr){gr===void 0&&(gr={}),Ei.stop();var yr=jt[St];if(yr===void 0)throw new Error(St+" is not valid");ci=St;var Dr=yr(et,ni);Ei=n(Dr,et),gr.silent||et.map.fire(Tt,{mode:St}),et.store.setDirty(),et.store.render()}Ke.keydown=function(St){(St.srcElement||St.target).classList[0]==="mapboxgl-canvas"&&(St.keyCode!==8&&St.keyCode!==46||!et.options.controls.trash?Mi(St.keyCode)?Ei.keydown(St):St.keyCode===49&&et.options.controls.point?Oi(je.DRAW_POINT):St.keyCode===50&&et.options.controls.line_string?Oi(je.DRAW_LINE_STRING):St.keyCode===51&&et.options.controls.polygon&&Oi(je.DRAW_POLYGON):(St.preventDefault(),Ei.trash()))},Ke.keyup=function(St){Mi(St.keyCode)&&Ei.keyup(St)},Ke.zoomend=function(){et.store.changeZoom()},Ke.data=function(St){if(St.dataType==="style"){var ni=et.setup,gr=et.map,yr=et.options,Dr=et.store;yr.styles.some(function(Ti){return gr.getLayer(Ti.id)})||(ni.addLayers(),Dr.setDirty(),Dr.render())}};var Yr={trash:!1,combineFeatures:!1,uncombineFeatures:!1};return{start:function(){ci=et.options.defaultMode,Ei=n(jt[ci](et),et)},changeMode:Oi,actionable:function(St){var ni=!1;Object.keys(St).forEach(function(gr){if(Yr[gr]===void 0)throw new Error("Invalid action type");Yr[gr]!==St[gr]&&(ni=!0),Yr[gr]=St[gr]}),ni&&et.map.fire(Dt,{actions:Yr})},currentModeName:function(){return ci},currentModeRender:function(St,ni){return Ei.render(St,ni)},fire:function(St,ni){Ke[St]&&Ke[St](ni)},addEventListeners:function(){et.map.on("mousemove",Ke.mousemove),et.map.on("mousedown",Ke.mousedown),et.map.on("mouseup",Ke.mouseup),et.map.on("data",Ke.data),et.map.on("touchmove",Ke.touchmove),et.map.on("touchstart",Ke.touchstart),et.map.on("touchend",Ke.touchend),et.container.addEventListener("mouseout",Ke.mouseout),et.options.keybindings&&(et.container.addEventListener("keydown",Ke.keydown),et.container.addEventListener("keyup",Ke.keyup))},removeEventListeners:function(){et.map.off("mousemove",Ke.mousemove),et.map.off("mousedown",Ke.mousedown),et.map.off("mouseup",Ke.mouseup),et.map.off("data",Ke.data),et.map.off("touchmove",Ke.touchmove),et.map.off("touchstart",Ke.touchstart),et.map.off("touchend",Ke.touchend),et.container.removeEventListener("mouseout",Ke.mouseout),et.options.keybindings&&(et.container.removeEventListener("keydown",Ke.keydown),et.container.removeEventListener("keyup",Ke.keyup))},trash:function(St){Ei.trash(St)},combineFeatures:function(){Ei.combineFeatures()},uncombineFeatures:function(){Ei.uncombineFeatures()},getMode:function(){return ci}}}(B),B.ui=function(et){var jt={},Ot=null,ei={mode:null,feature:null,mouse:null},Ke={mode:null,feature:null,mouse:null};function ci(St){Ke=qr(Ke,St)}function Ei(){var St,ni;if(et.container){var gr=[],yr=[];ye.forEach(function(Dr){Ke[Dr]!==ei[Dr]&&(gr.push(Dr+"-"+ei[Dr]),Ke[Dr]!==null&&yr.push(Dr+"-"+Ke[Dr]))}),gr.length>0&&(St=et.container.classList).remove.apply(St,gr),yr.length>0&&(ni=et.container.classList).add.apply(ni,yr),ei=qr(ei,Ke)}}function Mi(St,ni){ni===void 0&&(ni={});var gr=document.createElement("button");return gr.className=E+" "+ni.className,gr.setAttribute("title",ni.title),ni.container.appendChild(gr),gr.addEventListener("click",function(yr){if(yr.preventDefault(),yr.stopPropagation(),yr.target===Ot)return Oi(),void ni.onDeactivate();Yr(St),ni.onActivate()},!0),gr}function Oi(){Ot&&(Ot.classList.remove(q),Ot=null)}function Yr(St){Oi();var ni=jt[St];ni&&ni&&St!=="trash"&&(ni.classList.add(q),Ot=ni)}return{setActiveButton:Yr,queueMapClasses:ci,updateMapClasses:Ei,clearMapClasses:function(){ci({mode:null,feature:null,mouse:null}),Ei()},addButtons:function(){var St=et.options.controls,ni=document.createElement("div");return ni.className=K+" "+b,St&&(St[ee.LINE]&&(jt[ee.LINE]=Mi(ee.LINE,{container:ni,className:M,title:"LineString tool "+(et.options.keybindings?"(l)":""),onActivate:function(){return et.events.changeMode(je.DRAW_LINE_STRING)},onDeactivate:function(){return et.events.trash()}})),St[ee.POLYGON]&&(jt[ee.POLYGON]=Mi(ee.POLYGON,{container:ni,className:P,title:"Polygon tool "+(et.options.keybindings?"(p)":""),onActivate:function(){return et.events.changeMode(je.DRAW_POLYGON)},onDeactivate:function(){return et.events.trash()}})),St[ee.POINT]&&(jt[ee.POINT]=Mi(ee.POINT,{container:ni,className:L,title:"Marker tool "+(et.options.keybindings?"(m)":""),onActivate:function(){return et.events.changeMode(je.DRAW_POINT)},onDeactivate:function(){return et.events.trash()}})),St.trash&&(jt.trash=Mi("trash",{container:ni,className:D,title:"Delete",onActivate:function(){et.events.trash()}})),St.combine_features&&(jt.combine_features=Mi("combineFeatures",{container:ni,className:U,title:"Combine",onActivate:function(){et.events.combineFeatures()}})),St.uncombine_features&&(jt.uncombine_features=Mi("uncombineFeatures",{container:ni,className:X,title:"Uncombine",onActivate:function(){et.events.uncombineFeatures()}}))),ni},removeButtons:function(){Object.keys(jt).forEach(function(St){var ni=jt[St];ni.parentNode&&ni.parentNode.removeChild(ni),delete jt[St]})}}}(B),B.container=nt.getContainer(),B.store=new ar(B),j=B.ui.addButtons(),B.options.boxSelect&&(nt.boxZoom.disable(),nt.dragPan.disable(),nt.dragPan.enable()),nt.loaded()?Ue.connect():(nt.on("load",Ue.connect),ae=setInterval(function(){nt.loaded()&&Ue.connect()},16)),B.events.start(),j},addLayers:function(){B.map.addSource(Y,{data:{type:We,features:[]},type:"geojson"}),B.map.addSource(W,{data:{type:We,features:[]},type:"geojson"}),B.options.styles.forEach(function(nt){B.map.addLayer(nt)}),B.store.setDirty(!0),B.store.render()},removeLayers:function(){B.options.styles.forEach(function(nt){B.map.getLayer(nt.id)&&B.map.removeLayer(nt.id)}),B.map.getSource(Y)&&B.map.removeSource(Y),B.map.getSource(W)&&B.map.removeSource(W)}};return B.setup=Ue,Ue}function at(B){return function(j){var ae=j.featureTarget;return!!ae&&!!ae.properties&&ae.properties.meta===B}}function ne(B){return!!B.featureTarget&&!!B.featureTarget.properties&&B.featureTarget.properties.active===kt&&B.featureTarget.properties.meta===yi}function H(B){return!!B.featureTarget&&!!B.featureTarget.properties&&B.featureTarget.properties.active===Ri&&B.featureTarget.properties.meta===yi}function te(B){return B.featureTarget===void 0}function pe(B){var j=B.featureTarget;return!!j&&!!j.properties&&j.properties.meta===It}function we(B){return!!B.originalEvent&&B.originalEvent.shiftKey===!0}function ke(B){return B.keyCode===27}function $e(B){return B.keyCode===13}var Ge=De;function De(B,j){this.x=B,this.y=j}function Ze(B,j){var ae=j.getBoundingClientRect();return new Ge(B.clientX-ae.left-(j.clientLeft||0),B.clientY-ae.top-(j.clientTop||0))}function ut(B,j,ae,Ue){return{type:he,properties:{meta:It,parent:B,coord_path:ae,active:Ue?kt:Ri},geometry:{type:Qe,coordinates:j}}}function Ut(B,j,ae){j===void 0&&(j={}),ae===void 0&&(ae=null);var Ue,nt=B.geometry,Ye=nt.type,et=nt.coordinates,jt=B.properties&&B.properties.id,Ot=[];function ei(ci,Ei){var Mi="",Oi=null;ci.forEach(function(Yr,St){var ni=Ei!=null?Ei+"."+St:String(St),gr=ut(jt,Yr,ni,Ke(ni));if(j.midpoints&&Oi){var yr=function(Ti,ho,eo){var or=ho.geometry.coordinates,an=eo.geometry.coordinates;if(or[1]>85||or[1]<-85||an[1]>85||an[1]<-85)return null;var hn={lng:(or[0]+an[0])/2,lat:(or[1]+an[1])/2};return{type:he,properties:{meta:mi,parent:Ti,lng:hn.lng,lat:hn.lat,coord_path:eo.properties.coord_path},geometry:{type:Qe,coordinates:[hn.lng,hn.lat]}}}(jt,Oi,gr);yr&&Ot.push(yr)}Oi=gr;var Dr=JSON.stringify(Yr);Mi!==Dr&&Ot.push(gr),St===0&&(Mi=Dr)})}function Ke(ci){return!!j.selectedPaths&&j.selectedPaths.indexOf(ci)!==-1}return Ye===Qe?Ot.push(ut(jt,et,ae,Ke(ae))):Ye===Ie?et.forEach(function(ci,Ei){ei(ci,ae!==null?ae+"."+Ei:String(Ei))}):Ye===Pe?ei(et,ae):Ye.indexOf(Zt)===0&&(Ue=Ye.replace(Zt,""),et.forEach(function(ci,Ei){var Mi={type:he,properties:B.properties,geometry:{type:Ue,coordinates:ci}};Ot=Ot.concat(Ut(Mi,j,Ei))})),Ot}De.prototype={clone:function(){return new De(this.x,this.y)},add:function(B){return this.clone()._add(B)},sub:function(B){return this.clone()._sub(B)},multByPoint:function(B){return this.clone()._multByPoint(B)},divByPoint:function(B){return this.clone()._divByPoint(B)},mult:function(B){return this.clone()._mult(B)},div:function(B){return this.clone()._div(B)},rotate:function(B){return this.clone()._rotate(B)},rotateAround:function(B,j){return this.clone()._rotateAround(B,j)},matMult:function(B){return this.clone()._matMult(B)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(B){return this.x===B.x&&this.y===B.y},dist:function(B){return Math.sqrt(this.distSqr(B))},distSqr:function(B){var j=B.x-this.x,ae=B.y-this.y;return j*j+ae*ae},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(B){return Math.atan2(this.y-B.y,this.x-B.x)},angleWith:function(B){return this.angleWithSep(B.x,B.y)},angleWithSep:function(B,j){return Math.atan2(this.x*j-this.y*B,this.x*B+this.y*j)},_matMult:function(B){var j=B[0]*this.x+B[1]*this.y,ae=B[2]*this.x+B[3]*this.y;return this.x=j,this.y=ae,this},_add:function(B){return this.x+=B.x,this.y+=B.y,this},_sub:function(B){return this.x-=B.x,this.y-=B.y,this},_mult:function(B){return this.x*=B,this.y*=B,this},_div:function(B){return this.x/=B,this.y/=B,this},_multByPoint:function(B){return this.x*=B.x,this.y*=B.y,this},_divByPoint:function(B){return this.x/=B.x,this.y/=B.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var B=this.y;return this.y=this.x,this.x=-B,this},_rotate:function(B){var j=Math.cos(B),ae=Math.sin(B),Ue=j*this.x-ae*this.y,nt=ae*this.x+j*this.y;return this.x=Ue,this.y=nt,this},_rotateAround:function(B,j){var ae=Math.cos(B),Ue=Math.sin(B),nt=j.x+ae*(this.x-j.x)-Ue*(this.y-j.y),Ye=j.y+Ue*(this.x-j.x)+ae*(this.y-j.y);return this.x=nt,this.y=Ye,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},De.convert=function(B){return B instanceof De?B:Array.isArray(B)?new De(B[0],B[1]):B};var ft=function(B){setTimeout(function(){B.map&&B.map.doubleClickZoom&&B._ctx&&B._ctx.store&&B._ctx.store.getInitialConfigValue&&B._ctx.store.getInitialConfigValue("doubleClickZoom")&&B.map.doubleClickZoom.enable()},0)},bi=function(B){setTimeout(function(){B.map&&B.map.doubleClickZoom&&B.map.doubleClickZoom.disable()},0)},wi=function(B){if(!B||!B.type)return null;var j=gi[B.type];if(!j)return null;if(j==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:B}]};if(j==="feature")return{type:"FeatureCollection",features:[B]};if(j==="featurecollection")return B},gi={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"};function Di(B){switch(B&&B.type||null){case"FeatureCollection":return B.features=B.features.reduce(function(j,ae){return j.concat(Di(ae))},[]),B;case"Feature":return B.geometry?Di(B.geometry).map(function(j){var ae={type:"Feature",properties:JSON.parse(JSON.stringify(B.properties)),geometry:j};return B.id!==void 0&&(ae.id=B.id),ae}):[B];case"MultiPoint":return B.coordinates.map(function(j){return{type:"Point",coordinates:j}});case"MultiPolygon":return B.coordinates.map(function(j){return{type:"Polygon",coordinates:j}});case"MultiLineString":return B.coordinates.map(function(j){return{type:"LineString",coordinates:j}});case"GeometryCollection":return B.geometries.map(Di).reduce(function(j,ae){return j.concat(ae)},[]);case"Point":case"Polygon":case"LineString":return[B]}}var Hi=function(B){if(!B)return[];var j=Di(wi(B)),ae=[];return j.features.forEach(function(Ue){Ue.geometry&&(ae=ae.concat(function nt(Ye){return Array.isArray(Ye)&&Ye.length&&typeof Ye[0]=="number"?[Ye]:Ye.reduce(function(et,jt){return Array.isArray(jt)&&Array.isArray(jt[0])?et.concat(nt(jt)):(et.push(jt),et)},[])}(Ue.geometry.coordinates)))}),ae},Re=ii(function(B){var j=B.exports=function(Ke){return new ae(Ke)};function ae(Ke){this.value=Ke}function Ue(Ke,ci,Ei){var Mi=[],Oi=[],Yr=!0;return function St(ni){var gr=Ei?nt(ni):ni,yr={},Dr=!0,Ti={node:gr,node_:ni,path:[].concat(Mi),parent:Oi[Oi.length-1],parents:Oi,key:Mi.slice(-1)[0],isRoot:Mi.length===0,level:Mi.length,circular:null,update:function(or,an){Ti.isRoot||(Ti.parent.node[Ti.key]=or),Ti.node=or,an&&(Dr=!1)},delete:function(or){delete Ti.parent.node[Ti.key],or&&(Dr=!1)},remove:function(or){jt(Ti.parent.node)?Ti.parent.node.splice(Ti.key,1):delete Ti.parent.node[Ti.key],or&&(Dr=!1)},keys:null,before:function(or){yr.before=or},after:function(or){yr.after=or},pre:function(or){yr.pre=or},post:function(or){yr.post=or},stop:function(){Yr=!1},block:function(){Dr=!1}};if(!Yr)return Ti;function ho(){if(typeof Ti.node=="object"&&Ti.node!==null){Ti.keys&&Ti.node_===Ti.node||(Ti.keys=Ye(Ti.node)),Ti.isLeaf=Ti.keys.length==0;for(var or=0;or<Oi.length;or++)if(Oi[or].node_===ni){Ti.circular=Oi[or];break}}else Ti.isLeaf=!0,Ti.keys=null;Ti.notLeaf=!Ti.isLeaf,Ti.notRoot=!Ti.isRoot}ho();var eo=ci.call(Ti,Ti.node);return eo!==void 0&&Ti.update&&Ti.update(eo),yr.before&&yr.before.call(Ti,Ti.node),Dr&&(typeof Ti.node!="object"||Ti.node===null||Ti.circular||(Oi.push(Ti),ho(),Ot(Ti.keys,function(or,an){Mi.push(or),yr.pre&&yr.pre.call(Ti,Ti.node[or],or);var hn=St(Ti.node[or]);Ei&&ei.call(Ti.node,or)&&(Ti.node[or]=hn.node),hn.isLast=an==Ti.keys.length-1,hn.isFirst=an==0,yr.post&&yr.post.call(Ti,hn),Mi.pop()}),Oi.pop()),yr.after&&yr.after.call(Ti,Ti.node)),Ti}(Ke).node}function nt(Ke){if(typeof Ke=="object"&&Ke!==null){var ci;if(jt(Ke))ci=[];else if(et(Ke)==="[object Date]")ci=new Date(Ke.getTime?Ke.getTime():Ke);else if(function(Oi){return et(Oi)==="[object RegExp]"}(Ke))ci=new RegExp(Ke);else if(function(Oi){return et(Oi)==="[object Error]"}(Ke))ci={message:Ke.message};else if(function(Oi){return et(Oi)==="[object Boolean]"}(Ke))ci=new Boolean(Ke);else if(function(Oi){return et(Oi)==="[object Number]"}(Ke))ci=new Number(Ke);else if(function(Oi){return et(Oi)==="[object String]"}(Ke))ci=new String(Ke);else if(Object.create&&Object.getPrototypeOf)ci=Object.create(Object.getPrototypeOf(Ke));else if(Ke.constructor===Object)ci={};else{var Ei=Ke.constructor&&Ke.constructor.prototype||Ke.__proto__||{},Mi=function(){};Mi.prototype=Ei,ci=new Mi}return Ot(Ye(Ke),function(Oi){ci[Oi]=Ke[Oi]}),ci}return Ke}ae.prototype.get=function(Ke){for(var ci=this.value,Ei=0;Ei<Ke.length;Ei++){var Mi=Ke[Ei];if(!ci||!ei.call(ci,Mi)){ci=void 0;break}ci=ci[Mi]}return ci},ae.prototype.has=function(Ke){for(var ci=this.value,Ei=0;Ei<Ke.length;Ei++){var Mi=Ke[Ei];if(!ci||!ei.call(ci,Mi))return!1;ci=ci[Mi]}return!0},ae.prototype.set=function(Ke,ci){for(var Ei=this.value,Mi=0;Mi<Ke.length-1;Mi++){var Oi=Ke[Mi];ei.call(Ei,Oi)||(Ei[Oi]={}),Ei=Ei[Oi]}return Ei[Ke[Mi]]=ci,ci},ae.prototype.map=function(Ke){return Ue(this.value,Ke,!0)},ae.prototype.forEach=function(Ke){return this.value=Ue(this.value,Ke,!1),this.value},ae.prototype.reduce=function(Ke,ci){var Ei=arguments.length===1,Mi=Ei?this.value:ci;return this.forEach(function(Oi){this.isRoot&&Ei||(Mi=Ke.call(this,Mi,Oi))}),Mi},ae.prototype.paths=function(){var Ke=[];return this.forEach(function(ci){Ke.push(this.path)}),Ke},ae.prototype.nodes=function(){var Ke=[];return this.forEach(function(ci){Ke.push(this.node)}),Ke},ae.prototype.clone=function(){var Ke=[],ci=[];return function Ei(Mi){for(var Oi=0;Oi<Ke.length;Oi++)if(Ke[Oi]===Mi)return ci[Oi];if(typeof Mi=="object"&&Mi!==null){var Yr=nt(Mi);return Ke.push(Mi),ci.push(Yr),Ot(Ye(Mi),function(St){Yr[St]=Ei(Mi[St])}),Ke.pop(),ci.pop(),Yr}return Mi}(this.value)};var Ye=Object.keys||function(Ke){var ci=[];for(var Ei in Ke)ci.push(Ei);return ci};function et(Ke){return Object.prototype.toString.call(Ke)}var jt=Array.isArray||function(Ke){return Object.prototype.toString.call(Ke)==="[object Array]"},Ot=function(Ke,ci){if(Ke.forEach)return Ke.forEach(ci);for(var Ei=0;Ei<Ke.length;Ei++)ci(Ke[Ei],Ei,Ke)};Ot(Ye(ae.prototype),function(Ke){j[Ke]=function(ci){var Ei=[].slice.call(arguments,1),Mi=new ae(ci);return Mi[Ke].apply(Mi,Ei)}});var ei=Object.hasOwnProperty||function(Ke,ci){return ci in Ke}}),vt=Pt;function Pt(B){if(!(this instanceof Pt))return new Pt(B);this._bbox=B||[1/0,1/0,-1/0,-1/0],this._valid=!!B}Pt.prototype.include=function(B){return this._valid=!0,this._bbox[0]=Math.min(this._bbox[0],B[0]),this._bbox[1]=Math.min(this._bbox[1],B[1]),this._bbox[2]=Math.max(this._bbox[2],B[0]),this._bbox[3]=Math.max(this._bbox[3],B[1]),this},Pt.prototype.equals=function(B){var j;return j=B instanceof Pt?B.bbox():B,this._bbox[0]==j[0]&&this._bbox[1]==j[1]&&this._bbox[2]==j[2]&&this._bbox[3]==j[3]},Pt.prototype.center=function(B){return this._valid?[(this._bbox[0]+this._bbox[2])/2,(this._bbox[1]+this._bbox[3])/2]:null},Pt.prototype.union=function(B){var j;return this._valid=!0,j=B instanceof Pt?B.bbox():B,this._bbox[0]=Math.min(this._bbox[0],j[0]),this._bbox[1]=Math.min(this._bbox[1],j[1]),this._bbox[2]=Math.max(this._bbox[2],j[2]),this._bbox[3]=Math.max(this._bbox[3],j[3]),this},Pt.prototype.bbox=function(){return this._valid?this._bbox:null},Pt.prototype.contains=function(B){if(!B)return this._fastContains();if(!this._valid)return null;var j=B[0],ae=B[1];return this._bbox[0]<=j&&this._bbox[1]<=ae&&this._bbox[2]>=j&&this._bbox[3]>=ae},Pt.prototype.intersect=function(B){return this._valid?(j=B instanceof Pt?B.bbox():B,!(this._bbox[0]>j[2]||this._bbox[2]<j[0]||this._bbox[3]<j[1]||this._bbox[1]>j[3])):null;var j},Pt.prototype._fastContains=function(){if(!this._valid)return new Function("return null;");var B="return "+this._bbox[0]+"<= ll[0] &&"+this._bbox[1]+"<= ll[1] &&"+this._bbox[2]+">= ll[0] &&"+this._bbox[3]+">= ll[1]";return new Function("ll",B)},Pt.prototype.polygon=function(){return this._valid?{type:"Polygon",coordinates:[[[this._bbox[0],this._bbox[1]],[this._bbox[2],this._bbox[1]],[this._bbox[2],this._bbox[3]],[this._bbox[0],this._bbox[3]],[this._bbox[0],this._bbox[1]]]]}:null};var fi={features:["FeatureCollection"],coordinates:["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],geometry:["Feature"],geometries:["GeometryCollection"]},dr=Object.keys(fi),sr=function(B){return it(B).bbox()};function it(B){for(var j=vt(),ae=Hi(B),Ue=0;Ue<ae.length;Ue++)j.include(ae[Ue]);return j}sr.polygon=function(B){return it(B).polygon()},sr.bboxify=function(B){return Re(B).map(function(j){j&&dr.some(function(ae){return!!j[ae]&&fi[ae].indexOf(j.type)!==-1})&&(j.bbox=it(j).bbox(),this.update(j))})};function Or(B,j){var ae=-90,Ue=90,nt=-90,Ye=90,et=270,jt=-270;B.forEach(function(ei){var Ke=sr(ei),ci=Ke[1],Ei=Ke[3],Mi=Ke[0],Oi=Ke[2];ci>ae&&(ae=ci),Ei<Ue&&(Ue=Ei),Ei>nt&&(nt=Ei),ci<Ye&&(Ye=ci),Mi<et&&(et=Mi),Oi>jt&&(jt=Oi)});var Ot=j;return ae+Ot.lat>85&&(Ot.lat=85-ae),nt+Ot.lat>90&&(Ot.lat=90-nt),Ue+Ot.lat<-85&&(Ot.lat=-85-Ue),Ye+Ot.lat<-90&&(Ot.lat=-90-Ye),et+Ot.lng<=-270&&(Ot.lng+=360*Math.ceil(Math.abs(Ot.lng)/360)),jt+Ot.lng>=270&&(Ot.lng-=360*Math.ceil(Math.abs(Ot.lng)/360)),Ot}function Fr(B,j){var ae=Or(B.map(function(Ue){return Ue.toGeoJSON()}),j);B.forEach(function(Ue){var nt,Ye=Ue.getCoordinates(),et=function(Ot){var ei={lng:Ot[0]+ae.lng,lat:Ot[1]+ae.lat};return[ei.lng,ei.lat]},jt=function(Ot){return Ot.map(function(ei){return et(ei)})};Ue.type===Qe?nt=et(Ye):Ue.type===Pe||Ue.type===ti?nt=Ye.map(et):Ue.type===Ie||Ue.type===$t?nt=Ye.map(jt):Ue.type===oi&&(nt=Ye.map(function(Ot){return Ot.map(function(ei){return jt(ei)})})),Ue.incomingCoords(nt)})}var Vr={onSetup:function(B){var j=this,ae={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initiallySelectedFeatureIds:B.featureIds||[]};return this.setSelected(ae.initiallySelectedFeatureIds.filter(function(Ue){return j.getFeature(Ue)!==void 0})),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),ae},fireUpdate:function(){this.map.fire(dt,{action:vi,features:this.getSelected().map(function(B){return B.toGeoJSON()})})},fireActionable:function(){var B=this,j=this.getSelected(),ae=j.filter(function(jt){return B.isInstanceOf("MultiFeature",jt)}),Ue=!1;if(j.length>1){Ue=!0;var nt=j[0].type.replace("Multi","");j.forEach(function(jt){jt.type.replace("Multi","")!==nt&&(Ue=!1)})}var Ye=ae.length>0,et=j.length>0;this.setActionableState({combineFeatures:Ue,uncombineFeatures:Ye,trash:et})},getUniqueIds:function(B){return B.length?B.map(function(j){return j.properties.id}).filter(function(j){return j!==void 0}).reduce(function(j,ae){return j.add(ae),j},new Gt).values():[]},stopExtendedInteractions:function(B){B.boxSelectElement&&(B.boxSelectElement.parentNode&&B.boxSelectElement.parentNode.removeChild(B.boxSelectElement),B.boxSelectElement=null),this.map.dragPan.enable(),B.boxSelecting=!1,B.canBoxSelect=!1,B.dragMoving=!1,B.canDragMove=!1},onStop:function(){ft(this)},onMouseMove:function(B){return this.stopExtendedInteractions(B),!0},onMouseOut:function(B){return!B.dragMoving||this.fireUpdate()}};Vr.onTap=Vr.onClick=function(B,j){return te(j)?this.clickAnywhere(B,j):at(It)(j)?this.clickOnVertex(B,j):function(ae){return!!ae.featureTarget&&!!ae.featureTarget.properties&&ae.featureTarget.properties.meta===yi}(j)?this.clickOnFeature(B,j):void 0},Vr.clickAnywhere=function(B){var j=this,ae=this.getSelectedIds();ae.length&&(this.clearSelectedFeatures(),ae.forEach(function(Ue){return j.doRender(Ue)})),ft(this),this.stopExtendedInteractions(B)},Vr.clickOnVertex=function(B,j){this.changeMode(je.DIRECT_SELECT,{featureId:j.featureTarget.properties.parent,coordPath:j.featureTarget.properties.coord_path,startPos:j.lngLat}),this.updateUIClasses({mouse:Ee})},Vr.startOnActiveFeature=function(B,j){this.stopExtendedInteractions(B),this.map.dragPan.disable(),this.doRender(j.featureTarget.properties.id),B.canDragMove=!0,B.dragMoveLocation=j.lngLat},Vr.clickOnFeature=function(B,j){var ae=this;bi(this),this.stopExtendedInteractions(B);var Ue=we(j),nt=this.getSelectedIds(),Ye=j.featureTarget.properties.id,et=this.isSelected(Ye);if(!Ue&&et&&this.getFeature(Ye).type!==Qe)return this.changeMode(je.DIRECT_SELECT,{featureId:Ye});et&&Ue?(this.deselect(Ye),this.updateUIClasses({mouse:se}),nt.length===1&&ft(this)):!et&&Ue?(this.select(Ye),this.updateUIClasses({mouse:Ee})):et||Ue||(nt.forEach(function(jt){return ae.doRender(jt)}),this.setSelected(Ye),this.updateUIClasses({mouse:Ee})),this.doRender(Ye)},Vr.onMouseDown=function(B,j){return ne(j)?this.startOnActiveFeature(B,j):this.drawConfig.boxSelect&&function(ae){return!!ae.originalEvent&&!!ae.originalEvent.shiftKey&&ae.originalEvent.button===0}(j)?this.startBoxSelect(B,j):void 0},Vr.startBoxSelect=function(B,j){this.stopExtendedInteractions(B),this.map.dragPan.disable(),B.boxSelectStartLocation=Ze(j.originalEvent,this.map.getContainer()),B.canBoxSelect=!0},Vr.onTouchStart=function(B,j){if(ne(j))return this.startOnActiveFeature(B,j)},Vr.onDrag=function(B,j){return B.canDragMove?this.dragMove(B,j):this.drawConfig.boxSelect&&B.canBoxSelect?this.whileBoxSelect(B,j):void 0},Vr.whileBoxSelect=function(B,j){B.boxSelecting=!0,this.updateUIClasses({mouse:J}),B.boxSelectElement||(B.boxSelectElement=document.createElement("div"),B.boxSelectElement.classList.add(oe),this.map.getContainer().appendChild(B.boxSelectElement));var ae=Ze(j.originalEvent,this.map.getContainer()),Ue=Math.min(B.boxSelectStartLocation.x,ae.x),nt=Math.max(B.boxSelectStartLocation.x,ae.x),Ye=Math.min(B.boxSelectStartLocation.y,ae.y),et=Math.max(B.boxSelectStartLocation.y,ae.y),jt="translate("+Ue+"px, "+Ye+"px)";B.boxSelectElement.style.transform=jt,B.boxSelectElement.style.WebkitTransform=jt,B.boxSelectElement.style.width=nt-Ue+"px",B.boxSelectElement.style.height=et-Ye+"px"},Vr.dragMove=function(B,j){B.dragMoving=!0,j.originalEvent.stopPropagation();var ae={lng:j.lngLat.lng-B.dragMoveLocation.lng,lat:j.lngLat.lat-B.dragMoveLocation.lat};Fr(this.getSelected(),ae),B.dragMoveLocation=j.lngLat},Vr.onMouseUp=function(B,j){var ae=this;if(B.dragMoving)this.fireUpdate();else if(B.boxSelecting){var Ue=[B.boxSelectStartLocation,Ze(j.originalEvent,this.map.getContainer())],nt=this.featuresAt(null,Ue,"click"),Ye=this.getUniqueIds(nt).filter(function(et){return!ae.isSelected(et)});Ye.length&&(this.select(Ye),Ye.forEach(function(et){return ae.doRender(et)}),this.updateUIClasses({mouse:Ee}))}this.stopExtendedInteractions(B)},Vr.toDisplayFeatures=function(B,j,ae){j.properties.active=this.isSelected(j.properties.id)?kt:Ri,ae(j),this.fireActionable(),j.properties.active===kt&&j.geometry.type!==Qe&&Ut(j).forEach(ae)},Vr.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()},Vr.onCombineFeatures=function(){var B=this.getSelected();if(!(B.length===0||B.length<2)){for(var j=[],ae=[],Ue=B[0].type.replace("Multi",""),nt=0;nt<B.length;nt++){var Ye=B[nt];if(Ye.type.replace("Multi","")!==Ue)return;Ye.type.includes("Multi")?Ye.getCoordinates().forEach(function(jt){j.push(jt)}):j.push(Ye.getCoordinates()),ae.push(Ye.toGeoJSON())}if(ae.length>1){var et=this.newFeature({type:he,properties:ae[0].properties,geometry:{type:"Multi"+Ue,coordinates:j}});this.addFeature(et),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([et.id]),this.map.fire(pi,{createdFeatures:[et.toGeoJSON()],deletedFeatures:ae})}this.fireActionable()}},Vr.onUncombineFeatures=function(){var B=this,j=this.getSelected();if(j.length!==0){for(var ae=[],Ue=[],nt=function(et){var jt=j[et];B.isInstanceOf("MultiFeature",jt)&&(jt.getFeatures().forEach(function(Ot){B.addFeature(Ot),Ot.properties=jt.properties,ae.push(Ot.toGeoJSON()),B.select([Ot.id])}),B.deleteFeature(jt.id,{silent:!0}),Ue.push(jt.toGeoJSON()))},Ye=0;Ye<j.length;Ye++)nt(Ye);ae.length>1&&this.map.fire(yt,{createdFeatures:ae,deletedFeatures:Ue}),this.fireActionable()}};var xs=at(It),Qn=at(mi),Cn={fireUpdate:function(){this.map.fire(dt,{action:$i,features:this.getSelected().map(function(B){return B.toGeoJSON()})})},fireActionable:function(B){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:B.selectedCoordPaths.length>0})},startDragging:function(B,j){this.map.dragPan.disable(),B.canDragMove=!0,B.dragMoveLocation=j.lngLat},stopDragging:function(B){this.map.dragPan.enable(),B.dragMoving=!1,B.canDragMove=!1,B.dragMoveLocation=null},onVertex:function(B,j){this.startDragging(B,j);var ae=j.featureTarget.properties,Ue=B.selectedCoordPaths.indexOf(ae.coord_path);we(j)||Ue!==-1?we(j)&&Ue===-1&&B.selectedCoordPaths.push(ae.coord_path):B.selectedCoordPaths=[ae.coord_path];var nt=this.pathsToCoordinates(B.featureId,B.selectedCoordPaths);this.setSelectedCoordinates(nt)},onMidpoint:function(B,j){this.startDragging(B,j);var ae=j.featureTarget.properties;B.feature.addCoordinate(ae.coord_path,ae.lng,ae.lat),this.fireUpdate(),B.selectedCoordPaths=[ae.coord_path]},pathsToCoordinates:function(B,j){return j.map(function(ae){return{feature_id:B,coord_path:ae}})},onFeature:function(B,j){B.selectedCoordPaths.length===0?this.startDragging(B,j):this.stopDragging(B)},dragFeature:function(B,j,ae){Fr(this.getSelected(),ae),B.dragMoveLocation=j.lngLat},dragVertex:function(B,j,ae){for(var Ue=B.selectedCoordPaths.map(function(jt){return B.feature.getCoordinate(jt)}),nt=Or(Ue.map(function(jt){return{type:he,properties:{},geometry:{type:Qe,coordinates:jt}}}),ae),Ye=0;Ye<Ue.length;Ye++){var et=Ue[Ye];B.feature.updateCoordinate(B.selectedCoordPaths[Ye],et[0]+nt.lng,et[1]+nt.lat)}},clickNoTarget:function(){this.changeMode(je.SIMPLE_SELECT)},clickInactive:function(){this.changeMode(je.SIMPLE_SELECT)},clickActiveFeature:function(B){B.selectedCoordPaths=[],this.clearSelectedCoordinates(),B.feature.changed()},onSetup:function(B){var j=B.featureId,ae=this.getFeature(j);if(!ae)throw new Error("You must provide a featureId to enter direct_select mode");if(ae.type===Qe)throw new TypeError("direct_select mode doesn't handle point features");var Ue={featureId:j,feature:ae,dragMoveLocation:B.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:B.coordPath?[B.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(j,Ue.selectedCoordPaths)),this.setSelected(j),bi(this),this.setActionableState({trash:!0}),Ue},onStop:function(){ft(this),this.clearSelectedCoordinates()},toDisplayFeatures:function(B,j,ae){B.featureId===j.properties.id?(j.properties.active=kt,ae(j),Ut(j,{map:this.map,midpoints:!0,selectedPaths:B.selectedCoordPaths}).forEach(ae)):(j.properties.active=Ri,ae(j)),this.fireActionable(B)},onTrash:function(B){B.selectedCoordPaths.sort(function(j,ae){return ae.localeCompare(j,"en",{numeric:!0})}).forEach(function(j){return B.feature.removeCoordinate(j)}),this.fireUpdate(),B.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(B),B.feature.isValid()===!1&&(this.deleteFeature([B.featureId]),this.changeMode(je.SIMPLE_SELECT,{}))},onMouseMove:function(B,j){var ae=ne(j),Ue=xs(j),nt=B.selectedCoordPaths.length===0;return ae&&nt||Ue&&!nt?this.updateUIClasses({mouse:Ee}):this.updateUIClasses({mouse:ce}),this.stopDragging(B),!0},onMouseOut:function(B){return B.dragMoving&&this.fireUpdate(),!0}};Cn.onTouchStart=Cn.onMouseDown=function(B,j){return xs(j)?this.onVertex(B,j):ne(j)?this.onFeature(B,j):Qn(j)?this.onMidpoint(B,j):void 0},Cn.onDrag=function(B,j){if(B.canDragMove===!0){B.dragMoving=!0,j.originalEvent.stopPropagation();var ae={lng:j.lngLat.lng-B.dragMoveLocation.lng,lat:j.lngLat.lat-B.dragMoveLocation.lat};B.selectedCoordPaths.length>0?this.dragVertex(B,j,ae):this.dragFeature(B,j,ae),B.dragMoveLocation=j.lngLat}},Cn.onClick=function(B,j){return te(j)?this.clickNoTarget(B,j):ne(j)?this.clickActiveFeature(B,j):H(j)?this.clickInactive(B,j):void this.stopDragging(B)},Cn.onTap=function(B,j){return te(j)?this.clickNoTarget(B,j):ne(j)?this.clickActiveFeature(B,j):H(j)?this.clickInactive(B,j):void 0},Cn.onTouchEnd=Cn.onMouseUp=function(B){B.dragMoving&&this.fireUpdate(),this.stopDragging(B)};var Hn={};function So(B,j){return!!B.lngLat&&B.lngLat.lng===j[0]&&B.lngLat.lat===j[1]}Hn.onSetup=function(){var B=this.newFeature({type:he,properties:{},geometry:{type:Qe,coordinates:[]}});return this.addFeature(B),this.clearSelectedFeatures(),this.updateUIClasses({mouse:J}),this.activateUIButton(ee.POINT),this.setActionableState({trash:!0}),{point:B}},Hn.stopDrawingAndRemove=function(B){this.deleteFeature([B.point.id],{silent:!0}),this.changeMode(je.SIMPLE_SELECT)},Hn.onTap=Hn.onClick=function(B,j){this.updateUIClasses({mouse:Ee}),B.point.updateCoordinate("",j.lngLat.lng,j.lngLat.lat),this.map.fire(_t,{features:[B.point.toGeoJSON()]}),this.changeMode(je.SIMPLE_SELECT,{featureIds:[B.point.id]})},Hn.onStop=function(B){this.activateUIButton(),B.point.getCoordinate().length||this.deleteFeature([B.point.id],{silent:!0})},Hn.toDisplayFeatures=function(B,j,ae){var Ue=j.properties.id===B.point.id;if(j.properties.active=Ue?kt:Ri,!Ue)return ae(j)},Hn.onTrash=Hn.stopDrawingAndRemove,Hn.onKeyUp=function(B,j){if(ke(j)||$e(j))return this.stopDrawingAndRemove(B,j)};var Qt={onSetup:function(){var B=this.newFeature({type:he,properties:{},geometry:{type:Ie,coordinates:[[]]}});return this.addFeature(B),this.clearSelectedFeatures(),bi(this),this.updateUIClasses({mouse:J}),this.activateUIButton(ee.POLYGON),this.setActionableState({trash:!0}),{polygon:B,currentVertexPosition:0}},clickAnywhere:function(B,j){if(B.currentVertexPosition>0&&So(j,B.polygon.coordinates[0][B.currentVertexPosition-1]))return this.changeMode(je.SIMPLE_SELECT,{featureIds:[B.polygon.id]});this.updateUIClasses({mouse:J}),B.polygon.updateCoordinate("0."+B.currentVertexPosition,j.lngLat.lng,j.lngLat.lat),B.currentVertexPosition++,B.polygon.updateCoordinate("0."+B.currentVertexPosition,j.lngLat.lng,j.lngLat.lat)},clickOnVertex:function(B){return this.changeMode(je.SIMPLE_SELECT,{featureIds:[B.polygon.id]})},onMouseMove:function(B,j){B.polygon.updateCoordinate("0."+B.currentVertexPosition,j.lngLat.lng,j.lngLat.lat),pe(j)&&this.updateUIClasses({mouse:se})}};Qt.onTap=Qt.onClick=function(B,j){return pe(j)?this.clickOnVertex(B,j):this.clickAnywhere(B,j)},Qt.onKeyUp=function(B,j){ke(j)?(this.deleteFeature([B.polygon.id],{silent:!0}),this.changeMode(je.SIMPLE_SELECT)):$e(j)&&this.changeMode(je.SIMPLE_SELECT,{featureIds:[B.polygon.id]})},Qt.onStop=function(B){this.updateUIClasses({mouse:ce}),ft(this),this.activateUIButton(),this.getFeature(B.polygon.id)!==void 0&&(B.polygon.removeCoordinate("0."+B.currentVertexPosition),B.polygon.isValid()?this.map.fire(_t,{features:[B.polygon.toGeoJSON()]}):(this.deleteFeature([B.polygon.id],{silent:!0}),this.changeMode(je.SIMPLE_SELECT,{},{silent:!0})))},Qt.toDisplayFeatures=function(B,j,ae){var Ue=j.properties.id===B.polygon.id;if(j.properties.active=Ue?kt:Ri,!Ue)return ae(j);if(j.geometry.coordinates.length!==0){var nt=j.geometry.coordinates[0].length;if(!(nt<3)){if(j.properties.meta=yi,ae(ut(B.polygon.id,j.geometry.coordinates[0][0],"0.0",!1)),nt>3){var Ye=j.geometry.coordinates[0].length-3;ae(ut(B.polygon.id,j.geometry.coordinates[0][Ye],"0."+Ye,!1))}if(nt<=4){var et=[[j.geometry.coordinates[0][0][0],j.geometry.coordinates[0][0][1]],[j.geometry.coordinates[0][1][0],j.geometry.coordinates[0][1][1]]];if(ae({type:he,properties:j.properties,geometry:{coordinates:et,type:Pe}}),nt===3)return}return ae(j)}}},Qt.onTrash=function(B){this.deleteFeature([B.polygon.id],{silent:!0}),this.changeMode(je.SIMPLE_SELECT)};var Wi={onSetup:function(B){var j,ae,Ue=(B=B||{}).featureId,nt="forward";if(Ue){if(!(j=this.getFeature(Ue)))throw new Error("Could not find a feature with the provided featureId");var Ye=B.from;if(Ye&&Ye.type==="Feature"&&Ye.geometry&&Ye.geometry.type==="Point"&&(Ye=Ye.geometry),Ye&&Ye.type==="Point"&&Ye.coordinates&&Ye.coordinates.length===2&&(Ye=Ye.coordinates),!Ye||!Array.isArray(Ye))throw new Error("Please use the `from` property to indicate which point to continue the line from");var et=j.coordinates.length-1;if(j.coordinates[et][0]===Ye[0]&&j.coordinates[et][1]===Ye[1])ae=et+1,j.addCoordinate.apply(j,[ae].concat(j.coordinates[et]));else{if(j.coordinates[0][0]!==Ye[0]||j.coordinates[0][1]!==Ye[1])throw new Error("`from` should match the point at either the start or the end of the provided LineString");nt="backwards",ae=0,j.addCoordinate.apply(j,[ae].concat(j.coordinates[0]))}}else j=this.newFeature({type:he,properties:{},geometry:{type:Pe,coordinates:[]}}),ae=0,this.addFeature(j);return this.clearSelectedFeatures(),bi(this),this.updateUIClasses({mouse:J}),this.activateUIButton(ee.LINE),this.setActionableState({trash:!0}),{line:j,currentVertexPosition:ae,direction:nt}},clickAnywhere:function(B,j){if(B.currentVertexPosition>0&&So(j,B.line.coordinates[B.currentVertexPosition-1])||B.direction==="backwards"&&So(j,B.line.coordinates[B.currentVertexPosition+1]))return this.changeMode(je.SIMPLE_SELECT,{featureIds:[B.line.id]});this.updateUIClasses({mouse:J}),B.line.updateCoordinate(B.currentVertexPosition,j.lngLat.lng,j.lngLat.lat),B.direction==="forward"?(B.currentVertexPosition++,B.line.updateCoordinate(B.currentVertexPosition,j.lngLat.lng,j.lngLat.lat)):B.line.addCoordinate(0,j.lngLat.lng,j.lngLat.lat)},clickOnVertex:function(B){return this.changeMode(je.SIMPLE_SELECT,{featureIds:[B.line.id]})},onMouseMove:function(B,j){B.line.updateCoordinate(B.currentVertexPosition,j.lngLat.lng,j.lngLat.lat),pe(j)&&this.updateUIClasses({mouse:se})}};Wi.onTap=Wi.onClick=function(B,j){if(pe(j))return this.clickOnVertex(B,j);this.clickAnywhere(B,j)},Wi.onKeyUp=function(B,j){$e(j)?this.changeMode(je.SIMPLE_SELECT,{featureIds:[B.line.id]}):ke(j)&&(this.deleteFeature([B.line.id],{silent:!0}),this.changeMode(je.SIMPLE_SELECT))},Wi.onStop=function(B){ft(this),this.activateUIButton(),this.getFeature(B.line.id)!==void 0&&(B.line.removeCoordinate(""+B.currentVertexPosition),B.line.isValid()?this.map.fire(_t,{features:[B.line.toGeoJSON()]}):(this.deleteFeature([B.line.id],{silent:!0}),this.changeMode(je.SIMPLE_SELECT,{},{silent:!0})))},Wi.onTrash=function(B){this.deleteFeature([B.line.id],{silent:!0}),this.changeMode(je.SIMPLE_SELECT)},Wi.toDisplayFeatures=function(B,j,ae){var Ue=j.properties.id===B.line.id;if(j.properties.active=Ue?kt:Ri,!Ue)return ae(j);j.geometry.coordinates.length<2||(j.properties.meta=yi,ae(ut(B.line.id,j.geometry.coordinates[B.direction==="forward"?j.geometry.coordinates.length-2:1],""+(B.direction==="forward"?j.geometry.coordinates.length-2:1),!1)),ae(j))};var ir={simple_select:Vr,direct_select:Cn,draw_point:Hn,draw_polygon:Qt,draw_line_string:Wi},Jn={defaultMode:je.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:[{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#3bb2d0","fill-outline-color":"#3bb2d0","fill-opacity":.1}},{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","active","true"],["==","$type","Polygon"]],paint:{"fill-color":"#fbb03b","fill-outline-color":"#fbb03b","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","active","true"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-stroke-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#fff"}},{id:"gl-draw-polygon-and-line-vertex-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-point-point-stroke-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-opacity":1,"circle-color":"#fff"}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#3bb2d0"}},{id:"gl-draw-point-stroke-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["!=","meta","midpoint"]],paint:{"circle-radius":7,"circle-color":"#fff"}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":5,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","mode","static"],["==","$type","Polygon"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","mode","static"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","mode","static"],["==","$type","LineString"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-point-static",type:"circle",filter:["all",["==","mode","static"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"#404040"}}],modes:ir,controls:{},userProperties:!1},ia={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},nr={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function ra(B,j){return B.map(function(ae){return ae.source?ae:qr(ae,{id:ae.id+"."+j,source:j==="hot"?W:Y})})}var na=ii(function(B,j){var ae="[object Arguments]",Ue="[object Map]",nt="[object Object]",Ye="[object Set]",et=/^\[object .+?Constructor\]$/,jt=/^(?:0|[1-9]\d*)$/,Ot={};Ot["[object Float32Array]"]=Ot["[object Float64Array]"]=Ot["[object Int8Array]"]=Ot["[object Int16Array]"]=Ot["[object Int32Array]"]=Ot["[object Uint8Array]"]=Ot["[object Uint8ClampedArray]"]=Ot["[object Uint16Array]"]=Ot["[object Uint32Array]"]=!0,Ot[ae]=Ot["[object Array]"]=Ot["[object ArrayBuffer]"]=Ot["[object Boolean]"]=Ot["[object DataView]"]=Ot["[object Date]"]=Ot["[object Error]"]=Ot["[object Function]"]=Ot[Ue]=Ot["[object Number]"]=Ot[nt]=Ot["[object RegExp]"]=Ot[Ye]=Ot["[object String]"]=Ot["[object WeakMap]"]=!1;var ei=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,Ke=typeof self=="object"&&self&&self.Object===Object&&self,ci=ei||Ke||Function("return this")(),Ei=j&&!j.nodeType&&j,Mi=Ei&&B&&!B.nodeType&&B,Oi=Mi&&Mi.exports===Ei,Yr=Oi&&ei.process,St=function(){try{return Yr&&Yr.binding&&Yr.binding("util")}catch{}}(),ni=St&&St.isTypedArray;function gr(Xe,pt){for(var ui=-1,Ui=Xe==null?0:Xe.length;++ui<Ui;)if(pt(Xe[ui],ui,Xe))return!0;return!1}function yr(Xe){var pt=-1,ui=Array(Xe.size);return Xe.forEach(function(Ui,Br){ui[++pt]=[Br,Ui]}),ui}function Dr(Xe){var pt=-1,ui=Array(Xe.size);return Xe.forEach(function(Ui){ui[++pt]=Ui}),ui}var Ti,ho,eo,or=Array.prototype,an=Function.prototype,hn=Object.prototype,vs=ci["__core-js_shared__"],Ha=an.toString,yn=hn.hasOwnProperty,Js=(Ti=/[^.]+$/.exec(vs&&vs.keys&&vs.keys.IE_PROTO||""))?"Symbol(src)_1."+Ti:"",bs=hn.toString,zo=RegExp("^"+Ha.call(yn).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),On=Oi?ci.Buffer:void 0,Oo=ci.Symbol,fo=ci.Uint8Array,Wa=hn.propertyIsEnumerable,Ya=or.splice,_n=Oo?Oo.toStringTag:void 0,ws=Object.getOwnPropertySymbols,Ka=On?On.isBuffer:void 0,el=(ho=Object.keys,eo=Object,function(Xe){return ho(eo(Xe))}),Ca=Vo(ci,"DataView"),aa=Vo(ci,"Map"),ka=Vo(ci,"Promise"),Pa=Vo(ci,"Set"),po=Vo(ci,"WeakMap"),Fo=Vo(Object,"create"),Es=no(Ca),Qa=no(aa),Ts=no(ka),to=no(Pa),fr=no(po),sa=Oo?Oo.prototype:void 0,la=sa?sa.valueOf:void 0;function io(Xe){var pt=-1,ui=Xe==null?0:Xe.length;for(this.clear();++pt<ui;){var Ui=Xe[pt];this.set(Ui[0],Ui[1])}}function Fn(Xe){var pt=-1,ui=Xe==null?0:Xe.length;for(this.clear();++pt<ui;){var Ui=Xe[pt];this.set(Ui[0],Ui[1])}}function Mo(Xe){var pt=-1,ui=Xe==null?0:Xe.length;for(this.clear();++pt<ui;){var Ui=Xe[pt];this.set(Ui[0],Ui[1])}}function No(Xe){var pt=-1,ui=Xe==null?0:Xe.length;for(this.__data__=new Mo;++pt<ui;)this.add(Xe[pt])}function ro(Xe){var pt=this.__data__=new Fn(Xe);this.size=pt.size}function Ja(Xe,pt){var ui=ua(Xe),Ui=!ui&&ts(Xe),Br=!ui&&!Ui&&is(Xe),cr=!ui&&!Ui&&!Br&&Da(Xe),Zr=ui||Ui||Br||cr,Kr=Zr?function(en,Pn){for(var go=-1,dn=Array(en);++go<en;)dn[go]=Pn(go);return dn}(Xe.length,String):[],Wn=Kr.length;for(var Xr in Xe)!pt&&!yn.call(Xe,Xr)||Zr&&(Xr=="length"||Br&&(Xr=="offset"||Xr=="parent")||cr&&(Xr=="buffer"||Xr=="byteLength"||Xr=="byteOffset")||Is(Xr,Wn))||Kr.push(Xr);return Kr}function Ao(Xe,pt){for(var ui=Xe.length;ui--;)if(es(Xe[ui][0],pt))return ui;return-1}function Nn(Xe){return Xe==null?Xe===void 0?"[object Undefined]":"[object Null]":_n&&_n in Object(Xe)?function(pt){var ui=yn.call(pt,_n),Ui=pt[_n];try{pt[_n]=void 0;var Br=!0}catch{}var cr=bs.call(pt);return Br&&(ui?pt[_n]=Ui:delete pt[_n]),cr}(Xe):function(pt){return bs.call(pt)}(Xe)}function Uo(Xe){return fa(Xe)&&Nn(Xe)==ae}function ur(Xe,pt,ui,Ui,Br){return Xe===pt||(Xe==null||pt==null||!fa(Xe)&&!fa(pt)?Xe!=Xe&&pt!=pt:function(cr,Zr,Kr,Wn,Xr,en){var Pn=ua(cr),go=ua(Zr),dn=Pn?"[object Array]":mo(cr),_o=go?"[object Array]":mo(Zr),yo=(dn=dn==ae?nt:dn)==nt,jo=(_o=_o==ae?nt:_o)==nt,Io=dn==_o;if(Io&&is(cr)){if(!is(Zr))return!1;Pn=!0,yo=!1}if(Io&&!yo)return en||(en=new ro),Pn||Da(cr)?Ms(cr,Zr,Kr,Wn,Xr,en):function(Cr,br,Ba,oo,Ra,Tn,ao){switch(Ba){case"[object DataView]":if(Cr.byteLength!=br.byteLength||Cr.byteOffset!=br.byteOffset)return!1;Cr=Cr.buffer,br=br.buffer;case"[object ArrayBuffer]":return!(Cr.byteLength!=br.byteLength||!Tn(new fo(Cr),new fo(br)));case"[object Boolean]":case"[object Date]":case"[object Number]":return es(+Cr,+br);case"[object Error]":return Cr.name==br.name&&Cr.message==br.message;case"[object RegExp]":case"[object String]":return Cr==br+"";case Ue:var xo=yr;case Ye:var pa=1&oo;if(xo||(xo=Dr),Cr.size!=br.size&&!pa)return!1;var ma=ao.get(Cr);if(ma)return ma==br;oo|=2,ao.set(Cr,br);var Un=Ms(xo(Cr),xo(br),oo,Ra,Tn,ao);return ao.delete(Cr),Un;case"[object Symbol]":if(la)return la.call(Cr)==la.call(br)}return!1}(cr,Zr,dn,Kr,Wn,Xr,en);if(!(1&Kr)){var Go=yo&&yn.call(cr,"__wrapped__"),qo=jo&&yn.call(Zr,"__wrapped__");if(Go||qo){var $l=Go?cr.value():cr,Vl=qo?Zr.value():Zr;return en||(en=new ro),Xr($l,Vl,Kr,Wn,en)}}return Io?(en||(en=new ro),function(Cr,br,Ba,oo,Ra,Tn){var ao=1&Ba,xo=As(Cr),pa=xo.length,ma=As(br).length;if(pa!=ma&&!ao)return!1;for(var Un=pa;Un--;){var Dn=xo[Un];if(!(ao?Dn in br:yn.call(br,Dn)))return!1}var ns=Tn.get(Cr);if(ns&&Tn.get(br))return ns==br;var $n=!0;Tn.set(Cr,br),Tn.set(br,Cr);for(var Co=ao;++Un<pa;){Dn=xo[Un];var La=Cr[Dn],Bn=br[Dn];if(oo)var hr=ao?oo(Bn,La,Dn,br,Cr,Tn):oo(La,Bn,Dn,Cr,br,Tn);if(!(hr===void 0?La===Bn||Ra(La,Bn,Ba,oo,Tn):hr)){$n=!1;break}Co||(Co=Dn=="constructor")}if($n&&!Co){var Vn=Cr.constructor,os=br.constructor;Vn==os||!("constructor"in Cr)||!("constructor"in br)||typeof Vn=="function"&&Vn instanceof Vn&&typeof os=="function"&&os instanceof os||($n=!1)}return Tn.delete(Cr),Tn.delete(br),$n}(cr,Zr,Kr,Wn,Xr,en)):!1}(Xe,pt,ui,Ui,ur,Br))}function ca(Xe){return!(!da(Xe)||function(pt){return!!Js&&Js in pt}(Xe))&&(il(Xe)?zo:et).test(no(Xe))}function Ss(Xe){if(ui=(pt=Xe)&&pt.constructor,Ui=typeof ui=="function"&&ui.prototype||hn,pt!==Ui)return el(Xe);var pt,ui,Ui,Br=[];for(var cr in Object(Xe))yn.call(Xe,cr)&&cr!="constructor"&&Br.push(cr);return Br}function Ms(Xe,pt,ui,Ui,Br,cr){var Zr=1&ui,Kr=Xe.length,Wn=pt.length;if(Kr!=Wn&&!(Zr&&Wn>Kr))return!1;var Xr=cr.get(Xe);if(Xr&&cr.get(pt))return Xr==pt;var en=-1,Pn=!0,go=2&ui?new No:void 0;for(cr.set(Xe,pt),cr.set(pt,Xe);++en<Kr;){var dn=Xe[en],_o=pt[en];if(Ui)var yo=Zr?Ui(_o,dn,en,pt,Xe,cr):Ui(dn,_o,en,Xe,pt,cr);if(yo!==void 0){if(yo)continue;Pn=!1;break}if(go){if(!gr(pt,function(jo,Io){if(Go=Io,!go.has(Go)&&(dn===jo||Br(dn,jo,ui,Ui,cr)))return go.push(Io);var Go})){Pn=!1;break}}else if(dn!==_o&&!Br(dn,_o,ui,Ui,cr)){Pn=!1;break}}return cr.delete(Xe),cr.delete(pt),Pn}function As(Xe){return function(pt,ui,Ui){var Br=ui(pt);return ua(pt)?Br:function(cr,Zr){for(var Kr=-1,Wn=Zr.length,Xr=cr.length;++Kr<Wn;)cr[Xr+Kr]=Zr[Kr];return cr}(Br,Ui(pt))}(Xe,rs,tl)}function $o(Xe,pt){var ui,Ui,Br=Xe.__data__;return((Ui=typeof(ui=pt))=="string"||Ui=="number"||Ui=="symbol"||Ui=="boolean"?ui!=="__proto__":ui===null)?Br[typeof pt=="string"?"string":"hash"]:Br.map}function Vo(Xe,pt){var ui=function(Ui,Br){return Ui?.[Br]}(Xe,pt);return ca(ui)?ui:void 0}io.prototype.clear=function(){this.__data__=Fo?Fo(null):{},this.size=0},io.prototype.delete=function(Xe){var pt=this.has(Xe)&&delete this.__data__[Xe];return this.size-=pt?1:0,pt},io.prototype.get=function(Xe){var pt=this.__data__;if(Fo){var ui=pt[Xe];return ui==="__lodash_hash_undefined__"?void 0:ui}return yn.call(pt,Xe)?pt[Xe]:void 0},io.prototype.has=function(Xe){var pt=this.__data__;return Fo?pt[Xe]!==void 0:yn.call(pt,Xe)},io.prototype.set=function(Xe,pt){var ui=this.__data__;return this.size+=this.has(Xe)?0:1,ui[Xe]=Fo&&pt===void 0?"__lodash_hash_undefined__":pt,this},Fn.prototype.clear=function(){this.__data__=[],this.size=0},Fn.prototype.delete=function(Xe){var pt=this.__data__,ui=Ao(pt,Xe);return!(ui<0)&&(ui==pt.length-1?pt.pop():Ya.call(pt,ui,1),--this.size,!0)},Fn.prototype.get=function(Xe){var pt=this.__data__,ui=Ao(pt,Xe);return ui<0?void 0:pt[ui][1]},Fn.prototype.has=function(Xe){return Ao(this.__data__,Xe)>-1},Fn.prototype.set=function(Xe,pt){var ui=this.__data__,Ui=Ao(ui,Xe);return Ui<0?(++this.size,ui.push([Xe,pt])):ui[Ui][1]=pt,this},Mo.prototype.clear=function(){this.size=0,this.__data__={hash:new io,map:new(aa||Fn),string:new io}},Mo.prototype.delete=function(Xe){var pt=$o(this,Xe).delete(Xe);return this.size-=pt?1:0,pt},Mo.prototype.get=function(Xe){return $o(this,Xe).get(Xe)},Mo.prototype.has=function(Xe){return $o(this,Xe).has(Xe)},Mo.prototype.set=function(Xe,pt){var ui=$o(this,Xe),Ui=ui.size;return ui.set(Xe,pt),this.size+=ui.size==Ui?0:1,this},No.prototype.add=No.prototype.push=function(Xe){return this.__data__.set(Xe,"__lodash_hash_undefined__"),this},No.prototype.has=function(Xe){return this.__data__.has(Xe)},ro.prototype.clear=function(){this.__data__=new Fn,this.size=0},ro.prototype.delete=function(Xe){var pt=this.__data__,ui=pt.delete(Xe);return this.size=pt.size,ui},ro.prototype.get=function(Xe){return this.__data__.get(Xe)},ro.prototype.has=function(Xe){return this.__data__.has(Xe)},ro.prototype.set=function(Xe,pt){var ui=this.__data__;if(ui instanceof Fn){var Ui=ui.__data__;if(!aa||Ui.length<199)return Ui.push([Xe,pt]),this.size=++ui.size,this;ui=this.__data__=new Mo(Ui)}return ui.set(Xe,pt),this.size=ui.size,this};var tl=ws?function(Xe){return Xe==null?[]:(Xe=Object(Xe),function(pt,ui){for(var Ui=-1,Br=pt==null?0:pt.length,cr=0,Zr=[];++Ui<Br;){var Kr=pt[Ui];ui(Kr,Ui,pt)&&(Zr[cr++]=Kr)}return Zr}(ws(Xe),function(pt){return Wa.call(Xe,pt)}))}:function(){return[]},mo=Nn;function Is(Xe,pt){return!!(pt=pt??9007199254740991)&&(typeof Xe=="number"||jt.test(Xe))&&Xe>-1&&Xe%1==0&&Xe<pt}function no(Xe){if(Xe!=null){try{return Ha.call(Xe)}catch{}try{return Xe+""}catch{}}return""}function es(Xe,pt){return Xe===pt||Xe!=Xe&&pt!=pt}(Ca&&mo(new Ca(new ArrayBuffer(1)))!="[object DataView]"||aa&&mo(new aa)!=Ue||ka&&mo(ka.resolve())!="[object Promise]"||Pa&&mo(new Pa)!=Ye||po&&mo(new po)!="[object WeakMap]")&&(mo=function(Xe){var pt=Nn(Xe),ui=pt==nt?Xe.constructor:void 0,Ui=ui?no(ui):"";if(Ui)switch(Ui){case Es:return"[object DataView]";case Qa:return Ue;case Ts:return"[object Promise]";case to:return Ye;case fr:return"[object WeakMap]"}return pt});var ts=Uo(function(){return arguments}())?Uo:function(Xe){return fa(Xe)&&yn.call(Xe,"callee")&&!Wa.call(Xe,"callee")},ua=Array.isArray,is=Ka||function(){return!1};function il(Xe){if(!da(Xe))return!1;var pt=Nn(Xe);return pt=="[object Function]"||pt=="[object GeneratorFunction]"||pt=="[object AsyncFunction]"||pt=="[object Proxy]"}function ha(Xe){return typeof Xe=="number"&&Xe>-1&&Xe%1==0&&Xe<=9007199254740991}function da(Xe){var pt=typeof Xe;return Xe!=null&&(pt=="object"||pt=="function")}function fa(Xe){return Xe!=null&&typeof Xe=="object"}var Da=ni?function(Xe){return function(pt){return Xe(pt)}}(ni):function(Xe){return fa(Xe)&&ha(Xe.length)&&!!Ot[Nn(Xe)]};function rs(Xe){return(pt=Xe)!=null&&ha(pt.length)&&!il(pt)?Ja(Xe):Ss(Xe);var pt}B.exports=function(Xe,pt){return ur(Xe,pt)}}),oa={Polygon:Fi,LineString:Ii,Point:Li,MultiPolygon:Ki,MultiLineString:Ki,MultiPoint:Ki};function kn(B,j){return j.modes=je,j.getFeatureIdsAt=function(ae){return si.click({point:ae},null,B).map(function(Ue){return Ue.properties.id})},j.getSelectedIds=function(){return B.store.getSelectedIds()},j.getSelected=function(){return{type:We,features:B.store.getSelectedIds().map(function(ae){return B.store.get(ae)}).map(function(ae){return ae.toGeoJSON()})}},j.getSelectedPoints=function(){return{type:We,features:B.store.getSelectedCoordinates().map(function(ae){return{type:he,properties:{},geometry:{type:Qe,coordinates:ae.coordinates}}})}},j.set=function(ae){if(ae.type===void 0||ae.type!==We||!Array.isArray(ae.features))throw new Error("Invalid FeatureCollection");var Ue=B.store.createRenderBatch(),nt=B.store.getAllIds().slice(),Ye=j.add(ae),et=new Gt(Ye);return(nt=nt.filter(function(jt){return!et.has(jt)})).length&&j.delete(nt),Ue(),Ye},j.add=function(ae){var Ue=JSON.parse(JSON.stringify(wi(ae))).features.map(function(nt){if(nt.id=nt.id||Rt(),nt.geometry===null)throw new Error("Invalid geometry: null");if(B.store.get(nt.id)===void 0||B.store.get(nt.id).type!==nt.geometry.type){var Ye=oa[nt.geometry.type];if(Ye===void 0)throw new Error("Invalid geometry type: "+nt.geometry.type+".");var et=new Ye(B,nt);B.store.add(et)}else{var jt=B.store.get(nt.id);jt.properties=nt.properties,na(jt.getCoordinates(),nt.geometry.coordinates)||jt.incomingCoords(nt.geometry.coordinates)}return nt.id});return B.store.render(),Ue},j.get=function(ae){var Ue=B.store.get(ae);if(Ue)return Ue.toGeoJSON()},j.getAll=function(){return{type:We,features:B.store.getAll().map(function(ae){return ae.toGeoJSON()})}},j.delete=function(ae){return B.store.delete(ae,{silent:!0}),j.getMode()!==je.DIRECT_SELECT||B.store.getSelectedIds().length?B.store.render():B.events.changeMode(je.SIMPLE_SELECT,void 0,{silent:!0}),j},j.deleteAll=function(){return B.store.delete(B.store.getAllIds(),{silent:!0}),j.getMode()===je.DIRECT_SELECT?B.events.changeMode(je.SIMPLE_SELECT,void 0,{silent:!0}):B.store.render(),j},j.changeMode=function(ae,Ue){return Ue===void 0&&(Ue={}),ae===je.SIMPLE_SELECT&&j.getMode()===je.SIMPLE_SELECT?(nt=Ue.featureIds||[],Ye=B.store.getSelectedIds(),nt.length===Ye.length&&JSON.stringify(nt.map(function(et){return et}).sort())===JSON.stringify(Ye.map(function(et){return et}).sort())||(B.store.setSelected(Ue.featureIds,{silent:!0}),B.store.render()),j):(ae===je.DIRECT_SELECT&&j.getMode()===je.DIRECT_SELECT&&Ue.featureId===B.store.getSelectedIds()[0]||B.events.changeMode(ae,Ue,{silent:!0}),j);var nt,Ye},j.getMode=function(){return B.events.getMode()},j.trash=function(){return B.events.trash({silent:!0}),j},j.combineFeatures=function(){return B.events.combineFeatures({silent:!0}),j},j.uncombineFeatures=function(){return B.events.uncombineFeatures({silent:!0}),j},j.setFeatureProperty=function(ae,Ue,nt){return B.store.setFeatureProperty(ae,Ue,nt),j},j}var Pr=function(B,j){var ae={options:B=function(nt){nt===void 0&&(nt={});var Ye=qr(nt);return nt.controls||(Ye.controls={}),nt.displayControlsDefault===!1?Ye.controls=qr(nr,nt.controls):Ye.controls=qr(ia,nt.controls),(Ye=qr(Jn,Ye)).styles=ra(Ye.styles,"cold").concat(ra(Ye.styles,"hot")),Ye}(B)};j=kn(ae,j),ae.api=j;var Ue=qe(ae);return j.onAdd=Ue.onAdd,j.onRemove=Ue.onRemove,j.types=ee,j.options=B,j};function Qs(B){Pr(B,this)}return Qs.modes=ir,Qs})})(mapboxGlDraw$1);var mapboxGlDraw="",mapboxMapViewer_vue_vue_type_style_index_0_lang="";let geocoder;const _sfc_main$3={name:"mapbox-map-viewer",setup(){return{tileInfoString:ref(""),dirHandle:ref(""),style_url:ref(""),access_token:ref(""),mapbox_raster_png_dem:ref(""),mapbox_api_url:ref(""),mapbox_rgb_image_url:ref(""),map:ref(""),threedview:ref(!1),layers:ref(["hillshading","bounding_box","undersea-features-lines","undersea-features-points","undersea-features-points-label","10m-bathymetry-81bsvj"]),layer_type:[{label:"Hillshade",value:"hillshading"},{label:"Bounding Box",value:"bounding_box"},{label:"Undersea Lines",value:"undersea-features-lines"},{label:"Undersea Points",value:"undersea-features-points"},{label:"Undersea Labels",value:"undersea-features-points-label"},{label:"Depth",value:"10m-bathymetry-81bsvj"},{label:"Satellite",value:"satellite"},{label:"3D",value:"3d"}]}},mounted(){},methods:{async changeLayers(e){for(const r of this.layer_type)e.includes(r.value)?r.value!=="3d"?this.map.setLayoutProperty(r.value,"visibility","visible"):this.map.setTerrain({source:"mapbox-3d",exaggeration:1.5}):r.value!=="3d"?this.map.setLayoutProperty(r.value,"visibility","none"):this.map.setTerrain(null)},loadMapSourcesLayers(e){e.addSource("mapbox_terrain_dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1"}),e.addSource("satellite",{type:"raster",url:"mapbox://mapbox.satellite",tileSize:512}),e.addLayer({id:"satellite",source:"satellite",type:"raster",layout:{visibility:"none"}}),e.addLayer({id:"hillshading",source:"mapbox_terrain_dem",type:"hillshade"}),e.addSource("bounding_box_source",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,1],[1,1],[1,0],[0,0]]]}}}),e.addLayer({id:"bounding_box",type:"fill",source:"bounding_box_source",paint:{"fill-color":"#008888","fill-opacity":0}}),e.addSource("bathymetry",{type:"vector",url:"mapbox://mapbox-public.bathymetry"}),e.addLayer({id:"undersea-features-lines",type:"line",source:"bathymetry","source-layer":"undersea-features-lines",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ff69b4","line-width":2}}),e.addLayer({id:"undersea-features-points",type:"circle",source:"bathymetry","source-layer":"undersea-features-points",paint:{"circle-radius":4,"circle-color":"#01fe01"}}),e.addLayer({id:"undersea-features-points-label",type:"symbol",source:"bathymetry","source-layer":"undersea-features-points",layout:{"text-field":"{name}","text-anchor":"top-left","text-size":12}}),e.addSource("10m-bathymetry-81bsvj",{type:"vector",url:"mapbox://mapbox.9tm8dx88"}),e.addSource("mapbox-3d",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:15}),e.addLayer({id:"10m-bathymetry-81bsvj",type:"fill",source:"10m-bathymetry-81bsvj","source-layer":"10m-bathymetry-81bsvj",layout:{},paint:{"fill-outline-color":"hsla(337, 82%, 62%, 0)","fill-color":["interpolate",["cubic-bezier",0,.5,1,.5],["get","DEPTH"],200,"#78bced",9e3,"#15659f"]}},"land-structure-polygon")},async loadMapboxMap(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.mapbox_api_url=await idbKeyval.get("mapbox_api_url"),this.dirHandle=await idbKeyval.get("dirHandle"),this.style_url=await idbKeyval.get("style_url"),this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem");let e=this,r=new mapboxgl.Map({container:"map",trackResize:!0,style:e.style_url,center:[-121.7598,46.876],zoom:9,maxZoom:14,doubleClickZoom:!0,antialias:!0,boxZoom:!0,failIfMajorPerformanceCaveat:!0});this.map=r;const n=function(_){const o=_.match(/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i);if(!o)return null;function b(L,D){return{center:[L,D],geometry:{type:"Point",coordinates:[L,D]},place_name:"Lat: "+D+" Lng: "+L,place_type:["coordinate"],properties:{},type:"Feature"}}const E=Number(o[1]),M=Number(o[2]),P=[];return(E<-90||E>90)&&P.push(b(E,M)),(M<-90||M>90)&&P.push(b(M,E)),P.length===0&&(P.push(b(E,M)),P.push(b(M,E))),P};geocoder=new lib({accessToken:this.access_token,mapboxgl,localGeocoder:n,zoom:10,placeholder:"Try: -40, 170 or  Name",reverseGeocode:!0}),r.addControl(geocoder),r.addControl(new mapboxgl.FullscreenControl({})),r.addControl(new mapboxgl.NavigationControl);const a=100,u=25;function f(_){return _*(2-_)}r.on("style.load",()=>{const _=()=>{r.isStyleLoaded()?e.loadMapSourcesLayers(r):setTimeout(_,200)};_()}),r.on("load",function(){r.getCanvas().focus(),r.getCanvas().addEventListener("keydown",_=>{_.preventDefault(),_.which===87?r.panBy([0,-a],{easing:f}):_.which===83?r.panBy([0,a],{easing:f}):_.which===65?r.easeTo({bearing:r.getBearing()-u,easing:f}):_.which===68&&r.easeTo({bearing:r.getBearing()+u,easing:f})},!0)}),r.on("error",_=>{console.error(_)}),r.on("click",async function(_){let o=await idbKeyval.get("dirHandle");if(await fileUtils.verifyPermission(o,!0)===!1){console.error(`User did not grant permission to '${o.name}'`);return}let b=_.lngLat.lng,E=_.lngLat.lat,M=mapUtils.getTileInfo(b,E,r);idbKeyval.set("tile_info",M),e.tileInfoString="Slippy Tile Info String: "+M.x+","+M.y+","+M.z+" Area in KM: "+M.distance,await e.geoCodeReverse(M),r.getSource("bounding_box_source").setData(M.polygon_bb),r.setPaintProperty("bounding_box","fill-opacity",.45),e.mapbox_rgb_image_url=e.mapbox_api_url+e.mapbox_raster_png_dem+`/${M.z}/${M.x}/${M.y}@2x.pngraw?access_token=`+e.access_token;let P=await mapUtils.getMapboxTerrainRgb(o,M,e.mapbox_rgb_image_url),L=await P.toBuffer();await idbKeyval.set("rgb_image_buffer",L),await fileUtils.writeFileToDisk(o,M.rgbFileName,L);let D=mapUtils.createHeightMapImage(P,32,"GREY");if(await fileUtils.fileExists(o,M.thirtyTwoFileName)===!1){let X=await D.image.toBuffer();await fileUtils.writeFileToDisk(o,M.thirtyTwoFileName,X)}emitter.emit("updatePreviewImage",{dir_handle:o,tile_info:M,preview_image_info:D,map:r})}),r.on("mousemove",_=>{r.getCanvas().style.cursor="pointer";const o=r.queryRenderedFeatures(_.point);for(const b of o)if(Object.keys(b.type).length>0&&Object.keys(b.properties).length>0){let E=b.properties,M=b.layer;E.DEPTH&&E.DEPTH,b.type,M.id}})},resizeMap(){this.map.resize()},async geoCodeReverse(e){geocoding({accessToken:mapboxgl.accessToken}).reverseGeocode({query:[e.pointLng,e.pointLat]}).send().then(function(n){if(n&&n.body&&n.body.features){e.address=n.body.features[0].place_name;let a=n.body.features[0].context;for(let u of a){let f=u.id;switch(f.substring(0,f.indexOf("."))){case"neighborhood":e.neighborhood=u.text;break;case"postcode":e.postcode=u.text;break;case"locality":e.locality=u.text;break;case"place":e.place=u.text;break;case"district":e.district=u.text;break;case"region":e.region=u.text;break;case"country":e.country=u.text;break}}}})}}},_hoisted_1$3={id:"map"},_hoisted_2$3={class:"row no-wrap q-pa-md"},_hoisted_3$3={class:"column"},_hoisted_4$3=createBaseVNode("u",null,[createBaseVNode("b",null,"Enable Layers")],-1);function _sfc_render$3(e,r,n,a,u,f){return openBlock(),createElementBlock("div",_hoisted_1$3,[createVNode(QToolbar,{id:"mb-tbar",class:"bg-primary text-white q-pa-none q-ma-none"},{default:withCtx(()=>[createVNode(QBtn,{color:"info",label:"Map Settings"},{default:withCtx(()=>[createVNode(QMenu,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_2$3,[createBaseVNode("div",_hoisted_3$3,[_hoisted_4$3,createVNode(QOptionGroup,{dense:"",color:"green","checked-icon":"check","unchecked-icon":"clear",options:a.layer_type,type:"toggle",modelValue:a.layers,"onUpdate:modelValue":[r[0]||(r[0]=_=>a.layers=_),f.changeLayers]},null,8,["options","modelValue","onUpdate:modelValue"])])])]),_:1})]),_:1}),createTextVNode(" \xA0 \xA0 \xA0 "+toDisplayString(this.tileInfoString),1)]),_:1})])}var MapboxMapViewer=_export_sfc(_sfc_main$3,[["render",_sfc_render$3]]);const useRatioProps={ratio:[String,Number]};function useRatio(e,r){return computed(()=>{const n=Number(e.ratio||(r!==void 0?r.value:void 0));return isNaN(n)!==!0&&n>0?{paddingBottom:`${100/n}%`}:null})}const defaultRatio=16/9;var QImg=createComponent({name:"QImg",props:{...useRatioProps,src:String,srcset:String,sizes:String,alt:String,crossorigin:String,decoding:String,referrerpolicy:String,draggable:Boolean,loading:{type:String,default:"lazy"},fetchpriority:{type:String,default:"auto"},width:String,height:String,initialRatio:{type:[Number,String],default:defaultRatio},placeholderSrc:String,fit:{type:String,default:"cover"},position:{type:String,default:"50% 50%"},imgClass:String,imgStyle:Object,noSpinner:Boolean,noNativeMenu:Boolean,noTransition:Boolean,spinnerColor:String,spinnerSize:String},emits:["load","error"],setup(e,{slots:r,emit:n}){const a=ref(e.initialRatio),u=useRatio(e,a);let f;const _=[ref(null),ref(X())],o=ref(0),b=ref(!1),E=ref(!1),M=computed(()=>`q-img q-img--${e.noNativeMenu===!0?"no-":""}menu`),P=computed(()=>({width:e.width,height:e.height})),L=computed(()=>`q-img__image ${e.imgClass!==void 0?e.imgClass+" ":""}q-img__image--with${e.noTransition===!0?"out":""}-transition`),D=computed(()=>({...e.imgStyle,objectFit:e.fit,objectPosition:e.position}));watch(()=>U(),K);function U(){return e.src||e.srcset||e.sizes?{src:e.src,srcset:e.srcset,sizes:e.sizes}:null}function X(){return e.placeholderSrc!==void 0?{src:e.placeholderSrc}:null}function K(xe){clearTimeout(f),E.value=!1,xe===null?(b.value=!1,_[o.value^1].value=X()):b.value=!0,_[o.value].value=xe}function q({target:xe}){f!==null&&(clearTimeout(f),a.value=xe.naturalHeight===0?.5:xe.naturalWidth/xe.naturalHeight,oe(xe,1))}function oe(xe,se){f===null||se===1e3||(xe.complete===!0?W(xe):f=setTimeout(()=>{oe(xe,se+1)},50))}function W(xe){f!==null&&(o.value=o.value^1,_[o.value].value=null,b.value=!1,E.value=!1,n("load",xe.currentSrc||xe.src))}function Y(xe){clearTimeout(f),b.value=!1,E.value=!0,_[o.value].value=null,_[o.value^1].value=X(),n("error",xe)}function J(xe){const se=_[xe].value,ce={key:"img_"+xe,class:L.value,style:D.value,crossorigin:e.crossorigin,decoding:e.decoding,referrerpolicy:e.referrerpolicy,height:e.height,width:e.width,loading:e.loading,fetchpriority:e.fetchpriority,"aria-hidden":"true",draggable:e.draggable,...se};return o.value===xe?(ce.class+=" q-img__image--waiting",Object.assign(ce,{onLoad:q,onError:Y})):ce.class+=" q-img__image--loaded",h("div",{class:"q-img__container absolute-full",key:"img"+xe},h("img",ce))}function Ee(){return b.value!==!0?h("div",{key:"content",class:"q-img__content absolute-full q-anchor--skip"},hSlot(r[E.value===!0?"error":"default"])):h("div",{key:"loading",class:"q-img__loading absolute-full flex flex-center"},r.loading!==void 0?r.loading():e.noSpinner===!0?void 0:[h(QSpinner,{color:e.spinnerColor,size:e.spinnerSize})])}return K(U()),onBeforeUnmount(()=>{clearTimeout(f),f=null}),()=>{const xe=[];return u.value!==null&&xe.push(h("div",{key:"filler",style:u.value})),E.value!==!0&&(_[0].value!==null&&xe.push(J(0)),_[1].value!==null&&xe.push(J(1))),xe.push(h(Transition,{name:"q-transition--fade"},Ee)),h("div",{class:M.value,style:P.value,role:"img","aria-label":e.alt},xe)}}}),QField=createComponent({name:"QField",inheritAttrs:!1,props:useFieldProps,emits:useFieldEmits,setup(){return useField(useFieldState())}}),QItemLabel=createComponent({name:"QItemLabel",props:{overline:Boolean,caption:Boolean,header:Boolean,lines:[Number,String]},setup(e,{slots:r}){const n=computed(()=>parseInt(e.lines,10)),a=computed(()=>"q-item__label"+(e.overline===!0?" q-item__label--overline text-overline":"")+(e.caption===!0?" q-item__label--caption text-caption":"")+(e.header===!0?" q-item__label--header":"")+(n.value===1?" ellipsis":"")),u=computed(()=>e.lines!==void 0&&n.value>1?{overflow:"hidden",display:"-webkit-box","-webkit-box-orient":"vertical","-webkit-line-clamp":n.value}:null);return()=>h("div",{style:u.value,class:a.value},hSlot(r.default))}});const defaultSizes={xs:8,sm:10,md:14,lg:20,xl:24};var QChip=createComponent({name:"QChip",props:{...useDarkProps,...useSizeProps,dense:Boolean,icon:String,iconRight:String,iconRemove:String,iconSelected:String,label:[String,Number],color:String,textColor:String,modelValue:{type:Boolean,default:!0},selected:{type:Boolean,default:null},square:Boolean,outline:Boolean,clickable:Boolean,removable:Boolean,removeAriaLabel:String,tabindex:[String,Number],disable:Boolean,ripple:{type:[Boolean,Object],default:!0}},emits:["update:modelValue","update:selected","remove","click"],setup(e,{slots:r,emit:n}){const{proxy:{$q:a}}=getCurrentInstance(),u=useDark(e,a),f=useSize(e,defaultSizes),_=computed(()=>e.selected===!0||e.icon!==void 0),o=computed(()=>e.selected===!0?e.iconSelected||a.iconSet.chip.selected:e.icon),b=computed(()=>e.iconRemove||a.iconSet.chip.remove),E=computed(()=>e.disable===!1&&(e.clickable===!0||e.selected!==null)),M=computed(()=>{const K=e.outline===!0&&e.color||e.textColor;return"q-chip row inline no-wrap items-center"+(e.outline===!1&&e.color!==void 0?` bg-${e.color}`:"")+(K?` text-${K} q-chip--colored`:"")+(e.disable===!0?" disabled":"")+(e.dense===!0?" q-chip--dense":"")+(e.outline===!0?" q-chip--outline":"")+(e.selected===!0?" q-chip--selected":"")+(E.value===!0?" q-chip--clickable cursor-pointer non-selectable q-hoverable":"")+(e.square===!0?" q-chip--square":"")+(u.value===!0?" q-chip--dark q-dark":"")}),P=computed(()=>{const K=e.disable===!0?{tabindex:-1,"aria-disabled":"true"}:{tabindex:e.tabindex||0},q={...K,role:"button","aria-hidden":"false","aria-label":e.removeAriaLabel||a.lang.label.remove};return{chip:K,remove:q}});function L(K){K.keyCode===13&&D(K)}function D(K){e.disable||(n("update:selected",!e.selected),n("click",K))}function U(K){(K.keyCode===void 0||K.keyCode===13)&&(stopAndPrevent(K),e.disable===!1&&(n("update:modelValue",!1),n("remove")))}function X(){const K=[];E.value===!0&&K.push(h("div",{class:"q-focus-helper"})),_.value===!0&&K.push(h(QIcon,{class:"q-chip__icon q-chip__icon--left",name:o.value}));const q=e.label!==void 0?[h("div",{class:"ellipsis"},[e.label])]:void 0;return K.push(h("div",{class:"q-chip__content col row no-wrap items-center q-anchor--skip"},hMergeSlotSafely(r.default,q))),e.iconRight&&K.push(h(QIcon,{class:"q-chip__icon q-chip__icon--right",name:e.iconRight})),e.removable===!0&&K.push(h(QIcon,{class:"q-chip__icon q-chip__icon--remove cursor-pointer",name:b.value,...P.value.remove,onClick:U,onKeyup:U})),K}return()=>{if(e.modelValue===!1)return;const K={class:M.value,style:f.value};return E.value===!0&&Object.assign(K,P.value.chip,{onClick:D,onKeyup:L}),hDir("div",K,X(),"ripple",e.ripple!==!1&&e.disable!==!0,()=>[[Ripple,e.ripple]])}}}),QItem=createComponent({name:"QItem",props:{...useDarkProps,...useRouterLinkProps,tag:{type:String,default:"div"},active:{type:Boolean,default:null},clickable:Boolean,dense:Boolean,insetLevel:Number,tabindex:[String,Number],focused:Boolean,manualFocus:Boolean},emits:["click","keyup"],setup(e,{slots:r,emit:n}){const{proxy:{$q:a}}=getCurrentInstance(),u=useDark(e,a),{hasLink:f,linkAttrs:_,linkClass:o,linkTag:b,navigateOnClick:E}=useRouterLink(),M=ref(null),P=ref(null),L=computed(()=>e.clickable===!0||f.value===!0||e.tag==="label"),D=computed(()=>e.disable!==!0&&L.value===!0),U=computed(()=>"q-item q-item-type row no-wrap"+(e.dense===!0?" q-item--dense":"")+(u.value===!0?" q-item--dark":"")+(f.value===!0&&e.active===null?o.value:e.active===!0?` q-item--active${e.activeClass!==void 0?` ${e.activeClass}`:""}`:"")+(e.disable===!0?" disabled":"")+(D.value===!0?" q-item--clickable q-link cursor-pointer "+(e.manualFocus===!0?"q-manual-focusable":"q-focusable q-hoverable")+(e.focused===!0?" q-manual-focusable--focused":""):"")),X=computed(()=>{if(e.insetLevel===void 0)return null;const W=a.lang.rtl===!0?"Right":"Left";return{["padding"+W]:16+e.insetLevel*56+"px"}});function K(W){D.value===!0&&(P.value!==null&&(W.qKeyEvent!==!0&&document.activeElement===M.value?P.value.focus():document.activeElement===P.value&&M.value.focus()),E(W))}function q(W){if(D.value===!0&&isKeyCode(W,13)===!0){stopAndPrevent(W),W.qKeyEvent=!0;const Y=new MouseEvent("click",W);Y.qKeyEvent=!0,M.value.dispatchEvent(Y)}n("keyup",W)}function oe(){const W=hUniqueSlot(r.default,[]);return D.value===!0&&W.unshift(h("div",{class:"q-focus-helper",tabindex:-1,ref:P})),W}return()=>{const W={ref:M,class:U.value,style:X.value,role:"listitem",onClick:K,onKeyup:q};return D.value===!0?(W.tabindex=e.tabindex||"0",Object.assign(W,_.value)):L.value===!0&&(W["aria-disabled"]="true"),h(b.value,W,oe())}}}),QItemSection=createComponent({name:"QItemSection",props:{avatar:Boolean,thumbnail:Boolean,side:Boolean,top:Boolean,noWrap:Boolean},setup(e,{slots:r}){const n=computed(()=>`q-item__section column q-item__section--${e.avatar===!0||e.side===!0||e.thumbnail===!0?"side":"main"}`+(e.top===!0?" q-item__section--top justify-start":" justify-center")+(e.avatar===!0?" q-item__section--avatar":"")+(e.thumbnail===!0?" q-item__section--thumbnail":"")+(e.noWrap===!0?" q-item__section--nowrap":""));return()=>h("div",{class:n.value},hSlot(r.default))}});const aggBucketSize=1e3,scrollToEdges=["start","center","end","start-force","center-force","end-force"],filterProto=Array.prototype.filter,setOverflowAnchor=window.getComputedStyle(document.body).overflowAnchor===void 0?noop:function(e,r){e!==null&&(cancelAnimationFrame(e._qOverflowAnimationFrame),e._qOverflowAnimationFrame=requestAnimationFrame(()=>{if(e===null)return;const n=e.children||[];filterProto.call(n,u=>u.dataset&&u.dataset.qVsAnchor!==void 0).forEach(u=>{delete u.dataset.qVsAnchor});const a=n[r];a&&a.dataset&&(a.dataset.qVsAnchor="")}))};function sumFn(e,r){return e+r}function getScrollDetails(e,r,n,a,u,f,_,o){const b=e===window?document.scrollingElement||document.documentElement:e,E=u===!0?"offsetWidth":"offsetHeight",M={scrollStart:0,scrollViewSize:-_-o,scrollMaxSize:0,offsetStart:-_,offsetEnd:-o};if(u===!0?(e===window?(M.scrollStart=window.pageXOffset||window.scrollX||document.body.scrollLeft||0,M.scrollViewSize+=document.documentElement.clientWidth):(M.scrollStart=b.scrollLeft,M.scrollViewSize+=b.clientWidth),M.scrollMaxSize=b.scrollWidth,f===!0&&(M.scrollStart=(rtlHasScrollBug===!0?M.scrollMaxSize-M.scrollViewSize:0)-M.scrollStart)):(e===window?(M.scrollStart=window.pageYOffset||window.scrollY||document.body.scrollTop||0,M.scrollViewSize+=document.documentElement.clientHeight):(M.scrollStart=b.scrollTop,M.scrollViewSize+=b.clientHeight),M.scrollMaxSize=b.scrollHeight),n!==null)for(let P=n.previousElementSibling;P!==null;P=P.previousElementSibling)P.classList.contains("q-virtual-scroll--skip")===!1&&(M.offsetStart+=P[E]);if(a!==null)for(let P=a.nextElementSibling;P!==null;P=P.nextElementSibling)P.classList.contains("q-virtual-scroll--skip")===!1&&(M.offsetEnd+=P[E]);if(r!==e){const P=b.getBoundingClientRect(),L=r.getBoundingClientRect();u===!0?(M.offsetStart+=L.left-P.left,M.offsetEnd-=L.width):(M.offsetStart+=L.top-P.top,M.offsetEnd-=L.height),e!==window&&(M.offsetStart+=M.scrollStart),M.offsetEnd+=M.scrollMaxSize-M.offsetStart}return M}function setScroll(e,r,n,a){r==="end"&&(r=(e===window?document.body:e)[n===!0?"scrollWidth":"scrollHeight"]),e===window?n===!0?(a===!0&&(r=(rtlHasScrollBug===!0?document.body.scrollWidth-document.documentElement.clientWidth:0)-r),window.scrollTo(r,window.pageYOffset||window.scrollY||document.body.scrollTop||0)):window.scrollTo(window.pageXOffset||window.scrollX||document.body.scrollLeft||0,r):n===!0?(a===!0&&(r=(rtlHasScrollBug===!0?e.scrollWidth-e.offsetWidth:0)-r),e.scrollLeft=r):e.scrollTop=r}function sumSize(e,r,n,a){if(n>=a)return 0;const u=r.length,f=Math.floor(n/aggBucketSize),_=Math.floor((a-1)/aggBucketSize)+1;let o=e.slice(f,_).reduce(sumFn,0);return n%aggBucketSize!==0&&(o-=r.slice(f*aggBucketSize,n).reduce(sumFn,0)),a%aggBucketSize!==0&&a!==u&&(o-=r.slice(a,_*aggBucketSize).reduce(sumFn,0)),o}const commonVirtScrollProps={virtualScrollSliceSize:{type:[Number,String],default:null},virtualScrollSliceRatioBefore:{type:[Number,String],default:1},virtualScrollSliceRatioAfter:{type:[Number,String],default:1},virtualScrollItemSize:{type:[Number,String],default:24},virtualScrollStickySizeStart:{type:[Number,String],default:0},virtualScrollStickySizeEnd:{type:[Number,String],default:0},tableColspan:[Number,String]},useVirtualScrollProps={virtualScrollHorizontal:Boolean,onVirtualScroll:Function,...commonVirtScrollProps};function useVirtualScroll({virtualScrollLength:e,getVirtualScrollTarget:r,getVirtualScrollEl:n,virtualScrollItemSizeComputed:a}){const u=getCurrentInstance(),{props:f,emit:_,proxy:o}=u,{$q:b}=o;let E,M,P,L=[],D;const U=ref(0),X=ref(0),K=ref({}),q=ref(null),oe=ref(null),W=ref(null),Y=ref({from:0,to:0}),J=computed(()=>f.tableColspan!==void 0?f.tableColspan:100);a===void 0&&(a=computed(()=>f.virtualScrollItemSize));const Ee=computed(()=>a.value+";"+f.virtualScrollHorizontal),xe=computed(()=>Ee.value+";"+f.virtualScrollSliceRatioBefore+";"+f.virtualScrollSliceRatioAfter);watch(xe,()=>{Zt()}),watch(Ee,se);function se(){We(M,!0)}function ce(_t){We(_t===void 0?M:_t)}function ee(_t,Bt){const dt=r();if(dt==null||dt.nodeType===8)return;const At=getScrollDetails(dt,n(),q.value,oe.value,f.virtualScrollHorizontal,b.lang.rtl,f.virtualScrollStickySizeStart,f.virtualScrollStickySizeEnd);P!==At.scrollViewSize&&Zt(At.scrollViewSize),Ie(dt,At,Math.min(e.value-1,Math.max(0,parseInt(_t,10)||0)),0,scrollToEdges.indexOf(Bt)>-1?Bt:M>-1&&_t>M?"end":"start")}function he(){const _t=r();if(_t==null||_t.nodeType===8)return;const Bt=getScrollDetails(_t,n(),q.value,oe.value,f.virtualScrollHorizontal,b.lang.rtl,f.virtualScrollStickySizeStart,f.virtualScrollStickySizeEnd),dt=e.value-1,At=Bt.scrollMaxSize-Bt.offsetStart-Bt.offsetEnd-X.value;if(E===Bt.scrollStart)return;if(Bt.scrollMaxSize<=0){Ie(_t,Bt,0,0);return}P!==Bt.scrollViewSize&&Zt(Bt.scrollViewSize),Pe(Y.value.from);const Tt=Math.floor(Bt.scrollMaxSize-Math.max(Bt.scrollViewSize,Bt.offsetEnd)-Math.min(D[dt],Bt.scrollViewSize/2));if(Tt>0&&Math.ceil(Bt.scrollStart)>=Tt){Ie(_t,Bt,dt,Bt.scrollMaxSize-Bt.offsetEnd-L.reduce(sumFn,0));return}let Dt=0,Ct=Bt.scrollStart-Bt.offsetStart,pi=Ct;if(Ct<=At&&Ct+Bt.scrollViewSize>=U.value)Ct-=U.value,Dt=Y.value.from,pi=Ct;else for(let yt=0;Ct>=L[yt]&&Dt<dt;yt++)Ct-=L[yt],Dt+=aggBucketSize;for(;Ct>0&&Dt<dt;)Ct-=D[Dt],Ct>-Bt.scrollViewSize?(Dt++,pi=Ct):pi=D[Dt]+Ct;Ie(_t,Bt,Dt,pi)}function Ie(_t,Bt,dt,At,Tt){const Dt=typeof Tt=="string"&&Tt.indexOf("-force")>-1,Ct=Dt===!0?Tt.replace("-force",""):Tt,pi=Ct!==void 0?Ct:"start";let yt=Math.max(0,dt-K.value[pi]),vi=yt+K.value.total;vi>e.value&&(vi=e.value,yt=Math.max(0,vi-K.value.total)),E=Bt.scrollStart;const $i=yt!==Y.value.from||vi!==Y.value.to;if($i===!1&&Ct===void 0){$t(dt);return}const{activeElement:yi}=document,mi=W.value;$i===!0&&mi!==null&&mi!==yi&&mi.contains(yi)===!0&&(mi.addEventListener("focusout",Qe),setTimeout(()=>{mi!==null&&mi.removeEventListener("focusout",Qe)})),setOverflowAnchor(mi,dt-yt);const It=Ct!==void 0?D.slice(yt,dt).reduce(sumFn,0):0;if($i===!0){const kt=vi>=Y.value.from&&yt<=Y.value.to?Y.value.to:vi;Y.value={from:yt,to:kt},U.value=sumSize(L,D,0,yt),X.value=sumSize(L,D,vi,e.value),requestAnimationFrame(()=>{Y.value.to!==vi&&E===Bt.scrollStart&&(Y.value={from:Y.value.from,to:vi},X.value=sumSize(L,D,vi,e.value))})}requestAnimationFrame(()=>{if(E!==Bt.scrollStart)return;$i===!0&&Pe(yt);const kt=D.slice(yt,dt).reduce(sumFn,0),Ri=kt+Bt.offsetStart+U.value,Pi=Ri+D[dt];let zi=Ri+At;if(Ct!==void 0){const ht=kt-It,Gt=Bt.scrollStart+ht;zi=Dt!==!0&&Gt<Ri&&Pi<Gt+Bt.scrollViewSize?Gt:Ct==="end"?Pi-Bt.scrollViewSize:Ri-(Ct==="start"?0:Math.round((Bt.scrollViewSize-D[dt])/2))}E=zi,setScroll(_t,zi,f.virtualScrollHorizontal,b.lang.rtl),$t(dt)})}function Pe(_t){const Bt=W.value;if(Bt){const dt=filterProto.call(Bt.children,yt=>yt.classList&&yt.classList.contains("q-virtual-scroll--skip")===!1),At=dt.length,Tt=f.virtualScrollHorizontal===!0?yt=>yt.getBoundingClientRect().width:yt=>yt.offsetHeight;let Dt=_t,Ct,pi;for(let yt=0;yt<At;){for(Ct=Tt(dt[yt]),yt++;yt<At&&dt[yt].classList.contains("q-virtual-scroll--with-prev")===!0;)Ct+=Tt(dt[yt]),yt++;pi=Ct-D[Dt],pi!==0&&(D[Dt]+=pi,L[Math.floor(Dt/aggBucketSize)]+=pi),Dt++}}}function Qe(){W.value!==null&&W.value!==void 0&&W.value.focus()}function We(_t,Bt){const dt=1*a.value;(Bt===!0||Array.isArray(D)===!1)&&(D=[]);const At=D.length;D.length=e.value;for(let Dt=e.value-1;Dt>=At;Dt--)D[Dt]=dt;const Tt=Math.floor((e.value-1)/aggBucketSize);L=[];for(let Dt=0;Dt<=Tt;Dt++){let Ct=0;const pi=Math.min((Dt+1)*aggBucketSize,e.value);for(let yt=Dt*aggBucketSize;yt<pi;yt++)Ct+=D[yt];L.push(Ct)}M=-1,E=void 0,U.value=sumSize(L,D,0,Y.value.from),X.value=sumSize(L,D,Y.value.to,e.value),_t>=0?(Pe(Y.value.from),nextTick(()=>{ee(_t)})):oi()}function Zt(_t){if(_t===void 0&&typeof window<"u"){const Ct=r();Ct!=null&&Ct.nodeType!==8&&(_t=getScrollDetails(Ct,n(),q.value,oe.value,f.virtualScrollHorizontal,b.lang.rtl,f.virtualScrollStickySizeStart,f.virtualScrollStickySizeEnd).scrollViewSize)}P=_t;const Bt=parseFloat(f.virtualScrollSliceRatioBefore)||0,dt=parseFloat(f.virtualScrollSliceRatioAfter)||0,At=1+Bt+dt,Tt=_t===void 0||_t<=0?1:Math.ceil(_t/a.value),Dt=Math.max(1,Tt,Math.ceil((f.virtualScrollSliceSize>0?f.virtualScrollSliceSize:10)/At));K.value={total:Math.ceil(Dt*At),start:Math.ceil(Dt*Bt),center:Math.ceil(Dt*(.5+Bt)),end:Math.ceil(Dt*(1+Bt)),view:Tt}}function ti(_t,Bt){const dt=f.virtualScrollHorizontal===!0?"width":"height",At={["--q-virtual-scroll-item-"+dt]:a.value+"px"};return[_t==="tbody"?h(_t,{class:"q-virtual-scroll__padding",key:"before",ref:q},[h("tr",[h("td",{style:{[dt]:`${U.value}px`,...At},colspan:J.value})])]):h(_t,{class:"q-virtual-scroll__padding",key:"before",ref:q,style:{[dt]:`${U.value}px`,...At}}),h(_t,{class:"q-virtual-scroll__content",key:"content",ref:W,tabindex:-1},Bt.flat()),_t==="tbody"?h(_t,{class:"q-virtual-scroll__padding",key:"after",ref:oe},[h("tr",[h("td",{style:{[dt]:`${X.value}px`,...At},colspan:J.value})])]):h(_t,{class:"q-virtual-scroll__padding",key:"after",ref:oe,style:{[dt]:`${X.value}px`,...At}})]}function $t(_t){M!==_t&&(f.onVirtualScroll!==void 0&&_("virtualScroll",{index:_t,from:Y.value.from,to:Y.value.to-1,direction:_t<M?"decrease":"increase",ref:o}),M=_t)}Zt();const oi=debounce$2(he,b.platform.is.ios===!0?120:35);onBeforeMount(()=>{Zt()});let je=!1;return onDeactivated(()=>{je=!0}),onActivated(()=>{if(je!==!0)return;const _t=r();E!==void 0&&_t!==void 0&&_t!==null&&_t.nodeType!==8?setScroll(_t,E,f.virtualScrollHorizontal,b.lang.rtl):ee(M)}),onBeforeUnmount(()=>{oi.cancel()}),Object.assign(o,{scrollTo:ee,reset:se,refresh:ce}),{virtualScrollSliceRange:Y,virtualScrollSliceSizeComputed:K,setVirtualScrollSize:Zt,onVirtualScrollEvt:oi,localResetVirtualScroll:We,padVirtualScroll:ti,scrollTo:ee,reset:se,refresh:ce}}const validateNewValueMode=e=>["add","add-unique","toggle"].includes(e),reEscapeList=".*+?^${}()|[]\\",fieldPropsList=Object.keys(useFieldProps);var QSelect=createComponent({name:"QSelect",inheritAttrs:!1,props:{...useVirtualScrollProps,...useFormProps,...useFieldProps,modelValue:{required:!0},multiple:Boolean,displayValue:[String,Number],displayValueHtml:Boolean,dropdownIcon:String,options:{type:Array,default:()=>[]},optionValue:[Function,String],optionLabel:[Function,String],optionDisable:[Function,String],hideSelected:Boolean,hideDropdownIcon:Boolean,fillInput:Boolean,maxValues:[Number,String],optionsDense:Boolean,optionsDark:{type:Boolean,default:null},optionsSelectedClass:String,optionsHtml:Boolean,optionsCover:Boolean,menuShrink:Boolean,menuAnchor:String,menuSelf:String,menuOffset:Array,popupContentClass:String,popupContentStyle:[String,Array,Object],useInput:Boolean,useChips:Boolean,newValueMode:{type:String,validator:validateNewValueMode},mapOptions:Boolean,emitValue:Boolean,inputDebounce:{type:[Number,String],default:500},inputClass:[Array,String,Object],inputStyle:[Array,String,Object],tabindex:{type:[String,Number],default:0},autocomplete:String,transitionShow:String,transitionHide:String,transitionDuration:[String,Number],behavior:{type:String,validator:e=>["default","menu","dialog"].includes(e),default:"default"},virtualScrollItemSize:{type:[Number,String],default:void 0},onNewValue:Function,onFilter:Function},emits:[...useFieldEmits,"add","remove","inputValue","newValue","keyup","keypress","keydown","filterAbort"],setup(e,{slots:r,emit:n}){const{proxy:a}=getCurrentInstance(),{$q:u}=a,f=ref(!1),_=ref(!1),o=ref(-1),b=ref(""),E=ref(!1),M=ref(!1);let P,L,D,U,X,K,q,oe,W;const Y=ref(null),J=ref(null),Ee=ref(null),xe=ref(null),se=ref(null),ce=useFormInputNameAttr(e),ee=useKeyComposition(qr),he=computed(()=>Array.isArray(e.options)?e.options.length:0),Ie=computed(()=>e.virtualScrollItemSize===void 0?e.optionsDense===!0?24:48:e.virtualScrollItemSize),{virtualScrollSliceRange:Pe,virtualScrollSliceSizeComputed:Qe,localResetVirtualScroll:We,padVirtualScroll:Zt,onVirtualScrollEvt:ti,scrollTo:$t,setVirtualScrollSize:oi}=useVirtualScroll({virtualScrollLength:he,getVirtualScrollTarget:Er,getVirtualScrollEl:gn,virtualScrollItemSizeComputed:Ie}),je=useFieldState(),_t=computed(()=>{const Re=e.mapOptions===!0&&e.multiple!==!0,vt=e.modelValue!==void 0&&(e.modelValue!==null||Re===!0)?e.multiple===!0&&Array.isArray(e.modelValue)?e.modelValue:[e.modelValue]:[];if(e.mapOptions===!0&&Array.isArray(e.options)===!0){const Pt=e.mapOptions===!0&&L!==void 0?L:[],fi=vt.map(dr=>Ii(dr,Pt));return e.modelValue===null&&Re===!0?fi.filter(dr=>dr!==null):fi}return vt}),Bt=computed(()=>{const Re={};return fieldPropsList.forEach(vt=>{const Pt=e[vt];Pt!==void 0&&(Re[vt]=Pt)}),Re}),dt=computed(()=>e.optionsDark===null?je.isDark.value:e.optionsDark),At=computed(()=>fieldValueIsFilled(_t.value)),Tt=computed(()=>{let Re="q-field__input q-placeholder col";return e.hideSelected===!0||_t.value.length===0?[Re,e.inputClass]:(Re+=" q-field__input--padding",e.inputClass===void 0?Re:[Re,e.inputClass])}),Dt=computed(()=>(e.virtualScrollHorizontal===!0?"q-virtual-scroll--horizontal":"")+(e.popupContentClass?" "+e.popupContentClass:"")),Ct=computed(()=>he.value===0),pi=computed(()=>_t.value.map(Re=>di.value(Re)).join(", ")),yt=computed(()=>e.displayValue!==void 0?e.displayValue:pi.value),vi=computed(()=>e.optionsHtml===!0?()=>!0:Re=>Re!=null&&Re.html===!0),$i=computed(()=>e.displayValueHtml===!0||e.displayValue===void 0&&(e.optionsHtml===!0||_t.value.some(vi.value))),yi=computed(()=>je.focused.value===!0?e.tabindex:-1),mi=computed(()=>{const Re={tabindex:e.tabindex,role:"combobox","aria-label":e.label,"aria-readonly":e.readonly===!0?"true":"false","aria-autocomplete":e.useInput===!0?"list":"none","aria-expanded":f.value===!0?"true":"false","aria-controls":`${je.targetUid.value}_lb`};return o.value>=0&&(Re["aria-activedescendant"]=`${je.targetUid.value}_${o.value}`),Re}),It=computed(()=>({id:`${je.targetUid.value}_lb`,role:"listbox","aria-multiselectable":e.multiple===!0?"true":"false"})),kt=computed(()=>_t.value.map((Re,vt)=>({index:vt,opt:Re,html:vi.value(Re),selected:!0,removeAtIndex:Yt,toggleOption:Rt,tabindex:yi.value}))),Ri=computed(()=>{if(he.value===0)return[];const{from:Re,to:vt}=Pe.value;return e.options.slice(Re,vt).map((Pt,fi)=>{const dr=si.value(Pt)===!0,sr=Re+fi,it={clickable:!0,active:!1,activeClass:ht.value,manualFocus:!0,focused:!1,disable:dr,tabindex:-1,dense:e.optionsDense,dark:dt.value,role:"option",id:`${je.targetUid.value}_${sr}`,onClick:()=>{Rt(Pt)}};return dr!==!0&&(Xi(Pt)===!0&&(it.active=!0),o.value===sr&&(it.focused=!0),it["aria-selected"]=it.active===!0?"true":"false",u.platform.is.desktop===!0&&(it.onMousemove=()=>{f.value===!0&&Kt(sr)})),{index:sr,opt:Pt,html:vi.value(Pt),label:di.value(Pt),selected:it.active,focused:it.focused,toggleOption:Rt,setOptionIndex:Kt,itemProps:it}})}),Pi=computed(()=>e.dropdownIcon!==void 0?e.dropdownIcon:u.iconSet.arrow.dropdown),zi=computed(()=>e.optionsCover===!1&&e.outlined!==!0&&e.standout!==!0&&e.borderless!==!0&&e.rounded!==!0),ht=computed(()=>e.optionsSelectedClass!==void 0?e.optionsSelectedClass:e.color!==void 0?`text-${e.color}`:""),Gt=computed(()=>Fi(e.optionValue,"value")),di=computed(()=>Fi(e.optionLabel,"label")),si=computed(()=>Fi(e.optionDisable,"disable")),Ae=computed(()=>_t.value.map(Re=>Gt.value(Re))),xt=computed(()=>{const Re={onInput:qr,onChange:ee,onKeydown:mn,onKeyup:Ci,onKeypress:Ir,onFocus:rr,onClick(vt){D===!0&&stop(vt)}};return Re.onCompositionstart=Re.onCompositionupdate=Re.onCompositionend=ee,Re});watch(_t,Re=>{L=Re,e.useInput===!0&&e.fillInput===!0&&e.multiple!==!0&&je.innerLoading.value!==!0&&(_.value!==!0&&f.value!==!0||At.value!==!0)&&(U!==!0&&Ut(),(_.value===!0||f.value===!0)&&qe(""))},{immediate:!0}),watch(()=>e.fillInput,Ut),watch(f,ft),watch(he,bi);function Xt(Re){return e.emitValue===!0?Gt.value(Re):Re}function Nt(Re){if(Re>-1&&Re<_t.value.length)if(e.multiple===!0){const vt=e.modelValue.slice();n("remove",{index:Re,value:vt.splice(Re,1)[0]}),n("update:modelValue",vt)}else n("update:modelValue",null)}function Yt(Re){Nt(Re),je.focus()}function ii(Re,vt){const Pt=Xt(Re);if(e.multiple!==!0){e.fillInput===!0&&ye(di.value(Re),!0,!0),n("update:modelValue",Pt);return}if(_t.value.length===0){n("add",{index:0,value:Pt}),n("update:modelValue",e.multiple===!0?[Pt]:Pt);return}if(vt===!0&&Xi(Re)===!0||e.maxValues!==void 0&&e.modelValue.length>=e.maxValues)return;const fi=e.modelValue.slice();n("add",{index:fi.length,value:Pt}),fi.push(Pt),n("update:modelValue",fi)}function Rt(Re,vt){if(je.editable.value!==!0||Re===void 0||si.value(Re)===!0)return;const Pt=Gt.value(Re);if(e.multiple!==!0){vt!==!0&&(ye(e.fillInput===!0?di.value(Re):"",!0,!0),ut()),J.value!==null&&J.value.focus(),(_t.value.length===0||isDeepEqual(Gt.value(_t.value[0]),Pt)!==!0)&&n("update:modelValue",e.emitValue===!0?Pt:Re);return}if((D!==!0||E.value===!0)&&je.focus(),rr(),_t.value.length===0){const sr=e.emitValue===!0?Pt:Re;n("add",{index:0,value:sr}),n("update:modelValue",e.multiple===!0?[sr]:sr);return}const fi=e.modelValue.slice(),dr=Ae.value.findIndex(sr=>isDeepEqual(sr,Pt));if(dr>-1)n("remove",{index:dr,value:fi.splice(dr,1)[0]});else{if(e.maxValues!==void 0&&fi.length>=e.maxValues)return;const sr=e.emitValue===!0?Pt:Re;n("add",{index:fi.length,value:sr}),fi.push(sr)}n("update:modelValue",fi)}function Kt(Re){if(u.platform.is.desktop!==!0)return;const vt=Re>-1&&Re<he.value?Re:-1;o.value!==vt&&(o.value=vt)}function Li(Re=1,vt){if(f.value===!0){let Pt=o.value;do Pt=normalizeToInterval(Pt+Re,-1,he.value-1);while(Pt!==-1&&Pt!==o.value&&si.value(e.options[Pt])===!0);o.value!==Pt&&(Kt(Pt),$t(Pt),vt!==!0&&e.useInput===!0&&e.fillInput===!0&&kr(Pt>=0?di.value(e.options[Pt]):K))}}function Ii(Re,vt){const Pt=fi=>isDeepEqual(Gt.value(fi),Re);return e.options.find(Pt)||vt.find(Pt)||Re}function Fi(Re,vt){const Pt=Re!==void 0?Re:vt;return typeof Pt=="function"?Pt:fi=>fi!==null&&typeof fi=="object"&&Pt in fi?fi[Pt]:fi}function Xi(Re){const vt=Gt.value(Re);return Ae.value.find(Pt=>isDeepEqual(Pt,vt))!==void 0}function rr(Re){e.useInput===!0&&J.value!==null&&(Re===void 0||J.value===Re.target&&Re.target.value===pi.value)&&J.value.select()}function Ki(Re){isKeyCode(Re,27)===!0&&f.value===!0&&(stop(Re),ut(),Ut()),n("keyup",Re)}function Ci(Re){const{value:vt}=Re.target;if(Re.keyCode!==void 0){Ki(Re);return}if(Re.target.value="",clearTimeout(P),Ut(),typeof vt=="string"&&vt.length>0){const Pt=vt.toLocaleLowerCase(),fi=sr=>{const it=e.options.find(Or=>sr.value(Or).toLocaleLowerCase()===Pt);return it===void 0?!1:(_t.value.indexOf(it)===-1?Rt(it):ut(),!0)},dr=sr=>{fi(Gt)!==!0&&(fi(di)===!0||sr===!0||qe(vt,!0,()=>dr(!0)))};dr()}else je.clearValue(Re)}function Ir(Re){n("keypress",Re)}function mn(Re){if(n("keydown",Re),shouldIgnoreKey(Re)===!0)return;const vt=b.value.length>0&&(e.newValueMode!==void 0||e.onNewValue!==void 0),Pt=Re.shiftKey!==!0&&e.multiple!==!0&&(o.value>-1||vt===!0);if(Re.keyCode===27){prevent(Re);return}if(Re.keyCode===9&&Pt===!1){De();return}if(Re.target===void 0||Re.target.id!==je.targetUid.value)return;if(Re.keyCode===40&&je.innerLoading.value!==!0&&f.value===!1){stopAndPrevent(Re),Ze();return}if(Re.keyCode===8&&e.hideSelected!==!0&&b.value.length===0){e.multiple===!0&&Array.isArray(e.modelValue)===!0?Nt(e.modelValue.length-1):e.multiple!==!0&&e.modelValue!==null&&n("update:modelValue",null);return}(Re.keyCode===35||Re.keyCode===36)&&(typeof b.value!="string"||b.value.length===0)&&(stopAndPrevent(Re),o.value=-1,Li(Re.keyCode===36?1:-1,e.multiple)),(Re.keyCode===33||Re.keyCode===34)&&Qe.value!==void 0&&(stopAndPrevent(Re),o.value=Math.max(-1,Math.min(he.value,o.value+(Re.keyCode===33?-1:1)*Qe.value.view)),Li(Re.keyCode===33?1:-1,e.multiple)),(Re.keyCode===38||Re.keyCode===40)&&(stopAndPrevent(Re),Li(Re.keyCode===38?-1:1,e.multiple));const fi=he.value;if((oe===void 0||W<Date.now())&&(oe=""),fi>0&&e.useInput!==!0&&Re.key!==void 0&&Re.key.length===1&&Re.altKey===!1&&Re.ctrlKey===!1&&Re.metaKey===!1&&(Re.keyCode!==32||oe.length>0)){f.value!==!0&&Ze(Re);const dr=Re.key.toLocaleLowerCase(),sr=oe.length===1&&oe[0]===dr;W=Date.now()+1500,sr===!1&&(stopAndPrevent(Re),oe+=dr);const it=new RegExp("^"+oe.split("").map(Fr=>reEscapeList.indexOf(Fr)>-1?"\\"+Fr:Fr).join(".*"),"i");let Or=o.value;if(sr===!0||Or<0||it.test(di.value(e.options[Or]))!==!0)do Or=normalizeToInterval(Or+1,-1,fi-1);while(Or!==o.value&&(si.value(e.options[Or])===!0||it.test(di.value(e.options[Or]))!==!0));o.value!==Or&&nextTick(()=>{Kt(Or),$t(Or),Or>=0&&e.useInput===!0&&e.fillInput===!0&&kr(di.value(e.options[Or]))});return}if(!(Re.keyCode!==13&&(Re.keyCode!==32||e.useInput===!0||oe!=="")&&(Re.keyCode!==9||Pt===!1))){if(Re.keyCode!==9&&stopAndPrevent(Re),o.value>-1&&o.value<fi){Rt(e.options[o.value]);return}if(vt===!0){const dr=(sr,it)=>{if(it){if(validateNewValueMode(it)!==!0)return}else it=e.newValueMode;if(sr==null)return;ye("",e.multiple!==!0,!0),(it==="toggle"?Rt:ii)(sr,it==="add-unique"),e.multiple!==!0&&(J.value!==null&&J.value.focus(),ut())};if(e.onNewValue!==void 0?n("newValue",b.value,dr):dr(b.value),e.multiple!==!0)return}f.value===!0?De():je.innerLoading.value!==!0&&Ze()}}function gn(){return D===!0?se.value:Ee.value!==null&&Ee.value.contentEl!==null?Ee.value.contentEl:void 0}function Er(){return gn()}function un(){return e.hideSelected===!0?[]:r["selected-item"]!==void 0?kt.value.map(Re=>r["selected-item"](Re)).slice():r.selected!==void 0?[].concat(r.selected()):e.useChips===!0?kt.value.map((Re,vt)=>h(QChip,{key:"option-"+vt,removable:je.editable.value===!0&&si.value(Re.opt)!==!0,dense:!0,textColor:e.color,tabindex:yi.value,onRemove(){Re.removeAtIndex(vt)}},()=>h("span",{class:"ellipsis",[Re.html===!0?"innerHTML":"textContent"]:di.value(Re.opt)}))):[h("span",{[$i.value===!0?"innerHTML":"textContent"]:yt.value})]}function ar(){if(Ct.value===!0)return r["no-option"]!==void 0?r["no-option"]({inputValue:b.value}):void 0;const Re=r.option!==void 0?r.option:Pt=>h(QItem,{key:Pt.index,...Pt.itemProps},()=>h(QItemSection,()=>h(QItemLabel,()=>h("span",{[Pt.html===!0?"innerHTML":"textContent"]:Pt.label}))));let vt=Zt("div",Ri.value.map(Re));return r["before-options"]!==void 0&&(vt=r["before-options"]().concat(vt)),hMergeSlot(r["after-options"],vt)}function Jr(Re,vt){const Pt=vt===!0?{...mi.value,...je.splitAttrs.attributes.value}:void 0,fi={ref:vt===!0?J:void 0,key:"i_t",class:Tt.value,style:e.inputStyle,value:b.value!==void 0?b.value:"",type:"search",...Pt,id:vt===!0?je.targetUid.value:void 0,maxlength:e.maxlength,autocomplete:e.autocomplete,"data-autofocus":Re===!0||e.autofocus===!0||void 0,disabled:e.disable===!0,readonly:e.readonly===!0,...xt.value};return Re!==!0&&D===!0&&(Array.isArray(fi.class)===!0?fi.class=[...fi.class,"no-pointer-events"]:fi.class+=" no-pointer-events"),h("input",fi)}function qr(Re){clearTimeout(P),!(Re&&Re.target&&Re.target.qComposing===!0)&&(kr(Re.target.value||""),U=!0,K=b.value,je.focused.value!==!0&&(D!==!0||E.value===!0)&&je.focus(),e.onFilter!==void 0&&(P=setTimeout(()=>{qe(b.value)},e.inputDebounce)))}function kr(Re){b.value!==Re&&(b.value=Re,n("inputValue",Re))}function ye(Re,vt,Pt){U=Pt!==!0,e.useInput===!0&&(kr(Re),(vt===!0||Pt!==!0)&&(K=Re),vt!==!0&&qe(Re))}function qe(Re,vt,Pt){if(e.onFilter===void 0||vt!==!0&&je.focused.value!==!0)return;je.innerLoading.value===!0?n("filterAbort"):(je.innerLoading.value=!0,M.value=!0),Re!==""&&e.multiple!==!0&&_t.value.length>0&&U!==!0&&Re===di.value(_t.value[0])&&(Re="");const fi=setTimeout(()=>{f.value===!0&&(f.value=!1)},10);clearTimeout(X),X=fi,n("filter",Re,(dr,sr)=>{(vt===!0||je.focused.value===!0)&&X===fi&&(clearTimeout(X),typeof dr=="function"&&dr(),M.value=!1,nextTick(()=>{je.innerLoading.value=!1,je.editable.value===!0&&(vt===!0?f.value===!0&&ut():f.value===!0?ft(!0):f.value=!0),typeof sr=="function"&&nextTick(()=>{sr(a)}),typeof Pt=="function"&&nextTick(()=>{Pt(a)})}))},()=>{je.focused.value===!0&&X===fi&&(clearTimeout(X),je.innerLoading.value=!1,M.value=!1),f.value===!0&&(f.value=!1)})}function at(){return h(QMenu,{ref:Ee,class:Dt.value,style:e.popupContentStyle,modelValue:f.value,fit:e.menuShrink!==!0,cover:e.optionsCover===!0&&Ct.value!==!0&&e.useInput!==!0,anchor:e.menuAnchor,self:e.menuSelf,offset:e.menuOffset,dark:dt.value,noParentEvent:!0,noRefocus:!0,noFocus:!0,square:zi.value,transitionShow:e.transitionShow,transitionHide:e.transitionHide,transitionDuration:e.transitionDuration,separateClosePopup:!0,...It.value,onScrollPassive:ti,onBeforeShow:gi,onBeforeHide:ne,onShow:H},ar)}function ne(Re){Di(Re),De()}function H(){oi()}function te(Re){stop(Re),J.value!==null&&J.value.focus(),E.value=!0,window.scrollTo(window.pageXOffset||window.scrollX||document.body.scrollLeft||0,0)}function pe(Re){stop(Re),nextTick(()=>{E.value=!1})}function we(){const Re=[h(QField,{class:`col-auto ${je.fieldClass.value}`,...Bt.value,for:je.targetUid.value,dark:dt.value,square:!0,loading:M.value,itemAligned:!1,filled:!0,stackLabel:b.value.length>0,...je.splitAttrs.listeners.value,onFocus:te,onBlur:pe},{...r,rawControl:()=>je.getControl(!0),before:void 0,after:void 0})];return f.value===!0&&Re.push(h("div",{ref:se,class:Dt.value+" scroll",style:e.popupContentStyle,...It.value,onClick:prevent,onScrollPassive:ti},ar())),h(QDialog,{ref:xe,modelValue:_.value,position:e.useInput===!0?"top":void 0,transitionShow:q,transitionHide:e.transitionHide,transitionDuration:e.transitionDuration,onBeforeShow:gi,onBeforeHide:ke,onHide:$e,onShow:Ge},()=>h("div",{class:"q-select__dialog"+(dt.value===!0?" q-select__dialog--dark q-dark":"")+(E.value===!0?" q-select__dialog--focused":"")},Re))}function ke(Re){Di(Re),xe.value!==null&&xe.value.__updateRefocusTarget(je.rootRef.value.querySelector(".q-field__native > [tabindex]:last-child")),je.focused.value=!1}function $e(Re){ut(),je.focused.value===!1&&n("blur",Re),Ut()}function Ge(){const Re=document.activeElement;(Re===null||Re.id!==je.targetUid.value)&&J.value!==null&&J.value!==Re&&J.value.focus(),oi()}function De(){_.value!==!0&&(o.value=-1,f.value===!0&&(f.value=!1),je.focused.value===!1&&(clearTimeout(X),X=void 0,je.innerLoading.value===!0&&(n("filterAbort"),je.innerLoading.value=!1,M.value=!1)))}function Ze(Re){je.editable.value===!0&&(D===!0?(je.onControlFocusin(Re),_.value=!0,nextTick(()=>{je.focus()})):je.focus(),e.onFilter!==void 0?qe(b.value):(Ct.value!==!0||r["no-option"]!==void 0)&&(f.value=!0))}function ut(){_.value=!1,De()}function Ut(){e.useInput===!0&&ye(e.multiple!==!0&&e.fillInput===!0&&_t.value.length>0&&di.value(_t.value[0])||"",!0,!0)}function ft(Re){let vt=-1;if(Re===!0){if(_t.value.length>0){const Pt=Gt.value(_t.value[0]);vt=e.options.findIndex(fi=>isDeepEqual(Gt.value(fi),Pt))}We(vt)}Kt(vt)}function bi(Re,vt){f.value===!0&&je.innerLoading.value===!1&&(We(-1,!0),nextTick(()=>{f.value===!0&&je.innerLoading.value===!1&&(Re>vt?We():ft(!0))}))}function wi(){_.value===!1&&Ee.value!==null&&Ee.value.updatePosition()}function gi(Re){Re!==void 0&&stop(Re),n("popupShow",Re),je.hasPopupOpen=!0,je.onControlFocusin(Re)}function Di(Re){Re!==void 0&&stop(Re),n("popupHide",Re),je.hasPopupOpen=!1,je.onControlFocusout(Re)}function Hi(){D=u.platform.is.mobile!==!0&&e.behavior!=="dialog"?!1:e.behavior!=="menu"&&(e.useInput===!0?r["no-option"]!==void 0||e.onFilter!==void 0||Ct.value===!1:!0),q=u.platform.is.ios===!0&&D===!0&&e.useInput===!0?"fade":e.transitionShow}return onBeforeUpdate(Hi),onUpdated(wi),Hi(),onBeforeUnmount(()=>{clearTimeout(P)}),Object.assign(a,{showPopup:Ze,hidePopup:ut,removeAtIndex:Nt,add:ii,toggleOption:Rt,getOptionIndex:()=>o.value,setOptionIndex:Kt,moveOptionSelection:Li,filter:qe,updateMenuPosition:wi,updateInputValue:ye,isOptionSelected:Xi,getEmittingOptionValue:Xt,isOptionDisabled:(...Re)=>si.value.apply(null,Re)===!0,getOptionValue:(...Re)=>Gt.value.apply(null,Re),getOptionLabel:(...Re)=>di.value.apply(null,Re)}),Object.assign(je,{innerValue:_t,fieldClass:computed(()=>`q-select q-field--auto-height q-select--with${e.useInput!==!0?"out":""}-input q-select--with${e.useChips!==!0?"out":""}-chips q-select--${e.multiple===!0?"multiple":"single"}`),inputRef:Y,targetRef:J,hasValue:At,showPopup:Ze,floatingLabel:computed(()=>e.hideSelected!==!0&&At.value===!0||typeof b.value=="number"||b.value.length>0||fieldValueIsFilled(e.displayValue)),getControlChild:()=>{if(je.editable.value!==!1&&(_.value===!0||Ct.value!==!0||r["no-option"]!==void 0))return D===!0?we():at();je.hasPopupOpen===!0&&(je.hasPopupOpen=!1)},controlEvents:{onFocusin(Re){je.onControlFocusin(Re)},onFocusout(Re){je.onControlFocusout(Re,()=>{Ut(),De()})},onClick(Re){if(prevent(Re),D!==!0&&f.value===!0){De(),J.value!==null&&J.value.focus();return}Ze(Re)}},getControl:Re=>{const vt=un(),Pt=Re===!0||_.value!==!0||D!==!0;if(e.useInput===!0)vt.push(Jr(Re,Pt));else if(je.editable.value===!0){const dr=Pt===!0?mi.value:void 0;vt.push(h("input",{ref:Pt===!0?J:void 0,key:"d_t",class:"q-select__focus-target",id:Pt===!0?je.targetUid.value:void 0,value:yt.value,readonly:!0,"data-autofocus":Re===!0||e.autofocus===!0||void 0,...dr,onKeydown:mn,onKeyup:Ki,onKeypress:Ir})),Pt===!0&&typeof e.autocomplete=="string"&&e.autocomplete.length>0&&vt.push(h("input",{class:"q-select__autocomplete-input",autocomplete:e.autocomplete,tabindex:-1,onKeyup:Ci}))}if(ce.value!==void 0&&e.disable!==!0&&Ae.value.length>0){const dr=Ae.value.map(sr=>h("option",{value:sr,selected:!0}));vt.push(h("select",{class:"hidden",name:ce.value,multiple:e.multiple},dr))}const fi=e.useInput===!0||Pt!==!0?void 0:je.splitAttrs.attributes.value;return h("div",{class:"q-field__native row items-center",...fi},vt)},getInnerAppend:()=>e.loading!==!0&&M.value!==!0&&e.hideDropdownIcon!==!0?[h(QIcon,{class:"q-select__dropdown-icon"+(f.value===!0?" rotate-180":""),name:Pi.value})]:null}),useField(je)}});function getDepth(e){if(e===!1)return 0;if(e===!0||e===void 0)return 1;const r=parseInt(e,10);return isNaN(r)?0:r}var ClosePopup=createDirective({name:"close-popup",beforeMount(e,{value:r}){const n={depth:getDepth(r),handler(a){n.depth!==0&&setTimeout(()=>{const u=getPortalProxy(e);u!==void 0&&closePortals(u,a,n.depth)})},handlerKey(a){isKeyCode(a,13)===!0&&n.handler(a)}};e.__qclosepopup=n,e.addEventListener("click",n.handler),e.addEventListener("keyup",n.handlerKey)},updated(e,{value:r,oldValue:n}){r!==n&&(e.__qclosepopup.depth=getDepth(r))},beforeUnmount(e){const r=e.__qclosepopup;e.removeEventListener("click",r.handler),e.removeEventListener("keyup",r.handlerKey),delete e.__qclosepopup}});function useQuasar(){return inject(quasarKey)}const gdalWorker=new Worker("gdalWorker.js");let ZrangeSeaLevel=32767;const _sfc_main$2={name:"SideNav",setup(){const e=useQuasar();return{alert:ref(!1),isAlphaBrush:ref(!1),blurRadius:ref(0),access_token:ref(""),isDisabled:ref(!1),isDownload:ref(!0),isLandscape:ref(!0),isExportOptions:ref(!0),isBlurRadius:ref(!0),isSendToUnreal:ref(!0),unrealLandscape:ref({label:505,value:505}),landscapeSize:[{label:"8129x8129",value:8129},{label:"4033x4033",value:4033},{label:"2017x2017",value:2017},{label:"1009x1009",value:1009},{label:"512x512-Downloaded-Size",value:512},{label:"505x505",value:505}],url:ref("thirtytwo-9-82-180.png"),tile_info:ref(""),save_fileName:ref(""),dirHandle:ref(""),preview_image_info:ref(""),rgb_image:ref(""),img_min:ref(""),img_max:ref(""),map:null,data:null,bbinfoalert:ref(!1),exportType:ref({label:"Unreal Heightmap",value:"Unreal Heightmap"}),landscapeName:ref(""),alphaBrushName:ref(""),alphaBrushHeight:ref(505),alphaBrushWidth:ref(505),unrealMapPath:ref(""),qt:e,exportOptionsModel:ref(["zrange","combine_features"]),alertMsg:ref(""),exportOptions:[{label:"Zrange-sea level=0",value:"zrange"},{label:"Flip X",value:"flipx"},{label:"Flip y",value:"flipy"},{label:"Download Satellite",value:"satellite"},{label:"Download Geojson Features",value:"features"},{label:"Combine Unique Features",value:"combine_features"}],exportTyprOptions:[{label:"Unreal Heightmap",value:"Unreal Heightmap"},{label:"Unreal Terrain Magic Plugin",value:"Unreal Terrain Magic Plugin"},{label:"Unreal Terrain Magic Plugin -- Manual",value:"Unreal Terrain Magic Plugin -- Manual"},{label:"Unreal Stamp Brush Plugin",value:"Unreal Stamp Brush Plugin"},{label:"Unreal Landmass Effect Brush Plugin",value:"Unreal Landmass Effect Brush Plugin",cannotSelect:!1},{label:"None",value:"none"},{label:"Geojson Only",value:"geojson_only"}]}},async mounted(){emitter.on("updatePreviewImage",e=>{this.data=e,this.updatePreviewImage()})},methods:{showNotify(e,r,n,a,u){this.qt.notify({message:e,color:r,position:n,icon:a,textColor:u})},copyTileInfoString(){this.tile_info?navigator.permissions.query({name:"clipboard-write"}).then(e=>{if(e.state==="granted"||e.state==="prompt"){let r=this.tile_info.x+","+this.tile_info.y+","+this.tile_info.z;navigator.clipboard.writeText(r).then(()=>{this.showNotify("Tile info string copied   "+r,"info","top","announcement","white")},()=>{})}}):(this.alertMsg="Please select a location on the map first.",this.alert=!0)},copyExtents(){this.tile_info?navigator.permissions.query({name:"clipboard-write"}).then(e=>{if(e.state==="granted"||e.state==="prompt"){let r=this.tile_info.bboxW+","+this.tile_info.bboxS+","+this.tile_info.bboxE+","+this.tile_info.bboxN;navigator.clipboard.writeText(r).then(()=>{this.showNotify("Bounding box coordinates copied   "+r,"info","top","announcement","white")},()=>{})}}):(this.alertMsg="Please select a location on the map first.",this.alert=!0)},landscapeSizeChange(){this.tile_info.resolution=this.unrealLandscape.value,this.adjustedZscale()},adjustedZscale(){let e=this.getUnrealZScale(this.preview_image_info.maxElevation);return this.exportOptionsModel.includes("zrange")?(this.tile_info.startZRange=ZrangeSeaLevel,this.tile_info.zscale=e.toFixed(3)):(this.tile_info.startZRange=0,this.tile_info.zscale=e.toFixed(3)),this.tile_info.zscale},exportOptionsModelChange(e){this.exportOptionsModel=e,this.tile_info.resolution=this.unrealLandscape.value,this.adjustedZscale()},exportType_Change(e){this.exportType.label==="Unreal Heightmap"||this.exportType.label==="None"||this.exportType.label==="Unreal Terrain Magic Plugin -- Manual"?(this.isDownload=!0,this.isSendToUnreal=!0,this.isAlphaBrush=!1,this.isLandscape=!0,this.isExportOptions=!0,this.isBlurRadius=!0):this.exportType.label==="Unreal Stamp Brush Plugin"||this.exportType.label==="Unreal Landmass Effect Brush Plugin"?(this.isDownload=!1,this.isSendToUnreal=!0,this.isAlphaBrush=!0,this.isLandscape=!1,this.isExportOptions=!1,this.isBlurRadius=!0):this.exportType.label==="Geojson Only"?(this.isDownload=!0,this.isSendToUnreal=!1,this.isAlphaBrush=!1,this.isLandscape=!1,this.isExportOptions=!1,this.isBlurRadius=!1):this.exportType.label==="Unreal Terrain Magic Plugin"&&(this.isDownload=!1,this.isSendToUnreal=!0,this.isAlphaBrush=!1,this.isLandscape=!1,this.isExportOptions=!1,this.isBlurRadius=!1)},showBBInfo(){this.tile_info?this.bbinfoalert=!0:(this.bbinfoalert=!1,this.alertMsg="Please select a location on the map first.",this.alert=!0)},updateStats(){this.preview_image_info.maxElevation!==""?(this.tile_info.MaxElevation=this.preview_image_info.maxElevation,this.tile_info.MinElevation=this.preview_image_info.minElevation,this.tile_info.minmax=this.tile_info.MinElevation.toFixed(3)+" / "+this.tile_info.MaxElevation.toFixed(3),this.tile_info.elevation_range=(this.tile_info.MaxElevation-this.tile_info.MinElevation).toFixed(3),this.tile_info.zscale=this.adjustedZscale()):this.tile_info.minmax=""},getUnrealZScale(e){return e*100*.001953125},async updatePreviewImage(){this.preview_image_info=await this.data.preview_image_info,this.tile_info=this.data.tile_info,this.map=this.data.map;let e=await this.preview_image_info.image.toBlob();const r=URL.createObjectURL(e);this.url=r,this.updateStats(this.tile_info)},async saveImage(e,r,n){let a=await idbKeyval.get("dirHandle"),u=new Blob([e],{type:"image/"+n});await fileUtils.writeFileToDisk(a,r,u)},async createWorker(e,r,n,a,u){let f=this;return new Promise(function(_){let o=new File([e],"temp."+a,{type:"image/"+a,lastModified:Date.now()}),b=new DataTransfer;b.items.add(o);let E=b.files,M={};M.files=E,M.translateOptions=n,gdalWorker.postMessage(M),gdalWorker.onmessage=async function(P){u==="createHeightmap"&&await f.saveImage(P.data,r,a),_(!0)}})},async sendToUnreal(){let e="http://localhost:30010/",r="remote/object/call",n={},a,u,f,_="Mapbox_BP",o,b,E,M;if(this.tile_info)if(n={objectPath:"/Script/UnrealEd.Default__EditorActorSubsystem",functionName:"GetAllLevelActors"},a=await mapUtils.unrealRemoteControl(n,e+r),a.error)a.error.message==="Failed to fetch"?this.alertMsg="Cannot connect to Unreal server. Please make sure your project is open and Mapbox_BP is in the scene.  Also make sure you launched the Map using the Select Map button as this starts the Unreal Web Server":this.alertMsg=a.error.message,this.alert=!0;else{let P=await a.response.json();for(let L of P.ReturnValue)if(u=L.includes(_),u===!0){f=L;break}else f=null;if(f){this.exportType.label!=="Unreal Terrain Magic Plugin"?await this.createSixteenHeightMap():this.tile_info.resolution="505",this.exportType.label==="Unreal Stamp Brush Plugin"&&(o="/Game/Brushes/CustomBrushes/",b="/Game/Brushes/PEAKS/Peak_10_brush.Peak_10_brush",E="Textures/",M="HeightMap"),this.exportType.label==="Unreal Landmass Effect Brush Plugin"&&(o="/Game/Editor/Landscape/LandmassEffectBrush/CustomBrushes/",b="/Game/Editor/Landscape/LandmassEffectBrush/Effects/Variants/Map/HeightMapEffect.HeightMapEffect",E="Textures/",M="Heightmap (Greyscale / White is High)"),this.unrealMapPath=await idbKeyval.get("mappath"),this.tile_info.landscapeName=this.landscapeName;let L=this.tile_info.x+","+this.tile_info.y+","+this.tile_info.z;n={objectPath:f,functionName:"GenerateMapboxLandscape",parameters:{LandscapeName:this.tile_info.landscapeName,LandscapeSize:this.tile_info.resolution.toString(),TileHeightmapFileName:this.tile_info.sixteenFileName,TileGeojsonFileName:this.tile_info.geoJsonFileName,TileInfoFileName:this.tile_info.tileInfoFileName,MapMiddleLngX:this.tile_info.center.lng,MapMiddleLatY:this.tile_info.center.lat,MapBtmRLng:this.tile_info.bottomRight.lng,MapBtmLLng:this.tile_info.bottomLeft.lng,MapTopLLat:this.tile_info.topLeft.lat,MapBtmLLat:this.tile_info.bottomLeft.lat,RunFunction:this.exportType.label,SlippyMapTileString:L.trim(),HeightMapTexturesPath:"/Game/ImportedHeightMaps/",AlphaBrushName:this.tile_info.alphaBrushFileName,AlphaBrushDestinationPath:o,AlphaBrushTemplatePath:b,AlphaBrushTexturesPath:E,HeightmapProperty:M}},a=await mapUtils.unrealRemoteControl(n,e+r),a.error?(console.log(a.error),this.alertMsg=a.error.message,this.alert=!0):console.log(await a.response.json())}else this.alertMsg="Could not find Mapbox_BP in scene",this.alert=!0}else this.alertMsg="Please select a map location",this.alert=!0;this.qt.loading.hide()},async unrealTileFeatures(e){let r=mapUtils.getFeaturesFromBB(this.map,this.tile_info,e),n=JSON.stringify(r),a=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(this.dirHandle,this.tile_info.geoJsonFileName,n),await fileUtils.writeFileToDisk(this.dirHandle,this.tile_info.tileInfoFileName,a)},async createSixteenHeightMap(){if(this.tile_info){let e,r;this.tile_info.resolution=this.unrealLandscape.value,mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.tile_info.geoJsonFileName="geojson-"+this.tile_info.mapboxTileName+".json",this.tile_info.tileInfoFileName="tile-info-"+this.tile_info.mapboxTileName+".json",this.tile_info.sixteenFileName="sixteen-"+this.tile_info.mapboxTileName+"-LandscapeSize-"+this.tile_info.resolution+".png";let n=await idbKeyval.get("mapbox_satellite_endpoint");if(this.tile_info.mapbox_satellite_image_url=n+`/${this.tile_info.z}/${this.tile_info.x}/${this.tile_info.y}@2x?access_token=`+this.access_token,this.tile_info.satelliteFileName="satellite-"+this.tile_info.mapboxTileName+"-LandscapeSize-"+this.tile_info.resolution+".jpg",this.qt.loading.show(),this.dirHandle=await idbKeyval.get("dirHandle"),await fileUtils.verifyPermission(this.dirHandle,!0)===!1){console.error(`User did not grant permission to '${this.dirHandle.name}'`);return}if(fileUtils.fileExists(this.dirHandle,this.tile_info.thirtytwoFile)){let u=await idbKeyval.get("rgb_image_buffer"),f=await mapUtils.loadImageFromArray(u),_=mapUtils.createHeightMapImage(f,16,"GREY"),o=_.image;if(this.exportOptionsModel.includes("flipy")&&(o=await o.flipY()),this.exportOptionsModel.includes("flipx")&&(o=await o.flipX()),this.blurRadius>=1&&(o=o.blurFilter({radius:this.blurRadius})),r=await o.toBuffer(),this.img_min=parseInt(_.minElevation).toString(),this.img_max=parseInt(_.maxElevation).toString(),this.tile_info.resampleSize=this.unrealLandscape.value.toString(),this.tile_info.resizeMethod="lanczos",this.tile_info.exportTypeLabel=this.exportType.label,this.tile_info.alphaBrushFileName="alphabrush-"+this.tile_info.mapboxTileName+"-height-"+this.alphaBrushHeight+"-width-"+this.alphaBrushWidth,this.exportOptionsModel.includes("features")){let b=!1;this.exportOptionsModel.includes("combine_features")&&(b=!0),await this.unrealTileFeatures(b)}switch(this.tile_info.exportTypeLabel){case"Unreal Terrain Magic Plugin -- Manual":if(e=["-ot","UInt16","-of","PNG","-scale",this.img_min,this.img_max,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod.toString()],await this.createWorker(r,this.tile_info.sixteenFileName,e,"png","createHeightmap"),this.exportOptionsModel.includes("satellite")){e=["-of","JPEG","-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod];let b=await mapUtils.downloadTerrainRgb(this.tile_info.mapbox_satellite_image_url);await this.createWorker(b,this.tile_info.satelliteFileName,e,"jpg","createHeightmap")}this.qt.loading.hide();break;case"Unreal Heightmap":if(e=["-ot","UInt16","-of","PNG","-scale",this.img_min,this.img_max,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod.toString()],await this.createWorker(r,this.tile_info.sixteenFileName,e,"png","createHeightmap"),this.exportOptionsModel.includes("satellite")){e=["-of","JPEG","-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod];let b=await mapUtils.downloadTerrainRgb(this.tile_info.mapbox_satellite_image_url);await this.createWorker(b,this.tile_info.satelliteFileName,e,"jpg","createHeightmap")}this.qt.loading.hide();break;case"Geojson Only":await this.unrealTileFeatures(!0),this.qt.loading.hide();break;case"Unreal Stamp Brush Plugin":this.alphaBrushName.length>0&&(this.tile_info.alphaBrushFileName=this.alphaBrushName),e=["-ot","UInt16","-of","PNG","-scale",this.img_min,this.img_max,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.alphaBrushHeight.toString(),this.alphaBrushWidth.toString(),"-r",this.tile_info.resizeMethod],await this.createWorker(r,this.tile_info.alphaBrushFileName+".png",e,"png","createHeightmap"),this.qt.loading.hide();break;case"Unreal Landmass Effect Brush Plugin":this.alphaBrushName.length>0&&(this.tile_info.alphaBrushFileName=this.alphaBrushName),e=["-ot","UInt16","-of","PNG","-scale",this.img_min,this.img_max,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.alphaBrushHeight.toString(),this.alphaBrushWidth.toString(),"-r",this.tile_info.resizeMethod],await this.createWorker(r,this.tile_info.alphaBrushFileName+".png",e,"png","createHeightmap"),this.qt.loading.hide();break;case"None":await fileUtils.writeFileToDisk(this.dirHandle,this.tile_info.sixteenFileName,o.toBuffer()),this.qt.loading.hide();break}}else this.alertMsg="Please select a location on the map first.",this.alert=!0}else this.alertMsg="Please select a location on the map first.",this.alert=!0}}},_hoisted_1$2=createBaseVNode("div",{id:"previewTitle",class:"text-h6 bg-primary text-white"},"Preview Image",-1),_hoisted_2$2={class:"row justify-start q-pa-none q-ma-none"},_hoisted_3$2={style:{width:"100%"}},_hoisted_4$2={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_5$2={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_6$2=createBaseVNode("b",null,[createBaseVNode("u",null,"Export Type:")],-1),_hoisted_7$1=createBaseVNode("b",null,[createBaseVNode("u",null,"Export Options:")],-1),_hoisted_8$1=createBaseVNode("div",{class:"text-h6"},[createBaseVNode("u",null,"Coordinates for Unreal LandscapeGen Plugin")],-1),_hoisted_9$1=createBaseVNode("div",{class:"text-h6"},"Zoom:",-1),_hoisted_10$1=createBaseVNode("div",{class:"text-h6"},"Mouse Point Lat/Lng:",-1),_hoisted_11$1=createBaseVNode("div",{class:"text-h6"},[createBaseVNode("u",null,"Bounding Box Corners Lat/Lng:")],-1),_hoisted_12$1=createBaseVNode("div",{class:"text-h6"},"Top Left:",-1),_hoisted_13=createBaseVNode("div",{class:"text-h6"},"Bottom Left:",-1),_hoisted_14=createBaseVNode("div",{class:"text-h6"},"Top Right:",-1),_hoisted_15=createBaseVNode("div",{class:"text-h6"},"Bottom Right:",-1),_hoisted_16=createBaseVNode("div",{class:"text-h6"},"Lng/Lat Max/Min:",-1),_hoisted_17=createBaseVNode("div",{class:"text-h6"},"Alert",-1);function _sfc_render$2(e,r,n,a,u,f){return openBlock(),createElementBlock(Fragment,null,[_hoisted_1$2,createVNode(QImg,{src:a.url,height:"150px"},null,8,["src"]),createBaseVNode("div",_hoisted_2$2,[createBaseVNode("div",_hoisted_3$2,[createVNode(QField,{dense:"",class:"text-weight-bolder q-pt-none q-mt-xs",label:"Min/Max Elevation","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_4$2,toDisplayString(this.tile_info.minmax),1)]),_:1}),createVNode(QField,{class:"q-pt-none q-mt-xs",dense:"",label:"Unreal Z-Scale",hint:"Input into Unreal Landscape Z scale","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_5$2,toDisplayString(this.tile_info.zscale),1)]),_:1}),createVNode(QItemLabel,{class:"q-pt-none q-mt-xs"},{default:withCtx(()=>[_hoisted_6$2]),_:1}),createVNode(QSelect,{class:"q-mt-none q-pt-none","bg-color":"blue-2",outlined:"",filled:"",dense:"",modelValue:a.exportType,"onUpdate:modelValue":[r[0]||(r[0]=_=>a.exportType=_),f.exportType_Change],options:a.exportTyprOptions,"option-disable":"cannotSelect"},null,8,["modelValue","options","option-disable","onUpdate:modelValue"]),withDirectives(createVNode(QItemLabel,{class:"q-pt-none q-mt-xs"},{default:withCtx(()=>[_hoisted_7$1]),_:1},512),[[vShow,a.isExportOptions]]),withDirectives(createVNode(QOptionGroup,{class:"q-mt-none q-pt-none",dense:"",inline:"",options:a.exportOptions,"onUpdate:modelValue":[f.exportOptionsModelChange,r[1]||(r[1]=_=>a.exportOptionsModel=_)],type:"checkbox",modelValue:a.exportOptionsModel},null,8,["options","onUpdate:modelValue","modelValue"]),[[vShow,a.isExportOptions]]),withDirectives(createVNode(QSelect,{dense:"",class:"q-pt-none q-mt-xs",label:"Landscape Size","transition-show":"scale","transition-hide":"scale",hint:"Unreal Recommended Sizes",outlined:"",modelValue:a.unrealLandscape,"onUpdate:modelValue":[r[2]||(r[2]=_=>a.unrealLandscape=_),f.landscapeSizeChange],options:a.landscapeSize},null,8,["modelValue","options","onUpdate:modelValue"]),[[vShow,a.isLandscape]]),withDirectives(createVNode(QField,{class:"q-pt-none q-mt-xs",label:"Brush Size"},{default:withCtx(()=>[createVNode(QInput,{class:"q-pt-none q-mt-xs",filled:"",modelValue:a.alphaBrushHeight,"onUpdate:modelValue":r[3]||(r[3]=_=>a.alphaBrushHeight=_),label:"Height"},null,8,["modelValue"]),createVNode(QInput,{class:"q-pt-none q-mt-xs",filled:"",modelValue:a.alphaBrushWidth,"onUpdate:modelValue":r[4]||(r[4]=_=>a.alphaBrushWidth=_),label:"Width"},null,8,["modelValue"]),createVNode(QInput,{ref:"alphaBrushNameRef",filled:"",modelValue:a.alphaBrushName,"onUpdate:modelValue":r[5]||(r[5]=_=>a.alphaBrushName=_),label:"Brush Name"},null,8,["modelValue"])]),_:1},512),[[vShow,a.isAlphaBrush]]),withDirectives(createVNode(QField,{class:"q-pt-none q-mt-xs",dense:"",label:"Landscape Name (Optional)",hint:"Enter Unique Landscape Name"},{default:withCtx(()=>[createVNode(QInput,{modelValue:a.landscapeName,"onUpdate:modelValue":r[6]||(r[6]=_=>a.landscapeName=_)},null,8,["modelValue"])]),_:1},512),[[vShow,a.isLandscape]]),withDirectives(createVNode(QField,{class:"q-pt-none q-mt-xs",label:"Blur Radius"},{default:withCtx(()=>[createVNode(QInput,{class:"q-pt-none q-mt-xs",filled:"",modelValue:a.blurRadius,"onUpdate:modelValue":r[7]||(r[7]=_=>a.blurRadius=_),label:"Blur Radius"},null,8,["modelValue"])]),_:1},512),[[vShow,a.isBlurRadius]])])]),withDirectives(createVNode(QBtn,{onClick:f.createSixteenHeightMap,ref:"btnDownload",dense:"",color:"primary","no-caps":"",label:"Download HeightMap"},null,8,["onClick"]),[[vShow,a.isDownload]]),withDirectives(createVNode(QBtn,{onClick:f.sendToUnreal,disabled:a.isDisabled,dense:"",color:"green",class:"q-ml-xs","no-caps":"",label:"Send To Unreal"},null,8,["onClick","disabled"]),[[vShow,a.isSendToUnreal]]),createVNode(QBtn,{onClick:f.copyExtents,disabled:a.isDisabled,dense:"",color:"purple",class:"q-ml-xs","no-caps":"",label:"Copy Bounds for Blender Osm"},null,8,["onClick","disabled"]),createVNode(QBtn,{onClick:f.copyTileInfoString,disabled:a.isDisabled,dense:"",color:"cyan",class:"q-ml-xs","no-caps":"",label:"Copy Slippy Tile Info String"},null,8,["onClick","disabled"]),createVNode(QBtn,{onClick:f.showBBInfo,dense:"",color:"orange","no-caps":"",label:"Show Bounding Box Info"},null,8,["onClick"]),createVNode(QDialog,{modelValue:a.bbinfoalert,"onUpdate:modelValue":r[8]||(r[8]=_=>a.bbinfoalert=_)},{default:withCtx(()=>[createVNode(QCard,null,{default:withCtx(()=>[createVNode(QCardSection,null,{default:withCtx(()=>[_hoisted_8$1]),_:1}),createVNode(QCardSection,{class:"q-pt-none"},{default:withCtx(()=>[_hoisted_9$1,createTextVNode(" "+toDisplayString(a.tile_info.z)+" ",1),_hoisted_10$1,createTextVNode(" Lat: "+toDisplayString(a.tile_info.pointLat)+" Lng: "+toDisplayString(a.tile_info.pointLng)+" ",1),_hoisted_11$1,_hoisted_12$1,createTextVNode(" Lat: "+toDisplayString(a.tile_info.topLeft.lat)+" Lng: "+toDisplayString(a.tile_info.topLeft.lng)+" ",1),_hoisted_13,createTextVNode(" Lat: "+toDisplayString(a.tile_info.bottomLeft.lat)+" Lng: "+toDisplayString(a.tile_info.bottomLeft.lng)+" ",1),_hoisted_14,createTextVNode(" Lat: "+toDisplayString(a.tile_info.topRight.lat)+" Lng: "+toDisplayString(a.tile_info.topRight.lng)+" ",1),_hoisted_15,createTextVNode(" Lat: "+toDisplayString(a.tile_info.bottomRight.lat)+" Lng: "+toDisplayString(a.tile_info.bottomRight.lng)+" ",1),_hoisted_16,createTextVNode(" Lng/Lat-Min: "+toDisplayString(a.tile_info.bboxW)+" , "+toDisplayString(a.tile_info.bboxS)+" Lng/Lat-Max: "+toDisplayString(a.tile_info.bboxE)+" , "+toDisplayString(a.tile_info.bboxN),1)]),_:1}),createVNode(QCardActions,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(QBtn,{flat:"",label:"OK",color:"primary"},null,512),[[ClosePopup]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),createVNode(QDialog,{modelValue:a.alert,"onUpdate:modelValue":r[9]||(r[9]=_=>a.alert=_)},{default:withCtx(()=>[createVNode(QCard,null,{default:withCtx(()=>[createVNode(QCardSection,null,{default:withCtx(()=>[_hoisted_17]),_:1}),createVNode(QCardSection,{class:"q-pt-none"},{default:withCtx(()=>[createTextVNode(toDisplayString(a.alertMsg),1)]),_:1}),createVNode(QCardActions,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(QBtn,{flat:"",label:"OK",color:"primary"},null,512),[[ClosePopup]])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}var SideNav=_export_sfc(_sfc_main$2,[["render",_sfc_render$2]]);const _sfc_main$1={props:{},emits:["ok","hide"],methods:{show(){this.$refs.dialog.show()},hide(){this.$refs.dialog.hide()},onDialogHide(){this.$emit("hide")},onOKClick(){this.$emit("ok"),this.hide()},onCancelClick(){this.hide()}}},_hoisted_1$1=createBaseVNode("div",null,[createBaseVNode("b",null,"Help")],-1),_hoisted_2$1=createBaseVNode("br",null,null,-1),_hoisted_3$1=createBaseVNode("div",{class:"q-mt-sm"},[createBaseVNode("b",null,"Settings Page:")],-1),_hoisted_4$1=createBaseVNode("ol",null,[createBaseVNode("li",null,[createTextVNode(" You need to create a free Mapbox account and enter your mapbox access token. Goto "),createBaseVNode("a",{href:"https://www.mapbox.com",target:"_blank"},"Mapbox"),createTextVNode(" then goto your account page. There you can copy your access token. ")]),createBaseVNode("li",null," Select a download folder. This is a folder on your local pc where your heightmap files will be saved. ")],-1),_hoisted_5$1=createBaseVNode("div",{class:"q-mt-sm"},[createBaseVNode("b",null,"Map Page:")],-1),_hoisted_6$1=createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Map Settings"),createTextVNode(" -- Enable different layers for viewing. This does not affect downloaded data ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Search Bar"),createTextVNode(" -- Enter the name of a location or Longitude Latitude seperated by a comma. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Top Bar"),createTextVNode(" -- Area in KM show the area of the blue bounding box in Kilometers. Slippy Tile Info String is a standard format identification for downloading map tiles. Format is X,Y,Z Z = zoom level. ")])],-1),_hoisted_7=createBaseVNode("div",{class:""},[createBaseVNode("b",null,"Map Navigation:")],-1),_hoisted_8=createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Left Mouse Click"),createTextVNode(" -- Selects a location on the map indicated by a blue bounding box. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Left Mouse Hold"),createTextVNode(" -- Drag the mouse around to move the map. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Right Mouse Hold"),createTextVNode(" -- Tilt and Rotate the map. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Scroll Wheel"),createTextVNode(" -- Zoom in and out. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Arrow Keys"),createTextVNode(" -- Move around the map. ")])],-1),_hoisted_9=createBaseVNode("div",{class:"q-mb-md"},[createBaseVNode("b",null,"Left Side Bar:")],-1),_hoisted_10=createBaseVNode("div",{class:"q-ml-md"},[createBaseVNode("div",null,[createBaseVNode("u",null,"Export Type:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Heightmap"),createTextVNode(" -- Generates a 16-bit png heightmap file. Can be used in other applications besides Unreal. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Terrain Magic Plugin"),createTextVNode(" -- Needs custom C++ adjustment to work. You need to install the paid plugin "),createBaseVNode("a",{href:"https://github.com/GDi4K/unreal-terrain-magic"},"Terrain Magic"),createTextVNode(". Terrain magic has it's own map to import heightmaps for Unreal. This just makes it a one click solution instead of copy and paste. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Terrain Magic Plugin -- Manual"),createTextVNode(" -- No modification to Terrain Magic Pluign needed. You need to install the paid plugin "),createBaseVNode("a",{href:"https://github.com/GDi4K/unreal-terrain-magic"},"Terrain Magic"),createTextVNode(". You need to click on Match Landscape Size to refersh the imported landscape after you click Send To Unreal. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Stamp Brush Plugin"),createTextVNode(" -- You need to install paid plugin "),createBaseVNode("a",{href:"https://www.unrealengine.com/marketplace/en-US/product/landscape-stamping-tool-100-custom-brushes?sessionInvalidated=true"},"Landscape Stamping Tool - 100+ Custom Brushes"),createTextVNode(". This automates the creation of new stamps from selected map location. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Landmass Effect Brush Plugin"),createTextVNode(" -- Open source plugin for creating non-destructive landmass stamps and other features. Download the source from here "),createBaseVNode("a",{href:"https://github.com/AWeinb/SimplerLandmassBlueprints"},"SimplerLandmassBlueprints"),createTextVNode(". From the Content folder copy the whole Editor folder to your Content directory. Each time you click Send To Unreal it will import the texture to a sub folder CustomBrushes > Textures. For now it only imports the texture you have to manually add the texture to the brush according to the github instructions. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"None"),createTextVNode(" -- Generate 16-bit png heightmap but do not do any other transformations to the image. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Geojson Only"),createTextVNode(" -- Do not download a heightmap png file. Just download a Geojson file. ")])])]),createBaseVNode("div",null,[createBaseVNode("u",null,"Export Options:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Zrange-sea level="),createTextVNode(" -- By checking this the imported heightmap will keep the landscape height near 100 Unreal Units. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"FlipX/FlipY"),createTextVNode(" -- Flips the sides of the heightmap image in the X or Y direction. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Download Satellite"),createTextVNode(" -- Downloads a Satellite Image of the selected area. This can be used as on overlay in UE. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Download Geojson Features"),createTextVNode(" -- Downloads the features of the selected area in geojson format. Search Mapbox for geosjon. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Combine Unique Features"),createTextVNode(" -- Removes overlapping features when downloading geojson ")])])])],-1),_hoisted_11=createBaseVNode("div",null,[createBaseVNode("u",null,"Landscape:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Landscape Size"),createTextVNode(" -- Resamples the size of the image to recommended Unreal Landscape sizes. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Landscape Name"),createTextVNode(" -- Name of the landscape to be imported. (Optional ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Blur Radius"),createTextVNode(" -- Adds a gaussian blur to the heightmap png. This can help smooth out your imported landscape if it has some sharp edges. The greater the number the greater the blur. 0 = no blur. ")])])],-1),_hoisted_12=createBaseVNode("div",null,[createBaseVNode("u",null,"Buttons:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Download Heightmap"),createTextVNode(" -- Downloads the heightmap png to the folder location on the settings page. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Send To Unreal"),createTextVNode(" -- Automatically imports heightmap or stamp into your Unreal project. Required -- Mapbox_BP has to be installed in to your unreal project and configured. You can download the free plugin here "),createBaseVNode("a",{href:"https://github.com/delebash/UnrealMapboxBridgePlugin"},"Unreal Mapbox Bridge Plugin"),createTextVNode(". ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Copy Bounds for Blender OSM"),createTextVNode(" -- A plugin for blend that downloads real world map info into blender. It has it's own map but you can use this one as well since it has a search by name feature. Download "),createBaseVNode("a",{href:"https://github.com/vvoovv/blender-osm"},"Blender OSM"),createTextVNode(". ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Copy Slippy Tile Info String"),createTextVNode(" -- This format is used in many other GIS applications to download map tile information. This is just a convenience function. This is also the same string Terrain Magic expects. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Show Bounding Box Info"),createTextVNode(" -- General info such as Long/Lat info for bounding box. ")])])],-1);function _sfc_render$1(e,r,n,a,u,f){return openBlock(),createBlock(QDialog,{class:"dialog-plugin",ref:"dialog",onHide:f.onDialogHide},{default:withCtx(()=>[createVNode(QCard,{style:{width:"900px","max-width":"80vw",height:"700px"}},{default:withCtx(()=>[createVNode(QCardSection,null,{default:withCtx(()=>[_hoisted_1$1,_hoisted_2$1,createVNode(QSeparator),_hoisted_3$1,_hoisted_4$1,_hoisted_5$1,_hoisted_6$1,_hoisted_7,_hoisted_8,_hoisted_9,_hoisted_10,_hoisted_11,_hoisted_12,createVNode(QCardActions,{class:"absolute-top",align:"right"},{default:withCtx(()=>[createVNode(QBtn,{color:"primary",label:"Close",onClick:f.onOKClick},null,8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["onHide"])}var Help=_export_sfc(_sfc_main$1,[["render",_sfc_render$1]]);const _sfc_main={setup(){const e=useQuasar();return{showDialog(){e.dialog({component:Help,componentProps:{text:""}}).onOk(()=>{}).onCancel(()=>{}).onDismiss(()=>{})},data_path:"",selectedTab:ref("map"),dirHandle:ref(""),dirName:ref(""),style_url:ref(""),access_token:ref(""),mapbox_api_url:ref(""),mapbox_raster_png_dem:ref(""),mapbox_satellite_endpoint:ref(""),isPwd:ref(!0),drawerLeft:ref(!1),createFolder:ref(!1)}},mounted:async function(){await this.loadUserData(),this.isRequiredSettings()===!0&&await this.loadMap()},methods:{resizeMap(){this.$refs.mapBoxViewer.resizeMap()},changeDrawer(){this.drawerLeft=!this.drawerLeft},async loadMap(){this.selectedTab="map",await this.$nextTick(()=>{this.$refs.mapBoxViewer.loadMapboxMap()})},isRequiredSettings(){return this.access_token&&this.style_url&&this.dirName?!0:(this.redirectToSettings(),!1)},redirectToSettings(){this.selectedTab="settings",Notify.create({color:"negative",textColor:"white",icon:"report_problem",message:"Please fill out the required fields!",position:"top"})},async openDirectory(){let e;try{e=await fileUtils.getDirHandle()}catch(r){if(r.name==="AbortError")return;console.error("An error occured trying to open the file.",r)}!e||(idbKeyval.set("dirHandle",e),this.dirName=e.name)},saveUserSettings(){idbKeyval.set("access_token",this.access_token),idbKeyval.set("style_url",this.style_url),idbKeyval.set("mapbox_api_url",this.mapbox_api_url),idbKeyval.set("mapbox_satellite_endpoint",this.mapbox_satellite_endpoint),idbKeyval.set("mapbox_raster_png_dem",this.mapbox_raster_png_dem),idbKeyval.set("create_folder",this.createFolder),this.isRequiredSettings()===!0&&this.loadMap()},async loadUserData(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken||"",this.style_url=await idbKeyval.get("style_url")||"mapbox://styles/mapbox/streets-v11",this.mapbox_api_url=await idbKeyval.get("mapbox_api_url")||"https://api.mapbox.com/v4/",this.mapbox_satellite_endpoint=await idbKeyval.get("mapbox_satellite_endpoint")||"https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles",this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem")||"mapbox.mapbox-terrain-dem-v1";let e=await idbKeyval.get("dirHandle")||"";this.createFolder=await idbKeyval.get("create_folder")||"",this.dirHandle=e,this.dirName=e.name}},components:{MapboxMapViewer,SideNav,Help}},_hoisted_1={class:"row q-pa-xs full-height"},_hoisted_2=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/access-token/",target:"_blank"},"Mapbox access token docs",-1),_hoisted_3=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/style-url/",target:"_blank"},"Mapbox style url docs",-1),_hoisted_4={class:"q-pa-none row items-start"},_hoisted_5={class:"col q-pa-none"},_hoisted_6=createBaseVNode("br",null,null,-1);function _sfc_render(e,r,n,a,u,f){const _=resolveComponent("side-nav"),o=resolveComponent("mapbox-map-viewer");return openBlock(),createBlock(QLayout,{view:"lHr lpr lfr"},{default:withCtx(()=>[createVNode(QHeader,{dense:"",elevated:"",class:"bg-primary text-white","height-hint":"98"}),createVNode(QDrawer,{dense:"","show-if-above":"",modelValue:a.drawerLeft,"onUpdate:modelValue":r[0]||(r[0]=b=>a.drawerLeft=b),side:"left",onHide:f.resizeMap,class:"no-margin no-padding"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1,[createVNode(QCard,{class:"col q-pl-xs"},{default:withCtx(()=>[createVNode(_)]),_:1})])]),_:1},8,["modelValue","onHide"]),createVNode(QPageContainer,null,{default:withCtx(()=>[createVNode(QPage,{class:"row no-margin q-pa-sm"},{default:withCtx(()=>[createVNode(QCard,{class:"col"},{default:withCtx(()=>[createVNode(QTabs,{dense:"",modelValue:a.selectedTab,"onUpdate:modelValue":r[2]||(r[2]=b=>a.selectedTab=b),class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:withCtx(()=>[createVNode(QBtn,{dense:"",flat:"",onClick:f.changeDrawer,round:"",icon:"menu"},null,8,["onClick"]),createVNode(QTab,{dense:"",name:"map",label:"Map"}),createVNode(QTab,{dense:"",name:"settings",label:"Settings"}),createVNode(QBtn,{style:{background:"#FF0080",color:"white"},label:"Help",class:"q-mr-lg",onClick:a.showDialog},null,8,["onClick"]),createVNode(QBtn,{dense:"",flat:"",round:"",onClick:r[1]||(r[1]=b=>e.$q.dark.toggle()),icon:e.$q.dark.isActive?"nights_stay":"wb_sunny"},null,8,["icon"])]),_:1},8,["modelValue"]),createVNode(QSeparator),createVNode(QTabPanels,{class:"q-pa-none q-ma-none","keep-alive":"",modelValue:a.selectedTab,"onUpdate:modelValue":r[12]||(r[12]=b=>a.selectedTab=b),animated:""},{default:withCtx(()=>[createVNode(QTabPanel,{name:"map",class:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",style:{width:"100%",height:"calc(100vh - 65px)"}},{default:withCtx(()=>[createVNode(o,{class:"col",ref:"mapBoxViewer"},null,512)]),_:1}),createVNode(QTabPanel,{lass:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",name:"settings"},{default:withCtx(()=>[createTextVNode(" See: "),_hoisted_2,createVNode(QInput,{dense:"",modelValue:a.access_token,"onUpdate:modelValue":r[4]||(r[4]=b=>a.access_token=b),label:"Mapbox Access Token *",filled:"",type:a.isPwd?"password":"text","lazy-rules":"",hint:"You will need your own access token created from your Mapbox accounts page. The Mapbox free plan is a great choice.",rules:[b=>b&&b.length>0||"Please type something"]},{append:withCtx(()=>[createVNode(QIcon,{dense:"",name:a.isPwd?"visibility_off":"visibility",class:"cursor-pointer",onClick:r[3]||(r[3]=b=>a.isPwd=!a.isPwd)},null,8,["name"])]),_:1},8,["modelValue","type","rules"]),createTextVNode(" See: "),_hoisted_3,createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:a.style_url,"onUpdate:modelValue":r[5]||(r[5]=b=>a.style_url=b),label:"Enter your Mapbox style url *",filled:"","lazy-rules":"",hint:"You can use the default style or you can create your own custom style in Mapbox Studio.",rules:[b=>b&&b.length>0||"Please type something"],type:a.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:a.mapbox_api_url,"onUpdate:modelValue":r[6]||(r[6]=b=>a.mapbox_api_url=b),label:"Mapbox base api url *",filled:"","lazy-rules":"",hint:"",rules:[b=>b&&b.length>0||"Please type something"],type:a.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:a.mapbox_raster_png_dem,"onUpdate:modelValue":r[7]||(r[7]=b=>a.mapbox_raster_png_dem=b),label:"Mapbox Raster Dem Endpoint *",filled:"","lazy-rules":"",hint:"",rules:[b=>b&&b.length>0||"Please type something"],type:a.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:a.mapbox_satellite_endpoint,"onUpdate:modelValue":r[8]||(r[8]=b=>a.mapbox_satellite_endpoint=b),label:"Mapbox Satellite Endpoint *",filled:"","lazy-rules":"",hint:"",rules:[b=>b&&b.length>0||"Please type something"],type:a.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createBaseVNode("div",_hoisted_4,[createBaseVNode("div",_hoisted_5,[createVNode(QInput,{dense:"",class:"q-pb-none",modelValue:a.dirName,"onUpdate:modelValue":r[9]||(r[9]=b=>a.dirName=b),label:"Enter download directory path *",filled:"","lazy-rules":"",rules:[b=>b&&b.length>0||"Please type something"],type:a.isPwd?"":"text"},null,8,["modelValue","rules","type"])]),createVNode(QBtn,{class:"q-pb-none",dense:"",onClick:r[10]||(r[10]=b=>f.openDirectory()),color:"secondary",label:"Select download folder"})]),_hoisted_6,createVNode(QBtn,{class:"q-pt-none",dense:"",onClick:r[11]||(r[11]=b=>f.saveUserSettings()),color:"secondary",label:"Save settings"})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})}var MainLayout=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{MainLayout as default};
