import{r as ref,i as isRuntimeSsrPreHydration,o as onMounted,c as createComponent,g as getCurrentInstance,a as onBeforeUnmount,n as noop,b as nextTick,h,l as listenOpts,d as inject,e as emptyRenderFn,f as computed,w as watch,j as hUniqueSlot,k as layoutKey,P as Platform,m as createDirective,p as client$1,q as leftClick,s as addEvt,t as preventDraggable,u as prevent,v as stop,x as position,y as cleanEvt,z as stopAndPrevent,A as useModelToggleProps,B as useDarkProps,C as useModelToggleEmits,D as useDark,E as useTimeout,F as useModelToggle,G as useHistory,H as withDirectives,I as hDir,J as hSlot,K as usePreventScroll,L as tabsKey,R as Ripple,M as isKeyCode,N as shouldIgnoreKey,Q as QIcon,O as hMergeSlot,S as isDeepEqual,T as uid$1,U as useTick,V as provide,W as onDeactivated,X as onActivated,Y as Transition,Z as getNormalizedVNodes,_ as KeepAlive,$ as portalProxyList,a0 as getScrollbarWidth,a1 as useTransitionProps,a2 as useTransition,a3 as usePortal,a4 as addFocusout,a5 as removeFocusout,a6 as removeEscapeKey,a7 as getScrollTarget,a8 as closePortalMenus,a9 as addEscapeKey,aa as addFocusFn,ab as childHasFocus,ac as injectProp,ad as QBtn,ae as debounce$2,af as onBeforeMount,ag as useFieldProps,ah as useFieldEmits,ai as useField,aj as useFieldState,ak as useSizeProps,al as useSize,am as hMergeSlotSafely,an as useRouterLinkProps,ao as useRouterLink,ap as useFormProps,aq as useFormInputNameAttr,ar as fieldValueIsFilled,as as onBeforeUpdate,at as onUpdated,au as useKeyComposition,av as QDialog,aw as vmHasRouter,ax as History,ay as isNumber$1,az as isDate,aA as isObject$1,aB as injectMultipleProps,aC as QCheckbox,aD as QSeparator,aE as pageContainerKey,aF as getVerticalScrollPosition,aG as getHorizontalScrollPosition,aH as reactive,aI as onUnmounted,aJ as getPortalProxy,aK as closePortals,aL as quasarKey,aM as _export_sfc,aN as openBlock,aO as createElementBlock,aP as createBaseVNode,aQ as createVNode,aR as withCtx,aS as QOptionGroup,aT as createTextVNode,aU as toDisplayString,aV as QCard,aW as QCardSection,aX as QCardActions,aY as Fragment,aZ as QSpinner,a_ as toRaw,a$ as vShow,b0 as QInput,b1 as createBlock,b2 as isProxy,b3 as Notify,b4 as resolveComponent,b5 as withKeys}from"./index-c0393a6c.js";import{Q as QPage}from"./QPage-4c88e985.js";function useCanRender(){const e=ref(!isRuntimeSsrPreHydration.value);return e.value===!1&&onMounted(()=>{e.value=!0}),e}const hasObserver=typeof ResizeObserver<"u",resizeProps=hasObserver===!0?{}:{style:"display:block;position:absolute;top:0;left:0;right:0;bottom:0;height:100%;width:100%;overflow:hidden;pointer-events:none;z-index:-1;",url:"about:blank"},QResizeObserver=createComponent({name:"QResizeObserver",props:{debounce:{type:[String,Number],default:100}},emits:["resize"],setup(e,{emit:r}){let t=null,o,s={width:-1,height:-1};function d(b){b===!0||e.debounce===0||e.debounce==="0"?g():t===null&&(t=setTimeout(g,e.debounce))}function g(){if(t!==null&&(clearTimeout(t),t=null),o){const{offsetWidth:b,offsetHeight:_}=o;(b!==s.width||_!==s.height)&&(s={width:b,height:_},r("resize",s))}}const{proxy:a}=getCurrentInstance();if(hasObserver===!0){let b;const _=T=>{o=a.$el.parentNode,o?(b=new ResizeObserver(d),b.observe(o),g()):T!==!0&&nextTick(()=>{_(!0)})};return onMounted(()=>{_()}),onBeforeUnmount(()=>{t!==null&&clearTimeout(t),b!==void 0&&(b.disconnect!==void 0?b.disconnect():o&&b.unobserve(o))}),noop}else{let T=function(){t!==null&&(clearTimeout(t),t=null),_!==void 0&&(_.removeEventListener!==void 0&&_.removeEventListener("resize",d,listenOpts.passive),_=void 0)},C=function(){T(),o&&o.contentDocument&&(_=o.contentDocument.defaultView,_.addEventListener("resize",d,listenOpts.passive),g())};const b=useCanRender();let _;return onMounted(()=>{nextTick(()=>{o=a.$el,o&&C()})}),onBeforeUnmount(T),a.trigger=d,()=>{if(b.value===!0)return h("object",{style:resizeProps.style,tabindex:-1,type:"text/html",data:resizeProps.url,"aria-hidden":"true",onLoad:C})}}}}),QHeader=createComponent({name:"QHeader",props:{modelValue:{type:Boolean,default:!0},reveal:Boolean,revealOffset:{type:Number,default:250},bordered:Boolean,elevated:Boolean,heightHint:{type:[String,Number],default:50}},emits:["reveal","focusin"],setup(e,{slots:r,emit:t}){const{proxy:{$q:o}}=getCurrentInstance(),s=inject(layoutKey,emptyRenderFn);if(s===emptyRenderFn)return console.error("QHeader needs to be child of QLayout"),emptyRenderFn;const d=ref(parseInt(e.heightHint,10)),g=ref(!0),a=computed(()=>e.reveal===!0||s.view.value.indexOf("H")>-1||o.platform.is.ios&&s.isContainer.value===!0),b=computed(()=>{if(e.modelValue!==!0)return 0;if(a.value===!0)return g.value===!0?d.value:0;const te=d.value-s.scroll.value.position;return te>0?te:0}),_=computed(()=>e.modelValue!==!0||a.value===!0&&g.value!==!0),T=computed(()=>e.modelValue===!0&&_.value===!0&&e.reveal===!0),C=computed(()=>"q-header q-layout__section--marginal "+(a.value===!0?"fixed":"absolute")+"-top"+(e.bordered===!0?" q-header--bordered":"")+(_.value===!0?" q-header--hidden":"")+(e.modelValue!==!0?" q-layout--prevent-focus":"")),D=computed(()=>{const te=s.rows.value.top,H={};return te[0]==="l"&&s.left.space===!0&&(H[o.lang.rtl===!0?"right":"left"]=`${s.left.size}px`),te[2]==="r"&&s.right.space===!0&&(H[o.lang.rtl===!0?"left":"right"]=`${s.right.size}px`),H});function k(te,H){s.update("header",te,H)}function O(te,H){te.value!==H&&(te.value=H)}function U({height:te}){O(d,te),k("size",te)}function G(te){T.value===!0&&O(g,!0),t("focusin",te)}watch(()=>e.modelValue,te=>{k("space",te),O(g,!0),s.animate()}),watch(b,te=>{k("offset",te)}),watch(()=>e.reveal,te=>{te===!1&&O(g,e.modelValue)}),watch(g,te=>{s.animate(),t("reveal",te)}),watch(s.scroll,te=>{e.reveal===!0&&O(g,te.direction==="up"||te.position<=e.revealOffset||te.position-te.inflectionPoint<100)});const j={};return s.instances.header=j,e.modelValue===!0&&k("size",d.value),k("space",e.modelValue),k("offset",b.value),onBeforeUnmount(()=>{s.instances.header===j&&(s.instances.header=void 0,k("size",0),k("offset",0),k("space",!1))}),()=>{const te=hUniqueSlot(r.default,[]);return e.elevated===!0&&te.push(h("div",{class:"q-layout__shadow absolute-full overflow-hidden no-pointer-events"})),te.push(h(QResizeObserver,{debounce:0,onResize:U})),h("header",{class:C.value,style:D.value,onFocusin:G},te)}}}),modifiersAll={left:!0,right:!0,up:!0,down:!0,horizontal:!0,vertical:!0},directionList=Object.keys(modifiersAll);modifiersAll.all=!0;function getModifierDirections(e){const r={};for(const t of directionList)e[t]===!0&&(r[t]=!0);return Object.keys(r).length===0?modifiersAll:(r.horizontal===!0?r.left=r.right=!0:r.left===!0&&r.right===!0&&(r.horizontal=!0),r.vertical===!0?r.up=r.down=!0:r.up===!0&&r.down===!0&&(r.vertical=!0),r.horizontal===!0&&r.vertical===!0&&(r.all=!0),r)}function shouldStart(e,r){return r.event===void 0&&e.target!==void 0&&e.target.draggable!==!0&&typeof r.handler=="function"&&e.target.nodeName.toUpperCase()!=="INPUT"&&(e.qClonedBy===void 0||e.qClonedBy.indexOf(r.uid)===-1)}function clearSelection(){if(window.getSelection!==void 0){const e=window.getSelection();e.empty!==void 0?e.empty():e.removeAllRanges!==void 0&&(e.removeAllRanges(),Platform.is.mobile!==!0&&e.addRange(document.createRange()))}else document.selection!==void 0&&document.selection.empty()}function getChanges(e,r,t){const o=position(e);let s,d=o.left-r.event.x,g=o.top-r.event.y,a=Math.abs(d),b=Math.abs(g);const _=r.direction;_.horizontal===!0&&_.vertical!==!0?s=d<0?"left":"right":_.horizontal!==!0&&_.vertical===!0?s=g<0?"up":"down":_.up===!0&&g<0?(s="up",a>b&&(_.left===!0&&d<0?s="left":_.right===!0&&d>0&&(s="right"))):_.down===!0&&g>0?(s="down",a>b&&(_.left===!0&&d<0?s="left":_.right===!0&&d>0&&(s="right"))):_.left===!0&&d<0?(s="left",a<b&&(_.up===!0&&g<0?s="up":_.down===!0&&g>0&&(s="down"))):_.right===!0&&d>0&&(s="right",a<b&&(_.up===!0&&g<0?s="up":_.down===!0&&g>0&&(s="down")));let T=!1;if(s===void 0&&t===!1){if(r.event.isFirst===!0||r.event.lastDir===void 0)return{};s=r.event.lastDir,T=!0,s==="left"||s==="right"?(o.left-=d,a=0,d=0):(o.top-=g,b=0,g=0)}return{synthetic:T,payload:{evt:e,touch:r.event.mouse!==!0,mouse:r.event.mouse===!0,position:o,direction:s,isFirst:r.event.isFirst,isFinal:t===!0,duration:Date.now()-r.event.time,distance:{x:a,y:b},offset:{x:d,y:g},delta:{x:o.left-r.event.lastX,y:o.top-r.event.lastY}}}}let uid=0;const TouchPan=createDirective({name:"touch-pan",beforeMount(e,{value:r,modifiers:t}){if(t.mouse!==!0&&client$1.has.touch!==!0)return;function o(d,g){t.mouse===!0&&g===!0?stopAndPrevent(d):(t.stop===!0&&stop(d),t.prevent===!0&&prevent(d))}const s={uid:"qvtp_"+uid++,handler:r,modifiers:t,direction:getModifierDirections(t),noop,mouseStart(d){shouldStart(d,s)&&leftClick(d)&&(addEvt(s,"temp",[[document,"mousemove","move","notPassiveCapture"],[document,"mouseup","end","passiveCapture"]]),s.start(d,!0))},touchStart(d){if(shouldStart(d,s)){const g=d.target;addEvt(s,"temp",[[g,"touchmove","move","notPassiveCapture"],[g,"touchcancel","end","passiveCapture"],[g,"touchend","end","passiveCapture"]]),s.start(d)}},start(d,g){if(client$1.is.firefox===!0&&preventDraggable(e,!0),s.lastEvt=d,g===!0||t.stop===!0){if(s.direction.all!==!0&&(g!==!0||s.modifiers.mouseAllDir!==!0&&s.modifiers.mousealldir!==!0)){const _=d.type.indexOf("mouse")>-1?new MouseEvent(d.type,d):new TouchEvent(d.type,d);d.defaultPrevented===!0&&prevent(_),d.cancelBubble===!0&&stop(_),Object.assign(_,{qKeyEvent:d.qKeyEvent,qClickOutside:d.qClickOutside,qAnchorHandled:d.qAnchorHandled,qClonedBy:d.qClonedBy===void 0?[s.uid]:d.qClonedBy.concat(s.uid)}),s.initialEvent={target:d.target,event:_}}stop(d)}const{left:a,top:b}=position(d);s.event={x:a,y:b,time:Date.now(),mouse:g===!0,detected:!1,isFirst:!0,isFinal:!1,lastX:a,lastY:b}},move(d){if(s.event===void 0)return;const g=position(d),a=g.left-s.event.x,b=g.top-s.event.y;if(a===0&&b===0)return;s.lastEvt=d;const _=s.event.mouse===!0,T=()=>{o(d,_);let k;t.preserveCursor!==!0&&t.preservecursor!==!0&&(k=document.documentElement.style.cursor||"",document.documentElement.style.cursor="grabbing"),_===!0&&document.body.classList.add("no-pointer-events--children"),document.body.classList.add("non-selectable"),clearSelection(),s.styleCleanup=O=>{if(s.styleCleanup=void 0,k!==void 0&&(document.documentElement.style.cursor=k),document.body.classList.remove("non-selectable"),_===!0){const U=()=>{document.body.classList.remove("no-pointer-events--children")};O!==void 0?setTimeout(()=>{U(),O()},50):U()}else O!==void 0&&O()}};if(s.event.detected===!0){s.event.isFirst!==!0&&o(d,s.event.mouse);const{payload:k,synthetic:O}=getChanges(d,s,!1);k!==void 0&&(s.handler(k)===!1?s.end(d):(s.styleCleanup===void 0&&s.event.isFirst===!0&&T(),s.event.lastX=k.position.left,s.event.lastY=k.position.top,s.event.lastDir=O===!0?void 0:k.direction,s.event.isFirst=!1));return}if(s.direction.all===!0||_===!0&&(s.modifiers.mouseAllDir===!0||s.modifiers.mousealldir===!0)){T(),s.event.detected=!0,s.move(d);return}const C=Math.abs(a),D=Math.abs(b);C!==D&&(s.direction.horizontal===!0&&C>D||s.direction.vertical===!0&&C<D||s.direction.up===!0&&C<D&&b<0||s.direction.down===!0&&C<D&&b>0||s.direction.left===!0&&C>D&&a<0||s.direction.right===!0&&C>D&&a>0?(s.event.detected=!0,s.move(d)):s.end(d,!0))},end(d,g){if(s.event!==void 0){if(cleanEvt(s,"temp"),client$1.is.firefox===!0&&preventDraggable(e,!1),g===!0)s.styleCleanup!==void 0&&s.styleCleanup(),s.event.detected!==!0&&s.initialEvent!==void 0&&s.initialEvent.target.dispatchEvent(s.initialEvent.event);else if(s.event.detected===!0){s.event.isFirst===!0&&s.handler(getChanges(d===void 0?s.lastEvt:d,s).payload);const{payload:a}=getChanges(d===void 0?s.lastEvt:d,s,!0),b=()=>{s.handler(a)};s.styleCleanup!==void 0?s.styleCleanup(b):b()}s.event=void 0,s.initialEvent=void 0,s.lastEvt=void 0}}};if(e.__qtouchpan=s,t.mouse===!0){const d=t.mouseCapture===!0||t.mousecapture===!0?"Capture":"";addEvt(s,"main",[[e,"mousedown","mouseStart",`passive${d}`]])}client$1.has.touch===!0&&addEvt(s,"main",[[e,"touchstart","touchStart",`passive${t.capture===!0?"Capture":""}`],[e,"touchmove","noop","notPassiveCapture"]])},updated(e,r){const t=e.__qtouchpan;t!==void 0&&(r.oldValue!==r.value&&(typeof value!="function"&&t.end(),t.handler=r.value),t.direction=getModifierDirections(r.modifiers))},beforeUnmount(e){const r=e.__qtouchpan;r!==void 0&&(r.event!==void 0&&r.end(),cleanEvt(r,"main"),cleanEvt(r,"temp"),client$1.is.firefox===!0&&preventDraggable(e,!1),r.styleCleanup!==void 0&&r.styleCleanup(),delete e.__qtouchpan)}});function between(e,r,t){return t<=r?r:Math.min(t,Math.max(r,e))}function normalizeToInterval(e,r,t){if(t<=r)return r;const o=t-r+1;let s=r+(e-r)%o;return s<r&&(s=o+s),s===0?0:s}const duration=150,QDrawer=createComponent({name:"QDrawer",inheritAttrs:!1,props:{...useModelToggleProps,...useDarkProps,side:{type:String,default:"left",validator:e=>["left","right"].includes(e)},width:{type:Number,default:300},mini:Boolean,miniToOverlay:Boolean,miniWidth:{type:Number,default:57},breakpoint:{type:Number,default:1023},showIfAbove:Boolean,behavior:{type:String,validator:e=>["default","desktop","mobile"].includes(e),default:"default"},bordered:Boolean,elevated:Boolean,overlay:Boolean,persistent:Boolean,noSwipeOpen:Boolean,noSwipeClose:Boolean,noSwipeBackdrop:Boolean},emits:[...useModelToggleEmits,"onLayout","miniState"],setup(e,{slots:r,emit:t,attrs:o}){const s=getCurrentInstance(),{proxy:{$q:d}}=s,g=useDark(e,d),{preventBodyScroll:a}=usePreventScroll(),{registerTimeout:b,removeTimeout:_}=useTimeout(),T=inject(layoutKey,emptyRenderFn);if(T===emptyRenderFn)return console.error("QDrawer needs to be child of QLayout"),emptyRenderFn;let C,D=null,k;const O=ref(e.behavior==="mobile"||e.behavior!=="desktop"&&T.totalWidth.value<=e.breakpoint),U=computed(()=>e.mini===!0&&O.value!==!0),G=computed(()=>U.value===!0?e.miniWidth:e.width),j=ref(e.showIfAbove===!0&&O.value===!1?!0:e.modelValue===!0),te=computed(()=>e.persistent!==!0&&(O.value===!0||tt.value===!0));function H(Be,Xt){if(fe(),Be!==!1&&T.animate(),ci(0),O.value===!0){const ni=T.instances[qt.value];ni!==void 0&&ni.belowBreakpoint===!0&&ni.hide(!1),mt(1),T.isContainer.value!==!0&&a(!0)}else mt(0),Be!==!1&&$t(!1);b(()=>{Be!==!1&&$t(!0),Xt!==!0&&t("show",Be)},duration)}function Z(Be,Xt){re(),Be!==!1&&T.animate(),mt(0),ci(se.value*G.value),dt(),Xt!==!0?b(()=>{t("hide",Be)},duration):_()}const{show:W,hide:_e}=useModelToggle({showing:j,hideOnRouteChange:te,handleShow:H,handleHide:Z}),{addToHistory:fe,removeFromHistory:re}=useHistory(j,_e,te),ae={belowBreakpoint:O,hide:_e},J=computed(()=>e.side==="right"),se=computed(()=>(d.lang.rtl===!0?-1:1)*(J.value===!0?1:-1)),Me=ref(0),Ie=ref(!1),We=ref(!1),Ge=ref(G.value*se.value),qt=computed(()=>J.value===!0?"left":"right"),ti=computed(()=>j.value===!0&&O.value===!1&&e.overlay===!1?e.miniToOverlay===!0?e.miniWidth:G.value:0),Ut=computed(()=>e.overlay===!0||e.miniToOverlay===!0||T.view.value.indexOf(J.value?"R":"L")>-1||d.platform.is.ios===!0&&T.isContainer.value===!0),Qt=computed(()=>e.overlay===!1&&j.value===!0&&O.value===!1),tt=computed(()=>e.overlay===!0&&j.value===!0&&O.value===!1),nt=computed(()=>"fullscreen q-drawer__backdrop"+(j.value===!1&&Ie.value===!1?" hidden":"")),Mt=computed(()=>({backgroundColor:`rgba(0,0,0,${Me.value*.4})`})),ht=computed(()=>J.value===!0?T.rows.value.top[2]==="r":T.rows.value.top[0]==="l"),xt=computed(()=>J.value===!0?T.rows.value.bottom[2]==="r":T.rows.value.bottom[0]==="l"),It=computed(()=>{const Be={};return T.header.space===!0&&ht.value===!1&&(Ut.value===!0?Be.top=`${T.header.offset}px`:T.header.space===!0&&(Be.top=`${T.header.size}px`)),T.footer.space===!0&&xt.value===!1&&(Ut.value===!0?Be.bottom=`${T.footer.offset}px`:T.footer.space===!0&&(Be.bottom=`${T.footer.size}px`)),Be}),Et=computed(()=>{const Be={width:`${G.value}px`,transform:`translateX(${Ge.value}px)`};return O.value===!0?Be:Object.assign(Be,It.value)}),yt=computed(()=>"q-drawer__content fit "+(T.isContainer.value!==!0?"scroll":"overflow-auto")),Bt=computed(()=>`q-drawer q-drawer--${e.side}`+(We.value===!0?" q-drawer--mini-animate":"")+(e.bordered===!0?" q-drawer--bordered":"")+(g.value===!0?" q-drawer--dark q-dark":"")+(Ie.value===!0?" no-transition":j.value===!0?"":" q-layout--prevent-focus")+(O.value===!0?" fixed q-drawer--on-top q-drawer--mobile q-drawer--top-padding":` q-drawer--${U.value===!0?"mini":"standard"}`+(Ut.value===!0||Qt.value!==!0?" fixed":"")+(e.overlay===!0||e.miniToOverlay===!0?" q-drawer--on-top":"")+(ht.value===!0?" q-drawer--top-padding":""))),_t=computed(()=>{const Be=d.lang.rtl===!0?e.side:qt.value;return[[TouchPan,Di,void 0,{[Be]:!0,mouse:!0}]]}),si=computed(()=>{const Be=d.lang.rtl===!0?qt.value:e.side;return[[TouchPan,Ci,void 0,{[Be]:!0,mouse:!0}]]}),Li=computed(()=>{const Be=d.lang.rtl===!0?qt.value:e.side;return[[TouchPan,Ci,void 0,{[Be]:!0,mouse:!0,mouseAllDir:!0}]]});function vi(){ct(O,e.behavior==="mobile"||e.behavior!=="desktop"&&T.totalWidth.value<=e.breakpoint)}watch(O,Be=>{Be===!0?(C=j.value,j.value===!0&&_e(!1)):e.overlay===!1&&e.behavior!=="mobile"&&C!==!1&&(j.value===!0?(ci(0),mt(0),dt()):W(!1))}),watch(()=>e.side,(Be,Xt)=>{T.instances[Xt]===ae&&(T.instances[Xt]=void 0,T[Xt].space=!1,T[Xt].offset=0),T.instances[Be]=ae,T[Be].size=G.value,T[Be].space=Qt.value,T[Be].offset=ti.value}),watch(T.totalWidth,()=>{(T.isContainer.value===!0||document.qScrollPrevented!==!0)&&vi()}),watch(()=>e.behavior+e.breakpoint,vi),watch(T.isContainer,Be=>{j.value===!0&&a(Be!==!0),Be===!0&&vi()}),watch(T.scrollbarWidth,()=>{ci(j.value===!0?0:void 0)}),watch(ti,Be=>{ei("offset",Be)}),watch(Qt,Be=>{t("onLayout",Be),ei("space",Be)}),watch(J,()=>{ci()}),watch(G,Be=>{ci(),Ct(e.miniToOverlay,Be)}),watch(()=>e.miniToOverlay,Be=>{Ct(Be,G.value)}),watch(()=>d.lang.rtl,()=>{ci()}),watch(()=>e.mini,()=>{e.modelValue===!0&&(Mi(),T.animate())}),watch(U,Be=>{t("miniState",Be)});function ci(Be){Be===void 0?nextTick(()=>{Be=j.value===!0?0:G.value,ci(se.value*Be)}):(T.isContainer.value===!0&&J.value===!0&&(O.value===!0||Math.abs(Be)===G.value)&&(Be+=se.value*T.scrollbarWidth.value),Ge.value=Be)}function mt(Be){Me.value=Be}function $t(Be){const Xt=Be===!0?"remove":T.isContainer.value!==!0?"add":"";Xt!==""&&document.body.classList[Xt]("q-body--drawer-toggle")}function Mi(){D!==null&&clearTimeout(D),s.proxy&&s.proxy.$el&&s.proxy.$el.classList.add("q-drawer--mini-animate"),We.value=!0,D=setTimeout(()=>{D=null,We.value=!1,s&&s.proxy&&s.proxy.$el&&s.proxy.$el.classList.remove("q-drawer--mini-animate")},150)}function Di(Be){if(j.value!==!1)return;const Xt=G.value,ni=between(Be.distance.x,0,Xt);if(Be.isFinal===!0){ni>=Math.min(75,Xt)===!0?W():(T.animate(),mt(0),ci(se.value*Xt)),Ie.value=!1;return}ci((d.lang.rtl===!0?J.value!==!0:J.value)?Math.max(Xt-ni,0):Math.min(0,ni-Xt)),mt(between(ni/Xt,0,1)),Be.isFirst===!0&&(Ie.value=!0)}function Ci(Be){if(j.value!==!0)return;const Xt=G.value,ni=Be.direction===e.side,Vt=(d.lang.rtl===!0?ni!==!0:ni)?between(Be.distance.x,0,Xt):0;if(Be.isFinal===!0){Math.abs(Vt)<Math.min(75,Xt)===!0?(T.animate(),mt(1),ci(0)):_e(),Ie.value=!1;return}ci(se.value*Vt),mt(between(1-Vt/Xt,0,1)),Be.isFirst===!0&&(Ie.value=!0)}function dt(){a(!1),$t(!0)}function ei(Be,Xt){T.update(e.side,Be,Xt)}function ct(Be,Xt){Be.value!==Xt&&(Be.value=Xt)}function Ct(Be,Xt){ei("size",Be===!0?e.miniWidth:Xt)}return T.instances[e.side]=ae,Ct(e.miniToOverlay,G.value),ei("space",Qt.value),ei("offset",ti.value),e.showIfAbove===!0&&e.modelValue!==!0&&j.value===!0&&e["onUpdate:modelValue"]!==void 0&&t("update:modelValue",!0),onMounted(()=>{t("onLayout",Qt.value),t("miniState",U.value),C=e.showIfAbove===!0;const Be=()=>{(j.value===!0?H:Z)(!1,!0)};if(T.totalWidth.value!==0){nextTick(Be);return}k=watch(T.totalWidth,()=>{k(),k=void 0,j.value===!1&&e.showIfAbove===!0&&O.value===!1?W(!1):Be()})}),onBeforeUnmount(()=>{k!==void 0&&k(),D!==null&&(clearTimeout(D),D=null),j.value===!0&&dt(),T.instances[e.side]===ae&&(T.instances[e.side]=void 0,ei("size",0),ei("offset",0),ei("space",!1))}),()=>{const Be=[];O.value===!0&&(e.noSwipeOpen===!1&&Be.push(withDirectives(h("div",{key:"open",class:`q-drawer__opener fixed-${e.side}`,"aria-hidden":"true"}),_t.value)),Be.push(hDir("div",{ref:"backdrop",class:nt.value,style:Mt.value,"aria-hidden":"true",onClick:_e},void 0,"backdrop",e.noSwipeBackdrop!==!0&&j.value===!0,()=>Li.value)));const Xt=U.value===!0&&r.mini!==void 0,ni=[h("div",{...o,key:""+Xt,class:[yt.value,o.class]},Xt===!0?r.mini():hSlot(r.default))];return e.elevated===!0&&j.value===!0&&ni.push(h("div",{class:"q-layout__shadow absolute-full overflow-hidden no-pointer-events"})),Be.push(hDir("aside",{ref:"content",class:Bt.value,style:Et.value},ni,"contentclose",e.noSwipeClose!==!0&&O.value===!0,()=>si.value)),h("div",{class:"q-drawer-container"},Be)}}});let id=0;const useTabEmits=["click","keydown"],useTabProps={icon:String,label:[Number,String],alert:[Boolean,String],alertIcon:String,name:{type:[Number,String],default:()=>`t_${id++}`},noCaps:Boolean,tabindex:[String,Number],disable:Boolean,contentClass:String,ripple:{type:[Boolean,Object],default:!0}};function useTab(e,r,t,o){const s=inject(tabsKey,emptyRenderFn);if(s===emptyRenderFn)return console.error("QTab/QRouteTab component needs to be child of QTabs"),emptyRenderFn;const{proxy:d}=getCurrentInstance(),g=ref(null),a=ref(null),b=ref(null),_=computed(()=>e.disable===!0||e.ripple===!1?!1:Object.assign({keyCodes:[13,32],early:!0},e.ripple===!0?{}:e.ripple)),T=computed(()=>s.currentModel.value===e.name),C=computed(()=>"q-tab relative-position self-stretch flex flex-center text-center"+(T.value===!0?" q-tab--active"+(s.tabProps.value.activeClass?" "+s.tabProps.value.activeClass:"")+(s.tabProps.value.activeColor?` text-${s.tabProps.value.activeColor}`:"")+(s.tabProps.value.activeBgColor?` bg-${s.tabProps.value.activeBgColor}`:""):" q-tab--inactive")+(e.icon&&e.label&&s.tabProps.value.inlineLabel===!1?" q-tab--full":"")+(e.noCaps===!0||s.tabProps.value.noCaps===!0?" q-tab--no-caps":"")+(e.disable===!0?" disabled":" q-focusable q-hoverable cursor-pointer")+(o!==void 0?o.linkClass.value:"")),D=computed(()=>"q-tab__content self-stretch flex-center relative-position q-anchor--skip non-selectable "+(s.tabProps.value.inlineLabel===!0?"row no-wrap q-tab__content--inline":"column")+(e.contentClass!==void 0?` ${e.contentClass}`:"")),k=computed(()=>e.disable===!0||s.hasFocus.value===!0||T.value===!1&&s.hasActiveTab.value===!0?-1:e.tabindex||0);function O(H,Z){if(Z!==!0&&g.value!==null&&g.value.focus(),e.disable===!0){o!==void 0&&o.hasRouterLink.value===!0&&stopAndPrevent(H);return}if(o===void 0){s.updateModel({name:e.name}),t("click",H);return}if(o.hasRouterLink.value===!0){const W=(_e={})=>{let fe;const re=_e.to===void 0||isDeepEqual(_e.to,e.to)===!0?s.avoidRouteWatcher=uid$1():null;return o.navigateToRouterLink(H,{..._e,returnRouterError:!0}).catch(ae=>{fe=ae}).then(ae=>{if(re===s.avoidRouteWatcher&&(s.avoidRouteWatcher=!1,fe===void 0&&(ae===void 0||ae.message.startsWith("Avoided redundant navigation")===!0)&&s.updateModel({name:e.name})),_e.returnRouterError===!0)return fe!==void 0?Promise.reject(fe):ae})};t("click",H,W),H.defaultPrevented!==!0&&W();return}t("click",H)}function U(H){isKeyCode(H,[13,32])?O(H,!0):shouldIgnoreKey(H)!==!0&&H.keyCode>=35&&H.keyCode<=40&&H.altKey!==!0&&H.metaKey!==!0&&s.onKbdNavigate(H.keyCode,d.$el)===!0&&stopAndPrevent(H),t("keydown",H)}function G(){const H=s.tabProps.value.narrowIndicator,Z=[],W=h("div",{ref:b,class:["q-tab__indicator",s.tabProps.value.indicatorClass]});e.icon!==void 0&&Z.push(h(QIcon,{class:"q-tab__icon",name:e.icon})),e.label!==void 0&&Z.push(h("div",{class:"q-tab__label"},e.label)),e.alert!==!1&&Z.push(e.alertIcon!==void 0?h(QIcon,{class:"q-tab__alert-icon",color:e.alert!==!0?e.alert:void 0,name:e.alertIcon}):h("div",{class:"q-tab__alert"+(e.alert!==!0?` text-${e.alert}`:"")})),H===!0&&Z.push(W);const _e=[h("div",{class:"q-focus-helper",tabindex:-1,ref:g}),h("div",{class:D.value},hMergeSlot(r.default,Z))];return H===!1&&_e.push(W),_e}const j={name:computed(()=>e.name),rootRef:a,tabIndicatorRef:b,routeData:o};onBeforeUnmount(()=>{s.unregisterTab(j)}),onMounted(()=>{s.registerTab(j)});function te(H,Z){const W={ref:a,class:C.value,tabindex:k.value,role:"tab","aria-selected":T.value===!0?"true":"false","aria-disabled":e.disable===!0?"true":void 0,onClick:O,onKeydown:U,...Z};return withDirectives(h(H,W,G()),[[Ripple,_.value]])}return{renderTab:te,$tabs:s}}const QTab=createComponent({name:"QTab",props:useTabProps,emits:useTabEmits,setup(e,{slots:r,emit:t}){const{renderTab:o}=useTab(e,r,t);return()=>o("div")}});let rtlHasScrollBug=!1;{const e=document.createElement("div");e.setAttribute("dir","rtl"),Object.assign(e.style,{width:"1px",height:"1px",overflow:"auto"});const r=document.createElement("div");Object.assign(r.style,{width:"1000px",height:"1px"}),document.body.appendChild(e),e.appendChild(r),e.scrollLeft=-1e3,rtlHasScrollBug=e.scrollLeft>=0,e.remove()}function getIndicatorClass(e,r,t){const o=t===!0?["left","right"]:["top","bottom"];return`absolute-${r===!0?o[0]:o[1]}${e?` text-${e}`:""}`}const alignValues=["left","center","right","justify"],QTabs=createComponent({name:"QTabs",props:{modelValue:[Number,String],align:{type:String,default:"center",validator:e=>alignValues.includes(e)},breakpoint:{type:[String,Number],default:600},vertical:Boolean,shrink:Boolean,stretch:Boolean,activeClass:String,activeColor:String,activeBgColor:String,indicatorColor:String,leftIcon:String,rightIcon:String,outsideArrows:Boolean,mobileArrows:Boolean,switchIndicator:Boolean,narrowIndicator:Boolean,inlineLabel:Boolean,noCaps:Boolean,dense:Boolean,contentClass:String,"onUpdate:modelValue":[Function,Array]},setup(e,{slots:r,emit:t}){const{proxy:o}=getCurrentInstance(),{$q:s}=o,{registerTick:d}=useTick(),{registerTick:g}=useTick(),{registerTick:a}=useTick(),{registerTimeout:b,removeTimeout:_}=useTimeout(),{registerTimeout:T,removeTimeout:C}=useTimeout(),D=ref(null),k=ref(null),O=ref(e.modelValue),U=ref(!1),G=ref(!0),j=ref(!1),te=ref(!1),H=[],Z=ref(0),W=ref(!1);let _e=null,fe=null,re;const ae=computed(()=>({activeClass:e.activeClass,activeColor:e.activeColor,activeBgColor:e.activeBgColor,indicatorClass:getIndicatorClass(e.indicatorColor,e.switchIndicator,e.vertical),narrowIndicator:e.narrowIndicator,inlineLabel:e.inlineLabel,noCaps:e.noCaps})),J=computed(()=>{const ct=Z.value,Ct=O.value;for(let Be=0;Be<ct;Be++)if(H[Be].name.value===Ct)return!0;return!1}),se=computed(()=>`q-tabs__content--align-${U.value===!0?"left":te.value===!0?"justify":e.align}`),Me=computed(()=>`q-tabs row no-wrap items-center q-tabs--${U.value===!0?"":"not-"}scrollable q-tabs--${e.vertical===!0?"vertical":"horizontal"} q-tabs__arrows--${e.outsideArrows===!0?"outside":"inside"} q-tabs--mobile-with${e.mobileArrows===!0?"":"out"}-arrows`+(e.dense===!0?" q-tabs--dense":"")+(e.shrink===!0?" col-shrink":"")+(e.stretch===!0?" self-stretch":"")),Ie=computed(()=>"q-tabs__content scroll--mobile row no-wrap items-center self-stretch hide-scrollbar relative-position "+se.value+(e.contentClass!==void 0?` ${e.contentClass}`:"")),We=computed(()=>e.vertical===!0?{container:"height",content:"offsetHeight",scroll:"scrollHeight"}:{container:"width",content:"offsetWidth",scroll:"scrollWidth"}),Ge=computed(()=>e.vertical!==!0&&s.lang.rtl===!0),qt=computed(()=>rtlHasScrollBug===!1&&Ge.value===!0);watch(Ge,Mt),watch(()=>e.modelValue,ct=>{ti({name:ct,setCurrent:!0,skipEmit:!0})}),watch(()=>e.outsideArrows,Ut);function ti({name:ct,setCurrent:Ct,skipEmit:Be}){O.value!==ct&&(Be!==!0&&e["onUpdate:modelValue"]!==void 0&&t("update:modelValue",ct),(Ct===!0||e["onUpdate:modelValue"]===void 0)&&(tt(O.value,ct),O.value=ct))}function Ut(){d(()=>{Qt({width:D.value.offsetWidth,height:D.value.offsetHeight})})}function Qt(ct){if(We.value===void 0||k.value===null)return;const Ct=ct[We.value.container],Be=Math.min(k.value[We.value.scroll],Array.prototype.reduce.call(k.value.children,(ni,Vt)=>ni+(Vt[We.value.content]||0),0)),Xt=Ct>0&&Be>Ct;U.value=Xt,Xt===!0&&g(Mt),te.value=Ct<parseInt(e.breakpoint,10)}function tt(ct,Ct){const Be=ct!=null&&ct!==""?H.find(ni=>ni.name.value===ct):null,Xt=Ct!=null&&Ct!==""?H.find(ni=>ni.name.value===Ct):null;if(Be&&Xt){const ni=Be.tabIndicatorRef.value,Vt=Xt.tabIndicatorRef.value;_e!==null&&(clearTimeout(_e),_e=null),ni.style.transition="none",ni.style.transform="none",Vt.style.transition="none",Vt.style.transform="none";const Nt=ni.getBoundingClientRect(),mi=Vt.getBoundingClientRect();Vt.style.transform=e.vertical===!0?`translate3d(0,${Nt.top-mi.top}px,0) scale3d(1,${mi.height?Nt.height/mi.height:1},1)`:`translate3d(${Nt.left-mi.left}px,0,0) scale3d(${mi.width?Nt.width/mi.width:1},1,1)`,a(()=>{_e=setTimeout(()=>{_e=null,Vt.style.transition="transform .25s cubic-bezier(.4, 0, .2, 1)",Vt.style.transform="none"},70)})}Xt&&U.value===!0&&nt(Xt.rootRef.value)}function nt(ct){const{left:Ct,width:Be,top:Xt,height:ni}=k.value.getBoundingClientRect(),Vt=ct.getBoundingClientRect();let Nt=e.vertical===!0?Vt.top-Xt:Vt.left-Ct;if(Nt<0){k.value[e.vertical===!0?"scrollTop":"scrollLeft"]+=Math.floor(Nt),Mt();return}Nt+=e.vertical===!0?Vt.height-ni:Vt.width-Be,Nt>0&&(k.value[e.vertical===!0?"scrollTop":"scrollLeft"]+=Math.ceil(Nt),Mt())}function Mt(){const ct=k.value;if(ct===null)return;const Ct=ct.getBoundingClientRect(),Be=e.vertical===!0?ct.scrollTop:Math.abs(ct.scrollLeft);Ge.value===!0?(G.value=Math.ceil(Be+Ct.width)<ct.scrollWidth-1,j.value=Be>0):(G.value=Be>0,j.value=e.vertical===!0?Math.ceil(Be+Ct.height)<ct.scrollHeight:Math.ceil(Be+Ct.width)<ct.scrollWidth)}function ht(ct){fe!==null&&clearInterval(fe),fe=setInterval(()=>{_t(ct)===!0&&Et()},5)}function xt(){ht(qt.value===!0?Number.MAX_SAFE_INTEGER:0)}function It(){ht(qt.value===!0?0:Number.MAX_SAFE_INTEGER)}function Et(){fe!==null&&(clearInterval(fe),fe=null)}function yt(ct,Ct){const Be=Array.prototype.filter.call(k.value.children,mi=>mi===Ct||mi.matches&&mi.matches(".q-tab.q-focusable")===!0),Xt=Be.length;if(Xt===0)return;if(ct===36)return nt(Be[0]),Be[0].focus(),!0;if(ct===35)return nt(Be[Xt-1]),Be[Xt-1].focus(),!0;const ni=ct===(e.vertical===!0?38:37),Vt=ct===(e.vertical===!0?40:39),Nt=ni===!0?-1:Vt===!0?1:void 0;if(Nt!==void 0){const mi=Ge.value===!0?-1:1,ii=Be.indexOf(Ct)+Nt*mi;return ii>=0&&ii<Xt&&(nt(Be[ii]),Be[ii].focus({preventScroll:!0})),!0}}const Bt=computed(()=>qt.value===!0?{get:ct=>Math.abs(ct.scrollLeft),set:(ct,Ct)=>{ct.scrollLeft=-Ct}}:e.vertical===!0?{get:ct=>ct.scrollTop,set:(ct,Ct)=>{ct.scrollTop=Ct}}:{get:ct=>ct.scrollLeft,set:(ct,Ct)=>{ct.scrollLeft=Ct}});function _t(ct){const Ct=k.value,{get:Be,set:Xt}=Bt.value;let ni=!1,Vt=Be(Ct);const Nt=ct<Vt?-1:1;return Vt+=Nt*5,Vt<0?(ni=!0,Vt=0):(Nt===-1&&Vt<=ct||Nt===1&&Vt>=ct)&&(ni=!0,Vt=ct),Xt(Ct,Vt),Mt(),ni}function si(ct,Ct){for(const Be in ct)if(ct[Be]!==Ct[Be])return!1;return!0}function Li(){let ct=null,Ct={matchedLen:0,queryDiff:9999,hrefLen:0};const Be=H.filter(Nt=>Nt.routeData!==void 0&&Nt.routeData.hasRouterLink.value===!0),{hash:Xt,query:ni}=o.$route,Vt=Object.keys(ni).length;for(const Nt of Be){const mi=Nt.routeData.exact.value===!0;if(Nt.routeData[mi===!0?"linkIsExactActive":"linkIsActive"].value!==!0)continue;const{hash:ii,query:Ii,matched:$i,href:Ri}=Nt.routeData.resolvedLink.value,Ni=Object.keys(Ii).length;if(mi===!0){if(ii!==Xt||Ni!==Vt||si(ni,Ii)===!1)continue;ct=Nt.name.value;break}if(ii!==""&&ii!==Xt||Ni!==0&&si(Ii,ni)===!1)continue;const zi={matchedLen:$i.length,queryDiff:Vt-Ni,hrefLen:Ri.length-ii.length};if(zi.matchedLen>Ct.matchedLen){ct=Nt.name.value,Ct=zi;continue}else if(zi.matchedLen!==Ct.matchedLen)continue;if(zi.queryDiff<Ct.queryDiff)ct=Nt.name.value,Ct=zi;else if(zi.queryDiff!==Ct.queryDiff)continue;zi.hrefLen>Ct.hrefLen&&(ct=Nt.name.value,Ct=zi)}ct===null&&H.some(Nt=>Nt.routeData===void 0&&Nt.name.value===O.value)===!0||ti({name:ct,setCurrent:!0})}function vi(ct){if(_(),W.value!==!0&&D.value!==null&&ct.target&&typeof ct.target.closest=="function"){const Ct=ct.target.closest(".q-tab");Ct&&D.value.contains(Ct)===!0&&(W.value=!0,U.value===!0&&nt(Ct))}}function ci(){b(()=>{W.value=!1},30)}function mt(){Ci.avoidRouteWatcher===!1?T(Li):C()}function $t(){if(re===void 0){const ct=watch(()=>o.$route.fullPath,mt);re=()=>{ct(),re=void 0}}}function Mi(ct){H.push(ct),Z.value++,Ut(),ct.routeData===void 0||o.$route===void 0?T(()=>{if(U.value===!0){const Ct=O.value,Be=Ct!=null&&Ct!==""?H.find(Xt=>Xt.name.value===Ct):null;Be&&nt(Be.rootRef.value)}}):($t(),ct.routeData.hasRouterLink.value===!0&&mt())}function Di(ct){H.splice(H.indexOf(ct),1),Z.value--,Ut(),re!==void 0&&ct.routeData!==void 0&&(H.every(Ct=>Ct.routeData===void 0)===!0&&re(),mt())}const Ci={currentModel:O,tabProps:ae,hasFocus:W,hasActiveTab:J,registerTab:Mi,unregisterTab:Di,verifyRouteModel:mt,updateModel:ti,onKbdNavigate:yt,avoidRouteWatcher:!1};provide(tabsKey,Ci);function dt(){_e!==null&&clearTimeout(_e),Et(),re!==void 0&&re()}let ei;return onBeforeUnmount(dt),onDeactivated(()=>{ei=re!==void 0,dt()}),onActivated(()=>{ei===!0&&$t(),Ut()}),()=>h("div",{ref:D,class:Me.value,role:"tablist",onFocusin:vi,onFocusout:ci},[h(QResizeObserver,{onResize:Qt}),h("div",{ref:k,class:Ie.value,onScroll:Mt},hSlot(r.default)),h(QIcon,{class:"q-tabs__arrow q-tabs__arrow--left absolute q-tab__icon"+(G.value===!0?"":" q-tabs__arrow--faded"),name:e.leftIcon||s.iconSet.tabs[e.vertical===!0?"up":"left"],onMousedownPassive:xt,onTouchstartPassive:xt,onMouseupPassive:Et,onMouseleavePassive:Et,onTouchendPassive:Et}),h(QIcon,{class:"q-tabs__arrow q-tabs__arrow--right absolute q-tab__icon"+(j.value===!0?"":" q-tabs__arrow--faded"),name:e.rightIcon||s.iconSet.tabs[e.vertical===!0?"down":"right"],onMousedownPassive:It,onTouchstartPassive:It,onMouseupPassive:Et,onMouseleavePassive:Et,onTouchendPassive:Et})])}});function parseArg(e){const r=[.06,6,50];return typeof e=="string"&&e.length&&e.split(":").forEach((t,o)=>{const s=parseFloat(t);s&&(r[o]=s)}),r}const TouchSwipe=createDirective({name:"touch-swipe",beforeMount(e,{value:r,arg:t,modifiers:o}){if(o.mouse!==!0&&client$1.has.touch!==!0)return;const s=o.mouseCapture===!0?"Capture":"",d={handler:r,sensitivity:parseArg(t),direction:getModifierDirections(o),noop,mouseStart(g){shouldStart(g,d)&&leftClick(g)&&(addEvt(d,"temp",[[document,"mousemove","move",`notPassive${s}`],[document,"mouseup","end","notPassiveCapture"]]),d.start(g,!0))},touchStart(g){if(shouldStart(g,d)){const a=g.target;addEvt(d,"temp",[[a,"touchmove","move","notPassiveCapture"],[a,"touchcancel","end","notPassiveCapture"],[a,"touchend","end","notPassiveCapture"]]),d.start(g)}},start(g,a){client$1.is.firefox===!0&&preventDraggable(e,!0);const b=position(g);d.event={x:b.left,y:b.top,time:Date.now(),mouse:a===!0,dir:!1}},move(g){if(d.event===void 0)return;if(d.event.dir!==!1){stopAndPrevent(g);return}const a=Date.now()-d.event.time;if(a===0)return;const b=position(g),_=b.left-d.event.x,T=Math.abs(_),C=b.top-d.event.y,D=Math.abs(C);if(d.event.mouse!==!0){if(T<d.sensitivity[1]&&D<d.sensitivity[1]){d.end(g);return}}else if(T<d.sensitivity[2]&&D<d.sensitivity[2])return;const k=T/a,O=D/a;d.direction.vertical===!0&&T<D&&T<100&&O>d.sensitivity[0]&&(d.event.dir=C<0?"up":"down"),d.direction.horizontal===!0&&T>D&&D<100&&k>d.sensitivity[0]&&(d.event.dir=_<0?"left":"right"),d.direction.up===!0&&T<D&&C<0&&T<100&&O>d.sensitivity[0]&&(d.event.dir="up"),d.direction.down===!0&&T<D&&C>0&&T<100&&O>d.sensitivity[0]&&(d.event.dir="down"),d.direction.left===!0&&T>D&&_<0&&D<100&&k>d.sensitivity[0]&&(d.event.dir="left"),d.direction.right===!0&&T>D&&_>0&&D<100&&k>d.sensitivity[0]&&(d.event.dir="right"),d.event.dir!==!1?(stopAndPrevent(g),d.event.mouse===!0&&(document.body.classList.add("no-pointer-events--children"),document.body.classList.add("non-selectable"),clearSelection(),d.styleCleanup=U=>{d.styleCleanup=void 0,document.body.classList.remove("non-selectable");const G=()=>{document.body.classList.remove("no-pointer-events--children")};U===!0?setTimeout(G,50):G()}),d.handler({evt:g,touch:d.event.mouse!==!0,mouse:d.event.mouse,direction:d.event.dir,duration:a,distance:{x:T,y:D}})):d.end(g)},end(g){d.event!==void 0&&(cleanEvt(d,"temp"),client$1.is.firefox===!0&&preventDraggable(e,!1),d.styleCleanup!==void 0&&d.styleCleanup(!0),g!==void 0&&d.event.dir!==!1&&stopAndPrevent(g),d.event=void 0)}};if(e.__qtouchswipe=d,o.mouse===!0){const g=o.mouseCapture===!0||o.mousecapture===!0?"Capture":"";addEvt(d,"main",[[e,"mousedown","mouseStart",`passive${g}`]])}client$1.has.touch===!0&&addEvt(d,"main",[[e,"touchstart","touchStart",`passive${o.capture===!0?"Capture":""}`],[e,"touchmove","noop","notPassiveCapture"]])},updated(e,r){const t=e.__qtouchswipe;t!==void 0&&(r.oldValue!==r.value&&(typeof r.value!="function"&&t.end(),t.handler=r.value),t.direction=getModifierDirections(r.modifiers))},beforeUnmount(e){const r=e.__qtouchswipe;r!==void 0&&(cleanEvt(r,"main"),cleanEvt(r,"temp"),client$1.is.firefox===!0&&preventDraggable(e,!1),r.styleCleanup!==void 0&&r.styleCleanup(),delete e.__qtouchswipe)}});function useCache(){const e=new Map;return{getCache:function(r,t){return e[r]===void 0?e[r]=t:e[r]},getCacheWithFn:function(r,t){return e[r]===void 0?e[r]=t():e[r]}}}const usePanelChildProps={name:{required:!0},disable:Boolean},PanelWrapper={setup(e,{slots:r}){return()=>h("div",{class:"q-panel scroll",role:"tabpanel"},hSlot(r.default))}},usePanelProps={modelValue:{required:!0},animated:Boolean,infinite:Boolean,swipeable:Boolean,vertical:Boolean,transitionPrev:String,transitionNext:String,transitionDuration:{type:[String,Number],default:300},keepAlive:Boolean,keepAliveInclude:[String,Array,RegExp],keepAliveExclude:[String,Array,RegExp],keepAliveMax:Number},usePanelEmits=["update:modelValue","beforeTransition","transition"];function usePanel(){const{props:e,emit:r,proxy:t}=getCurrentInstance(),{getCacheWithFn:o}=useCache();let s,d;const g=ref(null),a=ref(null);function b(Ie){const We=e.vertical===!0?"up":"left";fe((t.$q.lang.rtl===!0?-1:1)*(Ie.direction===We?1:-1))}const _=computed(()=>[[TouchSwipe,b,void 0,{horizontal:e.vertical!==!0,vertical:e.vertical,mouse:!0}]]),T=computed(()=>e.transitionPrev||`slide-${e.vertical===!0?"down":"right"}`),C=computed(()=>e.transitionNext||`slide-${e.vertical===!0?"up":"left"}`),D=computed(()=>`--q-transition-duration: ${e.transitionDuration}ms`),k=computed(()=>typeof e.modelValue=="string"||typeof e.modelValue=="number"?e.modelValue:String(e.modelValue)),O=computed(()=>({include:e.keepAliveInclude,exclude:e.keepAliveExclude,max:e.keepAliveMax})),U=computed(()=>e.keepAliveInclude!==void 0||e.keepAliveExclude!==void 0);watch(()=>e.modelValue,(Ie,We)=>{const Ge=H(Ie)===!0?Z(Ie):-1;d!==!0&&_e(Ge===-1?0:Ge<Z(We)?-1:1),g.value!==Ge&&(g.value=Ge,r("beforeTransition",Ie,We),nextTick(()=>{r("transition",Ie,We)}))});function G(){fe(1)}function j(){fe(-1)}function te(Ie){r("update:modelValue",Ie)}function H(Ie){return Ie!=null&&Ie!==""}function Z(Ie){return s.findIndex(We=>We.props.name===Ie&&We.props.disable!==""&&We.props.disable!==!0)}function W(){return s.filter(Ie=>Ie.props.disable!==""&&Ie.props.disable!==!0)}function _e(Ie){const We=Ie!==0&&e.animated===!0&&g.value!==-1?"q-transition--"+(Ie===-1?T.value:C.value):null;a.value!==We&&(a.value=We)}function fe(Ie,We=g.value){let Ge=We+Ie;for(;Ge>-1&&Ge<s.length;){const qt=s[Ge];if(qt!==void 0&&qt.props.disable!==""&&qt.props.disable!==!0){_e(Ie),d=!0,r("update:modelValue",qt.props.name),setTimeout(()=>{d=!1});return}Ge+=Ie}e.infinite===!0&&s.length>0&&We!==-1&&We!==s.length&&fe(Ie,Ie===-1?s.length:-1)}function re(){const Ie=Z(e.modelValue);return g.value!==Ie&&(g.value=Ie),!0}function ae(){const Ie=H(e.modelValue)===!0&&re()&&s[g.value];return e.keepAlive===!0?[h(KeepAlive,O.value,[h(U.value===!0?o(k.value,()=>({...PanelWrapper,name:k.value})):PanelWrapper,{key:k.value,style:D.value},()=>Ie)])]:[h("div",{class:"q-panel scroll",style:D.value,key:k.value,role:"tabpanel"},[Ie])]}function J(){if(s.length!==0)return e.animated===!0?[h(Transition,{name:a.value},ae)]:ae()}function se(Ie){return s=getNormalizedVNodes(hSlot(Ie.default,[])).filter(We=>We.props!==null&&We.props.slot===void 0&&H(We.props.name)===!0),s.length}function Me(){return s}return Object.assign(t,{next:G,previous:j,goTo:te}),{panelIndex:g,panelDirectives:_,updatePanelsList:se,updatePanelIndex:re,getPanelContent:J,getEnabledPanels:W,getPanels:Me,isValidPanelName:H,keepAliveProps:O,needsUniqueKeepAliveWrapper:U,goToPanelByOffset:fe,goToPanel:te,nextPanel:G,previousPanel:j}}const QTabPanel=createComponent({name:"QTabPanel",props:usePanelChildProps,setup(e,{slots:r}){return()=>h("div",{class:"q-tab-panel",role:"tabpanel"},hSlot(r.default))}}),QTd=createComponent({name:"QTd",props:{props:Object,autoWidth:Boolean,noHover:Boolean},setup(e,{slots:r}){const t=getCurrentInstance(),o=computed(()=>"q-td"+(e.autoWidth===!0?" q-table--col-auto-width":"")+(e.noHover===!0?" q-td--no-hover":"")+" ");return()=>{if(e.props===void 0)return h("td",{class:o.value},hSlot(r.default));const s=t.vnode.key,d=(e.props.colsMap!==void 0?e.props.colsMap[s]:null)||e.props.col;if(d===void 0)return;const{row:g}=e.props;return h("td",{class:o.value+d.__tdClass(g),style:d.__tdStyle(g)},hSlot(r.default))}}}),useAnchorProps={target:{default:!0},noParentEvent:Boolean,contextMenu:Boolean};function useAnchor({showing:e,avoidEmit:r,configureAnchorEl:t}){const{props:o,proxy:s,emit:d}=getCurrentInstance(),g=ref(null);let a=null;function b(k){return g.value===null?!1:k===void 0||k.touches===void 0||k.touches.length<=1}const _={};t===void 0&&(Object.assign(_,{hide(k){s.hide(k)},toggle(k){s.toggle(k),k.qAnchorHandled=!0},toggleKey(k){isKeyCode(k,13)===!0&&_.toggle(k)},contextClick(k){s.hide(k),prevent(k),nextTick(()=>{s.show(k),k.qAnchorHandled=!0})},prevent,mobileTouch(k){if(_.mobileCleanup(k),b(k)!==!0)return;s.hide(k),g.value.classList.add("non-selectable");const O=k.target;addEvt(_,"anchor",[[O,"touchmove","mobileCleanup","passive"],[O,"touchend","mobileCleanup","passive"],[O,"touchcancel","mobileCleanup","passive"],[g.value,"contextmenu","prevent","notPassive"]]),a=setTimeout(()=>{a=null,s.show(k),k.qAnchorHandled=!0},300)},mobileCleanup(k){g.value.classList.remove("non-selectable"),a!==null&&(clearTimeout(a),a=null),e.value===!0&&k!==void 0&&clearSelection()}}),t=function(k=o.contextMenu){if(o.noParentEvent===!0||g.value===null)return;let O;k===!0?s.$q.platform.is.mobile===!0?O=[[g.value,"touchstart","mobileTouch","passive"]]:O=[[g.value,"mousedown","hide","passive"],[g.value,"contextmenu","contextClick","notPassive"]]:O=[[g.value,"click","toggle","passive"],[g.value,"keyup","toggleKey","passive"]],addEvt(_,"anchor",O)});function T(){cleanEvt(_,"anchor")}function C(k){for(g.value=k;g.value.classList.contains("q-anchor--skip");)g.value=g.value.parentNode;t()}function D(){if(o.target===!1||o.target===""||s.$el.parentNode===null)g.value=null;else if(o.target===!0)C(s.$el.parentNode);else{let k=o.target;if(typeof o.target=="string")try{k=document.querySelector(o.target)}catch{k=void 0}k!=null?(g.value=k.$el||k,t()):(g.value=null,console.error(`Anchor: target "${o.target}" not found`))}}return watch(()=>o.contextMenu,k=>{g.value!==null&&(T(),t(k))}),watch(()=>o.target,()=>{g.value!==null&&T(),D()}),watch(()=>o.noParentEvent,k=>{g.value!==null&&(k===!0?T():t())}),onMounted(()=>{D(),r!==!0&&o.modelValue===!0&&g.value===null&&d("update:modelValue",!1)}),onBeforeUnmount(()=>{a!==null&&clearTimeout(a),T()}),{anchorEl:g,canShow:b,anchorEvents:_}}function useScrollTarget(e,r){const t=ref(null);let o;function s(a,b){const _=`${b!==void 0?"add":"remove"}EventListener`,T=b!==void 0?b:o;a!==window&&a[_]("scroll",T,listenOpts.passive),window[_]("scroll",T,listenOpts.passive),o=b}function d(){t.value!==null&&(s(t.value),t.value=null)}const g=watch(()=>e.noParentEvent,()=>{t.value!==null&&(d(),r())});return onBeforeUnmount(g),{localScrollTarget:t,unconfigureScrollTarget:d,changeScrollEvent:s}}const{notPassiveCapture}=listenOpts,registeredList=[];function globalHandler(e){const r=e.target;if(r===void 0||r.nodeType===8||r.classList.contains("no-pointer-events")===!0)return;let t=portalProxyList.length-1;for(;t>=0;){const o=portalProxyList[t].$;if(o.type.name!=="QDialog")break;if(o.props.seamless!==!0)return;t--}for(let o=registeredList.length-1;o>=0;o--){const s=registeredList[o];if((s.anchorEl.value===null||s.anchorEl.value.contains(r)===!1)&&(r===document.body||s.innerRef.value!==null&&s.innerRef.value.contains(r)===!1))e.qClickOutside=!0,s.onClickOutside(e);else return}}function addClickOutside(e){registeredList.push(e),registeredList.length===1&&(document.addEventListener("mousedown",globalHandler,notPassiveCapture),document.addEventListener("touchstart",globalHandler,notPassiveCapture))}function removeClickOutside(e){const r=registeredList.findIndex(t=>t===e);r>-1&&(registeredList.splice(r,1),registeredList.length===0&&(document.removeEventListener("mousedown",globalHandler,notPassiveCapture),document.removeEventListener("touchstart",globalHandler,notPassiveCapture)))}let vpLeft,vpTop;function validatePosition(e){const r=e.split(" ");return r.length!==2?!1:["top","center","bottom"].includes(r[0])!==!0?(console.error("Anchor/Self position must start with one of top/center/bottom"),!1):["left","middle","right","start","end"].includes(r[1])!==!0?(console.error("Anchor/Self position must end with one of left/middle/right/start/end"),!1):!0}function validateOffset(e){return e?!(e.length!==2||typeof e[0]!="number"||typeof e[1]!="number"):!0}const horizontalPos={"start#ltr":"left","start#rtl":"right","end#ltr":"right","end#rtl":"left"};["left","middle","right"].forEach(e=>{horizontalPos[`${e}#ltr`]=e,horizontalPos[`${e}#rtl`]=e});function parsePosition(e,r){const t=e.split(" ");return{vertical:t[0],horizontal:horizontalPos[`${t[1]}#${r===!0?"rtl":"ltr"}`]}}function getAnchorProps(e,r){let{top:t,left:o,right:s,bottom:d,width:g,height:a}=e.getBoundingClientRect();return r!==void 0&&(t-=r[1],o-=r[0],d+=r[1],s+=r[0],g+=r[0],a+=r[1]),{top:t,bottom:d,height:a,left:o,right:s,width:g,middle:o+(s-o)/2,center:t+(d-t)/2}}function getAbsoluteAnchorProps(e,r,t){let{top:o,left:s}=e.getBoundingClientRect();return o+=r.top,s+=r.left,t!==void 0&&(o+=t[1],s+=t[0]),{top:o,bottom:o+1,height:1,left:s,right:s+1,width:1,middle:s,center:o}}function getTargetProps(e){return{top:0,center:e.offsetHeight/2,bottom:e.offsetHeight,left:0,middle:e.offsetWidth/2,right:e.offsetWidth}}function getTopLeftProps(e,r,t){return{top:e[t.anchorOrigin.vertical]-r[t.selfOrigin.vertical],left:e[t.anchorOrigin.horizontal]-r[t.selfOrigin.horizontal]}}function setPosition(e){if(client$1.is.ios===!0&&window.visualViewport!==void 0){const a=document.body.style,{offsetLeft:b,offsetTop:_}=window.visualViewport;b!==vpLeft&&(a.setProperty("--q-pe-left",b+"px"),vpLeft=b),_!==vpTop&&(a.setProperty("--q-pe-top",_+"px"),vpTop=_)}const{scrollLeft:r,scrollTop:t}=e.el,o=e.absoluteOffset===void 0?getAnchorProps(e.anchorEl,e.cover===!0?[0,0]:e.offset):getAbsoluteAnchorProps(e.anchorEl,e.absoluteOffset,e.offset);let s={maxHeight:e.maxHeight,maxWidth:e.maxWidth,visibility:"visible"};(e.fit===!0||e.cover===!0)&&(s.minWidth=o.width+"px",e.cover===!0&&(s.minHeight=o.height+"px")),Object.assign(e.el.style,s);const d=getTargetProps(e.el);let g=getTopLeftProps(o,d,e);if(e.absoluteOffset===void 0||e.offset===void 0)applyBoundaries(g,o,d,e.anchorOrigin,e.selfOrigin);else{const{top:a,left:b}=g;applyBoundaries(g,o,d,e.anchorOrigin,e.selfOrigin);let _=!1;if(g.top!==a){_=!0;const T=2*e.offset[1];o.center=o.top-=T,o.bottom-=T+2}if(g.left!==b){_=!0;const T=2*e.offset[0];o.middle=o.left-=T,o.right-=T+2}_===!0&&(g=getTopLeftProps(o,d,e),applyBoundaries(g,o,d,e.anchorOrigin,e.selfOrigin))}s={top:g.top+"px",left:g.left+"px"},g.maxHeight!==void 0&&(s.maxHeight=g.maxHeight+"px",o.height>g.maxHeight&&(s.minHeight=s.maxHeight)),g.maxWidth!==void 0&&(s.maxWidth=g.maxWidth+"px",o.width>g.maxWidth&&(s.minWidth=s.maxWidth)),Object.assign(e.el.style,s),e.el.scrollTop!==t&&(e.el.scrollTop=t),e.el.scrollLeft!==r&&(e.el.scrollLeft=r)}function applyBoundaries(e,r,t,o,s){const d=t.bottom,g=t.right,a=getScrollbarWidth(),b=window.innerHeight-a,_=document.body.clientWidth;if(e.top<0||e.top+d>b)if(s.vertical==="center")e.top=r[o.vertical]>b/2?Math.max(0,b-d):0,e.maxHeight=Math.min(d,b);else if(r[o.vertical]>b/2){const T=Math.min(b,o.vertical==="center"?r.center:o.vertical===s.vertical?r.bottom:r.top);e.maxHeight=Math.min(d,T),e.top=Math.max(0,T-d)}else e.top=Math.max(0,o.vertical==="center"?r.center:o.vertical===s.vertical?r.top:r.bottom),e.maxHeight=Math.min(d,b-e.top);if(e.left<0||e.left+g>_)if(e.maxWidth=Math.min(g,_),s.horizontal==="middle")e.left=r[o.horizontal]>_/2?Math.max(0,_-g):0;else if(r[o.horizontal]>_/2){const T=Math.min(_,o.horizontal==="middle"?r.middle:o.horizontal===s.horizontal?r.right:r.left);e.maxWidth=Math.min(g,T),e.left=Math.max(0,T-e.maxWidth)}else e.left=Math.max(0,o.horizontal==="middle"?r.middle:o.horizontal===s.horizontal?r.left:r.right),e.maxWidth=Math.min(g,_-e.left)}const QMenu=createComponent({name:"QMenu",inheritAttrs:!1,props:{...useAnchorProps,...useModelToggleProps,...useDarkProps,...useTransitionProps,persistent:Boolean,autoClose:Boolean,separateClosePopup:Boolean,noRouteDismiss:Boolean,noRefocus:Boolean,noFocus:Boolean,fit:Boolean,cover:Boolean,square:Boolean,anchor:{type:String,validator:validatePosition},self:{type:String,validator:validatePosition},offset:{type:Array,validator:validateOffset},scrollTarget:{default:void 0},touchPosition:Boolean,maxHeight:{type:String,default:null},maxWidth:{type:String,default:null}},emits:[...useModelToggleEmits,"click","escapeKey"],setup(e,{slots:r,emit:t,attrs:o}){let s=null,d,g,a;const b=getCurrentInstance(),{proxy:_}=b,{$q:T}=_,C=ref(null),D=ref(!1),k=computed(()=>e.persistent!==!0&&e.noRouteDismiss!==!0),O=useDark(e,T),{registerTick:U,removeTick:G}=useTick(),{registerTimeout:j}=useTimeout(),{transitionProps:te,transitionStyle:H}=useTransition(e),{localScrollTarget:Z,changeScrollEvent:W,unconfigureScrollTarget:_e}=useScrollTarget(e,ht),{anchorEl:fe,canShow:re}=useAnchor({showing:D}),{hide:ae}=useModelToggle({showing:D,canShow:re,handleShow:tt,handleHide:nt,hideOnRouteChange:k,processOnMount:!0}),{showPortal:J,hidePortal:se,renderPortal:Me}=usePortal(b,C,Bt,"menu"),Ie={anchorEl:fe,innerRef:C,onClickOutside(_t){if(e.persistent!==!0&&D.value===!0)return ae(_t),(_t.type==="touchstart"||_t.target.classList.contains("q-dialog__backdrop"))&&stopAndPrevent(_t),!0}},We=computed(()=>parsePosition(e.anchor||(e.cover===!0?"center middle":"bottom start"),T.lang.rtl)),Ge=computed(()=>e.cover===!0?We.value:parsePosition(e.self||"top start",T.lang.rtl)),qt=computed(()=>(e.square===!0?" q-menu--square":"")+(O.value===!0?" q-menu--dark q-dark":"")),ti=computed(()=>e.autoClose===!0?{onClick:xt}:{}),Ut=computed(()=>D.value===!0&&e.persistent!==!0);watch(Ut,_t=>{_t===!0?(addEscapeKey(Et),addClickOutside(Ie)):(removeEscapeKey(Et),removeClickOutside(Ie))});function Qt(){addFocusFn(()=>{let _t=C.value;_t&&_t.contains(document.activeElement)!==!0&&(_t=_t.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||_t.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||_t.querySelector("[autofocus], [data-autofocus]")||_t,_t.focus({preventScroll:!0}))})}function tt(_t){if(s=e.noRefocus===!1?document.activeElement:null,addFocusout(It),J(),ht(),d=void 0,_t!==void 0&&(e.touchPosition||e.contextMenu)){const si=position(_t);if(si.left!==void 0){const{top:Li,left:vi}=fe.value.getBoundingClientRect();d={left:si.left-vi,top:si.top-Li}}}g===void 0&&(g=watch(()=>T.screen.width+"|"+T.screen.height+"|"+e.self+"|"+e.anchor+"|"+T.lang.rtl,yt)),e.noFocus!==!0&&document.activeElement.blur(),U(()=>{yt(),e.noFocus!==!0&&Qt()}),j(()=>{T.platform.is.ios===!0&&(a=e.autoClose,C.value.click()),yt(),J(!0),t("show",_t)},e.transitionDuration)}function nt(_t){G(),se(),Mt(!0),s!==null&&(_t===void 0||_t.qClickOutside!==!0)&&(((_t&&_t.type.indexOf("key")===0?s.closest('[tabindex]:not([tabindex^="-"])'):void 0)||s).focus(),s=null),j(()=>{se(!0),t("hide",_t)},e.transitionDuration)}function Mt(_t){d=void 0,g!==void 0&&(g(),g=void 0),(_t===!0||D.value===!0)&&(removeFocusout(It),_e(),removeClickOutside(Ie),removeEscapeKey(Et)),_t!==!0&&(s=null)}function ht(){(fe.value!==null||e.scrollTarget!==void 0)&&(Z.value=getScrollTarget(fe.value,e.scrollTarget),W(Z.value,yt))}function xt(_t){a!==!0?(closePortalMenus(_,_t),t("click",_t)):a=!1}function It(_t){Ut.value===!0&&e.noFocus!==!0&&childHasFocus(C.value,_t.target)!==!0&&Qt()}function Et(_t){t("escapeKey"),ae(_t)}function yt(){const _t=C.value;_t===null||fe.value===null||setPosition({el:_t,offset:e.offset,anchorEl:fe.value,anchorOrigin:We.value,selfOrigin:Ge.value,absoluteOffset:d,fit:e.fit,cover:e.cover,maxHeight:e.maxHeight,maxWidth:e.maxWidth})}function Bt(){return h(Transition,te.value,()=>D.value===!0?h("div",{role:"menu",...o,ref:C,tabindex:-1,class:["q-menu q-position-engine scroll"+qt.value,o.class],style:[o.style,H.value],...ti.value},hSlot(r.default)):null)}return onBeforeUnmount(Mt),Object.assign(_,{focus:Qt,updatePosition:yt}),Me}});function cloneDeep(e,r=new WeakMap){if(Object(e)!==e)return e;if(r.has(e))return r.get(e);const t=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):e instanceof Set?new Set:e instanceof Map?new Map:typeof e.constructor!="function"?Object.create(null):e.prototype!==void 0&&typeof e.prototype.constructor=="function"?e:new e.constructor;if(typeof e.constructor=="function"&&typeof e.valueOf=="function"){const o=e.valueOf();if(Object(o)!==o){const s=new e.constructor(o);return r.set(e,s),s}}return r.set(e,t),e instanceof Set?e.forEach(o=>{t.add(cloneDeep(o,r))}):e instanceof Map&&e.forEach((o,s)=>{t.set(s,cloneDeep(o,r))}),Object.assign(t,...Object.keys(e).map(o=>({[o]:cloneDeep(e[o],r)})))}const QPopupEdit=createComponent({name:"QPopupEdit",props:{modelValue:{required:!0},title:String,buttons:Boolean,labelSet:String,labelCancel:String,color:{type:String,default:"primary"},validate:{type:Function,default:()=>!0},autoSave:Boolean,cover:{type:Boolean,default:!0},disable:Boolean},emits:["update:modelValue","save","cancel","beforeShow","show","beforeHide","hide"],setup(e,{slots:r,emit:t}){const{proxy:o}=getCurrentInstance(),{$q:s}=o,d=ref(null),g=ref(""),a=ref("");let b=!1;const _=computed(()=>injectProp({initialValue:g.value,validate:e.validate,set:T,cancel:C,updatePosition:D},"value",()=>a.value,Z=>{a.value=Z}));function T(){e.validate(a.value)!==!1&&(k()===!0&&(t("save",a.value,g.value),t("update:modelValue",a.value)),O())}function C(){k()===!0&&t("cancel",a.value,g.value),O()}function D(){nextTick(()=>{d.value.updatePosition()})}function k(){return isDeepEqual(a.value,g.value)===!1}function O(){b=!0,d.value.hide()}function U(){b=!1,g.value=cloneDeep(e.modelValue),a.value=cloneDeep(e.modelValue),t("beforeShow")}function G(){t("show")}function j(){b===!1&&k()===!0&&(e.autoSave===!0&&e.validate(a.value)===!0?(t("save",a.value,g.value),t("update:modelValue",a.value)):t("cancel",a.value,g.value)),t("beforeHide")}function te(){t("hide")}function H(){const Z=r.default!==void 0?[].concat(r.default(_.value)):[];return e.title&&Z.unshift(h("div",{class:"q-dialog__title q-mt-sm q-mb-sm"},e.title)),e.buttons===!0&&Z.push(h("div",{class:"q-popup-edit__buttons row justify-center no-wrap"},[h(QBtn,{flat:!0,color:e.color,label:e.labelCancel||s.lang.label.cancel,onClick:C}),h(QBtn,{flat:!0,color:e.color,label:e.labelSet||s.lang.label.set,onClick:T})])),Z}return Object.assign(o,{set:T,cancel:C,show(Z){d.value!==null&&d.value.show(Z)},hide(Z){d.value!==null&&d.value.hide(Z)},updatePosition:D}),()=>{if(e.disable!==!0)return h(QMenu,{ref:d,class:"q-popup-edit",cover:e.cover,onBeforeShow:U,onShow:G,onBeforeHide:j,onHide:te,onEscapeKey:C},H)}}}),QTr=createComponent({name:"QTr",props:{props:Object,noHover:Boolean},setup(e,{slots:r}){const t=computed(()=>"q-tr"+(e.props===void 0||e.props.header===!0?"":" "+e.props.__trClass)+(e.noHover===!0?" q-tr--no-hover":""));return()=>h("tr",{class:t.value},hSlot(r.default))}}),QTh=createComponent({name:"QTh",props:{props:Object,autoWidth:Boolean},emits:["click"],setup(e,{slots:r,emit:t}){const o=getCurrentInstance(),{proxy:{$q:s}}=o,d=g=>{t("click",g)};return()=>{if(e.props===void 0)return h("th",{class:e.autoWidth===!0?"q-table--col-auto-width":"",onClick:d},hSlot(r.default));let g,a;const b=o.vnode.key;if(b){if(g=e.props.colsMap[b],g===void 0)return}else g=e.props.col;if(g.sortable===!0){const T=g.align==="right"?"unshift":"push";a=hUniqueSlot(r.default,[]),a[T](h(QIcon,{class:g.__iconClass,name:s.iconSet.table.arrowUp}))}else a=hSlot(r.default);const _={class:g.__thClass+(e.autoWidth===!0?" q-table--col-auto-width":""),style:g.headerStyle,onClick:T=>{g.sortable===!0&&e.props.sort(g),d(T)}};return h("th",_,a)}}}),QList=createComponent({name:"QList",props:{...useDarkProps,bordered:Boolean,dense:Boolean,separator:Boolean,padding:Boolean,tag:{type:String,default:"div"}},setup(e,{slots:r}){const t=getCurrentInstance(),o=useDark(e,t.proxy.$q),s=computed(()=>"q-list"+(e.bordered===!0?" q-list--bordered":"")+(e.dense===!0?" q-list--dense":"")+(e.separator===!0?" q-list--separator":"")+(o.value===!0?" q-list--dark":"")+(e.padding===!0?" q-list--padding":""));return()=>h(e.tag,{class:s.value},hSlot(r.default))}}),separatorValues=["horizontal","vertical","cell","none"],QMarkupTable=createComponent({name:"QMarkupTable",props:{...useDarkProps,dense:Boolean,flat:Boolean,bordered:Boolean,square:Boolean,wrapCells:Boolean,separator:{type:String,default:"horizontal",validator:e=>separatorValues.includes(e)}},setup(e,{slots:r}){const t=getCurrentInstance(),o=useDark(e,t.proxy.$q),s=computed(()=>`q-markup-table q-table__container q-table__card q-table--${e.separator}-separator`+(o.value===!0?" q-table--dark q-table__card--dark q-dark":"")+(e.dense===!0?" q-table--dense":"")+(e.flat===!0?" q-table--flat":"")+(e.bordered===!0?" q-table--bordered":"")+(e.square===!0?" q-table--square":"")+(e.wrapCells===!1?" q-table--no-wrap":""));return()=>h("div",{class:s.value},[h("table",{class:"q-table"},hSlot(r.default))])}});function getTableMiddle(e,r){return h("div",e,[h("table",{class:"q-table"},r)])}const aggBucketSize=1e3,scrollToEdges=["start","center","end","start-force","center-force","end-force"],filterProto=Array.prototype.filter,setOverflowAnchor=window.getComputedStyle(document.body).overflowAnchor===void 0?noop:function(e,r){e!==null&&(e._qOverflowAnimationFrame!==void 0&&cancelAnimationFrame(e._qOverflowAnimationFrame),e._qOverflowAnimationFrame=requestAnimationFrame(()=>{if(e===null)return;e._qOverflowAnimationFrame=void 0;const t=e.children||[];filterProto.call(t,s=>s.dataset&&s.dataset.qVsAnchor!==void 0).forEach(s=>{delete s.dataset.qVsAnchor});const o=t[r];o&&o.dataset&&(o.dataset.qVsAnchor="")}))};function sumFn(e,r){return e+r}function getScrollDetails(e,r,t,o,s,d,g,a){const b=e===window?document.scrollingElement||document.documentElement:e,_=s===!0?"offsetWidth":"offsetHeight",T={scrollStart:0,scrollViewSize:-g-a,scrollMaxSize:0,offsetStart:-g,offsetEnd:-a};if(s===!0?(e===window?(T.scrollStart=window.pageXOffset||window.scrollX||document.body.scrollLeft||0,T.scrollViewSize+=document.documentElement.clientWidth):(T.scrollStart=b.scrollLeft,T.scrollViewSize+=b.clientWidth),T.scrollMaxSize=b.scrollWidth,d===!0&&(T.scrollStart=(rtlHasScrollBug===!0?T.scrollMaxSize-T.scrollViewSize:0)-T.scrollStart)):(e===window?(T.scrollStart=window.pageYOffset||window.scrollY||document.body.scrollTop||0,T.scrollViewSize+=document.documentElement.clientHeight):(T.scrollStart=b.scrollTop,T.scrollViewSize+=b.clientHeight),T.scrollMaxSize=b.scrollHeight),t!==null)for(let C=t.previousElementSibling;C!==null;C=C.previousElementSibling)C.classList.contains("q-virtual-scroll--skip")===!1&&(T.offsetStart+=C[_]);if(o!==null)for(let C=o.nextElementSibling;C!==null;C=C.nextElementSibling)C.classList.contains("q-virtual-scroll--skip")===!1&&(T.offsetEnd+=C[_]);if(r!==e){const C=b.getBoundingClientRect(),D=r.getBoundingClientRect();s===!0?(T.offsetStart+=D.left-C.left,T.offsetEnd-=D.width):(T.offsetStart+=D.top-C.top,T.offsetEnd-=D.height),e!==window&&(T.offsetStart+=T.scrollStart),T.offsetEnd+=T.scrollMaxSize-T.offsetStart}return T}function setScroll(e,r,t,o){r==="end"&&(r=(e===window?document.body:e)[t===!0?"scrollWidth":"scrollHeight"]),e===window?t===!0?(o===!0&&(r=(rtlHasScrollBug===!0?document.body.scrollWidth-document.documentElement.clientWidth:0)-r),window.scrollTo(r,window.pageYOffset||window.scrollY||document.body.scrollTop||0)):window.scrollTo(window.pageXOffset||window.scrollX||document.body.scrollLeft||0,r):t===!0?(o===!0&&(r=(rtlHasScrollBug===!0?e.scrollWidth-e.offsetWidth:0)-r),e.scrollLeft=r):e.scrollTop=r}function sumSize(e,r,t,o){if(t>=o)return 0;const s=r.length,d=Math.floor(t/aggBucketSize),g=Math.floor((o-1)/aggBucketSize)+1;let a=e.slice(d,g).reduce(sumFn,0);return t%aggBucketSize!==0&&(a-=r.slice(d*aggBucketSize,t).reduce(sumFn,0)),o%aggBucketSize!==0&&o!==s&&(a-=r.slice(o,g*aggBucketSize).reduce(sumFn,0)),a}const commonVirtScrollProps={virtualScrollSliceSize:{type:[Number,String],default:null},virtualScrollSliceRatioBefore:{type:[Number,String],default:1},virtualScrollSliceRatioAfter:{type:[Number,String],default:1},virtualScrollItemSize:{type:[Number,String],default:24},virtualScrollStickySizeStart:{type:[Number,String],default:0},virtualScrollStickySizeEnd:{type:[Number,String],default:0},tableColspan:[Number,String]},commonVirtPropsList=Object.keys(commonVirtScrollProps),useVirtualScrollProps={virtualScrollHorizontal:Boolean,onVirtualScroll:Function,...commonVirtScrollProps};function useVirtualScroll({virtualScrollLength:e,getVirtualScrollTarget:r,getVirtualScrollEl:t,virtualScrollItemSizeComputed:o}){const s=getCurrentInstance(),{props:d,emit:g,proxy:a}=s,{$q:b}=a;let _,T,C,D=[],k;const O=ref(0),U=ref(0),G=ref({}),j=ref(null),te=ref(null),H=ref(null),Z=ref({from:0,to:0}),W=computed(()=>d.tableColspan!==void 0?d.tableColspan:100);o===void 0&&(o=computed(()=>d.virtualScrollItemSize));const _e=computed(()=>o.value+";"+d.virtualScrollHorizontal),fe=computed(()=>_e.value+";"+d.virtualScrollSliceRatioBefore+";"+d.virtualScrollSliceRatioAfter);watch(fe,()=>{qt()}),watch(_e,re);function re(){Ge(T,!0)}function ae(nt){Ge(nt===void 0?T:nt)}function J(nt,Mt){const ht=r();if(ht==null||ht.nodeType===8)return;const xt=getScrollDetails(ht,t(),j.value,te.value,d.virtualScrollHorizontal,b.lang.rtl,d.virtualScrollStickySizeStart,d.virtualScrollStickySizeEnd);C!==xt.scrollViewSize&&qt(xt.scrollViewSize),Me(ht,xt,Math.min(e.value-1,Math.max(0,parseInt(nt,10)||0)),0,scrollToEdges.indexOf(Mt)>-1?Mt:T>-1&&nt>T?"end":"start")}function se(){const nt=r();if(nt==null||nt.nodeType===8)return;const Mt=getScrollDetails(nt,t(),j.value,te.value,d.virtualScrollHorizontal,b.lang.rtl,d.virtualScrollStickySizeStart,d.virtualScrollStickySizeEnd),ht=e.value-1,xt=Mt.scrollMaxSize-Mt.offsetStart-Mt.offsetEnd-U.value;if(_===Mt.scrollStart)return;if(Mt.scrollMaxSize<=0){Me(nt,Mt,0,0);return}C!==Mt.scrollViewSize&&qt(Mt.scrollViewSize),Ie(Z.value.from);const It=Math.floor(Mt.scrollMaxSize-Math.max(Mt.scrollViewSize,Mt.offsetEnd)-Math.min(k[ht],Mt.scrollViewSize/2));if(It>0&&Math.ceil(Mt.scrollStart)>=It){Me(nt,Mt,ht,Mt.scrollMaxSize-Mt.offsetEnd-D.reduce(sumFn,0));return}let Et=0,yt=Mt.scrollStart-Mt.offsetStart,Bt=yt;if(yt<=xt&&yt+Mt.scrollViewSize>=O.value)yt-=O.value,Et=Z.value.from,Bt=yt;else for(let _t=0;yt>=D[_t]&&Et<ht;_t++)yt-=D[_t],Et+=aggBucketSize;for(;yt>0&&Et<ht;)yt-=k[Et],yt>-Mt.scrollViewSize?(Et++,Bt=yt):Bt=k[Et]+yt;Me(nt,Mt,Et,Bt)}function Me(nt,Mt,ht,xt,It){const Et=typeof It=="string"&&It.indexOf("-force")>-1,yt=Et===!0?It.replace("-force",""):It,Bt=yt!==void 0?yt:"start";let _t=Math.max(0,ht-G.value[Bt]),si=_t+G.value.total;si>e.value&&(si=e.value,_t=Math.max(0,si-G.value.total)),_=Mt.scrollStart;const Li=_t!==Z.value.from||si!==Z.value.to;if(Li===!1&&yt===void 0){Ut(ht);return}const{activeElement:vi}=document,ci=H.value;Li===!0&&ci!==null&&ci!==vi&&ci.contains(vi)===!0&&(ci.addEventListener("focusout",We),setTimeout(()=>{ci!==null&&ci.removeEventListener("focusout",We)})),setOverflowAnchor(ci,ht-_t);const mt=yt!==void 0?k.slice(_t,ht).reduce(sumFn,0):0;if(Li===!0){const $t=si>=Z.value.from&&_t<=Z.value.to?Z.value.to:si;Z.value={from:_t,to:$t},O.value=sumSize(D,k,0,_t),U.value=sumSize(D,k,si,e.value),requestAnimationFrame(()=>{Z.value.to!==si&&_===Mt.scrollStart&&(Z.value={from:Z.value.from,to:si},U.value=sumSize(D,k,si,e.value))})}requestAnimationFrame(()=>{if(_!==Mt.scrollStart)return;Li===!0&&Ie(_t);const $t=k.slice(_t,ht).reduce(sumFn,0),Mi=$t+Mt.offsetStart+O.value,Di=Mi+k[ht];let Ci=Mi+xt;if(yt!==void 0){const dt=$t-mt,ei=Mt.scrollStart+dt;Ci=Et!==!0&&ei<Mi&&Di<ei+Mt.scrollViewSize?ei:yt==="end"?Di-Mt.scrollViewSize:Mi-(yt==="start"?0:Math.round((Mt.scrollViewSize-k[ht])/2))}_=Ci,setScroll(nt,Ci,d.virtualScrollHorizontal,b.lang.rtl),Ut(ht)})}function Ie(nt){const Mt=H.value;if(Mt){const ht=filterProto.call(Mt.children,_t=>_t.classList&&_t.classList.contains("q-virtual-scroll--skip")===!1),xt=ht.length,It=d.virtualScrollHorizontal===!0?_t=>_t.getBoundingClientRect().width:_t=>_t.offsetHeight;let Et=nt,yt,Bt;for(let _t=0;_t<xt;){for(yt=It(ht[_t]),_t++;_t<xt&&ht[_t].classList.contains("q-virtual-scroll--with-prev")===!0;)yt+=It(ht[_t]),_t++;Bt=yt-k[Et],Bt!==0&&(k[Et]+=Bt,D[Math.floor(Et/aggBucketSize)]+=Bt),Et++}}}function We(){H.value!==null&&H.value!==void 0&&H.value.focus()}function Ge(nt,Mt){const ht=1*o.value;(Mt===!0||Array.isArray(k)===!1)&&(k=[]);const xt=k.length;k.length=e.value;for(let Et=e.value-1;Et>=xt;Et--)k[Et]=ht;const It=Math.floor((e.value-1)/aggBucketSize);D=[];for(let Et=0;Et<=It;Et++){let yt=0;const Bt=Math.min((Et+1)*aggBucketSize,e.value);for(let _t=Et*aggBucketSize;_t<Bt;_t++)yt+=k[_t];D.push(yt)}T=-1,_=void 0,O.value=sumSize(D,k,0,Z.value.from),U.value=sumSize(D,k,Z.value.to,e.value),nt>=0?(Ie(Z.value.from),nextTick(()=>{J(nt)})):Qt()}function qt(nt){if(nt===void 0&&typeof window<"u"){const yt=r();yt!=null&&yt.nodeType!==8&&(nt=getScrollDetails(yt,t(),j.value,te.value,d.virtualScrollHorizontal,b.lang.rtl,d.virtualScrollStickySizeStart,d.virtualScrollStickySizeEnd).scrollViewSize)}C=nt;const Mt=parseFloat(d.virtualScrollSliceRatioBefore)||0,ht=parseFloat(d.virtualScrollSliceRatioAfter)||0,xt=1+Mt+ht,It=nt===void 0||nt<=0?1:Math.ceil(nt/o.value),Et=Math.max(1,It,Math.ceil((d.virtualScrollSliceSize>0?d.virtualScrollSliceSize:10)/xt));G.value={total:Math.ceil(Et*xt),start:Math.ceil(Et*Mt),center:Math.ceil(Et*(.5+Mt)),end:Math.ceil(Et*(1+Mt)),view:It}}function ti(nt,Mt){const ht=d.virtualScrollHorizontal===!0?"width":"height",xt={["--q-virtual-scroll-item-"+ht]:o.value+"px"};return[nt==="tbody"?h(nt,{class:"q-virtual-scroll__padding",key:"before",ref:j},[h("tr",[h("td",{style:{[ht]:`${O.value}px`,...xt},colspan:W.value})])]):h(nt,{class:"q-virtual-scroll__padding",key:"before",ref:j,style:{[ht]:`${O.value}px`,...xt}}),h(nt,{class:"q-virtual-scroll__content",key:"content",ref:H,tabindex:-1},Mt.flat()),nt==="tbody"?h(nt,{class:"q-virtual-scroll__padding",key:"after",ref:te},[h("tr",[h("td",{style:{[ht]:`${U.value}px`,...xt},colspan:W.value})])]):h(nt,{class:"q-virtual-scroll__padding",key:"after",ref:te,style:{[ht]:`${U.value}px`,...xt}})]}function Ut(nt){T!==nt&&(d.onVirtualScroll!==void 0&&g("virtualScroll",{index:nt,from:Z.value.from,to:Z.value.to-1,direction:nt<T?"decrease":"increase",ref:a}),T=nt)}qt();const Qt=debounce$2(se,b.platform.is.ios===!0?120:35);onBeforeMount(()=>{qt()});let tt=!1;return onDeactivated(()=>{tt=!0}),onActivated(()=>{if(tt!==!0)return;const nt=r();_!==void 0&&nt!==void 0&&nt!==null&&nt.nodeType!==8?setScroll(nt,_,d.virtualScrollHorizontal,b.lang.rtl):J(T)}),onBeforeUnmount(()=>{Qt.cancel()}),Object.assign(a,{scrollTo:J,reset:re,refresh:ae}),{virtualScrollSliceRange:Z,virtualScrollSliceSizeComputed:G,setVirtualScrollSize:qt,onVirtualScrollEvt:Qt,localResetVirtualScroll:Ge,padVirtualScroll:ti,scrollTo:J,reset:re,refresh:ae}}const comps={list:QList,table:QMarkupTable},typeOptions=["list","table","__qtable"],QVirtualScroll=createComponent({name:"QVirtualScroll",props:{...useVirtualScrollProps,type:{type:String,default:"list",validator:e=>typeOptions.includes(e)},items:{type:Array,default:()=>[]},itemsFn:Function,itemsSize:Number,scrollTarget:{default:void 0}},setup(e,{slots:r,attrs:t}){let o;const s=ref(null),d=computed(()=>e.itemsSize>=0&&e.itemsFn!==void 0?parseInt(e.itemsSize,10):Array.isArray(e.items)?e.items.length:0),{virtualScrollSliceRange:g,localResetVirtualScroll:a,padVirtualScroll:b,onVirtualScrollEvt:_}=useVirtualScroll({virtualScrollLength:d,getVirtualScrollTarget:O,getVirtualScrollEl:k}),T=computed(()=>{if(d.value===0)return[];const te=(H,Z)=>({index:g.value.from+Z,item:H});return e.itemsFn===void 0?e.items.slice(g.value.from,g.value.to).map(te):e.itemsFn(g.value.from,g.value.to-g.value.from).map(te)}),C=computed(()=>"q-virtual-scroll q-virtual-scroll"+(e.virtualScrollHorizontal===!0?"--horizontal":"--vertical")+(e.scrollTarget!==void 0?"":" scroll")),D=computed(()=>e.scrollTarget!==void 0?{}:{tabindex:0});watch(d,()=>{a()}),watch(()=>e.scrollTarget,()=>{G(),U()});function k(){return s.value.$el||s.value}function O(){return o}function U(){o=getScrollTarget(k(),e.scrollTarget),o.addEventListener("scroll",_,listenOpts.passive)}function G(){o!==void 0&&(o.removeEventListener("scroll",_,listenOpts.passive),o=void 0)}function j(){let te=b(e.type==="list"?"div":"tbody",T.value.map(r.default));return r.before!==void 0&&(te=r.before().concat(te)),hMergeSlot(r.after,te)}return onBeforeMount(()=>{a()}),onMounted(()=>{U()}),onActivated(()=>{U()}),onDeactivated(()=>{G()}),onBeforeUnmount(()=>{G()}),()=>{if(r.default===void 0){console.error("QVirtualScroll: default scoped slot is required for rendering");return}return e.type==="__qtable"?getTableMiddle({ref:s,class:"q-table__middle "+C.value},j()):h(comps[e.type],{...t,ref:s,class:[t.class,C.value],...D.value},j)}}}),QField=createComponent({name:"QField",inheritAttrs:!1,props:useFieldProps,emits:useFieldEmits,setup(){return useField(useFieldState())}}),defaultSizes$1={xs:8,sm:10,md:14,lg:20,xl:24},QChip=createComponent({name:"QChip",props:{...useDarkProps,...useSizeProps,dense:Boolean,icon:String,iconRight:String,iconRemove:String,iconSelected:String,label:[String,Number],color:String,textColor:String,modelValue:{type:Boolean,default:!0},selected:{type:Boolean,default:null},square:Boolean,outline:Boolean,clickable:Boolean,removable:Boolean,removeAriaLabel:String,tabindex:[String,Number],disable:Boolean,ripple:{type:[Boolean,Object],default:!0}},emits:["update:modelValue","update:selected","remove","click"],setup(e,{slots:r,emit:t}){const{proxy:{$q:o}}=getCurrentInstance(),s=useDark(e,o),d=useSize(e,defaultSizes$1),g=computed(()=>e.selected===!0||e.icon!==void 0),a=computed(()=>e.selected===!0?e.iconSelected||o.iconSet.chip.selected:e.icon),b=computed(()=>e.iconRemove||o.iconSet.chip.remove),_=computed(()=>e.disable===!1&&(e.clickable===!0||e.selected!==null)),T=computed(()=>{const G=e.outline===!0&&e.color||e.textColor;return"q-chip row inline no-wrap items-center"+(e.outline===!1&&e.color!==void 0?` bg-${e.color}`:"")+(G?` text-${G} q-chip--colored`:"")+(e.disable===!0?" disabled":"")+(e.dense===!0?" q-chip--dense":"")+(e.outline===!0?" q-chip--outline":"")+(e.selected===!0?" q-chip--selected":"")+(_.value===!0?" q-chip--clickable cursor-pointer non-selectable q-hoverable":"")+(e.square===!0?" q-chip--square":"")+(s.value===!0?" q-chip--dark q-dark":"")}),C=computed(()=>{const G=e.disable===!0?{tabindex:-1,"aria-disabled":"true"}:{tabindex:e.tabindex||0},j={...G,role:"button","aria-hidden":"false","aria-label":e.removeAriaLabel||o.lang.label.remove};return{chip:G,remove:j}});function D(G){G.keyCode===13&&k(G)}function k(G){e.disable||(t("update:selected",!e.selected),t("click",G))}function O(G){(G.keyCode===void 0||G.keyCode===13)&&(stopAndPrevent(G),e.disable===!1&&(t("update:modelValue",!1),t("remove")))}function U(){const G=[];_.value===!0&&G.push(h("div",{class:"q-focus-helper"})),g.value===!0&&G.push(h(QIcon,{class:"q-chip__icon q-chip__icon--left",name:a.value}));const j=e.label!==void 0?[h("div",{class:"ellipsis"},[e.label])]:void 0;return G.push(h("div",{class:"q-chip__content col row no-wrap items-center q-anchor--skip"},hMergeSlotSafely(r.default,j))),e.iconRight&&G.push(h(QIcon,{class:"q-chip__icon q-chip__icon--right",name:e.iconRight})),e.removable===!0&&G.push(h(QIcon,{class:"q-chip__icon q-chip__icon--remove cursor-pointer",name:b.value,...C.value.remove,onClick:O,onKeyup:O})),G}return()=>{if(e.modelValue===!1)return;const G={class:T.value,style:d.value};return _.value===!0&&Object.assign(G,C.value.chip,{onClick:k,onKeyup:D}),hDir("div",G,U(),"ripple",e.ripple!==!1&&e.disable!==!0,()=>[[Ripple,e.ripple]])}}}),QItem=createComponent({name:"QItem",props:{...useDarkProps,...useRouterLinkProps,tag:{type:String,default:"div"},active:{type:Boolean,default:null},clickable:Boolean,dense:Boolean,insetLevel:Number,tabindex:[String,Number],focused:Boolean,manualFocus:Boolean},emits:["click","keyup"],setup(e,{slots:r,emit:t}){const{proxy:{$q:o}}=getCurrentInstance(),s=useDark(e,o),{hasLink:d,linkAttrs:g,linkClass:a,linkTag:b,navigateOnClick:_}=useRouterLink(),T=ref(null),C=ref(null),D=computed(()=>e.clickable===!0||d.value===!0||e.tag==="label"),k=computed(()=>e.disable!==!0&&D.value===!0),O=computed(()=>"q-item q-item-type row no-wrap"+(e.dense===!0?" q-item--dense":"")+(s.value===!0?" q-item--dark":"")+(d.value===!0&&e.active===null?a.value:e.active===!0?` q-item--active${e.activeClass!==void 0?` ${e.activeClass}`:""}`:"")+(e.disable===!0?" disabled":"")+(k.value===!0?" q-item--clickable q-link cursor-pointer "+(e.manualFocus===!0?"q-manual-focusable":"q-focusable q-hoverable")+(e.focused===!0?" q-manual-focusable--focused":""):"")),U=computed(()=>e.insetLevel===void 0?null:{["padding"+(o.lang.rtl===!0?"Right":"Left")]:16+e.insetLevel*56+"px"});function G(H){k.value===!0&&(C.value!==null&&(H.qKeyEvent!==!0&&document.activeElement===T.value?C.value.focus():document.activeElement===C.value&&T.value.focus()),_(H))}function j(H){if(k.value===!0&&isKeyCode(H,13)===!0){stopAndPrevent(H),H.qKeyEvent=!0;const Z=new MouseEvent("click",H);Z.qKeyEvent=!0,T.value.dispatchEvent(Z)}t("keyup",H)}function te(){const H=hUniqueSlot(r.default,[]);return k.value===!0&&H.unshift(h("div",{class:"q-focus-helper",tabindex:-1,ref:C})),H}return()=>{const H={ref:T,class:O.value,style:U.value,role:"listitem",onClick:G,onKeyup:j};return k.value===!0?(H.tabindex=e.tabindex||"0",Object.assign(H,g.value)):D.value===!0&&(H["aria-disabled"]="true"),h(b.value,H,te())}}}),QItemSection=createComponent({name:"QItemSection",props:{avatar:Boolean,thumbnail:Boolean,side:Boolean,top:Boolean,noWrap:Boolean},setup(e,{slots:r}){const t=computed(()=>`q-item__section column q-item__section--${e.avatar===!0||e.side===!0||e.thumbnail===!0?"side":"main"}`+(e.top===!0?" q-item__section--top justify-start":" justify-center")+(e.avatar===!0?" q-item__section--avatar":"")+(e.thumbnail===!0?" q-item__section--thumbnail":"")+(e.noWrap===!0?" q-item__section--nowrap":""));return()=>h("div",{class:t.value},hSlot(r.default))}}),QItemLabel=createComponent({name:"QItemLabel",props:{overline:Boolean,caption:Boolean,header:Boolean,lines:[Number,String]},setup(e,{slots:r}){const t=computed(()=>parseInt(e.lines,10)),o=computed(()=>"q-item__label"+(e.overline===!0?" q-item__label--overline text-overline":"")+(e.caption===!0?" q-item__label--caption text-caption":"")+(e.header===!0?" q-item__label--header":"")+(t.value===1?" ellipsis":"")),s=computed(()=>e.lines!==void 0&&t.value>1?{overflow:"hidden",display:"-webkit-box","-webkit-box-orient":"vertical","-webkit-line-clamp":t.value}:null);return()=>h("div",{style:s.value,class:o.value},hSlot(r.default))}}),validateNewValueMode=e=>["add","add-unique","toggle"].includes(e),reEscapeList=".*+?^${}()|[]\\",fieldPropsList=Object.keys(useFieldProps),QSelect=createComponent({name:"QSelect",inheritAttrs:!1,props:{...useVirtualScrollProps,...useFormProps,...useFieldProps,modelValue:{required:!0},multiple:Boolean,displayValue:[String,Number],displayValueHtml:Boolean,dropdownIcon:String,options:{type:Array,default:()=>[]},optionValue:[Function,String],optionLabel:[Function,String],optionDisable:[Function,String],hideSelected:Boolean,hideDropdownIcon:Boolean,fillInput:Boolean,maxValues:[Number,String],optionsDense:Boolean,optionsDark:{type:Boolean,default:null},optionsSelectedClass:String,optionsHtml:Boolean,optionsCover:Boolean,menuShrink:Boolean,menuAnchor:String,menuSelf:String,menuOffset:Array,popupContentClass:String,popupContentStyle:[String,Array,Object],useInput:Boolean,useChips:Boolean,newValueMode:{type:String,validator:validateNewValueMode},mapOptions:Boolean,emitValue:Boolean,inputDebounce:{type:[Number,String],default:500},inputClass:[Array,String,Object],inputStyle:[Array,String,Object],tabindex:{type:[String,Number],default:0},autocomplete:String,transitionShow:String,transitionHide:String,transitionDuration:[String,Number],behavior:{type:String,validator:e=>["default","menu","dialog"].includes(e),default:"default"},virtualScrollItemSize:{type:[Number,String],default:void 0},onNewValue:Function,onFilter:Function},emits:[...useFieldEmits,"add","remove","inputValue","newValue","keyup","keypress","keydown","filterAbort"],setup(e,{slots:r,emit:t}){const{proxy:o}=getCurrentInstance(),{$q:s}=o,d=ref(!1),g=ref(!1),a=ref(-1),b=ref(""),_=ref(!1),T=ref(!1);let C=null,D,k,O,U=null,G,j,te,H;const Z=ref(null),W=ref(null),_e=ref(null),fe=ref(null),re=ref(null),ae=useFormInputNameAttr(e),J=useKeyComposition(vt),se=computed(()=>Array.isArray(e.options)?e.options.length:0),Me=computed(()=>e.virtualScrollItemSize===void 0?e.optionsDense===!0?24:48:e.virtualScrollItemSize),{virtualScrollSliceRange:Ie,virtualScrollSliceSizeComputed:We,localResetVirtualScroll:Ge,padVirtualScroll:qt,onVirtualScrollEvt:ti,scrollTo:Ut,setVirtualScrollSize:Qt}=useVirtualScroll({virtualScrollLength:se,getVirtualScrollTarget:Er,getVirtualScrollEl:nn,virtualScrollItemSizeComputed:Me}),tt=useFieldState(),nt=computed(()=>{const Ce=e.mapOptions===!0&&e.multiple!==!0,Yt=e.modelValue!==void 0&&(e.modelValue!==null||Ce===!0)?e.multiple===!0&&Array.isArray(e.modelValue)?e.modelValue:[e.modelValue]:[];if(e.mapOptions===!0&&Array.isArray(e.options)===!0){const At=e.mapOptions===!0&&D!==void 0?D:[],ui=Yt.map(Bi=>Ri(Bi,At));return e.modelValue===null&&Ce===!0?ui.filter(Bi=>Bi!==null):ui}return Yt}),Mt=computed(()=>{const Ce={};return fieldPropsList.forEach(Yt=>{const At=e[Yt];At!==void 0&&(Ce[Yt]=At)}),Ce}),ht=computed(()=>e.optionsDark===null?tt.isDark.value:e.optionsDark),xt=computed(()=>fieldValueIsFilled(nt.value)),It=computed(()=>{let Ce="q-field__input q-placeholder col";return e.hideSelected===!0||nt.value.length===0?[Ce,e.inputClass]:(Ce+=" q-field__input--padding",e.inputClass===void 0?Ce:[Ce,e.inputClass])}),Et=computed(()=>(e.virtualScrollHorizontal===!0?"q-virtual-scroll--horizontal":"")+(e.popupContentClass?" "+e.popupContentClass:"")),yt=computed(()=>se.value===0),Bt=computed(()=>nt.value.map(Ce=>ct.value(Ce)).join(", ")),_t=computed(()=>e.displayValue!==void 0?e.displayValue:Bt.value),si=computed(()=>e.optionsHtml===!0?()=>!0:Ce=>Ce!=null&&Ce.html===!0),Li=computed(()=>e.displayValueHtml===!0||e.displayValue===void 0&&(e.optionsHtml===!0||nt.value.some(si.value))),vi=computed(()=>tt.focused.value===!0?e.tabindex:-1),ci=computed(()=>{const Ce={tabindex:e.tabindex,role:"combobox","aria-label":e.label,"aria-readonly":e.readonly===!0?"true":"false","aria-autocomplete":e.useInput===!0?"list":"none","aria-expanded":d.value===!0?"true":"false","aria-controls":`${tt.targetUid.value}_lb`};return a.value>=0&&(Ce["aria-activedescendant"]=`${tt.targetUid.value}_${a.value}`),Ce}),mt=computed(()=>({id:`${tt.targetUid.value}_lb`,role:"listbox","aria-multiselectable":e.multiple===!0?"true":"false"})),$t=computed(()=>nt.value.map((Ce,Yt)=>({index:Yt,opt:Ce,html:si.value(Ce),selected:!0,removeAtIndex:Nt,toggleOption:ii,tabindex:vi.value}))),Mi=computed(()=>{if(se.value===0)return[];const{from:Ce,to:Yt}=Ie.value;return e.options.slice(Ce,Yt).map((At,ui)=>{const Bi=Ct.value(At)===!0,rr=Ce+ui,dr={clickable:!0,active:!1,activeClass:dt.value,manualFocus:!0,focused:!1,disable:Bi,tabindex:-1,dense:e.optionsDense,dark:ht.value,role:"option",id:`${tt.targetUid.value}_${rr}`,onClick:()=>{ii(At)}};return Bi!==!0&&(zi(At)===!0&&(dr.active=!0),a.value===rr&&(dr.focused=!0),dr["aria-selected"]=dr.active===!0?"true":"false",s.platform.is.desktop===!0&&(dr.onMousemove=()=>{d.value===!0&&Ii(rr)})),{index:rr,opt:At,html:si.value(At),label:ct.value(At),selected:dr.active,focused:dr.focused,toggleOption:ii,setOptionIndex:Ii,itemProps:dr}})}),Di=computed(()=>e.dropdownIcon!==void 0?e.dropdownIcon:s.iconSet.arrow.dropdown),Ci=computed(()=>e.optionsCover===!1&&e.outlined!==!0&&e.standout!==!0&&e.borderless!==!0&&e.rounded!==!0),dt=computed(()=>e.optionsSelectedClass!==void 0?e.optionsSelectedClass:e.color!==void 0?`text-${e.color}`:""),ei=computed(()=>Ni(e.optionValue,"value")),ct=computed(()=>Ni(e.optionLabel,"label")),Ct=computed(()=>Ni(e.optionDisable,"disable")),Be=computed(()=>nt.value.map(Ce=>ei.value(Ce))),Xt=computed(()=>{const Ce={onInput:vt,onChange:J,onKeydown:Ur,onKeyup:cr,onKeypress:ur,onFocus:Ki,onClick(Yt){k===!0&&stop(Yt)}};return Ce.onCompositionstart=Ce.onCompositionupdate=Ce.onCompositionend=J,Ce});watch(nt,Ce=>{D=Ce,e.useInput===!0&&e.fillInput===!0&&e.multiple!==!0&&tt.innerLoading.value!==!0&&(g.value!==!0&&d.value!==!0||xt.value!==!0)&&(O!==!0&&bt(),(g.value===!0||d.value===!0)&&Oe(""))},{immediate:!0}),watch(()=>e.fillInput,bt),watch(d,Ht),watch(se,Pt);function ni(Ce){return e.emitValue===!0?ei.value(Ce):Ce}function Vt(Ce){if(Ce>-1&&Ce<nt.value.length)if(e.multiple===!0){const Yt=e.modelValue.slice();t("remove",{index:Ce,value:Yt.splice(Ce,1)[0]}),t("update:modelValue",Yt)}else t("update:modelValue",null)}function Nt(Ce){Vt(Ce),tt.focus()}function mi(Ce,Yt){const At=ni(Ce);if(e.multiple!==!0){e.fillInput===!0&&he(ct.value(Ce),!0,!0),t("update:modelValue",At);return}if(nt.value.length===0){t("add",{index:0,value:At}),t("update:modelValue",e.multiple===!0?[At]:At);return}if(Yt===!0&&zi(Ce)===!0||e.maxValues!==void 0&&e.modelValue.length>=e.maxValues)return;const ui=e.modelValue.slice();t("add",{index:ui.length,value:At}),ui.push(At),t("update:modelValue",ui)}function ii(Ce,Yt){if(tt.editable.value!==!0||Ce===void 0||Ct.value(Ce)===!0)return;const At=ei.value(Ce);if(e.multiple!==!0){Yt!==!0&&(he(e.fillInput===!0?ct.value(Ce):"",!0,!0),Xe()),W.value!==null&&W.value.focus(),(nt.value.length===0||isDeepEqual(ei.value(nt.value[0]),At)!==!0)&&t("update:modelValue",e.emitValue===!0?At:Ce);return}if((k!==!0||_.value===!0)&&tt.focus(),Ki(),nt.value.length===0){const rr=e.emitValue===!0?At:Ce;t("add",{index:0,value:rr}),t("update:modelValue",e.multiple===!0?[rr]:rr);return}const ui=e.modelValue.slice(),Bi=Be.value.findIndex(rr=>isDeepEqual(rr,At));if(Bi>-1)t("remove",{index:Bi,value:ui.splice(Bi,1)[0]});else{if(e.maxValues!==void 0&&ui.length>=e.maxValues)return;const rr=e.emitValue===!0?At:Ce;t("add",{index:ui.length,value:rr}),ui.push(rr)}t("update:modelValue",ui)}function Ii(Ce){if(s.platform.is.desktop!==!0)return;const Yt=Ce>-1&&Ce<se.value?Ce:-1;a.value!==Yt&&(a.value=Yt)}function $i(Ce=1,Yt){if(d.value===!0){let At=a.value;do At=normalizeToInterval(At+Ce,-1,se.value-1);while(At!==-1&&At!==a.value&&Ct.value(e.options[At])===!0);a.value!==At&&(Ii(At),Ut(At),Yt!==!0&&e.useInput===!0&&e.fillInput===!0&&_i(At>=0?ct.value(e.options[At]):G))}}function Ri(Ce,Yt){const At=ui=>isDeepEqual(ei.value(ui),Ce);return e.options.find(At)||Yt.find(At)||Ce}function Ni(Ce,Yt){const At=Ce!==void 0?Ce:Yt;return typeof At=="function"?At:ui=>ui!==null&&typeof ui=="object"&&At in ui?ui[At]:ui}function zi(Ce){const Yt=ei.value(Ce);return Be.value.find(At=>isDeepEqual(At,Yt))!==void 0}function Ki(Ce){e.useInput===!0&&W.value!==null&&(Ce===void 0||W.value===Ce.target&&Ce.target.value===Bt.value)&&W.value.select()}function _r(Ce){isKeyCode(Ce,27)===!0&&d.value===!0&&(stop(Ce),Xe(),bt()),t("keyup",Ce)}function cr(Ce){const{value:Yt}=Ce.target;if(Ce.keyCode!==void 0){_r(Ce);return}if(Ce.target.value="",C!==null&&(clearTimeout(C),C=null),bt(),typeof Yt=="string"&&Yt.length>0){const At=Yt.toLocaleLowerCase(),ui=rr=>{const dr=e.options.find(ot=>rr.value(ot).toLocaleLowerCase()===At);return dr===void 0?!1:(nt.value.indexOf(dr)===-1?ii(dr):Xe(),!0)},Bi=rr=>{ui(ei)!==!0&&(ui(ct)===!0||rr===!0||Oe(Yt,!0,()=>Bi(!0)))};Bi()}else tt.clearValue(Ce)}function ur(Ce){t("keypress",Ce)}function Ur(Ce){if(t("keydown",Ce),shouldIgnoreKey(Ce)===!0)return;const Yt=b.value.length>0&&(e.newValueMode!==void 0||e.onNewValue!==void 0),At=Ce.shiftKey!==!0&&e.multiple!==!0&&(a.value>-1||Yt===!0);if(Ce.keyCode===27){prevent(Ce);return}if(Ce.keyCode===9&&At===!1){Ue();return}if(Ce.target===void 0||Ce.target.id!==tt.targetUid.value)return;if(Ce.keyCode===40&&tt.innerLoading.value!==!0&&d.value===!1){stopAndPrevent(Ce),Ne();return}if(Ce.keyCode===8&&e.hideSelected!==!0&&b.value.length===0){e.multiple===!0&&Array.isArray(e.modelValue)===!0?Vt(e.modelValue.length-1):e.multiple!==!0&&e.modelValue!==null&&t("update:modelValue",null);return}(Ce.keyCode===35||Ce.keyCode===36)&&(typeof b.value!="string"||b.value.length===0)&&(stopAndPrevent(Ce),a.value=-1,$i(Ce.keyCode===36?1:-1,e.multiple)),(Ce.keyCode===33||Ce.keyCode===34)&&We.value!==void 0&&(stopAndPrevent(Ce),a.value=Math.max(-1,Math.min(se.value,a.value+(Ce.keyCode===33?-1:1)*We.value.view)),$i(Ce.keyCode===33?1:-1,e.multiple)),(Ce.keyCode===38||Ce.keyCode===40)&&(stopAndPrevent(Ce),$i(Ce.keyCode===38?-1:1,e.multiple));const ui=se.value;if((te===void 0||H<Date.now())&&(te=""),ui>0&&e.useInput!==!0&&Ce.key!==void 0&&Ce.key.length===1&&Ce.altKey===!1&&Ce.ctrlKey===!1&&Ce.metaKey===!1&&(Ce.keyCode!==32||te.length>0)){d.value!==!0&&Ne(Ce);const Bi=Ce.key.toLocaleLowerCase(),rr=te.length===1&&te[0]===Bi;H=Date.now()+1500,rr===!1&&(stopAndPrevent(Ce),te+=Bi);const dr=new RegExp("^"+te.split("").map(Sn=>reEscapeList.indexOf(Sn)>-1?"\\"+Sn:Sn).join(".*"),"i");let ot=a.value;if(rr===!0||ot<0||dr.test(ct.value(e.options[ot]))!==!0)do ot=normalizeToInterval(ot+1,-1,ui-1);while(ot!==a.value&&(Ct.value(e.options[ot])===!0||dr.test(ct.value(e.options[ot]))!==!0));a.value!==ot&&nextTick(()=>{Ii(ot),Ut(ot),ot>=0&&e.useInput===!0&&e.fillInput===!0&&_i(ct.value(e.options[ot]))});return}if(!(Ce.keyCode!==13&&(Ce.keyCode!==32||e.useInput===!0||te!=="")&&(Ce.keyCode!==9||At===!1))){if(Ce.keyCode!==9&&stopAndPrevent(Ce),a.value>-1&&a.value<ui){ii(e.options[a.value]);return}if(Yt===!0){const Bi=(rr,dr)=>{if(dr){if(validateNewValueMode(dr)!==!0)return}else dr=e.newValueMode;if(rr==null)return;he("",e.multiple!==!0,!0),(dr==="toggle"?ii:mi)(rr,dr==="add-unique"),e.multiple!==!0&&(W.value!==null&&W.value.focus(),Xe())};if(e.onNewValue!==void 0?t("newValue",b.value,Bi):Bi(b.value),e.multiple!==!0)return}d.value===!0?Ue():tt.innerLoading.value!==!0&&Ne()}}function nn(){return k===!0?re.value:_e.value!==null&&_e.value.contentEl!==null?_e.value.contentEl:void 0}function Er(){return nn()}function Kr(){return e.hideSelected===!0?[]:r["selected-item"]!==void 0?$t.value.map(Ce=>r["selected-item"](Ce)).slice():r.selected!==void 0?[].concat(r.selected()):e.useChips===!0?$t.value.map((Ce,Yt)=>h(QChip,{key:"option-"+Yt,removable:tt.editable.value===!0&&Ct.value(Ce.opt)!==!0,dense:!0,textColor:e.color,tabindex:vi.value,onRemove(){Ce.removeAtIndex(Yt)}},()=>h("span",{class:"ellipsis",[Ce.html===!0?"innerHTML":"textContent"]:ct.value(Ce.opt)}))):[h("span",{[Li.value===!0?"innerHTML":"textContent"]:_t.value})]}function on(){if(yt.value===!0)return r["no-option"]!==void 0?r["no-option"]({inputValue:b.value}):void 0;const Ce=r.option!==void 0?r.option:At=>h(QItem,{key:At.index,...At.itemProps},()=>h(QItemSection,()=>h(QItemLabel,()=>h("span",{[At.html===!0?"innerHTML":"textContent"]:At.label}))));let Yt=qt("div",Mi.value.map(Ce));return r["before-options"]!==void 0&&(Yt=r["before-options"]().concat(Yt)),hMergeSlot(r["after-options"],Yt)}function an(Ce,Yt){const At=Yt===!0?{...ci.value,...tt.splitAttrs.attributes.value}:void 0,ui={ref:Yt===!0?W:void 0,key:"i_t",class:It.value,style:e.inputStyle,value:b.value!==void 0?b.value:"",type:"search",...At,id:Yt===!0?tt.targetUid.value:void 0,maxlength:e.maxlength,autocomplete:e.autocomplete,"data-autofocus":Ce===!0||e.autofocus===!0||void 0,disabled:e.disable===!0,readonly:e.readonly===!0,...Xt.value};return Ce!==!0&&k===!0&&(Array.isArray(ui.class)===!0?ui.class=[...ui.class,"no-pointer-events"]:ui.class+=" no-pointer-events"),h("input",ui)}function vt(Ce){C!==null&&(clearTimeout(C),C=null),!(Ce&&Ce.target&&Ce.target.qComposing===!0)&&(_i(Ce.target.value||""),O=!0,G=b.value,tt.focused.value!==!0&&(k!==!0||_.value===!0)&&tt.focus(),e.onFilter!==void 0&&(C=setTimeout(()=>{C=null,Oe(b.value)},e.inputDebounce)))}function _i(Ce){b.value!==Ce&&(b.value=Ce,t("inputValue",Ce))}function he(Ce,Yt,At){O=At!==!0,e.useInput===!0&&(_i(Ce),(Yt===!0||At!==!0)&&(G=Ce),Yt!==!0&&Oe(Ce))}function Oe(Ce,Yt,At){if(e.onFilter===void 0||Yt!==!0&&tt.focused.value!==!0)return;tt.innerLoading.value===!0?t("filterAbort"):(tt.innerLoading.value=!0,T.value=!0),Ce!==""&&e.multiple!==!0&&nt.value.length>0&&O!==!0&&Ce===ct.value(nt.value[0])&&(Ce="");const ui=setTimeout(()=>{d.value===!0&&(d.value=!1)},10);U!==null&&clearTimeout(U),U=ui,t("filter",Ce,(Bi,rr)=>{(Yt===!0||tt.focused.value===!0)&&U===ui&&(clearTimeout(U),typeof Bi=="function"&&Bi(),T.value=!1,nextTick(()=>{tt.innerLoading.value=!1,tt.editable.value===!0&&(Yt===!0?d.value===!0&&Xe():d.value===!0?Ht(!0):d.value=!0),typeof rr=="function"&&nextTick(()=>{rr(o)}),typeof At=="function"&&nextTick(()=>{At(o)})}))},()=>{tt.focused.value===!0&&U===ui&&(clearTimeout(U),tt.innerLoading.value=!1,T.value=!1),d.value===!0&&(d.value=!1)})}function He(){return h(QMenu,{ref:_e,class:Et.value,style:e.popupContentStyle,modelValue:d.value,fit:e.menuShrink!==!0,cover:e.optionsCover===!0&&yt.value!==!0&&e.useInput!==!0,anchor:e.menuAnchor,self:e.menuSelf,offset:e.menuOffset,dark:ht.value,noParentEvent:!0,noRefocus:!0,noFocus:!0,square:Ci.value,transitionShow:e.transitionShow,transitionHide:e.transitionHide,transitionDuration:e.transitionDuration,separateClosePopup:!0,...mt.value,onScrollPassive:ti,onBeforeShow:xi,onBeforeHide:Tt,onShow:le},on)}function Tt(Ce){Ei(Ce),Ue()}function le(){Qt()}function Q(Ce){stop(Ce),W.value!==null&&W.value.focus(),_.value=!0,window.scrollTo(window.pageXOffset||window.scrollX||document.body.scrollLeft||0,0)}function ne(Ce){stop(Ce),nextTick(()=>{_.value=!1})}function me(){const Ce=[h(QField,{class:`col-auto ${tt.fieldClass.value}`,...Mt.value,for:tt.targetUid.value,dark:ht.value,square:!0,loading:T.value,itemAligned:!1,filled:!0,stackLabel:b.value.length>0,...tt.splitAttrs.listeners.value,onFocus:Q,onBlur:ne},{...r,rawControl:()=>tt.getControl(!0),before:void 0,after:void 0})];return d.value===!0&&Ce.push(h("div",{ref:re,class:Et.value+" scroll",style:e.popupContentStyle,...mt.value,onClick:prevent,onScrollPassive:ti},on())),h(QDialog,{ref:fe,modelValue:g.value,position:e.useInput===!0?"top":void 0,transitionShow:j,transitionHide:e.transitionHide,transitionDuration:e.transitionDuration,onBeforeShow:xi,onBeforeHide:we,onHide:Pe,onShow:Ye},()=>h("div",{class:"q-select__dialog"+(ht.value===!0?" q-select__dialog--dark q-dark":"")+(_.value===!0?" q-select__dialog--focused":"")},Ce))}function we(Ce){Ei(Ce),fe.value!==null&&fe.value.__updateRefocusTarget(tt.rootRef.value.querySelector(".q-field__native > [tabindex]:last-child")),tt.focused.value=!1}function Pe(Ce){Xe(),tt.focused.value===!1&&t("blur",Ce),bt()}function Ye(){const Ce=document.activeElement;(Ce===null||Ce.id!==tt.targetUid.value)&&W.value!==null&&W.value!==Ce&&W.value.focus(),Qt()}function Ue(){g.value!==!0&&(a.value=-1,d.value===!0&&(d.value=!1),tt.focused.value===!1&&(U!==null&&(clearTimeout(U),U=null),tt.innerLoading.value===!0&&(t("filterAbort"),tt.innerLoading.value=!1,T.value=!1)))}function Ne(Ce){tt.editable.value===!0&&(k===!0?(tt.onControlFocusin(Ce),g.value=!0,nextTick(()=>{tt.focus()})):tt.focus(),e.onFilter!==void 0?Oe(b.value):(yt.value!==!0||r["no-option"]!==void 0)&&(d.value=!0))}function Xe(){g.value=!1,Ue()}function bt(){e.useInput===!0&&he(e.multiple!==!0&&e.fillInput===!0&&nt.value.length>0&&ct.value(nt.value[0])||"",!0,!0)}function Ht(Ce){let Yt=-1;if(Ce===!0){if(nt.value.length>0){const At=ei.value(nt.value[0]);Yt=e.options.findIndex(ui=>isDeepEqual(ei.value(ui),At))}Ge(Yt)}Ii(Yt)}function Pt(Ce,Yt){d.value===!0&&tt.innerLoading.value===!1&&(Ge(-1,!0),nextTick(()=>{d.value===!0&&tt.innerLoading.value===!1&&(Ce>Yt?Ge():Ht(!0))}))}function Ai(){g.value===!1&&_e.value!==null&&_e.value.updatePosition()}function xi(Ce){Ce!==void 0&&stop(Ce),t("popupShow",Ce),tt.hasPopupOpen=!0,tt.onControlFocusin(Ce)}function Ei(Ce){Ce!==void 0&&stop(Ce),t("popupHide",Ce),tt.hasPopupOpen=!1,tt.onControlFocusout(Ce)}function Fi(){k=s.platform.is.mobile!==!0&&e.behavior!=="dialog"?!1:e.behavior!=="menu"&&(e.useInput===!0?r["no-option"]!==void 0||e.onFilter!==void 0||yt.value===!1:!0),j=s.platform.is.ios===!0&&k===!0&&e.useInput===!0?"fade":e.transitionShow}return onBeforeUpdate(Fi),onUpdated(Ai),Fi(),onBeforeUnmount(()=>{C!==null&&clearTimeout(C)}),Object.assign(o,{showPopup:Ne,hidePopup:Xe,removeAtIndex:Vt,add:mi,toggleOption:ii,getOptionIndex:()=>a.value,setOptionIndex:Ii,moveOptionSelection:$i,filter:Oe,updateMenuPosition:Ai,updateInputValue:he,isOptionSelected:zi,getEmittingOptionValue:ni,isOptionDisabled:(...Ce)=>Ct.value.apply(null,Ce)===!0,getOptionValue:(...Ce)=>ei.value.apply(null,Ce),getOptionLabel:(...Ce)=>ct.value.apply(null,Ce)}),Object.assign(tt,{innerValue:nt,fieldClass:computed(()=>`q-select q-field--auto-height q-select--with${e.useInput!==!0?"out":""}-input q-select--with${e.useChips!==!0?"out":""}-chips q-select--${e.multiple===!0?"multiple":"single"}`),inputRef:Z,targetRef:W,hasValue:xt,showPopup:Ne,floatingLabel:computed(()=>e.hideSelected!==!0&&xt.value===!0||typeof b.value=="number"||b.value.length>0||fieldValueIsFilled(e.displayValue)),getControlChild:()=>{if(tt.editable.value!==!1&&(g.value===!0||yt.value!==!0||r["no-option"]!==void 0))return k===!0?me():He();tt.hasPopupOpen===!0&&(tt.hasPopupOpen=!1)},controlEvents:{onFocusin(Ce){tt.onControlFocusin(Ce)},onFocusout(Ce){tt.onControlFocusout(Ce,()=>{bt(),Ue()})},onClick(Ce){if(prevent(Ce),k!==!0&&d.value===!0){Ue(),W.value!==null&&W.value.focus();return}Ne(Ce)}},getControl:Ce=>{const Yt=Kr(),At=Ce===!0||g.value!==!0||k!==!0;if(e.useInput===!0)Yt.push(an(Ce,At));else if(tt.editable.value===!0){const Bi=At===!0?ci.value:void 0;Yt.push(h("input",{ref:At===!0?W:void 0,key:"d_t",class:"q-select__focus-target",id:At===!0?tt.targetUid.value:void 0,value:_t.value,readonly:!0,"data-autofocus":Ce===!0||e.autofocus===!0||void 0,...Bi,onKeydown:Ur,onKeyup:_r,onKeypress:ur})),At===!0&&typeof e.autocomplete=="string"&&e.autocomplete.length>0&&Yt.push(h("input",{class:"q-select__autocomplete-input",autocomplete:e.autocomplete,tabindex:-1,onKeyup:cr}))}if(ae.value!==void 0&&e.disable!==!0&&Be.value.length>0){const Bi=Be.value.map(rr=>h("option",{value:rr,selected:!0}));Yt.push(h("select",{class:"hidden",name:ae.value,multiple:e.multiple},Bi))}const ui=e.useInput===!0||At!==!0?void 0:tt.splitAttrs.attributes.value;return h("div",{class:"q-field__native row items-center",...ui,...tt.splitAttrs.listeners.value},Yt)},getInnerAppend:()=>e.loading!==!0&&T.value!==!0&&e.hideDropdownIcon!==!0?[h(QIcon,{class:"q-select__dropdown-icon"+(d.value===!0?" rotate-180":""),name:Di.value})]:null}),useField(tt)}}),defaultSizes={xs:2,sm:4,md:6,lg:10,xl:14};function width(e,r,t){return{transform:r===!0?`translateX(${t.lang.rtl===!0?"-":""}100%) scale3d(${-e},1,1)`:`scale3d(${e},1,1)`}}const QLinearProgress=createComponent({name:"QLinearProgress",props:{...useDarkProps,...useSizeProps,value:{type:Number,default:0},buffer:Number,color:String,trackColor:String,reverse:Boolean,stripe:Boolean,indeterminate:Boolean,query:Boolean,rounded:Boolean,animationSpeed:{type:[String,Number],default:2100},instantFeedback:Boolean},setup(e,{slots:r}){const{proxy:t}=getCurrentInstance(),o=useDark(e,t.$q),s=useSize(e,defaultSizes),d=computed(()=>e.indeterminate===!0||e.query===!0),g=computed(()=>e.reverse!==e.query),a=computed(()=>({...s.value!==null?s.value:{},"--q-linear-progress-speed":`${e.animationSpeed}ms`})),b=computed(()=>"q-linear-progress"+(e.color!==void 0?` text-${e.color}`:"")+(e.reverse===!0||e.query===!0?" q-linear-progress--reverse":"")+(e.rounded===!0?" rounded-borders":"")),_=computed(()=>width(e.buffer!==void 0?e.buffer:1,g.value,t.$q)),T=computed(()=>`with${e.instantFeedback===!0?"out":""}-transition`),C=computed(()=>`q-linear-progress__track absolute-full q-linear-progress__track--${T.value} q-linear-progress__track--${o.value===!0?"dark":"light"}`+(e.trackColor!==void 0?` bg-${e.trackColor}`:"")),D=computed(()=>width(d.value===!0?1:e.value,g.value,t.$q)),k=computed(()=>`q-linear-progress__model absolute-full q-linear-progress__model--${T.value} q-linear-progress__model--${d.value===!0?"in":""}determinate`),O=computed(()=>({width:`${e.value*100}%`})),U=computed(()=>`q-linear-progress__stripe absolute-${e.reverse===!0?"right":"left"} q-linear-progress__stripe--${T.value}`);return()=>{const G=[h("div",{class:C.value,style:_.value}),h("div",{class:k.value,style:D.value})];return e.stripe===!0&&d.value===!1&&G.push(h("div",{class:U.value,style:O.value})),h("div",{class:b.value,style:a.value,role:"progressbar","aria-valuemin":0,"aria-valuemax":1,"aria-valuenow":e.indeterminate===!0?void 0:e.value},hMergeSlot(r.default,G))}}});let counter=0;const useFullscreenProps={fullscreen:Boolean,noRouteFullscreenExit:Boolean},useFullscreenEmits=["update:fullscreen","fullscreen"];function useFullscreen(){const e=getCurrentInstance(),{props:r,emit:t,proxy:o}=e;let s,d,g;const a=ref(!1);vmHasRouter(e)===!0&&watch(()=>o.$route.fullPath,()=>{r.noRouteFullscreenExit!==!0&&T()}),watch(()=>r.fullscreen,C=>{a.value!==C&&b()}),watch(a,C=>{t("update:fullscreen",C),t("fullscreen",C)});function b(){a.value===!0?T():_()}function _(){a.value!==!0&&(a.value=!0,g=o.$el.parentNode,g.replaceChild(d,o.$el),document.body.appendChild(o.$el),counter++,counter===1&&document.body.classList.add("q-body--fullscreen-mixin"),s={handler:T},History.add(s))}function T(){a.value===!0&&(s!==void 0&&(History.remove(s),s=void 0),g.replaceChild(o.$el,d),a.value=!1,counter=Math.max(0,counter-1),counter===0&&(document.body.classList.remove("q-body--fullscreen-mixin"),o.$el.scrollIntoView!==void 0&&setTimeout(()=>{o.$el.scrollIntoView()})))}return onBeforeMount(()=>{d=document.createElement("span")}),onMounted(()=>{r.fullscreen===!0&&_()}),onBeforeUnmount(T),Object.assign(o,{toggleFullscreen:b,setFullscreen:_,exitFullscreen:T}),{inFullscreen:a,toggleFullscreen:b}}function sortDate(e,r){return new Date(e)-new Date(r)}const useTableSortProps={sortMethod:Function,binaryStateSort:Boolean,columnSortOrder:{type:String,validator:e=>e==="ad"||e==="da",default:"ad"}};function useTableSort(e,r,t,o){const s=computed(()=>{const{sortBy:a}=r.value;return a&&t.value.find(b=>b.name===a)||null}),d=computed(()=>e.sortMethod!==void 0?e.sortMethod:(a,b,_)=>{const T=t.value.find(k=>k.name===b);if(T===void 0||T.field===void 0)return a;const C=_===!0?-1:1,D=typeof T.field=="function"?k=>T.field(k):k=>k[T.field];return a.sort((k,O)=>{let U=D(k),G=D(O);return U==null?-1*C:G==null?1*C:T.sort!==void 0?T.sort(U,G,k,O)*C:isNumber$1(U)===!0&&isNumber$1(G)===!0?(U-G)*C:isDate(U)===!0&&isDate(G)===!0?sortDate(U,G)*C:typeof U=="boolean"&&typeof G=="boolean"?(U-G)*C:([U,G]=[U,G].map(j=>(j+"").toLocaleString().toLowerCase()),U<G?-1*C:U===G?0:C)})});function g(a){let b=e.columnSortOrder;if(isObject$1(a)===!0)a.sortOrder&&(b=a.sortOrder),a=a.name;else{const C=t.value.find(D=>D.name===a);C!==void 0&&C.sortOrder&&(b=C.sortOrder)}let{sortBy:_,descending:T}=r.value;_!==a?(_=a,T=b==="da"):e.binaryStateSort===!0?T=!T:T===!0?b==="ad"?_=null:T=!1:b==="ad"?T=!0:_=null,o({sortBy:_,descending:T,page:1})}return{columnToSort:s,computedSortMethod:d,sort:g}}const useTableFilterProps={filter:[String,Object],filterMethod:Function};function useTableFilter(e,r){const t=computed(()=>e.filterMethod!==void 0?e.filterMethod:(o,s,d,g)=>{const a=s?s.toLowerCase():"";return o.filter(b=>d.some(_=>{const T=g(_,b)+"";return(T==="undefined"||T==="null"?"":T.toLowerCase()).indexOf(a)!==-1}))});return watch(()=>e.filter,()=>{nextTick(()=>{r({page:1},!0)})},{deep:!0}),{computedFilterMethod:t}}function samePagination(e,r){for(const t in r)if(r[t]!==e[t])return!1;return!0}function fixPagination(e){return e.page<1&&(e.page=1),e.rowsPerPage!==void 0&&e.rowsPerPage<1&&(e.rowsPerPage=0),e}const useTablePaginationProps={pagination:Object,rowsPerPageOptions:{type:Array,default:()=>[5,7,10,15,20,25,50,0]},"onUpdate:pagination":[Function,Array]};function useTablePaginationState(e,r){const{props:t,emit:o}=e,s=ref(Object.assign({sortBy:null,descending:!1,page:1,rowsPerPage:t.rowsPerPageOptions.length>0?t.rowsPerPageOptions[0]:5},t.pagination)),d=computed(()=>{const T=t["onUpdate:pagination"]!==void 0?{...s.value,...t.pagination}:s.value;return fixPagination(T)}),g=computed(()=>d.value.rowsNumber!==void 0);function a(T){b({pagination:T,filter:t.filter})}function b(T={}){nextTick(()=>{o("request",{pagination:T.pagination||d.value,filter:T.filter||t.filter,getCellValue:r})})}function _(T,C){const D=fixPagination({...d.value,...T});if(samePagination(d.value,D)===!0){g.value===!0&&C===!0&&a(D);return}if(g.value===!0){a(D);return}t.pagination!==void 0&&t["onUpdate:pagination"]!==void 0?o("update:pagination",D):s.value=D}return{innerPagination:s,computedPagination:d,isServerSide:g,requestServerInteraction:b,setPagination:_}}function useTablePagination(e,r,t,o,s,d){const{props:g,emit:a,proxy:{$q:b}}=e,_=computed(()=>o.value===!0?t.value.rowsNumber||0:d.value),T=computed(()=>{const{page:Z,rowsPerPage:W}=t.value;return(Z-1)*W}),C=computed(()=>{const{page:Z,rowsPerPage:W}=t.value;return Z*W}),D=computed(()=>t.value.page===1),k=computed(()=>t.value.rowsPerPage===0?1:Math.max(1,Math.ceil(_.value/t.value.rowsPerPage))),O=computed(()=>C.value===0?!0:t.value.page>=k.value),U=computed(()=>(g.rowsPerPageOptions.includes(r.value.rowsPerPage)?g.rowsPerPageOptions:[r.value.rowsPerPage].concat(g.rowsPerPageOptions)).map(W=>({label:W===0?b.lang.table.allRows:""+W,value:W})));watch(k,(Z,W)=>{if(Z===W)return;const _e=t.value.page;Z&&!_e?s({page:1}):Z<_e&&s({page:Z})});function G(){s({page:1})}function j(){const{page:Z}=t.value;Z>1&&s({page:Z-1})}function te(){const{page:Z,rowsPerPage:W}=t.value;C.value>0&&Z*W<_.value&&s({page:Z+1})}function H(){s({page:k.value})}return g["onUpdate:pagination"]!==void 0&&a("update:pagination",{...t.value}),{firstRowIndex:T,lastRowIndex:C,isFirstPage:D,isLastPage:O,pagesNumber:k,computedRowsPerPageOptions:U,computedRowsNumber:_,firstPage:G,prevPage:j,nextPage:te,lastPage:H}}const useTableRowSelectionProps={selection:{type:String,default:"none",validator:e=>["single","multiple","none"].includes(e)},selected:{type:Array,default:()=>[]}},useTableRowSelectionEmits=["update:selected","selection"];function useTableRowSelection(e,r,t,o){const s=computed(()=>{const O={};return e.selected.map(o.value).forEach(U=>{O[U]=!0}),O}),d=computed(()=>e.selection!=="none"),g=computed(()=>e.selection==="single"),a=computed(()=>e.selection==="multiple"),b=computed(()=>t.value.length>0&&t.value.every(O=>s.value[o.value(O)]===!0)),_=computed(()=>b.value!==!0&&t.value.some(O=>s.value[o.value(O)]===!0)),T=computed(()=>e.selected.length);function C(O){return s.value[O]===!0}function D(){r("update:selected",[])}function k(O,U,G,j){r("selection",{rows:U,added:G,keys:O,evt:j});const te=g.value===!0?G===!0?U:[]:G===!0?e.selected.concat(U):e.selected.filter(H=>O.includes(o.value(H))===!1);r("update:selected",te)}return{hasSelectionMode:d,singleSelection:g,multipleSelection:a,allRowsSelected:b,someRowsSelected:_,rowsSelectedNumber:T,isRowSelected:C,clearSelection:D,updateSelection:k}}function getVal(e){return Array.isArray(e)?e.slice():[]}const useTableRowExpandProps={expanded:Array},useTableRowExpandEmits=["update:expanded"];function useTableRowExpand(e,r){const t=ref(getVal(e.expanded));watch(()=>e.expanded,g=>{t.value=getVal(g)});function o(g){return t.value.includes(g)}function s(g){e.expanded!==void 0?r("update:expanded",g):t.value=g}function d(g,a){const b=t.value.slice(),_=b.indexOf(g);a===!0?_===-1&&(b.push(g),s(b)):_!==-1&&(b.splice(_,1),s(b))}return{isRowExpanded:o,setExpanded:s,updateExpanded:d}}const useTableColumnSelectionProps={visibleColumns:Array};function useTableColumnSelection(e,r,t){const o=computed(()=>{if(e.columns!==void 0)return e.columns;const a=e.rows[0];return a!==void 0?Object.keys(a).map(b=>({name:b,label:b.toUpperCase(),field:b,align:isNumber$1(a[b])?"right":"left",sortable:!0})):[]}),s=computed(()=>{const{sortBy:a,descending:b}=r.value;return(e.visibleColumns!==void 0?o.value.filter(T=>T.required===!0||e.visibleColumns.includes(T.name)===!0):o.value).map(T=>{const C=T.align||"right",D=`text-${C}`;return{...T,align:C,__iconClass:`q-table__sort-icon q-table__sort-icon--${C}`,__thClass:D+(T.headerClasses!==void 0?" "+T.headerClasses:"")+(T.sortable===!0?" sortable":"")+(T.name===a?` sorted ${b===!0?"sort-desc":""}`:""),__tdStyle:T.style!==void 0?typeof T.style!="function"?()=>T.style:T.style:()=>null,__tdClass:T.classes!==void 0?typeof T.classes!="function"?()=>D+" "+T.classes:k=>D+" "+T.classes(k):()=>D}})}),d=computed(()=>{const a={};return s.value.forEach(b=>{a[b.name]=b}),a}),g=computed(()=>e.tableColspan!==void 0?e.tableColspan:s.value.length+(t.value===!0?1:0));return{colList:o,computedCols:s,computedColsMap:d,computedColspan:g}}const bottomClass="q-table__bottom row items-center",commonVirtPropsObj={};commonVirtPropsList.forEach(e=>{commonVirtPropsObj[e]={}});const QTable=createComponent({name:"QTable",props:{rows:{type:Array,default:()=>[]},rowKey:{type:[String,Function],default:"id"},columns:Array,loading:Boolean,iconFirstPage:String,iconPrevPage:String,iconNextPage:String,iconLastPage:String,title:String,hideHeader:Boolean,grid:Boolean,gridHeader:Boolean,dense:Boolean,flat:Boolean,bordered:Boolean,square:Boolean,separator:{type:String,default:"horizontal",validator:e=>["horizontal","vertical","cell","none"].includes(e)},wrapCells:Boolean,virtualScroll:Boolean,virtualScrollTarget:{default:void 0},...commonVirtPropsObj,noDataLabel:String,noResultsLabel:String,loadingLabel:String,selectedRowsLabel:Function,rowsPerPageLabel:String,paginationLabel:Function,color:{type:String,default:"grey-8"},titleClass:[String,Array,Object],tableStyle:[String,Array,Object],tableClass:[String,Array,Object],tableHeaderStyle:[String,Array,Object],tableHeaderClass:[String,Array,Object],cardContainerClass:[String,Array,Object],cardContainerStyle:[String,Array,Object],cardStyle:[String,Array,Object],cardClass:[String,Array,Object],hideBottom:Boolean,hideSelectedBanner:Boolean,hideNoData:Boolean,hidePagination:Boolean,onRowClick:Function,onRowDblclick:Function,onRowContextmenu:Function,...useDarkProps,...useFullscreenProps,...useTableColumnSelectionProps,...useTableFilterProps,...useTablePaginationProps,...useTableRowExpandProps,...useTableRowSelectionProps,...useTableSortProps},emits:["request","virtualScroll",...useFullscreenEmits,...useTableRowExpandEmits,...useTableRowSelectionEmits],setup(e,{slots:r,emit:t}){const o=getCurrentInstance(),{proxy:{$q:s}}=o,d=useDark(e,s),{inFullscreen:g,toggleFullscreen:a}=useFullscreen(),b=computed(()=>typeof e.rowKey=="function"?e.rowKey:vt=>vt[e.rowKey]),_=ref(null),T=ref(null),C=computed(()=>e.grid!==!0&&e.virtualScroll===!0),D=computed(()=>" q-table__card"+(d.value===!0?" q-table__card--dark q-dark":"")+(e.square===!0?" q-table--square":"")+(e.flat===!0?" q-table--flat":"")+(e.bordered===!0?" q-table--bordered":"")),k=computed(()=>`q-table__container q-table--${e.separator}-separator column no-wrap`+(e.grid===!0?" q-table--grid":D.value)+(d.value===!0?" q-table--dark":"")+(e.dense===!0?" q-table--dense":"")+(e.wrapCells===!1?" q-table--no-wrap":"")+(g.value===!0?" fullscreen scroll":"")),O=computed(()=>k.value+(e.loading===!0?" q-table--loading":""));watch(()=>e.tableStyle+e.tableClass+e.tableHeaderStyle+e.tableHeaderClass+k.value,()=>{C.value===!0&&T.value!==null&&T.value.reset()});const{innerPagination:U,computedPagination:G,isServerSide:j,requestServerInteraction:te,setPagination:H}=useTablePaginationState(o,$i),{computedFilterMethod:Z}=useTableFilter(e,H),{isRowExpanded:W,setExpanded:_e,updateExpanded:fe}=useTableRowExpand(e,t),re=computed(()=>{let vt=e.rows;if(j.value===!0||vt.length===0)return vt;const{sortBy:_i,descending:he}=G.value;return e.filter&&(vt=Z.value(vt,e.filter,nt.value,$i)),xt.value!==null&&(vt=It.value(e.rows===vt?vt.slice():vt,_i,he)),vt}),ae=computed(()=>re.value.length),J=computed(()=>{let vt=re.value;if(j.value===!0)return vt;const{rowsPerPage:_i}=G.value;return _i!==0&&(yt.value===0&&e.rows!==vt?vt.length>Bt.value&&(vt=vt.slice(0,Bt.value)):vt=vt.slice(yt.value,Bt.value)),vt}),{hasSelectionMode:se,singleSelection:Me,multipleSelection:Ie,allRowsSelected:We,someRowsSelected:Ge,rowsSelectedNumber:qt,isRowSelected:ti,clearSelection:Ut,updateSelection:Qt}=useTableRowSelection(e,t,J,b),{colList:tt,computedCols:nt,computedColsMap:Mt,computedColspan:ht}=useTableColumnSelection(e,G,se),{columnToSort:xt,computedSortMethod:It,sort:Et}=useTableSort(e,G,tt,H),{firstRowIndex:yt,lastRowIndex:Bt,isFirstPage:_t,isLastPage:si,pagesNumber:Li,computedRowsPerPageOptions:vi,computedRowsNumber:ci,firstPage:mt,prevPage:$t,nextPage:Mi,lastPage:Di}=useTablePagination(o,U,G,j,H,ae),Ci=computed(()=>J.value.length===0),dt=computed(()=>{const vt={};return commonVirtPropsList.forEach(_i=>{vt[_i]=e[_i]}),vt.virtualScrollItemSize===void 0&&(vt.virtualScrollItemSize=e.dense===!0?28:48),vt});function ei(){C.value===!0&&T.value.reset()}function ct(){if(e.grid===!0)return an();const vt=e.hideHeader!==!0?Ki:null;if(C.value===!0){const he=r["top-row"],Oe=r["bottom-row"],He={default:Tt=>ni(Tt.item,r.body,Tt.index)};if(he!==void 0){const Tt=h("tbody",he({cols:nt.value}));He.before=vt===null?()=>Tt:()=>[vt()].concat(Tt)}else vt!==null&&(He.before=vt);return Oe!==void 0&&(He.after=()=>h("tbody",Oe({cols:nt.value}))),h(QVirtualScroll,{ref:T,class:e.tableClass,style:e.tableStyle,...dt.value,scrollTarget:e.virtualScrollTarget,items:J.value,type:"__qtable",tableColspan:ht.value,onVirtualScroll:Be},He)}const _i=[Vt()];return vt!==null&&_i.unshift(vt()),getTableMiddle({class:["q-table__middle scroll",e.tableClass],style:e.tableStyle},_i)}function Ct(vt,_i){if(T.value!==null){T.value.scrollTo(vt,_i);return}vt=parseInt(vt,10);const he=_.value.querySelector(`tbody tr:nth-of-type(${vt+1})`);if(he!==null){const Oe=_.value.querySelector(".q-table__middle.scroll"),He=he.offsetTop-e.virtualScrollStickySizeStart,Tt=He<Oe.scrollTop?"decrease":"increase";Oe.scrollTop=He,t("virtualScroll",{index:vt,from:0,to:U.value.rowsPerPage-1,direction:Tt})}}function Be(vt){t("virtualScroll",vt)}function Xt(){return[h(QLinearProgress,{class:"q-table__linear-progress",color:e.color,dark:d.value,indeterminate:!0,trackColor:"transparent"})]}function ni(vt,_i,he){const Oe=b.value(vt),He=ti(Oe);if(_i!==void 0)return _i(Nt({key:Oe,row:vt,pageIndex:he,__trClass:He?"selected":""}));const Tt=r["body-cell"],le=nt.value.map(ne=>{const me=r[`body-cell-${ne.name}`],we=me!==void 0?me:Tt;return we!==void 0?we(mi({key:Oe,row:vt,pageIndex:he,col:ne})):h("td",{class:ne.__tdClass(vt),style:ne.__tdStyle(vt)},$i(ne,vt))});if(se.value===!0){const ne=r["body-selection"],me=ne!==void 0?ne(ii({key:Oe,row:vt,pageIndex:he})):[h(QCheckbox,{modelValue:He,color:e.color,dark:d.value,dense:e.dense,"onUpdate:modelValue":(we,Pe)=>{Qt([Oe],[vt],we,Pe)}})];le.unshift(h("td",{class:"q-table--col-auto-width"},me))}const Q={key:Oe,class:{selected:He}};return e.onRowClick!==void 0&&(Q.class["cursor-pointer"]=!0,Q.onClick=ne=>{t("RowClick",ne,vt,he)}),e.onRowDblclick!==void 0&&(Q.class["cursor-pointer"]=!0,Q.onDblclick=ne=>{t("RowDblclick",ne,vt,he)}),e.onRowContextmenu!==void 0&&(Q.class["cursor-pointer"]=!0,Q.onContextmenu=ne=>{t("RowContextmenu",ne,vt,he)}),h("tr",Q,le)}function Vt(){const vt=r.body,_i=r["top-row"],he=r["bottom-row"];let Oe=J.value.map((He,Tt)=>ni(He,vt,Tt));return _i!==void 0&&(Oe=_i({cols:nt.value}).concat(Oe)),he!==void 0&&(Oe=Oe.concat(he({cols:nt.value}))),h("tbody",Oe)}function Nt(vt){return Ii(vt),vt.cols=vt.cols.map(_i=>injectProp({..._i},"value",()=>$i(_i,vt.row))),vt}function mi(vt){return Ii(vt),injectProp(vt,"value",()=>$i(vt.col,vt.row)),vt}function ii(vt){return Ii(vt),vt}function Ii(vt){Object.assign(vt,{cols:nt.value,colsMap:Mt.value,sort:Et,rowIndex:yt.value+vt.pageIndex,color:e.color,dark:d.value,dense:e.dense}),se.value===!0&&injectProp(vt,"selected",()=>ti(vt.key),(_i,he)=>{Qt([vt.key],[vt.row],_i,he)}),injectProp(vt,"expand",()=>W(vt.key),_i=>{fe(vt.key,_i)})}function $i(vt,_i){const he=typeof vt.field=="function"?vt.field(_i):_i[vt.field];return vt.format!==void 0?vt.format(he,_i):he}const Ri=computed(()=>({pagination:G.value,pagesNumber:Li.value,isFirstPage:_t.value,isLastPage:si.value,firstPage:mt,prevPage:$t,nextPage:Mi,lastPage:Di,inFullscreen:g.value,toggleFullscreen:a}));function Ni(){const vt=r.top,_i=r["top-left"],he=r["top-right"],Oe=r["top-selection"],He=se.value===!0&&Oe!==void 0&&qt.value>0,Tt="q-table__top relative-position row items-center";if(vt!==void 0)return h("div",{class:Tt},[vt(Ri.value)]);let le;if(He===!0?le=Oe(Ri.value).slice():(le=[],_i!==void 0?le.push(h("div",{class:"q-table__control"},[_i(Ri.value)])):e.title&&le.push(h("div",{class:"q-table__control"},[h("div",{class:["q-table__title",e.titleClass]},e.title)]))),he!==void 0&&(le.push(h("div",{class:"q-table__separator col"})),le.push(h("div",{class:"q-table__control"},[he(Ri.value)]))),le.length!==0)return h("div",{class:Tt},le)}const zi=computed(()=>Ge.value===!0?null:We.value);function Ki(){const vt=_r();return e.loading===!0&&r.loading===void 0&&vt.push(h("tr",{class:"q-table__progress"},[h("th",{class:"relative-position",colspan:ht.value},Xt())])),h("thead",vt)}function _r(){const vt=r.header,_i=r["header-cell"];if(vt!==void 0)return vt(cr({header:!0})).slice();const he=nt.value.map(Oe=>{const He=r[`header-cell-${Oe.name}`],Tt=He!==void 0?He:_i,le=cr({col:Oe});return Tt!==void 0?Tt(le):h(QTh,{key:Oe.name,props:le},()=>Oe.label)});if(Me.value===!0&&e.grid!==!0)he.unshift(h("th",{class:"q-table--col-auto-width"}," "));else if(Ie.value===!0){const Oe=r["header-selection"],He=Oe!==void 0?Oe(cr({})):[h(QCheckbox,{color:e.color,modelValue:zi.value,dark:d.value,dense:e.dense,"onUpdate:modelValue":ur})];he.unshift(h("th",{class:"q-table--col-auto-width"},He))}return[h("tr",{class:e.tableHeaderClass,style:e.tableHeaderStyle},he)]}function cr(vt){return Object.assign(vt,{cols:nt.value,sort:Et,colsMap:Mt.value,color:e.color,dark:d.value,dense:e.dense}),Ie.value===!0&&injectProp(vt,"selected",()=>zi.value,ur),vt}function ur(vt){Ge.value===!0&&(vt=!1),Qt(J.value.map(b.value),J.value,vt)}const Ur=computed(()=>{const vt=[e.iconFirstPage||s.iconSet.table.firstPage,e.iconPrevPage||s.iconSet.table.prevPage,e.iconNextPage||s.iconSet.table.nextPage,e.iconLastPage||s.iconSet.table.lastPage];return s.lang.rtl===!0?vt.reverse():vt});function nn(){if(e.hideBottom===!0)return;if(Ci.value===!0){if(e.hideNoData===!0)return;const he=e.loading===!0?e.loadingLabel||s.lang.table.loading:e.filter?e.noResultsLabel||s.lang.table.noResults:e.noDataLabel||s.lang.table.noData,Oe=r["no-data"],He=Oe!==void 0?[Oe({message:he,icon:s.iconSet.table.warning,filter:e.filter})]:[h(QIcon,{class:"q-table__bottom-nodata-icon",name:s.iconSet.table.warning}),he];return h("div",{class:bottomClass+" q-table__bottom--nodata"},He)}const vt=r.bottom;if(vt!==void 0)return h("div",{class:bottomClass},[vt(Ri.value)]);const _i=e.hideSelectedBanner!==!0&&se.value===!0&&qt.value>0?[h("div",{class:"q-table__control"},[h("div",[(e.selectedRowsLabel||s.lang.table.selectedRecords)(qt.value)])])]:[];if(e.hidePagination!==!0)return h("div",{class:bottomClass+" justify-end"},Kr(_i));if(_i.length>0)return h("div",{class:bottomClass},_i)}function Er(vt){H({page:1,rowsPerPage:vt.value})}function Kr(vt){let _i;const{rowsPerPage:he}=G.value,Oe=e.paginationLabel||s.lang.table.pagination,He=r.pagination,Tt=e.rowsPerPageOptions.length>1;if(vt.push(h("div",{class:"q-table__separator col"})),Tt===!0&&vt.push(h("div",{class:"q-table__control"},[h("span",{class:"q-table__bottom-item"},[e.rowsPerPageLabel||s.lang.table.recordsPerPage]),h(QSelect,{class:"q-table__select inline q-table__bottom-item",color:e.color,modelValue:he,options:vi.value,displayValue:he===0?s.lang.table.allRows:he,dark:d.value,borderless:!0,dense:!0,optionsDense:!0,optionsCover:!0,"onUpdate:modelValue":Er})])),He!==void 0)_i=He(Ri.value);else if(_i=[h("span",he!==0?{class:"q-table__bottom-item"}:{},[he?Oe(yt.value+1,Math.min(Bt.value,ci.value),ci.value):Oe(1,ae.value,ci.value)])],he!==0&&Li.value>1){const le={color:e.color,round:!0,dense:!0,flat:!0};e.dense===!0&&(le.size="sm"),Li.value>2&&_i.push(h(QBtn,{key:"pgFirst",...le,icon:Ur.value[0],disable:_t.value,onClick:mt})),_i.push(h(QBtn,{key:"pgPrev",...le,icon:Ur.value[1],disable:_t.value,onClick:$t}),h(QBtn,{key:"pgNext",...le,icon:Ur.value[2],disable:si.value,onClick:Mi})),Li.value>2&&_i.push(h(QBtn,{key:"pgLast",...le,icon:Ur.value[3],disable:si.value,onClick:Di}))}return vt.push(h("div",{class:"q-table__control"},_i)),vt}function on(){const vt=e.gridHeader===!0?[h("table",{class:"q-table"},[Ki()])]:e.loading===!0&&r.loading===void 0?Xt():void 0;return h("div",{class:"q-table__middle"},vt)}function an(){const vt=r.item!==void 0?r.item:_i=>{const he=_i.cols.map(He=>h("div",{class:"q-table__grid-item-row"},[h("div",{class:"q-table__grid-item-title"},[He.label]),h("div",{class:"q-table__grid-item-value"},[He.value])]));if(se.value===!0){const He=r["body-selection"],Tt=He!==void 0?He(_i):[h(QCheckbox,{modelValue:_i.selected,color:e.color,dark:d.value,dense:e.dense,"onUpdate:modelValue":(le,Q)=>{Qt([_i.key],[_i.row],le,Q)}})];he.unshift(h("div",{class:"q-table__grid-item-row"},Tt),h(QSeparator,{dark:d.value}))}const Oe={class:["q-table__grid-item-card"+D.value,e.cardClass],style:e.cardStyle};return(e.onRowClick!==void 0||e.onRowDblclick!==void 0)&&(Oe.class[0]+=" cursor-pointer",e.onRowClick!==void 0&&(Oe.onClick=He=>{t("RowClick",He,_i.row,_i.pageIndex)}),e.onRowDblclick!==void 0&&(Oe.onDblclick=He=>{t("RowDblclick",He,_i.row,_i.pageIndex)})),h("div",{class:"q-table__grid-item col-xs-12 col-sm-6 col-md-4 col-lg-3"+(_i.selected===!0?" q-table__grid-item--selected":"")},[h("div",Oe,he)])};return h("div",{class:["q-table__grid-content row",e.cardContainerClass],style:e.cardContainerStyle},J.value.map((_i,he)=>vt(Nt({key:b.value(_i),row:_i,pageIndex:he}))))}return Object.assign(o.proxy,{requestServerInteraction:te,setPagination:H,firstPage:mt,prevPage:$t,nextPage:Mi,lastPage:Di,isRowSelected:ti,clearSelection:Ut,isRowExpanded:W,setExpanded:_e,sort:Et,resetVirtualScroll:ei,scrollTo:Ct,getCellValue:$i}),injectMultipleProps(o.proxy,{filteredSortedRows:()=>re.value,computedRows:()=>J.value,computedRowsNumber:()=>ci.value}),()=>{const vt=[Ni()],_i={ref:_,class:O.value};return e.grid===!0?vt.push(on()):Object.assign(_i,{class:[_i.class,e.cardClass],style:e.cardStyle}),vt.push(ct(),nn()),e.loading===!0&&r.loading!==void 0&&vt.push(r.loading()),h("div",_i,vt)}}}),QTabPanels=createComponent({name:"QTabPanels",props:{...usePanelProps,...useDarkProps},emits:usePanelEmits,setup(e,{slots:r}){const t=getCurrentInstance(),o=useDark(e,t.proxy.$q),{updatePanelsList:s,getPanelContent:d,panelDirectives:g}=usePanel(),a=computed(()=>"q-tab-panels q-panel-parent"+(o.value===!0?" q-tab-panels--dark q-dark":""));return()=>(s(r),hDir("div",{class:a.value},d(),"pan",e.swipeable,()=>g.value))}}),QPageContainer=createComponent({name:"QPageContainer",setup(e,{slots:r}){const{proxy:{$q:t}}=getCurrentInstance(),o=inject(layoutKey,emptyRenderFn);if(o===emptyRenderFn)return console.error("QPageContainer needs to be child of QLayout"),emptyRenderFn;provide(pageContainerKey,!0);const s=computed(()=>{const d={};return o.header.space===!0&&(d.paddingTop=`${o.header.size}px`),o.right.space===!0&&(d[`padding${t.lang.rtl===!0?"Left":"Right"}`]=`${o.right.size}px`),o.footer.space===!0&&(d.paddingBottom=`${o.footer.size}px`),o.left.space===!0&&(d[`padding${t.lang.rtl===!0?"Right":"Left"}`]=`${o.left.size}px`),d});return()=>h("div",{class:"q-page-container",style:s.value},hSlot(r.default))}}),{passive}=listenOpts,axisValues=["both","horizontal","vertical"],QScrollObserver=createComponent({name:"QScrollObserver",props:{axis:{type:String,validator:e=>axisValues.includes(e),default:"vertical"},debounce:[String,Number],scrollTarget:{default:void 0}},emits:["scroll"],setup(e,{emit:r}){const t={position:{top:0,left:0},direction:"down",directionChanged:!1,delta:{top:0,left:0},inflectionPoint:{top:0,left:0}};let o=null,s,d;watch(()=>e.scrollTarget,()=>{b(),a()});function g(){o!==null&&o();const C=Math.max(0,getVerticalScrollPosition(s)),D=getHorizontalScrollPosition(s),k={top:C-t.position.top,left:D-t.position.left};if(e.axis==="vertical"&&k.top===0||e.axis==="horizontal"&&k.left===0)return;const O=Math.abs(k.top)>=Math.abs(k.left)?k.top<0?"up":"down":k.left<0?"left":"right";t.position={top:C,left:D},t.directionChanged=t.direction!==O,t.delta=k,t.directionChanged===!0&&(t.direction=O,t.inflectionPoint=t.position),r("scroll",{...t})}function a(){s=getScrollTarget(d,e.scrollTarget),s.addEventListener("scroll",_,passive),_(!0)}function b(){s!==void 0&&(s.removeEventListener("scroll",_,passive),s=void 0)}function _(C){if(C===!0||e.debounce===0||e.debounce==="0")g();else if(o===null){const[D,k]=e.debounce?[setTimeout(g,e.debounce),clearTimeout]:[requestAnimationFrame(g),cancelAnimationFrame];o=()=>{k(D),o=null}}}const{proxy:T}=getCurrentInstance();return watch(()=>T.$q.lang.rtl,g),onMounted(()=>{d=T.$el.parentNode,a()}),onBeforeUnmount(()=>{o!==null&&o(),b()}),Object.assign(T,{trigger:_,getPosition:()=>t}),noop}}),QLayout=createComponent({name:"QLayout",props:{container:Boolean,view:{type:String,default:"hhh lpr fff",validator:e=>/^(h|l)h(h|r) lpr (f|l)f(f|r)$/.test(e.toLowerCase())},onScroll:Function,onScrollHeight:Function,onResize:Function},setup(e,{slots:r,emit:t}){const{proxy:{$q:o}}=getCurrentInstance(),s=ref(null),d=ref(o.screen.height),g=ref(e.container===!0?0:o.screen.width),a=ref({position:0,direction:"down",inflectionPoint:0}),b=ref(0),_=ref(isRuntimeSsrPreHydration.value===!0?0:getScrollbarWidth()),T=computed(()=>"q-layout q-layout--"+(e.container===!0?"containerized":"standard")),C=computed(()=>e.container===!1?{minHeight:o.screen.height+"px"}:null),D=computed(()=>_.value!==0?{[o.lang.rtl===!0?"left":"right"]:`${_.value}px`}:null),k=computed(()=>_.value!==0?{[o.lang.rtl===!0?"right":"left"]:0,[o.lang.rtl===!0?"left":"right"]:`-${_.value}px`,width:`calc(100% + ${_.value}px)`}:null);function O(Z){if(e.container===!0||document.qScrollPrevented!==!0){const W={position:Z.position.top,direction:Z.direction,directionChanged:Z.directionChanged,inflectionPoint:Z.inflectionPoint.top,delta:Z.delta.top};a.value=W,e.onScroll!==void 0&&t("scroll",W)}}function U(Z){const{height:W,width:_e}=Z;let fe=!1;d.value!==W&&(fe=!0,d.value=W,e.onScrollHeight!==void 0&&t("scrollHeight",W),j()),g.value!==_e&&(fe=!0,g.value=_e),fe===!0&&e.onResize!==void 0&&t("resize",Z)}function G({height:Z}){b.value!==Z&&(b.value=Z,j())}function j(){if(e.container===!0){const Z=d.value>b.value?getScrollbarWidth():0;_.value!==Z&&(_.value=Z)}}let te=null;const H={instances:{},view:computed(()=>e.view),isContainer:computed(()=>e.container),rootRef:s,height:d,containerHeight:b,scrollbarWidth:_,totalWidth:computed(()=>g.value+_.value),rows:computed(()=>{const Z=e.view.toLowerCase().split(" ");return{top:Z[0].split(""),middle:Z[1].split(""),bottom:Z[2].split("")}}),header:reactive({size:0,offset:0,space:!1}),right:reactive({size:300,offset:0,space:!1}),footer:reactive({size:0,offset:0,space:!1}),left:reactive({size:300,offset:0,space:!1}),scroll:a,animate(){te!==null?clearTimeout(te):document.body.classList.add("q-body--layout-animate"),te=setTimeout(()=>{te=null,document.body.classList.remove("q-body--layout-animate")},155)},update(Z,W,_e){H[Z][W]=_e}};if(provide(layoutKey,H),getScrollbarWidth()>0){let _e=function(){Z=null,W.classList.remove("hide-scrollbar")},fe=function(){if(Z===null){if(W.scrollHeight>o.screen.height)return;W.classList.add("hide-scrollbar")}else clearTimeout(Z);Z=setTimeout(_e,300)},re=function(ae){Z!==null&&ae==="remove"&&(clearTimeout(Z),_e()),window[`${ae}EventListener`]("resize",fe)},Z=null;const W=document.body;watch(()=>e.container!==!0?"add":"remove",re),e.container!==!0&&re("add"),onUnmounted(()=>{re("remove")})}return()=>{const Z=hMergeSlot(r.default,[h(QScrollObserver,{onScroll:O}),h(QResizeObserver,{onResize:U})]),W=h("div",{class:T.value,style:C.value,ref:e.container===!0?void 0:s,tabindex:-1},Z);return e.container===!0?h("div",{class:"q-layout-container overflow-hidden",ref:s},[h(QResizeObserver,{onResize:G}),h("div",{class:"absolute-full",style:D.value},[h("div",{class:"scroll",style:k.value},[W])])]):W}}});function getDepth$1(e){if(e===!1)return 0;if(e===!0||e===void 0)return 1;const r=parseInt(e,10);return isNaN(r)?0:r}const ClosePopup=createDirective({name:"close-popup",beforeMount(e,{value:r}){const t={depth:getDepth$1(r),handler(o){t.depth!==0&&setTimeout(()=>{const s=getPortalProxy(e);s!==void 0&&closePortals(s,o,t.depth)})},handlerKey(o){isKeyCode(o,13)===!0&&t.handler(o)}};e.__qclosepopup=t,e.addEventListener("click",t.handler),e.addEventListener("keyup",t.handlerKey)},updated(e,{value:r,oldValue:t}){r!==t&&(e.__qclosepopup.depth=getDepth$1(r))},beforeUnmount(e){const r=e.__qclosepopup;e.removeEventListener("click",r.handler),e.removeEventListener("keyup",r.handlerKey),delete e.__qclosepopup}}),QToolbar=createComponent({name:"QToolbar",props:{inset:Boolean},setup(e,{slots:r}){const t=computed(()=>"q-toolbar row no-wrap items-center"+(e.inset===!0?" q-toolbar--inset":""));return()=>h("div",{class:t.value,role:"toolbar"},hSlot(r.default))}});class Store{constructor(r="unreal-mapbox",t="keyval"){this.storeName=t,this._dbp=new Promise((o,s)=>{const d=indexedDB.open(r,3);d.onerror=()=>s(d.error),d.onsuccess=()=>o(d.result),d.onupgradeneeded=()=>{try{d.result.deleteObjectStore(t)}catch{}d.result.createObjectStore(t)}})}_withIDBStore(r,t){return this._dbp.then(o=>new Promise((s,d)=>{const g=o.transaction(this.storeName,r);g.oncomplete=()=>s(),g.onabort=g.onerror=()=>d(g.error),t(g.objectStore(this.storeName))}))}}let store;function getDefaultStore(){return store||(store=new Store),store}function get(e,r=getDefaultStore()){let t;return r._withIDBStore("readonly",o=>{t=o.get(e)}).then(()=>t.result)}function set(e,r,t=getDefaultStore()){return t._withIDBStore("readwrite",o=>{o.put(r,e)})}function del(e,r=getDefaultStore()){return r._withIDBStore("readwrite",t=>{t.delete(e)})}function clear(e=getDefaultStore()){return e._withIDBStore("readwrite",r=>{r.clear()})}function keys(e=getDefaultStore()){const r=[];return e._withIDBStore("readonly",t=>{(t.openKeyCursor||t.openCursor).call(t).onsuccess=function(){this.result&&(r.push(this.result.key),this.result.continue())}}).then(()=>r)}const idbKeyval={keys,clear,del,set,get};function getFileHandle(){if("showOpenFilePicker"in window)return window.showOpenFilePicker().then(e=>e[0])}function getDirHandle(){if("showDirectoryPicker"in window)return window.showDirectoryPicker().then(e=>e)}async function verifyPermission(e,r){const t={};return r&&(t.writable=!0,t.mode="readwrite"),await e.queryPermission(t)==="granted"||await e.requestPermission(t)==="granted"}async function writeFileToDisk(e,r,t){let s=await(await e.getFileHandle(r,{create:!0})).createWritable();await s.write(t),await s.close()}async function fileExists(e,r){try{return await e.getFileHandle(r),!0}catch(t){if(t.name==="NotFoundError")return!1;if(t.name==="NotAllowedError")return console.log("Please select directory to verify permissions"),!1}}async function readFileFromDisk(e,r){return await(await(await e.getFileHandle(r)).getFile()).arrayBuffer()}function checkFileApiSupport(){let e;return"showDirectoryPicker"in window?e=!0:e=!1,e}const fileUtils={getDirHandle,verifyPermission,writeFileToDisk,fileExists,getFileHandle,readFileFromDisk,checkFileApiSupport};var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function getAugmentedNamespace(e){if(e.__esModule)return e;var r=e.default;if(typeof r=="function"){var t=function o(){if(this instanceof o){var s=[null];s.push.apply(s,arguments);var d=Function.bind.apply(r,s);return new d}return r.apply(this,arguments)};t.prototype=r.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(e).forEach(function(o){var s=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,s.get?s:{enumerable:!0,get:function(){return e[o]}})}),t}var mapboxGl={exports:{}};(function(e,r){(function(t,o){e.exports=o()})(commonjsGlobal,function(){var t,o,s;function d(a,b){if(!t)t=b;else if(!o)o=b;else{var _="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+t+")(sharedChunk); ("+o+")(sharedChunk); self.onerror = null;",T={};t(T),s=b(T),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(s.workerUrl=window.URL.createObjectURL(new Blob([_],{type:"text/javascript"})))}}d(["exports"],function(a){var b=typeof self<"u"?self:{},_="2.14.1";let T;const C={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(T==null){const l=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{T={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):l}catch{T=l}}return T},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!C.API_URL)return null;try{const l=new URL(C.API_URL);return l.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":l.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},D={supported:!1,testSupport:function(l){!U&&O&&(G?j(l):k=l)}};let k,O,U=!1,G=!1;function j(l){const n=l.createTexture();l.bindTexture(l.TEXTURE_2D,n);try{if(l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,O),l.isContextLost())return;D.supported=!0}catch{}l.deleteTexture(n),U=!0}b.document&&(O=b.document.createElement("img"),O.onload=function(){k&&j(k),k=null,G=!0},O.onerror=function(){U=!0,k=null},O.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const te="01";var H=Z;function Z(l,n,c,f){this.cx=3*l,this.bx=3*(c-l)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(f-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=l,this.p1y=n,this.p2x=c,this.p2y=f}Z.prototype={sampleCurveX:function(l){return((this.ax*l+this.bx)*l+this.cx)*l},sampleCurveY:function(l){return((this.ay*l+this.by)*l+this.cy)*l},sampleCurveDerivativeX:function(l){return(3*this.ax*l+2*this.bx)*l+this.cx},solveCurveX:function(l,n){if(n===void 0&&(n=1e-6),l<0)return 0;if(l>1)return 1;for(var c=l,f=0;f<8;f++){var m=this.sampleCurveX(c)-l;if(Math.abs(m)<n)return c;var x=this.sampleCurveDerivativeX(c);if(Math.abs(x)<1e-6)break;c-=m/x}var E=0,M=1;for(c=l,f=0;f<20&&(m=this.sampleCurveX(c),!(Math.abs(m-l)<n));f++)l>m?E=c:M=c,c=.5*(M-E)+E;return c},solve:function(l,n){return this.sampleCurveY(this.solveCurveX(l,n))}};var W=_e;function _e(l,n){this.x=l,this.y=n}_e.prototype={clone:function(){return new _e(this.x,this.y)},add:function(l){return this.clone()._add(l)},sub:function(l){return this.clone()._sub(l)},multByPoint:function(l){return this.clone()._multByPoint(l)},divByPoint:function(l){return this.clone()._divByPoint(l)},mult:function(l){return this.clone()._mult(l)},div:function(l){return this.clone()._div(l)},rotate:function(l){return this.clone()._rotate(l)},rotateAround:function(l,n){return this.clone()._rotateAround(l,n)},matMult:function(l){return this.clone()._matMult(l)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(l){return this.x===l.x&&this.y===l.y},dist:function(l){return Math.sqrt(this.distSqr(l))},distSqr:function(l){var n=l.x-this.x,c=l.y-this.y;return n*n+c*c},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(l){return Math.atan2(this.y-l.y,this.x-l.x)},angleWith:function(l){return this.angleWithSep(l.x,l.y)},angleWithSep:function(l,n){return Math.atan2(this.x*n-this.y*l,this.x*l+this.y*n)},_matMult:function(l){var n=l[2]*this.x+l[3]*this.y;return this.x=l[0]*this.x+l[1]*this.y,this.y=n,this},_add:function(l){return this.x+=l.x,this.y+=l.y,this},_sub:function(l){return this.x-=l.x,this.y-=l.y,this},_mult:function(l){return this.x*=l,this.y*=l,this},_div:function(l){return this.x/=l,this.y/=l,this},_multByPoint:function(l){return this.x*=l.x,this.y*=l.y,this},_divByPoint:function(l){return this.x/=l.x,this.y/=l.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var l=this.y;return this.y=this.x,this.x=-l,this},_rotate:function(l){var n=Math.cos(l),c=Math.sin(l),f=c*this.x+n*this.y;return this.x=n*this.x-c*this.y,this.y=f,this},_rotateAround:function(l,n){var c=Math.cos(l),f=Math.sin(l),m=n.y+f*(this.x-n.x)+c*(this.y-n.y);return this.x=n.x+c*(this.x-n.x)-f*(this.y-n.y),this.y=m,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},_e.convert=function(l){return l instanceof _e?l:Array.isArray(l)?new _e(l[0],l[1]):l};const fe=Math.PI/180,re=180/Math.PI;function ae(l){return l*fe}function J(l){return l*re}const se=[[0,0],[1,0],[1,1],[0,1]];function Me(l){if(l<=0)return 0;if(l>=1)return 1;const n=l*l,c=n*l;return 4*(l<.5?c:3*(l-n)+c-.75)}function Ie(l,n,c,f){const m=new H(l,n,c,f);return function(x){return m.solve(x)}}const We=Ie(.25,.1,.25,1);function Ge(l,n,c){return Math.min(c,Math.max(n,l))}function qt(l,n,c){return(c=Ge((c-l)/(n-l),0,1))*c*(3-2*c)}function ti(l,n,c){const f=c-n,m=((l-n)%f+f)%f+n;return m===n?c:m}function Ut(l,n,c){if(!l.length)return c(null,[]);let f=l.length;const m=new Array(l.length);let x=null;l.forEach((E,M)=>{n(E,(I,P)=>{I&&(x=I),m[M]=P,--f==0&&c(x,m)})})}function Qt(l){const n=[];for(const c in l)n.push(l[c]);return n}function tt(l,...n){for(const c of n)for(const f in c)l[f]=c[f];return l}let nt=1;function Mt(){return nt++}function ht(){return function l(n){return n?(n^Math.random()*(16>>n/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,l)}()}function xt(l){return l<=1?1:Math.pow(2,Math.ceil(Math.log(l)/Math.LN2))}function It(l){return!!l&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(l)}function Et(l,n){l.forEach(c=>{n[c]&&(n[c]=n[c].bind(n))})}function yt(l,n){return l.indexOf(n,l.length-n.length)!==-1}function Bt(l,n,c){const f={};for(const m in l)f[m]=n.call(c||this,l[m],m,l);return f}function _t(l,n,c){const f={};for(const m in l)n.call(c||this,l[m],m,l)&&(f[m]=l[m]);return f}function si(l){return Array.isArray(l)?l.map(si):typeof l=="object"&&l?Bt(l,si):l}const Li={};function vi(l){Li[l]||(typeof console<"u"&&console.warn(l),Li[l]=!0)}function ci(l,n,c){return(c.y-l.y)*(n.x-l.x)>(n.y-l.y)*(c.x-l.x)}function mt(l){let n=0;for(let c,f,m=0,x=l.length,E=x-1;m<x;E=m++)c=l[m],f=l[E],n+=(f.x-c.x)*(c.y+f.y);return n}function $t(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function Mi(l){const n={};if(l.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(c,f,m,x)=>{const E=m||x;return n[f]=!E||E.toLowerCase(),""}),n["max-age"]){const c=parseInt(n["max-age"],10);isNaN(c)?delete n["max-age"]:n["max-age"]=c}return n}let Di=null;function Ci(l){if(Di==null){const n=l.navigator?l.navigator.userAgent:null;Di=!!l.safari||!(!n||!(/\b(iPad|iPhone|iPod)\b/.test(n)||n.match("Safari")&&!n.match("Chrome")))}return Di}function dt(l){try{const n=b[l];return n.setItem("_mapbox_test_",1),n.removeItem("_mapbox_test_"),!0}catch{return!1}}function ei(l,n){return[l[4*n],l[4*n+1],l[4*n+2],l[4*n+3]]}const ct="mapbox-tiles";let Ct,Be,Xt=500,ni=50;function Vt(){try{return b.caches}catch{}}function Nt(){Vt()&&!Ct&&(Ct=b.caches.open(ct))}function mi(l){const n=l.indexOf("?");if(n<0)return l;const c=function(m){const x=m.indexOf("?");return x>0?m.slice(x+1).split("&"):[]}(l),f=c.filter(m=>{const x=m.split("=");return x[0]==="language"||x[0]==="worldview"});return f.length?`${l.slice(0,n)}?${f.join("&")}`:l.slice(0,n)}let ii=1/0;const Ii={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(Ii);class $i extends Error{constructor(n,c,f){c===401&&Kr(f)&&(n+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(n),this.status=c,this.url=f}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Ri=$t()?()=>self.worker&&self.worker.referrer:()=>(b.location.protocol==="blob:"?b.parent:b).location.href,Ni=function(l,n){if(!(/^file:/.test(c=l.url)||/^file:/.test(Ri())&&!/^\w+:/.test(c))){if(b.fetch&&b.Request&&b.AbortController&&b.Request.prototype.hasOwnProperty("signal"))return function(f,m){const x=new b.AbortController,E=new b.Request(f.url,{method:f.method||"GET",body:f.body,credentials:f.credentials,headers:f.headers,referrer:Ri(),referrerPolicy:f.referrerPolicy,signal:x.signal});let M=!1,I=!1;const P=(z=E.url).indexOf("sku=")>0&&Kr(z);var z;f.type==="json"&&E.headers.set("Accept","application/json");const N=(K,ee,oe)=>{if(I)return;if(K&&K.message!=="SecurityError"&&vi(K),ee&&oe)return q(ee);const pe=Date.now();b.fetch(E).then(Ee=>{if(Ee.ok){const Re=P?Ee.clone():null;return q(Ee,Re,pe)}return m(new $i(Ee.statusText,Ee.status,f.url))}).catch(Ee=>{Ee.name!=="AbortError"&&m(new Error(`${Ee.message} ${f.url}`))})},q=(K,ee,oe)=>{(f.type==="arrayBuffer"?K.arrayBuffer():f.type==="json"?K.json():K.text()).then(pe=>{I||(ee&&oe&&function(Ee,Re,be){if(Nt(),!Ct)return;const De={status:Re.status,statusText:Re.statusText,headers:new b.Headers};Re.headers.forEach((st,it)=>De.headers.set(it,st));const ze=Mi(Re.headers.get("Cache-Control")||"");if(ze["no-store"])return;ze["max-age"]&&De.headers.set("Expires",new Date(be+1e3*ze["max-age"]).toUTCString());const Le=De.headers.get("Expires");Le&&(new Date(Le).getTime()-be<42e4||function(st,it){if(Be===void 0)try{new Response(new ReadableStream),Be=!0}catch{Be=!1}Be?it(st.body):st.blob().then(it)}(Re,st=>{const it=new b.Response(st,De);Nt(),Ct&&Ct.then(wt=>wt.put(mi(Ee.url),it)).catch(wt=>vi(wt.message))}))}(E,ee,oe),M=!0,m(null,pe,K.headers.get("Cache-Control"),K.headers.get("Expires")))}).catch(pe=>{I||m(new Error(pe.message))})};return P?function(K,ee){if(Nt(),!Ct)return ee(null);const oe=mi(K.url);Ct.then(pe=>{pe.match(oe).then(Ee=>{const Re=function(be){if(!be)return!1;const De=new Date(be.headers.get("Expires")||0),ze=Mi(be.headers.get("Cache-Control")||"");return De>Date.now()&&!ze["no-cache"]}(Ee);pe.delete(oe),Re&&pe.put(oe,Ee.clone()),ee(null,Ee,Re)}).catch(ee)}).catch(ee)}(E,N):N(null,null),{cancel:()=>{I=!0,M||x.abort()}}}(l,n);if($t()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",l,n,void 0,!0)}var c;return function(f,m){const x=new b.XMLHttpRequest;x.open(f.method||"GET",f.url,!0),f.type==="arrayBuffer"&&(x.responseType="arraybuffer");for(const E in f.headers)x.setRequestHeader(E,f.headers[E]);return f.type==="json"&&(x.responseType="text",x.setRequestHeader("Accept","application/json")),x.withCredentials=f.credentials==="include",x.onerror=()=>{m(new Error(x.statusText))},x.onload=()=>{if((x.status>=200&&x.status<300||x.status===0)&&x.response!==null){let E=x.response;if(f.type==="json")try{E=JSON.parse(x.response)}catch(M){return m(M)}m(null,E,x.getResponseHeader("Cache-Control"),x.getResponseHeader("Expires"))}else m(new $i(x.statusText,x.status,f.url))},x.send(f.body),{cancel:()=>x.abort()}}(l,n)},zi=function(l,n){return Ni(tt(l,{type:"arrayBuffer"}),n)};function Ki(l){const n=b.document.createElement("a");return n.href=l,n.protocol===b.document.location.protocol&&n.host===b.document.location.host}const _r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let cr,ur;cr=[],ur=0;const Ur=function(l,n){if(D.supported&&(l.headers||(l.headers={}),l.headers.accept="image/webp,*/*"),ur>=C.MAX_PARALLEL_IMAGE_REQUESTS){const x={requestParameters:l,callback:n,cancelled:!1,cancel(){this.cancelled=!0}};return cr.push(x),x}ur++;let c=!1;const f=()=>{if(!c)for(c=!0,ur--;cr.length&&ur<C.MAX_PARALLEL_IMAGE_REQUESTS;){const x=cr.shift(),{requestParameters:E,callback:M,cancelled:I}=x;I||(x.cancel=Ur(E,M).cancel)}},m=zi(l,(x,E,M,I)=>{f(),x?n(x):E&&(b.createImageBitmap?function(P,z){const N=new b.Blob([new Uint8Array(P)],{type:"image/png"});b.createImageBitmap(N).then(q=>{z(null,q)}).catch(q=>{z(new Error(`Could not load image because of ${q.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(E,(P,z)=>n(P,z,M,I)):function(P,z){const N=new b.Image,q=b.URL;N.onload=()=>{z(null,N),q.revokeObjectURL(N.src),N.onload=null,b.requestAnimationFrame(()=>{N.src=_r})},N.onerror=()=>z(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const K=new b.Blob([new Uint8Array(P)],{type:"image/png"});N.src=P.byteLength?q.createObjectURL(K):_r}(E,(P,z)=>n(P,z,M,I)))});return{cancel:()=>{m.cancel(),f()}}},nn="NO_ACCESS_TOKEN";function Er(l){return l.indexOf("mapbox:")===0}function Kr(l){return C.API_URL_REGEX.test(l)}function on(l){return C.API_CDN_URL_REGEX.test(l)}function an(l){return C.API_STYLE_REGEX.test(l)&&!vt(l)}function vt(l){return C.API_SPRITE_REGEX.test(l)}const _i=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function he(l){const n=l.match(_i);if(!n)throw new Error("Unable to parse URL object");return{protocol:n[1],authority:n[2],path:n[3]||"/",params:n[4]?n[4].split("&"):[]}}function Oe(l){const n=l.params.length?`?${l.params.join("&")}`:"";return`${l.protocol}://${l.authority}${l.path}${n}`}function He(l){if(!l)return null;const n=l.split(".");if(!n||n.length!==3)return null;try{return JSON.parse(decodeURIComponent(b.atob(n[1]).split("").map(c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class Tt{constructor(n){this.type=n,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(n){const c=He(C.ACCESS_TOKEN);let f="";return f=c&&c.u?b.btoa(encodeURIComponent(c.u).replace(/%([0-9A-F]{2})/g,(m,x)=>String.fromCharCode(+("0x"+x)))):C.ACCESS_TOKEN||"",n?`mapbox.eventData.${n}:${f}`:`mapbox.eventData:${f}`}fetchEventData(){const n=dt("localStorage"),c=this.getStorageKey(),f=this.getStorageKey("uuid");if(n)try{const m=b.localStorage.getItem(c);m&&(this.eventData=JSON.parse(m));const x=b.localStorage.getItem(f);x&&(this.anonId=x)}catch{vi("Unable to read from LocalStorage")}}saveEventData(){const n=dt("localStorage"),c=this.getStorageKey(),f=this.getStorageKey("uuid");if(n)try{b.localStorage.setItem(f,this.anonId),Object.keys(this.eventData).length>=1&&b.localStorage.setItem(c,JSON.stringify(this.eventData))}catch{vi("Unable to write to LocalStorage")}}processRequests(n){}postEvent(n,c,f,m){if(!C.EVENTS_URL)return;const x=he(C.EVENTS_URL);x.params.push(`access_token=${m||C.ACCESS_TOKEN||""}`);const E={event:this.type,created:new Date(n).toISOString()},M=c?tt(E,c):E,I={url:Oe(x),headers:{"Content-Type":"text/plain"},body:JSON.stringify([M])};this.pendingRequest=function(P,z){return Ni(tt(P,{method:"POST"}),z)}(I,P=>{this.pendingRequest=null,f(P),this.saveEventData(),this.processRequests(m)})}queueRequest(n,c){this.queue.push(n),this.processRequests(c)}}const le=new class extends Tt{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,n){C.EVENTS_URL&&C.ACCESS_TOKEN&&Array.isArray(l)&&l.some(c=>Er(c)||Kr(c))&&this.queueRequest(Date.now(),n)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const n=He(C.ACCESS_TOKEN),c=n?n.u:C.ACCESS_TOKEN;let f=c!==this.eventData.tokenU;It(this.anonId)||(this.anonId=ht(),f=!0);const m=this.queue.shift();if(this.eventData.lastSuccess){const x=new Date(this.eventData.lastSuccess),E=new Date(m),M=(m-this.eventData.lastSuccess)/864e5;f=f||M>=1||M<-1||x.getDate()!==E.getDate()}else f=!0;f?this.postEvent(m,{sdkIdentifier:"mapbox-gl-js",sdkVersion:_,skuId:te,"enabled.telemetry":!1,userId:this.anonId},x=>{x||(this.eventData.lastSuccess=m,this.eventData.tokenU=c)},l):this.processRequests()}},Q=le.postTurnstileEvent.bind(le),ne=new class extends Tt{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,n,c,f){this.skuToken=n,this.errorCb=f,C.EVENTS_URL&&(c||C.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},c):this.errorCb(new Error(nn)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:n,timestamp:c}=this.queue.shift();n&&this.success[n]||(this.anonId||this.fetchEventData(),It(this.anonId)||(this.anonId=ht()),this.postEvent(c,{sdkIdentifier:"mapbox-gl-js",sdkVersion:_,skuId:te,skuToken:this.skuToken,userId:this.anonId},f=>{f?this.errorCb(f):n&&(this.success[n]=!0)},l))}},me=ne.postMapLoadEvent.bind(ne),we=new class extends Tt{constructor(){super("gljs.performance")}postPerformanceEvent(l,n){C.EVENTS_URL&&(l||C.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:n},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:n,performanceData:c}=this.queue.shift(),f=function(m){const x=b.performance.getEntriesByType("resource"),E=b.performance.getEntriesByType("mark"),M=function(q){const K={};if(q){for(const ee in q)if(ee!=="other")for(const oe of q[ee]){const pe=`${ee}ResolveRangeMin`,Ee=`${ee}ResolveRangeMax`,Re=`${ee}RequestCount`,be=`${ee}RequestCachedCount`;K[pe]=Math.min(K[pe]||1/0,oe.startTime),K[Ee]=Math.max(K[Ee]||-1/0,oe.responseEnd);const De=ze=>{K[ze]===void 0&&(K[ze]=0),++K[ze]};oe.transferSize!==void 0&&oe.transferSize===0&&De(be),De(Re)}}return K}(function(q,K){const ee={};if(q)for(const oe of q){const pe=K(oe);ee[pe]===void 0&&(ee[pe]=[]),ee[pe].push(oe)}return ee}(x,Ht)),I=b.devicePixelRatio,P=b.navigator.connection||b.navigator.mozConnection||b.navigator.webkitConnection,z={counters:[],metadata:[],attributes:[]},N=(q,K,ee)=>{ee!=null&&q.push({name:K,value:ee.toString()})};for(const q in M)N(z.counters,q,M[q]);if(m.interactionRange[0]!==1/0&&m.interactionRange[1]!==-1/0&&(N(z.counters,"interactionRangeMin",m.interactionRange[0]),N(z.counters,"interactionRangeMax",m.interactionRange[1])),E)for(const q of Object.keys(Xe)){const K=Xe[q],ee=E.find(oe=>oe.name===K);ee&&N(z.counters,K,ee.startTime)}return N(z.counters,"visibilityHidden",m.visibilityHidden),N(z.attributes,"style",function(q){if(q)for(const K of q){const ee=K.name.split("?")[0];if(an(ee)){const oe=ee.split("/").slice(-2);if(oe.length===2)return`mapbox://styles/${oe[0]}/${oe[1]}`}}}(x)),N(z.attributes,"terrainEnabled",m.terrainEnabled?"true":"false"),N(z.attributes,"fogEnabled",m.fogEnabled?"true":"false"),N(z.attributes,"projection",m.projection),N(z.attributes,"zoom",m.zoom),N(z.metadata,"devicePixelRatio",I),N(z.metadata,"connectionEffectiveType",P?P.effectiveType:void 0),N(z.metadata,"navigatorUserAgent",b.navigator.userAgent),N(z.metadata,"screenWidth",b.screen.width),N(z.metadata,"screenHeight",b.screen.height),N(z.metadata,"windowWidth",b.innerWidth),N(z.metadata,"windowHeight",b.innerHeight),N(z.metadata,"mapWidth",m.width/I),N(z.metadata,"mapHeight",m.height/I),N(z.metadata,"webglRenderer",m.renderer),N(z.metadata,"webglVendor",m.vendor),N(z.metadata,"sdkVersion",_),N(z.metadata,"sdkIdentifier","mapbox-gl-js"),z}(c);for(const m of f.metadata);for(const m of f.counters);for(const m of f.attributes);this.postEvent(n,f,()=>{},l)}},Pe=we.postPerformanceEvent.bind(we),Ye=new class extends Tt{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,n,c,f){if(!C.API_URL||!C.SESSION_PATH)return;const m=he(C.API_URL+C.SESSION_PATH);m.params.push(`sku=${n||""}`),m.params.push(`access_token=${f||C.ACCESS_TOKEN||""}`);const x={url:Oe(m),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(E,M){return Ni(tt(E,{method:"GET"}),M)}(x,E=>{this.pendingRequest=null,c(E),this.saveEventData(),this.processRequests(f)})}getSessionAPI(l,n,c,f){this.skuToken=n,this.errorCb=f,C.SESSION_PATH&&C.API_URL&&(c||C.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},c):this.errorCb(new Error(nn)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:n,timestamp:c}=this.queue.shift();n&&this.success[n]||this.getSession(c,this.skuToken,f=>{f?this.errorCb(f):n&&(this.success[n]=!0)},l)}},Ue=Ye.getSessionAPI.bind(Ye),Ne=new Set,Xe={create:"create",load:"load",fullLoad:"fullLoad"},bt={mark(l){b.performance.mark(l)},measure(l,n,c){b.performance.measure(l,n,c)}};function Ht(l){const n=l.name.split("?")[0];return on(n)&&n.includes("mapbox-gl.js")?"javascript":on(n)&&n.includes("mapbox-gl.css")?"css":function(c){return C.API_FONTS_REGEX.test(c)}(n)?"fontRange":vt(n)?"sprite":an(n)?"style":function(c){return C.API_TILEJSON_REGEX.test(c)}(n)?"tilejson":"other"}const Pt=b.performance;function Ai(l){const n=l?l.url.toString():void 0;return Pt.getEntriesByName(n)}let xi,Ei,Fi,Ce;const Yt={now:()=>Fi!==void 0?Fi:b.performance.now(),setNow(l){Fi=l},restoreNow(){Fi=void 0},frame(l){const n=b.requestAnimationFrame(l);return{cancel:()=>b.cancelAnimationFrame(n)}},getImageData(l,n=0){const{width:c,height:f}=l;Ce||(Ce=b.document.createElement("canvas"));const m=Ce.getContext("2d",{willReadFrequently:!0});if(!m)throw new Error("failed to create canvas 2d context");return(c>Ce.width||f>Ce.height)&&(Ce.width=c,Ce.height=f),m.clearRect(-n,-n,c+2*n,f+2*n),m.drawImage(l,0,0,c,f),m.getImageData(-n,-n,c+2*n,f+2*n)},resolveURL:l=>(xi||(xi=b.document.createElement("a")),xi.href=l,xi.href),get devicePixelRatio(){return b.devicePixelRatio},get prefersReducedMotion(){return!!b.matchMedia&&(Ei==null&&(Ei=b.matchMedia("(prefers-reduced-motion: reduce)")),Ei.matches)}};function At(l,n,c){c[l]&&c[l].indexOf(n)!==-1||(c[l]=c[l]||[],c[l].push(n))}function ui(l,n,c){if(c&&c[l]){const f=c[l].indexOf(n);f!==-1&&c[l].splice(f,1)}}class Bi{constructor(n,c={}){tt(this,c),this.type=n}}class rr extends Bi{constructor(n,c={}){super("error",tt({error:n},c))}}class dr{on(n,c){return this._listeners=this._listeners||{},At(n,c,this._listeners),this}off(n,c){return ui(n,c,this._listeners),ui(n,c,this._oneTimeListeners),this}once(n,c){return c?(this._oneTimeListeners=this._oneTimeListeners||{},At(n,c,this._oneTimeListeners),this):new Promise(f=>this.once(n,f))}fire(n,c){typeof n=="string"&&(n=new Bi(n,c||{}));const f=n.type;if(this.listens(f)){n.target=this;const m=this._listeners&&this._listeners[f]?this._listeners[f].slice():[];for(const M of m)M.call(this,n);const x=this._oneTimeListeners&&this._oneTimeListeners[f]?this._oneTimeListeners[f].slice():[];for(const M of x)ui(f,M,this._oneTimeListeners),M.call(this,n);const E=this._eventedParent;E&&(tt(n,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),E.fire(n))}else n instanceof rr&&console.error(n.error);return this}listens(n){return!!(this._listeners&&this._listeners[n]&&this._listeners[n].length>0||this._oneTimeListeners&&this._oneTimeListeners[n]&&this._oneTimeListeners[n].length>0||this._eventedParent&&this._eventedParent.listens(n))}setEventedParent(n,c){return this._eventedParent=n,this._eventedParentData=c,this}}var ot=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{},"globe":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["source"]}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["fill-extrusion-edge-radius"]}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":false,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"transition":false,"requires":[{"source":"geojson","has":{"lineMetrics":true}}],"property-type":"constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function Sn(l,...n){for(const c of n)for(const f in c)l[f]=c[f];return l}function Gr(l){return l instanceof Number||l instanceof String||l instanceof Boolean?l.valueOf():l}function xo(l){if(Array.isArray(l))return l.map(xo);if(l instanceof Object&&!(l instanceof Number||l instanceof String||l instanceof Boolean)){const n={};for(const c in l)n[c]=xo(l[c]);return n}return Gr(l)}class cl extends Error{constructor(n,c){super(c),this.message=c,this.key=n}}var Zn=cl;class lo{constructor(n,c=[]){this.parent=n,this.bindings={};for(const[f,m]of c)this.bindings[f]=m}concat(n){return new lo(this,n)}get(n){if(this.bindings[n])return this.bindings[n];if(this.parent)return this.parent.get(n);throw new Error(`${n} not found in scope.`)}has(n){return!!this.bindings[n]||!!this.parent&&this.parent.has(n)}}var ul=lo;const Do={kind:"null"},ri={kind:"number"},nr={kind:"string"},tr={kind:"boolean"},$n={kind:"color"},$={kind:"object"},V={kind:"value"},ue={kind:"collator"},ke={kind:"formatted"},Ve={kind:"resolvedImage"};function je(l,n){return{kind:"array",itemType:l,N:n}}function Ze(l){if(l.kind==="array"){const n=Ze(l.itemType);return typeof l.N=="number"?`array<${n}, ${l.N}>`:l.itemType.kind==="value"?"array":`array<${n}>`}return l.kind}const Wt=[Do,ri,nr,tr,$n,ke,$,je(V),Ve];function Kt(l,n){if(n.kind==="error")return null;if(l.kind==="array"){if(n.kind==="array"&&(n.N===0&&n.itemType.kind==="value"||!Kt(l.itemType,n.itemType))&&(typeof l.N!="number"||l.N===n.N))return null}else{if(l.kind===n.kind)return null;if(l.kind==="value"){for(const c of Wt)if(!Kt(c,n))return null}}return`Expected ${Ze(l)} but found ${Ze(n)} instead.`}function bi(l,n){return n.some(c=>c.kind===l.kind)}function di(l,n){return n.some(c=>c==="null"?l===null:c==="array"?Array.isArray(l):c==="object"?l&&!Array.isArray(l)&&typeof l=="object":c===typeof l)}var hi,Hi={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Ir(l){return(l=Math.round(l))<0?0:l>255?255:l}function Xi(l){return Ir(l[l.length-1]==="%"?parseFloat(l)/100*255:parseInt(l))}function zr(l){return(n=l[l.length-1]==="%"?parseFloat(l)/100:parseFloat(l))<0?0:n>1?1:n;var n}function Ot(l,n,c){return c<0?c+=1:c>1&&(c-=1),6*c<1?l+(n-l)*c*6:2*c<1?n:3*c<2?l+(n-l)*(2/3-c)*6:l}try{hi={}.parseCSSColor=function(l){var n,c=l.replace(/ /g,"").toLowerCase();if(c in Hi)return Hi[c].slice();if(c[0]==="#")return c.length===4?(n=parseInt(c.substr(1),16))>=0&&n<=4095?[(3840&n)>>4|(3840&n)>>8,240&n|(240&n)>>4,15&n|(15&n)<<4,1]:null:c.length===7&&(n=parseInt(c.substr(1),16))>=0&&n<=16777215?[(16711680&n)>>16,(65280&n)>>8,255&n,1]:null;var f=c.indexOf("("),m=c.indexOf(")");if(f!==-1&&m+1===c.length){var x=c.substr(0,f),E=c.substr(f+1,m-(f+1)).split(","),M=1;switch(x){case"rgba":if(E.length!==4)return null;M=zr(E.pop());case"rgb":return E.length!==3?null:[Xi(E[0]),Xi(E[1]),Xi(E[2]),M];case"hsla":if(E.length!==4)return null;M=zr(E.pop());case"hsl":if(E.length!==3)return null;var I=(parseFloat(E[0])%360+360)%360/360,P=zr(E[1]),z=zr(E[2]),N=z<=.5?z*(P+1):z+P-z*P,q=2*z-N;return[Ir(255*Ot(q,N,I+1/3)),Ir(255*Ot(q,N,I)),Ir(255*Ot(q,N,I-1/3)),M];default:return null}}return null}}catch{}class wi{constructor(n,c,f,m=1){this.r=n,this.g=c,this.b=f,this.a=m}static parse(n){if(!n)return;if(n instanceof wi)return n;if(typeof n!="string")return;const c=hi(n);return c?new wi(c[0]/255*c[3],c[1]/255*c[3],c[2]/255*c[3],c[3]):void 0}toString(){const[n,c,f,m]=this.toArray();return`rgba(${Math.round(n)},${Math.round(c)},${Math.round(f)},${m})`}toArray(){const{r:n,g:c,b:f,a:m}=this;return m===0?[0,0,0,0]:[255*n/m,255*c/m,255*f/m,m]}toArray01(){const{r:n,g:c,b:f,a:m}=this;return m===0?[0,0,0,0]:[n/m,c/m,f/m,m]}toArray01PremultipliedAlpha(){const{r:n,g:c,b:f,a:m}=this;return[n,c,f,m]}}wi.black=new wi(0,0,0,1),wi.white=new wi(1,1,1,1),wi.transparent=new wi(0,0,0,0),wi.red=new wi(1,0,0,1),wi.blue=new wi(0,0,1,1);var Yi=wi;class Zr{constructor(n,c,f){this.sensitivity=n?c?"variant":"case":c?"accent":"base",this.locale=f,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(n,c){return this.collator.compare(n,c)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Vr{constructor(n,c,f,m,x){this.text=n.normalize?n.normalize():n,this.image=c,this.scale=f,this.fontStack=m,this.textColor=x}}class mn{constructor(n){this.sections=n}static fromString(n){return new mn([new Vr(n,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(n=>n.text.length!==0||n.image&&n.image.name.length!==0)}static factory(n){return n instanceof mn?n:mn.fromString(n)}toString(){return this.sections.length===0?"":this.sections.map(n=>n.text).join("")}serialize(){const n=["format"];for(const c of this.sections){if(c.image){n.push(["image",c.image.name]);continue}n.push(c.text);const f={};c.fontStack&&(f["text-font"]=["literal",c.fontStack.split(",")]),c.scale&&(f["font-scale"]=c.scale),c.textColor&&(f["text-color"]=["rgba"].concat(c.textColor.toArray())),n.push(f)}return n}}class yn{constructor(n){this.name=n.name,this.available=n.available}toString(){return this.name}static fromString(n){return n?new yn({name:n,available:!1}):null}serialize(){return["image",this.name]}}function Lr(l,n,c,f){return typeof l=="number"&&l>=0&&l<=255&&typeof n=="number"&&n>=0&&n<=255&&typeof c=="number"&&c>=0&&c<=255?f===void 0||typeof f=="number"&&f>=0&&f<=1?null:`Invalid rgba value [${[l,n,c,f].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof f=="number"?[l,n,c,f]:[l,n,c]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function wa(l){if(l===null||typeof l=="string"||typeof l=="boolean"||typeof l=="number"||l instanceof Yi||l instanceof Zr||l instanceof mn||l instanceof yn)return!0;if(Array.isArray(l)){for(const n of l)if(!wa(n))return!1;return!0}if(typeof l=="object"){for(const n in l)if(!wa(l[n]))return!1;return!0}return!1}function Qr(l){if(l===null)return Do;if(typeof l=="string")return nr;if(typeof l=="boolean")return tr;if(typeof l=="number")return ri;if(l instanceof Yi)return $n;if(l instanceof Zr)return ue;if(l instanceof mn)return ke;if(l instanceof yn)return Ve;if(Array.isArray(l)){const n=l.length;let c;for(const f of l){const m=Qr(f);if(c){if(c===m)continue;c=V;break}c=m}return je(c||V,n)}return $}function Bn(l){const n=typeof l;return l===null?"":n==="string"||n==="number"||n==="boolean"?String(l):l instanceof Yi||l instanceof mn||l instanceof yn?l.toString():JSON.stringify(l)}class Ya{constructor(n,c){this.type=n,this.value=c}static parse(n,c){if(n.length!==2)return c.error(`'literal' expression requires exactly one argument, but found ${n.length-1} instead.`);if(!wa(n[1]))return c.error("invalid value");const f=n[1];let m=Qr(f);const x=c.expectedType;return m.kind!=="array"||m.N!==0||!x||x.kind!=="array"||typeof x.N=="number"&&x.N!==0||(m=x),new Ya(m,f)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Yi?["rgba"].concat(this.value.toArray()):this.value instanceof mn?this.value.serialize():this.value}}var Jo=Ya,hn=class{constructor(l){this.name="ExpressionEvaluationError",this.message=l}toJSON(){return this.message}};const ea={string:nr,number:ri,boolean:tr,object:$};class Ro{constructor(n,c){this.type=n,this.args=c}static parse(n,c){if(n.length<2)return c.error("Expected at least one argument.");let f,m=1;const x=n[0];if(x==="array"){let M,I;if(n.length>2){const P=n[1];if(typeof P!="string"||!(P in ea)||P==="object")return c.error('The item type argument of "array" must be one of string, number, boolean',1);M=ea[P],m++}else M=V;if(n.length>3){if(n[2]!==null&&(typeof n[2]!="number"||n[2]<0||n[2]!==Math.floor(n[2])))return c.error('The length argument to "array" must be a positive integer literal',2);I=n[2],m++}f=je(M,I)}else f=ea[x];const E=[];for(;m<n.length;m++){const M=c.parse(n[m],m,V);if(!M)return null;E.push(M)}return new Ro(f,E)}evaluate(n){for(let c=0;c<this.args.length;c++){const f=this.args[c].evaluate(n);if(!Kt(this.type,Qr(f)))return f;if(c===this.args.length-1)throw new hn(`Expected value to be of type ${Ze(this.type)}, but found ${Ze(Qr(f))} instead.`)}return null}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}serialize(){const n=this.type,c=[n.kind];if(n.kind==="array"){const f=n.itemType;if(f.kind==="string"||f.kind==="number"||f.kind==="boolean"){c.push(f.kind);const m=n.N;(typeof m=="number"||this.args.length>1)&&c.push(m)}}return c.concat(this.args.map(f=>f.serialize()))}}var Qn=Ro;class Ea{constructor(n){this.type=ke,this.sections=n}static parse(n,c){if(n.length<2)return c.error("Expected at least one argument.");const f=n[1];if(!Array.isArray(f)&&typeof f=="object")return c.error("First argument must be an image or text section.");const m=[];let x=!1;for(let E=1;E<=n.length-1;++E){const M=n[E];if(x&&typeof M=="object"&&!Array.isArray(M)){x=!1;let I=null;if(M["font-scale"]&&(I=c.parse(M["font-scale"],1,ri),!I))return null;let P=null;if(M["text-font"]&&(P=c.parse(M["text-font"],1,je(nr)),!P))return null;let z=null;if(M["text-color"]&&(z=c.parse(M["text-color"],1,$n),!z))return null;const N=m[m.length-1];N.scale=I,N.font=P,N.textColor=z}else{const I=c.parse(n[E],1,V);if(!I)return null;const P=I.type.kind;if(P!=="string"&&P!=="value"&&P!=="null"&&P!=="resolvedImage")return c.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");x=!0,m.push({content:I,scale:null,font:null,textColor:null})}}return new Ea(m)}evaluate(n){return new mn(this.sections.map(c=>{const f=c.content.evaluate(n);return Qr(f)===Ve?new Vr("",f,null,null,null):new Vr(Bn(f),null,c.scale?c.scale.evaluate(n):null,c.font?c.font.evaluate(n).join(","):null,c.textColor?c.textColor.evaluate(n):null)}))}eachChild(n){for(const c of this.sections)n(c.content),c.scale&&n(c.scale),c.font&&n(c.font),c.textColor&&n(c.textColor)}outputDefined(){return!1}serialize(){const n=["format"];for(const c of this.sections){n.push(c.content.serialize());const f={};c.scale&&(f["font-scale"]=c.scale.serialize()),c.font&&(f["text-font"]=c.font.serialize()),c.textColor&&(f["text-color"]=c.textColor.serialize()),n.push(f)}return n}}class Wa{constructor(n){this.type=Ve,this.input=n}static parse(n,c){if(n.length!==2)return c.error("Expected two arguments.");const f=c.parse(n[1],1,nr);return f?new Wa(f):c.error("No image name provided.")}evaluate(n){const c=this.input.evaluate(n),f=yn.fromString(c);return f&&n.availableImages&&(f.available=n.availableImages.indexOf(c)>-1),f}eachChild(n){n(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const Yl={"to-boolean":tr,"to-color":$n,"to-number":ri,"to-string":nr};class Ka{constructor(n,c){this.type=n,this.args=c}static parse(n,c){if(n.length<2)return c.error("Expected at least one argument.");const f=n[0];if((f==="to-boolean"||f==="to-string")&&n.length!==2)return c.error("Expected one argument.");const m=Yl[f],x=[];for(let E=1;E<n.length;E++){const M=c.parse(n[E],E,V);if(!M)return null;x.push(M)}return new Ka(m,x)}evaluate(n){if(this.type.kind==="boolean")return!!this.args[0].evaluate(n);if(this.type.kind==="color"){let c,f;for(const m of this.args){if(c=m.evaluate(n),f=null,c instanceof Yi)return c;if(typeof c=="string"){const x=n.parseColor(c);if(x)return x}else if(Array.isArray(c)&&(f=c.length<3||c.length>4?`Invalid rbga value ${JSON.stringify(c)}: expected an array containing either three or four numeric values.`:Lr(c[0],c[1],c[2],c[3]),!f))return new Yi(c[0]/255,c[1]/255,c[2]/255,c[3])}throw new hn(f||`Could not parse color from value '${typeof c=="string"?c:String(JSON.stringify(c))}'`)}if(this.type.kind==="number"){let c=null;for(const f of this.args){if(c=f.evaluate(n),c===null)return 0;const m=Number(c);if(!isNaN(m))return m}throw new hn(`Could not convert ${JSON.stringify(c)} to number.`)}return this.type.kind==="formatted"?mn.fromString(Bn(this.args[0].evaluate(n))):this.type.kind==="resolvedImage"?yn.fromString(Bn(this.args[0].evaluate(n))):Bn(this.args[0].evaluate(n))}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Ea([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Wa(this.args[0]).serialize();const n=[`to-${this.type.kind}`];return this.eachChild(c=>{n.push(c.serialize())}),n}}var Po=Ka;const Cs=["Unknown","Point","LineString","Polygon"];var Ta=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Cs[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const l=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:c,y:f}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(c*n-l[0])+this.featureDistanceData.bearing[1]*(f*n-l[1])}return 0}parseColor(l){let n=this._parseColorCache[l];return n||(n=this._parseColorCache[l]=Yi.parse(l)),n}};class ta{constructor(n,c,f,m){this.name=n,this.type=c,this._evaluate=f,this.args=m}evaluate(n){return this._evaluate(n,this.args)}eachChild(n){this.args.forEach(n)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(n=>n.serialize()))}static parse(n,c){const f=n[0],m=ta.definitions[f];if(!m)return c.error(`Unknown expression "${f}". If you wanted a literal array, use ["literal", [...]].`,0);const x=Array.isArray(m)?m[0]:m.type,E=Array.isArray(m)?[[m[1],m[2]]]:m.overloads,M=E.filter(([P])=>!Array.isArray(P)||P.length===n.length-1);let I=null;for(const[P,z]of M){I=new Rs(c.registry,c.path,null,c.scope);const N=[];let q=!1;for(let K=1;K<n.length;K++){const ee=n[K],oe=Array.isArray(P)?P[K-1]:P.type,pe=I.parse(ee,1+N.length,oe);if(!pe){q=!0;break}N.push(pe)}if(!q)if(Array.isArray(P)&&P.length!==N.length)I.error(`Expected ${P.length} arguments, but found ${N.length} instead.`);else{for(let K=0;K<N.length;K++){const ee=Array.isArray(P)?P[K]:P.type,oe=N[K];I.concat(K+1).checkSubtype(ee,oe.type)}if(I.errors.length===0)return new ta(f,x,z,N)}}if(M.length===1)c.errors.push(...I.errors);else{const P=(M.length?M:E).map(([N])=>{return q=N,Array.isArray(q)?`(${q.map(Ze).join(", ")})`:`(${Ze(q.type)}...)`;var q}).join(" | "),z=[];for(let N=1;N<n.length;N++){const q=c.parse(n[N],1+z.length);if(!q)return null;z.push(Ze(q.type))}c.error(`Expected arguments of type ${P}, but found (${z.join(", ")}) instead.`)}return null}static register(n,c){ta.definitions=c;for(const f in c)n[f]=ta}}var Hn=ta;class ia{constructor(n,c,f){this.type=ue,this.locale=f,this.caseSensitive=n,this.diacriticSensitive=c}static parse(n,c){if(n.length!==2)return c.error("Expected one argument.");const f=n[1];if(typeof f!="object"||Array.isArray(f))return c.error("Collator options argument must be an object.");const m=c.parse(f["case-sensitive"]!==void 0&&f["case-sensitive"],1,tr);if(!m)return null;const x=c.parse(f["diacritic-sensitive"]!==void 0&&f["diacritic-sensitive"],1,tr);if(!x)return null;let E=null;return f.locale&&(E=c.parse(f.locale,1,nr),!E)?null:new ia(m,x,E)}evaluate(n){return new Zr(this.caseSensitive.evaluate(n),this.diacriticSensitive.evaluate(n),this.locale?this.locale.evaluate(n):null)}eachChild(n){n(this.caseSensitive),n(this.diacriticSensitive),this.locale&&n(this.locale)}outputDefined(){return!1}serialize(){const n={};return n["case-sensitive"]=this.caseSensitive.serialize(),n["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(n.locale=this.locale.serialize()),["collator",n]}}const co=8192;function Hr(l,n){l[0]=Math.min(l[0],n[0]),l[1]=Math.min(l[1],n[1]),l[2]=Math.max(l[2],n[0]),l[3]=Math.max(l[3],n[1])}function ra(l,n){return!(l[0]<=n[0]||l[2]>=n[2]||l[1]<=n[1]||l[3]>=n[3])}function Is(l,n){const c=(180+l[0])/360,f=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+l[1]*Math.PI/360)))/360,m=Math.pow(2,n.z);return[Math.round(c*m*co),Math.round(f*m*co)]}function hl(l,n,c){const f=l[0]-n[0],m=l[1]-n[1],x=l[0]-c[0],E=l[1]-c[1];return f*E-x*m==0&&f*x<=0&&m*E<=0}function Sa(l,n){let c=!1;for(let E=0,M=n.length;E<M;E++){const I=n[E];for(let P=0,z=I.length;P<z-1;P++){if(hl(l,I[P],I[P+1]))return!1;(m=I[P])[1]>(f=l)[1]!=(x=I[P+1])[1]>f[1]&&f[0]<(x[0]-m[0])*(f[1]-m[1])/(x[1]-m[1])+m[0]&&(c=!c)}}var f,m,x;return c}function Ma(l,n){for(let c=0;c<n.length;c++)if(Sa(l,n[c]))return!0;return!1}function Qa(l,n,c,f){const m=f[0]-c[0],x=f[1]-c[1],E=(l[0]-c[0])*x-m*(l[1]-c[1]),M=(n[0]-c[0])*x-m*(n[1]-c[1]);return E>0&&M<0||E<0&&M>0}function Ja(l,n,c){for(const P of c)for(let z=0;z<P.length-1;++z)if((M=[(E=P[z+1])[0]-(x=P[z])[0],E[1]-x[1]])[0]*(I=[(m=n)[0]-(f=l)[0],m[1]-f[1]])[1]-M[1]*I[0]!=0&&Qa(f,m,x,E)&&Qa(x,E,f,m))return!0;var f,m,x,E,M,I;return!1}function na(l,n){for(let c=0;c<l.length;++c)if(!Sa(l[c],n))return!1;for(let c=0;c<l.length-1;++c)if(Ja(l[c],l[c+1],n))return!1;return!0}function bo(l,n){for(let c=0;c<n.length;c++)if(na(l,n[c]))return!0;return!1}function Aa(l,n,c){const f=[];for(let m=0;m<l.length;m++){const x=[];for(let E=0;E<l[m].length;E++){const M=Is(l[m][E],c);Hr(n,M),x.push(M)}f.push(x)}return f}function es(l,n,c){const f=[];for(let m=0;m<l.length;m++){const x=Aa(l[m],n,c);f.push(x)}return f}function ks(l,n,c,f){if(l[0]<c[0]||l[0]>c[2]){const m=.5*f;let x=l[0]-c[0]>m?-f:c[0]-l[0]>m?f:0;x===0&&(x=l[0]-c[2]>m?-f:c[2]-l[0]>m?f:0),l[0]+=x}Hr(n,l)}function uo(l,n,c,f){const m=Math.pow(2,f.z)*co,x=[f.x*co,f.y*co],E=[];if(!l)return E;for(const M of l)for(const I of M){const P=[I.x+x[0],I.y+x[1]];ks(P,n,c,m),E.push(P)}return E}function hr(l,n,c,f){const m=Math.pow(2,f.z)*co,x=[f.x*co,f.y*co],E=[];if(!l)return E;for(const I of l){const P=[];for(const z of I){const N=[z.x+x[0],z.y+x[1]];Hr(n,N),P.push(N)}E.push(P)}if(n[2]-n[0]<=m/2){(M=n)[0]=M[1]=1/0,M[2]=M[3]=-1/0;for(const I of E)for(const P of I)ks(P,n,c,m)}var M;return E}class Lo{constructor(n,c){this.type=tr,this.geojson=n,this.geometries=c}static parse(n,c){if(n.length!==2)return c.error(`'within' expression requires exactly one argument, but found ${n.length-1} instead.`);if(wa(n[1])){const f=n[1];if(f.type==="FeatureCollection")for(let m=0;m<f.features.length;++m){const x=f.features[m].geometry.type;if(x==="Polygon"||x==="MultiPolygon")return new Lo(f,f.features[m].geometry)}else if(f.type==="Feature"){const m=f.geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new Lo(f,f.geometry)}else if(f.type==="Polygon"||f.type==="MultiPolygon")return new Lo(f,f)}return c.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(n){if(n.geometry()!=null&&n.canonicalID()!=null){if(n.geometryType()==="Point")return function(c,f){const m=[1/0,1/0,-1/0,-1/0],x=[1/0,1/0,-1/0,-1/0],E=c.canonicalID();if(!E)return!1;if(f.type==="Polygon"){const M=Aa(f.coordinates,x,E),I=uo(c.geometry(),m,x,E);if(!ra(m,x))return!1;for(const P of I)if(!Sa(P,M))return!1}if(f.type==="MultiPolygon"){const M=es(f.coordinates,x,E),I=uo(c.geometry(),m,x,E);if(!ra(m,x))return!1;for(const P of I)if(!Ma(P,M))return!1}return!0}(n,this.geometries);if(n.geometryType()==="LineString")return function(c,f){const m=[1/0,1/0,-1/0,-1/0],x=[1/0,1/0,-1/0,-1/0],E=c.canonicalID();if(!E)return!1;if(f.type==="Polygon"){const M=Aa(f.coordinates,x,E),I=hr(c.geometry(),m,x,E);if(!ra(m,x))return!1;for(const P of I)if(!na(P,M))return!1}if(f.type==="MultiPolygon"){const M=es(f.coordinates,x,E),I=hr(c.geometry(),m,x,E);if(!ra(m,x))return!1;for(const P of I)if(!bo(P,M))return!1}return!0}(n,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Ca=Lo;function $o(l){if(l instanceof Hn&&(l.name==="get"&&l.args.length===1||l.name==="feature-state"||l.name==="has"&&l.args.length===1||l.name==="properties"||l.name==="geometry-type"||l.name==="id"||/^filter-/.test(l.name))||l instanceof Ca)return!1;let n=!0;return l.eachChild(c=>{n&&!$o(c)&&(n=!1)}),n}function ho(l){if(l instanceof Hn&&l.name==="feature-state")return!1;let n=!0;return l.eachChild(c=>{n&&!ho(c)&&(n=!1)}),n}function ts(l,n){if(l instanceof Hn&&n.indexOf(l.name)>=0)return!1;let c=!0;return l.eachChild(f=>{c&&!ts(f,n)&&(c=!1)}),c}class is{constructor(n,c){this.type=c.type,this.name=n,this.boundExpression=c}static parse(n,c){if(n.length!==2||typeof n[1]!="string")return c.error("'var' expression requires exactly one string literal argument.");const f=n[1];return c.scope.has(f)?new is(f,c.scope.get(f)):c.error(`Unknown variable "${f}". Make sure "${f}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(n){return this.boundExpression.evaluate(n)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var Ds=is;class rs{constructor(n,c=[],f,m=new ul,x=[]){this.registry=n,this.path=c,this.key=c.map(E=>`[${E}]`).join(""),this.scope=m,this.errors=x,this.expectedType=f}parse(n,c,f,m,x={}){return c?this.concat(c,f,m)._parse(n,x):this._parse(n,x)}_parse(n,c){function f(m,x,E){return E==="assert"?new Qn(x,[m]):E==="coerce"?new Po(x,[m]):m}if(n!==null&&typeof n!="string"&&typeof n!="boolean"&&typeof n!="number"||(n=["literal",n]),Array.isArray(n)){if(n.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const m=n[0];if(typeof m!="string")return this.error(`Expression name must be a string, but found ${typeof m} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const x=this.registry[m];if(x){let E=x.parse(n,this);if(!E)return null;if(this.expectedType){const M=this.expectedType,I=E.type;if(M.kind!=="string"&&M.kind!=="number"&&M.kind!=="boolean"&&M.kind!=="object"&&M.kind!=="array"||I.kind!=="value")if(M.kind!=="color"&&M.kind!=="formatted"&&M.kind!=="resolvedImage"||I.kind!=="value"&&I.kind!=="string"){if(this.checkSubtype(M,I))return null}else E=f(E,M,c.typeAnnotation||"coerce");else E=f(E,M,c.typeAnnotation||"assert")}if(!(E instanceof Jo)&&E.type.kind!=="resolvedImage"&&fo(E)){const M=new Ta;try{E=new Jo(E.type,E.evaluate(M))}catch(I){return this.error(I.message),null}}return E}return this.error(`Unknown expression "${m}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(n===void 0?"'undefined' value invalid. Use null instead.":typeof n=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof n} instead.`)}concat(n,c,f){const m=typeof n=="number"?this.path.concat(n):this.path,x=f?this.scope.concat(f):this.scope;return new rs(this.registry,m,c||null,x,this.errors)}error(n,...c){const f=`${this.key}${c.map(m=>`[${m}]`).join("")}`;this.errors.push(new Zn(f,n))}checkSubtype(n,c){const f=Kt(n,c);return f&&this.error(f),f}}var Rs=rs;function fo(l){if(l instanceof Ds)return fo(l.boundExpression);if(l instanceof Hn&&l.name==="error"||l instanceof ia||l instanceof Ca)return!1;const n=l instanceof Po||l instanceof Qn;let c=!0;return l.eachChild(f=>{c=n?c&&fo(f):c&&f instanceof Jo}),!!c&&$o(l)&&ts(l,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function po(l,n){const c=l.length-1;let f,m,x=0,E=c,M=0;for(;x<=E;)if(M=Math.floor((x+E)/2),f=l[M],m=l[M+1],f<=n){if(M===c||n<m)return M;x=M+1}else{if(!(f>n))throw new hn("Input is not a number.");E=M-1}return 0}class Jn{constructor(n,c,f){this.type=n,this.input=c,this.labels=[],this.outputs=[];for(const[m,x]of f)this.labels.push(m),this.outputs.push(x)}static parse(n,c){if(n.length-1<4)return c.error(`Expected at least 4 arguments, but found only ${n.length-1}.`);if((n.length-1)%2!=0)return c.error("Expected an even number of arguments.");const f=c.parse(n[1],1,ri);if(!f)return null;const m=[];let x=null;c.expectedType&&c.expectedType.kind!=="value"&&(x=c.expectedType);for(let E=1;E<n.length;E+=2){const M=E===1?-1/0:n[E],I=n[E+1],P=E,z=E+1;if(typeof M!="number")return c.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',P);if(m.length&&m[m.length-1][0]>=M)return c.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',P);const N=c.parse(I,z,x);if(!N)return null;x=x||N.type,m.push([M,N])}return new Jn(x,f,m)}evaluate(n){const c=this.labels,f=this.outputs;if(c.length===1)return f[0].evaluate(n);const m=this.input.evaluate(n);if(m<=c[0])return f[0].evaluate(n);const x=c.length;return m>=c[x-1]?f[x-1].evaluate(n):f[po(c,m)].evaluate(n)}eachChild(n){n(this.input);for(const c of this.outputs)n(c)}outputDefined(){return this.outputs.every(n=>n.outputDefined())}serialize(){const n=["step",this.input.serialize()];for(let c=0;c<this.labels.length;c++)c>0&&n.push(this.labels[c]),n.push(this.outputs[c].serialize());return n}}var Xn=Jn;function Qi(l,n,c){return l*(1-c)+n*c}var wo=Object.freeze({__proto__:null,number:Qi,color:function(l,n,c){return new Yi(Qi(l.r,n.r,c),Qi(l.g,n.g,c),Qi(l.b,n.b,c),Qi(l.a,n.a,c))},array:function(l,n,c){return l.map((f,m)=>Qi(f,n[m],c))}});const mo=.95047,dl=1.08883,oa=4/29,Bo=6/29,ns=3*Bo*Bo,Ps=Math.PI/180,Wl=180/Math.PI;function os(l){return l>.008856451679035631?Math.pow(l,1/3):l/ns+oa}function as(l){return l>Bo?l*l*l:ns*(l-oa)}function Ia(l){return 255*(l<=.0031308?12.92*l:1.055*Math.pow(l,1/2.4)-.055)}function Oo(l){return(l/=255)<=.04045?l/12.92:Math.pow((l+.055)/1.055,2.4)}function zo(l){const n=Oo(l.r),c=Oo(l.g),f=Oo(l.b),m=os((.4124564*n+.3575761*c+.1804375*f)/mo),x=os((.2126729*n+.7151522*c+.072175*f)/1);return{l:116*x-16,a:500*(m-x),b:200*(x-os((.0193339*n+.119192*c+.9503041*f)/dl)),alpha:l.a}}function fl(l){let n=(l.l+16)/116,c=isNaN(l.a)?n:n+l.a/500,f=isNaN(l.b)?n:n-l.b/200;return n=1*as(n),c=mo*as(c),f=dl*as(f),new Yi(Ia(3.2404542*c-1.5371385*n-.4985314*f),Ia(-.969266*c+1.8760108*n+.041556*f),Ia(.0556434*c-.2040259*n+1.0572252*f),l.alpha)}function Eo(l,n,c){const f=n-l;return l+c*(f>180||f<-180?f-360*Math.round(f/360):f)}const ka={forward:zo,reverse:fl,interpolate:function(l,n,c){return{l:Qi(l.l,n.l,c),a:Qi(l.a,n.a,c),b:Qi(l.b,n.b,c),alpha:Qi(l.alpha,n.alpha,c)}}},Yn={forward:function(l){const{l:n,a:c,b:f}=zo(l),m=Math.atan2(f,c)*Wl;return{h:m<0?m+360:m,c:Math.sqrt(c*c+f*f),l:n,alpha:l.a}},reverse:function(l){const n=l.h*Ps,c=l.c;return fl({l:l.l,a:Math.cos(n)*c,b:Math.sin(n)*c,alpha:l.alpha})},interpolate:function(l,n,c){return{h:Eo(l.h,n.h,c),c:Qi(l.c,n.c,c),l:Qi(l.l,n.l,c),alpha:Qi(l.alpha,n.alpha,c)}}};var Ls=Object.freeze({__proto__:null,lab:ka,hcl:Yn});class Da{constructor(n,c,f,m,x){this.type=n,this.operator=c,this.interpolation=f,this.input=m,this.labels=[],this.outputs=[];for(const[E,M]of x)this.labels.push(E),this.outputs.push(M)}static interpolationFactor(n,c,f,m){let x=0;if(n.name==="exponential")x=aa(c,n.base,f,m);else if(n.name==="linear")x=aa(c,1,f,m);else if(n.name==="cubic-bezier"){const E=n.controlPoints;x=new H(E[0],E[1],E[2],E[3]).solve(aa(c,1,f,m))}return x}static parse(n,c){let[f,m,x,...E]=n;if(!Array.isArray(m)||m.length===0)return c.error("Expected an interpolation type expression.",1);if(m[0]==="linear")m={name:"linear"};else if(m[0]==="exponential"){const P=m[1];if(typeof P!="number")return c.error("Exponential interpolation requires a numeric base.",1,1);m={name:"exponential",base:P}}else{if(m[0]!=="cubic-bezier")return c.error(`Unknown interpolation type ${String(m[0])}`,1,0);{const P=m.slice(1);if(P.length!==4||P.some(z=>typeof z!="number"||z<0||z>1))return c.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);m={name:"cubic-bezier",controlPoints:P}}}if(n.length-1<4)return c.error(`Expected at least 4 arguments, but found only ${n.length-1}.`);if((n.length-1)%2!=0)return c.error("Expected an even number of arguments.");if(x=c.parse(x,2,ri),!x)return null;const M=[];let I=null;f==="interpolate-hcl"||f==="interpolate-lab"?I=$n:c.expectedType&&c.expectedType.kind!=="value"&&(I=c.expectedType);for(let P=0;P<E.length;P+=2){const z=E[P],N=E[P+1],q=P+3,K=P+4;if(typeof z!="number")return c.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',q);if(M.length&&M[M.length-1][0]>=z)return c.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',q);const ee=c.parse(N,K,I);if(!ee)return null;I=I||ee.type,M.push([z,ee])}return I.kind==="number"||I.kind==="color"||I.kind==="array"&&I.itemType.kind==="number"&&typeof I.N=="number"?new Da(I,f,m,x,M):c.error(`Type ${Ze(I)} is not interpolatable.`)}evaluate(n){const c=this.labels,f=this.outputs;if(c.length===1)return f[0].evaluate(n);const m=this.input.evaluate(n);if(m<=c[0])return f[0].evaluate(n);const x=c.length;if(m>=c[x-1])return f[x-1].evaluate(n);const E=po(c,m),M=Da.interpolationFactor(this.interpolation,m,c[E],c[E+1]),I=f[E].evaluate(n),P=f[E+1].evaluate(n);return this.operator==="interpolate"?wo[this.type.kind.toLowerCase()](I,P,M):this.operator==="interpolate-hcl"?Yn.reverse(Yn.interpolate(Yn.forward(I),Yn.forward(P),M)):ka.reverse(ka.interpolate(ka.forward(I),ka.forward(P),M))}eachChild(n){n(this.input);for(const c of this.outputs)n(c)}outputDefined(){return this.outputs.every(n=>n.outputDefined())}serialize(){let n;n=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const c=[this.operator,n,this.input.serialize()];for(let f=0;f<this.labels.length;f++)c.push(this.labels[f],this.outputs[f].serialize());return c}}function aa(l,n,c,f){const m=f-c,x=l-c;return m===0?0:n===1?x/m:(Math.pow(n,x)-1)/(Math.pow(n,m)-1)}var Nn=Da;class ss{constructor(n,c){this.type=n,this.args=c}static parse(n,c){if(n.length<2)return c.error("Expectected at least one argument.");let f=null;const m=c.expectedType;m&&m.kind!=="value"&&(f=m);const x=[];for(const M of n.slice(1)){const I=c.parse(M,1+x.length,f,void 0,{typeAnnotation:"omit"});if(!I)return null;f=f||I.type,x.push(I)}const E=m&&x.some(M=>Kt(m,M.type));return new ss(E?V:f,x)}evaluate(n){let c,f=null,m=0;for(const x of this.args){if(m++,f=x.evaluate(n),f&&f instanceof yn&&!f.available&&(c||(c=f),f=null,m===this.args.length))return c;if(f!==null)break}return f}eachChild(n){this.args.forEach(n)}outputDefined(){return this.args.every(n=>n.outputDefined())}serialize(){const n=["coalesce"];return this.eachChild(c=>{n.push(c.serialize())}),n}}var $s=ss;class Ra{constructor(n,c){this.type=c.type,this.bindings=[].concat(n),this.result=c}evaluate(n){return this.result.evaluate(n)}eachChild(n){for(const c of this.bindings)n(c[1]);n(this.result)}static parse(n,c){if(n.length<4)return c.error(`Expected at least 3 arguments, but found ${n.length-1} instead.`);const f=[];for(let x=1;x<n.length-1;x+=2){const E=n[x];if(typeof E!="string")return c.error(`Expected string, but found ${typeof E} instead.`,x);if(/[^a-zA-Z0-9_]/.test(E))return c.error("Variable names must contain only alphanumeric characters or '_'.",x);const M=c.parse(n[x+1],x+1);if(!M)return null;f.push([E,M])}const m=c.parse(n[n.length-1],n.length-1,c.expectedType,f);return m?new Ra(f,m):null}outputDefined(){return this.result.outputDefined()}serialize(){const n=["let"];for(const[c,f]of this.bindings)n.push(c,f.serialize());return n.push(this.result.serialize()),n}}var Fo=Ra;class Pa{constructor(n,c,f){this.type=n,this.index=c,this.input=f}static parse(n,c){if(n.length!==3)return c.error(`Expected 2 arguments, but found ${n.length-1} instead.`);const f=c.parse(n[1],1,ri),m=c.parse(n[2],2,je(c.expectedType||V));return f&&m?new Pa(m.type.itemType,f,m):null}evaluate(n){const c=this.index.evaluate(n),f=this.input.evaluate(n);if(c<0)throw new hn(`Array index out of bounds: ${c} < 0.`);if(c>=f.length)throw new hn(`Array index out of bounds: ${c} > ${f.length-1}.`);if(c!==Math.floor(c))throw new hn(`Array index must be an integer, but found ${c} instead.`);return f[c]}eachChild(n){n(this.index),n(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var Kl=Pa;class Qe{constructor(n,c){this.type=tr,this.needle=n,this.haystack=c}static parse(n,c){if(n.length!==3)return c.error(`Expected 2 arguments, but found ${n.length-1} instead.`);const f=c.parse(n[1],1,V),m=c.parse(n[2],2,V);return f&&m?bi(f.type,[tr,nr,ri,Do,V])?new Qe(f,m):c.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ze(f.type)} instead`):null}evaluate(n){const c=this.needle.evaluate(n),f=this.haystack.evaluate(n);if(f==null)return!1;if(!di(c,["boolean","string","number","null"]))throw new hn(`Expected first argument to be of type boolean, string, number or null, but found ${Ze(Qr(c))} instead.`);if(!di(f,["string","array"]))throw new hn(`Expected second argument to be of type array or string, but found ${Ze(Qr(f))} instead.`);return f.indexOf(c)>=0}eachChild(n){n(this.needle),n(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var St=Qe;class fi{constructor(n,c,f){this.type=ri,this.needle=n,this.haystack=c,this.fromIndex=f}static parse(n,c){if(n.length<=2||n.length>=5)return c.error(`Expected 3 or 4 arguments, but found ${n.length-1} instead.`);const f=c.parse(n[1],1,V),m=c.parse(n[2],2,V);if(!f||!m)return null;if(!bi(f.type,[tr,nr,ri,Do,V]))return c.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ze(f.type)} instead`);if(n.length===4){const x=c.parse(n[3],3,ri);return x?new fi(f,m,x):null}return new fi(f,m)}evaluate(n){const c=this.needle.evaluate(n),f=this.haystack.evaluate(n);if(!di(c,["boolean","string","number","null"]))throw new hn(`Expected first argument to be of type boolean, string, number or null, but found ${Ze(Qr(c))} instead.`);if(!di(f,["string","array"]))throw new hn(`Expected second argument to be of type array or string, but found ${Ze(Qr(f))} instead.`);if(this.fromIndex){const m=this.fromIndex.evaluate(n);return f.indexOf(c,m)}return f.indexOf(c)}eachChild(n){n(this.needle),n(this.haystack),this.fromIndex&&n(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const n=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),n]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var ji=fi;class kr{constructor(n,c,f,m,x,E){this.inputType=n,this.type=c,this.input=f,this.cases=m,this.outputs=x,this.otherwise=E}static parse(n,c){if(n.length<5)return c.error(`Expected at least 4 arguments, but found only ${n.length-1}.`);if(n.length%2!=1)return c.error("Expected an even number of arguments.");let f,m;c.expectedType&&c.expectedType.kind!=="value"&&(m=c.expectedType);const x={},E=[];for(let P=2;P<n.length-1;P+=2){let z=n[P];const N=n[P+1];Array.isArray(z)||(z=[z]);const q=c.concat(P);if(z.length===0)return q.error("Expected at least one branch label.");for(const ee of z){if(typeof ee!="number"&&typeof ee!="string")return q.error("Branch labels must be numbers or strings.");if(typeof ee=="number"&&Math.abs(ee)>Number.MAX_SAFE_INTEGER)return q.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof ee=="number"&&Math.floor(ee)!==ee)return q.error("Numeric branch labels must be integer values.");if(f){if(q.checkSubtype(f,Qr(ee)))return null}else f=Qr(ee);if(x[String(ee)]!==void 0)return q.error("Branch labels must be unique.");x[String(ee)]=E.length}const K=c.parse(N,P,m);if(!K)return null;m=m||K.type,E.push(K)}const M=c.parse(n[1],1,V);if(!M)return null;const I=c.parse(n[n.length-1],n.length-1,m);return I?M.type.kind!=="value"&&c.concat(1).checkSubtype(f,M.type)?null:new kr(f,m,M,x,E,I):null}evaluate(n){const c=this.input.evaluate(n);return(Qr(c)===this.inputType&&this.outputs[this.cases[c]]||this.otherwise).evaluate(n)}eachChild(n){n(this.input),this.outputs.forEach(n),n(this.otherwise)}outputDefined(){return this.outputs.every(n=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){const n=["match",this.input.serialize()],c=Object.keys(this.cases).sort(),f=[],m={};for(const E of c){const M=m[this.cases[E]];M===void 0?(m[this.cases[E]]=f.length,f.push([this.cases[E],[E]])):f[M][1].push(E)}const x=E=>this.inputType.kind==="number"?Number(E):E;for(const[E,M]of f)n.push(M.length===1?x(M[0]):M.map(x)),n.push(this.outputs[E].serialize());return n.push(this.otherwise.serialize()),n}}var fr=kr;class jr{constructor(n,c,f){this.type=n,this.branches=c,this.otherwise=f}static parse(n,c){if(n.length<4)return c.error(`Expected at least 3 arguments, but found only ${n.length-1}.`);if(n.length%2!=0)return c.error("Expected an odd number of arguments.");let f;c.expectedType&&c.expectedType.kind!=="value"&&(f=c.expectedType);const m=[];for(let E=1;E<n.length-1;E+=2){const M=c.parse(n[E],E,tr);if(!M)return null;const I=c.parse(n[E+1],E+1,f);if(!I)return null;m.push([M,I]),f=f||I.type}const x=c.parse(n[n.length-1],n.length-1,f);return x?new jr(f,m,x):null}evaluate(n){for(const[c,f]of this.branches)if(c.evaluate(n))return f.evaluate(n);return this.otherwise.evaluate(n)}eachChild(n){for(const[c,f]of this.branches)n(c),n(f);n(this.otherwise)}outputDefined(){return this.branches.every(([n,c])=>c.outputDefined())&&this.otherwise.outputDefined()}serialize(){const n=["case"];return this.eachChild(c=>{n.push(c.serialize())}),n}}var Jr=jr;class fn{constructor(n,c,f,m){this.type=n,this.input=c,this.beginIndex=f,this.endIndex=m}static parse(n,c){if(n.length<=2||n.length>=5)return c.error(`Expected 3 or 4 arguments, but found ${n.length-1} instead.`);const f=c.parse(n[1],1,V),m=c.parse(n[2],2,ri);if(!f||!m)return null;if(!bi(f.type,[je(V),nr,V]))return c.error(`Expected first argument to be of type array or string, but found ${Ze(f.type)} instead`);if(n.length===4){const x=c.parse(n[3],3,ri);return x?new fn(f.type,f,m,x):null}return new fn(f.type,f,m)}evaluate(n){const c=this.input.evaluate(n),f=this.beginIndex.evaluate(n);if(!di(c,["string","array"]))throw new hn(`Expected first argument to be of type array or string, but found ${Ze(Qr(c))} instead.`);if(this.endIndex){const m=this.endIndex.evaluate(n);return c.slice(f,m)}return c.slice(f)}eachChild(n){n(this.input),n(this.beginIndex),this.endIndex&&n(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const n=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),n]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var en=fn;function Xr(l,n){return l==="=="||l==="!="?n.kind==="boolean"||n.kind==="string"||n.kind==="number"||n.kind==="null"||n.kind==="value":n.kind==="string"||n.kind==="number"||n.kind==="value"}function Wn(l,n,c,f){return f.compare(n,c)===0}function Mn(l,n,c){const f=l!=="=="&&l!=="!=";return class Op{constructor(x,E,M){this.type=tr,this.lhs=x,this.rhs=E,this.collator=M,this.hasUntypedArgument=x.type.kind==="value"||E.type.kind==="value"}static parse(x,E){if(x.length!==3&&x.length!==4)return E.error("Expected two or three arguments.");const M=x[0];let I=E.parse(x[1],1,V);if(!I)return null;if(!Xr(M,I.type))return E.concat(1).error(`"${M}" comparisons are not supported for type '${Ze(I.type)}'.`);let P=E.parse(x[2],2,V);if(!P)return null;if(!Xr(M,P.type))return E.concat(2).error(`"${M}" comparisons are not supported for type '${Ze(P.type)}'.`);if(I.type.kind!==P.type.kind&&I.type.kind!=="value"&&P.type.kind!=="value")return E.error(`Cannot compare types '${Ze(I.type)}' and '${Ze(P.type)}'.`);f&&(I.type.kind==="value"&&P.type.kind!=="value"?I=new Qn(P.type,[I]):I.type.kind!=="value"&&P.type.kind==="value"&&(P=new Qn(I.type,[P])));let z=null;if(x.length===4){if(I.type.kind!=="string"&&P.type.kind!=="string"&&I.type.kind!=="value"&&P.type.kind!=="value")return E.error("Cannot use collator to compare non-string types.");if(z=E.parse(x[3],3,ue),!z)return null}return new Op(I,P,z)}evaluate(x){const E=this.lhs.evaluate(x),M=this.rhs.evaluate(x);if(f&&this.hasUntypedArgument){const I=Qr(E),P=Qr(M);if(I.kind!==P.kind||I.kind!=="string"&&I.kind!=="number")throw new hn(`Expected arguments for "${l}" to be (string, string) or (number, number), but found (${I.kind}, ${P.kind}) instead.`)}if(this.collator&&!f&&this.hasUntypedArgument){const I=Qr(E),P=Qr(M);if(I.kind!=="string"||P.kind!=="string")return n(x,E,M)}return this.collator?c(x,E,M,this.collator.evaluate(x)):n(x,E,M)}eachChild(x){x(this.lhs),x(this.rhs),this.collator&&x(this.collator)}outputDefined(){return!0}serialize(){const x=[l];return this.eachChild(E=>{x.push(E.serialize())}),x}}}const vn=Mn("==",function(l,n,c){return n===c},Wn),eo=Mn("!=",function(l,n,c){return n!==c},function(l,n,c,f){return!Wn(0,n,c,f)}),No=Mn("<",function(l,n,c){return n<c},function(l,n,c,f){return f.compare(n,c)<0}),La=Mn(">",function(l,n,c){return n>c},function(l,n,c,f){return f.compare(n,c)>0}),To=Mn("<=",function(l,n,c){return n<=c},function(l,n,c,f){return f.compare(n,c)<=0}),$a=Mn(">=",function(l,n,c){return n>=c},function(l,n,c,f){return f.compare(n,c)>=0});class ls{constructor(n,c,f,m,x,E){this.type=nr,this.number=n,this.locale=c,this.currency=f,this.unit=m,this.minFractionDigits=x,this.maxFractionDigits=E}static parse(n,c){if(n.length!==3)return c.error("Expected two arguments.");const f=c.parse(n[1],1,ri);if(!f)return null;const m=n[2];if(typeof m!="object"||Array.isArray(m))return c.error("NumberFormat options argument must be an object.");let x=null;if(m.locale&&(x=c.parse(m.locale,1,nr),!x))return null;let E=null;if(m.currency&&(E=c.parse(m.currency,1,nr),!E))return null;let M=null;if(m.unit&&(M=c.parse(m.unit,1,nr),!M))return null;let I=null;if(m["min-fraction-digits"]&&(I=c.parse(m["min-fraction-digits"],1,ri),!I))return null;let P=null;return m["max-fraction-digits"]&&(P=c.parse(m["max-fraction-digits"],1,ri),!P)?null:new ls(f,x,E,M,I,P)}evaluate(n){return new Intl.NumberFormat(this.locale?this.locale.evaluate(n):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(n):void 0,unit:this.unit?this.unit.evaluate(n):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(n):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(n):void 0}).format(this.number.evaluate(n))}eachChild(n){n(this.number),this.locale&&n(this.locale),this.currency&&n(this.currency),this.unit&&n(this.unit),this.minFractionDigits&&n(this.minFractionDigits),this.maxFractionDigits&&n(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const n={};return this.locale&&(n.locale=this.locale.serialize()),this.currency&&(n.currency=this.currency.serialize()),this.unit&&(n.unit=this.unit.serialize()),this.minFractionDigits&&(n["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(n["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),n]}}class Bs{constructor(n){this.type=ri,this.input=n}static parse(n,c){if(n.length!==2)return c.error(`Expected 1 argument, but found ${n.length-1} instead.`);const f=c.parse(n[1],1);return f?f.type.kind!=="array"&&f.type.kind!=="string"&&f.type.kind!=="value"?c.error(`Expected argument of type string or array, but found ${Ze(f.type)} instead.`):new Bs(f):null}evaluate(n){const c=this.input.evaluate(n);if(typeof c=="string"||Array.isArray(c))return c.length;throw new hn(`Expected value to be of type string or array, but found ${Ze(Qr(c))} instead.`)}eachChild(n){n(this.input)}outputDefined(){return!1}serialize(){const n=["length"];return this.eachChild(c=>{n.push(c.serialize())}),n}}const pl={"==":vn,"!=":eo,">":La,"<":No,">=":$a,"<=":To,array:Qn,at:Kl,boolean:Qn,case:Jr,coalesce:$s,collator:ia,format:Ea,image:Wa,in:St,"index-of":ji,interpolate:Nn,"interpolate-hcl":Nn,"interpolate-lab":Nn,length:Bs,let:Fo,literal:Jo,match:fr,number:Qn,"number-format":ls,object:Qn,slice:en,step:Xn,string:Qn,"to-boolean":Po,"to-color":Po,"to-number":Po,"to-string":Po,var:Ds,within:Ca};function Mr(l,[n,c,f,m]){n=n.evaluate(l),c=c.evaluate(l),f=f.evaluate(l);const x=m?m.evaluate(l):1,E=Lr(n,c,f,x);if(E)throw new hn(E);return new Yi(n/255*x,c/255*x,f/255*x,x)}function xr(l,n){return l in n}function sa(l,n){const c=n[l];return c===void 0?null:c}function xn(l){return{type:l}}Hn.register(pl,{error:[{kind:"error"},[nr],(l,[n])=>{throw new hn(n.evaluate(l))}],typeof:[nr,[V],(l,[n])=>Ze(Qr(n.evaluate(l)))],"to-rgba":[je(ri,4),[$n],(l,[n])=>n.evaluate(l).toArray()],rgb:[$n,[ri,ri,ri],Mr],rgba:[$n,[ri,ri,ri,ri],Mr],has:{type:tr,overloads:[[[nr],(l,[n])=>xr(n.evaluate(l),l.properties())],[[nr,$],(l,[n,c])=>xr(n.evaluate(l),c.evaluate(l))]]},get:{type:V,overloads:[[[nr],(l,[n])=>sa(n.evaluate(l),l.properties())],[[nr,$],(l,[n,c])=>sa(n.evaluate(l),c.evaluate(l))]]},"feature-state":[V,[nr],(l,[n])=>sa(n.evaluate(l),l.featureState||{})],properties:[$,[],l=>l.properties()],"geometry-type":[nr,[],l=>l.geometryType()],id:[V,[],l=>l.id()],zoom:[ri,[],l=>l.globals.zoom],pitch:[ri,[],l=>l.globals.pitch||0],"distance-from-center":[ri,[],l=>l.distanceFromCenter()],"heatmap-density":[ri,[],l=>l.globals.heatmapDensity||0],"line-progress":[ri,[],l=>l.globals.lineProgress||0],"sky-radial-progress":[ri,[],l=>l.globals.skyRadialProgress||0],accumulated:[V,[],l=>l.globals.accumulated===void 0?null:l.globals.accumulated],"+":[ri,xn(ri),(l,n)=>{let c=0;for(const f of n)c+=f.evaluate(l);return c}],"*":[ri,xn(ri),(l,n)=>{let c=1;for(const f of n)c*=f.evaluate(l);return c}],"-":{type:ri,overloads:[[[ri,ri],(l,[n,c])=>n.evaluate(l)-c.evaluate(l)],[[ri],(l,[n])=>-n.evaluate(l)]]},"/":[ri,[ri,ri],(l,[n,c])=>n.evaluate(l)/c.evaluate(l)],"%":[ri,[ri,ri],(l,[n,c])=>n.evaluate(l)%c.evaluate(l)],ln2:[ri,[],()=>Math.LN2],pi:[ri,[],()=>Math.PI],e:[ri,[],()=>Math.E],"^":[ri,[ri,ri],(l,[n,c])=>Math.pow(n.evaluate(l),c.evaluate(l))],sqrt:[ri,[ri],(l,[n])=>Math.sqrt(n.evaluate(l))],log10:[ri,[ri],(l,[n])=>Math.log(n.evaluate(l))/Math.LN10],ln:[ri,[ri],(l,[n])=>Math.log(n.evaluate(l))],log2:[ri,[ri],(l,[n])=>Math.log(n.evaluate(l))/Math.LN2],sin:[ri,[ri],(l,[n])=>Math.sin(n.evaluate(l))],cos:[ri,[ri],(l,[n])=>Math.cos(n.evaluate(l))],tan:[ri,[ri],(l,[n])=>Math.tan(n.evaluate(l))],asin:[ri,[ri],(l,[n])=>Math.asin(n.evaluate(l))],acos:[ri,[ri],(l,[n])=>Math.acos(n.evaluate(l))],atan:[ri,[ri],(l,[n])=>Math.atan(n.evaluate(l))],min:[ri,xn(ri),(l,n)=>Math.min(...n.map(c=>c.evaluate(l)))],max:[ri,xn(ri),(l,n)=>Math.max(...n.map(c=>c.evaluate(l)))],abs:[ri,[ri],(l,[n])=>Math.abs(n.evaluate(l))],round:[ri,[ri],(l,[n])=>{const c=n.evaluate(l);return c<0?-Math.round(-c):Math.round(c)}],floor:[ri,[ri],(l,[n])=>Math.floor(n.evaluate(l))],ceil:[ri,[ri],(l,[n])=>Math.ceil(n.evaluate(l))],"filter-==":[tr,[nr,V],(l,[n,c])=>l.properties()[n.value]===c.value],"filter-id-==":[tr,[V],(l,[n])=>l.id()===n.value],"filter-type-==":[tr,[nr],(l,[n])=>l.geometryType()===n.value],"filter-<":[tr,[nr,V],(l,[n,c])=>{const f=l.properties()[n.value],m=c.value;return typeof f==typeof m&&f<m}],"filter-id-<":[tr,[V],(l,[n])=>{const c=l.id(),f=n.value;return typeof c==typeof f&&c<f}],"filter->":[tr,[nr,V],(l,[n,c])=>{const f=l.properties()[n.value],m=c.value;return typeof f==typeof m&&f>m}],"filter-id->":[tr,[V],(l,[n])=>{const c=l.id(),f=n.value;return typeof c==typeof f&&c>f}],"filter-<=":[tr,[nr,V],(l,[n,c])=>{const f=l.properties()[n.value],m=c.value;return typeof f==typeof m&&f<=m}],"filter-id-<=":[tr,[V],(l,[n])=>{const c=l.id(),f=n.value;return typeof c==typeof f&&c<=f}],"filter->=":[tr,[nr,V],(l,[n,c])=>{const f=l.properties()[n.value],m=c.value;return typeof f==typeof m&&f>=m}],"filter-id->=":[tr,[V],(l,[n])=>{const c=l.id(),f=n.value;return typeof c==typeof f&&c>=f}],"filter-has":[tr,[V],(l,[n])=>n.value in l.properties()],"filter-has-id":[tr,[],l=>l.id()!==null&&l.id()!==void 0],"filter-type-in":[tr,[je(nr)],(l,[n])=>n.value.indexOf(l.geometryType())>=0],"filter-id-in":[tr,[je(V)],(l,[n])=>n.value.indexOf(l.id())>=0],"filter-in-small":[tr,[nr,je(V)],(l,[n,c])=>c.value.indexOf(l.properties()[n.value])>=0],"filter-in-large":[tr,[nr,je(V)],(l,[n,c])=>function(f,m,x,E){for(;x<=E;){const M=x+E>>1;if(m[M]===f)return!0;m[M]>f?E=M-1:x=M+1}return!1}(l.properties()[n.value],c.value,0,c.value.length-1)],all:{type:tr,overloads:[[[tr,tr],(l,[n,c])=>n.evaluate(l)&&c.evaluate(l)],[xn(tr),(l,n)=>{for(const c of n)if(!c.evaluate(l))return!1;return!0}]]},any:{type:tr,overloads:[[[tr,tr],(l,[n,c])=>n.evaluate(l)||c.evaluate(l)],[xn(tr),(l,n)=>{for(const c of n)if(c.evaluate(l))return!0;return!1}]]},"!":[tr,[tr],(l,[n])=>!n.evaluate(l)],"is-supported-script":[tr,[nr],(l,[n])=>{const c=l.globals&&l.globals.isSupportedScript;return!c||c(n.evaluate(l))}],upcase:[nr,[nr],(l,[n])=>n.evaluate(l).toUpperCase()],downcase:[nr,[nr],(l,[n])=>n.evaluate(l).toLowerCase()],concat:[nr,xn(V),(l,n)=>n.map(c=>Bn(c.evaluate(l))).join("")],"resolved-locale":[nr,[ue],(l,[n])=>n.evaluate(l).resolvedLocale()]});var So=pl;function gn(l){return{result:"success",value:l}}function An(l){return{result:"error",value:l}}function On(l){return l["property-type"]==="data-driven"}function zn(l){return!!l.expression&&l.expression.parameters.indexOf("zoom")>-1}function Uo(l){return!!l.expression&&l.expression.interpolated}function Ji(l){return l instanceof Number?"number":l instanceof String?"string":l instanceof Boolean?"boolean":Array.isArray(l)?"array":l===null?"null":typeof l}function to(l){return typeof l=="object"&&l!==null&&!Array.isArray(l)}function ml(l){return l}function la(l,n){const c=n.type==="color",f=l.stops&&typeof l.stops[0][0]=="object",m=f||!(f||l.property!==void 0),x=l.type||(Uo(n)?"exponential":"interval");if(c&&((l=Sn({},l)).stops&&(l.stops=l.stops.map(P=>[P[0],Yi.parse(P[1])])),l.default=Yi.parse(l.default?l.default:n.default)),l.colorSpace&&l.colorSpace!=="rgb"&&!Ls[l.colorSpace])throw new Error(`Unknown color space: ${l.colorSpace}`);let E,M,I;if(x==="exponential")E=Oa;else if(x==="interval")E=Ba;else if(x==="categorical"){E=ca,M=Object.create(null);for(const P of l.stops)M[P[0]]=P[1];I=typeof l.stops[0][0]}else{if(x!=="identity")throw new Error(`Unknown function type "${x}"`);E=za}if(f){const P={},z=[];for(let K=0;K<l.stops.length;K++){const ee=l.stops[K],oe=ee[0].zoom;P[oe]===void 0&&(P[oe]={zoom:oe,type:l.type,property:l.property,default:l.default,stops:[]},z.push(oe)),P[oe].stops.push([ee[0].value,ee[1]])}const N=[];for(const K of z)N.push([P[K].zoom,la(P[K],n)]);const q={name:"linear"};return{kind:"composite",interpolationType:q,interpolationFactor:Nn.interpolationFactor.bind(void 0,q),zoomStops:N.map(K=>K[0]),evaluate:({zoom:K},ee)=>Oa({stops:N,base:l.base},n,K).evaluate(K,ee)}}if(m){const P=x==="exponential"?{name:"exponential",base:l.base!==void 0?l.base:1}:null;return{kind:"camera",interpolationType:P,interpolationFactor:Nn.interpolationFactor.bind(void 0,P),zoomStops:l.stops.map(z=>z[0]),evaluate:({zoom:z})=>E(l,n,z,M,I)}}return{kind:"source",evaluate(P,z){const N=z&&z.properties?z.properties[l.property]:void 0;return N===void 0?Vo(l.default,n.default):E(l,n,N,M,I)}}}function Vo(l,n,c){return l!==void 0?l:n!==void 0?n:c!==void 0?c:void 0}function ca(l,n,c,f,m){return Vo(typeof c===m?f[c]:void 0,l.default,n.default)}function Ba(l,n,c){if(Ji(c)!=="number")return Vo(l.default,n.default);const f=l.stops.length;if(f===1||c<=l.stops[0][0])return l.stops[0][1];if(c>=l.stops[f-1][0])return l.stops[f-1][1];const m=po(l.stops.map(x=>x[0]),c);return l.stops[m][1]}function Oa(l,n,c){const f=l.base!==void 0?l.base:1;if(Ji(c)!=="number")return Vo(l.default,n.default);const m=l.stops.length;if(m===1||c<=l.stops[0][0])return l.stops[0][1];if(c>=l.stops[m-1][0])return l.stops[m-1][1];const x=po(l.stops.map(z=>z[0]),c),E=function(z,N,q,K){const ee=K-q,oe=z-q;return ee===0?0:N===1?oe/ee:(Math.pow(N,oe)-1)/(Math.pow(N,ee)-1)}(c,f,l.stops[x][0],l.stops[x+1][0]),M=l.stops[x][1],I=l.stops[x+1][1];let P=wo[n.type]||ml;if(l.colorSpace&&l.colorSpace!=="rgb"){const z=Ls[l.colorSpace];P=(N,q)=>z.reverse(z.interpolate(z.forward(N),z.forward(q),E))}return typeof M.evaluate=="function"?{evaluate(...z){const N=M.evaluate.apply(void 0,z),q=I.evaluate.apply(void 0,z);if(N!==void 0&&q!==void 0)return P(N,q,E)}}:P(M,I,E)}function za(l,n,c){return n.type==="color"?c=Yi.parse(c):n.type==="formatted"?c=mn.fromString(c.toString()):n.type==="resolvedImage"?c=yn.fromString(c.toString()):Ji(c)===n.type||n.type==="enum"&&n.values[c]||(c=void 0),Vo(c,l.default,n.default)}class jo{constructor(n,c){this.expression=n,this._warningHistory={},this._evaluator=new Ta,this._defaultValue=c?function(f){return f.type==="color"&&(to(f.default)||Array.isArray(f.default))?new Yi(0,0,0,0):f.type==="color"?Yi.parse(f.default)||null:f.default===void 0?null:f.default}(c):null,this._enumValues=c&&c.type==="enum"?c.values:null}evaluateWithoutErrorHandling(n,c,f,m,x,E,M,I){return this._evaluator.globals=n,this._evaluator.feature=c,this._evaluator.featureState=f,this._evaluator.canonical=m||null,this._evaluator.availableImages=x||null,this._evaluator.formattedSection=E,this._evaluator.featureTileCoord=M||null,this._evaluator.featureDistanceData=I||null,this.expression.evaluate(this._evaluator)}evaluate(n,c,f,m,x,E,M,I){this._evaluator.globals=n,this._evaluator.feature=c||null,this._evaluator.featureState=f||null,this._evaluator.canonical=m||null,this._evaluator.availableImages=x||null,this._evaluator.formattedSection=E||null,this._evaluator.featureTileCoord=M||null,this._evaluator.featureDistanceData=I||null;try{const P=this.expression.evaluate(this._evaluator);if(P==null||typeof P=="number"&&P!=P)return this._defaultValue;if(this._enumValues&&!(P in this._enumValues))throw new hn(`Expected value to be one of ${Object.keys(this._enumValues).map(z=>JSON.stringify(z)).join(", ")}, but found ${JSON.stringify(P)} instead.`);return P}catch(P){return this._warningHistory[P.message]||(this._warningHistory[P.message]=!0,typeof console<"u"&&console.warn(P.message)),this._defaultValue}}}function cs(l){return Array.isArray(l)&&l.length>0&&typeof l[0]=="string"&&l[0]in So}function us(l,n){const c=new Rs(So,[],n?function(m){const x={color:$n,string:nr,number:ri,enum:nr,boolean:tr,formatted:ke,resolvedImage:Ve};return m.type==="array"?je(x[m.value]||V,m.length):x[m.type]}(n):void 0),f=c.parse(l,void 0,void 0,void 0,n&&n.type==="string"?{typeAnnotation:"coerce"}:void 0);return f?gn(new jo(f,n)):An(c.errors)}class gl{constructor(n,c){this.kind=n,this._styleExpression=c,this.isStateDependent=n!=="constant"&&!ho(c.expression)}evaluateWithoutErrorHandling(n,c,f,m,x,E){return this._styleExpression.evaluateWithoutErrorHandling(n,c,f,m,x,E)}evaluate(n,c,f,m,x,E){return this._styleExpression.evaluate(n,c,f,m,x,E)}}class Fa{constructor(n,c,f,m){this.kind=n,this.zoomStops=f,this._styleExpression=c,this.isStateDependent=n!=="camera"&&!ho(c.expression),this.interpolationType=m}evaluateWithoutErrorHandling(n,c,f,m,x,E){return this._styleExpression.evaluateWithoutErrorHandling(n,c,f,m,x,E)}evaluate(n,c,f,m,x,E){return this._styleExpression.evaluate(n,c,f,m,x,E)}interpolationFactor(n,c,f){return this.interpolationType?Nn.interpolationFactor(this.interpolationType,n,c,f):0}}function Na(l,n){if((l=us(l,n)).result==="error")return l;const c=l.value.expression,f=$o(c);if(!f&&!On(n))return An([new Zn("","data expressions not supported")]);const m=ts(c,["zoom","pitch","distance-from-center"]);if(!m&&!zn(n))return An([new Zn("","zoom expressions not supported")]);const x=zs(c);return x||m?x instanceof Zn?An([x]):x instanceof Nn&&!Uo(n)?An([new Zn("",'"interpolate" expressions cannot be used with this property')]):gn(x?new Fa(f?"camera":"composite",l.value,x.labels,x instanceof Nn?x.interpolation:void 0):new gl(f?"constant":"source",l.value)):An([new Zn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Os{constructor(n,c){this._parameters=n,this._specification=c,Sn(this,la(this._parameters,this._specification))}static deserialize(n){return new Os(n._parameters,n._specification)}static serialize(n){return{_parameters:n._parameters,_specification:n._specification}}}function zs(l){let n=null;if(l instanceof Fo)n=zs(l.result);else if(l instanceof $s){for(const c of l.args)if(n=zs(c),n)break}else(l instanceof Xn||l instanceof Nn)&&l.input instanceof Hn&&l.input.name==="zoom"&&(n=l);return n instanceof Zn||l.eachChild(c=>{const f=zs(c);f instanceof Zn?n=f:!n&&f?n=new Zn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):n&&f&&n!==f&&(n=new Zn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),n}class gi{constructor(n,c,f,m){this.message=(n?`${n}: `:"")+f,m&&(this.identifier=m),c!=null&&c.__line__&&(this.line=c.__line__)}}function io(l){const n=l.key,c=l.value,f=l.valueSpec||{},m=l.objectElementValidators||{},x=l.style,E=l.styleSpec;let M=[];const I=Ji(c);if(I!=="object")return[new gi(n,c,`object expected, ${I} found`)];for(const P in c){const z=P.split(".")[0],N=f[z]||f["*"];let q;m[z]?q=m[z]:f[z]?q=Cn:m["*"]?q=m["*"]:f["*"]&&(q=Cn),q?M=M.concat(q({key:(n&&`${n}.`)+P,value:c[P],valueSpec:N,style:x,styleSpec:E,object:c,objectKey:P},c)):M.push(new gi(n,c[P],`unknown property "${P}"`))}for(const P in f)m[P]||f[P].required&&f[P].default===void 0&&c[P]===void 0&&M.push(new gi(n,c,`missing required property "${P}"`));return M}function qc(l){const n=l.value,c=l.valueSpec,f=l.style,m=l.styleSpec,x=l.key,E=l.arrayElementValidator||Cn;if(Ji(n)!=="array")return[new gi(x,n,`array expected, ${Ji(n)} found`)];if(c.length&&n.length!==c.length)return[new gi(x,n,`array length ${c.length} expected, length ${n.length} found`)];if(c["min-length"]&&n.length<c["min-length"])return[new gi(x,n,`array length at least ${c["min-length"]} expected, length ${n.length} found`)];let M={type:c.value,values:c.values,minimum:c.minimum,maximum:c.maximum,function:void 0};m.$version<7&&(M.function=c.function),Ji(c.value)==="object"&&(M=c.value);let I=[];for(let P=0;P<n.length;P++)I=I.concat(E({array:n,arrayIndex:P,value:n[P],valueSpec:M,style:f,styleSpec:m,key:`${x}[${P}]`}));return I}function Ql(l){const n=l.key,c=l.value,f=l.valueSpec;let m=Ji(c);if(m==="number"&&c!=c&&(m="NaN"),m!=="number")return[new gi(n,c,`number expected, ${m} found`)];if("minimum"in f){let x=f.minimum;if(Ji(f.minimum)==="array"&&(x=f.minimum[l.arrayIndex]),c<x)return[new gi(n,c,`${c} is less than the minimum value ${x}`)]}if("maximum"in f){let x=f.maximum;if(Ji(f.maximum)==="array"&&(x=f.maximum[l.arrayIndex]),c>x)return[new gi(n,c,`${c} is greater than the maximum value ${x}`)]}return[]}function Fs(l){const n=l.valueSpec,c=Gr(l.value.type);let f,m,x,E={};const M=c!=="categorical"&&l.value.property===void 0,I=!M,P=Ji(l.value.stops)==="array"&&Ji(l.value.stops[0])==="array"&&Ji(l.value.stops[0][0])==="object",z=io({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(K){if(c==="identity")return[new gi(K.key,K.value,'identity function may not have a "stops" property')];let ee=[];const oe=K.value;return ee=ee.concat(qc({key:K.key,value:oe,valueSpec:K.valueSpec,style:K.style,styleSpec:K.styleSpec,arrayElementValidator:N})),Ji(oe)==="array"&&oe.length===0&&ee.push(new gi(K.key,oe,"array must have at least one stop")),ee},default:function(K){return Cn({key:K.key,value:K.value,valueSpec:n,style:K.style,styleSpec:K.styleSpec})}}});return c==="identity"&&M&&z.push(new gi(l.key,l.value,'missing required property "property"')),c==="identity"||l.value.stops||z.push(new gi(l.key,l.value,'missing required property "stops"')),c==="exponential"&&l.valueSpec.expression&&!Uo(l.valueSpec)&&z.push(new gi(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(I&&!On(l.valueSpec)?z.push(new gi(l.key,l.value,"property functions not supported")):M&&!zn(l.valueSpec)&&z.push(new gi(l.key,l.value,"zoom functions not supported"))),c!=="categorical"&&!P||l.value.property!==void 0||z.push(new gi(l.key,l.value,'"property" property is required')),z;function N(K){let ee=[];const oe=K.value,pe=K.key;if(Ji(oe)!=="array")return[new gi(pe,oe,`array expected, ${Ji(oe)} found`)];if(oe.length!==2)return[new gi(pe,oe,`array length 2 expected, length ${oe.length} found`)];if(P){if(Ji(oe[0])!=="object")return[new gi(pe,oe,`object expected, ${Ji(oe[0])} found`)];if(oe[0].zoom===void 0)return[new gi(pe,oe,"object stop key must have zoom")];if(oe[0].value===void 0)return[new gi(pe,oe,"object stop key must have value")];const Ee=Gr(oe[0].zoom);if(typeof Ee!="number")return[new gi(pe,oe[0].zoom,"stop zoom values must be numbers")];if(x&&x>Ee)return[new gi(pe,oe[0].zoom,"stop zoom values must appear in ascending order")];Ee!==x&&(x=Ee,m=void 0,E={}),ee=ee.concat(io({key:`${pe}[0]`,value:oe[0],valueSpec:{zoom:{}},style:K.style,styleSpec:K.styleSpec,objectElementValidators:{zoom:Ql,value:q}}))}else ee=ee.concat(q({key:`${pe}[0]`,value:oe[0],valueSpec:{},style:K.style,styleSpec:K.styleSpec},oe));return cs(xo(oe[1]))?ee.concat([new gi(`${pe}[1]`,oe[1],"expressions are not allowed in function stops.")]):ee.concat(Cn({key:`${pe}[1]`,value:oe[1],valueSpec:n,style:K.style,styleSpec:K.styleSpec}))}function q(K,ee){const oe=Ji(K.value),pe=Gr(K.value),Ee=K.value!==null?K.value:ee;if(f){if(oe!==f)return[new gi(K.key,Ee,`${oe} stop domain type must match previous stop domain type ${f}`)]}else f=oe;if(oe!=="number"&&oe!=="string"&&oe!=="boolean"&&typeof pe!="number"&&typeof pe!="string"&&typeof pe!="boolean")return[new gi(K.key,Ee,"stop domain value must be a number, string, or boolean")];if(oe!=="number"&&c!=="categorical"){let Re=`number expected, ${oe} found`;return On(n)&&c===void 0&&(Re+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new gi(K.key,Ee,Re)]}return c!=="categorical"||oe!=="number"||typeof pe=="number"&&isFinite(pe)&&Math.floor(pe)===pe?c!=="categorical"&&oe==="number"&&typeof pe=="number"&&typeof m=="number"&&m!==void 0&&pe<m?[new gi(K.key,Ee,"stop domain values must appear in ascending order")]:(m=pe,c==="categorical"&&pe in E?[new gi(K.key,Ee,"stop domain values must be unique")]:(E[pe]=!0,[])):[new gi(K.key,Ee,`integer expected, found ${String(pe)}`)]}}function hs(l){const n=(l.expressionContext==="property"?Na:us)(xo(l.value),l.valueSpec);if(n.result==="error")return n.value.map(f=>new gi(`${l.key}${f.key}`,l.value,f.message));const c=n.value.expression||n.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!c.outputDefined())return[new gi(l.key,l.value,`Invalid data expression for "${l.propertyKey}". Output values must be contained as literals within the expression.`)];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!ho(c))return[new gi(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return Gc(c,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!ts(c,["zoom","feature-state"]))return[new gi(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!$o(c))return[new gi(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Gc(l,n){const c=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(n.valueSpec&&n.valueSpec.expression)for(const m of n.valueSpec.expression.parameters)c.delete(m);if(c.size===0)return[];const f=[];return l instanceof Hn&&c.has(l.name)?[new gi(n.key,n.value,`["${l.name}"] expression is not supported in a filter for a ${n.object.type} layer with id: ${n.object.id}`)]:(l.eachChild(m=>{f.push(...Gc(m,n))}),f)}function _l(l){const n=l.key,c=l.value,f=l.valueSpec,m=[];return Array.isArray(f.values)?f.values.indexOf(Gr(c))===-1&&m.push(new gi(n,c,`expected one of [${f.values.join(", ")}], ${JSON.stringify(c)} found`)):Object.keys(f.values).indexOf(Gr(c))===-1&&m.push(new gi(n,c,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(c)} found`)),m}function Jl(l){if(l===!0||l===!1)return!0;if(!Array.isArray(l)||l.length===0)return!1;switch(l[0]){case"has":return l.length>=2&&l[1]!=="$id"&&l[1]!=="$type";case"in":return l.length>=3&&(typeof l[1]!="string"||Array.isArray(l[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return l.length!==3||Array.isArray(l[1])||Array.isArray(l[2]);case"any":case"all":for(const n of l.slice(1))if(!Jl(n)&&typeof n!="boolean")return!1;return!0;default:return!0}}function yl(l,n="fill"){if(l==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Jl(l)||(l=xl(l));const c=l;let f=!0;try{f=function(P){if(!_n(P))return P;let z=xo(P);return Us(z),z=Ns(z),z}(c)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(c,null,2)}
        `)}const m=ot[`filter_${n}`],x=us(f,m);let E=null;if(x.result==="error")throw new Error(x.value.map(P=>`${P.key}: ${P.message}`).join(", "));E=(P,z,N)=>x.value.evaluate(P,z,{},N);let M=null,I=null;if(f!==c){const P=us(c,m);if(P.result==="error")throw new Error(P.value.map(z=>`${z.key}: ${z.message}`).join(", "));M=(z,N,q,K,ee)=>P.value.evaluate(z,N,{},q,void 0,void 0,K,ee),I=!$o(P.value.expression)}return{filter:E,dynamicFilter:M||void 0,needGeometry:Zc(f),needFeature:!!I}}function Ns(l){if(!Array.isArray(l))return l;const n=function(c){if(vl.has(c[0])){for(let f=1;f<c.length;f++)if(_n(c[f]))return!0}return c}(l);return n===!0?n:n.map(c=>Ns(c))}function Us(l){let n=!1;const c=[];if(l[0]==="case"){for(let f=1;f<l.length-1;f+=2)n=n||_n(l[f]),c.push(l[f+1]);c.push(l[l.length-1])}else if(l[0]==="match"){n=n||_n(l[1]);for(let f=2;f<l.length-1;f+=2)c.push(l[f+1]);c.push(l[l.length-1])}else if(l[0]==="step"){n=n||_n(l[1]);for(let f=1;f<l.length-1;f+=2)c.push(l[f+1])}n&&(l.length=0,l.push("any",...c));for(let f=1;f<l.length;f++)Us(l[f])}function _n(l){if(!Array.isArray(l))return!1;if((n=l[0])==="pitch"||n==="distance-from-center")return!0;var n;for(let c=1;c<l.length;c++)if(_n(l[c]))return!0;return!1}const vl=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Qu(l,n){return l<n?-1:l>n?1:0}function Zc(l){if(!Array.isArray(l))return!1;if(l[0]==="within")return!0;for(let n=1;n<l.length;n++)if(Zc(l[n]))return!0;return!1}function xl(l){if(!l)return!0;const n=l[0];return l.length<=1?n!=="any":n==="=="?ec(l[1],l[2],"=="):n==="!="?ds(ec(l[1],l[2],"==")):n==="<"||n===">"||n==="<="||n===">="?ec(l[1],l[2],n):n==="any"?(c=l.slice(1),["any"].concat(c.map(xl))):n==="all"?["all"].concat(l.slice(1).map(xl)):n==="none"?["all"].concat(l.slice(1).map(xl).map(ds)):n==="in"?bl(l[1],l.slice(2)):n==="!in"?ds(bl(l[1],l.slice(2))):n==="has"?Hc(l[1]):n==="!has"?ds(Hc(l[1])):n!=="within"||l;var c}function ec(l,n,c){switch(l){case"$type":return[`filter-type-${c}`,n];case"$id":return[`filter-id-${c}`,n];default:return[`filter-${c}`,l,n]}}function bl(l,n){if(n.length===0)return!1;switch(l){case"$type":return["filter-type-in",["literal",n]];case"$id":return["filter-id-in",["literal",n]];default:return n.length>200&&!n.some(c=>typeof c!=typeof n[0])?["filter-in-large",l,["literal",n.sort(Qu)]]:["filter-in-small",l,["literal",n]]}}function Hc(l){switch(l){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",l]}}function ds(l){return["!",l]}function tc(l){return Jl(xo(l.value))?hs(Sn({},l,{expressionContext:"filter",valueSpec:l.styleSpec[`filter_${l.layerType||"fill"}`]})):Xc(l)}function Xc(l){const n=l.value,c=l.key;if(Ji(n)!=="array")return[new gi(c,n,`array expected, ${Ji(n)} found`)];const f=l.styleSpec;let m,x=[];if(n.length<1)return[new gi(c,n,"filter array must have at least 1 element")];switch(x=x.concat(_l({key:`${c}[0]`,value:n[0],valueSpec:f.filter_operator,style:l.style,styleSpec:l.styleSpec})),Gr(n[0])){case"<":case"<=":case">":case">=":n.length>=2&&Gr(n[1])==="$type"&&x.push(new gi(c,n,`"$type" cannot be use with operator "${n[0]}"`));case"==":case"!=":n.length!==3&&x.push(new gi(c,n,`filter array for operator "${n[0]}" must have 3 elements`));case"in":case"!in":n.length>=2&&(m=Ji(n[1]),m!=="string"&&x.push(new gi(`${c}[1]`,n[1],`string expected, ${m} found`)));for(let E=2;E<n.length;E++)m=Ji(n[E]),Gr(n[1])==="$type"?x=x.concat(_l({key:`${c}[${E}]`,value:n[E],valueSpec:f.geometry_type,style:l.style,styleSpec:l.styleSpec})):m!=="string"&&m!=="number"&&m!=="boolean"&&x.push(new gi(`${c}[${E}]`,n[E],`string, number, or boolean expected, ${m} found`));break;case"any":case"all":case"none":for(let E=1;E<n.length;E++)x=x.concat(Xc({key:`${c}[${E}]`,value:n[E],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":m=Ji(n[1]),n.length!==2?x.push(new gi(c,n,`filter array for "${n[0]}" operator must have 2 elements`)):m!=="string"&&x.push(new gi(`${c}[1]`,n[1],`string expected, ${m} found`));break;case"within":m=Ji(n[1]),n.length!==2?x.push(new gi(c,n,`filter array for "${n[0]}" operator must have 2 elements`)):m!=="object"&&x.push(new gi(`${c}[1]`,n[1],`object expected, ${m} found`))}return x}function wl(l,n){const c=l.key,f=l.style,m=l.styleSpec,x=l.value,E=l.objectKey,M=m[`${n}_${l.layerType}`];if(!M)return[];const I=E.match(/^(.*)-transition$/);if(n==="paint"&&I&&M[I[1]]&&M[I[1]].transition)return Cn({key:c,value:x,valueSpec:m.transition,style:f,styleSpec:m});const P=l.valueSpec||M[E];if(!P)return[new gi(c,x,`unknown property "${E}"`)];let z;if(Ji(x)==="string"&&On(P)&&!P.tokens&&(z=/^{([^}]+)}$/.exec(x))){const q=`\`{ "type": "identity", "property": ${z?JSON.stringify(z[1]):'"_"'} }\``;return[new gi(c,x,`"${E}" does not support interpolation syntax
Use an identity property function instead: ${q}.`)]}const N=[];return l.layerType==="symbol"&&(E==="text-field"&&f&&!f.glyphs&&N.push(new gi(c,x,'use of "text-field" requires a style "glyphs" property')),E==="text-font"&&to(xo(x))&&Gr(x.type)==="identity"&&N.push(new gi(c,x,'"text-font" does not support identity functions'))),N.concat(Cn({key:l.key,value:x,valueSpec:P,style:f,styleSpec:m,expressionContext:"property",propertyType:n,propertyKey:E}))}function Yc(l){return wl(l,"paint")}function ic(l){return wl(l,"layout")}function rc(l){let n=[];const c=l.value,f=l.key,m=l.style,x=l.styleSpec;c.type||c.ref||n.push(new gi(f,c,'either "type" or "ref" is required'));let E=Gr(c.type);const M=Gr(c.ref);if(c.id){const I=Gr(c.id);for(let P=0;P<l.arrayIndex;P++){const z=m.layers[P];Gr(z.id)===I&&n.push(new gi(f,c.id,`duplicate layer id "${c.id}", previously used at line ${z.id.__line__}`))}}if("ref"in c){let I;["type","source","source-layer","filter","layout"].forEach(P=>{P in c&&n.push(new gi(f,c[P],`"${P}" is prohibited for ref layers`))}),m.layers.forEach(P=>{Gr(P.id)===M&&(I=P)}),I?I.ref?n.push(new gi(f,c.ref,"ref cannot reference another ref layer")):E=Gr(I.type):typeof M=="string"&&n.push(new gi(f,c.ref,`ref layer "${M}" not found`))}else if(E!=="background"&&E!=="sky")if(c.source){const I=m.sources&&m.sources[c.source],P=I&&Gr(I.type);I?P==="vector"&&E==="raster"?n.push(new gi(f,c.source,`layer "${c.id}" requires a raster source`)):P==="raster"&&E!=="raster"?n.push(new gi(f,c.source,`layer "${c.id}" requires a vector source`)):P!=="vector"||c["source-layer"]?P==="raster-dem"&&E!=="hillshade"?n.push(new gi(f,c.source,"raster-dem source can only be used with layer type 'hillshade'.")):E!=="line"||!c.paint||!c.paint["line-gradient"]&&!c.paint["line-trim-offset"]||P==="geojson"&&I.lineMetrics||n.push(new gi(f,c,`layer "${c.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):n.push(new gi(f,c,`layer "${c.id}" must specify a "source-layer"`)):n.push(new gi(f,c.source,`source "${c.source}" not found`))}else n.push(new gi(f,c,'missing required property "source"'));return n=n.concat(io({key:f,value:c,valueSpec:x.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Cn({key:`${f}.type`,value:c.type,valueSpec:x.layer.type,style:l.style,styleSpec:l.styleSpec,object:c,objectKey:"type"}),filter:I=>tc(Sn({layerType:E},I)),layout:I=>io({layer:c,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":P=>ic(Sn({layerType:E},P))}}),paint:I=>io({layer:c,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":P=>Yc(Sn({layerType:E},P))}})}})),n}function fs(l){const n=l.value,c=l.key,f=Ji(n);return f!=="string"?[new gi(c,n,`string expected, ${f} found`)]:[]}const El={promoteId:function({key:l,value:n}){if(Ji(n)==="string")return fs({key:l,value:n});{const c=[];for(const f in n)c.push(...fs({key:`${l}.${f}`,value:n[f]}));return c}}};function Vs(l){const n=l.value,c=l.key,f=l.styleSpec,m=l.style;if(!n.type)return[new gi(c,n,'"type" is required')];const x=Gr(n.type);let E;switch(x){case"vector":case"raster":case"raster-dem":return E=io({key:c,value:n,valueSpec:f[`source_${x.replace("-","_")}`],style:l.style,styleSpec:f,objectElementValidators:El}),E;case"geojson":if(E=io({key:c,value:n,valueSpec:f.source_geojson,style:m,styleSpec:f,objectElementValidators:El}),n.cluster)for(const M in n.clusterProperties){const[I,P]=n.clusterProperties[M],z=typeof I=="string"?[I,["accumulated"],["get",M]]:I;E.push(...hs({key:`${c}.${M}.map`,value:P,expressionContext:"cluster-map"})),E.push(...hs({key:`${c}.${M}.reduce`,value:z,expressionContext:"cluster-reduce"}))}return E;case"video":return io({key:c,value:n,valueSpec:f.source_video,style:m,styleSpec:f});case"image":return io({key:c,value:n,valueSpec:f.source_image,style:m,styleSpec:f});case"canvas":return[new gi(c,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return _l({key:`${c}.type`,value:n.type,valueSpec:{values:Wc(f)},style:m,styleSpec:f})}}function Wc(l){return l.source.reduce((n,c)=>{const f=l[c];return f.type.type==="enum"&&(n=n.concat(Object.keys(f.type.values))),n},[])}function Kc(l){const n=l.value,c=l.styleSpec,f=c.light,m=l.style;let x=[];const E=Ji(n);if(n===void 0)return x;if(E!=="object")return x=x.concat([new gi("light",n,`object expected, ${E} found`)]),x;for(const M in n){const I=M.match(/^(.*)-transition$/);x=x.concat(I&&f[I[1]]&&f[I[1]].transition?Cn({key:M,value:n[M],valueSpec:c.transition,style:m,styleSpec:c}):f[M]?Cn({key:M,value:n[M],valueSpec:f[M],style:m,styleSpec:c}):[new gi(M,n[M],`unknown property "${M}"`)])}return x}function nc(l){const n=l.value,c=l.key,f=l.style,m=l.styleSpec,x=m.terrain;let E=[];const M=Ji(n);if(n===void 0)return E;if(M!=="object")return E=E.concat([new gi("terrain",n,`object expected, ${M} found`)]),E;for(const I in n){const P=I.match(/^(.*)-transition$/);E=E.concat(P&&x[P[1]]&&x[P[1]].transition?Cn({key:I,value:n[I],valueSpec:m.transition,style:f,styleSpec:m}):x[I]?Cn({key:I,value:n[I],valueSpec:x[I],style:f,styleSpec:m}):[new gi(I,n[I],`unknown property "${I}"`)])}if(n.source){const I=f.sources&&f.sources[n.source],P=I&&Gr(I.type);I?P!=="raster-dem"&&E.push(new gi(c,n.source,`terrain cannot be used with a source of type ${String(P)}, it only be used with a "raster-dem" source type`)):E.push(new gi(c,n.source,`source "${n.source}" not found`))}else E.push(new gi(c,n,'terrain is missing required property "source"'));return E}function Qc(l){const n=l.value,c=l.style,f=l.styleSpec,m=f.fog;let x=[];const E=Ji(n);if(n===void 0)return x;if(E!=="object")return x=x.concat([new gi("fog",n,`object expected, ${E} found`)]),x;for(const M in n){const I=M.match(/^(.*)-transition$/);x=x.concat(I&&m[I[1]]&&m[I[1]].transition?Cn({key:M,value:n[M],valueSpec:f.transition,style:c,styleSpec:f}):m[M]?Cn({key:M,value:n[M],valueSpec:m[M],style:c,styleSpec:f}):[new gi(M,n[M],`unknown property "${M}"`)])}return x}const Tl={"*":()=>[],array:qc,boolean:function(l){const n=l.value,c=l.key,f=Ji(n);return f!=="boolean"?[new gi(c,n,`boolean expected, ${f} found`)]:[]},number:Ql,color:function(l){const n=l.key,c=l.value,f=Ji(c);return f!=="string"?[new gi(n,c,`color expected, ${f} found`)]:hi(c)===null?[new gi(n,c,`color expected, "${c}" found`)]:[]},enum:_l,filter:tc,function:Fs,layer:rc,object:io,source:Vs,light:Kc,terrain:nc,fog:Qc,string:fs,formatted:function(l){return fs(l).length===0?[]:hs(l)},resolvedImage:function(l){return fs(l).length===0?[]:hs(l)},projection:function(l){const n=l.value,c=l.styleSpec,f=c.projection,m=l.style;let x=[];const E=Ji(n);if(E==="object")for(const M in n)x=x.concat(Cn({key:M,value:n[M],valueSpec:f[M],style:m,styleSpec:c}));else E!=="string"&&(x=x.concat([new gi("projection",n,`object or string expected, ${E} found`)]));return x}};function Cn(l){const n=l.value,c=l.valueSpec,f=l.styleSpec;return c.expression&&to(Gr(n))?Fs(l):c.expression&&cs(xo(n))?hs(l):c.type&&Tl[c.type]?Tl[c.type](l):io(Sn({},l,{valueSpec:c.type?f[c.type]:c}))}function Ju(l){const n=l.value,c=l.key,f=fs(l);return f.length||(n.indexOf("{fontstack}")===-1&&f.push(new gi(c,n,'"glyphs" url must include a "{fontstack}" token')),n.indexOf("{range}")===-1&&f.push(new gi(c,n,'"glyphs" url must include a "{range}" token'))),f}function Jc(l,n=ot){return qo(Cn({key:"",value:l,valueSpec:n.$root,styleSpec:n,style:l,objectElementValidators:{glyphs:Ju,"*":()=>[]}}))}const eh=l=>qo(Yc(l)),eu=l=>qo(ic(l));function qo(l){return l.slice().sort((n,c)=>n.line&&c.line?n.line-c.line:0)}function tu(l,n){let c=!1;if(n&&n.length)for(const f of n)l.fire(new rr(new Error(f.message))),c=!0;return c}var ps=Mo;function Mo(l,n,c){var f=this.cells=[];if(l instanceof ArrayBuffer){this.arrayBuffer=l;var m=new Int32Array(this.arrayBuffer);l=m[0],this.d=(n=m[1])+2*(c=m[2]);for(var x=0;x<this.d*this.d;x++){var E=m[3+x],M=m[3+x+1];f.push(E===M?null:m.subarray(E,M))}var I=m[3+f.length+1];this.keys=m.subarray(m[3+f.length],I),this.bboxes=m.subarray(I),this.insert=this._insertReadonly}else{this.d=n+2*c;for(var P=0;P<this.d*this.d;P++)f.push([]);this.keys=[],this.bboxes=[]}this.n=n,this.extent=l,this.padding=c,this.scale=n/l,this.uid=0;var z=c/n*l;this.min=-z,this.max=l+z}Mo.prototype.insert=function(l,n,c,f,m){this._forEachCell(n,c,f,m,this._insertCell,this.uid++),this.keys.push(l),this.bboxes.push(n),this.bboxes.push(c),this.bboxes.push(f),this.bboxes.push(m)},Mo.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Mo.prototype._insertCell=function(l,n,c,f,m,x){this.cells[m].push(x)},Mo.prototype.query=function(l,n,c,f,m){var x=this.min,E=this.max;if(l<=x&&n<=x&&E<=c&&E<=f&&!m)return Array.prototype.slice.call(this.keys);var M=[];return this._forEachCell(l,n,c,f,this._queryCell,M,{},m),M},Mo.prototype._queryCell=function(l,n,c,f,m,x,E,M){var I=this.cells[m];if(I!==null)for(var P=this.keys,z=this.bboxes,N=0;N<I.length;N++){var q=I[N];if(E[q]===void 0){var K=4*q;(M?M(z[K+0],z[K+1],z[K+2],z[K+3]):l<=z[K+2]&&n<=z[K+3]&&c>=z[K+0]&&f>=z[K+1])?(E[q]=!0,x.push(P[q])):E[q]=!1}}},Mo.prototype._forEachCell=function(l,n,c,f,m,x,E,M){for(var I=this._convertToCellCoord(l),P=this._convertToCellCoord(n),z=this._convertToCellCoord(c),N=this._convertToCellCoord(f),q=I;q<=z;q++)for(var K=P;K<=N;K++){var ee=this.d*K+q;if((!M||M(this._convertFromCellCoord(q),this._convertFromCellCoord(K),this._convertFromCellCoord(q+1),this._convertFromCellCoord(K+1)))&&m.call(this,l,n,c,f,ee,x,E,M))return}},Mo.prototype._convertFromCellCoord=function(l){return(l-this.padding)/this.scale},Mo.prototype._convertToCellCoord=function(l){return Math.max(0,Math.min(this.d-1,Math.floor(l*this.scale)+this.padding))},Mo.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var l=this.cells,n=3+this.cells.length+1+1,c=0,f=0;f<this.cells.length;f++)c+=this.cells[f].length;var m=new Int32Array(n+c+this.keys.length+this.bboxes.length);m[0]=this.extent,m[1]=this.n,m[2]=this.padding;for(var x=n,E=0;E<l.length;E++){var M=l[E];m[3+E]=x,m.set(M,x),x+=M.length}return m[3+l.length]=x,m.set(this.keys,x),m[3+l.length+1]=x+=this.keys.length,m.set(this.bboxes,x),x+=this.bboxes.length,m.buffer};const Sl={};function Ti(l,n,c={}){Object.defineProperty(l,"_classRegistryKey",{value:n,writeable:!1}),Sl[n]={klass:l,omit:c.omit||[]}}Ti(Object,"Object"),ps.serialize=function(l,n){const c=l.toArrayBuffer();return n&&n.push(c),{buffer:c}},ps.deserialize=function(l){return new ps(l.buffer)},Object.defineProperty(ps,"name",{value:"Grid"}),Ti(ps,"Grid"),Ti(Yi,"Color"),Ti(Error,"Error"),Ti($i,"AJAXError"),Ti(yn,"ResolvedImage"),Ti(Os,"StylePropertyFunction"),Ti(jo,"StyleExpression",{omit:["_evaluator"]}),Ti(Fa,"ZoomDependentExpression"),Ti(gl,"ZoomConstantExpression"),Ti(Hn,"CompoundExpression",{omit:["_evaluate"]});for(const l in So)Sl[So[l]._classRegistryKey]||Ti(So[l],`Expression${l}`);function iu(l){return l&&typeof ArrayBuffer<"u"&&(l instanceof ArrayBuffer||l.constructor&&l.constructor.name==="ArrayBuffer")}function js(l){return b.ImageBitmap&&l instanceof b.ImageBitmap}function qs(l,n){if(l==null||typeof l=="boolean"||typeof l=="number"||typeof l=="string"||l instanceof Boolean||l instanceof Number||l instanceof String||l instanceof Date||l instanceof RegExp)return l;if(iu(l)||js(l))return n&&n.push(l),l;if(ArrayBuffer.isView(l)){const c=l;return n&&n.push(c.buffer),c}if(l instanceof b.ImageData)return n&&n.push(l.data.buffer),l;if(Array.isArray(l)){const c=[];for(const f of l)c.push(qs(f,n));return c}if(typeof l=="object"){const c=l.constructor,f=c._classRegistryKey;if(!f)throw new Error(`can't serialize object of unregistered class ${f}`);const m=c.serialize?c.serialize(l,n):{};if(!c.serialize){for(const x in l)l.hasOwnProperty(x)&&(Sl[f].omit.indexOf(x)>=0||(m[x]=qs(l[x],n)));l instanceof Error&&(m.message=l.message)}if(m.$name)throw new Error("$name property is reserved for worker serialization logic.");return f!=="Object"&&(m.$name=f),m}throw new Error("can't serialize object of type "+typeof l)}function Gs(l){if(l==null||typeof l=="boolean"||typeof l=="number"||typeof l=="string"||l instanceof Boolean||l instanceof Number||l instanceof String||l instanceof Date||l instanceof RegExp||iu(l)||js(l)||ArrayBuffer.isView(l)||l instanceof b.ImageData)return l;if(Array.isArray(l))return l.map(Gs);if(typeof l=="object"){const n=l.$name||"Object",{klass:c}=Sl[n];if(!c)throw new Error(`can't deserialize unregistered class ${n}`);if(c.deserialize)return c.deserialize(l);const f=Object.create(c.prototype);for(const m of Object.keys(l))m!=="$name"&&(f[m]=Gs(l[m]));return f}throw new Error("can't deserialize object of type "+typeof l)}const Zs=l=>l>=1536&&l<=1791,ru=l=>l>=1872&&l<=1919,oc=l=>l>=2208&&l<=2303,nu=l=>l>=11904&&l<=12031,ac=l=>l>=12032&&l<=12255,sc=l=>l>=12272&&l<=12287,Hs=l=>l>=12288&&l<=12351,Ml=l=>l>=12352&&l<=12447,ms=l=>l>=12448&&l<=12543,Al=l=>l>=12544&&l<=12591,ou=l=>l>=12704&&l<=12735,au=l=>l>=12736&&l<=12783,lc=l=>l>=12784&&l<=12799,su=l=>l>=12800&&l<=13055,lu=l=>l>=13056&&l<=13311,cu=l=>l>=13312&&l<=19903,cc=l=>l>=19968&&l<=40959,uu=l=>l>=40960&&l<=42127,hu=l=>l>=42128&&l<=42191,du=l=>l>=44032&&l<=55215,fu=l=>l>=63744&&l<=64255,Cl=l=>l>=64336&&l<=65023,Xs=l=>l>=65040&&l<=65055,y=l=>l>=65072&&l<=65103,u=l=>l>=65104&&l<=65135,p=l=>l>=65136&&l<=65279,w=l=>l>=65280&&l<=65519;function S(l){for(const n of l)if(B(n.charCodeAt(0)))return!0;return!1}function A(l){for(const n of l)if(!L(n.charCodeAt(0)))return!1;return!0}function L(l){return!(Zs(l)||ru(l)||oc(l)||Cl(l)||p(l))}function B(l){return!(l!==746&&l!==747&&(l<4352||!(ou(l)||Al(l)||y(l)&&!(l>=65097&&l<=65103)||fu(l)||lu(l)||nu(l)||au(l)||!(!Hs(l)||l>=12296&&l<=12305||l>=12308&&l<=12319||l===12336)||cu(l)||cc(l)||su(l)||(n=>n>=12592&&n<=12687)(l)||(n=>n>=43360&&n<=43391)(l)||(n=>n>=55216&&n<=55295)(l)||(n=>n>=4352&&n<=4607)(l)||du(l)||Ml(l)||sc(l)||(n=>n>=12688&&n<=12703)(l)||ac(l)||lc(l)||ms(l)&&l!==12540||!(!w(l)||l===65288||l===65289||l===65293||l>=65306&&l<=65310||l===65339||l===65341||l===65343||l>=65371&&l<=65503||l===65507||l>=65512&&l<=65519)||!(!u(l)||l>=65112&&l<=65118||l>=65123&&l<=65126)||(n=>n>=5120&&n<=5759)(l)||(n=>n>=6320&&n<=6399)(l)||Xs(l)||(n=>n>=19904&&n<=19967)(l)||uu(l)||hu(l))))}function F(l){return!(B(l)||function(n){return!!((c=>c>=128&&c<=255)(n)&&(n===167||n===169||n===174||n===177||n===188||n===189||n===190||n===215||n===247)||(c=>c>=8192&&c<=8303)(n)&&(n===8214||n===8224||n===8225||n===8240||n===8241||n===8251||n===8252||n===8258||n===8263||n===8264||n===8265||n===8273)||(c=>c>=8448&&c<=8527)(n)||(c=>c>=8528&&c<=8591)(n)||(c=>c>=8960&&c<=9215)(n)&&(n>=8960&&n<=8967||n>=8972&&n<=8991||n>=8996&&n<=9e3||n===9003||n>=9085&&n<=9114||n>=9150&&n<=9165||n===9167||n>=9169&&n<=9179||n>=9186&&n<=9215)||(c=>c>=9216&&c<=9279)(n)&&n!==9251||(c=>c>=9280&&c<=9311)(n)||(c=>c>=9312&&c<=9471)(n)||(c=>c>=9632&&c<=9727)(n)||(c=>c>=9728&&c<=9983)(n)&&!(n>=9754&&n<=9759)||(c=>c>=11008&&c<=11263)(n)&&(n>=11026&&n<=11055||n>=11088&&n<=11097||n>=11192&&n<=11243)||Hs(n)||ms(n)||(c=>c>=57344&&c<=63743)(n)||y(n)||u(n)||w(n)||n===8734||n===8756||n===8757||n>=9984&&n<=10087||n>=10102&&n<=10131||n===65532||n===65533)}(l))}function Y(l){return l>=1424&&l<=2303||Cl(l)||p(l)}function X(l,n){return!(!n&&Y(l)||l>=2304&&l<=3583||l>=3840&&l<=4255||(c=>c>=6016&&c<=6143)(l))}function ie(l){for(const n of l)if(Y(n.charCodeAt(0)))return!0;return!1}const de="deferred",ge="loading",ye="loaded";let ve=null,xe="unavailable",ce=null;const Se=function(l){l&&typeof l=="string"&&l.indexOf("NetworkError")>-1&&(xe="error"),ve&&ve(l)};function Te(){Ae.fire(new Bi("pluginStateChange",{pluginStatus:xe,pluginURL:ce}))}const Ae=new dr,Fe=function(){return xe},$e=function(){if(xe!==de||!ce)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");xe=ge,Te(),ce&&zi({url:ce},l=>{l?Se(l):(xe=ye,Te())})},qe={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>xe===ye||qe.applyArabicShaping!=null,isLoading:()=>xe===ge,setState(l){xe=l.pluginStatus,ce=l.pluginURL},isParsed:()=>qe.applyArabicShaping!=null&&qe.processBidirectionalText!=null&&qe.processStyledBidirectionalText!=null,getPluginURL:()=>ce};class Je{constructor(n,c){this.zoom=n,c?(this.now=c.now,this.fadeDuration=c.fadeDuration,this.transition=c.transition,this.pitch=c.pitch):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0)}isSupportedScript(n){return function(c,f){for(const m of c)if(!X(m.charCodeAt(0),f))return!1;return!0}(n,qe.isLoaded())}}class rt{constructor(n,c){this.property=n,this.value=c,this.expression=function(f,m){if(to(f))return new Os(f,m);if(cs(f)){const x=Na(f,m);if(x.result==="error")throw new Error(x.value.map(E=>`${E.key}: ${E.message}`).join(", "));return x.value}{let x=f;return typeof f=="string"&&m.type==="color"&&(x=Yi.parse(f)),{kind:"constant",evaluate:()=>x}}}(c===void 0?n.specification.default:c,n.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(n,c,f){return this.property.possiblyEvaluate(this,n,c,f)}}class lt{constructor(n){this.property=n,this.value=new rt(n,void 0)}transitioned(n,c){return new et(this.property,this.value,c,tt({},n.transition,this.transition),n.now)}untransitioned(){return new et(this.property,this.value,null,{},0)}}class Jt{constructor(n){this._properties=n,this._values=Object.create(n.defaultTransitionablePropertyValues)}getValue(n){return si(this._values[n].value.value)}setValue(n,c){this._values.hasOwnProperty(n)||(this._values[n]=new lt(this._values[n].property)),this._values[n].value=new rt(this._values[n].property,c===null?void 0:si(c))}getTransition(n){return si(this._values[n].transition)}setTransition(n,c){this._values.hasOwnProperty(n)||(this._values[n]=new lt(this._values[n].property)),this._values[n].transition=si(c)||void 0}serialize(){const n={};for(const c of Object.keys(this._values)){const f=this.getValue(c);f!==void 0&&(n[c]=f);const m=this.getTransition(c);m!==void 0&&(n[`${c}-transition`]=m)}return n}transitioned(n,c){const f=new Dt(this._properties);for(const m of Object.keys(this._values))f._values[m]=this._values[m].transitioned(n,c._values[m]);return f}untransitioned(){const n=new Dt(this._properties);for(const c of Object.keys(this._values))n._values[c]=this._values[c].untransitioned();return n}}class et{constructor(n,c,f,m,x){const E=m.delay||0,M=m.duration||0;x=x||0,this.property=n,this.value=c,this.begin=x+E,this.end=this.begin+M,n.specification.transition&&(m.delay||m.duration)&&(this.prior=f)}possiblyEvaluate(n,c,f){const m=n.now||0,x=this.value.possiblyEvaluate(n,c,f),E=this.prior;if(E){if(m>this.end)return this.prior=null,x;if(this.value.isDataDriven())return this.prior=null,x;if(m<this.begin)return E.possiblyEvaluate(n,c,f);{const M=(m-this.begin)/(this.end-this.begin);return this.property.interpolate(E.possiblyEvaluate(n,c,f),x,Me(M))}}return x}}class Dt{constructor(n){this._properties=n,this._values=Object.create(n.defaultTransitioningPropertyValues)}possiblyEvaluate(n,c,f){const m=new at(this._properties);for(const x of Object.keys(this._values))m._values[x]=this._values[x].possiblyEvaluate(n,c,f);return m}hasTransition(){for(const n of Object.keys(this._values))if(this._values[n].prior)return!0;return!1}}class gt{constructor(n){this._properties=n,this._values=Object.create(n.defaultPropertyValues)}getValue(n){return si(this._values[n].value)}setValue(n,c){this._values[n]=new rt(this._values[n].property,c===null?void 0:si(c))}serialize(){const n={};for(const c of Object.keys(this._values)){const f=this.getValue(c);f!==void 0&&(n[c]=f)}return n}possiblyEvaluate(n,c,f){const m=new at(this._properties);for(const x of Object.keys(this._values))m._values[x]=this._values[x].possiblyEvaluate(n,c,f);return m}}class zt{constructor(n,c,f){this.property=n,this.value=c,this.parameters=f}isConstant(){return this.value.kind==="constant"}constantOr(n){return this.value.kind==="constant"?this.value.value:n}evaluate(n,c,f,m){return this.property.evaluate(this.value,this.parameters,n,c,f,m)}}class at{constructor(n){this._properties=n,this._values=Object.create(n.defaultPossiblyEvaluatedValues)}get(n){return this._values[n]}}class Ke{constructor(n){this.specification=n}possiblyEvaluate(n,c){return n.expression.evaluate(c)}interpolate(n,c,f){const m=wo[this.specification.type];return m?m(n,c,f):n}}class ut{constructor(n,c){this.specification=n,this.overrides=c}possiblyEvaluate(n,c,f,m){return new zt(this,n.expression.kind==="constant"||n.expression.kind==="camera"?{kind:"constant",value:n.expression.evaluate(c,null,{},f,m)}:n.expression,c)}interpolate(n,c,f){if(n.value.kind!=="constant"||c.value.kind!=="constant")return n;if(n.value.value===void 0||c.value.value===void 0)return new zt(this,{kind:"constant",value:void 0},n.parameters);const m=wo[this.specification.type];return m?new zt(this,{kind:"constant",value:m(n.value.value,c.value.value,f)},n.parameters):n}evaluate(n,c,f,m,x,E){return n.kind==="constant"?n.value:n.evaluate(c,f,m,x,E)}}class Lt{constructor(n){this.specification=n}possiblyEvaluate(n,c,f,m){return!!n.expression.evaluate(c,null,{},f,m)}interpolate(){return!1}}class jt{constructor(n){this.properties=n,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const c=new Je(0,{});for(const f in n){const m=n[f];m.specification.overridable&&this.overridableProperties.push(f);const x=this.defaultPropertyValues[f]=new rt(m,void 0),E=this.defaultTransitionablePropertyValues[f]=new lt(m);this.defaultTransitioningPropertyValues[f]=E.untransitioned(),this.defaultPossiblyEvaluatedValues[f]=x.possiblyEvaluate(c)}}}function Pi(l,n){return 256*(l=Ge(Math.floor(l),0,255))+Ge(Math.floor(n),0,255)}Ti(ut,"DataDrivenProperty"),Ti(Ke,"DataConstantProperty"),Ti(Lt,"ColorRampProperty");const er={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Si{constructor(n,c){this._structArray=n,this._pos1=c*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class yi{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(n,c){return n._trim(),c&&(n.isTransferred=!0,c.push(n.arrayBuffer)),{length:n.length,arrayBuffer:n.arrayBuffer}}static deserialize(n){const c=Object.create(this.prototype);return c.arrayBuffer=n.arrayBuffer,c.length=n.length,c.capacity=n.arrayBuffer.byteLength/c.bytesPerElement,c._refreshViews(),c}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(n){this.reserve(n),this.length=n}reserve(n){if(n>this.capacity){this.capacity=Math.max(n,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const c=this.uint8;this._refreshViews(),c&&this.uint8.set(c)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Oi(l,n=1){let c=0,f=0;return{members:l.map(m=>{const x=er[m.type].BYTES_PER_ELEMENT,E=c=ar(c,Math.max(n,x)),M=m.components||1;return f=Math.max(f,x),c+=x*M,{name:m.name,type:m.type,components:M,offset:E}}),size:ar(c,Math.max(f,n)),alignment:n}}function ar(l,n){return Math.ceil(l/n)*n}class Ui extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c){const f=this.length;return this.resize(f+1),this.emplace(f,n,c)}emplace(n,c,f){const m=2*n;return this.int16[m+0]=c,this.int16[m+1]=f,n}}Ui.prototype.bytesPerElement=4,Ti(Ui,"StructArrayLayout2i4");class yr extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,f){const m=this.length;return this.resize(m+1),this.emplace(m,n,c,f)}emplace(n,c,f,m){const x=3*n;return this.int16[x+0]=c,this.int16[x+1]=f,this.int16[x+2]=m,n}}yr.prototype.bytesPerElement=6,Ti(yr,"StructArrayLayout3i6");class vr extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,f,m){const x=this.length;return this.resize(x+1),this.emplace(x,n,c,f,m)}emplace(n,c,f,m,x){const E=4*n;return this.int16[E+0]=c,this.int16[E+1]=f,this.int16[E+2]=m,this.int16[E+3]=x,n}}vr.prototype.bytesPerElement=8,Ti(vr,"StructArrayLayout4i8");class Dr extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x,E,M){const I=this.length;return this.resize(I+1),this.emplace(I,n,c,f,m,x,E,M)}emplace(n,c,f,m,x,E,M,I){const P=6*n,z=12*n,N=3*n;return this.int16[P+0]=c,this.int16[P+1]=f,this.uint8[z+4]=m,this.uint8[z+5]=x,this.uint8[z+6]=E,this.uint8[z+7]=M,this.float32[N+2]=I,n}}Dr.prototype.bytesPerElement=12,Ti(Dr,"StructArrayLayout2i4ub1f12");class Ar extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,f,m){const x=this.length;return this.resize(x+1),this.emplace(x,n,c,f,m)}emplace(n,c,f,m,x){const E=4*n;return this.float32[E+0]=c,this.float32[E+1]=f,this.float32[E+2]=m,this.float32[E+3]=x,n}}Ar.prototype.bytesPerElement=16,Ti(Ar,"StructArrayLayout4f16");class sn extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x){const E=this.length;return this.resize(E+1),this.emplace(E,n,c,f,m,x)}emplace(n,c,f,m,x,E){const M=6*n,I=3*n;return this.uint16[M+0]=c,this.uint16[M+1]=f,this.uint16[M+2]=m,this.uint16[M+3]=x,this.float32[I+2]=E,n}}sn.prototype.bytesPerElement=12,Ti(sn,"StructArrayLayout4ui1f12");class Un extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,f,m){const x=this.length;return this.resize(x+1),this.emplace(x,n,c,f,m)}emplace(n,c,f,m,x){const E=4*n;return this.uint16[E+0]=c,this.uint16[E+1]=f,this.uint16[E+2]=m,this.uint16[E+3]=x,n}}Un.prototype.bytesPerElement=8,Ti(Un,"StructArrayLayout4ui8");class go extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x,E){const M=this.length;return this.resize(M+1),this.emplace(M,n,c,f,m,x,E)}emplace(n,c,f,m,x,E,M){const I=6*n;return this.int16[I+0]=c,this.int16[I+1]=f,this.int16[I+2]=m,this.int16[I+3]=x,this.int16[I+4]=E,this.int16[I+5]=M,n}}go.prototype.bytesPerElement=12,Ti(go,"StructArrayLayout6i12");class Go extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x,E,M,I,P,z,N,q){const K=this.length;return this.resize(K+1),this.emplace(K,n,c,f,m,x,E,M,I,P,z,N,q)}emplace(n,c,f,m,x,E,M,I,P,z,N,q,K){const ee=12*n;return this.int16[ee+0]=c,this.int16[ee+1]=f,this.int16[ee+2]=m,this.int16[ee+3]=x,this.uint16[ee+4]=E,this.uint16[ee+5]=M,this.uint16[ee+6]=I,this.uint16[ee+7]=P,this.int16[ee+8]=z,this.int16[ee+9]=N,this.int16[ee+10]=q,this.int16[ee+11]=K,n}}Go.prototype.bytesPerElement=24,Ti(Go,"StructArrayLayout4i4ui4i24");class Fr extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x,E){const M=this.length;return this.resize(M+1),this.emplace(M,n,c,f,m,x,E)}emplace(n,c,f,m,x,E,M){const I=10*n,P=5*n;return this.int16[I+0]=c,this.int16[I+1]=f,this.int16[I+2]=m,this.float32[P+2]=x,this.float32[P+3]=E,this.float32[P+4]=M,n}}Fr.prototype.bytesPerElement=20,Ti(Fr,"StructArrayLayout3i3f20");class Cr extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(n){const c=this.length;return this.resize(c+1),this.emplace(c,n)}emplace(n,c){return this.uint32[1*n+0]=c,n}}Cr.prototype.bytesPerElement=4,Ti(Cr,"StructArrayLayout1ul4");class mr extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x,E,M,I,P,z,N,q,K){const ee=this.length;return this.resize(ee+1),this.emplace(ee,n,c,f,m,x,E,M,I,P,z,N,q,K)}emplace(n,c,f,m,x,E,M,I,P,z,N,q,K,ee){const oe=20*n,pe=10*n;return this.int16[oe+0]=c,this.int16[oe+1]=f,this.int16[oe+2]=m,this.int16[oe+3]=x,this.int16[oe+4]=E,this.float32[pe+3]=M,this.float32[pe+4]=I,this.float32[pe+5]=P,this.float32[pe+6]=z,this.int16[oe+14]=N,this.uint32[pe+8]=q,this.uint16[oe+18]=K,this.uint16[oe+19]=ee,n}}mr.prototype.bytesPerElement=40,Ti(mr,"StructArrayLayout5i4f1i1ul2ui40");class Yr extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x,E,M){const I=this.length;return this.resize(I+1),this.emplace(I,n,c,f,m,x,E,M)}emplace(n,c,f,m,x,E,M,I){const P=8*n;return this.int16[P+0]=c,this.int16[P+1]=f,this.int16[P+2]=m,this.int16[P+4]=x,this.int16[P+5]=E,this.int16[P+6]=M,this.int16[P+7]=I,n}}Yr.prototype.bytesPerElement=16,Ti(Yr,"StructArrayLayout3i2i2i16");class In extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x){const E=this.length;return this.resize(E+1),this.emplace(E,n,c,f,m,x)}emplace(n,c,f,m,x,E){const M=4*n,I=8*n;return this.float32[M+0]=c,this.float32[M+1]=f,this.float32[M+2]=m,this.int16[I+6]=x,this.int16[I+7]=E,n}}In.prototype.bytesPerElement=16,Ti(In,"StructArrayLayout2f1f2i16");class $r extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,f,m){const x=this.length;return this.resize(x+1),this.emplace(x,n,c,f,m)}emplace(n,c,f,m,x){const E=12*n,M=3*n;return this.uint8[E+0]=c,this.uint8[E+1]=f,this.float32[M+1]=m,this.float32[M+2]=x,n}}$r.prototype.bytesPerElement=12,Ti($r,"StructArrayLayout2ub2f12");class kn extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,f){const m=this.length;return this.resize(m+1),this.emplace(m,n,c,f)}emplace(n,c,f,m){const x=3*n;return this.float32[x+0]=c,this.float32[x+1]=f,this.float32[x+2]=m,n}}kn.prototype.bytesPerElement=12,Ti(kn,"StructArrayLayout3f12");class Dn extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,f){const m=this.length;return this.resize(m+1),this.emplace(m,n,c,f)}emplace(n,c,f,m){const x=3*n;return this.uint16[x+0]=c,this.uint16[x+1]=f,this.uint16[x+2]=m,n}}Dn.prototype.bytesPerElement=6,Ti(Dn,"StructArrayLayout3ui6");class ua extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x,E,M,I,P,z,N,q,K,ee,oe,pe,Ee,Re,be,De,ze){const Le=this.length;return this.resize(Le+1),this.emplace(Le,n,c,f,m,x,E,M,I,P,z,N,q,K,ee,oe,pe,Ee,Re,be,De,ze)}emplace(n,c,f,m,x,E,M,I,P,z,N,q,K,ee,oe,pe,Ee,Re,be,De,ze,Le){const st=30*n,it=15*n,wt=60*n;return this.int16[st+0]=c,this.int16[st+1]=f,this.int16[st+2]=m,this.float32[it+2]=x,this.float32[it+3]=E,this.uint16[st+8]=M,this.uint16[st+9]=I,this.uint32[it+5]=P,this.uint32[it+6]=z,this.uint32[it+7]=N,this.uint16[st+16]=q,this.uint16[st+17]=K,this.uint16[st+18]=ee,this.float32[it+10]=oe,this.float32[it+11]=pe,this.uint8[wt+48]=Ee,this.uint8[wt+49]=Re,this.uint8[wt+50]=be,this.uint32[it+13]=De,this.int16[st+28]=ze,this.uint8[wt+58]=Le,n}}ua.prototype.bytesPerElement=60,Ti(ua,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class gs extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x,E,M,I,P,z,N,q,K,ee,oe,pe,Ee,Re,be,De,ze,Le,st,it,wt,Gt,ft,kt,Rt,Ft){const Zt=this.length;return this.resize(Zt+1),this.emplace(Zt,n,c,f,m,x,E,M,I,P,z,N,q,K,ee,oe,pe,Ee,Re,be,De,ze,Le,st,it,wt,Gt,ft,kt,Rt,Ft)}emplace(n,c,f,m,x,E,M,I,P,z,N,q,K,ee,oe,pe,Ee,Re,be,De,ze,Le,st,it,wt,Gt,ft,kt,Rt,Ft,Zt){const pt=38*n,oi=19*n;return this.int16[pt+0]=c,this.int16[pt+1]=f,this.int16[pt+2]=m,this.float32[oi+2]=x,this.float32[oi+3]=E,this.int16[pt+8]=M,this.int16[pt+9]=I,this.int16[pt+10]=P,this.int16[pt+11]=z,this.int16[pt+12]=N,this.int16[pt+13]=q,this.uint16[pt+14]=K,this.uint16[pt+15]=ee,this.uint16[pt+16]=oe,this.uint16[pt+17]=pe,this.uint16[pt+18]=Ee,this.uint16[pt+19]=Re,this.uint16[pt+20]=be,this.uint16[pt+21]=De,this.uint16[pt+22]=ze,this.uint16[pt+23]=Le,this.uint16[pt+24]=st,this.uint16[pt+25]=it,this.uint16[pt+26]=wt,this.uint16[pt+27]=Gt,this.uint16[pt+28]=ft,this.uint32[oi+15]=kt,this.float32[oi+16]=Rt,this.float32[oi+17]=Ft,this.float32[oi+18]=Zt,n}}gs.prototype.bytesPerElement=76,Ti(gs,"StructArrayLayout3i2f6i15ui1ul3f76");class Kn extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n){const c=this.length;return this.resize(c+1),this.emplace(c,n)}emplace(n,c){return this.float32[1*n+0]=c,n}}Kn.prototype.bytesPerElement=4,Ti(Kn,"StructArrayLayout1f4");class ro extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c,f,m,x){const E=this.length;return this.resize(E+1),this.emplace(E,n,c,f,m,x)}emplace(n,c,f,m,x,E){const M=5*n;return this.float32[M+0]=c,this.float32[M+1]=f,this.float32[M+2]=m,this.float32[M+3]=x,this.float32[M+4]=E,n}}ro.prototype.bytesPerElement=20,Ti(ro,"StructArrayLayout5f20");class Zo extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c,f,m){const x=this.length;return this.resize(x+1),this.emplace(x,n,c,f,m)}emplace(n,c,f,m,x){const E=6*n;return this.uint32[3*n+0]=c,this.uint16[E+2]=f,this.uint16[E+3]=m,this.uint16[E+4]=x,n}}Zo.prototype.bytesPerElement=12,Ti(Zo,"StructArrayLayout1ul3ui12");class ha extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n,c){const f=this.length;return this.resize(f+1),this.emplace(f,n,c)}emplace(n,c,f){const m=2*n;return this.uint16[m+0]=c,this.uint16[m+1]=f,n}}ha.prototype.bytesPerElement=4,Ti(ha,"StructArrayLayout2ui4");class da extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(n){const c=this.length;return this.resize(c+1),this.emplace(c,n)}emplace(n,c){return this.uint16[1*n+0]=c,n}}da.prototype.bytesPerElement=2,Ti(da,"StructArrayLayout1ui2");class _s extends yi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(n,c){const f=this.length;return this.resize(f+1),this.emplace(f,n,c)}emplace(n,c,f){const m=2*n;return this.float32[m+0]=c,this.float32[m+1]=f,n}}_s.prototype.bytesPerElement=8,Ti(_s,"StructArrayLayout2f8");class sd extends Si{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}sd.prototype.size=40;class th extends mr{get(n){return new sd(this,n)}}Ti(th,"CollisionBoxArray");class ld extends Si{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(n){this._structArray.uint8[this._pos1+49]=n}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(n){this._structArray.uint8[this._pos1+50]=n}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(n){this._structArray.uint32[this._pos4+13]=n}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(n){this._structArray.uint8[this._pos1+58]=n}}ld.prototype.size=60;class cd extends ua{get(n){return new ld(this,n)}}Ti(cd,"PlacedSymbolArray");class ud extends Si{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(n){this._structArray.uint32[this._pos4+15]=n}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}ud.prototype.size=76;class hd extends gs{get(n){return new ud(this,n)}}Ti(hd,"SymbolInstanceArray");class dd extends Kn{getoffsetX(n){return this.float32[1*n+0]}}Ti(dd,"GlyphOffsetArray");class fd extends Ui{getx(n){return this.int16[2*n+0]}gety(n){return this.int16[2*n+1]}}Ti(fd,"SymbolLineVertexArray");class pd extends Si{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}pd.prototype.size=12;class md extends Zo{get(n){return new pd(this,n)}}Ti(md,"FeatureIndexArray");class gd extends ha{geta_centroid_pos0(n){return this.uint16[2*n+0]}geta_centroid_pos1(n){return this.uint16[2*n+1]}}Ti(gd,"FillExtrusionCentroidArray");const Up=Oi([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Vp=Oi([{name:"a_dash",components:4,type:"Uint16"}]);var Ys={},jp={get exports(){return Ys},set exports(l){Ys=l}},ih={};({get exports(){return ih},set exports(l){ih=l}}).exports=function(l,n){var c,f,m,x,E,M,I,P;for(f=l.length-(c=3&l.length),m=n,E=3432918353,M=461845907,P=0;P<f;)I=255&l.charCodeAt(P)|(255&l.charCodeAt(++P))<<8|(255&l.charCodeAt(++P))<<16|(255&l.charCodeAt(++P))<<24,++P,m=27492+(65535&(x=5*(65535&(m=(m^=I=(65535&(I=(I=(65535&I)*E+(((I>>>16)*E&65535)<<16)&4294967295)<<15|I>>>17))*M+(((I>>>16)*M&65535)<<16)&4294967295)<<13|m>>>19))+((5*(m>>>16)&65535)<<16)&4294967295))+((58964+(x>>>16)&65535)<<16);switch(I=0,c){case 3:I^=(255&l.charCodeAt(P+2))<<16;case 2:I^=(255&l.charCodeAt(P+1))<<8;case 1:m^=I=(65535&(I=(I=(65535&(I^=255&l.charCodeAt(P)))*E+(((I>>>16)*E&65535)<<16)&4294967295)<<15|I>>>17))*M+(((I>>>16)*M&65535)<<16)&4294967295}return m^=l.length,m=2246822507*(65535&(m^=m>>>16))+((2246822507*(m>>>16)&65535)<<16)&4294967295,m=3266489909*(65535&(m^=m>>>13))+((3266489909*(m>>>16)&65535)<<16)&4294967295,(m^=m>>>16)>>>0};var rh={};({get exports(){return rh},set exports(l){rh=l}}).exports=function(l,n){for(var c,f=l.length,m=n^f,x=0;f>=4;)c=1540483477*(65535&(c=255&l.charCodeAt(x)|(255&l.charCodeAt(++x))<<8|(255&l.charCodeAt(++x))<<16|(255&l.charCodeAt(++x))<<24))+((1540483477*(c>>>16)&65535)<<16),m=1540483477*(65535&m)+((1540483477*(m>>>16)&65535)<<16)^(c=1540483477*(65535&(c^=c>>>24))+((1540483477*(c>>>16)&65535)<<16)),f-=4,++x;switch(f){case 3:m^=(255&l.charCodeAt(x+2))<<16;case 2:m^=(255&l.charCodeAt(x+1))<<8;case 1:m=1540483477*(65535&(m^=255&l.charCodeAt(x)))+((1540483477*(m>>>16)&65535)<<16)}return m=1540483477*(65535&(m^=m>>>13))+((1540483477*(m>>>16)&65535)<<16),(m^=m>>>15)>>>0};var _d=ih,qp=rh;jp.exports=_d,Ys.murmur3=_d,Ys.murmur2=qp;class pu{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(n,c,f,m){this.ids.push(yd(n)),this.positions.push(c,f,m)}getPositions(n){const c=yd(n);let f=0,m=this.ids.length-1;for(;f<m;){const E=f+m>>1;this.ids[E]>=c?m=E:f=E+1}const x=[];for(;this.ids[f]===c;)x.push({index:this.positions[3*f],start:this.positions[3*f+1],end:this.positions[3*f+2]}),f++;return x}static serialize(n,c){const f=new Float64Array(n.ids),m=new Uint32Array(n.positions);return nh(f,m,0,f.length-1),c&&c.push(f.buffer,m.buffer),{ids:f,positions:m}}static deserialize(n){const c=new pu;return c.ids=n.ids,c.positions=n.positions,c.indexed=!0,c}}function yd(l){const n=+l;return!isNaN(n)&&Number.MIN_SAFE_INTEGER<=n&&n<=Number.MAX_SAFE_INTEGER?n:Ys(String(l))}function nh(l,n,c,f){for(;c<f;){const m=l[c+f>>1];let x=c-1,E=f+1;for(;;){do x++;while(l[x]<m);do E--;while(l[E]>m);if(x>=E)break;mu(l,x,E),mu(n,3*x,3*E),mu(n,3*x+1,3*E+1),mu(n,3*x+2,3*E+2)}E-c<f-E?(nh(l,n,c,E),c=E+1):(nh(l,n,E+1,f),f=E)}}function mu(l,n,c){const f=l[n];l[n]=l[c],l[c]=f}Ti(pu,"FeaturePositionMap");class Ua{constructor(n){this.gl=n.gl,this.initialized=!1}fetchUniformLocation(n,c){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(n,c),this.initialized=!0),!!this.location}}class gu extends Ua{constructor(n){super(n),this.current=0}set(n,c,f){this.fetchUniformLocation(n,c)&&this.current!==f&&(this.current=f,this.gl.uniform1f(this.location,f))}}class vd extends Ua{constructor(n){super(n),this.current=[0,0,0,0]}set(n,c,f){this.fetchUniformLocation(n,c)&&(f[0]===this.current[0]&&f[1]===this.current[1]&&f[2]===this.current[2]&&f[3]===this.current[3]||(this.current=f,this.gl.uniform4f(this.location,f[0],f[1],f[2],f[3])))}}class xd extends Ua{constructor(n){super(n),this.current=Yi.transparent}set(n,c,f){this.fetchUniformLocation(n,c)&&(f.r===this.current.r&&f.g===this.current.g&&f.b===this.current.b&&f.a===this.current.a||(this.current=f,this.gl.uniform4f(this.location,f.r,f.g,f.b,f.a)))}}const Gp=new Float32Array(16),Zp=new Float32Array(9),Hp=new Float32Array(4);function oh(l){return[Pi(255*l.r,255*l.g),Pi(255*l.b,255*l.a)]}class uc{constructor(n,c,f){this.value=n,this.uniformNames=c.map(m=>`u_${m}`),this.type=f}setUniform(n,c,f,m,x){c.set(n,x,m.constantOr(this.value))}getBinding(n,c){return this.type==="color"?new xd(n):new gu(n)}}class Il{constructor(n,c){this.uniformNames=c.map(f=>`u_${f}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(n){this.pixelRatio=n.pixelRatio||1,this.pattern=n.tl.concat(n.br)}setUniform(n,c,f,m,x){const E=x==="u_pattern"||x==="u_dash"?this.pattern:x==="u_pixel_ratio"?this.pixelRatio:null;E&&c.set(n,x,E)}getBinding(n,c){return c==="u_pattern"||c==="u_dash"?new vd(n):new gu(n)}}class Va{constructor(n,c,f,m){this.expression=n,this.type=f,this.maxValue=0,this.paintVertexAttributes=c.map(x=>({name:`a_${x}`,type:"Float32",components:f==="color"?2:1,offset:0})),this.paintVertexArray=new m}populatePaintArray(n,c,f,m,x,E){const M=this.paintVertexArray.length,I=this.expression.evaluate(new Je(0),c,{},x,m,E);this.paintVertexArray.resize(n),this._setPaintValue(M,n,I)}updatePaintArray(n,c,f,m,x){const E=this.expression.evaluate({zoom:0},f,m,void 0,x);this._setPaintValue(n,c,E)}_setPaintValue(n,c,f){if(this.type==="color"){const m=oh(f);for(let x=n;x<c;x++)this.paintVertexArray.emplace(x,m[0],m[1])}else{for(let m=n;m<c;m++)this.paintVertexArray.emplace(m,f);this.maxValue=Math.max(this.maxValue,Math.abs(f))}}upload(n){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=n.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ho{constructor(n,c,f,m,x,E){this.expression=n,this.uniformNames=c.map(M=>`u_${M}_t`),this.type=f,this.useIntegerZoom=m,this.zoom=x,this.maxValue=0,this.paintVertexAttributes=c.map(M=>({name:`a_${M}`,type:"Float32",components:f==="color"?4:2,offset:0})),this.paintVertexArray=new E}populatePaintArray(n,c,f,m,x,E){const M=this.expression.evaluate(new Je(this.zoom),c,{},x,m,E),I=this.expression.evaluate(new Je(this.zoom+1),c,{},x,m,E),P=this.paintVertexArray.length;this.paintVertexArray.resize(n),this._setPaintValue(P,n,M,I)}updatePaintArray(n,c,f,m,x){const E=this.expression.evaluate({zoom:this.zoom},f,m,void 0,x),M=this.expression.evaluate({zoom:this.zoom+1},f,m,void 0,x);this._setPaintValue(n,c,E,M)}_setPaintValue(n,c,f,m){if(this.type==="color"){const x=oh(f),E=oh(m);for(let M=n;M<c;M++)this.paintVertexArray.emplace(M,x[0],x[1],E[0],E[1])}else{for(let x=n;x<c;x++)this.paintVertexArray.emplace(x,f,m);this.maxValue=Math.max(this.maxValue,Math.abs(f),Math.abs(m))}}upload(n){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=n.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(n,c,f,m,x){const E=this.useIntegerZoom?Math.floor(f.zoom):f.zoom,M=Ge(this.expression.interpolationFactor(E,this.zoom,this.zoom+1),0,1);c.set(n,x,M)}getBinding(n,c){return new gu(n)}}class ys{constructor(n,c,f,m,x){this.expression=n,this.layerId=x,this.paintVertexAttributes=(f==="array"?Vp:Up).members;for(let E=0;E<c.length;++E);this.paintVertexArray=new m}populatePaintArray(n,c,f){const m=this.paintVertexArray.length;this.paintVertexArray.resize(n),this._setPaintValues(m,n,c.patterns&&c.patterns[this.layerId],f)}updatePaintArray(n,c,f,m,x,E){this._setPaintValues(n,c,f.patterns&&f.patterns[this.layerId],E)}_setPaintValues(n,c,f,m){if(!m||!f)return;const x=m[f];if(!x)return;const{tl:E,br:M,pixelRatio:I}=x;for(let P=n;P<c;P++)this.paintVertexArray.emplace(P,E[0],E[1],M[0],M[1],I)}upload(n){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=n.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class vs{constructor(n,c,f=()=>!0){this.binders={},this._buffers=[];const m=[];for(const x in n.paint._values){if(!f(x))continue;const E=n.paint.get(x);if(!(E instanceof zt&&On(E.property.specification)))continue;const M=Yp(x,n.type),I=E.value,P=E.property.specification.type,z=!!E.property.useIntegerZoom,N=x==="line-dasharray"||x.endsWith("pattern"),q=x==="line-dasharray"&&n.layout.get("line-cap").value.kind!=="constant";if(I.kind!=="constant"||q)if(I.kind==="source"||q||N){const K=bd(x,P,"source");this.binders[x]=N?new ys(I,M,P,K,n.id):new Va(I,M,P,K),m.push(`/a_${x}`)}else{const K=bd(x,P,"composite");this.binders[x]=new Ho(I,M,P,z,c,K),m.push(`/z_${x}`)}else this.binders[x]=N?new Il(I.value,M):new uc(I.value,M,P),m.push(`/u_${x}`)}this.cacheKey=m.sort().join("")}getMaxValue(n){const c=this.binders[n];return c instanceof Va||c instanceof Ho?c.maxValue:0}populatePaintArrays(n,c,f,m,x,E){for(const M in this.binders){const I=this.binders[M];(I instanceof Va||I instanceof Ho||I instanceof ys)&&I.populatePaintArray(n,c,f,m,x,E)}}setConstantPatternPositions(n){for(const c in this.binders){const f=this.binders[c];f instanceof Il&&f.setConstantPatternPositions(n)}}updatePaintArrays(n,c,f,m,x,E){let M=!1;for(const I in n){const P=c.getPositions(I);for(const z of P){const N=f.feature(z.index);for(const q in this.binders){const K=this.binders[q];if((K instanceof Va||K instanceof Ho||K instanceof ys)&&K.expression.isStateDependent===!0){const ee=m.paint.get(q);K.expression=ee.value,K.updatePaintArray(z.start,z.end,N,n[I],x,E),M=!0}}}}return M}defines(){const n=[];for(const c in this.binders){const f=this.binders[c];(f instanceof uc||f instanceof Il)&&n.push(...f.uniformNames.map(m=>`#define HAS_UNIFORM_${m}`))}return n}getBinderAttributes(){const n=[];for(const c in this.binders){const f=this.binders[c];if(f instanceof Va||f instanceof Ho||f instanceof ys)for(let m=0;m<f.paintVertexAttributes.length;m++)n.push(f.paintVertexAttributes[m].name)}return n}getBinderUniforms(){const n=[];for(const c in this.binders){const f=this.binders[c];if(f instanceof uc||f instanceof Il||f instanceof Ho)for(const m of f.uniformNames)n.push(m)}return n}getPaintVertexBuffers(){return this._buffers}getUniforms(n){const c=[];for(const f in this.binders){const m=this.binders[f];if(m instanceof uc||m instanceof Il||m instanceof Ho)for(const x of m.uniformNames)c.push({name:x,property:f,binding:m.getBinding(n,x)})}return c}setUniforms(n,c,f,m,x){for(const{name:E,property:M,binding:I}of f)this.binders[M].setUniform(n,I,x,m.get(M),E)}updatePaintBuffers(){this._buffers=[];for(const n in this.binders){const c=this.binders[n];(c instanceof Va||c instanceof Ho||c instanceof ys)&&c.paintVertexBuffer&&this._buffers.push(c.paintVertexBuffer)}}upload(n){for(const c in this.binders){const f=this.binders[c];(f instanceof Va||f instanceof Ho||f instanceof ys)&&f.upload(n)}this.updatePaintBuffers()}destroy(){for(const n in this.binders){const c=this.binders[n];(c instanceof Va||c instanceof Ho||c instanceof ys)&&c.destroy()}}}class Ws{constructor(n,c,f=()=>!0){this.programConfigurations={};for(const m of n)this.programConfigurations[m.id]=new vs(m,c,f);this.needsUpload=!1,this._featureMap=new pu,this._bufferOffset=0}populatePaintArrays(n,c,f,m,x,E,M){for(const I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(n,c,m,x,E,M);c.id!==void 0&&this._featureMap.add(c.id,f,this._bufferOffset,n),this._bufferOffset=n,this.needsUpload=!0}updatePaintArrays(n,c,f,m,x){for(const E of f)this.needsUpload=this.programConfigurations[E.id].updatePaintArrays(n,this._featureMap,c,E,m,x)||this.needsUpload}get(n){return this.programConfigurations[n]}upload(n){if(this.needsUpload){for(const c in this.programConfigurations)this.programConfigurations[c].upload(n);this.needsUpload=!1}}destroy(){for(const n in this.programConfigurations)this.programConfigurations[n].destroy()}}const Xp={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function Yp(l,n){return Xp[l]||[l.replace(`${n}-`,"").replace(/-/g,"_")]}const Wp={"line-pattern":{source:sn,composite:sn},"fill-pattern":{source:sn,composite:sn},"fill-extrusion-pattern":{source:sn,composite:sn},"line-dasharray":{source:Un,composite:Un}},Kp={color:{source:_s,composite:Ar},number:{source:Kn,composite:_s}};function bd(l,n,c){const f=Wp[l];return f&&f[c]||Kp[n][c]}Ti(uc,"ConstantBinder"),Ti(Il,"PatternConstantBinder"),Ti(Va,"SourceExpressionBinder"),Ti(ys,"PatternCompositeBinder"),Ti(Ho,"CompositeExpressionBinder"),Ti(vs,"ProgramConfiguration",{omit:["_buffers"]}),Ti(Ws,"ProgramConfigurationSet");const _u="-transition";class Xo extends dr{constructor(n,c){if(super(),this.id=n.id,this.type=n.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,n.type!=="custom"&&(this.metadata=n.metadata,this.minzoom=n.minzoom,this.maxzoom=n.maxzoom,n.type!=="background"&&n.type!=="sky"&&(this.source=n.source,this.sourceLayer=n["source-layer"],this.filter=n.filter),c.layout&&(this._unevaluatedLayout=new gt(c.layout)),c.paint)){this._transitionablePaint=new Jt(c.paint);for(const f in n.paint)this.setPaintProperty(f,n.paint[f],{validate:!1});for(const f in n.layout)this.setLayoutProperty(f,n.layout[f],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new at(c.paint)}}getLayoutProperty(n){return n==="visibility"?this.visibility:this._unevaluatedLayout.getValue(n)}setLayoutProperty(n,c,f={}){c!=null&&this._validate(eu,`layers.${this.id}.layout.${n}`,n,c,f)||(n!=="visibility"?this._unevaluatedLayout.setValue(n,c):this.visibility=c)}getPaintProperty(n){return yt(n,_u)?this._transitionablePaint.getTransition(n.slice(0,-_u.length)):this._transitionablePaint.getValue(n)}setPaintProperty(n,c,f={}){if(c!=null&&this._validate(eh,`layers.${this.id}.paint.${n}`,n,c,f))return!1;if(yt(n,_u))return this._transitionablePaint.setTransition(n.slice(0,-_u.length),c||void 0),!1;{const m=this._transitionablePaint._values[n],x=m.value.isDataDriven(),E=m.value;this._transitionablePaint.setValue(n,c),this._handleSpecialPaintPropertyUpdate(n);const M=this._transitionablePaint._values[n].value,I=M.isDataDriven(),P=yt(n,"pattern")||n==="line-dasharray";return I||x||P||this._handleOverridablePaintPropertyUpdate(n,E,M)}}_handleSpecialPaintPropertyUpdate(n){}getProgramIds(){return null}getProgramConfiguration(n){return null}_handleOverridablePaintPropertyUpdate(n,c,f){return!1}isHidden(n){return!!(this.minzoom&&n<this.minzoom)||!!(this.maxzoom&&n>=this.maxzoom)||this.visibility==="none"}updateTransitions(n){this._transitioningPaint=this._transitionablePaint.transitioned(n,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(n,c){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(n,void 0,c)),this.paint=this._transitioningPaint.possiblyEvaluate(n,void 0,c)}serialize(){const n={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(n.layout=n.layout||{},n.layout.visibility=this.visibility),_t(n,(c,f)=>!(c===void 0||f==="layout"&&!Object.keys(c).length||f==="paint"&&!Object.keys(c).length))}_validate(n,c,f,m,x={}){return(!x||x.validate!==!1)&&tu(this,n.call(Jc,{key:c,layerType:this.type,objectKey:f,value:m,styleSpec:ot,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const n in this.paint._values){const c=this.paint.get(n);if(c instanceof zt&&On(c.property.specification)&&(c.value.kind==="source"||c.value.kind==="composite")&&c.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=yl(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const Qp=Oi([{name:"a_pos",components:2,type:"Int16"}],4),Jp=Oi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class ln{constructor(n=[]){this.segments=n}prepareSegment(n,c,f,m){let x=this.segments[this.segments.length-1];return n>ln.MAX_VERTEX_ARRAY_LENGTH&&vi(`Max vertices per segment is ${ln.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${n}`),(!x||x.vertexLength+n>ln.MAX_VERTEX_ARRAY_LENGTH||x.sortKey!==m)&&(x={vertexOffset:c.length,primitiveOffset:f.length,vertexLength:0,primitiveLength:0},m!==void 0&&(x.sortKey=m),this.segments.push(x)),x}get(){return this.segments}destroy(){for(const n of this.segments)for(const c in n.vaos)n.vaos[c].destroy()}static simpleSegment(n,c,f,m){return new ln([{vertexOffset:n,primitiveOffset:c,vertexLength:f,primitiveLength:m,vaos:{},sortKey:0}])}}ln.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ti(ln,"SegmentVector");var Zi=8192;class xs{constructor(n,c){n&&(c?this.setSouthWest(n).setNorthEast(c):n.length===4?this.setSouthWest([n[0],n[1]]).setNorthEast([n[2],n[3]]):this.setSouthWest(n[0]).setNorthEast(n[1]))}setNorthEast(n){return this._ne=n instanceof pr?new pr(n.lng,n.lat):pr.convert(n),this}setSouthWest(n){return this._sw=n instanceof pr?new pr(n.lng,n.lat):pr.convert(n),this}extend(n){const c=this._sw,f=this._ne;let m,x;if(n instanceof pr)m=n,x=n;else{if(!(n instanceof xs))return Array.isArray(n)?n.length===4||n.every(Array.isArray)?this.extend(xs.convert(n)):this.extend(pr.convert(n)):typeof n=="object"&&n!==null&&n.hasOwnProperty("lat")&&(n.hasOwnProperty("lon")||n.hasOwnProperty("lng"))?this.extend(pr.convert(n)):this;if(m=n._sw,x=n._ne,!m||!x)return this}return c||f?(c.lng=Math.min(m.lng,c.lng),c.lat=Math.min(m.lat,c.lat),f.lng=Math.max(x.lng,f.lng),f.lat=Math.max(x.lat,f.lat)):(this._sw=new pr(m.lng,m.lat),this._ne=new pr(x.lng,x.lat)),this}getCenter(){return new pr((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new pr(this.getWest(),this.getNorth())}getSouthEast(){return new pr(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(n){const{lng:c,lat:f}=pr.convert(n);let m=this._sw.lng<=c&&c<=this._ne.lng;return this._sw.lng>this._ne.lng&&(m=this._sw.lng>=c&&c>=this._ne.lng),this._sw.lat<=f&&f<=this._ne.lat&&m}static convert(n){return!n||n instanceof xs?n:new xs(n)}}var yu=1e-6,no=typeof Float32Array<"u"?Float32Array:Array;function wd(){var l=new no(9);return no!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[5]=0,l[6]=0,l[7]=0),l[0]=1,l[4]=1,l[8]=1,l}function Ed(l,n,c){var f=n[0],m=n[1],x=n[2],E=n[3],M=n[4],I=n[5],P=n[6],z=n[7],N=n[8],q=c[0],K=c[1],ee=c[2],oe=c[3],pe=c[4],Ee=c[5],Re=c[6],be=c[7],De=c[8];return l[0]=q*f+K*E+ee*P,l[1]=q*m+K*M+ee*z,l[2]=q*x+K*I+ee*N,l[3]=oe*f+pe*E+Ee*P,l[4]=oe*m+pe*M+Ee*z,l[5]=oe*x+pe*I+Ee*N,l[6]=Re*f+be*E+De*P,l[7]=Re*m+be*M+De*z,l[8]=Re*x+be*I+De*N,l}function Yo(l){return l[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function ah(l,n){var c=n[0],f=n[1],m=n[2],x=n[3],E=n[4],M=n[5],I=n[6],P=n[7],z=n[8],N=n[9],q=n[10],K=n[11],ee=n[12],oe=n[13],pe=n[14],Ee=n[15],Re=c*M-f*E,be=c*I-m*E,De=c*P-x*E,ze=f*I-m*M,Le=f*P-x*M,st=m*P-x*I,it=z*oe-N*ee,wt=z*pe-q*ee,Gt=z*Ee-K*ee,ft=N*pe-q*oe,kt=N*Ee-K*oe,Rt=q*Ee-K*pe,Ft=Re*Rt-be*kt+De*ft+ze*Gt-Le*wt+st*it;return Ft?(l[0]=(M*Rt-I*kt+P*ft)*(Ft=1/Ft),l[1]=(m*kt-f*Rt-x*ft)*Ft,l[2]=(oe*st-pe*Le+Ee*ze)*Ft,l[3]=(q*Le-N*st-K*ze)*Ft,l[4]=(I*Gt-E*Rt-P*wt)*Ft,l[5]=(c*Rt-m*Gt+x*wt)*Ft,l[6]=(pe*De-ee*st-Ee*be)*Ft,l[7]=(z*st-q*De+K*be)*Ft,l[8]=(E*kt-M*Gt+P*it)*Ft,l[9]=(f*Gt-c*kt-x*it)*Ft,l[10]=(ee*Le-oe*De+Ee*Re)*Ft,l[11]=(N*De-z*Le-K*Re)*Ft,l[12]=(M*wt-E*ft-I*it)*Ft,l[13]=(c*ft-f*wt+m*it)*Ft,l[14]=(oe*be-ee*ze-pe*Re)*Ft,l[15]=(z*ze-N*be+q*Re)*Ft,l):null}function Ks(l,n,c){var f=n[0],m=n[1],x=n[2],E=n[3],M=n[4],I=n[5],P=n[6],z=n[7],N=n[8],q=n[9],K=n[10],ee=n[11],oe=n[12],pe=n[13],Ee=n[14],Re=n[15],be=c[0],De=c[1],ze=c[2],Le=c[3];return l[0]=be*f+De*M+ze*N+Le*oe,l[1]=be*m+De*I+ze*q+Le*pe,l[2]=be*x+De*P+ze*K+Le*Ee,l[3]=be*E+De*z+ze*ee+Le*Re,l[4]=(be=c[4])*f+(De=c[5])*M+(ze=c[6])*N+(Le=c[7])*oe,l[5]=be*m+De*I+ze*q+Le*pe,l[6]=be*x+De*P+ze*K+Le*Ee,l[7]=be*E+De*z+ze*ee+Le*Re,l[8]=(be=c[8])*f+(De=c[9])*M+(ze=c[10])*N+(Le=c[11])*oe,l[9]=be*m+De*I+ze*q+Le*pe,l[10]=be*x+De*P+ze*K+Le*Ee,l[11]=be*E+De*z+ze*ee+Le*Re,l[12]=(be=c[12])*f+(De=c[13])*M+(ze=c[14])*N+(Le=c[15])*oe,l[13]=be*m+De*I+ze*q+Le*pe,l[14]=be*x+De*P+ze*K+Le*Ee,l[15]=be*E+De*z+ze*ee+Le*Re,l}function hc(l,n,c){var f,m,x,E,M,I,P,z,N,q,K,ee,oe=c[0],pe=c[1],Ee=c[2];return n===l?(l[12]=n[0]*oe+n[4]*pe+n[8]*Ee+n[12],l[13]=n[1]*oe+n[5]*pe+n[9]*Ee+n[13],l[14]=n[2]*oe+n[6]*pe+n[10]*Ee+n[14],l[15]=n[3]*oe+n[7]*pe+n[11]*Ee+n[15]):(m=n[1],x=n[2],E=n[3],M=n[4],I=n[5],P=n[6],z=n[7],N=n[8],q=n[9],K=n[10],ee=n[11],l[0]=f=n[0],l[1]=m,l[2]=x,l[3]=E,l[4]=M,l[5]=I,l[6]=P,l[7]=z,l[8]=N,l[9]=q,l[10]=K,l[11]=ee,l[12]=f*oe+M*pe+N*Ee+n[12],l[13]=m*oe+I*pe+q*Ee+n[13],l[14]=x*oe+P*pe+K*Ee+n[14],l[15]=E*oe+z*pe+ee*Ee+n[15]),l}function Qs(l,n,c){var f=c[0],m=c[1],x=c[2];return l[0]=n[0]*f,l[1]=n[1]*f,l[2]=n[2]*f,l[3]=n[3]*f,l[4]=n[4]*m,l[5]=n[5]*m,l[6]=n[6]*m,l[7]=n[7]*m,l[8]=n[8]*x,l[9]=n[9]*x,l[10]=n[10]*x,l[11]=n[11]*x,l[12]=n[12],l[13]=n[13],l[14]=n[14],l[15]=n[15],l}function sh(l,n,c){var f=Math.sin(c),m=Math.cos(c),x=n[4],E=n[5],M=n[6],I=n[7],P=n[8],z=n[9],N=n[10],q=n[11];return n!==l&&(l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],l[12]=n[12],l[13]=n[13],l[14]=n[14],l[15]=n[15]),l[4]=x*m+P*f,l[5]=E*m+z*f,l[6]=M*m+N*f,l[7]=I*m+q*f,l[8]=P*m-x*f,l[9]=z*m-E*f,l[10]=N*m-M*f,l[11]=q*m-I*f,l}function vu(l,n,c){var f=Math.sin(c),m=Math.cos(c),x=n[0],E=n[1],M=n[2],I=n[3],P=n[8],z=n[9],N=n[10],q=n[11];return n!==l&&(l[4]=n[4],l[5]=n[5],l[6]=n[6],l[7]=n[7],l[12]=n[12],l[13]=n[13],l[14]=n[14],l[15]=n[15]),l[0]=x*m-P*f,l[1]=E*m-z*f,l[2]=M*m-N*f,l[3]=I*m-q*f,l[8]=x*f+P*m,l[9]=E*f+z*m,l[10]=M*f+N*m,l[11]=I*f+q*m,l}function Td(l,n){return l[0]=n[0],l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=n[1],l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=n[2],l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function Sd(l,n,c){var f,m,x,E=c[0],M=c[1],I=c[2],P=Math.hypot(E,M,I);return P<yu?null:(E*=P=1/P,M*=P,I*=P,f=Math.sin(n),m=Math.cos(n),l[0]=E*E*(x=1-m)+m,l[1]=M*E*x+I*f,l[2]=I*E*x-M*f,l[3]=0,l[4]=E*M*x-I*f,l[5]=M*M*x+m,l[6]=I*M*x+E*f,l[7]=0,l[8]=E*I*x+M*f,l[9]=M*I*x-E*f,l[10]=I*I*x+m,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l)}Math.hypot||(Math.hypot=function(){for(var l=0,n=arguments.length;n--;)l+=arguments[n]*arguments[n];return Math.sqrt(l)});var em=Ks;function lh(){var l=new no(3);return no!=Float32Array&&(l[0]=0,l[1]=0,l[2]=0),l}function Md(l){var n=new no(3);return n[0]=l[0],n[1]=l[1],n[2]=l[2],n}function dc(l){return Math.hypot(l[0],l[1],l[2])}function kl(l,n,c){var f=new no(3);return f[0]=l,f[1]=n,f[2]=c,f}function ja(l,n,c){return l[0]=n[0]+c[0],l[1]=n[1]+c[1],l[2]=n[2]+c[2],l}function ch(l,n,c){return l[0]=n[0]-c[0],l[1]=n[1]-c[1],l[2]=n[2]-c[2],l}function Ad(l,n,c){return l[0]=n[0]*c[0],l[1]=n[1]*c[1],l[2]=n[2]*c[2],l}function fc(l,n,c){return l[0]=Math.min(n[0],c[0]),l[1]=Math.min(n[1],c[1]),l[2]=Math.min(n[2],c[2]),l}function pc(l,n,c){return l[0]=Math.max(n[0],c[0]),l[1]=Math.max(n[1],c[1]),l[2]=Math.max(n[2],c[2]),l}function _o(l,n,c){return l[0]=n[0]*c,l[1]=n[1]*c,l[2]=n[2]*c,l}function mc(l,n,c,f){return l[0]=n[0]+c[0]*f,l[1]=n[1]+c[1]*f,l[2]=n[2]+c[2]*f,l}function Vn(l,n){var c=n[0],f=n[1],m=n[2],x=c*c+f*f+m*m;return x>0&&(x=1/Math.sqrt(x)),l[0]=n[0]*x,l[1]=n[1]*x,l[2]=n[2]*x,l}function Ao(l,n){return l[0]*n[0]+l[1]*n[1]+l[2]*n[2]}function uh(l,n,c){var f=n[0],m=n[1],x=n[2],E=c[0],M=c[1],I=c[2];return l[0]=m*I-x*M,l[1]=x*E-f*I,l[2]=f*M-m*E,l}function tn(l,n,c){var f=n[0],m=n[1],x=n[2],E=c[3]*f+c[7]*m+c[11]*x+c[15];return l[0]=(c[0]*f+c[4]*m+c[8]*x+c[12])/(E=E||1),l[1]=(c[1]*f+c[5]*m+c[9]*x+c[13])/E,l[2]=(c[2]*f+c[6]*m+c[10]*x+c[14])/E,l}function Cd(l,n,c){var f=c[0],m=c[1],x=c[2],E=n[0],M=n[1],I=n[2],P=m*I-x*M,z=x*E-f*I,N=f*M-m*E,q=m*N-x*z,K=x*P-f*N,ee=f*z-m*P,oe=2*c[3];return z*=oe,N*=oe,K*=2,ee*=2,l[0]=E+(P*=oe)+(q*=2),l[1]=M+z+K,l[2]=I+N+ee,l}var gc,Wo=ch,tm=Ad,im=dc;function Id(l,n,c){return l[0]=n[0]*c,l[1]=n[1]*c,l[2]=n[2]*c,l[3]=n[3]*c,l}function kd(l,n){var c=n[0],f=n[1],m=n[2],x=n[3],E=c*c+f*f+m*m+x*x;return E>0&&(E=1/Math.sqrt(E)),l[0]=c*E,l[1]=f*E,l[2]=m*E,l[3]=x*E,l}function Js(l,n,c){var f=n[0],m=n[1],x=n[2],E=n[3];return l[0]=c[0]*f+c[4]*m+c[8]*x+c[12]*E,l[1]=c[1]*f+c[5]*m+c[9]*x+c[13]*E,l[2]=c[2]*f+c[6]*m+c[10]*x+c[14]*E,l[3]=c[3]*f+c[7]*m+c[11]*x+c[15]*E,l}function Dd(){var l=new no(4);return no!=Float32Array&&(l[0]=0,l[1]=0,l[2]=0),l[3]=1,l}function Rd(l){return l[0]=0,l[1]=0,l[2]=0,l[3]=1,l}function Pd(l,n,c){c*=.5;var f=n[0],m=n[1],x=n[2],E=n[3],M=Math.sin(c),I=Math.cos(c);return l[0]=f*I+E*M,l[1]=m*I+x*M,l[2]=x*I-m*M,l[3]=E*I-f*M,l}function Ld(l,n,c){c*=.5;var f=n[0],m=n[1],x=n[2],E=n[3],M=Math.sin(c),I=Math.cos(c);return l[0]=f*I-x*M,l[1]=m*I+E*M,l[2]=x*I+f*M,l[3]=E*I-m*M,l}lh(),gc=new no(4),no!=Float32Array&&(gc[0]=0,gc[1]=0,gc[2]=0,gc[3]=0);var rm=kd;lh(),kl(1,0,0),kl(0,1,0),Dd(),Dd(),wd();const nm=Oi([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:$d}=nm,Bd=Oi([{name:"a_pos_3",components:3,type:"Int16"}]);var _c=Oi([{name:"a_pos",type:"Int16",components:2}]);class hh{constructor(n,c){this.pos=n,this.dir=c}intersectsPlane(n,c,f){const m=Ao(c,this.dir);if(Math.abs(m)<1e-6)return!1;const x=((n[0]-this.pos[0])*c[0]+(n[1]-this.pos[1])*c[1]+(n[2]-this.pos[2])*c[2])/m;return f[0]=this.pos[0]+this.dir[0]*x,f[1]=this.pos[1]+this.dir[1]*x,f[2]=this.pos[2]+this.dir[2]*x,!0}closestPointOnSphere(n,c,f){if(function(K,ee){var oe=K[0],pe=K[1],Ee=K[2],Re=ee[0],be=ee[1],De=ee[2];return Math.abs(oe-Re)<=yu*Math.max(1,Math.abs(oe),Math.abs(Re))&&Math.abs(pe-be)<=yu*Math.max(1,Math.abs(pe),Math.abs(be))&&Math.abs(Ee-De)<=yu*Math.max(1,Math.abs(Ee),Math.abs(De))}(this.pos,n)||c===0)return f[0]=f[1]=f[2]=0,!1;const[m,x,E]=this.dir,M=this.pos[0]-n[0],I=this.pos[1]-n[1],P=this.pos[2]-n[2],z=m*m+x*x+E*E,N=2*(M*m+I*x+P*E),q=N*N-4*z*(M*M+I*I+P*P-c*c);if(q<0){const K=Math.max(-N/2,0),ee=M+m*K,oe=I+x*K,pe=P+E*K,Ee=Math.hypot(ee,oe,pe);return f[0]=ee*c/Ee,f[1]=oe*c/Ee,f[2]=pe*c/Ee,!1}{const K=(-N-Math.sqrt(q))/(2*z);if(K<0){const ee=Math.hypot(M,I,P);return f[0]=M*c/ee,f[1]=I*c/ee,f[2]=P*c/ee,!1}return f[0]=M+m*K,f[1]=I+x*K,f[2]=P+E*K,!0}}}class dh{constructor(n,c,f,m,x){this.TL=n,this.TR=c,this.BR=f,this.BL=m,this.horizon=x}static fromInvProjectionMatrix(n,c,f){const m=[-1,1,1],x=[1,1,1],E=[1,-1,1],M=[-1,-1,1],I=tn(m,m,n),P=tn(x,x,n),z=tn(E,E,n),N=tn(M,M,n);return new dh(I,P,z,N,c/f)}}class fh{constructor(n,c){this.points=n,this.planes=c}static fromInvProjectionMatrix(n,c,f,m){const x=Math.pow(2,f),E=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(I=>{const P=Js([],I,n),z=1/P[3]/c*x;return function(N,q,K){return N[0]=q[0]*K[0],N[1]=q[1]*K[1],N[2]=q[2]*K[2],N[3]=q[3]*K[3],N}(P,P,[z,z,m?1/P[3]:z,z])}),M=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(I=>{const P=Vn([],uh([],Wo([],E[I[0]],E[I[1]]),Wo([],E[I[2]],E[I[1]]))),z=-Ao(P,E[I[1]]);return P.concat(z)});return new fh(E,M)}}class jn{static fromPoints(n){const c=[1/0,1/0,1/0],f=[-1/0,-1/0,-1/0];for(const m of n)fc(c,c,m),pc(f,f,m);return new jn(c,f)}static applyTransform(n,c){const f=n.getCorners();for(let m=0;m<f.length;++m)tn(f[m],f[m],c);return jn.fromPoints(f)}constructor(n,c){this.min=n,this.max=c,this.center=_o([],ja([],this.min,this.max),.5)}quadrant(n){const c=[n%2==0,n<2],f=Md(this.min),m=Md(this.max);for(let x=0;x<c.length;x++)f[x]=c[x]?this.min[x]:this.center[x],m[x]=c[x]?this.center[x]:this.max[x];return m[2]=this.max[2],new jn(f,m)}distanceX(n){return Math.max(Math.min(this.max[0],n[0]),this.min[0])-n[0]}distanceY(n){return Math.max(Math.min(this.max[1],n[1]),this.min[1])-n[1]}distanceZ(n){return Math.max(Math.min(this.max[2],n[2]),this.min[2])-n[2]}getCorners(){const n=this.min,c=this.max;return[[n[0],n[1],n[2]],[c[0],n[1],n[2]],[c[0],c[1],n[2]],[n[0],c[1],n[2]],[n[0],n[1],c[2]],[c[0],n[1],c[2]],[c[0],c[1],c[2]],[n[0],c[1],c[2]]]}intersects(n){const c=this.getCorners();let f=!0;for(let m=0;m<n.planes.length;m++){const x=n.planes[m];let E=0;for(let M=0;M<c.length;M++)E+=Ao(x,c[M])+x[3]>=0;if(E===0)return 0;E!==c.length&&(f=!1)}if(f)return 2;for(let m=0;m<3;m++){let x=Number.MAX_VALUE,E=-Number.MAX_VALUE;for(let M=0;M<n.points.length;M++){const I=n.points[M][m]-this.min[m];x=Math.min(x,I),E=Math.max(E,I)}if(E<0||x>this.max[m]-this.min[m])return 0}return 1}}const fa=Zi/Math.PI/2,el=64,yc=[el,32,16],Co=-fa,Io=fa,om=[new jn([Co,Co,Co],[Io,Io,Io]),new jn([Co,Co,Co],[0,0,Io]),new jn([0,Co,Co],[Io,0,Io]),new jn([Co,0,Co],[0,Io,Io]),new jn([0,0,Co],[Io,Io,Io])];function xu(l){return l*fa/bc}function Od(l,n,c,f=!0){const m=_o([],l._camera.position,l.worldSize),x=[n,c,1,1];Js(x,x,l.pixelMatrixInverse),Id(x,x,1/x[3]);const E=Vn([],Wo([],x,m)),M=l.globeMatrix,I=[M[12],M[13],M[14]],P=Wo([],I,m),z=dc(P),N=Vn([],P),q=l.worldSize/(2*Math.PI),K=Ao(N,E),ee=Math.asin(q/z);if(ee<Math.acos(K)){if(!f)return null;const Gt=[],ft=[];_o(Gt,E,z/K),Vn(ft,Wo(ft,Gt,P)),Vn(E,ja(E,P,_o(E,ft,Math.tan(ee)*z)))}const oe=[];new hh(m,E).closestPointOnSphere(I,q,oe);const pe=Vn([],ei(M,0)),Ee=Vn([],ei(M,1)),Re=Vn([],ei(M,2)),be=Ao(pe,oe),De=Ao(Ee,oe),ze=Ao(Re,oe),Le=J(Math.asin(-De/q));let st=J(Math.atan2(be,ze));st=l.center.lng+function(Gt,ft){const kt=(ft-Gt+180)%360-180;return kt<-180?kt+360:kt}(l.center.lng,st);const it=ma(st),wt=Ge(ga(Le),0,1);return new Ll(it,wt)}class am{constructor(n,c,f){this.a=Wo([],n,f),this.b=Wo([],c,f),this.center=f;const m=Vn([],this.a),x=Vn([],this.b);this.angle=Math.acos(Ao(m,x))}}function ph(l,n){if(l.angle===0)return null;let c;return c=l.a[n]===0?1/l.angle*.5*Math.PI:1/l.angle*Math.atan(l.b[n]/l.a[n]/Math.sin(l.angle)-1/Math.tan(l.angle)),c<0||c>1?null:function(f,m,x,E){const M=Math.sin(x);return f*(Math.sin((1-E)*x)/M)+m*(Math.sin(E*x)/M)}(l.a[n],l.b[n],l.angle,Ge(c,0,1))+l.center[n]}function pa(l){if(l.z<=1)return om[l.z+2*l.y+l.x];const n=mh(bu(l));return jn.fromPoints(n)}function tl(l,n,c){return _o(l,l,1-c),mc(l,l,n,c)}function zd(l,n){const c=Pl(n.zoom);if(c===0)return pa(l);const f=bu(l),m=mh(f),x=ma(f.getWest())*n.worldSize,E=ma(f.getEast())*n.worldSize,M=ga(f.getNorth())*n.worldSize,I=ga(f.getSouth())*n.worldSize,P=[x,M,0],z=[E,M,0],N=[x,I,0],q=[E,I,0],K=ah([],n.globeMatrix);return tn(P,P,K),tn(z,z,K),tn(N,N,K),tn(q,q,K),m[0]=tl(m[0],N,c),m[1]=tl(m[1],q,c),m[2]=tl(m[2],z,c),m[3]=tl(m[3],P,c),jn.fromPoints(m)}function Fd(l,n,c){for(const f of l)tn(f,f,n),_o(f,f,c)}function sm(l,n,c){const f=n/l.worldSize,m=l.globeMatrix;if(c.z<=1){const it=pa(c).getCorners();return Fd(it,m,f),jn.fromPoints(it)}const x=bu(c),E=mh(x);Fd(E,m,f);const M=Number.MAX_VALUE,I=[-M,-M,-M],P=[M,M,M];if(x.contains(l.center)){for(const Gt of E)fc(P,P,Gt),pc(I,I,Gt);I[2]=0;const it=l.point,wt=[it.x*f,it.y*f,0];return fc(P,P,wt),pc(I,I,wt),new jn(P,I)}const z=[m[12]*f,m[13]*f,m[14]*f],N=x.getCenter(),q=Ge(l.center.lat,-Pn,Pn),K=Ge(N.lat,-Pn,Pn),ee=ma(l.center.lng),oe=ga(q);let pe=ee-ma(N.lng);const Ee=oe-ga(K);pe>.5?pe-=1:pe<-.5&&(pe+=1);let Re=0;Math.abs(pe)>Math.abs(Ee)?Re=pe>=0?1:3:(Re=Ee>=0?0:2,mc(z,z,[m[4]*f,m[5]*f,m[6]*f],-Math.sin(ae(Ee>=0?x.getSouth():x.getNorth()))*fa));const be=E[Re],De=E[(Re+1)%4],ze=new am(be,De,z),Le=[ph(ze,0)||be[0],ph(ze,1)||be[1],ph(ze,2)||be[2]],st=Pl(l.zoom);if(st>0){const it=function({x:Gt,y:ft,z:kt},Rt,Ft,Zt,pt){const oi=1/(1<<kt);let Vi=Gt*oi,pi=Vi+oi,ki=ft*oi,ai=ki+oi,qi=0;const sr=(Vi+pi)/2-Zt;return sr>.5?qi=-1:sr<-.5&&(qi=1),Vi=((Vi+qi)*Rt-(Zt*=Rt))*Ft+Zt,pi=((pi+qi)*Rt-Zt)*Ft+Zt,ki=(ki*Rt-(pt*=Rt))*Ft+pt,ai=(ai*Rt-pt)*Ft+pt,[[Vi,ai,0],[pi,ai,0],[pi,ki,0],[Vi,ki,0]]}(c,n,l._pixelsPerMercatorPixel,ee,oe);for(let Gt=0;Gt<E.length;Gt++)tl(E[Gt],it[Gt],st);const wt=ja([],it[Re],it[(Re+1)%4]);_o(wt,wt,.5),tl(Le,wt,st)}for(const it of E)fc(P,P,it),pc(I,I,it);return P[2]=Math.min(be[2],De[2]),fc(P,P,Le),pc(I,I,Le),new jn(P,I)}function bu({x:l,y:n,z:c}){const f=1/(1<<c),m=new pr(yo(l*f),Rn((n+1)*f)),x=new pr(yo((l+1)*f),Rn(n*f));return new xs(m,x)}function mh(l){const n=ae(l.getNorth()),c=ae(l.getSouth()),f=Math.cos(n),m=Math.cos(c),x=Math.sin(n),E=Math.sin(c),M=l.getWest(),I=l.getEast();return[Dl(m,E,M),Dl(m,E,I),Dl(f,x,I),Dl(f,x,M)]}function Dl(l,n,c,f=fa){return c=ae(c),[l*Math.sin(c)*f,-n*f,l*Math.cos(c)*f]}function Rl(l,n,c){return Dl(Math.cos(ae(l)),Math.sin(ae(l)),n,c)}function vc(l,n,c,f){const m=1<<c.z,x=(l/Zi+c.x)/m;return Rl(Rn((n/Zi+c.y)/m),yo(x),f)}function wu({min:l,max:n}){return 16383/Math.max(n[0]-l[0],n[1]-l[1],n[2]-l[2])}const Nd=new Float64Array(16);function xc(l){const n=wu(l),c=Td(Nd,[n,n,n]);return hc(c,c,((f=[])[0]=-(m=l.min)[0],f[1]=-m[1],f[2]=-m[2],f));var f,m}function gh(l){const n=(f=l.min,(c=Nd)[0]=1,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=1,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=f[0],c[13]=f[1],c[14]=f[2],c[15]=1,c);var c,f;const m=1/wu(l);return Qs(n,n,[m,m,m])}function Ud(l,n,c,f,m){const x=function(I){const P=Zi/(2*Math.PI);return I/(2*Math.PI)/P}(c),E=[l,n,-c/(2*Math.PI)],M=Yo(new Float64Array(16));return hc(M,M,E),Qs(M,M,[x,x,x]),sh(M,M,ae(-m)),vu(M,M,ae(-f)),M}function Pl(l){return qt(5,6,l)}function Vd(l,n){const c=Rl(n.lat,n.lng),f=function(ee){const oe=Rl(ee._center.lat,ee._center.lng);let pe=uh([],kl(0,1,0),oe);const Ee=Sd([],-ee.angle,oe);pe=tn(pe,pe,Ee),Sd(Ee,-ee._pitch,pe);const Re=Vn([],oe);return _o(Re,Re,xu(ee.cameraToCenterDistance/ee.pixelsPerMeter)),tn(Re,Re,Ee),ja([],oe,Re)}(l);return E=(m=ch([],f,c))[0],M=m[1],I=m[2],P=(x=c)[0],z=x[1],N=x[2],K=(q=Math.sqrt(E*E+M*M+I*I)*Math.sqrt(P*P+z*z+N*N))&&Ao(m,x)/q,Math.acos(Math.min(Math.max(K,-1),1));var m,x,E,M,I,P,z,N,q,K}function _h(l,n){return Vd(l,n)>Math.PI/2*1.01}const jd=ae(85),lm=Math.cos(jd),cm=Math.sin(jd),bc=63710088e-1,qd=2*Math.PI*bc;class pr{constructor(n,c){if(isNaN(n)||isNaN(c))throw new Error(`Invalid LngLat object: (${n}, ${c})`);if(this.lng=+n,this.lat=+c,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new pr(ti(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(n){const c=Math.PI/180,f=this.lat*c,m=n.lat*c,x=Math.sin(f)*Math.sin(m)+Math.cos(f)*Math.cos(m)*Math.cos((n.lng-this.lng)*c);return bc*Math.acos(Math.min(x,1))}toBounds(n=0){const c=360*n/40075017,f=c/Math.cos(Math.PI/180*this.lat);return new xs(new pr(this.lng-f,this.lat-c),new pr(this.lng+f,this.lat+c))}toEcef(n){const c=xu(n);return Rl(this.lat,this.lng,fa+c)}static convert(n){if(n instanceof pr)return n;if(Array.isArray(n)&&(n.length===2||n.length===3))return new pr(Number(n[0]),Number(n[1]));if(!Array.isArray(n)&&typeof n=="object"&&n!==null)return new pr(Number("lng"in n?n.lng:n.lon),Number(n.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}function yh(l){return qd*Math.cos(l*Math.PI/180)}function ma(l){return(180+l)/360}function ga(l){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+l*Math.PI/360)))/360}function Ko(l,n){return l/yh(n)}function yo(l){return 360*l-180}function Rn(l){return 360/Math.PI*Math.atan(Math.exp((180-360*l)*Math.PI/180))-90}function Gd(l,n){return l*yh(Rn(n))}const Pn=85.051129;function Zd(l){return 1/Math.cos(l*Math.PI/180)}class Ll{constructor(n,c,f=0){this.x=+n,this.y=+c,this.z=+f}static fromLngLat(n,c=0){const f=pr.convert(n);return new Ll(ma(f.lng),ga(f.lat),Ko(c,f.lat))}toLngLat(){return new pr(yo(this.x),Rn(this.y))}toAltitude(){return Gd(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/qd*Zd(Rn(this.y))}}function vh(l,n,c,f,m,x,E,M,I){const P=(n+f)/2,z=(c+m)/2,N=new W(P,z);M(N),function(q,K,ee,oe,pe,Ee){const Re=ee-pe,be=oe-Ee;return Math.abs((oe-K)*Re-(ee-q)*be)/Math.hypot(Re,be)}(N.x,N.y,x.x,x.y,E.x,E.y)>=I?(vh(l,n,c,P,z,x,N,M,I),vh(l,P,z,f,m,N,E,M,I)):l.push(E)}function Hd(l,n,c){let f=l[0],m=f.x,x=f.y;n(f);const E=[f];for(let M=1;M<l.length;M++){const I=l[M],{x:P,y:z}=I;n(I),vh(E,m,x,P,z,f,I,n,c),m=P,x=z,f=I}return E}function xh(l,n,c,f){if(f(n,c)){const m=n.add(c)._mult(.5);xh(l,n,m,f),xh(l,m,c,f)}else l.push(c)}function um(l,n){let c=l[0];const f=[c];for(let m=1;m<l.length;m++){const x=l[m];xh(f,c,x,n),c=x}return f}const bh=Math.pow(2,14)-1,Xd=-bh-1;function hm(l,n){const c=Math.round(l.x*n),f=Math.round(l.y*n);return l.x=Ge(c,Xd,bh),l.y=Ge(f,Xd,bh),(c<l.x||c>l.x+1||f<l.y||f>l.y+1)&&vi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),l}function qa(l,n,c){const f=l.loadGeometry(),m=l.extent,x=Zi/m;if(n&&c&&c.projection.isReprojectedInTileSpace){const E=1<<n.z,{scale:M,x:I,y:P,projection:z}=c,N=q=>{const K=yo((n.x+q.x/m)/E),ee=Rn((n.y+q.y/m)/E),oe=z.project(K,ee);q.x=(oe.x*M-I)*m,q.y=(oe.y*M-P)*m};for(let q=0;q<f.length;q++)if(l.type!==1)f[q]=Hd(f[q],N,1);else{const K=[];for(const ee of f[q])ee.x<0||ee.x>=m||ee.y<0||ee.y>=m||(N(ee),K.push(ee));f[q]=K}}for(const E of f)for(const M of E)hm(M,x);return f}function il(l,n){return{type:l.type,id:l.id,properties:l.properties,geometry:n?qa(l):[]}}function Eu(l,n,c,f,m){l.emplaceBack(2*n+(f+1)/2,2*c+(m+1)/2)}function Tu(l,n,c){l.emplaceBack(n.x,n.y,n.z,c[0]*16384,c[1]*16384,c[2]*16384)}class wh{constructor(n){this.zoom=n.zoom,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(c=>c.id),this.index=n.index,this.hasPattern=!1,this.projection=n.projection,this.layoutVertexArray=new Ui,this.indexArray=new Dn,this.segments=new ln,this.programConfigurations=new Ws(n.layers,n.zoom),this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(n,c,f,m){const x=this.layers[0],E=[];let M=null;x.type==="circle"&&(M=x.layout.get("circle-sort-key"));for(const{feature:P,id:z,index:N,sourceLayerIndex:q}of n){const K=this.layers[0]._featureFilter.needGeometry,ee=il(P,K);if(!this.layers[0]._featureFilter.filter(new Je(this.zoom),ee,f))continue;const oe=M?M.evaluate(ee,{},f):void 0,pe={id:z,properties:P.properties,type:P.type,sourceLayerIndex:q,index:N,geometry:K?ee.geometry:qa(P,f,m),patterns:{},sortKey:oe};E.push(pe)}M&&E.sort((P,z)=>P.sortKey-z.sortKey);let I=null;m.projection.name==="globe"&&(this.globeExtVertexArray=new go,I=m.projection);for(const P of E){const{geometry:z,index:N,sourceLayerIndex:q}=P,K=n[N].feature;this.addFeature(P,z,N,c.availableImages,f,I),c.featureIndex.insert(K,z,N,q,this.index)}}update(n,c,f,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(n,c,this.stateDependentLayers,f,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,Qp.members),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=n.createVertexBuffer(this.globeExtVertexArray,Jp.members))),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(n,c,f,m,x,E){for(const M of c)for(const I of M){const P=I.x,z=I.y;if(P<0||P>=Zi||z<0||z>=Zi)continue;if(E){const K=E.projectTilePoint(P,z,x),ee=E.upVector(x,P,z),oe=this.globeExtVertexArray;Tu(oe,K,ee),Tu(oe,K,ee),Tu(oe,K,ee),Tu(oe,K,ee)}const N=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,n.sortKey),q=N.vertexLength;Eu(this.layoutVertexArray,P,z,-1,-1),Eu(this.layoutVertexArray,P,z,1,-1),Eu(this.layoutVertexArray,P,z,1,1),Eu(this.layoutVertexArray,P,z,-1,1),this.indexArray.emplaceBack(q,q+1,q+2),this.indexArray.emplaceBack(q,q+2,q+3),N.vertexLength+=4,N.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,f,{},m,x)}}function Yd(l,n){for(let c=0;c<l.length;c++)if(rl(n,l[c]))return!0;for(let c=0;c<n.length;c++)if(rl(l,n[c]))return!0;return!!Eh(l,n)}function dm(l,n,c){return!!rl(l,n)||!!Th(n,l,c)}function Wd(l,n){if(l.length===1)return Qd(n,l[0]);for(let c=0;c<n.length;c++){const f=n[c];for(let m=0;m<f.length;m++)if(rl(l,f[m]))return!0}for(let c=0;c<l.length;c++)if(Qd(n,l[c]))return!0;for(let c=0;c<n.length;c++)if(Eh(l,n[c]))return!0;return!1}function fm(l,n,c){if(l.length>1){if(Eh(l,n))return!0;for(let f=0;f<n.length;f++)if(Th(n[f],l,c))return!0}for(let f=0;f<l.length;f++)if(Th(l[f],n,c))return!0;return!1}function Eh(l,n){if(l.length===0||n.length===0)return!1;for(let c=0;c<l.length-1;c++){const f=l[c],m=l[c+1];for(let x=0;x<n.length-1;x++)if(pm(f,m,n[x],n[x+1]))return!0}return!1}function pm(l,n,c,f){return ci(l,c,f)!==ci(n,c,f)&&ci(l,n,c)!==ci(l,n,f)}function Th(l,n,c){const f=c*c;if(n.length===1)return l.distSqr(n[0])<f;for(let m=1;m<n.length;m++)if(Kd(l,n[m-1],n[m])<f)return!0;return!1}function Kd(l,n,c){const f=n.distSqr(c);if(f===0)return l.distSqr(n);const m=((l.x-n.x)*(c.x-n.x)+(l.y-n.y)*(c.y-n.y))/f;return l.distSqr(m<0?n:m>1?c:c.sub(n)._mult(m)._add(n))}function Qd(l,n){let c,f,m,x=!1;for(let E=0;E<l.length;E++){c=l[E];for(let M=0,I=c.length-1;M<c.length;I=M++)f=c[M],m=c[I],f.y>n.y!=m.y>n.y&&n.x<(m.x-f.x)*(n.y-f.y)/(m.y-f.y)+f.x&&(x=!x)}return x}function rl(l,n){let c=!1;for(let f=0,m=l.length-1;f<l.length;m=f++){const x=l[f],E=l[m];x.y>n.y!=E.y>n.y&&n.x<(E.x-x.x)*(n.y-x.y)/(E.y-x.y)+x.x&&(c=!c)}return c}function Jd(l,n,c,f,m){for(const E of l)if(n<=E.x&&c<=E.y&&f>=E.x&&m>=E.y)return!0;const x=[new W(n,c),new W(n,m),new W(f,m),new W(f,c)];if(l.length>2){for(const E of x)if(rl(l,E))return!0}for(let E=0;E<l.length-1;E++)if(mm(l[E],l[E+1],x))return!0;return!1}function mm(l,n,c){const f=c[0],m=c[2];if(l.x<f.x&&n.x<f.x||l.x>m.x&&n.x>m.x||l.y<f.y&&n.y<f.y||l.y>m.y&&n.y>m.y)return!1;const x=ci(l,n,c[0]);return x!==ci(l,n,c[1])||x!==ci(l,n,c[2])||x!==ci(l,n,c[3])}function $l(l,n,c){const f=n.paint.get(l).value;return f.kind==="constant"?f.value:c.programConfigurations.get(n.id).getMaxValue(l)}function Su(l){return Math.sqrt(l[0]*l[0]+l[1]*l[1])}function ef(l,n,c,f,m){if(!n[0]&&!n[1])return l;const x=W.convert(n)._mult(m);c==="viewport"&&x._rotate(-f);const E=[];for(let M=0;M<l.length;M++)E.push(l[M].sub(x));return E}function tf(l,n,c,f){const m=W.convert(l)._mult(f);return n==="viewport"&&m._rotate(-c),m}Ti(wh,"CircleBucket",{omit:["layers"]});const gm=new jt({"circle-sort-key":new ut(ot.layout_circle["circle-sort-key"])});var _m={paint:new jt({"circle-radius":new ut(ot.paint_circle["circle-radius"]),"circle-color":new ut(ot.paint_circle["circle-color"]),"circle-blur":new ut(ot.paint_circle["circle-blur"]),"circle-opacity":new ut(ot.paint_circle["circle-opacity"]),"circle-translate":new Ke(ot.paint_circle["circle-translate"]),"circle-translate-anchor":new Ke(ot.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ke(ot.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ke(ot.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ut(ot.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ut(ot.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ut(ot.paint_circle["circle-stroke-opacity"])}),layout:gm};function rf(l,n,c,f,m,x,E,M,I){if(x&&l.queryGeometry.isAboveHorizon)return!1;x&&(I*=l.pixelToTileUnitsFactor);const P=l.tileID.canonical,z=c.projection.upVectorScale(P,c.center.lat,c.worldSize).metersToTile;for(const N of n)for(const q of N){const K=q.add(M),ee=m&&c.elevation?c.elevation.exaggeration()*m.getElevationAt(K.x,K.y,!0):0,oe=c.projection.projectTilePoint(K.x,K.y,P);if(ee>0){const be=c.projection.upVector(P,K.x,K.y);oe.x+=be[0]*z*ee,oe.y+=be[1]*z*ee,oe.z+=be[2]*z*ee}const pe=x?K:ym(oe.x,oe.y,oe.z,f),Ee=x?l.tilespaceRays.map(be=>xm(be,ee)):l.queryGeometry.screenGeometry,Re=Js([],[oe.x,oe.y,oe.z,1],f);if(!E&&x?I*=Re[3]/c.cameraToCenterDistance:E&&!x&&(I*=c.cameraToCenterDistance/Re[3]),x){const be=Rn((q.y/Zi+P.y)/(1<<P.z));I/=c.projection.pixelsPerMeter(be,1)/Ko(1,be)}if(dm(Ee,pe,I))return!0}return!1}function ym(l,n,c,f){const m=Js([],[l,n,c,1],f);return new W(m[0]/m[3],m[1]/m[3])}const nf=kl(0,0,0),vm=kl(0,0,1);function xm(l,n){const c=lh();return nf[2]=n,l.intersectsPlane(nf,vm,c),new W(c[0],c[1])}class of extends wh{}function af(l,{width:n,height:c},f,m){if(m){if(m instanceof Uint8ClampedArray)m=new Uint8Array(m.buffer);else if(m.length!==n*c*f)throw new RangeError("mismatched image size")}else m=new Uint8Array(n*c*f);return l.width=n,l.height=c,l.data=m,l}function sf(l,n,c){const{width:f,height:m}=n;f===l.width&&m===l.height||(Sh(l,n,{x:0,y:0},{x:0,y:0},{width:Math.min(l.width,f),height:Math.min(l.height,m)},c),l.width=f,l.height=m,l.data=n.data)}function Sh(l,n,c,f,m,x){if(m.width===0||m.height===0)return n;if(m.width>l.width||m.height>l.height||c.x>l.width-m.width||c.y>l.height-m.height)throw new RangeError("out of range source coordinates for image copy");if(m.width>n.width||m.height>n.height||f.x>n.width-m.width||f.y>n.height-m.height)throw new RangeError("out of range destination coordinates for image copy");const E=l.data,M=n.data;for(let I=0;I<m.height;I++){const P=((c.y+I)*l.width+c.x)*x,z=((f.y+I)*n.width+f.x)*x;for(let N=0;N<m.width*x;N++)M[z+N]=E[P+N]}return n}Ti(of,"HeatmapBucket",{omit:["layers"]});class Ga{constructor(n,c){af(this,n,1,c)}resize(n){sf(this,new Ga(n),1)}clone(){return new Ga({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(n,c,f,m,x){Sh(n,c,f,m,x,1)}}class oo{constructor(n,c){af(this,n,4,c)}resize(n){sf(this,new oo(n),4)}replace(n,c){c?this.data.set(n):this.data=n instanceof Uint8ClampedArray?new Uint8Array(n.buffer):n}clone(){return new oo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(n,c,f,m,x){Sh(n,c,f,m,x,4)}}Ti(Ga,"AlphaImage"),Ti(oo,"RGBAImage");var bm={paint:new jt({"heatmap-radius":new ut(ot.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ut(ot.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ke(ot.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Lt(ot.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ke(ot.paint_heatmap["heatmap-opacity"])})};function Mh(l){const n={},c=l.resolution||256,f=l.clips?l.clips.length:1,m=l.image||new oo({width:c,height:f}),x=(E,M,I)=>{n[l.evaluationKey]=I;const P=l.expression.evaluate(n);m.data[E+M+0]=Math.floor(255*P.r/P.a),m.data[E+M+1]=Math.floor(255*P.g/P.a),m.data[E+M+2]=Math.floor(255*P.b/P.a),m.data[E+M+3]=Math.floor(255*P.a)};if(l.clips)for(let E=0,M=0;E<f;++E,M+=4*c)for(let I=0,P=0;I<c;I++,P+=4){const z=I/(c-1),{start:N,end:q}=l.clips[E];x(M,P,N*(1-z)+q*z)}else for(let E=0,M=0;E<c;E++,M+=4)x(0,M,E/(c-1));return m}var wm={paint:new jt({"hillshade-illumination-direction":new Ke(ot.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ke(ot.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ke(ot.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ke(ot.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ke(ot.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ke(ot.paint_hillshade["hillshade-accent-color"])})};const Em=Oi([{name:"a_pos",components:2,type:"Int16"}],4),{members:Tm}=Em;var Bl={};function Mu(l,n,c){c=c||2;var f,m,x,E,M,I,P,z=n&&n.length,N=z?n[0]*c:l.length,q=lf(l,0,N,c,!0),K=[];if(!q||q.next===q.prev)return K;if(z&&(q=function(oe,pe,Ee,Re){var be,De,ze,Le=[];for(be=0,De=pe.length;be<De;be++)(ze=lf(oe,pe[be]*Re,be<De-1?pe[be+1]*Re:oe.length,Re,!1))===ze.next&&(ze.steiner=!0),Le.push(Rm(ze));for(Le.sort(Im),be=0;be<Le.length;be++)Ee=km(Le[be],Ee);return Ee}(l,n,q,c)),l.length>80*c){f=x=l[0],m=E=l[1];for(var ee=c;ee<N;ee+=c)(M=l[ee])<f&&(f=M),(I=l[ee+1])<m&&(m=I),M>x&&(x=M),I>E&&(E=I);P=(P=Math.max(x-f,E-m))!==0?32767/P:0}return wc(q,K,c,f,m,P,0),K}function lf(l,n,c,f,m){var x,E;if(m===Ih(l,n,c,f)>0)for(x=n;x<c;x+=f)E=hf(x,l[x],l[x+1],E);else for(x=c-f;x>=n;x-=f)E=hf(x,l[x],l[x+1],E);return E&&Au(E,E.next)&&(Tc(E),E=E.next),E}function nl(l,n){if(!l)return l;n||(n=l);var c,f=l;do if(c=!1,f.steiner||!Au(f,f.next)&&cn(f.prev,f,f.next)!==0)f=f.next;else{if(Tc(f),(f=n=f.prev)===f.next)break;c=!0}while(c||f!==n);return n}function wc(l,n,c,f,m,x,E){if(l){!E&&x&&function(z,N,q,K){var ee=z;do ee.z===0&&(ee.z=Ah(ee.x,ee.y,N,q,K)),ee.prevZ=ee.prev,ee.nextZ=ee.next,ee=ee.next;while(ee!==z);ee.prevZ.nextZ=null,ee.prevZ=null,function(oe){var pe,Ee,Re,be,De,ze,Le,st,it=1;do{for(Ee=oe,oe=null,De=null,ze=0;Ee;){for(ze++,Re=Ee,Le=0,pe=0;pe<it&&(Le++,Re=Re.nextZ);pe++);for(st=it;Le>0||st>0&&Re;)Le!==0&&(st===0||!Re||Ee.z<=Re.z)?(be=Ee,Ee=Ee.nextZ,Le--):(be=Re,Re=Re.nextZ,st--),De?De.nextZ=be:oe=be,be.prevZ=De,De=be;Ee=Re}De.nextZ=null,it*=2}while(ze>1)}(ee)}(l,f,m,x);for(var M,I,P=l;l.prev!==l.next;)if(M=l.prev,I=l.next,x?Mm(l,f,m,x):Sm(l))n.push(M.i/c|0),n.push(l.i/c|0),n.push(I.i/c|0),Tc(l),l=I.next,P=I.next;else if((l=I)===P){E?E===1?wc(l=Am(nl(l),n,c),n,c,f,m,x,2):E===2&&Cm(l,n,c,f,m,x):wc(nl(l),n,c,f,m,x,1);break}}}function Sm(l){var n=l.prev,c=l,f=l.next;if(cn(n,c,f)>=0)return!1;for(var m=n.x,x=c.x,E=f.x,M=n.y,I=c.y,P=f.y,z=m<x?m<E?m:E:x<E?x:E,N=M<I?M<P?M:P:I<P?I:P,q=m>x?m>E?m:E:x>E?x:E,K=M>I?M>P?M:P:I>P?I:P,ee=f.next;ee!==n;){if(ee.x>=z&&ee.x<=q&&ee.y>=N&&ee.y<=K&&Ol(m,M,x,I,E,P,ee.x,ee.y)&&cn(ee.prev,ee,ee.next)>=0)return!1;ee=ee.next}return!0}function Mm(l,n,c,f){var m=l.prev,x=l,E=l.next;if(cn(m,x,E)>=0)return!1;for(var M=m.x,I=x.x,P=E.x,z=m.y,N=x.y,q=E.y,K=M<I?M<P?M:P:I<P?I:P,ee=z<N?z<q?z:q:N<q?N:q,oe=M>I?M>P?M:P:I>P?I:P,pe=z>N?z>q?z:q:N>q?N:q,Ee=Ah(K,ee,n,c,f),Re=Ah(oe,pe,n,c,f),be=l.prevZ,De=l.nextZ;be&&be.z>=Ee&&De&&De.z<=Re;){if(be.x>=K&&be.x<=oe&&be.y>=ee&&be.y<=pe&&be!==m&&be!==E&&Ol(M,z,I,N,P,q,be.x,be.y)&&cn(be.prev,be,be.next)>=0||(be=be.prevZ,De.x>=K&&De.x<=oe&&De.y>=ee&&De.y<=pe&&De!==m&&De!==E&&Ol(M,z,I,N,P,q,De.x,De.y)&&cn(De.prev,De,De.next)>=0))return!1;De=De.nextZ}for(;be&&be.z>=Ee;){if(be.x>=K&&be.x<=oe&&be.y>=ee&&be.y<=pe&&be!==m&&be!==E&&Ol(M,z,I,N,P,q,be.x,be.y)&&cn(be.prev,be,be.next)>=0)return!1;be=be.prevZ}for(;De&&De.z<=Re;){if(De.x>=K&&De.x<=oe&&De.y>=ee&&De.y<=pe&&De!==m&&De!==E&&Ol(M,z,I,N,P,q,De.x,De.y)&&cn(De.prev,De,De.next)>=0)return!1;De=De.nextZ}return!0}function Am(l,n,c){var f=l;do{var m=f.prev,x=f.next.next;!Au(m,x)&&cf(m,f,f.next,x)&&Ec(m,x)&&Ec(x,m)&&(n.push(m.i/c|0),n.push(f.i/c|0),n.push(x.i/c|0),Tc(f),Tc(f.next),f=l=x),f=f.next}while(f!==l);return nl(f)}function Cm(l,n,c,f,m,x){var E=l;do{for(var M=E.next.next;M!==E.prev;){if(E.i!==M.i&&Pm(E,M)){var I=uf(E,M);return E=nl(E,E.next),I=nl(I,I.next),wc(E,n,c,f,m,x,0),void wc(I,n,c,f,m,x,0)}M=M.next}E=E.next}while(E!==l)}function Im(l,n){return l.x-n.x}function km(l,n){var c=function(m,x){var E,M=x,I=m.x,P=m.y,z=-1/0;do{if(P<=M.y&&P>=M.next.y&&M.next.y!==M.y){var N=M.x+(P-M.y)*(M.next.x-M.x)/(M.next.y-M.y);if(N<=I&&N>z&&(z=N,E=M.x<M.next.x?M:M.next,N===I))return E}M=M.next}while(M!==x);if(!E)return null;var q,K=E,ee=E.x,oe=E.y,pe=1/0;M=E;do I>=M.x&&M.x>=ee&&I!==M.x&&Ol(P<oe?I:z,P,ee,oe,P<oe?z:I,P,M.x,M.y)&&(q=Math.abs(P-M.y)/(I-M.x),Ec(M,m)&&(q<pe||q===pe&&(M.x>E.x||M.x===E.x&&Dm(E,M)))&&(E=M,pe=q)),M=M.next;while(M!==K);return E}(l,n);if(!c)return n;var f=uf(c,l);return nl(f,f.next),nl(c,c.next)}function Dm(l,n){return cn(l.prev,l,n.prev)<0&&cn(n.next,l,l.next)<0}function Ah(l,n,c,f,m){return(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=(l-c)*m|0)|l<<8))|l<<4))|l<<2))|l<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-f)*m|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function Rm(l){var n=l,c=l;do(n.x<c.x||n.x===c.x&&n.y<c.y)&&(c=n),n=n.next;while(n!==l);return c}function Ol(l,n,c,f,m,x,E,M){return(m-E)*(n-M)>=(l-E)*(x-M)&&(l-E)*(f-M)>=(c-E)*(n-M)&&(c-E)*(x-M)>=(m-E)*(f-M)}function Pm(l,n){return l.next.i!==n.i&&l.prev.i!==n.i&&!function(c,f){var m=c;do{if(m.i!==c.i&&m.next.i!==c.i&&m.i!==f.i&&m.next.i!==f.i&&cf(m,m.next,c,f))return!0;m=m.next}while(m!==c);return!1}(l,n)&&(Ec(l,n)&&Ec(n,l)&&function(c,f){var m=c,x=!1,E=(c.x+f.x)/2,M=(c.y+f.y)/2;do m.y>M!=m.next.y>M&&m.next.y!==m.y&&E<(m.next.x-m.x)*(M-m.y)/(m.next.y-m.y)+m.x&&(x=!x),m=m.next;while(m!==c);return x}(l,n)&&(cn(l.prev,l,n.prev)||cn(l,n.prev,n))||Au(l,n)&&cn(l.prev,l,l.next)>0&&cn(n.prev,n,n.next)>0)}function cn(l,n,c){return(n.y-l.y)*(c.x-n.x)-(n.x-l.x)*(c.y-n.y)}function Au(l,n){return l.x===n.x&&l.y===n.y}function cf(l,n,c,f){var m=Iu(cn(l,n,c)),x=Iu(cn(l,n,f)),E=Iu(cn(c,f,l)),M=Iu(cn(c,f,n));return m!==x&&E!==M||!(m!==0||!Cu(l,c,n))||!(x!==0||!Cu(l,f,n))||!(E!==0||!Cu(c,l,f))||!(M!==0||!Cu(c,n,f))}function Cu(l,n,c){return n.x<=Math.max(l.x,c.x)&&n.x>=Math.min(l.x,c.x)&&n.y<=Math.max(l.y,c.y)&&n.y>=Math.min(l.y,c.y)}function Iu(l){return l>0?1:l<0?-1:0}function Ec(l,n){return cn(l.prev,l,l.next)<0?cn(l,n,l.next)>=0&&cn(l,l.prev,n)>=0:cn(l,n,l.prev)<0||cn(l,l.next,n)<0}function uf(l,n){var c=new Ch(l.i,l.x,l.y),f=new Ch(n.i,n.x,n.y),m=l.next,x=n.prev;return l.next=n,n.prev=l,c.next=m,m.prev=c,f.next=c,c.prev=f,x.next=f,f.prev=x,f}function hf(l,n,c,f){var m=new Ch(l,n,c);return f?(m.next=f.next,m.prev=f,f.next.prev=m,f.next=m):(m.prev=m,m.next=m),m}function Tc(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function Ch(l,n,c){this.i=l,this.x=n,this.y=c,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Ih(l,n,c,f){for(var m=0,x=n,E=c-f;x<c;x+=f)m+=(l[E]-l[x])*(l[x+1]+l[E+1]),E=x;return m}function Lm(l,n,c,f,m){df(l,n,c||0,f||l.length-1,m||$m)}function df(l,n,c,f,m){for(;f>c;){if(f-c>600){var x=f-c+1,E=n-c+1,M=Math.log(x),I=.5*Math.exp(2*M/3),P=.5*Math.sqrt(M*I*(x-I)/x)*(E-x/2<0?-1:1);df(l,n,Math.max(c,Math.floor(n-E*I/x+P)),Math.min(f,Math.floor(n+(x-E)*I/x+P)),m)}var z=l[n],N=c,q=f;for(Sc(l,c,n),m(l[f],z)>0&&Sc(l,c,f);N<q;){for(Sc(l,N,q),N++,q--;m(l[N],z)<0;)N++;for(;m(l[q],z)>0;)q--}m(l[c],z)===0?Sc(l,c,q):Sc(l,++q,f),q<=n&&(c=q+1),n<=q&&(f=q-1)}}function Sc(l,n,c){var f=l[n];l[n]=l[c],l[c]=f}function $m(l,n){return l<n?-1:l>n?1:0}function kh(l,n){const c=l.length;if(c<=1)return[l];const f=[];let m,x;for(let E=0;E<c;E++){const M=mt(l[E]);M!==0&&(l[E].area=Math.abs(M),x===void 0&&(x=M<0),x===M<0?(m&&f.push(m),m=[l[E]]):m.push(l[E]))}if(m&&f.push(m),n>1)for(let E=0;E<f.length;E++)f[E].length<=n||(Lm(f[E],n,1,f[E].length-1,Bm),f[E]=f[E].slice(0,n));return f}function Bm(l,n){return n.area-l.area}function Dh(l,n,c){const f=c.patternDependencies;let m=!1;for(const x of n){const E=x.paint.get(`${l}-pattern`);E.isConstant()||(m=!0);const M=E.constantOr(null);M&&(m=!0,f[M]=!0)}return m}function Rh(l,n,c,f,m){const x=m.patternDependencies;for(const E of n){const M=E.paint.get(`${l}-pattern`).value;if(M.kind!=="constant"){let I=M.evaluate({zoom:f},c,{},m.availableImages);I=I&&I.name?I.name:I,x[I]=!0,c.patterns[E.id]=I}}return c}({get exports(){return Bl},set exports(l){Bl=l}}).exports=Mu,Bl.default=Mu,Mu.deviation=function(l,n,c,f){var m=n&&n.length,x=Math.abs(Ih(l,0,m?n[0]*c:l.length,c));if(m)for(var E=0,M=n.length;E<M;E++)x-=Math.abs(Ih(l,n[E]*c,E<M-1?n[E+1]*c:l.length,c));var I=0;for(E=0;E<f.length;E+=3){var P=f[E]*c,z=f[E+1]*c,N=f[E+2]*c;I+=Math.abs((l[P]-l[N])*(l[z+1]-l[P+1])-(l[P]-l[z])*(l[N+1]-l[P+1]))}return x===0&&I===0?0:Math.abs((I-x)/x)},Mu.flatten=function(l){for(var n=l[0][0].length,c={vertices:[],holes:[],dimensions:n},f=0,m=0;m<l.length;m++){for(var x=0;x<l[m].length;x++)for(var E=0;E<n;E++)c.vertices.push(l[m][x][E]);m>0&&c.holes.push(f+=l[m-1].length)}return c};class ku{constructor(n){this.zoom=n.zoom,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(c=>c.id),this.index=n.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Ui,this.indexArray=new Dn,this.indexArray2=new ha,this.programConfigurations=new Ws(n.layers,n.zoom),this.segments=new ln,this.segments2=new ln,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id),this.projection=n.projection}populate(n,c,f,m){this.hasPattern=Dh("fill",this.layers,c);const x=this.layers[0].layout.get("fill-sort-key"),E=[];for(const{feature:M,id:I,index:P,sourceLayerIndex:z}of n){const N=this.layers[0]._featureFilter.needGeometry,q=il(M,N);if(!this.layers[0]._featureFilter.filter(new Je(this.zoom),q,f))continue;const K=x?x.evaluate(q,{},f,c.availableImages):void 0,ee={id:I,properties:M.properties,type:M.type,sourceLayerIndex:z,index:P,geometry:N?q.geometry:qa(M,f,m),patterns:{},sortKey:K};E.push(ee)}x&&E.sort((M,I)=>M.sortKey-I.sortKey);for(const M of E){const{geometry:I,index:P,sourceLayerIndex:z}=M;if(this.hasPattern){const N=Rh("fill",this.layers,M,this.zoom,c);this.patternFeatures.push(N)}else this.addFeature(M,I,P,f,{},c.availableImages);c.featureIndex.insert(n[P].feature,I,P,z,this.index)}}update(n,c,f,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(n,c,this.stateDependentLayers,f,m)}addFeatures(n,c,f,m,x){for(const E of this.patternFeatures)this.addFeature(E,E.geometry,E.index,c,f,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,Tm),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.indexBuffer2=n.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(n,c,f,m,x,E=[]){for(const M of kh(c,500)){let I=0;for(const ee of M)I+=ee.length;const P=this.segments.prepareSegment(I,this.layoutVertexArray,this.indexArray),z=P.vertexLength,N=[],q=[];for(const ee of M){if(ee.length===0)continue;ee!==M[0]&&q.push(N.length/2);const oe=this.segments2.prepareSegment(ee.length,this.layoutVertexArray,this.indexArray2),pe=oe.vertexLength;this.layoutVertexArray.emplaceBack(ee[0].x,ee[0].y),this.indexArray2.emplaceBack(pe+ee.length-1,pe),N.push(ee[0].x),N.push(ee[0].y);for(let Ee=1;Ee<ee.length;Ee++)this.layoutVertexArray.emplaceBack(ee[Ee].x,ee[Ee].y),this.indexArray2.emplaceBack(pe+Ee-1,pe+Ee),N.push(ee[Ee].x),N.push(ee[Ee].y);oe.vertexLength+=ee.length,oe.primitiveLength+=ee.length}const K=Bl(N,q);for(let ee=0;ee<K.length;ee+=3)this.indexArray.emplaceBack(z+K[ee],z+K[ee+1],z+K[ee+2]);P.vertexLength+=I,P.primitiveLength+=K.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,f,x,E,m)}}Ti(ku,"FillBucket",{omit:["layers","patternFeatures"]});const Om=new jt({"fill-sort-key":new ut(ot.layout_fill["fill-sort-key"])});var zm={paint:new jt({"fill-antialias":new Ke(ot.paint_fill["fill-antialias"]),"fill-opacity":new ut(ot.paint_fill["fill-opacity"]),"fill-color":new ut(ot.paint_fill["fill-color"]),"fill-outline-color":new ut(ot.paint_fill["fill-outline-color"]),"fill-translate":new Ke(ot.paint_fill["fill-translate"]),"fill-translate-anchor":new Ke(ot.paint_fill["fill-translate-anchor"]),"fill-pattern":new ut(ot.paint_fill["fill-pattern"])}),layout:Om};const Fm=Oi([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Nm=Oi([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Um=Oi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Vm}=Fm;var Du={},jm=W,ff=zl;function zl(l,n,c,f,m){this.properties={},this.extent=c,this.type=0,this._pbf=l,this._geometry=-1,this._keys=f,this._values=m,l.readFields(qm,this,n)}function qm(l,n,c){l==1?n.id=c.readVarint():l==2?function(f,m){for(var x=f.readVarint()+f.pos;f.pos<x;){var E=m._keys[f.readVarint()],M=m._values[f.readVarint()];m.properties[E]=M}}(c,n):l==3?n.type=c.readVarint():l==4&&(n._geometry=c.pos)}function Gm(l){for(var n,c,f=0,m=0,x=l.length,E=x-1;m<x;E=m++)f+=((c=l[E]).x-(n=l[m]).x)*(n.y+c.y);return f}zl.types=["Unknown","Point","LineString","Polygon"],zl.prototype.loadGeometry=function(){var l=this._pbf;l.pos=this._geometry;for(var n,c=l.readVarint()+l.pos,f=1,m=0,x=0,E=0,M=[];l.pos<c;){if(m<=0){var I=l.readVarint();f=7&I,m=I>>3}if(m--,f===1||f===2)x+=l.readSVarint(),E+=l.readSVarint(),f===1&&(n&&M.push(n),n=[]),n.push(new jm(x,E));else{if(f!==7)throw new Error("unknown command "+f);n&&n.push(n[0].clone())}}return n&&M.push(n),M},zl.prototype.bbox=function(){var l=this._pbf;l.pos=this._geometry;for(var n=l.readVarint()+l.pos,c=1,f=0,m=0,x=0,E=1/0,M=-1/0,I=1/0,P=-1/0;l.pos<n;){if(f<=0){var z=l.readVarint();c=7&z,f=z>>3}if(f--,c===1||c===2)(m+=l.readSVarint())<E&&(E=m),m>M&&(M=m),(x+=l.readSVarint())<I&&(I=x),x>P&&(P=x);else if(c!==7)throw new Error("unknown command "+c)}return[E,I,M,P]},zl.prototype.toGeoJSON=function(l,n,c){var f,m,x=this.extent*Math.pow(2,c),E=this.extent*l,M=this.extent*n,I=this.loadGeometry(),P=zl.types[this.type];function z(K){for(var ee=0;ee<K.length;ee++){var oe=K[ee];K[ee]=[360*(oe.x+E)/x-180,360/Math.PI*Math.atan(Math.exp((180-360*(oe.y+M)/x)*Math.PI/180))-90]}}switch(this.type){case 1:var N=[];for(f=0;f<I.length;f++)N[f]=I[f][0];z(I=N);break;case 2:for(f=0;f<I.length;f++)z(I[f]);break;case 3:for(I=function(K){var ee=K.length;if(ee<=1)return[K];for(var oe,pe,Ee=[],Re=0;Re<ee;Re++){var be=Gm(K[Re]);be!==0&&(pe===void 0&&(pe=be<0),pe===be<0?(oe&&Ee.push(oe),oe=[K[Re]]):oe.push(K[Re]))}return oe&&Ee.push(oe),Ee}(I),f=0;f<I.length;f++)for(m=0;m<I[f].length;m++)z(I[f][m])}I.length===1?I=I[0]:P="Multi"+P;var q={type:"Feature",geometry:{type:P,coordinates:I},properties:this.properties};return"id"in this&&(q.id=this.id),q};var Zm=ff,pf=mf;function mf(l,n){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=l,this._keys=[],this._values=[],this._features=[],l.readFields(Hm,this,n),this.length=this._features.length}function Hm(l,n,c){l===15?n.version=c.readVarint():l===1?n.name=c.readString():l===5?n.extent=c.readVarint():l===2?n._features.push(c.pos):l===3?n._keys.push(c.readString()):l===4&&n._values.push(function(f){for(var m=null,x=f.readVarint()+f.pos;f.pos<x;){var E=f.readVarint()>>3;m=E===1?f.readString():E===2?f.readFloat():E===3?f.readDouble():E===4?f.readVarint64():E===5?f.readVarint():E===6?f.readSVarint():E===7?f.readBoolean():null}return m}(c))}mf.prototype.feature=function(l){if(l<0||l>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[l];var n=this._pbf.readVarint()+this._pbf.pos;return new Zm(this._pbf,n,this.extent,this._keys,this._values)};var Xm=pf;function Ym(l,n,c){if(l===3){var f=new Xm(c,c.readVarint()+c.pos);f.length&&(n[f.name]=f)}}var Ph=Du.VectorTile=function(l,n){this.layers=l.readFields(Ym,{},n)},Ru=Du.VectorTileFeature=ff;function Pu(l,n,c,f){const m=[],x=f===0?(E,M,I,P,z,N)=>{E.push(new W(N,I+(N-M)/(P-M)*(z-I)))}:(E,M,I,P,z,N)=>{E.push(new W(M+(N-I)/(z-I)*(P-M),N))};for(const E of l){const M=[];for(const I of E){if(I.length<=2)continue;const P=[];for(let q=0;q<I.length-1;q++){const K=I[q].x,ee=I[q].y,oe=I[q+1].x,pe=I[q+1].y,Ee=f===0?K:ee,Re=f===0?oe:pe;Ee<n?Re>n&&x(P,K,ee,oe,pe,n):Ee>c?Re<c&&x(P,K,ee,oe,pe,c):P.push(I[q]),Re<n&&Ee>=n&&x(P,K,ee,oe,pe,n),Re>c&&Ee<=c&&x(P,K,ee,oe,pe,c)}let z=I[I.length-1];const N=f===0?z.x:z.y;N>=n&&N<=c&&P.push(z),P.length&&(z=P[P.length-1],P[0].x===z.x&&P[0].y===z.y||P.push(P[0]),M.push(P))}M.length&&m.push(M)}return m}Du.VectorTileLayer=pf;const Wm=Ru.types,Km=Math.pow(2,13);function Mc(l,n,c,f,m,x,E,M){l.emplaceBack((n<<1)+E,(c<<1)+x,(Math.floor(f*Km)<<1)+m,Math.round(M))}function Ac(l,n,c){l.emplaceBack(n.x,n.y,n.z,c[0]*16384,c[1]*16384,c[2]*16384)}class gf{constructor(){this.acc=new W(0,0),this.polyCount=[]}startRing(n){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new W(n.x,n.y),this.max=new W(n.x,n.y))}append(n,c){this.currentPolyCount.edges++,this.acc._add(n);const f=this.min,m=this.max;n.x<f.x?f.x=n.x:n.x>m.x&&(m.x=n.x),n.y<f.y?f.y=n.y:n.y>m.y&&(m.y=n.y),((n.x===0||n.x===Zi)&&n.x===c.x)!=((n.y===0||n.y===Zi)&&n.y===c.y)&&this.processBorderOverlap(n,c),c.x<0!=n.x<0&&this.addBorderIntersection(0,Qi(c.y,n.y,(0-c.x)/(n.x-c.x))),c.x>Zi!=n.x>Zi&&this.addBorderIntersection(1,Qi(c.y,n.y,(Zi-c.x)/(n.x-c.x))),c.y<0!=n.y<0&&this.addBorderIntersection(2,Qi(c.x,n.x,(0-c.y)/(n.y-c.y))),c.y>Zi!=n.y>Zi&&this.addBorderIntersection(3,Qi(c.x,n.x,(Zi-c.y)/(n.y-c.y)))}addBorderIntersection(n,c){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const f=this.borders[n];c<f[0]&&(f[0]=c),c>f[1]&&(f[1]=c)}processBorderOverlap(n,c){if(n.x===c.x){if(n.y===c.y)return;const f=n.x===0?0:1;this.addBorderIntersection(f,c.y),this.addBorderIntersection(f,n.y)}else{const f=n.y===0?2:3;this.addBorderIntersection(f,c.x),this.addBorderIntersection(f,n.x)}}centroid(){const n=this.polyCount.reduce((c,f)=>c+f.edges,0);return n!==0?this.acc.div(n)._round():new W(0,0)}span(){return new W(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((n,c)=>n+ +(c[0]!==Number.MAX_VALUE),0)}}class Cc{constructor(n){this.zoom=n.zoom,this.canonical=n.canonical,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(c=>c.id),this.index=n.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=n.projection,this.layoutVertexArray=new vr,this.centroidVertexArray=new gd,this.indexArray=new Dn,this.programConfigurations=new Ws(n.layers,n.zoom),this.segments=new ln,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id),this.enableTerrain=n.enableTerrain}populate(n,c,f,m){this.features=[],this.hasPattern=Dh("fill-extrusion",this.layers,c),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=function(x){const E=Math.exp(Math.PI*(1-x.y/(1<<x.z)*2));return 80150034*E/(E*E+1)/Zi/(1<<x.z)}(f),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:x,id:E,index:M,sourceLayerIndex:I}of n){const P=this.layers[0]._featureFilter.needGeometry,z=il(x,P);if(!this.layers[0]._featureFilter.filter(new Je(this.zoom),z,f))continue;const N={id:E,sourceLayerIndex:I,index:M,geometry:P?z.geometry:qa(x,f,m),properties:x.properties,type:x.type,patterns:{}},q=this.layoutVertexArray.length;this.hasPattern?this.features.push(Rh("fill-extrusion",this.layers,N,this.zoom,c)):this.addFeature(N,N.geometry,M,f,{},c.availableImages,m),c.featureIndex.insert(x,N.geometry,M,I,this.index,q)}this.sortBorders()}addFeatures(n,c,f,m,x){for(const E of this.features){const{geometry:M}=E;this.addFeature(E,M,E.index,c,f,m,x)}this.sortBorders()}update(n,c,f,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(n,c,this.stateDependentLayers,f,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,Vm),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=n.createVertexBuffer(this.layoutVertexExtArray,Um.members,!0))),this.programConfigurations.upload(n),this.uploaded=!0}uploadCentroid(n){this.centroidVertexArray.length!==0&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=n.createVertexBuffer(this.centroidVertexArray,Nm.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(n,c,f,m,x,E,M){const I=[new W(0,0),new W(Zi,Zi)],P=M.projection,z=P.name==="globe",N=this.enableTerrain&&!z?new gf:null,q=Wm[n.type]==="Polygon";z&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new go);const K=kh(c,500);for(let Ee=K.length-1;Ee>=0;Ee--){const Re=K[Ee];(Re.length===0||(ee=Re[0]).every(be=>be.x<=0)||ee.every(be=>be.x>=Zi)||ee.every(be=>be.y<=0)||ee.every(be=>be.y>=Zi))&&K.splice(Ee,1)}var ee;let oe;if(z)oe=Ef(K,I,m);else{oe=[];for(const Ee of K)oe.push({polygon:Ee,bounds:I})}const pe=q?this.edgeRadius:0;for(const{polygon:Ee,bounds:Re}of oe){let be=0,De=0;for(const Le of Ee)q&&!Le[0].equals(Le[Le.length-1])&&Le.push(Le[0]),De+=q?Le.length-1:Le.length;const ze=this.segments.prepareSegment((q?5:4)*De,this.layoutVertexArray,this.indexArray);if(q){const Le=[],st=[];be=ze.vertexLength;for(const wt of Ee){let Gt,ft;wt.length&&wt!==Ee[0]&&st.push(Le.length/2),Gt=wt[1].sub(wt[0])._perp()._unit();for(let kt=1;kt<wt.length;kt++){const Rt=wt[kt],Ft=wt[kt===wt.length-1?1:kt+1];let{x:Zt,y:pt}=Rt;if(pe){ft=Ft.sub(Rt)._perp()._unit();const oi=Gt.add(ft)._unit(),Vi=pe*Math.min(4,1/(Gt.x*oi.x+Gt.y*oi.y));Zt+=Vi*oi.x,pt+=Vi*oi.y,Gt=ft}Mc(this.layoutVertexArray,Zt,pt,0,0,1,1,0),ze.vertexLength++,Le.push(Rt.x,Rt.y),z&&Ac(this.layoutVertexExtArray,P.projectTilePoint(Zt,pt,m),P.upVector(m,Zt,pt))}}const it=Bl(Le,st);for(let wt=0;wt<it.length;wt+=3)this.indexArray.emplaceBack(be+it[wt],be+it[wt+2],be+it[wt+1]),ze.primitiveLength++}for(const Le of Ee){N&&Le.length&&N.startRing(Le[0]);let st,it,wt,Gt=Le.length>4&&xf(Le[Le.length-2],Le[0],Le[1]),ft=pe?Qm(Le[Le.length-2],Le[0],Le[1],pe):0;it=Le[1].sub(Le[0])._perp()._unit();let kt=!0;for(let Rt=1,Ft=0;Rt<Le.length;Rt++){let Zt=Le[Rt-1],pt=Le[Rt];const oi=Le[Rt===Le.length-1?1:Rt+1];if(N&&q&&N.currentPolyCount.top++,vf(pt,Zt,Re)){pe&&(it=oi.sub(pt)._perp()._unit(),kt=!kt);continue}N&&N.append(pt,Zt);const Vi=pt.sub(Zt)._perp(),pi=Vi.x/(Math.abs(Vi.x)+Math.abs(Vi.y)),ki=Vi.y>0?1:0,ai=Zt.dist(pt);if(Ft+ai>32768&&(Ft=0),pe){wt=oi.sub(pt)._perp()._unit();let ir=yf(Zt,pt,oi,_f(it,wt),pe);isNaN(ir)&&(ir=0);const Gi=pt.sub(Zt)._unit();Zt=Zt.add(Gi.mult(ft))._round(),pt=pt.add(Gi.mult(-ir))._round(),ft=ir,it=wt}const qi=ze.vertexLength,sr=Le.length>4&&xf(Zt,pt,oi);let or=bf(Ft,Gt,kt);if(Mc(this.layoutVertexArray,Zt.x,Zt.y,pi,ki,0,0,or),Mc(this.layoutVertexArray,Zt.x,Zt.y,pi,ki,0,1,or),Ft+=ai,or=bf(Ft,sr,!kt),Gt=sr,Mc(this.layoutVertexArray,pt.x,pt.y,pi,ki,0,0,or),Mc(this.layoutVertexArray,pt.x,pt.y,pi,ki,0,1,or),ze.vertexLength+=4,this.indexArray.emplaceBack(qi+0,qi+1,qi+2),this.indexArray.emplaceBack(qi+1,qi+3,qi+2),ze.primitiveLength+=2,pe){const ir=be+(Rt===1?Le.length-2:Rt-2),Gi=Rt===1?be:ir+1;if(this.indexArray.emplaceBack(qi+1,ir,qi+3),this.indexArray.emplaceBack(ir,Gi,qi+3),ze.primitiveLength+=2,st===void 0&&(st=qi),!vf(oi,Le[Rt],Re)){const br=Rt===Le.length-1?st:ze.vertexLength;this.indexArray.emplaceBack(qi+2,qi+3,br),this.indexArray.emplaceBack(qi+3,br+1,br),this.indexArray.emplaceBack(qi+3,Gi,br+1),ze.primitiveLength+=3}kt=!kt}if(z){const ir=this.layoutVertexExtArray,Gi=P.projectTilePoint(Zt.x,Zt.y,m),br=P.projectTilePoint(pt.x,pt.y,m),Wi=P.upVector(m,Zt.x,Zt.y),lr=P.upVector(m,pt.x,pt.y);Ac(ir,Gi,Wi),Ac(ir,Gi,Wi),Ac(ir,br,lr),Ac(ir,br,lr)}}q&&(be+=Le.length-1)}}if(N&&N.polyCount.length>0){if(N.borders){N.vertexArrayOffset=this.centroidVertexArray.length;const Ee=N.borders,Re=this.featuresOnBorder.push(N)-1;for(let be=0;be<4;be++)Ee[be][0]!==Number.MAX_VALUE&&this.borders[be].push(Re)}this.encodeCentroid(N.borders?void 0:N.centroid(),N)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,f,x,E,m)}sortBorders(){for(let n=0;n<4;n++)this.borders[n].sort((c,f)=>this.featuresOnBorder[c].borders[n][0]-this.featuresOnBorder[f].borders[n][0])}encodeCentroid(n,c,f=!0){let m,x;if(n)if(n.y!==0){const M=c.span()._mult(this.tileToMeter);m=(Math.max(n.x,1)<<3)+Math.min(7,Math.round(M.x/10)),x=(Math.max(n.y,1)<<3)+Math.min(7,Math.round(M.y/10))}else m=Math.ceil(7*(n.x+450)),x=0;else m=0,x=+f;let E=f?this.centroidVertexArray.length:c.vertexArrayOffset;for(const M of c.polyCount){f&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*M.edges+M.top);for(let I=0;I<M.top;I++)this.centroidVertexArray.emplace(E++,m,x);for(let I=0;I<2*M.edges;I++)this.centroidVertexArray.emplace(E++,0,x),this.centroidVertexArray.emplace(E++,m,x)}}}function _f(l,n){const c=l.add(n)._unit();return l.x*c.x+l.y*c.y}function Qm(l,n,c,f){const m=n.sub(l)._perp()._unit(),x=c.sub(n)._perp()._unit();return yf(l,n,c,_f(m,x),f)}function yf(l,n,c,f,m){const x=Math.sqrt(1-f*f);return Math.min(l.dist(n)/3,n.dist(c)/3,m*x/f)}function vf(l,n,c){return l.x<c[0].x&&n.x<c[0].x||l.x>c[1].x&&n.x>c[1].x||l.y<c[0].y&&n.y<c[0].y||l.y>c[1].y&&n.y>c[1].y}function xf(l,n,c){if(l.x<0||l.x>=Zi||n.x<0||n.x>=Zi||c.x<0||c.x>=Zi)return!1;const f=c.sub(n),m=f.perp(),x=l.sub(n);return(f.x*x.x+f.y*x.y)/Math.sqrt((f.x*f.x+f.y*f.y)*(x.x*x.x+x.y*x.y))>-.866&&m.x*x.x+m.y*x.y<0}function bf(l,n,c){const f=n?2|l:-3&l;return c?1|f:-2&f}function wf(){const l=Math.PI/32,n=Math.tan(l),c=bc;return c*Math.sqrt(1+2*n*n)-c}function Ef(l,n,c){const f=1<<c.z,m=yo(c.x/f),x=yo((c.x+1)/f),E=Rn(c.y/f),M=Rn((c.y+1)/f);return function(I,P,z,N,q=0,K){const ee=[];if(!I.length||!z||!N)return ee;const oe=(Le,st)=>{for(const it of Le)ee.push({polygon:it,bounds:st})},pe=Math.ceil(Math.log2(z)),Ee=Math.ceil(Math.log2(N)),Re=pe-Ee,be=[];for(let Le=0;Le<Math.abs(Re);Le++)be.push(Re>0?0:1);for(let Le=0;Le<Math.min(pe,Ee);Le++)be.push(0),be.push(1);let De=I;if(De=Pu(De,P[0].y-q,P[1].y+q,1),De=Pu(De,P[0].x-q,P[1].x+q,0),!De.length)return ee;const ze=[];for(be.length?ze.push({polygons:De,bounds:P,depth:0}):oe(De,P);ze.length;){const Le=ze.pop(),st=Le.depth,it=be[st],wt=Le.bounds[0],Gt=Le.bounds[1],ft=it===0?wt.x:wt.y,kt=it===0?Gt.x:Gt.y,Rt=K?K(it,ft,kt):.5*(ft+kt),Ft=Pu(Le.polygons,ft-q,Rt+q,it),Zt=Pu(Le.polygons,Rt-q,kt+q,it);if(Ft.length){const pt=[wt,new W(it===0?Rt:Gt.x,it===1?Rt:Gt.y)];be.length>st+1?ze.push({polygons:Ft,bounds:pt,depth:st+1}):oe(Ft,pt)}if(Zt.length){const pt=[new W(it===0?Rt:wt.x,it===1?Rt:wt.y),Gt];be.length>st+1?ze.push({polygons:Zt,bounds:pt,depth:st+1}):oe(Zt,pt)}}return ee}(l,n,Math.ceil((x-m)/11.25),Math.ceil((E-M)/11.25),1,(I,P,z)=>{if(I===0)return .5*(P+z);{const N=Rn((c.y+P/Zi)/f);return(ga(.5*(Rn((c.y+z/Zi)/f)+N))*f-c.y)*Zi}})}Ti(Cc,"FillExtrusionBucket",{omit:["layers","features"]}),Ti(gf,"PartMetadata");const Jm=new jt({"fill-extrusion-edge-radius":new Ke(ot["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var eg={paint:new jt({"fill-extrusion-opacity":new Ke(ot["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ut(ot["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ke(ot["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ke(ot["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new ut(ot["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new ut(ot["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ut(ot["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Ke(ot["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Ke(ot["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Ke(ot["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"])}),layout:Jm};function Tf(l,n,c){var f=2*Math.PI*6378137/256/Math.pow(2,c);return[l*f-2*Math.PI*6378137/2,n*f-2*Math.PI*6378137/2]}class Lu{constructor(n,c,f){this.z=n,this.x=c,this.y=f,this.key=Ic(0,n,n,c,f)}equals(n){return this.z===n.z&&this.x===n.x&&this.y===n.y}url(n,c){const f=function(x,E,M){var I=Tf(256*x,256*(E=Math.pow(2,M)-E-1),M),P=Tf(256*(x+1),256*(E+1),M);return I[0]+","+I[1]+","+P[0]+","+P[1]}(this.x,this.y,this.z),m=function(x,E,M){let I,P="";for(let z=x;z>0;z--)I=1<<z-1,P+=(E&I?1:0)+(M&I?2:0);return P}(this.z,this.x,this.y);return n[(this.x+this.y)%n.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(c==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",m).replace("{bbox-epsg-3857}",f)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Sf{constructor(n,c){this.wrap=n,this.canonical=c,this.key=Ic(n,c.z,c.z,c.x,c.y)}}class qn{constructor(n,c,f,m,x){this.overscaledZ=n,this.wrap=c,this.canonical=new Lu(f,+m,+x),this.key=c===0&&n===f?this.canonical.key:Ic(c,n,f,m,x)}equals(n){return this.overscaledZ===n.overscaledZ&&this.wrap===n.wrap&&this.canonical.equals(n.canonical)}scaledTo(n){const c=this.canonical.z-n;return n>this.canonical.z?new qn(n,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new qn(n,this.wrap,n,this.canonical.x>>c,this.canonical.y>>c)}calculateScaledKey(n,c=!0){if(this.overscaledZ===n&&c)return this.key;if(n>this.canonical.z)return Ic(this.wrap*+c,n,this.canonical.z,this.canonical.x,this.canonical.y);{const f=this.canonical.z-n;return Ic(this.wrap*+c,n,n,this.canonical.x>>f,this.canonical.y>>f)}}isChildOf(n){if(n.wrap!==this.wrap)return!1;const c=this.canonical.z-n.canonical.z;return n.overscaledZ===0||n.overscaledZ<this.overscaledZ&&n.canonical.x===this.canonical.x>>c&&n.canonical.y===this.canonical.y>>c}children(n){if(this.overscaledZ>=n)return[new qn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const c=this.canonical.z+1,f=2*this.canonical.x,m=2*this.canonical.y;return[new qn(c,this.wrap,c,f,m),new qn(c,this.wrap,c,f+1,m),new qn(c,this.wrap,c,f,m+1),new qn(c,this.wrap,c,f+1,m+1)]}isLessThan(n){return this.wrap<n.wrap||!(this.wrap>n.wrap)&&(this.overscaledZ<n.overscaledZ||!(this.overscaledZ>n.overscaledZ)&&(this.canonical.x<n.canonical.x||!(this.canonical.x>n.canonical.x)&&this.canonical.y<n.canonical.y))}wrapped(){return new qn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(n){return new qn(this.overscaledZ,n,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Sf(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Ic(l,n,c,f,m){const x=1<<Math.min(c,22);let E=x*(m%x)+f%x;return l&&c<22&&(E+=x*x*((l<0?-2*l-1:2*l)%(1<<2*(22-c)))),16*(32*E+c)+(n-c)}Ti(Lu,"CanonicalTileID"),Ti(qn,"OverscaledTileID",{omit:["projMatrix"]});class Fl extends W{constructor(n,c,f){super(n,c),this.z=f}}function kc(l,n){return l.x*n.x+l.y*n.y}function Mf(l,n){if(l.length===1){let c=0;const f=n[c++];let m;for(;!m||f.equals(m);)if(m=n[c++],!m)return 1/0;for(;c<n.length;c++){const x=n[c],E=l[0],M=m.sub(f),I=x.sub(f),P=E.sub(f),z=kc(M,M),N=kc(M,I),q=kc(I,I),K=kc(P,M),ee=kc(P,I),oe=z*q-N*N,pe=(q*K-N*ee)/oe,Ee=(z*ee-N*K)/oe,Re=f.z*(1-pe-Ee)+m.z*pe+x.z*Ee;if(isFinite(Re))return Re}return 1/0}{let c=1/0;for(const f of n)c=Math.min(c,f.z);return c}}function Af(l,n,c,f,m,x,E,M){const I=E*m.getElevationAt(l,n,!0,!0),P=x[0]!==0,z=P?x[1]===0?E*(x[0]/7-450):E*function(N,q,K){const ee=Math.floor(q[0]/8),oe=Math.floor(q[1]/8),pe=10*(q[0]-8*ee),Ee=10*(q[1]-8*oe),Re=N.getElevationAt(ee,oe,!0,!0),be=N.getMeterToDEM(K),De=Math.floor(.5*(pe*be-1)),ze=Math.floor(.5*(Ee*be-1)),Le=N.tileCoordToPixel(ee,oe),st=2*De+1,it=2*ze+1,wt=function(Zt,pt,oi,Vi,pi){return[Zt.getElevationAtPixel(pt,oi,!0),Zt.getElevationAtPixel(pt+pi,oi,!0),Zt.getElevationAtPixel(pt,oi+pi,!0),Zt.getElevationAtPixel(pt+Vi,oi+pi,!0)]}(N,Le.x-De,Le.y-ze,st,it),Gt=Math.abs(wt[0]-wt[1]),ft=Math.abs(wt[2]-wt[3]),kt=Math.abs(wt[0]-wt[2])+Math.abs(wt[1]-wt[3]),Rt=Math.min(.25,.5*be*(Gt+ft)/st),Ft=Math.min(.25,.5*be*kt/it);return Re+Math.max(Rt*pe,Ft*Ee)}(m,x,M):I;return{base:I+(c===0)?-1:c,top:P?Math.max(z+f,I+c+2):I+f}}const tg=Oi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:ig}=tg,rg=Oi([{name:"a_packed",components:4,type:"Float32"}]),{members:ng}=rg,og=Ru.types,ag=Math.cos(Math.PI/180*37.5);class $u{constructor(n){this.zoom=n.zoom,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(c=>c.id),this.index=n.index,this.projection=n.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(c=>{this.gradients[c.id]={}}),this.layoutVertexArray=new Dr,this.layoutVertexArray2=new Ar,this.indexArray=new Dn,this.programConfigurations=new Ws(n.layers,n.zoom),this.segments=new ln,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(n,c,f,m){this.hasPattern=Dh("line",this.layers,c);const x=this.layers[0].layout.get("line-sort-key"),E=[];for(const{feature:z,id:N,index:q,sourceLayerIndex:K}of n){const ee=this.layers[0]._featureFilter.needGeometry,oe=il(z,ee);if(!this.layers[0]._featureFilter.filter(new Je(this.zoom),oe,f))continue;const pe=x?x.evaluate(oe,{},f):void 0,Ee={id:N,properties:z.properties,type:z.type,sourceLayerIndex:K,index:q,geometry:ee?oe.geometry:qa(z,f,m),patterns:{},sortKey:pe};E.push(Ee)}x&&E.sort((z,N)=>z.sortKey-N.sortKey);const{lineAtlas:M,featureIndex:I}=c,P=this.addConstantDashes(M);for(const z of E){const{geometry:N,index:q,sourceLayerIndex:K}=z;if(P&&this.addFeatureDashes(z,M),this.hasPattern){const ee=Rh("line",this.layers,z,this.zoom,c);this.patternFeatures.push(ee)}else this.addFeature(z,N,q,f,M.positions,c.availableImages);I.insert(n[q].feature,N,q,K,this.index)}}addConstantDashes(n){let c=!1;for(const f of this.layers){const m=f.paint.get("line-dasharray").value,x=f.layout.get("line-cap").value;if(m.kind!=="constant"||x.kind!=="constant")c=!0;else{const E=x.value,M=m.value;if(!M)continue;n.addDash(M,E)}}return c}addFeatureDashes(n,c){const f=this.zoom;for(const m of this.layers){const x=m.paint.get("line-dasharray").value,E=m.layout.get("line-cap").value;if(x.kind==="constant"&&E.kind==="constant")continue;let M,I;if(x.kind==="constant"){if(M=x.value,!M)continue}else M=x.evaluate({zoom:f},n);I=E.kind==="constant"?E.value:E.evaluate({zoom:f},n),c.addDash(M,I),n.patterns[m.id]=c.getKey(M,I)}}update(n,c,f,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(n,c,this.stateDependentLayers,f,m)}addFeatures(n,c,f,m,x){for(const E of this.patternFeatures)this.addFeature(E,E.geometry,E.index,c,f,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(n){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=n.createVertexBuffer(this.layoutVertexArray2,ng)),this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,ig),this.indexBuffer=n.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(n),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(n){if(n.properties&&n.properties.hasOwnProperty("mapbox_clip_start")&&n.properties.hasOwnProperty("mapbox_clip_end"))return{start:+n.properties.mapbox_clip_start,end:+n.properties.mapbox_clip_end}}addFeature(n,c,f,m,x,E){const M=this.layers[0].layout,I=M.get("line-join").evaluate(n,{}),P=M.get("line-cap").evaluate(n,{}),z=M.get("line-miter-limit"),N=M.get("line-round-limit");this.lineClips=this.lineFeatureClips(n);for(const q of c)this.addLine(q,n,I,P,z,N);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,f,x,E,m)}addLine(n,c,f,m,x,E){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Ee=0;Ee<n.length-1;Ee++)this.totalDistance+=n[Ee].dist(n[Ee+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const M=og[c.type]==="Polygon";let I=n.length;for(;I>=2&&n[I-1].equals(n[I-2]);)I--;let P=0;for(;P<I-1&&n[P].equals(n[P+1]);)P++;if(I<(M?3:2))return;f==="bevel"&&(x=1.05);const z=this.overscaling<=16?122880/(512*this.overscaling):0,N=this.segments.prepareSegment(10*I,this.layoutVertexArray,this.indexArray);let q,K,ee,oe,pe;this.e1=this.e2=-1,M&&(q=n[I-2],pe=n[P].sub(q)._unit()._perp());for(let Ee=P;Ee<I;Ee++){if(ee=Ee===I-1?M?n[P+1]:void 0:n[Ee+1],ee&&n[Ee].equals(ee))continue;pe&&(oe=pe),q&&(K=q),q=n[Ee],pe=ee?ee.sub(q)._unit()._perp():oe,oe=oe||pe;let Re=oe.add(pe);Re.x===0&&Re.y===0||Re._unit();const be=oe.x*pe.x+oe.y*pe.y,De=Re.x*pe.x+Re.y*pe.y,ze=De!==0?1/De:1/0,Le=2*Math.sqrt(2-2*De),st=De<ag&&K&&ee,it=oe.x*pe.y-oe.y*pe.x>0;if(st&&Ee>P){const ft=q.dist(K);if(ft>2*z){const kt=q.sub(q.sub(K)._mult(z/ft)._round());this.updateDistance(K,kt),this.addCurrentVertex(kt,oe,0,0,N),K=kt}}const wt=K&&ee;let Gt=wt?f:M?"butt":m;if(wt&&Gt==="round"&&(ze<E?Gt="miter":ze<=2&&(Gt="fakeround")),Gt==="miter"&&ze>x&&(Gt="bevel"),Gt==="bevel"&&(ze>2&&(Gt="flipbevel"),ze<x&&(Gt="miter")),K&&this.updateDistance(K,q),Gt==="miter")Re._mult(ze),this.addCurrentVertex(q,Re,0,0,N);else if(Gt==="flipbevel"){if(ze>100)Re=pe.mult(-1);else{const ft=ze*oe.add(pe).mag()/oe.sub(pe).mag();Re._perp()._mult(ft*(it?-1:1))}this.addCurrentVertex(q,Re,0,0,N),this.addCurrentVertex(q,Re.mult(-1),0,0,N)}else if(Gt==="bevel"||Gt==="fakeround"){const ft=-Math.sqrt(ze*ze-1),kt=it?ft:0,Rt=it?0:ft;if(K&&this.addCurrentVertex(q,oe,kt,Rt,N),Gt==="fakeround"){const Ft=Math.round(180*Le/Math.PI/20);for(let Zt=1;Zt<Ft;Zt++){let pt=Zt/Ft;if(pt!==.5){const Vi=pt-.5;pt+=pt*Vi*(pt-1)*((1.0904+be*(be*(3.55645-1.43519*be)-3.2452))*Vi*Vi+(.848013+be*(.215638*be-1.06021)))}const oi=pe.sub(oe)._mult(pt)._add(oe)._unit()._mult(it?-1:1);this.addHalfVertex(q,oi.x,oi.y,!1,it,0,N)}}ee&&this.addCurrentVertex(q,pe,-kt,-Rt,N)}else if(Gt==="butt")this.addCurrentVertex(q,Re,0,0,N);else if(Gt==="square"){const ft=K?1:-1;K||this.addCurrentVertex(q,Re,ft,ft,N),this.addCurrentVertex(q,Re,0,0,N),K&&this.addCurrentVertex(q,Re,ft,ft,N)}else Gt==="round"&&(K&&(this.addCurrentVertex(q,oe,0,0,N),this.addCurrentVertex(q,oe,1,1,N,!0)),ee&&(this.addCurrentVertex(q,pe,-1,-1,N,!0),this.addCurrentVertex(q,pe,0,0,N)));if(st&&Ee<I-1){const ft=q.dist(ee);if(ft>2*z){const kt=q.add(ee.sub(q)._mult(z/ft)._round());this.updateDistance(q,kt),this.addCurrentVertex(kt,pe,0,0,N),q=kt}}}}addCurrentVertex(n,c,f,m,x,E=!1){const M=c.y*m-c.x,I=-c.y-c.x*m;this.addHalfVertex(n,c.x+c.y*f,c.y-c.x*f,E,!1,f,x),this.addHalfVertex(n,M,I,E,!0,-m,x)}addHalfVertex({x:n,y:c},f,m,x,E,M,I){this.layoutVertexArray.emplaceBack((n<<1)+(x?1:0),(c<<1)+(E?1:0),Math.round(63*f)+128,Math.round(63*m)+128,1+(M===0?0:M<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const P=I.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,P),I.primitiveLength++),E?this.e2=P:this.e1=P}updateScaledDistance(){if(this.lineClips){const n=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=n*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(n,c){this.distance+=n.dist(c),this.updateScaledDistance()}}Ti($u,"LineBucket",{omit:["layers","patternFeatures"]});const sg=new jt({"line-cap":new ut(ot.layout_line["line-cap"]),"line-join":new ut(ot.layout_line["line-join"]),"line-miter-limit":new Ke(ot.layout_line["line-miter-limit"]),"line-round-limit":new Ke(ot.layout_line["line-round-limit"]),"line-sort-key":new ut(ot.layout_line["line-sort-key"])});var Cf={paint:new jt({"line-opacity":new ut(ot.paint_line["line-opacity"]),"line-color":new ut(ot.paint_line["line-color"]),"line-translate":new Ke(ot.paint_line["line-translate"]),"line-translate-anchor":new Ke(ot.paint_line["line-translate-anchor"]),"line-width":new ut(ot.paint_line["line-width"]),"line-gap-width":new ut(ot.paint_line["line-gap-width"]),"line-offset":new ut(ot.paint_line["line-offset"]),"line-blur":new ut(ot.paint_line["line-blur"]),"line-dasharray":new ut(ot.paint_line["line-dasharray"]),"line-pattern":new ut(ot.paint_line["line-pattern"]),"line-gradient":new Lt(ot.paint_line["line-gradient"]),"line-trim-offset":new Ke(ot.paint_line["line-trim-offset"])}),layout:sg};const If=new class extends ut{possiblyEvaluate(l,n){return n=new Je(Math.floor(n.zoom),{now:n.now,fadeDuration:n.fadeDuration,transition:n.transition}),super.possiblyEvaluate(l,n)}evaluate(l,n,c,f){return n=tt({},n,{zoom:Math.floor(n.zoom)}),super.evaluate(l,n,c,f)}}(Cf.paint.properties["line-width"].specification);function kf(l,n){return n>0?n+2*l:l}If.useIntegerZoom=!0;const lg=Oi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),cg=Oi([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),ug=Oi([{name:"a_projected_pos",components:4,type:"Float32"}],4);Oi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const hg=Oi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),dg=Oi([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);Oi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Df=Oi([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),fg=Oi([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Oi([{name:"triangle",components:3,type:"Uint16"}]),Oi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Oi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),Oi([{type:"Float32",name:"offsetX"}]),Oi([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Ln=24;const _a=128;function Lh(l,n){const{expression:c}=n;if(c.kind==="constant")return{kind:"constant",layoutSize:c.evaluate(new Je(l+1))};if(c.kind==="source")return{kind:"source"};{const{zoomStops:f,interpolationType:m}=c;let x=0;for(;x<f.length&&f[x]<=l;)x++;x=Math.max(0,x-1);let E=x;for(;E<f.length&&f[E]<l+1;)E++;E=Math.min(f.length-1,E);const M=f[x],I=f[E];return c.kind==="composite"?{kind:"composite",minZoom:M,maxZoom:I,interpolationType:m}:{kind:"camera",minZoom:M,maxZoom:I,minSize:c.evaluate(new Je(M)),maxSize:c.evaluate(new Je(I)),interpolationType:m}}}function Bu(l,{uSize:n,uSizeT:c},{lowerSize:f,upperSize:m}){return l.kind==="source"?f/_a:l.kind==="composite"?Qi(f/_a,m/_a,c):n}function Nl(l,n){let c=0,f=0;if(l.kind==="constant")f=l.layoutSize;else if(l.kind!=="source"){const{interpolationType:m,minZoom:x,maxZoom:E}=l,M=m?Ge(Nn.interpolationFactor(m,n,x,E),0,1):0;l.kind==="camera"?f=Qi(l.minSize,l.maxSize,M):c=M}return{uSizeT:c,uSize:f}}var pg=Object.freeze({__proto__:null,getSizeData:Lh,evaluateSizeForFeature:Bu,evaluateSizeForZoom:Nl,SIZE_PACK_FACTOR:_a});function mg(l,n,c){return l.sections.forEach(f=>{f.text=function(m,x,E){const M=x.layout.get("text-transform").evaluate(E,{});return M==="uppercase"?m=m.toLocaleUpperCase():M==="lowercase"&&(m=m.toLocaleLowerCase()),qe.applyArabicShaping&&(m=qe.applyArabicShaping(m)),m}(f.text,n,c)}),l}const Dc={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function gg(l){return l==="︶"||l==="﹈"||l==="︸"||l==="﹄"||l==="﹂"||l==="︾"||l==="︼"||l==="︺"||l==="︘"||l==="﹀"||l==="︐"||l==="︓"||l==="︔"||l==="｀"||l==="￣"||l==="︑"||l==="︒"}function _g(l){return l==="︵"||l==="﹇"||l==="︷"||l==="﹃"||l==="﹁"||l==="︽"||l==="︻"||l==="︹"||l==="︗"||l==="︿"}var Rc=Rr,Rf=function(l,n,c,f,m){var x,E,M=8*m-f-1,I=(1<<M)-1,P=I>>1,z=-7,N=c?m-1:0,q=c?-1:1,K=l[n+N];for(N+=q,x=K&(1<<-z)-1,K>>=-z,z+=M;z>0;x=256*x+l[n+N],N+=q,z-=8);for(E=x&(1<<-z)-1,x>>=-z,z+=f;z>0;E=256*E+l[n+N],N+=q,z-=8);if(x===0)x=1-P;else{if(x===I)return E?NaN:1/0*(K?-1:1);E+=Math.pow(2,f),x-=P}return(K?-1:1)*E*Math.pow(2,x-f)},Pf=function(l,n,c,f,m,x){var E,M,I,P=8*x-m-1,z=(1<<P)-1,N=z>>1,q=m===23?Math.pow(2,-24)-Math.pow(2,-77):0,K=f?0:x-1,ee=f?1:-1,oe=n<0||n===0&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(M=isNaN(n)?1:0,E=z):(E=Math.floor(Math.log(n)/Math.LN2),n*(I=Math.pow(2,-E))<1&&(E--,I*=2),(n+=E+N>=1?q/I:q*Math.pow(2,1-N))*I>=2&&(E++,I/=2),E+N>=z?(M=0,E=z):E+N>=1?(M=(n*I-1)*Math.pow(2,m),E+=N):(M=n*Math.pow(2,N-1)*Math.pow(2,m),E=0));m>=8;l[c+K]=255&M,K+=ee,M/=256,m-=8);for(E=E<<m|M,P+=m;P>0;l[c+K]=255&E,K+=ee,E/=256,P-=8);l[c+K-ee]|=128*oe};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function Rr(l){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(l)?l:new Uint8Array(l||0),this.pos=0,this.type=0,this.length=this.buf.length}Rr.Varint=0,Rr.Fixed64=1,Rr.Bytes=2,Rr.Fixed32=5;var $h=4294967296,Lf=1/$h,$f=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function Za(l){return l.type===Rr.Bytes?l.readVarint()+l.pos:l.pos+1}function Ul(l,n,c){return c?4294967296*n+(l>>>0):4294967296*(n>>>0)+(l>>>0)}function Bf(l,n,c){var f=n<=16383?1:n<=2097151?2:n<=268435455?3:Math.floor(Math.log(n)/(7*Math.LN2));c.realloc(f);for(var m=c.pos-1;m>=l;m--)c.buf[m+f]=c.buf[m]}function yg(l,n){for(var c=0;c<l.length;c++)n.writeVarint(l[c])}function vg(l,n){for(var c=0;c<l.length;c++)n.writeSVarint(l[c])}function xg(l,n){for(var c=0;c<l.length;c++)n.writeFloat(l[c])}function bg(l,n){for(var c=0;c<l.length;c++)n.writeDouble(l[c])}function wg(l,n){for(var c=0;c<l.length;c++)n.writeBoolean(l[c])}function Eg(l,n){for(var c=0;c<l.length;c++)n.writeFixed32(l[c])}function Tg(l,n){for(var c=0;c<l.length;c++)n.writeSFixed32(l[c])}function Sg(l,n){for(var c=0;c<l.length;c++)n.writeFixed64(l[c])}function Mg(l,n){for(var c=0;c<l.length;c++)n.writeSFixed64(l[c])}function Ou(l,n){return(l[n]|l[n+1]<<8|l[n+2]<<16)+16777216*l[n+3]}function Vl(l,n,c){l[c]=n,l[c+1]=n>>>8,l[c+2]=n>>>16,l[c+3]=n>>>24}function Of(l,n){return(l[n]|l[n+1]<<8|l[n+2]<<16)+(l[n+3]<<24)}function Ag(l,n,c){n.glyphs=[],l===1&&c.readMessage(Cg,n)}function Cg(l,n,c){if(l===3){const{id:f,bitmap:m,width:x,height:E,left:M,top:I,advance:P}=c.readMessage(Ig,{});n.glyphs.push({id:f,bitmap:new Ga({width:x+6,height:E+6},m),metrics:{width:x,height:E,left:M,top:I,advance:P}})}else l===4?n.ascender=c.readSVarint():l===5&&(n.descender=c.readSVarint())}function Ig(l,n,c){l===1?n.id=c.readVarint():l===2?n.bitmap=c.readBytes():l===3?n.width=c.readVarint():l===4?n.height=c.readVarint():l===5?n.left=c.readSVarint():l===6?n.top=c.readSVarint():l===7&&(n.advance=c.readVarint())}function Bh(l){let n=0,c=0;for(const E of l)n+=E.w*E.h,c=Math.max(c,E.w);l.sort((E,M)=>M.h-E.h);const f=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(n/.95)),c),h:1/0}];let m=0,x=0;for(const E of l)for(let M=f.length-1;M>=0;M--){const I=f[M];if(!(E.w>I.w||E.h>I.h)){if(E.x=I.x,E.y=I.y,x=Math.max(x,E.y+E.h),m=Math.max(m,E.x+E.w),E.w===I.w&&E.h===I.h){const P=f.pop();M<f.length&&(f[M]=P)}else E.h===I.h?(I.x+=E.w,I.w-=E.w):E.w===I.w?(I.y+=E.h,I.h-=E.h):(f.push({x:I.x+E.w,y:I.y,w:I.w-E.w,h:E.h}),I.y+=E.h,I.h-=E.h);break}}return{w:m,h:x,fill:n/(m*x)||0}}Rr.prototype={destroy:function(){this.buf=null},readFields:function(l,n,c){for(c=c||this.length;this.pos<c;){var f=this.readVarint(),m=f>>3,x=this.pos;this.type=7&f,l(m,n,this),this.pos===x&&this.skip(f)}return n},readMessage:function(l,n){return this.readFields(l,n,this.readVarint()+this.pos)},readFixed32:function(){var l=Ou(this.buf,this.pos);return this.pos+=4,l},readSFixed32:function(){var l=Of(this.buf,this.pos);return this.pos+=4,l},readFixed64:function(){var l=Ou(this.buf,this.pos)+Ou(this.buf,this.pos+4)*$h;return this.pos+=8,l},readSFixed64:function(){var l=Ou(this.buf,this.pos)+Of(this.buf,this.pos+4)*$h;return this.pos+=8,l},readFloat:function(){var l=Rf(this.buf,this.pos,!0,23,4);return this.pos+=4,l},readDouble:function(){var l=Rf(this.buf,this.pos,!0,52,8);return this.pos+=8,l},readVarint:function(l){var n,c,f=this.buf;return n=127&(c=f[this.pos++]),c<128?n:(n|=(127&(c=f[this.pos++]))<<7,c<128?n:(n|=(127&(c=f[this.pos++]))<<14,c<128?n:(n|=(127&(c=f[this.pos++]))<<21,c<128?n:function(m,x,E){var M,I,P=E.buf;if(M=(112&(I=P[E.pos++]))>>4,I<128||(M|=(127&(I=P[E.pos++]))<<3,I<128)||(M|=(127&(I=P[E.pos++]))<<10,I<128)||(M|=(127&(I=P[E.pos++]))<<17,I<128)||(M|=(127&(I=P[E.pos++]))<<24,I<128)||(M|=(1&(I=P[E.pos++]))<<31,I<128))return Ul(m,M,x);throw new Error("Expected varint not more than 10 bytes")}(n|=(15&(c=f[this.pos]))<<28,l,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var l=this.readVarint();return l%2==1?(l+1)/-2:l/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var l=this.readVarint()+this.pos,n=this.pos;return this.pos=l,l-n>=12&&$f?function(c,f,m){return $f.decode(c.subarray(f,m))}(this.buf,n,l):function(c,f,m){for(var x="",E=f;E<m;){var M,I,P,z=c[E],N=null,q=z>239?4:z>223?3:z>191?2:1;if(E+q>m)break;q===1?z<128&&(N=z):q===2?(192&(M=c[E+1]))==128&&(N=(31&z)<<6|63&M)<=127&&(N=null):q===3?(I=c[E+2],(192&(M=c[E+1]))==128&&(192&I)==128&&((N=(15&z)<<12|(63&M)<<6|63&I)<=2047||N>=55296&&N<=57343)&&(N=null)):q===4&&(I=c[E+2],P=c[E+3],(192&(M=c[E+1]))==128&&(192&I)==128&&(192&P)==128&&((N=(15&z)<<18|(63&M)<<12|(63&I)<<6|63&P)<=65535||N>=1114112)&&(N=null)),N===null?(N=65533,q=1):N>65535&&(N-=65536,x+=String.fromCharCode(N>>>10&1023|55296),N=56320|1023&N),x+=String.fromCharCode(N),E+=q}return x}(this.buf,n,l)},readBytes:function(){var l=this.readVarint()+this.pos,n=this.buf.subarray(this.pos,l);return this.pos=l,n},readPackedVarint:function(l,n){if(this.type!==Rr.Bytes)return l.push(this.readVarint(n));var c=Za(this);for(l=l||[];this.pos<c;)l.push(this.readVarint(n));return l},readPackedSVarint:function(l){if(this.type!==Rr.Bytes)return l.push(this.readSVarint());var n=Za(this);for(l=l||[];this.pos<n;)l.push(this.readSVarint());return l},readPackedBoolean:function(l){if(this.type!==Rr.Bytes)return l.push(this.readBoolean());var n=Za(this);for(l=l||[];this.pos<n;)l.push(this.readBoolean());return l},readPackedFloat:function(l){if(this.type!==Rr.Bytes)return l.push(this.readFloat());var n=Za(this);for(l=l||[];this.pos<n;)l.push(this.readFloat());return l},readPackedDouble:function(l){if(this.type!==Rr.Bytes)return l.push(this.readDouble());var n=Za(this);for(l=l||[];this.pos<n;)l.push(this.readDouble());return l},readPackedFixed32:function(l){if(this.type!==Rr.Bytes)return l.push(this.readFixed32());var n=Za(this);for(l=l||[];this.pos<n;)l.push(this.readFixed32());return l},readPackedSFixed32:function(l){if(this.type!==Rr.Bytes)return l.push(this.readSFixed32());var n=Za(this);for(l=l||[];this.pos<n;)l.push(this.readSFixed32());return l},readPackedFixed64:function(l){if(this.type!==Rr.Bytes)return l.push(this.readFixed64());var n=Za(this);for(l=l||[];this.pos<n;)l.push(this.readFixed64());return l},readPackedSFixed64:function(l){if(this.type!==Rr.Bytes)return l.push(this.readSFixed64());var n=Za(this);for(l=l||[];this.pos<n;)l.push(this.readSFixed64());return l},skip:function(l){var n=7&l;if(n===Rr.Varint)for(;this.buf[this.pos++]>127;);else if(n===Rr.Bytes)this.pos=this.readVarint()+this.pos;else if(n===Rr.Fixed32)this.pos+=4;else{if(n!==Rr.Fixed64)throw new Error("Unimplemented type: "+n);this.pos+=8}},writeTag:function(l,n){this.writeVarint(l<<3|n)},realloc:function(l){for(var n=this.length||16;n<this.pos+l;)n*=2;if(n!==this.length){var c=new Uint8Array(n);c.set(this.buf),this.buf=c,this.length=n}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(l){this.realloc(4),Vl(this.buf,l,this.pos),this.pos+=4},writeSFixed32:function(l){this.realloc(4),Vl(this.buf,l,this.pos),this.pos+=4},writeFixed64:function(l){this.realloc(8),Vl(this.buf,-1&l,this.pos),Vl(this.buf,Math.floor(l*Lf),this.pos+4),this.pos+=8},writeSFixed64:function(l){this.realloc(8),Vl(this.buf,-1&l,this.pos),Vl(this.buf,Math.floor(l*Lf),this.pos+4),this.pos+=8},writeVarint:function(l){(l=+l||0)>268435455||l<0?function(n,c){var f,m;if(n>=0?(f=n%4294967296|0,m=n/4294967296|0):(m=~(-n/4294967296),4294967295^(f=~(-n%4294967296))?f=f+1|0:(f=0,m=m+1|0)),n>=18446744073709552e3||n<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");c.realloc(10),function(x,E,M){M.buf[M.pos++]=127&x|128,x>>>=7,M.buf[M.pos++]=127&x|128,x>>>=7,M.buf[M.pos++]=127&x|128,x>>>=7,M.buf[M.pos++]=127&x|128,M.buf[M.pos]=127&(x>>>=7)}(f,0,c),function(x,E){var M=(7&x)<<4;E.buf[E.pos++]|=M|((x>>>=3)?128:0),x&&(E.buf[E.pos++]=127&x|((x>>>=7)?128:0),x&&(E.buf[E.pos++]=127&x|((x>>>=7)?128:0),x&&(E.buf[E.pos++]=127&x|((x>>>=7)?128:0),x&&(E.buf[E.pos++]=127&x|((x>>>=7)?128:0),x&&(E.buf[E.pos++]=127&x)))))}(m,c)}(l,this):(this.realloc(4),this.buf[this.pos++]=127&l|(l>127?128:0),l<=127||(this.buf[this.pos++]=127&(l>>>=7)|(l>127?128:0),l<=127||(this.buf[this.pos++]=127&(l>>>=7)|(l>127?128:0),l<=127||(this.buf[this.pos++]=l>>>7&127))))},writeSVarint:function(l){this.writeVarint(l<0?2*-l-1:2*l)},writeBoolean:function(l){this.writeVarint(!!l)},writeString:function(l){l=String(l),this.realloc(4*l.length),this.pos++;var n=this.pos;this.pos=function(f,m,x){for(var E,M,I=0;I<m.length;I++){if((E=m.charCodeAt(I))>55295&&E<57344){if(!M){E>56319||I+1===m.length?(f[x++]=239,f[x++]=191,f[x++]=189):M=E;continue}if(E<56320){f[x++]=239,f[x++]=191,f[x++]=189,M=E;continue}E=M-55296<<10|E-56320|65536,M=null}else M&&(f[x++]=239,f[x++]=191,f[x++]=189,M=null);E<128?f[x++]=E:(E<2048?f[x++]=E>>6|192:(E<65536?f[x++]=E>>12|224:(f[x++]=E>>18|240,f[x++]=E>>12&63|128),f[x++]=E>>6&63|128),f[x++]=63&E|128)}return x}(this.buf,l,this.pos);var c=this.pos-n;c>=128&&Bf(n,c,this),this.pos=n-1,this.writeVarint(c),this.pos+=c},writeFloat:function(l){this.realloc(4),Pf(this.buf,l,this.pos,!0,23,4),this.pos+=4},writeDouble:function(l){this.realloc(8),Pf(this.buf,l,this.pos,!0,52,8),this.pos+=8},writeBytes:function(l){var n=l.length;this.writeVarint(n),this.realloc(n);for(var c=0;c<n;c++)this.buf[this.pos++]=l[c]},writeRawMessage:function(l,n){this.pos++;var c=this.pos;l(n,this);var f=this.pos-c;f>=128&&Bf(c,f,this),this.pos=c-1,this.writeVarint(f),this.pos+=f},writeMessage:function(l,n,c){this.writeTag(l,Rr.Bytes),this.writeRawMessage(n,c)},writePackedVarint:function(l,n){n.length&&this.writeMessage(l,yg,n)},writePackedSVarint:function(l,n){n.length&&this.writeMessage(l,vg,n)},writePackedBoolean:function(l,n){n.length&&this.writeMessage(l,wg,n)},writePackedFloat:function(l,n){n.length&&this.writeMessage(l,xg,n)},writePackedDouble:function(l,n){n.length&&this.writeMessage(l,bg,n)},writePackedFixed32:function(l,n){n.length&&this.writeMessage(l,Eg,n)},writePackedSFixed32:function(l,n){n.length&&this.writeMessage(l,Tg,n)},writePackedFixed64:function(l,n){n.length&&this.writeMessage(l,Sg,n)},writePackedSFixed64:function(l,n){n.length&&this.writeMessage(l,Mg,n)},writeBytesField:function(l,n){this.writeTag(l,Rr.Bytes),this.writeBytes(n)},writeFixed32Field:function(l,n){this.writeTag(l,Rr.Fixed32),this.writeFixed32(n)},writeSFixed32Field:function(l,n){this.writeTag(l,Rr.Fixed32),this.writeSFixed32(n)},writeFixed64Field:function(l,n){this.writeTag(l,Rr.Fixed64),this.writeFixed64(n)},writeSFixed64Field:function(l,n){this.writeTag(l,Rr.Fixed64),this.writeSFixed64(n)},writeVarintField:function(l,n){this.writeTag(l,Rr.Varint),this.writeVarint(n)},writeSVarintField:function(l,n){this.writeTag(l,Rr.Varint),this.writeSVarint(n)},writeStringField:function(l,n){this.writeTag(l,Rr.Bytes),this.writeString(n)},writeFloatField:function(l,n){this.writeTag(l,Rr.Fixed32),this.writeFloat(n)},writeDoubleField:function(l,n){this.writeTag(l,Rr.Fixed64),this.writeDouble(n)},writeBooleanField:function(l,n){this.writeVarintField(l,!!n)}};class Oh{constructor(n,{pixelRatio:c,version:f,stretchX:m,stretchY:x,content:E}){this.paddedRect=n,this.pixelRatio=c,this.stretchX=m,this.stretchY=x,this.content=E,this.version=f}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class zf{constructor(n,c){const f={},m={};this.haveRenderCallbacks=[];const x=[];this.addImages(n,f,x),this.addImages(c,m,x);const{w:E,h:M}=Bh(x),I=new oo({width:E||1,height:M||1});for(const P in n){const z=n[P],N=f[P].paddedRect;oo.copy(z.data,I,{x:0,y:0},{x:N.x+1,y:N.y+1},z.data)}for(const P in c){const z=c[P],N=m[P].paddedRect,q=N.x+1,K=N.y+1,ee=z.data.width,oe=z.data.height;oo.copy(z.data,I,{x:0,y:0},{x:q,y:K},z.data),oo.copy(z.data,I,{x:0,y:oe-1},{x:q,y:K-1},{width:ee,height:1}),oo.copy(z.data,I,{x:0,y:0},{x:q,y:K+oe},{width:ee,height:1}),oo.copy(z.data,I,{x:ee-1,y:0},{x:q-1,y:K},{width:1,height:oe}),oo.copy(z.data,I,{x:0,y:0},{x:q+ee,y:K},{width:1,height:oe})}this.image=I,this.iconPositions=f,this.patternPositions=m}addImages(n,c,f){for(const m in n){const x=n[m],E={x:0,y:0,w:x.data.width+2,h:x.data.height+2};f.push(E),c[m]=new Oh(E,x),x.hasRenderCallback&&this.haveRenderCallbacks.push(m)}}patchUpdatedImages(n,c){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(f=>n.hasImage(f)),n.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const f in n.updatedImages)this.patchUpdatedImage(this.iconPositions[f],n.getImage(f),c),this.patchUpdatedImage(this.patternPositions[f],n.getImage(f),c)}patchUpdatedImage(n,c,f){if(!n||!c||n.version===c.version)return;n.version=c.version;const[m,x]=n.tl;f.update(c.data,void 0,{x:m,y:x})}}Ti(Oh,"ImagePosition"),Ti(zf,"ImageAtlas");const vo={horizontal:1,vertical:2,horizontalOnly:3};class Pc{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(n,c){const f=new Pc;return f.scale=n||1,f.fontStack=c,f}static forImage(n){const c=new Pc;return c.imageName=n,c}}class jl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(n,c){const f=new jl;for(let m=0;m<n.sections.length;m++){const x=n.sections[m];x.image?f.addImageSection(x):f.addTextSection(x,c)}return f}length(){return this.text.length}getSection(n){return this.sections[this.sectionIndex[n]]}getSections(){return this.sections}getSectionIndex(n){return this.sectionIndex[n]}getCharCode(n){return this.text.charCodeAt(n)}verticalizePunctuation(n){this.text=function(c,f){let m="";for(let x=0;x<c.length;x++){const E=c.charCodeAt(x+1)||null,M=c.charCodeAt(x-1)||null;m+=!f&&(E&&F(E)&&!Dc[c[x+1]]||M&&F(M)&&!Dc[c[x-1]])||!Dc[c[x]]?c[x]:Dc[c[x]]}return m}(this.text,n)}trim(){let n=0;for(let f=0;f<this.text.length&&zu[this.text.charCodeAt(f)];f++)n++;let c=this.text.length;for(let f=this.text.length-1;f>=0&&f>=n&&zu[this.text.charCodeAt(f)];f--)c--;this.text=this.text.substring(n,c),this.sectionIndex=this.sectionIndex.slice(n,c)}substring(n,c){const f=new jl;return f.text=this.text.substring(n,c),f.sectionIndex=this.sectionIndex.slice(n,c),f.sections=this.sections,f}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((n,c)=>Math.max(n,this.sections[c].scale),0)}addTextSection(n,c){this.text+=n.text,this.sections.push(Pc.forText(n.scale,n.fontStack||c));const f=this.sections.length-1;for(let m=0;m<n.text.length;++m)this.sectionIndex.push(f)}addImageSection(n){const c=n.image?n.image.name:"";if(c.length===0)return void vi("Can't add FormattedSection with an empty image.");const f=this.getNextImageSectionCharCode();f?(this.text+=String.fromCharCode(f),this.sections.push(Pc.forImage(c)),this.sectionIndex.push(this.sections.length-1)):vi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function zh(l,n,c,f,m,x,E,M,I,P,z,N,q,K,ee){const oe=jl.fromFeature(l,m);N===vo.vertical&&oe.verticalizePunctuation(q);let pe=[];const Ee=function(Le,st,it,wt,Gt,ft){if(!Le)return[];const kt=[],Rt=function(oi,Vi,pi,ki,ai,qi){let sr=0;for(let or=0;or<oi.length();or++){const ir=oi.getSection(or);sr+=Ff(oi.getCharCode(or),ir,ki,ai,Vi,qi)}return sr/Math.max(1,Math.ceil(sr/pi))}(Le,st,it,wt,Gt,ft),Ft=Le.text.indexOf("​")>=0;let Zt=0;for(let oi=0;oi<Le.length();oi++){const Vi=Le.getSection(oi),pi=Le.getCharCode(oi);if(zu[pi]||(Zt+=Ff(pi,Vi,wt,Gt,st,ft)),oi<Le.length()-1){const ki=!((pt=pi)<11904||!(ou(pt)||Al(pt)||y(pt)||fu(pt)||lu(pt)||nu(pt)||au(pt)||Hs(pt)||cu(pt)||cc(pt)||su(pt)||w(pt)||Ml(pt)||sc(pt)||ac(pt)||lc(pt)||ms(pt)||Xs(pt)||hu(pt)||uu(pt)));(kg[pi]||ki||Vi.imageName)&&kt.push(Uf(oi+1,Zt,Rt,kt,Dg(pi,Le.getCharCode(oi+1),ki&&Ft),!1))}}var pt;return Vf(Uf(Le.length(),Zt,Rt,kt,0,!0))}(oe,P,x,n,f,K),{processBidirectionalText:Re,processStyledBidirectionalText:be}=qe;if(Re&&oe.sections.length===1){const Le=Re(oe.toString(),Ee);for(const st of Le){const it=new jl;it.text=st,it.sections=oe.sections;for(let wt=0;wt<st.length;wt++)it.sectionIndex.push(0);pe.push(it)}}else if(be){const Le=be(oe.text,oe.sectionIndex,Ee);for(const st of Le){const it=new jl;it.text=st[0],it.sectionIndex=st[1],it.sections=oe.sections,pe.push(it)}}else pe=function(Le,st){const it=[],wt=Le.text;let Gt=0;for(const ft of st)it.push(Le.substring(Gt,ft)),Gt=ft;return Gt<wt.length&&it.push(Le.substring(Gt,wt.length)),it}(oe,Ee);const De=[],ze={positionedLines:De,text:oe.toString(),top:z[1],bottom:z[1],left:z[0],right:z[0],writingMode:N,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(Le,st,it,wt,Gt,ft,kt,Rt,Ft,Zt,pt,oi){let Vi=0,pi=0,ki=0;const ai=Rt==="right"?1:Rt==="left"?0:.5;let qi=!1;for(const Wi of Gt){const lr=Wi.getSections();for(const Tr of lr){if(Tr.imageName)continue;const Br=st[Tr.fontStack];if(Br&&(qi=Br.ascender!==void 0&&Br.descender!==void 0,!qi))break}if(!qi)break}let sr=0;for(const Wi of Gt){Wi.trim();const lr=Wi.getMaxScale(),Tr=(lr-1)*Ln,Br={positionedGlyphs:[],lineOffset:0};Le.positionedLines[sr]=Br;const Pr=Br.positionedGlyphs;let Or=0;if(!Wi.length()){pi+=ft,++sr;continue}let Nr=0,Wr=0;for(let wr=0;wr<Wi.length();wr++){const dn=Wi.getSection(wr),un=Wi.getSectionIndex(wr),gr=Wi.getCharCode(wr);let qr=dn.scale,pn=null,Sr=null,rn=null,Fn=Ln,wn=0;const En=!(Ft===vo.horizontal||!pt&&!B(gr)||pt&&(zu[gr]||(or=gr,Zs(or)||ru(or)||oc(or)||Cl(or)||p(or))));if(dn.imageName){const Gn=wt[dn.imageName];if(!Gn)continue;rn=dn.imageName,Le.iconsInText=Le.iconsInText||!0,Sr=Gn.paddedRect;const Tn=Gn.displaySize;qr=qr*Ln/oi,pn={width:Tn[0],height:Tn[1],left:1,top:-3,advance:En?Tn[1]:Tn[0],localGlyph:!1},wn=qi?-pn.height*qr:lr*Ln-17-Tn[1]*qr,Fn=pn.advance;const Xa=(En?Tn[0]:Tn[1])*qr-Ln*lr;Xa>0&&Xa>Or&&(Or=Xa)}else{const Gn=it[dn.fontStack];if(!Gn)continue;Gn[gr]&&(Sr=Gn[gr]);const Tn=st[dn.fontStack];if(!Tn)continue;const Xa=Tn.glyphs[gr];if(!Xa)continue;if(pn=Xa.metrics,Fn=gr!==8203?Ln:0,qi){const Xl=Tn.ascender!==void 0?Math.abs(Tn.ascender):0,Uc=Tn.descender!==void 0?Math.abs(Tn.descender):0,Vc=(Xl+Uc)*qr;Nr<Vc&&(Nr=Vc,Wr=(Xl-Uc)/2*qr),wn=-Xl*qr}else wn=(lr-qr)*Ln-17}En?(Le.verticalizable=!0,Pr.push({glyph:gr,imageName:rn,x:Vi,y:pi+wn,vertical:En,scale:qr,localGlyph:pn.localGlyph,fontStack:dn.fontStack,sectionIndex:un,metrics:pn,rect:Sr}),Vi+=Fn*qr+Zt):(Pr.push({glyph:gr,imageName:rn,x:Vi,y:pi+wn,vertical:En,scale:qr,localGlyph:pn.localGlyph,fontStack:dn.fontStack,sectionIndex:un,metrics:pn,rect:Sr}),Vi+=pn.advance*qr+Zt)}Pr.length!==0&&(ki=Math.max(Vi-Zt,ki),qi?jf(Pr,ai,Or,Wr,ft*lr/2):jf(Pr,ai,Or,0,ft/2)),Vi=0;const bn=ft*lr+Or;Br.lineOffset=Math.max(Or,Tr),pi+=bn,++sr}var or;const ir=pi,{horizontalAlign:Gi,verticalAlign:br}=Fh(kt);(function(Wi,lr,Tr,Br,Pr,Or){const Nr=(lr-Tr)*Pr,Wr=-Or*Br;for(const bn of Wi)for(const wr of bn.positionedGlyphs)wr.x+=Nr,wr.y+=Wr})(Le.positionedLines,ai,Gi,br,ki,ir),Le.top+=-br*ir,Le.bottom=Le.top+ir,Le.left+=-Gi*ki,Le.right=Le.left+ki,Le.hasBaseline=qi}(ze,n,c,f,pe,E,M,I,N,P,q,ee),!function(Le){for(const st of Le)if(st.positionedGlyphs.length!==0)return!1;return!0}(De)&&ze}const zu={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},kg={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Ff(l,n,c,f,m,x){if(n.imageName){const E=f[n.imageName];return E?E.displaySize[0]*n.scale*Ln/x+m:0}{const E=c[n.fontStack],M=E&&E.glyphs[l];return M?M.metrics.advance*n.scale+m:0}}function Nf(l,n,c,f){const m=Math.pow(l-n,2);return f?l<n?m/2:2*m:m+Math.abs(c)*c}function Dg(l,n,c){let f=0;return l===10&&(f-=1e4),c&&(f+=150),l!==40&&l!==65288||(f+=50),n!==41&&n!==65289||(f+=50),f}function Uf(l,n,c,f,m,x){let E=null,M=Nf(n,c,m,x);for(const I of f){const P=Nf(n-I.x,c,m,x)+I.badness;P<=M&&(E=I,M=P)}return{index:l,x:n,priorBreak:E,badness:M}}function Vf(l){return l?Vf(l.priorBreak).concat(l.index):[]}function Fh(l){let n=.5,c=.5;switch(l){case"right":case"top-right":case"bottom-right":n=1;break;case"left":case"top-left":case"bottom-left":n=0}switch(l){case"bottom":case"bottom-right":case"bottom-left":c=1;break;case"top":case"top-right":case"top-left":c=0}return{horizontalAlign:n,verticalAlign:c}}function jf(l,n,c,f,m){if(!(n||c||f||m))return;const x=l.length-1,E=l[x],M=(E.x+E.metrics.advance*E.scale)*n;for(let I=0;I<=x;I++)l[I].x-=M,l[I].y+=c+f+m}function Rg(l,n,c){const{horizontalAlign:f,verticalAlign:m}=Fh(c),x=n[0]-l.displaySize[0]*f,E=n[1]-l.displaySize[1]*m;return{image:l,top:E,bottom:E+l.displaySize[1],left:x,right:x+l.displaySize[0]}}function qf(l,n,c,f,m,x){const E=l.image;let M;if(E.content){const pe=E.content,Ee=E.pixelRatio||1;M=[pe[0]/Ee,pe[1]/Ee,E.displaySize[0]-pe[2]/Ee,E.displaySize[1]-pe[3]/Ee]}const I=n.left*x,P=n.right*x;let z,N,q,K;c==="width"||c==="both"?(K=m[0]+I-f[3],N=m[0]+P+f[1]):(K=m[0]+(I+P-E.displaySize[0])/2,N=K+E.displaySize[0]);const ee=n.top*x,oe=n.bottom*x;return c==="height"||c==="both"?(z=m[1]+ee-f[0],q=m[1]+oe+f[2]):(z=m[1]+(ee+oe-E.displaySize[1])/2,q=z+E.displaySize[1]),{image:E,top:z,right:N,bottom:q,left:K,collisionPadding:M}}class Ha extends W{constructor(n,c,f,m,x){super(n,c),this.angle=m,this.z=f,x!==void 0&&(this.segment=x)}clone(){return new Ha(this.x,this.y,this.z,this.angle,this.segment)}}function Gf(l,n,c,f,m){if(n.segment===void 0)return!0;let x=n,E=n.segment+1,M=0;for(;M>-c/2;){if(E--,E<0)return!1;M-=l[E].dist(x),x=l[E]}M+=l[E].dist(l[E+1]),E++;const I=[];let P=0;for(;M<c/2;){const z=l[E],N=l[E+1];if(!N)return!1;let q=l[E-1].angleTo(z)-z.angleTo(N);for(q=Math.abs((q+3*Math.PI)%(2*Math.PI)-Math.PI),I.push({distance:M,angleDelta:q}),P+=q;M-I[0].distance>f;)P-=I.shift().angleDelta;if(P>m)return!1;E++,M+=z.dist(N)}return!0}function Zf(l){let n=0;for(let c=0;c<l.length-1;c++)n+=l[c].dist(l[c+1]);return n}function Hf(l,n,c){return l?.6*n*c:0}function Xf(l,n){return Math.max(l?l.right-l.left:0,n?n.right-n.left:0)}function Pg(l,n,c,f,m,x){const E=Hf(c,m,x),M=Xf(c,f)*x;let I=0;const P=Zf(l)/2;for(let z=0;z<l.length-1;z++){const N=l[z],q=l[z+1],K=N.dist(q);if(I+K>P){const ee=(P-I)/K,oe=Qi(N.x,q.x,ee),pe=Qi(N.y,q.y,ee),Ee=new Ha(oe,pe,0,q.angleTo(N),z);return!E||Gf(l,Ee,M,E,n)?Ee:void 0}I+=K}}function Lg(l,n,c,f,m,x,E,M,I){const P=Hf(f,x,E),z=Xf(f,m),N=z*E,q=l[0].x===0||l[0].x===I||l[0].y===0||l[0].y===I;return n-N<n/4&&(n=N+n/4),Yf(l,q?n/2*M%n:(z/2+2*x)*E*M%n,n,P,c,N,q,!1,I)}function Yf(l,n,c,f,m,x,E,M,I){const P=x/2,z=Zf(l);let N=0,q=n-c,K=[];for(let ee=0;ee<l.length-1;ee++){const oe=l[ee],pe=l[ee+1],Ee=oe.dist(pe),Re=pe.angleTo(oe);for(;q+c<N+Ee;){q+=c;const be=(q-N)/Ee,De=Qi(oe.x,pe.x,be),ze=Qi(oe.y,pe.y,be);if(De>=0&&De<I&&ze>=0&&ze<I&&q-P>=0&&q+P<=z){const Le=new Ha(De,ze,0,Re,ee);Le._round(),f&&!Gf(l,Le,x,f,m)||K.push(Le)}}N+=Ee}return M||K.length||E||(K=Yf(l,N/2,c,f,m,x,E,!0,I)),K}function Wf(l,n,c,f,m){const x=[];for(let E=0;E<l.length;E++){const M=l[E];let I;for(let P=0;P<M.length-1;P++){let z=M[P],N=M[P+1];z.x<n&&N.x<n||(z.x<n?z=new W(n,z.y+(n-z.x)/(N.x-z.x)*(N.y-z.y))._round():N.x<n&&(N=new W(n,z.y+(n-z.x)/(N.x-z.x)*(N.y-z.y))._round()),z.y<c&&N.y<c||(z.y<c?z=new W(z.x+(c-z.y)/(N.y-z.y)*(N.x-z.x),c)._round():N.y<c&&(N=new W(z.x+(c-z.y)/(N.y-z.y)*(N.x-z.x),c)._round()),z.x>=f&&N.x>=f||(z.x>=f?z=new W(f,z.y+(f-z.x)/(N.x-z.x)*(N.y-z.y))._round():N.x>=f&&(N=new W(f,z.y+(f-z.x)/(N.x-z.x)*(N.y-z.y))._round()),z.y>=m&&N.y>=m||(z.y>=m?z=new W(z.x+(m-z.y)/(N.y-z.y)*(N.x-z.x),m)._round():N.y>=m&&(N=new W(z.x+(m-z.y)/(N.y-z.y)*(N.x-z.x),m)._round()),I&&z.equals(I[I.length-1])||(I=[z],x.push(I)),I.push(N)))))}}return x}Ti(Ha,"Anchor");const Lc=1e20;function Kf(l,n,c,f,m,x,E,M,I){for(let P=n;P<n+f;P++)Qf(l,c*x+P,x,m,E,M,I);for(let P=c;P<c+m;P++)Qf(l,P*x+n,1,f,E,M,I)}function Qf(l,n,c,f,m,x,E){x[0]=0,E[0]=-Lc,E[1]=Lc,m[0]=l[n];for(let M=1,I=0,P=0;M<f;M++){m[M]=l[n+M*c];const z=M*M;do{const N=x[I];P=(m[M]-m[N]+z-N*N)/(M-N)/2}while(P<=E[I]&&--I>-1);I++,x[I]=M,E[I]=P,E[I+1]=Lc}for(let M=0,I=0;M<f;M++){for(;E[I+1]<M;)I++;const P=x[I],z=M-P;l[n+M*c]=m[P]+z*z}}const Nh={none:0,ideographs:1,all:2};class ql{constructor(n,c,f){this.requestManager=n,this.localGlyphMode=c,this.localFontFamily=f,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(n){this.url=n}getGlyphs(n,c){const f=[];for(const m in n)for(const x of n[m])f.push({stack:m,id:x});Ut(f,({stack:m,id:x},E)=>{let M=this.entries[m];M||(M=this.entries[m]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let I=M.glyphs[x];if(I!==void 0)return void E(null,{stack:m,id:x,glyph:I});if(I=this._tinySDF(M,m,x),I)return M.glyphs[x]=I,void E(null,{stack:m,id:x,glyph:I});const P=Math.floor(x/256);if(256*P>65535)return void E(new Error("glyphs > 65535 not supported"));if(M.ranges[P])return void E(null,{stack:m,id:x,glyph:I});let z=M.requests[P];z||(z=M.requests[P]=[],ql.loadGlyphRange(m,P,this.url,this.requestManager,(N,q)=>{if(q){M.ascender=q.ascender,M.descender=q.descender;for(const K in q.glyphs)this._doesCharSupportLocalGlyph(+K)||(M.glyphs[+K]=q.glyphs[+K]);M.ranges[P]=!0}for(const K of z)K(N,q);delete M.requests[P]})),z.push((N,q)=>{N?E(N):q&&E(null,{stack:m,id:x,glyph:q.glyphs[x]||null})})},(m,x)=>{if(m)c(m);else if(x){const E={};for(const{stack:M,id:I,glyph:P}of x)E[M]===void 0&&(E[M]={}),E[M].glyphs===void 0&&(E[M].glyphs={}),E[M].glyphs[I]=P&&{id:P.id,bitmap:P.bitmap.clone(),metrics:P.metrics},E[M].ascender=this.entries[M].ascender,E[M].descender=this.entries[M].descender;c(null,E)}})}_doesCharSupportLocalGlyph(n){return this.localGlyphMode!==Nh.none&&(this.localGlyphMode===Nh.all?!!this.localFontFamily:!!this.localFontFamily&&(cc(n)||du(n)||Ml(n)||ms(n)||Hs(n)))}_tinySDF(n,c,f){const m=this.localFontFamily;if(!m||!this._doesCharSupportLocalGlyph(f))return;let x=n.tinySDF;if(!x){let oe="400";/bold/i.test(c)?oe="900":/medium/i.test(c)?oe="500":/light/i.test(c)&&(oe="200"),x=n.tinySDF=new ql.TinySDF({fontFamily:m,fontWeight:oe,fontSize:48,buffer:6,radius:16}),x.fontWeight=oe}if(this.localGlyphs[x.fontWeight][f])return this.localGlyphs[x.fontWeight][f];const E=String.fromCharCode(f),{data:M,width:I,height:P,glyphWidth:z,glyphHeight:N,glyphLeft:q,glyphTop:K,glyphAdvance:ee}=x.draw(E);return this.localGlyphs[x.fontWeight][f]={id:f,bitmap:new Ga({width:I,height:P},M),metrics:{width:z/2,height:N/2,left:q/2,top:K/2-27,advance:ee/2,localGlyph:!0}}}}function Jf(l,n,c,f){const m=[],x=l.image,E=x.pixelRatio,M=x.paddedRect.w-2,I=x.paddedRect.h-2,P=l.right-l.left,z=l.bottom-l.top,N=x.stretchX||[[0,M]],q=x.stretchY||[[0,I]],K=(ft,kt)=>ft+kt[1]-kt[0],ee=N.reduce(K,0),oe=q.reduce(K,0),pe=M-ee,Ee=I-oe;let Re=0,be=ee,De=0,ze=oe,Le=0,st=pe,it=0,wt=Ee;if(x.content&&f){const ft=x.content;Re=Fu(N,0,ft[0]),De=Fu(q,0,ft[1]),be=Fu(N,ft[0],ft[2]),ze=Fu(q,ft[1],ft[3]),Le=ft[0]-Re,it=ft[1]-De,st=ft[2]-ft[0]-be,wt=ft[3]-ft[1]-ze}const Gt=(ft,kt,Rt,Ft)=>{const Zt=Nu(ft.stretch-Re,be,P,l.left),pt=Uu(ft.fixed-Le,st,ft.stretch,ee),oi=Nu(kt.stretch-De,ze,z,l.top),Vi=Uu(kt.fixed-it,wt,kt.stretch,oe),pi=Nu(Rt.stretch-Re,be,P,l.left),ki=Uu(Rt.fixed-Le,st,Rt.stretch,ee),ai=Nu(Ft.stretch-De,ze,z,l.top),qi=Uu(Ft.fixed-it,wt,Ft.stretch,oe),sr=new W(Zt,oi),or=new W(pi,oi),ir=new W(pi,ai),Gi=new W(Zt,ai),br=new W(pt/E,Vi/E),Wi=new W(ki/E,qi/E),lr=n*Math.PI/180;if(lr){const Pr=Math.sin(lr),Or=Math.cos(lr),Nr=[Or,-Pr,Pr,Or];sr._matMult(Nr),or._matMult(Nr),Gi._matMult(Nr),ir._matMult(Nr)}const Tr=ft.stretch+ft.fixed,Br=kt.stretch+kt.fixed;return{tl:sr,tr:or,bl:Gi,br:ir,tex:{x:x.paddedRect.x+1+Tr,y:x.paddedRect.y+1+Br,w:Rt.stretch+Rt.fixed-Tr,h:Ft.stretch+Ft.fixed-Br},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:br,pixelOffsetBR:Wi,minFontScaleX:st/E/P,minFontScaleY:wt/E/z,isSDF:c}};if(f&&(x.stretchX||x.stretchY)){const ft=ep(N,pe,ee),kt=ep(q,Ee,oe);for(let Rt=0;Rt<ft.length-1;Rt++){const Ft=ft[Rt],Zt=ft[Rt+1];for(let pt=0;pt<kt.length-1;pt++)m.push(Gt(Ft,kt[pt],Zt,kt[pt+1]))}}else m.push(Gt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:M+1},{fixed:0,stretch:I+1}));return m}function Fu(l,n,c){let f=0;for(const m of l)f+=Math.max(n,Math.min(c,m[1]))-Math.max(n,Math.min(c,m[0]));return f}function ep(l,n,c){const f=[{fixed:-1,stretch:0}];for(const[m,x]of l){const E=f[f.length-1];f.push({fixed:m-E.stretch,stretch:E.stretch}),f.push({fixed:m-E.stretch,stretch:E.stretch+(x-m)})}return f.push({fixed:n+1,stretch:c}),f}function Nu(l,n,c,f){return l/n*c+f}function Uu(l,n,c,f){return l-n*c/f}function $g(l,n,c,f){const m=n+l.positionedLines[f].lineOffset;return f===0?c+m/2:c+(m+(n+l.positionedLines[f-1].lineOffset))/2}ql.loadGlyphRange=function(l,n,c,f,m){const x=256*n,E=x+255,M=f.transformRequest(f.normalizeGlyphsURL(c).replace("{fontstack}",l).replace("{range}",`${x}-${E}`),Ii.Glyphs);zi(M,(I,P)=>{if(I)m(I);else if(P){const z={},N=function(q){return new Rc(q).readFields(Ag,{})}(P);for(const q of N.glyphs)z[q.id]=q;m(null,{glyphs:z,ascender:N.ascender,descender:N.descender})}})},ql.TinySDF=class{constructor({fontSize:l=24,buffer:n=3,radius:c=8,cutoff:f=.25,fontFamily:m="sans-serif",fontWeight:x="normal",fontStyle:E="normal"}={}){this.buffer=n,this.cutoff=f,this.radius=c;const M=this.size=l+4*n,I=this._createCanvas(M),P=this.ctx=I.getContext("2d",{willReadFrequently:!0});P.font=`${E} ${x} ${l}px ${m}`,P.textBaseline="alphabetic",P.textAlign="left",P.fillStyle="black",this.gridOuter=new Float64Array(M*M),this.gridInner=new Float64Array(M*M),this.f=new Float64Array(M),this.z=new Float64Array(M+1),this.v=new Uint16Array(M)}_createCanvas(l){const n=document.createElement("canvas");return n.width=n.height=l,n}draw(l){const{width:n,actualBoundingBoxAscent:c,actualBoundingBoxDescent:f,actualBoundingBoxLeft:m,actualBoundingBoxRight:x}=this.ctx.measureText(l),E=Math.ceil(c),M=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(x-m))),I=Math.min(this.size-this.buffer,E+Math.ceil(f)),P=M+2*this.buffer,z=I+2*this.buffer,N=Math.max(P*z,0),q=new Uint8ClampedArray(N),K={data:q,width:P,height:z,glyphWidth:M,glyphHeight:I,glyphTop:E,glyphLeft:0,glyphAdvance:n};if(M===0||I===0)return K;const{ctx:ee,buffer:oe,gridInner:pe,gridOuter:Ee}=this;ee.clearRect(oe,oe,M,I),ee.fillText(l,oe,oe+E);const Re=ee.getImageData(oe,oe,M,I);Ee.fill(Lc,0,N),pe.fill(0,0,N);for(let be=0;be<I;be++)for(let De=0;De<M;De++){const ze=Re.data[4*(be*M+De)+3]/255;if(ze===0)continue;const Le=(be+oe)*P+De+oe;if(ze===1)Ee[Le]=0,pe[Le]=Lc;else{const st=.5-ze;Ee[Le]=st>0?st*st:0,pe[Le]=st<0?st*st:0}}Kf(Ee,0,0,P,z,P,this.f,this.v,this.z),Kf(pe,oe,oe,M,I,P,this.f,this.v,this.z);for(let be=0;be<N;be++){const De=Math.sqrt(Ee[be])-Math.sqrt(pe[be]);q[be]=Math.round(255-255*(De/this.radius+this.cutoff))}return K}};class Bg{constructor(n=[],c=Og){if(this.data=n,this.length=this.data.length,this.compare=c,this.length>0)for(let f=(this.length>>1)-1;f>=0;f--)this._down(f)}push(n){this.data.push(n),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const n=this.data[0],c=this.data.pop();return this.length--,this.length>0&&(this.data[0]=c,this._down(0)),n}peek(){return this.data[0]}_up(n){const{data:c,compare:f}=this,m=c[n];for(;n>0;){const x=n-1>>1,E=c[x];if(f(m,E)>=0)break;c[n]=E,n=x}c[n]=m}_down(n){const{data:c,compare:f}=this,m=this.length>>1,x=c[n];for(;n<m;){let E=1+(n<<1),M=c[E];const I=E+1;if(I<this.length&&f(c[I],M)<0&&(E=I,M=c[I]),f(M,x)>=0)break;c[n]=M,n=E}c[n]=x}}function Og(l,n){return l<n?-1:l>n?1:0}function zg(l,n=1,c=!1){let f=1/0,m=1/0,x=-1/0,E=-1/0;const M=l[0];for(let K=0;K<M.length;K++){const ee=M[K];(!K||ee.x<f)&&(f=ee.x),(!K||ee.y<m)&&(m=ee.y),(!K||ee.x>x)&&(x=ee.x),(!K||ee.y>E)&&(E=ee.y)}const I=Math.min(x-f,E-m);let P=I/2;const z=new Bg([],Fg);if(I===0)return new W(f,m);for(let K=f;K<x;K+=I)for(let ee=m;ee<E;ee+=I)z.push(new Gl(K+P,ee+P,P,l));let N=function(K){let ee=0,oe=0,pe=0;const Ee=K[0];for(let Re=0,be=Ee.length,De=be-1;Re<be;De=Re++){const ze=Ee[Re],Le=Ee[De],st=ze.x*Le.y-Le.x*ze.y;oe+=(ze.x+Le.x)*st,pe+=(ze.y+Le.y)*st,ee+=3*st}return new Gl(oe/ee,pe/ee,0,K)}(l),q=z.length;for(;z.length;){const K=z.pop();(K.d>N.d||!N.d)&&(N=K,c&&console.log("found best %d after %d probes",Math.round(1e4*K.d)/1e4,q)),K.max-N.d<=n||(P=K.h/2,z.push(new Gl(K.p.x-P,K.p.y-P,P,l)),z.push(new Gl(K.p.x+P,K.p.y-P,P,l)),z.push(new Gl(K.p.x-P,K.p.y+P,P,l)),z.push(new Gl(K.p.x+P,K.p.y+P,P,l)),q+=4)}return c&&(console.log(`num probes: ${q}`),console.log(`best distance: ${N.d}`)),N.p}function Fg(l,n){return n.max-l.max}class Gl{constructor(n,c,f,m){this.p=new W(n,c),this.h=f,this.d=function(x,E){let M=!1,I=1/0;for(let P=0;P<E.length;P++){const z=E[P];for(let N=0,q=z.length,K=q-1;N<q;K=N++){const ee=z[N],oe=z[K];ee.y>x.y!=oe.y>x.y&&x.x<(oe.x-ee.x)*(x.y-ee.y)/(oe.y-ee.y)+ee.x&&(M=!M),I=Math.min(I,Kd(x,ee,oe))}}return(M?1:-1)*Math.sqrt(I)}(this.p,m),this.max=this.d+this.h*Math.SQRT2}}const Uh=Number.POSITIVE_INFINITY,Ng=Math.sqrt(2);function tp(l,[n,c]){let f=0,m=0;if(c===Uh){n<0&&(n=0);const x=n/Ng;switch(l){case"top-right":case"top-left":m=x-7;break;case"bottom-right":case"bottom-left":m=7-x;break;case"bottom":m=7-n;break;case"top":m=n-7}switch(l){case"top-right":case"bottom-right":f=-x;break;case"top-left":case"bottom-left":f=x;break;case"left":f=n;break;case"right":f=-n}}else{switch(n=Math.abs(n),c=Math.abs(c),l){case"top-right":case"top-left":case"top":m=c-7;break;case"bottom-right":case"bottom-left":case"bottom":m=7-c}switch(l){case"top-right":case"bottom-right":case"right":f=-n;break;case"top-left":case"bottom-left":case"left":f=n}}return[f,m]}function Ug(l,n,c,f,m,x,E,M,I,P){l.createArrays(),l.tilePixelRatio=Zi/(512*l.overscaling),l.compareText={},l.iconsNeedLinear=!1;const z=l.layers[0].layout,N=l.layers[0]._unevaluatedLayout._values,q={};if(l.textSizeData.kind==="composite"){const{minZoom:oe,maxZoom:pe}=l.textSizeData;q.compositeTextSizes=[N["text-size"].possiblyEvaluate(new Je(oe),M),N["text-size"].possiblyEvaluate(new Je(pe),M)]}if(l.iconSizeData.kind==="composite"){const{minZoom:oe,maxZoom:pe}=l.iconSizeData;q.compositeIconSizes=[N["icon-size"].possiblyEvaluate(new Je(oe),M),N["icon-size"].possiblyEvaluate(new Je(pe),M)]}q.layoutTextSize=N["text-size"].possiblyEvaluate(new Je(I+1),M),q.layoutIconSize=N["icon-size"].possiblyEvaluate(new Je(I+1),M),q.textMaxSize=N["text-size"].possiblyEvaluate(new Je(18),M);const K=z.get("text-rotation-alignment")==="map"&&z.get("symbol-placement")!=="point",ee=z.get("text-size");for(const oe of l.features){const pe=z.get("text-font").evaluate(oe,{},M).join(","),Ee=ee.evaluate(oe,{},M),Re=q.layoutTextSize.evaluate(oe,{},M),be=(q.layoutIconSize.evaluate(oe,{},M),{horizontal:{},vertical:void 0}),De=oe.text;let ze,Le=[0,0];if(De){const wt=De.toString(),Gt=z.get("text-letter-spacing").evaluate(oe,{},M)*Ln,ft=z.get("text-line-height").evaluate(oe,{},M)*Ln,kt=A(wt)?Gt:0,Rt=z.get("text-anchor").evaluate(oe,{},M),Ft=z.get("text-variable-anchor");if(!Ft){const pi=z.get("text-radial-offset").evaluate(oe,{},M);Le=pi?tp(Rt,[pi*Ln,Uh]):z.get("text-offset").evaluate(oe,{},M).map(ki=>ki*Ln)}let Zt=K?"center":z.get("text-justify").evaluate(oe,{},M);const pt=z.get("symbol-placement")==="point",oi=pt?z.get("text-max-width").evaluate(oe,{},M)*Ln:1/0,Vi=pi=>{l.allowVerticalPlacement&&S(wt)&&(be.vertical=zh(De,n,c,m,pe,oi,ft,Rt,pi,kt,Le,vo.vertical,!0,Re,Ee))};if(!K&&Ft){const pi=Zt==="auto"?Ft.map(ai=>Vh(ai)):[Zt];let ki=!1;for(let ai=0;ai<pi.length;ai++){const qi=pi[ai];if(!be.horizontal[qi])if(ki)be.horizontal[qi]=be.horizontal[0];else{const sr=zh(De,n,c,m,pe,oi,ft,"center",qi,kt,Le,vo.horizontal,!1,Re,Ee);sr&&(be.horizontal[qi]=sr,ki=sr.positionedLines.length===1)}}Vi("left")}else{if(Zt==="auto"&&(Zt=Vh(Rt)),pt||z.get("text-writing-mode").indexOf("horizontal")>=0||!S(wt)){const pi=zh(De,n,c,m,pe,oi,ft,Rt,Zt,kt,Le,vo.horizontal,!1,Re,Ee);pi&&(be.horizontal[Zt]=pi)}Vi(pt?"left":Zt)}}let st=!1;if(oe.icon&&oe.icon.name){const wt=f[oe.icon.name];wt&&(ze=Rg(m[oe.icon.name],z.get("icon-offset").evaluate(oe,{},M),z.get("icon-anchor").evaluate(oe,{},M)),st=wt.sdf,l.sdfIcons===void 0?l.sdfIcons=wt.sdf:l.sdfIcons!==wt.sdf&&vi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(wt.pixelRatio!==l.pixelRatio||z.get("icon-rotate").constantOr(1)!==0)&&(l.iconsNeedLinear=!0))}const it=rp(be.horizontal)||be.vertical;l.iconsInText||(l.iconsInText=!!it&&it.iconsInText),(it||ze)&&Vg(l,oe,be,ze,f,q,Re,0,Le,st,E,M,P)}x&&l.generateCollisionDebugBuffers(I,l.collisionBoxArray)}function Vh(l){switch(l){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Vg(l,n,c,f,m,x,E,M,I,P,z,N,q){let K=x.textMaxSize.evaluate(n,{},N);K===void 0&&(K=E);const ee=l.layers[0].layout,oe=ee.get("icon-offset").evaluate(n,{},N),pe=rp(c.horizontal)||c.vertical,Ee=q.name==="globe",Re=E/24,be=l.tilePixelRatio*K/24,De=(kt=l.overscaling,l.zoom>18&&kt>2&&(kt>>=1),Math.max(Zi/(512*kt),1)*ee.get("symbol-spacing")),ze=ee.get("text-padding")*l.tilePixelRatio,Le=ee.get("icon-padding")*l.tilePixelRatio,st=ae(ee.get("text-max-angle")),it=ee.get("text-rotation-alignment")==="map"&&ee.get("symbol-placement")!=="point",wt=ee.get("icon-rotation-alignment")==="map"&&ee.get("symbol-placement")!=="point",Gt=ee.get("symbol-placement"),ft=De/2;var kt;const Rt=ee.get("icon-text-fit");let Ft;f&&Rt!=="none"&&(l.allowVerticalPlacement&&c.vertical&&(Ft=qf(f,c.vertical,Rt,ee.get("icon-text-fit-padding"),oe,Re)),pe&&(f=qf(f,pe,Rt,ee.get("icon-text-fit-padding"),oe,Re)));const Zt=(pt,oi,Vi)=>{if(oi.x<0||oi.x>=Zi||oi.y<0||oi.y>=Zi)return;let pi=null;if(Ee){const{x:ki,y:ai,z:qi}=q.projectTilePoint(oi.x,oi.y,Vi);pi={anchor:new Ha(ki,ai,qi,0,void 0),up:q.upVector(Vi,oi.x,oi.y)}}(function(ki,ai,qi,sr,or,ir,Gi,br,Wi,lr,Tr,Br,Pr,Or,Nr,Wr,bn,wr,dn,un,gr,qr,pn,Sr,rn){const Fn=ki.addToLineVertexArray(ai,sr);let wn,En,Gn,Tn,Xa,Xl,Uc,Vc=0,Rp=0,Pp=0,Lp=0,ed=-1,td=-1;const ba={};let $p=Ys("");const sl=qi?qi.anchor:ai;let rd=0,nd=0;if(Wi._unevaluatedLayout.getValue("text-radial-offset")===void 0?[rd,nd]=Wi.layout.get("text-offset").evaluate(gr,{},rn).map(ao=>ao*Ln):(rd=Wi.layout.get("text-radial-offset").evaluate(gr,{},rn)*Ln,nd=Uh),ki.allowVerticalPlacement&&or.vertical){const ao=or.vertical;if(Nr)Xl=jh(ao),br&&(Uc=jh(br));else{const so=Wi.layout.get("text-rotate").evaluate(gr,{},rn)+90;Gn=Vu(lr,sl,ai,Tr,Br,Pr,ao,Or,so,Wr),br&&(Tn=Vu(lr,sl,ai,Tr,Br,Pr,br,wr,so))}}if(ir){const ao=Wi.layout.get("icon-rotate").evaluate(gr,{},rn),so=Wi.layout.get("icon-text-fit")!=="none",jc=Jf(ir,ao,pn,so),ad=br?Jf(br,ao,pn,so):void 0;En=Vu(lr,sl,ai,Tr,Br,Pr,ir,wr,ao),Vc=4*jc.length;const Bp=ki.iconSizeData;let ll=null;Bp.kind==="source"?(ll=[_a*Wi.layout.get("icon-size").evaluate(gr,{},rn)],ll[0]>bs&&vi(`${ki.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Bp.kind==="composite"&&(ll=[_a*qr.compositeIconSizes[0].evaluate(gr,{},rn),_a*qr.compositeIconSizes[1].evaluate(gr,{},rn)],(ll[0]>bs||ll[1]>bs)&&vi(`${ki.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),ki.addSymbols(ki.icon,jc,ll,un,dn,gr,!1,qi,ai,Fn.lineStartIndex,Fn.lineLength,-1,Sr,rn),ed=ki.icon.placedSymbolArray.length-1,ad&&(Rp=4*ad.length,ki.addSymbols(ki.icon,ad,ll,un,dn,gr,vo.vertical,qi,ai,Fn.lineStartIndex,Fn.lineLength,-1,Sr,rn),td=ki.icon.placedSymbolArray.length-1)}for(const ao in or.horizontal){const so=or.horizontal[ao];wn||($p=Ys(so.text),Nr?Xa=jh(so):wn=Vu(lr,sl,ai,Tr,Br,Pr,so,Or,Wi.layout.get("text-rotate").evaluate(gr,{},rn),Wr));const jc=so.positionedLines.length===1;if(Pp+=ip(ki,qi,ai,so,Gi,Wi,Nr,gr,Wr,Fn,or.vertical?vo.horizontal:vo.horizontalOnly,jc?Object.keys(or.horizontal):[ao],ba,ed,qr,Sr,rn),jc)break}or.vertical&&(Lp+=ip(ki,qi,ai,or.vertical,Gi,Wi,Nr,gr,Wr,Fn,vo.vertical,["vertical"],ba,td,qr,Sr,rn));let As=-1;const od=(ao,so)=>ao?Math.max(ao,so):so;As=od(Xa,As),As=od(Xl,As),As=od(Uc,As);const g_=As>-1?1:0;ki.glyphOffsetArray.length>=Es.MAX_GLYPHS&&vi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),gr.sortKey!==void 0&&ki.addToSortKeyRanges(ki.symbolInstances.length,gr.sortKey),ki.symbolInstances.emplaceBack(sl.x,sl.y,sl.z,ai.x,ai.y,ba.right>=0?ba.right:-1,ba.center>=0?ba.center:-1,ba.left>=0?ba.left:-1,ba.vertical>=0?ba.vertical:-1,ed,td,$p,wn!==void 0?wn:ki.collisionBoxArray.length,wn!==void 0?wn+1:ki.collisionBoxArray.length,Gn!==void 0?Gn:ki.collisionBoxArray.length,Gn!==void 0?Gn+1:ki.collisionBoxArray.length,En!==void 0?En:ki.collisionBoxArray.length,En!==void 0?En+1:ki.collisionBoxArray.length,Tn||ki.collisionBoxArray.length,Tn?Tn+1:ki.collisionBoxArray.length,Tr,Pp,Lp,Vc,Rp,g_,0,rd,nd,As)})(l,oi,pi,pt,c,f,m,Ft,l.layers[0],l.collisionBoxArray,n.index,n.sourceLayerIndex,l.index,ze,it,I,0,Le,wt,oe,n,x,P,z,N)};if(Gt==="line")for(const pt of Wf(n.geometry,0,0,Zi,Zi)){const oi=Lg(pt,De,st,c.vertical||pe,f,24,be,l.overscaling,Zi);for(const Vi of oi){const pi=pe;pi&&jg(l,pi.text,ft,Vi)||Zt(pt,Vi,N)}}else if(Gt==="line-center"){for(const pt of n.geometry)if(pt.length>1){const oi=Pg(pt,st,c.vertical||pe,f,24,be);oi&&Zt(pt,oi,N)}}else if(n.type==="Polygon")for(const pt of kh(n.geometry,0)){const oi=zg(pt,16);Zt(pt[0],new Ha(oi.x,oi.y,0,0,void 0),N)}else if(n.type==="LineString")for(const pt of n.geometry)Zt(pt,new Ha(pt[0].x,pt[0].y,0,0,void 0),N);else if(n.type==="Point")for(const pt of n.geometry)for(const oi of pt)Zt([oi],new Ha(oi.x,oi.y,0,0,void 0),N)}const bs=32640;function ip(l,n,c,f,m,x,E,M,I,P,z,N,q,K,ee,oe,pe){const Ee=function(De,ze,Le,st,it,wt,Gt,ft){const kt=[];if(ze.positionedLines.length===0)return kt;const Rt=st.layout.get("text-rotate").evaluate(wt,{})*Math.PI/180,Ft=function(pi){const ki=pi[0],ai=pi[1],qi=ki*ai;return qi>0?[ki,-ai]:qi<0?[-ki,ai]:ki===0?[ai,ki]:[ai,-ki]}(Le);let Zt=Math.abs(ze.top-ze.bottom);for(const pi of ze.positionedLines)Zt-=pi.lineOffset;const pt=ze.positionedLines.length,oi=Zt/pt;let Vi=ze.top-Le[1];for(let pi=0;pi<pt;++pi){const ki=ze.positionedLines[pi];Vi=$g(ze,oi,Vi,pi);for(const ai of ki.positionedGlyphs){if(!ai.rect)continue;const qi=ai.rect||{};let sr=4,or=!0,ir=1,Gi=0;if(ai.imageName){const Sr=Gt[ai.imageName];if(!Sr)continue;if(Sr.sdf){vi("SDF images are not supported in formatted text and will be ignored.");continue}or=!1,ir=Sr.pixelRatio,sr=1/ir}const br=(it||ft)&&ai.vertical,Wi=ai.metrics.advance*ai.scale/2,lr=ai.metrics,Tr=ai.rect;if(Tr===null)continue;ft&&ze.verticalizable&&(Gi=ai.imageName?Wi-ai.metrics.width*ai.scale/2:0);const Br=it?[ai.x+Wi,ai.y]:[0,0];let Pr=[0,0],Or=[0,0],Nr=!1;it||(br?(Or=[ai.x+Wi+Ft[0],ai.y+Ft[1]-Gi],Nr=!0):Pr=[ai.x+Wi+Le[0],ai.y+Le[1]-Gi]);const Wr=Tr.w*ai.scale/(ir*(ai.localGlyph?2:1)),bn=Tr.h*ai.scale/(ir*(ai.localGlyph?2:1));let wr,dn,un,gr;if(br){const Sr=ai.y-Vi,rn=new W(-Wi,Wi-Sr),Fn=-Math.PI/2,wn=new W(...Or);wr=new W(-Wi+Pr[0],Pr[1]),wr._rotateAround(Fn,rn)._add(wn),wr.x+=-Sr+Wi,wr.y-=(lr.left-sr)*ai.scale;const En=ai.imageName?lr.advance*ai.scale:Ln*ai.scale,Gn=String.fromCharCode(ai.glyph);gg(Gn)?wr.x+=(1-sr)*ai.scale:_g(Gn)?wr.x+=En-lr.height*ai.scale+(-sr-1)*ai.scale:wr.x+=ai.imageName||lr.width+2*sr===Tr.w&&lr.height+2*sr===Tr.h?(En-bn)/2:(En-(lr.height+2*sr)*ai.scale)/2,dn=new W(wr.x,wr.y-Wr),un=new W(wr.x+bn,wr.y),gr=new W(wr.x+bn,wr.y-Wr)}else{const Sr=(lr.left-sr)*ai.scale-Wi+Pr[0],rn=(-lr.top-sr)*ai.scale+Pr[1],Fn=Sr+Wr,wn=rn+bn;wr=new W(Sr,rn),dn=new W(Fn,rn),un=new W(Sr,wn),gr=new W(Fn,wn)}if(Rt){let Sr;Sr=it?new W(0,0):Nr?new W(Ft[0],Ft[1]):new W(Le[0],Le[1]),wr._rotateAround(Rt,Sr),dn._rotateAround(Rt,Sr),un._rotateAround(Rt,Sr),gr._rotateAround(Rt,Sr)}const qr=new W(0,0),pn=new W(0,0);kt.push({tl:wr,tr:dn,bl:un,br:gr,tex:qi,writingMode:ze.writingMode,glyphOffset:Br,sectionIndex:ai.sectionIndex,isSDF:or,pixelOffsetTL:qr,pixelOffsetBR:pn,minFontScaleX:0,minFontScaleY:0})}}return kt}(0,f,I,x,E,M,m,l.allowVerticalPlacement),Re=l.textSizeData;let be=null;Re.kind==="source"?(be=[_a*x.layout.get("text-size").evaluate(M,{},pe)],be[0]>bs&&vi(`${l.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Re.kind==="composite"&&(be=[_a*ee.compositeTextSizes[0].evaluate(M,{},pe),_a*ee.compositeTextSizes[1].evaluate(M,{},pe)],(be[0]>bs||be[1]>bs)&&vi(`${l.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),l.addSymbols(l.text,Ee,be,I,E,M,z,n,c,P.lineStartIndex,P.lineLength,K,oe,pe);for(const De of N)q[De]=l.text.placedSymbolArray.length-1;return 4*Ee.length}function rp(l){for(const n in l)return l[n];return null}function Vu(l,n,c,f,m,x,E,M,I,P){let z=E.top,N=E.bottom,q=E.left,K=E.right;const ee=E.collisionPadding;if(ee&&(q-=ee[0],z-=ee[1],K+=ee[2],N+=ee[3]),I){const oe=new W(q,z),pe=new W(K,z),Ee=new W(q,N),Re=new W(K,N),be=ae(I);let De=new W(0,0);P&&(De=new W(P[0],P[1])),oe._rotateAround(be,De),pe._rotateAround(be,De),Ee._rotateAround(be,De),Re._rotateAround(be,De),q=Math.min(oe.x,pe.x,Ee.x,Re.x),K=Math.max(oe.x,pe.x,Ee.x,Re.x),z=Math.min(oe.y,pe.y,Ee.y,Re.y),N=Math.max(oe.y,pe.y,Ee.y,Re.y)}return l.emplaceBack(n.x,n.y,n.z,c.x,c.y,q,z,K,N,M,f,m,x),l.length-1}function jh(l){l.collisionPadding&&(l.top-=l.collisionPadding[1],l.bottom+=l.collisionPadding[3]);const n=l.bottom-l.top;return n>0?Math.max(10,n):null}function jg(l,n,c,f){const m=l.compareText;if(n in m){const x=m[n];for(let E=x.length-1;E>=0;E--)if(f.dist(x[E])<c)return!0}else m[n]=[];return m[n].push(f),!1}function np(l,n){const c=l.fovAboveCenter,f=l.elevation?l.elevation.getMinElevationBelowMSL()*n:0,m=(l._camera.position[2]*l.worldSize-f)/Math.cos(l._pitch),x=Math.sin(c)*m/Math.sin(Math.max(Math.PI/2-l._pitch-c,.01)),E=Math.sin(l._pitch)*x+m;return Math.min(1.01*E,m*(1/l._horizonShift))}function ol(l,n){if(!n.isReprojectedInTileSpace)return{scale:1<<l.z,x:l.x,y:l.y,x2:l.x+1,y2:l.y+1,projection:n};const c=Math.pow(2,-l.z),f=l.x*c,m=(l.x+1)*c,x=l.y*c,E=(l.y+1)*c,M=yo(f),I=yo(m),P=Rn(x),z=Rn(E),N=n.project(M,P),q=n.project(I,P),K=n.project(I,z),ee=n.project(M,z);let oe=Math.min(N.x,q.x,K.x,ee.x),pe=Math.min(N.y,q.y,K.y,ee.y),Ee=Math.max(N.x,q.x,K.x,ee.x),Re=Math.max(N.y,q.y,K.y,ee.y);const be=c/16;function De(Le,st,it,wt,Gt,ft){const kt=(it+Gt)/2,Rt=(wt+ft)/2,Ft=n.project(yo(kt),Rn(Rt)),Zt=Math.max(0,oe-Ft.x,pe-Ft.y,Ft.x-Ee,Ft.y-Re);oe=Math.min(oe,Ft.x),Ee=Math.max(Ee,Ft.x),pe=Math.min(pe,Ft.y),Re=Math.max(Re,Ft.y),Zt>be&&(De(Le,Ft,it,wt,kt,Rt),De(Ft,st,kt,Rt,Gt,ft))}De(N,q,f,x,m,x),De(q,K,m,x,m,E),De(K,ee,m,E,f,E),De(ee,N,f,E,f,x),oe-=be,pe-=be,Ee+=be,Re+=be;const ze=1/Math.max(Ee-oe,Re-pe);return{scale:ze,x:oe*ze,y:pe*ze,x2:Ee*ze,y2:Re*ze,projection:n}}const qg=Yo(new Float32Array(16));class ws{constructor(n){this.spec=n,this.name=n.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(n,c){return{x:0,y:0,z:0}}unproject(n,c){return new pr(0,0)}projectTilePoint(n,c,f){return{x:n,y:c,z:0}}locationPoint(n,c,f=!0){return n._coordinatePoint(n.locationCoordinate(c),f)}pixelsPerMeter(n,c){return Ko(1,n)*c}pixelSpaceConversion(n,c,f){return 1}farthestPixelDistance(n){return np(n,n.pixelsPerMeter)}pointCoordinate(n,c,f,m){const x=n.horizonLineFromTop(!1),E=new W(c,Math.max(x,f));return n.rayIntersectionCoordinate(n.pointRayIntersection(E,m))}pointCoordinate3D(n,c,f){const m=new W(c,f);if(n.elevation)return n.elevation.pointCoordinate(m);{const x=this.pointCoordinate(n,m.x,m.y,0);return[x.x,x.y,x.z]}}isPointAboveHorizon(n,c){if(n.elevation)return!this.pointCoordinate3D(n,c.x,c.y);const f=n.horizonLineFromTop();return c.y<f}createInversionMatrix(n,c){return qg}createTileMatrix(n,c,f){let m,x,E;const M=f.canonical,I=Yo(new Float64Array(16));if(this.isReprojectedInTileSpace){const P=ol(M,this);m=1,x=P.x+f.wrap*P.scale,E=P.y,Qs(I,I,[m/P.scale,m/P.scale,n.pixelsPerMeter/c])}else m=c/n.zoomScale(M.z),x=(M.x+Math.pow(2,M.z)*f.wrap)*m,E=M.y*m;return hc(I,I,[x,E,0]),Qs(I,I,[m/Zi,m/Zi,1]),I}upVector(n,c,f){return[0,0,1]}upVectorScale(n,c,f){return{metersToTile:1}}}class Gg extends ws{constructor(n){super(n),this.range=[4,7],this.center=n.center||[-96,37.5];const[c,f]=this.parallels=n.parallels||[29.5,45.5],m=Math.sin(ae(c));this.n=(m+Math.sin(ae(f)))/2,this.c=1+m*(2*this.n-m),this.r0=Math.sqrt(this.c)/this.n}project(n,c){const{n:f,c:m,r0:x}=this,E=ae(n-this.center[0]),M=ae(c),I=Math.sqrt(m-2*f*Math.sin(M))/f;return{x:I*Math.sin(E*f),y:I*Math.cos(E*f)-x,z:0}}unproject(n,c){const{n:f,c:m,r0:x}=this,E=x+c;let M=Math.atan2(n,Math.abs(E))*Math.sign(E);E*f<0&&(M-=Math.PI*Math.sign(n)*Math.sign(E));const I=ae(this.center[0])*f;M=ti(M,-Math.PI-I,Math.PI-I);const P=Ge(J(M/f)+this.center[0],-180,180),z=Math.asin(Ge((m-(n*n+E*E)*f*f)/(2*f),-1,1)),N=Ge(J(z),-Pn,Pn);return new pr(P,N)}}const $c=1.340264,Bc=-.081106,Oc=893e-6,zc=.003796,ju=Math.sqrt(3)/2;class Zg extends ws{project(n,c){c=c/180*Math.PI,n=n/180*Math.PI;const f=Math.asin(ju*Math.sin(c)),m=f*f,x=m*m*m;return{x:.5*(n*Math.cos(f)/(ju*($c+3*Bc*m+x*(7*Oc+9*zc*m)))/Math.PI+.5),y:1-.5*(f*($c+Bc*m+x*(Oc+zc*m))/Math.PI+1),z:0}}unproject(n,c){n=(2*n-.5)*Math.PI;let f=c=(2*(1-c)-1)*Math.PI,m=f*f,x=m*m*m;for(let z,N,q,K=0;K<12&&(N=f*($c+Bc*m+x*(Oc+zc*m))-c,q=$c+3*Bc*m+x*(7*Oc+9*zc*m),z=N/q,f=Ge(f-z,-Math.PI/3,Math.PI/3),m=f*f,x=m*m*m,!(Math.abs(z)<1e-12));++K);const E=ju*n*($c+3*Bc*m+x*(7*Oc+9*zc*m))/Math.cos(f),M=Math.asin(Math.sin(f)/ju),I=Ge(180*E/Math.PI,-180,180),P=Ge(180*M/Math.PI,-Pn,Pn);return new pr(I,P)}}class Hg extends ws{constructor(n){super(n),this.wrap=!0,this.supportsWorldCopies=!0}project(n,c){return{x:.5+n/360,y:.5-c/360,z:0}}unproject(n,c){const f=360*(n-.5),m=Ge(360*(.5-c),-Pn,Pn);return new pr(f,m)}}const Zl=Math.PI/2;function qu(l){return Math.tan((Zl+l)/2)}class Xg extends ws{constructor(n){super(n),this.center=n.center||[0,30];const[c,f]=this.parallels=n.parallels||[30,30];let m=ae(c),x=ae(f);this.southernCenter=m+x<0,this.southernCenter&&(m=-m,x=-x);const E=Math.cos(m),M=qu(m);this.n=m===x?Math.sin(m):Math.log(E/Math.cos(x))/Math.log(qu(x)/M),this.f=E*Math.pow(qu(m),this.n)/this.n}project(n,c){c=ae(c),this.southernCenter&&(c=-c),n=ae(n-this.center[0]);const f=1e-6,{n:m,f:x}=this;x>0?c<-Zl+f&&(c=-Zl+f):c>Zl-f&&(c=Zl-f);const E=x/Math.pow(qu(c),m);let M=E*Math.sin(m*n),I=x-E*Math.cos(m*n);return M=.5*(M/Math.PI+.5),I=.5*(I/Math.PI+.5),{x:M,y:this.southernCenter?I:1-I,z:0}}unproject(n,c){n=(2*n-.5)*Math.PI,this.southernCenter&&(c=1-c),c=(2*(1-c)-.5)*Math.PI;const{n:f,f:m}=this,x=m-c,E=Math.sign(x),M=Math.sign(f)*Math.sqrt(n*n+x*x);let I=Math.atan2(n,Math.abs(x))*E;x*f<0&&(I-=Math.PI*Math.sign(n)*E);const P=Ge(J(I/f)+this.center[0],-180,180),z=Ge(J(2*Math.atan(Math.pow(m/M,1/f))-Zl),-Pn,Pn);return new pr(P,this.southernCenter?-z:z)}}class op extends ws{constructor(n){super(n),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(n,c){return{x:ma(n),y:ga(c),z:0}}unproject(n,c){const f=yo(n),m=Rn(c);return new pr(f,m)}}const ap=ae(Pn);class Yg extends ws{project(n,c){const f=(c=ae(c))*c,m=f*f;return{x:.5*((n=ae(n))*(.8707-.131979*f+m*(m*(.003971*f-.001529*m)-.013791))/Math.PI+.5),y:1-.5*(c*(1.007226+f*(.015085+m*(.028874*f-.044475-.005916*m)))/Math.PI+1),z:0}}unproject(n,c){n=(2*n-.5)*Math.PI;let f=c=(2*(1-c)-1)*Math.PI,m=25,x=0,E=f*f;do{E=f*f;const P=E*E;x=(f*(1.007226+E*(.015085+P*(.028874*E-.044475-.005916*P)))-c)/(1.007226+E*(.045255+P*(.259866*E-.311325-.005916*11*P))),f=Ge(f-x,-ap,ap)}while(Math.abs(x)>1e-6&&--m>0);E=f*f;const M=Ge(J(n/(.8707+E*(E*(E*E*E*(.003971-.001529*E)-.013791)-.131979))),-180,180),I=J(f);return new pr(M,I)}}const sp=ae(Pn);class Wg extends ws{project(n,c){c=ae(c),n=ae(n);const f=Math.cos(c),m=2/Math.PI,x=Math.acos(f*Math.cos(n/2)),E=Math.sin(x)/x,M=.5*(n*m+2*f*Math.sin(n/2)/E)||0,I=.5*(c+Math.sin(c)/E)||0;return{x:.5*(M/Math.PI+.5),y:1-.5*(I/Math.PI+1),z:0}}unproject(n,c){let f=n=(2*n-.5)*Math.PI,m=c=(2*(1-c)-1)*Math.PI,x=25;const E=1e-6;let M=0,I=0;do{const P=Math.cos(m),z=Math.sin(m),N=2*z*P,q=z*z,K=P*P,ee=Math.cos(f/2),oe=Math.sin(f/2),pe=2*ee*oe,Ee=oe*oe,Re=1-K*ee*ee,be=Re?1/Re:0,De=Re?Math.acos(P*ee)*Math.sqrt(1/Re):0,ze=.5*(2*De*P*oe+2*f/Math.PI)-n,Le=.5*(De*z+m)-c,st=.5*be*(K*Ee+De*P*ee*q)+1/Math.PI,it=be*(pe*N/4-De*z*oe),wt=.125*be*(N*oe-De*z*K*pe),Gt=.5*be*(q*ee+De*Ee*P)+.5,ft=it*wt-Gt*st;M=(Le*it-ze*Gt)/ft,I=(ze*wt-Le*st)/ft,f=Ge(f-M,-Math.PI,Math.PI),m=Ge(m-I,-sp,sp)}while((Math.abs(M)>E||Math.abs(I)>E)&&--x>0);return new pr(J(f),J(m))}}class lp extends ws{constructor(n){super(n),this.center=n.center||[0,0],this.parallels=n.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(ae(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(n,c){const{scale:f,cosPhi:m}=this;return{x:ae(n)*m*f+.5,y:-Math.sin(ae(c))/m*f+.5,z:0}}unproject(n,c){const{scale:f,cosPhi:m}=this,x=-(c-.5)/f,E=Ge(J((n-.5)/f)/m,-180,180),M=Math.asin(Ge(x*m,-1,1)),I=Ge(J(M),-Pn,Pn);return new pr(E,I)}}class Kg extends op{constructor(n){super(n),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(n,c,f){const m=vc(n,c,f);return tn(m,m,xc(pa(f))),{x:m[0],y:m[1],z:m[2]}}locationPoint(n,c){const f=Rl(c.lat,c.lng),m=Vn([],f),x=n.elevation?n.elevation.getAtPointOrZero(n.locationCoordinate(c),n._centerAltitude):n._centerAltitude;mc(f,f,m,Ko(1,0)*Zi*x);const E=Yo(new Float64Array(16));return Ks(E,n.pixelMatrix,n.globeMatrix),tn(f,f,E),new W(f[0],f[1])}pixelsPerMeter(n,c){return Ko(1,0)*c}pixelSpaceConversion(n,c,f){const m=Ko(1,n)*c,x=Qi(Ko(1,45)*c,m,f);return this.pixelsPerMeter(n,c)/x}createTileMatrix(n,c,f){const m=gh(pa(f.canonical));return Ks(new Float64Array(16),n.globeMatrix,m)}createInversionMatrix(n,c){const{center:f}=n,m=xc(pa(c));return vu(m,m,ae(f.lng)),sh(m,m,ae(f.lat)),Qs(m,m,[n._pixelsPerMercatorPixel,n._pixelsPerMercatorPixel,1]),Float32Array.from(m)}pointCoordinate(n,c,f,m){return Od(n,c,f,!0)||new Ll(0,0)}pointCoordinate3D(n,c,f){const m=this.pointCoordinate(n,c,f,0);return[m.x,m.y,m.z]}isPointAboveHorizon(n,c){return!Od(n,c.x,c.y,!1)}farthestPixelDistance(n){const c=function(m,x){const E=m.cameraToCenterDistance,M=m._centerAltitude*x,I=m._camera,P=m._camera.forward(),z=ja([],_o([],P,-E),[0,0,M]),N=m.worldSize/(2*Math.PI),q=[0,0,-N],K=m.width/m.height,ee=Math.tan(m.fovAboveCenter),oe=_o([],I.up(),ee),pe=_o([],I.right(),ee*K),Ee=Vn([],ja([],ja([],P,oe),pe)),Re=[];let be;if(new hh(z,Ee).closestPointOnSphere(q,N,Re)){const De=ja([],Re,q),ze=Wo([],De,z);be=Math.cos(m.fovAboveCenter)*dc(ze)}else{const De=Wo([],z,q),ze=Wo([],q,z);Vn(ze,ze);const Le=dc(De)-N;be=Math.sqrt(Le*(Le+2*N));const st=Math.acos(be/(N+Le))-Math.acos(Ao(P,ze));be*=Math.cos(st)}return 1.01*be}(n,this.pixelsPerMeter(n.center.lat,n.worldSize)),f=Pl(n.zoom);if(f>0){const m=np(n,Ko(1,n.center.lat)*n.worldSize),x=n.worldSize/(2*Math.PI),E=Math.max(n.width,n.height)/n.worldSize*Math.PI;return Qi(c,m+x*(1-Math.cos(E)),Math.pow(f,10))}return c}upVector(n,c,f){return vc(c,f,n,1)}upVectorScale(n){return{metersToTile:xu(wu(pa(n)))}}}function cp(l){const n=l.parallels,c=!!n&&Math.abs(n[0]+n[1])<.01;switch(l.name){case"mercator":return new op(l);case"equirectangular":return new Hg(l);case"naturalEarth":return new Yg(l);case"equalEarth":return new Zg(l);case"winkelTripel":return new Wg(l);case"albers":return c?new lp(l):new Gg(l);case"lambertConformalConic":return c?new lp(l):new Xg(l);case"globe":return new Kg(l)}throw new Error(`Invalid projection name: ${l.name}`)}const Qg=Ru.types,Jg=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Gu(l,n,c,f,m,x,E,M,I,P,z,N,q){const K=M?Math.min(bs,Math.round(M[0])):0,ee=M?Math.min(bs,Math.round(M[1])):0;l.emplaceBack(n,c,Math.round(32*f),Math.round(32*m),x,E,(K<<1)+(I?1:0),ee,16*P,16*z,256*N,256*q)}function Zu(l,n,c,f,m,x,E){l.emplaceBack(n,c,f,m,x,E)}function Hu(l,n,c,f,m){l.emplaceBack(n,c,f,m),l.emplaceBack(n,c,f,m),l.emplaceBack(n,c,f,m),l.emplaceBack(n,c,f,m)}function e_(l){for(const n of l.sections)if(ie(n.text))return!0;return!1}class qh{constructor(n){this.layoutVertexArray=new Go,this.indexArray=new Dn,this.programConfigurations=n,this.segments=new ln,this.dynamicLayoutVertexArray=new Ar,this.opacityVertexArray=new Cr,this.placedSymbolArray=new cd,this.globeExtVertexArray=new Fr}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(n,c,f,m){this.isEmpty()||(f&&(this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,lg.members),this.indexBuffer=n.createIndexBuffer(this.indexArray,c),this.dynamicLayoutVertexBuffer=n.createVertexBuffer(this.dynamicLayoutVertexArray,ug.members,!0),this.opacityVertexBuffer=n.createVertexBuffer(this.opacityVertexArray,Jg,!0),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=n.createVertexBuffer(this.globeExtVertexArray,cg.members,!0)),this.opacityVertexBuffer.itemSize=1),(f||m)&&this.programConfigurations.upload(n))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}}Ti(qh,"SymbolBuffers");class Gh{constructor(n,c,f){this.layoutVertexArray=new n,this.layoutAttributes=c,this.indexArray=new f,this.segments=new ln,this.collisionVertexArray=new $r,this.collisionVertexArrayExt=new kn}upload(n){this.layoutVertexBuffer=n.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=n.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=n.createVertexBuffer(this.collisionVertexArray,hg.members,!0),this.collisionVertexBufferExt=n.createVertexBuffer(this.collisionVertexArrayExt,dg.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Ti(Gh,"CollisionBuffers");class Es{constructor(n){this.collisionBoxArray=n.collisionBoxArray,this.zoom=n.zoom,this.overscaling=n.overscaling,this.layers=n.layers,this.layerIds=this.layers.map(E=>E.id),this.index=n.index,this.pixelRatio=n.pixelRatio,this.sourceLayerIndex=n.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Yo([]),this.placementViewportMatrix=Yo([]);const c=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Lh(this.zoom,c["text-size"]),this.iconSizeData=Lh(this.zoom,c["icon-size"]);const f=this.layers[0].layout,m=f.get("symbol-sort-key"),x=f.get("symbol-z-order");this.canOverlap=f.get("text-allow-overlap")||f.get("icon-allow-overlap")||f.get("text-ignore-placement")||f.get("icon-ignore-placement"),this.sortFeaturesByKey=x!=="viewport-y"&&m.constantOr(1)!==void 0,this.sortFeaturesByY=(x==="viewport-y"||x==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=f.get("text-writing-mode").map(E=>vo[E]),this.stateDependentLayerIds=this.layers.filter(E=>E.isStateDependent()).map(E=>E.id),this.sourceID=n.sourceID,this.projection=n.projection}createArrays(){this.text=new qh(new Ws(this.layers,this.zoom,n=>/^text/.test(n))),this.icon=new qh(new Ws(this.layers,this.zoom,n=>/^icon/.test(n))),this.glyphOffsetArray=new dd,this.lineVertexArray=new fd,this.symbolInstances=new hd}calculateGlyphDependencies(n,c,f,m,x){for(let E=0;E<n.length;E++)if(c[n.charCodeAt(E)]=!0,m&&x){const M=Dc[n.charAt(E)];M&&(c[M.charCodeAt(0)]=!0)}}populate(n,c,f,m){const x=this.layers[0],E=x.layout,M=this.projection.name==="globe",I=E.get("text-font"),P=E.get("text-field"),z=E.get("icon-image"),N=(P.value.kind!=="constant"||P.value.value instanceof mn&&!P.value.value.isEmpty()||P.value.value.toString().length>0)&&(I.value.kind!=="constant"||I.value.value.length>0),q=z.value.kind!=="constant"||!!z.value.value||Object.keys(z.parameters).length>0,K=E.get("symbol-sort-key");if(this.features=[],!N&&!q)return;const ee=c.iconDependencies,oe=c.glyphDependencies,pe=c.availableImages,Ee=new Je(this.zoom);for(const{feature:Re,id:be,index:De,sourceLayerIndex:ze}of n){const Le=x._featureFilter.needGeometry,st=il(Re,Le);if(!x._featureFilter.filter(Ee,st,f))continue;if(Le||(st.geometry=qa(Re,f,m)),M&&Re.type!==1&&f.z<=5){const ft=st.geometry,kt=.98078528056,Rt=(Ft,Zt)=>Ao(vc(Ft.x,Ft.y,f,1),vc(Zt.x,Zt.y,f,1))<kt;for(let Ft=0;Ft<ft.length;Ft++)ft[Ft]=um(ft[Ft],Rt)}let it,wt;if(N){const ft=x.getValueAndResolveTokens("text-field",st,f,pe),kt=mn.factory(ft);e_(kt)&&(this.hasRTLText=!0),(!this.hasRTLText||Fe()==="unavailable"||this.hasRTLText&&qe.isParsed())&&(it=mg(kt,x,st))}if(q){const ft=x.getValueAndResolveTokens("icon-image",st,f,pe);wt=ft instanceof yn?ft:yn.fromString(ft)}if(!it&&!wt)continue;const Gt=this.sortFeaturesByKey?K.evaluate(st,{},f):void 0;if(this.features.push({id:be,text:it,icon:wt,index:De,sourceLayerIndex:ze,geometry:st.geometry,properties:Re.properties,type:Qg[Re.type],sortKey:Gt}),wt&&(ee[wt.name]=!0),it){const ft=I.evaluate(st,{},f).join(","),kt=E.get("text-rotation-alignment")==="map"&&E.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(vo.vertical)>=0;for(const Rt of it.sections)if(Rt.image)ee[Rt.image.name]=!0;else{const Ft=S(it.toString()),Zt=Rt.fontStack||ft,pt=oe[Zt]=oe[Zt]||{};this.calculateGlyphDependencies(Rt.text,pt,kt,this.allowVerticalPlacement,Ft)}}}E.get("symbol-placement")==="line"&&(this.features=function(Re){const be={},De={},ze=[];let Le=0;function st(ft){ze.push(Re[ft]),Le++}function it(ft,kt,Rt){const Ft=De[ft];return delete De[ft],De[kt]=Ft,ze[Ft].geometry[0].pop(),ze[Ft].geometry[0]=ze[Ft].geometry[0].concat(Rt[0]),Ft}function wt(ft,kt,Rt){const Ft=be[kt];return delete be[kt],be[ft]=Ft,ze[Ft].geometry[0].shift(),ze[Ft].geometry[0]=Rt[0].concat(ze[Ft].geometry[0]),Ft}function Gt(ft,kt,Rt){const Ft=Rt?kt[0][kt[0].length-1]:kt[0][0];return`${ft}:${Ft.x}:${Ft.y}`}for(let ft=0;ft<Re.length;ft++){const kt=Re[ft],Rt=kt.geometry,Ft=kt.text?kt.text.toString():null;if(!Ft){st(ft);continue}const Zt=Gt(Ft,Rt),pt=Gt(Ft,Rt,!0);if(Zt in De&&pt in be&&De[Zt]!==be[pt]){const oi=wt(Zt,pt,Rt),Vi=it(Zt,pt,ze[oi].geometry);delete be[Zt],delete De[pt],De[Gt(Ft,ze[Vi].geometry,!0)]=Vi,ze[oi].geometry=null}else Zt in De?it(Zt,pt,Rt):pt in be?wt(Zt,pt,Rt):(st(ft),be[Zt]=Le-1,De[pt]=Le-1)}return ze.filter(ft=>ft.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Re,be)=>Re.sortKey-be.sortKey)}update(n,c,f,m){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(n,c,this.layers,f,m),this.icon.programConfigurations.updatePaintArrays(n,c,this.layers,f,m))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(n){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(n),this.iconCollisionBox.upload(n)),this.text.upload(n,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(n,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=cp(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(n,c){const f=this.lineVertexArray.length;if(n.segment!==void 0)for(const{x:m,y:x}of c)this.lineVertexArray.emplaceBack(m,x);return{lineStartIndex:f,lineLength:this.lineVertexArray.length-f}}addSymbols(n,c,f,m,x,E,M,I,P,z,N,q,K,ee){const oe=n.indexArray,pe=n.layoutVertexArray,Ee=n.globeExtVertexArray,Re=n.segments.prepareSegment(4*c.length,pe,oe,this.canOverlap?E.sortKey:void 0),be=this.glyphOffsetArray.length,De=Re.vertexLength,ze=this.allowVerticalPlacement&&M===vo.vertical?Math.PI/2:0,Le=E.text&&E.text.sections;for(let it=0;it<c.length;it++){const{tl:wt,tr:Gt,bl:ft,br:kt,tex:Rt,pixelOffsetTL:Ft,pixelOffsetBR:Zt,minFontScaleX:pt,minFontScaleY:oi,glyphOffset:Vi,isSDF:pi,sectionIndex:ki}=c[it],ai=Re.vertexLength,qi=Vi[1];if(Gu(pe,P.x,P.y,wt.x,qi+wt.y,Rt.x,Rt.y,f,pi,Ft.x,Ft.y,pt,oi),Gu(pe,P.x,P.y,Gt.x,qi+Gt.y,Rt.x+Rt.w,Rt.y,f,pi,Zt.x,Ft.y,pt,oi),Gu(pe,P.x,P.y,ft.x,qi+ft.y,Rt.x,Rt.y+Rt.h,f,pi,Ft.x,Zt.y,pt,oi),Gu(pe,P.x,P.y,kt.x,qi+kt.y,Rt.x+Rt.w,Rt.y+Rt.h,f,pi,Zt.x,Zt.y,pt,oi),I){const{x:sr,y:or,z:ir}=I.anchor,[Gi,br,Wi]=I.up;Zu(Ee,sr,or,ir,Gi,br,Wi),Zu(Ee,sr,or,ir,Gi,br,Wi),Zu(Ee,sr,or,ir,Gi,br,Wi),Zu(Ee,sr,or,ir,Gi,br,Wi),Hu(n.dynamicLayoutVertexArray,sr,or,ir,ze)}else Hu(n.dynamicLayoutVertexArray,P.x,P.y,P.z,ze);oe.emplaceBack(ai,ai+1,ai+2),oe.emplaceBack(ai+1,ai+2,ai+3),Re.vertexLength+=4,Re.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Vi[0]),it!==c.length-1&&ki===c[it+1].sectionIndex||n.programConfigurations.populatePaintArrays(pe.length,E,E.index,{},K,ee,Le&&Le[ki])}const st=I?I.anchor:P;n.placedSymbolArray.emplaceBack(st.x,st.y,st.z,P.x,P.y,be,this.glyphOffsetArray.length-be,De,z,N,P.segment,f?f[0]:0,f?f[1]:0,m[0],m[1],M,0,!1,0,q,0)}_commitLayoutVertex(n,c,f,m,x,E,M){n.emplaceBack(c,f,m,x,E,Math.round(M.x),Math.round(M.y))}_addCollisionDebugVertices(n,c,f,m,x,E,M){const I=f.segments.prepareSegment(4,f.layoutVertexArray,f.indexArray),P=I.vertexLength,z=M.tileAnchorX,N=M.tileAnchorY;for(let K=0;K<4;K++)f.collisionVertexArray.emplaceBack(0,0,0,0);f.collisionVertexArrayExt.emplaceBack(c,-n.padding,-n.padding),f.collisionVertexArrayExt.emplaceBack(c,n.padding,-n.padding),f.collisionVertexArrayExt.emplaceBack(c,n.padding,n.padding),f.collisionVertexArrayExt.emplaceBack(c,-n.padding,n.padding),this._commitLayoutVertex(f.layoutVertexArray,m,x,E,z,N,new W(n.x1,n.y1)),this._commitLayoutVertex(f.layoutVertexArray,m,x,E,z,N,new W(n.x2,n.y1)),this._commitLayoutVertex(f.layoutVertexArray,m,x,E,z,N,new W(n.x2,n.y2)),this._commitLayoutVertex(f.layoutVertexArray,m,x,E,z,N,new W(n.x1,n.y2)),I.vertexLength+=4;const q=f.indexArray;q.emplaceBack(P,P+1),q.emplaceBack(P+1,P+2),q.emplaceBack(P+2,P+3),q.emplaceBack(P+3,P),I.primitiveLength+=4}_addTextDebugCollisionBoxes(n,c,f,m,x,E){for(let M=m;M<x;M++){const I=f.get(M),P=this.getSymbolInstanceTextSize(n,E,c,M);this._addCollisionDebugVertices(I,P,this.textCollisionBox,I.projectedAnchorX,I.projectedAnchorY,I.projectedAnchorZ,E)}}_addIconDebugCollisionBoxes(n,c,f,m,x,E){for(let M=m;M<x;M++){const I=f.get(M),P=this.getSymbolInstanceIconSize(n,c,E.placedIconSymbolIndex);this._addCollisionDebugVertices(I,P,this.iconCollisionBox,I.projectedAnchorX,I.projectedAnchorY,I.projectedAnchorZ,E)}}generateCollisionDebugBuffers(n,c){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Gh(Yr,Df.members,ha),this.iconCollisionBox=new Gh(Yr,Df.members,ha);const f=Nl(this.iconSizeData,n),m=Nl(this.textSizeData,n);for(let x=0;x<this.symbolInstances.length;x++){const E=this.symbolInstances.get(x);this._addTextDebugCollisionBoxes(m,n,c,E.textBoxStartIndex,E.textBoxEndIndex,E),this._addTextDebugCollisionBoxes(m,n,c,E.verticalTextBoxStartIndex,E.verticalTextBoxEndIndex,E),this._addIconDebugCollisionBoxes(f,n,c,E.iconBoxStartIndex,E.iconBoxEndIndex,E),this._addIconDebugCollisionBoxes(f,n,c,E.verticalIconBoxStartIndex,E.verticalIconBoxEndIndex,E)}}getSymbolInstanceTextSize(n,c,f,m){const x=this.text.placedSymbolArray.get(c.rightJustifiedTextSymbolIndex>=0?c.rightJustifiedTextSymbolIndex:c.centerJustifiedTextSymbolIndex>=0?c.centerJustifiedTextSymbolIndex:c.leftJustifiedTextSymbolIndex>=0?c.leftJustifiedTextSymbolIndex:c.verticalPlacedTextSymbolIndex>=0?c.verticalPlacedTextSymbolIndex:m),E=Bu(this.textSizeData,n,x)/Ln;return this.tilePixelRatio*E}getSymbolInstanceIconSize(n,c,f){const m=this.icon.placedSymbolArray.get(f),x=Bu(this.iconSizeData,n,m);return this.tilePixelRatio*x}_commitDebugCollisionVertexUpdate(n,c,f){n.emplaceBack(c,-f,-f),n.emplaceBack(c,f,-f),n.emplaceBack(c,f,f),n.emplaceBack(c,-f,f)}_updateTextDebugCollisionBoxes(n,c,f,m,x,E){for(let M=m;M<x;M++){const I=f.get(M),P=this.getSymbolInstanceTextSize(n,E,c,M);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,P,I.padding)}}_updateIconDebugCollisionBoxes(n,c,f,m,x,E){for(let M=m;M<x;M++){const I=f.get(M),P=this.getSymbolInstanceIconSize(n,c,E);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,P,I.padding)}}updateCollisionDebugBuffers(n,c){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const f=Nl(this.iconSizeData,n),m=Nl(this.textSizeData,n);for(let x=0;x<this.symbolInstances.length;x++){const E=this.symbolInstances.get(x);this._updateTextDebugCollisionBoxes(m,n,c,E.textBoxStartIndex,E.textBoxEndIndex,E),this._updateTextDebugCollisionBoxes(m,n,c,E.verticalTextBoxStartIndex,E.verticalTextBoxEndIndex,E),this._updateIconDebugCollisionBoxes(f,n,c,E.iconBoxStartIndex,E.iconBoxEndIndex,E.placedIconSymbolIndex),this._updateIconDebugCollisionBoxes(f,n,c,E.verticalIconBoxStartIndex,E.verticalIconBoxEndIndex,E.placedIconSymbolIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(n,c,f,m,x,E,M,I,P){const z={};if(c<f){const{x1:N,y1:q,x2:K,y2:ee,padding:oe,projectedAnchorX:pe,projectedAnchorY:Ee,projectedAnchorZ:Re,tileAnchorX:be,tileAnchorY:De,featureIndex:ze}=n.get(c);z.textBox={x1:N,y1:q,x2:K,y2:ee,padding:oe,projectedAnchorX:pe,projectedAnchorY:Ee,projectedAnchorZ:Re,tileAnchorX:be,tileAnchorY:De},z.textFeatureIndex=ze}if(m<x){const{x1:N,y1:q,x2:K,y2:ee,padding:oe,projectedAnchorX:pe,projectedAnchorY:Ee,projectedAnchorZ:Re,tileAnchorX:be,tileAnchorY:De,featureIndex:ze}=n.get(m);z.verticalTextBox={x1:N,y1:q,x2:K,y2:ee,padding:oe,projectedAnchorX:pe,projectedAnchorY:Ee,projectedAnchorZ:Re,tileAnchorX:be,tileAnchorY:De},z.verticalTextFeatureIndex=ze}if(E<M){const{x1:N,y1:q,x2:K,y2:ee,padding:oe,projectedAnchorX:pe,projectedAnchorY:Ee,projectedAnchorZ:Re,tileAnchorX:be,tileAnchorY:De,featureIndex:ze}=n.get(E);z.iconBox={x1:N,y1:q,x2:K,y2:ee,padding:oe,projectedAnchorX:pe,projectedAnchorY:Ee,projectedAnchorZ:Re,tileAnchorX:be,tileAnchorY:De},z.iconFeatureIndex=ze}if(I<P){const{x1:N,y1:q,x2:K,y2:ee,padding:oe,projectedAnchorX:pe,projectedAnchorY:Ee,projectedAnchorZ:Re,tileAnchorX:be,tileAnchorY:De,featureIndex:ze}=n.get(I);z.verticalIconBox={x1:N,y1:q,x2:K,y2:ee,padding:oe,projectedAnchorX:pe,projectedAnchorY:Ee,projectedAnchorZ:Re,tileAnchorX:be,tileAnchorY:De},z.verticalIconFeatureIndex=ze}return z}deserializeCollisionBoxes(n){this.collisionArrays=[];for(let c=0;c<this.symbolInstances.length;c++){const f=this.symbolInstances.get(c);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(n,f.textBoxStartIndex,f.textBoxEndIndex,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f.iconBoxStartIndex,f.iconBoxEndIndex,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(n,c){const f=n.placedSymbolArray.get(c),m=f.vertexStartIndex+4*f.numGlyphs;for(let x=f.vertexStartIndex;x<m;x+=4)n.indexArray.emplaceBack(x,x+1,x+2),n.indexArray.emplaceBack(x+1,x+2,x+3)}getSortedSymbolIndexes(n){if(this.sortedAngle===n&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const c=Math.sin(n),f=Math.cos(n),m=[],x=[],E=[];for(let M=0;M<this.symbolInstances.length;++M){E.push(M);const I=this.symbolInstances.get(M);m.push(0|Math.round(c*I.tileAnchorX+f*I.tileAnchorY)),x.push(I.featureIndex)}return E.sort((M,I)=>m[M]-m[I]||x[I]-x[M]),E}addToSortKeyRanges(n,c){const f=this.sortKeyRanges[this.sortKeyRanges.length-1];f&&f.sortKey===c?f.symbolInstanceEnd=n+1:this.sortKeyRanges.push({sortKey:c,symbolInstanceStart:n,symbolInstanceEnd:n+1})}sortFeatures(n){if(this.sortFeaturesByY&&this.sortedAngle!==n&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(n),this.sortedAngle=n,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const c of this.symbolInstanceIndexes){const f=this.symbolInstances.get(c);this.featureSortOrder.push(f.featureIndex);const{rightJustifiedTextSymbolIndex:m,centerJustifiedTextSymbolIndex:x,leftJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:M,placedIconSymbolIndex:I,verticalPlacedIconSymbolIndex:P}=f;m>=0&&this.addIndicesForPlacedSymbol(this.text,m),x>=0&&x!==m&&this.addIndicesForPlacedSymbol(this.text,x),E>=0&&E!==x&&E!==m&&this.addIndicesForPlacedSymbol(this.text,E),M>=0&&this.addIndicesForPlacedSymbol(this.text,M),I>=0&&this.addIndicesForPlacedSymbol(this.icon,I),P>=0&&this.addIndicesForPlacedSymbol(this.icon,P)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Ti(Es,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Es.MAX_GLYPHS=65535,Es.addDynamicAttributes=Hu;const t_=new jt({"symbol-placement":new Ke(ot.layout_symbol["symbol-placement"]),"symbol-spacing":new Ke(ot.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ke(ot.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ut(ot.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ke(ot.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Ke(ot.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ke(ot.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ke(ot.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ke(ot.layout_symbol["icon-rotation-alignment"]),"icon-size":new ut(ot.layout_symbol["icon-size"]),"icon-text-fit":new Ke(ot.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ke(ot.layout_symbol["icon-text-fit-padding"]),"icon-image":new ut(ot.layout_symbol["icon-image"]),"icon-rotate":new ut(ot.layout_symbol["icon-rotate"]),"icon-padding":new Ke(ot.layout_symbol["icon-padding"]),"icon-keep-upright":new Ke(ot.layout_symbol["icon-keep-upright"]),"icon-offset":new ut(ot.layout_symbol["icon-offset"]),"icon-anchor":new ut(ot.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ke(ot.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ke(ot.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ke(ot.layout_symbol["text-rotation-alignment"]),"text-field":new ut(ot.layout_symbol["text-field"]),"text-font":new ut(ot.layout_symbol["text-font"]),"text-size":new ut(ot.layout_symbol["text-size"]),"text-max-width":new ut(ot.layout_symbol["text-max-width"]),"text-line-height":new ut(ot.layout_symbol["text-line-height"]),"text-letter-spacing":new ut(ot.layout_symbol["text-letter-spacing"]),"text-justify":new ut(ot.layout_symbol["text-justify"]),"text-radial-offset":new ut(ot.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ke(ot.layout_symbol["text-variable-anchor"]),"text-anchor":new ut(ot.layout_symbol["text-anchor"]),"text-max-angle":new Ke(ot.layout_symbol["text-max-angle"]),"text-writing-mode":new Ke(ot.layout_symbol["text-writing-mode"]),"text-rotate":new ut(ot.layout_symbol["text-rotate"]),"text-padding":new Ke(ot.layout_symbol["text-padding"]),"text-keep-upright":new Ke(ot.layout_symbol["text-keep-upright"]),"text-transform":new ut(ot.layout_symbol["text-transform"]),"text-offset":new ut(ot.layout_symbol["text-offset"]),"text-allow-overlap":new Ke(ot.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ke(ot.layout_symbol["text-ignore-placement"]),"text-optional":new Ke(ot.layout_symbol["text-optional"])});var Zh={paint:new jt({"icon-opacity":new ut(ot.paint_symbol["icon-opacity"]),"icon-color":new ut(ot.paint_symbol["icon-color"]),"icon-halo-color":new ut(ot.paint_symbol["icon-halo-color"]),"icon-halo-width":new ut(ot.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ut(ot.paint_symbol["icon-halo-blur"]),"icon-translate":new Ke(ot.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ke(ot.paint_symbol["icon-translate-anchor"]),"text-opacity":new ut(ot.paint_symbol["text-opacity"]),"text-color":new ut(ot.paint_symbol["text-color"],{runtimeType:$n,getOverride:l=>l.textColor,hasOverride:l=>!!l.textColor}),"text-halo-color":new ut(ot.paint_symbol["text-halo-color"]),"text-halo-width":new ut(ot.paint_symbol["text-halo-width"]),"text-halo-blur":new ut(ot.paint_symbol["text-halo-blur"]),"text-translate":new Ke(ot.paint_symbol["text-translate"]),"text-translate-anchor":new Ke(ot.paint_symbol["text-translate-anchor"])}),layout:t_};class up{constructor(n){this.type=n.property.overrides?n.property.overrides.runtimeType:Do,this.defaultValue=n}evaluate(n){if(n.formattedSection){const c=this.defaultValue.property.overrides;if(c&&c.hasOverride(n.formattedSection))return c.getOverride(n.formattedSection)}return n.feature&&n.featureState?this.defaultValue.evaluate(n.feature,n.featureState):this.defaultValue.property.specification.default}eachChild(n){this.defaultValue.isConstant()||n(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ti(up,"FormatSectionOverride",{omit:["defaultValue"]});class Xu extends Xo{constructor(n){super(n,Zh)}recalculate(n,c){super.recalculate(n,c),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const f=this.layout.get("text-writing-mode");if(f){const m=[];for(const x of f)m.indexOf(x)<0&&m.push(x);this.layout._values["text-writing-mode"]=m}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(n,c,f,m){const x=this.layout.get(n).evaluate(c,{},f,m),E=this._unevaluatedLayout._values[n];return E.isDataDriven()||cs(E.value)||!x?x:function(M,I){return I.replace(/{([^{}]+)}/g,(P,z)=>z in M?String(M[z]):"")}(c.properties,x)}createBucket(n){return new Es(n)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const n of Zh.paint.overridableProperties){if(!Xu.hasPaintOverride(this.layout,n))continue;const c=this.paint.get(n),f=new up(c),m=new jo(f,c.property.specification);let x=null;x=c.value.kind==="constant"||c.value.kind==="source"?new gl("source",m):new Fa("composite",m,c.value.zoomStops,c.value._interpolationType),this.paint._values[n]=new zt(c.property,x,c.parameters)}}_handleOverridablePaintPropertyUpdate(n,c,f){return!(!this.layout||c.isDataDriven()||f.isDataDriven())&&Xu.hasPaintOverride(this.layout,n)}static hasPaintOverride(n,c){const f=n.get("text-field"),m=Zh.paint.properties[c];let x=!1;const E=M=>{for(const I of M)if(m.overrides&&m.overrides.hasOverride(I))return void(x=!0)};if(f.value.kind==="constant"&&f.value.value instanceof mn)E(f.value.value.sections);else if(f.value.kind==="source"){const M=P=>{x||(P instanceof Jo&&Qr(P.value)===ke?E(P.value.sections):P instanceof Ea?E(P.sections):P.eachChild(M))},I=f.value;I._styleExpression&&M(I._styleExpression.expression)}return x}getProgramConfiguration(n){return new vs(this,n)}}var i_={paint:new jt({"background-color":new Ke(ot.paint_background["background-color"]),"background-pattern":new Ke(ot.paint_background["background-pattern"]),"background-opacity":new Ke(ot.paint_background["background-opacity"])})},r_={paint:new jt({"raster-opacity":new Ke(ot.paint_raster["raster-opacity"]),"raster-hue-rotate":new Ke(ot.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ke(ot.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ke(ot.paint_raster["raster-brightness-max"]),"raster-saturation":new Ke(ot.paint_raster["raster-saturation"]),"raster-contrast":new Ke(ot.paint_raster["raster-contrast"]),"raster-resampling":new Ke(ot.paint_raster["raster-resampling"]),"raster-fade-duration":new Ke(ot.paint_raster["raster-fade-duration"])})};class n_ extends Xo{constructor(n){super(n,{}),this.implementation=n}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isLayerDraped(){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(n){this.implementation.onAdd&&this.implementation.onAdd(n,n.painter.context.gl)}onRemove(n){this.implementation.onRemove&&this.implementation.onRemove(n,n.painter.context.gl)}}var o_={paint:new jt({"sky-type":new Ke(ot.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ke(ot.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ke(ot.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ke(ot.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ke(ot.paint_sky["sky-gradient-radius"]),"sky-gradient":new Lt(ot.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ke(ot.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ke(ot.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ke(ot.paint_sky["sky-opacity"])})};function Hh(l,n,c){const f=[0,0,1],m=Rd([]);return Ld(m,m,c?-ae(l)+Math.PI:ae(l)),Pd(m,m,-ae(n)),Cd(f,f,m),Vn(f,f)}const a_={circle:class extends Xo{constructor(l){super(l,_m)}createBucket(l){return new wh(l)}queryRadius(l){const n=l;return $l("circle-radius",this,n)+$l("circle-stroke-width",this,n)+Su(this.paint.get("circle-translate"))}queryIntersectsFeature(l,n,c,f,m,x,E,M){const I=tf(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),x.angle,l.pixelToTileUnitsFactor),P=this.paint.get("circle-radius").evaluate(n,c)+this.paint.get("circle-stroke-width").evaluate(n,c);return rf(l,f,x,E,M,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",I,P)}getProgramIds(){return["circle"]}getProgramConfiguration(l){return new vs(this,l)}},heatmap:class extends Xo{createBucket(l){return new of(l)}constructor(l){super(l,bm),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(l){l==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Mh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(l){return $l("heatmap-radius",this,l)}queryIntersectsFeature(l,n,c,f,m,x,E,M){const I=this.paint.get("heatmap-radius").evaluate(n,c);return rf(l,f,x,E,M,!0,!0,new W(0,0),I)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(l){return new vs(this,l)}},hillshade:class extends Xo{constructor(l){super(l,wm)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}},fill:class extends Xo{constructor(l){super(l,zm)}getProgramIds(){const l=this.paint.get("fill-pattern"),n=l&&l.constantOr(1),c=[n?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&c.push(n&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),c}getProgramConfiguration(l){return new vs(this,l)}recalculate(l,n){super.recalculate(l,n);const c=this.paint._values["fill-outline-color"];c.value.kind==="constant"&&c.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(l){return new ku(l)}queryRadius(){return Su(this.paint.get("fill-translate"))}queryIntersectsFeature(l,n,c,f,m,x){return!l.queryGeometry.isAboveHorizon&&Wd(ef(l.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),x.angle,l.pixelToTileUnitsFactor),f)}isTileClipped(){return!0}},"fill-extrusion":class extends Xo{constructor(l){super(l,eg)}createBucket(l){return new Cc(l)}queryRadius(){return Su(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(l){return new vs(this,l)}queryIntersectsFeature(l,n,c,f,m,x,E,M,I){const P=tf(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),x.angle,l.pixelToTileUnitsFactor),z=this.paint.get("fill-extrusion-height").evaluate(n,c),N=this.paint.get("fill-extrusion-base").evaluate(n,c),q=[0,0],K=M&&x.elevation,ee=x.elevation?x.elevation.exaggeration():1,oe=l.tile.getBucket(this);if(K&&oe instanceof Cc){const De=oe.centroidVertexArray,ze=I+1;ze<De.length&&(q[0]=De.geta_centroid_pos0(ze),q[1]=De.geta_centroid_pos1(ze))}if(q[0]===0&&q[1]===1)return!1;x.projection.name==="globe"&&(f=Ef([f],[new W(0,0),new W(Zi,Zi)],l.tileID.canonical).map(De=>De.polygon).flat());const pe=K?M:null,[Ee,Re]=function(De,ze,Le,st,it,wt,Gt,ft,kt,Rt,Ft){return De.projection.name==="globe"?function(Zt,pt,oi,Vi,pi,ki,ai,qi,sr,or,ir){const Gi=[],br=[],Wi=Zt.projection.upVectorScale(ir,Zt.center.lat,Zt.worldSize).metersToTile,lr=[0,0,0,1],Tr=[0,0,0,1],Br=(Or,Nr,Wr,bn)=>{Or[0]=Nr,Or[1]=Wr,Or[2]=bn,Or[3]=1},Pr=wf();oi>0&&(oi+=Pr),Vi+=Pr;for(const Or of pt){const Nr=[],Wr=[];for(const bn of Or){const wr=bn.x+pi.x,dn=bn.y+pi.y,un=Zt.projection.projectTilePoint(wr,dn,ir),gr=Zt.projection.upVector(ir,bn.x,bn.y);let qr=oi,pn=Vi;if(ai){const Sr=Af(wr,dn,oi,Vi,ai,qi,sr,or);qr+=Sr.base,pn+=Sr.top}oi!==0?Br(lr,un.x+gr[0]*Wi*qr,un.y+gr[1]*Wi*qr,un.z+gr[2]*Wi*qr):Br(lr,un.x,un.y,un.z),Br(Tr,un.x+gr[0]*Wi*pn,un.y+gr[1]*Wi*pn,un.z+gr[2]*Wi*pn),tn(lr,lr,ki),tn(Tr,Tr,ki),Nr.push(new Fl(lr[0],lr[1],lr[2])),Wr.push(new Fl(Tr[0],Tr[1],Tr[2]))}Gi.push(Nr),br.push(Wr)}return[Gi,br]}(De,ze,Le,st,it,wt,Gt,ft,kt,Rt,Ft):Gt?function(Zt,pt,oi,Vi,pi,ki,ai,qi,sr){const or=[],ir=[],Gi=[0,0,0,1];for(const br of Zt){const Wi=[],lr=[];for(const Tr of br){const Br=Tr.x+Vi.x,Pr=Tr.y+Vi.y,Or=Af(Br,Pr,pt,oi,ki,ai,qi,sr);Gi[0]=Br,Gi[1]=Pr,Gi[2]=Or.base,Gi[3]=1,Js(Gi,Gi,pi),Gi[3]=Math.max(Gi[3],1e-5);const Nr=new Fl(Gi[0]/Gi[3],Gi[1]/Gi[3],Gi[2]/Gi[3]);Gi[0]=Br,Gi[1]=Pr,Gi[2]=Or.top,Gi[3]=1,Js(Gi,Gi,pi),Gi[3]=Math.max(Gi[3],1e-5);const Wr=new Fl(Gi[0]/Gi[3],Gi[1]/Gi[3],Gi[2]/Gi[3]);Wi.push(Nr),lr.push(Wr)}or.push(Wi),ir.push(lr)}return[or,ir]}(ze,Le,st,it,wt,Gt,ft,kt,Rt):function(Zt,pt,oi,Vi,pi){const ki=[],ai=[],qi=pi[8]*pt,sr=pi[9]*pt,or=pi[10]*pt,ir=pi[11]*pt,Gi=pi[8]*oi,br=pi[9]*oi,Wi=pi[10]*oi,lr=pi[11]*oi;for(const Tr of Zt){const Br=[],Pr=[];for(const Or of Tr){const Nr=Or.x+Vi.x,Wr=Or.y+Vi.y,bn=pi[0]*Nr+pi[4]*Wr+pi[12],wr=pi[1]*Nr+pi[5]*Wr+pi[13],dn=pi[2]*Nr+pi[6]*Wr+pi[14],un=pi[3]*Nr+pi[7]*Wr+pi[15],gr=bn+qi,qr=wr+sr,pn=dn+or,Sr=Math.max(un+ir,1e-5),rn=bn+Gi,Fn=wr+br,wn=dn+Wi,En=Math.max(un+lr,1e-5);Br.push(new Fl(gr/Sr,qr/Sr,pn/Sr)),Pr.push(new Fl(rn/En,Fn/En,wn/En))}ki.push(Br),ai.push(Pr)}return[ki,ai]}(ze,Le,st,it,wt)}(x,f,N,z,P,E,pe,q,ee,x.center.lat,l.tileID.canonical),be=l.queryGeometry;return function(De,ze,Le){let st=1/0;Wd(Le,ze)&&(st=Mf(Le,ze[0]));for(let it=0;it<ze.length;it++){const wt=ze[it],Gt=De[it];for(let ft=0;ft<wt.length-1;ft++){const kt=wt[ft],Rt=[kt,wt[ft+1],Gt[ft+1],Gt[ft],kt];Yd(Le,Rt)&&(st=Math.min(st,Mf(Le,Rt)))}}return st!==1/0&&st}(Ee,Re,be.isPointQuery()?be.screenBounds:be.screenGeometry)}},line:class extends Xo{constructor(l){super(l,Cf),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(l){if(l==="line-gradient"){const n=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=n._styleExpression&&n._styleExpression.expression instanceof Xn,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(l,n){super.recalculate(l,n),this.paint._values["line-floorwidth"]=If.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,l)}createBucket(l){return new $u(l)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(l){return new vs(this,l)}queryRadius(l){const n=l,c=kf($l("line-width",this,n),$l("line-gap-width",this,n)),f=$l("line-offset",this,n);return c/2+Math.abs(f)+Su(this.paint.get("line-translate"))}queryIntersectsFeature(l,n,c,f,m,x){if(l.queryGeometry.isAboveHorizon)return!1;const E=ef(l.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),x.angle,l.pixelToTileUnitsFactor),M=l.pixelToTileUnitsFactor/2*kf(this.paint.get("line-width").evaluate(n,c),this.paint.get("line-gap-width").evaluate(n,c)),I=this.paint.get("line-offset").evaluate(n,c);return I&&(f=function(P,z){const N=[],q=new W(0,0);for(let K=0;K<P.length;K++){const ee=P[K],oe=[];for(let pe=0;pe<ee.length;pe++){const Ee=ee[pe-1],Re=ee[pe],be=ee[pe+1],De=pe===0?q:Re.sub(Ee)._unit()._perp(),ze=pe===ee.length-1?q:be.sub(Re)._unit()._perp(),Le=De._add(ze)._unit();Le._mult(1/(Le.x*ze.x+Le.y*ze.y)),oe.push(Le._mult(z)._add(Re))}N.push(oe)}return N}(f,I*l.pixelToTileUnitsFactor)),function(P,z,N){for(let q=0;q<z.length;q++){const K=z[q];if(P.length>=3){for(let ee=0;ee<K.length;ee++)if(rl(P,K[ee]))return!0}if(fm(P,K,N))return!0}return!1}(E,f,M)}isTileClipped(){return!0}},symbol:Xu,background:class extends Xo{constructor(l){super(l,i_)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends Xo{constructor(l){super(l,r_)}getProgramIds(){return["raster"]}},sky:class extends Xo{constructor(l){super(l,o_),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(l){l==="sky-gradient"?this._updateColorRamp():l!=="sky-atmosphere-sun"&&l!=="sky-atmosphere-halo-color"&&l!=="sky-atmosphere-color"&&l!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Mh({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(l){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const n=l.style.light.properties.get("position");return this._lightPosition.azimuthal!==n.azimuthal||this._lightPosition.polar!==n.polar}return!1}getCenter(l,n){if(this.paint.get("sky-type")==="atmosphere"){const f=this.paint.get("sky-atmosphere-sun"),m=!f,x=l.style.light,E=x.properties.get("position");return m&&x.properties.get("anchor")==="viewport"&&vi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),m?Hh(E.azimuthal,90-E.polar,n):Hh(f[0],90-f[1],n)}const c=this.paint.get("sky-gradient-center");return Hh(c[0],90-c[1],n)}is3D(){return!1}isSky(){return!0}markSkyboxValid(l){this._skyboxInvalidated=!1,this._lightPosition=l.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const l=this.paint.get("sky-type");return l==="atmosphere"?["skyboxCapture","skybox"]:l==="gradient"?["skyboxGradient"]:null}}};class Fc{constructor(n,c,f,m){this.context=n,this.format=f,this.texture=n.gl.createTexture(),this.update(c,m)}update(n,c,f){const{width:m,height:x}=n,{context:E}=this,{gl:M}=E,{HTMLImageElement:I,HTMLCanvasElement:P,HTMLVideoElement:z,ImageData:N,ImageBitmap:q}=b;if(M.bindTexture(M.TEXTURE_2D,this.texture),E.pixelStoreUnpackFlipY.set(!1),E.pixelStoreUnpack.set(1),E.pixelStoreUnpackPremultiplyAlpha.set(this.format===M.RGBA&&(!c||c.premultiply!==!1)),f||this.size&&this.size[0]===m&&this.size[1]===x){const{x:K,y:ee}=f||{x:0,y:0};n instanceof I||n instanceof P||n instanceof z||n instanceof N||q&&n instanceof q?M.texSubImage2D(M.TEXTURE_2D,0,K,ee,M.RGBA,M.UNSIGNED_BYTE,n):M.texSubImage2D(M.TEXTURE_2D,0,K,ee,m,x,M.RGBA,M.UNSIGNED_BYTE,n.data)}else this.size=[m,x],n instanceof I||n instanceof P||n instanceof z||n instanceof N||q&&n instanceof q?M.texImage2D(M.TEXTURE_2D,0,this.format,this.format,M.UNSIGNED_BYTE,n):M.texImage2D(M.TEXTURE_2D,0,this.format,m,x,0,this.format,M.UNSIGNED_BYTE,n.data);this.useMipmap=!!(c&&c.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&M.generateMipmap(M.TEXTURE_2D)}bind(n,c){const{context:f}=this,{gl:m}=f;m.bindTexture(m.TEXTURE_2D,this.texture),n!==this.filter&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,n),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,this.useMipmap?n===m.NEAREST?m.NEAREST_MIPMAP_NEAREST:m.LINEAR_MIPMAP_NEAREST:n),this.filter=n),c!==this.wrap&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,c),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,c),this.wrap=c)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}}class s_{constructor(n){this._callback=n,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class l_{constructor(){this.tasks={},this.taskQueue=[],Et(["process"],this),this.invoker=new s_(this.process),this.nextId=0}add(n,c){const f=this.nextId++,m=function({type:x,isSymbolTile:E,zoom:M}){return M=M||0,x==="message"?0:x!=="maybePrepare"||E?x!=="parseTile"||E?x==="parseTile"&&E?300-M:x==="maybePrepare"&&E?400-M:500:200-M:100-M}(c);if(m===0){$t();try{n()}finally{}return{cancel:()=>{}}}return this.tasks[f]={fn:n,metadata:c,priority:m,id:f},this.taskQueue.push(f),this.invoker.trigger(),{cancel:()=>{delete this.tasks[f]}}}process(){$t();try{if(this.taskQueue=this.taskQueue.filter(f=>!!this.tasks[f]),!this.taskQueue.length)return;const n=this.pick();if(n===null)return;const c=this.tasks[n];if(delete this.tasks[n],this.taskQueue.length&&this.invoker.trigger(),!c)return;c.fn()}finally{}}pick(){let n=null,c=1/0;for(let m=0;m<this.taskQueue.length;m++){const x=this.tasks[this.taskQueue[m]];x.priority<c&&(c=x.priority,n=m)}if(n===null)return null;const f=this.taskQueue[n];return this.taskQueue.splice(n,1),f}remove(){this.invoker.remove()}}class hp{constructor(n){this._stringToNumber={},this._numberToString=[];for(let c=0;c<n.length;c++){const f=n[c];this._stringToNumber[f]=c,this._numberToString[c]=f}}encode(n){return this._stringToNumber[n]}decode(n){return this._numberToString[n]}}const c_=["tile","layer","source","sourceLayer","state"];class dp{constructor(n,c,f,m,x){this.type="Feature",this._vectorTileFeature=n,this._z=c,this._x=f,this._y=m,this.properties=n.properties,this.id=x}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(n){this._geometry=n}toJSON(){const n={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};this.id!==void 0&&(n.id=this.id);for(const c of c_)this[c]!==void 0&&(n[c]=this[c]);return n}}const ko=32,ya=33,Ts=new Uint16Array(8184);for(let l=0;l<2046;l++){let n=l+2,c=0,f=0,m=0,x=0,E=0,M=0;for(1&n?m=x=E=ko:c=f=M=ko;(n>>=1)>1;){const P=c+m>>1,z=f+x>>1;1&n?(m=c,x=f,c=E,f=M):(c=m,f=x,m=E,x=M),E=P,M=z}const I=4*l;Ts[I+0]=c,Ts[I+1]=f,Ts[I+2]=m,Ts[I+3]=x}const va=new Uint16Array(2178),Ss=new Uint8Array(1089),Yu=new Uint16Array(1089);function fp(l){return l===0?-.03125:l===32?.03125:0}var pp=Oi([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const mp={type:2,extent:Zi,loadGeometry:()=>[[new W(0,0),new W(8193,0),new W(8193,8193),new W(0,8193),new W(0,0)]]};class Xh{constructor(n,c,f,m,x){this.tileID=n,this.uid=Mt(),this.uses=0,this.tileSize=c,this.tileZoom=f,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=x,this.expiredRequestCount=0,this.state="loading",m&&m.transform&&(this.projection=m.transform.projection)}registerFadeDuration(n){const c=n+this.timeAdded;c<Yt.now()||this.fadeEndTime&&c<this.fadeEndTime||(this.fadeEndTime=c)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=ol(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(n,c,f){if(this.unloadVectorData(),this.state="loaded",n){n.featureIndex&&(this.latestFeatureIndex=n.featureIndex,n.rawTileData?(this.latestRawTileData=n.rawTileData,this.latestFeatureIndex.rawTileData=n.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=n.collisionBoxArray,this.buckets=function(m,x){const E={};if(!x)return E;for(const M of m){const I=M.layerIds.map(P=>x.getLayer(P)).filter(Boolean);if(I.length!==0){M.layers=I,M.stateDependentLayerIds&&(M.stateDependentLayers=M.stateDependentLayerIds.map(P=>I.filter(z=>z.id===P)[0]));for(const P of I)E[P.id]=M}}return E}(n.buckets,c.style),this.hasSymbolBuckets=!1;for(const m in this.buckets){const x=this.buckets[m];if(x instanceof Es){if(this.hasSymbolBuckets=!0,!f)break;x.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const m in this.buckets){const x=this.buckets[m];if(x instanceof Es&&x.hasRTLText){this.hasRTLText=!0,qe.isLoading()||qe.isLoaded()||Fe()!=="deferred"||$e();break}}this.queryPadding=0;for(const m in this.buckets){const x=this.buckets[m];this.queryPadding=Math.max(this.queryPadding,c.style.getLayer(m).queryRadius(x))}n.imageAtlas&&(this.imageAtlas=n.imageAtlas),n.glyphAtlasImage&&(this.glyphAtlasImage=n.glyphAtlasImage),n.lineAtlas&&(this.lineAtlas=n.lineAtlas)}else this.collisionBoxArray=new th}unloadVectorData(){if(this.hasData()){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(n){return this.buckets[n.id]}upload(n){for(const f in this.buckets){const m=this.buckets[f];m.uploadPending()&&m.upload(n)}const c=n.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Fc(n,this.imageAtlas.image,c.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Fc(n,this.glyphAtlasImage,c.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new Fc(n,this.lineAtlas.image,c.ALPHA),this.lineAtlas.uploaded=!0)}prepare(n){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(n,this.imageAtlasTexture)}queryRenderedFeatures(n,c,f,m,x,E,M,I){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:m,pixelPosMatrix:M,transform:E,params:x,tileTransform:this.tileTransform},n,c,f):{}}querySourceFeatures(n,c){const f=this.latestFeatureIndex;if(!f||!f.rawTileData)return;const m=f.loadVTLayers(),x=c?c.sourceLayer:"",E=m._geojsonTileLayer||m[x];if(!E)return;const M=yl(c&&c.filter),{z:I,x:P,y:z}=this.tileID.canonical,N={z:I,x:P,y:z};for(let q=0;q<E.length;q++){const K=E.feature(q);if(M.needGeometry){const pe=il(K,!0);if(!M.filter(new Je(this.tileID.overscaledZ),pe,this.tileID.canonical))continue}else if(!M.filter(new Je(this.tileID.overscaledZ),K))continue;const ee=f.getId(K,x),oe=new dp(K,I,P,z,ee);oe.tile=N,n.push(oe)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(n){const c=this.expirationTime;if(n.cacheControl){const f=Mi(n.cacheControl);f["max-age"]&&(this.expirationTime=Date.now()+1e3*f["max-age"])}else n.expires&&(this.expirationTime=new Date(n.expires).getTime());if(this.expirationTime){const f=Date.now();let m=!1;if(this.expirationTime>f)m=!1;else if(c)if(this.expirationTime<c)m=!0;else{const x=this.expirationTime-c;x?this.expirationTime=f+Math.max(x,3e4):m=!0}else m=!0;m?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(n,c){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(n).length===0||!c)return;const f=this.latestFeatureIndex.loadVTLayers(),m=c.style.listImages();for(const x in this.buckets){if(!c.style.hasLayer(x))continue;const E=this.buckets[x],M=E.layers[0].sourceLayer||"_geojsonTileLayer",I=f[M],P=n[M];if(!I||!P||Object.keys(P).length===0)continue;if(E.update(P,I,m,this.imageAtlas&&this.imageAtlas.patternPositions||{}),E instanceof $u||E instanceof ku){const N=c.style._getSourceCache(E.layers[0].source);c._terrain&&c._terrain.enabled&&N&&E.programConfigurations.needsUpload&&c._terrain._clearRenderCacheForTile(N.id,this.tileID)}const z=c&&c.style&&c.style.getLayer(x);z&&(this.queryPadding=Math.max(this.queryPadding,z.queryRadius(E)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Yt.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(n){this.symbolFadeHoldUntil=Yt.now()+n}setTexture(n,c){const f=c.context,m=f.gl;this.texture=this.texture||c.getTileTexture(n.width),this.texture?this.texture.update(n,{useMipmap:!0}):(this.texture=new Fc(f,n,m.RGBA,{useMipmap:!0}),this.texture.bind(m.LINEAR,m.CLAMP_TO_EDGE))}setDependencies(n,c){const f={};for(const m of c)f[m]=!0;this.dependencies[n]=f}hasDependency(n,c){for(const f of n){const m=this.dependencies[f];if(m){for(const x of c)if(m[x])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(n,c){if(!c||c.name==="mercator"||this._tileDebugBuffer)return;const f=qa(mp,this.tileID.canonical,this.tileTransform)[0],m=new Ui,x=new da;for(let E=0;E<f.length;E++){const{x:M,y:I}=f[E];m.emplaceBack(M,I),x.emplaceBack(E)}x.emplaceBack(0),this._tileDebugIndexBuffer=n.createIndexBuffer(x),this._tileDebugBuffer=n.createVertexBuffer(m,_c.members),this._tileDebugSegments=ln.simpleSegment(0,0,m.length,x.length)}_makeTileBoundsBuffers(n,c){if(this._tileBoundsBuffer||!c||c.name==="mercator")return;const f=qa(mp,this.tileID.canonical,this.tileTransform)[0];let m,x;if(this.isRaster){const E=function(M,I){const P=ol(M,I),z=Math.pow(2,M.z);for(let pe=0;pe<ya;pe++)for(let Ee=0;Ee<ya;Ee++){const Re=yo((M.x+(Ee+fp(Ee))/ko)/z),be=Rn((M.y+(pe+fp(pe))/ko)/z),De=I.project(Re,be),ze=pe*ya+Ee;va[2*ze+0]=Math.round((De.x*P.scale-P.x)*Zi),va[2*ze+1]=Math.round((De.y*P.scale-P.y)*Zi)}Ss.fill(0),Yu.fill(0);for(let pe=2045;pe>=0;pe--){const Ee=4*pe,Re=Ts[Ee+0],be=Ts[Ee+1],De=Ts[Ee+2],ze=Ts[Ee+3],Le=Re+De>>1,st=be+ze>>1,it=Le+st-be,wt=st+Re-Le,Gt=be*ya+Re,ft=ze*ya+De,kt=st*ya+Le,Rt=Math.hypot((va[2*Gt+0]+va[2*ft+0])/2-va[2*kt+0],(va[2*Gt+1]+va[2*ft+1])/2-va[2*kt+1])>=16;if(Ss[kt]=Ss[kt]||(Rt?1:0),pe<1022){const Ft=(be+wt>>1)*ya+(Re+it>>1),Zt=(ze+wt>>1)*ya+(De+it>>1);Ss[kt]=Ss[kt]||Ss[Ft]||Ss[Zt]}}const N=new vr,q=new Dn;let K=0;function ee(pe,Ee){const Re=Ee*ya+pe;return Yu[Re]===0&&(N.emplaceBack(va[2*Re+0],va[2*Re+1],pe*Zi/ko,Ee*Zi/ko),Yu[Re]=++K),Yu[Re]-1}function oe(pe,Ee,Re,be,De,ze){const Le=pe+Re>>1,st=Ee+be>>1;if(Math.abs(pe-De)+Math.abs(Ee-ze)>1&&Ss[st*ya+Le])oe(De,ze,pe,Ee,Le,st),oe(Re,be,De,ze,Le,st);else{const it=ee(pe,Ee),wt=ee(Re,be),Gt=ee(De,ze);q.emplaceBack(it,wt,Gt)}}return oe(0,0,ko,ko,ko,0),oe(ko,ko,0,0,0,ko),{vertices:N,indices:q}}(this.tileID.canonical,c);m=E.vertices,x=E.indices}else{m=new vr,x=new Dn;for(const{x:M,y:I}of f)m.emplaceBack(M,I,0,0);const E=Bl(m.int16,void 0,4);for(let M=0;M<E.length;M+=3)x.emplaceBack(E[M],E[M+1],E[M+2])}this._tileBoundsBuffer=n.createVertexBuffer(m,pp.members),this._tileBoundsIndexBuffer=n.createIndexBuffer(x),this._tileBoundsSegments=ln.simpleSegment(0,0,m.length,x.length)}_makeGlobeTileDebugBuffers(n,c){const f=c.projection;if(!f||f.name!=="globe"||c.freezeTileCoverage)return;const m=this.tileID.canonical,x=xc(zd(m,c)),E=Pl(c.zoom);let M;E>0&&(M=ah(new Float64Array(16),c.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(n,m,c,x,M,E),this._makeGlobeTileDebugTextBuffer(n,m,c,x,M,E)}_globePoint(n,c,f,m,x,E,M){let I=vc(n,c,f);if(E){const P=1<<f.z,z=ma(m.center.lng),N=ga(m.center.lat),q=(f.x+.5)/P-z;let K=0;q>.5?K=-1:q<-.5&&(K=1);let ee=(n/Zi+f.x)/P+K,oe=(c/Zi+f.y)/P;ee=(ee-z)*m._pixelsPerMercatorPixel+z,oe=(oe-N)*m._pixelsPerMercatorPixel+N;const pe=[ee*m.worldSize,oe*m.worldSize,0];tn(pe,pe,E),I=tl(I,pe,M)}return tn(I,I,x)}_makeGlobeTileDebugBorderBuffer(n,c,f,m,x,E){const M=new Ui,I=new da,P=new yr,z=(q,K,ee,oe,pe)=>{const Ee=(ee-q)/(pe-1),Re=(oe-K)/(pe-1),be=M.length;for(let De=0;De<pe;De++){const ze=q+De*Ee,Le=K+De*Re;M.emplaceBack(ze,Le);const st=this._globePoint(ze,Le,c,f,m,x,E);P.emplaceBack(st[0],st[1],st[2]),I.emplaceBack(be+De)}},N=Zi;z(0,0,N,0,16),z(N,0,N,N,16),z(N,N,0,N,16),z(0,N,0,0,16),this._tileDebugIndexBuffer=n.createIndexBuffer(I),this._tileDebugBuffer=n.createVertexBuffer(M,_c.members),this._globeTileDebugBorderBuffer=n.createVertexBuffer(P,Bd.members),this._tileDebugSegments=ln.simpleSegment(0,0,M.length,I.length)}_makeGlobeTileDebugTextBuffer(n,c,f,m,x,E){const M=new Ui,I=new Dn,P=new yr,z=25;I.reserve(32),M.reserve(z),P.reserve(z);const N=(q,K)=>z*q+K;for(let q=0;q<z;q++){const K=2048*q;for(let ee=0;ee<z;ee++){const oe=2048*ee;M.emplaceBack(oe,K);const pe=this._globePoint(oe,K,c,f,m,x,E);P.emplaceBack(pe[0],pe[1],pe[2])}}for(let q=0;q<4;q++)for(let K=0;K<4;K++){const ee=N(q,K),oe=N(q,K+1),pe=N(q+1,K),Ee=N(q+1,K+1);I.emplaceBack(ee,oe,pe),I.emplaceBack(pe,oe,Ee)}this._tileDebugTextIndexBuffer=n.createIndexBuffer(I),this._tileDebugTextBuffer=n.createVertexBuffer(M,_c.members),this._globeTileDebugTextBuffer=n.createVertexBuffer(P,Bd.members),this._tileDebugTextSegments=ln.simpleSegment(0,0,z,32)}}class u_{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(n,c,f){const m=String(c);if(this.stateChanges[n]=this.stateChanges[n]||{},this.stateChanges[n][m]=this.stateChanges[n][m]||{},tt(this.stateChanges[n][m],f),this.deletedStates[n]===null){this.deletedStates[n]={};for(const x in this.state[n])x!==m&&(this.deletedStates[n][x]=null)}else if(this.deletedStates[n]&&this.deletedStates[n][m]===null){this.deletedStates[n][m]={};for(const x in this.state[n][m])f[x]||(this.deletedStates[n][m][x]=null)}else for(const x in f)this.deletedStates[n]&&this.deletedStates[n][m]&&this.deletedStates[n][m][x]===null&&delete this.deletedStates[n][m][x]}removeFeatureState(n,c,f){if(this.deletedStates[n]===null)return;const m=String(c);if(this.deletedStates[n]=this.deletedStates[n]||{},f&&c!==void 0)this.deletedStates[n][m]!==null&&(this.deletedStates[n][m]=this.deletedStates[n][m]||{},this.deletedStates[n][m][f]=null);else if(c!==void 0)if(this.stateChanges[n]&&this.stateChanges[n][m])for(f in this.deletedStates[n][m]={},this.stateChanges[n][m])this.deletedStates[n][m][f]=null;else this.deletedStates[n][m]=null;else this.deletedStates[n]=null}getState(n,c){const f=String(c),m=tt({},(this.state[n]||{})[f],(this.stateChanges[n]||{})[f]);if(this.deletedStates[n]===null)return{};if(this.deletedStates[n]){const x=this.deletedStates[n][c];if(x===null)return{};for(const E in x)delete m[E]}return m}initializeTileState(n,c){n.setFeatureState(this.state,c)}coalesceChanges(n,c){const f={};for(const m in this.stateChanges){this.state[m]=this.state[m]||{};const x={};for(const E in this.stateChanges[m])this.state[m][E]||(this.state[m][E]={}),tt(this.state[m][E],this.stateChanges[m][E]),x[E]=this.state[m][E];f[m]=x}for(const m in this.deletedStates){this.state[m]=this.state[m]||{};const x={};if(this.deletedStates[m]===null)for(const E in this.state[m])x[E]={},this.state[m][E]={};else for(const E in this.deletedStates[m]){if(this.deletedStates[m][E]===null)this.state[m][E]={};else if(this.state[m][E])for(const M of Object.keys(this.deletedStates[m][E]))delete this.state[m][E][M];x[E]=this.state[m][E]}f[m]=f[m]||{},tt(f[m],x)}if(this.stateChanges={},this.deletedStates={},Object.keys(f).length!==0)for(const m in n)n[m].setFeatureState(f,c)}}class gp{constructor(n){this.size=n,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(n,c){const f=this.toIdx(n,c);return{min:this.minimums[f],max:this.maximums[f]}}isLeaf(n,c){return this.leaves[this.toIdx(n,c)]}toIdx(n,c){return c*this.size+n}}function _p(l,n,c,f){let m=0,x=Number.MAX_VALUE;for(let E=0;E<3;E++)if(Math.abs(f[E])<1e-15){if(c[E]<l[E]||c[E]>n[E])return null}else{const M=1/f[E];let I=(l[E]-c[E])*M,P=(n[E]-c[E])*M;if(I>P){const z=I;I=P,P=z}if(I>m&&(m=I),P<x&&(x=P),m>x)return null}return m}function yp(l,n,c,f,m,x,E,M,I,P,z){const N=f-l,q=m-n,K=x-c,ee=E-l,oe=M-n,pe=I-c,Ee=z[1]*pe-z[2]*oe,Re=z[2]*ee-z[0]*pe,be=z[0]*oe-z[1]*ee,De=N*Ee+q*Re+K*be;if(Math.abs(De)<1e-15)return null;const ze=1/De,Le=P[0]-l,st=P[1]-n,it=P[2]-c,wt=(Le*Ee+st*Re+it*be)*ze;if(wt<0||wt>1)return null;const Gt=st*K-it*q,ft=it*N-Le*K,kt=Le*q-st*N,Rt=(z[0]*Gt+z[1]*ft+z[2]*kt)*ze;return Rt<0||wt+Rt>1?null:(ee*Gt+oe*ft+pe*kt)*ze}function vp(l,n,c){return(l-n)/(c-n)}function xp(l,n,c,f,m,x,E,M,I){const P=1<<c,z=x-f,N=E-m,q=(l+1)/P*z+f,K=(n+0)/P*N+m,ee=(n+1)/P*N+m;M[0]=(l+0)/P*z+f,M[1]=K,I[0]=q,I[1]=ee}class bp{constructor(n){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=n,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const c=function(x){const E=Math.ceil(Math.log2(x.dim/8)),M=[];let I=Math.ceil(Math.pow(2,E));const P=1/I,z=(K,ee,oe,pe,Ee)=>{const Re=pe?1:0,be=(K+1)*oe-Re,De=ee*oe,ze=(ee+1)*oe-Re;Ee[0]=K*oe,Ee[1]=De,Ee[2]=be,Ee[3]=ze};let N=new gp(I);const q=[];for(let K=0;K<I*I;K++){z(K%I,Math.floor(K/I),P,!1,q);const ee=Ms(q[0],q[1],x),oe=Ms(q[2],q[1],x),pe=Ms(q[2],q[3],x),Ee=Ms(q[0],q[3],x);N.minimums.push(Math.min(ee,oe,pe,Ee)),N.maximums.push(Math.max(ee,oe,pe,Ee)),N.leaves.push(1)}for(M.push(N),I/=2;I>=1;I/=2){const K=M[M.length-1];N=new gp(I);for(let ee=0;ee<I*I;ee++){z(ee%I,Math.floor(ee/I),2,!0,q);const oe=K.getElevation(q[0],q[1]),pe=K.getElevation(q[2],q[1]),Ee=K.getElevation(q[2],q[3]),Re=K.getElevation(q[0],q[3]),be=K.isLeaf(q[0],q[1]),De=K.isLeaf(q[2],q[1]),ze=K.isLeaf(q[2],q[3]),Le=K.isLeaf(q[0],q[3]),st=Math.min(oe.min,pe.min,Ee.min,Re.min),it=Math.max(oe.max,pe.max,Ee.max,Re.max),wt=be&&De&&ze&&Le;N.maximums.push(it),N.minimums.push(st),N.leaves.push(it-st<=5&&wt?1:0)}M.push(N)}return M}(this.dem),f=c.length-1,m=c[f];this._addNode(m.minimums[0],m.maximums[0],m.leaves[0]),this._construct(c,0,0,f,0)}raycastRoot(n,c,f,m,x,E,M=1){return _p([n,c,-100],[f,m,this.maximums[0]*M],x,E)}raycast(n,c,f,m,x,E,M=1){if(!this.nodeCount)return null;const I=this.raycastRoot(n,c,f,m,x,E,M);if(I==null)return null;const P=[],z=[],N=[],q=[],K=[{idx:0,t:I,nodex:0,nodey:0,depth:0}];for(;K.length>0;){const{idx:ee,t:oe,nodex:pe,nodey:Ee,depth:Re}=K.pop();if(this.leaves[ee]){xp(pe,Ee,Re,n,c,f,m,N,q);const De=1<<Re,ze=(pe+0)/De,Le=(pe+1)/De,st=(Ee+0)/De,it=(Ee+1)/De,wt=Ms(ze,st,this.dem)*M,Gt=Ms(Le,st,this.dem)*M,ft=Ms(Le,it,this.dem)*M,kt=Ms(ze,it,this.dem)*M,Rt=yp(N[0],N[1],wt,q[0],N[1],Gt,q[0],q[1],ft,x,E),Ft=yp(q[0],q[1],ft,N[0],q[1],kt,N[0],N[1],wt,x,E),Zt=Math.min(Rt!==null?Rt:Number.MAX_VALUE,Ft!==null?Ft:Number.MAX_VALUE);if(Zt!==Number.MAX_VALUE)return Zt;{const pt=mc([],x,E,oe);if(wp(wt,Gt,kt,ft,vp(pt[0],N[0],q[0]),vp(pt[1],N[1],q[1]))>=pt[2])return oe}continue}let be=0;for(let De=0;De<this._siblingOffset.length;De++){xp((pe<<1)+this._siblingOffset[De][0],(Ee<<1)+this._siblingOffset[De][1],Re+1,n,c,f,m,N,q),N[2]=-100,q[2]=this.maximums[this.childOffsets[ee]+De]*M;const ze=_p(N,q,x,E);if(ze!=null){const Le=ze;P[De]=Le;let st=!1;for(let it=0;it<be&&!st;it++)Le>=P[z[it]]&&(z.splice(it,0,De),st=!0);st||(z[be]=De),be++}}for(let De=0;De<be;De++){const ze=z[De];K.push({idx:this.childOffsets[ee]+ze,t:P[ze],nodex:(pe<<1)+this._siblingOffset[ze][0],nodey:(Ee<<1)+this._siblingOffset[ze][1],depth:Re+1})}}return null}_addNode(n,c,f){return this.minimums.push(n),this.maximums.push(c),this.leaves.push(f),this.childOffsets.push(0),this.nodeCount++}_construct(n,c,f,m,x){if(n[m].isLeaf(c,f)===1)return;this.childOffsets[x]||(this.childOffsets[x]=this.nodeCount);const E=m-1,M=n[E];let I=0,P=0;for(let z=0;z<this._siblingOffset.length;z++){const N=2*c+this._siblingOffset[z][0],q=2*f+this._siblingOffset[z][1],K=M.getElevation(N,q),ee=M.isLeaf(N,q),oe=this._addNode(K.min,K.max,ee);ee&&(I|=1<<z),P||(P=oe)}for(let z=0;z<this._siblingOffset.length;z++)I&1<<z||this._construct(n,2*c+this._siblingOffset[z][0],2*f+this._siblingOffset[z][1],E,P+z)}}function wp(l,n,c,f,m,x){return Qi(Qi(l,c,x),Qi(n,f,x),m)}function Ms(l,n,c){const f=c.dim,m=Ge(l*f-.5,0,f-1),x=Ge(n*f-.5,0,f-1),E=Math.floor(m),M=Math.floor(x),I=Math.min(E+1,f-1),P=Math.min(M+1,f-1);return wp(c.get(E,M),c.get(I,M),c.get(E,P),c.get(I,P),m-E,x-M)}const Ep={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function h_(l,n,c){return(256*l*256+256*n+c)/10-1e4}function d_(l,n,c){return 256*l+n+c/256-32768}class Wu{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(n,c,f,m=!1,x=!1){if(this.uid=n,c.height!==c.width)throw new RangeError("DEM tiles must be square");if(f&&f!=="mapbox"&&f!=="terrarium")return vi(`"${f}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=c.height;const E=this.dim=c.height-2,M=new Uint32Array(c.data.buffer);if(this.pixels=new Uint8Array(c.data.buffer),this.encoding=f||"mapbox",this.borderReady=m,!m){for(let I=0;I<E;I++)M[this._idx(-1,I)]=M[this._idx(0,I)],M[this._idx(E,I)]=M[this._idx(E-1,I)],M[this._idx(I,-1)]=M[this._idx(I,0)],M[this._idx(I,E)]=M[this._idx(I,E-1)];M[this._idx(-1,-1)]=M[this._idx(0,0)],M[this._idx(E,-1)]=M[this._idx(E-1,0)],M[this._idx(-1,E)]=M[this._idx(0,E-1)],M[this._idx(E,E)]=M[this._idx(E-1,E-1)],x&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new bp(this)}get(n,c,f=!1){f&&(n=Ge(n,-1,this.dim),c=Ge(c,-1,this.dim));const m=4*this._idx(n,c);return(this.encoding==="terrarium"?d_:h_)(this.pixels[m],this.pixels[m+1],this.pixels[m+2])}static getUnpackVector(n){return Ep[n]}get unpackVector(){return Ep[this.encoding]}_idx(n,c){if(n<-1||n>=this.dim+1||c<-1||c>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(c+1)*this.stride+(n+1)}static pack(n,c){const f=[0,0,0,0],m=Wu.getUnpackVector(c);let x=Math.floor((n+m[3])/m[2]);return f[2]=x%256,x=Math.floor(x/256),f[1]=x%256,x=Math.floor(x/256),f[0]=x,f}getPixels(){return new oo({width:this.stride,height:this.stride},this.pixels)}backfillBorder(n,c,f){if(this.dim!==n.dim)throw new Error("dem dimension mismatch");let m=c*this.dim,x=c*this.dim+this.dim,E=f*this.dim,M=f*this.dim+this.dim;switch(c){case-1:m=x-1;break;case 1:x=m+1}switch(f){case-1:E=M-1;break;case 1:M=E+1}const I=-c*this.dim,P=-f*this.dim;for(let z=E;z<M;z++)for(let N=m;N<x;N++){const q=4*this._idx(N,z),K=4*this._idx(N+I,z+P);this.pixels[q+0]=n.pixels[K+0],this.pixels[q+1]=n.pixels[K+1],this.pixels[q+2]=n.pixels[K+2],this.pixels[q+3]=n.pixels[K+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Ti(Wu,"DEMData"),Ti(bp,"DemMinMaxQuadTree",{omit:["dem"]});class f_{constructor(n,c){this.max=n,this.onRemove=c,this.reset()}reset(){for(const n in this.data)for(const c of this.data[n])c.timeout&&clearTimeout(c.timeout),this.onRemove(c.value);return this.data={},this.order=[],this}add(n,c,f){const m=n.wrapped().key;this.data[m]===void 0&&(this.data[m]=[]);const x={value:c,timeout:void 0};if(f!==void 0&&(x.timeout=setTimeout(()=>{this.remove(n,x)},f)),this.data[m].push(x),this.order.push(m),this.order.length>this.max){const E=this._getAndRemoveByKey(this.order[0]);E&&this.onRemove(E)}return this}has(n){return n.wrapped().key in this.data}getAndRemove(n){return this.has(n)?this._getAndRemoveByKey(n.wrapped().key):null}_getAndRemoveByKey(n){const c=this.data[n].shift();return c.timeout&&clearTimeout(c.timeout),this.data[n].length===0&&delete this.data[n],this.order.splice(this.order.indexOf(n),1),c.value}getByKey(n){const c=this.data[n];return c?c[0].value:null}get(n){return this.has(n)?this.data[n.wrapped().key][0].value:null}remove(n,c){if(!this.has(n))return this;const f=n.wrapped().key,m=c===void 0?0:this.data[f].indexOf(c),x=this.data[f][m];return this.data[f].splice(m,1),x.timeout&&clearTimeout(x.timeout),this.data[f].length===0&&delete this.data[f],this.onRemove(x.value),this.order.splice(this.order.indexOf(f),1),this}setMaxSize(n){for(this.max=n;this.order.length>this.max;){const c=this._getAndRemoveByKey(this.order[0]);c&&this.onRemove(c)}return this}filter(n){const c=[];for(const f in this.data)for(const m of this.data[f])n(m.value)||c.push(m);for(const f of c)this.remove(f.value.tileID,f)}}class Hl{constructor(n,c,f){this.func=n,this.mask=c,this.range=f}}Hl.ReadOnly=!1,Hl.ReadWrite=!0,Hl.disabled=new Hl(519,Hl.ReadOnly,[0,1]);const Yh=7680;class Wh{constructor(n,c,f,m,x,E){this.test=n,this.ref=c,this.mask=f,this.fail=m,this.depthFail=x,this.pass=E}}Wh.disabled=new Wh({func:519,mask:0},0,0,Yh,Yh,Yh);class xa{constructor(n,c,f){this.blendFunction=n,this.blendColor=c,this.mask=f}}xa.Replace=[1,0],xa.disabled=new xa(xa.Replace,Yi.transparent,[!1,!1,!1,!1]),xa.unblended=new xa(xa.Replace,Yi.transparent,[!0,!0,!0,!0]),xa.alphaBlended=new xa([1,771],Yi.transparent,[!0,!0,!0,!0]);const Kh=1029,Qh=2305;class Qo{constructor(n,c,f){this.enable=n,this.mode=c,this.frontFace=f}}Qo.disabled=new Qo(!1,Kh,Qh),Qo.backCCW=new Qo(!0,Kh,Qh),Qo.backCW=new Qo(!0,Kh,2304),Qo.frontCW=new Qo(!0,1028,2304),Qo.frontCCW=new Qo(!0,1028,Qh);class al extends dr{constructor(n,c,f){super(),this.id=n,this._onlySymbols=f,c.on("data",m=>{m.dataType==="source"&&m.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&m.dataType==="source"&&m.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),c.on("error",()=>{this._sourceErrored=!0}),this._source=c,this._tiles={},this._cache=new f_(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=c.minTileCacheSize,this._maxTileCacheSize=c.maxTileCacheSize,this._loadedParentTiles={},this._coveredTiles={},this._state=new u_,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(n){this.map=n,this._minTileCacheSize=this._minTileCacheSize===void 0&&n?n._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&n?n._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const n in this._tiles){const c=this._tiles[n];if(c.state!=="loaded"&&c.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const n=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,n&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(n,c){return n.isSymbolTile=this._onlySymbols,this._source.loadTile(n,c)}_unloadTile(n){if(this._source.unloadTile)return this._source.unloadTile(n,()=>{})}_abortTile(n){if(this._source.abortTile)return this._source.abortTile(n,()=>{})}serialize(){return this._source.serialize()}prepare(n){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const c in this._tiles){const f=this._tiles[c];f.upload(n),f.prepare(this.map.style.imageManager)}}getIds(){return Qt(this._tiles).map(n=>n.tileID).sort(Tp).map(n=>n.key)}getRenderableIds(n){const c=[];for(const f in this._tiles)this._isIdRenderable(+f,n)&&c.push(this._tiles[f]);return n?c.sort((f,m)=>{const x=f.tileID,E=m.tileID,M=new W(x.canonical.x,x.canonical.y)._rotate(this.transform.angle),I=new W(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return x.overscaledZ-E.overscaledZ||I.y-M.y||I.x-M.x}).map(f=>f.tileID.key):c.map(f=>f.tileID).sort(Tp).map(f=>f.key)}hasRenderableParent(n){const c=this.findLoadedParent(n,0);return!!c&&this._isIdRenderable(c.tileID.key)}_isIdRenderable(n,c){return this._tiles[n]&&this._tiles[n].hasData()&&!this._coveredTiles[n]&&(c||!this._tiles[n].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const n in this._tiles)this._tiles[n].state!=="errored"&&this._reloadTile(+n,"reloading")}}_reloadTile(n,c){const f=this._tiles[n];f&&(f.state!=="loading"&&(f.state=c),this._loadTile(f,this._tileLoaded.bind(this,f,n,c)))}_tileLoaded(n,c,f,m){if(m)if(n.state="errored",m.status!==404)this._source.fire(new rr(m,{tile:n}));else if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const x=this.map.painter.terrain;this.update(this.transform,x.getScaledDemTileSize(),!0),x.resetTileLookupCache(this.id)}else this.update(this.transform);else n.timeAdded=Yt.now(),f==="expired"&&(n.refreshedUponExpiration=!0),this._setTileReloadTimer(c,n),this._source.type==="raster-dem"&&n.dem&&this._backfillDEM(n),this._state.initializeTileState(n,this.map?this.map.painter:null),this._source.fire(new Bi("data",{dataType:"source",tile:n,coord:n.tileID,sourceCacheId:this.id}))}_backfillDEM(n){const c=this.getRenderableIds();for(let m=0;m<c.length;m++){const x=c[m];if(n.neighboringTiles&&n.neighboringTiles[x]){const E=this.getTileByID(x);f(n,E),f(E,n)}}function f(m,x){if(!m.dem||m.dem.borderReady)return;m.needsHillshadePrepare=!0,m.needsDEMTextureUpload=!0;let E=x.tileID.canonical.x-m.tileID.canonical.x;const M=x.tileID.canonical.y-m.tileID.canonical.y,I=Math.pow(2,m.tileID.canonical.z),P=x.tileID.key;E===0&&M===0||Math.abs(M)>1||(Math.abs(E)>1&&(Math.abs(E+I)===1?E+=I:Math.abs(E-I)===1&&(E-=I)),x.dem&&m.dem&&(m.dem.backfillBorder(x.dem,E,M),m.neighboringTiles&&m.neighboringTiles[P]&&(m.neighboringTiles[P].backfilled=!0)))}}getTile(n){return this.getTileByID(n.key)}getTileByID(n){return this._tiles[n]}_retainLoadedChildren(n,c,f,m){for(const x in this._tiles){let E=this._tiles[x];if(m[x]||!E.hasData()||E.tileID.overscaledZ<=c||E.tileID.overscaledZ>f)continue;let M=E.tileID;for(;E&&E.tileID.overscaledZ>c+1;){const P=E.tileID.scaledTo(E.tileID.overscaledZ-1);E=this._tiles[P.key],E&&E.hasData()&&(M=P)}let I=M;for(;I.overscaledZ>c;)if(I=I.scaledTo(I.overscaledZ-1),n[I.key]){m[M.key]=M;break}}}findLoadedParent(n,c){if(n.key in this._loadedParentTiles){const f=this._loadedParentTiles[n.key];return f&&f.tileID.overscaledZ>=c?f:null}for(let f=n.overscaledZ-1;f>=c;f--){const m=n.scaledTo(f),x=this._getLoadedTile(m);if(x)return x}}_getLoadedTile(n){const c=this._tiles[n.key];return c&&c.hasData()?c:this._cache.getByKey(this._source.reparseOverscaled?n.wrapped().key:n.canonical.key)}updateCacheSize(n,c){c=c||this._source.tileSize;const f=Math.ceil(n.width/c)+1,m=Math.ceil(n.height/c)+1,x=Math.floor(f*m*5),E=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,x):x,M=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,E):E;this._cache.setMaxSize(M)}handleWrapJump(n){const c=Math.round((n-(this._prevLng===void 0?n:this._prevLng))/360);if(this._prevLng=n,c){const f={};for(const m in this._tiles){const x=this._tiles[m];x.tileID=x.tileID.unwrapTo(x.tileID.wrap+c),f[x.tileID.key]=x}this._tiles=f;for(const m in this._timers)clearTimeout(this._timers[m]),delete this._timers[m];for(const m in this._tiles)this._setTileReloadTimer(+m,this._tiles[m])}}update(n,c,f){if(this.transform=n,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!f)return;let m;this.updateCacheSize(n,c),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?m=n.getVisibleUnwrappedCoordinates(this._source.tileID).map(M=>new qn(M.canonical.z,M.wrap,M.canonical.z,M.canonical.x,M.canonical.y)):(m=n.coveringTiles({tileSize:c||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(m=m.filter(M=>this._source.hasTile(M)))):m=[];const x=this._updateRetainedTiles(m);if(Sp(this._source.type)&&m.length!==0){const M={},I={},P=Object.keys(x);for(const N of P){const q=x[N],K=this._tiles[N];if(!K||K.fadeEndTime&&K.fadeEndTime<=Yt.now())continue;const ee=this.findLoadedParent(q,Math.max(q.overscaledZ-al.maxOverzooming,this._source.minzoom));ee&&(this._addTile(ee.tileID),M[ee.tileID.key]=ee.tileID),I[N]=q}const z=m[m.length-1].overscaledZ;for(const N in this._tiles){const q=this._tiles[N];if(x[N]||!q.hasData())continue;let K=q.tileID;for(;K.overscaledZ>z;){K=K.scaledTo(K.overscaledZ-1);const ee=this._tiles[K.key];if(ee&&ee.hasData()&&I[K.key]){x[N]=q.tileID;break}}}for(const N in M)x[N]||(this._coveredTiles[N]=!0,x[N]=M[N])}for(const M in x)this._tiles[M].clearFadeHold();const E=function(M,I){const P=[];for(const z in M)z in I||P.push(z);return P}(this._tiles,x);for(const M of E){const I=this._tiles[M];I.hasSymbolBuckets&&!I.holdingForFade()?I.setHoldDuration(this.map._fadeDuration):I.hasSymbolBuckets&&!I.symbolFadeFinished()||this._removeTile(+M)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const n in this._tiles)this._tiles[n].holdingForFade()&&this._removeTile(+n)}_updateRetainedTiles(n){const c={};if(n.length===0)return c;const f={},m=n.reduce((P,z)=>Math.min(P,z.overscaledZ),1/0),x=n[0].overscaledZ,E=Math.max(x-al.maxOverzooming,this._source.minzoom),M=Math.max(x+al.maxUnderzooming,this._source.minzoom),I={};for(const P of n){const z=this._addTile(P);c[P.key]=P,z.hasData()||m<this._source.maxzoom&&(I[P.key]=P)}this._retainLoadedChildren(I,m,M,c);for(const P of n){let z=this._tiles[P.key];if(z.hasData())continue;if(P.canonical.z>=this._source.maxzoom){const q=P.children(this._source.maxzoom)[0],K=this.getTile(q);if(K&&K.hasData()){c[q.key]=q;continue}}else{const q=P.children(this._source.maxzoom);if(c[q[0].key]&&c[q[1].key]&&c[q[2].key]&&c[q[3].key])continue}let N=z.wasRequested();for(let q=P.overscaledZ-1;q>=E;--q){const K=P.scaledTo(q);if(f[K.key]||(f[K.key]=!0,z=this.getTile(K),!z&&N&&(z=this._addTile(K)),z&&(c[K.key]=K,N=z.wasRequested(),z.hasData())))break}}return c}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const n in this._tiles){const c=[];let f,m=this._tiles[n].tileID;for(;m.overscaledZ>0;){if(m.key in this._loadedParentTiles){f=this._loadedParentTiles[m.key];break}c.push(m.key);const x=m.scaledTo(m.overscaledZ-1);if(f=this._getLoadedTile(x),f)break;m=x}for(const x of c)this._loadedParentTiles[x]=f}}_addTile(n){let c=this._tiles[n.key];if(c)return c;c=this._cache.getAndRemove(n),c&&(this._setTileReloadTimer(n.key,c),c.tileID=n,this._state.initializeTileState(c,this.map?this.map.painter:null),this._cacheTimers[n.key]&&(clearTimeout(this._cacheTimers[n.key]),delete this._cacheTimers[n.key],this._setTileReloadTimer(n.key,c)));const f=!!c;if(!f){const m=this.map?this.map.painter:null;c=new Xh(n,this._source.tileSize*n.overscaleFactor(),this.transform.tileZoom,m,this._isRaster),this._loadTile(c,this._tileLoaded.bind(this,c,n.key,c.state))}return c?(c.uses++,this._tiles[n.key]=c,f||this._source.fire(new Bi("dataloading",{tile:c,coord:c.tileID,dataType:"source"})),c):null}_setTileReloadTimer(n,c){n in this._timers&&(clearTimeout(this._timers[n]),delete this._timers[n]);const f=c.getExpiryTimeout();f&&(this._timers[n]=setTimeout(()=>{this._reloadTile(n,"expired"),delete this._timers[n]},f))}_removeTile(n){const c=this._tiles[n];c&&(c.uses--,delete this._tiles[n],this._timers[n]&&(clearTimeout(this._timers[n]),delete this._timers[n]),c.uses>0||(c.hasData()&&c.state!=="reloading"?this._cache.add(c.tileID,c,c.getExpiryTimeout()):(c.aborted=!0,this._abortTile(c),this._unloadTile(c))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const n in this._tiles)this._removeTile(+n);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(n,c,f){const m=[],x=this.transform;if(!x)return m;const E=x.projection.name==="globe",M=ma(x.center.lng);for(const I in this._tiles){const P=this._tiles[I];if(f&&P.clearQueryDebugViz(),P.holdingForFade())continue;let z;if(E){const N=P.tileID.canonical;if(N.z===0){const q=[Math.abs(Ge(M,...Nc(N,-1))-M),Math.abs(Ge(M,...Nc(N,1))-M)];z=[0,2*q.indexOf(Math.min(...q))-1]}else{const q=[Math.abs(Ge(M,...Nc(N,-1))-M),Math.abs(Ge(M,...Nc(N,0))-M),Math.abs(Ge(M,...Nc(N,1))-M)];z=[q.indexOf(Math.min(...q))-1]}}else z=[0];for(const N of z){const q=n.containsTile(P,x,c,N);q&&m.push(q)}}return m}getVisibleCoordinates(n){const c=this.getRenderableIds(n).map(f=>this._tiles[f].tileID);for(const f of c)f.projMatrix=this.transform.calculateProjMatrix(f.toUnwrapped());return c}hasTransition(){if(this._source.hasTransition())return!0;if(Sp(this._source.type))for(const n in this._tiles){const c=this._tiles[n];if(c.fadeEndTime!==void 0&&c.fadeEndTime>=Yt.now())return!0}return!1}setFeatureState(n,c,f){this._state.updateState(n=n||"_geojsonTileLayer",c,f)}removeFeatureState(n,c,f){this._state.removeFeatureState(n=n||"_geojsonTileLayer",c,f)}getFeatureState(n,c){return this._state.getState(n=n||"_geojsonTileLayer",c)}setDependencies(n,c,f){const m=this._tiles[n];m&&m.setDependencies(c,f)}reloadTilesForDependencies(n,c){for(const f in this._tiles)this._tiles[f].hasDependency(n,c)&&this._reloadTile(+f,"reloading");this._cache.filter(f=>!f.hasDependency(n,c))}_preloadTiles(n,c){const f=new Map,m=Array.isArray(n)?n:[n],x=this.map.painter.terrain,E=this.usedForTerrain&&x?x.getScaledDemTileSize():this._source.tileSize;for(const M of m){const I=M.coveringTiles({tileSize:E,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const P of I)f.set(P.key,P);this.usedForTerrain&&M.updateElevation(!1)}Ut(Array.from(f.values()),(M,I)=>{const P=new Xh(M,this._source.tileSize*M.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(P,z=>{this._source.type==="raster-dem"&&P.dem&&this._backfillDEM(P),I(z,P)})},c)}}function Tp(l,n){const c=Math.abs(2*l.wrap)-+(l.wrap<0),f=Math.abs(2*n.wrap)-+(n.wrap<0);return l.overscaledZ-n.overscaledZ||f-c||n.canonical.y-l.canonical.y||n.canonical.x-l.canonical.x}function Sp(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function Nc(l,n){const c=1<<l.z;return[l.x/c+n,(l.x+1)/c+n]}al.maxOverzooming=10,al.maxUnderzooming=3;class Ku{constructor(n,c,f){this._demTile=n,this._dem=this._demTile.dem,this._scale=c,this._offset=f}static create(n,c,f){const m=f||n.findDEMTileFor(c);if(!m||!m.dem)return;const x=m.dem,E=m.tileID,M=1<<c.canonical.z-E.canonical.z;return new Ku(m,m.tileSize/Zi/M,[(c.canonical.x/M-E.canonical.x)*x.dim,(c.canonical.y/M-E.canonical.y)*x.dim])}tileCoordToPixel(n,c){const f=c*this._scale+this._offset[1],m=Math.floor(n*this._scale+this._offset[0]),x=Math.floor(f);return new W(m,x)}getElevationAt(n,c,f,m){const x=n*this._scale+this._offset[0],E=c*this._scale+this._offset[1],M=Math.floor(x),I=Math.floor(E),P=this._dem;return m=!!m,f?Qi(Qi(P.get(M,I,m),P.get(M,I+1,m),E-I),Qi(P.get(M+1,I,m),P.get(M+1,I+1,m),E-I),x-M):P.get(M,I,m)}getElevationAtPixel(n,c,f){return this._dem.get(n,c,!!f)}getMeterToDEM(n){return(1<<this._demTile.tileID.canonical.z)*Ko(1,n)*this._dem.stride}}class Mp{constructor(n,c){this.tileID=n,this.x=n.canonical.x,this.y=n.canonical.y,this.z=n.canonical.z,this.grid=new ps(Zi,16,0),this.featureIndexArray=new md,this.promoteId=c}insert(n,c,f,m,x,E=0){const M=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(f,m,x,E);const I=this.grid;for(let P=0;P<c.length;P++){const z=c[P],N=[1/0,1/0,-1/0,-1/0];for(let q=0;q<z.length;q++){const K=z[q];N[0]=Math.min(N[0],K.x),N[1]=Math.min(N[1],K.y),N[2]=Math.max(N[2],K.x),N[3]=Math.max(N[3],K.y)}N[0]<Zi&&N[1]<Zi&&N[2]>=0&&N[3]>=0&&I.insert(M,N[0],N[1],N[2],N[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Ph(new Rc(this.rawTileData)).layers,this.sourceLayerCoder=new hp(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const n in this.vtLayers)this.vtFeatures[n]=[]}return this.vtLayers}query(n,c,f,m){this.loadVTLayers();const x=n.params||{},E=yl(x.filter),M=n.tileResult,I=n.transform,P=M.bufferedTilespaceBounds,z=this.grid.query(P.min.x,P.min.y,P.max.x,P.max.y,(ee,oe,pe,Ee)=>Jd(M.bufferedTilespaceGeometry,ee,oe,pe,Ee));z.sort(p_);let N=null;I.elevation&&z.length>0&&(N=Ku.create(I.elevation,this.tileID));const q={};let K;for(let ee=0;ee<z.length;ee++){const oe=z[ee];if(oe===K)continue;K=oe;const pe=this.featureIndexArray.get(oe);let Ee=null;this.loadMatchingFeature(q,pe,E,x.layers,x.availableImages,c,f,m,(Re,be,De,ze=0)=>(Ee||(Ee=qa(Re,this.tileID.canonical,n.tileTransform)),be.queryIntersectsFeature(M,Re,De,Ee,this.z,n.transform,n.pixelPosMatrix,N,ze)))}return q}loadMatchingFeature(n,c,f,m,x,E,M,I,P){const{featureIndex:z,bucketIndex:N,sourceLayerIndex:q,layoutVertexArrayOffset:K}=c,ee=this.bucketLayerIDs[N];if(m&&!function(Re,be){for(let De=0;De<Re.length;De++)if(be.indexOf(Re[De])>=0)return!0;return!1}(m,ee))return;const oe=this.sourceLayerCoder.decode(q),pe=this.vtLayers[oe].feature(z);if(f.needGeometry){const Re=il(pe,!0);if(!f.filter(new Je(this.tileID.overscaledZ),Re,this.tileID.canonical))return}else if(!f.filter(new Je(this.tileID.overscaledZ),pe))return;const Ee=this.getId(pe,oe);for(let Re=0;Re<ee.length;Re++){const be=ee[Re];if(m&&m.indexOf(be)<0)continue;const De=E[be];if(!De)continue;let ze={};Ee!==void 0&&I&&(ze=I.getState(De.sourceLayer||"_geojsonTileLayer",Ee));const Le=tt({},M[be]);Le.paint=Ap(Le.paint,De.paint,pe,ze,x),Le.layout=Ap(Le.layout,De.layout,pe,ze,x);const st=!P||P(pe,De,ze,K);if(!st)continue;const it=new dp(pe,this.z,this.x,this.y,Ee);it.layer=Le;let wt=n[be];wt===void 0&&(wt=n[be]=[]),wt.push({featureIndex:z,feature:it,intersectionZ:st})}}lookupSymbolFeatures(n,c,f,m,x,E,M,I){const P={};this.loadVTLayers();const z=yl(x);for(const N of n)this.loadMatchingFeature(P,{bucketIndex:f,sourceLayerIndex:m,featureIndex:N,layoutVertexArrayOffset:0},z,E,M,I,c);return P}loadFeature(n){const{featureIndex:c,sourceLayerIndex:f}=n;this.loadVTLayers();const m=this.sourceLayerCoder.decode(f),x=this.vtFeatures[m];if(x[c])return x[c];const E=this.vtLayers[m].feature(c);return x[c]=E,E}hasLayer(n){for(const c of this.bucketLayerIDs)for(const f of c)if(n===f)return!0;return!1}getId(n,c){let f=n.id;if(this.promoteId){const m=typeof this.promoteId=="string"?this.promoteId:this.promoteId[c];m!=null&&(f=n.properties[m]),typeof f=="boolean"&&(f=Number(f))}return f}}function Ap(l,n,c,f,m){return Bt(l,(x,E)=>{const M=n instanceof at?n.get(E):null;return M&&M.evaluate?M.evaluate(c,f,m):M})}function p_(l,n){return n-l}Ti(Mp,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});class Cp{constructor(n,c){this.width=n,this.height=c,this.nextRow=0,this.image=new Ga({width:n,height:c}),this.positions={},this.uploaded=!1}getDash(n,c){const f=this.getKey(n,c);return this.positions[f]}trim(){const n=this.width,c=this.height=xt(this.nextRow);this.image.resize({width:n,height:c})}getKey(n,c){return n.join(",")+c}getDashRanges(n,c,f){const m=[];let x=n.length%2==1?-n[n.length-1]*f:0,E=n[0]*f,M=!0;m.push({left:x,right:E,isDash:M,zeroLength:n[0]===0});let I=n[0];for(let P=1;P<n.length;P++){M=!M;const z=n[P];x=I*f,I+=z,E=I*f,m.push({left:x,right:E,isDash:M,zeroLength:z===0})}return m}addRoundDash(n,c,f){const m=c/2;for(let x=-f;x<=f;x++){const E=this.width*(this.nextRow+f+x);let M=0,I=n[M];for(let P=0;P<this.width;P++){P/I.right>1&&(I=n[++M]);const z=Math.abs(P-I.left),N=Math.abs(P-I.right),q=Math.min(z,N);let K;const ee=x/f*(m+1);if(I.isDash){const oe=m-Math.abs(ee);K=Math.sqrt(q*q+oe*oe)}else K=m-Math.sqrt(q*q+ee*ee);this.image.data[E+P]=Math.max(0,Math.min(255,K+128))}}}addRegularDash(n,c){for(let I=n.length-1;I>=0;--I){const P=n[I],z=n[I+1];P.zeroLength?n.splice(I,1):z&&z.isDash===P.isDash&&(z.left=P.left,n.splice(I,1))}const f=n[0],m=n[n.length-1];f.isDash===m.isDash&&(f.left=m.left-this.width,m.right=f.right+this.width);const x=this.width*this.nextRow;let E=0,M=n[E];for(let I=0;I<this.width;I++){I/M.right>1&&(M=n[++E]);const P=Math.abs(I-M.left),z=Math.abs(I-M.right),N=Math.min(P,z);this.image.data[x+I]=Math.max(0,Math.min(255,(M.isDash?N:-N)+c+128))}}addDash(n,c){const f=this.getKey(n,c);if(this.positions[f])return this.positions[f];const m=c==="round",x=m?7:0,E=2*x+1;if(this.nextRow+E>this.height)return vi("LineAtlas out of space"),null;n.length===0&&n.push(1);let M=0;for(let z=0;z<n.length;z++)n[z]<0&&(vi("Negative value is found in line dasharray, replacing values with 0"),n[z]=0),M+=n[z];if(M!==0){const z=this.width/M,N=this.getDashRanges(n,this.width,z);m?this.addRoundDash(N,z,x):this.addRegularDash(N,c==="square"?.5*z:0)}const I=this.nextRow+x;this.nextRow+=E;const P={tl:[I,x],br:[M,0]};return this.positions[f]=P,P}}Ti(Cp,"LineAtlas");class Ip{constructor(n){const c={},f=[];for(const M in n){const I=n[M],P=c[M]={};for(const z in I.glyphs){const N=I.glyphs[+z];if(!N||N.bitmap.width===0||N.bitmap.height===0)continue;const q=N.metrics.localGlyph?2:1,K={x:0,y:0,w:N.bitmap.width+2*q,h:N.bitmap.height+2*q};f.push(K),P[z]=K}}const{w:m,h:x}=Bh(f),E=new Ga({width:m||1,height:x||1});for(const M in n){const I=n[M];for(const P in I.glyphs){const z=I.glyphs[+P];if(!z||z.bitmap.width===0||z.bitmap.height===0)continue;const N=c[M][P],q=z.metrics.localGlyph?2:1;Ga.copy(z.bitmap,E,{x:0,y:0},{x:N.x+q,y:N.y+q},z.bitmap)}}this.image=E,this.positions=c}}Ti(Ip,"GlyphAtlas");class m_{constructor(n){this.tileID=new qn(n.tileID.overscaledZ,n.tileID.wrap,n.tileID.canonical.z,n.tileID.canonical.x,n.tileID.canonical.y),this.tileZoom=n.tileZoom,this.uid=n.uid,this.zoom=n.zoom,this.canonical=n.tileID.canonical,this.pixelRatio=n.pixelRatio,this.tileSize=n.tileSize,this.source=n.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=n.showCollisionBoxes,this.collectResourceTiming=!!n.collectResourceTiming,this.returnDependencies=!!n.returnDependencies,this.promoteId=n.promoteId,this.enableTerrain=!!n.enableTerrain,this.isSymbolTile=n.isSymbolTile,this.tileTransform=ol(n.tileID.canonical,n.projection),this.projection=n.projection}parse(n,c,f,m,x){this.status="parsing",this.data=n,this.collisionBoxArray=new th;const E=new hp(Object.keys(n.layers).sort()),M=new Mp(this.tileID,this.promoteId);M.bucketLayerIDs=[];const I={},P=new Cp(256,256),z={featureIndex:M,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:P,availableImages:f},N=c.familiesBySource[this.source];for(const ze in N){const Le=n.layers[ze];if(!Le)continue;let st=!1,it=!1;for(const ft of N[ze])ft[0].type==="symbol"?st=!0:it=!0;if(this.isSymbolTile===!0&&!st||this.isSymbolTile===!1&&!it)continue;Le.version===1&&vi(`Vector tile source "${this.source}" layer "${ze}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const wt=E.encode(ze),Gt=[];for(let ft=0;ft<Le.length;ft++){const kt=Le.feature(ft),Rt=M.getId(kt,ze);Gt.push({feature:kt,id:Rt,index:ft,sourceLayerIndex:wt})}for(const ft of N[ze]){const kt=ft[0];this.isSymbolTile!==void 0&&kt.type==="symbol"!==this.isSymbolTile||kt.minzoom&&this.zoom<Math.floor(kt.minzoom)||kt.maxzoom&&this.zoom>=kt.maxzoom||kt.visibility!=="none"&&(Jh(ft,this.zoom,f),(I[kt.id]=kt.createBucket({index:M.bucketLayerIDs.length,layers:ft,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:wt,sourceID:this.source,enableTerrain:this.enableTerrain,projection:this.projection.spec,availableImages:f})).populate(Gt,z,this.tileID.canonical,this.tileTransform),M.bucketLayerIDs.push(ft.map(Rt=>Rt.id)))}}let q,K,ee,oe;P.trim();const pe={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Ee=Bt(z.glyphDependencies,ze=>Object.keys(ze).map(Number));Object.keys(Ee).length?m.send("getGlyphs",{uid:this.uid,stacks:Ee},(ze,Le)=>{q||(q=ze,K=Le,De.call(this))},void 0,!1,pe):K={};const Re=Object.keys(z.iconDependencies);Re.length?m.send("getImages",{icons:Re,source:this.source,tileID:this.tileID,type:"icons"},(ze,Le)=>{q||(q=ze,ee=Le,De.call(this))},void 0,!1,pe):ee={};const be=Object.keys(z.patternDependencies);function De(){if(q)return x(q);if(K&&ee&&oe){const ze=new Ip(K),Le=new zf(ee,oe);for(const st in I){const it=I[st];it instanceof Es?(Jh(it.layers,this.zoom,f),Ug(it,K,ze.positions,ee,Le.iconPositions,this.showCollisionBoxes,f,this.tileID.canonical,this.tileZoom,this.projection)):it.hasPattern&&(it instanceof $u||it instanceof ku||it instanceof Cc)&&(Jh(it.layers,this.zoom,f),it.addFeatures(z,this.tileID.canonical,Le.patternPositions,f,this.tileTransform))}this.status="done",x(null,{buckets:Qt(I).filter(st=>!st.isEmpty()),featureIndex:M,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:ze.image,lineAtlas:P,imageAtlas:Le,glyphMap:this.returnDependencies?K:null,iconMap:this.returnDependencies?ee:null,glyphPositions:this.returnDependencies?ze.positions:null})}}be.length?m.send("getImages",{icons:be,source:this.source,tileID:this.tileID,type:"patterns"},(ze,Le)=>{q||(q=ze,oe=Le,De.call(this))},void 0,!1,pe):oe={},De.call(this)}}function Jh(l,n,c){const f=new Je(n);for(const m of l)m.recalculate(f,c)}class kp{constructor(n){this.entries={},this.scheduler=n}request(n,c,f,m){const x=this.entries[n]=this.entries[n]||{callbacks:[]};if(x.result){const[E,M]=x.result;return this.scheduler?this.scheduler.add(()=>{m(E,M)},c):m(E,M),()=>{}}return x.callbacks.push(m),x.cancel||(x.cancel=f((E,M)=>{x.result=[E,M];for(const I of x.callbacks)this.scheduler?this.scheduler.add(()=>{I(E,M)},c):I(E,M);setTimeout(()=>delete this.entries[n],3e3)})),()=>{x.result||(x.callbacks=x.callbacks.filter(E=>E!==m),x.callbacks.length||(x.cancel(),delete this.entries[n]))}}}function Dp(l,n,c){const f=JSON.stringify(l.request);return l.data&&(this.deduped.entries[f]={result:[null,l.data]}),this.deduped.request(f,{type:"parseTile",isSymbolTile:l.isSymbolTile,zoom:l.tileZoom},m=>{const x=zi(l.request,(E,M,I,P)=>{E?m(E):M&&m(null,{vectorTile:c?void 0:new Ph(new Rc(M)),rawData:M,cacheControl:I,expires:P})});return()=>{x.cancel(),m()}},n)}a.ARRAY_TYPE=no,a.AUTH_ERR_MSG=nn,a.Aabb=jn,a.Actor=class{constructor(l,n,c){this.target=l,this.parent=n,this.mapId=c,this.callbacks={},this.cancelCallbacks={},Et(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=$t()?l:b,this.scheduler=new l_}send(l,n,c,f,m=!1,x){const E=Math.round(1e18*Math.random()).toString(36).substring(0,10);c&&(c.metadata=x,this.callbacks[E]=c);const M=Ci(this.globalScope)?void 0:[];return this.target.postMessage({id:E,type:l,hasCallback:!!c,targetMapId:f,mustQueue:m,sourceMapId:this.mapId,data:qs(n,M)},M),{cancel:()=>{c&&delete this.callbacks[E],this.target.postMessage({id:E,type:"<cancel>",targetMapId:f,sourceMapId:this.mapId})}}}receive(l){const n=l.data,c=n.id;if(c&&(!n.targetMapId||this.mapId===n.targetMapId))if(n.type==="<cancel>"){const f=this.cancelCallbacks[c];delete this.cancelCallbacks[c],f&&f.cancel()}else if(n.mustQueue||$t()){const f=this.callbacks[c];this.cancelCallbacks[c]=this.scheduler.add(()=>this.processTask(c,n),f&&f.metadata||{type:"message"})}else this.processTask(c,n)}processTask(l,n){if(n.type==="<response>"){const c=this.callbacks[l];delete this.callbacks[l],c&&(n.error?c(Gs(n.error)):c(null,Gs(n.data)))}else{const c=Ci(this.globalScope)?void 0:[],f=n.hasCallback?(x,E)=>{delete this.cancelCallbacks[l],this.target.postMessage({id:l,type:"<response>",sourceMapId:this.mapId,error:x?qs(x):null,data:qs(E,c)},c)}:x=>{},m=Gs(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,m,f);else if(this.parent.getWorkerSource){const x=n.type.split(".");this.parent.getWorkerSource(n.sourceMapId,x[0],m.source)[x[1]](m,f)}else f(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},a.CanonicalTileID=Lu,a.Color=Yi,a.ColorMode=xa,a.CullFaceMode=Qo,a.DEMData=Wu,a.DataConstantProperty=Ke,a.DedupedRequest=kp,a.DepthMode=Hl,a.EXTENT=Zi,a.Elevation=class{isDataAvailableAtPoint(l){const n=this._source();if(this.isUsingMockSource()||!n||l.y<0||l.y>1)return!1;const c=n.getSource().maxzoom,f=1<<c,m=Math.floor(l.x),x=Math.floor((l.x-m)*f),E=Math.floor(l.y*f),M=this.findDEMTileFor(new qn(c,m,c,x,E));return!(!M||!M.dem)}getAtPointOrZero(l,n=0){return this.getAtPoint(l,n)||0}getAtPoint(l,n,c=!0){if(this.isUsingMockSource())return null;n==null&&(n=null);const f=this._source();if(!f||l.y<0||l.y>1)return n;const m=f.getSource().maxzoom,x=1<<m,E=Math.floor(l.x),M=l.x-E,I=new qn(m,E,m,Math.floor(M*x),Math.floor(l.y*x)),P=this.findDEMTileFor(I);if(!P||!P.dem)return n;const z=P.dem,N=1<<P.tileID.canonical.z,q=(M*N-P.tileID.canonical.x)*z.dim,K=(l.y*N-P.tileID.canonical.y)*z.dim,ee=Math.floor(q),oe=Math.floor(K);return(c?this.exaggeration():1)*Qi(Qi(z.get(ee,oe),z.get(ee,oe+1),K-oe),Qi(z.get(ee+1,oe),z.get(ee+1,oe+1),K-oe),q-ee)}getAtTileOffset(l,n,c){const f=1<<l.canonical.z;return this.getAtPointOrZero(new Ll(l.wrap+(l.canonical.x+n/Zi)/f,(l.canonical.y+c/Zi)/f))}getAtTileOffsetFunc(l,n,c,f){return m=>{const x=this.getAtTileOffset(l,m.x,m.y),E=f.upVector(l.canonical,m.x,m.y);return _o(E,E,x*f.upVectorScale(l.canonical,n,c).metersToTile),E}}getForTilePoints(l,n,c,f){if(this.isUsingMockSource())return!1;const m=Ku.create(this,l,f);return!!m&&(n.forEach(x=>{x[2]=this.exaggeration()*m.getElevationAt(x[0],x[1],c)}),!0)}getMinMaxForTile(l){if(this.isUsingMockSource())return null;const n=this.findDEMTileFor(l);if(!n||!n.dem)return null;const c=n.dem.tree,f=n.tileID,m=1<<l.canonical.z-f.canonical.z;let x=l.canonical.x/m-f.canonical.x,E=l.canonical.y/m-f.canonical.y,M=0;for(let I=0;I<l.canonical.z-f.canonical.z&&!c.leaves[M];I++){x*=2,E*=2;const P=2*Math.floor(E)+Math.floor(x);M=c.childOffsets[M]+P,x%=1,E%=1}return{min:this.exaggeration()*c.minimums[M],max:this.exaggeration()*c.maximums[M]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(l,n,c){throw new Error("Pure virtual method called.")}pointCoordinate(l){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(l){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},a.ErrorEvent=rr,a.EvaluationParameters=Je,a.Event=Bi,a.Evented=dr,a.FillExtrusionBucket=Cc,a.Frustum=fh,a.FrustumCorners=dh,a.GLOBE_RADIUS=fa,a.GLOBE_SCALE_MATCH_LATITUDE=45,a.GLOBE_ZOOM_THRESHOLD_MAX=6,a.GLOBE_ZOOM_THRESHOLD_MIN=5,a.GlobeSharedBuffers=class{constructor(l){this._createGrid(l),this._createPoles(l)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const l of this._poleSegments)l.destroy();for(const l of this._gridSegments)l.withSkirts.destroy(),l.withoutSkirts.destroy();if(this._wireframeIndexBuffer){this._wireframeIndexBuffer.destroy();for(const l of this._wireframeSegments)l.destroy()}}_fillGridMeshWithLods(l,n){const c=new Ui,f=new Dn,m=[],x=l+1+2,E=n[0]+1,M=n[0]+1+(1+n.length),I=(P,z,N)=>{let q=P===x-1?P-2:P===0?P:P-1;return q+=N?24575:0,[q,z]};for(let P=0;P<x;++P)c.emplaceBack(...I(P,0,!0));for(let P=0;P<E;++P)for(let z=0;z<x;++z)c.emplaceBack(...I(z,P,(z===0||z===x-1)&&!0));for(let P=0;P<n.length;++P){const z=n[P];for(let N=0;N<x;++N)c.emplaceBack(...I(N,z,!0))}for(let P=0;P<n.length;++P){const z=f.length,N=n[P]+1+2,q=new Dn;for(let oe=0;oe<N-1;oe++){const pe=oe===N-2,Ee=pe?x*(M-n.length+P-oe):x;for(let Re=0;Re<x-1;Re++){const be=oe*x+Re;oe===0||pe||Re===0||Re===x-2?(q.emplaceBack(be+1,be,be+Ee),q.emplaceBack(be+Ee,be+Ee+1,be+1)):(f.emplaceBack(be+1,be,be+Ee),f.emplaceBack(be+Ee,be+Ee+1,be+1))}}const K=ln.simpleSegment(0,z,c.length,f.length-z);for(let oe=0;oe<q.uint16.length;oe+=3)f.emplaceBack(q.uint16[oe],q.uint16[oe+1],q.uint16[oe+2]);const ee=ln.simpleSegment(0,z,c.length,f.length-z);m.push({withoutSkirts:K,withSkirts:ee})}return{vertices:c,indices:f,segments:m}}_createGrid(l){const n=this._fillGridMeshWithLods(el,yc);this._gridSegments=n.segments,this._gridBuffer=l.createVertexBuffer(n.vertices,_c.members),this._gridIndexBuffer=l.createIndexBuffer(n.indices,!0)}_createPoles(l){const n=new Dn;for(let m=0;m<=el;m++)n.emplaceBack(0,m+1,m+2);this._poleIndexBuffer=l.createIndexBuffer(n,!0);const c=new ro,f=new ro;this._poleSegments=[];for(let m=0,x=0;m<5;m++){const E=360/(1<<m);c.emplaceBack(0,-fa,0,.5,0),f.emplaceBack(0,-fa,0,.5,1);for(let M=0;M<=el;M++){const I=M/el,P=Qi(0,E,I),[z,N,q]=Dl(lm,cm,P,fa);c.emplaceBack(z,N,q,I,0),f.emplaceBack(z,N,q,I,1)}this._poleSegments.push(ln.simpleSegment(x,0,66,64)),x+=66}this._poleNorthVertexBuffer=l.createVertexBuffer(c,$d,!1),this._poleSouthVertexBuffer=l.createVertexBuffer(f,$d,!1)}getGridBuffers(l,n){return[this._gridBuffer,this._gridIndexBuffer,n?this._gridSegments[l].withSkirts:this._gridSegments[l].withoutSkirts]}getPoleBuffers(l){return[this._poleNorthVertexBuffer,this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[l]]}getWirefameBuffers(l,n){if(!this._wireframeSegments){const c=new ha,f=el,m=f+1+2,x=1;this._wireframeSegments=[];for(let E=0,M=0;E<yc.length;E++){const I=yc[E];for(let z=x;z<I+x;z++)for(let N=x;N<f+x;N++){const q=z*m+N;c.emplaceBack(q,q+1),c.emplaceBack(q,q+m),c.emplaceBack(q,q+m+1)}const P=I*f*3;this._wireframeSegments.push(ln.simpleSegment(0,M,(I+1)*m,P)),M+=P}this._wireframeIndexBuffer=l.createIndexBuffer(c)}return[this._gridBuffer,this._wireframeIndexBuffer,this._wireframeSegments[n]]}},a.GlyphManager=ql,a.ImagePosition=Oh,a.LivePerformanceUtils=bt,a.LngLat=pr,a.LngLatBounds=xs,a.LocalGlyphMode=Nh,a.MAX_MERCATOR_LATITUDE=Pn,a.MercatorCoordinate=Ll,a.ONE_EM=Ln,a.OverscaledTileID=qn,a.PerformanceMarkers=Xe,a.Properties=jt,a.RGBAImage=oo,a.Ray=hh,a.RequestManager=class{constructor(l,n,c){this._transformRequestFn=l,this._customAccessToken=n,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const l=function(){let n="";for(let c=0;c<10;c++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",te,n].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=l.token,this._skuTokenExpiresAt=l.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(l,n){return this._transformRequestFn&&this._transformRequestFn(l,n)||{url:l}}normalizeStyleURL(l,n){if(!Er(l))return l;const c=he(l);return c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeGlyphsURL(l,n){if(!Er(l))return l;const c=he(l);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeSourceURL(l,n,c,f){if(!Er(l))return l;const m=he(l);return m.path=`/v4/${m.authority}.json`,m.params.push("secure"),c&&m.params.push(`language=${c}`),f&&m.params.push(`worldview=${f}`),this._makeAPIURL(m,this._customAccessToken||n)}normalizeSpriteURL(l,n,c,f){const m=he(l);return Er(l)?(m.path=`/styles/v1${m.path}/sprite${n}${c}`,this._makeAPIURL(m,this._customAccessToken||f)):(m.path+=`${n}${c}`,Oe(m))}normalizeTileURL(l,n,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),l&&!Er(l))return l;const f=he(l);f.path=f.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${n||c&&f.authority!=="raster"&&c===512?"@2x":""}${D.supported?".webp":"$1"}`),f.authority==="raster"?f.path=`/${C.RASTER_URL_PREFIX}${f.path}`:(f.path=f.path.replace(/^.+\/v4\//,"/"),f.path=`/${C.TILE_URL_VERSION}${f.path}`);const m=this._customAccessToken||function(x){for(const E of x){const M=E.match(/^access_token=(.*)$/);if(M)return M[1]}return null}(f.params)||C.ACCESS_TOKEN;return C.REQUIRE_ACCESS_TOKEN&&m&&this._skuToken&&f.params.push(`sku=${this._skuToken}`),this._makeAPIURL(f,m)}canonicalizeTileURL(l,n){const c=he(l);if(!c.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!c.path.match(/\.[\w]+$/))return l;let f="mapbox://";c.path.match(/^\/raster\/v1\//)?f+=`raster/${c.path.replace(`/${C.RASTER_URL_PREFIX}/`,"")}`:f+=`tiles/${c.path.replace(`/${C.TILE_URL_VERSION}/`,"")}`;let m=c.params;return n&&(m=m.filter(x=>!x.match(/^access_token=/))),m.length&&(f+=`?${m.join("&")}`),f}canonicalizeTileset(l,n){const c=!!n&&Er(n),f=[];for(const m of l.tiles||[])Kr(m)?f.push(this.canonicalizeTileURL(m,c)):f.push(m);return f}_makeAPIURL(l,n){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",f=he(C.API_URL);if(l.protocol=f.protocol,l.authority=f.authority,l.protocol==="http"){const m=l.params.indexOf("secure");m>=0&&l.params.splice(m,1)}if(f.path!=="/"&&(l.path=`${f.path}${l.path}`),!C.REQUIRE_ACCESS_TOKEN)return Oe(l);if(n=n||C.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if(n[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return l.params=l.params.filter(m=>m.indexOf("access_token")===-1),l.params.push(`access_token=${n||""}`),Oe(l)}},a.ResourceType=Ii,a.SegmentVector=ln,a.SourceCache=al,a.StencilMode=Wh,a.StructArrayLayout1ui2=da,a.StructArrayLayout2f1f2i16=In,a.StructArrayLayout2i4=Ui,a.StructArrayLayout2ui4=ha,a.StructArrayLayout3f12=kn,a.StructArrayLayout3ui6=Dn,a.StructArrayLayout4i8=vr,a.StructArrayLayout5f20=ro,a.Texture=Fc,a.Tile=Xh,a.Transitionable=Jt,a.Uniform1f=gu,a.Uniform1i=class extends Ua{constructor(l){super(l),this.current=0}set(l,n,c){this.fetchUniformLocation(l,n)&&this.current!==c&&(this.current=c,this.gl.uniform1i(this.location,c))}},a.Uniform2f=class extends Ua{constructor(l){super(l),this.current=[0,0]}set(l,n,c){this.fetchUniformLocation(l,n)&&(c[0]===this.current[0]&&c[1]===this.current[1]||(this.current=c,this.gl.uniform2f(this.location,c[0],c[1])))}},a.Uniform3f=class extends Ua{constructor(l){super(l),this.current=[0,0,0]}set(l,n,c){this.fetchUniformLocation(l,n)&&(c[0]===this.current[0]&&c[1]===this.current[1]&&c[2]===this.current[2]||(this.current=c,this.gl.uniform3f(this.location,c[0],c[1],c[2])))}},a.Uniform4f=vd,a.UniformColor=xd,a.UniformMatrix2f=class extends Ua{constructor(l){super(l),this.current=Hp}set(l,n,c){if(this.fetchUniformLocation(l,n)){for(let f=0;f<4;f++)if(c[f]!==this.current[f]){this.current=c,this.gl.uniformMatrix2fv(this.location,!1,c);break}}}},a.UniformMatrix3f=class extends Ua{constructor(l){super(l),this.current=Zp}set(l,n,c){if(this.fetchUniformLocation(l,n)){for(let f=0;f<9;f++)if(c[f]!==this.current[f]){this.current=c,this.gl.uniformMatrix3fv(this.location,!1,c);break}}}},a.UniformMatrix4f=class extends Ua{constructor(l){super(l),this.current=Gp}set(l,n,c){if(this.fetchUniformLocation(l,n)){if(c[12]!==this.current[12]||c[0]!==this.current[0])return this.current=c,void this.gl.uniformMatrix4fv(this.location,!1,c);for(let f=1;f<16;f++)if(c[f]!==this.current[f]){this.current=c,this.gl.uniformMatrix4fv(this.location,!1,c);break}}}},a.UnwrappedTileID=Sf,a.ValidationError=gi,a.VectorTileFeature=Ru,a.VectorTileWorkerSource=class extends dr{constructor(l,n,c,f,m){super(),this.actor=l,this.layerIndex=n,this.availableImages=c,this.loadVectorData=m||Dp,this.loading={},this.loaded={},this.deduped=new kp(l.scheduler),this.isSpriteLoaded=f,this.scheduler=l.scheduler}loadTile(l,n){const c=l.uid,f=l&&l.request,m=f&&f.collectResourceTiming,x=this.loading[c]=new m_(l);x.abort=this.loadVectorData(l,(E,M)=>{const I=!this.loading[c];if(delete this.loading[c],I||E||!M)return x.status="done",I||(this.loaded[c]=x),n(E);const P=M.rawData,z={};M.expires&&(z.expires=M.expires),M.cacheControl&&(z.cacheControl=M.cacheControl),x.vectorTile=M.vectorTile||new Ph(new Rc(P));const N=()=>{x.parse(x.vectorTile,this.layerIndex,this.availableImages,this.actor,(q,K)=>{if(q||!K)return n(q);const ee={};if(m){const oe=Ai(f);oe.length>0&&(ee.resourceTiming=JSON.parse(JSON.stringify(oe)))}n(null,tt({rawTileData:P.slice(0)},K,z,ee))})};this.isSpriteLoaded?N():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(N,{type:"parseTile",isSymbolTile:l.isSymbolTile,zoom:l.tileZoom}):N()}),this.loaded=this.loaded||{},this.loaded[c]=x})}reloadTile(l,n){const c=this.loaded,f=l.uid,m=this;if(c&&c[f]){const x=c[f];x.showCollisionBoxes=l.showCollisionBoxes,x.enableTerrain=!!l.enableTerrain,x.projection=l.projection,x.tileTransform=ol(l.tileID.canonical,l.projection);const E=(M,I)=>{const P=x.reloadCallback;P&&(delete x.reloadCallback,x.parse(x.vectorTile,m.layerIndex,this.availableImages,m.actor,P)),n(M,I)};x.status==="parsing"?x.reloadCallback=E:x.status==="done"&&(x.vectorTile?x.parse(x.vectorTile,this.layerIndex,this.availableImages,this.actor,E):E())}}abortTile(l,n){const c=l.uid,f=this.loading[c];f&&(f.abort&&f.abort(),delete this.loading[c]),n()}removeTile(l,n){const c=this.loaded,f=l.uid;c&&c[f]&&delete c[f],n()}},a.WritingMode=vo,a.ZoomDependentExpression=Fa,a.add=ja,a.addDynamicAttributes=Hu,a.adjoint=function(l,n){var c=n[0],f=n[1],m=n[2],x=n[3],E=n[4],M=n[5],I=n[6],P=n[7],z=n[8];return l[0]=E*z-M*P,l[1]=m*P-f*z,l[2]=f*M-m*E,l[3]=M*I-x*z,l[4]=c*z-m*I,l[5]=m*x-c*M,l[6]=x*P-E*I,l[7]=f*I-c*P,l[8]=c*E-f*x,l},a.asyncAll=Ut,a.bezier=Ie,a.bindAll=Et,a.boundsAttributes=pp,a.bufferConvexPolygon=function(l,n){const c=[];for(let f=0;f<l.length;f++){const m=ti(f-1,-1,l.length-1),x=ti(f+1,-1,l.length-1),E=l[f],M=l[x],I=l[m].sub(E).unit(),P=M.sub(E).unit(),z=P.angleWithSep(I.x,I.y),N=I.add(P).unit().mult(-1*n/Math.sin(z/2));c.push(E.add(N))}return c},a.cacheEntryPossiblyAdded=function(l){ii++,ii>ni&&(l.getActor().send("enforceCacheSizeLimit",Xt),ii=0)},a.calculateGlobeLabelMatrix=function(l,n){const{x:c,y:f}=l.point,m=Ud(c,f,l.worldSize/l._pixelsPerMercatorPixel,0,0);return Ks(m,m,gh(pa(n)))},a.calculateGlobeMatrix=function(l){const{x:n,y:c}=l.point,{lng:f,lat:m}=l._center;return Ud(n,c,l.worldSize,f,m)},a.calculateGlobeMercatorMatrix=function(l){const n=l.pixelsPerMeter,c=n/Ko(1,l.center.lat),f=Yo(new Float64Array(16));return hc(f,f,[l.point.x,l.point.y,0]),Qs(f,f,[c,c,n]),Float32Array.from(f)},a.circumferenceAtLatitude=yh,a.clamp=Ge,a.clearTileCache=function(l){if(!Vt())return;const n=b.caches.delete(ct);l&&n.catch(l).then(()=>l())},a.clipLine=Wf,a.clone=function(l){var n=new no(16);return n[0]=l[0],n[1]=l[1],n[2]=l[2],n[3]=l[3],n[4]=l[4],n[5]=l[5],n[6]=l[6],n[7]=l[7],n[8]=l[8],n[9]=l[9],n[10]=l[10],n[11]=l[11],n[12]=l[12],n[13]=l[13],n[14]=l[14],n[15]=l[15],n},a.clone$1=si,a.collisionCircleLayout=fg,a.config=C,a.conjugate=function(l,n){return l[0]=-n[0],l[1]=-n[1],l[2]=-n[2],l[3]=n[3],l},a.create=function(){var l=new no(16);return no!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=0,l[12]=0,l[13]=0,l[14]=0),l[0]=1,l[5]=1,l[10]=1,l[15]=1,l},a.create$1=wd,a.createExpression=us,a.createLayout=Oi,a.createStyleLayer=function(l){return l.type==="custom"?new n_(l):new a_[l.type](l)},a.cross=uh,a.degToRad=ae,a.distance=function(l,n){return Math.hypot(n[0]-l[0],n[1]-l[1],n[2]-l[2])},a.div=function(l,n,c){return l[0]=n[0]/c[0],l[1]=n[1]/c[1],l[2]=n[2]/c[2],l},a.dot=Ao,a.earthRadius=bc,a.ease=We,a.easeCubicInOut=Me,a.ecefToLatLng=function([l,n,c]){const f=Math.hypot(l,n,c),m=Math.atan2(l,c),x=.5*Math.PI-Math.acos(-n/f);return new pr(J(m),J(x))},a.emitValidationErrors=tu,a.endsWith=yt,a.enforceCacheSizeLimit=function(l){Nt(),Ct&&Ct.then(n=>{n.keys().then(c=>{for(let f=0;f<c.length-l;f++)n.delete(c[f])})})},a.evaluateSizeForFeature=Bu,a.evaluateSizeForZoom=Nl,a.evaluateVariableOffset=tp,a.evented=Ae,a.exactEquals=function(l,n){return l[0]===n[0]&&l[1]===n[1]&&l[2]===n[2]&&l[3]===n[3]},a.exactEquals$1=function(l,n){return l[0]===n[0]&&l[1]===n[1]&&l[2]===n[2]},a.exported=Yt,a.exported$1=D,a.extend=tt,a.extend$1=Sn,a.fillExtrusionHeightLift=wf,a.filterObject=_t,a.fromMat4=function(l,n){return l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[4],l[4]=n[5],l[5]=n[6],l[6]=n[8],l[7]=n[9],l[8]=n[10],l},a.fromQuat=function(l,n){var c=n[0],f=n[1],m=n[2],x=n[3],E=c+c,M=f+f,I=m+m,P=c*E,z=f*E,N=f*M,q=m*E,K=m*M,ee=m*I,oe=x*E,pe=x*M,Ee=x*I;return l[0]=1-N-ee,l[1]=z+Ee,l[2]=q-pe,l[3]=0,l[4]=z-Ee,l[5]=1-P-ee,l[6]=K+oe,l[7]=0,l[8]=q+pe,l[9]=K-oe,l[10]=1-P-N,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l},a.fromRotation=function(l,n){var c=Math.sin(n),f=Math.cos(n);return l[0]=f,l[1]=c,l[2]=0,l[3]=-c,l[4]=f,l[5]=0,l[6]=0,l[7]=0,l[8]=1,l},a.fromScaling=Td,a.furthestTileCorner=function(l){const n=Math.round((l+45+360)%360/90)%4;return se[n]},a.getAABBPointSquareDist=function(l,n,c){let f=0;for(let m=0;m<2;++m){const x=c?c[m]:0;l[m]>x&&(f+=(l[m]-x)*(l[m]-x)),n[m]<x&&(f+=(x-n[m])*(x-n[m]))}return f},a.getAnchorAlignment=Fh,a.getAnchorJustification=Vh,a.getBounds=function(l){let n=1/0,c=1/0,f=-1/0,m=-1/0;for(const x of l)n=Math.min(n,x.x),c=Math.min(c,x.y),f=Math.max(f,x.x),m=Math.max(m,x.y);return{min:new W(n,c),max:new W(f,m)}},a.getColumn=ei,a.getGridMatrix=function(l,n,c,f){const m=n.getNorth(),x=n.getSouth(),E=n.getWest(),M=n.getEast(),I=1<<l.z,P=M-E,z=m-x,N=P/el,q=-z/yc[c],K=[0,N,0,q,0,0,m,E,0];if(l.z>0){const ee=180/f;Ed(K,K,[ee/P+1,0,0,0,ee/z+1,0,-.5*ee/N,.5*ee/q,1])}return K[2]=I,K[5]=l.x,K[8]=l.y,K},a.getImage=Ur,a.getJSON=function(l,n){return Ni(tt(l,{type:"json"}),n)},a.getLatitudinalLod=function(l){const n=Pn-5;l=Ge(l,-n,n)/n*90;const c=Math.pow(Math.abs(Math.sin(ae(l))),3);return Math.round(c*(yc.length-1))},a.getMapSessionAPI=Ue,a.getPerformanceMeasurement=Ai,a.getProjection=cp,a.getRTLTextPluginStatus=Fe,a.getReferrer=Ri,a.getTilePoint=function(l,{x:n,y:c},f=0){return new W(((n-f)*l.scale-l.x)*Zi,(c*l.scale-l.y)*Zi)},a.getTileVec3=function(l,n,c=0){return kl(((n.x-c)*l.scale-l.x)*Zi,(n.y*l.scale-l.y)*Zi,Gd(n.z,n.y))},a.getVideo=function(l,n){const c=b.document.createElement("video");c.muted=!0,c.onloadstart=function(){n(null,c)};for(let f=0;f<l.length;f++){const m=b.document.createElement("source");Ki(l[f])||(c.crossOrigin="Anonymous"),m.src=l[f],c.appendChild(m)}return{cancel:()=>{}}},a.globeCenterToScreenPoint=function(l){const n=[0,0,0],c=Yo(new Float64Array(16));return Ks(c,l.pixelMatrix,l.globeMatrix),tn(n,n,c),new W(n[0],n[1])},a.globeDenormalizeECEF=gh,a.globeECEFOrigin=function(l,n){const c=[0,0,0];return tn(c,c,xc(pa(n.canonical))),tn(c,c,l),c},a.globeMetersToEcef=xu,a.globeNormalizeECEF=xc,a.globePixelsToTileUnits=function(l,n){return Zi/(512*Math.pow(2,l))*wu(pa(n))},a.globePoleMatrixForTile=function(l,n,c){const f=Yo(new Float64Array(16)),m=(n/(1<<l)-.5)*Math.PI*2;return vu(f,c.globeMatrix,m),Float32Array.from(f)},a.globeTileBounds=pa,a.globeTiltAtLngLat=Vd,a.globeToMercatorTransition=Pl,a.globeUseCustomAntiAliasing=function(l,n,c){const f=Pl(c.zoom),m=l.style.map._antialias,x=!!n.extStandardDerivatives,E=n.extStandardDerivativesForceOff||l.terrain&&l.terrain.exaggeration()>0;return f===0&&!m&&!E&&x},a.identity=Yo,a.identity$1=Rd,a.invert=ah,a.isFullscreen=function(){return!!b.document.fullscreenElement||!!b.document.webkitFullscreenElement},a.isLngLatBehindGlobe=_h,a.isMapAuthenticated=function(l){return Ne.has(l)},a.isMapboxURL=Er,a.isSafariWithAntialiasingBug=function(l){const n=l.navigator?l.navigator.userAgent:null;return!!Ci(l)&&n&&(n.match("Version/15.4")||n.match("Version/15.5")||n.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},a.latFromMercatorY=Rn,a.latLngToECEF=Rl,a.len=im,a.length=dc,a.length$1=function(l){return Math.hypot(l[0],l[1],l[2],l[3])},a.lngFromMercatorX=yo,a.loadVectorTile=Dp,a.makeRequest=Ni,a.mapValue=function(l,n,c,f,m){return Ge((l-n)/(c-n)*(m-f)+f,f,m)},a.mercatorScale=Zd,a.mercatorXfromLng=ma,a.mercatorYfromLat=ga,a.mercatorZfromAltitude=Ko,a.mul=em,a.mul$1=tm,a.multiply=Ks,a.multiply$1=Ed,a.multiply$2=Ad,a.nextPowerOfTwo=xt,a.normalize=Vn,a.normalize$1=rm,a.normalize$2=kd,a.number=Qi,a.ortho=function(l,n,c,f,m,x,E){var M=1/(n-c),I=1/(f-m),P=1/(x-E);return l[0]=-2*M,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=-2*I,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=2*P,l[11]=0,l[12]=(n+c)*M,l[13]=(m+f)*I,l[14]=(E+x)*P,l[15]=1,l},a.pbf=Rc,a.perspective=function(l,n,c,f,m){var x,E=1/Math.tan(n/2);return l[0]=E/c,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=E,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=-1,l[12]=0,l[13]=0,l[15]=0,m!=null&&m!==1/0?(l[10]=(m+f)*(x=1/(f-m)),l[14]=2*m*f*x):(l[10]=-1,l[14]=-2*f),l},a.pick=function(l,n){const c={};for(let f=0;f<n.length;f++){const m=n[f];m in l&&(c[m]=l[m])}return c},a.plugin=qe,a.pointGeometry=W,a.polesInViewport=function(l){const n=Yo(new Float64Array(16));Ks(n,l.pixelMatrix,l.globeMatrix);const c=[0,Co,0],f=[0,Io,0];return tn(c,c,n),tn(f,f,n),[c[0]>0&&c[0]<=l.width&&c[1]>0&&c[1]<=l.height&&!_h(l,new pr(l.center.lat,90)),f[0]>0&&f[0]<=l.width&&f[1]>0&&f[1]<=l.height&&!_h(l,new pr(l.center.lat,-90))]},a.polygonContainsPoint=rl,a.polygonIntersectsBox=Jd,a.polygonIntersectsPolygon=Yd,a.polygonizeBounds=function(l,n,c=0,f=!0){const m=new W(c,c),x=l.sub(m),E=n.add(m),M=[x,new W(E.x,x.y),E,new W(x.x,E.y)];return f&&M.push(x.clone()),M},a.posAttributes=_c,a.postMapLoadEvent=me,a.postPerformanceEvent=Pe,a.postTurnstileEvent=Q,a.potpack=Bh,a.prevPowerOfTwo=function(l){return l<=1?1:Math.pow(2,Math.floor(Math.log(l)/Math.LN2))},a.radToDeg=J,a.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],a.registerForPluginStateChange=function(l){return l({pluginStatus:xe,pluginURL:ce}),Ae.on("pluginStateChange",l),l},a.removeAuthState=function(l){Ne.delete(l)},a.renderColorRamp=Mh,a.resample=Hd,a.rotateX=sh,a.rotateX$1=Pd,a.rotateY=vu,a.rotateY$1=Ld,a.rotateZ=function(l,n,c){var f=Math.sin(c),m=Math.cos(c),x=n[0],E=n[1],M=n[2],I=n[3],P=n[4],z=n[5],N=n[6],q=n[7];return n!==l&&(l[8]=n[8],l[9]=n[9],l[10]=n[10],l[11]=n[11],l[12]=n[12],l[13]=n[13],l[14]=n[14],l[15]=n[15]),l[0]=x*m+P*f,l[1]=E*m+z*f,l[2]=M*m+N*f,l[3]=I*m+q*f,l[4]=P*m-x*f,l[5]=z*m-E*f,l[6]=N*m-M*f,l[7]=q*m-I*f,l},a.rotateZ$1=function(l,n,c){c*=.5;var f=n[0],m=n[1],x=n[2],E=n[3],M=Math.sin(c),I=Math.cos(c);return l[0]=f*I+m*M,l[1]=m*I-f*M,l[2]=x*I+E*M,l[3]=E*I-x*M,l},a.scale=Qs,a.scale$1=Id,a.scale$2=_o,a.scaleAndAdd=mc,a.set=function(l,n,c,f){return l[0]=n,l[1]=c,l[2]=f,l},a.setCacheLimits=function(l,n){Xt=l,ni=n},a.setColumn=function(l,n,c){l[4*n+0]=c[0],l[4*n+1]=c[1],l[4*n+2]=c[2],l[4*n+3]=c[3]},a.setRTLTextPlugin=function(l,n,c=!1){if(xe===de||xe===ge||xe===ye)throw new Error("setRTLTextPlugin cannot be called multiple times.");ce=Yt.resolveURL(l),xe=de,ve=n,Te(),c||$e()},a.smoothstep=qt,a.spec=ot,a.squaredLength=function(l){var n=l[0],c=l[1],f=l[2];return n*n+c*c+f*f},a.storeAuthState=function(l,n){n?Ne.add(l):Ne.delete(l)},a.sub=Wo,a.subtract=ch,a.symbolSize=pg,a.tileAABB=function(l,n,c,f,m,x,E,M,I){if(I.name==="globe")return sm(l,n,new Lu(c,f,m));const P=ol({z:c,x:f,y:m},I);return new jn([(x+P.x/P.scale)*n,n*(P.y/P.scale),E],[(x+P.x2/P.scale)*n,n*(P.y2/P.scale),M])},a.tileCornersToBounds=bu,a.tileTransform=ol,a.transformMat3=function(l,n,c){var f=n[0],m=n[1],x=n[2];return l[0]=f*c[0]+m*c[3]+x*c[6],l[1]=f*c[1]+m*c[4]+x*c[7],l[2]=f*c[2]+m*c[5]+x*c[8],l},a.transformMat4=tn,a.transformMat4$1=Js,a.transformQuat=Cd,a.transitionTileAABBinECEF=zd,a.translate=hc,a.transpose=function(l,n){if(l===n){var c=n[1],f=n[2],m=n[5];l[1]=n[3],l[2]=n[6],l[3]=c,l[5]=n[7],l[6]=f,l[7]=m}else l[0]=n[0],l[1]=n[3],l[2]=n[6],l[3]=n[1],l[4]=n[4],l[5]=n[7],l[6]=n[2],l[7]=n[5],l[8]=n[8];return l},a.triggerPluginCompletionEvent=Se,a.uniqueId=Mt,a.updateGlobeVertexNormal=function(l,n,c,f,m){const x=5*n+2;l.float32[x+0]=c,l.float32[x+1]=f,l.float32[x+2]=m},a.validateCustomStyleLayer=function(l){const n=[],c=l.id;return c===void 0&&n.push({message:`layers.${c}: missing required property "id"`}),l.render===void 0&&n.push({message:`layers.${c}: missing required method "render"`}),l.renderingMode&&l.renderingMode!=="2d"&&l.renderingMode!=="3d"&&n.push({message:`layers.${c}: property "renderingMode" must be either "2d" or "3d"`}),n},a.validateFilter=l=>qo(tc(l)),a.validateFog=l=>qo(Qc(l)),a.validateLayer=l=>qo(rc(l)),a.validateLight=l=>qo(Kc(l)),a.validateSource=l=>qo(Vs(l)),a.validateStyle=Jc,a.validateTerrain=l=>qo(nc(l)),a.values=Qt,a.vectorTile=Du,a.version=_,a.warnOnce=vi,a.window=b,a.wrap=ti}),d(["./shared"],function(a){function b(le){if(typeof le=="number"||typeof le=="boolean"||typeof le=="string"||le==null)return JSON.stringify(le);if(Array.isArray(le)){let ne="[";for(const me of le)ne+=`${b(me)},`;return`${ne}]`}let Q="{";for(const ne of Object.keys(le).sort())Q+=`${ne}:${b(le[ne])},`;return`${Q}}`}function _(le){let Q="";for(const ne of a.refProperties)Q+=`/${b(le[ne])}`;return Q}class T{constructor(Q){this.keyCache={},Q&&this.replace(Q)}replace(Q){this._layerConfigs={},this._layers={},this.update(Q,[])}update(Q,ne){for(const we of Q)this._layerConfigs[we.id]=we,(this._layers[we.id]=a.createStyleLayer(we)).compileFilter(),this.keyCache[we.id]&&delete this.keyCache[we.id];for(const we of ne)delete this.keyCache[we],delete this._layerConfigs[we],delete this._layers[we];this.familiesBySource={};const me=function(we,Pe){const Ye={};for(let Ne=0;Ne<we.length;Ne++){const Xe=Pe&&Pe[we[Ne].id]||_(we[Ne]);Pe&&(Pe[we[Ne].id]=Xe);let bt=Ye[Xe];bt||(bt=Ye[Xe]=[]),bt.push(we[Ne])}const Ue=[];for(const Ne in Ye)Ue.push(Ye[Ne]);return Ue}(a.values(this._layerConfigs),this.keyCache);for(const we of me){const Pe=we.map(Ht=>this._layers[Ht.id]),Ye=Pe[0];if(Ye.visibility==="none")continue;const Ue=Ye.source||"";let Ne=this.familiesBySource[Ue];Ne||(Ne=this.familiesBySource[Ue]={});const Xe=Ye.sourceLayer||"_geojsonTileLayer";let bt=Ne[Xe];bt||(bt=Ne[Xe]=[]),bt.push(Pe)}}}class C{loadTile(Q,ne){const{uid:me,encoding:we,rawImageData:Pe,padding:Ye,buildQuadTree:Ue}=Q,Ne=a.window.ImageBitmap&&Pe instanceof a.window.ImageBitmap?this.getImageData(Pe,Ye):Pe;ne(null,new a.DEMData(me,Ne,we,Ye<1,Ue))}getImageData(Q,ne){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(Q.width,Q.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=Q.width,this.offscreenCanvas.height=Q.height,this.offscreenCanvasContext.drawImage(Q,0,0,Q.width,Q.height);const me=this.offscreenCanvasContext.getImageData(-ne,-ne,Q.width+2*ne,Q.height+2*ne);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),me}}var D=function le(Q,ne){var me,we=Q&&Q.type;if(we==="FeatureCollection")for(me=0;me<Q.features.length;me++)le(Q.features[me],ne);else if(we==="GeometryCollection")for(me=0;me<Q.geometries.length;me++)le(Q.geometries[me],ne);else if(we==="Feature")le(Q.geometry,ne);else if(we==="Polygon")k(Q.coordinates,ne);else if(we==="MultiPolygon")for(me=0;me<Q.coordinates.length;me++)k(Q.coordinates[me],ne);return Q};function k(le,Q){if(le.length!==0){O(le[0],Q);for(var ne=1;ne<le.length;ne++)O(le[ne],!Q)}}function O(le,Q){for(var ne=0,me=0,we=0,Pe=le.length,Ye=Pe-1;we<Pe;Ye=we++){var Ue=(le[we][0]-le[Ye][0])*(le[Ye][1]+le[we][1]),Ne=ne+Ue;me+=Math.abs(ne)>=Math.abs(Ue)?ne-Ne+Ue:Ue-Ne+ne,ne=Ne}ne+me>=0!=!!Q&&le.reverse()}const U=a.VectorTileFeature.prototype.toGeoJSON;class G{constructor(Q){this._feature=Q,this.extent=a.EXTENT,this.type=Q.type,this.properties=Q.tags,"id"in Q&&!isNaN(Q.id)&&(this.id=parseInt(Q.id,10))}loadGeometry(){if(this._feature.type===1){const Q=[];for(const ne of this._feature.geometry)Q.push([new a.pointGeometry(ne[0],ne[1])]);return Q}{const Q=[];for(const ne of this._feature.geometry){const me=[];for(const we of ne)me.push(new a.pointGeometry(we[0],we[1]));Q.push(me)}return Q}}toGeoJSON(Q,ne,me){return U.call(this,Q,ne,me)}}class j{constructor(Q){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=a.EXTENT,this.length=Q.length,this._features=Q}feature(Q){return new G(this._features[Q])}}var te={},H={get exports(){return te},set exports(le){te=le}},Z=a.pointGeometry,W=a.vectorTile.VectorTileFeature,_e=fe;function fe(le,Q){this.options=Q||{},this.features=le,this.length=le.length}function re(le,Q){this.id=typeof le.id=="number"?le.id:void 0,this.type=le.type,this.rawGeometry=le.type===1?[le.geometry]:le.geometry,this.properties=le.tags,this.extent=Q||4096}fe.prototype.feature=function(le){return new re(this.features[le],this.options.extent)},re.prototype.loadGeometry=function(){var le=this.rawGeometry;this.geometry=[];for(var Q=0;Q<le.length;Q++){for(var ne=le[Q],me=[],we=0;we<ne.length;we++)me.push(new Z(ne[we][0],ne[we][1]));this.geometry.push(me)}return this.geometry},re.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var le=this.geometry,Q=1/0,ne=-1/0,me=1/0,we=-1/0,Pe=0;Pe<le.length;Pe++)for(var Ye=le[Pe],Ue=0;Ue<Ye.length;Ue++){var Ne=Ye[Ue];Q=Math.min(Q,Ne.x),ne=Math.max(ne,Ne.x),me=Math.min(me,Ne.y),we=Math.max(we,Ne.y)}return[Q,me,ne,we]},re.prototype.toGeoJSON=W.prototype.toGeoJSON;var ae=a.pbf,J=_e;function se(le){var Q=new ae;return function(ne,me){for(var we in ne.layers)me.writeMessage(3,Me,ne.layers[we])}(le,Q),Q.finish()}function Me(le,Q){var ne;Q.writeVarintField(15,le.version||1),Q.writeStringField(1,le.name||""),Q.writeVarintField(5,le.extent||4096);var me={keys:[],values:[],keycache:{},valuecache:{}};for(ne=0;ne<le.length;ne++)me.feature=le.feature(ne),Q.writeMessage(2,Ie,me);var we=me.keys;for(ne=0;ne<we.length;ne++)Q.writeStringField(3,we[ne]);var Pe=me.values;for(ne=0;ne<Pe.length;ne++)Q.writeMessage(4,Ut,Pe[ne])}function Ie(le,Q){var ne=le.feature;ne.id!==void 0&&Q.writeVarintField(1,ne.id),Q.writeMessage(2,We,le),Q.writeVarintField(3,ne.type),Q.writeMessage(4,ti,ne)}function We(le,Q){var ne=le.feature,me=le.keys,we=le.values,Pe=le.keycache,Ye=le.valuecache;for(var Ue in ne.properties){var Ne=ne.properties[Ue],Xe=Pe[Ue];if(Ne!==null){Xe===void 0&&(me.push(Ue),Pe[Ue]=Xe=me.length-1),Q.writeVarint(Xe);var bt=typeof Ne;bt!=="string"&&bt!=="boolean"&&bt!=="number"&&(Ne=JSON.stringify(Ne));var Ht=bt+":"+Ne,Pt=Ye[Ht];Pt===void 0&&(we.push(Ne),Ye[Ht]=Pt=we.length-1),Q.writeVarint(Pt)}}}function Ge(le,Q){return(Q<<3)+(7&le)}function qt(le){return le<<1^le>>31}function ti(le,Q){for(var ne=le.loadGeometry(),me=le.type,we=0,Pe=0,Ye=ne.length,Ue=0;Ue<Ye;Ue++){var Ne=ne[Ue],Xe=1;me===1&&(Xe=Ne.length),Q.writeVarint(Ge(1,Xe));for(var bt=me===3?Ne.length-1:Ne.length,Ht=0;Ht<bt;Ht++){Ht===1&&me!==1&&Q.writeVarint(Ge(2,bt-1));var Pt=Ne[Ht].x-we,Ai=Ne[Ht].y-Pe;Q.writeVarint(qt(Pt)),Q.writeVarint(qt(Ai)),we+=Pt,Pe+=Ai}me===3&&Q.writeVarint(Ge(7,1))}}function Ut(le,Q){var ne=typeof le;ne==="string"?Q.writeStringField(1,le):ne==="boolean"?Q.writeBooleanField(7,le):ne==="number"&&(le%1!=0?Q.writeDoubleField(3,le):le<0?Q.writeSVarintField(6,le):Q.writeVarintField(5,le))}function Qt(le,Q,ne,me,we,Pe){if(we-me<=ne)return;const Ye=me+we>>1;tt(le,Q,Ye,me,we,Pe%2),Qt(le,Q,ne,me,Ye-1,Pe+1),Qt(le,Q,ne,Ye+1,we,Pe+1)}function tt(le,Q,ne,me,we,Pe){for(;we>me;){if(we-me>600){const Xe=we-me+1,bt=ne-me+1,Ht=Math.log(Xe),Pt=.5*Math.exp(2*Ht/3),Ai=.5*Math.sqrt(Ht*Pt*(Xe-Pt)/Xe)*(bt-Xe/2<0?-1:1);tt(le,Q,ne,Math.max(me,Math.floor(ne-bt*Pt/Xe+Ai)),Math.min(we,Math.floor(ne+(Xe-bt)*Pt/Xe+Ai)),Pe)}const Ye=Q[2*ne+Pe];let Ue=me,Ne=we;for(nt(le,Q,me,ne),Q[2*we+Pe]>Ye&&nt(le,Q,me,we);Ue<Ne;){for(nt(le,Q,Ue,Ne),Ue++,Ne--;Q[2*Ue+Pe]<Ye;)Ue++;for(;Q[2*Ne+Pe]>Ye;)Ne--}Q[2*me+Pe]===Ye?nt(le,Q,me,Ne):(Ne++,nt(le,Q,Ne,we)),Ne<=ne&&(me=Ne+1),ne<=Ne&&(we=Ne-1)}}function nt(le,Q,ne,me){Mt(le,ne,me),Mt(Q,2*ne,2*me),Mt(Q,2*ne+1,2*me+1)}function Mt(le,Q,ne){const me=le[Q];le[Q]=le[ne],le[ne]=me}function ht(le,Q,ne,me){const we=le-ne,Pe=Q-me;return we*we+Pe*Pe}H.exports=se,te.fromVectorTileJs=se,te.fromGeojsonVt=function(le,Q){Q=Q||{};var ne={};for(var me in le)ne[me]=new J(le[me].features,Q),ne[me].name=me,ne[me].version=Q.version,ne[me].extent=Q.extent;return se({layers:ne})},te.GeoJSONWrapper=J;const xt=le=>le[0],It=le=>le[1];class Et{constructor(Q,ne=xt,me=It,we=64,Pe=Float64Array){this.nodeSize=we,this.points=Q;const Ye=Q.length<65536?Uint16Array:Uint32Array,Ue=this.ids=new Ye(Q.length),Ne=this.coords=new Pe(2*Q.length);for(let Xe=0;Xe<Q.length;Xe++)Ue[Xe]=Xe,Ne[2*Xe]=ne(Q[Xe]),Ne[2*Xe+1]=me(Q[Xe]);Qt(Ue,Ne,we,0,Ue.length-1,0)}range(Q,ne,me,we){return function(Pe,Ye,Ue,Ne,Xe,bt,Ht){const Pt=[0,Pe.length-1,0],Ai=[];let xi,Ei;for(;Pt.length;){const Fi=Pt.pop(),Ce=Pt.pop(),Yt=Pt.pop();if(Ce-Yt<=Ht){for(let Bi=Yt;Bi<=Ce;Bi++)xi=Ye[2*Bi],Ei=Ye[2*Bi+1],xi>=Ue&&xi<=Xe&&Ei>=Ne&&Ei<=bt&&Ai.push(Pe[Bi]);continue}const At=Math.floor((Yt+Ce)/2);xi=Ye[2*At],Ei=Ye[2*At+1],xi>=Ue&&xi<=Xe&&Ei>=Ne&&Ei<=bt&&Ai.push(Pe[At]);const ui=(Fi+1)%2;(Fi===0?Ue<=xi:Ne<=Ei)&&(Pt.push(Yt),Pt.push(At-1),Pt.push(ui)),(Fi===0?Xe>=xi:bt>=Ei)&&(Pt.push(At+1),Pt.push(Ce),Pt.push(ui))}return Ai}(this.ids,this.coords,Q,ne,me,we,this.nodeSize)}within(Q,ne,me){return function(we,Pe,Ye,Ue,Ne,Xe){const bt=[0,we.length-1,0],Ht=[],Pt=Ne*Ne;for(;bt.length;){const Ai=bt.pop(),xi=bt.pop(),Ei=bt.pop();if(xi-Ei<=Xe){for(let ui=Ei;ui<=xi;ui++)ht(Pe[2*ui],Pe[2*ui+1],Ye,Ue)<=Pt&&Ht.push(we[ui]);continue}const Fi=Math.floor((Ei+xi)/2),Ce=Pe[2*Fi],Yt=Pe[2*Fi+1];ht(Ce,Yt,Ye,Ue)<=Pt&&Ht.push(we[Fi]);const At=(Ai+1)%2;(Ai===0?Ye-Ne<=Ce:Ue-Ne<=Yt)&&(bt.push(Ei),bt.push(Fi-1),bt.push(At)),(Ai===0?Ye+Ne>=Ce:Ue+Ne>=Yt)&&(bt.push(Fi+1),bt.push(xi),bt.push(At))}return Ht}(this.ids,this.coords,Q,ne,me,this.nodeSize)}}const yt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:le=>le},Bt=Math.fround||(_t=new Float32Array(1),le=>(_t[0]=+le,_t[0]));var _t;class si{constructor(Q){this.options=Ci(Object.create(yt),Q),this.trees=new Array(this.options.maxZoom+1)}load(Q){const{log:ne,minZoom:me,maxZoom:we,nodeSize:Pe}=this.options;ne&&console.time("total time");const Ye=`prepare ${Q.length} points`;ne&&console.time(Ye),this.points=Q;let Ue=[];for(let Ne=0;Ne<Q.length;Ne++)Q[Ne].geometry&&Ue.push(vi(Q[Ne],Ne));this.trees[we+1]=new Et(Ue,dt,ei,Pe,Float32Array),ne&&console.timeEnd(Ye);for(let Ne=we;Ne>=me;Ne--){const Xe=+Date.now();Ue=this._cluster(Ue,Ne),this.trees[Ne]=new Et(Ue,dt,ei,Pe,Float32Array),ne&&console.log("z%d: %d clusters in %dms",Ne,Ue.length,+Date.now()-Xe)}return ne&&console.timeEnd("total time"),this}getClusters(Q,ne){let me=((Q[0]+180)%360+360)%360-180;const we=Math.max(-90,Math.min(90,Q[1]));let Pe=Q[2]===180?180:((Q[2]+180)%360+360)%360-180;const Ye=Math.max(-90,Math.min(90,Q[3]));if(Q[2]-Q[0]>=360)me=-180,Pe=180;else if(me>Pe){const bt=this.getClusters([me,we,180,Ye],ne),Ht=this.getClusters([-180,we,Pe,Ye],ne);return bt.concat(Ht)}const Ue=this.trees[this._limitZoom(ne)],Ne=Ue.range($t(me),Mi(Ye),$t(Pe),Mi(we)),Xe=[];for(const bt of Ne){const Ht=Ue.points[bt];Xe.push(Ht.numPoints?ci(Ht):this.points[Ht.index])}return Xe}getChildren(Q){const ne=this._getOriginId(Q),me=this._getOriginZoom(Q),we="No cluster with the specified id.",Pe=this.trees[me];if(!Pe)throw new Error(we);const Ye=Pe.points[ne];if(!Ye)throw new Error(we);const Ue=this.options.radius/(this.options.extent*Math.pow(2,me-1)),Ne=Pe.within(Ye.x,Ye.y,Ue),Xe=[];for(const bt of Ne){const Ht=Pe.points[bt];Ht.parentId===Q&&Xe.push(Ht.numPoints?ci(Ht):this.points[Ht.index])}if(Xe.length===0)throw new Error(we);return Xe}getLeaves(Q,ne,me){const we=[];return this._appendLeaves(we,Q,ne=ne||10,me=me||0,0),we}getTile(Q,ne,me){const we=this.trees[this._limitZoom(Q)],Pe=Math.pow(2,Q),{extent:Ye,radius:Ue}=this.options,Ne=Ue/Ye,Xe=(me-Ne)/Pe,bt=(me+1+Ne)/Pe,Ht={features:[]};return this._addTileFeatures(we.range((ne-Ne)/Pe,Xe,(ne+1+Ne)/Pe,bt),we.points,ne,me,Pe,Ht),ne===0&&this._addTileFeatures(we.range(1-Ne/Pe,Xe,1,bt),we.points,Pe,me,Pe,Ht),ne===Pe-1&&this._addTileFeatures(we.range(0,Xe,Ne/Pe,bt),we.points,-1,me,Pe,Ht),Ht.features.length?Ht:null}getClusterExpansionZoom(Q){let ne=this._getOriginZoom(Q)-1;for(;ne<=this.options.maxZoom;){const me=this.getChildren(Q);if(ne++,me.length!==1)break;Q=me[0].properties.cluster_id}return ne}_appendLeaves(Q,ne,me,we,Pe){const Ye=this.getChildren(ne);for(const Ue of Ye){const Ne=Ue.properties;if(Ne&&Ne.cluster?Pe+Ne.point_count<=we?Pe+=Ne.point_count:Pe=this._appendLeaves(Q,Ne.cluster_id,me,we,Pe):Pe<we?Pe++:Q.push(Ue),Q.length===me)break}return Pe}_addTileFeatures(Q,ne,me,we,Pe,Ye){for(const Ue of Q){const Ne=ne[Ue],Xe=Ne.numPoints;let bt,Ht,Pt;if(Xe)bt=mt(Ne),Ht=Ne.x,Pt=Ne.y;else{const Ei=this.points[Ne.index];bt=Ei.properties,Ht=$t(Ei.geometry.coordinates[0]),Pt=Mi(Ei.geometry.coordinates[1])}const Ai={type:1,geometry:[[Math.round(this.options.extent*(Ht*Pe-me)),Math.round(this.options.extent*(Pt*Pe-we))]],tags:bt};let xi;Xe?xi=Ne.id:this.options.generateId?xi=Ne.index:this.points[Ne.index].id&&(xi=this.points[Ne.index].id),xi!==void 0&&(Ai.id=xi),Ye.features.push(Ai)}}_limitZoom(Q){return Math.max(this.options.minZoom,Math.min(Math.floor(+Q),this.options.maxZoom+1))}_cluster(Q,ne){const me=[],{radius:we,extent:Pe,reduce:Ye,minPoints:Ue}=this.options,Ne=we/(Pe*Math.pow(2,ne));for(let Xe=0;Xe<Q.length;Xe++){const bt=Q[Xe];if(bt.zoom<=ne)continue;bt.zoom=ne;const Ht=this.trees[ne+1],Pt=Ht.within(bt.x,bt.y,Ne),Ai=bt.numPoints||1;let xi=Ai;for(const Ei of Pt){const Fi=Ht.points[Ei];Fi.zoom>ne&&(xi+=Fi.numPoints||1)}if(xi>Ai&&xi>=Ue){let Ei=bt.x*Ai,Fi=bt.y*Ai,Ce=Ye&&Ai>1?this._map(bt,!0):null;const Yt=(Xe<<5)+(ne+1)+this.points.length;for(const At of Pt){const ui=Ht.points[At];if(ui.zoom<=ne)continue;ui.zoom=ne;const Bi=ui.numPoints||1;Ei+=ui.x*Bi,Fi+=ui.y*Bi,ui.parentId=Yt,Ye&&(Ce||(Ce=this._map(bt,!0)),Ye(Ce,this._map(ui)))}bt.parentId=Yt,me.push(Li(Ei/xi,Fi/xi,Yt,xi,Ce))}else if(me.push(bt),xi>1)for(const Ei of Pt){const Fi=Ht.points[Ei];Fi.zoom<=ne||(Fi.zoom=ne,me.push(Fi))}}return me}_getOriginId(Q){return Q-this.points.length>>5}_getOriginZoom(Q){return(Q-this.points.length)%32}_map(Q,ne){if(Q.numPoints)return ne?Ci({},Q.properties):Q.properties;const me=this.points[Q.index].properties,we=this.options.map(me);return ne&&we===me?Ci({},we):we}}function Li(le,Q,ne,me,we){return{x:Bt(le),y:Bt(Q),zoom:1/0,id:ne,parentId:-1,numPoints:me,properties:we}}function vi(le,Q){const[ne,me]=le.geometry.coordinates;return{x:Bt($t(ne)),y:Bt(Mi(me)),zoom:1/0,index:Q,parentId:-1}}function ci(le){return{type:"Feature",id:le.id,properties:mt(le),geometry:{type:"Point",coordinates:[(Q=le.x,360*(Q-.5)),Di(le.y)]}};var Q}function mt(le){const Q=le.numPoints,ne=Q>=1e4?`${Math.round(Q/1e3)}k`:Q>=1e3?Math.round(Q/100)/10+"k":Q;return Ci(Ci({},le.properties),{cluster:!0,cluster_id:le.id,point_count:Q,point_count_abbreviated:ne})}function $t(le){return le/360+.5}function Mi(le){const Q=Math.sin(le*Math.PI/180),ne=.5-.25*Math.log((1+Q)/(1-Q))/Math.PI;return ne<0?0:ne>1?1:ne}function Di(le){const Q=(180-360*le)*Math.PI/180;return 360*Math.atan(Math.exp(Q))/Math.PI-90}function Ci(le,Q){for(const ne in Q)le[ne]=Q[ne];return le}function dt(le){return le.x}function ei(le){return le.y}function ct(le,Q,ne,me){for(var we,Pe=me,Ye=ne-Q>>1,Ue=ne-Q,Ne=le[Q],Xe=le[Q+1],bt=le[ne],Ht=le[ne+1],Pt=Q+3;Pt<ne;Pt+=3){var Ai=Ct(le[Pt],le[Pt+1],Ne,Xe,bt,Ht);if(Ai>Pe)we=Pt,Pe=Ai;else if(Ai===Pe){var xi=Math.abs(Pt-Ye);xi<Ue&&(we=Pt,Ue=xi)}}Pe>me&&(we-Q>3&&ct(le,Q,we,me),le[we+2]=Pe,ne-we>3&&ct(le,we,ne,me))}function Ct(le,Q,ne,me,we,Pe){var Ye=we-ne,Ue=Pe-me;if(Ye!==0||Ue!==0){var Ne=((le-ne)*Ye+(Q-me)*Ue)/(Ye*Ye+Ue*Ue);Ne>1?(ne=we,me=Pe):Ne>0&&(ne+=Ye*Ne,me+=Ue*Ne)}return(Ye=le-ne)*Ye+(Ue=Q-me)*Ue}function Be(le,Q,ne,me){var we={id:le===void 0?null:le,type:Q,geometry:ne,tags:me,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Pe){var Ye=Pe.geometry,Ue=Pe.type;if(Ue==="Point"||Ue==="MultiPoint"||Ue==="LineString")Xt(Pe,Ye);else if(Ue==="Polygon"||Ue==="MultiLineString")for(var Ne=0;Ne<Ye.length;Ne++)Xt(Pe,Ye[Ne]);else if(Ue==="MultiPolygon")for(Ne=0;Ne<Ye.length;Ne++)for(var Xe=0;Xe<Ye[Ne].length;Xe++)Xt(Pe,Ye[Ne][Xe])}(we),we}function Xt(le,Q){for(var ne=0;ne<Q.length;ne+=3)le.minX=Math.min(le.minX,Q[ne]),le.minY=Math.min(le.minY,Q[ne+1]),le.maxX=Math.max(le.maxX,Q[ne]),le.maxY=Math.max(le.maxY,Q[ne+1])}function ni(le,Q,ne,me){if(Q.geometry){var we=Q.geometry.coordinates,Pe=Q.geometry.type,Ye=Math.pow(ne.tolerance/((1<<ne.maxZoom)*ne.extent),2),Ue=[],Ne=Q.id;if(ne.promoteId?Ne=Q.properties[ne.promoteId]:ne.generateId&&(Ne=me||0),Pe==="Point")Vt(we,Ue);else if(Pe==="MultiPoint")for(var Xe=0;Xe<we.length;Xe++)Vt(we[Xe],Ue);else if(Pe==="LineString")Nt(we,Ue,Ye,!1);else if(Pe==="MultiLineString"){if(ne.lineMetrics){for(Xe=0;Xe<we.length;Xe++)Nt(we[Xe],Ue=[],Ye,!1),le.push(Be(Ne,"LineString",Ue,Q.properties));return}mi(we,Ue,Ye,!1)}else if(Pe==="Polygon")mi(we,Ue,Ye,!0);else{if(Pe!=="MultiPolygon"){if(Pe==="GeometryCollection"){for(Xe=0;Xe<Q.geometry.geometries.length;Xe++)ni(le,{id:Ne,geometry:Q.geometry.geometries[Xe],properties:Q.properties},ne,me);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Xe=0;Xe<we.length;Xe++){var bt=[];mi(we[Xe],bt,Ye,!0),Ue.push(bt)}}le.push(Be(Ne,Pe,Ue,Q.properties))}}function Vt(le,Q){Q.push(ii(le[0])),Q.push(Ii(le[1])),Q.push(0)}function Nt(le,Q,ne,me){for(var we,Pe,Ye=0,Ue=0;Ue<le.length;Ue++){var Ne=ii(le[Ue][0]),Xe=Ii(le[Ue][1]);Q.push(Ne),Q.push(Xe),Q.push(0),Ue>0&&(Ye+=me?(we*Xe-Ne*Pe)/2:Math.sqrt(Math.pow(Ne-we,2)+Math.pow(Xe-Pe,2))),we=Ne,Pe=Xe}var bt=Q.length-3;Q[2]=1,ct(Q,0,bt,ne),Q[bt+2]=1,Q.size=Math.abs(Ye),Q.start=0,Q.end=Q.size}function mi(le,Q,ne,me){for(var we=0;we<le.length;we++){var Pe=[];Nt(le[we],Pe,ne,me),Q.push(Pe)}}function ii(le){return le/360+.5}function Ii(le){var Q=Math.sin(le*Math.PI/180),ne=.5-.25*Math.log((1+Q)/(1-Q))/Math.PI;return ne<0?0:ne>1?1:ne}function $i(le,Q,ne,me,we,Pe,Ye,Ue){if(me/=Q,Pe>=(ne/=Q)&&Ye<me)return le;if(Ye<ne||Pe>=me)return null;for(var Ne=[],Xe=0;Xe<le.length;Xe++){var bt=le[Xe],Ht=bt.geometry,Pt=bt.type,Ai=we===0?bt.minX:bt.minY,xi=we===0?bt.maxX:bt.maxY;if(Ai>=ne&&xi<me)Ne.push(bt);else if(!(xi<ne||Ai>=me)){var Ei=[];if(Pt==="Point"||Pt==="MultiPoint")Ri(Ht,Ei,ne,me,we);else if(Pt==="LineString")Ni(Ht,Ei,ne,me,we,!1,Ue.lineMetrics);else if(Pt==="MultiLineString")Ki(Ht,Ei,ne,me,we,!1);else if(Pt==="Polygon")Ki(Ht,Ei,ne,me,we,!0);else if(Pt==="MultiPolygon")for(var Fi=0;Fi<Ht.length;Fi++){var Ce=[];Ki(Ht[Fi],Ce,ne,me,we,!0),Ce.length&&Ei.push(Ce)}if(Ei.length){if(Ue.lineMetrics&&Pt==="LineString"){for(Fi=0;Fi<Ei.length;Fi++)Ne.push(Be(bt.id,Pt,Ei[Fi],bt.tags));continue}Pt!=="LineString"&&Pt!=="MultiLineString"||(Ei.length===1?(Pt="LineString",Ei=Ei[0]):Pt="MultiLineString"),Pt!=="Point"&&Pt!=="MultiPoint"||(Pt=Ei.length===3?"Point":"MultiPoint"),Ne.push(Be(bt.id,Pt,Ei,bt.tags))}}}return Ne.length?Ne:null}function Ri(le,Q,ne,me,we){for(var Pe=0;Pe<le.length;Pe+=3){var Ye=le[Pe+we];Ye>=ne&&Ye<=me&&(Q.push(le[Pe]),Q.push(le[Pe+1]),Q.push(le[Pe+2]))}}function Ni(le,Q,ne,me,we,Pe,Ye){for(var Ue,Ne,Xe=zi(le),bt=we===0?cr:ur,Ht=le.start,Pt=0;Pt<le.length-3;Pt+=3){var Ai=le[Pt],xi=le[Pt+1],Ei=le[Pt+2],Fi=le[Pt+3],Ce=le[Pt+4],Yt=we===0?Ai:xi,At=we===0?Fi:Ce,ui=!1;Ye&&(Ue=Math.sqrt(Math.pow(Ai-Fi,2)+Math.pow(xi-Ce,2))),Yt<ne?At>ne&&(Ne=bt(Xe,Ai,xi,Fi,Ce,ne),Ye&&(Xe.start=Ht+Ue*Ne)):Yt>me?At<me&&(Ne=bt(Xe,Ai,xi,Fi,Ce,me),Ye&&(Xe.start=Ht+Ue*Ne)):_r(Xe,Ai,xi,Ei),At<ne&&Yt>=ne&&(Ne=bt(Xe,Ai,xi,Fi,Ce,ne),ui=!0),At>me&&Yt<=me&&(Ne=bt(Xe,Ai,xi,Fi,Ce,me),ui=!0),!Pe&&ui&&(Ye&&(Xe.end=Ht+Ue*Ne),Q.push(Xe),Xe=zi(le)),Ye&&(Ht+=Ue)}var Bi=le.length-3;Ai=le[Bi],xi=le[Bi+1],Ei=le[Bi+2],(Yt=we===0?Ai:xi)>=ne&&Yt<=me&&_r(Xe,Ai,xi,Ei),Bi=Xe.length-3,Pe&&Bi>=3&&(Xe[Bi]!==Xe[0]||Xe[Bi+1]!==Xe[1])&&_r(Xe,Xe[0],Xe[1],Xe[2]),Xe.length&&Q.push(Xe)}function zi(le){var Q=[];return Q.size=le.size,Q.start=le.start,Q.end=le.end,Q}function Ki(le,Q,ne,me,we,Pe){for(var Ye=0;Ye<le.length;Ye++)Ni(le[Ye],Q,ne,me,we,Pe,!1)}function _r(le,Q,ne,me){le.push(Q),le.push(ne),le.push(me)}function cr(le,Q,ne,me,we,Pe){var Ye=(Pe-Q)/(me-Q);return le.push(Pe),le.push(ne+(we-ne)*Ye),le.push(1),Ye}function ur(le,Q,ne,me,we,Pe){var Ye=(Pe-ne)/(we-ne);return le.push(Q+(me-Q)*Ye),le.push(Pe),le.push(1),Ye}function Ur(le,Q){for(var ne=[],me=0;me<le.length;me++){var we,Pe=le[me],Ye=Pe.type;if(Ye==="Point"||Ye==="MultiPoint"||Ye==="LineString")we=nn(Pe.geometry,Q);else if(Ye==="MultiLineString"||Ye==="Polygon"){we=[];for(var Ue=0;Ue<Pe.geometry.length;Ue++)we.push(nn(Pe.geometry[Ue],Q))}else if(Ye==="MultiPolygon")for(we=[],Ue=0;Ue<Pe.geometry.length;Ue++){for(var Ne=[],Xe=0;Xe<Pe.geometry[Ue].length;Xe++)Ne.push(nn(Pe.geometry[Ue][Xe],Q));we.push(Ne)}ne.push(Be(Pe.id,Ye,we,Pe.tags))}return ne}function nn(le,Q){var ne=[];ne.size=le.size,le.start!==void 0&&(ne.start=le.start,ne.end=le.end);for(var me=0;me<le.length;me+=3)ne.push(le[me]+Q,le[me+1],le[me+2]);return ne}function Er(le,Q){if(le.transformed)return le;var ne,me,we,Pe=1<<le.z,Ye=le.x,Ue=le.y;for(ne=0;ne<le.features.length;ne++){var Ne=le.features[ne],Xe=Ne.geometry,bt=Ne.type;if(Ne.geometry=[],bt===1)for(me=0;me<Xe.length;me+=2)Ne.geometry.push(Kr(Xe[me],Xe[me+1],Q,Pe,Ye,Ue));else for(me=0;me<Xe.length;me++){var Ht=[];for(we=0;we<Xe[me].length;we+=2)Ht.push(Kr(Xe[me][we],Xe[me][we+1],Q,Pe,Ye,Ue));Ne.geometry.push(Ht)}}return le.transformed=!0,le}function Kr(le,Q,ne,me,we,Pe){return[Math.round(ne*(le*me-we)),Math.round(ne*(Q*me-Pe))]}function on(le,Q,ne,me,we){for(var Pe=Q===we.maxZoom?0:we.tolerance/((1<<Q)*we.extent),Ye={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:ne,y:me,z:Q,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Ue=0;Ue<le.length;Ue++){Ye.numFeatures++,an(Ye,le[Ue],Pe,we);var Ne=le[Ue].minX,Xe=le[Ue].minY,bt=le[Ue].maxX,Ht=le[Ue].maxY;Ne<Ye.minX&&(Ye.minX=Ne),Xe<Ye.minY&&(Ye.minY=Xe),bt>Ye.maxX&&(Ye.maxX=bt),Ht>Ye.maxY&&(Ye.maxY=Ht)}return Ye}function an(le,Q,ne,me){var we=Q.geometry,Pe=Q.type,Ye=[];if(Pe==="Point"||Pe==="MultiPoint")for(var Ue=0;Ue<we.length;Ue+=3)Ye.push(we[Ue]),Ye.push(we[Ue+1]),le.numPoints++,le.numSimplified++;else if(Pe==="LineString")vt(Ye,we,le,ne,!1,!1);else if(Pe==="MultiLineString"||Pe==="Polygon")for(Ue=0;Ue<we.length;Ue++)vt(Ye,we[Ue],le,ne,Pe==="Polygon",Ue===0);else if(Pe==="MultiPolygon")for(var Ne=0;Ne<we.length;Ne++){var Xe=we[Ne];for(Ue=0;Ue<Xe.length;Ue++)vt(Ye,Xe[Ue],le,ne,!0,Ue===0)}if(Ye.length){var bt=Q.tags||null;if(Pe==="LineString"&&me.lineMetrics){for(var Ht in bt={},Q.tags)bt[Ht]=Q.tags[Ht];bt.mapbox_clip_start=we.start/we.size,bt.mapbox_clip_end=we.end/we.size}var Pt={geometry:Ye,type:Pe==="Polygon"||Pe==="MultiPolygon"?3:Pe==="LineString"||Pe==="MultiLineString"?2:1,tags:bt};Q.id!==null&&(Pt.id=Q.id),le.features.push(Pt)}}function vt(le,Q,ne,me,we,Pe){var Ye=me*me;if(me>0&&Q.size<(we?Ye:me))ne.numPoints+=Q.length/3;else{for(var Ue=[],Ne=0;Ne<Q.length;Ne+=3)(me===0||Q[Ne+2]>Ye)&&(ne.numSimplified++,Ue.push(Q[Ne]),Ue.push(Q[Ne+1])),ne.numPoints++;we&&function(Xe,bt){for(var Ht=0,Pt=0,Ai=Xe.length,xi=Ai-2;Pt<Ai;xi=Pt,Pt+=2)Ht+=(Xe[Pt]-Xe[xi])*(Xe[Pt+1]+Xe[xi+1]);if(Ht>0===bt)for(Pt=0,Ai=Xe.length;Pt<Ai/2;Pt+=2){var Ei=Xe[Pt],Fi=Xe[Pt+1];Xe[Pt]=Xe[Ai-2-Pt],Xe[Pt+1]=Xe[Ai-1-Pt],Xe[Ai-2-Pt]=Ei,Xe[Ai-1-Pt]=Fi}}(Ue,Pe),le.push(Ue)}}function _i(le,Q){var ne=(Q=this.options=function(we,Pe){for(var Ye in Pe)we[Ye]=Pe[Ye];return we}(Object.create(this.options),Q)).debug;if(ne&&console.time("preprocess data"),Q.maxZoom<0||Q.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Q.promoteId&&Q.generateId)throw new Error("promoteId and generateId cannot be used together.");var me=function(we,Pe){var Ye=[];if(we.type==="FeatureCollection")for(var Ue=0;Ue<we.features.length;Ue++)ni(Ye,we.features[Ue],Pe,Ue);else ni(Ye,we.type==="Feature"?we:{geometry:we},Pe);return Ye}(le,Q);this.tiles={},this.tileCoords=[],ne&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Q.indexMaxZoom,Q.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),me=function(we,Pe){var Ye=Pe.buffer/Pe.extent,Ue=we,Ne=$i(we,1,-1-Ye,Ye,0,-1,2,Pe),Xe=$i(we,1,1-Ye,2+Ye,0,-1,2,Pe);return(Ne||Xe)&&(Ue=$i(we,1,-Ye,1+Ye,0,-1,2,Pe)||[],Ne&&(Ue=Ur(Ne,1).concat(Ue)),Xe&&(Ue=Ue.concat(Ur(Xe,-1)))),Ue}(me,Q),me.length&&this.splitTile(me,0,0,0),ne&&(me.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function he(le,Q,ne){return 32*((1<<le)*ne+Q)+le}function Oe(le,Q){const ne=le.tileID.canonical;if(!this._geoJSONIndex)return Q(null,null);const me=this._geoJSONIndex.getTile(ne.z,ne.x,ne.y);if(!me)return Q(null,null);const we=new j(me.features);let Pe=te(we);Pe.byteOffset===0&&Pe.byteLength===Pe.buffer.byteLength||(Pe=new Uint8Array(Pe)),Q(null,{vectorTile:we,rawData:Pe.buffer})}_i.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},_i.prototype.splitTile=function(le,Q,ne,me,we,Pe,Ye){for(var Ue=[le,Q,ne,me],Ne=this.options,Xe=Ne.debug;Ue.length;){me=Ue.pop(),ne=Ue.pop(),Q=Ue.pop(),le=Ue.pop();var bt=1<<Q,Ht=he(Q,ne,me),Pt=this.tiles[Ht];if(!Pt&&(Xe>1&&console.time("creation"),Pt=this.tiles[Ht]=on(le,Q,ne,me,Ne),this.tileCoords.push({z:Q,x:ne,y:me}),Xe)){Xe>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Q,ne,me,Pt.numFeatures,Pt.numPoints,Pt.numSimplified),console.timeEnd("creation"));var Ai="z"+Q;this.stats[Ai]=(this.stats[Ai]||0)+1,this.total++}if(Pt.source=le,we){if(Q===Ne.maxZoom||Q===we)continue;var xi=1<<we-Q;if(ne!==Math.floor(Pe/xi)||me!==Math.floor(Ye/xi))continue}else if(Q===Ne.indexMaxZoom||Pt.numPoints<=Ne.indexMaxPoints)continue;if(Pt.source=null,le.length!==0){Xe>1&&console.time("clipping");var Ei,Fi,Ce,Yt,At,ui,Bi=.5*Ne.buffer/Ne.extent,rr=.5-Bi,dr=.5+Bi,ot=1+Bi;Ei=Fi=Ce=Yt=null,At=$i(le,bt,ne-Bi,ne+dr,0,Pt.minX,Pt.maxX,Ne),ui=$i(le,bt,ne+rr,ne+ot,0,Pt.minX,Pt.maxX,Ne),le=null,At&&(Ei=$i(At,bt,me-Bi,me+dr,1,Pt.minY,Pt.maxY,Ne),Fi=$i(At,bt,me+rr,me+ot,1,Pt.minY,Pt.maxY,Ne),At=null),ui&&(Ce=$i(ui,bt,me-Bi,me+dr,1,Pt.minY,Pt.maxY,Ne),Yt=$i(ui,bt,me+rr,me+ot,1,Pt.minY,Pt.maxY,Ne),ui=null),Xe>1&&console.timeEnd("clipping"),Ue.push(Ei||[],Q+1,2*ne,2*me),Ue.push(Fi||[],Q+1,2*ne,2*me+1),Ue.push(Ce||[],Q+1,2*ne+1,2*me),Ue.push(Yt||[],Q+1,2*ne+1,2*me+1)}}},_i.prototype.getTile=function(le,Q,ne){var me=this.options,we=me.extent,Pe=me.debug;if(le<0||le>24)return null;var Ye=1<<le,Ue=he(le,Q=(Q%Ye+Ye)%Ye,ne);if(this.tiles[Ue])return Er(this.tiles[Ue],we);Pe>1&&console.log("drilling down to z%d-%d-%d",le,Q,ne);for(var Ne,Xe=le,bt=Q,Ht=ne;!Ne&&Xe>0;)Xe--,bt=Math.floor(bt/2),Ht=Math.floor(Ht/2),Ne=this.tiles[he(Xe,bt,Ht)];return Ne&&Ne.source?(Pe>1&&console.log("found parent tile z%d-%d-%d",Xe,bt,Ht),Pe>1&&console.time("drilling down"),this.splitTile(Ne.source,Xe,bt,Ht,le,Q,ne),Pe>1&&console.timeEnd("drilling down"),this.tiles[Ue]?Er(this.tiles[Ue],we):null):null};class He extends a.VectorTileWorkerSource{constructor(Q,ne,me,we,Pe){super(Q,ne,me,we,Oe),Pe&&(this.loadGeoJSON=Pe)}loadData(Q,ne){const me=Q&&Q.request,we=me&&me.collectResourceTiming;this.loadGeoJSON(Q,(Pe,Ye)=>{if(Pe||!Ye)return ne(Pe);if(typeof Ye!="object")return ne(new Error(`Input data given to '${Q.source}' is not a valid GeoJSON object.`));{D(Ye,!0);try{if(Q.filter){const Ne=a.createExpression(Q.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Ne.result==="error")throw new Error(Ne.value.map(bt=>`${bt.key}: ${bt.message}`).join(", "));Ye={type:"FeatureCollection",features:Ye.features.filter(bt=>Ne.value.evaluate({zoom:0},bt))}}this._geoJSONIndex=Q.cluster?new si(function({superclusterOptions:Ne,clusterProperties:Xe}){if(!Xe||!Ne)return Ne;const bt={},Ht={},Pt={accumulated:null,zoom:0},Ai={properties:null},xi=Object.keys(Xe);for(const Ei of xi){const[Fi,Ce]=Xe[Ei],Yt=a.createExpression(Ce),At=a.createExpression(typeof Fi=="string"?[Fi,["accumulated"],["get",Ei]]:Fi);bt[Ei]=Yt.value,Ht[Ei]=At.value}return Ne.map=Ei=>{Ai.properties=Ei;const Fi={};for(const Ce of xi)Fi[Ce]=bt[Ce].evaluate(Pt,Ai);return Fi},Ne.reduce=(Ei,Fi)=>{Ai.properties=Fi;for(const Ce of xi)Pt.accumulated=Ei[Ce],Ei[Ce]=Ht[Ce].evaluate(Pt,Ai)},Ne}(Q)).load(Ye.features):function(Ne,Xe){return new _i(Ne,Xe)}(Ye,Q.geojsonVtOptions)}catch(Ne){return ne(Ne)}this.loaded={};const Ue={};if(we){const Ne=a.getPerformanceMeasurement(me);Ne&&(Ue.resourceTiming={},Ue.resourceTiming[Q.source]=JSON.parse(JSON.stringify(Ne)))}ne(null,Ue)}})}reloadTile(Q,ne){const me=this.loaded;return me&&me[Q.uid]?super.reloadTile(Q,ne):this.loadTile(Q,ne)}loadGeoJSON(Q,ne){if(Q.request)a.getJSON(Q.request,ne);else{if(typeof Q.data!="string")return ne(new Error(`Input data given to '${Q.source}' is not a valid GeoJSON object.`));try{return ne(null,JSON.parse(Q.data))}catch{return ne(new Error(`Input data given to '${Q.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(Q,ne){try{ne(null,this._geoJSONIndex.getClusterExpansionZoom(Q.clusterId))}catch(me){ne(me)}}getClusterChildren(Q,ne){try{ne(null,this._geoJSONIndex.getChildren(Q.clusterId))}catch(me){ne(me)}}getClusterLeaves(Q,ne){try{ne(null,this._geoJSONIndex.getLeaves(Q.clusterId,Q.limit,Q.offset))}catch(me){ne(me)}}}class Tt{constructor(Q){this.self=Q,this.actor=new a.Actor(Q,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=a.getProjection({name:"mercator"}),this.workerSourceTypes={vector:a.VectorTileWorkerSource,geojson:He},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(ne,me)=>{if(this.workerSourceTypes[ne])throw new Error(`Worker source with name "${ne}" already registered.`);this.workerSourceTypes[ne]=me},this.self.registerRTLTextPlugin=ne=>{if(a.plugin.isParsed())throw new Error("RTL text plugin already registered.");a.plugin.applyArabicShaping=ne.applyArabicShaping,a.plugin.processBidirectionalText=ne.processBidirectionalText,a.plugin.processStyledBidirectionalText=ne.processStyledBidirectionalText}}clearCaches(Q,ne,me){delete this.layerIndexes[Q],delete this.availableImages[Q],delete this.workerSources[Q],delete this.demWorkerSources[Q],me()}checkIfReady(Q,ne,me){me()}setReferrer(Q,ne){this.referrer=ne}spriteLoaded(Q,ne){this.isSpriteLoaded[Q]=ne;for(const me in this.workerSources[Q]){const we=this.workerSources[Q][me];for(const Pe in we)we[Pe]instanceof a.VectorTileWorkerSource&&(we[Pe].isSpriteLoaded=ne,we[Pe].fire(new a.Event("isSpriteLoaded")))}}setImages(Q,ne,me){this.availableImages[Q]=ne;for(const we in this.workerSources[Q]){const Pe=this.workerSources[Q][we];for(const Ye in Pe)Pe[Ye].availableImages=ne}me()}enableTerrain(Q,ne,me){this.terrain=ne,me()}setProjection(Q,ne){this.projections[Q]=a.getProjection(ne)}setLayers(Q,ne,me){this.getLayerIndex(Q).replace(ne),me()}updateLayers(Q,ne,me){this.getLayerIndex(Q).update(ne.layers,ne.removedIds),me()}loadTile(Q,ne,me){const we=this.enableTerrain?a.extend({enableTerrain:this.terrain},ne):ne;we.projection=this.projections[Q]||this.defaultProjection,this.getWorkerSource(Q,ne.type,ne.source).loadTile(we,me)}loadDEMTile(Q,ne,me){const we=this.enableTerrain?a.extend({buildQuadTree:this.terrain},ne):ne;this.getDEMWorkerSource(Q,ne.source).loadTile(we,me)}reloadTile(Q,ne,me){const we=this.enableTerrain?a.extend({enableTerrain:this.terrain},ne):ne;we.projection=this.projections[Q]||this.defaultProjection,this.getWorkerSource(Q,ne.type,ne.source).reloadTile(we,me)}abortTile(Q,ne,me){this.getWorkerSource(Q,ne.type,ne.source).abortTile(ne,me)}removeTile(Q,ne,me){this.getWorkerSource(Q,ne.type,ne.source).removeTile(ne,me)}removeSource(Q,ne,me){if(!this.workerSources[Q]||!this.workerSources[Q][ne.type]||!this.workerSources[Q][ne.type][ne.source])return;const we=this.workerSources[Q][ne.type][ne.source];delete this.workerSources[Q][ne.type][ne.source],we.removeSource!==void 0?we.removeSource(ne,me):me()}loadWorkerSource(Q,ne,me){try{this.self.importScripts(ne.url),me()}catch(we){me(we.toString())}}syncRTLPluginState(Q,ne,me){try{a.plugin.setState(ne);const we=a.plugin.getPluginURL();if(a.plugin.isLoaded()&&!a.plugin.isParsed()&&we!=null){this.self.importScripts(we);const Pe=a.plugin.isParsed();me(Pe?void 0:new Error(`RTL Text Plugin failed to import scripts from ${we}`),Pe)}}catch(we){me(we.toString())}}getAvailableImages(Q){let ne=this.availableImages[Q];return ne||(ne=[]),ne}getLayerIndex(Q){let ne=this.layerIndexes[Q];return ne||(ne=this.layerIndexes[Q]=new T),ne}getWorkerSource(Q,ne,me){if(this.workerSources[Q]||(this.workerSources[Q]={}),this.workerSources[Q][ne]||(this.workerSources[Q][ne]={}),!this.workerSources[Q][ne][me]){const we={send:(Pe,Ye,Ue,Ne,Xe,bt)=>{this.actor.send(Pe,Ye,Ue,Q,Xe,bt)},scheduler:this.actor.scheduler};this.workerSources[Q][ne][me]=new this.workerSourceTypes[ne](we,this.getLayerIndex(Q),this.getAvailableImages(Q),this.isSpriteLoaded[Q])}return this.workerSources[Q][ne][me]}getDEMWorkerSource(Q,ne){return this.demWorkerSources[Q]||(this.demWorkerSources[Q]={}),this.demWorkerSources[Q][ne]||(this.demWorkerSources[Q][ne]=new C),this.demWorkerSources[Q][ne]}enforceCacheSizeLimit(Q,ne){a.enforceCacheSizeLimit(ne)}getWorkerPerformanceMetrics(Q,ne,me){me(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new Tt(self)),Tt}),d(["./shared"],function(a){function b(y,u){if(Array.isArray(y)){if(!Array.isArray(u)||y.length!==u.length)return!1;for(let p=0;p<y.length;p++)if(!b(y[p],u[p]))return!1;return!0}if(typeof y=="object"&&y!==null&&u!==null){if(typeof u!="object"||Object.keys(y).length!==Object.keys(u).length)return!1;for(const p in y)if(!b(y[p],u[p]))return!1;return!0}return y===u}var _=T;function T(y){return!function(u){return typeof window>"u"||typeof document>"u"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var w,S,A=new Blob([""],{type:"text/javascript"}),L=URL.createObjectURL(A);try{S=new Worker(L),w=!0}catch{w=!1}return S&&S.terminate(),URL.revokeObjectURL(L),w}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var w=document.createElement("canvas");w.width=w.height=1;var S=w.getContext("2d");if(!S)return!1;var A=S.getImageData(0,0,1,1);return A&&A.width===w.width}()?(C[p=u&&u.failIfMajorPerformanceCaveat]===void 0&&(C[p]=function(w){var S,A=function(L){var B=document.createElement("canvas"),F=Object.create(T.webGLContextAttributes);return F.failIfMajorPerformanceCaveat=L,B.getContext("webgl",F)||B.getContext("experimental-webgl",F)}(w);if(!A)return!1;try{S=A.createShader(A.VERTEX_SHADER)}catch{return!1}return!(!S||A.isContextLost())&&(A.shaderSource(S,"void main() {}"),A.compileShader(S),A.getShaderParameter(S,A.COMPILE_STATUS)===!0)}(p)),C[p]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var p}(y)}var C={};function D(y,u,p){const w=a.window.document.createElement(y);return u!==void 0&&(w.className=u),p&&p.appendChild(w),w}function k(y,u,p){const w=a.window.document.createElementNS("http://www.w3.org/2000/svg",y);for(const S of Object.keys(u))w.setAttributeNS(null,S,u[S]);return p&&p.appendChild(w),w}T.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const O=a.window.document&&a.window.document.documentElement.style,U=O&&O.userSelect!==void 0?"userSelect":"WebkitUserSelect";let G;function j(){O&&U&&(G=O[U],O[U]="none")}function te(){O&&U&&(O[U]=G)}function H(y){y.preventDefault(),y.stopPropagation(),a.window.removeEventListener("click",H,!0)}function Z(){a.window.addEventListener("click",H,!0),a.window.setTimeout(()=>{a.window.removeEventListener("click",H,!0)},0)}function W(y,u){const p=y.getBoundingClientRect();return re(y,p,u)}function _e(y,u){const p=y.getBoundingClientRect(),w=[];for(let S=0;S<u.length;S++)w.push(re(y,p,u[S]));return w}function fe(y){return a.window.InstallTrigger!==void 0&&y.button===2&&y.ctrlKey&&a.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:y.button}function re(y,u,p){const w=y.offsetWidth===u.width?1:y.offsetWidth/u.width;return new a.pointGeometry((p.clientX-u.left)*w,(p.clientY-u.top)*w)}function ae(y,u){var p=u[0],w=u[1],S=u[2],A=u[3],L=p*A-S*w;return L?(y[0]=A*(L=1/L),y[1]=-w*L,y[2]=-S*L,y[3]=p*L,y):null}function J(y){const{userImage:u}=y;return!!(u&&u.render&&u.render())&&(y.data.replace(new Uint8Array(u.data.buffer)),!0)}class se extends a.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new a.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(u){if(this.loaded!==u&&(this.loaded=u,u)){for(const{ids:p,callback:w}of this.requestors)this._notify(p,w);this.requestors=[]}}hasImage(u){return!!this.getImage(u)}getImage(u){return this.images[u]}addImage(u,p){this._validate(u,p)&&(this.images[u]=p)}_validate(u,p){let w=!0;return this._validateStretch(p.stretchX,p.data&&p.data.width)||(this.fire(new a.ErrorEvent(new Error(`Image "${u}" has invalid "stretchX" value`))),w=!1),this._validateStretch(p.stretchY,p.data&&p.data.height)||(this.fire(new a.ErrorEvent(new Error(`Image "${u}" has invalid "stretchY" value`))),w=!1),this._validateContent(p.content,p)||(this.fire(new a.ErrorEvent(new Error(`Image "${u}" has invalid "content" value`))),w=!1),w}_validateStretch(u,p){if(!u)return!0;let w=0;for(const S of u){if(S[0]<w||S[1]<S[0]||p<S[1])return!1;w=S[1]}return!0}_validateContent(u,p){return!(u&&(u.length!==4||u[0]<0||p.data.width<u[0]||u[1]<0||p.data.height<u[1]||u[2]<0||p.data.width<u[2]||u[3]<0||p.data.height<u[3]||u[2]<u[0]||u[3]<u[1]))}updateImage(u,p){p.version=this.images[u].version+1,this.images[u]=p,this.updatedImages[u]=!0}removeImage(u){const p=this.images[u];delete this.images[u],delete this.patterns[u],p.userImage&&p.userImage.onRemove&&p.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(u,p){let w=!0;if(!this.isLoaded())for(const S of u)this.images[S]||(w=!1);this.isLoaded()||w?this._notify(u,p):this.requestors.push({ids:u,callback:p})}_notify(u,p){const w={};for(const S of u){this.images[S]||this.fire(new a.Event("styleimagemissing",{id:S}));const A=this.images[S];A?w[S]={data:A.data.clone(),pixelRatio:A.pixelRatio,sdf:A.sdf,version:A.version,stretchX:A.stretchX,stretchY:A.stretchY,content:A.content,hasRenderCallback:!!(A.userImage&&A.userImage.render)}:a.warnOnce(`Image "${S}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}p(null,w)}getPixelSize(){const{width:u,height:p}=this.atlasImage;return{width:u,height:p}}getPattern(u){const p=this.patterns[u],w=this.getImage(u);if(!w)return null;if(p&&p.position.version===w.version)return p.position;if(p)p.position.version=w.version;else{const S={w:w.data.width+2,h:w.data.height+2,x:0,y:0},A=new a.ImagePosition(S,w);this.patterns[u]={bin:S,position:A}}return this._updatePatternAtlas(),this.patterns[u].position}bind(u){const p=u.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new a.Texture(u,this.atlasImage,p.RGBA),this.atlasTexture&&this.atlasTexture.bind(p.LINEAR,p.CLAMP_TO_EDGE)}_updatePatternAtlas(){const u=[];for(const A in this.patterns)u.push(this.patterns[A].bin);const{w:p,h:w}=a.potpack(u),S=this.atlasImage;S.resize({width:p||1,height:w||1});for(const A in this.patterns){const{bin:L}=this.patterns[A],B=L.x+1,F=L.y+1,Y=this.images[A].data,X=Y.width,ie=Y.height;a.RGBAImage.copy(Y,S,{x:0,y:0},{x:B,y:F},{width:X,height:ie}),a.RGBAImage.copy(Y,S,{x:0,y:ie-1},{x:B,y:F-1},{width:X,height:1}),a.RGBAImage.copy(Y,S,{x:0,y:0},{x:B,y:F+ie},{width:X,height:1}),a.RGBAImage.copy(Y,S,{x:X-1,y:0},{x:B-1,y:F},{width:1,height:ie}),a.RGBAImage.copy(Y,S,{x:0,y:0},{x:B+X,y:F},{width:1,height:ie})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(u){for(const p of u){if(this.callbackDispatchedThisFrame[p])continue;this.callbackDispatchedThisFrame[p]=!0;const w=this.images[p];J(w)&&this.updateImage(p,w)}}}const Me=new a.Properties({anchor:new a.DataConstantProperty(a.spec.light.anchor),position:new class{constructor(){this.specification=a.spec.light.position}possiblyEvaluate(y,u){return function([p,w,S]){const A=a.degToRad(w+90),L=a.degToRad(S);return{x:p*Math.cos(A)*Math.sin(L),y:p*Math.sin(A)*Math.sin(L),z:p*Math.cos(L),azimuthal:w,polar:S}}(y.expression.evaluate(u))}interpolate(y,u,p){return{x:a.number(y.x,u.x,p),y:a.number(y.y,u.y,p),z:a.number(y.z,u.z,p),azimuthal:a.number(y.azimuthal,u.azimuthal,p),polar:a.number(y.polar,u.polar,p)}}},color:new a.DataConstantProperty(a.spec.light.color),intensity:new a.DataConstantProperty(a.spec.light.intensity)}),Ie="-transition";class We extends a.Evented{constructor(u){super(),this._transitionable=new a.Transitionable(Me),this.setLight(u),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(u,p={}){if(!this._validate(a.validateLight,u,p))for(const w in u){const S=u[w];a.endsWith(w,Ie)?this._transitionable.setTransition(w.slice(0,-Ie.length),S):this._transitionable.setValue(w,S)}}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,p,w){return(!w||w.validate!==!1)&&a.emitValidationErrors(this,u.call(a.validateStyle,a.extend({value:p,style:{glyphs:!0,sprite:!0},styleSpec:a.spec})))}}const Ge=new a.Properties({source:new a.DataConstantProperty(a.spec.terrain.source),exaggeration:new a.DataConstantProperty(a.spec.terrain.exaggeration)}),qt="-transition";class ti extends a.Evented{constructor(u,p){super(),this._transitionable=new a.Transitionable(Ge),this.set(u),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=p}get(){return this._transitionable.serialize()}set(u){for(const p in u){const w=u[p];a.endsWith(p,qt)?this._transitionable.setTransition(p.slice(0,-qt.length),w):this._transitionable.setValue(p,w)}}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}}function Ut(y,u,p,w){const S=a.smoothstep(45,65,p),[A,L]=Qt(y,w),B=a.length(u);let F=1-Math.min(1,Math.exp((B-A)/(L-A)*-6));return F*=F*F,F=Math.min(1,1.00747*F),F*S*y.alpha}function Qt(y,u){const p=.5/Math.tan(.5*u);return[y.range[0]+p,y.range[1]+p]}const tt=new a.Properties({range:new a.DataConstantProperty(a.spec.fog.range),color:new a.DataConstantProperty(a.spec.fog.color),"high-color":new a.DataConstantProperty(a.spec.fog["high-color"]),"space-color":new a.DataConstantProperty(a.spec.fog["space-color"]),"horizon-blend":new a.DataConstantProperty(a.spec.fog["horizon-blend"]),"star-intensity":new a.DataConstantProperty(a.spec.fog["star-intensity"])}),nt="-transition";class Mt extends a.Evented{constructor(u,p){super(),this._transitionable=new a.Transitionable(tt),this.set(u),this._transitioning=this._transitionable.untransitioned(),this._transform=p}get state(){const u=this._transform,p=u.projection.name==="globe",w=a.globeToMercatorTransition(u.zoom),S=this.properties.get("range"),A=[.5,3];return{range:p?[a.number(A[0],S[0],w),a.number(A[1],S[1],w)]:S,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(u,p={}){if(!this._validate(a.validateFog,u,p)){for(const w of Object.keys(a.spec.fog))u&&u[w]===void 0&&(u[w]=a.spec.fog[w].default);for(const w in u){const S=u[w];a.endsWith(w,nt)?this._transitionable.setTransition(w.slice(0,-nt.length),S):this._transitionable.setValue(w,S)}}}getOpacity(u){if(!this._transform.projection.supportsFog)return 0;const p=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:a.smoothstep(45,65,u))*p.a}getOpacityAtLatLng(u,p){return this._transform.projection.supportsFog?function(w,S,A){const L=a.MercatorCoordinate.fromLngLat(S),B=A.elevation?A.elevation.getAtPointOrZero(L):0,F=[L.x,L.y,B];return a.transformMat4(F,F,A.mercatorFogMatrix),Ut(w,F,A.pitch,A._fov)}(this.state,u,p):0}getFovAdjustedRange(u){return this._transform.projection.supportsFog?Qt(this.state,u):[0,1]}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,p,w){return(!w||w.validate!==!1)&&a.emitValidationErrors(this,u.call(a.validateStyle,a.extend({value:p,style:{glyphs:!0,sprite:!0},styleSpec:a.spec})))}}class ht{constructor(u,p){this.workerPool=u,this.actors=[],this.currentActor=0,this.id=a.uniqueId();const w=this.workerPool.acquire(this.id);for(let S=0;S<w.length;S++){const A=new ht.Actor(w[S],p,this.id);A.name=`Worker ${S}`,this.actors.push(A)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(u,p,w){a.asyncAll(this.actors,(S,A)=>{S.send(u,p,A)},w=w||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(u=>{u.remove()}),this.actors=[],this.workerPool.release(this.id)}}function xt(y,u,p){return u*(a.EXTENT/(y.tileSize*Math.pow(2,p-y.tileID.overscaledZ)))}ht.Actor=a.Actor;class It{constructor(u,p,w,S){this.screenBounds=u,this.cameraPoint=p,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=w,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,S)}static createFromScreenPoints(u,p){let w,S;if(u instanceof a.pointGeometry||typeof u[0]=="number"){const A=a.pointGeometry.convert(u);w=[A],S=p.isPointAboveHorizon(A)}else{const A=a.pointGeometry.convert(u[0]),L=a.pointGeometry.convert(u[1]);w=[A,L],S=a.polygonizeBounds(A,L).every(B=>p.isPointAboveHorizon(B))}return new It(w,p.getCameraPoint(),S,p)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(u){return a.polygonizeBounds(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],u)}bufferedCameraGeometry(u){const p=this.screenBounds[0],w=this.screenBounds.length===1?this.screenBounds[0].add(new a.pointGeometry(1,1)):this.screenBounds[1],S=a.polygonizeBounds(p,w,0,!1);return this.cameraPoint.y>w.y&&(this.cameraPoint.x>p.x&&this.cameraPoint.x<w.x?S.splice(3,0,this.cameraPoint):this.cameraPoint.x>=w.x?S[2]=this.cameraPoint:this.cameraPoint.x<=p.x&&(S[3]=this.cameraPoint)),a.bufferConvexPolygon(S,u)}bufferedCameraGeometryGlobe(u){const p=this.screenBounds[0],w=this.screenBounds.length===1?this.screenBounds[0].add(new a.pointGeometry(1,1)):this.screenBounds[1],S=a.polygonizeBounds(p,w,u),A=this.cameraPoint.clone();switch(3*((A.y>p.y)+(A.y>w.y))+((A.x>p.x)+(A.x>w.x))){case 0:S[0]=A,S[4]=A.clone();break;case 1:S.splice(1,0,A);break;case 2:S[1]=A;break;case 3:S.splice(4,0,A);break;case 5:S.splice(2,0,A);break;case 6:S[3]=A;break;case 7:S.splice(3,0,A);break;case 8:S[2]=A}return S}containsTile(u,p,w,S=0){const A=u.queryPadding/p._pixelsPerMercatorPixel+1,L=w?this._bufferedCameraMercator(A,p):this._bufferedScreenMercator(A,p);let B=u.tileID.wrap+(L.unwrapped?S:0);const F=L.polygon.map(xe=>a.getTilePoint(u.tileTransform,xe,B));if(!a.polygonIntersectsBox(F,0,0,a.EXTENT,a.EXTENT))return;B=u.tileID.wrap+(this.screenGeometryMercator.unwrapped?S:0);const Y=this.screenGeometryMercator.polygon.map(xe=>a.getTileVec3(u.tileTransform,xe,B)),X=Y.map(xe=>new a.pointGeometry(xe[0],xe[1])),ie=p.getFreeCameraOptions().position||new a.MercatorCoordinate(0,0,0),de=a.getTileVec3(u.tileTransform,ie,B),ge=Y.map(xe=>{const ce=a.sub(xe,xe,de);return a.normalize(ce,ce),new a.Ray(de,ce)}),ye=xt(u,1,p.zoom)*p._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:X,tilespaceRays:ge,bufferedTilespaceGeometry:F,bufferedTilespaceBounds:(ve=a.getBounds(F),ve.min.x=a.clamp(ve.min.x,0,a.EXTENT),ve.min.y=a.clamp(ve.min.y,0,a.EXTENT),ve.max.x=a.clamp(ve.max.x,0,a.EXTENT),ve.max.y=a.clamp(ve.max.y,0,a.EXTENT),ve),tile:u,tileID:u.tileID,pixelToTileUnitsFactor:ye};var ve}_bufferedScreenMercator(u,p){const w=Bt(u);if(this._screenRaycastCache[w])return this._screenRaycastCache[w];{let S;return S=p.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(u),p):{polygon:this.bufferedScreenGeometry(u).map(A=>p.pointCoordinate3D(A)),unwrapped:!0},this._screenRaycastCache[w]=S,S}}_bufferedCameraMercator(u,p){const w=Bt(u);if(this._cameraRaycastCache[w])return this._cameraRaycastCache[w];{let S;return S=p.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(u),p):{polygon:this.bufferedCameraGeometry(u).map(A=>p.pointCoordinate3D(A)),unwrapped:!0},this._cameraRaycastCache[w]=S,S}}_projectAndResample(u,p){const w=function(A,L){const B=a.multiply([],L.pixelMatrix,L.globeMatrix),F=[0,-a.GLOBE_RADIUS,0,1],Y=[0,a.GLOBE_RADIUS,0,1],X=[0,0,0,1];a.transformMat4$1(F,F,B),a.transformMat4$1(Y,Y,B),a.transformMat4$1(X,X,B);const ie=new a.pointGeometry(F[0]/F[3],F[1]/F[3]),de=new a.pointGeometry(Y[0]/Y[3],Y[1]/Y[3]),ge=a.polygonContainsPoint(A,ie)&&F[3]<X[3],ye=a.polygonContainsPoint(A,de)&&Y[3]<X[3];if(!ge&&!ye)return null;const ve=function(qe,Je,rt){for(let lt=1;lt<qe.length;lt++){const Jt=yt(Je.pointCoordinate3D(qe[lt-1]).x),et=yt(Je.pointCoordinate3D(qe[lt]).x);if(rt<0){if(Jt<et)return{idx:lt,t:-Jt/(et-1-Jt)}}else if(et<Jt)return{idx:lt,t:(1-Jt)/(et+1-Jt)}}return null}(A,L,ge?-1:1);if(!ve)return null;const{idx:xe,t:ce}=ve;let Se=xe>1?Et(A.slice(0,xe),L):[],Te=xe<A.length?Et(A.slice(xe),L):[];Se=Se.map(qe=>new a.pointGeometry(yt(qe.x),qe.y)),Te=Te.map(qe=>new a.pointGeometry(yt(qe.x),qe.y));const Ae=[...Se];Ae.length===0&&Ae.push(Te[Te.length-1]);const Fe=a.number(Ae[Ae.length-1].y,(Te.length===0?Se[0]:Te[0]).y,ce);let $e;return $e=ge?[new a.pointGeometry(0,Fe),new a.pointGeometry(0,0),new a.pointGeometry(1,0),new a.pointGeometry(1,Fe)]:[new a.pointGeometry(1,Fe),new a.pointGeometry(1,1),new a.pointGeometry(0,1),new a.pointGeometry(0,Fe)],Ae.push(...$e),Te.length===0?Ae.push(Se[0]):Ae.push(...Te),{polygon:Ae.map(qe=>new a.MercatorCoordinate(qe.x,qe.y)),unwrapped:!1}}(u,p);if(w)return w;const S=function(A,L){let B=!1,F=-1/0,Y=0;for(let ie=0;ie<A.length-1;ie++)A[ie].x>F&&(F=A[ie].x,Y=ie);for(let ie=0;ie<A.length-1;ie++){const de=(Y+ie)%(A.length-1),ge=A[de],ye=A[de+1];Math.abs(ge.x-ye.x)>.5&&(ge.x<ye.x?(ge.x+=1,de===0&&(A[A.length-1].x+=1)):(ye.x+=1,de+1===A.length-1&&(A[0].x+=1)),B=!0)}const X=a.mercatorXfromLng(L.center.lng);return B&&X<Math.abs(X-1)&&A.forEach(ie=>{ie.x-=1}),{polygon:A,unwrapped:B}}(Et(u,p).map(A=>new a.pointGeometry(yt(A.x),A.y)),p);return{polygon:S.polygon.map(A=>new a.MercatorCoordinate(A.x,A.y)),unwrapped:S.unwrapped}}}function Et(y,u){return a.resample(y,p=>{const w=u.pointCoordinate3D(p);p.x=w.x,p.y=w.y},1/256)}function yt(y){return y<0?1+y%1:y%1}function Bt(y){return 100*y|0}function _t(y,u,p,w,S){const A=function(L,B){if(L)return S(L);if(B){y.url&&B.tiles&&y.tiles&&delete y.tiles;const F=a.pick(a.extend(B,y),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);B.vector_layers&&(F.vectorLayers=B.vector_layers,F.vectorLayerIds=F.vectorLayers.map(Y=>Y.id)),F.tiles=u.canonicalizeTileset(F,y.url),S(null,F)}};return y.url?a.getJSON(u.transformRequest(u.normalizeSourceURL(y.url,null,p,w),a.ResourceType.Source),A):a.exported.frame(()=>A(null,y))}class si{constructor(u,p,w){this.bounds=a.LngLatBounds.convert(this.validateBounds(u)),this.minzoom=p||0,this.maxzoom=w||24}validateBounds(u){return Array.isArray(u)&&u.length===4?[Math.max(-180,u[0]),Math.max(-90,u[1]),Math.min(180,u[2]),Math.min(90,u[3])]:[-180,-90,180,90]}contains(u){const p=Math.pow(2,u.z),w=Math.floor(a.mercatorXfromLng(this.bounds.getWest())*p),S=Math.floor(a.mercatorYfromLat(this.bounds.getNorth())*p),A=Math.ceil(a.mercatorXfromLng(this.bounds.getEast())*p),L=Math.ceil(a.mercatorYfromLat(this.bounds.getSouth())*p);return u.x>=w&&u.x<A&&u.y>=S&&u.y<L}}class Li{constructor(u,p,w){this.context=u;const S=u.gl;this.buffer=S.createBuffer(),this.dynamicDraw=!!w,this.context.unbindVAO(),u.bindElementBuffer.set(this.buffer),S.bufferData(S.ELEMENT_ARRAY_BUFFER,p.arrayBuffer,this.dynamicDraw?S.DYNAMIC_DRAW:S.STATIC_DRAW),this.dynamicDraw||p.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(u){const p=this.context.gl;this.context.unbindVAO(),this.bind(),p.bufferSubData(p.ELEMENT_ARRAY_BUFFER,0,u.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const vi={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class ci{constructor(u,p,w,S){this.length=p.length,this.attributes=w,this.itemSize=p.bytesPerElement,this.dynamicDraw=S,this.context=u;const A=u.gl;this.buffer=A.createBuffer(),u.bindVertexBuffer.set(this.buffer),A.bufferData(A.ARRAY_BUFFER,p.arrayBuffer,this.dynamicDraw?A.DYNAMIC_DRAW:A.STATIC_DRAW),this.dynamicDraw||p.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(u){const p=this.context.gl;this.bind(),p.bufferSubData(p.ARRAY_BUFFER,0,u.arrayBuffer)}enableAttributes(u,p){for(let w=0;w<this.attributes.length;w++){const S=p.attributes[this.attributes[w].name];S!==void 0&&u.enableVertexAttribArray(S)}}setVertexAttribPointers(u,p,w){for(let S=0;S<this.attributes.length;S++){const A=this.attributes[S],L=p.attributes[A.name];L!==void 0&&u.vertexAttribPointer(L,A.components,u[vi[A.type]],!1,this.itemSize,A.offset+this.itemSize*(w||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class mt{constructor(u){this.gl=u.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(u){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class $t extends mt{getDefault(){return a.Color.transparent}set(u){const p=this.current;(u.r!==p.r||u.g!==p.g||u.b!==p.b||u.a!==p.a||this.dirty)&&(this.gl.clearColor(u.r,u.g,u.b,u.a),this.current=u,this.dirty=!1)}}class Mi extends mt{getDefault(){return 1}set(u){(u!==this.current||this.dirty)&&(this.gl.clearDepth(u),this.current=u,this.dirty=!1)}}class Di extends mt{getDefault(){return 0}set(u){(u!==this.current||this.dirty)&&(this.gl.clearStencil(u),this.current=u,this.dirty=!1)}}class Ci extends mt{getDefault(){return[!0,!0,!0,!0]}set(u){const p=this.current;(u[0]!==p[0]||u[1]!==p[1]||u[2]!==p[2]||u[3]!==p[3]||this.dirty)&&(this.gl.colorMask(u[0],u[1],u[2],u[3]),this.current=u,this.dirty=!1)}}class dt extends mt{getDefault(){return!0}set(u){(u!==this.current||this.dirty)&&(this.gl.depthMask(u),this.current=u,this.dirty=!1)}}class ei extends mt{getDefault(){return 255}set(u){(u!==this.current||this.dirty)&&(this.gl.stencilMask(u),this.current=u,this.dirty=!1)}}class ct extends mt{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(u){const p=this.current;(u.func!==p.func||u.ref!==p.ref||u.mask!==p.mask||this.dirty)&&(this.gl.stencilFunc(u.func,u.ref,u.mask),this.current=u,this.dirty=!1)}}class Ct extends mt{getDefault(){const u=this.gl;return[u.KEEP,u.KEEP,u.KEEP]}set(u){const p=this.current;(u[0]!==p[0]||u[1]!==p[1]||u[2]!==p[2]||this.dirty)&&(this.gl.stencilOp(u[0],u[1],u[2]),this.current=u,this.dirty=!1)}}class Be extends mt{getDefault(){return!1}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;u?p.enable(p.STENCIL_TEST):p.disable(p.STENCIL_TEST),this.current=u,this.dirty=!1}}class Xt extends mt{getDefault(){return[0,1]}set(u){const p=this.current;(u[0]!==p[0]||u[1]!==p[1]||this.dirty)&&(this.gl.depthRange(u[0],u[1]),this.current=u,this.dirty=!1)}}class ni extends mt{getDefault(){return!1}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;u?p.enable(p.DEPTH_TEST):p.disable(p.DEPTH_TEST),this.current=u,this.dirty=!1}}class Vt extends mt{getDefault(){return this.gl.LESS}set(u){(u!==this.current||this.dirty)&&(this.gl.depthFunc(u),this.current=u,this.dirty=!1)}}class Nt extends mt{getDefault(){return!1}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;u?p.enable(p.BLEND):p.disable(p.BLEND),this.current=u,this.dirty=!1}}class mi extends mt{getDefault(){const u=this.gl;return[u.ONE,u.ZERO]}set(u){const p=this.current;(u[0]!==p[0]||u[1]!==p[1]||this.dirty)&&(this.gl.blendFunc(u[0],u[1]),this.current=u,this.dirty=!1)}}class ii extends mt{getDefault(){return a.Color.transparent}set(u){const p=this.current;(u.r!==p.r||u.g!==p.g||u.b!==p.b||u.a!==p.a||this.dirty)&&(this.gl.blendColor(u.r,u.g,u.b,u.a),this.current=u,this.dirty=!1)}}class Ii extends mt{getDefault(){return this.gl.FUNC_ADD}set(u){(u!==this.current||this.dirty)&&(this.gl.blendEquation(u),this.current=u,this.dirty=!1)}}class $i extends mt{getDefault(){return!1}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;u?p.enable(p.CULL_FACE):p.disable(p.CULL_FACE),this.current=u,this.dirty=!1}}class Ri extends mt{getDefault(){return this.gl.BACK}set(u){(u!==this.current||this.dirty)&&(this.gl.cullFace(u),this.current=u,this.dirty=!1)}}class Ni extends mt{getDefault(){return this.gl.CCW}set(u){(u!==this.current||this.dirty)&&(this.gl.frontFace(u),this.current=u,this.dirty=!1)}}class zi extends mt{getDefault(){return null}set(u){(u!==this.current||this.dirty)&&(this.gl.useProgram(u),this.current=u,this.dirty=!1)}}class Ki extends mt{getDefault(){return this.gl.TEXTURE0}set(u){(u!==this.current||this.dirty)&&(this.gl.activeTexture(u),this.current=u,this.dirty=!1)}}class _r extends mt{getDefault(){const u=this.gl;return[0,0,u.drawingBufferWidth,u.drawingBufferHeight]}set(u){const p=this.current;(u[0]!==p[0]||u[1]!==p[1]||u[2]!==p[2]||u[3]!==p[3]||this.dirty)&&(this.gl.viewport(u[0],u[1],u[2],u[3]),this.current=u,this.dirty=!1)}}class cr extends mt{getDefault(){return null}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;p.bindFramebuffer(p.FRAMEBUFFER,u),this.current=u,this.dirty=!1}}class ur extends mt{getDefault(){return null}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;p.bindRenderbuffer(p.RENDERBUFFER,u),this.current=u,this.dirty=!1}}class Ur extends mt{getDefault(){return null}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;p.bindTexture(p.TEXTURE_2D,u),this.current=u,this.dirty=!1}}class nn extends mt{getDefault(){return null}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;p.bindBuffer(p.ARRAY_BUFFER,u),this.current=u,this.dirty=!1}}class Er extends mt{getDefault(){return null}set(u){const p=this.gl;p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,u),this.current=u,this.dirty=!1}}class Kr extends mt{constructor(u){super(u),this.vao=u.extVertexArrayObject}getDefault(){return null}set(u){this.vao&&(u!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(u),this.current=u,this.dirty=!1)}}class on extends mt{getDefault(){return 4}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;p.pixelStorei(p.UNPACK_ALIGNMENT,u),this.current=u,this.dirty=!1}}class an extends mt{getDefault(){return!1}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,u),this.current=u,this.dirty=!1}}class vt extends mt{getDefault(){return!1}set(u){if(u===this.current&&!this.dirty)return;const p=this.gl;p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,u),this.current=u,this.dirty=!1}}class _i extends mt{constructor(u,p){super(u),this.context=u,this.parent=p}getDefault(){return null}}class he extends _i{setDirty(){this.dirty=!0}set(u){if(u===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const p=this.gl;p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,u,0),this.current=u,this.dirty=!1}}class Oe extends _i{attachment(){return this.gl.DEPTH_ATTACHMENT}set(u){if(u===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const p=this.gl;p.framebufferRenderbuffer(p.FRAMEBUFFER,this.attachment(),p.RENDERBUFFER,u),this.current=u,this.dirty=!1}}class He extends Oe{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class Tt{constructor(u,p,w,S){this.context=u,this.width=p,this.height=w;const A=this.framebuffer=u.gl.createFramebuffer();this.colorAttachment=new he(u,A),S&&(this.depthAttachment=new Oe(u,A))}destroy(){const u=this.context.gl,p=this.colorAttachment.get();if(p&&u.deleteTexture(p),this.depthAttachment){const w=this.depthAttachment.get();w&&u.deleteRenderbuffer(w)}u.deleteFramebuffer(this.framebuffer)}}class le{constructor(u,p=!1){if(this.gl=u,this.isWebGL2=p,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),p){const w=u;this.extVertexArrayObject={createVertexArrayOES:w.createVertexArray.bind(u),deleteVertexArrayOES:w.deleteVertexArray.bind(u),bindVertexArrayOES:w.bindVertexArray.bind(u)}}this.clearColor=new $t(this),this.clearDepth=new Mi(this),this.clearStencil=new Di(this),this.colorMask=new Ci(this),this.depthMask=new dt(this),this.stencilMask=new ei(this),this.stencilFunc=new ct(this),this.stencilOp=new Ct(this),this.stencilTest=new Be(this),this.depthRange=new Xt(this),this.depthTest=new ni(this),this.depthFunc=new Vt(this),this.blend=new Nt(this),this.blendFunc=new mi(this),this.blendColor=new ii(this),this.blendEquation=new Ii(this),this.cullFace=new $i(this),this.cullFaceSide=new Ri(this),this.frontFace=new Ni(this),this.program=new zi(this),this.activeTexture=new Ki(this),this.viewport=new _r(this),this.bindFramebuffer=new cr(this),this.bindRenderbuffer=new ur(this),this.bindTexture=new Ur(this),this.bindVertexBuffer=new nn(this),this.bindElementBuffer=new Er(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new Kr(this),this.pixelStoreUnpack=new on(this),this.pixelStoreUnpackPremultiplyAlpha=new an(this),this.pixelStoreUnpackFlipY=new vt(this),this.extTextureFilterAnisotropic=u.getExtension("EXT_texture_filter_anisotropic")||u.getExtension("MOZ_EXT_texture_filter_anisotropic")||u.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=u.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extStandardDerivativesForceOff=!1,this.extDebugRendererInfo=u.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=u.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=u.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),p||(this.extTextureHalfFloat=u.getExtension("OES_texture_half_float")),(p||this.extTextureHalfFloat&&u.getExtension("OES_texture_half_float_linear"))&&(this.extRenderToTextureHalfFloat=u.getExtension("EXT_color_buffer_half_float")),this.extStandardDerivatives=p||u.getExtension("OES_standard_derivatives"),this.extTimerQuery=u.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=u.getParameter(u.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(u,p){return new Li(this,u,p)}createVertexBuffer(u,p,w){return new ci(this,u,p,w)}createRenderbuffer(u,p,w){const S=this.gl,A=S.createRenderbuffer();return this.bindRenderbuffer.set(A),S.renderbufferStorage(S.RENDERBUFFER,u,p,w),this.bindRenderbuffer.set(null),A}createFramebuffer(u,p,w){return new Tt(this,u,p,w)}clear({color:u,depth:p,stencil:w}){const S=this.gl;let A=0;u&&(A|=S.COLOR_BUFFER_BIT,this.clearColor.set(u),this.colorMask.set([!0,!0,!0,!0])),p!==void 0&&(A|=S.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(p),this.depthMask.set(!0)),w!==void 0&&(A|=S.STENCIL_BUFFER_BIT,this.clearStencil.set(w),this.stencilMask.set(255)),S.clear(A)}setCullFace(u){u.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(u.mode),this.frontFace.set(u.frontFace))}setDepthMode(u){u.func!==this.gl.ALWAYS||u.mask?(this.depthTest.set(!0),this.depthFunc.set(u.func),this.depthMask.set(u.mask),this.depthRange.set(u.range)):this.depthTest.set(!1)}setStencilMode(u){u.test.func!==this.gl.ALWAYS||u.mask?(this.stencilTest.set(!0),this.stencilMask.set(u.mask),this.stencilOp.set([u.fail,u.depthFail,u.pass]),this.stencilFunc.set({func:u.test.func,ref:u.ref,mask:u.test.mask})):this.stencilTest.set(!1)}setColorMode(u){b(u.blendFunction,a.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(u.blendFunction),this.blendColor.set(u.blendColor)),this.colorMask.set(u.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class Q extends a.Evented{constructor(u,p,w,S){if(super(),this.id=u,this.dispatcher=w,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,a.extend(this,a.pick(p,["url","scheme","tileSize","promoteId"])),this._options=a.extend({type:"vector"},p),this._collectResourceTiming=p.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(S),this._tileWorkers={},this._deduped=new a.DedupedRequest}load(u){this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"}));const p=Array.isArray(this.map._language)?this.map._language.join():this.map._language,w=this.map._worldview;this._tileJSONRequest=_t(this._options,this.map._requestManager,p,w,(S,A)=>{this._tileJSONRequest=null,this._loaded=!0,S?(p&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${p}`),w&&w.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${w}`),this.fire(new a.ErrorEvent(S))):A&&(a.extend(this,A),A.bounds&&(this.tileBounds=new si(A.bounds,this.minzoom,this.maxzoom)),a.postTurnstileEvent(A.tiles,this.map._requestManager._customAccessToken),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"}))),u&&u(S)})}loaded(){return this._loaded}hasTile(u){return!this.tileBounds||this.tileBounds.contains(u.canonical)}onAdd(u){this.map=u,this.load()}reload(){this.cancelTileJSONRequest(),this.load(()=>this.map.style._clearSource(this.id))}setTiles(u){return this._options.tiles=u,this.reload(),this}setUrl(u){return this.url=u,this._options.url=u,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return a.extend({},this._options)}loadTile(u,p){const w=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme)),S={request:this.map._requestManager.transformRequest(w,a.ResourceType.Tile),data:void 0,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,tileSize:this.tileSize*u.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:a.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:u.isSymbolTile};if(S.request.collectResourceTiming=this._collectResourceTiming,u.actor&&u.state!=="expired")u.state==="loading"?u.reloadCallback=p:u.request=u.actor.send("reloadTile",S,A.bind(this));else if(u.actor=this._tileWorkers[w]=this._tileWorkers[w]||this.dispatcher.getActor(),this.dispatcher.ready)u.request=u.actor.send("loadTile",S,A.bind(this),void 0,!0);else{const L=a.loadVectorTile.call({deduped:this._deduped},S,(B,F)=>{B||!F?A.call(this,B):(S.data={cacheControl:F.cacheControl,expires:F.expires,rawData:F.rawData.slice(0)},u.actor&&u.actor.send("loadTile",S,A.bind(this),void 0,!0))},!0);u.request={cancel:L}}function A(L,B){return delete u.request,u.aborted?p(null):L&&L.status!==404?p(L):(B&&B.resourceTiming&&(u.resourceTiming=B.resourceTiming),this.map._refreshExpiredTiles&&B&&u.setExpiryData(B),u.loadVectorData(B,this.map.painter),a.cacheEntryPossiblyAdded(this.dispatcher),p(null),void(u.reloadCallback&&(this.loadTile(u,u.reloadCallback),u.reloadCallback=null)))}}abortTile(u){u.request&&(u.request.cancel(),delete u.request),u.actor&&u.actor.send("abortTile",{uid:u.uid,type:this.type,source:this.id})}unloadTile(u){u.unloadVectorData(),u.actor&&u.actor.send("removeTile",{uid:u.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ne extends a.Evented{constructor(u,p,w,S){super(),this.id=u,this.dispatcher=w,this.setEventedParent(S),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=a.extend({type:"raster"},p),a.extend(this,a.pick(p,["url","scheme","tileSize"]))}load(u){this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=_t(this._options,this.map._requestManager,null,null,(p,w)=>{this._tileJSONRequest=null,this._loaded=!0,p?this.fire(new a.ErrorEvent(p)):w&&(a.extend(this,w),w.bounds&&(this.tileBounds=new si(w.bounds,this.minzoom,this.maxzoom)),a.postTurnstileEvent(w.tiles),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"}))),u&&u(p)})}loaded(){return this._loaded}onAdd(u){this.map=u,this.load()}reload(){this.cancelTileJSONRequest(),this.load(()=>this.map.style._clearSource(this.id))}setTiles(u){return this._options.tiles=u,this.reload(),this}setUrl(u){return this.url=u,this._options.url=u,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return a.extend({},this._options)}hasTile(u){return!this.tileBounds||this.tileBounds.contains(u.canonical)}loadTile(u,p){const w=a.exported.devicePixelRatio>=2,S=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme),w,this.tileSize);u.request=a.getImage(this.map._requestManager.transformRequest(S,a.ResourceType.Tile),(A,L,B,F)=>(delete u.request,u.aborted?(u.state="unloaded",p(null)):A?(u.state="errored",p(A)):L?(this.map._refreshExpiredTiles&&u.setExpiryData({cacheControl:B,expires:F}),u.setTexture(L,this.map.painter),u.state="loaded",a.cacheEntryPossiblyAdded(this.dispatcher),void p(null)):p(null)))}static loadTileData(u,p,w){u.setTexture(p,w)}static unloadTileData(u,p){u.texture&&p.saveTileTexture(u.texture)}abortTile(u,p){u.request&&(u.request.cancel(),delete u.request),p()}unloadTile(u,p){u.texture&&this.map.painter.saveTileTexture(u.texture),p()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}let me;function we(y,u,p,w,S,A,L,B){const F=[y,p,S,u,w,A,1,1,1],Y=[L,B,1],X=a.adjoint([],F),[ie,de,ge]=a.transformMat3(Y,Y,a.transpose(X,X));return a.multiply$1(F,[ie,0,0,0,de,0,0,0,ge],F)}class Pe extends a.Evented{constructor(u,p,w,S){super(),this.id=u,this.dispatcher=w,this.coordinates=p.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(S),this.options=p,this._dirty=!1}load(u,p){this._loaded=p||!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this.url=this.options.url,this._imageRequest=a.getImage(this.map._requestManager.transformRequest(this.url,a.ResourceType.Image),(w,S)=>{if(this._imageRequest=null,this._loaded=!0,w)this.fire(new a.ErrorEvent(w));else if(S){const{HTMLImageElement:A}=a.window;this.image=S instanceof A?a.exported.getImageData(S):S,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,u&&(this.coordinates=u),this._finishLoading()}})}loaded(){return this._loaded}updateImage(u){return this.image&&u.url?(this._imageRequest&&u.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=u.url,this.load(u.coordinates,this._loaded),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(u){this.map=u,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),this.texture&&this.texture.destroy()}setCoordinates(u){this.coordinates=u,this._boundsArray=void 0;const p=u.map(a.MercatorCoordinate.fromLngLat);return this.tileID=function(w){let S=1/0,A=1/0,L=-1/0,B=-1/0;for(const ie of w)S=Math.min(S,ie.x),A=Math.min(A,ie.y),L=Math.max(L,ie.x),B=Math.max(B,ie.y);const F=Math.max(L-S,B-A),Y=Math.max(0,Math.floor(-Math.log(F)/Math.LN2)),X=Math.pow(2,Y);return new a.CanonicalTileID(Y,Math.floor((S+L)/2*X),Math.floor((A+B)/2*X))}(p),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(u){for(const F in this.tiles){const Y=this.tiles[F];Y.state!=="loaded"&&(Y.state="loaded",Y.texture=this.texture)}if(this._boundsArray)return;const p=a.tileTransform(this.tileID,this.map.transform.projection),[w,S,A,L]=this.coordinates.map(F=>{const Y=p.projection.project(F[0],F[1]);return a.getTilePoint(p,Y)._round()});this.perspectiveTransform=function(F,Y,X,ie,de,ge,ye,ve,xe,ce){const Se=we(0,0,F,0,0,Y,F,Y),Te=we(X,ie,de,ge,ye,ve,xe,ce);return a.multiply$1(Te,a.adjoint(Se,Se),Te),[Te[6]/Te[8]*F/a.EXTENT,Te[7]/Te[8]*Y/a.EXTENT]}(this.width,this.height,w.x,w.y,S.x,S.y,L.x,L.y,A.x,A.y);const B=this._boundsArray=new a.StructArrayLayout4i8;B.emplaceBack(w.x,w.y,0,0),B.emplaceBack(S.x,S.y,a.EXTENT,0),B.emplaceBack(L.x,L.y,0,a.EXTENT),B.emplaceBack(A.x,A.y,a.EXTENT,a.EXTENT),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=u.createVertexBuffer(B,a.boundsAttributes.members),this.boundsSegments=a.SegmentVector.simpleSegment(0,0,4,2)}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const u=this.map.painter.context,p=u.gl;this._dirty&&(this.texture?this.texture.update(this.image):(this.texture=new a.Texture(u,this.image,p.RGBA),this.texture.bind(p.LINEAR,p.CLAMP_TO_EDGE)),this._dirty=!1),this._prepareData(u)}loadTile(u,p){this.tileID&&this.tileID.equals(u.tileID.canonical)?(this.tiles[String(u.tileID.wrap)]=u,u.buckets={},p(null)):(u.state="errored",p(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const Ye={vector:Q,raster:ne,"raster-dem":class extends ne{constructor(y,u,p,w){super(y,u,p,w),this.type="raster-dem",this.maxzoom=22,this._options=a.extend({type:"raster-dem"},u),this.encoding=u.encoding||"mapbox"}loadTile(y,u){const p=this.map._requestManager.normalizeTileURL(y.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function w(S,A){S&&(y.state="errored",u(S)),A&&(y.dem=A,y.dem.onDeserialize(),y.needsHillshadePrepare=!0,y.needsDEMTextureUpload=!0,y.state="loaded",u(null))}y.request=a.getImage(this.map._requestManager.transformRequest(p,a.ResourceType.Tile),function(S,A,L,B){if(delete y.request,y.aborted)y.state="unloaded",u(null);else if(S)y.state="errored",u(S);else if(A){this.map._refreshExpiredTiles&&y.setExpiryData({cacheControl:L,expires:B});const F=a.window.ImageBitmap&&A instanceof a.window.ImageBitmap&&(me==null&&(me=a.window.OffscreenCanvas&&new a.window.OffscreenCanvas(1,1).getContext("2d")&&typeof a.window.createImageBitmap=="function"),me),Y=1-(A.width-a.prevPowerOfTwo(A.width))/2;Y<1||y.neighboringTiles||(y.neighboringTiles=this._getNeighboringTiles(y.tileID));const X=F?A:a.exported.getImageData(A,Y),ie={uid:y.uid,coord:y.tileID,source:this.id,rawImageData:X,encoding:this.encoding,padding:Y};y.actor&&y.state!=="expired"||(y.actor=this.dispatcher.getActor(),y.actor.send("loadDEMTile",ie,w.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(y){const u=y.canonical,p=Math.pow(2,u.z),w=(u.x-1+p)%p,S=u.x===0?y.wrap-1:y.wrap,A=(u.x+1+p)%p,L=u.x+1===p?y.wrap+1:y.wrap,B={};return B[new a.OverscaledTileID(y.overscaledZ,S,u.z,w,u.y).key]={backfilled:!1},B[new a.OverscaledTileID(y.overscaledZ,L,u.z,A,u.y).key]={backfilled:!1},u.y>0&&(B[new a.OverscaledTileID(y.overscaledZ,S,u.z,w,u.y-1).key]={backfilled:!1},B[new a.OverscaledTileID(y.overscaledZ,y.wrap,u.z,u.x,u.y-1).key]={backfilled:!1},B[new a.OverscaledTileID(y.overscaledZ,L,u.z,A,u.y-1).key]={backfilled:!1}),u.y+1<p&&(B[new a.OverscaledTileID(y.overscaledZ,S,u.z,w,u.y+1).key]={backfilled:!1},B[new a.OverscaledTileID(y.overscaledZ,y.wrap,u.z,u.x,u.y+1).key]={backfilled:!1},B[new a.OverscaledTileID(y.overscaledZ,L,u.z,A,u.y+1).key]={backfilled:!1}),B}unloadTile(y){y.demTexture&&this.map.painter.saveTileTexture(y.demTexture),y.fbo&&(y.fbo.destroy(),delete y.fbo),y.dem&&delete y.dem,delete y.neighboringTiles,y.state="unloaded"}},geojson:class extends a.Evented{constructor(y,u,p,w){super(),this.id=y,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=p.getActor(),this.setEventedParent(w),this._data=u.data,this._options=a.extend({},u),this._collectResourceTiming=u.collectResourceTiming,u.maxzoom!==void 0&&(this.maxzoom=u.maxzoom),u.type&&(this.type=u.type),u.attribution&&(this.attribution=u.attribution),this.promoteId=u.promoteId;const S=a.EXTENT/this.tileSize;this.workerOptions=a.extend({source:this.id,cluster:u.cluster||!1,geojsonVtOptions:{buffer:(u.buffer!==void 0?u.buffer:128)*S,tolerance:(u.tolerance!==void 0?u.tolerance:.375)*S,extent:a.EXTENT,maxZoom:this.maxzoom,lineMetrics:u.lineMetrics||!1,generateId:u.generateId||!1},superclusterOptions:{maxZoom:u.clusterMaxZoom!==void 0?u.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,u.clusterMinPoints||2),extent:a.EXTENT,radius:(u.clusterRadius!==void 0?u.clusterRadius:50)*S,log:!1,generateId:u.generateId||!1},clusterProperties:u.clusterProperties,filter:u.filter},u.workerOptions)}onAdd(y){this.map=y,this.setData(this._data)}setData(y){return this._data=y,this._updateWorkerData(),this}getClusterExpansionZoom(y,u){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:y,source:this.id},u),this}getClusterChildren(y,u){return this.actor.send("geojson.getClusterChildren",{clusterId:y,source:this.id},u),this}getClusterLeaves(y,u,p,w){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:y,limit:u,offset:p},w),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new a.Event("dataloading",{dataType:"source"})),this._loaded=!1;const y=a.extend({},this.workerOptions),u=this._data;typeof u=="string"?(y.request=this.map._requestManager.transformRequest(a.exported.resolveURL(u),a.ResourceType.Source),y.request.collectResourceTiming=this._collectResourceTiming):y.data=JSON.stringify(u),this._pendingLoad=this.actor.send(`${this.type}.loadData`,y,(p,w)=>{if(this._loaded=!0,this._pendingLoad=null,p)this.fire(new a.ErrorEvent(p));else{const S={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&w&&w.resourceTiming&&w.resourceTiming[this.id]&&(S.resourceTiming=w.resourceTiming[this.id]),this.fire(new a.Event("data",S)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(y,u){const p=y.actor?"reloadTile":"loadTile";y.actor=this.actor,y.request=this.actor.send(p,{type:this.type,uid:y.uid,tileID:y.tileID,tileZoom:y.tileZoom,zoom:y.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:a.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(w,S)=>(delete y.request,y.unloadVectorData(),y.aborted?u(null):w?u(w):(y.loadVectorData(S,this.map.painter,p==="reloadTile"),u(null))),void 0,p==="loadTile")}abortTile(y){y.request&&(y.request.cancel(),delete y.request),y.aborted=!0}unloadTile(y){y.unloadVectorData(),this.actor.send("removeTile",{uid:y.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return a.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Pe{constructor(y,u,p,w){super(y,u,p,w),this.roundZoom=!0,this.type="video",this.options=u}load(){this._loaded=!1;const y=this.options;this.urls=[];for(const u of y.urls)this.urls.push(this.map._requestManager.transformRequest(u,a.ResourceType.Source).url);a.getVideo(this.urls,(u,p)=>{this._loaded=!0,u?this.fire(new a.ErrorEvent(u)):p&&(this.video=p,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(y){if(this.video){const u=this.video.seekable;y<u.start(0)||y>u.end(0)?this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${u.start(0)} and ${u.end(0)}-second mark.`))):this.video.currentTime=y}}getVideo(){return this.video}onAdd(y){this.map||(this.map=y,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const y=this.map.painter.context,u=y.gl;this.texture?this.video.paused||(this.texture.bind(u.LINEAR,u.CLAMP_TO_EDGE),u.texSubImage2D(u.TEXTURE_2D,0,0,0,u.RGBA,u.UNSIGNED_BYTE,this.video)):(this.texture=new a.Texture(y,this.video,u.RGBA),this.texture.bind(u.LINEAR,u.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(y)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Pe,canvas:class extends Pe{constructor(y,u,p,w){super(y,u,p,w),u.coordinates?Array.isArray(u.coordinates)&&u.coordinates.length===4&&!u.coordinates.some(S=>!Array.isArray(S)||S.length!==2||S.some(A=>typeof A!="number"))||this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${y}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${y}`,null,'missing required property "coordinates"'))),u.animate&&typeof u.animate!="boolean"&&this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${y}`,null,'optional "animate" property must be a boolean value'))),u.canvas?typeof u.canvas=="string"||u.canvas instanceof a.window.HTMLCanvasElement||this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${y}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new a.ErrorEvent(new a.ValidationError(`sources.${y}`,null,'missing required property "canvas"'))),this.options=u,this.animate=u.animate===void 0||u.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof a.window.HTMLCanvasElement?this.options.canvas:a.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new a.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(y){this.map=y,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let y=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,y=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,y=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const u=this.map.painter.context;this.texture?(y||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new a.Texture(u,this.canvas,u.gl.RGBA,{premultiply:!0}),this._prepareData(u)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const y of[this.canvas.width,this.canvas.height])if(isNaN(y)||y<=0)return!0;return!1}},custom:class extends a.Evented{constructor(y,u,p,w){super(),this.id=y,this.type="custom",this._dataType="raster",this._dispatcher=p,this._implementation=u,this.setEventedParent(w),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new a.ErrorEvent(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new a.ErrorEvent(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new si(this._implementation.bounds,this.minzoom,this.maxzoom)),u.update=this._update.bind(this),u.clearTiles=this._clearTiles.bind(this),u.coveringTiles=this._coveringTiles.bind(this),a.extend(this,a.pick(u,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return a.pick(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new a.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(y){this._map=y,this._loaded=!1,this.fire(new a.Event("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(y),this.load()}onRemove(y){this._implementation.onRemove&&this._implementation.onRemove(y)}hasTile(y){if(this._implementation.hasTile){const{x:u,y:p,z:w}=y.canonical;return this._implementation.hasTile({x:u,y:p,z:w})}return!this.tileBounds||this.tileBounds.contains(y.canonical)}loadTile(y,u){const{x:p,y:w,z:S}=y.tileID.canonical,A=new a.window.AbortController;y.request=Promise.resolve(this._implementation.loadTile({x:p,y:w,z:S},{signal:A.signal})).then(function(L){return delete y.request,y.aborted?(y.state="unloaded",u(null)):L===void 0?(y.state="errored",u(null)):L===null?(this.loadTileData(y,{width:this.tileSize,height:this.tileSize,data:null}),y.state="loaded",u(null)):function(B){return B instanceof a.window.ImageData||B instanceof a.window.HTMLCanvasElement||B instanceof a.window.ImageBitmap||B instanceof a.window.HTMLImageElement}(L)?(this.loadTileData(y,L),y.state="loaded",void u(null)):(y.state="errored",u(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch(L=>{L.code!==20&&(y.state="errored",u(L))}),y.request.cancel=()=>A.abort()}loadTileData(y,u){ne.loadTileData(y,u,this._map.painter)}unloadTileData(y){ne.unloadTileData(y,this._map.painter)}unloadTile(y,u){if(this.unloadTileData(y),this._implementation.unloadTile){const{x:p,y:w,z:S}=y.tileID.canonical;this._implementation.unloadTile({x:p,y:w,z:S})}u()}abortTile(y,u){y.request&&y.request.cancel&&(y.request.cancel(),delete y.request),u()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(y=>({x:y.canonical.x,y:y.canonical.y,z:y.canonical.z}))}_clearTiles(){this._map.style._clearSource(this.id)}_update(){this.fire(new a.Event("data",{dataType:"source",sourceDataType:"content"}))}}},Ue=function(y,u,p,w){const S=new Ye[u.type](y,u,p,w);if(S.id!==y)throw new Error(`Expected Source id to be ${y} instead of ${S.id}`);return a.bindAll(["load","abort","unload","serialize","prepare"],S),S};function Ne(y,u){const p=a.identity([]);return a.scale(p,p,[.5*y.width,.5*-y.height,1]),a.translate(p,p,[1,-1,0]),a.multiply(p,p,y.calculateProjMatrix(u.toUnwrapped())),Float32Array.from(p)}function Xe(y,u,p,w,S,A,L,B=!1){const F=y.tilesIn(w,L,B);F.sort(Ht);const Y=[];for(const ie of F)Y.push({wrappedTileID:ie.tile.tileID.wrapped().key,queryResults:ie.tile.queryRenderedFeatures(u,p,y._state,ie,S,A,Ne(y.transform,ie.tile.tileID),B)});const X=function(ie){const de={},ge={};for(const ye of ie){const ve=ye.queryResults,xe=ye.wrappedTileID,ce=ge[xe]=ge[xe]||{};for(const Se in ve){const Te=ve[Se],Ae=ce[Se]=ce[Se]||{},Fe=de[Se]=de[Se]||[];for(const $e of Te)Ae[$e.featureIndex]||(Ae[$e.featureIndex]=!0,Fe.push($e))}}return de}(Y);for(const ie in X)X[ie].forEach(de=>{const ge=de.feature,ye=ge.layer;ye&&ye.type!=="background"&&ye.type!=="sky"&&(ge.source=ye.source,ye["source-layer"]&&(ge.sourceLayer=ye["source-layer"]),ge.state=ge.id!==void 0?y.getFeatureState(ye["source-layer"],ge.id):{})});return X}function bt(y,u){const p=y.getRenderableIds().map(A=>y.getTileByID(A)),w=[],S={};for(let A=0;A<p.length;A++){const L=p[A],B=L.tileID.canonical.key;S[B]||(S[B]=!0,L.querySourceFeatures(w,u))}return w}function Ht(y,u){const p=y.tileID,w=u.tileID;return p.overscaledZ-w.overscaledZ||p.canonical.y-w.canonical.y||p.wrap-w.wrap||p.canonical.x-w.canonical.x}function Pt(){return Xs.workerClass!=null?new Xs.workerClass:new a.window.Worker(Xs.workerUrl)}const Ai="mapboxgl_preloaded_worker_pool";class xi{constructor(){this.active={}}acquire(u){if(!this.workers)for(this.workers=[];this.workers.length<xi.workerCount;)this.workers.push(new Pt);return this.active[u]=!0,this.workers.slice()}release(u){delete this.active[u],this.numActive()===0&&(this.workers.forEach(p=>{p.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Ai]}numActive(){return Object.keys(this.active).length}}let Ei;function Fi(){return Ei||(Ei=new xi),Ei}function Ce(y,u){const p={};for(const w in y)w!=="ref"&&(p[w]=y[w]);return a.refProperties.forEach(w=>{w in u&&(p[w]=u[w])}),p}function Yt(y){y=y.slice();const u=Object.create(null);for(let p=0;p<y.length;p++)u[y[p].id]=y[p];for(let p=0;p<y.length;p++)"ref"in y[p]&&(y[p]=Ce(y[p],u[y[p].ref]));return y}xi.workerCount=2;const At={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function ui(y,u,p){p.push({command:At.addSource,args:[y,u[y]]})}function Bi(y,u,p){u.push({command:At.removeSource,args:[y]}),p[y]=!0}function rr(y,u,p,w){Bi(y,p,w),ui(y,u,p)}function dr(y,u,p){let w;for(w in y[p])if(y[p].hasOwnProperty(w)&&w!=="data"&&!b(y[p][w],u[p][w]))return!1;for(w in u[p])if(u[p].hasOwnProperty(w)&&w!=="data"&&!b(y[p][w],u[p][w]))return!1;return!0}function ot(y,u,p,w,S,A){let L;for(L in u=u||{},y=y||{})y.hasOwnProperty(L)&&(b(y[L],u[L])||p.push({command:A,args:[w,L,u[L],S]}));for(L in u)u.hasOwnProperty(L)&&!y.hasOwnProperty(L)&&(b(y[L],u[L])||p.push({command:A,args:[w,L,u[L],S]}))}function Sn(y){return y.id}function Gr(y,u){return y[u.id]=u,y}class xo{constructor(u,p){this.reset(u,p)}reset(u,p){this.points=u||[],this._distances=[0];for(let w=1;w<this.points.length;w++)this._distances[w]=this._distances[w-1]+this.points[w].dist(this.points[w-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(p||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(u){if(this.points.length===1)return this.points[0];u=a.clamp(u,0,1);let p=1,w=this._distances[p];const S=u*this.paddedLength+this.padding;for(;w<S&&p<this._distances.length;)w=this._distances[++p];const A=p-1,L=this._distances[A],B=w-L,F=B>0?(S-L)/B:0;return this.points[A].mult(1-F).add(this.points[p].mult(F))}}class cl{constructor(u,p,w){const S=this.boxCells=[],A=this.circleCells=[];this.xCellCount=Math.ceil(u/w),this.yCellCount=Math.ceil(p/w);for(let L=0;L<this.xCellCount*this.yCellCount;L++)S.push([]),A.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=u,this.height=p,this.xScale=this.xCellCount/u,this.yScale=this.yCellCount/p,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(u,p,w,S,A){this._forEachCell(p,w,S,A,this._insertBoxCell,this.boxUid++),this.boxKeys.push(u),this.bboxes.push(p),this.bboxes.push(w),this.bboxes.push(S),this.bboxes.push(A)}insertCircle(u,p,w,S){this._forEachCell(p-S,w-S,p+S,w+S,this._insertCircleCell,this.circleUid++),this.circleKeys.push(u),this.circles.push(p),this.circles.push(w),this.circles.push(S)}_insertBoxCell(u,p,w,S,A,L){this.boxCells[A].push(L)}_insertCircleCell(u,p,w,S,A,L){this.circleCells[A].push(L)}_query(u,p,w,S,A,L){if(w<0||u>this.width||S<0||p>this.height)return!A&&[];const B=[];if(u<=0&&p<=0&&this.width<=w&&this.height<=S){if(A)return!0;for(let F=0;F<this.boxKeys.length;F++)B.push({key:this.boxKeys[F],x1:this.bboxes[4*F],y1:this.bboxes[4*F+1],x2:this.bboxes[4*F+2],y2:this.bboxes[4*F+3]});for(let F=0;F<this.circleKeys.length;F++){const Y=this.circles[3*F],X=this.circles[3*F+1],ie=this.circles[3*F+2];B.push({key:this.circleKeys[F],x1:Y-ie,y1:X-ie,x2:Y+ie,y2:X+ie})}return L?B.filter(L):B}return this._forEachCell(u,p,w,S,this._queryCell,B,{hitTest:A,seenUids:{box:{},circle:{}}},L),A?B.length>0:B}_queryCircle(u,p,w,S,A){const L=u-w,B=u+w,F=p-w,Y=p+w;if(B<0||L>this.width||Y<0||F>this.height)return!S&&[];const X=[];return this._forEachCell(L,F,B,Y,this._queryCellCircle,X,{hitTest:S,circle:{x:u,y:p,radius:w},seenUids:{box:{},circle:{}}},A),S?X.length>0:X}query(u,p,w,S,A){return this._query(u,p,w,S,!1,A)}hitTest(u,p,w,S,A){return this._query(u,p,w,S,!0,A)}hitTestCircle(u,p,w,S){return this._queryCircle(u,p,w,!0,S)}_queryCell(u,p,w,S,A,L,B,F){const Y=B.seenUids,X=this.boxCells[A];if(X!==null){const de=this.bboxes;for(const ge of X)if(!Y.box[ge]){Y.box[ge]=!0;const ye=4*ge;if(u<=de[ye+2]&&p<=de[ye+3]&&w>=de[ye+0]&&S>=de[ye+1]&&(!F||F(this.boxKeys[ge]))){if(B.hitTest)return L.push(!0),!0;L.push({key:this.boxKeys[ge],x1:de[ye],y1:de[ye+1],x2:de[ye+2],y2:de[ye+3]})}}}const ie=this.circleCells[A];if(ie!==null){const de=this.circles;for(const ge of ie)if(!Y.circle[ge]){Y.circle[ge]=!0;const ye=3*ge;if(this._circleAndRectCollide(de[ye],de[ye+1],de[ye+2],u,p,w,S)&&(!F||F(this.circleKeys[ge]))){if(B.hitTest)return L.push(!0),!0;{const ve=de[ye],xe=de[ye+1],ce=de[ye+2];L.push({key:this.circleKeys[ge],x1:ve-ce,y1:xe-ce,x2:ve+ce,y2:xe+ce})}}}}}_queryCellCircle(u,p,w,S,A,L,B,F){const Y=B.circle,X=B.seenUids,ie=this.boxCells[A];if(ie!==null){const ge=this.bboxes;for(const ye of ie)if(!X.box[ye]){X.box[ye]=!0;const ve=4*ye;if(this._circleAndRectCollide(Y.x,Y.y,Y.radius,ge[ve+0],ge[ve+1],ge[ve+2],ge[ve+3])&&(!F||F(this.boxKeys[ye])))return L.push(!0),!0}}const de=this.circleCells[A];if(de!==null){const ge=this.circles;for(const ye of de)if(!X.circle[ye]){X.circle[ye]=!0;const ve=3*ye;if(this._circlesCollide(ge[ve],ge[ve+1],ge[ve+2],Y.x,Y.y,Y.radius)&&(!F||F(this.circleKeys[ye])))return L.push(!0),!0}}}_forEachCell(u,p,w,S,A,L,B,F){const Y=this._convertToXCellCoord(u),X=this._convertToYCellCoord(p),ie=this._convertToXCellCoord(w),de=this._convertToYCellCoord(S);for(let ge=Y;ge<=ie;ge++)for(let ye=X;ye<=de;ye++)if(A.call(this,u,p,w,S,this.xCellCount*ye+ge,L,B,F))return}_convertToXCellCoord(u){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(u*this.xScale)))}_convertToYCellCoord(u){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(u*this.yScale)))}_circlesCollide(u,p,w,S,A,L){const B=S-u,F=A-p,Y=w+L;return Y*Y>B*B+F*F}_circleAndRectCollide(u,p,w,S,A,L,B){const F=(L-S)/2,Y=Math.abs(u-(S+F));if(Y>F+w)return!1;const X=(B-A)/2,ie=Math.abs(p-(A+X));if(ie>X+w)return!1;if(Y<=F||ie<=X)return!0;const de=Y-F,ge=ie-X;return de*de+ge*ge<=w*w}}const Zn=Math.tan(85*Math.PI/180);function lo(y,u,p,w,S,A,L){const B=a.create();if(p)if(A.name==="globe"){const F=a.calculateGlobeLabelMatrix(S,u);a.multiply(B,B,F)}else{const F=ae([],L);B[0]=F[0],B[1]=F[1],B[4]=F[2],B[5]=F[3],w||a.rotateZ(B,B,S.angle)}else a.multiply(B,S.labelPlaneMatrix,y);return B}function ul(y,u,p,w,S,A,L){const B=lo(y,u,p,w,S,A,L);return A.name==="globe"&&p||(B[2]=B[6]=B[10]=B[14]=0),B}function Do(y,u,p,w,S,A,L){if(p){if(A.name==="globe"){const B=lo(y,u,p,w,S,A,L);return a.invert(B,B),a.multiply(B,y,B),B}{const B=a.clone(y),F=a.identity([]);return F[0]=L[0],F[1]=L[1],F[4]=L[2],F[5]=L[3],a.multiply(B,B,F),w||a.rotateZ(B,B,-S.angle),B}}return S.glCoordMatrix}function ri(y,u,p,w){const S=[y,u,p,1];p?a.transformMat4$1(S,S,w):Wt(S,S,w);const A=S[3];return S[0]/=A,S[1]/=A,S[2]/=A,S}function nr(y,u){return Math.min(.5+y/u*.5,1.5)}function tr(y,u){const p=y[0]/y[3],w=y[1]/y[3];return p>=-u[0]&&p<=u[0]&&w>=-u[1]&&w<=u[1]}function $n(y,u,p,w,S,A,L,B,F,Y){const X=p.transform,ie=w?y.textSizeData:y.iconSizeData,de=a.evaluateSizeForZoom(ie,p.transform.zoom),ge=X.projection.name==="globe",ye=[256/p.width*2+1,256/p.height*2+1],ve=w?y.text.dynamicLayoutVertexArray:y.icon.dynamicLayoutVertexArray;ve.clear();let xe=null;ge&&(xe=w?y.text.globeExtVertexArray:y.icon.globeExtVertexArray);const ce=y.lineVertexArray,Se=w?y.text.placedSymbolArray:y.icon.placedSymbolArray,Te=p.transform.width/p.transform.height;let Ae,Fe=!1;for(let $e=0;$e<Se.length;$e++){const qe=Se.get($e),{numGlyphs:Je,writingMode:rt}=qe;if(rt!==a.WritingMode.vertical||Fe||Ae===a.WritingMode.horizontal||(Fe=!0),Ae=rt,(qe.hidden||rt===a.WritingMode.vertical)&&!Fe){Ze(Je,ve);continue}Fe=!1;const lt=new a.pointGeometry(qe.tileAnchorX,qe.tileAnchorY);let{x:Jt,y:et,z:Dt}=X.projection.projectTilePoint(lt.x,lt.y,Y.canonical);if(F){const[er,Si,yi]=F(lt);Jt+=er,et+=Si,Dt+=yi}const gt=[Jt,et,Dt,1];if(a.transformMat4$1(gt,gt,u),!tr(gt,ye)){Ze(Je,ve);continue}const zt=nr(p.transform.cameraToCenterDistance,gt[3]),at=a.evaluateSizeForFeature(ie,de,qe),Ke=L?at/zt:at*zt,ut=ri(Jt,et,Dt,S);if(ut[3]<=0){Ze(Je,ve);continue}let Lt={};const jt=L?null:F,Pi=ue(qe,Ke,!1,B,u,S,A,y.glyphOffsetArray,ce,ve,xe,ut,lt,Lt,Te,jt,X.projection,Y,L);Fe=Pi.useVertical,jt&&Pi.needsFlipping&&(Lt={}),(Pi.notEnoughRoom||Fe||Pi.needsFlipping&&ue(qe,Ke,!0,B,u,S,A,y.glyphOffsetArray,ce,ve,xe,ut,lt,Lt,Te,jt,X.projection,Y,L).notEnoughRoom)&&Ze(Je,ve)}w?(y.text.dynamicLayoutVertexBuffer.updateData(ve),xe&&y.text.globeExtVertexBuffer.updateData(xe)):(y.icon.dynamicLayoutVertexBuffer.updateData(ve),xe&&y.icon.globeExtVertexBuffer.updateData(xe))}function $(y,u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve){const{lineStartIndex:xe,glyphStartIndex:ce,segment:Se}=B,Te=ce+B.numGlyphs,Ae=xe+B.lineLength,Fe=u.getoffsetX(ce),$e=u.getoffsetX(Te-1),qe=je(y*Fe,p,w,S,A,L,Se,xe,Ae,F,Y,X,ie,de,!0,ge,ye,ve);if(!qe)return null;const Je=je(y*$e,p,w,S,A,L,Se,xe,Ae,F,Y,X,ie,de,!0,ge,ye,ve);return Je?{first:qe,last:Je}:null}function V(y,u,p,w){return y===a.WritingMode.horizontal&&Math.abs(w)>Math.abs(p)?{useVertical:!0}:y===a.WritingMode.vertical?w>0?{needsFlipping:!0}:null:u!==0&&function(S,A){return S===0||Math.abs(A/S)>Zn}(p,w)?u===1?{needsFlipping:!0}:null:p<0?{needsFlipping:!0}:null}function ue(y,u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve,xe,ce,Se){const Te=u/24,Ae=y.lineOffsetX*Te,Fe=y.lineOffsetY*Te,{lineStartIndex:$e,glyphStartIndex:qe,numGlyphs:Je,segment:rt,writingMode:lt,flipState:Jt}=y,et=$e+y.lineLength,Dt=gt=>{if(X){const[ut,Lt,jt]=gt.up,Pi=Y.length;a.updateGlobeVertexNormal(X,Pi+0,ut,Lt,jt),a.updateGlobeVertexNormal(X,Pi+1,ut,Lt,jt),a.updateGlobeVertexNormal(X,Pi+2,ut,Lt,jt),a.updateGlobeVertexNormal(X,Pi+3,ut,Lt,jt)}const[zt,at,Ke]=gt.point;a.addDynamicAttributes(Y,zt,at,Ke,gt.angle)};if(Je>1){const gt=$(Te,B,Ae,Fe,p,ie,de,y,F,A,ge,ve,!1,xe,ce,Se);if(!gt)return{notEnoughRoom:!0};if(w&&!p){let[zt,at,Ke]=gt.first.point,[ut,Lt,jt]=gt.last.point;[zt,at]=ri(zt,at,Ke,L),[ut,Lt]=ri(ut,Lt,jt,L);const Pi=V(lt,Jt,(ut-zt)*ye,Lt-at);if(y.flipState=Pi&&Pi.needsFlipping?1:2,Pi)return Pi}Dt(gt.first);for(let zt=qe+1;zt<qe+Je-1;zt++){const at=je(Te*B.getoffsetX(zt),Ae,Fe,p,ie,de,rt,$e,et,F,A,ge,ve,!1,!1,xe,ce,Se);if(!at)return Y.length-=4*(zt-qe),{notEnoughRoom:!0};Dt(at)}Dt(gt.last)}else{if(w&&!p){const zt=ri(de.x,de.y,0,S),at=$e+rt+1,Ke=new a.pointGeometry(F.getx(at),F.gety(at)),ut=ri(Ke.x,Ke.y,0,S),Lt=ut[3]>0?ut:Ve(de,Ke,zt,1,S,void 0,xe,ce.canonical),jt=V(lt,Jt,(Lt[0]-zt[0])*ye,Lt[1]-zt[1]);if(y.flipState=jt&&jt.needsFlipping?1:2,jt)return jt}const gt=je(Te*B.getoffsetX(qe),Ae,Fe,p,ie,de,rt,$e,et,F,A,ge,ve,!1,!1,xe,ce,Se);if(!gt)return{notEnoughRoom:!0};Dt(gt)}return{}}function ke(y,u,p,w,S){const{x:A,y:L,z:B}=w.projectTilePoint(y.x,y.y,u);if(!S)return ri(A,L,B,p);const[F,Y,X]=S(y);return ri(A+F,L+Y,B+X,p)}function Ve(y,u,p,w,S,A,L,B){const F=ke(y.sub(u)._unit()._add(y),B,S,L,A);return a.sub(F,p,F),a.normalize(F,F),a.scaleAndAdd(F,p,F,w)}function je(y,u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve,xe,ce){const Se=w?y-u:y+u;let Te=Se>0?1:-1,Ae=0;w&&(Te*=-1,Ae=Math.PI),Te<0&&(Ae+=Math.PI);let Fe=B+L+(Te>0?0:1)|0,$e=S,qe=S,Je=0,rt=0;const lt=Math.abs(Se),Jt=[],et=[];let Dt=A,gt=Dt;const zt=()=>Ve(gt,Dt,qe,lt-Je+1,X,de,ve,xe.canonical);for(;Je+rt<=lt;){if(Fe+=Te,Fe<B||Fe>=F)return null;if(qe=$e,gt=Dt,Jt.push(qe),ge&&et.push(gt),Dt=new a.pointGeometry(Y.getx(Fe),Y.gety(Fe)),$e=ie[Fe],!$e){const yi=ke(Dt,xe.canonical,X,ve,de);$e=yi[3]>0?ie[Fe]=yi:zt()}Je+=rt,rt=a.distance(qe,$e)}ye&&de&&(ie[Fe]&&($e=zt(),rt=a.distance(qe,$e)),ie[Fe]=$e);const at=(lt-Je)/rt,Ke=Dt.sub(gt)._mult(at)._add(gt),ut=a.sub([],$e,qe),Lt=a.scaleAndAdd([],qe,ut,at);let jt=[0,0,1],Pi=ut[0],er=ut[1];if(ce&&(jt=ve.upVector(xe.canonical,Ke.x,Ke.y),jt[0]!==0||jt[1]!==0||jt[2]!==1)){const yi=[jt[2],0,-jt[0]],Oi=a.cross([],jt,yi);a.normalize(yi,yi),a.normalize(Oi,Oi),Pi=a.dot(ut,yi),er=a.dot(ut,Oi)}if(p){const yi=a.cross([],jt,ut);a.normalize(yi,yi),a.scaleAndAdd(Lt,Lt,yi,p*Te)}const Si=Ae+Math.atan2(er,Pi);return Jt.push(Lt),ge&&et.push(Ke),{point:Lt,angle:Si,path:Jt,tilePath:et,up:jt}}function Ze(y,u){const p=u.length,w=p+4*y;u.resize(w),u.float32.fill(-1/0,4*p,4*w)}function Wt(y,u,p){const w=u[0],S=u[1];return y[0]=p[0]*w+p[4]*S+p[12],y[1]=p[1]*w+p[5]*S+p[13],y[3]=p[3]*w+p[7]*S+p[15],y}const Kt=100;class bi{constructor(u,p,w=new cl(u.width+200,u.height+200,25),S=new cl(u.width+200,u.height+200,25)){this.transform=u,this.grid=w,this.ignoredGrid=S,this.pitchfactor=Math.cos(u._pitch)*u.cameraToCenterDistance,this.screenRightBoundary=u.width+Kt,this.screenBottomBoundary=u.height+Kt,this.gridRightBoundary=u.width+200,this.gridBottomBoundary=u.height+200,this.fogState=p}placeCollisionBox(u,p,w,S,A,L,B,F){let Y=w.projectedAnchorX,X=w.projectedAnchorY,ie=w.projectedAnchorZ;const de=w.elevation,ge=w.tileID,ye=u.getProjection();if(de&&ge){const[$e,qe,Je]=ye.upVector(ge.canonical,w.tileAnchorX,w.tileAnchorY),rt=ye.upVectorScale(ge.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;Y+=$e*de*rt,X+=qe*de*rt,ie+=Je*de*rt}const ve=this.projectAndGetPerspectiveRatio(B,Y,X,ie,w.tileID,ye.name==="globe"||!!de||this.transform.pitch>0,ye),xe=L*ve.perspectiveRatio,ce=(w.x1*p+S.x-w.padding)*xe+ve.point.x,Se=(w.y1*p+S.y-w.padding)*xe+ve.point.y,Te=(w.x2*p+S.x+w.padding)*xe+ve.point.x,Ae=(w.y2*p+S.y+w.padding)*xe+ve.point.y,Fe=ve.perspectiveRatio<=.55||ve.occluded;return!this.isInsideGrid(ce,Se,Te,Ae)||!A&&this.grid.hitTest(ce,Se,Te,Ae,F)||Fe?{box:[],offscreen:!1,occluded:ve.occluded}:{box:[ce,Se,Te,Ae],offscreen:this.isOffscreen(ce,Se,Te,Ae),occluded:!1}}placeCollisionCircles(u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve){const xe=[],ce=this.transform.elevation,Se=u.getProjection(),Te=ce?ce.getAtTileOffsetFunc(ve,this.transform.center.lat,this.transform.worldSize,Se):null,Ae=new a.pointGeometry(w.tileAnchorX,w.tileAnchorY);let{x:Fe,y:$e,z:qe}=Se.projectTilePoint(Ae.x,Ae.y,ve.canonical);if(Te){const[Ke,ut,Lt]=Te(Ae);Fe+=Ke,$e+=ut,qe+=Lt}const Je=Se.name==="globe",rt=this.projectAndGetPerspectiveRatio(B,Fe,$e,qe,ve,Je||!!ce||this.transform.pitch>0,Se),{perspectiveRatio:lt}=rt,Jt=(ie?L/lt:L*lt)/a.ONE_EM,et=ri(Fe,$e,qe,F),Dt=rt.signedDistanceFromCamera>0?$(Jt,A,w.lineOffsetX*Jt,w.lineOffsetY*Jt,!1,et,Ae,w,S,F,{},ce&&!ie?Te:null,ie&&!!ce,Se,ve,ie):null;let gt=!1,zt=!1,at=!0;if(Dt&&!rt.occluded){const Ke=.5*ge*lt+ye,ut=new a.pointGeometry(-100,-100),Lt=new a.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),jt=new xo,{first:Pi,last:er}=Dt,Si=Pi.path.length;let yi=[];for(let Ui=Si-1;Ui>=1;Ui--)yi.push(Pi.path[Ui]);for(let Ui=1;Ui<er.path.length;Ui++)yi.push(er.path[Ui]);const Oi=2.5*Ke;Y&&(yi=yi.map(([Ui,yr,vr],Dr)=>(Te&&!Je&&(vr=Te(Dr<Si-1?Pi.tilePath[Si-1-Dr]:er.tilePath[Dr-Si+2])[2]),ri(Ui,yr,vr,Y))),yi.some(Ui=>Ui[3]<=0)&&(yi=[]));let ar=[];if(yi.length>0){let Ui=1/0,yr=-1/0,vr=1/0,Dr=-1/0;for(const Ar of yi)Ui=Math.min(Ui,Ar[0]),vr=Math.min(vr,Ar[1]),yr=Math.max(yr,Ar[0]),Dr=Math.max(Dr,Ar[1]);yr>=ut.x&&Ui<=Lt.x&&Dr>=ut.y&&vr<=Lt.y&&(ar=[yi.map(Ar=>new a.pointGeometry(Ar[0],Ar[1]))],(Ui<ut.x||yr>Lt.x||vr<ut.y||Dr>Lt.y)&&(ar=a.clipLine(ar,ut.x,ut.y,Lt.x,Lt.y)))}for(const Ui of ar){jt.reset(Ui,.25*Ke);let yr=0;yr=jt.length<=.5*Ke?1:Math.ceil(jt.paddedLength/Oi)+1;for(let vr=0;vr<yr;vr++){const Dr=vr/Math.max(yr-1,1),Ar=jt.lerp(Dr),sn=Ar.x+Kt,Un=Ar.y+Kt;xe.push(sn,Un,Ke,0);const go=sn-Ke,Go=Un-Ke,Fr=sn+Ke,Cr=Un+Ke;if(at=at&&this.isOffscreen(go,Go,Fr,Cr),zt=zt||this.isInsideGrid(go,Go,Fr,Cr),!p&&this.grid.hitTestCircle(sn,Un,Ke,de)&&(gt=!0,!X))return{circles:[],offscreen:!1,collisionDetected:gt,occluded:!1}}}}return{circles:!X&&gt||!zt?[]:xe,offscreen:at,collisionDetected:gt,occluded:rt.occluded}}queryRenderedSymbols(u){if(u.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const p=[];let w=1/0,S=1/0,A=-1/0,L=-1/0;for(const X of u){const ie=new a.pointGeometry(X.x+Kt,X.y+Kt);w=Math.min(w,ie.x),S=Math.min(S,ie.y),A=Math.max(A,ie.x),L=Math.max(L,ie.y),p.push(ie)}const B=this.grid.query(w,S,A,L).concat(this.ignoredGrid.query(w,S,A,L)),F={},Y={};for(const X of B){const ie=X.key;if(F[ie.bucketInstanceId]===void 0&&(F[ie.bucketInstanceId]={}),F[ie.bucketInstanceId][ie.featureIndex])continue;const de=[new a.pointGeometry(X.x1,X.y1),new a.pointGeometry(X.x2,X.y1),new a.pointGeometry(X.x2,X.y2),new a.pointGeometry(X.x1,X.y2)];a.polygonIntersectsPolygon(p,de)&&(F[ie.bucketInstanceId][ie.featureIndex]=!0,Y[ie.bucketInstanceId]===void 0&&(Y[ie.bucketInstanceId]=[]),Y[ie.bucketInstanceId].push(ie.featureIndex))}return Y}insertCollisionBox(u,p,w,S,A){(p?this.ignoredGrid:this.grid).insert({bucketInstanceId:w,featureIndex:S,collisionGroupID:A},u[0],u[1],u[2],u[3])}insertCollisionCircles(u,p,w,S,A){const L=p?this.ignoredGrid:this.grid,B={bucketInstanceId:w,featureIndex:S,collisionGroupID:A};for(let F=0;F<u.length;F+=4)L.insertCircle(B,u[F],u[F+1],u[F+2])}projectAndGetPerspectiveRatio(u,p,w,S,A,L,B){const F=[p,w,S,1];let Y=!1;if(S||this.transform.pitch>0){a.transformMat4$1(F,F,u);const ie=B.name==="globe";this.fogState&&A&&!ie&&(Y=function(ge,ye,ve,xe,ce,Se){const Te=Se.calculateFogTileMatrix(ce),Ae=[ye,ve,xe];return a.transformMat4(Ae,Ae,Te),Ut(ge,Ae,Se.pitch,Se._fov)}(this.fogState,p,w,S,A.toUnwrapped(),this.transform)>.9)}else Wt(F,F,u);const X=F[3];return{point:new a.pointGeometry((F[0]/X+1)/2*this.transform.width+Kt,(-F[1]/X+1)/2*this.transform.height+Kt),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(B)/X*.5,1.5),signedDistanceFromCamera:X,occluded:L&&F[2]>X||Y}}isOffscreen(u,p,w,S){return w<Kt||u>=this.screenRightBoundary||S<Kt||p>this.screenBottomBoundary}isInsideGrid(u,p,w,S){return w>=0&&u<this.gridRightBoundary&&S>=0&&p<this.gridBottomBoundary}getViewportMatrix(){const u=a.identity([]);return a.translate(u,u,[-100,-100,0]),u}}function di(y,u,p){const w=u.createTileMatrix(y,y.worldSize,p.toUnwrapped());return a.multiply(new Float32Array(16),y.projMatrix,w)}function hi(y,u,p){if(u.projection.name===p.projection.name)return y.projMatrix;const w=p.clone();return w.setProjection(u.projection),di(w,u.getProjection(),y)}function Hi(y,u,p){return u.name===p.projection.name?y.projMatrix:di(p,u,y)}class Ir{constructor(u,p,w,S){this.opacity=u?Math.max(0,Math.min(1,u.opacity+(u.placed?p:-p))):S&&w?1:0,this.placed=w}isHidden(){return this.opacity===0&&!this.placed}}class Xi{constructor(u,p,w,S,A,L=!1){this.text=new Ir(u?u.text:null,p,w,A),this.icon=new Ir(u?u.icon:null,p,S,A),this.clipped=L}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class zr{constructor(u,p,w,S=!1){this.text=u,this.icon=p,this.skipFade=w,this.clipped=S}}class Ot{constructor(){this.invProjMatrix=a.create(),this.viewportMatrix=a.create(),this.circles=[]}}class wi{constructor(u,p,w,S,A){this.bucketInstanceId=u,this.featureIndex=p,this.sourceLayerIndex=w,this.bucketIndex=S,this.tileID=A}}class Yi{constructor(u){this.crossSourceCollisions=u,this.maxGroupID=0,this.collisionGroups={}}get(u){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[u]){const p=++this.maxGroupID;this.collisionGroups[u]={ID:p,predicate:w=>w.collisionGroupID===p}}return this.collisionGroups[u]}}function Zr(y,u,p,w,S){const{horizontalAlign:A,verticalAlign:L}=a.getAnchorAlignment(y),B=-(A-.5)*u,F=-(L-.5)*p,Y=a.evaluateVariableOffset(y,w);return new a.pointGeometry(B+Y[0]*S,F+Y[1]*S)}function Vr(y,u,p,w,S){const A=new a.pointGeometry(y,u);return p&&A._rotate(w?S:-S),A}class mn{constructor(u,p,w,S,A){this.transform=u.clone(),this.projection=u.projection.name,this.collisionIndex=new bi(this.transform,A),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=p,this.retainedQueryData={},this.collisionGroups=new Yi(w),this.collisionCircleArrays={},this.prevPlacement=S,S&&(S.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(u,p,w,S){const A=w.getBucket(p),L=w.latestFeatureIndex;if(!A||!L||p.id!==A.layerIds[0])return;const B=A.layers[0].layout,F=w.collisionBoxArray,Y=Math.pow(2,this.transform.zoom-w.tileID.overscaledZ),X=w.tileSize/a.EXTENT,ie=w.tileID.toUnwrapped();this.transform.setProjection(A.projection);const de=(ge=w.tileID,ye=A.getProjection(),ve=this.transform,ye.name===this.projection?ve.calculateProjMatrix(ge.toUnwrapped()):di(ve,ye,ge));var ge,ye,ve;const xe=B.get("text-pitch-alignment")==="map",ce=B.get("text-rotation-alignment")==="map";p.compileFilter();const Se=p.dynamicFilter(),Te=p.dynamicFilterNeedsFeature(),Ae=this.transform.calculatePixelsToTileUnitsMatrix(w),Fe=ul(de,w.tileID.canonical,xe,ce,this.transform,A.getProjection(),Ae);let $e=null;if(xe){const rt=Do(de,w.tileID.canonical,xe,ce,this.transform,A.getProjection(),Ae);$e=a.multiply([],this.transform.labelPlaneMatrix,rt)}let qe=null;Se&&w.latestFeatureIndex&&(qe={unwrappedTileID:ie,dynamicFilter:Se,dynamicFilterNeedsFeature:Te,featureIndex:w.latestFeatureIndex}),this.retainedQueryData[A.bucketInstanceId]=new wi(A.bucketInstanceId,L,A.sourceLayerIndex,A.index,w.tileID);const Je={bucket:A,layout:B,posMatrix:de,textLabelPlaneMatrix:Fe,labelToScreenMatrix:$e,clippingData:qe,scale:Y,textPixelRatio:X,holdingForFade:w.holdingForFade(),collisionBoxArray:F,partiallyEvaluatedTextSize:a.evaluateSizeForZoom(A.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:a.evaluateSizeForZoom(A.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(A.sourceID)};if(S)for(const rt of A.sortKeyRanges){const{sortKey:lt,symbolInstanceStart:Jt,symbolInstanceEnd:et}=rt;u.push({sortKey:lt,symbolInstanceStart:Jt,symbolInstanceEnd:et,parameters:Je})}else u.push({symbolInstanceStart:0,symbolInstanceEnd:A.symbolInstances.length,parameters:Je})}attemptAnchorPlacement(u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve,xe,ce,Se){const{textOffset0:Te,textOffset1:Ae,crossTileID:Fe}=de,$e=[Te,Ae],qe=Zr(u,w,S,$e,A),Je=this.collisionIndex.placeCollisionBox(ye,A,p,Vr(qe.x,qe.y,L,B,this.transform.angle),ie,F,Y,X.predicate);if(xe){const rt=ye.getSymbolInstanceIconSize(Se,this.transform.zoom,de.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(ye,rt,xe,Vr(qe.x,qe.y,L,B,this.transform.angle),ie,F,Y,X.predicate).box.length===0)return}if(Je.box.length>0){let rt;return this.prevPlacement&&this.prevPlacement.variableOffsets[Fe]&&this.prevPlacement.placements[Fe]&&this.prevPlacement.placements[Fe].text&&(rt=this.prevPlacement.variableOffsets[Fe].anchor),this.variableOffsets[Fe]={textOffset:$e,width:w,height:S,anchor:u,textScale:A,prevAnchor:rt},this.markUsedJustification(ye,u,de,ve),ye.allowVerticalPlacement&&(this.markUsedOrientation(ye,ve,de),this.placedOrientations[Fe]=ve),{shift:qe,placedGlyphBoxes:Je}}}placeLayerBucketPart(u,p,w,S){const{bucket:A,layout:L,posMatrix:B,textLabelPlaneMatrix:F,labelToScreenMatrix:Y,clippingData:X,textPixelRatio:ie,holdingForFade:de,collisionBoxArray:ge,partiallyEvaluatedTextSize:ye,partiallyEvaluatedIconSize:ve,collisionGroup:xe}=u.parameters,ce=L.get("text-optional"),Se=L.get("icon-optional"),Te=L.get("text-allow-overlap"),Ae=L.get("icon-allow-overlap"),Fe=L.get("text-rotation-alignment")==="map",$e=L.get("text-pitch-alignment")==="map",qe=L.get("icon-text-fit")!=="none",Je=L.get("symbol-z-order")==="viewport-y";this.transform.setProjection(A.projection);let rt=Te&&(Ae||!A.hasIconData()||Se),lt=Ae&&(Te||!A.hasTextData()||ce);!A.collisionArrays&&ge&&A.deserializeCollisionBoxes(ge),w&&S&&A.updateCollisionDebugBuffers(this.transform.zoom,ge);const Jt=(et,Dt,gt)=>{const{crossTileID:zt,numVerticalGlyphVertices:at}=et;if(X){const Fr={zoom:this.transform.zoom,pitch:this.transform.pitch};let Cr=null;if(X.dynamicFilterNeedsFeature){const mr=this.retainedQueryData[A.bucketInstanceId];Cr=X.featureIndex.loadFeature({featureIndex:et.featureIndex,bucketIndex:mr.bucketIndex,sourceLayerIndex:mr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,X.dynamicFilter)(Fr,Cr,this.retainedQueryData[A.bucketInstanceId].tileID.canonical,new a.pointGeometry(et.tileAnchorX,et.tileAnchorY),this.transform.calculateDistanceTileData(X.unwrappedTileID)))return this.placements[zt]=new zr(!1,!1,!1,!0),void(p[zt]=!0)}if(p[zt])return;if(de)return void(this.placements[zt]=new zr(!1,!1,!1));let Ke=!1,ut=!1,Lt=!0,jt=!1,Pi=!1,er=null,Si={box:null,offscreen:null,occluded:null},yi={box:null,offscreen:null,occluded:null},Oi=null,ar=null,Ui=null,yr=0,vr=0,Dr=0;gt.textFeatureIndex?yr=gt.textFeatureIndex:et.useRuntimeCollisionCircles&&(yr=et.featureIndex),gt.verticalTextFeatureIndex&&(vr=gt.verticalTextFeatureIndex);const Ar=Fr=>{Fr.tileID=this.retainedQueryData[A.bucketInstanceId].tileID;const Cr=this.transform.elevation;(Cr||Fr.elevation)&&(Fr.elevation=Cr?Cr.getAtTileOffset(Fr.tileID,Fr.tileAnchorX,Fr.tileAnchorY):0)},sn=gt.textBox;if(sn){Ar(sn);const Fr=mr=>{let Yr=a.WritingMode.horizontal;if(A.allowVerticalPlacement&&!mr&&this.prevPlacement){const In=this.prevPlacement.placedOrientations[zt];In&&(this.placedOrientations[zt]=In,Yr=In,this.markUsedOrientation(A,Yr,et))}return Yr},Cr=(mr,Yr)=>{if(A.allowVerticalPlacement&&at>0&&gt.verticalTextBox){for(const In of A.writingModes)if(In===a.WritingMode.vertical?(Si=Yr(),yi=Si):Si=mr(),Si&&Si.box&&Si.box.length)break}else Si=mr()};if(L.get("text-variable-anchor")){let mr=L.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[zt]){const $r=this.prevPlacement.variableOffsets[zt];mr.indexOf($r.anchor)>0&&(mr=mr.filter(kn=>kn!==$r.anchor),mr.unshift($r.anchor))}const Yr=($r,kn,Dn)=>{const ua=A.getSymbolInstanceTextSize(ye,et,this.transform.zoom,Dt),gs=($r.x2-$r.x1)*ua+2*$r.padding,Kn=($r.y2-$r.y1)*ua+2*$r.padding,ro=qe&&!Ae?kn:null;ro&&Ar(ro);let Zo={box:[],offscreen:!1,occluded:!1};const ha=Te?2*mr.length:mr.length;for(let da=0;da<ha;++da){const _s=this.attemptAnchorPlacement(mr[da%mr.length],$r,gs,Kn,ua,Fe,$e,ie,B,xe,da>=mr.length,et,Dt,A,Dn,ro,ye,ve);if(_s&&(Zo=_s.placedGlyphBoxes,Zo&&Zo.box&&Zo.box.length)){Ke=!0,er=_s.shift;break}}return Zo};Cr(()=>Yr(sn,gt.iconBox,a.WritingMode.horizontal),()=>{const $r=gt.verticalTextBox;return $r&&Ar($r),A.allowVerticalPlacement&&!(Si&&Si.box&&Si.box.length)&&at>0&&$r?Yr($r,gt.verticalIconBox,a.WritingMode.vertical):{box:null,offscreen:null,occluded:null}}),Si&&(Ke=Si.box,Lt=Si.offscreen,jt=Si.occluded);const In=Fr(Si&&Si.box);if(!Ke&&this.prevPlacement){const $r=this.prevPlacement.variableOffsets[zt];$r&&(this.variableOffsets[zt]=$r,this.markUsedJustification(A,$r.anchor,et,In))}}else{const mr=(Yr,In)=>{const $r=A.getSymbolInstanceTextSize(ye,et,this.transform.zoom,Dt),kn=this.collisionIndex.placeCollisionBox(A,$r,Yr,new a.pointGeometry(0,0),Te,ie,B,xe.predicate);return kn&&kn.box&&kn.box.length&&(this.markUsedOrientation(A,In,et),this.placedOrientations[zt]=In),kn};Cr(()=>mr(sn,a.WritingMode.horizontal),()=>{const Yr=gt.verticalTextBox;return A.allowVerticalPlacement&&at>0&&Yr?(Ar(Yr),mr(Yr,a.WritingMode.vertical)):{box:null,offscreen:null,occluded:null}}),Fr(Si&&Si.box&&Si.box.length)}}if(Oi=Si,Ke=Oi&&Oi.box&&Oi.box.length>0,Lt=Oi&&Oi.offscreen,jt=Oi&&Oi.occluded,et.useRuntimeCollisionCircles){const Fr=A.text.placedSymbolArray.get(et.centerJustifiedTextSymbolIndex>=0?et.centerJustifiedTextSymbolIndex:et.verticalPlacedTextSymbolIndex),Cr=a.evaluateSizeForFeature(A.textSizeData,ye,Fr),mr=L.get("text-padding");ar=this.collisionIndex.placeCollisionCircles(A,Te,Fr,A.lineVertexArray,A.glyphOffsetArray,Cr,B,F,Y,w,$e,xe.predicate,et.collisionCircleDiameter*Cr/a.ONE_EM,mr,this.retainedQueryData[A.bucketInstanceId].tileID),Ke=Te||ar.circles.length>0&&!ar.collisionDetected,Lt=Lt&&ar.offscreen,jt=ar.occluded}if(gt.iconFeatureIndex&&(Dr=gt.iconFeatureIndex),gt.iconBox){const Fr=Cr=>{Ar(Cr);const mr=qe&&er?Vr(er.x,er.y,Fe,$e,this.transform.angle):new a.pointGeometry(0,0),Yr=A.getSymbolInstanceIconSize(ve,this.transform.zoom,et.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(A,Yr,Cr,mr,Ae,ie,B,xe.predicate)};yi&&yi.box&&yi.box.length&&gt.verticalIconBox?(Ui=Fr(gt.verticalIconBox),ut=Ui.box.length>0):(Ui=Fr(gt.iconBox),ut=Ui.box.length>0),Lt=Lt&&Ui.offscreen,Pi=Ui.occluded}const Un=ce||et.numHorizontalGlyphVertices===0&&at===0,go=Se||et.numIconVertices===0;if(Un||go?go?Un||(ut=ut&&Ke):Ke=ut&&Ke:ut=Ke=ut&&Ke,Ke&&Oi&&Oi.box&&this.collisionIndex.insertCollisionBox(Oi.box,L.get("text-ignore-placement"),A.bucketInstanceId,yi&&yi.box&&vr?vr:yr,xe.ID),ut&&Ui&&this.collisionIndex.insertCollisionBox(Ui.box,L.get("icon-ignore-placement"),A.bucketInstanceId,Dr,xe.ID),ar&&(Ke&&this.collisionIndex.insertCollisionCircles(ar.circles,L.get("text-ignore-placement"),A.bucketInstanceId,yr,xe.ID),w)){const Fr=A.bucketInstanceId;let Cr=this.collisionCircleArrays[Fr];Cr===void 0&&(Cr=this.collisionCircleArrays[Fr]=new Ot);for(let mr=0;mr<ar.circles.length;mr+=4)Cr.circles.push(ar.circles[mr+0]),Cr.circles.push(ar.circles[mr+1]),Cr.circles.push(ar.circles[mr+2]),Cr.circles.push(ar.collisionDetected?1:0)}const Go=A.projection.name!=="globe";rt=rt&&(Go||!jt),lt=lt&&(Go||!Pi),this.placements[zt]=new zr(Ke||rt,ut||lt,Lt||A.justReloaded),p[zt]=!0};if(Je){const et=A.getSortedSymbolIndexes(this.transform.angle);for(let Dt=et.length-1;Dt>=0;--Dt){const gt=et[Dt];Jt(A.symbolInstances.get(gt),gt,A.collisionArrays[gt])}}else for(let et=u.symbolInstanceStart;et<u.symbolInstanceEnd;et++)Jt(A.symbolInstances.get(et),et,A.collisionArrays[et]);if(w&&A.bucketInstanceId in this.collisionCircleArrays){const et=this.collisionCircleArrays[A.bucketInstanceId];a.invert(et.invProjMatrix,B),et.viewportMatrix=this.collisionIndex.getViewportMatrix()}A.justReloaded=!1}markUsedJustification(u,p,w,S){const{leftJustifiedTextSymbolIndex:A,centerJustifiedTextSymbolIndex:L,rightJustifiedTextSymbolIndex:B,verticalPlacedTextSymbolIndex:F,crossTileID:Y}=w,X=a.getAnchorJustification(p),ie=S===a.WritingMode.vertical?F:X==="left"?A:X==="center"?L:X==="right"?B:-1;A>=0&&(u.text.placedSymbolArray.get(A).crossTileID=ie>=0&&A!==ie?0:Y),L>=0&&(u.text.placedSymbolArray.get(L).crossTileID=ie>=0&&L!==ie?0:Y),B>=0&&(u.text.placedSymbolArray.get(B).crossTileID=ie>=0&&B!==ie?0:Y),F>=0&&(u.text.placedSymbolArray.get(F).crossTileID=ie>=0&&F!==ie?0:Y)}markUsedOrientation(u,p,w){const S=p===a.WritingMode.horizontal||p===a.WritingMode.horizontalOnly?p:0,A=p===a.WritingMode.vertical?p:0,{leftJustifiedTextSymbolIndex:L,centerJustifiedTextSymbolIndex:B,rightJustifiedTextSymbolIndex:F,verticalPlacedTextSymbolIndex:Y}=w,X=u.text.placedSymbolArray;L>=0&&(X.get(L).placedOrientation=S),B>=0&&(X.get(B).placedOrientation=S),F>=0&&(X.get(F).placedOrientation=S),Y>=0&&(X.get(Y).placedOrientation=A)}commit(u){this.commitTime=u,this.zoomAtLastRecencyCheck=this.transform.zoom;const p=this.prevPlacement;let w=!1;this.prevZoomAdjustment=p?p.zoomAdjustment(this.transform.zoom):0;const S=p?p.symbolFadeChange(u):1,A=p?p.opacities:{},L=p?p.variableOffsets:{},B=p?p.placedOrientations:{};for(const F in this.placements){const Y=this.placements[F],X=A[F];X?(this.opacities[F]=new Xi(X,S,Y.text,Y.icon,null,Y.clipped),w=w||Y.text!==X.text.placed||Y.icon!==X.icon.placed):(this.opacities[F]=new Xi(null,S,Y.text,Y.icon,Y.skipFade,Y.clipped),w=w||Y.text||Y.icon)}for(const F in A){const Y=A[F];if(!this.opacities[F]){const X=new Xi(Y,S,!1,!1);X.isHidden()||(this.opacities[F]=X,w=w||Y.text.placed||Y.icon.placed)}}for(const F in L)this.variableOffsets[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.variableOffsets[F]=L[F]);for(const F in B)this.placedOrientations[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.placedOrientations[F]=B[F]);w?this.lastPlacementChangeTime=u:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=p?p.lastPlacementChangeTime:u)}updateLayerOpacities(u,p){const w={};for(const S of p){const A=S.getBucket(u);A&&S.latestFeatureIndex&&u.id===A.layerIds[0]&&this.updateBucketOpacities(A,w,S.collisionBoxArray)}}updateBucketOpacities(u,p,w){u.hasTextData()&&u.text.opacityVertexArray.clear(),u.hasIconData()&&u.icon.opacityVertexArray.clear(),u.hasIconCollisionBoxData()&&u.iconCollisionBox.collisionVertexArray.clear(),u.hasTextCollisionBoxData()&&u.textCollisionBox.collisionVertexArray.clear();const S=u.layers[0].layout,A=!!u.layers[0].dynamicFilter(),L=new Xi(null,0,!1,!1,!0),B=S.get("text-allow-overlap"),F=S.get("icon-allow-overlap"),Y=S.get("text-variable-anchor"),X=S.get("text-rotation-alignment")==="map",ie=S.get("text-pitch-alignment")==="map",de=S.get("icon-text-fit")!=="none",ge=new Xi(null,0,B&&(F||!u.hasIconData()||S.get("icon-optional")),F&&(B||!u.hasTextData()||S.get("text-optional")),!0);!u.collisionArrays&&w&&(u.hasIconCollisionBoxData()||u.hasTextCollisionBoxData())&&u.deserializeCollisionBoxes(w);const ye=(xe,ce,Se)=>{for(let Te=0;Te<ce/4;Te++)xe.opacityVertexArray.emplaceBack(Se)};let ve=0;for(let xe=0;xe<u.symbolInstances.length;xe++){const ce=u.symbolInstances.get(xe),{numHorizontalGlyphVertices:Se,numVerticalGlyphVertices:Te,crossTileID:Ae,numIconVertices:Fe}=ce;let $e=this.opacities[Ae];p[Ae]?$e=L:$e||($e=ge,this.opacities[Ae]=$e),p[Ae]=!0;const qe=Se>0||Te>0,Je=Fe>0,rt=this.placedOrientations[Ae],lt=rt===a.WritingMode.vertical,Jt=rt===a.WritingMode.horizontal||rt===a.WritingMode.horizontalOnly;if(!qe&&!Je||$e.isHidden()||ve++,qe){const et=ea($e.text);ye(u.text,Se,lt?Ro:et),ye(u.text,Te,Jt?Ro:et);const Dt=$e.text.isHidden(),{leftJustifiedTextSymbolIndex:gt,centerJustifiedTextSymbolIndex:zt,rightJustifiedTextSymbolIndex:at,verticalPlacedTextSymbolIndex:Ke}=ce,ut=u.text.placedSymbolArray,Lt=Dt||lt?1:0;gt>=0&&(ut.get(gt).hidden=Lt),zt>=0&&(ut.get(zt).hidden=Lt),at>=0&&(ut.get(at).hidden=Lt),Ke>=0&&(ut.get(Ke).hidden=Dt||Jt?1:0);const jt=this.variableOffsets[Ae];jt&&this.markUsedJustification(u,jt.anchor,ce,rt);const Pi=this.placedOrientations[Ae];Pi&&(this.markUsedJustification(u,"left",ce,Pi),this.markUsedOrientation(u,Pi,ce))}if(Je){const et=ea($e.icon),{placedIconSymbolIndex:Dt,verticalPlacedIconSymbolIndex:gt}=ce,zt=u.icon.placedSymbolArray,at=$e.icon.isHidden()?1:0;Dt>=0&&(ye(u.icon,Fe,lt?Ro:et),zt.get(Dt).hidden=at),gt>=0&&(ye(u.icon,ce.numVerticalIconVertices,Jt?Ro:et),zt.get(gt).hidden=at)}if(u.hasIconCollisionBoxData()||u.hasTextCollisionBoxData()){const et=u.collisionArrays[xe];if(et){let Dt=new a.pointGeometry(0,0),gt=!0;if(et.textBox||et.verticalTextBox){if(Y){const at=this.variableOffsets[Ae];at?(Dt=Zr(at.anchor,at.width,at.height,at.textOffset,at.textScale),X&&Dt._rotate(ie?this.transform.angle:-this.transform.angle)):gt=!1}A&&(gt=!$e.clipped),et.textBox&&yn(u.textCollisionBox.collisionVertexArray,$e.text.placed,!gt||lt,Dt.x,Dt.y),et.verticalTextBox&&yn(u.textCollisionBox.collisionVertexArray,$e.text.placed,!gt||Jt,Dt.x,Dt.y)}const zt=gt&&!!(!Jt&&et.verticalIconBox);et.iconBox&&yn(u.iconCollisionBox.collisionVertexArray,$e.icon.placed,zt,de?Dt.x:0,de?Dt.y:0),et.verticalIconBox&&yn(u.iconCollisionBox.collisionVertexArray,$e.icon.placed,!zt,de?Dt.x:0,de?Dt.y:0)}}}if(u.fullyClipped=ve===0,u.sortFeatures(this.transform.angle),this.retainedQueryData[u.bucketInstanceId]&&(this.retainedQueryData[u.bucketInstanceId].featureSortOrder=u.featureSortOrder),u.hasTextData()&&u.text.opacityVertexBuffer&&u.text.opacityVertexBuffer.updateData(u.text.opacityVertexArray),u.hasIconData()&&u.icon.opacityVertexBuffer&&u.icon.opacityVertexBuffer.updateData(u.icon.opacityVertexArray),u.hasIconCollisionBoxData()&&u.iconCollisionBox.collisionVertexBuffer&&u.iconCollisionBox.collisionVertexBuffer.updateData(u.iconCollisionBox.collisionVertexArray),u.hasTextCollisionBoxData()&&u.textCollisionBox.collisionVertexBuffer&&u.textCollisionBox.collisionVertexBuffer.updateData(u.textCollisionBox.collisionVertexArray),u.bucketInstanceId in this.collisionCircleArrays){const xe=this.collisionCircleArrays[u.bucketInstanceId];u.placementInvProjMatrix=xe.invProjMatrix,u.placementViewportMatrix=xe.viewportMatrix,u.collisionCircleArray=xe.circles,delete this.collisionCircleArrays[u.bucketInstanceId]}}symbolFadeChange(u){return this.fadeDuration===0?1:(u-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(u){return Math.max(0,(this.transform.zoom-u)/1.5)}hasTransitions(u){return this.stale||u-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(u,p){const w=this.zoomAtLastRecencyCheck===p?1-this.zoomAdjustment(p):1;return this.zoomAtLastRecencyCheck=p,this.commitTime+this.fadeDuration*w>u}setStale(){this.stale=!0}}function yn(y,u,p,w,S){y.emplaceBack(u?1:0,p?1:0,w||0,S||0),y.emplaceBack(u?1:0,p?1:0,w||0,S||0),y.emplaceBack(u?1:0,p?1:0,w||0,S||0),y.emplaceBack(u?1:0,p?1:0,w||0,S||0)}const Lr=Math.pow(2,25),wa=Math.pow(2,24),Qr=Math.pow(2,17),Bn=Math.pow(2,16),Ya=Math.pow(2,9),Jo=Math.pow(2,8),hn=Math.pow(2,1);function ea(y){if(y.opacity===0&&!y.placed)return 0;if(y.opacity===1&&y.placed)return 4294967295;const u=y.placed?1:0,p=Math.floor(127*y.opacity);return p*Lr+u*wa+p*Qr+u*Bn+p*Ya+u*Jo+p*hn+u}const Ro=0;class Qn{constructor(u){this._sortAcrossTiles=u.layout.get("symbol-z-order")!=="viewport-y"&&u.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(u,p,w,S,A){const L=this._bucketParts;for(;this._currentTileIndex<u.length;)if(p.getBucketParts(L,S,u[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,A())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,L.sort((B,F)=>B.sortKey-F.sortKey));this._currentPartIndex<L.length;){const B=L[this._currentPartIndex];if(p.placeLayerBucketPart(B,this._seenCrossTileIDs,w,B.symbolInstanceStart===0),this._currentPartIndex++,A())return!0}return!1}}class Ea{constructor(u,p,w,S,A,L,B,F){this.placement=new mn(u,A,L,B,F),this._currentPlacementIndex=p.length-1,this._forceFullPlacement=w,this._showCollisionBoxes=S,this._done=!1}isDone(){return this._done}continuePlacement(u,p,w){const S=a.exported.now(),A=()=>{const L=a.exported.now()-S;return!this._forceFullPlacement&&L>2};for(;this._currentPlacementIndex>=0;){const L=p[u[this._currentPlacementIndex]],B=this.placement.collisionIndex.transform.zoom;if(L.type==="symbol"&&(!L.minzoom||L.minzoom<=B)&&(!L.maxzoom||L.maxzoom>B)){if(this._inProgressLayer||(this._inProgressLayer=new Qn(L)),this._inProgressLayer.continuePlacement(w[L.source],this.placement,this._showCollisionBoxes,L,A))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(u){return this.placement.commit(u),this.placement}}const Wa=512/a.EXTENT/2;class Yl{constructor(u,p,w){this.tileID=u,this.indexedSymbolInstances={},this.bucketInstanceId=w;for(let S=0;S<p.length;S++){const A=p.get(S),L=A.key;this.indexedSymbolInstances[L]||(this.indexedSymbolInstances[L]=[]),this.indexedSymbolInstances[L].push({crossTileID:A.crossTileID,coord:this.getScaledCoordinates(A,u)})}}getScaledCoordinates(u,p){const w=Wa/Math.pow(2,p.canonical.z-this.tileID.canonical.z);return{x:Math.floor((p.canonical.x*a.EXTENT+u.tileAnchorX)*w),y:Math.floor((p.canonical.y*a.EXTENT+u.tileAnchorY)*w)}}findMatches(u,p,w){const S=this.tileID.canonical.z<p.canonical.z?1:Math.pow(2,this.tileID.canonical.z-p.canonical.z);for(let A=0;A<u.length;A++){const L=u.get(A);if(L.crossTileID)continue;const B=this.indexedSymbolInstances[L.key];if(!B)continue;const F=this.getScaledCoordinates(L,p);for(const Y of B)if(Math.abs(Y.coord.x-F.x)<=S&&Math.abs(Y.coord.y-F.y)<=S&&!w[Y.crossTileID]){w[Y.crossTileID]=!0,L.crossTileID=Y.crossTileID;break}}}}class Ka{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Po{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(u){const p=Math.round((u-this.lng)/360);if(p!==0)for(const w in this.indexes){const S=this.indexes[w],A={};for(const L in S){const B=S[L];B.tileID=B.tileID.unwrapTo(B.tileID.wrap+p),A[B.tileID.key]=B}this.indexes[w]=A}this.lng=u}addBucket(u,p,w){if(this.indexes[u.overscaledZ]&&this.indexes[u.overscaledZ][u.key]){if(this.indexes[u.overscaledZ][u.key].bucketInstanceId===p.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(u.overscaledZ,this.indexes[u.overscaledZ][u.key])}for(let A=0;A<p.symbolInstances.length;A++)p.symbolInstances.get(A).crossTileID=0;this.usedCrossTileIDs[u.overscaledZ]||(this.usedCrossTileIDs[u.overscaledZ]={});const S=this.usedCrossTileIDs[u.overscaledZ];for(const A in this.indexes){const L=this.indexes[A];if(Number(A)>u.overscaledZ)for(const B in L){const F=L[B];F.tileID.isChildOf(u)&&F.findMatches(p.symbolInstances,u,S)}else{const B=L[u.scaledTo(Number(A)).key];B&&B.findMatches(p.symbolInstances,u,S)}}for(let A=0;A<p.symbolInstances.length;A++){const L=p.symbolInstances.get(A);L.crossTileID||(L.crossTileID=w.generate(),S[L.crossTileID]=!0)}return this.indexes[u.overscaledZ]===void 0&&(this.indexes[u.overscaledZ]={}),this.indexes[u.overscaledZ][u.key]=new Yl(u,p.symbolInstances,p.bucketInstanceId),!0}removeBucketCrossTileIDs(u,p){for(const w in p.indexedSymbolInstances)for(const S of p.indexedSymbolInstances[w])delete this.usedCrossTileIDs[u][S.crossTileID]}removeStaleBuckets(u){let p=!1;for(const w in this.indexes){const S=this.indexes[w];for(const A in S)u[S[A].bucketInstanceId]||(this.removeBucketCrossTileIDs(w,S[A]),delete S[A],p=!0)}return p}}class Cs{constructor(){this.layerIndexes={},this.crossTileIDs=new Ka,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(u,p,w,S){let A=this.layerIndexes[u.id];A===void 0&&(A=this.layerIndexes[u.id]=new Po);let L=!1;const B={};S.name!=="globe"&&A.handleWrapJump(w);for(const F of p){const Y=F.getBucket(u);Y&&u.id===Y.layerIds[0]&&(Y.bucketInstanceId||(Y.bucketInstanceId=++this.maxBucketInstanceId),A.addBucket(F.tileID,Y,this.crossTileIDs)&&(L=!0),B[Y.bucketInstanceId]=!0)}return A.removeStaleBuckets(B)&&(L=!0),L}pruneUnusedLayers(u){const p={};u.forEach(w=>{p[w]=!0});for(const w in this.layerIndexes)p[w]||delete this.layerIndexes[w]}}const Ta=(y,u)=>a.emitValidationErrors(y,u&&u.filter(p=>p.identifier!=="source.canvas")),ta=a.pick(At,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Hn=a.pick(At,["setCenter","setZoom","setBearing","setPitch"]),ia={version:8,layers:[],sources:{}},co={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class Hr extends a.Evented{constructor(u,p={}){super(),this.map=u,this.dispatcher=new ht(Fi(),this),this.imageManager=new se,this.imageManager.setEventedParent(this),this.glyphManager=new a.GlyphManager(u._requestManager,p.localFontFamily?a.LocalGlyphMode.all:p.localIdeographFontFamily?a.LocalGlyphMode.ideographs:a.LocalGlyphMode.none,p.localFontFamily||p.localIdeographFontFamily),this.crossTileSymbolIndex=new Cs,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",a.getReferrer());const w=this;this._rtlTextPluginCallback=Hr.registerForPluginStateChange(S=>{w.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:S.pluginStatus,pluginURL:S.pluginURL},(A,L)=>{if(a.triggerPluginCompletionEvent(A),L&&L.every(B=>B))for(const B in w._sourceCaches){const F=w._sourceCaches[B],Y=F.getSource().type;Y!=="vector"&&Y!=="geojson"||F.reload()}})}),this.on("data",S=>{if(S.dataType!=="source"||S.sourceDataType!=="metadata")return;const A=this.getSource(S.sourceId);if(A&&A.vectorLayerIds)for(const L in this._layers){const B=this._layers[L];B.source===A.id&&this._validateLayer(B)}})}loadURL(u,p={}){this.fire(new a.Event("dataloading",{dataType:"style"}));const w=typeof p.validate=="boolean"?p.validate:!a.isMapboxURL(u);u=this.map._requestManager.normalizeStyleURL(u,p.accessToken);const S=this.map._requestManager.transformRequest(u,a.ResourceType.Style);this._request=a.getJSON(S,(A,L)=>{this._request=null,A?this.fire(new a.ErrorEvent(A)):L&&this._load(L,w)})}loadJSON(u,p={}){this.fire(new a.Event("dataloading",{dataType:"style"})),this._request=a.exported.frame(()=>{this._request=null,this._load(u,p.validate!==!1)})}loadEmpty(){this.fire(new a.Event("dataloading",{dataType:"style"})),this._load(ia,!1)}_updateLayerCount(u,p){const w=p?1:-1;u.is3D()&&(this._num3DLayers+=w),u.type==="circle"&&(this._numCircleLayers+=w),u.type==="symbol"&&(this._numSymbolLayers+=w)}_load(u,p){if(p&&Ta(this,a.validateStyle(u)))return;this._loaded=!0,this.stylesheet=a.clone$1(u),this._updateMapProjection();for(const S in u.sources)this.addSource(S,u.sources[S],{validate:!1});this._changed=!1,u.sprite?this._loadSprite(u.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(u.glyphs);const w=Yt(this.stylesheet.layers);this._order=w.map(S=>S.id),this._layers={},this._serializedLayers={};for(const S of w){const A=a.createStyleLayer(S);A.setEventedParent(this,{layer:{id:A.id}}),this._layers[A.id]=A,this._serializedLayers[A.id]=A.serialize(),this._updateLayerCount(A,!0)}this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new We(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new a.Event("data",{dataType:"style"})),this.fire(new a.Event("style.load"))}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}setProjection(u){u?this.stylesheet.projection=u:delete this.stylesheet.projection,this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.stylesheet.projection)}_loadSprite(u){this._spriteRequest=function(p,w,S){let A,L,B;const F=a.exported.devicePixelRatio>1?"@2x":"";let Y=a.getJSON(w.transformRequest(w.normalizeSpriteURL(p,F,".json"),a.ResourceType.SpriteJSON),(de,ge)=>{Y=null,B||(B=de,A=ge,ie())}),X=a.getImage(w.transformRequest(w.normalizeSpriteURL(p,F,".png"),a.ResourceType.SpriteImage),(de,ge)=>{X=null,B||(B=de,L=ge,ie())});function ie(){if(B)S(B);else if(A&&L){const de=a.exported.getImageData(L),ge={};for(const ye in A){const{width:ve,height:xe,x:ce,y:Se,sdf:Te,pixelRatio:Ae,stretchX:Fe,stretchY:$e,content:qe}=A[ye],Je=new a.RGBAImage({width:ve,height:xe});a.RGBAImage.copy(de,Je,{x:ce,y:Se},{x:0,y:0},{width:ve,height:xe}),ge[ye]={data:Je,pixelRatio:Ae,sdf:Te,stretchX:Fe,stretchY:$e,content:qe}}S(null,ge)}}return{cancel(){Y&&(Y.cancel(),Y=null),X&&(X.cancel(),X=null)}}}(u,this.map._requestManager,(p,w)=>{if(this._spriteRequest=null,p)this.fire(new a.ErrorEvent(p));else if(w)for(const S in w)this.imageManager.addImage(S,w[S]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new a.Event("data",{dataType:"style"}))})}_validateLayer(u){const p=this.getSource(u.source);if(!p)return;const w=u.sourceLayer;w&&(p.type==="geojson"||p.vectorLayerIds&&p.vectorLayerIds.indexOf(w)===-1)&&this.fire(new a.ErrorEvent(new Error(`Source layer "${w}" does not exist on source "${p.id}" as specified by style layer "${u.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const u in this._sourceCaches)if(!this._sourceCaches[u].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(u){const p=[];for(const w of u){const S=this._layers[w];S.type!=="custom"&&p.push(S.serialize())}return p}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const u in this._sourceCaches)if(this._sourceCaches[u].hasTransition())return!0;for(const u in this._layers)if(this._layers[u].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(u){return!!this.terrain&&(typeof u.isLayerDraped=="function"?u.isLayerDraped():co[u.type])}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(u){if(!this._loaded)return;const p=this._changed;if(this._changed){const S=Object.keys(this._updatedLayers),A=Object.keys(this._removedLayers);(S.length||A.length)&&this._updateWorkerLayers(S,A);for(const L in this._updatedSources){const B=this._updatedSources[L];B==="reload"?this._reloadSource(L):B==="clear"&&this._clearSource(L)}this._updateTilesForChangedImages();for(const L in this._updatedPaintProps)this._layers[L].updateTransitions(u);this.light.updateTransitions(u),this.fog&&this.fog.updateTransitions(u),this._resetUpdates()}const w={};for(const S in this._sourceCaches){const A=this._sourceCaches[S];w[S]=A.used,A.used=!1}for(const S of this._order){const A=this._layers[S];if(A.recalculate(u,this._availableImages),!A.isHidden(u.zoom)){const B=this._getLayerSourceCache(A);B&&(B.used=!0)}const L=this.map.painter;if(L){const B=A.getProgramIds();if(!B)continue;const F=A.getProgramConfiguration(u.zoom);for(const Y of B)L.useProgram(Y,F)}}for(const S in w){const A=this._sourceCaches[S];w[S]!==A.used&&A.getSource().fire(new a.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:A.getSource().id}))}this.light.recalculate(u),this.terrain&&this.terrain.recalculate(u),this.fog&&this.fog.recalculate(u),this.z=u.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),p&&this.fire(new a.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const u=Object.keys(this._changedImages);if(u.length){for(const p in this._sourceCaches)this._sourceCaches[p].reloadTilesForDependencies(["icons","patterns"],u);this._changedImages={}}}_updateWorkerLayers(u,p){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(u),removedIds:p})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(u){if(this._checkLoaded(),Ta(this,a.validateStyle(u)))return!1;(u=a.clone$1(u)).layers=Yt(u.layers);const p=function(S,A){if(!S)return[{command:At.setStyle,args:[A]}];let L=[];try{if(!b(S.version,A.version))return[{command:At.setStyle,args:[A]}];b(S.center,A.center)||L.push({command:At.setCenter,args:[A.center]}),b(S.zoom,A.zoom)||L.push({command:At.setZoom,args:[A.zoom]}),b(S.bearing,A.bearing)||L.push({command:At.setBearing,args:[A.bearing]}),b(S.pitch,A.pitch)||L.push({command:At.setPitch,args:[A.pitch]}),b(S.sprite,A.sprite)||L.push({command:At.setSprite,args:[A.sprite]}),b(S.glyphs,A.glyphs)||L.push({command:At.setGlyphs,args:[A.glyphs]}),b(S.transition,A.transition)||L.push({command:At.setTransition,args:[A.transition]}),b(S.light,A.light)||L.push({command:At.setLight,args:[A.light]}),b(S.fog,A.fog)||L.push({command:At.setFog,args:[A.fog]}),b(S.projection,A.projection)||L.push({command:At.setProjection,args:[A.projection]});const B={},F=[];(function(ie,de,ge,ye){let ve;for(ve in de=de||{},ie=ie||{})ie.hasOwnProperty(ve)&&(de.hasOwnProperty(ve)||Bi(ve,ge,ye));for(ve in de){if(!de.hasOwnProperty(ve))continue;const xe=de[ve];ie.hasOwnProperty(ve)?b(ie[ve],xe)||(ie[ve].type==="geojson"&&xe.type==="geojson"&&dr(ie,de,ve)?ge.push({command:At.setGeoJSONSourceData,args:[ve,xe.data]}):rr(ve,de,ge,ye)):ui(ve,de,ge)}})(S.sources,A.sources,F,B);const Y=[];S.layers&&S.layers.forEach(ie=>{ie.source&&B[ie.source]?L.push({command:At.removeLayer,args:[ie.id]}):Y.push(ie)});let X=S.terrain;X&&B[X.source]&&(L.push({command:At.setTerrain,args:[void 0]}),X=void 0),L=L.concat(F),b(X,A.terrain)||L.push({command:At.setTerrain,args:[A.terrain]}),function(ie,de,ge){de=de||[];const ye=(ie=ie||[]).map(Sn),ve=de.map(Sn),xe=ie.reduce(Gr,{}),ce=de.reduce(Gr,{}),Se=ye.slice(),Te=Object.create(null);let Ae,Fe,$e,qe,Je,rt,lt;for(Ae=0,Fe=0;Ae<ye.length;Ae++)$e=ye[Ae],ce.hasOwnProperty($e)?Fe++:(ge.push({command:At.removeLayer,args:[$e]}),Se.splice(Se.indexOf($e,Fe),1));for(Ae=0,Fe=0;Ae<ve.length;Ae++)$e=ve[ve.length-1-Ae],Se[Se.length-1-Ae]!==$e&&(xe.hasOwnProperty($e)?(ge.push({command:At.removeLayer,args:[$e]}),Se.splice(Se.lastIndexOf($e,Se.length-Fe),1)):Fe++,rt=Se[Se.length-Ae],ge.push({command:At.addLayer,args:[ce[$e],rt]}),Se.splice(Se.length-Ae,0,$e),Te[$e]=!0);for(Ae=0;Ae<ve.length;Ae++)if($e=ve[Ae],qe=xe[$e],Je=ce[$e],!Te[$e]&&!b(qe,Je))if(b(qe.source,Je.source)&&b(qe["source-layer"],Je["source-layer"])&&b(qe.type,Je.type)){for(lt in ot(qe.layout,Je.layout,ge,$e,null,At.setLayoutProperty),ot(qe.paint,Je.paint,ge,$e,null,At.setPaintProperty),b(qe.filter,Je.filter)||ge.push({command:At.setFilter,args:[$e,Je.filter]}),b(qe.minzoom,Je.minzoom)&&b(qe.maxzoom,Je.maxzoom)||ge.push({command:At.setLayerZoomRange,args:[$e,Je.minzoom,Je.maxzoom]}),qe)qe.hasOwnProperty(lt)&&lt!=="layout"&&lt!=="paint"&&lt!=="filter"&&lt!=="metadata"&&lt!=="minzoom"&&lt!=="maxzoom"&&(lt.indexOf("paint.")===0?ot(qe[lt],Je[lt],ge,$e,lt.slice(6),At.setPaintProperty):b(qe[lt],Je[lt])||ge.push({command:At.setLayerProperty,args:[$e,lt,Je[lt]]}));for(lt in Je)Je.hasOwnProperty(lt)&&!qe.hasOwnProperty(lt)&&lt!=="layout"&&lt!=="paint"&&lt!=="filter"&&lt!=="metadata"&&lt!=="minzoom"&&lt!=="maxzoom"&&(lt.indexOf("paint.")===0?ot(qe[lt],Je[lt],ge,$e,lt.slice(6),At.setPaintProperty):b(qe[lt],Je[lt])||ge.push({command:At.setLayerProperty,args:[$e,lt,Je[lt]]}))}else ge.push({command:At.removeLayer,args:[$e]}),rt=Se[Se.lastIndexOf($e)+1],ge.push({command:At.addLayer,args:[Je,rt]})}(Y,A.layers,L)}catch(B){console.warn("Unable to compute style diff:",B),L=[{command:At.setStyle,args:[A]}]}return L}(this.serialize(),u).filter(S=>!(S.command in Hn));if(p.length===0)return!1;const w=p.filter(S=>!(S.command in ta));if(w.length>0)throw new Error(`Unimplemented: ${w.map(S=>S.command).join(", ")}.`);return p.forEach(S=>{S.command!=="setTransition"&&S.command!=="setProjection"&&this[S.command].apply(this,S.args)}),this.stylesheet=u,this._updateMapProjection(),!0}addImage(u,p){return this.getImage(u)?this.fire(new a.ErrorEvent(new Error("An image with this name already exists."))):(this.imageManager.addImage(u,p),this._afterImageUpdated(u),this)}updateImage(u,p){this.imageManager.updateImage(u,p)}getImage(u){return this.imageManager.getImage(u)}removeImage(u){return this.getImage(u)?(this.imageManager.removeImage(u),this._afterImageUpdated(u),this):this.fire(new a.ErrorEvent(new Error("No image with this name exists.")))}_afterImageUpdated(u){this._availableImages=this.imageManager.listImages(),this._changedImages[u]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new a.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(u,p,w={}){if(this._checkLoaded(),this.getSource(u)!==void 0)throw new Error("There is already a source with this ID");if(!p.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(p).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(p.type)>=0&&this._validate(a.validateSource,`sources.${u}`,p,null,w))return;this.map&&this.map._collectResourceTiming&&(p.collectResourceTiming=!0);const S=Ue(u,p,this.dispatcher,this);S.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(u),source:S.serialize(),sourceId:u}));const A=L=>{const B=(L?"symbol:":"other:")+u,F=this._sourceCaches[B]=new a.SourceCache(B,S,L);(L?this._symbolSourceCaches:this._otherSourceCaches)[u]=F,F.style=this,F.onAdd(this.map)};A(!1),p.type!=="vector"&&p.type!=="geojson"||A(!0),S.onAdd&&S.onAdd(this.map),this._changed=!0}removeSource(u){this._checkLoaded();const p=this.getSource(u);if(!p)throw new Error("There is no source with this ID");for(const S in this._layers)if(this._layers[S].source===u)return this.fire(new a.ErrorEvent(new Error(`Source "${u}" cannot be removed while layer "${S}" is using it.`)));if(this.terrain&&this.terrain.get().source===u)return this.fire(new a.ErrorEvent(new Error(`Source "${u}" cannot be removed while terrain is using it.`)));const w=this._getSourceCaches(u);for(const S of w)delete this._sourceCaches[S.id],delete this._updatedSources[S.id],S.fire(new a.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:S.getSource().id})),S.setEventedParent(null),S.clearTiles();return delete this._otherSourceCaches[u],delete this._symbolSourceCaches[u],p.setEventedParent(null),p.onRemove&&p.onRemove(this.map),this._changed=!0,this}setGeoJSONSourceData(u,p){this._checkLoaded(),this.getSource(u).setData(p),this._changed=!0}getSource(u){const p=this._getSourceCache(u);return p&&p.getSource()}_getSources(){const u=[];for(const p in this._otherSourceCaches){const w=this._getSourceCache(p);w&&u.push(w.getSource())}return u}addLayer(u,p,w={}){this._checkLoaded();const S=u.id;if(this.getLayer(S))return void this.fire(new a.ErrorEvent(new Error(`Layer with id "${S}" already exists on this map`)));let A;if(u.type==="custom"){if(Ta(this,a.validateCustomStyleLayer(u)))return;A=a.createStyleLayer(u)}else{if(typeof u.source=="object"&&(this.addSource(S,u.source),u=a.clone$1(u),u=a.extend(u,{source:S})),this._validate(a.validateLayer,`layers.${S}`,u,{arrayIndex:-1},w))return;A=a.createStyleLayer(u),this._validateLayer(A),A.setEventedParent(this,{layer:{id:S}}),this._serializedLayers[A.id]=A.serialize(),this._updateLayerCount(A,!0)}const L=p?this._order.indexOf(p):this._order.length;if(p&&L===-1)return void this.fire(new a.ErrorEvent(new Error(`Layer with id "${p}" does not exist on this map.`)));this._order.splice(L,0,S),this._layerOrderChanged=!0,this._layers[S]=A;const B=this._getLayerSourceCache(A);if(this._removedLayers[S]&&A.source&&B&&A.type!=="custom"){const F=this._removedLayers[S];delete this._removedLayers[S],F.type!==A.type?this._updatedSources[A.source]="clear":(this._updatedSources[A.source]="reload",B.pause())}this._updateLayer(A),A.onAdd&&A.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(u,p){if(this._checkLoaded(),this._changed=!0,!this._layers[u])return void this.fire(new a.ErrorEvent(new Error(`The layer '${u}' does not exist in the map's style and cannot be moved.`)));if(u===p)return;const w=this._order.indexOf(u);this._order.splice(w,1);const S=p?this._order.indexOf(p):this._order.length;p&&S===-1?this.fire(new a.ErrorEvent(new Error(`Layer with id "${p}" does not exist on this map.`))):(this._order.splice(S,0,u),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(u){this._checkLoaded();const p=this._layers[u];if(!p)return void this.fire(new a.ErrorEvent(new Error(`The layer '${u}' does not exist in the map's style and cannot be removed.`)));p.setEventedParent(null),this._updateLayerCount(p,!1);const w=this._order.indexOf(u);this._order.splice(w,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[u]=p,delete this._layers[u],delete this._serializedLayers[u],delete this._updatedLayers[u],delete this._updatedPaintProps[u],p.onRemove&&p.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(u){return this._layers[u]}hasLayer(u){return u in this._layers}hasLayerType(u){for(const p in this._layers)if(this._layers[p].type===u)return!0;return!1}setLayerZoomRange(u,p,w){this._checkLoaded();const S=this.getLayer(u);S?S.minzoom===p&&S.maxzoom===w||(p!=null&&(S.minzoom=p),w!=null&&(S.maxzoom=w),this._updateLayer(S)):this.fire(new a.ErrorEvent(new Error(`The layer '${u}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(u,p,w={}){this._checkLoaded();const S=this.getLayer(u);if(S){if(!b(S.filter,p))return p==null?(S.filter=void 0,void this._updateLayer(S)):void(this._validate(a.validateFilter,`layers.${S.id}.filter`,p,{layerType:S.type},w)||(S.filter=a.clone$1(p),this._updateLayer(S)))}else this.fire(new a.ErrorEvent(new Error(`The layer '${u}' does not exist in the map's style and cannot be filtered.`)))}getFilter(u){const p=this.getLayer(u);return p&&a.clone$1(p.filter)}setLayoutProperty(u,p,w,S={}){this._checkLoaded();const A=this.getLayer(u);A?b(A.getLayoutProperty(p),w)||(A.setLayoutProperty(p,w,S),this._updateLayer(A)):this.fire(new a.ErrorEvent(new Error(`The layer '${u}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(u,p){const w=this.getLayer(u);if(w)return w.getLayoutProperty(p);this.fire(new a.ErrorEvent(new Error(`The layer '${u}' does not exist in the map's style.`)))}setPaintProperty(u,p,w,S={}){this._checkLoaded();const A=this.getLayer(u);A?b(A.getPaintProperty(p),w)||(A.setPaintProperty(p,w,S)&&this._updateLayer(A),this._changed=!0,this._updatedPaintProps[u]=!0):this.fire(new a.ErrorEvent(new Error(`The layer '${u}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(u,p){const w=this.getLayer(u);return w&&w.getPaintProperty(p)}setFeatureState(u,p){this._checkLoaded();const w=u.source,S=u.sourceLayer,A=this.getSource(w);if(!A)return void this.fire(new a.ErrorEvent(new Error(`The source '${w}' does not exist in the map's style.`)));const L=A.type;if(L==="geojson"&&S)return void this.fire(new a.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(L==="vector"&&!S)return void this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));u.id===void 0&&this.fire(new a.ErrorEvent(new Error("The feature id parameter must be provided.")));const B=this._getSourceCaches(w);for(const F of B)F.setFeatureState(S,u.id,p)}removeFeatureState(u,p){this._checkLoaded();const w=u.source,S=this.getSource(w);if(!S)return void this.fire(new a.ErrorEvent(new Error(`The source '${w}' does not exist in the map's style.`)));const A=S.type,L=A==="vector"?u.sourceLayer:void 0;if(A==="vector"&&!L)return void this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(p&&typeof u.id!="string"&&typeof u.id!="number")return void this.fire(new a.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const B=this._getSourceCaches(w);for(const F of B)F.removeFeatureState(L,u.id,p)}getFeatureState(u){this._checkLoaded();const p=u.source,w=u.sourceLayer,S=this.getSource(p);if(S){if(S.type!=="vector"||w)return u.id===void 0&&this.fire(new a.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(p)[0].getFeatureState(w,u.id);this.fire(new a.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new a.ErrorEvent(new Error(`The source '${p}' does not exist in the map's style.`)))}getTransition(){return a.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const u={};for(const p in this._sourceCaches){const w=this._sourceCaches[p].getSource();u[w.id]||(u[w.id]=w.serialize())}return a.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.getTerrain()||void 0,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:u,layers:this._serializeLayers(this._order)},p=>p!==void 0)}_updateLayer(u){this._updatedLayers[u.id]=!0;const p=this._getLayerSourceCache(u);u.source&&!this._updatedSources[u.source]&&p&&p.getSource().type!=="raster"&&(this._updatedSources[u.source]="reload",p.pause()),this._changed=!0,u.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(u){const p=L=>this._layers[L].type==="fill-extrusion",w={},S=[];for(let L=this._order.length-1;L>=0;L--){const B=this._order[L];if(p(B)){w[B]=L;for(const F of u){const Y=F[B];if(Y)for(const X of Y)S.push(X)}}}S.sort((L,B)=>B.intersectionZ-L.intersectionZ);const A=[];for(let L=this._order.length-1;L>=0;L--){const B=this._order[L];if(p(B))for(let F=S.length-1;F>=0;F--){const Y=S[F].feature;if(w[Y.layer.id]<L)break;A.push(Y),S.pop()}else for(const F of u){const Y=F[B];if(Y)for(const X of Y)A.push(X.feature)}}return A}queryRenderedFeatures(u,p,w){p&&p.filter&&this._validate(a.validateFilter,"queryRenderedFeatures.filter",p.filter,null,p);const S={};if(p&&p.layers){if(!Array.isArray(p.layers))return this.fire(new a.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const F of p.layers){const Y=this._layers[F];if(!Y)return this.fire(new a.ErrorEvent(new Error(`The layer '${F}' does not exist in the map's style and cannot be queried for features.`))),[];S[Y.source]=!0}}const A=[];p.availableImages=this._availableImages;const L=p&&p.layers?p.layers.some(F=>{const Y=this.getLayer(F);return Y&&Y.is3D()}):this.has3DLayers(),B=It.createFromScreenPoints(u,w);for(const F in this._sourceCaches){const Y=this._sourceCaches[F].getSource().id;p.layers&&!S[Y]||A.push(Xe(this._sourceCaches[F],this._layers,this._serializedLayers,B,p,w,L,!!this.map._showQueryGeometry))}return this.placement&&A.push(function(F,Y,X,ie,de,ge,ye){const ve={},xe=ge.queryRenderedSymbols(ie),ce=[];for(const Se of Object.keys(xe).map(Number))ce.push(ye[Se]);ce.sort(Ht);for(const Se of ce){const Te=Se.featureIndex.lookupSymbolFeatures(xe[Se.bucketInstanceId],Y,Se.bucketIndex,Se.sourceLayerIndex,de.filter,de.layers,de.availableImages,F);for(const Ae in Te){const Fe=ve[Ae]=ve[Ae]||[],$e=Te[Ae];$e.sort((qe,Je)=>{const rt=Se.featureSortOrder;if(rt){const lt=rt.indexOf(qe.featureIndex);return rt.indexOf(Je.featureIndex)-lt}return Je.featureIndex-qe.featureIndex});for(const qe of $e)Fe.push(qe)}}for(const Se in ve)ve[Se].forEach(Te=>{const Ae=Te.feature,Fe=X(F[Se]);if(!Fe)return;const $e=Fe.getFeatureState(Ae.layer["source-layer"],Ae.id);Ae.source=Ae.layer.source,Ae.layer["source-layer"]&&(Ae.sourceLayer=Ae.layer["source-layer"]),Ae.state=$e});return ve}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),B.screenGeometry,p,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(A)}querySourceFeatures(u,p){p&&p.filter&&this._validate(a.validateFilter,"querySourceFeatures.filter",p.filter,null,p);const w=this._getSourceCaches(u);let S=[];for(const A of w)S=S.concat(bt(A,p));return S}addSourceType(u,p,w){return Hr.getSourceType(u)?w(new Error(`A source type called "${u}" already exists.`)):(Hr.setSourceType(u,p),p.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:u,url:p.workerSourceURL},w):w(null,null))}getLight(){return this.light.getLight()}setLight(u,p={}){this._checkLoaded();const w=this.light.getLight();let S=!1;for(const L in u)if(!b(u[L],w[L])){S=!0;break}if(!S)return;const A=this._setTransitionParameters({duration:300,delay:0});this.light.setLight(u,p),this.light.updateTransitions(A)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(u,p=1){if(this._checkLoaded(),!u)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let w=u;if(p===1){if(typeof w.source=="object"){const S="terrain-dem-src";this.addSource(S,w.source),w=a.clone$1(w),w=a.extend(w,{source:S})}if(this._validate(a.validateTerrain,"terrain",w))return}if(!this.terrain||this.terrain&&p!==this.terrain.drapeRenderMode){if(!w)return;this._createTerrain(w,p)}else{const S=this.terrain,A=S.get();for(const L of Object.keys(a.spec.terrain))!w.hasOwnProperty(L)&&a.spec.terrain[L].default&&(w[L]=a.spec.terrain[L].default);for(const L in w)if(!b(w[L],A[L])){S.set(w),this.stylesheet.terrain=w;const B=this._setTransitionParameters({duration:0});S.updateTransitions(B);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(u){const p=this.fog=new Mt(u,this.map.transform);this.stylesheet.fog=u;const w=this._setTransitionParameters({duration:0});p.updateTransitions(w)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const u of this.map._markers)u._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(u){if(this._checkLoaded(),!u)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const p=this.fog,w=p.get();Object.keys(u).length===0&&p.set(u);for(const S in u)if(!b(u[S],w[S])){p.set(u),this.stylesheet.fog=u;const A=this._setTransitionParameters({duration:0});p.updateTransitions(A);break}}else this._createFog(u);this._markersNeedUpdate=!0}_setTransitionParameters(u){return{now:a.exported.now(),transition:a.extend(u,this.stylesheet.transition)}}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const u=this._order.filter(w=>this.isLayerDraped(this._layers[w])),p=this._order.filter(w=>!this.isLayerDraped(this._layers[w]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...u),this._drapedFirstOrder.push(...p)}_createTerrain(u,p){const w=this.terrain=new ti(u,p);this.stylesheet.terrain=u,this.dispatcher.broadcast("enableTerrain",!this.terrainSetForDrapingOnly()),this._force3DLayerUpdate();const S=this._setTransitionParameters({duration:0});w.updateTransitions(S)}_force3DLayerUpdate(){for(const u in this._layers){const p=this._layers[u];p.type==="fill-extrusion"&&this._updateLayer(p)}}_forceSymbolLayerUpdate(){for(const u in this._layers){const p=this._layers[u];p.type==="symbol"&&this._updateLayer(p)}}_validate(u,p,w,S,A={}){return(!A||A.validate!==!1)&&Ta(this,u.call(a.validateStyle,a.extend({key:p,style:this.serialize(),value:w,styleSpec:a.spec},S)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),a.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const u in this._layers)this._layers[u].setEventedParent(null);for(const u in this._sourceCaches)this._sourceCaches[u].clearTiles(),this._sourceCaches[u].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(u){const p=this._getSourceCaches(u);for(const w of p)w.clearTiles()}_reloadSource(u){const p=this._getSourceCaches(u);for(const w of p)w.resume(),w.reload()}_reloadSources(){for(const u of this._getSources())u.reload&&u.reload()}_updateSources(u){for(const p in this._sourceCaches)this._sourceCaches[p].update(u)}_generateCollisionBoxes(){for(const u in this._sourceCaches){const p=this._sourceCaches[u];p.resume(),p.reload()}}_updatePlacement(u,p,w,S,A=!1){let L=!1,B=!1;const F={};for(const Y of this._order){const X=this._layers[Y];if(X.type!=="symbol")continue;if(!F[X.source]){const de=this._getLayerSourceCache(X);if(!de)continue;F[X.source]=de.getRenderableIds(!0).map(ge=>de.getTileByID(ge)).sort((ge,ye)=>ye.tileID.overscaledZ-ge.tileID.overscaledZ||(ge.tileID.isLessThan(ye.tileID)?-1:1))}const ie=this.crossTileSymbolIndex.addLayer(X,F[X.source],u.center.lng,u.projection);L=L||ie}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),A=A||this._layerOrderChanged||w===0,this._layerOrderChanged&&this.fire(new a.Event("neworder")),(A||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(a.exported.now(),u.zoom))&&(this.pauseablePlacement=new Ea(u,this._order,A,p,w,S,this.placement,this.fog&&u.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,F),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(a.exported.now()),B=!0),L&&this.pauseablePlacement.placement.setStale()),B||L)for(const Y of this._order){const X=this._layers[Y];X.type==="symbol"&&this.placement.updateLayerOpacities(X,F[X.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(a.exported.now())}_releaseSymbolFadeTiles(){for(const u in this._sourceCaches)this._sourceCaches[u].releaseSymbolFadeTiles()}getImages(u,p,w){this.imageManager.getImages(p.icons,w),this._updateTilesForChangedImages();const S=A=>{A&&A.setDependencies(p.tileID.key,p.type,p.icons)};S(this._otherSourceCaches[p.source]),S(this._symbolSourceCaches[p.source])}getGlyphs(u,p,w){this.glyphManager.getGlyphs(p.stacks,w)}getResource(u,p,w){return a.makeRequest(p,w)}_getSourceCache(u){return this._otherSourceCaches[u]}_getLayerSourceCache(u){return u.type==="symbol"?this._symbolSourceCaches[u.source]:this._otherSourceCaches[u.source]}_getSourceCaches(u){const p=[];return this._otherSourceCaches[u]&&p.push(this._otherSourceCaches[u]),this._symbolSourceCaches[u]&&p.push(this._symbolSourceCaches[u]),p}_isSourceCacheLoaded(u){const p=this._getSourceCaches(u);return p.length===0?(this.fire(new a.ErrorEvent(new Error(`There is no source with ID '${u}'`))),!1):p.every(w=>w.loaded())}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Hr.getSourceType=function(y){return Ye[y]},Hr.setSourceType=function(y,u){Ye[y]=u},Hr.registerForPluginStateChange=a.registerForPluginStateChange;var ra=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#define HALF_PI PI/2.0
#define QUARTER_PI PI/4.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0`,Is="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",hl=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform sampler2D u_dem;uniform sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,Sa=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Ma=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump float u_fog_temporal_offset;varying vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`;let Qa={},Ja={};const na=[];uo(ra,na),uo(hl,na),uo(Sa,na),uo(Ma,na),Qa=hr("",hl),Ja=hr(Ma,Sa);const bo=hr(`
#if __VERSION__ >=300
#define varying in
#define gl_FragColor glFragColor
#define texture2D texture
#define textureCube texture
out vec4 glFragColor;
#endif
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}`,`
#if __VERSION__ >=300
#define attribute in
#define varying out
#define texture2D texture
#endif
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),Aa=ra,es=`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`;var ks={background:hr(`uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
varying vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform vec4 u_color;varying vec4 v_color;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting(u_color);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:hr(`uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:hr(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:hr("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:hr(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:hr(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:hr("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:hr("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:hr("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",`attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;
#endif
varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:hr(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:hr(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:hr(`uniform vec2 u_texsize;uniform sampler2D u_image;varying vec2 v_pos;varying vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;varying vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:hr(`uniform vec2 u_texsize;uniform sampler2D u_image;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:hr(`varying vec4 v_color;
#ifdef RENDER_SHADOWS
varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#ifdef ZERO_ROOF_RADIUS
varying vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
varying highp vec3 v_normal;
#endif
void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
vec3 normal=v_normal;
#endif
float z;vec4 color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);color=mix(v_color,v_roof_color,z);
#else
color=v_color;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);color.rgb=color.rgb*shade;
#endif
#ifdef RENDER_SHADOWS
#ifdef ZERO_ROOF_RADIUS
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#endif
color.xyz=shadowed_color_normal(color.xyz,normalize(normal),v_pos_light_view_0,v_pos_light_view_1,v_depth);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec4 v_color;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;
#endif
#ifdef ZERO_ROOF_RADIUS
varying vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
varying highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)
v_normal=normal;
#endif
base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
v_pos_light_view_0=u_light_matrix_0*vec4(pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1);v_depth=gl_Position.w;
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}v_color=vec4(0.0,0.0,0.0,1.0);
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting(color,NdotL);
#else
v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));
#endif
v_color*=u_opacity;
#ifdef ZERO_ROOF_RADIUS
v_roof_color=vec4(0.0,0.0,0.0,1.0);
#ifdef LIGHTING_3D_MODE
v_roof_color=apply_lighting(color,calculate_NdotL(vec3(0.0,0.0,1.0)));
#else
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));
#endif
v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionPattern:hr(`uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
varying float v_NdotL;
#endif
varying vec2 v_pos;varying vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,v_NdotL)*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec2 v_pos;varying vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
varying float v_NdotL;
#endif
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_NdotL=NdotL;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),hillshadePrepare:hr(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:hr(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
gl_FragColor=apply_lighting(gl_FragColor);
#endif
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:hr(`uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;varying vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
uniform float u_border_width;uniform vec4 u_border_color;float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture2D(u_dash_image,v_tex).a;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture2D(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trimmed=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef RENDER_LINE_ALPHA_DISCARD
if (alpha < u_alpha_discard_threshold) {discard;}
#endif
#ifdef RENDER_LINE_BORDER
float edgeBlur=(u_border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);
#ifdef RENDER_LINE_BORDER_AUTO
float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}
#else
out_color.rgb=mix(u_border_color.rgb*u_border_color.a*trimmed,out_color.rgb,smoothAlpha);
#endif
}
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
attribute highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;varying vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:hr(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x=mod(v_linesofar/pattern_size.x*aspect,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec4 color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
color=apply_lighting(color);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:hr(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:hr(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}`),symbolSDF:hr(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}`),symbolTextAndIcon:hr(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));
#endif
float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}`),terrainRaster:hr(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#endif
void main() {vec4 color=texture2D(u_image0,v_pos0);
#ifdef RENDER_SHADOWS
color.xyz=shadowed_color(color.xyz,v_pos_light_view_0,v_pos_light_view_1,v_depth);
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#endif
const float wireframeOffset=0.00015;void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;
#ifdef TERRAIN_WIREFRAME
elevation+=wireframeOffset;
#endif
v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;
#endif
}`),terrainDepth:hr(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;varying float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:hr(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Is),skyboxGradient:hr(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,Is),skyboxCapture:hr(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:hr(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture2D(u_image0,v_pos0);color=vec4(raster.rgb*antialias,raster.a*antialias);
#else
color=texture2D(u_image0,v_pos0);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef TERRAIN_WIREFRAME
gl_FragColor=vec4(1.0,0.0,0.0,0.8);
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
attribute vec3 a_globe_pos;attribute vec2 a_uv;
#else
attribute vec2 a_pos;
#endif
varying vec2 v_pos0;const float wireframeOffset=1e3;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);
#ifdef TERRAIN_WIREFRAME
height+=wireframeOffset;
#endif
globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:hr(`uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec3 u_start_color;uniform vec4 u_color;uniform vec4 u_space_color;uniform vec4 u_high_color;uniform float u_star_intensity;uniform float u_star_size;uniform float u_star_density;uniform float u_horizon_angle;uniform mat4 u_rotation_matrix;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;highp float random(highp vec3 p) {p=fract(p*vec3(23.2342,97.1231,91.2342));p+=dot(p.zxy,p.yxz+123.1234);return fract(p.x*p.y);}float stars(vec3 p,float scale,vec2 offset) {vec2 uv_scale=(u_viewport/u_star_size)*scale;vec3 position=vec3(p.xy*uv_scale+offset*u_viewport,p.z);vec3 q=fract(position)-0.5;vec3 id=floor(position);float random_visibility=step(random(id),u_star_density);float circle=smoothstep(0.5+u_star_intensity,0.5,length(q));return circle*random_visibility;}void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {discard;return;}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(dot(dir,horizon_dir)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;float closest_point_to_center=length(closest_point-u_globe_pos);float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c =mix(color_stop_2,c2,t);float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);vec2 uv=gl_FragCoord.xy/u_viewport-0.5;float aspect_ratio=u_viewport.x/u_viewport.y;vec4 uv_dir=vec4(normalize(vec3(uv.x*aspect_ratio,uv.y,1.0)),1.0);uv_dir=u_rotation_matrix*uv_dir;vec3 n=abs(uv_dir.xyz);vec2 uv_remap=(n.x > n.y && n.x > n.z) ? uv_dir.yz/uv_dir.x:
(n.y > n.x && n.y > n.z) ? uv_dir.zx/uv_dir.y:
uv_dir.xy/uv_dir.z;uv_remap.x/=aspect_ratio;vec3 D=vec3(uv_remap,1.0);highp float star_field=0.0;if (u_star_intensity > 0.0) {star_field+=stars(D,1.2,vec2(0.0,0.0));star_field+=stars(D,1.0,vec2(1.0,0.0));star_field+=stars(D,0.8,vec2(0.0,1.0));star_field+=stars(D,0.6,vec2(1.0,1.0));star_field*=(1.0-pow(t,0.25+(1.0-u_high_color.a)*0.75));c+=star_field*alpha_2;}c=dither(c,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=vec4(c,a);}`,`attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`)};function uo(y,u){const p=y.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let w of p)if(w=w.trim(),w[0]==="#"&&w.includes("if")&&!w.includes("endif")){w=w.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const S=w.split(" ");for(const A of S)u.includes(A)||u.push(A)}}function hr(y,u){const p=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,w=u.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),S={},A=[...na];return uo(y,A),uo(u,A),{fragmentSource:y=y.replace(p,(L,B,F,Y,X)=>(S[X]=!0,B==="define"?`
#ifndef HAS_UNIFORM_u_${X}
varying ${F} ${Y} ${X};
#else
uniform ${F} ${Y} u_${X};
#endif
`:`
#ifdef HAS_UNIFORM_u_${X}
    ${F} ${Y} ${X} = u_${X};
#endif
`)),vertexSource:u=u.replace(p,(L,B,F,Y,X)=>{const ie=Y==="float"?"vec2":"vec4",de=X.match(/color/)?"color":ie;return S[X]?B==="define"?`
#ifndef HAS_UNIFORM_u_${X}
uniform lowp float u_${X}_t;
attribute ${F} ${ie} a_${X};
varying ${F} ${Y} ${X};
#else
uniform ${F} ${Y} u_${X};
#endif
`:de==="vec4"?`
#ifndef HAS_UNIFORM_u_${X}
    ${X} = a_${X};
#else
    ${F} ${Y} ${X} = u_${X};
#endif
`:`
#ifndef HAS_UNIFORM_u_${X}
    ${X} = unpack_mix_${de}(a_${X}, u_${X}_t);
#else
    ${F} ${Y} ${X} = u_${X};
#endif
`:B==="define"?`
#ifndef HAS_UNIFORM_u_${X}
uniform lowp float u_${X}_t;
attribute ${F} ${ie} a_${X};
#else
uniform ${F} ${Y} u_${X};
#endif
`:de==="vec4"?`
#ifndef HAS_UNIFORM_u_${X}
    ${F} ${Y} ${X} = a_${X};
#else
    ${F} ${Y} ${X} = u_${X};
#endif
`:`
#ifndef HAS_UNIFORM_u_${X}
    ${F} ${Y} ${X} = unpack_mix_${de}(a_${X}, u_${X}_t);
#else
    ${F} ${Y} ${X} = u_${X};
#endif
`}),staticAttributes:w,usedDefines:A}}class Lo{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(u,p,w,S,A,L,B){this.context=u;let F=this.boundPaintVertexBuffers.length!==S.length;for(let X=0;!F&&X<S.length;X++)this.boundPaintVertexBuffers[X]!==S[X]&&(F=!0);let Y=this.boundDynamicVertexBuffers.length!==B.length;for(let X=0;!Y&&X<B.length;X++)this.boundDynamicVertexBuffers[X]!==B[X]&&(Y=!0);if(!u.extVertexArrayObject||!this.vao||this.boundProgram!==p||this.boundLayoutVertexBuffer!==w||F||Y||this.boundIndexBuffer!==A||this.boundVertexOffset!==L)this.freshBind(p,w,S,A,L,B);else{u.bindVertexArrayOES.set(this.vao);for(const X of B)X&&X.bind();A&&A.dynamicDraw&&A.bind()}}freshBind(u,p,w,S,A,L){let B;const F=u.numAttributes,Y=this.context,X=Y.gl;if(Y.extVertexArrayObject)this.vao&&this.destroy(),this.vao=Y.extVertexArrayObject.createVertexArrayOES(),Y.bindVertexArrayOES.set(this.vao),B=0,this.boundProgram=u,this.boundLayoutVertexBuffer=p,this.boundPaintVertexBuffers=w,this.boundIndexBuffer=S,this.boundVertexOffset=A,this.boundDynamicVertexBuffers=L;else{B=Y.currentNumAttributes||0;for(let ie=F;ie<B;ie++)X.disableVertexAttribArray(ie)}p.enableAttributes(X,u),p.bind(),p.setVertexAttribPointers(X,u,A);for(const ie of w)ie.enableAttributes(X,u),ie.bind(),ie.setVertexAttribPointers(X,u,A);for(const ie of L)ie&&(ie.enableAttributes(X,u),ie.bind(),ie.setVertexAttribPointers(X,u,A));S&&S.bind(),Y.currentNumAttributes=F}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function Ca(y,u){const p=Math.pow(2,u.canonical.z),w=u.canonical.y;return[new a.MercatorCoordinate(0,w/p).toLngLat().lat,new a.MercatorCoordinate(0,(w+1)/p).toLngLat().lat]}function $o(y,u,p,w,S,A,L){const B=y.context,F=B.gl,Y=p.fbo;if(!Y)return;y.prepareDrawTile();const X=y.useProgram("hillshade");B.activeTexture.set(F.TEXTURE0),F.bindTexture(F.TEXTURE_2D,Y.colorAttachment.get());const ie=((ve,xe,ce,Se)=>{const Te=ce.paint.get("hillshade-shadow-color"),Ae=ce.paint.get("hillshade-highlight-color"),Fe=ce.paint.get("hillshade-accent-color");let $e=ce.paint.get("hillshade-illumination-direction")*(Math.PI/180);ce.paint.get("hillshade-illumination-anchor")==="viewport"&&($e-=ve.transform.angle);const qe=!ve.options.moving;return{u_matrix:Se||ve.transform.calculateProjMatrix(xe.tileID.toUnwrapped(),qe),u_image:0,u_latrange:Ca(0,xe.tileID),u_light:[ce.paint.get("hillshade-exaggeration"),$e],u_shadow:Te,u_highlight:Ae,u_accent:Fe}})(y,p,w,y.terrain?u.projMatrix:null);y.prepareDrawProgram(B,X,u.toUnwrapped());const{tileBoundsBuffer:de,tileBoundsIndexBuffer:ge,tileBoundsSegments:ye}=y.getTileBoundsBuffers(p);X.draw(B,F.TRIANGLES,S,A,L,a.CullFaceMode.disabled,ie,w.id,de,ge,ye)}function ho(y,u,p){if(!u.needsDEMTextureUpload)return;const w=y.context,S=w.gl;w.pixelStoreUnpackPremultiplyAlpha.set(!1),u.demTexture=u.demTexture||y.getTileTexture(p.stride);const A=p.getPixels();u.demTexture?u.demTexture.update(A,{premultiply:!1}):u.demTexture=new a.Texture(w,A,S.RGBA,{premultiply:!1}),u.needsDEMTextureUpload=!1}function ts(y,u,p,w,S,A){const L=y.context,B=L.gl;if(!u.dem)return;const F=u.dem;if(L.activeTexture.set(B.TEXTURE1),ho(y,u,F),!u.demTexture)return;u.demTexture.bind(B.NEAREST,B.CLAMP_TO_EDGE);const Y=F.dim;L.activeTexture.set(B.TEXTURE0);let X=u.fbo;if(!X){const ye=new a.Texture(L,{width:Y,height:Y,data:null},B.RGBA);ye.bind(B.LINEAR,B.CLAMP_TO_EDGE),X=u.fbo=L.createFramebuffer(Y,Y,!0),X.colorAttachment.set(ye.texture)}L.bindFramebuffer.set(X.framebuffer),L.viewport.set([0,0,Y,Y]);const{tileBoundsBuffer:ie,tileBoundsIndexBuffer:de,tileBoundsSegments:ge}=y.getMercatorTileBoundsBuffers();y.useProgram("hillshadePrepare").draw(L,B.TRIANGLES,w,S,A,a.CullFaceMode.disabled,((ye,ve)=>{const xe=ve.stride,ce=a.create();return a.ortho(ce,0,a.EXTENT,-a.EXTENT,0,0,1),a.translate(ce,ce,[0,-a.EXTENT,0]),{u_matrix:ce,u_image:1,u_dimension:[xe,xe],u_zoom:ye.overscaledZ,u_unpack:ve.unpackVector}})(u.tileID,F),p.id,ie,de,ge),u.needsHillshadePrepare=!1}const is=y=>({u_matrix:new a.UniformMatrix4f(y),u_image0:new a.Uniform1i(y),u_skirt_height:new a.Uniform1f(y)}),Ds=(y,u)=>({u_matrix:y,u_image0:0,u_skirt_height:u}),rs=(y,u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye)=>({u_proj_matrix:Float32Array.from(y),u_globe_matrix:u,u_normalize_matrix:Float32Array.from(w),u_merc_matrix:p,u_zoom_transition:S,u_merc_center:A,u_image0:0,u_frustum_tl:L,u_frustum_tr:B,u_frustum_br:F,u_frustum_bl:Y,u_globe_pos:X,u_globe_radius:ie,u_viewport:de,u_grid_matrix:ye?Float32Array.from(ye):new Float32Array(9),u_skirt_height:ge});function Rs(y,u){return y!=null&&u!=null&&!(!y.hasData()||!u.hasData())&&y.demTexture!=null&&u.demTexture!=null&&y.tileID.key!==u.tileID.key}const fo=new class{constructor(){this.operations={}}newMorphing(y,u,p,w,S){if(y in this.operations){const A=this.operations[y];A.to.tileID.key!==p.tileID.key&&(A.queued=p)}else this.operations[y]={startTime:w,phase:0,duration:S,from:u,to:p,queued:null}}getMorphValuesForProxy(y){if(!(y in this.operations))return null;const u=this.operations[y];return{from:u.from,to:u.to,phase:u.phase}}update(y){for(const u in this.operations){const p=this.operations[u];for(p.phase=(y-p.startTime)/p.duration;p.phase>=1||!this._validOp(p);)if(!this._nextOp(p,y)){delete this.operations[u];break}}}_nextOp(y,u){return!!y.queued&&(y.from=y.to,y.to=y.queued,y.queued=null,y.phase=0,y.startTime=u,!0)}_validOp(y){return y.from.hasData()&&y.to.hasData()}},po={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function Jn(y){return 6*Math.pow(1.5,22-y)}function Xn(y,u){const p=1<<y.z;return!u&&(y.x===0||y.x===p-1)||y.y===0||y.y===p-1}const Qi=y=>({u_matrix:y});function wo(y,u,p,w,S){if(S>0){const A=a.exported.now(),L=(A-y.timeAdded)/S,B=u?(A-u.timeAdded)/S:-1,F=p.getSource(),Y=w.coveringZoomLevel({tileSize:F.tileSize,roundZoom:F.roundZoom}),X=!u||Math.abs(u.tileID.overscaledZ-Y)>Math.abs(y.tileID.overscaledZ-Y),ie=X&&y.refreshedUponExpiration?1:a.clamp(X?L:1-B,0,1);return y.refreshedUponExpiration&&L>=1&&(y.refreshedUponExpiration=!1),u?{opacity:1,mix:1-ie}:{opacity:ie,mix:0}}return{opacity:1,mix:0}}class mo extends a.SourceCache{constructor(u){const p={type:"raster-dem",maxzoom:u.transform.maxZoom},w=new ht(Fi(),null),S=Ue("mock-dem",p,w,u.style);super("mock-dem",S,!1),S.setEventedParent(this),this._sourceLoaded=!0}_loadTile(u,p){u.state="loaded",p(null)}}class dl extends a.SourceCache{constructor(u){const p=Ue("proxy",{type:"geojson",maxzoom:u.transform.maxZoom},new ht(Fi(),null),u.style);super("proxy",p,!1),p.setEventedParent(this),this.map=this.getSource().map=u,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(u,p,w){if(u.freezeTileCoverage)return;this.transform=u;const S=u.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((A,L)=>{if(A[L.key]="",!this._tiles[L.key]){const B=new a.Tile(L,this._source.tileSize*L.overscaleFactor(),u.tileZoom);B.state="loaded",this._tiles[L.key]=B}return A},{});for(const A in this._tiles)A in S||(this.freeFBO(A),this._tiles[A].unloadVectorData(),delete this._tiles[A])}freeFBO(u){const p=this.proxyCachedFBO[u];if(p!==void 0){const w=Object.values(p);this.renderCachePool.push(...w),delete this.proxyCachedFBO[u]}}deallocRenderCache(){this.renderCache.forEach(u=>u.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class oa extends a.OverscaledTileID{constructor(u,p,w){super(u.overscaledZ,u.wrap,u.canonical.z,u.canonical.x,u.canonical.y),this.proxyTileKey=p,this.projMatrix=w}}class Bo extends a.Elevation{constructor(u,p){super(),this.painter=u,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[w,S,A]=function(F){const Y=new a.StructArrayLayout2i4,X=new a.StructArrayLayout3ui6,ie=131;Y.reserve(17161),X.reserve(33800);const de=a.EXTENT/128,ge=a.EXTENT+de/2,ye=ge+de;for(let xe=-de;xe<ye;xe+=de)for(let ce=-de;ce<ye;ce+=de){const Se=ce<0||ce>ge||xe<0||xe>ge?24575:0,Te=a.clamp(Math.round(ce),0,a.EXTENT),Ae=a.clamp(Math.round(xe),0,a.EXTENT);Y.emplaceBack(Te+Se,Ae)}const ve=(xe,ce)=>{const Se=ce*ie+xe;X.emplaceBack(Se+1,Se,Se+ie),X.emplaceBack(Se+ie,Se+ie+1,Se+1)};for(let xe=1;xe<129;xe++)for(let ce=1;ce<129;ce++)ve(ce,xe);return[0,129].forEach(xe=>{for(let ce=0;ce<130;ce++)ve(ce,xe),ve(xe,ce)}),[Y,X,32768]}(),L=u.context;this.gridBuffer=L.createVertexBuffer(w,a.posAttributes.members),this.gridIndexBuffer=L.createIndexBuffer(S),this.gridSegments=a.SegmentVector.simpleSegment(0,0,w.length,S.length),this.gridNoSkirtSegments=a.SegmentVector.simpleSegment(0,0,w.length,A),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new dl(p.map),this.orthoMatrix=a.create(),a.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,a.EXTENT,0,a.EXTENT,0,1);const B=L.gl;this._overlapStencilMode=new a.StencilMode({func:B.GEQUAL,mask:255},0,255,B.KEEP,B.KEEP,B.REPLACE),this._previousZoom=u.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=p,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new mo(p.map)}set style(u){u.on("data",this._onStyleDataEvent.bind(this)),u.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=u,this._checkRenderCacheEfficiency(),this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(u,p,w){if(u&&u.terrain){this._style!==u&&(this.style=u),this.enabled=!0;const S=u.terrain.properties;this.sourceCache=u.terrain.drapeRenderMode===0?this._mockSourceCache:u._getSourceCache(S.get("source")),this._exaggeration=S.get("exaggeration");const A=()=>{this.sourceCache.used&&a.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const L=this.getScaledDemTileSize();this.sourceCache.update(p,L,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,A(),this._initializing=!0),A(),p.updateElevation(!0,w),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(p),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(u){this._findCoveringTileCache[u]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const u=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||u.efficiency!==100&&a.warnOnce(`Terrain render cache efficiency is not optimal (${u.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${u.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(u){u.coord&&u.dataType==="source"?this._clearRenderCacheForTile(u.sourceCacheId,u.coord):u.dataType==="style"&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const u in this._style._sourceCaches)this._style._sourceCaches[u].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(u=>u.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0)}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const u=2*this.proxySourceCache.getSource().tileSize;return[u,u]}set useVertexMorphing(u){this._useVertexMorphing=u}updateTileBinding(u){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const p=this.proxySourceCache,w=this.painter.transform;this._initializing&&(this._initializing=w._centerAltitude===0&&this.getAtPointOrZero(a.MercatorCoordinate.fromLngLat(w.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const S=this.proxyCoords=p.getIds().map(F=>{const Y=p.getTileByID(F).tileID;return Y.projMatrix=w.calculateProjMatrix(Y.toUnwrapped()),Y});(function(F,Y){const X=Y.transform.pointCoordinate(Y.transform.getCameraPoint()),ie=new a.pointGeometry(X.x,X.y);F.sort((de,ge)=>{if(ge.overscaledZ-de.overscaledZ)return ge.overscaledZ-de.overscaledZ;const ye=new a.pointGeometry(de.canonical.x+(1<<de.canonical.z)*de.wrap,de.canonical.y),ve=new a.pointGeometry(ge.canonical.x+(1<<ge.canonical.z)*ge.wrap,ge.canonical.y),xe=ie.mult(1<<de.canonical.z);return xe.x-=.5,xe.y-=.5,xe.distSqr(ye)-xe.distSqr(ve)})})(S,this.painter),this._previousZoom=w.zoom;const A=this.proxyToSource||{};this.proxyToSource={},S.forEach(F=>{this.proxyToSource[F.key]={}}),this.terrainTileForTile={};const L=this._style._sourceCaches;for(const F in L){const Y=L[F];if(!Y.used||(Y!==this.sourceCache&&this.resetTileLookupCache(Y.id),this._setupProxiedCoordsForOrtho(Y,u[F],A),Y.usedForTerrain))continue;const X=u[F];Y.getSource().reparseOverscaled&&this._assignTerrainTiles(X)}this.proxiedCoords[p.id]=S.map(F=>new oa(F,F.key,this.orthoMatrix)),this._assignTerrainTiles(S),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(A),this.renderingToTexture=!1,this._updateTimestamp=a.exported.now();const B={};this._visibleDemTiles=[];for(const F of this.proxyCoords){const Y=this.terrainTileForTile[F.key];if(!Y)continue;const X=Y.tileID.key;X in B||(this._visibleDemTiles.push(Y),B[X]=X)}}_assignTerrainTiles(u){this._initializing||u.forEach(p=>{if(this.terrainTileForTile[p.key])return;const w=this._findTileCoveringTileID(p,this.sourceCache);w&&(this.terrainTileForTile[p.key]=w)})}_prepareDEMTextures(){const u=this.painter.context,p=u.gl;for(const w in this.terrainTileForTile){const S=this.terrainTileForTile[w],A=S.dem;!A||S.demTexture&&!S.needsDEMTextureUpload||(u.activeTexture.set(p.TEXTURE1),ho(this.painter,S,A))}}_prepareDemTileUniforms(u,p,w,S){if(!p||p.demTexture==null)return!1;const A=u.tileID.canonical,L=Math.pow(2,p.tileID.canonical.z-A.z),B=S||"";return w[`u_dem_tl${B}`]=[A.x*L%1,A.y*L%1],w[`u_dem_scale${B}`]=L,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const u=this.painter.context,p=u.gl;if(!this._emptyDepthBufferTexture){const w=new a.RGBAImage({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new a.Texture(u,w,p.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let u=0;const p=this._visibleDemTiles.reduce((w,S)=>{if(!S.dem)return w;const A=S.dem.tree.minimums[0];return A>0&&u++,w+A},0);return u?p/u:0}_updateEmptyDEMTexture(){const u=this.painter.context,p=u.gl;u.activeTexture.set(p.TEXTURE2);const w=this._getLoadedAreaMinimum(),S=new a.RGBAImage({width:1,height:1},new Uint8Array(a.DEMData.pack(w,this.sourceCache.getSource().encoding)));this._emptyDEMTextureDirty=!1;let A=this._emptyDEMTexture;return A?A.update(S,{premultiply:!1}):A=this._emptyDEMTexture=new a.Texture(u,S,p.RGBA,{premultiply:!1}),A}setupElevationDraw(u,p,w){const S=this.painter.context,A=S.gl,L=(B=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:a.DEMData.getUnpackVector(B),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0});var B;L.u_dem_size=this.sourceCache.getSource().tileSize,L.u_exaggeration=this.exaggeration();let F=null,Y=null,X=1;if(w&&w.morphing&&this._useVertexMorphing){const ie=w.morphing.srcDemTile,de=w.morphing.dstDemTile;X=w.morphing.phase,ie&&de&&(this._prepareDemTileUniforms(u,ie,L,"_prev")&&(Y=ie),this._prepareDemTileUniforms(u,de,L)&&(F=de))}if(Y&&F?(S.activeTexture.set(A.TEXTURE2),F.demTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE,A.NEAREST),S.activeTexture.set(A.TEXTURE4),Y.demTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE,A.NEAREST),L.u_dem_lerp=X):(F=this.terrainTileForTile[u.tileID.key],S.activeTexture.set(A.TEXTURE2),(this._prepareDemTileUniforms(u,F,L)?F.demTexture:this.emptyDEMTexture).bind(A.NEAREST,A.CLAMP_TO_EDGE)),S.activeTexture.set(A.TEXTURE3),w&&w.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE),this._depthFBO&&(L.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE),L.u_depth_size_inv=[1,1]),w&&w.useMeterToDem&&F){const ie=(1<<F.tileID.canonical.z)*a.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;L.u_meter_to_dem=ie}if(w&&w.labelPlaneMatrixInv&&(L.u_label_plane_matrix_inv=w.labelPlaneMatrixInv),p.setTerrainUniformValues(S,L),this.painter.transform.projection.name==="globe"){const ie=this.globeUniformValues(this.painter.transform,u.tileID.canonical,w&&w.useDenormalizedUpVectorScale);p.setGlobeUniformValues(S,ie)}}globeUniformValues(u,p,w){const S=u.projection;return{u_tile_tl_up:S.upVector(p,0,0),u_tile_tr_up:S.upVector(p,a.EXTENT,0),u_tile_br_up:S.upVector(p,a.EXTENT,a.EXTENT),u_tile_bl_up:S.upVector(p,0,a.EXTENT),u_tile_up_scale:w?a.globeMetersToEcef(1):S.upVectorScale(p,u.center.lat,u.worldSize).metersToTile}}renderToBackBuffer(u){const p=this.painter,w=this.painter.context;u.length!==0&&(w.bindFramebuffer.set(null),w.viewport.set([0,0,p.width,p.height]),p.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(S,A,L,B,F){if(S.transform.projection.name==="globe")(function(Y,X,ie,de,ge){const ye=Y.context,ve=ye.gl;let xe,ce;const Se=Y.options.showTerrainWireframe?2:0,Te=Y.transform,Ae=a.globeUseCustomAntiAliasing(Y,ye,Te),Fe=(zt,at)=>{if(ce===zt)return;const Ke=[po[zt],"PROJECTION_GLOBE_VIEW"];Ae&&Ke.push("CUSTOM_ANTIALIASING"),at&&Ke.push(po[Se]),xe=Y.useProgram("globeRaster",null,Ke),ce=zt},$e=Y.colorModeForRenderPass(),qe=new a.DepthMode(ve.LEQUAL,a.DepthMode.ReadWrite,Y.depthRangeFor3D);fo.update(ge);const Je=a.calculateGlobeMercatorMatrix(Te),rt=[a.mercatorXfromLng(Te.center.lng),a.mercatorYfromLat(Te.center.lat)],lt=Se?[!1,!0]:[!1],Jt=Y.globeSharedBuffers,et=[Te.width*a.exported.devicePixelRatio,Te.height*a.exported.devicePixelRatio],Dt=Float32Array.from(Te.globeMatrix),gt={useDenormalizedUpVectorScale:!0};if(lt.forEach(zt=>{const at=Y.transform,Ke=Jn(at.zoom)*X.exaggeration();ce=-1;const ut=zt?ve.LINES:ve.TRIANGLES;for(const Lt of de){const jt=ie.getTile(Lt),Pi=a.StencilMode.disabled,er=X.prevTerrainTileForTile[Lt.key],Si=X.terrainTileForTile[Lt.key];Rs(er,Si)&&fo.newMorphing(Lt.key,er,Si,ge,250),ye.activeTexture.set(ve.TEXTURE0),jt.texture.bind(ve.LINEAR,ve.CLAMP_TO_EDGE);const yi=fo.getMorphValuesForProxy(Lt.key),Oi=yi?1:0;yi&&a.extend$1(gt,{morphing:{srcDemTile:yi.from,dstDemTile:yi.to,phase:a.easeCubicInOut(yi.phase)}});const ar=a.tileCornersToBounds(Lt.canonical),Ui=a.getLatitudinalLod(ar.getCenter().lat),yr=a.getGridMatrix(Lt.canonical,ar,Ui,at.worldSize/at._pixelsPerMercatorPixel),vr=a.globeNormalizeECEF(a.globeTileBounds(Lt.canonical)),Dr=rs(at.projMatrix,Dt,Je,vr,a.globeToMercatorTransition(at.zoom),rt,at.frustumCorners.TL,at.frustumCorners.TR,at.frustumCorners.BR,at.frustumCorners.BL,at.globeCenterInViewSpace,at.globeRadius,et,Ke,yr);if(Fe(Oi,zt),X.setupElevationDraw(jt,xe,gt),Y.prepareDrawProgram(ye,xe,Lt.toUnwrapped()),Jt){const[Ar,sn,Un]=zt?Jt.getWirefameBuffers(Y.context,Ui):Jt.getGridBuffers(Ui,Ke!==0);xe.draw(ye,ut,qe,Pi,$e,a.CullFaceMode.backCCW,Dr,"globe_raster",Ar,sn,Un)}}}),Jt){const zt=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Ae&&zt.push("CUSTOM_ANTIALIASING"),xe=Y.useProgram("globeRaster",null,zt);for(const at of de){const{x:Ke,y:ut,z:Lt}=at.canonical,jt=ut===0,Pi=ut===(1<<Lt)-1,[er,Si,yi,Oi]=Jt.getPoleBuffers(Lt);if(Oi&&(jt||Pi)){const ar=ie.getTile(at);ye.activeTexture.set(ve.TEXTURE0),ar.texture.bind(ve.LINEAR,ve.CLAMP_TO_EDGE);let Ui=a.globePoleMatrixForTile(Lt,Ke,Te);const yr=a.globeNormalizeECEF(a.globeTileBounds(at.canonical)),vr=(Dr,Ar)=>Dr.draw(ye,ve.TRIANGLES,qe,a.StencilMode.disabled,$e,a.CullFaceMode.disabled,rs(Te.projMatrix,Ui,Ui,yr,0,rt,Te.frustumCorners.TL,Te.frustumCorners.TR,Te.frustumCorners.BR,Te.frustumCorners.BL,Te.globeCenterInViewSpace,Te.globeRadius,et,0),"globe_pole_raster",Ar,yi,Oi);X.setupElevationDraw(ar,xe,gt),Y.prepareDrawProgram(ye,xe,at.toUnwrapped()),jt&&vr(xe,er),Pi&&(Ui=a.scale(a.create(),Ui,[1,-1,1]),vr(xe,Si))}}}})(S,A,L,B,F);else{const Y=S.context,X=Y.gl;let ie,de;const ge=S.options.showTerrainWireframe?2:0,ye=(Te,Ae)=>{if(de===Te)return;const Fe=[po[Te]];Ae&&Fe.push(po[ge]),ie=S.useProgram("terrainRaster",null,Fe),de=Te},ve=S.colorModeForRenderPass(),xe=new a.DepthMode(X.LEQUAL,a.DepthMode.ReadWrite,S.depthRangeFor3D);fo.update(F);const ce=S.transform,Se=Jn(ce.zoom)*A.exaggeration();(ge?[!1,!0]:[!1]).forEach(Te=>{de=-1;const Ae=Te?X.LINES:X.TRIANGLES,[Fe,$e]=Te?A.getWirefameBuffer():[A.gridIndexBuffer,A.gridSegments];for(const qe of B){const Je=L.getTile(qe),rt=a.StencilMode.disabled,lt=A.prevTerrainTileForTile[qe.key],Jt=A.terrainTileForTile[qe.key];Rs(lt,Jt)&&fo.newMorphing(qe.key,lt,Jt,F,250),Y.activeTexture.set(X.TEXTURE0),Je.texture.bind(X.LINEAR,X.CLAMP_TO_EDGE,X.LINEAR_MIPMAP_NEAREST);const et=fo.getMorphValuesForProxy(qe.key),Dt=et?1:0;let gt;et&&(gt={morphing:{srcDemTile:et.from,dstDemTile:et.to,phase:a.easeCubicInOut(et.phase)}});const zt=Ds(qe.projMatrix,Xn(qe.canonical,ce.renderWorldCopies)?Se/10:Se);ye(Dt,Te),A.setupElevationDraw(Je,ie,gt),S.prepareDrawProgram(Y,ie,qe.toUnwrapped()),ie.draw(Y,Ae,xe,rt,ve,a.CullFaceMode.backCCW,zt,"terrain_raster",A.gridBuffer,Fe,$e)}})}}(p,this,this.proxySourceCache,u,this._updateTimestamp),this.renderingToTexture=!0,p.gpuTimingDeferredRenderEnd(),u.splice(0,u.length))}renderBatch(u){if(this._drapedRenderBatches.length===0)return u+1;this.renderingToTexture=!0;const p=this.painter,w=this.painter.context,S=this.proxySourceCache,A=this.proxiedCoords[S.id],L=this._drapedRenderBatches.shift(),B=[],F=p.style.order;let Y=0;for(const X of A){const ie=S.getTileByID(X.proxyTileKey),de=S.proxyCachedFBO[X.key]?S.proxyCachedFBO[X.key][u]:void 0,ge=de!==void 0?S.renderCache[de]:this.pool[Y++],ye=de!==void 0;if(ie.texture=ge.tex,ye&&!ge.dirty){B.push(ie.tileID);continue}let ve;w.bindFramebuffer.set(ge.fb.framebuffer),this.renderedToTile=!1,ge.dirty&&(w.clear({color:a.Color.transparent,stencil:0}),ge.dirty=!1);for(let xe=L.start;xe<=L.end;++xe){const ce=p.style._layers[F[xe]];if(ce.isHidden(p.transform.zoom))continue;const Se=p.style._getLayerSourceCache(ce),Te=Se?this.proxyToSource[X.key][Se.id]:[X];if(!Te)continue;const Ae=Te;w.viewport.set([0,0,ge.fb.width,ge.fb.height]),ve!==(Se?Se.id:null)&&(this._setupStencil(ge,Te,ce,Se),ve=Se?Se.id:null),p.renderLayer(p,Se,ce,Ae)}this.renderedToTile?(ge.dirty=!0,B.push(ie.tileID)):ye||--Y,Y===5&&(Y=0,this.renderToBackBuffer(B))}return this.renderToBackBuffer(B),this.renderingToTexture=!1,w.bindFramebuffer.set(null),w.viewport.set([0,0,p.width,p.height]),L.end+1}postRender(){}renderCacheEfficiency(u){const p=u.order.length;if(p===0)return{efficiency:100};let w,S=0,A=0,L=!1;for(let B=0;B<p;++B){const F=u._layers[u.order[B]];this._style.isLayerDraped(F)?(L&&++S,++A):L||(L=!0,w=F.id)}return A===0?{efficiency:100}:{efficiency:100*(1-S/A),firstUndrapedLayer:w}}getMinElevationBelowMSL(){let u=0;return this._visibleDemTiles.filter(p=>p.dem).forEach(p=>{u=Math.min(u,p.dem.tree.minimums[0])}),u===0?u:(u-30)*this._exaggeration}raycast(u,p,w){if(!this._visibleDemTiles)return null;const S=this._visibleDemTiles.filter(A=>A.dem).map(A=>{const L=A.tileID,B=1<<L.overscaledZ,{x:F,y:Y}=L.canonical,X=F/B,ie=(F+1)/B,de=Y/B,ge=(Y+1)/B;return{minx:X,miny:de,maxx:ie,maxy:ge,t:A.dem.tree.raycastRoot(X,de,ie,ge,u,p,w),tile:A}});S.sort((A,L)=>(A.t!==null?A.t:Number.MAX_VALUE)-(L.t!==null?L.t:Number.MAX_VALUE));for(const A of S){if(A.t==null)return null;const L=A.tile.dem.tree.raycast(A.minx,A.miny,A.maxx,A.maxy,u,p,w);if(L!=null)return L}return null}_createFBO(){const u=this.painter.context,p=u.gl,w=this.drapeBufferSize;u.activeTexture.set(p.TEXTURE0);const S=new a.Texture(u,{width:w[0],height:w[1],data:null},p.RGBA);S.bind(p.LINEAR,p.CLAMP_TO_EDGE);const A=u.createFramebuffer(w[0],w[1],!1);return A.colorAttachment.set(S.texture),A.depthAttachment=new He(u,A.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=u.createRenderbuffer(u.gl.DEPTH_STENCIL,w[0],w[1]),this._stencilRef=0,A.depthAttachment.set(this._sharedDepthStencil),u.clear({stencil:0})):A.depthAttachment.set(this._sharedDepthStencil),u.extTextureFilterAnisotropic&&!u.extTextureFilterAnisotropicForceOff&&p.texParameterf(p.TEXTURE_2D,u.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,u.extTextureFilterAnisotropicMax),{fb:A,tex:S,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const u in this._style._sourceCaches)if(this._style._sourceCaches[u].hasTransition())return!0;return this._style.order.some(u=>{const p=this._style._layers[u],w=p.isHidden(this.painter.transform.zoom);return p.type==="custom"?!w&&p.shouldRedrape():!w&&p.hasTransition()})}_clearLineLayersFromRenderCache(){let u=!1;for(const w of this._style._getSources())if(w instanceof Q){u=!0;break}if(!u)return;const p={};for(let w=0;w<this._style.order.length;++w){const S=this._style._layers[this._style.order[w]],A=this._style._getLayerSourceCache(S);if(A&&!p[A.id]&&!S.isHidden(this.painter.transform.zoom)&&S.type==="line"&&S.widthExpression()instanceof a.ZoomDependentExpression){p[A.id]=!0;for(const L of this.proxyCoords){const B=this.proxyToSource[L.key][A.id];if(B)for(const F of B)this._clearRenderCacheForTile(A.id,F)}}}}_clearRasterLayersFromRenderCache(){let u=!1;for(const w in this._style._sourceCaches)if(this._style._sourceCaches[w]._source instanceof ne){u=!0;break}if(!u)return;const p={};for(let w=0;w<this._style.order.length;++w){const S=this._style._layers[this._style.order[w]],A=this._style._getLayerSourceCache(S);if(!A||p[A.id]||S.isHidden(this.painter.transform.zoom)||S.type!=="raster")continue;const L=S.paint.get("raster-fade-duration");for(const B of this.proxyCoords){const F=this.proxyToSource[B.key][A.id];if(F)for(const Y of F){const X=wo(A.getTile(Y),A.findLoadedParent(Y,0),A,this.painter.transform,L);(X.opacity!==1||X.mix!==0)&&this._clearRenderCacheForTile(A.id,Y)}}}}_setupDrapedRenderBatches(){const u=this._style.order,p=u.length;if(p===0)return;const w=[];let S,A=0,L=this._style._layers[u[A]];for(;!this._style.isLayerDraped(L)&&L.isHidden(this.painter.transform.zoom)&&++A<p;)L=this._style._layers[u[A]];for(;A<p;++A){const B=this._style._layers[u[A]];B.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(B)?S===void 0&&(S=A):S!==void 0&&(w.push({start:S,end:A-1}),S=void 0))}S!==void 0&&w.push({start:S,end:A-1}),this._drapedRenderBatches=w}_setupRenderCache(u){const p=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,p.renderCache.length>p.renderCachePool.length){const L=Object.values(p.proxyCachedFBO);p.proxyCachedFBO={};for(let B=0;B<L.length;++B){const F=Object.values(L[B]);p.renderCachePool.push(...F)}}return}this._clearRasterLayersFromRenderCache();const w=this.proxyCoords,S=this._tilesDirty;for(let L=w.length-1;L>=0;L--){const B=w[L];if(p.getTileByID(B.key),p.proxyCachedFBO[B.key]!==void 0){const F=u[B.key],Y=this.proxyToSource[B.key];let X=0;for(const ie in Y){const de=Y[ie],ge=F[ie];if(!ge||ge.length!==de.length||de.some((ye,ve)=>ye!==ge[ve]||S[ie]&&S[ie].hasOwnProperty(ye.key))){X=-1;break}++X}for(const ie in p.proxyCachedFBO[B.key])p.renderCache[p.proxyCachedFBO[B.key][ie]].dirty=X<0||X!==Object.values(F).length}}const A=[...this._drapedRenderBatches];A.sort((L,B)=>B.end-B.start-(L.end-L.start));for(const L of A)for(const B of w){if(p.proxyCachedFBO[B.key])continue;let F=p.renderCachePool.pop();F===void 0&&p.renderCache.length<50&&(F=p.renderCache.length,p.renderCache.push(this._createFBO())),F!==void 0&&(p.proxyCachedFBO[B.key]={},p.proxyCachedFBO[B.key][L.start]=F,p.renderCache[F].dirty=!0)}this._tilesDirty={}}_setupStencil(u,p,w,S){if(!S||!this._sourceTilesOverlap[S.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const A=this.painter.context,L=A.gl;if(p.length<=1)return void(this._overlapStencilType=!1);let B;if(w.isTileClipped())B=p.length,this._overlapStencilMode.test={func:L.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(p[0].overscaledZ>p[p.length-1].overscaledZ))return void(this._overlapStencilType=!1);B=1,this._overlapStencilMode.test={func:L.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+B>255&&(A.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=B,this._overlapStencilMode.ref=this._stencilRef,w.isTileClipped()&&this._renderTileClippingMasks(p,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(u){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[u.key]),this._overlapStencilMode):a.StencilMode.disabled}_renderTileClippingMasks(u,p){const w=this.painter,S=this.painter.context,A=S.gl;w._tileClippingMaskIDs={},S.setColorMode(a.ColorMode.disabled),S.setDepthMode(a.DepthMode.disabled);const L=w.useProgram("clippingMask");for(const B of u){const F=w._tileClippingMaskIDs[B.key]=--p;L.draw(S,A.TRIANGLES,a.DepthMode.disabled,new a.StencilMode({func:A.ALWAYS,mask:0},F,255,A.KEEP,A.KEEP,A.REPLACE),a.ColorMode.disabled,a.CullFaceMode.disabled,Qi(B.projMatrix),"$clipping",w.tileExtentBuffer,w.quadTriangleIndexBuffer,w.tileExtentSegments)}}pointCoordinate(u){const p=this.painter.transform;if(u.x<0||u.x>p.width||u.y<0||u.y>p.height)return null;const w=[u.x,u.y,1,1];a.transformMat4$1(w,w,p.pixelMatrixInverse),a.scale$1(w,w,1/w[3]),w[0]/=p.worldSize,w[1]/=p.worldSize;const S=p._camera.position,A=a.mercatorZfromAltitude(1,p.center.lat),L=[S[0],S[1],S[2]/A,0],B=a.subtract([],w.slice(0,3),L);a.normalize(B,B);const F=this.raycast(L,B,this._exaggeration);return F!==null&&F?(a.scaleAndAdd(L,L,B,F),L[3]=L[2],L[2]*=A,L):null}drawDepth(){const u=this.painter,p=u.context,w=this.proxySourceCache,S=Math.ceil(u.width),A=Math.ceil(u.height);if(!this._depthFBO||this._depthFBO.width===S&&this._depthFBO.height===A||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const L=p.gl,B=p.createFramebuffer(S,A,!0);p.activeTexture.set(L.TEXTURE0);const F=new a.Texture(p,{width:S,height:A,data:null},L.RGBA);F.bind(L.NEAREST,L.CLAMP_TO_EDGE),B.colorAttachment.set(F.texture);const Y=p.createRenderbuffer(p.gl.DEPTH_COMPONENT16,S,A);B.depthAttachment.set(Y),this._depthFBO=B,this._depthTexture=F}p.bindFramebuffer.set(this._depthFBO.framebuffer),p.viewport.set([0,0,S,A]),function(L,B,F,Y){if(L.transform.projection.name==="globe")return;const X=L.context,ie=X.gl;X.clear({depth:1});const de=L.useProgram("terrainDepth"),ge=new a.DepthMode(ie.LESS,a.DepthMode.ReadWrite,L.depthRangeFor3D);for(const ye of Y){const ve=F.getTile(ye),xe=Ds(ye.projMatrix,0);B.setupElevationDraw(ve,de),de.draw(X,ie.TRIANGLES,ge,a.StencilMode.disabled,a.ColorMode.unblended,a.CullFaceMode.backCCW,xe,"terrain_depth",B.gridBuffer,B.gridIndexBuffer,B.gridNoSkirtSegments)}}(u,this,w,this.proxyCoords)}_setupProxiedCoordsForOrtho(u,p,w){if(u.getSource()instanceof Pe)return this._setupProxiedCoordsForImageSource(u,p,w);this._findCoveringTileCache[u.id]=this._findCoveringTileCache[u.id]||{};const S=this.proxiedCoords[u.id]=[],A=this.proxyCoords;for(let B=0;B<A.length;B++){const F=A[B],Y=this._findTileCoveringTileID(F,u);if(Y){const X=this._createProxiedId(F,Y,w[F.key]&&w[F.key][u.id]);S.push(X),this.proxyToSource[F.key][u.id]=[X]}}let L=!1;for(let B=0;B<p.length;B++){const F=u.getTile(p[B]);if(!F||!F.hasData())continue;const Y=this._findTileCoveringTileID(F.tileID,this.proxySourceCache);if(Y&&Y.tileID.canonical.z!==F.tileID.canonical.z){const X=this.proxyToSource[Y.tileID.key][u.id],ie=this._createProxiedId(Y.tileID,F,w[Y.tileID.key]&&w[Y.tileID.key][u.id]);X?X.splice(X.length-1,0,ie):this.proxyToSource[Y.tileID.key][u.id]=[ie],S.push(ie),L=!0}}this._sourceTilesOverlap[u.id]=L}_setupProxiedCoordsForImageSource(u,p,w){if(!u.getSource().loaded())return;const S=this.proxiedCoords[u.id]=[],A=this.proxyCoords,L=u.getSource(),B=new a.pointGeometry(L.tileID.x,L.tileID.y)._div(1<<L.tileID.z),F=L.coordinates.map(a.MercatorCoordinate.fromLngLat).reduce((X,ie)=>(X.min.x=Math.min(X.min.x,ie.x-B.x),X.min.y=Math.min(X.min.y,ie.y-B.y),X.max.x=Math.max(X.max.x,ie.x-B.x),X.max.y=Math.max(X.max.y,ie.y-B.y),X),{min:new a.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new a.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),Y=(X,ie)=>{const de=X.wrap+X.canonical.x/(1<<X.canonical.z),ge=X.canonical.y/(1<<X.canonical.z),ye=a.EXTENT/(1<<X.canonical.z),ve=ie.wrap+ie.canonical.x/(1<<ie.canonical.z),xe=ie.canonical.y/(1<<ie.canonical.z);return de+ye<ve+F.min.x||de>ve+F.max.x||ge+ye<xe+F.min.y||ge>xe+F.max.y};for(let X=0;X<A.length;X++){const ie=A[X];for(let de=0;de<p.length;de++){const ge=u.getTile(p[de]);if(!ge||!ge.hasData()||Y(ie,ge.tileID))continue;const ye=this._createProxiedId(ie,ge,w[ie.key]&&w[ie.key][u.id]),ve=this.proxyToSource[ie.key][u.id];ve?ve.push(ye):this.proxyToSource[ie.key][u.id]=[ye],S.push(ye)}}}_createProxiedId(u,p,w){let S=this.orthoMatrix;if(w){const A=w.find(L=>L.key===p.tileID.key);if(A)return A}if(p.tileID.key!==u.key){const A=u.canonical.z-p.tileID.canonical.z;let L,B,F;S=a.create();const Y=p.tileID.wrap-u.wrap<<u.overscaledZ;A>0?(L=a.EXTENT>>A,B=L*((p.tileID.canonical.x<<A)-u.canonical.x+Y),F=L*((p.tileID.canonical.y<<A)-u.canonical.y)):(L=a.EXTENT<<-A,B=a.EXTENT*(p.tileID.canonical.x-(u.canonical.x+Y<<-A)),F=a.EXTENT*(p.tileID.canonical.y-(u.canonical.y<<-A))),a.ortho(S,0,L,0,L,0,1),a.translate(S,S,[B,F,0])}return new oa(p.tileID,u.key,S)}_findTileCoveringTileID(u,p){let w=p.getTile(u);if(w&&w.hasData())return w;const S=this._findCoveringTileCache[p.id],A=S[u.key];if(w=A?p.getTileByID(A):null,w&&w.hasData()||A===null)return w;let L=w?w.tileID:u,B=L.overscaledZ;const F=p.getSource().minzoom,Y=[];if(!A){const ie=p.getSource().maxzoom;if(u.canonical.z>=ie){const de=u.canonical.z-ie;p.getSource().reparseOverscaled?(B=Math.max(u.canonical.z+2,p.transform.tileZoom),L=new a.OverscaledTileID(B,u.wrap,ie,u.canonical.x>>de,u.canonical.y>>de)):de!==0&&(B=ie,L=new a.OverscaledTileID(B,u.wrap,ie,u.canonical.x>>de,u.canonical.y>>de))}L.key!==u.key&&(Y.push(L.key),w=p.getTile(L))}const X=ie=>{Y.forEach(de=>{S[de]=ie}),Y.length=0};for(B-=1;B>=F&&(!w||!w.hasData());B--){w&&X(w.tileID.key);const ie=L.calculateScaledKey(B);if(w=p.getTileByID(ie),w&&w.hasData())break;const de=S[ie];if(de===null)break;de===void 0?Y.push(ie):w=p.getTileByID(de)}return X(w?w.tileID.key:null),w&&w.hasData()?w:null}findDEMTileFor(u){return this.enabled?this._findTileCoveringTileID(u,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(u,p){let w=this._tilesDirty[u];w||(w=this._tilesDirty[u]={}),w[p.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const u=function(p){let w=0;const S=new a.StructArrayLayout2ui4,A=131;for(let L=1;L<129;L++){for(let B=1;B<129;B++)w=L*A+B,S.emplaceBack(w,w+1),S.emplaceBack(w,w+A),S.emplaceBack(w+1,w+A),L===128&&S.emplaceBack(w+A,w+A+1);S.emplaceBack(w+1,w+1+A)}return S}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(u),this.wireframeSegments=a.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,u.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}class ns{static cacheKey(u,p,w,S){let A=`${p}${S?S.cacheKey:""}`;for(const L of w)u.usedDefines.includes(L)&&(A+=`/${L}`);return A}constructor(u,p,w,S,A,L){const B=u.gl;this.program=B.createProgram();const F=function(ce){const Se=[];for(let Te=0;Te<ce.length;Te++){if(ce[Te]===null)continue;const Ae=ce[Te].split(" ");Se.push(Ae.pop())}return Se}(w.staticAttributes),Y=S?S.getBinderAttributes():[],X=F.concat(Y);let ie=S?S.defines():[];ie=ie.concat(L.map(ce=>`#define ${ce}`));const de=u.isWebGL2?`#version 300 es
`:"",ge=de+ie.concat(u.extStandardDerivatives&&de.length===0?`#extension GL_OES_standard_derivatives : enable
`.concat(es):es,es,Aa,bo.fragmentSource,Ja.fragmentSource,w.fragmentSource).join(`
`),ye=de+ie.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,Aa,bo.vertexSource,Ja.vertexSource,Qa.vertexSource,w.vertexSource).join(`
`),ve=B.createShader(B.FRAGMENT_SHADER);if(B.isContextLost())return void(this.failedToCreate=!0);B.shaderSource(ve,ge),B.compileShader(ve),B.attachShader(this.program,ve);const xe=B.createShader(B.VERTEX_SHADER);if(B.isContextLost())this.failedToCreate=!0;else{B.shaderSource(xe,ye),B.compileShader(xe),B.attachShader(this.program,xe),this.attributes={},this.numAttributes=X.length;for(let ce=0;ce<this.numAttributes;ce++)X[ce]&&(B.bindAttribLocation(this.program,ce,X[ce]),this.attributes[X[ce]]=ce);B.linkProgram(this.program),B.deleteShader(xe),B.deleteShader(ve),this.fixedUniforms=A(u),this.binderUniforms=S?S.getUniforms(u):[],L.includes("TERRAIN")&&(this.terrainUniforms=(ce=>({u_dem:new a.Uniform1i(ce),u_dem_prev:new a.Uniform1i(ce),u_dem_unpack:new a.Uniform4f(ce),u_dem_tl:new a.Uniform2f(ce),u_dem_scale:new a.Uniform1f(ce),u_dem_tl_prev:new a.Uniform2f(ce),u_dem_scale_prev:new a.Uniform1f(ce),u_dem_size:new a.Uniform1f(ce),u_dem_lerp:new a.Uniform1f(ce),u_exaggeration:new a.Uniform1f(ce),u_depth:new a.Uniform1i(ce),u_depth_size_inv:new a.Uniform2f(ce),u_meter_to_dem:new a.Uniform1f(ce),u_label_plane_matrix_inv:new a.UniformMatrix4f(ce)}))(u)),L.includes("GLOBE")&&(this.globeUniforms=(ce=>({u_tile_tl_up:new a.Uniform3f(ce),u_tile_tr_up:new a.Uniform3f(ce),u_tile_br_up:new a.Uniform3f(ce),u_tile_bl_up:new a.Uniform3f(ce),u_tile_up_scale:new a.Uniform1f(ce)}))(u)),L.includes("FOG")&&(this.fogUniforms=(ce=>({u_fog_matrix:new a.UniformMatrix4f(ce),u_fog_range:new a.Uniform2f(ce),u_fog_color:new a.Uniform4f(ce),u_fog_horizon_blend:new a.Uniform1f(ce),u_fog_temporal_offset:new a.Uniform1f(ce),u_frustum_tl:new a.Uniform3f(ce),u_frustum_tr:new a.Uniform3f(ce),u_frustum_br:new a.Uniform3f(ce),u_frustum_bl:new a.Uniform3f(ce),u_globe_pos:new a.Uniform3f(ce),u_globe_radius:new a.Uniform1f(ce),u_globe_transition:new a.Uniform1f(ce),u_is_globe:new a.Uniform1i(ce),u_viewport:new a.Uniform2f(ce)}))(u))}}setTerrainUniformValues(u,p){if(!this.terrainUniforms)return;const w=this.terrainUniforms;if(!this.failedToCreate){u.program.set(this.program);for(const S in p)w[S]&&w[S].set(this.program,S,p[S])}}setGlobeUniformValues(u,p){if(!this.globeUniforms)return;const w=this.globeUniforms;if(!this.failedToCreate){u.program.set(this.program);for(const S in p)w[S]&&w[S].set(this.program,S,p[S])}}setFogUniformValues(u,p){if(!this.fogUniforms)return;const w=this.fogUniforms;if(!this.failedToCreate){u.program.set(this.program);for(const S in p)w[S].set(this.program,S,p[S])}}draw(u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve){const xe=u.gl;if(this.failedToCreate)return;u.program.set(this.program),u.setDepthMode(w),u.setStencilMode(S),u.setColorMode(A),u.setCullFace(L);for(const Se of Object.keys(this.fixedUniforms))this.fixedUniforms[Se].set(this.program,Se,B[Se]);ye&&ye.setUniforms(this.program,u,this.binderUniforms,de,{zoom:ge});const ce={[xe.LINES]:2,[xe.TRIANGLES]:3,[xe.LINE_STRIP]:1}[p];for(const Se of ie.get()){const Te=Se.vaos||(Se.vaos={});(Te[F]||(Te[F]=new Lo)).bind(u,this,Y,ye?ye.getPaintVertexBuffers():[],X,Se.vertexOffset,ve||[]),xe.drawElements(p,Se.primitiveLength*ce,xe.UNSIGNED_SHORT,Se.primitiveOffset*ce*2)}}}function Ps(y,u){const p=Math.pow(2,u.tileID.overscaledZ),w=u.tileSize*Math.pow(2,y.transform.tileZoom)/p,S=w*(u.tileID.canonical.x+u.tileID.wrap*p),A=w*u.tileID.canonical.y;return{u_image:0,u_texsize:u.imageAtlasTexture.size,u_tile_units_to_pixels:1/xt(u,1,y.transform.tileZoom),u_pixel_coord_upper:[S>>16,A>>16],u_pixel_coord_lower:[65535&S,65535&A]}}const Wl=a.create(),os=(y,u,p,w,S,A,L,B,F,Y,X)=>{const ie=u.style.light,de=ie.properties.get("position"),ge=[de.x,de.y,de.z],ye=a.create$1();ie.properties.get("anchor")==="viewport"&&(a.fromRotation(ye,-u.transform.angle),a.transformMat3(ge,ge,ye));const ve=ie.properties.get("color"),xe=u.transform,ce={u_matrix:y,u_lightpos:ge,u_lightintensity:ie.properties.get("intensity"),u_lightcolor:[ve.r,ve.g,ve.b],u_vertical_gradient:+p,u_opacity:w,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Wl,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:S,u_edge_radius:A};return xe.projection.name==="globe"&&(ce.u_tile_id=[L.canonical.x,L.canonical.y,1<<L.canonical.z],ce.u_zoom_transition=F,ce.u_inv_rot_matrix=X,ce.u_merc_center=Y,ce.u_up_dir=xe.projection.upVector(new a.CanonicalTileID(0,0,0),Y[0]*a.EXTENT,Y[1]*a.EXTENT),ce.u_height_lift=B),ce},as=(y,u,p,w,S,A,L,B,F,Y,X,ie)=>{const de=os(y,u,p,w,S,A,L,F,Y,X,ie),ge={u_height_factor:-Math.pow(2,L.overscaledZ)/B.tileSize/8};return a.extend(de,Ps(u,B),ge)},Ia=y=>({u_matrix:y}),Oo=(y,u,p)=>a.extend(Ia(y),Ps(u,p)),zo=(y,u)=>({u_matrix:y,u_world:u}),fl=(y,u,p,w)=>a.extend(Oo(y,u,p),{u_world:w}),Eo=a.create(),ka=(y,u,p,w,S,A)=>{const L=y.transform,B=L.projection.name==="globe";let F;if(A.paint.get("circle-pitch-alignment")==="map")if(B){const X=a.globePixelsToTileUnits(L.zoom,u.canonical)*L._pixelsPerMercatorPixel;F=Float32Array.from([X,0,0,X])}else F=L.calculatePixelsToTileUnitsMatrix(p);else F=new Float32Array([L.pixelsToGLUnits[0],0,0,L.pixelsToGLUnits[1]]);const Y={u_camera_to_center_distance:L.cameraToCenterDistance,u_matrix:y.translatePosMatrix(u.projMatrix,p,A.paint.get("circle-translate"),A.paint.get("circle-translate-anchor")),u_device_pixel_ratio:a.exported.devicePixelRatio,u_extrude_scale:F,u_inv_rot_matrix:Eo,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(B){Y.u_inv_rot_matrix=w,Y.u_merc_center=S,Y.u_tile_id=[u.canonical.x,u.canonical.y,1<<u.canonical.z],Y.u_zoom_transition=a.globeToMercatorTransition(L.zoom);const X=S[0]*a.EXTENT,ie=S[1]*a.EXTENT;Y.u_up_dir=L.projection.upVector(new a.CanonicalTileID(0,0,0),X,ie)}return Y},Yn=y=>{const u=[];return y.paint.get("circle-pitch-alignment")==="map"&&u.push("PITCH_WITH_MAP"),y.paint.get("circle-pitch-scale")==="map"&&u.push("SCALE_WITH_MAP"),u},Ls=(y,u,p,w)=>{const S=a.EXTENT/p.tileSize;return{u_matrix:y,u_camera_to_center_distance:u.getCameraToCenterDistance(w),u_extrude_scale:[u.pixelsToGLUnits[0]/S,u.pixelsToGLUnits[1]/S]}},Da=(y,u,p=1)=>({u_matrix:y,u_color:u,u_overlay:0,u_overlay_scale:p}),aa=a.create(),Nn=(y,u,p,w,S,A,L)=>{const B=y.transform,F=B.projection.name==="globe",Y=F?a.globePixelsToTileUnits(B.zoom,u.canonical)*B._pixelsPerMercatorPixel:xt(p,1,A),X={u_matrix:u.projMatrix,u_extrude_scale:Y,u_intensity:L,u_inv_rot_matrix:aa,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(F){X.u_inv_rot_matrix=w,X.u_merc_center=S,X.u_tile_id=[u.canonical.x,u.canonical.y,1<<u.canonical.z],X.u_zoom_transition=a.globeToMercatorTransition(B.zoom);const ie=S[0]*a.EXTENT,de=S[1]*a.EXTENT;X.u_up_dir=B.projection.upVector(new a.CanonicalTileID(0,0,0),ie,de)}return X},ss=(y,u,p,w,S,A,L)=>{const B=y.transform,F=B.calculatePixelsToTileUnitsMatrix(u);return{u_matrix:Fo(y,u,p,w),u_pixels_to_tile_units:F,u_device_pixel_ratio:A,u_units_to_pixels:[1/B.pixelsToGLUnits[0],1/B.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:S,u_texsize:Pa(p)?u.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Ra(u,y.transform),u_alpha_discard_threshold:0,u_trim_offset:L}},$s=(y,u,p,w,S)=>{const A=y.transform;return{u_matrix:Fo(y,u,p,w),u_texsize:u.imageAtlasTexture.size,u_pixels_to_tile_units:A.calculatePixelsToTileUnitsMatrix(u),u_device_pixel_ratio:S,u_image:0,u_tile_units_to_pixels:Ra(u,A),u_units_to_pixels:[1/A.pixelsToGLUnits[0],1/A.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Ra(y,u){return 1/xt(y,1,u.tileZoom)}function Fo(y,u,p,w){return y.translatePosMatrix(w||u.tileID.projMatrix,u,p.paint.get("line-translate"),p.paint.get("line-translate-anchor"))}function Pa(y){const u=y.paint.get("line-dasharray").value;return u.value||u.kind!=="constant"}const Kl=(y,u,p,w,S,A)=>{return{u_matrix:y,u_tl_parent:u,u_scale_parent:p,u_fade_t:w.mix,u_opacity:w.opacity*S.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:S.paint.get("raster-brightness-min"),u_brightness_high:S.paint.get("raster-brightness-max"),u_saturation_factor:(B=S.paint.get("raster-saturation"),B>0?1-1/(1.001-B):-B),u_contrast_factor:(L=S.paint.get("raster-contrast"),L>0?1/(1-L):1+L),u_spin_weights:Qe(S.paint.get("raster-hue-rotate")),u_perspective_transform:A};var L,B};function Qe(y){y*=Math.PI/180;const u=Math.sin(y),p=Math.cos(y);return[(2*p+1)/3,(-Math.sqrt(3)*u-p+1)/3,(Math.sqrt(3)*u-p+1)/3]}const St=a.create(),fi=(y,u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve)=>{const xe=S.transform,ce={u_is_size_zoom_constant:+(y==="constant"||y==="source"),u_is_size_feature_constant:+(y==="constant"||y==="camera"),u_size_t:u?u.uSizeT:0,u_size:u?u.uSize:0,u_camera_to_center_distance:xe.cameraToCenterDistance,u_rotate_symbol:+p,u_aspect_ratio:xe.width/xe.height,u_fade_change:S.options.fadeDuration?S.symbolFadeChange:1,u_matrix:A,u_label_plane_matrix:L,u_coord_matrix:B,u_is_text:+F,u_pitch_with_map:+w,u_texsize:Y,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:St,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:St,u_up_vector:[0,-1,0]};return ve.name==="globe"&&(ce.u_tile_id=[X.canonical.x,X.canonical.y,1<<X.canonical.z],ce.u_zoom_transition=ie,ce.u_inv_rot_matrix=ge,ce.u_merc_center=de,ce.u_camera_forward=xe._camera.forward(),ce.u_ecef_origin=a.globeECEFOrigin(xe.globeMatrix,X.toUnwrapped()),ce.u_tile_matrix=Float32Array.from(xe.globeMatrix),ce.u_up_vector=ye),ce},ji=(y,u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve,xe)=>a.extend(fi(y,u,p,w,S,A,L,B,F,Y,ie,de,ge,ye,ve,xe),{u_gamma_scale:w?S.transform.cameraToCenterDistance*Math.cos(S.terrain?0:S.transform._pitch):1,u_device_pixel_ratio:a.exported.devicePixelRatio,u_is_halo:+X}),kr=(y,u,p,w,S,A,L,B,F,Y,X,ie,de,ge,ye,ve)=>a.extend(ji(y,u,p,w,S,A,L,B,!0,F,!0,X,ie,de,ge,ye,ve),{u_texsize_icon:Y,u_texture_icon:1}),fr=(y,u,p)=>({u_matrix:y,u_opacity:u,u_color:p}),jr=(y,u,p,w,S)=>a.extend(function(A,L,B){const F=L.imageManager.getPattern(A.toString()),{width:Y,height:X}=L.imageManager.getPixelSize(),ie=Math.pow(2,B.tileID.overscaledZ),de=B.tileSize*Math.pow(2,L.transform.tileZoom)/ie,ge=de*(B.tileID.canonical.x+B.tileID.wrap*ie),ye=de*B.tileID.canonical.y;return{u_image:0,u_pattern_tl:F.tl,u_pattern_br:F.br,u_texsize:[Y,X],u_pattern_size:F.displaySize,u_tile_units_to_pixels:1/xt(B,1,L.transform.tileZoom),u_pixel_coord_upper:[ge>>16,ye>>16],u_pixel_coord_lower:[65535&ge,65535&ye]}}(w,p,S),{u_matrix:y,u_opacity:u}),Jr={fillExtrusion:y=>({u_matrix:new a.UniformMatrix4f(y),u_lightpos:new a.Uniform3f(y),u_lightintensity:new a.Uniform1f(y),u_lightcolor:new a.Uniform3f(y),u_vertical_gradient:new a.Uniform1f(y),u_opacity:new a.Uniform1f(y),u_edge_radius:new a.Uniform1f(y),u_ao:new a.Uniform2f(y),u_tile_id:new a.Uniform3f(y),u_zoom_transition:new a.Uniform1f(y),u_inv_rot_matrix:new a.UniformMatrix4f(y),u_merc_center:new a.Uniform2f(y),u_up_dir:new a.Uniform3f(y),u_height_lift:new a.Uniform1f(y)}),fillExtrusionPattern:y=>({u_matrix:new a.UniformMatrix4f(y),u_lightpos:new a.Uniform3f(y),u_lightintensity:new a.Uniform1f(y),u_lightcolor:new a.Uniform3f(y),u_vertical_gradient:new a.Uniform1f(y),u_height_factor:new a.Uniform1f(y),u_edge_radius:new a.Uniform1f(y),u_ao:new a.Uniform2f(y),u_tile_id:new a.Uniform3f(y),u_zoom_transition:new a.Uniform1f(y),u_inv_rot_matrix:new a.UniformMatrix4f(y),u_merc_center:new a.Uniform2f(y),u_up_dir:new a.Uniform3f(y),u_height_lift:new a.Uniform1f(y),u_image:new a.Uniform1i(y),u_texsize:new a.Uniform2f(y),u_pixel_coord_upper:new a.Uniform2f(y),u_pixel_coord_lower:new a.Uniform2f(y),u_tile_units_to_pixels:new a.Uniform1f(y),u_opacity:new a.Uniform1f(y)}),fill:y=>({u_matrix:new a.UniformMatrix4f(y)}),fillPattern:y=>({u_matrix:new a.UniformMatrix4f(y),u_image:new a.Uniform1i(y),u_texsize:new a.Uniform2f(y),u_pixel_coord_upper:new a.Uniform2f(y),u_pixel_coord_lower:new a.Uniform2f(y),u_tile_units_to_pixels:new a.Uniform1f(y)}),fillOutline:y=>({u_matrix:new a.UniformMatrix4f(y),u_world:new a.Uniform2f(y)}),fillOutlinePattern:y=>({u_matrix:new a.UniformMatrix4f(y),u_world:new a.Uniform2f(y),u_image:new a.Uniform1i(y),u_texsize:new a.Uniform2f(y),u_pixel_coord_upper:new a.Uniform2f(y),u_pixel_coord_lower:new a.Uniform2f(y),u_tile_units_to_pixels:new a.Uniform1f(y)}),circle:y=>({u_camera_to_center_distance:new a.Uniform1f(y),u_extrude_scale:new a.UniformMatrix2f(y),u_device_pixel_ratio:new a.Uniform1f(y),u_matrix:new a.UniformMatrix4f(y),u_inv_rot_matrix:new a.UniformMatrix4f(y),u_merc_center:new a.Uniform2f(y),u_tile_id:new a.Uniform3f(y),u_zoom_transition:new a.Uniform1f(y),u_up_dir:new a.Uniform3f(y)}),collisionBox:y=>({u_matrix:new a.UniformMatrix4f(y),u_camera_to_center_distance:new a.Uniform1f(y),u_extrude_scale:new a.Uniform2f(y)}),collisionCircle:y=>({u_matrix:new a.UniformMatrix4f(y),u_inv_matrix:new a.UniformMatrix4f(y),u_camera_to_center_distance:new a.Uniform1f(y),u_viewport_size:new a.Uniform2f(y)}),debug:y=>({u_color:new a.UniformColor(y),u_matrix:new a.UniformMatrix4f(y),u_overlay:new a.Uniform1i(y),u_overlay_scale:new a.Uniform1f(y)}),clippingMask:y=>({u_matrix:new a.UniformMatrix4f(y)}),heatmap:y=>({u_extrude_scale:new a.Uniform1f(y),u_intensity:new a.Uniform1f(y),u_matrix:new a.UniformMatrix4f(y),u_inv_rot_matrix:new a.UniformMatrix4f(y),u_merc_center:new a.Uniform2f(y),u_tile_id:new a.Uniform3f(y),u_zoom_transition:new a.Uniform1f(y),u_up_dir:new a.Uniform3f(y)}),heatmapTexture:y=>({u_image:new a.Uniform1i(y),u_color_ramp:new a.Uniform1i(y),u_opacity:new a.Uniform1f(y)}),hillshade:y=>({u_matrix:new a.UniformMatrix4f(y),u_image:new a.Uniform1i(y),u_latrange:new a.Uniform2f(y),u_light:new a.Uniform2f(y),u_shadow:new a.UniformColor(y),u_highlight:new a.UniformColor(y),u_accent:new a.UniformColor(y)}),hillshadePrepare:y=>({u_matrix:new a.UniformMatrix4f(y),u_image:new a.Uniform1i(y),u_dimension:new a.Uniform2f(y),u_zoom:new a.Uniform1f(y),u_unpack:new a.Uniform4f(y)}),line:y=>({u_matrix:new a.UniformMatrix4f(y),u_pixels_to_tile_units:new a.UniformMatrix2f(y),u_device_pixel_ratio:new a.Uniform1f(y),u_units_to_pixels:new a.Uniform2f(y),u_dash_image:new a.Uniform1i(y),u_gradient_image:new a.Uniform1i(y),u_image_height:new a.Uniform1f(y),u_texsize:new a.Uniform2f(y),u_tile_units_to_pixels:new a.Uniform1f(y),u_alpha_discard_threshold:new a.Uniform1f(y),u_trim_offset:new a.Uniform2f(y)}),linePattern:y=>({u_matrix:new a.UniformMatrix4f(y),u_texsize:new a.Uniform2f(y),u_pixels_to_tile_units:new a.UniformMatrix2f(y),u_device_pixel_ratio:new a.Uniform1f(y),u_image:new a.Uniform1i(y),u_units_to_pixels:new a.Uniform2f(y),u_tile_units_to_pixels:new a.Uniform1f(y),u_alpha_discard_threshold:new a.Uniform1f(y)}),raster:y=>({u_matrix:new a.UniformMatrix4f(y),u_tl_parent:new a.Uniform2f(y),u_scale_parent:new a.Uniform1f(y),u_fade_t:new a.Uniform1f(y),u_opacity:new a.Uniform1f(y),u_image0:new a.Uniform1i(y),u_image1:new a.Uniform1i(y),u_brightness_low:new a.Uniform1f(y),u_brightness_high:new a.Uniform1f(y),u_saturation_factor:new a.Uniform1f(y),u_contrast_factor:new a.Uniform1f(y),u_spin_weights:new a.Uniform3f(y),u_perspective_transform:new a.Uniform2f(y)}),symbolIcon:y=>({u_is_size_zoom_constant:new a.Uniform1i(y),u_is_size_feature_constant:new a.Uniform1i(y),u_size_t:new a.Uniform1f(y),u_size:new a.Uniform1f(y),u_camera_to_center_distance:new a.Uniform1f(y),u_rotate_symbol:new a.Uniform1i(y),u_aspect_ratio:new a.Uniform1f(y),u_fade_change:new a.Uniform1f(y),u_matrix:new a.UniformMatrix4f(y),u_label_plane_matrix:new a.UniformMatrix4f(y),u_coord_matrix:new a.UniformMatrix4f(y),u_is_text:new a.Uniform1i(y),u_pitch_with_map:new a.Uniform1i(y),u_texsize:new a.Uniform2f(y),u_tile_id:new a.Uniform3f(y),u_zoom_transition:new a.Uniform1f(y),u_inv_rot_matrix:new a.UniformMatrix4f(y),u_merc_center:new a.Uniform2f(y),u_camera_forward:new a.Uniform3f(y),u_tile_matrix:new a.UniformMatrix4f(y),u_up_vector:new a.Uniform3f(y),u_ecef_origin:new a.Uniform3f(y),u_texture:new a.Uniform1i(y)}),symbolSDF:y=>({u_is_size_zoom_constant:new a.Uniform1i(y),u_is_size_feature_constant:new a.Uniform1i(y),u_size_t:new a.Uniform1f(y),u_size:new a.Uniform1f(y),u_camera_to_center_distance:new a.Uniform1f(y),u_rotate_symbol:new a.Uniform1i(y),u_aspect_ratio:new a.Uniform1f(y),u_fade_change:new a.Uniform1f(y),u_matrix:new a.UniformMatrix4f(y),u_label_plane_matrix:new a.UniformMatrix4f(y),u_coord_matrix:new a.UniformMatrix4f(y),u_is_text:new a.Uniform1i(y),u_pitch_with_map:new a.Uniform1i(y),u_texsize:new a.Uniform2f(y),u_texture:new a.Uniform1i(y),u_gamma_scale:new a.Uniform1f(y),u_device_pixel_ratio:new a.Uniform1f(y),u_tile_id:new a.Uniform3f(y),u_zoom_transition:new a.Uniform1f(y),u_inv_rot_matrix:new a.UniformMatrix4f(y),u_merc_center:new a.Uniform2f(y),u_camera_forward:new a.Uniform3f(y),u_tile_matrix:new a.UniformMatrix4f(y),u_up_vector:new a.Uniform3f(y),u_ecef_origin:new a.Uniform3f(y),u_is_halo:new a.Uniform1i(y)}),symbolTextAndIcon:y=>({u_is_size_zoom_constant:new a.Uniform1i(y),u_is_size_feature_constant:new a.Uniform1i(y),u_size_t:new a.Uniform1f(y),u_size:new a.Uniform1f(y),u_camera_to_center_distance:new a.Uniform1f(y),u_rotate_symbol:new a.Uniform1i(y),u_aspect_ratio:new a.Uniform1f(y),u_fade_change:new a.Uniform1f(y),u_matrix:new a.UniformMatrix4f(y),u_label_plane_matrix:new a.UniformMatrix4f(y),u_coord_matrix:new a.UniformMatrix4f(y),u_is_text:new a.Uniform1i(y),u_pitch_with_map:new a.Uniform1i(y),u_texsize:new a.Uniform2f(y),u_texsize_icon:new a.Uniform2f(y),u_texture:new a.Uniform1i(y),u_texture_icon:new a.Uniform1i(y),u_gamma_scale:new a.Uniform1f(y),u_device_pixel_ratio:new a.Uniform1f(y),u_is_halo:new a.Uniform1i(y)}),background:y=>({u_matrix:new a.UniformMatrix4f(y),u_opacity:new a.Uniform1f(y),u_color:new a.UniformColor(y)}),backgroundPattern:y=>({u_matrix:new a.UniformMatrix4f(y),u_opacity:new a.Uniform1f(y),u_image:new a.Uniform1i(y),u_pattern_tl:new a.Uniform2f(y),u_pattern_br:new a.Uniform2f(y),u_texsize:new a.Uniform2f(y),u_pattern_size:new a.Uniform2f(y),u_pixel_coord_upper:new a.Uniform2f(y),u_pixel_coord_lower:new a.Uniform2f(y),u_tile_units_to_pixels:new a.Uniform1f(y)}),terrainRaster:is,terrainDepth:is,skybox:y=>({u_matrix:new a.UniformMatrix4f(y),u_sun_direction:new a.Uniform3f(y),u_cubemap:new a.Uniform1i(y),u_opacity:new a.Uniform1f(y),u_temporal_offset:new a.Uniform1f(y)}),skyboxGradient:y=>({u_matrix:new a.UniformMatrix4f(y),u_color_ramp:new a.Uniform1i(y),u_center_direction:new a.Uniform3f(y),u_radius:new a.Uniform1f(y),u_opacity:new a.Uniform1f(y),u_temporal_offset:new a.Uniform1f(y)}),skyboxCapture:y=>({u_matrix_3f:new a.UniformMatrix3f(y),u_sun_direction:new a.Uniform3f(y),u_sun_intensity:new a.Uniform1f(y),u_color_tint_r:new a.Uniform4f(y),u_color_tint_m:new a.Uniform4f(y),u_luminance:new a.Uniform1f(y)}),globeRaster:y=>({u_proj_matrix:new a.UniformMatrix4f(y),u_globe_matrix:new a.UniformMatrix4f(y),u_normalize_matrix:new a.UniformMatrix4f(y),u_merc_matrix:new a.UniformMatrix4f(y),u_zoom_transition:new a.Uniform1f(y),u_merc_center:new a.Uniform2f(y),u_image0:new a.Uniform1i(y),u_grid_matrix:new a.UniformMatrix3f(y),u_skirt_height:new a.Uniform1f(y),u_frustum_tl:new a.Uniform3f(y),u_frustum_tr:new a.Uniform3f(y),u_frustum_br:new a.Uniform3f(y),u_frustum_bl:new a.Uniform3f(y),u_globe_pos:new a.Uniform3f(y),u_globe_radius:new a.Uniform1f(y),u_viewport:new a.Uniform2f(y)}),globeAtmosphere:y=>({u_frustum_tl:new a.Uniform3f(y),u_frustum_tr:new a.Uniform3f(y),u_frustum_br:new a.Uniform3f(y),u_frustum_bl:new a.Uniform3f(y),u_horizon:new a.Uniform1f(y),u_transition:new a.Uniform1f(y),u_fadeout_range:new a.Uniform1f(y),u_color:new a.Uniform4f(y),u_high_color:new a.Uniform4f(y),u_space_color:new a.Uniform4f(y),u_star_intensity:new a.Uniform1f(y),u_star_density:new a.Uniform1f(y),u_star_size:new a.Uniform1f(y),u_temporal_offset:new a.Uniform1f(y),u_horizon_angle:new a.Uniform1f(y),u_rotation_matrix:new a.UniformMatrix4f(y)})};let fn;function en(y,u,p,w,S,A,L){const B=y.context,F=B.gl,Y=y.transform,X=y.useProgram("collisionBox"),ie=[];let de=0,ge=0;for(let Ae=0;Ae<w.length;Ae++){const Fe=w[Ae],$e=u.getTile(Fe),qe=$e.getBucket(p);if(!qe)continue;const Je=hi(Fe,qe,Y);let rt=Je;S[0]===0&&S[1]===0||(rt=y.translatePosMatrix(Je,$e,S,A));const lt=L?qe.textCollisionBox:qe.iconCollisionBox,Jt=qe.collisionCircleArray;if(Jt.length>0){const et=a.create(),Dt=rt;a.mul(et,qe.placementInvProjMatrix,Y.glCoordMatrix),a.mul(et,et,qe.placementViewportMatrix),ie.push({circleArray:Jt,circleOffset:ge,transform:Dt,invTransform:et,projection:qe.getProjection()}),de+=Jt.length/4,ge=de}lt&&(y.terrain&&y.terrain.setupElevationDraw($e,X),X.draw(B,F.LINES,a.DepthMode.disabled,a.StencilMode.disabled,y.colorModeForRenderPass(),a.CullFaceMode.disabled,Ls(rt,Y,$e,qe.getProjection()),p.id,lt.layoutVertexBuffer,lt.indexBuffer,lt.segments,null,Y.zoom,null,[lt.collisionVertexBuffer,lt.collisionVertexBufferExt]))}if(!L||!ie.length)return;const ye=y.useProgram("collisionCircle"),ve=new a.StructArrayLayout2f1f2i16;ve.resize(4*de),ve._trim();let xe=0;for(const Ae of ie)for(let Fe=0;Fe<Ae.circleArray.length/4;Fe++){const $e=4*Fe,qe=Ae.circleArray[$e+0],Je=Ae.circleArray[$e+1],rt=Ae.circleArray[$e+2],lt=Ae.circleArray[$e+3];ve.emplace(xe++,qe,Je,rt,lt,0),ve.emplace(xe++,qe,Je,rt,lt,1),ve.emplace(xe++,qe,Je,rt,lt,2),ve.emplace(xe++,qe,Je,rt,lt,3)}(!fn||fn.length<2*de)&&(fn=function(Ae){const Fe=2*Ae,$e=new a.StructArrayLayout3ui6;$e.resize(Fe),$e._trim();for(let qe=0;qe<Fe;qe++){const Je=6*qe;$e.uint16[Je+0]=4*qe+0,$e.uint16[Je+1]=4*qe+1,$e.uint16[Je+2]=4*qe+2,$e.uint16[Je+3]=4*qe+2,$e.uint16[Je+4]=4*qe+3,$e.uint16[Je+5]=4*qe+0}return $e}(de));const ce=B.createIndexBuffer(fn,!0),Se=B.createVertexBuffer(ve,a.collisionCircleLayout.members,!0);for(const Ae of ie){const Fe={u_matrix:Ae.transform,u_inv_matrix:Ae.invTransform,u_camera_to_center_distance:(Te=Y).getCameraToCenterDistance(Ae.projection),u_viewport_size:[Te.width,Te.height]};ye.draw(B,F.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,y.colorModeForRenderPass(),a.CullFaceMode.disabled,Fe,p.id,Se,ce,a.SegmentVector.simpleSegment(0,2*Ae.circleOffset,Ae.circleArray.length,Ae.circleArray.length/2),null,Y.zoom)}var Te;Se.destroy(),ce.destroy()}const Xr=a.create();function Wn({width:y,height:u,anchor:p,textOffset:w,textScale:S},A){const{horizontalAlign:L,verticalAlign:B}=a.getAnchorAlignment(p),F=-(L-.5)*y,Y=-(B-.5)*u,X=a.evaluateVariableOffset(p,w);return new a.pointGeometry((F/S+X[0])*A,(Y/S+X[1])*A)}function Mn(y,u,p,w,S,A,L,B,F,Y,X){const ie=y.text.placedSymbolArray,de=y.text.dynamicLayoutVertexArray,ge=y.icon.dynamicLayoutVertexArray,ye={},ve=y.getProjection(),xe=Hi(B,ve,A),ce=A.elevation,Se=ve.upVectorScale(B.canonical,A.center.lat,A.worldSize).metersToTile;de.clear();for(let Te=0;Te<ie.length;Te++){const Ae=ie.get(Te),{tileAnchorX:Fe,tileAnchorY:$e,numGlyphs:qe}=Ae,Je=y.allowVerticalPlacement&&!Ae.placedOrientation,rt=Ae.hidden||!Ae.crossTileID||Je?null:w[Ae.crossTileID];if(rt){let lt=0,Jt=0,et=0;if(ce){const Pi=ce?ce.getAtTileOffset(B,Fe,$e):0,[er,Si,yi]=ve.upVector(B.canonical,Fe,$e);lt=Pi*er*Se,Jt=Pi*Si*Se,et=Pi*yi*Se}let[Dt,gt,zt,at]=ri(Ae.projectedAnchorX+lt,Ae.projectedAnchorY+Jt,Ae.projectedAnchorZ+et,p?xe:L);const Ke=nr(A.getCameraToCenterDistance(ve),at);let ut=S.evaluateSizeForFeature(y.textSizeData,Y,Ae)*Ke/a.ONE_EM;p&&(ut*=y.tilePixelRatio/F);const Lt=Wn(rt,ut);p?({x:Dt,y:gt,z:zt}=ve.projectTilePoint(Fe+Lt.x,$e+Lt.y,B.canonical),[Dt,gt,zt]=ri(Dt+lt,gt+Jt,zt+et,L)):(u&&Lt._rotate(-A.angle),Dt+=Lt.x,gt+=Lt.y,zt=0);const jt=y.allowVerticalPlacement&&Ae.placedOrientation===a.WritingMode.vertical?Math.PI/2:0;for(let Pi=0;Pi<qe;Pi++)a.addDynamicAttributes(de,Dt,gt,zt,jt);X&&Ae.associatedIconIndex>=0&&(ye[Ae.associatedIconIndex]={x:Dt,y:gt,z:zt,angle:jt})}else Ze(qe,de)}if(X){ge.clear();const Te=y.icon.placedSymbolArray;for(let Ae=0;Ae<Te.length;Ae++){const Fe=Te.get(Ae),{numGlyphs:$e}=Fe,qe=ye[Ae];if(Fe.hidden||!qe)Ze($e,ge);else{const{x:Je,y:rt,z:lt,angle:Jt}=qe;for(let et=0;et<$e;et++)a.addDynamicAttributes(ge,Je,rt,lt,Jt)}}y.icon.dynamicLayoutVertexBuffer.updateData(ge)}y.text.dynamicLayoutVertexBuffer.updateData(de)}function vn(y,u,p){return p.iconsInText&&u?"symbolTextAndIcon":y?"symbolSDF":"symbolIcon"}function eo(y,u,p,w,S,A,L,B,F,Y,X,ie){const de=y.context,ge=de.gl,ye=y.transform,ve=B==="map",xe=F==="map",ce=ve&&p.layout.get("symbol-placement")!=="point",Se=ve&&!xe&&!ce,Te=p.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Ae=!1;const Fe=y.depthModeForSublayer(0,a.DepthMode.ReadOnly),$e=[a.mercatorXfromLng(ye.center.lng),a.mercatorYfromLat(ye.center.lat)],qe=p.layout.get("text-variable-anchor"),Je=ye.projection.name==="globe",rt=[],lt=[0,-1,0];let Jt=lt;!Je&&!ye.mercatorFromTransition||ve||(Jt=function(et){const Dt=et._camera.getWorldToCamera(et.worldSize,1),gt=a.multiply([],Dt,et.globeMatrix);a.invert(gt,gt);const zt=[0,0,0],at=[0,1,0,0];return a.transformMat4$1(at,at,gt),zt[0]=at[0],zt[1]=at[1],zt[2]=at[2],a.normalize(zt,zt),zt}(ye));for(const et of w){const Dt=u.getTile(et),gt=Dt.getBucket(p);if(!gt||gt.projection.name==="mercator"&&Je)continue;const zt=S?gt.text:gt.icon;if(!zt||gt.fullyClipped||!zt.segments.get().length)continue;const at=zt.programConfigurations.get(p.id),Ke=S||gt.sdfIcons,ut=S?gt.textSizeData:gt.iconSizeData,Lt=xe||ye.pitch!==0,jt=a.evaluateSizeForZoom(ut,ye.zoom);let Pi,er,Si,yi,Oi=[0,0],ar=null;if(S){if(er=Dt.glyphAtlasTexture,Si=ge.LINEAR,Pi=Dt.glyphAtlasTexture.size,gt.iconsInText){Oi=Dt.imageAtlasTexture.size,ar=Dt.imageAtlasTexture;const Kn=ut.kind==="composite"||ut.kind==="camera";yi=Lt||y.options.rotating||y.options.zooming||Kn?ge.LINEAR:ge.NEAREST}}else{const Kn=p.layout.get("icon-size").constantOr(0)!==1||gt.iconsNeedLinear;er=Dt.imageAtlasTexture,Si=Ke||y.options.rotating||y.options.zooming||Kn||Lt?ge.LINEAR:ge.NEAREST,Pi=Dt.imageAtlasTexture.size}const Ui=gt.projection.name==="globe",yr=Ui?Jt:lt,vr=Ui?a.globeToMercatorTransition(ye.zoom):0,Dr=Hi(et,gt.getProjection(),ye),Ar=ye.calculatePixelsToTileUnitsMatrix(Dt),sn=lo(Dr,Dt.tileID.canonical,xe,ve,ye,gt.getProjection(),Ar),Un=y.terrain&&xe&&ce?a.invert(a.create(),sn):Xr,go=Do(Dr,Dt.tileID.canonical,xe,ve,ye,gt.getProjection(),Ar),Go=qe&&gt.hasTextData(),Fr=p.layout.get("icon-text-fit")!=="none"&&Go&&gt.hasIconData();if(ce){const Kn=ye.elevation,ro=Kn?Kn.getAtTileOffsetFunc(et,ye.center.lat,ye.worldSize,gt.getProjection()):null,Zo=ul(Dr,Dt.tileID.canonical,xe,ve,ye,gt.getProjection(),Ar);$n(gt,Dr,y,S,Zo,go,xe,Y,ro,et)}const Cr=ce||S&&qe||Fr,mr=y.translatePosMatrix(Dr,Dt,A,L),Yr=Cr?Xr:sn,In=y.translatePosMatrix(go,Dt,A,L,!0),$r=gt.getProjection().createInversionMatrix(ye,et.canonical),kn=[];y.terrainRenderModeElevated()&&xe&&kn.push("PITCH_WITH_MAP_TERRAIN"),Ui&&kn.push("PROJECTION_GLOBE_VIEW"),Cr&&kn.push("PROJECTED_POS_ON_VIEWPORT");const Dn=Ke&&p.paint.get(S?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let ua;ua=Ke?gt.iconsInText?kr(ut.kind,jt,Se,xe,y,mr,Yr,In,Pi,Oi,et,vr,$e,$r,yr,gt.getProjection()):ji(ut.kind,jt,Se,xe,y,mr,Yr,In,S,Pi,!0,et,vr,$e,$r,yr,gt.getProjection()):fi(ut.kind,jt,Se,xe,y,mr,Yr,In,S,Pi,et,vr,$e,$r,yr,gt.getProjection());const gs={program:y.useProgram(vn(Ke,S,gt),at,kn),buffers:zt,uniformValues:ua,atlasTexture:er,atlasTextureIcon:ar,atlasInterpolation:Si,atlasInterpolationIcon:yi,isSDF:Ke,hasHalo:Dn,tile:Dt,labelPlaneMatrixInv:Un};if(Te&&gt.canOverlap){Ae=!0;const Kn=zt.segments.get();for(const ro of Kn)rt.push({segments:new a.SegmentVector([ro]),sortKey:ro.sortKey,state:gs})}else rt.push({segments:zt.segments,sortKey:0,state:gs})}Ae&&rt.sort((et,Dt)=>et.sortKey-Dt.sortKey);for(const et of rt){const Dt=et.state;if(y.terrain&&y.terrain.setupElevationDraw(Dt.tile,Dt.program,{useDepthForOcclusion:!Je,labelPlaneMatrixInv:Dt.labelPlaneMatrixInv}),de.activeTexture.set(ge.TEXTURE0),Dt.atlasTexture.bind(Dt.atlasInterpolation,ge.CLAMP_TO_EDGE),Dt.atlasTextureIcon&&(de.activeTexture.set(ge.TEXTURE1),Dt.atlasTextureIcon&&Dt.atlasTextureIcon.bind(Dt.atlasInterpolationIcon,ge.CLAMP_TO_EDGE)),Dt.isSDF){const gt=Dt.uniformValues;Dt.hasHalo&&(gt.u_is_halo=1,No(Dt.buffers,et.segments,p,y,Dt.program,Fe,X,ie,gt)),gt.u_is_halo=0}No(Dt.buffers,et.segments,p,y,Dt.program,Fe,X,ie,Dt.uniformValues)}}function No(y,u,p,w,S,A,L,B,F){const Y=w.context,X=[y.dynamicLayoutVertexBuffer,y.opacityVertexBuffer,y.globeExtVertexBuffer];S.draw(Y,Y.gl.TRIANGLES,A,L,B,a.CullFaceMode.disabled,F,p.id,y.layoutVertexBuffer,y.indexBuffer,u,p.paint,w.transform.zoom,y.programConfigurations.get(p.id),X)}function La(y,u,p,w,S,A,L){const B=y.context.gl,F=p.paint.get("fill-pattern"),Y=F&&F.constantOr(1);let X,ie,de,ge,ye;L?(ie=Y&&!p.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",X=B.LINES):(ie=Y?"fillPattern":"fill",X=B.TRIANGLES);for(const ve of w){const xe=u.getTile(ve);if(Y&&!xe.patternsLoaded())continue;const ce=xe.getBucket(p);if(!ce)continue;y.prepareDrawTile();const Se=ce.programConfigurations.get(p.id),Te=y.useProgram(ie,Se);Y&&(y.context.activeTexture.set(B.TEXTURE0),xe.imageAtlasTexture.bind(B.LINEAR,B.CLAMP_TO_EDGE),Se.updatePaintBuffers());const Ae=F.constantOr(null);if(Ae&&xe.imageAtlas){const $e=xe.imageAtlas.patternPositions[Ae.toString()];$e&&Se.setConstantPatternPositions($e)}const Fe=y.translatePosMatrix(ve.projMatrix,xe,p.paint.get("fill-translate"),p.paint.get("fill-translate-anchor"));if(L){ge=ce.indexBuffer2,ye=ce.segments2;const $e=y.terrain&&y.terrain.renderingToTexture?y.terrain.drapeBufferSize:[B.drawingBufferWidth,B.drawingBufferHeight];de=ie==="fillOutlinePattern"&&Y?fl(Fe,y,xe,$e):zo(Fe,$e)}else ge=ce.indexBuffer,ye=ce.segments,de=Y?Oo(Fe,y,xe):Ia(Fe);y.prepareDrawProgram(y.context,Te,ve.toUnwrapped()),Te.draw(y.context,X,S,y.stencilModeForClipping(ve),A,a.CullFaceMode.disabled,de,p.id,ce.layoutVertexBuffer,ge,ye,p.paint,y.transform.zoom,Se)}}function To(y,u,p,w,S,A,L){const B=y.context,F=B.gl,Y=y.transform,X=p.paint.get("fill-extrusion-pattern"),ie=X.constantOr(1),de=p.paint.get("fill-extrusion-opacity"),ge=[p.paint.get("fill-extrusion-ambient-occlusion-intensity"),p.paint.get("fill-extrusion-ambient-occlusion-radius")],ye=p.layout.get("fill-extrusion-edge-radius"),ve=Y.projection.name==="globe"?a.fillExtrusionHeightLift():0,xe=Y.projection.name==="globe",ce=xe?a.globeToMercatorTransition(Y.zoom):0,Se=[a.mercatorXfromLng(Y.center.lng),a.mercatorYfromLat(Y.center.lat)],Te=[];xe&&Te.push("PROJECTION_GLOBE_VIEW"),ge[0]>0&&Te.push("FAUX_AO");for(const Ae of w){const Fe=u.getTile(Ae),$e=Fe.getBucket(p);if(!$e||$e.projection.name!==Y.projection.name)continue;const qe=$e.programConfigurations.get(p.id),Je=y.useProgram(ie?"fillExtrusionPattern":"fillExtrusion",qe,Te);if(y.terrain){const zt=y.terrain;if(y.style.terrainSetForDrapingOnly())zt.setupElevationDraw(Fe,Je,{useMeterToDem:!0});else{if(!$e.enableTerrain)continue;if(zt.setupElevationDraw(Fe,Je,{useMeterToDem:!0}),$a(B,u,Ae,$e,p,zt),!$e.centroidVertexBuffer){const at=Je.attributes.a_centroid_pos;at!==void 0&&F.vertexAttrib2f(at,0,0)}}}ie&&(y.context.activeTexture.set(F.TEXTURE0),Fe.imageAtlasTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),qe.updatePaintBuffers());const rt=X.constantOr(null);if(rt&&Fe.imageAtlas){const zt=Fe.imageAtlas.patternPositions[rt.toString()];zt&&qe.setConstantPatternPositions(zt)}const lt=y.translatePosMatrix(Ae.projMatrix,Fe,p.paint.get("fill-extrusion-translate"),p.paint.get("fill-extrusion-translate-anchor")),Jt=Y.projection.createInversionMatrix(Y,Ae.canonical),et=p.paint.get("fill-extrusion-vertical-gradient"),Dt=ie?as(lt,y,et,de,ge,ye,Ae,Fe,ve,ce,Se,Jt):os(lt,y,et,de,ge,ye,Ae,ve,ce,Se,Jt);y.prepareDrawProgram(B,Je,Ae.toUnwrapped());const gt=[];y.terrain&&gt.push($e.centroidVertexBuffer),xe&&gt.push($e.layoutVertexExtBuffer),Je.draw(B,B.gl.TRIANGLES,S,A,L,a.CullFaceMode.backCCW,Dt,p.id,$e.layoutVertexBuffer,$e.indexBuffer,$e.segments,p.paint,y.transform.zoom,qe,gt)}}function $a(y,u,p,w,S,A){const L=[ce=>{let Se=ce.canonical.x-1,Te=ce.wrap;return Se<0&&(Se=(1<<ce.canonical.z)-1,Te--),new a.OverscaledTileID(ce.overscaledZ,Te,ce.canonical.z,Se,ce.canonical.y)},ce=>{let Se=ce.canonical.x+1,Te=ce.wrap;return Se===1<<ce.canonical.z&&(Se=0,Te++),new a.OverscaledTileID(ce.overscaledZ,Te,ce.canonical.z,Se,ce.canonical.y)},ce=>new a.OverscaledTileID(ce.overscaledZ,ce.wrap,ce.canonical.z,ce.canonical.x,(ce.canonical.y===0?1<<ce.canonical.z:ce.canonical.y)-1),ce=>new a.OverscaledTileID(ce.overscaledZ,ce.wrap,ce.canonical.z,ce.canonical.x,ce.canonical.y===(1<<ce.canonical.z)-1?0:ce.canonical.y+1)],B=ce=>{const Se=u.getSource().minzoom,Te=Fe=>{const $e=u.getTileByID(Fe);if($e&&$e.hasData())return $e.getBucket(S)},Ae=[0,-1,1];for(const Fe of Ae){if(ce.overscaledZ+Fe<Se)continue;const $e=Te(ce.calculateScaledKey(ce.overscaledZ+Fe));if($e)return $e}},F=[0,0,0],Y=(ce,Se)=>(F[0]=Math.min(ce.min.y,Se.min.y),F[1]=Math.max(ce.max.y,Se.max.y),F[2]=a.EXTENT-Se.min.x>ce.max.x?Se.min.x-a.EXTENT:ce.max.x,F),X=(ce,Se)=>(F[0]=Math.min(ce.min.x,Se.min.x),F[1]=Math.max(ce.max.x,Se.max.x),F[2]=a.EXTENT-Se.min.y>ce.max.y?Se.min.y-a.EXTENT:ce.max.y,F),ie=[(ce,Se)=>Y(ce,Se),(ce,Se)=>Y(Se,ce),(ce,Se)=>X(ce,Se),(ce,Se)=>X(Se,ce)],de=new a.pointGeometry(0,0);let ge,ye,ve;const xe=(ce,Se,Te,Ae,Fe)=>{const $e=[[Ae?Te:ce,Ae?ce:Te,0],[Ae?Te:Se,Ae?Se:Te,0]],qe=Fe<0?a.EXTENT+Fe:Fe,Je=[Ae?qe:(ce+Se)/2,Ae?(ce+Se)/2:qe,0];return Te===0&&Fe<0||Te!==0&&Fe>0?A.getForTilePoints(ve,[Je],!0,ye):$e.push(Je),A.getForTilePoints(p,$e,!0,ge),Math.max($e[0][2],$e[1][2],Je[2])/A.exaggeration()};for(let ce=0;ce<4;ce++){const Se=(ce<2?1:5)-ce,Te=w.borders[ce];if(Te.length===0)continue;const Ae=ve=L[ce](p),Fe=B(Ae);if(!(Fe&&Fe instanceof a.FillExtrusionBucket&&Fe.enableTerrain)||w.borderDoneWithNeighborZ[ce]===Fe.canonical.z&&Fe.borderDoneWithNeighborZ[Se]===w.canonical.z||(ye=A.findDEMTileFor(Ae),!ye||!ye.dem))continue;if(!ge){const rt=A.findDEMTileFor(p);if(!rt||!rt.dem)return;ge=rt}const $e=Fe.borders[Se];let qe=0;const Je=Fe.borderDoneWithNeighborZ[Se]!==w.canonical.z;if(w.canonical.z===Fe.canonical.z){for(let rt=0;rt<Te.length;rt++){const lt=w.featuresOnBorder[Te[rt]],Jt=lt.borders[ce];let et;for(;qe<$e.length&&(et=Fe.featuresOnBorder[$e[qe]],!(et.borders[Se][1]>Jt[0]+3));)Je&&Fe.encodeCentroid(void 0,et,!1),qe++;if(et&&qe<$e.length){const Dt=qe;let gt=0;for(;!(et.borders[Se][0]>Jt[1]-3)&&(gt++,++qe!==$e.length);)et=Fe.featuresOnBorder[$e[qe]];if(et=Fe.featuresOnBorder[$e[Dt]],lt.intersectsCount()>1||et.intersectsCount()>1||gt!==1){gt!==1&&(qe=Dt),w.encodeCentroid(void 0,lt,!1),Je&&Fe.encodeCentroid(void 0,et,!1);continue}const zt=ie[ce](lt,et),at=ce%2?a.EXTENT-1:0;de.x=xe(zt[0],Math.min(a.EXTENT-1,zt[1]),at,ce<2,zt[2]),de.y=0,w.encodeCentroid(de,lt,!1),Je&&Fe.encodeCentroid(de,et,!1)}else w.encodeCentroid(void 0,lt,!1)}w.borderDoneWithNeighborZ[ce]=Fe.canonical.z,w.needsCentroidUpdate=!0,Je&&(Fe.borderDoneWithNeighborZ[Se]=w.canonical.z,Fe.needsCentroidUpdate=!0)}else{for(const rt of Te)w.encodeCentroid(void 0,w.featuresOnBorder[rt],!1);if(Je){for(const rt of $e)Fe.encodeCentroid(void 0,Fe.featuresOnBorder[rt],!1);Fe.borderDoneWithNeighborZ[Se]=w.canonical.z,Fe.needsCentroidUpdate=!0}w.borderDoneWithNeighborZ[ce]=Fe.canonical.z,w.needsCentroidUpdate=!0}}(w.needsCentroidUpdate||!w.centroidVertexBuffer&&w.centroidVertexArray.length!==0)&&w.uploadCentroid(y)}const ls=new a.Color(1,0,0,1),Bs=new a.Color(0,1,0,1),pl=new a.Color(0,0,1,1),Mr=new a.Color(1,0,1,1),xr=new a.Color(0,1,1,1);function sa(y,u,p){const w=y.context,S=y.transform,A=w.gl,L=S.projection.name==="globe",B=L?["PROJECTION_GLOBE_VIEW"]:null;let F=p.projMatrix;if(L&&a.globeToMercatorTransition(S.zoom)>0){const lt=a.transitionTileAABBinECEF(p.canonical,S),Jt=a.globeDenormalizeECEF(lt);F=a.multiply(new Float32Array(16),S.globeMatrix,Jt),a.multiply(F,S.projMatrix,F)}const Y=y.useProgram("debug",null,B),X=u.getTileByID(p.key);y.terrain&&y.terrain.setupElevationDraw(X,Y);const ie=a.DepthMode.disabled,de=a.StencilMode.disabled,ge=y.colorModeForRenderPass(),ye="$debug";w.activeTexture.set(A.TEXTURE0),y.emptyTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),L?X._makeGlobeTileDebugBuffers(y.context,S):X._makeDebugTileBoundsBuffers(y.context,S.projection);const ve=X._tileDebugBuffer||y.debugBuffer,xe=X._tileDebugIndexBuffer||y.debugIndexBuffer,ce=X._tileDebugSegments||y.debugSegments;Y.draw(w,A.LINE_STRIP,ie,de,ge,a.CullFaceMode.disabled,Da(F,a.Color.red),ye,ve,xe,ce,null,null,null,[X._globeTileDebugBorderBuffer]);const Se=X.latestRawTileData,Te=Math.floor((Se&&Se.byteLength||0)/1024),Ae=u.getTile(p).tileSize,Fe=512/Math.min(Ae,512)*(p.overscaledZ/S.zoom)*.5;let $e=p.canonical.toString();p.overscaledZ!==p.canonical.z&&($e+=` => ${p.overscaledZ}`),$e+=` ${Te}kb`,function(lt,Jt){lt.initDebugOverlayCanvas();const et=lt.debugOverlayCanvas,Dt=lt.context.gl,gt=lt.debugOverlayCanvas.getContext("2d");gt.clearRect(0,0,et.width,et.height),gt.shadowColor="white",gt.shadowBlur=2,gt.lineWidth=1.5,gt.strokeStyle="white",gt.textBaseline="top",gt.font="bold 36px Open Sans, sans-serif",gt.fillText(Jt,5,5),gt.strokeText(Jt,5,5),lt.debugOverlayTexture.update(et),lt.debugOverlayTexture.bind(Dt.LINEAR,Dt.CLAMP_TO_EDGE)}(y,$e);const qe=X._tileDebugTextBuffer||y.debugBuffer,Je=X._tileDebugTextIndexBuffer||y.quadTriangleIndexBuffer,rt=X._tileDebugTextSegments||y.debugSegments;Y.draw(w,A.TRIANGLES,ie,de,a.ColorMode.alphaBlended,a.CullFaceMode.disabled,Da(F,a.Color.transparent,Fe),ye,qe,Je,rt,null,null,null,[X._globeTileDebugTextBuffer])}function xn(y,u,p,w){gn(y,0,u+p/2,y.transform.width,p,w)}function So(y,u,p,w){gn(y,u-p/2,0,p,y.transform.height,w)}function gn(y,u,p,w,S,A){const L=y.context,B=L.gl;B.enable(B.SCISSOR_TEST),B.scissor(u*a.exported.devicePixelRatio,p*a.exported.devicePixelRatio,w*a.exported.devicePixelRatio,S*a.exported.devicePixelRatio),L.clear({color:A}),B.disable(B.SCISSOR_TEST)}const An=a.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:On}=An;function zn(y,u,p,w){y.emplaceBack(u,p,w)}class Uo{constructor(u){this.vertexArray=new a.StructArrayLayout3f12,this.indices=new a.StructArrayLayout3ui6,zn(this.vertexArray,-1,-1,1),zn(this.vertexArray,1,-1,1),zn(this.vertexArray,-1,1,1),zn(this.vertexArray,1,1,1),zn(this.vertexArray,-1,-1,-1),zn(this.vertexArray,1,-1,-1),zn(this.vertexArray,-1,1,-1),zn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=u.createVertexBuffer(this.vertexArray,On),this.indexBuffer=u.createIndexBuffer(this.indices),this.segment=a.SegmentVector.simpleSegment(0,0,36,12)}}function Ji(y,u,p,w,S,A){const L=y.gl,B=u.paint.get("sky-atmosphere-color"),F=u.paint.get("sky-atmosphere-halo-color"),Y=u.paint.get("sky-atmosphere-sun-intensity"),X=((ie,de,ge,ye,ve)=>({u_matrix_3f:ie,u_sun_direction:de,u_sun_intensity:ge,u_color_tint_r:[ye.r,ye.g,ye.b,ye.a],u_color_tint_m:[ve.r,ve.g,ve.b,ve.a],u_luminance:5e-5}))(a.fromMat4(a.create$1(),w),S,Y,B,F);L.framebufferTexture2D(L.FRAMEBUFFER,L.COLOR_ATTACHMENT0,L.TEXTURE_CUBE_MAP_POSITIVE_X+A,u.skyboxTexture,0),p.draw(y,L.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,a.ColorMode.unblended,a.CullFaceMode.frontCW,X,"skyboxCapture",u.skyboxGeometry.vertexBuffer,u.skyboxGeometry.indexBuffer,u.skyboxGeometry.segment)}const to=a.createLayout([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class ml{constructor(u){const p=new a.StructArrayLayout5f20;p.emplaceBack(-1,1,1,0,0),p.emplaceBack(1,1,1,1,0),p.emplaceBack(1,-1,1,1,1),p.emplaceBack(-1,-1,1,0,1);const w=new a.StructArrayLayout3ui6;w.emplaceBack(0,1,2),w.emplaceBack(2,3,0),this.vertexBuffer=u.createVertexBuffer(p,to.members),this.indexBuffer=u.createIndexBuffer(w),this.segments=a.SegmentVector.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const la={symbol:function(y,u,p,w,S){if(y.renderPass!=="translucent")return;const A=a.StencilMode.disabled,L=y.colorModeForRenderPass();p.layout.get("text-variable-anchor")&&function(B,F,Y,X,ie,de,ge){const ye=F.transform,ve=ie==="map",xe=de==="map";for(const ce of B){const Se=X.getTile(ce),Te=Se.getBucket(Y);if(!Te||!Te.text||!Te.text.segments.get().length)continue;const Ae=a.evaluateSizeForZoom(Te.textSizeData,ye.zoom),Fe=Hi(ce,Te.getProjection(),ye),$e=ye.calculatePixelsToTileUnitsMatrix(Se),qe=lo(Fe,Se.tileID.canonical,xe,ve,ye,Te.getProjection(),$e),Je=Y.layout.get("icon-text-fit")!=="none"&&Te.hasIconData();if(Ae){const rt=Math.pow(2,ye.zoom-Se.tileID.overscaledZ);Mn(Te,ve,xe,ge,a.symbolSize,ye,qe,ce,rt,Ae,Je)}}}(w,y,p,u,p.layout.get("text-rotation-alignment"),p.layout.get("text-pitch-alignment"),S),p.paint.get("icon-opacity").constantOr(1)!==0&&eo(y,u,p,w,!1,p.paint.get("icon-translate"),p.paint.get("icon-translate-anchor"),p.layout.get("icon-rotation-alignment"),p.layout.get("icon-pitch-alignment"),p.layout.get("icon-keep-upright"),A,L),p.paint.get("text-opacity").constantOr(1)!==0&&eo(y,u,p,w,!0,p.paint.get("text-translate"),p.paint.get("text-translate-anchor"),p.layout.get("text-rotation-alignment"),p.layout.get("text-pitch-alignment"),p.layout.get("text-keep-upright"),A,L),u.map.showCollisionBoxes&&(en(y,u,p,w,p.paint.get("text-translate"),p.paint.get("text-translate-anchor"),!0),en(y,u,p,w,p.paint.get("icon-translate"),p.paint.get("icon-translate-anchor"),!1))},circle:function(y,u,p,w){if(y.renderPass!=="translucent")return;const S=p.paint.get("circle-opacity"),A=p.paint.get("circle-stroke-width"),L=p.paint.get("circle-stroke-opacity"),B=p.layout.get("circle-sort-key").constantOr(1)!==void 0;if(S.constantOr(1)===0&&(A.constantOr(1)===0||L.constantOr(1)===0))return;const F=y.context,Y=F.gl,X=y.transform,ie=y.depthModeForSublayer(0,a.DepthMode.ReadOnly),de=a.StencilMode.disabled,ge=y.colorModeForRenderPass(),ye=X.projection.name==="globe",ve=[a.mercatorXfromLng(X.center.lng),a.mercatorYfromLat(X.center.lat)],xe=[];for(let Se=0;Se<w.length;Se++){const Te=w[Se],Ae=u.getTile(Te),Fe=Ae.getBucket(p);if(!Fe||Fe.projection.name!==X.projection.name)continue;const $e=Fe.programConfigurations.get(p.id),qe=Yn(p);ye&&qe.push("PROJECTION_GLOBE_VIEW");const Je=y.useProgram("circle",$e,qe),rt=Fe.layoutVertexBuffer,lt=Fe.globeExtVertexBuffer,Jt=Fe.indexBuffer,et=X.projection.createInversionMatrix(X,Te.canonical),Dt={programConfiguration:$e,program:Je,layoutVertexBuffer:rt,globeExtVertexBuffer:lt,indexBuffer:Jt,uniformValues:ka(y,Te,Ae,et,ve,p),tile:Ae};if(B){const gt=Fe.segments.get();for(const zt of gt)xe.push({segments:new a.SegmentVector([zt]),sortKey:zt.sortKey,state:Dt})}else xe.push({segments:Fe.segments,sortKey:0,state:Dt})}B&&xe.sort((Se,Te)=>Se.sortKey-Te.sortKey);const ce={useDepthForOcclusion:!ye};for(const Se of xe){const{programConfiguration:Te,program:Ae,layoutVertexBuffer:Fe,globeExtVertexBuffer:$e,indexBuffer:qe,uniformValues:Je,tile:rt}=Se.state,lt=Se.segments;y.terrain&&y.terrain.setupElevationDraw(rt,Ae,ce),y.prepareDrawProgram(F,Ae,rt.tileID.toUnwrapped()),Ae.draw(F,Y.TRIANGLES,ie,de,ge,a.CullFaceMode.disabled,Je,p.id,Fe,qe,lt,p.paint,X.zoom,Te,[$e])}},heatmap:function(y,u,p,w){if(p.paint.get("heatmap-opacity")!==0)if(y.renderPass==="offscreen"){const S=y.context,A=S.gl,L=a.StencilMode.disabled,B=new a.ColorMode([A.ONE,A.ONE],a.Color.transparent,[!0,!0,!0,!0]);(function(ge,ye,ve,xe){const ce=ge.gl,Se=ye.width*xe,Te=ye.height*xe;ge.activeTexture.set(ce.TEXTURE1),ge.viewport.set([0,0,Se,Te]);let Ae=ve.heatmapFbo;if(!Ae||Ae&&(Ae.width!==Se||Ae.height!==Te)){Ae&&Ae.destroy();const Fe=ce.createTexture();ce.bindTexture(ce.TEXTURE_2D,Fe),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_S,ce.CLAMP_TO_EDGE),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_T,ce.CLAMP_TO_EDGE),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MIN_FILTER,ce.LINEAR),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MAG_FILTER,ce.LINEAR),Ae=ve.heatmapFbo=ge.createFramebuffer(Se,Te,!1),function($e,qe,Je,rt,lt,Jt){const et=$e.gl;et.texImage2D(et.TEXTURE_2D,0,$e.isWebGL2&&$e.extRenderToTextureHalfFloat?et.RGBA16F:et.RGBA,lt,Jt,0,et.RGBA,$e.extRenderToTextureHalfFloat?$e.isWebGL2?et.HALF_FLOAT:$e.extTextureHalfFloat.HALF_FLOAT_OES:et.UNSIGNED_BYTE,null),rt.colorAttachment.set(Je)}(ge,0,Fe,Ae,Se,Te)}else ce.bindTexture(ce.TEXTURE_2D,Ae.colorAttachment.get()),ge.bindFramebuffer.set(Ae.framebuffer)})(S,y,p,y.transform.projection.name==="globe"?.5:.25),S.clear({color:a.Color.transparent});const F=y.transform,Y=F.projection.name==="globe",X=Y?["PROJECTION_GLOBE_VIEW"]:null,ie=Y?a.CullFaceMode.frontCCW:a.CullFaceMode.disabled,de=[a.mercatorXfromLng(F.center.lng),a.mercatorYfromLat(F.center.lat)];for(let ge=0;ge<w.length;ge++){const ye=w[ge];if(u.hasRenderableParent(ye))continue;const ve=u.getTile(ye),xe=ve.getBucket(p);if(!xe||xe.projection.name!==F.projection.name)continue;const ce=xe.programConfigurations.get(p.id),Se=y.useProgram("heatmap",ce,X),{zoom:Te}=y.transform;y.terrain&&y.terrain.setupElevationDraw(ve,Se),y.prepareDrawProgram(S,Se,ye.toUnwrapped());const Ae=F.projection.createInversionMatrix(F,ye.canonical);Se.draw(S,A.TRIANGLES,a.DepthMode.disabled,L,B,ie,Nn(y,ye,ve,Ae,de,Te,p.paint.get("heatmap-intensity")),p.id,xe.layoutVertexBuffer,xe.indexBuffer,xe.segments,p.paint,y.transform.zoom,ce,Y?[xe.globeExtVertexBuffer]:null)}S.viewport.set([0,0,y.width,y.height])}else y.renderPass==="translucent"&&(y.context.setColorMode(y.colorModeForRenderPass()),function(S,A){const L=S.context,B=L.gl,F=A.heatmapFbo;if(!F)return;L.activeTexture.set(B.TEXTURE0),B.bindTexture(B.TEXTURE_2D,F.colorAttachment.get()),L.activeTexture.set(B.TEXTURE1);let Y=A.colorRampTexture;Y||(Y=A.colorRampTexture=new a.Texture(L,A.colorRamp,B.RGBA)),Y.bind(B.LINEAR,B.CLAMP_TO_EDGE),S.useProgram("heatmapTexture").draw(L,B.TRIANGLES,a.DepthMode.disabled,a.StencilMode.disabled,S.colorModeForRenderPass(),a.CullFaceMode.disabled,((X,ie,de,ge)=>({u_image:0,u_color_ramp:1,u_opacity:ie.paint.get("heatmap-opacity")}))(0,A),A.id,S.viewportBuffer,S.quadTriangleIndexBuffer,S.viewportSegments,A.paint,S.transform.zoom)}(y,p))},line:function(y,u,p,w){if(y.renderPass!=="translucent")return;const S=p.paint.get("line-opacity"),A=p.paint.get("line-width");if(S.constantOr(1)===0||A.constantOr(1)===0)return;const L=y.depthModeForSublayer(0,a.DepthMode.ReadOnly),B=y.colorModeForRenderPass(),F=y.terrain&&y.terrain.renderingToTexture?1:a.exported.devicePixelRatio,Y=p.paint.get("line-dasharray"),X=Y.constantOr(1),ie=p.layout.get("line-cap"),de=p.paint.get("line-pattern"),ge=de.constantOr(1),ye=p.paint.get("line-gradient"),ve=ge?"linePattern":"line",xe=y.context,ce=xe.gl,Se=(Ae=>{const Fe=[];Pa(Ae)&&Fe.push("RENDER_LINE_DASH"),Ae.paint.get("line-gradient")&&Fe.push("RENDER_LINE_GRADIENT");const $e=Ae.paint.get("line-trim-offset");$e[0]===0&&$e[1]===0||Fe.push("RENDER_LINE_TRIM_OFFSET");const qe=Ae.paint.get("line-pattern").constantOr(1),Je=Ae.paint.get("line-opacity").constantOr(1)!==1;return!qe&&Je&&Fe.push("RENDER_LINE_ALPHA_DISCARD"),Fe})(p);let Te=Se.includes("RENDER_LINE_ALPHA_DISCARD");y.terrain&&y.terrain.clipOrMaskOverlapStencilType()&&(Te=!1);for(const Ae of w){const Fe=u.getTile(Ae);if(ge&&!Fe.patternsLoaded())continue;const $e=Fe.getBucket(p);if(!$e)continue;y.prepareDrawTile();const qe=$e.programConfigurations.get(p.id),Je=y.useProgram(ve,qe,Se),rt=de.constantOr(null);if(rt&&Fe.imageAtlas){const Ke=Fe.imageAtlas.patternPositions[rt.toString()];Ke&&qe.setConstantPatternPositions(Ke)}const lt=Y.constantOr(null),Jt=ie.constantOr(null);if(!ge&&lt&&Jt&&Fe.lineAtlas){const Ke=Fe.lineAtlas.getDash(lt,Jt);Ke&&qe.setConstantPatternPositions(Ke)}let[et,Dt]=p.paint.get("line-trim-offset");(Jt==="round"||Jt==="square")&&et!==Dt&&(et===0&&(et-=1),Dt===1&&(Dt+=1));const gt=y.terrain?Ae.projMatrix:null,zt=ge?$s(y,Fe,p,gt,F):ss(y,Fe,p,gt,$e.lineClipsArray.length,F,[et,Dt]);if(ye){const Ke=$e.gradients[p.id];let ut=Ke.texture;if(p.gradientVersion!==Ke.version){let Lt=256;if(p.stepInterpolant){const jt=u.getSource().maxzoom,Pi=Ae.canonical.z===jt?Math.ceil(1<<y.transform.maxZoom-Ae.canonical.z):1;Lt=a.clamp(a.nextPowerOfTwo($e.maxLineLength/a.EXTENT*1024*Pi),256,xe.maxTextureSize)}Ke.gradient=a.renderColorRamp({expression:p.gradientExpression(),evaluationKey:"lineProgress",resolution:Lt,image:Ke.gradient||void 0,clips:$e.lineClipsArray}),Ke.texture?Ke.texture.update(Ke.gradient):Ke.texture=new a.Texture(xe,Ke.gradient,ce.RGBA),Ke.version=p.gradientVersion,ut=Ke.texture}xe.activeTexture.set(ce.TEXTURE1),ut.bind(p.stepInterpolant?ce.NEAREST:ce.LINEAR,ce.CLAMP_TO_EDGE)}X&&(xe.activeTexture.set(ce.TEXTURE0),Fe.lineAtlasTexture.bind(ce.LINEAR,ce.REPEAT),qe.updatePaintBuffers()),ge&&(xe.activeTexture.set(ce.TEXTURE0),Fe.imageAtlasTexture.bind(ce.LINEAR,ce.CLAMP_TO_EDGE),qe.updatePaintBuffers()),y.prepareDrawProgram(xe,Je,Ae.toUnwrapped());const at=Ke=>{Je.draw(xe,ce.TRIANGLES,L,Ke,B,a.CullFaceMode.disabled,zt,p.id,$e.layoutVertexBuffer,$e.indexBuffer,$e.segments,p.paint,y.transform.zoom,qe,[$e.layoutVertexBuffer2])};if(Te){const Ke=y.stencilModeForClipping(Ae).ref;Ke===0&&y.terrain&&xe.clear({stencil:0});const ut={func:ce.EQUAL,mask:255};zt.u_alpha_discard_threshold=.8,at(new a.StencilMode(ut,Ke,255,ce.KEEP,ce.KEEP,ce.INVERT)),zt.u_alpha_discard_threshold=0,at(new a.StencilMode(ut,Ke,255,ce.KEEP,ce.KEEP,ce.KEEP))}else at(y.stencilModeForClipping(Ae))}Te&&(y.resetStencilClippingMasks(),y.terrain&&xe.clear({stencil:0}))},fill:function(y,u,p,w){const S=p.paint.get("fill-color"),A=p.paint.get("fill-opacity");if(A.constantOr(1)===0)return;const L=y.colorModeForRenderPass(),B=p.paint.get("fill-pattern"),F=y.opaquePassEnabledForLayer()&&!B.constantOr(1)&&S.constantOr(a.Color.transparent).a===1&&A.constantOr(0)===1?"opaque":"translucent";if(y.renderPass===F){const Y=y.depthModeForSublayer(1,y.renderPass==="opaque"?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly);La(y,u,p,w,Y,L,!1)}if(y.renderPass==="translucent"&&p.paint.get("fill-antialias")){const Y=y.depthModeForSublayer(p.getPaintProperty("fill-outline-color")?2:0,a.DepthMode.ReadOnly);La(y,u,p,w,Y,L,!0)}},"fill-extrusion":function(y,u,p,w){const S=p.paint.get("fill-extrusion-opacity");if(S!==0&&y.renderPass==="translucent"){const A=new a.DepthMode(y.context.gl.LEQUAL,a.DepthMode.ReadWrite,y.depthRangeFor3D);if(S!==1||p.paint.get("fill-extrusion-pattern").constantOr(1))To(y,u,p,w,A,a.StencilMode.disabled,a.ColorMode.disabled),To(y,u,p,w,A,y.stencilModeFor3D(),y.colorModeForRenderPass()),y.resetStencilClippingMasks();else{const L=y.colorModeForRenderPass();To(y,u,p,w,A,a.StencilMode.disabled,L)}}},hillshade:function(y,u,p,w){if(y.renderPass!=="offscreen"&&y.renderPass!=="translucent")return;const S=y.context,A=y.depthModeForSublayer(0,a.DepthMode.ReadOnly),L=y.colorModeForRenderPass(),B=y.terrain&&y.terrain.renderingToTexture,[F,Y]=y.renderPass!=="translucent"||B?[{},w]:y.stencilConfigForOverlap(w);for(const X of Y){const ie=u.getTile(X);if(ie.needsHillshadePrepare&&y.renderPass==="offscreen")ts(y,ie,p,A,a.StencilMode.disabled,L);else if(y.renderPass==="translucent"){const de=B&&y.terrain?y.terrain.stencilModeForRTTOverlap(X):F[X.overscaledZ];$o(y,X,ie,p,A,de,L)}}S.viewport.set([0,0,y.width,y.height]),y.resetStencilClippingMasks()},raster:function(y,u,p,w,S,A){if(y.renderPass!=="translucent"||p.paint.get("raster-opacity")===0||!w.length)return;const L=y.context,B=L.gl,F=u.getSource(),Y=y.useProgram("raster"),X=y.colorModeForRenderPass(),ie=y.terrain&&y.terrain.renderingToTexture,[de,ge]=F instanceof Pe||ie?[{},w]:y.stencilConfigForOverlap(w),ye=ge[ge.length-1].overscaledZ,ve=!y.options.moving;for(const xe of ge){const ce=ie?a.DepthMode.disabled:y.depthModeForSublayer(xe.overscaledZ-ye,p.paint.get("raster-opacity")===1?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly,B.LESS),Se=xe.toUnwrapped(),Te=u.getTile(xe);if(ie&&(!Te||!Te.hasData()))continue;const Ae=ie?xe.projMatrix:y.transform.calculateProjMatrix(Se,ve),Fe=y.terrain&&ie?y.terrain.stencilModeForRTTOverlap(xe):de[xe.overscaledZ],$e=A?0:p.paint.get("raster-fade-duration");Te.registerFadeDuration($e);const qe=u.findLoadedParent(xe,0),Je=wo(Te,qe,u,y.transform,$e);let rt,lt;y.terrain&&y.terrain.prepareDrawTile();const Jt=p.paint.get("raster-resampling")==="nearest"?B.NEAREST:B.LINEAR;L.activeTexture.set(B.TEXTURE0),Te.texture.bind(Jt,B.CLAMP_TO_EDGE),L.activeTexture.set(B.TEXTURE1),qe?(qe.texture.bind(Jt,B.CLAMP_TO_EDGE),rt=Math.pow(2,qe.tileID.overscaledZ-Te.tileID.overscaledZ),lt=[Te.tileID.canonical.x*rt%1,Te.tileID.canonical.y*rt%1]):Te.texture.bind(Jt,B.CLAMP_TO_EDGE),Te.texture.useMipmap&&L.extTextureFilterAnisotropic&&y.transform.pitch>20&&B.texParameterf(B.TEXTURE_2D,L.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,L.extTextureFilterAnisotropicMax);const et=Kl(Ae,lt||[0,0],rt||1,Je,p,F instanceof Pe?F.perspectiveTransform:[0,0]);if(y.prepareDrawProgram(L,Y,Se),F instanceof Pe)F.boundsBuffer&&F.boundsSegments&&Y.draw(L,B.TRIANGLES,ce,a.StencilMode.disabled,X,a.CullFaceMode.disabled,et,p.id,F.boundsBuffer,y.quadTriangleIndexBuffer,F.boundsSegments);else{const{tileBoundsBuffer:Dt,tileBoundsIndexBuffer:gt,tileBoundsSegments:zt}=y.getTileBoundsBuffers(Te);Y.draw(L,B.TRIANGLES,ce,Fe,X,a.CullFaceMode.disabled,et,p.id,Dt,gt,zt)}}y.resetStencilClippingMasks()},background:function(y,u,p,w){const S=p.paint.get("background-color"),A=p.paint.get("background-opacity");if(A===0)return;const L=y.context,B=L.gl,F=y.transform,Y=F.tileSize,X=p.paint.get("background-pattern");if(y.isPatternMissing(X))return;const ie=!X&&S.a===1&&A===1&&y.opaquePassEnabledForLayer()?"opaque":"translucent";if(y.renderPass!==ie)return;const de=a.StencilMode.disabled,ge=y.depthModeForSublayer(0,ie==="opaque"?a.DepthMode.ReadWrite:a.DepthMode.ReadOnly),ye=y.colorModeForRenderPass(),ve=y.useProgram(X?"backgroundPattern":"background");let xe,ce=w;ce||(xe=y.getBackgroundTiles(),ce=Object.values(xe).map(Se=>Se.tileID)),X&&(L.activeTexture.set(B.TEXTURE0),y.imageManager.bind(y.context));for(const Se of ce){const Te=Se.toUnwrapped(),Ae=w?Se.projMatrix:y.transform.calculateProjMatrix(Te);y.prepareDrawTile();const Fe=u?u.getTile(Se):xe?xe[Se.key]:new a.Tile(Se,Y,F.zoom,y),$e=X?jr(Ae,A,y,X,{tileID:Se,tileSize:Y}):fr(Ae,A,S);y.prepareDrawProgram(L,ve,Te);const{tileBoundsBuffer:qe,tileBoundsIndexBuffer:Je,tileBoundsSegments:rt}=y.getTileBoundsBuffers(Fe);ve.draw(L,B.TRIANGLES,ge,de,ye,a.CullFaceMode.disabled,$e,p.id,qe,Je,rt)}},sky:function(y,u,p){const w=y.transform,S=w.projection.name==="mercator"||w.projection.name==="globe"?1:a.smoothstep(7,8,w.zoom),A=p.paint.get("sky-opacity")*S;if(A===0)return;const L=y.context,B=p.paint.get("sky-type"),F=new a.DepthMode(L.gl.LEQUAL,a.DepthMode.ReadOnly,[0,1]),Y=y.frameCounter/1e3%1;B==="atmosphere"?y.renderPass==="offscreen"?p.needsSkyboxCapture(y)&&(function(X,ie,de,ge){const ye=X.context,ve=ye.gl;let xe=ie.skyboxFbo;if(!xe){xe=ie.skyboxFbo=ye.createFramebuffer(32,32,!1),ie.skyboxGeometry=new Uo(ye),ie.skyboxTexture=ye.gl.createTexture(),ve.bindTexture(ve.TEXTURE_CUBE_MAP,ie.skyboxTexture),ve.texParameteri(ve.TEXTURE_CUBE_MAP,ve.TEXTURE_WRAP_S,ve.CLAMP_TO_EDGE),ve.texParameteri(ve.TEXTURE_CUBE_MAP,ve.TEXTURE_WRAP_T,ve.CLAMP_TO_EDGE),ve.texParameteri(ve.TEXTURE_CUBE_MAP,ve.TEXTURE_MIN_FILTER,ve.LINEAR),ve.texParameteri(ve.TEXTURE_CUBE_MAP,ve.TEXTURE_MAG_FILTER,ve.LINEAR);for(let Ae=0;Ae<6;++Ae)ve.texImage2D(ve.TEXTURE_CUBE_MAP_POSITIVE_X+Ae,0,ve.RGBA,32,32,0,ve.RGBA,ve.UNSIGNED_BYTE,null)}ye.bindFramebuffer.set(xe.framebuffer),ye.viewport.set([0,0,32,32]);const ce=ie.getCenter(X,!0),Se=X.useProgram("skyboxCapture"),Te=new Float64Array(16);a.identity(Te),a.rotateY(Te,Te,.5*-Math.PI),Ji(ye,ie,Se,Te,ce,0),a.identity(Te),a.rotateY(Te,Te,.5*Math.PI),Ji(ye,ie,Se,Te,ce,1),a.identity(Te),a.rotateX(Te,Te,.5*-Math.PI),Ji(ye,ie,Se,Te,ce,2),a.identity(Te),a.rotateX(Te,Te,.5*Math.PI),Ji(ye,ie,Se,Te,ce,3),a.identity(Te),Ji(ye,ie,Se,Te,ce,4),a.identity(Te),a.rotateY(Te,Te,Math.PI),Ji(ye,ie,Se,Te,ce,5),ye.viewport.set([0,0,X.width,X.height])}(y,p),p.markSkyboxValid(y)):y.renderPass==="sky"&&function(X,ie,de,ge,ye){const ve=X.context,xe=ve.gl,ce=X.transform,Se=X.useProgram("skybox");ve.activeTexture.set(xe.TEXTURE0),xe.bindTexture(xe.TEXTURE_CUBE_MAP,ie.skyboxTexture);const Te=((Ae,Fe,$e,qe,Je)=>({u_matrix:Ae,u_sun_direction:Fe,u_cubemap:0,u_opacity:qe,u_temporal_offset:Je}))(ce.skyboxMatrix,ie.getCenter(X,!1),0,ge,ye);X.prepareDrawProgram(ve,Se),Se.draw(ve,xe.TRIANGLES,de,a.StencilMode.disabled,X.colorModeForRenderPass(),a.CullFaceMode.backCW,Te,"skybox",ie.skyboxGeometry.vertexBuffer,ie.skyboxGeometry.indexBuffer,ie.skyboxGeometry.segment)}(y,p,F,A,Y):B==="gradient"&&y.renderPass==="sky"&&function(X,ie,de,ge,ye){const ve=X.context,xe=ve.gl,ce=X.transform,Se=X.useProgram("skyboxGradient");ie.skyboxGeometry||(ie.skyboxGeometry=new Uo(ve)),ve.activeTexture.set(xe.TEXTURE0);let Te=ie.colorRampTexture;Te||(Te=ie.colorRampTexture=new a.Texture(ve,ie.colorRamp,xe.RGBA)),Te.bind(xe.LINEAR,xe.CLAMP_TO_EDGE);const Ae=((Fe,$e,qe,Je,rt)=>({u_matrix:Fe,u_color_ramp:0,u_center_direction:$e,u_radius:a.degToRad(qe),u_opacity:Je,u_temporal_offset:rt}))(ce.skyboxMatrix,ie.getCenter(X,!1),ie.paint.get("sky-gradient-radius"),ge,ye);X.prepareDrawProgram(ve,Se),Se.draw(ve,xe.TRIANGLES,de,a.StencilMode.disabled,X.colorModeForRenderPass(),a.CullFaceMode.backCW,Ae,"skyboxGradient",ie.skyboxGeometry.vertexBuffer,ie.skyboxGeometry.indexBuffer,ie.skyboxGeometry.segment)}(y,p,F,A,Y)},debug:function(y,u,p){for(let w=0;w<p.length;w++)sa(y,u,p[w])},custom:function(y,u,p,w){const S=y.context,A=p.implementation;if(!y.transform.projection.unsupportedLayers||!y.transform.projection.unsupportedLayers.includes("custom")||y.terrain&&(y.terrain.renderingToTexture||y.renderPass==="offscreen")&&p.isLayerDraped()){if(y.renderPass==="offscreen"){const L=A.prerender;if(L){if(y.setCustomLayerDefaults(),S.setColorMode(y.colorModeForRenderPass()),y.transform.projection.name==="globe"){const B=y.transform.pointMerc;L.call(A,S.gl,y.transform.customLayerMatrix(),y.transform.getProjection(),y.transform.globeToMercatorMatrix(),a.globeToMercatorTransition(y.transform.zoom),[B.x,B.y],y.transform.pixelsPerMeterRatio)}else L.call(A,S.gl,y.transform.customLayerMatrix());S.setDirty(),y.setBaseState()}}else if(y.renderPass==="translucent"){if(y.terrain&&y.terrain.renderingToTexture){const B=A.renderToTile;if(B){const F=w[0].canonical,Y=new a.MercatorCoordinate(F.x+w[0].wrap*(1<<F.z),F.y,F.z);S.setDepthMode(a.DepthMode.disabled),S.setStencilMode(a.StencilMode.disabled),S.setColorMode(y.colorModeForRenderPass()),y.setCustomLayerDefaults(),B.call(A,S.gl,Y),S.setDirty(),y.setBaseState()}return}y.setCustomLayerDefaults(),S.setColorMode(y.colorModeForRenderPass()),S.setStencilMode(a.StencilMode.disabled);const L=A.renderingMode==="3d"?new a.DepthMode(y.context.gl.LEQUAL,a.DepthMode.ReadWrite,y.depthRangeFor3D):y.depthModeForSublayer(0,a.DepthMode.ReadOnly);if(S.setDepthMode(L),y.transform.projection.name==="globe"){const B=y.transform.pointMerc;A.render(S.gl,y.transform.customLayerMatrix(),y.transform.getProjection(),y.transform.globeToMercatorMatrix(),a.globeToMercatorTransition(y.transform.zoom),[B.x,B.y],y.transform.pixelsPerMeterRatio)}else A.render(S.gl,y.transform.customLayerMatrix());S.setDirty(),y.setBaseState(),S.bindFramebuffer.set(null)}}else a.warnOnce("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")}};class Vo{constructor(u,p,w=!1){this.context=new le(u,w),this.transform=p,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=a.SourceCache.maxUnderzooming+a.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Cs,this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={}}updateTerrain(u,p){const w=!!u&&!!u.terrain&&this.transform.projection.supportsTerrain;if(!(w||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Bo(this,u));const S=this._terrain;this.transform.elevation=w?S:null,S.update(u,this.transform,p)}_updateFog(u){const p=u.fog;if(!p||this.transform.projection.name==="globe"||p.getOpacity(this.transform.pitch)<1||p.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[w,S]=p.getFovAdjustedRange(this.transform._fov);if(w>S)return void(this.transform.fogCullDistSq=null);const A=w+.78*(S-w);this.transform.fogCullDistSq=A*A}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(u,p){if(this.width=u*a.exported.devicePixelRatio,this.height=p*a.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const w of this.style.order)this.style._layers[w].resize()}setup(){const u=this.context,p=new a.StructArrayLayout2i4;p.emplaceBack(0,0),p.emplaceBack(a.EXTENT,0),p.emplaceBack(0,a.EXTENT),p.emplaceBack(a.EXTENT,a.EXTENT),this.tileExtentBuffer=u.createVertexBuffer(p,a.posAttributes.members),this.tileExtentSegments=a.SegmentVector.simpleSegment(0,0,4,2);const w=new a.StructArrayLayout2i4;w.emplaceBack(0,0),w.emplaceBack(a.EXTENT,0),w.emplaceBack(0,a.EXTENT),w.emplaceBack(a.EXTENT,a.EXTENT),this.debugBuffer=u.createVertexBuffer(w,a.posAttributes.members),this.debugSegments=a.SegmentVector.simpleSegment(0,0,4,5);const S=new a.StructArrayLayout2i4;S.emplaceBack(-1,-1),S.emplaceBack(1,-1),S.emplaceBack(-1,1),S.emplaceBack(1,1),this.viewportBuffer=u.createVertexBuffer(S,a.posAttributes.members),this.viewportSegments=a.SegmentVector.simpleSegment(0,0,4,2);const A=new a.StructArrayLayout4i8;A.emplaceBack(0,0,0,0),A.emplaceBack(a.EXTENT,0,a.EXTENT,0),A.emplaceBack(0,a.EXTENT,0,a.EXTENT),A.emplaceBack(a.EXTENT,a.EXTENT,a.EXTENT,a.EXTENT),this.mercatorBoundsBuffer=u.createVertexBuffer(A,a.boundsAttributes.members),this.mercatorBoundsSegments=a.SegmentVector.simpleSegment(0,0,4,2);const L=new a.StructArrayLayout3ui6;L.emplaceBack(0,1,2),L.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=u.createIndexBuffer(L);const B=new a.StructArrayLayout1ui2;for(const Y of[0,1,3,2,0])B.emplaceBack(Y);this.debugIndexBuffer=u.createIndexBuffer(B),this.emptyTexture=new a.Texture(u,new a.RGBAImage({width:1,height:1},Uint8Array.of(0,0,0,0)),u.gl.RGBA),this.identityMat=a.create();const F=this.context.gl;this.stencilClearMode=new a.StencilMode({func:F.ALWAYS,mask:0},0,255,F.ZERO,F.ZERO,F.ZERO),this.loadTimeStamps.push(a.window.performance.now()),this.atmosphereBuffer=new ml(this.context)}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(u){return u._makeTileBoundsBuffers(this.context,this.transform.projection),u._tileBoundsBuffer?{tileBoundsBuffer:u._tileBoundsBuffer,tileBoundsIndexBuffer:u._tileBoundsIndexBuffer,tileBoundsSegments:u._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const u=this.context,p=u.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(u,p.TRIANGLES,a.DepthMode.disabled,this.stencilClearMode,a.ColorMode.disabled,a.CullFaceMode.disabled,Qi(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(u,p,w){if(!p||this.currentStencilSource===p.id||!u.isTileClipped()||!w||w.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let B=!1;for(const F of w)if(this._tileClippingMaskIDs[F.key]===void 0){B=!0;break}if(!B)return}this.currentStencilSource=p.id;const S=this.context,A=S.gl;this.nextStencilID+w.length>256&&this.clearStencil(),S.setColorMode(a.ColorMode.disabled),S.setDepthMode(a.DepthMode.disabled);const L=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const B of w){const F=p.getTile(B),Y=this._tileClippingMaskIDs[B.key]=this.nextStencilID++,{tileBoundsBuffer:X,tileBoundsIndexBuffer:ie,tileBoundsSegments:de}=this.getTileBoundsBuffers(F);L.draw(S,A.TRIANGLES,a.DepthMode.disabled,new a.StencilMode({func:A.ALWAYS,mask:0},Y,255,A.KEEP,A.KEEP,A.REPLACE),a.ColorMode.disabled,a.CullFaceMode.disabled,Qi(B.projMatrix),"$clipping",X,ie,de)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const u=this.nextStencilID++,p=this.context.gl;return new a.StencilMode({func:p.NOTEQUAL,mask:255},u,255,p.KEEP,p.KEEP,p.REPLACE)}stencilModeForClipping(u){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(u);const p=this.context.gl;return new a.StencilMode({func:p.EQUAL,mask:255},this._tileClippingMaskIDs[u.key],0,p.KEEP,p.KEEP,p.REPLACE)}stencilConfigForOverlap(u){const p=this.context.gl,w=u.sort((L,B)=>B.overscaledZ-L.overscaledZ),S=w[w.length-1].overscaledZ,A=w[0].overscaledZ-S+1;if(A>1){this.currentStencilSource=void 0,this.nextStencilID+A>256&&this.clearStencil();const L={};for(let B=0;B<A;B++)L[B+S]=new a.StencilMode({func:p.GEQUAL,mask:255},B+this.nextStencilID,255,p.KEEP,p.KEEP,p.REPLACE);return this.nextStencilID+=A,[L,w]}return[{[S]:a.StencilMode.disabled},w]}colorModeForRenderPass(){const u=this.context.gl;return this._showOverdrawInspector?new a.ColorMode([u.CONSTANT_COLOR,u.ONE],new a.Color(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?a.ColorMode.unblended:a.ColorMode.alphaBlended}depthModeForSublayer(u,p,w){if(!this.opaquePassEnabledForLayer())return a.DepthMode.disabled;const S=1-((1+this.currentLayer)*this.numSublayers+u)*this.depthEpsilon;return new a.DepthMode(w||this.context.gl.LEQUAL,p,[S,S])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(u,p){this.style=u,this.options=p,this.imageManager=u.imageManager,this.glyphManager=u.glyphManager,this.symbolFadeChange=u.placement.symbolFadeChange(a.exported.now()),this.imageManager.beginFrame();const w=this.style.order,S=this.style._sourceCaches;for(const Y in S){const X=S[Y];X.used&&X.prepare(this.context)}const A={},L={},B={};for(const Y in S){const X=S[Y];A[Y]=X.getVisibleCoordinates(),L[Y]=A[Y].slice().reverse(),B[Y]=X.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let Y=0;Y<w.length;Y++)if(this.style._layers[w[Y]].is3D()){this.opaquePassCutoff=Y;break}if(this.terrain&&(this.terrain.updateTileBinding(B),this.opaquePassCutoff=0),this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new a.GlobeSharedBuffers(this.context)),!a.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const Y of w){const X=this.style._layers[Y],ie=u._getLayerSourceCache(X);if(!X.hasOffscreenPass()||X.isHidden(this.transform.zoom))continue;const de=ie?L[ie.id]:void 0;(X.type==="custom"||X.isSky()||de&&de.length)&&this.renderLayer(this,ie,X,de)}this.depthRangeFor3D=[0,1-(u.order.length+2)*this.numSublayers*this.depthEpsilon];const F=this.terrain;if(F&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&F.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]),this.context.clear({color:p.showOverdrawInspector?a.Color.black:a.Color.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=p.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=w.length-1;this.currentLayer>=0;this.currentLayer--){const Y=this.style._layers[w[this.currentLayer]],X=u._getLayerSourceCache(Y);if(Y.isSky())continue;const ie=X?L[X.id]:void 0;this._renderTileClippingMasks(Y,X,ie),this.renderLayer(this,X,Y,ie)}if(this.style.fog&&this.transform.projection.supportsFog&&function(Y,X){const ie=Y.context,de=ie.gl,ge=Y.transform,ye=new a.DepthMode(de.LEQUAL,a.DepthMode.ReadOnly,[0,1]),ve=Y.useProgram("globeAtmosphere",null,ge.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"]),xe=a.globeToMercatorTransition(ge.zoom),ce=X.properties.get("color").toArray01(),Se=X.properties.get("high-color").toArray01(),Te=X.properties.get("space-color").toArray01PremultipliedAlpha(),Ae=a.identity$1([]);a.rotateY$1(Ae,Ae,-a.degToRad(ge._center.lng)),a.rotateX$1(Ae,Ae,a.degToRad(ge._center.lat)),a.rotateZ$1(Ae,Ae,ge.angle),a.rotateX$1(Ae,Ae,-ge._pitch);const Fe=a.fromQuat(new Float32Array(16),Ae),$e=a.mapValue(X.properties.get("star-intensity"),0,1,0,.25),qe=5e-4,Je=a.mapValue(X.properties.get("horizon-blend"),0,1,qe,.25),rt=a.globeUseCustomAntiAliasing(Y,ie,ge)&&Je===qe?ge.worldSize/(2*Math.PI*1.025)-1:ge.globeRadius,lt=Y.frameCounter/1e3%1,Jt=a.length(ge.globeCenterInViewSpace),et=Math.sqrt(Math.pow(Jt,2)-Math.pow(rt,2)),Dt=Math.acos(et/Jt),gt=((at,Ke,ut,Lt,jt,Pi,er,Si,yi,Oi,ar,Ui,yr,vr)=>({u_frustum_tl:at,u_frustum_tr:Ke,u_frustum_br:ut,u_frustum_bl:Lt,u_horizon:jt,u_transition:Pi,u_fadeout_range:er,u_color:Si,u_high_color:yi,u_space_color:Oi,u_star_intensity:ar,u_star_size:5*a.exported.devicePixelRatio,u_star_density:0,u_temporal_offset:Ui,u_horizon_angle:yr,u_rotation_matrix:vr}))(ge.frustumCorners.TL,ge.frustumCorners.TR,ge.frustumCorners.BR,ge.frustumCorners.BL,ge.frustumCorners.horizon,xe,Je,ce,Se,Te,$e,lt,Dt,Fe);Y.prepareDrawProgram(ie,ve);const zt=Y.atmosphereBuffer;zt&&ve.draw(ie,de.TRIANGLES,ye,a.StencilMode.disabled,a.ColorMode.alphaBlended,a.CullFaceMode.backCW,gt,"skybox",zt.vertexBuffer,zt.indexBuffer,zt.segments)}(this,this.style.fog),this.renderPass="sky",(a.globeToMercatorTransition(this.transform.zoom)>0||this.transform.projection.name!=="globe")&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<w.length;this.currentLayer++){const Y=this.style._layers[w[this.currentLayer]],X=u._getLayerSourceCache(Y);Y.isSky()&&this.renderLayer(this,X,Y,X?L[X.id]:void 0)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<w.length;){const Y=this.style._layers[w[this.currentLayer]],X=u._getLayerSourceCache(Y);if(Y.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(Y)){if(Y.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const ie=X?(Y.type==="symbol"?B:L)[X.id]:void 0;this._renderTileClippingMasks(Y,X,X?A[X.id]:void 0),this.renderLayer(this,X,Y,ie),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Y=null;a.values(this.style._layers).forEach(X=>{const ie=u._getLayerSourceCache(X);ie&&!X.isHidden(this.transform.zoom)&&(!Y||Y.getSource().maxzoom<ie.getSource().maxzoom)&&(Y=ie)}),Y&&this.options.showTileBoundaries&&la.debug(this,Y,Y.getVisibleCoordinates())}this.options.showPadding&&function(Y){const X=Y.transform.padding;xn(Y,Y.transform.height-(X.top||0),3,ls),xn(Y,X.bottom||0,3,Bs),So(Y,X.left||0,3,pl),So(Y,Y.transform.width-(X.right||0),3,Mr);const ie=Y.transform.centerPoint;(function(de,ge,ye,ve){gn(de,ge-1,ye-10,2,20,ve),gn(de,ge-10,ye-1,20,2,ve)})(Y,ie.x,Y.transform.height-ie.y,xr)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(a.window.performance.now()),this.saveCanvasCopy())}renderLayer(u,p,w,S){w.isHidden(this.transform.zoom)||(w.type==="background"||w.type==="sky"||w.type==="custom"||S&&S.length)&&(this.id=w.id,this.gpuTimingStart(w),(!u.transform.projection.unsupportedLayers||!u.transform.projection.unsupportedLayers.includes(w.type)||u.terrain&&w.type==="custom")&&la[w.type](u,p,w,S,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(u){if(!this.options.gpuTiming)return;const p=this.context.extTimerQuery;let w=this.gpuTimers[u.id];w||(w=this.gpuTimers[u.id]={calls:0,cpuTime:0,query:p.createQueryEXT()}),w.calls++,p.beginQueryEXT(p.TIME_ELAPSED_EXT,w.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const u=this.context.extTimerQuery,p=u.createQueryEXT();this.deferredRenderGpuTimeQueries.push(p),u.beginQueryEXT(u.TIME_ELAPSED_EXT,p)}}gpuTimingDeferredRenderEnd(){if(!this.options.gpuTimingDeferredRender)return;const u=this.context.extTimerQuery;u.endQueryEXT(u.TIME_ELAPSED_EXT)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const u=this.context.extTimerQuery;u.endQueryEXT(u.TIME_ELAPSED_EXT)}collectGpuTimers(){const u=this.gpuTimers;return this.gpuTimers={},u}collectDeferredRenderGpuQueries(){const u=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],u}queryGpuTimers(u){const p={};for(const w in u){const S=u[w],A=this.context.extTimerQuery,L=A.getQueryObjectEXT(S.query,A.QUERY_RESULT_EXT)/1e6;A.deleteQueryEXT(S.query),p[w]=L}return p}queryGpuTimeDeferredRender(u){if(!this.options.gpuTimingDeferredRender)return 0;const p=this.context.extTimerQuery;let w=0;for(const S of u)w+=p.getQueryObjectEXT(S,p.QUERY_RESULT_EXT)/1e6,p.deleteQueryEXT(S);return w}translatePosMatrix(u,p,w,S,A){if(!w[0]&&!w[1])return u;const L=A?S==="map"?this.transform.angle:0:S==="viewport"?-this.transform.angle:0;if(L){const Y=Math.sin(L),X=Math.cos(L);w=[w[0]*X-w[1]*Y,w[0]*Y+w[1]*X]}const B=[A?w[0]:xt(p,w[0],this.transform.zoom),A?w[1]:xt(p,w[1],this.transform.zoom),0],F=new Float32Array(16);return a.translate(F,u,B),F}saveTileTexture(u){const p=this._tileTextures[u.size[0]];p?p.push(u):this._tileTextures[u.size[0]]=[u]}getTileTexture(u){const p=this._tileTextures[u];return p&&p.length>0?p.pop():null}isPatternMissing(u){return u===null||u!==void 0&&!this.imageManager.getPattern(u.toString())}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}currentGlobalDefines(){const u=this.terrain&&this.terrain.renderingToTexture,p=this.terrain&&this.terrain.exaggeration()===0,w=this.style&&this.style.fog,S=[];return this.terrainRenderModeElevated()&&S.push("TERRAIN"),this.transform.projection.name==="globe"&&S.push("GLOBE"),p&&S.push("ZERO_EXAGGERATION"),w&&!u&&w.getOpacity(this.transform.pitch)!==0&&S.push("FOG"),u&&S.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&S.push("OVERDRAW_INSPECTOR"),S}useProgram(u,p,w){this.cache=this.cache||{};const S=w||[],A=this.currentGlobalDefines().concat(S),L=ns.cacheKey(ks[u],u,A,p);return this.cache[L]||(this.cache[L]=new ns(this.context,u,ks[u],p,Jr[u],A)),this.cache[L]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const u=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(u.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=a.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new a.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this.atmosphereBuffer&&this.atmosphereBuffer.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}prepareDrawProgram(u,p,w){if(this.terrain&&this.terrain.renderingToTexture)return;const S=this.style.fog;if(S){const A=S.getOpacity(this.transform.pitch),L=((B,F,Y,X,ie,de,ge,ye,ve,xe,ce)=>{const Se=B.transform,Te=F.properties.get("color").toArray01();Te[3]=X;const Ae=B.frameCounter/1e3%1;return{u_fog_matrix:Y?Se.calculateFogTileMatrix(Y):B.identityMat,u_fog_range:F.getFovAdjustedRange(Se._fov),u_fog_color:Te,u_fog_horizon_blend:F.properties.get("horizon-blend"),u_fog_temporal_offset:Ae,u_frustum_tl:ie,u_frustum_tr:de,u_frustum_br:ge,u_frustum_bl:ye,u_globe_pos:ve,u_globe_radius:xe,u_viewport:ce,u_globe_transition:a.globeToMercatorTransition(Se.zoom),u_is_globe:+(Se.projection.name==="globe")}})(this,S,w,A,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*a.exported.devicePixelRatio,this.transform.height*a.exported.devicePixelRatio]);p.setFogUniformValues(u,L)}}setTileLoadedFlag(u){this.tileLoaded=u}saveCanvasCopy(){const u=this.canvasCopy();u&&(this.frameCopies.push(u),this.tileLoaded=!1)}canvasCopy(){const u=this.context.gl,p=u.createTexture();return u.bindTexture(u.TEXTURE_2D,p),u.copyTexImage2D(u.TEXTURE_2D,0,u.RGBA,0,0,u.drawingBufferWidth,u.drawingBufferHeight,0),p}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const u=this.style&&this.style.fog;return!!u&&u.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const u=this._backgroundTiles,p=this._backgroundTiles={},w=this.transform.coveringTiles({tileSize:512});for(const S of w)p[S.key]=u[S.key]||new a.Tile(S,512,this.transform.tileZoom,this);return p}clearBackgroundTiles(){this._backgroundTiles={}}}class ca{constructor(u=0,p=0,w=0,S=0){if(isNaN(u)||u<0||isNaN(p)||p<0||isNaN(w)||w<0||isNaN(S)||S<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=u,this.bottom=p,this.left=w,this.right=S}interpolate(u,p,w){return p.top!=null&&u.top!=null&&(this.top=a.number(u.top,p.top,w)),p.bottom!=null&&u.bottom!=null&&(this.bottom=a.number(u.bottom,p.bottom,w)),p.left!=null&&u.left!=null&&(this.left=a.number(u.left,p.left,w)),p.right!=null&&u.right!=null&&(this.right=a.number(u.right,p.right,w)),this}getCenter(u,p){const w=a.clamp((this.left+u-this.right)/2,0,u),S=a.clamp((this.top+p-this.bottom)/2,0,p);return new a.pointGeometry(w,S)}equals(u){return this.top===u.top&&this.bottom===u.bottom&&this.left===u.left&&this.right===u.right}clone(){return new ca(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Ba(y,u){const p=a.getColumn(y,3);a.fromQuat(y,u),a.setColumn(y,3,p)}function Oa(y,u){const p=a.identity$1([]);return a.rotateZ$1(p,p,-u),a.rotateX$1(p,p,-y),p}function za(y,u){const p=[y[0],y[1],0],w=[u[0],u[1],0];if(a.length(p)>=1e-15){const L=a.normalize([],p);a.scale$2(w,L,a.dot(w,L)),u[0]=w[0],u[1]=w[1]}const S=a.cross([],u,y);if(a.len(S)<1e-15)return null;const A=Math.atan2(-S[1],S[0]);return Oa(Math.atan2(Math.sqrt(y[0]*y[0]+y[1]*y[1]),-y[2]),A)}class jo{constructor(u,p){this.position=u,this.orientation=p}get position(){return this._position}set position(u){if(u){const p=u instanceof a.MercatorCoordinate?u:new a.MercatorCoordinate(u[0],u[1],u[2]);this._renderWorldCopies&&(p.x=a.wrap(p.x,0,1)),this._position=p}else this._position=null}lookAtPoint(u,p){if(this.orientation=null,!this.position)return;const w=this.position,S=this._elevation?this._elevation.getAtPointOrZero(a.MercatorCoordinate.fromLngLat(u)):0,A=a.MercatorCoordinate.fromLngLat(u,S),L=[A.x-w.x,A.y-w.y,A.z-w.z];p||(p=[0,0,1]),p[2]=Math.abs(p[2]),this.orientation=za(L,p)}setPitchBearing(u,p){this.orientation=Oa(a.degToRad(u),a.degToRad(-p))}}class cs{constructor(u,p){this._transform=a.identity([]),this.orientation=p,this.position=u}get mercatorPosition(){const u=this.position;return new a.MercatorCoordinate(u[0],u[1],u[2])}get position(){const u=a.getColumn(this._transform,3);return[u[0],u[1],u[2]]}set position(u){var p;u&&a.setColumn(this._transform,3,[(p=u)[0],p[1],p[2],1])}get orientation(){return this._orientation}set orientation(u){this._orientation=u||a.identity$1([]),u&&Ba(this._transform,this._orientation)}getPitchBearing(){const u=this.forward(),p=this.right();return{bearing:Math.atan2(-p[1],p[0]),pitch:Math.atan2(Math.sqrt(u[0]*u[0]+u[1]*u[1]),-u[2])}}setPitchBearing(u,p){this._orientation=Oa(u,p),Ba(this._transform,this._orientation)}forward(){const u=a.getColumn(this._transform,2);return[-u[0],-u[1],-u[2]]}up(){const u=a.getColumn(this._transform,1);return[-u[0],-u[1],-u[2]]}right(){const u=a.getColumn(this._transform,0);return[u[0],u[1],u[2]]}getCameraToWorld(u,p){const w=new Float64Array(16);return a.invert(w,this.getWorldToCamera(u,p)),w}getWorldToCameraPosition(u,p,w){const S=this.position;a.scale$2(S,S,-u);const A=new Float64Array(16);return a.fromScaling(A,[w,w,w]),a.translate(A,A,S),A[10]*=p,A}getWorldToCamera(u,p){const w=new Float64Array(16),S=new Float64Array(4),A=this.position;return a.conjugate(S,this._orientation),a.scale$2(A,A,-u),a.fromQuat(w,S),a.translate(w,w,A),w[1]*=-1,w[5]*=-1,w[9]*=-1,w[13]*=-1,w[8]*=p,w[9]*=p,w[10]*=p,w[11]*=p,w}getCameraToClipPerspective(u,p,w,S){const A=new Float64Array(16);return a.perspective(A,u,p,w,S),A}getDistanceToElevation(u,p=!1){const w=u===0?0:a.mercatorZfromAltitude(u,p?a.latFromMercatorY(this.position[1]):this.position[1]),S=this.forward();return(w-this.position[2])/S[2]}clone(){return new cs([...this.position],[...this.orientation])}}function us(y,u){const p=Fa(y.projection,y.zoom,y.width,y.height),w=function(A,L,B,F,Y){const X=new a.LngLat(B.lng-180*Na,B.lat),ie=new a.LngLat(B.lng+180*Na,B.lat),de=A.project(X.lng,X.lat),ge=A.project(ie.lng,ie.lat),ye=-Math.atan2(ge.y-de.y,ge.x-de.x),ve=a.MercatorCoordinate.fromLngLat(B);ve.y=a.clamp(ve.y,-.999975,.999975);const xe=ve.toLngLat(),ce=A.project(xe.lng,xe.lat),Se=a.MercatorCoordinate.fromLngLat(xe);Se.x+=Na;const Te=Se.toLngLat(),Ae=A.project(Te.lng,Te.lat),Fe=zs(Ae.x-ce.x,Ae.y-ce.y,ye),$e=a.MercatorCoordinate.fromLngLat(xe);$e.y+=Na;const qe=$e.toLngLat(),Je=A.project(qe.lng,qe.lat),rt=zs(Je.x-ce.x,Je.y-ce.y,ye),lt=Math.abs(Fe.x)/Math.abs(rt.y),Jt=a.identity([]);a.rotateZ(Jt,Jt,-ye*(1-(Y?0:F)));const et=a.identity([]);return a.scale(et,et,[1,1-(1-lt)*F,1]),et[4]=-rt.x/rt.y*F,a.rotateZ(et,et,ye),a.multiply(et,Jt,et),et}(y.projection,0,y.center,p,u),S=gl(y);return a.scale(w,w,[S,S,1]),w}function gl(y){const u=y.projection,p=Fa(y.projection,y.zoom,y.width,y.height),w=Os(u,y.center),S=Os(u,a.LngLat.convert(u.center));return Math.pow(2,w*p+(1-p)*S)}function Fa(y,u,p,w,S=1/0){const A=y.range;if(!A)return 0;const L=Math.min(S,Math.max(p,w)),B=Math.log(L/1024)/Math.LN2;return a.smoothstep(A[0]+B,A[1]+B,u)}const Na=1/4e4;function Os(y,u){const p=a.clamp(u.lat,-a.MAX_MERCATOR_LATITUDE,a.MAX_MERCATOR_LATITUDE),w=new a.LngLat(u.lng-180*Na,p),S=new a.LngLat(u.lng+180*Na,p),A=y.project(w.lng,p),L=y.project(S.lng,p),B=a.MercatorCoordinate.fromLngLat(w),F=a.MercatorCoordinate.fromLngLat(S),Y=L.x-A.x,X=L.y-A.y,ie=F.x-B.x,de=F.y-B.y,ge=Math.sqrt((ie*ie+de*de)/(Y*Y+X*X));return Math.log(ge)/Math.LN2}function zs(y,u,p){const w=Math.cos(p),S=Math.sin(p);return{x:y*w-u*S,y:y*S+u*w}}class gi{constructor(u,p,w,S,A,L,B){this.tileSize=512,this._renderWorldCopies=A===void 0||A,this._minZoom=u||0,this._maxZoom=p||22,this._minPitch=w??0,this._maxPitch=S??60,this.setProjection(L),this.setMaxBounds(B),this.width=0,this.height=0,this._center=new a.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new ca,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new cs,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1}clone(){const u=new gi(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return u._elevation=this._elevation,u._centerAltitude=this._centerAltitude,u._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,u.tileSize=this.tileSize,u.mercatorFromTransition=this.mercatorFromTransition,u.width=this.width,u.height=this.height,u.cameraElevationReference=this.cameraElevationReference,u._center=this._center,u._setZoom(this.zoom),u._seaLevelZoom=this._seaLevelZoom,u.angle=this.angle,u._fov=this._fov,u._pitch=this._pitch,u._nearZ=this._nearZ,u._farZ=this._farZ,u._averageElevation=this._averageElevation,u._unmodified=this._unmodified,u._edgeInsets=this._edgeInsets.clone(),u._camera=this._camera.clone(),u._calcMatrices(),u.freezeTileCoverage=this.freezeTileCoverage,u.frustumCorners=this.frustumCorners,u}get elevation(){return this._elevation}set elevation(u){this._elevation!==u&&(this._elevation=u,this._updateCameraOnTerrain(),this._calcMatrices())}updateElevation(u,p=!1){const w=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||w)&&this._updateCameraOnTerrain(),(u||w)&&this._constrainCamera(p),this._calcMatrices()}getProjection(){return a.pick(this.projection,["name","center","parallels"])}setProjection(u){this.projectionOptions=u||{name:"mercator"};const p=this.projection?this.getProjection():void 0;this.projection=a.getProjection(this.projectionOptions);const w=!b(p,this.getProjection());return w&&this._calcMatrices(),this.mercatorFromTransition=!1,w}setMercatorFromTransition(){const u=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=a.getProjection({name:"mercator"});const p=u!==this.projection.name;return p&&this._calcMatrices(),p}get minZoom(){return this._minZoom}set minZoom(u){this._minZoom!==u&&(this._minZoom=u,this.zoom=Math.max(this.zoom,u))}get maxZoom(){return this._maxZoom}set maxZoom(u){this._maxZoom!==u&&(this._maxZoom=u,this.zoom=Math.min(this.zoom,u))}get minPitch(){return this._minPitch}set minPitch(u){this._minPitch!==u&&(this._minPitch=u,this.pitch=Math.max(this.pitch,u))}get maxPitch(){return this._maxPitch}set maxPitch(u){this._maxPitch!==u&&(this._maxPitch=u,this.pitch=Math.min(this.pitch,u))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(u){u===void 0?u=!0:u===null&&(u=!1),this._renderWorldCopies=u}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const u=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(u))}get cameraWorldSize(){const u=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(u))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return a.mercatorZfromAltitude(this.center.lat,this.cameraWorldSizeForFog)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new a.pointGeometry(this.width,this.height)}get bearing(){return a.wrap(this.rotation,-180,180)}set bearing(u){this.rotation=u}get rotation(){return-this.angle/Math.PI*180}set rotation(u){const p=-u*Math.PI/180;var w;this.angle!==p&&(this._unmodified=!1,this.angle=p,this._calcMatrices(),this.rotationMatrix=(w=new a.ARRAY_TYPE(4),a.ARRAY_TYPE!=Float32Array&&(w[1]=0,w[2]=0),w[0]=1,w[3]=1,w),function(S,A,L){var B=A[0],F=A[1],Y=A[2],X=A[3],ie=Math.sin(L),de=Math.cos(L);S[0]=B*de+Y*ie,S[1]=F*de+X*ie,S[2]=B*-ie+Y*de,S[3]=F*-ie+X*de}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(u){const p=a.clamp(u,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==p&&(this._unmodified=!1,this._pitch=p,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const u=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/u)}set fov(u){u=Math.max(.01,Math.min(60,u)),this._fov!==u&&(this._unmodified=!1,this._fov=a.degToRad(u),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(u){this._averageElevation=u,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(u){const p=Math.min(Math.max(u,this.minZoom),this.maxZoom);this._zoom!==p&&(this._unmodified=!1,this._setZoom(p),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(u){this._zoom=u,this.scale=this.zoomScale(u),this.tileZoom=Math.floor(u),this.zoomFraction=u-this.tileZoom}_updateCameraOnTerrain(){if(!this._elevation||!this._elevation.isDataAvailableAtPoint(this.locationCoordinate(this.center)))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const u=this._elevation;this._centerAltitude=u.getAtPointOrZero(this.locationCoordinate(this.center)),this._centerAltitudeValidForExaggeration=u.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const u=this._elevation,p=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],w=this.horizonLineFromTop();let S=0,A=0;for(let L=0;L<p.length;L++){const B=new a.pointGeometry(p[L][0]*this.width,w+p[L][1]*(this.height-w)),F=u.pointCoordinate(B);if(!F)continue;const Y=1/Math.hypot(F[0]-this._camera.position[0],F[1]-this._camera.position[1]);S+=F[3]*Y,A+=Y}return A===0?NaN:S/A}get center(){return this._center}set center(u){u.lat===this._center.lat&&u.lng===this._center.lng||(this._unmodified=!1,this._center=u,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const u=this._seaLevelZoom,p=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),w=this.pixelsPerMeter/this.worldSize*p,S=this._mercatorZfromZoom(u),A=this._mercatorZfromZoom(this._maxZoom),L=Math.max(S-w,A);this._setZoom(this._zoomFromMercatorZ(L))}get padding(){return this._edgeInsets.toJSON()}set padding(u){this._edgeInsets.equals(u)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,u,1),this._calcMatrices())}computeZoomRelativeTo(u){const p=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,u.toAltitude()));let w;w=u.z<this._camera.position[2]?[p.x,p.y,p.z]:[u.x,u.y,u.z];const S=a.length(a.sub([],this._camera.position,w));return a.clamp(this._zoomFromMercatorZ(S),this._minZoom,this._maxZoom)}setFreeCameraOptions(u){if(!this.height||!u.position&&!u.orientation)return;this._updateCameraState();let p=!1;if(u.orientation&&!a.exactEquals(u.orientation,this._camera.orientation)&&(p=this._setCameraOrientation(u.orientation)),u.position){const w=[u.position.x,u.position.y,u.position.z];a.exactEquals$1(w,this._camera.position)||(this._setCameraPosition(w),p=!0)}p&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const u=this._camera.position,p=new jo;return p.position=new a.MercatorCoordinate(u[0],u[1],u[2]),p.orientation=this._camera.orientation,p._elevation=this.elevation,p._renderWorldCopies=this.renderWorldCopies,p}_setCameraOrientation(u){if(!a.length$1(u))return!1;a.normalize$1(u,u);const p=a.transformQuat([],[0,0,-1],u),w=a.transformQuat([],[0,-1,0],u);if(w[2]<0)return!1;const S=za(p,w);return!!S&&(this._camera.orientation=S,!0)}_setCameraPosition(u){const p=this.zoomScale(this.minZoom)*this.tileSize,w=this.zoomScale(this.maxZoom)*this.tileSize,S=this.cameraToCenterDistance;u[2]=a.clamp(u[2],S/w,S/p),this._camera.position=u}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(u){return this._edgeInsets.equals(u)}interpolatePadding(u,p,w){this._unmodified=!1,this._edgeInsets.interpolate(u,p,w),this._constrain(),this._calcMatrices()}coveringZoomLevel(u){const p=(u.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/u.tileSize));return Math.max(0,p)}getVisibleUnwrappedCoordinates(u){const p=[new a.UnwrappedTileID(0,u)];if(this.renderWorldCopies){const w=this.pointCoordinate(new a.pointGeometry(0,0)),S=this.pointCoordinate(new a.pointGeometry(this.width,0)),A=this.pointCoordinate(new a.pointGeometry(this.width,this.height)),L=this.pointCoordinate(new a.pointGeometry(0,this.height)),B=Math.floor(Math.min(w.x,S.x,A.x,L.x)),F=Math.floor(Math.max(w.x,S.x,A.x,L.x)),Y=1;for(let X=B-Y;X<=F+Y;X++)X!==0&&p.push(new a.UnwrappedTileID(X,u))}return p}coveringTiles(u){let p=this.coveringZoomLevel(u);const w=p,S=this.elevation&&!u.isTerrainDEM,A=this.projection.name==="mercator";if(u.minzoom!==void 0&&p<u.minzoom)return[];u.maxzoom!==void 0&&p>u.maxzoom&&(p=u.maxzoom);const L=this.locationCoordinate(this.center),B=this.center.lat,F=1<<p,Y=[F*L.x,F*L.y,0],X=this.projection.name==="globe",ie=!X,de=a.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,p,ie),ge=X?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),ye=F*a.mercatorZfromAltitude(1,this.center.lat),ve=this._camera.position[2]/a.mercatorZfromAltitude(1,this.center.lat),xe=[F*ge.x,F*ge.y,ve*(ie?1:ye)],ce=this.cameraToCenterDistance/u.tileSize*(u.roundZoom?1:.502),Se=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?p:0,Te=u.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,Ae=u.isTerrainDEM?-Te:this._elevation?this._elevation.getMinElevationBelowMSL():0,Fe=this.projection.isReprojectedInTileSpace?gl(this):1,$e=at=>{const ut=new a.MercatorCoordinate(at.x+25e-6,at.y,at.z),Lt=new a.MercatorCoordinate(at.x,at.y+25e-6,at.z),jt=at.toLngLat(),Pi=ut.toLngLat(),er=Lt.toLngLat(),Si=this.locationCoordinate(jt),yi=this.locationCoordinate(Pi),Oi=this.locationCoordinate(er),ar=Math.hypot(yi.x-Si.x,yi.y-Si.y),Ui=Math.hypot(Oi.x-Si.x,Oi.y-Si.y);return Math.sqrt(ar*Ui)*Fe/25e-6},qe=at=>{const Ke=Te,ut=Ae;return{aabb:a.tileAABB(this,F,0,0,0,at,ut,Ke,this.projection),zoom:0,x:0,y:0,minZ:ut,maxZ:Ke,wrap:at,fullyVisible:!1}},Je=[];let rt=[];const lt=p,Jt=u.reparseOverscaled?w:p,et=at=>at*at,Dt=et((ve-this._centerAltitude)*ye),gt=at=>{if(!this._elevation||!at.tileID||!A)return;const Ke=this._elevation.getMinMaxForTile(at.tileID),ut=at.aabb;Ke?(ut.min[2]=Ke.min,ut.max[2]=Ke.max,ut.center[2]=(ut.min[2]+ut.max[2])/2):(at.shouldSplit=zt(at),at.shouldSplit||(ut.min[2]=ut.max[2]=ut.center[2]=this._centerAltitude))},zt=at=>{if(at.zoom<Se)return!0;if(at.zoom===lt)return!1;if(at.shouldSplit!=null)return at.shouldSplit;const Ke=at.aabb.distanceX(xe),ut=at.aabb.distanceY(xe);let Lt=Dt,jt=1;if(X){Lt=et(at.aabb.distanceZ(xe));const Si=Math.pow(2,at.zoom),yi=a.latFromMercatorY((at.y+1)/Si),Oi=a.latFromMercatorY(at.y/Si),ar=Math.min(Math.max(B,yi),Oi),Ui=a.circumferenceAtLatitude(ar)/a.circumferenceAtLatitude(B);if(jt=ar===B?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Ui/this._mercatorScaleRatio),this.zoom<=a.GLOBE_ZOOM_THRESHOLD_MIN&&at.zoom===lt-1&&Ui>=.9)return!0}else if(S&&(Lt=et(at.aabb.distanceZ(xe)*ye)),this.projection.isReprojectedInTileSpace&&w<=5){const Si=Math.pow(2,at.zoom),yi=$e(new a.MercatorCoordinate((at.x+.5)/Si,(at.y+.5)/Si));jt=yi>.85?1:yi}const Pi=Ke*Ke+ut*ut+Lt,er=et((1<<lt-at.zoom)*ce*jt*((Si,yi)=>{if(yi*et(.707)<Si)return 1;const Oi=Math.sqrt(yi/Si);return Oi/(1.4144271570014144+(Math.pow(1.1,Oi-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(Lt,Dt),Pi));return Pi<er};if(this.renderWorldCopies)for(let at=1;at<=3;at++)Je.push(qe(-at)),Je.push(qe(at));for(Je.push(qe(0));Je.length>0;){const at=Je.pop(),Ke=at.x,ut=at.y;let Lt=at.fullyVisible;if(!Lt){const jt=at.aabb.intersects(de);if(jt===0)continue;Lt=jt===2}if(at.zoom!==lt&&zt(at))for(let jt=0;jt<4;jt++){const Pi=(Ke<<1)+jt%2,er=(ut<<1)+(jt>>1),Si={aabb:A?at.aabb.quadrant(jt):a.tileAABB(this,F,at.zoom+1,Pi,er,at.wrap,at.minZ,at.maxZ,this.projection),zoom:at.zoom+1,x:Pi,y:er,wrap:at.wrap,fullyVisible:Lt,tileID:void 0,shouldSplit:void 0,minZ:at.minZ,maxZ:at.maxZ};S&&!X&&(Si.tileID=new a.OverscaledTileID(at.zoom+1===lt?Jt:at.zoom+1,at.wrap,at.zoom+1,Pi,er),gt(Si)),Je.push(Si)}else{const jt=at.zoom===lt?Jt:at.zoom;if(u.minzoom&&u.minzoom>jt)continue;const Pi=Y[0]-(.5+Ke+(at.wrap<<at.zoom))*(1<<p-at.zoom),er=Y[1]-.5-ut,Si=at.tileID?at.tileID:new a.OverscaledTileID(jt,at.wrap,at.zoom,Ke,ut);rt.push({tileID:Si,distanceSq:Pi*Pi+er*er})}}if(this.fogCullDistSq){const at=this.fogCullDistSq,Ke=this.horizonLineFromTop();rt=rt.filter(ut=>{const Lt=[0,0,0,1],jt=[a.EXTENT,a.EXTENT,0,1],Pi=this.calculateFogTileMatrix(ut.tileID.toUnwrapped());a.transformMat4$1(Lt,Lt,Pi),a.transformMat4$1(jt,jt,Pi);const er=a.getAABBPointSquareDist(Lt,jt);if(er===0)return!0;let Si=!1;const yi=this._elevation;if(yi&&er>at&&Ke!==0){const Oi=this.calculateProjMatrix(ut.tileID.toUnwrapped());let ar;u.isTerrainDEM||(ar=yi.getMinMaxForTile(ut.tileID)),ar||(ar={min:Ae,max:Te});const Ui=a.furthestTileCorner(this.rotation),yr=[Ui[0]*a.EXTENT,Ui[1]*a.EXTENT,ar.max];a.transformMat4(yr,yr,Oi),Si=(1-yr[1])*this.height*.5<Ke}return er<at||Si})}return rt.sort((at,Ke)=>at.distanceSq-Ke.distanceSq).map(at=>at.tileID)}resize(u,p){this.width=u,this.height=p,this.pixelsToGLUnits=[2/u,-2/p],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(u){return Math.pow(2,u)}scaleZoom(u){return Math.log(u)/Math.LN2}project(u){const p=a.clamp(u.lat,-a.MAX_MERCATOR_LATITUDE,a.MAX_MERCATOR_LATITUDE),w=this.projection.project(u.lng,p);return new a.pointGeometry(w.x*this.worldSize,w.y*this.worldSize)}unproject(u){return this.projection.unproject(u.x/this.worldSize,u.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/a.mercatorZfromAltitude(1,this.center.lat)/this.worldSize}setLocationAtPoint(u,p){let w,S;const A=this.centerPoint;if(this.projection.name==="globe"){const B=this.worldSize;w=(p.x-A.x)/B,S=(p.y-A.y)/B}else{const B=this.pointCoordinate(p),F=this.pointCoordinate(A);w=B.x-F.x,S=B.y-F.y}const L=this.locationCoordinate(u);this.setLocation(new a.MercatorCoordinate(L.x-w,L.y-S))}setLocation(u){this.center=this.coordinateLocation(u),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(u){return this.projection.locationPoint(this,u)}locationPoint3D(u){return this.projection.locationPoint(this,u,!0)}pointLocation(u){return this.coordinateLocation(this.pointCoordinate(u))}pointLocation3D(u){return this.coordinateLocation(this.pointCoordinate3D(u))}locationCoordinate(u,p){const w=p?a.mercatorZfromAltitude(p,u.lat):void 0,S=this.projection.project(u.lng,u.lat);return new a.MercatorCoordinate(S.x,S.y,w)}coordinateLocation(u){return this.projection.unproject(u.x,u.y)}pointRayIntersection(u,p){const w=p??this._centerAltitude,S=[u.x,u.y,0,1],A=[u.x,u.y,1,1];a.transformMat4$1(S,S,this.pixelMatrixInverse),a.transformMat4$1(A,A,this.pixelMatrixInverse);const L=A[3];a.scale$1(S,S,1/S[3]),a.scale$1(A,A,1/L);const B=S[2],F=A[2];return{p0:S,p1:A,t:B===F?0:(w-B)/(F-B)}}screenPointToMercatorRay(u){const p=[u.x,u.y,0,1],w=[u.x,u.y,1,1];return a.transformMat4$1(p,p,this.pixelMatrixInverse),a.transformMat4$1(w,w,this.pixelMatrixInverse),a.scale$1(p,p,1/p[3]),a.scale$1(w,w,1/w[3]),p[2]=a.mercatorZfromAltitude(p[2],this._center.lat)*this.worldSize,w[2]=a.mercatorZfromAltitude(w[2],this._center.lat)*this.worldSize,a.scale$1(p,p,1/this.worldSize),a.scale$1(w,w,1/this.worldSize),new a.Ray([p[0],p[1],p[2]],a.normalize([],a.sub([],w,p)))}rayIntersectionCoordinate(u){const{p0:p,p1:w,t:S}=u,A=a.mercatorZfromAltitude(p[2],this._center.lat),L=a.mercatorZfromAltitude(w[2],this._center.lat);return new a.MercatorCoordinate(a.number(p[0],w[0],S)/this.worldSize,a.number(p[1],w[1],S)/this.worldSize,a.number(A,L,S))}pointCoordinate(u,p=this._centerAltitude){return this.projection.pointCoordinate(this,u.x,u.y,p)}pointCoordinate3D(u){if(!this.elevation)return this.pointCoordinate(u);let p=this.projection.pointCoordinate3D(this,u.x,u.y);if(p)return new a.MercatorCoordinate(p[0],p[1],p[2]);let w=0,S=this.horizonLineFromTop();if(u.y>S)return this.pointCoordinate(u);const A=.02*S,L=u.clone();for(let B=0;B<10&&S-w>A;B++){L.y=a.number(w,S,.66);const F=this.projection.pointCoordinate3D(this,L.x,L.y);F?(S=L.y,p=F):w=L.y}return p?new a.MercatorCoordinate(p[0],p[1],p[2]):this.pointCoordinate(u)}isPointAboveHorizon(u){return this.projection.isPointAboveHorizon(this,u)}_coordinatePoint(u,p){const w=p&&this.elevation?this.elevation.getAtPointOrZero(u,this._centerAltitude):this._centerAltitude,S=[u.x*this.worldSize,u.y*this.worldSize,w+u.toAltitude(),1];return a.transformMat4$1(S,S,this.pixelMatrix),S[3]>0?new a.pointGeometry(S[0]/S[3],S[1]/S[3]):new a.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:u,left:p}=this._edgeInsets,w=this.height-this._edgeInsets.bottom,S=this.width-this._edgeInsets.right,A=this.pointLocation3D(new a.pointGeometry(p,u)),L=this.pointLocation3D(new a.pointGeometry(S,u)),B=this.pointLocation3D(new a.pointGeometry(S,w)),F=this.pointLocation3D(new a.pointGeometry(p,w));let Y=Math.min(A.lng,L.lng,B.lng,F.lng),X=Math.max(A.lng,L.lng,B.lng,F.lng),ie=Math.min(A.lat,L.lat,B.lat,F.lat),de=Math.max(A.lat,L.lat,B.lat,F.lat);const ge=Math.pow(2,-this.zoom)/16*270,ye=this.projection.name==="globe"?1:4,ve=(xe,ce,Se,Te,Ae)=>{const Fe=(xe+Se)/2,$e=(ce+Te)/2,qe=new a.pointGeometry(Fe,$e),{lng:Je,lat:rt}=this.pointLocation3D(qe),lt=Math.max(0,Y-Je,ie-rt,Je-X,rt-de);Y=Math.min(Y,Je),X=Math.max(X,Je),ie=Math.min(ie,rt),de=Math.max(de,rt),(Ae<ye||lt>ge)&&(ve(xe,ce,Fe,$e,Ae+1),ve(Fe,$e,Se,Te,Ae+1))};if(ve(p,u,S,u,1),ve(S,u,S,w,1),ve(S,w,p,w,1),ve(p,w,p,u,1),this.projection.name==="globe"){const[xe,ce]=a.polesInViewport(this);xe?(de=90,X=180,Y=-180):ce&&(ie=-90,X=180,Y=-180)}return new a.LngLatBounds(new a.LngLat(Y,ie),new a.LngLat(X,de))}_getBoundsRectangular(u,p){const{top:w,left:S}=this._edgeInsets,A=this.height-this._edgeInsets.bottom,L=this.width-this._edgeInsets.right,B=new a.pointGeometry(S,w),F=new a.pointGeometry(L,w),Y=new a.pointGeometry(L,A),X=new a.pointGeometry(S,A);let ie=this.pointCoordinate(B,u),de=this.pointCoordinate(F,u);const ge=this.pointCoordinate(Y,p),ye=this.pointCoordinate(X,p),ve=(xe,ce)=>(ce.y-xe.y)/(ce.x-xe.x);return ie.y>1&&de.y>=0?ie=new a.MercatorCoordinate((1-ye.y)/ve(ye,ie)+ye.x,1):ie.y<0&&de.y<=1&&(ie=new a.MercatorCoordinate(-ye.y/ve(ye,ie)+ye.x,0)),de.y>1&&ie.y>=0?de=new a.MercatorCoordinate((1-ge.y)/ve(ge,de)+ge.x,1):de.y<0&&ie.y<=1&&(de=new a.MercatorCoordinate(-ge.y/ve(ge,de)+ge.x,0)),new a.LngLatBounds().extend(this.coordinateLocation(ie)).extend(this.coordinateLocation(de)).extend(this.coordinateLocation(ye)).extend(this.coordinateLocation(ge))}_getBoundsRectangularTerrain(){const u=this.elevation;if(!u.visibleDemTiles.length||u.isUsingMockSource())return this._getBoundsRectangular(0,0);const p=u.visibleDemTiles.reduce((w,S)=>{if(S.dem){const A=S.dem.tree;w.min=Math.min(w.min,A.minimums[0]),w.max=Math.max(w.max,A.maximums[0])}return w},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(p.min*u.exaggeration(),p.max*u.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(u=!0){const p=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,w=this.height/2-p*(1-this._horizonShift);return u?Math.max(0,w):w}getMaxBounds(){return this.maxBounds}setMaxBounds(u){this.maxBounds=u,this.minLat=-a.MAX_MERCATOR_LATITUDE,this.maxLat=a.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,u&&(this.minLat=u.getSouth(),this.maxLat=u.getNorth(),this.minLng=u.getWest(),this.maxLng=u.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=a.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=a.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=a.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=a.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(u,p){return this.projection.createTileMatrix(this,p,u)}calculateDistanceTileData(u){const p=u.key,w=this._distanceTileDataCache;if(w[p])return w[p];const S=u.canonical,A=1/this.height,L=this.cameraWorldSize,B=L/this.zoomScale(S.z),F=(S.x+Math.pow(2,S.z)*u.wrap)*B,Y=S.y*B,X=this.point;X.x*=L/this.worldSize,X.y*=L/this.worldSize;const ie=this.angle,de=Math.sin(-ie),ge=-Math.cos(-ie);return w[p]={bearing:[de,ge],center:[(X.x-F)*A,(X.y-Y)*A],scale:B/a.EXTENT*A},w[p]}calculateFogTileMatrix(u){const p=u.key,w=this._fogTileMatrixCache;if(w[p])return w[p];const S=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,u);return a.multiply(S,this.worldToFogMatrix,S),w[p]=new Float32Array(S),w[p]}calculateProjMatrix(u,p=!1){const w=u.key,S=p?this._alignedProjMatrixCache:this._projMatrixCache;if(S[w])return S[w];const A=this.calculatePosMatrix(u,this.worldSize);return a.multiply(A,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:p?this.alignedProjMatrix:this.projMatrix,A),S[w]=new Float32Array(A),S[w]}calculatePixelsToTileUnitsMatrix(u){const p=u.tileID.key,w=this._pixelsToTileUnitsCache;if(w[p])return w[p];const S=function(A,L){const{scale:B}=A.tileTransform,F=B*a.EXTENT/(A.tileSize*Math.pow(2,L.zoom-A.tileID.overscaledZ+A.tileID.canonical.z));return Y=new Float32Array(4),de=(X=L.inverseAdjustmentMatrix)[1],ge=X[2],ye=X[3],xe=(ie=[F,F])[1],Y[0]=X[0]*(ve=ie[0]),Y[1]=de*ve,Y[2]=ge*xe,Y[3]=ye*xe,Y;var Y,X,ie,de,ge,ye,ve,xe}(u,this);return w[p]=S,w[p]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const u=1/this.worldSize,p=a.fromScaling([],[u,u,u]);return a.multiply(p,p,this.globeMatrix),p}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const u=this._elevation;this._updateCameraState();const p=a.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,w=this._computeCameraPosition(p),S=this._camera.forward(),A=a.mercatorZfromAltitude(1,this._center.lat);w[2]/=A,S[2]/=A,a.normalize(S,S);const L=u.raycast(w,S,u.exaggeration());if(L){const B=a.scaleAndAdd([],w,S,L),F=new a.MercatorCoordinate(B[0],B[1],a.mercatorZfromAltitude(B[2],a.latFromMercatorY(B[1]))),Y=(F.z+a.length([F.x-w[0],F.y-w[1],F.z-w[2]*A]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(Y),this._centerAltitude=F.toAltitude(),this._center=this.coordinateLocation(F),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(u=!1){if(!this._elevation)return;const p=this._elevation,w=a.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,S=this._computeCameraPosition(w),A=p.getAtPointOrZero(new a.MercatorCoordinate(...S)),L=this.pixelsPerMeter/this.worldSize*A,B=this._minimumHeightOverTerrain(),F=S[2]-L;if(F<=B)if(F<0||u){const Y=this.locationCoordinate(this._center,this._centerAltitude),X=[S[0],S[1],Y.z-S[2]],ie=a.length(X);X[2]-=(B-F)/this._pixelsPerMercatorPixel;const de=a.length(X);if(de===0)return;a.scale$2(X,X,ie/de*this._pixelsPerMercatorPixel),this._camera.position=[S[0],S[1],Y.z*this._pixelsPerMercatorPixel-X[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const u=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||u){const de=this.center;return de.lat=a.clamp(de.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!u)&&(de.lng=a.clamp(de.lng,this.minLng,this.maxLng)),this.center=de,void(this._constraining=!1)}const p=this._unmodified,{x:w,y:S}=this.point;let A=0,L=w,B=S;const F=this.width/2,Y=this.height/2,X=this.worldMinY*this.scale,ie=this.worldMaxY*this.scale;if(S-Y<X&&(B=X+Y),S+Y>ie&&(B=ie-Y),ie-X<this.height&&(A=Math.max(A,this.height/(ie-X)),B=(ie+X)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const de=this.worldMinX*this.scale,ge=this.worldMaxX*this.scale,ye=this.worldSize/2-(de+ge)/2;L=(w+ye+this.worldSize)%this.worldSize-ye,L-F<de&&(L=de+F),L+F>ge&&(L=ge-F),ge-de<this.width&&(A=Math.max(A,this.width/(ge-de)),L=(ge+de)/2)}L===w&&B===S||(this.center=this.unproject(new a.pointGeometry(L,B))),A&&(this.zoom+=this.scaleZoom(A)),this._constrainCamera(),this._unmodified=p,this._constraining=!1}_minZoomForBounds(){let u=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(u=Math.max(u,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),u}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const u=this.centerOffset,p=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=a.mercatorZfromAltitude(1,this.center.lat)/a.mercatorZfromAltitude(1,a.GLOBE_SCALE_MATCH_LATITUDE));const w=Fa(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,w),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const S=this.projection.zAxisUnit==="meters"?p:1,A=this._camera.getWorldToCamera(this.worldSize,S),L=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);L[8]=2*-u.x/this.width,L[9]=2*u.y/this.height;let B=a.mul([],L,A);if(this.projection.isReprojectedInTileSpace){const $e=this.locationCoordinate(this.center),qe=a.identity([]);a.translate(qe,qe,[$e.x*this.worldSize,$e.y*this.worldSize,0]),a.multiply(qe,qe,us(this)),a.translate(qe,qe,[-$e.x*this.worldSize,-$e.y*this.worldSize,0]),a.multiply(B,B,qe),this.inverseAdjustmentMatrix=function(Je){const rt=us(Je,!0);return ae([],[rt[0],rt[1],rt[4],rt[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=a.scale([],B,[this.worldSize,this.worldSize,this.worldSize/S,1]),this.projMatrix=B,this.invProjMatrix=a.invert(new Float64Array(16),this.projMatrix);const F=a.invert([],L);this.frustumCorners=a.FrustumCorners.fromInvProjectionMatrix(F,this.horizonLineFromTop(),this.height);const Y=new Float32Array(16);a.identity(Y),a.scale(Y,Y,[1,-1,1]),a.rotateX(Y,Y,this._pitch),a.rotateZ(Y,Y,this.angle);const X=a.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),ie=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;X[8]=2*-u.x/this.width,X[9]=2*(u.y+ie)/this.height,this.skyboxMatrix=a.multiply(Y,X,Y);const de=this.point,ge=de.x,ye=de.y,ve=this.width%2/2,xe=this.height%2/2,ce=Math.cos(this.angle),Se=Math.sin(this.angle),Te=ge-Math.round(ge)+ce*ve+Se*xe,Ae=ye-Math.round(ye)+ce*xe+Se*ve,Fe=new Float64Array(B);if(a.translate(Fe,Fe,[Te>.5?Te-1:Te,Ae>.5?Ae-1:Ae,0]),this.alignedProjMatrix=Fe,B=a.create(),a.scale(B,B,[this.width/2,-this.height/2,1]),a.translate(B,B,[1,-1,0]),this.labelPlaneMatrix=B,B=a.create(),a.scale(B,B,[1,-1,1]),a.translate(B,B,[-1,-1,0]),a.scale(B,B,[2/this.width,2/this.height,1]),this.glCoordMatrix=B,this.pixelMatrix=a.multiply(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},B=a.invert(new Float64Array(16),this.pixelMatrix),!B)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=B,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=a.calculateGlobeMatrix(this);const $e=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=a.transformMat4($e,$e,A),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=B;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const u=this.cameraWorldSizeForFog,p=this.cameraPixelsPerMeter,w=this._camera.position,S=1/this.height/this._pixelsPerMercatorPixel,A=[u,u,p];a.scale$2(A,A,S),a.scale$2(w,w,-1),a.multiply$2(w,w,A);const L=a.create();a.translate(L,L,w),a.scale(L,L,A),this.mercatorFogMatrix=L,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(u,p,S)}_computeCameraPosition(u){const p=(u=u||this.pixelsPerMeter)/this.pixelsPerMeter,w=this._camera.forward(),S=this.point,A=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*p-u/this.worldSize*this._centerAltitude;return[S.x/this.worldSize-w[0]*A,S.y/this.worldSize-w[1]*A,u/this.worldSize*this._centerAltitude-w[2]*A]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(u){const p=this._maxCameraBoundsDistance()*Math.cos(this._pitch),w=this._camera.position[2],S=u[2];let A=1;this.projection.wrap&&(this.center=this.center.wrap()),S>0&&(A=Math.min((p-w)/S,1)),this._camera.position=a.scaleAndAdd([],this._camera.position,u,A),this._updateStateFromCamera()}_updateStateFromCamera(){const u=this._camera.position,p=this._camera.forward(),{pitch:w,bearing:S}=this._camera.getPitchBearing(),A=a.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,L=this._mercatorZfromZoom(this._maxZoom)*Math.cos(a.degToRad(this._maxPitch)),B=Math.max((u[2]-A)/Math.cos(w),L),F=this._zoomFromMercatorZ(B);a.scaleAndAdd(u,u,p,B),this._pitch=a.clamp(w,a.degToRad(this.minPitch),a.degToRad(this.maxPitch)),this.angle=a.wrap(S,-Math.PI,Math.PI),this._setZoom(a.clamp(F,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new a.MercatorCoordinate(u[0],u[1],u[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(u){return Math.pow(2,u)*this.tileSize}_mercatorZfromZoom(u){return this.cameraToCenterDistance/this._worldSizeFromZoom(u)}_minimumHeightOverTerrain(){const u=Math.min((this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(u)}_zoomFromMercatorZ(u){return this.scaleZoom(this.cameraToCenterDistance/(u*this.tileSize))}zoomFromMercatorZAdjusted(u){let p=0,w=a.GLOBE_ZOOM_THRESHOLD_MAX,S=0,A=1/0;for(;w-p>1e-6&&w>p;){const L=p+.5*(w-p),B=this.tileSize*Math.pow(2,L),F=this.getCameraToCenterDistance(this.projection,L,B),Y=this.scaleZoom(F/(u*this.tileSize)),X=Math.abs(L-Y);X<A&&(A=X,S=L),L<Y?p=L:w=L}return S}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(a.warnOnce("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(u,p){const w=Math.min(u.x,p.x),S=Math.max(u.x,p.x),A=Math.min(u.y,p.y),L=Math.max(u.y,p.y);if(A<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const B=[new a.pointGeometry(w,A),new a.pointGeometry(S,L),new a.pointGeometry(w,L),new a.pointGeometry(S,A)],F=this.renderWorldCopies?-3:0,Y=this.renderWorldCopies?4:1;for(const X of B){const ie=this.pointRayIntersection(X);if(ie.t<0)return!0;const de=this.rayIntersectionCoordinate(ie);if(de.x<F||de.y<0||de.x>Y||de.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+a.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new a.pointGeometry(0,0),new a.pointGeometry(this.width,this.height))}zoomDeltaToMovement(u,p){const w=a.length(a.sub([],this._camera.position,u)),S=this._zoomFromMercatorZ(w)+p;return w-this._mercatorZfromZoom(S)}getCameraPoint(){if(this.projection.name==="globe"){const u=function([p,w,S],A){const L=[p,w,S,1];a.transformMat4$1(L,L,A);const B=L[3]=Math.max(L[3],1e-6);return L[0]/=B,L[1]/=B,L[2]/=B,L}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new a.pointGeometry(u[0],u[1])}{const u=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new a.pointGeometry(0,u))}}getCameraToCenterDistance(u,p=this.zoom,w=this.worldSize){const S=Fa(u,p,this.width,this.height,1024),A=u.pixelSpaceConversion(this.center.lat,w,S);return .5/Math.tan(.5*this._fov)*this.height*A}getWorldToCameraMatrix(){const u=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&a.multiply(u,u,this.globeMatrix),u}}function io(y,u){let p=!1,w=null;const S=()=>{w=null,p&&(y(),w=setTimeout(S,u),p=!1)};return()=>(p=!0,w||S(),w)}class qc{constructor(u){this._hashName=u&&encodeURIComponent(u),a.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=io(this._updateHashUnthrottled.bind(this),300)}addTo(u){return this._map=u,a.window.addEventListener("hashchange",this._onHashChange,!1),u.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),a.window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const u=this._map;if(!u)return"";const p=Ql(u);if(this._hashName){const w=this._hashName;let S=!1;const A=a.window.location.hash.slice(1).split("&").map(L=>{const B=L.split("=")[0];return B===w?(S=!0,`${B}=${p}`):L}).filter(L=>L);return S||A.push(`${w}=${p}`),`#${A.join("&")}`}return`#${p}`}_getCurrentHash(){const u=a.window.location.hash.replace("#","");if(this._hashName){let p;return u.split("&").map(w=>w.split("=")).forEach(w=>{w[0]===this._hashName&&(p=w)}),(p&&p[1]||"").split("/")}return u.split("/")}_onHashChange(){const u=this._map;if(!u)return!1;const p=this._getCurrentHash();if(p.length>=3&&!p.some(w=>isNaN(w))){const w=u.dragRotate.isEnabled()&&u.touchZoomRotate.isEnabled()?+(p[3]||0):u.getBearing();return u.jumpTo({center:[+p[2],+p[1]],zoom:+p[0],bearing:w,pitch:+(p[4]||0)}),!0}return!1}_updateHashUnthrottled(){const u=a.window.location.href.replace(/(#.+)?$/,this.getHashString());a.window.history.replaceState(a.window.history.state,null,u)}}function Ql(y,u){const p=y.getCenter(),w=Math.round(100*y.getZoom())/100,S=Math.ceil((w*Math.LN2+Math.log(512/360/.5))/Math.LN10),A=Math.pow(10,S),L=Math.round(p.lng*A)/A,B=Math.round(p.lat*A)/A,F=y.getBearing(),Y=y.getPitch();let X=u?`/${L}/${B}/${w}`:`${w}/${B}/${L}`;return(F||Y)&&(X+="/"+Math.round(10*F)/10),Y&&(X+=`/${Math.round(Y)}`),X}const Fs={linearity:.3,easing:a.bezier(0,0,.3,1)},hs=a.extend({deceleration:2500,maxSpeed:1400},Fs),Gc=a.extend({deceleration:20,maxSpeed:1400},Fs),_l=a.extend({deceleration:1e3,maxSpeed:360},Fs),Jl=a.extend({deceleration:1e3,maxSpeed:90},Fs);class yl{constructor(u){this._map=u,this.clear()}clear(){this._inertiaBuffer=[]}record(u){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:a.exported.now(),settings:u})}_drainInertiaBuffer(){const u=this._inertiaBuffer,p=a.exported.now();for(;u.length>0&&p-u[0].time>160;)u.shift()}_onMoveEnd(u){if(a.exported.prefersReducedMotion||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const p={zoom:0,bearing:0,pitch:0,pan:new a.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:A}of this._inertiaBuffer)p.zoom+=A.zoomDelta||0,p.bearing+=A.bearingDelta||0,p.pitch+=A.pitchDelta||0,A.panDelta&&p.pan._add(A.panDelta),A.around&&(p.around=A.around),A.pinchAround&&(p.pinchAround=A.pinchAround);const w=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,S={};if(p.pan.mag()){const A=Us(p.pan.mag(),w,a.extend({},hs,u||{}));S.offset=p.pan.mult(A.amount/p.pan.mag()),S.center=this._map.transform.center,Ns(S,A)}if(p.zoom){const A=Us(p.zoom,w,Gc);S.zoom=this._map.transform.zoom+A.amount,Ns(S,A)}if(p.bearing){const A=Us(p.bearing,w,_l);S.bearing=this._map.transform.bearing+a.clamp(A.amount,-179,179),Ns(S,A)}if(p.pitch){const A=Us(p.pitch,w,Jl);S.pitch=this._map.transform.pitch+A.amount,Ns(S,A)}if(S.zoom||S.bearing){const A=p.pinchAround===void 0?p.around:p.pinchAround;S.around=A?this._map.unproject(A):this._map.getCenter()}return this.clear(),S.noMoveStart=!0,S}}function Ns(y,u){(!y.duration||y.duration<u.duration)&&(y.duration=u.duration,y.easing=u.easing)}function Us(y,u,p){const{maxSpeed:w,linearity:S,deceleration:A}=p,L=a.clamp(y*S/(u/1e3),-w,w),B=Math.abs(L)/(A*S);return{easing:p.easing,duration:1e3*B,amount:L*(B/2)}}class _n extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(u,p,w,S={}){const A=W(p.getCanvasContainer(),w),L=p.unproject(A);super(u,a.extend({point:A,lngLat:L,originalEvent:w},S)),this._defaultPrevented=!1,this.target=p}}class vl extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(u,p,w){const S=u==="touchend"?w.changedTouches:w.touches,A=_e(p.getCanvasContainer(),S),L=A.map(F=>p.unproject(F)),B=A.reduce((F,Y,X,ie)=>F.add(Y.div(ie.length)),new a.pointGeometry(0,0));super(u,{points:A,point:B,lngLats:L,lngLat:p.unproject(B),originalEvent:w}),this._defaultPrevented=!1}}class Qu extends a.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(u,p,w){super(u,{originalEvent:w}),this._defaultPrevented=!1}}class Zc{constructor(u,p){this._map=u,this._clickTolerance=p.clickTolerance}reset(){this._mousedownPos=void 0}wheel(u){return this._firePreventable(new Qu(u.type,this._map,u))}mousedown(u,p){return this._mousedownPos=p,this._firePreventable(new _n(u.type,this._map,u))}mouseup(u){this._map.fire(new _n(u.type,this._map,u))}preclick(u){const p=a.extend({},u);p.type="preclick",this._map.fire(new _n(p.type,this._map,p))}click(u,p){this._mousedownPos&&this._mousedownPos.dist(p)>=this._clickTolerance||(this.preclick(u),this._map.fire(new _n(u.type,this._map,u)))}dblclick(u){return this._firePreventable(new _n(u.type,this._map,u))}mouseover(u){this._map.fire(new _n(u.type,this._map,u))}mouseout(u){this._map.fire(new _n(u.type,this._map,u))}touchstart(u){return this._firePreventable(new vl(u.type,this._map,u))}touchmove(u){this._map.fire(new vl(u.type,this._map,u))}touchend(u){this._map.fire(new vl(u.type,this._map,u))}touchcancel(u){this._map.fire(new vl(u.type,this._map,u))}_firePreventable(u){if(this._map.fire(u),u.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class xl{constructor(u){this._map=u}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(u){this._map.fire(new _n(u.type,this._map,u))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new _n("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(u){this._delayContextMenu?this._contextMenuEvent=u:this._map.fire(new _n(u.type,this._map,u)),this._map.listens("contextmenu")&&u.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ec{constructor(u,p){this._map=u,this._el=u.getCanvasContainer(),this._container=u.getContainer(),this._clickTolerance=p.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(u,p){this.isEnabled()&&u.shiftKey&&u.button===0&&(j(),this._startPos=this._lastPos=p,this._active=!0)}mousemoveWindow(u,p){if(!this._active)return;const w=p,S=this._startPos,A=this._lastPos;if(!S||!A||A.equals(w)||!this._box&&w.dist(S)<this._clickTolerance)return;this._lastPos=w,this._box||(this._box=D("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",u));const L=Math.min(S.x,w.x),B=Math.max(S.x,w.x),F=Math.min(S.y,w.y),Y=Math.max(S.y,w.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${L}px,${F}px)`,this._box.style.width=B-L+"px",this._box.style.height=Y-F+"px")})}mouseupWindow(u,p){if(!this._active)return;const w=this._startPos,S=p;if(w&&u.button===0){if(this.reset(),Z(),w.x!==S.x||w.y!==S.y)return this._map.fire(new a.Event("boxzoomend",{originalEvent:u})),{cameraAnimation:A=>A.fitScreenCoordinates(w,S,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",u)}}keydown(u){this._active&&u.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",u))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),te(),delete this._startPos,delete this._lastPos}_fireEvent(u,p){return this._map.fire(new a.Event(u,{originalEvent:p}))}}function bl(y,u){const p={};for(let w=0;w<y.length;w++)p[y[w].identifier]=u[w];return p}class Hc{constructor(u){this.reset(),this.numTouches=u.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(u,p,w){(this.centroid||w.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=u.timeStamp),w.length===this.numTouches&&(this.centroid=function(S){const A=new a.pointGeometry(0,0);for(const L of S)A._add(L);return A.div(S.length)}(p),this.touches=bl(w,p)))}touchmove(u,p,w){if(this.aborted||!this.centroid)return;const S=bl(w,p);for(const A in this.touches){const L=this.touches[A],B=S[A];(!B||B.dist(L)>30)&&(this.aborted=!0)}}touchend(u,p,w){if((!this.centroid||u.timeStamp-this.startTime>500)&&(this.aborted=!0),w.length===0){const S=!this.aborted&&this.centroid;if(this.reset(),S)return S}}}class ds{constructor(u){this.singleTap=new Hc(u),this.numTaps=u.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(u,p,w){this.singleTap.touchstart(u,p,w)}touchmove(u,p,w){this.singleTap.touchmove(u,p,w)}touchend(u,p,w){const S=this.singleTap.touchend(u,p,w);if(S){const A=u.timeStamp-this.lastTime<500,L=!this.lastTap||this.lastTap.dist(S)<30;if(A&&L||this.reset(),this.count++,this.lastTime=u.timeStamp,this.lastTap=S,this.count===this.numTaps)return this.reset(),S}}}class tc{constructor(){this._zoomIn=new ds({numTouches:1,numTaps:2}),this._zoomOut=new ds({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(u,p,w){this._zoomIn.touchstart(u,p,w),this._zoomOut.touchstart(u,p,w)}touchmove(u,p,w){this._zoomIn.touchmove(u,p,w),this._zoomOut.touchmove(u,p,w)}touchend(u,p,w){const S=this._zoomIn.touchend(u,p,w),A=this._zoomOut.touchend(u,p,w);return S?(this._active=!0,u.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:L=>L.easeTo({duration:300,zoom:L.getZoom()+1,around:L.unproject(S)},{originalEvent:u})}):A?(this._active=!0,u.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:L=>L.easeTo({duration:300,zoom:L.getZoom()-1,around:L.unproject(A)},{originalEvent:u})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Xc={0:1,2:2};class wl{constructor(u){this.reset(),this._clickTolerance=u.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(u,p){return!1}_move(u,p){return{}}mousedown(u,p){if(this._lastPoint)return;const w=fe(u);this._correctButton(u,w)&&(this._lastPoint=p,this._eventButton=w)}mousemoveWindow(u,p){const w=this._lastPoint;if(w){if(u.preventDefault(),this._eventButton!=null&&function(S,A){const L=Xc[A];return S.buttons===void 0||(S.buttons&L)!==L}(u,this._eventButton))this.reset();else if(this._moved||!(p.dist(w)<this._clickTolerance))return this._moved=!0,this._lastPoint=p,this._move(w,p)}}mouseupWindow(u){this._lastPoint&&fe(u)===this._eventButton&&(this._moved&&Z(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Yc extends wl{mousedown(u,p){super.mousedown(u,p),this._lastPoint&&(this._active=!0)}_correctButton(u,p){return p===0&&!u.ctrlKey}_move(u,p){return{around:p,panDelta:p.sub(u)}}}class ic extends wl{_correctButton(u,p){return p===0&&u.ctrlKey||p===2}_move(u,p){const w=.8*(p.x-u.x);if(w)return this._active=!0,{bearingDelta:w}}contextmenu(u){u.preventDefault()}}class rc extends wl{_correctButton(u,p){return p===0&&u.ctrlKey||p===2}_move(u,p){const w=-.5*(p.y-u.y);if(w)return this._active=!0,{pitchDelta:w}}contextmenu(u){u.preventDefault()}}class fs{constructor(u,p){this._map=u,this._el=u.getCanvasContainer(),this._minTouches=1,this._clickTolerance=p.clickTolerance||1,this.reset(),a.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new a.pointGeometry(0,0)}touchstart(u,p,w){return this._calculateTransform(u,p,w)}touchmove(u,p,w){if(this._active&&!(w.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(w.length===1&&!a.isFullscreen())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return u.cancelable&&u.preventDefault(),this._calculateTransform(u,p,w)}}touchend(u,p,w){this._calculateTransform(u,p,w),this._active&&w.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(u,p,w){w.length>0&&(this._active=!0);const S=bl(w,p),A=new a.pointGeometry(0,0),L=new a.pointGeometry(0,0);let B=0;for(const Y in S){const X=S[Y],ie=this._touches[Y];ie&&(A._add(X),L._add(X.sub(ie)),B++,S[Y]=X)}if(this._touches=S,B<this._minTouches||!L.mag())return;const F=L.div(B);return this._sum._add(F),this._sum.mag()<this._clickTolerance?void 0:{around:A.div(B),panDelta:F}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=D("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")},500)}}class El{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(u){}_move(u,p,w){return{}}touchstart(u,p,w){this._firstTwoTouches||w.length<2||(this._firstTwoTouches=[w[0].identifier,w[1].identifier],this._start([p[0],p[1]]))}touchmove(u,p,w){const S=this._firstTwoTouches;if(!S)return;u.preventDefault();const[A,L]=S,B=Vs(w,p,A),F=Vs(w,p,L);if(!B||!F)return;const Y=this._aroundCenter?null:B.add(F).div(2);return this._move([B,F],Y,u)}touchend(u,p,w){if(!this._firstTwoTouches)return;const[S,A]=this._firstTwoTouches,L=Vs(w,p,S),B=Vs(w,p,A);L&&B||(this._active&&Z(),this.reset())}touchcancel(){this.reset()}enable(u){this._enabled=!0,this._aroundCenter=!!u&&u.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Vs(y,u,p){for(let w=0;w<y.length;w++)if(y[w].identifier===p)return u[w]}function Wc(y,u){return Math.log(y/u)/Math.LN2}class Kc extends El{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(u){this._startDistance=this._distance=u[0].dist(u[1])}_move(u,p){const w=this._distance;if(this._distance=u[0].dist(u[1]),this._active||!(Math.abs(Wc(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Wc(this._distance,w),pinchAround:p}}}function nc(y,u){return 180*y.angleWith(u)/Math.PI}class Qc extends El{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(u){this._startVector=this._vector=u[0].sub(u[1]),this._minDiameter=u[0].dist(u[1])}_move(u,p){const w=this._vector;if(this._vector=u[0].sub(u[1]),w&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:nc(this._vector,w),pinchAround:p}}_isBelowThreshold(u){this._minDiameter=Math.min(this._minDiameter,u.mag());const p=25/(Math.PI*this._minDiameter)*360,w=this._startVector;if(!w)return!1;const S=nc(u,w);return Math.abs(S)<p}}function Tl(y){return Math.abs(y.y)>Math.abs(y.x)}class Cn extends El{constructor(u){super(),this._map=u}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(u){this._lastPoints=u,Tl(u[0].sub(u[1]))&&(this._valid=!1)}_move(u,p,w){const S=this._lastPoints;if(!S)return;const A=u[0].sub(S[0]),L=u[1].sub(S[1]);return this._map._cooperativeGestures&&!a.isFullscreen()&&w.touches.length<3||(this._valid=this.gestureBeginsVertically(A,L,w.timeStamp),!this._valid)?void 0:(this._lastPoints=u,this._active=!0,{pitchDelta:(A.y+L.y)/2*-.5})}gestureBeginsVertically(u,p,w){if(this._valid!==void 0)return this._valid;const S=u.mag()>=2,A=p.mag()>=2;if(!S&&!A)return;if(!S||!A)return this._firstMove==null&&(this._firstMove=w),w-this._firstMove<100&&void 0;const L=u.y>0==p.y>0;return Tl(u)&&Tl(p)&&L}}const Ju={panStep:100,bearingStep:15,pitchStep:10};class Jc{constructor(){const u=Ju;this._panStep=u.panStep,this._bearingStep=u.bearingStep,this._pitchStep=u.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(u){if(u.altKey||u.ctrlKey||u.metaKey)return;let p=0,w=0,S=0,A=0,L=0;switch(u.keyCode){case 61:case 107:case 171:case 187:p=1;break;case 189:case 109:case 173:p=-1;break;case 37:u.shiftKey?w=-1:(u.preventDefault(),A=-1);break;case 39:u.shiftKey?w=1:(u.preventDefault(),A=1);break;case 38:u.shiftKey?S=1:(u.preventDefault(),L=-1);break;case 40:u.shiftKey?S=-1:(u.preventDefault(),L=1);break;default:return}return this._rotationDisabled&&(w=0,S=0),{cameraAnimation:B=>{const F=B.getZoom();B.easeTo({duration:300,easeId:"keyboardHandler",easing:eh,zoom:p?Math.round(F)+p*(u.shiftKey?2:1):F,bearing:B.getBearing()+w*this._bearingStep,pitch:B.getPitch()+S*this._pitchStep,offset:[-A*this._panStep,-L*this._panStep],center:B.getCenter()},{originalEvent:u})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function eh(y){return y*(2-y)}const eu=4.000244140625;class qo{constructor(u,p){this._map=u,this._el=u.getCanvasContainer(),this._handler=p,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,a.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(u){this._defaultZoomRate=u}setWheelZoomRate(u){this._wheelZoomRate=u}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(u){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!u&&u.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(u){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(u.ctrlKey||u.metaKey||this.isZooming()||a.isFullscreen()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let p=u.deltaMode===a.window.WheelEvent.DOM_DELTA_LINE?40*u.deltaY:u.deltaY;const w=a.exported.now(),S=w-(this._lastWheelEventTime||0);this._lastWheelEventTime=w,p!==0&&p%eu==0?this._type="wheel":p!==0&&Math.abs(p)<4?this._type="trackpad":S>400?(this._type=null,this._lastValue=p,this._timeout=setTimeout(this._onTimeout,40,u)):this._type||(this._type=Math.abs(S*p)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,p+=this._lastValue)),u.shiftKey&&p&&(p/=4),this._type&&(this._lastWheelEvent=u,this._delta-=p,this._active||this._start(u)),u.preventDefault()}_onTimeout(u){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(u)}_start(u){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const p=W(this._el,u);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:p,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const u=this._map.transform;this._type==="wheel"&&u.projection.wrap&&(u._center.lng>=180||u._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const p=()=>u._terrainEnabled()&&this._aroundCoord?u.computeZoomRelativeTo(this._aroundCoord):u.zoom;if(this._delta!==0){const F=this._type==="wheel"&&Math.abs(this._delta)>eu?this._wheelZoomRate:this._defaultZoomRate;let Y=2/(1+Math.exp(-Math.abs(this._delta*F)));this._delta<0&&Y!==0&&(Y=1/Y);const X=p(),ie=Math.pow(2,X),de=typeof this._targetZoom=="number"?u.zoomScale(this._targetZoom):ie;this._targetZoom=Math.min(u.maxZoom,Math.max(u.minZoom,u.scaleZoom(de*Y))),this._type==="wheel"&&(this._startZoom=X,this._easing=this._smoothOutEasing(200)),this._delta=0}const w=typeof this._targetZoom=="number"?this._targetZoom:p(),S=this._startZoom,A=this._easing;let L,B=!1;if(this._type==="wheel"&&S&&A){const F=Math.min((a.exported.now()-this._lastWheelEventTime)/200,1),Y=A(F);L=a.number(S,w,Y),F<1?this._frameId||(this._frameId=!0):B=!0}else L=w,B=!0;return this._active=!0,B&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!B,zoomDelta:L-p(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(u){let p=a.ease;if(this._prevEase){const w=this._prevEase,S=(a.exported.now()-w.start)/w.duration,A=w.easing(S+.01)-w.easing(S),L=.27/Math.sqrt(A*A+1e-4)*.01,B=Math.sqrt(.0729-L*L);p=a.bezier(L,B,.25,1)}return this._prevEase={start:a.exported.now(),duration:u,easing:p},p}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=D("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(a.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")},200)}}class tu{constructor(u,p){this._clickZoom=u,this._tapZoom=p}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ps{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(u,p){return u.preventDefault(),{cameraAnimation:w=>{w.easeTo({duration:300,zoom:w.getZoom()+(u.shiftKey?-1:1),around:w.unproject(p)},{originalEvent:u})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Mo{constructor(){this._tap=new ds({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(u,p,w){this._swipePoint||(this._tapTime&&u.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?w.length>0&&(this._swipePoint=p[0],this._swipeTouch=w[0].identifier):this._tap.touchstart(u,p,w))}touchmove(u,p,w){if(this._tapTime){if(this._swipePoint){if(w[0].identifier!==this._swipeTouch)return;const S=p[0],A=S.y-this._swipePoint.y;return this._swipePoint=S,u.preventDefault(),this._active=!0,{zoomDelta:A/128}}}else this._tap.touchmove(u,p,w)}touchend(u,p,w){this._tapTime?this._swipePoint&&w.length===0&&this.reset():this._tap.touchend(u,p,w)&&(this._tapTime=u.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Sl{constructor(u,p,w){this._el=u,this._mousePan=p,this._touchPan=w}enable(u){this._inertiaOptions=u||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Ti{constructor(u,p,w){this._pitchWithRotate=u.pitchWithRotate,this._mouseRotate=p,this._mousePitch=w}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class iu{constructor(u,p,w,S){this._el=u,this._touchZoom=p,this._touchRotate=w,this._tapDragZoom=S,this._rotationDisabled=!1,this._enabled=!0}enable(u){this._touchZoom.enable(u),this._rotationDisabled||this._touchRotate.enable(u),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const js=y=>y.zoom||y.drag||y.pitch||y.rotate;class qs extends a.Event{}class Gs{constructor(){this.constants=[1,1,.01],this.radius=0}setup(u,p){const w=a.sub([],p,u);this.radius=a.length(w[2]<0?a.div([],w,this.constants):[w[0],w[1],0])}projectRay(u){a.div(u,u,this.constants),a.normalize(u,u),a.mul$1(u,u,this.constants);const p=a.scale$2([],u,this.radius);if(p[2]>0){const w=a.scale$2([],[0,0,1],a.dot(p,[0,0,1])),S=a.scale$2([],a.normalize([],[p[0],p[1],0]),this.radius),A=a.add([],p,a.scale$2([],a.sub([],a.add([],S,w),p),2));p[0]=A[0],p[1]=A[1]}return p}}function Zs(y){return y.panDelta&&y.panDelta.mag()||y.zoomDelta||y.bearingDelta||y.pitchDelta}class ru{constructor(u,p){this._map=u,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new yl(u),this._bearingSnap=p.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Gs,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(p),a.bindAll(["handleEvent","handleWindowEvent"],this);const w=this._el;this._listeners=[[w,"touchstart",{passive:!0}],[w,"touchmove",{passive:!1}],[w,"touchend",void 0],[w,"touchcancel",void 0],[w,"mousedown",void 0],[w,"mousemove",void 0],[w,"mouseup",void 0],[a.window.document,"mousemove",{capture:!0}],[a.window.document,"mouseup",void 0],[w,"mouseover",void 0],[w,"mouseout",void 0],[w,"dblclick",void 0],[w,"click",void 0],[w,"keydown",{capture:!1}],[w,"keyup",void 0],[w,"wheel",{passive:!1}],[w,"contextmenu",void 0],[a.window,"blur",void 0]];for(const[S,A,L]of this._listeners)S.addEventListener(A,S===a.window.document?this.handleWindowEvent:this.handleEvent,L)}destroy(){for(const[u,p,w]of this._listeners)u.removeEventListener(p,u===a.window.document?this.handleWindowEvent:this.handleEvent,w)}_addDefaultHandlers(u){const p=this._map,w=p.getCanvasContainer();this._add("mapEvent",new Zc(p,u));const S=p.boxZoom=new ec(p,u);this._add("boxZoom",S);const A=new tc,L=new ps;p.doubleClickZoom=new tu(L,A),this._add("tapZoom",A),this._add("clickZoom",L);const B=new Mo;this._add("tapDragZoom",B);const F=p.touchPitch=new Cn(p);this._add("touchPitch",F);const Y=new ic(u),X=new rc(u);p.dragRotate=new Ti(u,Y,X),this._add("mouseRotate",Y,["mousePitch"]),this._add("mousePitch",X,["mouseRotate"]);const ie=new Yc(u),de=new fs(p,u);p.dragPan=new Sl(w,ie,de),this._add("mousePan",ie),this._add("touchPan",de,["touchZoom","touchRotate"]);const ge=new Qc,ye=new Kc;p.touchZoomRotate=new iu(w,ye,ge,B),this._add("touchRotate",ge,["touchPan","touchZoom"]),this._add("touchZoom",ye,["touchPan","touchRotate"]),this._add("blockableMapEvent",new xl(p));const ve=p.scrollZoom=new qo(p,this);this._add("scrollZoom",ve,["mousePan"]);const xe=p.keyboard=new Jc;this._add("keyboard",xe);for(const ce of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])u.interactive&&u[ce]&&p[ce].enable(u[ce])}_add(u,p,w){this._handlers.push({handlerName:u,handler:p,allowed:w}),this._handlersById[u]=p}stop(u){if(!this._updatingCamera){for(const{handler:p}of this._handlers)p.reset();this._inertia.clear(),this._fireEvents({},{},u),this._changes=[]}}isActive(){for(const{handler:u}of this._handlers)if(u.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!js(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(u,p,w){for(const S in u)if(S!==w&&(!p||p.indexOf(S)<0))return!0;return!1}handleWindowEvent(u){this.handleEvent(u,`${u.type}Window`)}_getMapTouches(u){const p=[];for(const w of u)this._el.contains(w.target)&&p.push(w);return p}handleEvent(u,p){this._updatingCamera=!0;const w=u.type==="renderFrame",S=w?void 0:u,A={needsRenderFrame:!1},L={},B={},F=u.touches?this._getMapTouches(u.touches):void 0,Y=F?_e(this._el,F):w?void 0:W(this._el,u);for(const{handlerName:de,handler:ge,allowed:ye}of this._handlers){if(!ge.isEnabled())continue;let ve;this._blockedByActive(B,ye,de)?ge.reset():ge[p||u.type]&&(ve=ge[p||u.type](u,Y,F),this.mergeHandlerResult(A,L,ve,de,S),ve&&ve.needsRenderFrame&&this._triggerRenderFrame()),(ve||ge.isActive())&&(B[de]=ge)}const X={};for(const de in this._previousActiveHandlers)B[de]||(X[de]=S);this._previousActiveHandlers=B,(Object.keys(X).length||Zs(A))&&(this._changes.push([A,L,X]),this._triggerRenderFrame()),(Object.keys(B).length||Zs(A))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ie}=A;ie&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ie(this._map))}mergeHandlerResult(u,p,w,S,A){if(!w)return;a.extend(u,w);const L={handlerName:S,originalEvent:w.originalEvent||A};w.zoomDelta!==void 0&&(p.zoom=L),w.panDelta!==void 0&&(p.drag=L),w.pitchDelta!==void 0&&(p.pitch=L),w.bearingDelta!==void 0&&(p.rotate=L)}_applyChanges(){const u={},p={},w={};for(const[S,A,L]of this._changes)S.panDelta&&(u.panDelta=(u.panDelta||new a.pointGeometry(0,0))._add(S.panDelta)),S.zoomDelta&&(u.zoomDelta=(u.zoomDelta||0)+S.zoomDelta),S.bearingDelta&&(u.bearingDelta=(u.bearingDelta||0)+S.bearingDelta),S.pitchDelta&&(u.pitchDelta=(u.pitchDelta||0)+S.pitchDelta),S.around!==void 0&&(u.around=S.around),S.aroundCoord!==void 0&&(u.aroundCoord=S.aroundCoord),S.pinchAround!==void 0&&(u.pinchAround=S.pinchAround),S.noInertia&&(u.noInertia=S.noInertia),a.extend(p,A),a.extend(w,L);this._updateMapTransform(u,p,w),this._changes=[]}_updateMapTransform(u,p,w){const S=this._map,A=S.transform,L=Se=>[Se.x,Se.y,Se.z];if((Se=>{const Te=this._eventsInProgress.drag;return Te&&!this._handlersById[Te.handlerName].isActive()})()&&!Zs(u)){const Se=A.zoom;A.cameraElevationReference="sea",A.recenterOnTerrain(),A.cameraElevationReference="ground",Se!==A.zoom&&this._map._update(!0)}if(A._isCameraConstrained&&S._stop(!0),!Zs(u))return void this._fireEvents(p,w,!0);let{panDelta:B,zoomDelta:F,bearingDelta:Y,pitchDelta:X,around:ie,aroundCoord:de,pinchAround:ge}=u;A._isCameraConstrained&&(F>0&&(F=0),A._isCameraConstrained=!1),ge!==void 0&&(ie=ge),(F||(Se=>p.drag&&!this._eventsInProgress.drag)())&&ie&&(this._dragOrigin=L(A.pointCoordinate3D(ie)),this._trackingEllipsoid.setup(A._camera.position,this._dragOrigin)),A.cameraElevationReference="sea",S._stop(!0),ie=ie||S.transform.centerPoint,Y&&(A.bearing+=Y),X&&(A.pitch+=X),A._updateCameraState();const ye=[0,0,0];if(B)if(A.projection.name==="mercator"){const Se=this._trackingEllipsoid.projectRay(A.screenPointToMercatorRay(ie).dir),Te=this._trackingEllipsoid.projectRay(A.screenPointToMercatorRay(ie.sub(B)).dir);ye[0]=Te[0]-Se[0],ye[1]=Te[1]-Se[1]}else{const Se=A.pointCoordinate(ie);if(A.projection.name==="globe"){B=B.rotate(-A.angle);const Te=A._pixelsPerMercatorPixel/A.worldSize;ye[0]=-B.x*a.mercatorScale(a.latFromMercatorY(Se.y))*Te,ye[1]=-B.y*a.mercatorScale(A.center.lat)*Te}else{const Te=A.pointCoordinate(ie.sub(B));Se&&Te&&(ye[0]=Te.x-Se.x,ye[1]=Te.y-Se.y)}}const ve=A.zoom,xe=[0,0,0];if(F){const Se=L(de||A.pointCoordinate3D(ie)),Te={dir:a.normalize([],a.sub([],Se,A._camera.position))};if(Te.dir[2]<0){const Ae=A.zoomDeltaToMovement(Se,F);a.scale$2(xe,Te.dir,Ae)}}const ce=a.add(ye,ye,xe);A._translateCameraConstrained(ce),F&&Math.abs(A.zoom-ve)>1e-4&&A.recenterOnTerrain(),A.cameraElevationReference="ground",this._map._update(),u.noInertia||this._inertia.record(u),this._fireEvents(p,w,!0)}_fireEvents(u,p,w){const S=js(this._eventsInProgress),A=js(u),L={};for(const X in u){const{originalEvent:ie}=u[X];this._eventsInProgress[X]||(L[`${X}start`]=ie),this._eventsInProgress[X]=u[X]}!S&&A&&this._fireEvent("movestart",A.originalEvent);for(const X in L)this._fireEvent(X,L[X]);A&&this._fireEvent("move",A.originalEvent);for(const X in u){const{originalEvent:ie}=u[X];this._fireEvent(X,ie)}const B={};let F;for(const X in this._eventsInProgress){const{handlerName:ie,originalEvent:de}=this._eventsInProgress[X];this._handlersById[ie].isActive()||(delete this._eventsInProgress[X],F=p[ie]||de,B[`${X}end`]=F)}for(const X in B)this._fireEvent(X,B[X]);const Y=js(this._eventsInProgress);if(w&&(S||A)&&!Y){this._updatingCamera=!0;const X=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),ie=de=>de!==0&&-this._bearingSnap<de&&de<this._bearingSnap;X?(ie(X.bearing||this._map.getBearing())&&(X.bearing=0),this._map.easeTo(X,{originalEvent:F})):(this._map.fire(new a.Event("moveend",{originalEvent:F})),ie(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(u,p){this._map.fire(new a.Event(u,p?{originalEvent:p}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(u=>{this._frameId=void 0,this.handleEvent(new qs("renderFrame",{timeStamp:u})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const oc="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class nu extends a.Evented{constructor(u,p){super(),this._moving=!1,this._zooming=!1,this.transform=u,this._bearingSnap=p.bearingSnap,a.bindAll(["_renderFrameCallback"],this)}getCenter(){return new a.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(u,p){return this.jumpTo({center:u},p)}panBy(u,p,w){return u=a.pointGeometry.convert(u).mult(-1),this.panTo(this.transform.center,a.extend({offset:u},p),w)}panTo(u,p,w){return this.easeTo(a.extend({center:u},p),w)}getZoom(){return this.transform.zoom}setZoom(u,p){return this.jumpTo({zoom:u},p),this}zoomTo(u,p,w){return this.easeTo(a.extend({zoom:u},p),w)}zoomIn(u,p){return this.zoomTo(this.getZoom()+1,u,p),this}zoomOut(u,p){return this.zoomTo(this.getZoom()-1,u,p),this}getBearing(){return this.transform.bearing}setBearing(u,p){return this.jumpTo({bearing:u},p),this}getPadding(){return this.transform.padding}setPadding(u,p){return this.jumpTo({padding:u},p),this}rotateTo(u,p,w){return this.easeTo(a.extend({bearing:u},p),w)}resetNorth(u,p){return this.rotateTo(0,a.extend({duration:1e3},u),p),this}resetNorthPitch(u,p){return this.easeTo(a.extend({bearing:0,pitch:0,duration:1e3},u),p),this}snapToNorth(u,p){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(u,p):this}getPitch(){return this.transform.pitch}setPitch(u,p){return this.jumpTo({pitch:u},p),this}cameraForBounds(u,p){u=a.LngLatBounds.convert(u);const w=p&&p.bearing||0,S=p&&p.pitch||0,A=u.getNorthWest(),L=u.getSouthEast();return this._cameraForBounds(this.transform,A,L,w,S,p)}_extendCameraOptions(u){const p={top:0,bottom:0,right:0,left:0};if(typeof(u=a.extend({padding:p,offset:[0,0],maxZoom:this.transform.maxZoom},u)).padding=="number"){const w=u.padding;u.padding={top:w,bottom:w,right:w,left:w}}return u.padding=a.extend(p,u.padding),u}_minimumAABBFrustumDistance(u,p){const w=p.max[0]-p.min[0],S=p.max[1]-p.min[1];return w/S>u.aspect?w/(2*Math.tan(.5*u.fovX)*u.aspect):S/(2*Math.tan(.5*u.fovY)*u.aspect)}_cameraForBoundsOnGlobe(u,p,w,S,A,L){const B=u.clone(),F=this._extendCameraOptions(L);B.bearing=S,B.pitch=A;const Y=a.LngLat.convert(p),X=a.LngLat.convert(w),ie=.5*(Y.lat+X.lat),de=.5*(Y.lng+X.lng),ge=a.latLngToECEF(ie,de),ye=a.normalize([],ge),ve=a.normalize([],a.cross([],ye,[0,1,0])),xe=a.cross([],ve,ye),ce=[ve[0],ve[1],ve[2],0,xe[0],xe[1],xe[2],0,ye[0],ye[1],ye[2],0,0,0,0,1],Se=[ge,a.latLngToECEF(Y.lat,Y.lng),a.latLngToECEF(X.lat,Y.lng),a.latLngToECEF(X.lat,X.lng),a.latLngToECEF(Y.lat,X.lng),a.latLngToECEF(ie,Y.lng),a.latLngToECEF(ie,X.lng),a.latLngToECEF(Y.lat,de),a.latLngToECEF(X.lat,de)];let Te=a.Aabb.fromPoints(Se.map(Lt=>[a.dot(ve,Lt),a.dot(xe,Lt),a.dot(ye,Lt)]));const Ae=a.transformMat4([],Te.center,ce);a.squaredLength(Ae)===0&&a.set(Ae,0,0,1),a.normalize(Ae,Ae),a.scale$2(Ae,Ae,a.GLOBE_RADIUS),B.center=a.ecefToLatLng(Ae);const Fe=B.getWorldToCameraMatrix(),$e=a.invert(new Float64Array(16),Fe);Te=a.Aabb.applyTransform(Te,a.multiply([],Fe,ce)),a.transformMat4(Ae,Ae,Fe);const qe=.5*(Te.max[2]-Te.min[2]),Je=this._minimumAABBFrustumDistance(B,Te),rt=a.scale$2([],[0,0,1],qe),lt=a.add(rt,Ae,rt),Jt=Je+(B.pitch===0?0:a.distance(Ae,lt)),et=B.globeCenterInViewSpace,Dt=a.sub([],Ae,[et[0],et[1],et[2]]);a.normalize(Dt,Dt),a.scale$2(Dt,Dt,Jt);const gt=a.add([],Ae,Dt);a.transformMat4(gt,gt,$e);const zt=a.earthRadius/a.GLOBE_RADIUS,at=a.length(gt),Ke=a.mercatorZfromAltitude(Math.max(at*zt-a.earthRadius,Number.EPSILON),0),ut=Math.min(B.zoomFromMercatorZAdjusted(Ke),F.maxZoom);return ut>.5*(a.GLOBE_ZOOM_THRESHOLD_MIN+a.GLOBE_ZOOM_THRESHOLD_MAX)?(B.setProjection({name:"mercator"}),B.zoom=ut,this._cameraForBounds(B,p,w,S,A,L)):{center:B.center,zoom:ut,bearing:S,pitch:A}}queryTerrainElevation(u,p){const w=this.transform.elevation;return w?(p=a.extend({},{exaggerated:!0},p),w.getAtPoint(a.MercatorCoordinate.fromLngLat(u),null,p.exaggerated)):null}_cameraForBounds(u,p,w,S,A,L){if(u.projection.name==="globe")return this._cameraForBoundsOnGlobe(u,p,w,S,A,L);const B=u.clone(),F=this._extendCameraOptions(L),Y=B.padding;B.bearing=S,B.pitch=A;const X=a.LngLat.convert(p),ie=a.LngLat.convert(w),de=new a.LngLat(X.lng,ie.lat),ge=new a.LngLat(ie.lng,X.lat),ye=B.project(X),ve=B.project(ie),xe=this.queryTerrainElevation(X),ce=this.queryTerrainElevation(ie),Se=this.queryTerrainElevation(de),Te=this.queryTerrainElevation(ge),Ae=[[ye.x,ye.y,Math.min(xe||0,ce||0,Se||0,Te||0)],[ve.x,ve.y,Math.max(xe||0,ce||0,Se||0,Te||0)]];let Fe=a.Aabb.fromPoints(Ae);const $e=B.getWorldToCameraMatrix(),qe=a.invert(new Float64Array(16),$e);Fe=a.Aabb.applyTransform(Fe,$e);const Je=a.sub([],Fe.max,Fe.min),rt=Y.left||0,lt=Y.right||0,Jt=Y.bottom||0,et=Y.top||0,{left:Dt,right:gt,top:zt,bottom:at}=F.padding,Ke=.5*(rt+lt),ut=.5*(et+Jt),Lt=Math.min(B.scaleZoom(B.scale*Math.min((B.width-(rt+lt+Dt+gt))/Je[0],(B.height-(Jt+et+at+zt))/Je[1])),F.maxZoom),jt=B.scale/B.zoomScale(Lt);Fe=new a.Aabb([Fe.min[0]-(Dt+Ke)*jt,Fe.min[1]-(at+ut)*jt,Fe.min[2]],[Fe.max[0]+(gt+Ke)*jt,Fe.max[1]+(zt+ut)*jt,Fe.max[2]]);const Pi=.5*Je[2],er=this._minimumAABBFrustumDistance(B,Fe),Si=[0,0,1,0];a.transformMat4$1(Si,Si,$e),a.normalize$2(Si,Si);const yi=a.scale$2([],Si,er+Pi),Oi=a.add([],Fe.center,yi),ar=(typeof F.offset.x=="number"&&typeof F.offset.y=="number"?new a.pointGeometry(F.offset.x,F.offset.y):a.pointGeometry.convert(F.offset)).rotate(-a.degToRad(S));Fe.center[0]-=ar.x*jt,Fe.center[1]+=ar.y*jt,a.transformMat4(Fe.center,Fe.center,qe),a.transformMat4(Oi,Oi,qe);const Ui=[Fe.center[0],Fe.center[1],Oi[2]*B.pixelsPerMeter];a.scale$2(Ui,Ui,1/B.worldSize);const yr=a.lngFromMercatorX(Ui[0]),vr=a.latFromMercatorY(Ui[1]),Dr=Math.min(B._zoomFromMercatorZ(Ui[2]),F.maxZoom),Ar=new a.LngLat(yr,vr);return B.mercatorFromTransition&&Dr<.5*(a.GLOBE_ZOOM_THRESHOLD_MIN+a.GLOBE_ZOOM_THRESHOLD_MAX)?(B.setProjection({name:"globe"}),B.zoom=Dr,this._cameraForBounds(B,p,w,S,A,L)):{center:Ar,zoom:Dr,bearing:S,pitch:A}}fitBounds(u,p,w){const S=this.cameraForBounds(u,p);return this._fitInternal(S,p,w)}fitScreenCoordinates(u,p,w,S,A){const L=a.pointGeometry.convert(u),B=a.pointGeometry.convert(p),F=new a.pointGeometry(Math.min(L.x,B.x),Math.min(L.y,B.y)),Y=new a.pointGeometry(Math.max(L.x,B.x),Math.max(L.y,B.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(L,B))return this;const X=this.transform.pointLocation3D(F),ie=this.transform.pointLocation3D(Y),de=this.transform.pointLocation3D(new a.pointGeometry(F.x,Y.y)),ge=this.transform.pointLocation3D(new a.pointGeometry(Y.x,F.y)),ye=[Math.min(X.lng,ie.lng,de.lng,ge.lng),Math.min(X.lat,ie.lat,de.lat,ge.lat)],ve=[Math.max(X.lng,ie.lng,de.lng,ge.lng),Math.max(X.lat,ie.lat,de.lat,ge.lat)],xe=S&&S.pitch?S.pitch:this.getPitch(),ce=this._cameraForBounds(this.transform,ye,ve,w,xe,S);return this._fitInternal(ce,S,A)}_fitInternal(u,p,w){return u?(delete(p=a.extend(u,p)).padding,p.linear?this.easeTo(p,w):this.flyTo(p,w)):this}jumpTo(u,p){this.stop();const w=u.preloadOnly?this.transform.clone():this.transform;let S=!1,A=!1,L=!1;return"zoom"in u&&w.zoom!==+u.zoom&&(S=!0,w.zoom=+u.zoom),u.center!==void 0&&(w.center=a.LngLat.convert(u.center)),"bearing"in u&&w.bearing!==+u.bearing&&(A=!0,w.bearing=+u.bearing),"pitch"in u&&w.pitch!==+u.pitch&&(L=!0,w.pitch=+u.pitch),u.padding==null||w.isPaddingEqual(u.padding)||(w.padding=u.padding),u.preloadOnly?(this._preloadTiles(w),this):(this.fire(new a.Event("movestart",p)).fire(new a.Event("move",p)),S&&this.fire(new a.Event("zoomstart",p)).fire(new a.Event("zoom",p)).fire(new a.Event("zoomend",p)),A&&this.fire(new a.Event("rotatestart",p)).fire(new a.Event("rotate",p)).fire(new a.Event("rotateend",p)),L&&this.fire(new a.Event("pitchstart",p)).fire(new a.Event("pitch",p)).fire(new a.Event("pitchend",p)),this.fire(new a.Event("moveend",p)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||a.warnOnce(oc),this.transform.getFreeCameraOptions()}setFreeCameraOptions(u,p){const w=this.transform;if(!w.projection.supportsFreeCamera)return a.warnOnce(oc),this;this.stop();const S=w.zoom,A=w.pitch,L=w.bearing;w.setFreeCameraOptions(u);const B=S!==w.zoom,F=A!==w.pitch,Y=L!==w.bearing;return this.fire(new a.Event("movestart",p)).fire(new a.Event("move",p)),B&&this.fire(new a.Event("zoomstart",p)).fire(new a.Event("zoom",p)).fire(new a.Event("zoomend",p)),Y&&this.fire(new a.Event("rotatestart",p)).fire(new a.Event("rotate",p)).fire(new a.Event("rotateend",p)),F&&this.fire(new a.Event("pitchstart",p)).fire(new a.Event("pitch",p)).fire(new a.Event("pitchend",p)),this.fire(new a.Event("moveend",p)),this}easeTo(u,p){this._stop(!1,u.easeId),((u=a.extend({offset:[0,0],duration:500,easing:a.ease},u)).animate===!1||!u.essential&&a.exported.prefersReducedMotion)&&(u.duration=0);const w=this.transform,S=this.getZoom(),A=this.getBearing(),L=this.getPitch(),B=this.getPadding(),F="zoom"in u?+u.zoom:S,Y="bearing"in u?this._normalizeBearing(u.bearing,A):A,X="pitch"in u?+u.pitch:L,ie="padding"in u?u.padding:w.padding,de=a.pointGeometry.convert(u.offset);let ge,ye,ve;if(w.projection.name==="globe"){const rt=a.MercatorCoordinate.fromLngLat(w.center),lt=de.rotate(-w.angle);rt.x+=lt.x/w.worldSize,rt.y+=lt.y/w.worldSize;const Jt=rt.toLngLat(),et=a.LngLat.convert(u.center||Jt);this._normalizeCenter(et),ge=w.centerPoint.add(lt),ye=new a.pointGeometry(rt.x,rt.y).mult(w.worldSize),ve=new a.pointGeometry(a.mercatorXfromLng(et.lng),a.mercatorYfromLat(et.lat)).mult(w.worldSize).sub(ye)}else{ge=w.centerPoint.add(de);const rt=w.pointLocation(ge),lt=a.LngLat.convert(u.center||rt);this._normalizeCenter(lt),ye=w.project(rt),ve=w.project(lt).sub(ye)}const xe=w.zoomScale(F-S);let ce,Se;u.around&&(ce=a.LngLat.convert(u.around),Se=w.locationPoint(ce));const Te=this._zooming||F!==S,Ae=this._rotating||A!==Y,Fe=this._pitching||X!==L,$e=!w.isPaddingEqual(ie),qe=rt=>lt=>{if(Te&&(rt.zoom=a.number(S,F,lt)),Ae&&(rt.bearing=a.number(A,Y,lt)),Fe&&(rt.pitch=a.number(L,X,lt)),$e&&(rt.interpolatePadding(B,ie,lt),ge=rt.centerPoint.add(de)),ce)rt.setLocationAtPoint(ce,Se);else{const Jt=rt.zoomScale(rt.zoom-S),et=F>S?Math.min(2,xe):Math.max(.5,xe),Dt=Math.pow(et,1-lt),gt=rt.unproject(ye.add(ve.mult(lt*Dt)).mult(Jt));rt.setLocationAtPoint(rt.renderWorldCopies?gt.wrap():gt,ge)}return u.preloadOnly||this._fireMoveEvents(p),rt};if(u.preloadOnly){const rt=this._emulate(qe,u.duration,w);return this._preloadTiles(rt),this}const Je={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Te,this._rotating=Ae,this._pitching=Fe,this._padding=$e,this._easeId=u.easeId,this._prepareEase(p,u.noMoveStart,Je),this._ease(qe(w),rt=>{w.recenterOnTerrain(),this._afterEase(p,rt)},u),this}_prepareEase(u,p,w={}){this._moving=!0,this.transform.cameraElevationReference="sea",p||w.moving||this.fire(new a.Event("movestart",u)),this._zooming&&!w.zooming&&this.fire(new a.Event("zoomstart",u)),this._rotating&&!w.rotating&&this.fire(new a.Event("rotatestart",u)),this._pitching&&!w.pitching&&this.fire(new a.Event("pitchstart",u))}_fireMoveEvents(u){this.fire(new a.Event("move",u)),this._zooming&&this.fire(new a.Event("zoom",u)),this._rotating&&this.fire(new a.Event("rotate",u)),this._pitching&&this.fire(new a.Event("pitch",u))}_afterEase(u,p){if(this._easeId&&p&&this._easeId===p)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const w=this._zooming,S=this._rotating,A=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,w&&this.fire(new a.Event("zoomend",u)),S&&this.fire(new a.Event("rotateend",u)),A&&this.fire(new a.Event("pitchend",u)),this.fire(new a.Event("moveend",u))}flyTo(u,p){if(!u.essential&&a.exported.prefersReducedMotion){const Lt=a.pick(u,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Lt,p)}this.stop(),u=a.extend({offset:[0,0],speed:1.2,curve:1.42,easing:a.ease},u);const w=this.transform,S=this.getZoom(),A=this.getBearing(),L=this.getPitch(),B=this.getPadding(),F="zoom"in u?a.clamp(+u.zoom,w.minZoom,w.maxZoom):S,Y="bearing"in u?this._normalizeBearing(u.bearing,A):A,X="pitch"in u?+u.pitch:L,ie="padding"in u?u.padding:w.padding,de=w.zoomScale(F-S),ge=a.pointGeometry.convert(u.offset);let ye=w.centerPoint.add(ge);const ve=w.pointLocation(ye),xe=a.LngLat.convert(u.center||ve);this._normalizeCenter(xe);const ce=w.project(ve),Se=w.project(xe).sub(ce);let Te=u.curve;const Ae=Math.max(w.width,w.height),Fe=Ae/de,$e=Se.mag();if("minZoom"in u){const Lt=a.clamp(Math.min(u.minZoom,S,F),w.minZoom,w.maxZoom),jt=Ae/w.zoomScale(Lt-S);Te=Math.sqrt(jt/$e*2)}const qe=Te*Te;function Je(Lt){const jt=(Fe*Fe-Ae*Ae+(Lt?-1:1)*qe*qe*$e*$e)/(2*(Lt?Fe:Ae)*qe*$e);return Math.log(Math.sqrt(jt*jt+1)-jt)}function rt(Lt){return(Math.exp(Lt)-Math.exp(-Lt))/2}function lt(Lt){return(Math.exp(Lt)+Math.exp(-Lt))/2}const Jt=Je(0);let et=function(Lt){return lt(Jt)/lt(Jt+Te*Lt)},Dt=function(Lt){return Ae*((lt(Jt)*(rt(jt=Jt+Te*Lt)/lt(jt))-rt(Jt))/qe)/$e;var jt},gt=(Je(1)-Jt)/Te;if(Math.abs($e)<1e-6||!isFinite(gt)){if(Math.abs(Ae-Fe)<1e-6)return this.easeTo(u,p);const Lt=Fe<Ae?-1:1;gt=Math.abs(Math.log(Fe/Ae))/Te,Dt=function(){return 0},et=function(jt){return Math.exp(Lt*Te*jt)}}u.duration="duration"in u?+u.duration:1e3*gt/("screenSpeed"in u?+u.screenSpeed/Te:+u.speed),u.maxDuration&&u.duration>u.maxDuration&&(u.duration=0);const zt=A!==Y,at=X!==L,Ke=!w.isPaddingEqual(ie),ut=Lt=>jt=>{const Pi=jt*gt,er=1/et(Pi);Lt.zoom=jt===1?F:S+Lt.scaleZoom(er),zt&&(Lt.bearing=a.number(A,Y,jt)),at&&(Lt.pitch=a.number(L,X,jt)),Ke&&(Lt.interpolatePadding(B,ie,jt),ye=Lt.centerPoint.add(ge));const Si=jt===1?xe:Lt.unproject(ce.add(Se.mult(Dt(Pi))).mult(er));return Lt.setLocationAtPoint(Lt.renderWorldCopies?Si.wrap():Si,ye),Lt._updateCameraOnTerrain(),u.preloadOnly||this._fireMoveEvents(p),Lt};if(u.preloadOnly){const Lt=this._emulate(ut,u.duration,w);return this._preloadTiles(Lt),this}return this._zooming=!0,this._rotating=zt,this._pitching=at,this._padding=Ke,this._prepareEase(p,!1),this._ease(ut(w),()=>this._afterEase(p),u),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(u,p){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const w=this._onEaseEnd;this._onEaseEnd=void 0,w.call(this,p)}if(!u){const w=this.handlers;w&&w.stop(!1)}return this}_ease(u,p,w){w.animate===!1||w.duration===0?(u(1),p()):(this._easeStart=a.exported.now(),this._easeOptions=w,this._onEaseFrame=u,this._onEaseEnd=p,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const u=Math.min((a.exported.now()-this._easeStart)/this._easeOptions.duration,1),p=this._onEaseFrame;p&&p(this._easeOptions.easing(u)),u<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(u,p){u=a.wrap(u,-180,180);const w=Math.abs(u-p);return Math.abs(u-360-p)<w&&(u-=360),Math.abs(u+360-p)<w&&(u+=360),u}_normalizeCenter(u){const p=this.transform;if(!p.renderWorldCopies||p.maxBounds)return;const w=u.lng-p.center.lng;u.lng+=w>180?-360:w<-180?360:0}_emulate(u,p,w){const S=Math.ceil(15*p/1e3),A=[],L=u(w.clone());for(let B=0;B<=S;B++){const F=L(B/S);A.push(F.clone())}return A}}class ac{constructor(u={}){this.options=u,a.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(u){const p=this.options&&this.options.compact;return this._map=u,this._container=D("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=D("button","mapboxgl-ctrl-attrib-button",this._container),D("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=D("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),p&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),p===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(u,p){const w=this._map._getUIString(`AttributionControl.${p}`);u.setAttribute("aria-label",w),u.removeAttribute("title"),u.firstElementChild&&u.firstElementChild.setAttribute("title",w)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let u=this._editLink;u||(u=this._editLink=this._container.querySelector(".mapbox-improve-map"));const p=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||a.config.ACCESS_TOKEN}];if(u){const w=p.reduce((S,A,L)=>(A.value&&(S+=`${A.key}=${A.value}${L<p.length-1?"&":""}`),S),"?");u.href=`${a.config.FEEDBACK_URL}/${w}#${Ql(this._map,!0)}`,u.rel="noopener nofollow",this._setElementTitle(u,"MapFeedback")}}_updateData(u){!u||u.sourceDataType!=="metadata"&&u.sourceDataType!=="visibility"&&u.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let u=[];if(this._map.style.stylesheet){const S=this._map.style.stylesheet;this.styleOwner=S.owner,this.styleId=S.id}const p=this._map.style._sourceCaches;for(const S in p){const A=p[S];if(A.used){const L=A.getSource();L.attribution&&u.indexOf(L.attribution)<0&&u.push(L.attribution)}}u.sort((S,A)=>S.length-A.length),u=u.filter((S,A)=>{for(let L=A+1;L<u.length;L++)if(u[L].indexOf(S)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?u=[...this.options.customAttribution,...u]:u.unshift(this.options.customAttribution));const w=u.join(" | ");w!==this._attribHTML&&(this._attribHTML=w,u.length?(this._innerContainer.innerHTML=w,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class sc{constructor(){a.bindAll(["_updateLogo","_updateCompact"],this)}onAdd(u){this._map=u,this._container=D("div","mapboxgl-ctrl");const p=D("a","mapboxgl-ctrl-logo");return p.target="_blank",p.rel="noopener nofollow",p.href="https://www.mapbox.com/",p.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),p.setAttribute("rel","noopener nofollow"),this._container.appendChild(p),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(u){u&&u.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const u=this._map.style._sourceCaches;if(Object.entries(u).length===0)return!0;for(const p in u){const w=u[p].getSource();if(w.hasOwnProperty("mapbox_logo")&&!w.mapbox_logo)return!1}return!0}_updateCompact(){const u=this._container.children;if(u.length){const p=u[0];this._map.getCanvasContainer().offsetWidth<250?p.classList.add("mapboxgl-compact"):p.classList.remove("mapboxgl-compact")}}}class Hs{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(u){const p=++this._id;return this._queue.push({callback:u,id:p,cancelled:!1}),p}remove(u){const p=this._currentlyRunning,w=p?this._queue.concat(p):this._queue;for(const S of w)if(S.id===u)return void(S.cancelled=!0)}run(u=0){const p=this._currentlyRunning=this._queue;this._queue=[];for(const w of p)if(!w.cancelled&&(w.callback(u),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Ml(y,u,p){if(y=new a.LngLat(y.lng,y.lat),u){const w=new a.LngLat(y.lng-360,y.lat),S=new a.LngLat(y.lng+360,y.lat),A=360*Math.ceil(Math.abs(y.lng-p.center.lng)/360),L=p.locationPoint(y).distSqr(u),B=u.x<0||u.y<0||u.x>p.width||u.y>p.height;p.locationPoint(w).distSqr(u)<L&&(B||Math.abs(w.lng-p.center.lng)<A)?y=w:p.locationPoint(S).distSqr(u)<L&&(B||Math.abs(S.lng-p.center.lng)<A)&&(y=S)}for(;Math.abs(y.lng-p.center.lng)>180;){const w=p.locationPoint(y);if(w.x>=0&&w.y>=0&&w.x<=p.width&&w.y<=p.height)break;y.lng>p.center.lng?y.lng-=360:y.lng+=360}return y}const ms={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Al extends a.Evented{constructor(u,p){if(super(),(u instanceof a.window.HTMLElement||p)&&(u=a.extend({element:u},p)),a.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=u&&u.anchor||"center",this._color=u&&u.color||"#3FB1CE",this._scale=u&&u.scale||1,this._draggable=u&&u.draggable||!1,this._clickTolerance=u&&u.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=u&&u.rotation||0,this._rotationAlignment=u&&u.rotationAlignment||"auto",this._pitchAlignment=u&&u.pitchAlignment&&u.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=u&&u.occludedOpacity||.2,u&&u.element)this._element=u.element,this._offset=a.pointGeometry.convert(u&&u.offset||[0,0]);else{this._defaultMarker=!0,this._element=D("div");const S=41,A=27,L=k("svg",{display:"block",height:S*this._scale+"px",width:A*this._scale+"px",viewBox:`0 0 ${A} ${S}`},this._element),B=k("radialGradient",{id:"shadowGradient"},k("defs",{},L));k("stop",{offset:"10%","stop-opacity":.4},B),k("stop",{offset:"100%","stop-opacity":.05},B),k("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},L),k("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},L),k("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},L),k("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},L),this._offset=a.pointGeometry.convert(u&&u.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",S=>{S.preventDefault()}),this._element.addEventListener("mousedown",S=>{S.preventDefault()});const w=this._element.classList;for(const S in ms)w.remove(`mapboxgl-marker-anchor-${S}`);w.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(u){return u===this._map||(this.remove(),this._map=u,u.getCanvasContainer().appendChild(this._element),u.on("move",this._updateMoving),u.on("moveend",this._update),u.on("remove",this._clearFadeTimer),u._addMarker(this),this.setDraggable(this._draggable),this._update(),u.on("click",this._onMapClick)),this}remove(){const u=this._map;return u&&(u.off("click",this._onMapClick),u.off("move",this._updateMoving),u.off("moveend",this._update),u.off("mousedown",this._addDragHandler),u.off("touchstart",this._addDragHandler),u.off("mouseup",this._onUp),u.off("touchend",this._onUp),u.off("mousemove",this._onMove),u.off("touchmove",this._onMove),u.off("remove",this._clearFadeTimer),u._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(u){return this._lngLat=a.LngLat.convert(u),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(u){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),u){if(!("offset"in u.options)){const S=Math.sqrt(Math.pow(13.5,2)/2);u.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[S,-1*(38.1-13.5+S)],"bottom-right":[-S,-1*(38.1-13.5+S)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=u,u._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(u){const p=u.code,w=u.charCode||u.keyCode;p!=="Space"&&p!=="Enter"&&w!==32&&w!==13||this.togglePopup()}_onMapClick(u){const p=u.originalEvent.target,w=this._element;this._popup&&(p===w||w.contains(p))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const u=this._popup;return u?(u.isOpen()?(u.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(u.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const u=this._map,p=this._pos;if(!u||!p)return!1;const w=u.unproject(p),S=u.getFreeCameraOptions();if(!S.position)return!1;const A=S.position.toLngLat();return A.distanceTo(w)<.9*A.distanceTo(this._lngLat)}_evaluateOpacity(){const u=this._map;if(!u)return;const p=this._pos;if(!p||p.x<0||p.x>u.transform.width||p.y<0||p.y>u.transform.height)return void this._clearFadeTimer();const w=u.unproject(p);let S;u._showingGlobe()&&a.isLngLatBehindGlobe(u.transform,this._lngLat)?S=0:(S=1-u._queryFogOpacity(w),u.transform._terrainEnabled()&&u.getTerrain()&&this._behindTerrain()&&(S*=this._occludedOpacity)),this._element.style.opacity=`${S}`,this._element.style.pointerEvents=S>0?"auto":"none",this._popup&&this._popup._setOpacity(S),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const u=this._pos;if(!u||!this._map)return;const p=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${u.x}px,${u.y}px)
            ${ms[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${p.x}px,${p.y}px)
        `}_calculateXYTransform(){const u=this._pos,p=this._map,w=this.getPitchAlignment();if(!p||!u||w!=="map")return"";if(!p._showingGlobe()){const F=p.getPitch();return F?`rotateX(${F}deg)`:""}const S=a.radToDeg(a.globeTiltAtLngLat(p.transform,this._lngLat)),A=u.sub(a.globeCenterToScreenPoint(p.transform)),L=Math.abs(A.x)+Math.abs(A.y);if(L===0)return"";const B=S/L;return`rotateX(${-A.y*B}deg) rotateY(${A.x*B}deg)`}_calculateZTransform(){const u=this._pos,p=this._map;if(!p||!u)return"";let w=0;const S=this.getRotationAlignment();if(S==="map")if(p._showingGlobe()){const A=p.project(new a.LngLat(this._lngLat.lng,this._lngLat.lat+.001)),L=p.project(new a.LngLat(this._lngLat.lng,this._lngLat.lat-.001)).sub(A);w=a.radToDeg(Math.atan2(L.y,L.x))-90}else w=-p.getBearing();else if(S==="horizon"){const A=a.smoothstep(4,6,p.getZoom()),L=a.globeCenterToScreenPoint(p.transform);L.y+=A*p.transform.height;const B=u.sub(L),F=a.radToDeg(Math.atan2(B.y,B.x));w=(F>90?F-270:F+90)*(1-A)}return w+=this._rotation,w?`rotateZ(${w}deg)`:""}_update(u){a.window.cancelAnimationFrame(this._updateFrameId);const p=this._map;p&&(p.transform.renderWorldCopies&&(this._lngLat=Ml(this._lngLat,this._pos,p.transform)),this._pos=p.project(this._lngLat),u===!0?this._updateFrameId=a.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),p._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(p._showingGlobe()||p.getTerrain()||p.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(u){return this._offset=a.pointGeometry.convert(u),this._update(),this}_onMove(u){const p=this._map;if(!p)return;const w=this._pointerdownPos,S=this._positionDelta;if(w&&S){if(!this._isDragging){const A=this._clickTolerance||p._clickTolerance;if(u.point.dist(w)<A)return;this._isDragging=!0}this._pos=u.point.sub(S),this._lngLat=p.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new a.Event("dragstart"))),this.fire(new a.Event("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const u=this._map;u&&(u.off("mousemove",this._onMove),u.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new a.Event("dragend")),this._state="inactive"}_addDragHandler(u){const p=this._map,w=this._pos;p&&w&&this._element.contains(u.originalEvent.target)&&(u.preventDefault(),this._positionDelta=u.point.sub(w),this._pointerdownPos=u.point,this._state="pending",p.on("mousemove",this._onMove),p.on("touchmove",this._onMove),p.once("mouseup",this._onUp),p.once("touchend",this._onUp))}setDraggable(u){this._draggable=!!u;const p=this._map;return p&&(u?(p.on("mousedown",this._addDragHandler),p.on("touchstart",this._addDragHandler)):(p.off("mousedown",this._addDragHandler),p.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(u){return this._rotation=u||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(u){return this._rotationAlignment=u||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(u){return this._pitchAlignment=u||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(u){return this._occludedOpacity=u||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const ou={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},au=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function lc(y=new a.pointGeometry(0,0),u="bottom"){if(typeof y=="number"){const p=Math.round(Math.sqrt(.5*Math.pow(y,2)));switch(u){case"top":return new a.pointGeometry(0,y);case"top-left":return new a.pointGeometry(p,p);case"top-right":return new a.pointGeometry(-p,p);case"bottom":return new a.pointGeometry(0,-y);case"bottom-left":return new a.pointGeometry(p,-p);case"bottom-right":return new a.pointGeometry(-p,-p);case"left":return new a.pointGeometry(y,0);case"right":return new a.pointGeometry(-y,0)}return new a.pointGeometry(0,0)}return y instanceof a.pointGeometry||Array.isArray(y)?a.pointGeometry.convert(y):a.pointGeometry.convert(y[u]||[0,0])}class su{constructor(u){this.jumpTo(u)}getValue(u){if(u<=this._startTime)return this._start;if(u>=this._endTime)return this._end;const p=a.easeCubicInOut((u-this._startTime)/(this._endTime-this._startTime));return this._start*(1-p)+this._end*p}isEasing(u){return u>=this._startTime&&u<=this._endTime}jumpTo(u){this._startTime=-1/0,this._endTime=-1/0,this._start=u,this._end=u}easeTo(u,p,w){this._start=this.getValue(p),this._end=u,this._startTime=p,this._endTime=p+w}}const lu={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},cu={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0},cc={showCompass:!0,showZoom:!0,visualizePitch:!1};class uu{constructor(u,p,w=!1){this._clickTolerance=10,this.element=p,this.mouseRotate=new ic({clickTolerance:u.dragRotate._mouseRotate._clickTolerance}),this.map=u,w&&(this.mousePitch=new rc({clickTolerance:u.dragRotate._mousePitch._clickTolerance})),a.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),p.addEventListener("mousedown",this.mousedown),p.addEventListener("touchstart",this.touchstart,{passive:!1}),p.addEventListener("touchmove",this.touchmove),p.addEventListener("touchend",this.touchend),p.addEventListener("touchcancel",this.reset)}down(u,p){this.mouseRotate.mousedown(u,p),this.mousePitch&&this.mousePitch.mousedown(u,p),j()}move(u,p){const w=this.map,S=this.mouseRotate.mousemoveWindow(u,p),A=S&&S.bearingDelta;if(A&&w.setBearing(w.getBearing()+A),this.mousePitch){const L=this.mousePitch.mousemoveWindow(u,p),B=L&&L.pitchDelta;B&&w.setPitch(w.getPitch()+B)}}off(){const u=this.element;u.removeEventListener("mousedown",this.mousedown),u.removeEventListener("touchstart",this.touchstart,{passive:!1}),u.removeEventListener("touchmove",this.touchmove),u.removeEventListener("touchend",this.touchend),u.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){te(),a.window.removeEventListener("mousemove",this.mousemove),a.window.removeEventListener("mouseup",this.mouseup)}mousedown(u){this.down(a.extend({},u,{ctrlKey:!0,preventDefault:()=>u.preventDefault()}),W(this.element,u)),a.window.addEventListener("mousemove",this.mousemove),a.window.addEventListener("mouseup",this.mouseup)}mousemove(u){this.move(u,W(this.element,u))}mouseup(u){this.mouseRotate.mouseupWindow(u),this.mousePitch&&this.mousePitch.mouseupWindow(u),this.offTemp()}touchstart(u){u.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=_e(this.element,u.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>u.preventDefault()},this._startPos))}touchmove(u){u.targetTouches.length!==1?this.reset():(this._lastPos=_e(this.element,u.targetTouches)[0],this.move({preventDefault:()=>u.preventDefault()},this._lastPos))}touchend(u){u.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const hu={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},du={maxWidth:100,unit:"metric"};function fu(y,u,p){const w=Cl(u),S=w/u,A={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"}[p];this._map._requestDomTask(()=>{this._container.style.width=y*S+"px",this._container.innerHTML=`${w}&nbsp;${A}`})}function Cl(y){const u=Math.pow(10,`${Math.floor(y)}`.length-1);let p=y/u;return p=p>=10?10:p>=5?5:p>=3?3:p>=2?2:p>=1?1:function(w){const S=Math.pow(10,Math.ceil(-Math.log(w)/Math.LN10));return Math.round(w*S)/S}(p),u*p}const Xs={version:a.version,supported:_,setRTLTextPlugin:a.setRTLTextPlugin,getRTLTextPluginStatus:a.getRTLTextPluginStatus,Map:class extends nu{constructor(y){if(a.LivePerformanceUtils.mark(a.PerformanceMarkers.create),(y=a.extend({},cu,y)).minZoom!=null&&y.maxZoom!=null&&y.minZoom>y.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(y.minPitch!=null&&y.maxPitch!=null&&y.minPitch>y.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(y.minPitch!=null&&y.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(y.maxPitch!=null&&y.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(y.antialias&&a.isSafariWithAntialiasingBug(a.window)&&(y.antialias=!1,a.warnOnce("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new gi(y.minZoom,y.maxZoom,y.minPitch,y.maxPitch,y.renderWorldCopies),y),this._interactive=y.interactive,this._minTileCacheSize=y.minTileCacheSize,this._maxTileCacheSize=y.maxTileCacheSize,this._failIfMajorPerformanceCaveat=y.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=y.preserveDrawingBuffer,this._antialias=y.antialias,this._useWebGL2=y.useWebGL2,this._trackResize=y.trackResize,this._bearingSnap=y.bearingSnap,this._refreshExpiredTiles=y.refreshExpiredTiles,this._fadeDuration=y.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=y.crossSourceCollisions,this._collectResourceTiming=y.collectResourceTiming,this._optimizeForTerrain=y.optimizeForTerrain,this._language=this._parseLanguage(y.language),this._worldview=y.worldview,this._renderTaskQueue=new Hs,this._domRenderTaskQueue=new Hs,this._controls=[],this._markers=[],this._popups=[],this._mapId=a.uniqueId(),this._locale=a.extend({},lu,y.locale),this._clickTolerance=y.clickTolerance,this._cooperativeGestures=y.cooperativeGestures,this._performanceMetricsCollection=y.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new su(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new a.RequestManager(y.transformRequest,y.accessToken,y.testMode),this._silenceAuthErrors=!!y.testMode,typeof y.container=="string"){if(this._container=a.window.document.getElementById(y.container),!this._container)throw new Error(`Container '${y.container}' not found.`)}else{if(!(y.container instanceof a.window.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=y.container}if(this._container.childNodes.length>0&&a.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),y.maxBounds&&this.setMaxBounds(y.maxBounds),a.bindAll(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),a.window!==void 0&&(a.window.addEventListener("online",this._onWindowOnline,!1),a.window.addEventListener("resize",this._onWindowResize,!1),a.window.addEventListener("orientationchange",this._onWindowResize,!1),a.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1),a.window.addEventListener("visibilitychange",this._onVisibilityChange,!1)),this.handlers=new ru(this,y),this._localFontFamily=y.localFontFamily,this._localIdeographFontFamily=y.localIdeographFontFamily,y.style&&this.setStyle(y.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),y.projection&&this.setProjection(y.projection),this._hash=y.hash&&new qc(typeof y.hash=="string"&&y.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:y.center,zoom:y.zoom,bearing:y.bearing,pitch:y.pitch}),y.bounds&&(this.resize(),this.fitBounds(y.bounds,a.extend({},y.fitBoundsOptions,{duration:0})))),this.resize(),y.attributionControl&&this.addControl(new ac({customAttribution:y.customAttribution})),this._logoControl=new sc,this.addControl(this._logoControl,y.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",u=>{this._update(u.dataType==="style"),this.fire(new a.Event(`${u.dataType}data`,u))}),this.on("dataloading",u=>{this.fire(new a.Event(`${u.dataType}dataloading`,u))})}_getMapId(){return this._mapId}addControl(y,u){if(u===void 0&&(u=y.getDefaultPosition?y.getDefaultPosition():"top-right"),!y||!y.onAdd)return this.fire(new a.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const p=y.onAdd(this);this._controls.push(y);const w=this._controlPositions[u];return u.indexOf("bottom")!==-1?w.insertBefore(p,w.firstChild):w.appendChild(p),this}removeControl(y){if(!y||!y.onRemove)return this.fire(new a.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const u=this._controls.indexOf(y);return u>-1&&this._controls.splice(u,1),y.onRemove(this),this}hasControl(y){return this._controls.indexOf(y)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(y){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const u=!this._moving;return u&&this.fire(new a.Event("movestart",y)).fire(new a.Event("move",y)),this.fire(new a.Event("resize",y)),u&&this.fire(new a.Event("moveend",y)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(y){return this.transform.setMaxBounds(a.LngLatBounds.convert(y)),this._update()}setMinZoom(y){if((y=y??-2)>=-2&&y<=this.transform.maxZoom)return this.transform.minZoom=y,this._update(),this.getZoom()<y?this.setZoom(y):this.fire(new a.Event("zoomstart")).fire(new a.Event("zoom")).fire(new a.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(y){if((y=y??22)>=this.transform.minZoom)return this.transform.maxZoom=y,this._update(),this.getZoom()>y?this.setZoom(y):this.fire(new a.Event("zoomstart")).fire(new a.Event("zoom")).fire(new a.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(y){if((y=y??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(y>=0&&y<=this.transform.maxPitch)return this.transform.minPitch=y,this._update(),this.getPitch()<y?this.setPitch(y):this.fire(new a.Event("pitchstart")).fire(new a.Event("pitch")).fire(new a.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(y){if((y=y??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(y>=this.transform.minPitch)return this.transform.maxPitch=y,this._update(),this.getPitch()>y?this.setPitch(y):this.fire(new a.Event("pitchstart")).fire(new a.Event("pitch")).fire(new a.Event("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(y){return this.transform.renderWorldCopies=y,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(y){return y==="auto"?a.window.navigator.language:Array.isArray(y)?y.length===0?void 0:y.map(u=>u==="auto"?a.window.navigator.language:u):y}setLanguage(y){const u=this._parseLanguage(y);if(!this.style||u===this._language)return this;this._language=u,this.style._reloadSources();for(const p of this._controls)p._setLanguage&&p._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(y){return this.style&&y!==this._worldview?(this._worldview=y,this.style._reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(y){return this._lazyInitEmptyStyle(),y?typeof y=="string"&&(y={name:y}):y=null,this._useExplicitProjection=!!y,this._prioritizeAndUpdateProjection(y,this.style.stylesheet?this.style.stylesheet.projection:null)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const y=this.transform,u=y.projection.name;let p;u==="globe"&&y.zoom>=a.GLOBE_ZOOM_THRESHOLD_MAX?(y.setMercatorFromTransition(),p=!0):u==="mercator"&&y.zoom<a.GLOBE_ZOOM_THRESHOLD_MAX&&(y.setProjection({name:"globe"}),p=!0),p&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(y,u){return this._updateProjection(y||u||{name:"mercator"})}_updateProjection(y){let u;if(u=y.name==="globe"&&this.transform.zoom>=a.GLOBE_ZOOM_THRESHOLD_MAX?this.transform.setMercatorFromTransition():this.transform.setProjection(y),this.style.applyProjectionUpdate(),u){this.painter.clearBackgroundTiles();for(const p in this.style._sourceCaches)this.style._sourceCaches[p].clearTiles();this._update(!0),this._forceMarkerAndPopupUpdate(!0)}return this}project(y){return this.transform.locationPoint3D(a.LngLat.convert(y))}unproject(y){return this.transform.pointLocation3D(a.pointGeometry.convert(y))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(y,u,p){if(y==="mouseenter"||y==="mouseover"){let w=!1;const S=L=>{const B=u.filter(Y=>this.getLayer(Y)),F=B.length?this.queryRenderedFeatures(L.point,{layers:B}):[];F.length?w||(w=!0,p.call(this,new _n(y,this,L.originalEvent,{features:F}))):w=!1},A=()=>{w=!1};return{layers:new Set(u),listener:p,delegates:{mousemove:S,mouseout:A}}}if(y==="mouseleave"||y==="mouseout"){let w=!1;const S=L=>{const B=u.filter(F=>this.getLayer(F));(B.length?this.queryRenderedFeatures(L.point,{layers:B}):[]).length?w=!0:w&&(w=!1,p.call(this,new _n(y,this,L.originalEvent)))},A=L=>{w&&(w=!1,p.call(this,new _n(y,this,L.originalEvent)))};return{layers:new Set(u),listener:p,delegates:{mousemove:S,mouseout:A}}}{const w=S=>{const A=u.filter(B=>this.getLayer(B)),L=A.length?this.queryRenderedFeatures(S.point,{layers:A}):[];L.length&&(S.features=L,p.call(this,S),delete S.features)};return{layers:new Set(u),listener:p,delegates:{[y]:w}}}}on(y,u,p){if(p===void 0)return super.on(y,u);Array.isArray(u)||(u=[u]);const w=this._createDelegatedListener(y,u,p);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[y]=this._delegatedListeners[y]||[],this._delegatedListeners[y].push(w);for(const S in w.delegates)this.on(S,w.delegates[S]);return this}once(y,u,p){if(p===void 0)return super.once(y,u);Array.isArray(u)||(u=[u]);const w=this._createDelegatedListener(y,u,p);for(const S in w.delegates)this.once(S,w.delegates[S]);return this}off(y,u,p){if(p===void 0)return super.off(y,u);u=new Set(Array.isArray(u)?u:[u]);const w=(A,L)=>{if(A.size!==L.size)return!1;for(const B of A)if(!L.has(B))return!1;return!0},S=this._delegatedListeners?this._delegatedListeners[y]:void 0;return S&&(A=>{for(let L=0;L<A.length;L++){const B=A[L];if(B.listener===p&&w(B.layers,u)){for(const F in B.delegates)this.off(F,B.delegates[F]);return A.splice(L,1),this}}})(S),this}queryRenderedFeatures(y,u){return this.style?(u!==void 0||y===void 0||y instanceof a.pointGeometry||Array.isArray(y)||(u=y,y=void 0),this.style.queryRenderedFeatures(y=y||[[0,0],[this.transform.width,this.transform.height]],u=u||{},this.transform)):[]}querySourceFeatures(y,u){return this.style.querySourceFeatures(y,u)}setStyle(y,u){return(u=a.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},u)).diff!==!1&&u.localIdeographFontFamily===this._localIdeographFontFamily&&u.localFontFamily===this._localFontFamily&&this.style&&y?(this._diffStyle(y,u),this):(this._localIdeographFontFamily=u.localIdeographFontFamily,this._localFontFamily=u.localFontFamily,this._updateStyle(y,u))}_getUIString(y){const u=this._locale[y];if(u==null)throw new Error(`Missing UI string '${y}'`);return u}_updateStyle(y,u){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),y&&(this.style=new Hr(this,u||{}),this.style.setEventedParent(this,{style:this.style}),typeof y=="string"?this.style.loadURL(y):this.style.loadJSON(y)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Hr(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(y,u){if(typeof y=="string"){const p=this._requestManager.normalizeStyleURL(y),w=this._requestManager.transformRequest(p,a.ResourceType.Style);a.getJSON(w,(S,A)=>{S?this.fire(new a.ErrorEvent(S)):A&&this._updateDiff(A,u)})}else typeof y=="object"&&this._updateDiff(y,u)}_updateDiff(y,u){try{this.style.setState(y)&&this._update(!0)}catch(p){a.warnOnce(`Unable to perform style diff: ${p.message||p.error||p}.  Rebuilding the style from scratch.`),this._updateStyle(y,u)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(a.warnOnce("There is no style added to the map."),!1)}addSource(y,u){return this._lazyInitEmptyStyle(),this.style.addSource(y,u),this._update(!0)}isSourceLoaded(y){return!!this.style&&this.style._isSourceCacheLoaded(y)}areTilesLoaded(){const y=this.style&&this.style._sourceCaches;for(const u in y){const p=y[u]._tiles;for(const w in p){const S=p[w];if(S.state!=="loaded"&&S.state!=="errored")return!1}}return!0}addSourceType(y,u,p){this._lazyInitEmptyStyle(),this.style.addSourceType(y,u,p)}removeSource(y){return this.style.removeSource(y),this._updateTerrain(),this._update(!0)}getSource(y){return this.style.getSource(y)}addImage(y,u,{pixelRatio:p=1,sdf:w=!1,stretchX:S,stretchY:A,content:L}={}){if(this._lazyInitEmptyStyle(),u instanceof a.window.HTMLImageElement||a.window.ImageBitmap&&u instanceof a.window.ImageBitmap){const{width:B,height:F,data:Y}=a.exported.getImageData(u);this.style.addImage(y,{data:new a.RGBAImage({width:B,height:F},Y),pixelRatio:p,stretchX:S,stretchY:A,content:L,sdf:w,version:0})}else if(u.width===void 0||u.height===void 0)this.fire(new a.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:B,height:F}=u,Y=u;this.style.addImage(y,{data:new a.RGBAImage({width:B,height:F},new Uint8Array(Y.data)),pixelRatio:p,stretchX:S,stretchY:A,content:L,sdf:w,version:0,userImage:Y}),Y.onAdd&&Y.onAdd(this,y)}}updateImage(y,u){const p=this.style.getImage(y);if(!p)return void this.fire(new a.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const w=u instanceof a.window.HTMLImageElement||a.window.ImageBitmap&&u instanceof a.window.ImageBitmap?a.exported.getImageData(u):u,{width:S,height:A}=w;S!==void 0&&A!==void 0?S===p.data.width&&A===p.data.height?(p.data.replace(w.data,!(u instanceof a.window.HTMLImageElement||a.window.ImageBitmap&&u instanceof a.window.ImageBitmap)),this.style.updateImage(y,p)):this.fire(new a.ErrorEvent(new Error(`The width and height of the updated image (${S}, ${A})
                must be that same as the previous version of the image
                (${p.data.width}, ${p.data.height})`))):this.fire(new a.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(y){return y?!!this.style.getImage(y):(this.fire(new a.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(y){this.style.removeImage(y)}loadImage(y,u){a.getImage(this._requestManager.transformRequest(y,a.ResourceType.Image),(p,w)=>{u(p,w instanceof a.window.HTMLImageElement?a.exported.getImageData(w):w)})}listImages(){return this.style.listImages()}addLayer(y,u){return this._lazyInitEmptyStyle(),this.style.addLayer(y,u),this._update(!0)}moveLayer(y,u){return this.style.moveLayer(y,u),this._update(!0)}removeLayer(y){return this.style.removeLayer(y),this._update(!0)}getLayer(y){return this.style.getLayer(y)}setLayerZoomRange(y,u,p){return this.style.setLayerZoomRange(y,u,p),this._update(!0)}setFilter(y,u,p={}){return this.style.setFilter(y,u,p),this._update(!0)}getFilter(y){return this.style.getFilter(y)}setPaintProperty(y,u,p,w={}){return this.style.setPaintProperty(y,u,p,w),this._update(!0)}getPaintProperty(y,u){return this.style.getPaintProperty(y,u)}setLayoutProperty(y,u,p,w={}){return this.style.setLayoutProperty(y,u,p,w),this._update(!0)}getLayoutProperty(y,u){return this.style.getLayoutProperty(y,u)}setLight(y,u={}){return this._lazyInitEmptyStyle(),this.style.setLight(y,u),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(y){return this._lazyInitEmptyStyle(),!y&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(y),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(y){return this._lazyInitEmptyStyle(),this.style.setFog(y),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(y){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(a.LngLat.convert(y),this.transform):0}setFeatureState(y,u){return this.style.setFeatureState(y,u),this._update()}removeFeatureState(y,u){return this.style.removeFeatureState(y,u),this._update()}getFeatureState(y){return this.style.getFeatureState(y)}_updateContainerDimensions(){if(!this._container)return;const y=this._container.getBoundingClientRect().width||400,u=this._container.getBoundingClientRect().height||300;let p,w,S,A=this._container;for(;A&&(!w||!S);){const L=a.window.getComputedStyle(A).transform;L&&L!=="none"&&(p=L.match(/matrix.*\((.+)\)/)[1].split(", "),p[0]&&p[0]!=="0"&&p[0]!=="1"&&(w=p[0]),p[3]&&p[3]!=="0"&&p[3]!=="1"&&(S=p[3])),A=A.parentElement}this._containerWidth=w?Math.abs(y/w):y,this._containerHeight=S?Math.abs(u/S):u}_detectMissingCSS(){a.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&a.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const y=this._container;y.classList.add("mapboxgl-map"),(this._missingCSSCanary=D("div","mapboxgl-canary",y)).style.visibility="hidden",this._detectMissingCSS();const u=this._canvasContainer=D("div","mapboxgl-canvas-container",y);this._interactive&&u.classList.add("mapboxgl-interactive"),this._canvas=D("canvas","mapboxgl-canvas",u),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const p=this._controlContainer=D("div","mapboxgl-control-container",y),w=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(S=>{w[S]=D("div",`mapboxgl-ctrl-${S}`,p)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(y,u){const p=a.exported.devicePixelRatio||1;this._canvas.width=p*Math.ceil(y),this._canvas.height=p*Math.ceil(u),this._canvas.style.width=`${y}px`,this._canvas.style.height=`${u}px`}_addMarker(y){this._markers.push(y)}_removeMarker(y){const u=this._markers.indexOf(y);u!==-1&&this._markers.splice(u,1)}_addPopup(y){this._popups.push(y)}_removePopup(y){const u=this._popups.indexOf(y);u!==-1&&this._popups.splice(u,1)}_setupPainter(){const y=a.extend({},_.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),u=this._useWebGL2&&this._canvas.getContext("webgl2",y),p=u||this._canvas.getContext("webgl",y)||this._canvas.getContext("experimental-webgl",y);p?(this._useWebGL2&&!u&&a.warnOnce("Failed to create WebGL 2 context. Using WebGL 1."),a.storeAuthState(p,!0),this.painter=new Vo(p,this.transform,!!u),this.on("data",w=>{w.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),a.exported$1.testSupport(p)):this.fire(new a.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(y){y.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new a.Event("webglcontextlost",{originalEvent:y}))}_contextRestored(y){this._setupPainter(),this.resize(),this._update(),this.fire(new a.Event("webglcontextrestored",{originalEvent:y}))}_onMapScroll(y){if(y.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(y){return this.style?(this._styleDirty=this._styleDirty||y,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(y){return this._update(),this._renderTaskQueue.add(y)}_cancelRenderFrame(y){this._renderTaskQueue.remove(y)}_requestDomTask(y){!this.loaded()||this.loaded()&&!this.isMoving()?y():this._domRenderTaskQueue.add(y)}_render(y){let u;const p=this.painter.context.extTimerQuery,w=a.exported.now();if(this.listens("gpu-timing-frame")&&(u=p.createQueryEXT(),p.beginQueryEXT(p.TIME_ELAPSED_EXT,u)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],a.window.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],a.window.performance.now())),this._renderTaskQueue.run(y),this._domRenderTaskQueue.run(y),this._removed)return;this._updateProjectionTransition();const S=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const B=this.transform.zoom,F=this.transform.pitch,Y=a.exported.now(),X=new a.EvaluationParameters(B,{now:Y,fadeDuration:S,pitch:F,transition:this.style.getTransition()});this.style.update(X)}this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let A=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),A=this._updateAverageElevation(w),this.style._updateSources(this.transform),this._forceMarkerAndPopupUpdate()):A=this._updateAverageElevation(w),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,S,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:S,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new a.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new a.Event("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),u){const B=a.exported.now()-w;p.endQueryEXT(p.TIME_ELAPSED_EXT,u),setTimeout(()=>{const F=p.getQueryObjectEXT(u,p.QUERY_RESULT_EXT)/1e6;p.deleteQueryEXT(u),this.fire(new a.Event("gpu-timing-frame",{cpuTime:B,gpuTime:F})),a.window.performance.mark("frame-gpu",{startTime:w,detail:{gpuTime:F}})},50)}if(this.listens("gpu-timing-layer")){const B=this.painter.collectGpuTimers();setTimeout(()=>{const F=this.painter.queryGpuTimers(B);this.fire(new a.Event("gpu-timing-layer",{layerTimes:F}))},50)}if(this.listens("gpu-timing-deferred-render")){const B=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const F=this.painter.queryGpuTimeDeferredRender(B);this.fire(new a.Event("gpu-timing-deferred-render",{gpuTime:F}))},50)}const L=this._sourcesDirty||this._styleDirty||this._placementDirty||A;if(L||this._repaint)this.triggerRepaint();else{const B=!this.isMoving()&&this.loaded();if(B&&(A=this._updateAverageElevation(w,!0)),A)this.triggerRepaint();else if(this._triggerFrame(!1),B&&(this.fire(new a.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const F=this._calculateSpeedIndex();this.fire(new a.Event("speedindexcompleted",{speedIndex:F})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||L||(this._fullyLoaded=!0,a.LivePerformanceUtils.mark(a.PerformanceMarkers.fullLoad),this._performanceMetricsCollection&&a.postPerformanceEvent(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(y){for(const u of this._markers)y&&!this.getRenderWorldCopies()&&(u._lngLat=u._lngLat.wrap()),u._update();for(const u of this._popups)!y||this.getRenderWorldCopies()||u._trackPointer||(u._lngLat=u._lngLat.wrap()),u._update()}_updateAverageElevation(y,u=!1){const p=w=>(this.transform.averageElevation=w,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&p(0);if((u||y-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(y)){const w=this.transform.averageElevation;let S=this.transform.sampleAverageElevation(),A=!1;this.transform.elevation&&(A=this.transform.elevation.exaggeration()!==this._averageElevationExaggeration,this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(S)?S=0:this._averageElevationLastSampledAt=y;const L=Math.abs(w-S);if(L>1){if(this._isInitialLoad||A)return this._averageElevation.jumpTo(S),p(S);this._averageElevation.easeTo(S,y,300)}else if(L>1e-4)return this._averageElevation.jumpTo(S),p(S)}return!!this._averageElevation.isEasing(y)&&p(this._averageElevation.getValue(y))}_authenticate(){a.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,y=>{if(y&&(y.message===a.AUTH_ERR_MSG||y.status===401)){const u=this.painter.context.gl;a.storeAuthState(u,!1),this._logoControl instanceof sc&&this._logoControl._updateLogo(),u&&u.clear(u.DEPTH_BUFFER_BIT|u.COLOR_BUFFER_BIT|u.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new a.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),a.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){const y=this._isDragging();this.painter.updateTerrain(this.style,y)}_calculateSpeedIndex(){const y=this.painter.canvasCopy(),u=this.painter.getCanvasCopiesAndTimestamps();u.timeStamps.push(performance.now());const p=this.painter.context.gl,w=p.createFramebuffer();function S(A){p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,A,0);const L=new Uint8Array(p.drawingBufferWidth*p.drawingBufferHeight*4);return p.readPixels(0,0,p.drawingBufferWidth,p.drawingBufferHeight,p.RGBA,p.UNSIGNED_BYTE,L),L}return p.bindFramebuffer(p.FRAMEBUFFER,w),this._canvasPixelComparison(S(y),u.canvasCopies.map(S),u.timeStamps)}_canvasPixelComparison(y,u,p){let w=p[1]-p[0];const S=y.length/4;for(let A=0;A<u.length;A++){const L=u[A];let B=0;for(let F=0;F<L.length;F+=4)L[F]===y[F]&&L[F+1]===y[F+1]&&L[F+2]===y[F+2]&&L[F+3]===y[F+3]&&(B+=1);w+=(p[A+2]-p[A+1])*(1-B/S)}return w}remove(){this._hash&&this._hash.remove();for(const u of this._controls)u.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),a.window!==void 0&&(a.window.removeEventListener("resize",this._onWindowResize,!1),a.window.removeEventListener("orientationchange",this._onWindowResize,!1),a.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),a.window.removeEventListener("online",this._onWindowOnline,!1),a.window.removeEventListener("visibilitychange",this._onVisibilityChange,!1));const y=this.painter.context.gl.getExtension("WEBGL_lose_context");y&&y.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),a.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new a.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(y){this._renderNextFrame=this._renderNextFrame||y,this.style&&!this._frame&&(this._frame=a.exported.frame(u=>{const p=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,p&&this._render(u)}))}_preloadTiles(y){const u=this.style?Object.values(this.style._sourceCaches):[];return a.asyncAll(u,(p,w)=>p._preloadTiles(y,w),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(y){this._trackResize&&this.resize({originalEvent:y})._update()}_onVisibilityChange(){a.window.document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(y){this._showTileBoundaries!==y&&(this._showTileBoundaries=y,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(y){this._showTerrainWireframe!==y&&(this._showTerrainWireframe=y,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(y){this._speedIndexTiming!==y&&(this._speedIndexTiming=y,this._update())}get showPadding(){return!!this._showPadding}set showPadding(y){this._showPadding!==y&&(this._showPadding=y,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(y){this._showCollisionBoxes!==y&&(this._showCollisionBoxes=y,y?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(y){this._showOverdrawInspector!==y&&(this._showOverdrawInspector=y,this._update())}get repaint(){return!!this._repaint}set repaint(y){this._repaint!==y&&(this._repaint=y,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(y){this._vertices=y,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(y){this._showTileAABBs!==y&&(this._showTileAABBs=y,y&&this._update())}_setCacheLimits(y,u){a.setCacheLimits(y,u)}get version(){return a.version}},NavigationControl:class{constructor(y){this.options=a.extend({},cc,y),this._container=D("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",u=>u.preventDefault()),this.options.showZoom&&(a.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",u=>{this._map&&this._map.zoomIn({},{originalEvent:u})}),D("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",u=>{this._map&&this._map.zoomOut({},{originalEvent:u})}),D("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(a.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",u=>{const p=this._map;p&&(this.options.visualizePitch?p.resetNorthPitch({},{originalEvent:u}):p.resetNorth({},{originalEvent:u}))}),this._compassIcon=D("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const y=this._map;if(!y)return;const u=y.getZoom(),p=u===y.getMaxZoom(),w=u===y.getMinZoom();this._zoomInButton.disabled=p,this._zoomOutButton.disabled=w,this._zoomInButton.setAttribute("aria-disabled",p.toString()),this._zoomOutButton.setAttribute("aria-disabled",w.toString())}_rotateCompassArrow(){const y=this._map;if(!y)return;const u=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(y.transform.pitch*(Math.PI/180)),.5)}) rotateX(${y.transform.pitch}deg) rotateZ(${y.transform.angle*(180/Math.PI)}deg)`:`rotate(${y.transform.angle*(180/Math.PI)}deg)`;y._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=u)})}onAdd(y){return this._map=y,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),y.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&y.on("pitch",this._rotateCompassArrow),y.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new uu(y,this._compass,this.options.visualizePitch)),this._container}onRemove(){const y=this._map;y&&(this._container.remove(),this.options.showZoom&&y.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&y.off("pitch",this._rotateCompassArrow),y.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(y,u){const p=D("button",y,this._container);return p.type="button",p.addEventListener("click",u),p}_setButtonTitle(y,u){if(!this._map)return;const p=this._map._getUIString(`NavigationControl.${u}`);y.setAttribute("aria-label",p),y.firstElementChild&&y.firstElementChild.setAttribute("title",p)}},GeolocateControl:class extends a.Evented{constructor(y){super(),this.options=a.extend({geolocation:a.window.navigator.geolocation},hu,y),a.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=io(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(y){return this._map=y,this._container=D("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(y){const u=(p=!!this.options.geolocation)=>{this._supportsGeolocation=p,y(p)};this._supportsGeolocation!==void 0?y(this._supportsGeolocation):a.window.navigator.permissions!==void 0?a.window.navigator.permissions.query({name:"geolocation"}).then(p=>u(p.state!=="denied")).catch(()=>u()):u()}_isOutOfMapMaxBounds(y){const u=this._map.getMaxBounds(),p=y.coords;return!!u&&(p.longitude<u.getWest()||p.longitude>u.getEast()||p.latitude<u.getSouth()||p.latitude>u.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(y){if(this._map){if(this._isOutOfMapMaxBounds(y))return this._setErrorState(),this.fire(new a.Event("outofmaxbounds",y)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=y,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(y),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(y),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new a.Event("geolocate",y)),this._finish()}}_updateCamera(y){const u=new a.LngLat(y.coords.longitude,y.coords.latitude),p=y.coords.accuracy,w=this._map.getBearing(),S=a.extend({bearing:w},this.options.fitBoundsOptions);this._map.fitBounds(u.toBounds(p),S,{geolocateSource:!0})}_updateMarker(y){if(y){const u=new a.LngLat(y.coords.longitude,y.coords.latitude);this._accuracyCircleMarker.setLngLat(u).addTo(this._map),this._userLocationDotMarker.setLngLat(u).addTo(this._map),this._accuracy=y.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const y=this._map.transform,u=a.mercatorZfromAltitude(1,y._center.lat)*y.worldSize,p=Math.ceil(2*this._accuracy*u);this._circleElement.style.width=`${p}px`,this._circleElement.style.height=`${p}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(y){if(this._map){if(this.options.trackUserLocation)if(y.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const u=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",u),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",u),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(y.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new a.Event("error",y)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(y){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",u=>u.preventDefault()),this._geolocateButton=D("button","mapboxgl-ctrl-geolocate",this._container),D("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",y===!1){a.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const u=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",u),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",u)}else{const u=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",u),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",u)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=D("div","mapboxgl-user-location"),this._dotElement.appendChild(D("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(D("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Al({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=D("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Al({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",u=>{u.geolocateSource||this._watchState!=="ACTIVE_LOCK"||u.originalEvent&&u.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new a.Event("trackuserlocationend")))})}}_onDeviceOrientation(y){this._userLocationDotMarker&&(y.webkitCompassHeading?this._heading=y.webkitCompassHeading:y.absolute===!0&&(this._heading=-1*y.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return a.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new a.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new a.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new a.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let y;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(y={maximumAge:6e5,timeout:0},this._noTimeout=!0):(y=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,y),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const y=()=>{a.window.addEventListener("ondeviceorientationabsolute"in a.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};a.window.DeviceMotionEvent!==void 0&&typeof a.window.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(u=>{u==="granted"&&y()}).catch(console.error):y()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),a.window.removeEventListener("deviceorientation",this._onDeviceOrientation),a.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:ac,ScaleControl:class{constructor(y){this.options=a.extend({},du,y),function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"narrow",unit:"meter"}),!0}catch{return!1}}()||(this._setScale=fu.bind(this)),a.bindAll(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const y=this.options.maxWidth||100,u=this._map,p=u._containerHeight/2,w=u._containerWidth/2-y/2,S=u.unproject([w,p]),A=u.unproject([w+y,p]),L=S.distanceTo(A);if(this.options.unit==="imperial"){const B=3.2808*L;B>5280?this._setScale(y,B/5280,"mile"):this._setScale(y,B,"foot")}else this.options.unit==="nautical"?this._setScale(y,L/1852,"nautical-mile"):L>=1e3?this._setScale(y,L/1e3,"kilometer"):this._setScale(y,L,"meter")}_setScale(y,u,p){const w=Cl(u),S=w/u;this._map._requestDomTask(()=>{this._container.style.width=y*S+"px",this._container.innerHTML=p!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"narrow",unit:p}).format(w):`${w}&nbsp;nm`})}onAdd(y){return this._map=y,this._language=y.getLanguage(),this._container=D("div","mapboxgl-ctrl mapboxgl-ctrl-scale",y.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(y){this._language=y,this._update()}setUnit(y){this.options.unit=y,this._update()}},FullscreenControl:class{constructor(y){this._fullscreen=!1,y&&y.container&&(y.container instanceof a.window.HTMLElement?this._container=y.container:a.warnOnce("Full screen control 'container' must be a DOM element.")),a.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in a.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in a.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(y){return this._map=y,this._container||(this._container=this._map.getContainer()),this._controlContainer=D("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",a.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,a.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!a.window.document.fullscreenEnabled&&!a.window.document.webkitFullscreenEnabled)}_setupUI(){const y=this._fullscreenButton=D("button","mapboxgl-ctrl-fullscreen",this._controlContainer);D("span","mapboxgl-ctrl-icon",y).setAttribute("aria-hidden","true"),y.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),a.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const y=this._getTitle();this._fullscreenButton.setAttribute("aria-label",y),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",y)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(a.window.document.fullscreenElement||a.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?a.window.document.exitFullscreen?a.window.document.exitFullscreen():a.window.document.webkitCancelFullScreen&&a.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends a.Evented{constructor(y){super(),this.options=a.extend(Object.create(ou),y),a.bindAll(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(y&&y.className?y.className.trim().split(/\s+/):[])}addTo(y){return this._map&&this.remove(),this._map=y,this.options.closeOnClick&&y.on("preclick",this._onClose),this.options.closeOnMove&&y.on("move",this._onClose),y.on("remove",this.remove),this._update(),y._addPopup(this),this._focusFirstElement(),this._trackPointer?(y.on("mousemove",this._onMouseEvent),y.on("mouseup",this._onMouseEvent),y._canvasContainer.classList.add("mapboxgl-track-pointer")):y.on("move",this._update),this.fire(new a.Event("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const y=this._map;return y&&(y.off("move",this._update),y.off("move",this._onClose),y.off("preclick",this._onClose),y.off("click",this._onClose),y.off("remove",this.remove),y.off("mousemove",this._onMouseEvent),y.off("mouseup",this._onMouseEvent),y.off("drag",this._onMouseEvent),y._canvasContainer&&y._canvasContainer.classList.remove("mapboxgl-track-pointer"),y._removePopup(this),this._map=void 0),this.fire(new a.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(y){this._lngLat=a.LngLat.convert(y),this._pos=null,this._trackPointer=!1,this._update();const u=this._map;return u&&(u.on("move",this._update),u.off("mousemove",this._onMouseEvent),u._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const y=this._map;return y&&(y.off("move",this._update),y.on("mousemove",this._onMouseEvent),y.on("drag",this._onMouseEvent),y._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(y){return this.setDOMContent(a.window.document.createTextNode(y))}setHTML(y){const u=a.window.document.createDocumentFragment(),p=a.window.document.createElement("body");let w;for(p.innerHTML=y;w=p.firstChild,w;)u.appendChild(w);return this.setDOMContent(u)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(y){return this.options.maxWidth=y,this._update(),this}setDOMContent(y){let u=this._content;if(u)for(;u.hasChildNodes();)u.firstChild&&u.removeChild(u.firstChild);else u=this._content=D("div","mapboxgl-popup-content",this._container||void 0);if(u.appendChild(y),this.options.closeButton){const p=this._closeButton=D("button","mapboxgl-popup-close-button",u);p.type="button",p.setAttribute("aria-label","Close popup"),p.setAttribute("aria-hidden","true"),p.innerHTML="&#215;",p.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(y){return this._classList.add(y),this._updateClassList(),this}removeClassName(y){return this._classList.delete(y),this._updateClassList(),this}setOffset(y){return this.options.offset=y,this._update(),this}toggleClassName(y){let u;return this._classList.delete(y)?u=!1:(this._classList.add(y),u=!0),this._updateClassList(),u}_onMouseEvent(y){this._update(y.point)}_getAnchor(y){if(this.options.anchor)return this.options.anchor;const u=this._map,p=this._container,w=this._pos;if(!u||!p||!w)return"bottom";const S=p.offsetWidth,A=p.offsetHeight,L=w.x<S/2,B=w.x>u.transform.width-S/2;if(w.y+y<A)return L?"top-left":B?"top-right":"top";if(w.y>u.transform.height-A){if(L)return"bottom-left";if(B)return"bottom-right"}return L?"left":B?"right":"bottom"}_updateClassList(){const y=this._container;if(!y)return;const u=[...this._classList];u.push("mapboxgl-popup"),this._anchor&&u.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&u.push("mapboxgl-popup-track-pointer"),y.className=u.join(" ")}_update(y){const u=this._map,p=this._content;if(!u||!this._lngLat&&!this._trackPointer||!p)return;let w=this._container;if(w||(w=this._container=D("div","mapboxgl-popup",u.getContainer()),this._tip=D("div","mapboxgl-popup-tip",w),w.appendChild(p)),this.options.maxWidth&&w.style.maxWidth!==this.options.maxWidth&&(w.style.maxWidth=this.options.maxWidth),u.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Ml(this._lngLat,this._pos,u.transform)),!this._trackPointer||y){const S=this._pos=this._trackPointer&&y?y:u.project(this._lngLat),A=lc(this.options.offset),L=this._anchor=this._getAnchor(A.y),B=lc(this.options.offset,L),F=S.add(B).round();u._requestDomTask(()=>{this._container&&L&&(this._container.style.transform=`${ms[L]} translate(${F.x}px,${F.y}px)`)})}if(!this._marker&&u._showingGlobe()){const S=a.isLngLatBehindGlobe(u.transform,this._lngLat)?0:1;this._setOpacity(S)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const y=this._container.querySelector(au);y&&y.focus()}_onClose(){this.remove()}_setOpacity(y){this._container&&(this._container.style.opacity=`${y}`),this._content&&(this._content.style.pointerEvents=y?"auto":"none")}},Marker:Al,Style:Hr,LngLat:a.LngLat,LngLatBounds:a.LngLatBounds,Point:a.pointGeometry,MercatorCoordinate:a.MercatorCoordinate,FreeCameraOptions:jo,Evented:a.Evented,config:a.config,prewarm:function(){Fi().acquire(Ai)},clearPrewarmedResources:function(){const y=Ei;y&&(y.isPreloaded()&&y.numActive()===1?(y.release(Ai),Ei=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return a.config.ACCESS_TOKEN},set accessToken(y){a.config.ACCESS_TOKEN=y},get baseApiUrl(){return a.config.API_URL},set baseApiUrl(y){a.config.API_URL=y},get workerCount(){return xi.workerCount},set workerCount(y){xi.workerCount=y},get maxParallelImageRequests(){return a.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(y){a.config.MAX_PARALLEL_IMAGE_REQUESTS=y},clearStorage(y){a.clearTileCache(y)},workerUrl:"",workerClass:null,setNow:a.exported.setNow,restoreNow:a.exported.restoreNow};return Xs});var g=s;return g})})(mapboxGl);var mapboxGlExports=mapboxGl.exports;const mapboxgl=getDefaultExportFromCjs(mapboxGlExports);var d2r=Math.PI/180,r2d=180/Math.PI;function tileToBBOX(e){var r=tile2lon(e[0]+1,e[2]),t=tile2lon(e[0],e[2]),o=tile2lat(e[1]+1,e[2]),s=tile2lat(e[1],e[2]);return[t,o,r,s]}function tileToGeoJSON(e){var r=tileToBBOX(e),t={type:"Polygon",coordinates:[[[r[0],r[3]],[r[0],r[1]],[r[2],r[1]],[r[2],r[3]],[r[0],r[3]]]]};return t}function tile2lon(e,r){return e/Math.pow(2,r)*360-180}function tile2lat(e,r){var t=Math.PI-2*Math.PI*e/Math.pow(2,r);return r2d*Math.atan(.5*(Math.exp(t)-Math.exp(-t)))}function pointToTile(e,r,t){var o=pointToTileFraction(e,r,t);return o[0]=Math.floor(o[0]),o[1]=Math.floor(o[1]),o}function getChildren(e){return[[e[0]*2,e[1]*2,e[2]+1],[e[0]*2+1,e[1]*2,e[2]+1],[e[0]*2+1,e[1]*2+1,e[2]+1],[e[0]*2,e[1]*2+1,e[2]+1]]}function getParent(e){return[e[0]>>1,e[1]>>1,e[2]-1]}function getSiblings(e){return getChildren(getParent(e))}function hasSiblings(e,r){for(var t=getSiblings(e),o=0;o<t.length;o++)if(!hasTile(r,t[o]))return!1;return!0}function hasTile(e,r){for(var t=0;t<e.length;t++)if(tilesEqual(e[t],r))return!0;return!1}function tilesEqual(e,r){return e[0]===r[0]&&e[1]===r[1]&&e[2]===r[2]}function tileToQuadkey(e){for(var r="",t=e[2];t>0;t--){var o=0,s=1<<t-1;e[0]&s&&o++,e[1]&s&&(o+=2),r+=o.toString()}return r}function quadkeyToTile(e){for(var r=0,t=0,o=e.length,s=o;s>0;s--){var d=1<<s-1,g=+e[o-s];g===1&&(r|=d),g===2&&(t|=d),g===3&&(r|=d,t|=d)}return[r,t,o]}function bboxToTile(e){var r=pointToTile(e[0],e[1],32),t=pointToTile(e[2],e[3],32),o=[r[0],r[1],t[0],t[1]],s=getBboxZoom(o);if(s===0)return[0,0,0];var d=o[0]>>>32-s,g=o[1]>>>32-s;return[d,g,s]}function getBboxZoom(e){for(var r=28,t=0;t<r;t++){var o=1<<32-(t+1);if((e[0]&o)!==(e[2]&o)||(e[1]&o)!==(e[3]&o))return t}return r}function pointToTileFraction(e,r,t){var o=Math.sin(r*d2r),s=Math.pow(2,t),d=s*(e/360+.5),g=s*(.5-.25*Math.log((1+o)/(1-o))/Math.PI);return d=d%s,d<0&&(d=d+s),[d,g,t]}var tilebelt={tileToGeoJSON,tileToBBOX,getChildren,getParent,getSiblings,hasTile,hasSiblings,tilesEqual,tileToQuadkey,quadkeyToTile,pointToTile,bboxToTile,pointToTileFraction};const tilebelt$1=getDefaultExportFromCjs(tilebelt);var earthRadius=63710088e-1,factors={centimeters:earthRadius*100,centimetres:earthRadius*100,degrees:earthRadius/111325,feet:earthRadius*3.28084,inches:earthRadius*39.37,kilometers:earthRadius/1e3,kilometres:earthRadius/1e3,meters:earthRadius,metres:earthRadius,miles:earthRadius/1609.344,millimeters:earthRadius*1e3,millimetres:earthRadius*1e3,nauticalmiles:earthRadius/1852,radians:1,yards:earthRadius*1.0936};function feature(e,r,t){t===void 0&&(t={});var o={type:"Feature"};return(t.id===0||t.id)&&(o.id=t.id),t.bbox&&(o.bbox=t.bbox),o.properties=r||{},o.geometry=e,o}function point(e,r,t){if(t===void 0&&(t={}),!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!isNumber(e[0])||!isNumber(e[1]))throw new Error("coordinates must contain numbers");var o={type:"Point",coordinates:e};return feature(o,r,t)}function polygon(e,r,t){t===void 0&&(t={});for(var o=0,s=e;o<s.length;o++){var d=s[o];if(d.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var g=0;g<d[d.length-1].length;g++)if(d[d.length-1][g]!==d[0][g])throw new Error("First and last Position are not equivalent.")}var a={type:"Polygon",coordinates:e};return feature(a,r,t)}function radiansToLength(e,r){r===void 0&&(r="kilometers");var t=factors[r];if(!t)throw new Error(r+" units is invalid");return e*t}function lengthToRadians(e,r){r===void 0&&(r="kilometers");var t=factors[r];if(!t)throw new Error(r+" units is invalid");return e/t}function radiansToDegrees(e){var r=e%(2*Math.PI);return r*180/Math.PI}function degreesToRadians(e){var r=e%360;return r*Math.PI/180}function isNumber(e){return!isNaN(e)&&e!==null&&!Array.isArray(e)}function geomEach(e,r){var t,o,s,d,g,a,b,_,T,C,D=0,k=e.type==="FeatureCollection",O=e.type==="Feature",U=k?e.features.length:1;for(t=0;t<U;t++){for(a=k?e.features[t].geometry:O?e.geometry:e,_=k?e.features[t].properties:O?e.properties:{},T=k?e.features[t].bbox:O?e.bbox:void 0,C=k?e.features[t].id:O?e.id:void 0,b=a?a.type==="GeometryCollection":!1,g=b?a.geometries.length:1,s=0;s<g;s++){if(d=b?a.geometries[s]:a,d===null){if(r(null,D,_,T,C)===!1)return!1;continue}switch(d.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(r(d,D,_,T,C)===!1)return!1;break}case"GeometryCollection":{for(o=0;o<d.geometries.length;o++)if(r(d.geometries[o],D,_,T,C)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}D++}}function geomReduce(e,r,t){var o=t;return geomEach(e,function(s,d,g,a,b){d===0&&t===void 0?o=s:o=r(o,s,d,g,a,b)}),o}function getCoord(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if(e.type==="Feature"&&e.geometry!==null&&e.geometry.type==="Point")return e.geometry.coordinates;if(e.type==="Point")return e.coordinates}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return e;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function distance(e,r,t){t===void 0&&(t={});var o=getCoord(e),s=getCoord(r),d=degreesToRadians(s[1]-o[1]),g=degreesToRadians(s[0]-o[0]),a=degreesToRadians(o[1]),b=degreesToRadians(s[1]),_=Math.pow(Math.sin(d/2),2)+Math.pow(Math.sin(g/2),2)*Math.cos(a)*Math.cos(b);return radiansToLength(2*Math.atan2(Math.sqrt(_),Math.sqrt(1-_)),t.units)}function bboxPolygon(e,r){r===void 0&&(r={});var t=Number(e[0]),o=Number(e[1]),s=Number(e[2]),d=Number(e[3]);if(e.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var g=[t,o],a=[t,d],b=[s,d],_=[s,o];return polygon([[g,_,b,a,g]],r.properties,{bbox:e,id:r.id})}function destination(e,r,t,o){o===void 0&&(o={});var s=getCoord(e),d=degreesToRadians(s[0]),g=degreesToRadians(s[1]),a=degreesToRadians(t),b=lengthToRadians(r,o.units),_=Math.asin(Math.sin(g)*Math.cos(b)+Math.cos(g)*Math.sin(b)*Math.cos(a)),T=d+Math.atan2(Math.sin(a)*Math.sin(b)*Math.cos(g),Math.cos(b)-Math.sin(g)*Math.sin(_)),C=radiansToDegrees(T),D=radiansToDegrees(_);return point([C,D],o.properties)}function bearing(e,r,t){if(t===void 0&&(t={}),t.final===!0)return calculateFinalBearing(e,r);var o=getCoord(e),s=getCoord(r),d=degreesToRadians(o[0]),g=degreesToRadians(s[0]),a=degreesToRadians(o[1]),b=degreesToRadians(s[1]),_=Math.sin(g-d)*Math.cos(b),T=Math.cos(a)*Math.sin(b)-Math.sin(a)*Math.cos(b)*Math.cos(g-d);return radiansToDegrees(Math.atan2(_,T))}function calculateFinalBearing(e,r){var t=bearing(r,e);return t=(t+180)%360,t}function midpoint(e,r){var t=distance(e,r),o=bearing(e,r),s=destination(e,t/2,o);return s}var RADIUS=6378137;function area(e){return geomReduce(e,function(r,t){return r+calculateArea(t)},0)}function calculateArea(e){var r=0,t;switch(e.type){case"Polygon":return polygonArea(e.coordinates);case"MultiPolygon":for(t=0;t<e.coordinates.length;t++)r+=polygonArea(e.coordinates[t]);return r;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function polygonArea(e){var r=0;if(e&&e.length>0){r+=Math.abs(ringArea(e[0]));for(var t=1;t<e.length;t++)r-=Math.abs(ringArea(e[t]))}return r}function ringArea(e){var r,t,o,s,d,g,a,b=0,_=e.length;if(_>2){for(a=0;a<_;a++)a===_-2?(s=_-2,d=_-1,g=0):a===_-1?(s=_-1,d=0,g=1):(s=a,d=a+1,g=a+2),r=e[s],t=e[d],o=e[g],b+=(rad(o[0])-rad(r[0]))*Math.sin(rad(t[1]));b=b*RADIUS*RADIUS/2}return b}function rad(e){return e*Math.PI/180}const bitMethods={getBit(e){return this.data[getSlot(e)]&1<<getShift(e)?1:0},setBit(e){this.data[getSlot(e)]|=1<<getShift(e)},clearBit(e){this.data[getSlot(e)]&=~(1<<getShift(e))},toggleBit(e){this.data[getSlot(e)]^=1<<getShift(e)},getBitXY(e,r){return e>=this.width||r>=this.height?0:this.getBit(r*this.width+e)},setBitXY(e,r){this.setBit(r*this.width+e)},clearBitXY(e,r){this.clearBit(r*this.width+e)},toggleBitXY(e,r){this.toggleBit(r*this.width+e)}};function getSlot(e){return e>>3}function getShift(e){return 7-(e&7)}function setBitMethods(e){for(const r in bitMethods)e.prototype[r]=bitMethods[r]}function checkProcessable(e,r={}){let{bitDepth:t,alpha:o,colorModel:s,components:d,channels:g}=r;if(typeof e!="string"||e.length===0)throw new TypeError("processName must be a string");if(t&&(Array.isArray(t)||(t=[t]),!t.includes(this.bitDepth)))throw new TypeError(`The process: ${e} can only be applied if bit depth is in: ${t}`);if(o&&(Array.isArray(o)||(o=[o]),!o.includes(this.alpha)))throw new TypeError(`The process: ${e} can only be applied if alpha is in: ${o}`);if(s&&(Array.isArray(s)||(s=[s]),!s.includes(this.colorModel)))throw new TypeError(`The process: ${e} can only be applied if color model is in: ${s}`);if(d&&(Array.isArray(d)||(d=[d]),!d.includes(this.components))){let a=`The process: ${e} can only be applied if the number of components is in: ${d}`;throw d.length===1&&d[0]===1?new TypeError(`${a}.\rYou should transform your image using "image.grey()" before applying the algorithm.`):new TypeError(a)}if(g&&(Array.isArray(g)||(g=[g]),!g.includes(this.channels)))throw new TypeError(`The process: ${e} can only be applied if the number of channels is in: ${g}`)}function createBlob(e,r){e=e||[],r=r||{},typeof r=="string"&&(r={type:r});try{return new Blob(e,r)}catch(d){if(d.name!=="TypeError")throw d;for(var t=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,o=new t,s=0;s<e.length;s+=1)o.append(e[s]);return o.getBlob(r.type)}}function dataURLToBlob(e){var r=e.match(/data:([^;]+)/)[1],t=e.replace(/^[^,]+,/,""),o=binaryStringToArrayBuffer(atob(t));return createBlob([o],{type:r})}function canvasToBlob(e,r,t){return typeof e.toBlob=="function"?new Promise(function(o){e.toBlob(o,r,t)}):Promise.resolve(dataURLToBlob(e.toDataURL(r,t)))}function binaryStringToArrayBuffer(e){for(var r=e.length,t=new ArrayBuffer(r),o=new Uint8Array(t),s=-1;++s<r;)o[s]=e.charCodeAt(s);return t}(function(e){if(e.TextEncoder&&e.TextDecoder)return!1;function r(o="utf-8"){if(o!=="utf-8")throw new RangeError(`Failed to construct 'TextEncoder': The encoding label provided ('${o}') is invalid.`)}Object.defineProperty(r.prototype,"encoding",{value:"utf-8"}),r.prototype.encode=function(o,s={stream:!1}){if(s.stream)throw new Error("Failed to encode: the 'stream' option is unsupported.");let d=0;const g=o.length;let a=0,b=Math.max(32,g+(g>>1)+7),_=new Uint8Array(b>>3<<3);for(;d<g;){let T=o.charCodeAt(d++);if(T>=55296&&T<=56319){if(d<g){const C=o.charCodeAt(d);(C&64512)===56320&&(++d,T=((T&1023)<<10)+(C&1023)+65536)}if(T>=55296&&T<=56319)continue}if(a+4>_.length){b+=8,b*=1+d/o.length*2,b=b>>3<<3;const C=new Uint8Array(b);C.set(_),_=C}if(T&4294967168)if(!(T&4294965248))_[a++]=T>>6&31|192;else if(!(T&4294901760))_[a++]=T>>12&15|224,_[a++]=T>>6&63|128;else if(!(T&4292870144))_[a++]=T>>18&7|240,_[a++]=T>>12&63|128,_[a++]=T>>6&63|128;else continue;else{_[a++]=T;continue}_[a++]=T&63|128}return _.slice(0,a)};function t(o="utf-8",s={fatal:!1}){if(o!=="utf-8")throw new RangeError(`Failed to construct 'TextDecoder': The encoding label provided ('${o}') is invalid.`);if(s.fatal)throw new Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(t.prototype,"fatal",{value:!1}),Object.defineProperty(t.prototype,"ignoreBOM",{value:!1}),t.prototype.decode=function(o,s={stream:!1}){if(s.stream)throw new Error("Failed to decode: the 'stream' option is unsupported.");const d=new Uint8Array(o);let g=0;const a=d.length,b=[];for(;g<a;){const _=d[g++];if(_===0)break;if(!(_&128))b.push(_);else if((_&224)===192){const T=d[g++]&63;b.push((_&31)<<6|T)}else if((_&240)===224){const T=d[g++]&63,C=d[g++]&63;b.push((_&31)<<12|T<<6|C)}else if((_&248)===240){const T=d[g++]&63,C=d[g++]&63,D=d[g++]&63;let k=(_&7)<<18|T<<12|C<<6|D;k>65535&&(k-=65536,b.push(k>>>10&1023|55296),k=56320|k&1023),b.push(k)}}return String.fromCharCode.apply(null,b)},e.TextEncoder=r,e.TextDecoder=t})(typeof window<"u"?window:typeof self<"u"?self:globalThis);function decode$5(e,r="utf8"){return new TextDecoder(r).decode(e)}const encoder$1=new TextEncoder;function encode$3(e){return encoder$1.encode(e)}const defaultByteLength$1=1024*8,hostBigEndian=(()=>{const e=new Uint8Array(4),r=new Uint32Array(e.buffer);return!((r[0]=1)&e[0])})(),typedArrays={int8:globalThis.Int8Array,uint8:globalThis.Uint8Array,int16:globalThis.Int16Array,uint16:globalThis.Uint16Array,int32:globalThis.Int32Array,uint32:globalThis.Uint32Array,uint64:globalThis.BigUint64Array,int64:globalThis.BigInt64Array,float32:globalThis.Float32Array,float64:globalThis.Float64Array};let IOBuffer$4=class zp{constructor(r=defaultByteLength$1,t={}){let o=!1;typeof r=="number"?r=new ArrayBuffer(r):(o=!0,this.lastWrittenByte=r.byteLength);const s=t.offset?t.offset>>>0:0,d=r.byteLength-s;let g=s;(ArrayBuffer.isView(r)||r instanceof zp)&&(r.byteLength!==r.buffer.byteLength&&(g=r.byteOffset+s),r=r.buffer),o?this.lastWrittenByte=d:this.lastWrittenByte=0,this.buffer=r,this.length=d,this.byteLength=d,this.byteOffset=g,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,g,d),this._mark=0,this._marks=[]}available(r=1){return this.offset+r<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(r=1){return this.offset+=r,this}back(r=1){return this.offset-=r,this}seek(r){return this.offset=r,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const r=this._marks.pop();if(r===void 0)throw new Error("Mark stack empty");return this.seek(r),this}rewind(){return this.offset=0,this}ensureAvailable(r=1){if(!this.available(r)){const o=(this.offset+r)*2,s=new Uint8Array(o);s.set(new Uint8Array(this.buffer)),this.buffer=s.buffer,this.length=this.byteLength=o,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(r=1){return this.readArray(r,"uint8")}readArray(r,t){const o=typedArrays[t].BYTES_PER_ELEMENT*r,s=this.byteOffset+this.offset,d=this.buffer.slice(s,s+o);if(this.littleEndian===hostBigEndian&&t!=="uint8"&&t!=="int8"){const a=new Uint8Array(this.buffer.slice(s,s+o));a.reverse();const b=new typedArrays[t](a.buffer);return this.offset+=o,b.reverse(),b}const g=new typedArrays[t](d);return this.offset+=o,g}readInt16(){const r=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,r}readUint16(){const r=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,r}readInt32(){const r=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,r}readUint32(){const r=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,r}readFloat32(){const r=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,r}readFloat64(){const r=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,r}readBigInt64(){const r=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,r}readBigUint64(){const r=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,r}readChar(){return String.fromCharCode(this.readInt8())}readChars(r=1){let t="";for(let o=0;o<r;o++)t+=this.readChar();return t}readUtf8(r=1){return decode$5(this.readBytes(r))}decodeText(r=1,t="utf-8"){return decode$5(this.readBytes(r),t)}writeBoolean(r){return this.writeUint8(r?255:0),this}writeInt8(r){return this.ensureAvailable(1),this._data.setInt8(this.offset++,r),this._updateLastWrittenByte(),this}writeUint8(r){return this.ensureAvailable(1),this._data.setUint8(this.offset++,r),this._updateLastWrittenByte(),this}writeByte(r){return this.writeUint8(r)}writeBytes(r){this.ensureAvailable(r.length);for(let t=0;t<r.length;t++)this._data.setUint8(this.offset++,r[t]);return this._updateLastWrittenByte(),this}writeInt16(r){return this.ensureAvailable(2),this._data.setInt16(this.offset,r,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(r){return this.ensureAvailable(2),this._data.setUint16(this.offset,r,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(r){return this.ensureAvailable(4),this._data.setInt32(this.offset,r,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(r){return this.ensureAvailable(4),this._data.setUint32(this.offset,r,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(r){return this.ensureAvailable(4),this._data.setFloat32(this.offset,r,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(r){return this.ensureAvailable(8),this._data.setFloat64(this.offset,r,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(r){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,r,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(r){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,r,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(r){return this.writeUint8(r.charCodeAt(0))}writeChars(r){for(let t=0;t<r.length;t++)this.writeUint8(r.charCodeAt(t));return this}writeUtf8(r){return this.writeBytes(encode$3(r))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}};const IOBuffer$5=Object.freeze(Object.defineProperty({__proto__:null,IOBuffer:IOBuffer$4},Symbol.toStringTag,{value:"Module"})),require$$0$4=getAugmentedNamespace(IOBuffer$5);var constants$d={BITMAPV5HEADER:{LogicalColorSpace:{LCS_CALIBRATED_RGB:0,LCS_sRGB:1934772034,LCS_WINDOWS_COLOR_SPACE:1466527264},Compression:{BI_RGB:0,BI_RLE8:1,BI_RLE4:2,BI_BITFIELDS:3,BI_JPEG:4,BI_PNG:5,BI_CMYK:11,BI_CMYKRLE8:12,BI_CMYKRLE4:13},GamutMappingIntent:{LCS_GM_ABS_COLORIMETRIC:8,LCS_GM_BUSINESS:1,LCS_GM_GRAPHICS:2,LCS_GM_IMAGES:4}}};const{IOBuffer:IOBuffer$3}=require$$0$4,constants$c=constants$d,tableLeft=[];for(let e=0;e<=8;e++)tableLeft.push(255<<e);class BMPEncoder extends IOBuffer$3{constructor(r){if(r.bitDepth!==1)throw new Error("Only bitDepth of 1 is supported");if(!r.height||!r.width)throw new Error("ImageData width and height are required");super(r.data),this.width=r.width,this.height=r.height,this.bitDepth=r.bitDepth,this.channels=r.channels,this.components=r.components}encode(){this.encoded=new IOBuffer$3,this.encoded.skip(14),this.writeBitmapV5Header(),this.writeColorTable();const r=this.encoded.offset;return this.writePixelArray(),this.encoded.rewind(),this.writeBitmapFileHeader(r),this.encoded.toArray()}writePixelArray(){let r=this.encoded;const t=Math.floor((this.bitDepth*this.width+31)/32)*4,o=Math.ceil(this.bitDepth*this.width/8),s=t-o,d=this.bitDepth*this.width%8,g=d===0?0:8-d,a=t*this.height;let b,_,T=0,C=0,D=8;r.mark(),_=this.readUint8();for(let k=this.height-1;k>=0;k--){const O=k===0;r.reset(),r.skip(k*t);for(let U=0;U<o;U++){const G=U===o-1;C<=g&&G?(r.writeByte(_<<C),(g===0||g===C)&&!O&&(b=_,_=this.readByte())):C===0?(b=_,_=this.readUint8(),r.writeByte(b)):(b=_,_=this.readUint8(),r.writeByte(b<<C&tableLeft[C]|_>>D)),G&&(T+=d||0,r.skip(s),C=T%8,D=8-C)}}t>o&&(r.reset(),r.skip(a-1),r.writeUint8(0))}writeColorTable(){this.encoded.writeUint32(0).writeUint32(16777215)}writeBitmapFileHeader(r){this.encoded.writeChars("BM").writeInt32(this.encoded.lastWrittenByte).writeUint16(0).writeUint16(0).writeUint32(r)}writeBitmapV5Header(){const t=Math.floor((this.bitDepth*this.width+31)/32)*4*this.height;this.encoded.writeUint32(124).writeInt32(this.width).writeInt32(this.height).writeUint16(1).writeUint16(this.bitDepth).writeUint32(constants$c.BITMAPV5HEADER.Compression.BI_RGB).writeUint32(t).writeInt32(0).writeInt32(0).writeUint32(Math.pow(2,this.bitDepth)).writeUint32(Math.pow(2,this.bitDepth)).writeUint32(4278190080).writeUint32(16711680).writeUint32(65280).writeUint32(255).writeUint32(constants$c.BITMAPV5HEADER.LogicalColorSpace.LCS_sRGB).skip(36).skip(12).writeUint32(constants$c.BITMAPV5HEADER.GamutMappingIntent.LCS_GM_IMAGES).skip(12)}}var BMPEncoder_1=BMPEncoder;const Encoder=BMPEncoder_1;var encode$2=function(r){return new Encoder(r).encode()};/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const Z_FIXED$1$1=4,Z_BINARY$1=0,Z_TEXT$1=1,Z_UNKNOWN$1$1=2;function zero$1$1(e){let r=e.length;for(;--r>=0;)e[r]=0}const STORED_BLOCK$1=0,STATIC_TREES$1=1,DYN_TREES$1=2,MIN_MATCH$1$1=3,MAX_MATCH$1$1=258,LENGTH_CODES$1$1=29,LITERALS$1$1=256,L_CODES$1$1=LITERALS$1$1+1+LENGTH_CODES$1$1,D_CODES$1$1=30,BL_CODES$1$1=19,HEAP_SIZE$1$1=2*L_CODES$1$1+1,MAX_BITS$1$1=15,Buf_size$1=16,MAX_BL_BITS$1=7,END_BLOCK$1=256,REP_3_6$1=16,REPZ_3_10$1=17,REPZ_11_138$1=18,extra_lbits$1=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),extra_dbits$1=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),extra_blbits$1=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),bl_order$1=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),DIST_CODE_LEN$1=512,static_ltree$1=new Array((L_CODES$1$1+2)*2);zero$1$1(static_ltree$1);const static_dtree$1=new Array(D_CODES$1$1*2);zero$1$1(static_dtree$1);const _dist_code$1=new Array(DIST_CODE_LEN$1);zero$1$1(_dist_code$1);const _length_code$1=new Array(MAX_MATCH$1$1-MIN_MATCH$1$1+1);zero$1$1(_length_code$1);const base_length$1=new Array(LENGTH_CODES$1$1);zero$1$1(base_length$1);const base_dist$1=new Array(D_CODES$1$1);zero$1$1(base_dist$1);function StaticTreeDesc$1(e,r,t,o,s){this.static_tree=e,this.extra_bits=r,this.extra_base=t,this.elems=o,this.max_length=s,this.has_stree=e&&e.length}let static_l_desc$1,static_d_desc$1,static_bl_desc$1;function TreeDesc$1(e,r){this.dyn_tree=e,this.max_code=0,this.stat_desc=r}const d_code$1=e=>e<256?_dist_code$1[e]:_dist_code$1[256+(e>>>7)],put_short$1=(e,r)=>{e.pending_buf[e.pending++]=r&255,e.pending_buf[e.pending++]=r>>>8&255},send_bits$1=(e,r,t)=>{e.bi_valid>Buf_size$1-t?(e.bi_buf|=r<<e.bi_valid&65535,put_short$1(e,e.bi_buf),e.bi_buf=r>>Buf_size$1-e.bi_valid,e.bi_valid+=t-Buf_size$1):(e.bi_buf|=r<<e.bi_valid&65535,e.bi_valid+=t)},send_code$1=(e,r,t)=>{send_bits$1(e,t[r*2],t[r*2+1])},bi_reverse$1=(e,r)=>{let t=0;do t|=e&1,e>>>=1,t<<=1;while(--r>0);return t>>>1},bi_flush$1=e=>{e.bi_valid===16?(put_short$1(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=e.bi_buf&255,e.bi_buf>>=8,e.bi_valid-=8)},gen_bitlen$1=(e,r)=>{const t=r.dyn_tree,o=r.max_code,s=r.stat_desc.static_tree,d=r.stat_desc.has_stree,g=r.stat_desc.extra_bits,a=r.stat_desc.extra_base,b=r.stat_desc.max_length;let _,T,C,D,k,O,U=0;for(D=0;D<=MAX_BITS$1$1;D++)e.bl_count[D]=0;for(t[e.heap[e.heap_max]*2+1]=0,_=e.heap_max+1;_<HEAP_SIZE$1$1;_++)T=e.heap[_],D=t[t[T*2+1]*2+1]+1,D>b&&(D=b,U++),t[T*2+1]=D,!(T>o)&&(e.bl_count[D]++,k=0,T>=a&&(k=g[T-a]),O=t[T*2],e.opt_len+=O*(D+k),d&&(e.static_len+=O*(s[T*2+1]+k)));if(U!==0){do{for(D=b-1;e.bl_count[D]===0;)D--;e.bl_count[D]--,e.bl_count[D+1]+=2,e.bl_count[b]--,U-=2}while(U>0);for(D=b;D!==0;D--)for(T=e.bl_count[D];T!==0;)C=e.heap[--_],!(C>o)&&(t[C*2+1]!==D&&(e.opt_len+=(D-t[C*2+1])*t[C*2],t[C*2+1]=D),T--)}},gen_codes$1=(e,r,t)=>{const o=new Array(MAX_BITS$1$1+1);let s=0,d,g;for(d=1;d<=MAX_BITS$1$1;d++)s=s+t[d-1]<<1,o[d]=s;for(g=0;g<=r;g++){let a=e[g*2+1];a!==0&&(e[g*2]=bi_reverse$1(o[a]++,a))}},tr_static_init$1=()=>{let e,r,t,o,s;const d=new Array(MAX_BITS$1$1+1);for(t=0,o=0;o<LENGTH_CODES$1$1-1;o++)for(base_length$1[o]=t,e=0;e<1<<extra_lbits$1[o];e++)_length_code$1[t++]=o;for(_length_code$1[t-1]=o,s=0,o=0;o<16;o++)for(base_dist$1[o]=s,e=0;e<1<<extra_dbits$1[o];e++)_dist_code$1[s++]=o;for(s>>=7;o<D_CODES$1$1;o++)for(base_dist$1[o]=s<<7,e=0;e<1<<extra_dbits$1[o]-7;e++)_dist_code$1[256+s++]=o;for(r=0;r<=MAX_BITS$1$1;r++)d[r]=0;for(e=0;e<=143;)static_ltree$1[e*2+1]=8,e++,d[8]++;for(;e<=255;)static_ltree$1[e*2+1]=9,e++,d[9]++;for(;e<=279;)static_ltree$1[e*2+1]=7,e++,d[7]++;for(;e<=287;)static_ltree$1[e*2+1]=8,e++,d[8]++;for(gen_codes$1(static_ltree$1,L_CODES$1$1+1,d),e=0;e<D_CODES$1$1;e++)static_dtree$1[e*2+1]=5,static_dtree$1[e*2]=bi_reverse$1(e,5);static_l_desc$1=new StaticTreeDesc$1(static_ltree$1,extra_lbits$1,LITERALS$1$1+1,L_CODES$1$1,MAX_BITS$1$1),static_d_desc$1=new StaticTreeDesc$1(static_dtree$1,extra_dbits$1,0,D_CODES$1$1,MAX_BITS$1$1),static_bl_desc$1=new StaticTreeDesc$1(new Array(0),extra_blbits$1,0,BL_CODES$1$1,MAX_BL_BITS$1)},init_block$1=e=>{let r;for(r=0;r<L_CODES$1$1;r++)e.dyn_ltree[r*2]=0;for(r=0;r<D_CODES$1$1;r++)e.dyn_dtree[r*2]=0;for(r=0;r<BL_CODES$1$1;r++)e.bl_tree[r*2]=0;e.dyn_ltree[END_BLOCK$1*2]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},bi_windup$1=e=>{e.bi_valid>8?put_short$1(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},smaller$1=(e,r,t,o)=>{const s=r*2,d=t*2;return e[s]<e[d]||e[s]===e[d]&&o[r]<=o[t]},pqdownheap$1=(e,r,t)=>{const o=e.heap[t];let s=t<<1;for(;s<=e.heap_len&&(s<e.heap_len&&smaller$1(r,e.heap[s+1],e.heap[s],e.depth)&&s++,!smaller$1(r,o,e.heap[s],e.depth));)e.heap[t]=e.heap[s],t=s,s<<=1;e.heap[t]=o},compress_block$1=(e,r,t)=>{let o,s,d=0,g,a;if(e.sym_next!==0)do o=e.pending_buf[e.sym_buf+d++]&255,o+=(e.pending_buf[e.sym_buf+d++]&255)<<8,s=e.pending_buf[e.sym_buf+d++],o===0?send_code$1(e,s,r):(g=_length_code$1[s],send_code$1(e,g+LITERALS$1$1+1,r),a=extra_lbits$1[g],a!==0&&(s-=base_length$1[g],send_bits$1(e,s,a)),o--,g=d_code$1(o),send_code$1(e,g,t),a=extra_dbits$1[g],a!==0&&(o-=base_dist$1[g],send_bits$1(e,o,a)));while(d<e.sym_next);send_code$1(e,END_BLOCK$1,r)},build_tree$1=(e,r)=>{const t=r.dyn_tree,o=r.stat_desc.static_tree,s=r.stat_desc.has_stree,d=r.stat_desc.elems;let g,a,b=-1,_;for(e.heap_len=0,e.heap_max=HEAP_SIZE$1$1,g=0;g<d;g++)t[g*2]!==0?(e.heap[++e.heap_len]=b=g,e.depth[g]=0):t[g*2+1]=0;for(;e.heap_len<2;)_=e.heap[++e.heap_len]=b<2?++b:0,t[_*2]=1,e.depth[_]=0,e.opt_len--,s&&(e.static_len-=o[_*2+1]);for(r.max_code=b,g=e.heap_len>>1;g>=1;g--)pqdownheap$1(e,t,g);_=d;do g=e.heap[1],e.heap[1]=e.heap[e.heap_len--],pqdownheap$1(e,t,1),a=e.heap[1],e.heap[--e.heap_max]=g,e.heap[--e.heap_max]=a,t[_*2]=t[g*2]+t[a*2],e.depth[_]=(e.depth[g]>=e.depth[a]?e.depth[g]:e.depth[a])+1,t[g*2+1]=t[a*2+1]=_,e.heap[1]=_++,pqdownheap$1(e,t,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],gen_bitlen$1(e,r),gen_codes$1(t,b,e.bl_count)},scan_tree$1=(e,r,t)=>{let o,s=-1,d,g=r[0*2+1],a=0,b=7,_=4;for(g===0&&(b=138,_=3),r[(t+1)*2+1]=65535,o=0;o<=t;o++)d=g,g=r[(o+1)*2+1],!(++a<b&&d===g)&&(a<_?e.bl_tree[d*2]+=a:d!==0?(d!==s&&e.bl_tree[d*2]++,e.bl_tree[REP_3_6$1*2]++):a<=10?e.bl_tree[REPZ_3_10$1*2]++:e.bl_tree[REPZ_11_138$1*2]++,a=0,s=d,g===0?(b=138,_=3):d===g?(b=6,_=3):(b=7,_=4))},send_tree$1=(e,r,t)=>{let o,s=-1,d,g=r[0*2+1],a=0,b=7,_=4;for(g===0&&(b=138,_=3),o=0;o<=t;o++)if(d=g,g=r[(o+1)*2+1],!(++a<b&&d===g)){if(a<_)do send_code$1(e,d,e.bl_tree);while(--a!==0);else d!==0?(d!==s&&(send_code$1(e,d,e.bl_tree),a--),send_code$1(e,REP_3_6$1,e.bl_tree),send_bits$1(e,a-3,2)):a<=10?(send_code$1(e,REPZ_3_10$1,e.bl_tree),send_bits$1(e,a-3,3)):(send_code$1(e,REPZ_11_138$1,e.bl_tree),send_bits$1(e,a-11,7));a=0,s=d,g===0?(b=138,_=3):d===g?(b=6,_=3):(b=7,_=4)}},build_bl_tree$1=e=>{let r;for(scan_tree$1(e,e.dyn_ltree,e.l_desc.max_code),scan_tree$1(e,e.dyn_dtree,e.d_desc.max_code),build_tree$1(e,e.bl_desc),r=BL_CODES$1$1-1;r>=3&&e.bl_tree[bl_order$1[r]*2+1]===0;r--);return e.opt_len+=3*(r+1)+5+5+4,r},send_all_trees$1=(e,r,t,o)=>{let s;for(send_bits$1(e,r-257,5),send_bits$1(e,t-1,5),send_bits$1(e,o-4,4),s=0;s<o;s++)send_bits$1(e,e.bl_tree[bl_order$1[s]*2+1],3);send_tree$1(e,e.dyn_ltree,r-1),send_tree$1(e,e.dyn_dtree,t-1)},detect_data_type$1=e=>{let r=4093624447,t;for(t=0;t<=31;t++,r>>>=1)if(r&1&&e.dyn_ltree[t*2]!==0)return Z_BINARY$1;if(e.dyn_ltree[9*2]!==0||e.dyn_ltree[10*2]!==0||e.dyn_ltree[13*2]!==0)return Z_TEXT$1;for(t=32;t<LITERALS$1$1;t++)if(e.dyn_ltree[t*2]!==0)return Z_TEXT$1;return Z_BINARY$1};let static_init_done$1=!1;const _tr_init$1$1=e=>{static_init_done$1||(tr_static_init$1(),static_init_done$1=!0),e.l_desc=new TreeDesc$1(e.dyn_ltree,static_l_desc$1),e.d_desc=new TreeDesc$1(e.dyn_dtree,static_d_desc$1),e.bl_desc=new TreeDesc$1(e.bl_tree,static_bl_desc$1),e.bi_buf=0,e.bi_valid=0,init_block$1(e)},_tr_stored_block$1$1=(e,r,t,o)=>{send_bits$1(e,(STORED_BLOCK$1<<1)+(o?1:0),3),bi_windup$1(e),put_short$1(e,t),put_short$1(e,~t),t&&e.pending_buf.set(e.window.subarray(r,r+t),e.pending),e.pending+=t},_tr_align$1$1=e=>{send_bits$1(e,STATIC_TREES$1<<1,3),send_code$1(e,END_BLOCK$1,static_ltree$1),bi_flush$1(e)},_tr_flush_block$1$1=(e,r,t,o)=>{let s,d,g=0;e.level>0?(e.strm.data_type===Z_UNKNOWN$1$1&&(e.strm.data_type=detect_data_type$1(e)),build_tree$1(e,e.l_desc),build_tree$1(e,e.d_desc),g=build_bl_tree$1(e),s=e.opt_len+3+7>>>3,d=e.static_len+3+7>>>3,d<=s&&(s=d)):s=d=t+5,t+4<=s&&r!==-1?_tr_stored_block$1$1(e,r,t,o):e.strategy===Z_FIXED$1$1||d===s?(send_bits$1(e,(STATIC_TREES$1<<1)+(o?1:0),3),compress_block$1(e,static_ltree$1,static_dtree$1)):(send_bits$1(e,(DYN_TREES$1<<1)+(o?1:0),3),send_all_trees$1(e,e.l_desc.max_code+1,e.d_desc.max_code+1,g+1),compress_block$1(e,e.dyn_ltree,e.dyn_dtree)),init_block$1(e),o&&bi_windup$1(e)},_tr_tally$1$1=(e,r,t)=>(e.pending_buf[e.sym_buf+e.sym_next++]=r,e.pending_buf[e.sym_buf+e.sym_next++]=r>>8,e.pending_buf[e.sym_buf+e.sym_next++]=t,r===0?e.dyn_ltree[t*2]++:(e.matches++,r--,e.dyn_ltree[(_length_code$1[t]+LITERALS$1$1+1)*2]++,e.dyn_dtree[d_code$1(r)*2]++),e.sym_next===e.sym_end);var _tr_init_1$1=_tr_init$1$1,_tr_stored_block_1$1=_tr_stored_block$1$1,_tr_flush_block_1$1=_tr_flush_block$1$1,_tr_tally_1$1=_tr_tally$1$1,_tr_align_1$1=_tr_align$1$1,trees$1={_tr_init:_tr_init_1$1,_tr_stored_block:_tr_stored_block_1$1,_tr_flush_block:_tr_flush_block_1$1,_tr_tally:_tr_tally_1$1,_tr_align:_tr_align_1$1};const adler32$1=(e,r,t,o)=>{let s=e&65535|0,d=e>>>16&65535|0,g=0;for(;t!==0;){g=t>2e3?2e3:t,t-=g;do s=s+r[o++]|0,d=d+s|0;while(--g);s%=65521,d%=65521}return s|d<<16|0};var adler32_1$1=adler32$1;const makeTable$1=()=>{let e,r=[];for(var t=0;t<256;t++){e=t;for(var o=0;o<8;o++)e=e&1?3988292384^e>>>1:e>>>1;r[t]=e}return r},crcTable$2=new Uint32Array(makeTable$1()),crc32$1=(e,r,t,o)=>{const s=crcTable$2,d=o+t;e^=-1;for(let g=o;g<d;g++)e=e>>>8^s[(e^r[g])&255];return e^-1};var crc32_1$1=crc32$1,messages$1={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},constants$2$2={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:_tr_init$2,_tr_stored_block:_tr_stored_block$2,_tr_flush_block:_tr_flush_block$2,_tr_tally:_tr_tally$2,_tr_align:_tr_align$2}=trees$1,{Z_NO_FLUSH:Z_NO_FLUSH$2$1,Z_PARTIAL_FLUSH:Z_PARTIAL_FLUSH$1,Z_FULL_FLUSH:Z_FULL_FLUSH$1$1,Z_FINISH:Z_FINISH$3$1,Z_BLOCK:Z_BLOCK$1$1,Z_OK:Z_OK$3$1,Z_STREAM_END:Z_STREAM_END$3$1,Z_STREAM_ERROR:Z_STREAM_ERROR$2$1,Z_DATA_ERROR:Z_DATA_ERROR$2$1,Z_BUF_ERROR:Z_BUF_ERROR$1$1,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$1$1,Z_FILTERED:Z_FILTERED$1,Z_HUFFMAN_ONLY:Z_HUFFMAN_ONLY$1,Z_RLE:Z_RLE$1,Z_FIXED:Z_FIXED$2,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY$1$1,Z_UNKNOWN:Z_UNKNOWN$2,Z_DEFLATED:Z_DEFLATED$2$1}=constants$2$2,MAX_MEM_LEVEL$1=9,MAX_WBITS$1$1=15,DEF_MEM_LEVEL$1=8,LENGTH_CODES$2=29,LITERALS$2=256,L_CODES$2=LITERALS$2+1+LENGTH_CODES$2,D_CODES$2=30,BL_CODES$2=19,HEAP_SIZE$2=2*L_CODES$2+1,MAX_BITS$2=15,MIN_MATCH$2=3,MAX_MATCH$2=258,MIN_LOOKAHEAD$1=MAX_MATCH$2+MIN_MATCH$2+1,PRESET_DICT$1=32,INIT_STATE$1=42,GZIP_STATE$1=57,EXTRA_STATE$1=69,NAME_STATE$1=73,COMMENT_STATE$1=91,HCRC_STATE$1=103,BUSY_STATE$1=113,FINISH_STATE$1=666,BS_NEED_MORE$1=1,BS_BLOCK_DONE$1=2,BS_FINISH_STARTED$1=3,BS_FINISH_DONE$1=4,OS_CODE$1=3,err$1=(e,r)=>(e.msg=messages$1[r],r),rank$1=e=>e*2-(e>4?9:0),zero$2=e=>{let r=e.length;for(;--r>=0;)e[r]=0},slide_hash$1=e=>{let r,t,o,s=e.w_size;r=e.hash_size,o=r;do t=e.head[--o],e.head[o]=t>=s?t-s:0;while(--r);r=s,o=r;do t=e.prev[--o],e.prev[o]=t>=s?t-s:0;while(--r)};let HASH_ZLIB$1=(e,r,t)=>(r<<e.hash_shift^t)&e.hash_mask,HASH$1=HASH_ZLIB$1;const flush_pending$1=e=>{const r=e.state;let t=r.pending;t>e.avail_out&&(t=e.avail_out),t!==0&&(e.output.set(r.pending_buf.subarray(r.pending_out,r.pending_out+t),e.next_out),e.next_out+=t,r.pending_out+=t,e.total_out+=t,e.avail_out-=t,r.pending-=t,r.pending===0&&(r.pending_out=0))},flush_block_only$1=(e,r)=>{_tr_flush_block$2(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,r),e.block_start=e.strstart,flush_pending$1(e.strm)},put_byte$1=(e,r)=>{e.pending_buf[e.pending++]=r},putShortMSB$1=(e,r)=>{e.pending_buf[e.pending++]=r>>>8&255,e.pending_buf[e.pending++]=r&255},read_buf$1=(e,r,t,o)=>{let s=e.avail_in;return s>o&&(s=o),s===0?0:(e.avail_in-=s,r.set(e.input.subarray(e.next_in,e.next_in+s),t),e.state.wrap===1?e.adler=adler32_1$1(e.adler,r,s,t):e.state.wrap===2&&(e.adler=crc32_1$1(e.adler,r,s,t)),e.next_in+=s,e.total_in+=s,s)},longest_match$1=(e,r)=>{let t=e.max_chain_length,o=e.strstart,s,d,g=e.prev_length,a=e.nice_match;const b=e.strstart>e.w_size-MIN_LOOKAHEAD$1?e.strstart-(e.w_size-MIN_LOOKAHEAD$1):0,_=e.window,T=e.w_mask,C=e.prev,D=e.strstart+MAX_MATCH$2;let k=_[o+g-1],O=_[o+g];e.prev_length>=e.good_match&&(t>>=2),a>e.lookahead&&(a=e.lookahead);do if(s=r,!(_[s+g]!==O||_[s+g-1]!==k||_[s]!==_[o]||_[++s]!==_[o+1])){o+=2,s++;do;while(_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&o<D);if(d=MAX_MATCH$2-(D-o),o=D-MAX_MATCH$2,d>g){if(e.match_start=r,g=d,d>=a)break;k=_[o+g-1],O=_[o+g]}}while((r=C[r&T])>b&&--t!==0);return g<=e.lookahead?g:e.lookahead},fill_window$1=e=>{const r=e.w_size;let t,o,s;do{if(o=e.window_size-e.lookahead-e.strstart,e.strstart>=r+(r-MIN_LOOKAHEAD$1)&&(e.window.set(e.window.subarray(r,r+r-o),0),e.match_start-=r,e.strstart-=r,e.block_start-=r,e.insert>e.strstart&&(e.insert=e.strstart),slide_hash$1(e),o+=r),e.strm.avail_in===0)break;if(t=read_buf$1(e.strm,e.window,e.strstart+e.lookahead,o),e.lookahead+=t,e.lookahead+e.insert>=MIN_MATCH$2)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=HASH$1(e,e.ins_h,e.window[s+1]);e.insert&&(e.ins_h=HASH$1(e,e.ins_h,e.window[s+MIN_MATCH$2-1]),e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<MIN_MATCH$2)););}while(e.lookahead<MIN_LOOKAHEAD$1&&e.strm.avail_in!==0)},deflate_stored$1=(e,r)=>{let t=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o,s,d,g=0,a=e.strm.avail_in;do{if(o=65535,d=e.bi_valid+42>>3,e.strm.avail_out<d||(d=e.strm.avail_out-d,s=e.strstart-e.block_start,o>s+e.strm.avail_in&&(o=s+e.strm.avail_in),o>d&&(o=d),o<t&&(o===0&&r!==Z_FINISH$3$1||r===Z_NO_FLUSH$2$1||o!==s+e.strm.avail_in)))break;g=r===Z_FINISH$3$1&&o===s+e.strm.avail_in?1:0,_tr_stored_block$2(e,0,0,g),e.pending_buf[e.pending-4]=o,e.pending_buf[e.pending-3]=o>>8,e.pending_buf[e.pending-2]=~o,e.pending_buf[e.pending-1]=~o>>8,flush_pending$1(e.strm),s&&(s>o&&(s=o),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+s),e.strm.next_out),e.strm.next_out+=s,e.strm.avail_out-=s,e.strm.total_out+=s,e.block_start+=s,o-=s),o&&(read_buf$1(e.strm,e.strm.output,e.strm.next_out,o),e.strm.next_out+=o,e.strm.avail_out-=o,e.strm.total_out+=o)}while(g===0);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),g?BS_FINISH_DONE$1:r!==Z_NO_FLUSH$2$1&&r!==Z_FINISH$3$1&&e.strm.avail_in===0&&e.strstart===e.block_start?BS_BLOCK_DONE$1:(d=e.window_size-e.strstart,e.strm.avail_in>d&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,d+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),d>e.strm.avail_in&&(d=e.strm.avail_in),d&&(read_buf$1(e.strm,e.window,e.strstart,d),e.strstart+=d,e.insert+=d>e.w_size-e.insert?e.w_size-e.insert:d),e.high_water<e.strstart&&(e.high_water=e.strstart),d=e.bi_valid+42>>3,d=e.pending_buf_size-d>65535?65535:e.pending_buf_size-d,t=d>e.w_size?e.w_size:d,s=e.strstart-e.block_start,(s>=t||(s||r===Z_FINISH$3$1)&&r!==Z_NO_FLUSH$2$1&&e.strm.avail_in===0&&s<=d)&&(o=s>d?d:s,g=r===Z_FINISH$3$1&&e.strm.avail_in===0&&o===s?1:0,_tr_stored_block$2(e,e.block_start,o,g),e.block_start+=o,flush_pending$1(e.strm)),g?BS_FINISH_STARTED$1:BS_NEED_MORE$1)},deflate_fast$1=(e,r)=>{let t,o;for(;;){if(e.lookahead<MIN_LOOKAHEAD$1){if(fill_window$1(e),e.lookahead<MIN_LOOKAHEAD$1&&r===Z_NO_FLUSH$2$1)return BS_NEED_MORE$1;if(e.lookahead===0)break}if(t=0,e.lookahead>=MIN_MATCH$2&&(e.ins_h=HASH$1(e,e.ins_h,e.window[e.strstart+MIN_MATCH$2-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),t!==0&&e.strstart-t<=e.w_size-MIN_LOOKAHEAD$1&&(e.match_length=longest_match$1(e,t)),e.match_length>=MIN_MATCH$2)if(o=_tr_tally$2(e,e.strstart-e.match_start,e.match_length-MIN_MATCH$2),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=MIN_MATCH$2){e.match_length--;do e.strstart++,e.ins_h=HASH$1(e,e.ins_h,e.window[e.strstart+MIN_MATCH$2-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!==0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=HASH$1(e,e.ins_h,e.window[e.strstart+1]);else o=_tr_tally$2(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(o&&(flush_block_only$1(e,!1),e.strm.avail_out===0))return BS_NEED_MORE$1}return e.insert=e.strstart<MIN_MATCH$2-1?e.strstart:MIN_MATCH$2-1,r===Z_FINISH$3$1?(flush_block_only$1(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED$1:BS_FINISH_DONE$1):e.sym_next&&(flush_block_only$1(e,!1),e.strm.avail_out===0)?BS_NEED_MORE$1:BS_BLOCK_DONE$1},deflate_slow$1=(e,r)=>{let t,o,s;for(;;){if(e.lookahead<MIN_LOOKAHEAD$1){if(fill_window$1(e),e.lookahead<MIN_LOOKAHEAD$1&&r===Z_NO_FLUSH$2$1)return BS_NEED_MORE$1;if(e.lookahead===0)break}if(t=0,e.lookahead>=MIN_MATCH$2&&(e.ins_h=HASH$1(e,e.ins_h,e.window[e.strstart+MIN_MATCH$2-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=MIN_MATCH$2-1,t!==0&&e.prev_length<e.max_lazy_match&&e.strstart-t<=e.w_size-MIN_LOOKAHEAD$1&&(e.match_length=longest_match$1(e,t),e.match_length<=5&&(e.strategy===Z_FILTERED$1||e.match_length===MIN_MATCH$2&&e.strstart-e.match_start>4096)&&(e.match_length=MIN_MATCH$2-1)),e.prev_length>=MIN_MATCH$2&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-MIN_MATCH$2,o=_tr_tally$2(e,e.strstart-1-e.prev_match,e.prev_length-MIN_MATCH$2),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=s&&(e.ins_h=HASH$1(e,e.ins_h,e.window[e.strstart+MIN_MATCH$2-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!==0);if(e.match_available=0,e.match_length=MIN_MATCH$2-1,e.strstart++,o&&(flush_block_only$1(e,!1),e.strm.avail_out===0))return BS_NEED_MORE$1}else if(e.match_available){if(o=_tr_tally$2(e,0,e.window[e.strstart-1]),o&&flush_block_only$1(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return BS_NEED_MORE$1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(o=_tr_tally$2(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<MIN_MATCH$2-1?e.strstart:MIN_MATCH$2-1,r===Z_FINISH$3$1?(flush_block_only$1(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED$1:BS_FINISH_DONE$1):e.sym_next&&(flush_block_only$1(e,!1),e.strm.avail_out===0)?BS_NEED_MORE$1:BS_BLOCK_DONE$1},deflate_rle$1=(e,r)=>{let t,o,s,d;const g=e.window;for(;;){if(e.lookahead<=MAX_MATCH$2){if(fill_window$1(e),e.lookahead<=MAX_MATCH$2&&r===Z_NO_FLUSH$2$1)return BS_NEED_MORE$1;if(e.lookahead===0)break}if(e.match_length=0,e.lookahead>=MIN_MATCH$2&&e.strstart>0&&(s=e.strstart-1,o=g[s],o===g[++s]&&o===g[++s]&&o===g[++s])){d=e.strstart+MAX_MATCH$2;do;while(o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&s<d);e.match_length=MAX_MATCH$2-(d-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=MIN_MATCH$2?(t=_tr_tally$2(e,1,e.match_length-MIN_MATCH$2),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(t=_tr_tally$2(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),t&&(flush_block_only$1(e,!1),e.strm.avail_out===0))return BS_NEED_MORE$1}return e.insert=0,r===Z_FINISH$3$1?(flush_block_only$1(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED$1:BS_FINISH_DONE$1):e.sym_next&&(flush_block_only$1(e,!1),e.strm.avail_out===0)?BS_NEED_MORE$1:BS_BLOCK_DONE$1},deflate_huff$1=(e,r)=>{let t;for(;;){if(e.lookahead===0&&(fill_window$1(e),e.lookahead===0)){if(r===Z_NO_FLUSH$2$1)return BS_NEED_MORE$1;break}if(e.match_length=0,t=_tr_tally$2(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,t&&(flush_block_only$1(e,!1),e.strm.avail_out===0))return BS_NEED_MORE$1}return e.insert=0,r===Z_FINISH$3$1?(flush_block_only$1(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED$1:BS_FINISH_DONE$1):e.sym_next&&(flush_block_only$1(e,!1),e.strm.avail_out===0)?BS_NEED_MORE$1:BS_BLOCK_DONE$1};function Config$1(e,r,t,o,s){this.good_length=e,this.max_lazy=r,this.nice_length=t,this.max_chain=o,this.func=s}const configuration_table$1=[new Config$1(0,0,0,0,deflate_stored$1),new Config$1(4,4,8,4,deflate_fast$1),new Config$1(4,5,16,8,deflate_fast$1),new Config$1(4,6,32,32,deflate_fast$1),new Config$1(4,4,16,16,deflate_slow$1),new Config$1(8,16,32,32,deflate_slow$1),new Config$1(8,16,128,128,deflate_slow$1),new Config$1(8,32,128,256,deflate_slow$1),new Config$1(32,128,258,1024,deflate_slow$1),new Config$1(32,258,258,4096,deflate_slow$1)],lm_init$1=e=>{e.window_size=2*e.w_size,zero$2(e.head),e.max_lazy_match=configuration_table$1[e.level].max_lazy,e.good_match=configuration_table$1[e.level].good_length,e.nice_match=configuration_table$1[e.level].nice_length,e.max_chain_length=configuration_table$1[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=MIN_MATCH$2-1,e.match_available=0,e.ins_h=0};function DeflateState$1(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Z_DEFLATED$2$1,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(HEAP_SIZE$2*2),this.dyn_dtree=new Uint16Array((2*D_CODES$2+1)*2),this.bl_tree=new Uint16Array((2*BL_CODES$2+1)*2),zero$2(this.dyn_ltree),zero$2(this.dyn_dtree),zero$2(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(MAX_BITS$2+1),this.heap=new Uint16Array(2*L_CODES$2+1),zero$2(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*L_CODES$2+1),zero$2(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const deflateStateCheck$1=e=>{if(!e)return 1;const r=e.state;return!r||r.strm!==e||r.status!==INIT_STATE$1&&r.status!==GZIP_STATE$1&&r.status!==EXTRA_STATE$1&&r.status!==NAME_STATE$1&&r.status!==COMMENT_STATE$1&&r.status!==HCRC_STATE$1&&r.status!==BUSY_STATE$1&&r.status!==FINISH_STATE$1?1:0},deflateResetKeep$1=e=>{if(deflateStateCheck$1(e))return err$1(e,Z_STREAM_ERROR$2$1);e.total_in=e.total_out=0,e.data_type=Z_UNKNOWN$2;const r=e.state;return r.pending=0,r.pending_out=0,r.wrap<0&&(r.wrap=-r.wrap),r.status=r.wrap===2?GZIP_STATE$1:r.wrap?INIT_STATE$1:BUSY_STATE$1,e.adler=r.wrap===2?0:1,r.last_flush=-2,_tr_init$2(r),Z_OK$3$1},deflateReset$1=e=>{const r=deflateResetKeep$1(e);return r===Z_OK$3$1&&lm_init$1(e.state),r},deflateSetHeader$1=(e,r)=>deflateStateCheck$1(e)||e.state.wrap!==2?Z_STREAM_ERROR$2$1:(e.state.gzhead=r,Z_OK$3$1),deflateInit2$1=(e,r,t,o,s,d)=>{if(!e)return Z_STREAM_ERROR$2$1;let g=1;if(r===Z_DEFAULT_COMPRESSION$1$1&&(r=6),o<0?(g=0,o=-o):o>15&&(g=2,o-=16),s<1||s>MAX_MEM_LEVEL$1||t!==Z_DEFLATED$2$1||o<8||o>15||r<0||r>9||d<0||d>Z_FIXED$2||o===8&&g!==1)return err$1(e,Z_STREAM_ERROR$2$1);o===8&&(o=9);const a=new DeflateState$1;return e.state=a,a.strm=e,a.status=INIT_STATE$1,a.wrap=g,a.gzhead=null,a.w_bits=o,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+MIN_MATCH$2-1)/MIN_MATCH$2),a.window=new Uint8Array(a.w_size*2),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=a.lit_bufsize*4,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=(a.lit_bufsize-1)*3,a.level=r,a.strategy=d,a.method=t,deflateReset$1(e)},deflateInit$1=(e,r)=>deflateInit2$1(e,r,Z_DEFLATED$2$1,MAX_WBITS$1$1,DEF_MEM_LEVEL$1,Z_DEFAULT_STRATEGY$1$1),deflate$2$1=(e,r)=>{if(deflateStateCheck$1(e)||r>Z_BLOCK$1$1||r<0)return e?err$1(e,Z_STREAM_ERROR$2$1):Z_STREAM_ERROR$2$1;const t=e.state;if(!e.output||e.avail_in!==0&&!e.input||t.status===FINISH_STATE$1&&r!==Z_FINISH$3$1)return err$1(e,e.avail_out===0?Z_BUF_ERROR$1$1:Z_STREAM_ERROR$2$1);const o=t.last_flush;if(t.last_flush=r,t.pending!==0){if(flush_pending$1(e),e.avail_out===0)return t.last_flush=-1,Z_OK$3$1}else if(e.avail_in===0&&rank$1(r)<=rank$1(o)&&r!==Z_FINISH$3$1)return err$1(e,Z_BUF_ERROR$1$1);if(t.status===FINISH_STATE$1&&e.avail_in!==0)return err$1(e,Z_BUF_ERROR$1$1);if(t.status===INIT_STATE$1&&t.wrap===0&&(t.status=BUSY_STATE$1),t.status===INIT_STATE$1){let s=Z_DEFLATED$2$1+(t.w_bits-8<<4)<<8,d=-1;if(t.strategy>=Z_HUFFMAN_ONLY$1||t.level<2?d=0:t.level<6?d=1:t.level===6?d=2:d=3,s|=d<<6,t.strstart!==0&&(s|=PRESET_DICT$1),s+=31-s%31,putShortMSB$1(t,s),t.strstart!==0&&(putShortMSB$1(t,e.adler>>>16),putShortMSB$1(t,e.adler&65535)),e.adler=1,t.status=BUSY_STATE$1,flush_pending$1(e),t.pending!==0)return t.last_flush=-1,Z_OK$3$1}if(t.status===GZIP_STATE$1){if(e.adler=0,put_byte$1(t,31),put_byte$1(t,139),put_byte$1(t,8),t.gzhead)put_byte$1(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),put_byte$1(t,t.gzhead.time&255),put_byte$1(t,t.gzhead.time>>8&255),put_byte$1(t,t.gzhead.time>>16&255),put_byte$1(t,t.gzhead.time>>24&255),put_byte$1(t,t.level===9?2:t.strategy>=Z_HUFFMAN_ONLY$1||t.level<2?4:0),put_byte$1(t,t.gzhead.os&255),t.gzhead.extra&&t.gzhead.extra.length&&(put_byte$1(t,t.gzhead.extra.length&255),put_byte$1(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(e.adler=crc32_1$1(e.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=EXTRA_STATE$1;else if(put_byte$1(t,0),put_byte$1(t,0),put_byte$1(t,0),put_byte$1(t,0),put_byte$1(t,0),put_byte$1(t,t.level===9?2:t.strategy>=Z_HUFFMAN_ONLY$1||t.level<2?4:0),put_byte$1(t,OS_CODE$1),t.status=BUSY_STATE$1,flush_pending$1(e),t.pending!==0)return t.last_flush=-1,Z_OK$3$1}if(t.status===EXTRA_STATE$1){if(t.gzhead.extra){let s=t.pending,d=(t.gzhead.extra.length&65535)-t.gzindex;for(;t.pending+d>t.pending_buf_size;){let a=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+a),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1$1(e.adler,t.pending_buf,t.pending-s,s)),t.gzindex+=a,flush_pending$1(e),t.pending!==0)return t.last_flush=-1,Z_OK$3$1;s=0,d-=a}let g=new Uint8Array(t.gzhead.extra);t.pending_buf.set(g.subarray(t.gzindex,t.gzindex+d),t.pending),t.pending+=d,t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1$1(e.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=NAME_STATE$1}if(t.status===NAME_STATE$1){if(t.gzhead.name){let s=t.pending,d;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1$1(e.adler,t.pending_buf,t.pending-s,s)),flush_pending$1(e),t.pending!==0)return t.last_flush=-1,Z_OK$3$1;s=0}t.gzindex<t.gzhead.name.length?d=t.gzhead.name.charCodeAt(t.gzindex++)&255:d=0,put_byte$1(t,d)}while(d!==0);t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1$1(e.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=COMMENT_STATE$1}if(t.status===COMMENT_STATE$1){if(t.gzhead.comment){let s=t.pending,d;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1$1(e.adler,t.pending_buf,t.pending-s,s)),flush_pending$1(e),t.pending!==0)return t.last_flush=-1,Z_OK$3$1;s=0}t.gzindex<t.gzhead.comment.length?d=t.gzhead.comment.charCodeAt(t.gzindex++)&255:d=0,put_byte$1(t,d)}while(d!==0);t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1$1(e.adler,t.pending_buf,t.pending-s,s))}t.status=HCRC_STATE$1}if(t.status===HCRC_STATE$1){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(flush_pending$1(e),t.pending!==0))return t.last_flush=-1,Z_OK$3$1;put_byte$1(t,e.adler&255),put_byte$1(t,e.adler>>8&255),e.adler=0}if(t.status=BUSY_STATE$1,flush_pending$1(e),t.pending!==0)return t.last_flush=-1,Z_OK$3$1}if(e.avail_in!==0||t.lookahead!==0||r!==Z_NO_FLUSH$2$1&&t.status!==FINISH_STATE$1){let s=t.level===0?deflate_stored$1(t,r):t.strategy===Z_HUFFMAN_ONLY$1?deflate_huff$1(t,r):t.strategy===Z_RLE$1?deflate_rle$1(t,r):configuration_table$1[t.level].func(t,r);if((s===BS_FINISH_STARTED$1||s===BS_FINISH_DONE$1)&&(t.status=FINISH_STATE$1),s===BS_NEED_MORE$1||s===BS_FINISH_STARTED$1)return e.avail_out===0&&(t.last_flush=-1),Z_OK$3$1;if(s===BS_BLOCK_DONE$1&&(r===Z_PARTIAL_FLUSH$1?_tr_align$2(t):r!==Z_BLOCK$1$1&&(_tr_stored_block$2(t,0,0,!1),r===Z_FULL_FLUSH$1$1&&(zero$2(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),flush_pending$1(e),e.avail_out===0))return t.last_flush=-1,Z_OK$3$1}return r!==Z_FINISH$3$1?Z_OK$3$1:t.wrap<=0?Z_STREAM_END$3$1:(t.wrap===2?(put_byte$1(t,e.adler&255),put_byte$1(t,e.adler>>8&255),put_byte$1(t,e.adler>>16&255),put_byte$1(t,e.adler>>24&255),put_byte$1(t,e.total_in&255),put_byte$1(t,e.total_in>>8&255),put_byte$1(t,e.total_in>>16&255),put_byte$1(t,e.total_in>>24&255)):(putShortMSB$1(t,e.adler>>>16),putShortMSB$1(t,e.adler&65535)),flush_pending$1(e),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?Z_OK$3$1:Z_STREAM_END$3$1)},deflateEnd$1=e=>{if(deflateStateCheck$1(e))return Z_STREAM_ERROR$2$1;const r=e.state.status;return e.state=null,r===BUSY_STATE$1?err$1(e,Z_DATA_ERROR$2$1):Z_OK$3$1},deflateSetDictionary$1=(e,r)=>{let t=r.length;if(deflateStateCheck$1(e))return Z_STREAM_ERROR$2$1;const o=e.state,s=o.wrap;if(s===2||s===1&&o.status!==INIT_STATE$1||o.lookahead)return Z_STREAM_ERROR$2$1;if(s===1&&(e.adler=adler32_1$1(e.adler,r,t,0)),o.wrap=0,t>=o.w_size){s===0&&(zero$2(o.head),o.strstart=0,o.block_start=0,o.insert=0);let b=new Uint8Array(o.w_size);b.set(r.subarray(t-o.w_size,t),0),r=b,t=o.w_size}const d=e.avail_in,g=e.next_in,a=e.input;for(e.avail_in=t,e.next_in=0,e.input=r,fill_window$1(o);o.lookahead>=MIN_MATCH$2;){let b=o.strstart,_=o.lookahead-(MIN_MATCH$2-1);do o.ins_h=HASH$1(o,o.ins_h,o.window[b+MIN_MATCH$2-1]),o.prev[b&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=b,b++;while(--_);o.strstart=b,o.lookahead=MIN_MATCH$2-1,fill_window$1(o)}return o.strstart+=o.lookahead,o.block_start=o.strstart,o.insert=o.lookahead,o.lookahead=0,o.match_length=o.prev_length=MIN_MATCH$2-1,o.match_available=0,e.next_in=g,e.input=a,e.avail_in=d,o.wrap=s,Z_OK$3$1};var deflateInit_1$1=deflateInit$1,deflateInit2_1$1=deflateInit2$1,deflateReset_1$1=deflateReset$1,deflateResetKeep_1$1=deflateResetKeep$1,deflateSetHeader_1$1=deflateSetHeader$1,deflate_2$1$1=deflate$2$1,deflateEnd_1$1=deflateEnd$1,deflateSetDictionary_1$1=deflateSetDictionary$1,deflateInfo$1="pako deflate (from Nodeca project)",deflate_1$2$1={deflateInit:deflateInit_1$1,deflateInit2:deflateInit2_1$1,deflateReset:deflateReset_1$1,deflateResetKeep:deflateResetKeep_1$1,deflateSetHeader:deflateSetHeader_1$1,deflate:deflate_2$1$1,deflateEnd:deflateEnd_1$1,deflateSetDictionary:deflateSetDictionary_1$1,deflateInfo:deflateInfo$1};const _has$1=(e,r)=>Object.prototype.hasOwnProperty.call(e,r);var assign$1=function(e){const r=Array.prototype.slice.call(arguments,1);for(;r.length;){const t=r.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const o in t)_has$1(t,o)&&(e[o]=t[o])}}return e},flattenChunks$1=e=>{let r=0;for(let o=0,s=e.length;o<s;o++)r+=e[o].length;const t=new Uint8Array(r);for(let o=0,s=0,d=e.length;o<d;o++){let g=e[o];t.set(g,s),s+=g.length}return t},common$1={assign:assign$1,flattenChunks:flattenChunks$1};let STR_APPLY_UIA_OK$1=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{STR_APPLY_UIA_OK$1=!1}const _utf8len$1=new Uint8Array(256);for(let e=0;e<256;e++)_utf8len$1[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;_utf8len$1[254]=_utf8len$1[254]=1;var string2buf$1=e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let r,t,o,s,d,g=e.length,a=0;for(s=0;s<g;s++)t=e.charCodeAt(s),(t&64512)===55296&&s+1<g&&(o=e.charCodeAt(s+1),(o&64512)===56320&&(t=65536+(t-55296<<10)+(o-56320),s++)),a+=t<128?1:t<2048?2:t<65536?3:4;for(r=new Uint8Array(a),d=0,s=0;d<a;s++)t=e.charCodeAt(s),(t&64512)===55296&&s+1<g&&(o=e.charCodeAt(s+1),(o&64512)===56320&&(t=65536+(t-55296<<10)+(o-56320),s++)),t<128?r[d++]=t:t<2048?(r[d++]=192|t>>>6,r[d++]=128|t&63):t<65536?(r[d++]=224|t>>>12,r[d++]=128|t>>>6&63,r[d++]=128|t&63):(r[d++]=240|t>>>18,r[d++]=128|t>>>12&63,r[d++]=128|t>>>6&63,r[d++]=128|t&63);return r};const buf2binstring$1=(e,r)=>{if(r<65534&&e.subarray&&STR_APPLY_UIA_OK$1)return String.fromCharCode.apply(null,e.length===r?e:e.subarray(0,r));let t="";for(let o=0;o<r;o++)t+=String.fromCharCode(e[o]);return t};var buf2string$1=(e,r)=>{const t=r||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,r));let o,s;const d=new Array(t*2);for(s=0,o=0;o<t;){let g=e[o++];if(g<128){d[s++]=g;continue}let a=_utf8len$1[g];if(a>4){d[s++]=65533,o+=a-1;continue}for(g&=a===2?31:a===3?15:7;a>1&&o<t;)g=g<<6|e[o++]&63,a--;if(a>1){d[s++]=65533;continue}g<65536?d[s++]=g:(g-=65536,d[s++]=55296|g>>10&1023,d[s++]=56320|g&1023)}return buf2binstring$1(d,s)},utf8border$1=(e,r)=>{r=r||e.length,r>e.length&&(r=e.length);let t=r-1;for(;t>=0&&(e[t]&192)===128;)t--;return t<0||t===0?r:t+_utf8len$1[e[t]]>r?t:r},strings$1={string2buf:string2buf$1,buf2string:buf2string$1,utf8border:utf8border$1};function ZStream$1(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var zstream$1=ZStream$1;const toString$1$2=Object.prototype.toString,{Z_NO_FLUSH:Z_NO_FLUSH$1$1,Z_SYNC_FLUSH:Z_SYNC_FLUSH$1,Z_FULL_FLUSH:Z_FULL_FLUSH$2,Z_FINISH:Z_FINISH$2$1,Z_OK:Z_OK$2$1,Z_STREAM_END:Z_STREAM_END$2$1,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$2,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY$2,Z_DEFLATED:Z_DEFLATED$1$1}=constants$2$2;function Deflate$1$1(e){this.options=common$1.assign({level:Z_DEFAULT_COMPRESSION$2,method:Z_DEFLATED$1$1,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY$2},e||{});let r=this.options;r.raw&&r.windowBits>0?r.windowBits=-r.windowBits:r.gzip&&r.windowBits>0&&r.windowBits<16&&(r.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream$1,this.strm.avail_out=0;let t=deflate_1$2$1.deflateInit2(this.strm,r.level,r.method,r.windowBits,r.memLevel,r.strategy);if(t!==Z_OK$2$1)throw new Error(messages$1[t]);if(r.header&&deflate_1$2$1.deflateSetHeader(this.strm,r.header),r.dictionary){let o;if(typeof r.dictionary=="string"?o=strings$1.string2buf(r.dictionary):toString$1$2.call(r.dictionary)==="[object ArrayBuffer]"?o=new Uint8Array(r.dictionary):o=r.dictionary,t=deflate_1$2$1.deflateSetDictionary(this.strm,o),t!==Z_OK$2$1)throw new Error(messages$1[t]);this._dict_set=!0}}Deflate$1$1.prototype.push=function(e,r){const t=this.strm,o=this.options.chunkSize;let s,d;if(this.ended)return!1;for(r===~~r?d=r:d=r===!0?Z_FINISH$2$1:Z_NO_FLUSH$1$1,typeof e=="string"?t.input=strings$1.string2buf(e):toString$1$2.call(e)==="[object ArrayBuffer]"?t.input=new Uint8Array(e):t.input=e,t.next_in=0,t.avail_in=t.input.length;;){if(t.avail_out===0&&(t.output=new Uint8Array(o),t.next_out=0,t.avail_out=o),(d===Z_SYNC_FLUSH$1||d===Z_FULL_FLUSH$2)&&t.avail_out<=6){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(s=deflate_1$2$1.deflate(t,d),s===Z_STREAM_END$2$1)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),s=deflate_1$2$1.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===Z_OK$2$1;if(t.avail_out===0){this.onData(t.output);continue}if(d>0&&t.next_out>0){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(t.avail_in===0)break}return!0};Deflate$1$1.prototype.onData=function(e){this.chunks.push(e)};Deflate$1$1.prototype.onEnd=function(e){e===Z_OK$2$1&&(this.result=common$1.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function deflate$1(e,r){const t=new Deflate$1$1(r);if(t.push(e,!0),t.err)throw t.msg||messages$1[t.err];return t.result}function deflateRaw$1(e,r){return r=r||{},r.raw=!0,deflate$1(e,r)}function gzip$1(e,r){return r=r||{},r.gzip=!0,deflate$1(e,r)}var Deflate_1$1=Deflate$1$1,deflate_2=deflate$1,deflateRaw_1$1=deflateRaw$1,gzip_1$1=gzip$1,constants$1$1=constants$2$2,deflate_1$1={Deflate:Deflate_1$1,deflate:deflate_2,deflateRaw:deflateRaw_1$1,gzip:gzip_1$1,constants:constants$1$1};const BAD$1$1=16209,TYPE$1$1=16191;var inffast$1=function(r,t){let o,s,d,g,a,b,_,T,C,D,k,O,U,G,j,te,H,Z,W,_e,fe,re,ae,J;const se=r.state;o=r.next_in,ae=r.input,s=o+(r.avail_in-5),d=r.next_out,J=r.output,g=d-(t-r.avail_out),a=d+(r.avail_out-257),b=se.dmax,_=se.wsize,T=se.whave,C=se.wnext,D=se.window,k=se.hold,O=se.bits,U=se.lencode,G=se.distcode,j=(1<<se.lenbits)-1,te=(1<<se.distbits)-1;e:do{O<15&&(k+=ae[o++]<<O,O+=8,k+=ae[o++]<<O,O+=8),H=U[k&j];t:for(;;){if(Z=H>>>24,k>>>=Z,O-=Z,Z=H>>>16&255,Z===0)J[d++]=H&65535;else if(Z&16){W=H&65535,Z&=15,Z&&(O<Z&&(k+=ae[o++]<<O,O+=8),W+=k&(1<<Z)-1,k>>>=Z,O-=Z),O<15&&(k+=ae[o++]<<O,O+=8,k+=ae[o++]<<O,O+=8),H=G[k&te];i:for(;;){if(Z=H>>>24,k>>>=Z,O-=Z,Z=H>>>16&255,Z&16){if(_e=H&65535,Z&=15,O<Z&&(k+=ae[o++]<<O,O+=8,O<Z&&(k+=ae[o++]<<O,O+=8)),_e+=k&(1<<Z)-1,_e>b){r.msg="invalid distance too far back",se.mode=BAD$1$1;break e}if(k>>>=Z,O-=Z,Z=d-g,_e>Z){if(Z=_e-Z,Z>T&&se.sane){r.msg="invalid distance too far back",se.mode=BAD$1$1;break e}if(fe=0,re=D,C===0){if(fe+=_-Z,Z<W){W-=Z;do J[d++]=D[fe++];while(--Z);fe=d-_e,re=J}}else if(C<Z){if(fe+=_+C-Z,Z-=C,Z<W){W-=Z;do J[d++]=D[fe++];while(--Z);if(fe=0,C<W){Z=C,W-=Z;do J[d++]=D[fe++];while(--Z);fe=d-_e,re=J}}}else if(fe+=C-Z,Z<W){W-=Z;do J[d++]=D[fe++];while(--Z);fe=d-_e,re=J}for(;W>2;)J[d++]=re[fe++],J[d++]=re[fe++],J[d++]=re[fe++],W-=3;W&&(J[d++]=re[fe++],W>1&&(J[d++]=re[fe++]))}else{fe=d-_e;do J[d++]=J[fe++],J[d++]=J[fe++],J[d++]=J[fe++],W-=3;while(W>2);W&&(J[d++]=J[fe++],W>1&&(J[d++]=J[fe++]))}}else if(Z&64){r.msg="invalid distance code",se.mode=BAD$1$1;break e}else{H=G[(H&65535)+(k&(1<<Z)-1)];continue i}break}}else if(Z&64)if(Z&32){se.mode=TYPE$1$1;break e}else{r.msg="invalid literal/length code",se.mode=BAD$1$1;break e}else{H=U[(H&65535)+(k&(1<<Z)-1)];continue t}break}}while(o<s&&d<a);W=O>>3,o-=W,O-=W<<3,k&=(1<<O)-1,r.next_in=o,r.next_out=d,r.avail_in=o<s?5+(s-o):5-(o-s),r.avail_out=d<a?257+(a-d):257-(d-a),se.hold=k,se.bits=O};const MAXBITS$1=15,ENOUGH_LENS$1$1=852,ENOUGH_DISTS$1$1=592,CODES$1$1=0,LENS$1$1=1,DISTS$1$1=2,lbase$1=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),lext$1=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),dbase$1=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),dext$1=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),inflate_table$1=(e,r,t,o,s,d,g,a)=>{const b=a.bits;let _=0,T=0,C=0,D=0,k=0,O=0,U=0,G=0,j=0,te=0,H,Z,W,_e,fe,re=null,ae;const J=new Uint16Array(MAXBITS$1+1),se=new Uint16Array(MAXBITS$1+1);let Me=null,Ie,We,Ge;for(_=0;_<=MAXBITS$1;_++)J[_]=0;for(T=0;T<o;T++)J[r[t+T]]++;for(k=b,D=MAXBITS$1;D>=1&&J[D]===0;D--);if(k>D&&(k=D),D===0)return s[d++]=1<<24|64<<16|0,s[d++]=1<<24|64<<16|0,a.bits=1,0;for(C=1;C<D&&J[C]===0;C++);for(k<C&&(k=C),G=1,_=1;_<=MAXBITS$1;_++)if(G<<=1,G-=J[_],G<0)return-1;if(G>0&&(e===CODES$1$1||D!==1))return-1;for(se[1]=0,_=1;_<MAXBITS$1;_++)se[_+1]=se[_]+J[_];for(T=0;T<o;T++)r[t+T]!==0&&(g[se[r[t+T]]++]=T);if(e===CODES$1$1?(re=Me=g,ae=20):e===LENS$1$1?(re=lbase$1,Me=lext$1,ae=257):(re=dbase$1,Me=dext$1,ae=0),te=0,T=0,_=C,fe=d,O=k,U=0,W=-1,j=1<<k,_e=j-1,e===LENS$1$1&&j>ENOUGH_LENS$1$1||e===DISTS$1$1&&j>ENOUGH_DISTS$1$1)return 1;for(;;){Ie=_-U,g[T]+1<ae?(We=0,Ge=g[T]):g[T]>=ae?(We=Me[g[T]-ae],Ge=re[g[T]-ae]):(We=32+64,Ge=0),H=1<<_-U,Z=1<<O,C=Z;do Z-=H,s[fe+(te>>U)+Z]=Ie<<24|We<<16|Ge|0;while(Z!==0);for(H=1<<_-1;te&H;)H>>=1;if(H!==0?(te&=H-1,te+=H):te=0,T++,--J[_]===0){if(_===D)break;_=r[t+g[T]]}if(_>k&&(te&_e)!==W){for(U===0&&(U=k),fe+=C,O=_-U,G=1<<O;O+U<D&&(G-=J[O+U],!(G<=0));)O++,G<<=1;if(j+=1<<O,e===LENS$1$1&&j>ENOUGH_LENS$1$1||e===DISTS$1$1&&j>ENOUGH_DISTS$1$1)return 1;W=te&_e,s[W]=k<<24|O<<16|fe-d|0}}return te!==0&&(s[fe+te]=_-U<<24|64<<16|0),a.bits=k,0};var inftrees$1=inflate_table$1;const CODES$2=0,LENS$2=1,DISTS$2=2,{Z_FINISH:Z_FINISH$1$1,Z_BLOCK:Z_BLOCK$2,Z_TREES:Z_TREES$1,Z_OK:Z_OK$1$1,Z_STREAM_END:Z_STREAM_END$1$1,Z_NEED_DICT:Z_NEED_DICT$1$1,Z_STREAM_ERROR:Z_STREAM_ERROR$1$1,Z_DATA_ERROR:Z_DATA_ERROR$1$1,Z_MEM_ERROR:Z_MEM_ERROR$1$1,Z_BUF_ERROR:Z_BUF_ERROR$2,Z_DEFLATED:Z_DEFLATED$3}=constants$2$2,HEAD$1=16180,FLAGS$1=16181,TIME$1=16182,OS$1=16183,EXLEN$1=16184,EXTRA$1=16185,NAME$1=16186,COMMENT$1=16187,HCRC$1=16188,DICTID$1=16189,DICT$1=16190,TYPE$2=16191,TYPEDO$1=16192,STORED$1=16193,COPY_$1=16194,COPY$1=16195,TABLE$1=16196,LENLENS$1=16197,CODELENS$1=16198,LEN_$1=16199,LEN$1=16200,LENEXT$1=16201,DIST$1=16202,DISTEXT$1=16203,MATCH$1=16204,LIT$1=16205,CHECK$1=16206,LENGTH$1=16207,DONE$1=16208,BAD$2=16209,MEM$1=16210,SYNC$1=16211,ENOUGH_LENS$2=852,ENOUGH_DISTS$2=592,MAX_WBITS$2=15,DEF_WBITS$1=MAX_WBITS$2,zswap32$1=e=>(e>>>24&255)+(e>>>8&65280)+((e&65280)<<8)+((e&255)<<24);function InflateState$1(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const inflateStateCheck$1=e=>{if(!e)return 1;const r=e.state;return!r||r.strm!==e||r.mode<HEAD$1||r.mode>SYNC$1?1:0},inflateResetKeep$1=e=>{if(inflateStateCheck$1(e))return Z_STREAM_ERROR$1$1;const r=e.state;return e.total_in=e.total_out=r.total=0,e.msg="",r.wrap&&(e.adler=r.wrap&1),r.mode=HEAD$1,r.last=0,r.havedict=0,r.flags=-1,r.dmax=32768,r.head=null,r.hold=0,r.bits=0,r.lencode=r.lendyn=new Int32Array(ENOUGH_LENS$2),r.distcode=r.distdyn=new Int32Array(ENOUGH_DISTS$2),r.sane=1,r.back=-1,Z_OK$1$1},inflateReset$1=e=>{if(inflateStateCheck$1(e))return Z_STREAM_ERROR$1$1;const r=e.state;return r.wsize=0,r.whave=0,r.wnext=0,inflateResetKeep$1(e)},inflateReset2$1=(e,r)=>{let t;if(inflateStateCheck$1(e))return Z_STREAM_ERROR$1$1;const o=e.state;return r<0?(t=0,r=-r):(t=(r>>4)+5,r<48&&(r&=15)),r&&(r<8||r>15)?Z_STREAM_ERROR$1$1:(o.window!==null&&o.wbits!==r&&(o.window=null),o.wrap=t,o.wbits=r,inflateReset$1(e))},inflateInit2$1=(e,r)=>{if(!e)return Z_STREAM_ERROR$1$1;const t=new InflateState$1;e.state=t,t.strm=e,t.window=null,t.mode=HEAD$1;const o=inflateReset2$1(e,r);return o!==Z_OK$1$1&&(e.state=null),o},inflateInit$1=e=>inflateInit2$1(e,DEF_WBITS$1);let virgin$1=!0,lenfix$1,distfix$1;const fixedtables$1=e=>{if(virgin$1){lenfix$1=new Int32Array(512),distfix$1=new Int32Array(32);let r=0;for(;r<144;)e.lens[r++]=8;for(;r<256;)e.lens[r++]=9;for(;r<280;)e.lens[r++]=7;for(;r<288;)e.lens[r++]=8;for(inftrees$1(LENS$2,e.lens,0,288,lenfix$1,0,e.work,{bits:9}),r=0;r<32;)e.lens[r++]=5;inftrees$1(DISTS$2,e.lens,0,32,distfix$1,0,e.work,{bits:5}),virgin$1=!1}e.lencode=lenfix$1,e.lenbits=9,e.distcode=distfix$1,e.distbits=5},updatewindow$1=(e,r,t,o)=>{let s;const d=e.state;return d.window===null&&(d.wsize=1<<d.wbits,d.wnext=0,d.whave=0,d.window=new Uint8Array(d.wsize)),o>=d.wsize?(d.window.set(r.subarray(t-d.wsize,t),0),d.wnext=0,d.whave=d.wsize):(s=d.wsize-d.wnext,s>o&&(s=o),d.window.set(r.subarray(t-o,t-o+s),d.wnext),o-=s,o?(d.window.set(r.subarray(t-o,t),0),d.wnext=o,d.whave=d.wsize):(d.wnext+=s,d.wnext===d.wsize&&(d.wnext=0),d.whave<d.wsize&&(d.whave+=s))),0},inflate$2$1=(e,r)=>{let t,o,s,d,g,a,b,_,T,C,D,k,O,U,G=0,j,te,H,Z,W,_e,fe,re;const ae=new Uint8Array(4);let J,se;const Me=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(inflateStateCheck$1(e)||!e.output||!e.input&&e.avail_in!==0)return Z_STREAM_ERROR$1$1;t=e.state,t.mode===TYPE$2&&(t.mode=TYPEDO$1),g=e.next_out,s=e.output,b=e.avail_out,d=e.next_in,o=e.input,a=e.avail_in,_=t.hold,T=t.bits,C=a,D=b,re=Z_OK$1$1;e:for(;;)switch(t.mode){case HEAD$1:if(t.wrap===0){t.mode=TYPEDO$1;break}for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.wrap&2&&_===35615){t.wbits===0&&(t.wbits=15),t.check=0,ae[0]=_&255,ae[1]=_>>>8&255,t.check=crc32_1$1(t.check,ae,2,0),_=0,T=0,t.mode=FLAGS$1;break}if(t.head&&(t.head.done=!1),!(t.wrap&1)||(((_&255)<<8)+(_>>8))%31){e.msg="incorrect header check",t.mode=BAD$2;break}if((_&15)!==Z_DEFLATED$3){e.msg="unknown compression method",t.mode=BAD$2;break}if(_>>>=4,T-=4,fe=(_&15)+8,t.wbits===0&&(t.wbits=fe),fe>15||fe>t.wbits){e.msg="invalid window size",t.mode=BAD$2;break}t.dmax=1<<t.wbits,t.flags=0,e.adler=t.check=1,t.mode=_&512?DICTID$1:TYPE$2,_=0,T=0;break;case FLAGS$1:for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.flags=_,(t.flags&255)!==Z_DEFLATED$3){e.msg="unknown compression method",t.mode=BAD$2;break}if(t.flags&57344){e.msg="unknown header flags set",t.mode=BAD$2;break}t.head&&(t.head.text=_>>8&1),t.flags&512&&t.wrap&4&&(ae[0]=_&255,ae[1]=_>>>8&255,t.check=crc32_1$1(t.check,ae,2,0)),_=0,T=0,t.mode=TIME$1;case TIME$1:for(;T<32;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.head&&(t.head.time=_),t.flags&512&&t.wrap&4&&(ae[0]=_&255,ae[1]=_>>>8&255,ae[2]=_>>>16&255,ae[3]=_>>>24&255,t.check=crc32_1$1(t.check,ae,4,0)),_=0,T=0,t.mode=OS$1;case OS$1:for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.head&&(t.head.xflags=_&255,t.head.os=_>>8),t.flags&512&&t.wrap&4&&(ae[0]=_&255,ae[1]=_>>>8&255,t.check=crc32_1$1(t.check,ae,2,0)),_=0,T=0,t.mode=EXLEN$1;case EXLEN$1:if(t.flags&1024){for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.length=_,t.head&&(t.head.extra_len=_),t.flags&512&&t.wrap&4&&(ae[0]=_&255,ae[1]=_>>>8&255,t.check=crc32_1$1(t.check,ae,2,0)),_=0,T=0}else t.head&&(t.head.extra=null);t.mode=EXTRA$1;case EXTRA$1:if(t.flags&1024&&(k=t.length,k>a&&(k=a),k&&(t.head&&(fe=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(o.subarray(d,d+k),fe)),t.flags&512&&t.wrap&4&&(t.check=crc32_1$1(t.check,o,k,d)),a-=k,d+=k,t.length-=k),t.length))break e;t.length=0,t.mode=NAME$1;case NAME$1:if(t.flags&2048){if(a===0)break e;k=0;do fe=o[d+k++],t.head&&fe&&t.length<65536&&(t.head.name+=String.fromCharCode(fe));while(fe&&k<a);if(t.flags&512&&t.wrap&4&&(t.check=crc32_1$1(t.check,o,k,d)),a-=k,d+=k,fe)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=COMMENT$1;case COMMENT$1:if(t.flags&4096){if(a===0)break e;k=0;do fe=o[d+k++],t.head&&fe&&t.length<65536&&(t.head.comment+=String.fromCharCode(fe));while(fe&&k<a);if(t.flags&512&&t.wrap&4&&(t.check=crc32_1$1(t.check,o,k,d)),a-=k,d+=k,fe)break e}else t.head&&(t.head.comment=null);t.mode=HCRC$1;case HCRC$1:if(t.flags&512){for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.wrap&4&&_!==(t.check&65535)){e.msg="header crc mismatch",t.mode=BAD$2;break}_=0,T=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),e.adler=t.check=0,t.mode=TYPE$2;break;case DICTID$1:for(;T<32;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}e.adler=t.check=zswap32$1(_),_=0,T=0,t.mode=DICT$1;case DICT$1:if(t.havedict===0)return e.next_out=g,e.avail_out=b,e.next_in=d,e.avail_in=a,t.hold=_,t.bits=T,Z_NEED_DICT$1$1;e.adler=t.check=1,t.mode=TYPE$2;case TYPE$2:if(r===Z_BLOCK$2||r===Z_TREES$1)break e;case TYPEDO$1:if(t.last){_>>>=T&7,T-=T&7,t.mode=CHECK$1;break}for(;T<3;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}switch(t.last=_&1,_>>>=1,T-=1,_&3){case 0:t.mode=STORED$1;break;case 1:if(fixedtables$1(t),t.mode=LEN_$1,r===Z_TREES$1){_>>>=2,T-=2;break e}break;case 2:t.mode=TABLE$1;break;case 3:e.msg="invalid block type",t.mode=BAD$2}_>>>=2,T-=2;break;case STORED$1:for(_>>>=T&7,T-=T&7;T<32;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if((_&65535)!==(_>>>16^65535)){e.msg="invalid stored block lengths",t.mode=BAD$2;break}if(t.length=_&65535,_=0,T=0,t.mode=COPY_$1,r===Z_TREES$1)break e;case COPY_$1:t.mode=COPY$1;case COPY$1:if(k=t.length,k){if(k>a&&(k=a),k>b&&(k=b),k===0)break e;s.set(o.subarray(d,d+k),g),a-=k,d+=k,b-=k,g+=k,t.length-=k;break}t.mode=TYPE$2;break;case TABLE$1:for(;T<14;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.nlen=(_&31)+257,_>>>=5,T-=5,t.ndist=(_&31)+1,_>>>=5,T-=5,t.ncode=(_&15)+4,_>>>=4,T-=4,t.nlen>286||t.ndist>30){e.msg="too many length or distance symbols",t.mode=BAD$2;break}t.have=0,t.mode=LENLENS$1;case LENLENS$1:for(;t.have<t.ncode;){for(;T<3;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.lens[Me[t.have++]]=_&7,_>>>=3,T-=3}for(;t.have<19;)t.lens[Me[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,J={bits:t.lenbits},re=inftrees$1(CODES$2,t.lens,0,19,t.lencode,0,t.work,J),t.lenbits=J.bits,re){e.msg="invalid code lengths set",t.mode=BAD$2;break}t.have=0,t.mode=CODELENS$1;case CODELENS$1:for(;t.have<t.nlen+t.ndist;){for(;G=t.lencode[_&(1<<t.lenbits)-1],j=G>>>24,te=G>>>16&255,H=G&65535,!(j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(H<16)_>>>=j,T-=j,t.lens[t.have++]=H;else{if(H===16){for(se=j+2;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(_>>>=j,T-=j,t.have===0){e.msg="invalid bit length repeat",t.mode=BAD$2;break}fe=t.lens[t.have-1],k=3+(_&3),_>>>=2,T-=2}else if(H===17){for(se=j+3;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}_>>>=j,T-=j,fe=0,k=3+(_&7),_>>>=3,T-=3}else{for(se=j+7;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}_>>>=j,T-=j,fe=0,k=11+(_&127),_>>>=7,T-=7}if(t.have+k>t.nlen+t.ndist){e.msg="invalid bit length repeat",t.mode=BAD$2;break}for(;k--;)t.lens[t.have++]=fe}}if(t.mode===BAD$2)break;if(t.lens[256]===0){e.msg="invalid code -- missing end-of-block",t.mode=BAD$2;break}if(t.lenbits=9,J={bits:t.lenbits},re=inftrees$1(LENS$2,t.lens,0,t.nlen,t.lencode,0,t.work,J),t.lenbits=J.bits,re){e.msg="invalid literal/lengths set",t.mode=BAD$2;break}if(t.distbits=6,t.distcode=t.distdyn,J={bits:t.distbits},re=inftrees$1(DISTS$2,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,J),t.distbits=J.bits,re){e.msg="invalid distances set",t.mode=BAD$2;break}if(t.mode=LEN_$1,r===Z_TREES$1)break e;case LEN_$1:t.mode=LEN$1;case LEN$1:if(a>=6&&b>=258){e.next_out=g,e.avail_out=b,e.next_in=d,e.avail_in=a,t.hold=_,t.bits=T,inffast$1(e,D),g=e.next_out,s=e.output,b=e.avail_out,d=e.next_in,o=e.input,a=e.avail_in,_=t.hold,T=t.bits,t.mode===TYPE$2&&(t.back=-1);break}for(t.back=0;G=t.lencode[_&(1<<t.lenbits)-1],j=G>>>24,te=G>>>16&255,H=G&65535,!(j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(te&&!(te&240)){for(Z=j,W=te,_e=H;G=t.lencode[_e+((_&(1<<Z+W)-1)>>Z)],j=G>>>24,te=G>>>16&255,H=G&65535,!(Z+j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}_>>>=Z,T-=Z,t.back+=Z}if(_>>>=j,T-=j,t.back+=j,t.length=H,te===0){t.mode=LIT$1;break}if(te&32){t.back=-1,t.mode=TYPE$2;break}if(te&64){e.msg="invalid literal/length code",t.mode=BAD$2;break}t.extra=te&15,t.mode=LENEXT$1;case LENEXT$1:if(t.extra){for(se=t.extra;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.length+=_&(1<<t.extra)-1,_>>>=t.extra,T-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=DIST$1;case DIST$1:for(;G=t.distcode[_&(1<<t.distbits)-1],j=G>>>24,te=G>>>16&255,H=G&65535,!(j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(!(te&240)){for(Z=j,W=te,_e=H;G=t.distcode[_e+((_&(1<<Z+W)-1)>>Z)],j=G>>>24,te=G>>>16&255,H=G&65535,!(Z+j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}_>>>=Z,T-=Z,t.back+=Z}if(_>>>=j,T-=j,t.back+=j,te&64){e.msg="invalid distance code",t.mode=BAD$2;break}t.offset=H,t.extra=te&15,t.mode=DISTEXT$1;case DISTEXT$1:if(t.extra){for(se=t.extra;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.offset+=_&(1<<t.extra)-1,_>>>=t.extra,T-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){e.msg="invalid distance too far back",t.mode=BAD$2;break}t.mode=MATCH$1;case MATCH$1:if(b===0)break e;if(k=D-b,t.offset>k){if(k=t.offset-k,k>t.whave&&t.sane){e.msg="invalid distance too far back",t.mode=BAD$2;break}k>t.wnext?(k-=t.wnext,O=t.wsize-k):O=t.wnext-k,k>t.length&&(k=t.length),U=t.window}else U=s,O=g-t.offset,k=t.length;k>b&&(k=b),b-=k,t.length-=k;do s[g++]=U[O++];while(--k);t.length===0&&(t.mode=LEN$1);break;case LIT$1:if(b===0)break e;s[g++]=t.length,b--,t.mode=LEN$1;break;case CHECK$1:if(t.wrap){for(;T<32;){if(a===0)break e;a--,_|=o[d++]<<T,T+=8}if(D-=b,e.total_out+=D,t.total+=D,t.wrap&4&&D&&(e.adler=t.check=t.flags?crc32_1$1(t.check,s,D,g-D):adler32_1$1(t.check,s,D,g-D)),D=b,t.wrap&4&&(t.flags?_:zswap32$1(_))!==t.check){e.msg="incorrect data check",t.mode=BAD$2;break}_=0,T=0}t.mode=LENGTH$1;case LENGTH$1:if(t.wrap&&t.flags){for(;T<32;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.wrap&4&&_!==(t.total&4294967295)){e.msg="incorrect length check",t.mode=BAD$2;break}_=0,T=0}t.mode=DONE$1;case DONE$1:re=Z_STREAM_END$1$1;break e;case BAD$2:re=Z_DATA_ERROR$1$1;break e;case MEM$1:return Z_MEM_ERROR$1$1;case SYNC$1:default:return Z_STREAM_ERROR$1$1}return e.next_out=g,e.avail_out=b,e.next_in=d,e.avail_in=a,t.hold=_,t.bits=T,(t.wsize||D!==e.avail_out&&t.mode<BAD$2&&(t.mode<CHECK$1||r!==Z_FINISH$1$1))&&updatewindow$1(e,e.output,e.next_out,D-e.avail_out),C-=e.avail_in,D-=e.avail_out,e.total_in+=C,e.total_out+=D,t.total+=D,t.wrap&4&&D&&(e.adler=t.check=t.flags?crc32_1$1(t.check,s,D,e.next_out-D):adler32_1$1(t.check,s,D,e.next_out-D)),e.data_type=t.bits+(t.last?64:0)+(t.mode===TYPE$2?128:0)+(t.mode===LEN_$1||t.mode===COPY_$1?256:0),(C===0&&D===0||r===Z_FINISH$1$1)&&re===Z_OK$1$1&&(re=Z_BUF_ERROR$2),re},inflateEnd$1=e=>{if(inflateStateCheck$1(e))return Z_STREAM_ERROR$1$1;let r=e.state;return r.window&&(r.window=null),e.state=null,Z_OK$1$1},inflateGetHeader$1=(e,r)=>{if(inflateStateCheck$1(e))return Z_STREAM_ERROR$1$1;const t=e.state;return t.wrap&2?(t.head=r,r.done=!1,Z_OK$1$1):Z_STREAM_ERROR$1$1},inflateSetDictionary$1=(e,r)=>{const t=r.length;let o,s,d;return inflateStateCheck$1(e)||(o=e.state,o.wrap!==0&&o.mode!==DICT$1)?Z_STREAM_ERROR$1$1:o.mode===DICT$1&&(s=1,s=adler32_1$1(s,r,t,0),s!==o.check)?Z_DATA_ERROR$1$1:(d=updatewindow$1(e,r,t,t),d?(o.mode=MEM$1,Z_MEM_ERROR$1$1):(o.havedict=1,Z_OK$1$1))};var inflateReset_1$1=inflateReset$1,inflateReset2_1$1=inflateReset2$1,inflateResetKeep_1$1=inflateResetKeep$1,inflateInit_1$1=inflateInit$1,inflateInit2_1$1=inflateInit2$1,inflate_2$1$1=inflate$2$1,inflateEnd_1$1=inflateEnd$1,inflateGetHeader_1$1=inflateGetHeader$1,inflateSetDictionary_1$1=inflateSetDictionary$1,inflateInfo$1="pako inflate (from Nodeca project)",inflate_1$2$1={inflateReset:inflateReset_1$1,inflateReset2:inflateReset2_1$1,inflateResetKeep:inflateResetKeep_1$1,inflateInit:inflateInit_1$1,inflateInit2:inflateInit2_1$1,inflate:inflate_2$1$1,inflateEnd:inflateEnd_1$1,inflateGetHeader:inflateGetHeader_1$1,inflateSetDictionary:inflateSetDictionary_1$1,inflateInfo:inflateInfo$1};function GZheader$1(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var gzheader$1=GZheader$1;const toString$4=Object.prototype.toString,{Z_NO_FLUSH:Z_NO_FLUSH$3,Z_FINISH:Z_FINISH$4,Z_OK:Z_OK$4,Z_STREAM_END:Z_STREAM_END$4,Z_NEED_DICT:Z_NEED_DICT$2,Z_STREAM_ERROR:Z_STREAM_ERROR$3,Z_DATA_ERROR:Z_DATA_ERROR$3,Z_MEM_ERROR:Z_MEM_ERROR$2}=constants$2$2;function Inflate$1$1(e){this.options=common$1.assign({chunkSize:1024*64,windowBits:15,to:""},e||{});const r=this.options;r.raw&&r.windowBits>=0&&r.windowBits<16&&(r.windowBits=-r.windowBits,r.windowBits===0&&(r.windowBits=-15)),r.windowBits>=0&&r.windowBits<16&&!(e&&e.windowBits)&&(r.windowBits+=32),r.windowBits>15&&r.windowBits<48&&(r.windowBits&15||(r.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream$1,this.strm.avail_out=0;let t=inflate_1$2$1.inflateInit2(this.strm,r.windowBits);if(t!==Z_OK$4)throw new Error(messages$1[t]);if(this.header=new gzheader$1,inflate_1$2$1.inflateGetHeader(this.strm,this.header),r.dictionary&&(typeof r.dictionary=="string"?r.dictionary=strings$1.string2buf(r.dictionary):toString$4.call(r.dictionary)==="[object ArrayBuffer]"&&(r.dictionary=new Uint8Array(r.dictionary)),r.raw&&(t=inflate_1$2$1.inflateSetDictionary(this.strm,r.dictionary),t!==Z_OK$4)))throw new Error(messages$1[t])}Inflate$1$1.prototype.push=function(e,r){const t=this.strm,o=this.options.chunkSize,s=this.options.dictionary;let d,g,a;if(this.ended)return!1;for(r===~~r?g=r:g=r===!0?Z_FINISH$4:Z_NO_FLUSH$3,toString$4.call(e)==="[object ArrayBuffer]"?t.input=new Uint8Array(e):t.input=e,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(o),t.next_out=0,t.avail_out=o),d=inflate_1$2$1.inflate(t,g),d===Z_NEED_DICT$2&&s&&(d=inflate_1$2$1.inflateSetDictionary(t,s),d===Z_OK$4?d=inflate_1$2$1.inflate(t,g):d===Z_DATA_ERROR$3&&(d=Z_NEED_DICT$2));t.avail_in>0&&d===Z_STREAM_END$4&&t.state.wrap>0&&e[t.next_in]!==0;)inflate_1$2$1.inflateReset(t),d=inflate_1$2$1.inflate(t,g);switch(d){case Z_STREAM_ERROR$3:case Z_DATA_ERROR$3:case Z_NEED_DICT$2:case Z_MEM_ERROR$2:return this.onEnd(d),this.ended=!0,!1}if(a=t.avail_out,t.next_out&&(t.avail_out===0||d===Z_STREAM_END$4))if(this.options.to==="string"){let b=strings$1.utf8border(t.output,t.next_out),_=t.next_out-b,T=strings$1.buf2string(t.output,b);t.next_out=_,t.avail_out=o-_,_&&t.output.set(t.output.subarray(b,b+_),0),this.onData(T)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(d===Z_OK$4&&a===0)){if(d===Z_STREAM_END$4)return d=inflate_1$2$1.inflateEnd(this.strm),this.onEnd(d),this.ended=!0,!0;if(t.avail_in===0)break}}return!0};Inflate$1$1.prototype.onData=function(e){this.chunks.push(e)};Inflate$1$1.prototype.onEnd=function(e){e===Z_OK$4&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=common$1.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function inflate$1$1(e,r){const t=new Inflate$1$1(r);if(t.push(e),t.err)throw t.msg||messages$1[t.err];return t.result}function inflateRaw$1$1(e,r){return r=r||{},r.raw=!0,inflate$1$1(e,r)}var Inflate_1$1$1=Inflate$1$1,inflate_2$2=inflate$1$1,inflateRaw_1$1$1=inflateRaw$1$1,ungzip$1$1=inflate$1$1,constants$b=constants$2$2,inflate_1$1$1={Inflate:Inflate_1$1$1,inflate:inflate_2$2,inflateRaw:inflateRaw_1$1$1,ungzip:ungzip$1$1,constants:constants$b};const{Deflate,deflate,deflateRaw,gzip}=deflate_1$1,{Inflate:Inflate$2,inflate:inflate$3,inflateRaw:inflateRaw$2,ungzip:ungzip$2}=inflate_1$1$1;var deflate_1=deflate,Inflate_1=Inflate$2,inflate_1$3=inflate$3;const pngSignature=[137,80,78,71,13,10,26,10],crcTable$1=[];for(let e=0;e<256;e++){let r=e;for(let t=0;t<8;t++)r&1?r=3988292384^r>>>1:r=r>>>1;crcTable$1[e]=r}const initialCrc=4294967295;function updateCrc(e,r,t){let o=e;for(let s=0;s<t;s++)o=crcTable$1[(o^r[s])&255]^o>>>8;return o}function crc(e,r){return(updateCrc(initialCrc,e,r)^initialCrc)>>>0}var ColorType;(function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.GREYSCALE=0]="GREYSCALE",e[e.TRUECOLOUR=2]="TRUECOLOUR",e[e.INDEXED_COLOUR=3]="INDEXED_COLOUR",e[e.GREYSCALE_ALPHA=4]="GREYSCALE_ALPHA",e[e.TRUECOLOUR_ALPHA=6]="TRUECOLOUR_ALPHA"})(ColorType||(ColorType={}));var CompressionMethod;(function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.DEFLATE=0]="DEFLATE"})(CompressionMethod||(CompressionMethod={}));var FilterMethod;(function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.ADAPTIVE=0]="ADAPTIVE"})(FilterMethod||(FilterMethod={}));var InterlaceMethod;(function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.NO_INTERLACE=0]="NO_INTERLACE",e[e.ADAM7=1]="ADAM7"})(InterlaceMethod||(InterlaceMethod={}));const empty=new Uint8Array(0),NULL="\0",uint16=new Uint16Array([255]),uint8=new Uint8Array(uint16.buffer),osIsLittleEndian=uint8[0]===255;class PngDecoder extends IOBuffer$4{constructor(r,t={}){super(r);const{checkCrc:o=!1}=t;this._checkCrc=o,this._inflator=new Inflate_1,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._end=!1,this._hasPalette=!1,this._palette=[],this._compressionMethod=CompressionMethod.UNKNOWN,this._filterMethod=FilterMethod.UNKNOWN,this._interlaceMethod=InterlaceMethod.UNKNOWN,this._colorType=-1,this.setBigEndian()}decode(){for(this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(let r=0;r<pngSignature.length;r++)if(this.readUint8()!==pngSignature[r])throw new Error(`wrong PNG signature. Byte at ${r} should be ${pngSignature[r]}.`)}decodeChunk(){const r=this.readUint32(),t=this.readChars(4),o=this.offset;switch(t){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(r);break;case"IDAT":this.decodeIDAT(r);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(r);break;case"iCCP":this.decodeiCCP(r);break;case"tEXt":this.decodetEXt(r);break;case"pHYs":this.decodepHYs();break;default:this.skip(r);break}if(this.offset-o!==r)throw new Error(`Length mismatch while decoding chunk ${t}`);if(this._checkCrc){const s=this.readUint32(),d=r+4,g=crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-d-4,d),d);if(g!==s)throw new Error(`CRC mismatch for chunk ${t}. Expected ${s}, found ${g}`)}else this.skip(4)}decodeIHDR(){const r=this._png;r.width=this.readUint32(),r.height=this.readUint32(),r.depth=checkBitDepth(this.readUint8());const t=this.readUint8();this._colorType=t;let o;switch(t){case ColorType.GREYSCALE:o=1;break;case ColorType.TRUECOLOUR:o=3;break;case ColorType.INDEXED_COLOUR:o=1;break;case ColorType.GREYSCALE_ALPHA:o=2;break;case ColorType.TRUECOLOUR_ALPHA:o=4;break;default:throw new Error(`Unknown color type: ${t}`)}if(this._png.channels=o,this._compressionMethod=this.readUint8(),this._compressionMethod!==CompressionMethod.DEFLATE)throw new Error(`Unsupported compression method: ${this._compressionMethod}`);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodePLTE(r){if(r%3!==0)throw new RangeError(`PLTE field length must be a multiple of 3. Got ${r}`);const t=r/3;this._hasPalette=!0;const o=[];this._palette=o;for(let s=0;s<t;s++)o.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(r){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,r)),this.skip(r)}decodetRNS(r){if(this._colorType===3){if(r>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${r} vs ${this._palette.length})`);let t=0;for(;t<r;t++){const o=this.readByte();this._palette[t].push(o)}for(;t<this._palette.length;t++)this._palette[t].push(255)}}decodeiCCP(r){let t="",o;for(;(o=this.readChar())!==NULL;)t+=o;const s=this.readUint8();if(s!==CompressionMethod.DEFLATE)throw new Error(`Unsupported iCCP compression method: ${s}`);const d=this.readBytes(r-t.length-2);this._png.iccEmbeddedProfile={name:t,profile:inflate_1$3(d)}}decodetEXt(r){let t="",o;for(;(o=this.readChar())!==NULL;)t+=o;this._png.text[t]=this.readChars(r-t.length-1)}decodepHYs(){const r=this.readUint32(),t=this.readUint32(),o=this.readByte();this._png.resolution={x:r,y:t,unit:o}}decodeImage(){if(this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);const r=this._inflator.result;if(this._filterMethod!==FilterMethod.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod===InterlaceMethod.NO_INTERLACE)this.decodeInterlaceNull(r);else throw new Error(`Interlace method ${this._interlaceMethod} not supported`)}decodeInterlaceNull(r){const t=this._png.height,o=this._png.channels*this._png.depth/8,s=this._png.width*o,d=new Uint8Array(this._png.height*s);let g=empty,a=0,b,_;for(let T=0;T<t;T++){switch(b=r.subarray(a+1,a+1+s),_=d.subarray(T*s,(T+1)*s),r[a]){case 0:unfilterNone(b,_,s);break;case 1:unfilterSub(b,_,s,o);break;case 2:unfilterUp(b,_,g,s);break;case 3:unfilterAverage(b,_,g,s,o);break;case 4:unfilterPaeth(b,_,g,s,o);break;default:throw new Error(`Unsupported filter: ${r[a]}`)}g=_,a+=s+1}if(this._hasPalette&&(this._png.palette=this._palette),this._png.depth===16){const T=new Uint16Array(d.buffer);if(osIsLittleEndian)for(let C=0;C<T.length;C++)T[C]=swap16(T[C]);this._png.data=T}else this._png.data=d}}function unfilterNone(e,r,t){for(let o=0;o<t;o++)r[o]=e[o]}function unfilterSub(e,r,t,o){let s=0;for(;s<o;s++)r[s]=e[s];for(;s<t;s++)r[s]=e[s]+r[s-o]&255}function unfilterUp(e,r,t,o){let s=0;if(t.length===0)for(;s<o;s++)r[s]=e[s];else for(;s<o;s++)r[s]=e[s]+t[s]&255}function unfilterAverage(e,r,t,o,s){let d=0;if(t.length===0){for(;d<s;d++)r[d]=e[d];for(;d<o;d++)r[d]=e[d]+(r[d-s]>>1)&255}else{for(;d<s;d++)r[d]=e[d]+(t[d]>>1)&255;for(;d<o;d++)r[d]=e[d]+(r[d-s]+t[d]>>1)&255}}function unfilterPaeth(e,r,t,o,s){let d=0;if(t.length===0){for(;d<s;d++)r[d]=e[d];for(;d<o;d++)r[d]=e[d]+r[d-s]&255}else{for(;d<s;d++)r[d]=e[d]+t[d]&255;for(;d<o;d++)r[d]=e[d]+paethPredictor(r[d-s],t[d],t[d-s])&255}}function paethPredictor(e,r,t){const o=e+r-t,s=Math.abs(o-e),d=Math.abs(o-r),g=Math.abs(o-t);return s<=d&&s<=g?e:d<=g?r:t}function swap16(e){return(e&255)<<8|e>>8&255}function checkBitDepth(e){if(e!==1&&e!==2&&e!==4&&e!==8&&e!==16)throw new Error(`invalid bit depth: ${e}`);return e}const defaultZlibOptions={level:3};class PngEncoder extends IOBuffer$4{constructor(r,t={}){super(),this._colorType=ColorType.UNKNOWN,this._zlibOptions=Object.assign({},defaultZlibOptions,t.zlib),this._png=this._checkData(r),this.setBigEndian()}encode(){return this.encodeSignature(),this.encodeIHDR(),this.encodeData(),this.encodeIEND(),this.toArray()}encodeSignature(){this.writeBytes(pngSignature)}encodeIHDR(){this.writeUint32(13),this.writeChars("IHDR"),this.writeUint32(this._png.width),this.writeUint32(this._png.height),this.writeByte(this._png.depth),this.writeByte(this._colorType),this.writeByte(CompressionMethod.DEFLATE),this.writeByte(FilterMethod.ADAPTIVE),this.writeByte(InterlaceMethod.NO_INTERLACE),this.writeCrc(17)}encodeIEND(){this.writeUint32(0),this.writeChars("IEND"),this.writeCrc(4)}encodeIDAT(r){this.writeUint32(r.length),this.writeChars("IDAT"),this.writeBytes(r),this.writeCrc(r.length+4)}encodeData(){const{width:r,height:t,channels:o,depth:s,data:d}=this._png,g=o*r,a=new IOBuffer$4().setBigEndian();let b=0;for(let C=0;C<t;C++)if(a.writeByte(0),s===8)b=writeDataBytes(d,a,g,b);else if(s===16)b=writeDataUint16(d,a,g,b);else throw new Error("unreachable");const _=a.toArray(),T=deflate_1(_,this._zlibOptions);this.encodeIDAT(T)}_checkData(r){const{colorType:t,channels:o,depth:s}=getColorType(r),d={width:checkInteger(r.width,"width"),height:checkInteger(r.height,"height"),channels:o,data:r.data,depth:s,text:{}};this._colorType=t;const g=d.width*d.height*o;if(d.data.length!==g)throw new RangeError(`wrong data size. Found ${d.data.length}, expected ${g}`);return d}writeCrc(r){this.writeUint32(crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-r,r),r))}}function checkInteger(e,r){if(Number.isInteger(e)&&e>0)return e;throw new TypeError(`${r} must be a positive integer`)}function getColorType(e){const{channels:r=4,depth:t=8}=e;if(r!==4&&r!==3&&r!==2&&r!==1)throw new RangeError(`unsupported number of channels: ${r}`);if(t!==8&&t!==16)throw new RangeError(`unsupported bit depth: ${t}`);const o={channels:r,depth:t,colorType:ColorType.UNKNOWN};switch(r){case 4:o.colorType=ColorType.TRUECOLOUR_ALPHA;break;case 3:o.colorType=ColorType.TRUECOLOUR;break;case 1:o.colorType=ColorType.GREYSCALE;break;case 2:o.colorType=ColorType.GREYSCALE_ALPHA;break;default:throw new Error("unsupported number of channels")}return o}function writeDataBytes(e,r,t,o){for(let s=0;s<t;s++)r.writeByte(e[o++]);return o}function writeDataUint16(e,r,t,o){for(let s=0;s<t;s++)r.writeUint16(e[o++]);return o}var ResolutionUnitSpecifier;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.METRE=1]="METRE"})(ResolutionUnitSpecifier||(ResolutionUnitSpecifier={}));function decodePng(e,r){return new PngDecoder(e,r).decode()}function encodePng$1(e,r){return new PngEncoder(e,r).encode()}var encoder={exports:{}};(function(e){function r(o){var s=Math.floor,d=new Array(64),g=new Array(64),a=new Array(64),b=new Array(64),_,T,C,D,k=new Array(65535),O=new Array(65535),U=new Array(64),G=new Array(64),j=[],te=0,H=7,Z=new Array(64),W=new Array(64),_e=new Array(64),fe=new Array(256),re=new Array(2048),ae,J=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],se=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],Me=[0,1,2,3,4,5,6,7,8,9,10,11],Ie=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],We=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],Ge=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],qt=[0,1,2,3,4,5,6,7,8,9,10,11],ti=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],Ut=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function Qt(dt){for(var ei=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],ct=0;ct<64;ct++){var Ct=s((ei[ct]*dt+50)/100);Ct<1?Ct=1:Ct>255&&(Ct=255),d[J[ct]]=Ct}for(var Be=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],Xt=0;Xt<64;Xt++){var ni=s((Be[Xt]*dt+50)/100);ni<1?ni=1:ni>255&&(ni=255),g[J[Xt]]=ni}for(var Vt=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],Nt=0,mi=0;mi<8;mi++)for(var ii=0;ii<8;ii++)a[Nt]=1/(d[J[Nt]]*Vt[mi]*Vt[ii]*8),b[Nt]=1/(g[J[Nt]]*Vt[mi]*Vt[ii]*8),Nt++}function tt(dt,ei){for(var ct=0,Ct=0,Be=new Array,Xt=1;Xt<=16;Xt++){for(var ni=1;ni<=dt[Xt];ni++)Be[ei[Ct]]=[],Be[ei[Ct]][0]=ct,Be[ei[Ct]][1]=Xt,Ct++,ct++;ct*=2}return Be}function nt(){_=tt(se,Me),T=tt(Ge,qt),C=tt(Ie,We),D=tt(ti,Ut)}function Mt(){for(var dt=1,ei=2,ct=1;ct<=15;ct++){for(var Ct=dt;Ct<ei;Ct++)O[32767+Ct]=ct,k[32767+Ct]=[],k[32767+Ct][1]=ct,k[32767+Ct][0]=Ct;for(var Be=-(ei-1);Be<=-dt;Be++)O[32767+Be]=ct,k[32767+Be]=[],k[32767+Be][1]=ct,k[32767+Be][0]=ei-1+Be;dt<<=1,ei<<=1}}function ht(){for(var dt=0;dt<256;dt++)re[dt]=19595*dt,re[dt+256>>0]=38470*dt,re[dt+512>>0]=7471*dt+32768,re[dt+768>>0]=-11059*dt,re[dt+1024>>0]=-21709*dt,re[dt+1280>>0]=32768*dt+8421375,re[dt+1536>>0]=-27439*dt,re[dt+1792>>0]=-5329*dt}function xt(dt){for(var ei=dt[0],ct=dt[1]-1;ct>=0;)ei&1<<ct&&(te|=1<<H),ct--,H--,H<0&&(te==255?(It(255),It(0)):It(te),H=7,te=0)}function It(dt){j.push(dt)}function Et(dt){It(dt>>8&255),It(dt&255)}function yt(dt,ei){var ct,Ct,Be,Xt,ni,Vt,Nt,mi,ii=0,Ii,$i=8,Ri=64;for(Ii=0;Ii<$i;++Ii){ct=dt[ii],Ct=dt[ii+1],Be=dt[ii+2],Xt=dt[ii+3],ni=dt[ii+4],Vt=dt[ii+5],Nt=dt[ii+6],mi=dt[ii+7];var Ni=ct+mi,zi=ct-mi,Ki=Ct+Nt,_r=Ct-Nt,cr=Be+Vt,ur=Be-Vt,Ur=Xt+ni,nn=Xt-ni,Er=Ni+Ur,Kr=Ni-Ur,on=Ki+cr,an=Ki-cr;dt[ii]=Er+on,dt[ii+4]=Er-on;var vt=(an+Kr)*.707106781;dt[ii+2]=Kr+vt,dt[ii+6]=Kr-vt,Er=nn+ur,on=ur+_r,an=_r+zi;var _i=(Er-an)*.382683433,he=.5411961*Er+_i,Oe=1.306562965*an+_i,He=on*.707106781,Tt=zi+He,le=zi-He;dt[ii+5]=le+he,dt[ii+3]=le-he,dt[ii+1]=Tt+Oe,dt[ii+7]=Tt-Oe,ii+=8}for(ii=0,Ii=0;Ii<$i;++Ii){ct=dt[ii],Ct=dt[ii+8],Be=dt[ii+16],Xt=dt[ii+24],ni=dt[ii+32],Vt=dt[ii+40],Nt=dt[ii+48],mi=dt[ii+56];var Q=ct+mi,ne=ct-mi,me=Ct+Nt,we=Ct-Nt,Pe=Be+Vt,Ye=Be-Vt,Ue=Xt+ni,Ne=Xt-ni,Xe=Q+Ue,bt=Q-Ue,Ht=me+Pe,Pt=me-Pe;dt[ii]=Xe+Ht,dt[ii+32]=Xe-Ht;var Ai=(Pt+bt)*.707106781;dt[ii+16]=bt+Ai,dt[ii+48]=bt-Ai,Xe=Ne+Ye,Ht=Ye+we,Pt=we+ne;var xi=(Xe-Pt)*.382683433,Ei=.5411961*Xe+xi,Fi=1.306562965*Pt+xi,Ce=Ht*.707106781,Yt=ne+Ce,At=ne-Ce;dt[ii+40]=At+Ei,dt[ii+24]=At-Ei,dt[ii+8]=Yt+Fi,dt[ii+56]=Yt-Fi,ii++}var ui;for(Ii=0;Ii<Ri;++Ii)ui=dt[Ii]*ei[Ii],U[Ii]=ui>0?ui+.5|0:ui-.5|0;return U}function Bt(){Et(65504),Et(16),It(74),It(70),It(73),It(70),It(0),It(1),It(1),It(0),Et(1),Et(1),It(0),It(0)}function _t(dt){if(dt){Et(65505),dt[0]===69&&dt[1]===120&&dt[2]===105&&dt[3]===102?Et(dt.length+2):(Et(dt.length+5+2),It(69),It(120),It(105),It(102),It(0));for(var ei=0;ei<dt.length;ei++)It(dt[ei])}}function si(dt,ei){Et(65472),Et(17),It(8),Et(ei),Et(dt),It(3),It(1),It(17),It(0),It(2),It(17),It(1),It(3),It(17),It(1)}function Li(){Et(65499),Et(132),It(0);for(var dt=0;dt<64;dt++)It(d[dt]);It(1);for(var ei=0;ei<64;ei++)It(g[ei])}function vi(){Et(65476),Et(418),It(0);for(var dt=0;dt<16;dt++)It(se[dt+1]);for(var ei=0;ei<=11;ei++)It(Me[ei]);It(16);for(var ct=0;ct<16;ct++)It(Ie[ct+1]);for(var Ct=0;Ct<=161;Ct++)It(We[Ct]);It(1);for(var Be=0;Be<16;Be++)It(Ge[Be+1]);for(var Xt=0;Xt<=11;Xt++)It(qt[Xt]);It(17);for(var ni=0;ni<16;ni++)It(ti[ni+1]);for(var Vt=0;Vt<=161;Vt++)It(Ut[Vt])}function ci(dt){typeof dt>"u"||dt.constructor!==Array||dt.forEach(ei=>{if(typeof ei=="string"){Et(65534);var ct=ei.length;Et(ct+2);var Ct;for(Ct=0;Ct<ct;Ct++)It(ei.charCodeAt(Ct))}})}function mt(){Et(65498),Et(12),It(3),It(1),It(0),It(2),It(17),It(3),It(17),It(0),It(63),It(0)}function $t(dt,ei,ct,Ct,Be){for(var Xt=Be[0],ni=Be[240],Vt,Nt=16,mi=63,ii=64,Ii=yt(dt,ei),$i=0;$i<ii;++$i)G[J[$i]]=Ii[$i];var Ri=G[0]-ct;ct=G[0],Ri==0?xt(Ct[0]):(Vt=32767+Ri,xt(Ct[O[Vt]]),xt(k[Vt]));for(var Ni=63;Ni>0&&G[Ni]==0;Ni--);if(Ni==0)return xt(Xt),ct;for(var zi=1,Ki;zi<=Ni;){for(var _r=zi;G[zi]==0&&zi<=Ni;++zi);var cr=zi-_r;if(cr>=Nt){Ki=cr>>4;for(var ur=1;ur<=Ki;++ur)xt(ni);cr=cr&15}Vt=32767+G[zi],xt(Be[(cr<<4)+O[Vt]]),xt(k[Vt]),zi++}return Ni!=mi&&xt(Xt),ct}function Mi(){for(var dt=String.fromCharCode,ei=0;ei<256;ei++)fe[ei]=dt(ei)}this.encode=function(dt,ei){new Date().getTime(),ei&&Di(ei),j=new Array,te=0,H=7,Et(65496),Bt(),ci(dt.comments),_t(dt.exifBuffer),Li(),si(dt.width,dt.height),vi(),mt();var ct=0,Ct=0,Be=0;te=0,H=7,this.encode.displayName="_encode_";for(var Xt=dt.data,ni=dt.width,Vt=dt.height,Nt=ni*4,mi,ii=0,Ii,$i,Ri,Ni,zi,Ki,_r,cr;ii<Vt;){for(mi=0;mi<Nt;){for(Ni=Nt*ii+mi,zi=Ni,Ki=-1,_r=0,cr=0;cr<64;cr++)_r=cr>>3,Ki=(cr&7)*4,zi=Ni+_r*Nt+Ki,ii+_r>=Vt&&(zi-=Nt*(ii+1+_r-Vt)),mi+Ki>=Nt&&(zi-=mi+Ki-Nt+4),Ii=Xt[zi++],$i=Xt[zi++],Ri=Xt[zi++],Z[cr]=(re[Ii]+re[$i+256>>0]+re[Ri+512>>0]>>16)-128,W[cr]=(re[Ii+768>>0]+re[$i+1024>>0]+re[Ri+1280>>0]>>16)-128,_e[cr]=(re[Ii+1280>>0]+re[$i+1536>>0]+re[Ri+1792>>0]>>16)-128;ct=$t(Z,a,ct,_,C),Ct=$t(W,b,Ct,T,D),Be=$t(_e,b,Be,T,D),mi+=32}ii+=8}if(H>=0){var ur=[];ur[1]=H+1,ur[0]=(1<<H+1)-1,xt(ur)}return Et(65497),Buffer.from(j)};function Di(dt){if(dt<=0&&(dt=1),dt>100&&(dt=100),ae!=dt){var ei=0;dt<50?ei=Math.floor(5e3/dt):ei=Math.floor(200-dt*2),Qt(ei),ae=dt}}function Ci(){var dt=new Date().getTime();o||(o=50),Mi(),nt(),Mt(),ht(),Di(o),new Date().getTime()-dt}Ci()}e.exports=t;function t(o,s){typeof s>"u"&&(s=50);var d=new r(s),g=d.encode(o,s);return{data:g,width:o.width,height:o.height}}})(encoder);var encoderExports=encoder.exports,decoder={exports:{}};(function(e){var r=function(){var s=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),d=4017,g=799,a=3406,b=2276,_=1567,T=3784,C=5793,D=2896;function k(){}function O(W,_e){for(var fe=0,re=[],ae,J,se=16;se>0&&!W[se-1];)se--;re.push({children:[],index:0});var Me=re[0],Ie;for(ae=0;ae<se;ae++){for(J=0;J<W[ae];J++){for(Me=re.pop(),Me.children[Me.index]=_e[fe];Me.index>0;){if(re.length===0)throw new Error("Could not recreate Huffman Table");Me=re.pop()}for(Me.index++,re.push(Me);re.length<=ae;)re.push(Ie={children:[],index:0}),Me.children[Me.index]=Ie.children,Me=Ie;fe++}ae+1<se&&(re.push(Ie={children:[],index:0}),Me.children[Me.index]=Ie.children,Me=Ie)}return re[0].children}function U(W,_e,fe,re,ae,J,se,Me,Ie,We){fe.precision,fe.samplesPerLine,fe.scanLines;var Ge=fe.mcusPerLine,qt=fe.progressive;fe.maxH,fe.maxV;var ti=_e,Ut=0,Qt=0;function tt(){if(Qt>0)return Qt--,Ut>>Qt&1;if(Ut=W[_e++],Ut==255){var Vt=W[_e++];if(Vt)throw new Error("unexpected marker: "+(Ut<<8|Vt).toString(16))}return Qt=7,Ut>>>7}function nt(Vt){for(var Nt=Vt,mi;(mi=tt())!==null;){if(Nt=Nt[mi],typeof Nt=="number")return Nt;if(typeof Nt!="object")throw new Error("invalid huffman sequence")}return null}function Mt(Vt){for(var Nt=0;Vt>0;){var mi=tt();if(mi===null)return;Nt=Nt<<1|mi,Vt--}return Nt}function ht(Vt){var Nt=Mt(Vt);return Nt>=1<<Vt-1?Nt:Nt+(-1<<Vt)+1}function xt(Vt,Nt){var mi=nt(Vt.huffmanTableDC),ii=mi===0?0:ht(mi);Nt[0]=Vt.pred+=ii;for(var Ii=1;Ii<64;){var $i=nt(Vt.huffmanTableAC),Ri=$i&15,Ni=$i>>4;if(Ri===0){if(Ni<15)break;Ii+=16;continue}Ii+=Ni;var zi=s[Ii];Nt[zi]=ht(Ri),Ii++}}function It(Vt,Nt){var mi=nt(Vt.huffmanTableDC),ii=mi===0?0:ht(mi)<<Ie;Nt[0]=Vt.pred+=ii}function Et(Vt,Nt){Nt[0]|=tt()<<Ie}var yt=0;function Bt(Vt,Nt){if(yt>0){yt--;return}for(var mi=J,ii=se;mi<=ii;){var Ii=nt(Vt.huffmanTableAC),$i=Ii&15,Ri=Ii>>4;if($i===0){if(Ri<15){yt=Mt(Ri)+(1<<Ri)-1;break}mi+=16;continue}mi+=Ri;var Ni=s[mi];Nt[Ni]=ht($i)*(1<<Ie),mi++}}var _t=0,si;function Li(Vt,Nt){for(var mi=J,ii=se,Ii=0;mi<=ii;){var $i=s[mi],Ri=Nt[$i]<0?-1:1;switch(_t){case 0:var Ni=nt(Vt.huffmanTableAC),zi=Ni&15,Ii=Ni>>4;if(zi===0)Ii<15?(yt=Mt(Ii)+(1<<Ii),_t=4):(Ii=16,_t=1);else{if(zi!==1)throw new Error("invalid ACn encoding");si=ht(zi),_t=Ii?2:3}continue;case 1:case 2:Nt[$i]?Nt[$i]+=(tt()<<Ie)*Ri:(Ii--,Ii===0&&(_t=_t==2?3:0));break;case 3:Nt[$i]?Nt[$i]+=(tt()<<Ie)*Ri:(Nt[$i]=si<<Ie,_t=0);break;case 4:Nt[$i]&&(Nt[$i]+=(tt()<<Ie)*Ri);break}mi++}_t===4&&(yt--,yt===0&&(_t=0))}function vi(Vt,Nt,mi,ii,Ii){var $i=mi/Ge|0,Ri=mi%Ge,Ni=$i*Vt.v+ii,zi=Ri*Vt.h+Ii;Vt.blocks[Ni]===void 0&&We.tolerantDecoding||Nt(Vt,Vt.blocks[Ni][zi])}function ci(Vt,Nt,mi){var ii=mi/Vt.blocksPerLine|0,Ii=mi%Vt.blocksPerLine;Vt.blocks[ii]===void 0&&We.tolerantDecoding||Nt(Vt,Vt.blocks[ii][Ii])}var mt=re.length,$t,Mi,Di,Ci,dt,ei;qt?J===0?ei=Me===0?It:Et:ei=Me===0?Bt:Li:ei=xt;var ct=0,Ct,Be;mt==1?Be=re[0].blocksPerLine*re[0].blocksPerColumn:Be=Ge*fe.mcusPerColumn,ae||(ae=Be);for(var Xt,ni;ct<Be;){for(Mi=0;Mi<mt;Mi++)re[Mi].pred=0;if(yt=0,mt==1)for($t=re[0],dt=0;dt<ae;dt++)ci($t,ei,ct),ct++;else for(dt=0;dt<ae;dt++){for(Mi=0;Mi<mt;Mi++)for($t=re[Mi],Xt=$t.h,ni=$t.v,Di=0;Di<ni;Di++)for(Ci=0;Ci<Xt;Ci++)vi($t,ei,ct,Di,Ci);if(ct++,ct===Be)break}if(ct===Be)do{if(W[_e]===255&&W[_e+1]!==0)break;_e+=1}while(_e<W.length-2);if(Qt=0,Ct=W[_e]<<8|W[_e+1],Ct<65280)throw new Error("marker was not found");if(Ct>=65488&&Ct<=65495)_e+=2;else break}return _e-ti}function G(W,_e){var fe=[],re=_e.blocksPerLine,ae=_e.blocksPerColumn,J=re<<3,se=new Int32Array(64),Me=new Uint8Array(64);function Ie(Mt,ht,xt){var It=_e.quantizationTable,Et,yt,Bt,_t,si,Li,vi,ci,mt,$t=xt,Mi;for(Mi=0;Mi<64;Mi++)$t[Mi]=Mt[Mi]*It[Mi];for(Mi=0;Mi<8;++Mi){var Di=8*Mi;if($t[1+Di]==0&&$t[2+Di]==0&&$t[3+Di]==0&&$t[4+Di]==0&&$t[5+Di]==0&&$t[6+Di]==0&&$t[7+Di]==0){mt=C*$t[0+Di]+512>>10,$t[0+Di]=mt,$t[1+Di]=mt,$t[2+Di]=mt,$t[3+Di]=mt,$t[4+Di]=mt,$t[5+Di]=mt,$t[6+Di]=mt,$t[7+Di]=mt;continue}Et=C*$t[0+Di]+128>>8,yt=C*$t[4+Di]+128>>8,Bt=$t[2+Di],_t=$t[6+Di],si=D*($t[1+Di]-$t[7+Di])+128>>8,ci=D*($t[1+Di]+$t[7+Di])+128>>8,Li=$t[3+Di]<<4,vi=$t[5+Di]<<4,mt=Et-yt+1>>1,Et=Et+yt+1>>1,yt=mt,mt=Bt*T+_t*_+128>>8,Bt=Bt*_-_t*T+128>>8,_t=mt,mt=si-vi+1>>1,si=si+vi+1>>1,vi=mt,mt=ci+Li+1>>1,Li=ci-Li+1>>1,ci=mt,mt=Et-_t+1>>1,Et=Et+_t+1>>1,_t=mt,mt=yt-Bt+1>>1,yt=yt+Bt+1>>1,Bt=mt,mt=si*b+ci*a+2048>>12,si=si*a-ci*b+2048>>12,ci=mt,mt=Li*g+vi*d+2048>>12,Li=Li*d-vi*g+2048>>12,vi=mt,$t[0+Di]=Et+ci,$t[7+Di]=Et-ci,$t[1+Di]=yt+vi,$t[6+Di]=yt-vi,$t[2+Di]=Bt+Li,$t[5+Di]=Bt-Li,$t[3+Di]=_t+si,$t[4+Di]=_t-si}for(Mi=0;Mi<8;++Mi){var Ci=Mi;if($t[8+Ci]==0&&$t[16+Ci]==0&&$t[24+Ci]==0&&$t[32+Ci]==0&&$t[40+Ci]==0&&$t[48+Ci]==0&&$t[56+Ci]==0){mt=C*xt[Mi+0]+8192>>14,$t[0+Ci]=mt,$t[8+Ci]=mt,$t[16+Ci]=mt,$t[24+Ci]=mt,$t[32+Ci]=mt,$t[40+Ci]=mt,$t[48+Ci]=mt,$t[56+Ci]=mt;continue}Et=C*$t[0+Ci]+2048>>12,yt=C*$t[32+Ci]+2048>>12,Bt=$t[16+Ci],_t=$t[48+Ci],si=D*($t[8+Ci]-$t[56+Ci])+2048>>12,ci=D*($t[8+Ci]+$t[56+Ci])+2048>>12,Li=$t[24+Ci],vi=$t[40+Ci],mt=Et-yt+1>>1,Et=Et+yt+1>>1,yt=mt,mt=Bt*T+_t*_+2048>>12,Bt=Bt*_-_t*T+2048>>12,_t=mt,mt=si-vi+1>>1,si=si+vi+1>>1,vi=mt,mt=ci+Li+1>>1,Li=ci-Li+1>>1,ci=mt,mt=Et-_t+1>>1,Et=Et+_t+1>>1,_t=mt,mt=yt-Bt+1>>1,yt=yt+Bt+1>>1,Bt=mt,mt=si*b+ci*a+2048>>12,si=si*a-ci*b+2048>>12,ci=mt,mt=Li*g+vi*d+2048>>12,Li=Li*d-vi*g+2048>>12,vi=mt,$t[0+Ci]=Et+ci,$t[56+Ci]=Et-ci,$t[8+Ci]=yt+vi,$t[48+Ci]=yt-vi,$t[16+Ci]=Bt+Li,$t[40+Ci]=Bt-Li,$t[24+Ci]=_t+si,$t[32+Ci]=_t-si}for(Mi=0;Mi<64;++Mi){var dt=128+($t[Mi]+8>>4);ht[Mi]=dt<0?0:dt>255?255:dt}}Z(J*ae*8);for(var We,Ge,qt=0;qt<ae;qt++){var ti=qt<<3;for(We=0;We<8;We++)fe.push(new Uint8Array(J));for(var Ut=0;Ut<re;Ut++){Ie(_e.blocks[qt][Ut],Me,se);var Qt=0,tt=Ut<<3;for(Ge=0;Ge<8;Ge++){var nt=fe[ti+Ge];for(We=0;We<8;We++)nt[tt+We]=Me[Qt++]}}}return fe}function j(W){return W<0?0:W>255?255:W}k.prototype={load:function(_e){var fe=new XMLHttpRequest;fe.open("GET",_e,!0),fe.responseType="arraybuffer",fe.onload=function(){var re=new Uint8Array(fe.response||fe.mozResponseArrayBuffer);this.parse(re),this.onload&&this.onload()}.bind(this),fe.send(null)},parse:function(_e){var fe=this.opts.maxResolutionInMP*1e3*1e3,re=0;_e.length;function ae(){var Ri=_e[re]<<8|_e[re+1];return re+=2,Ri}function J(){var Ri=ae(),Ni=_e.subarray(re,re+Ri-2);return re+=Ni.length,Ni}function se(Ri){var Ni=1,zi=1,Ki,_r;for(_r in Ri.components)Ri.components.hasOwnProperty(_r)&&(Ki=Ri.components[_r],Ni<Ki.h&&(Ni=Ki.h),zi<Ki.v&&(zi=Ki.v));var cr=Math.ceil(Ri.samplesPerLine/8/Ni),ur=Math.ceil(Ri.scanLines/8/zi);for(_r in Ri.components)if(Ri.components.hasOwnProperty(_r)){Ki=Ri.components[_r];var Ur=Math.ceil(Math.ceil(Ri.samplesPerLine/8)*Ki.h/Ni),nn=Math.ceil(Math.ceil(Ri.scanLines/8)*Ki.v/zi),Er=cr*Ki.h,Kr=ur*Ki.v,on=Kr*Er,an=[];Z(on*256);for(var vt=0;vt<Kr;vt++){for(var _i=[],he=0;he<Er;he++)_i.push(new Int32Array(64));an.push(_i)}Ki.blocksPerLine=Ur,Ki.blocksPerColumn=nn,Ki.blocks=an}Ri.maxH=Ni,Ri.maxV=zi,Ri.mcusPerLine=cr,Ri.mcusPerColumn=ur}var Me=null,Ie=null,We,Ge,qt=[],ti=[],Ut=[],Qt=[],tt=ae(),nt=-1;if(this.comments=[],tt!=65496)throw new Error("SOI not found");for(tt=ae();tt!=65497;){var Mt,ht;switch(tt){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var xt=J();if(tt===65534){var It=String.fromCharCode.apply(null,xt);this.comments.push(It)}tt===65504&&xt[0]===74&&xt[1]===70&&xt[2]===73&&xt[3]===70&&xt[4]===0&&(Me={version:{major:xt[5],minor:xt[6]},densityUnits:xt[7],xDensity:xt[8]<<8|xt[9],yDensity:xt[10]<<8|xt[11],thumbWidth:xt[12],thumbHeight:xt[13],thumbData:xt.subarray(14,14+3*xt[12]*xt[13])}),tt===65505&&xt[0]===69&&xt[1]===120&&xt[2]===105&&xt[3]===102&&xt[4]===0&&(this.exifBuffer=xt.subarray(5,xt.length)),tt===65518&&xt[0]===65&&xt[1]===100&&xt[2]===111&&xt[3]===98&&xt[4]===101&&xt[5]===0&&(Ie={version:xt[6],flags0:xt[7]<<8|xt[8],flags1:xt[9]<<8|xt[10],transformCode:xt[11]});break;case 65499:for(var Et=ae(),yt=Et+re-2;re<yt;){var Bt=_e[re++];Z(256);var _t=new Int32Array(64);if(Bt>>4)if(Bt>>4===1)for(ht=0;ht<64;ht++){var si=s[ht];_t[si]=ae()}else throw new Error("DQT: invalid table spec");else for(ht=0;ht<64;ht++){var si=s[ht];_t[si]=_e[re++]}qt[Bt&15]=_t}break;case 65472:case 65473:case 65474:ae(),We={},We.extended=tt===65473,We.progressive=tt===65474,We.precision=_e[re++],We.scanLines=ae(),We.samplesPerLine=ae(),We.components={},We.componentsOrder=[];var Li=We.scanLines*We.samplesPerLine;if(Li>fe){var vi=Math.ceil((Li-fe)/1e6);throw new Error(`maxResolutionInMP limit exceeded by ${vi}MP`)}var ci=_e[re++],mt;for(Mt=0;Mt<ci;Mt++){mt=_e[re];var $t=_e[re+1]>>4,Mi=_e[re+1]&15,Di=_e[re+2];if($t<=0||Mi<=0)throw new Error("Invalid sampling factor, expected values above 0");We.componentsOrder.push(mt),We.components[mt]={h:$t,v:Mi,quantizationIdx:Di},re+=3}se(We),ti.push(We);break;case 65476:var Ci=ae();for(Mt=2;Mt<Ci;){var dt=_e[re++],ei=new Uint8Array(16),ct=0;for(ht=0;ht<16;ht++,re++)ct+=ei[ht]=_e[re];Z(16+ct);var Ct=new Uint8Array(ct);for(ht=0;ht<ct;ht++,re++)Ct[ht]=_e[re];Mt+=17+ct,(dt>>4?Ut:Qt)[dt&15]=O(ei,Ct)}break;case 65501:ae(),Ge=ae();break;case 65500:ae(),ae();break;case 65498:ae();var Be=_e[re++],Xt=[],ni;for(Mt=0;Mt<Be;Mt++){ni=We.components[_e[re++]];var Vt=_e[re++];ni.huffmanTableDC=Qt[Vt>>4],ni.huffmanTableAC=Ut[Vt&15],Xt.push(ni)}var Nt=_e[re++],mi=_e[re++],ii=_e[re++],Ii=U(_e,re,We,Xt,Ge,Nt,mi,ii>>4,ii&15,this.opts);re+=Ii;break;case 65535:_e[re]!==255&&re--;break;default:if(_e[re-3]==255&&_e[re-2]>=192&&_e[re-2]<=254){re-=3;break}else if(tt===224||tt==225){if(nt!==-1)throw new Error(`first unknown JPEG marker at offset ${nt.toString(16)}, second unknown JPEG marker ${tt.toString(16)} at offset ${(re-1).toString(16)}`);nt=re-1;const Ri=ae();if(_e[re+Ri-2]===255){re+=Ri-2;break}}throw new Error("unknown JPEG marker "+tt.toString(16))}tt=ae()}if(ti.length!=1)throw new Error("only single frame JPEGs supported");for(var Mt=0;Mt<ti.length;Mt++){var $i=ti[Mt].components;for(var ht in $i)$i[ht].quantizationTable=qt[$i[ht].quantizationIdx],delete $i[ht].quantizationIdx}this.width=We.samplesPerLine,this.height=We.scanLines,this.jfif=Me,this.adobe=Ie,this.components=[];for(var Mt=0;Mt<We.componentsOrder.length;Mt++){var ni=We.components[We.componentsOrder[Mt]];this.components.push({lines:G(We,ni),scaleX:ni.h/We.maxH,scaleY:ni.v/We.maxV})}},getData:function(_e,fe){var re=this.width/_e,ae=this.height/fe,J,se,Me,Ie,We,Ge,qt,ti,Ut,Qt,tt=0,nt,Mt,ht,xt,It,Et,yt,Bt,_t,si,Li,vi=_e*fe*this.components.length;Z(vi);var ci=new Uint8Array(vi);switch(this.components.length){case 1:for(J=this.components[0],Qt=0;Qt<fe;Qt++)for(We=J.lines[0|Qt*J.scaleY*ae],Ut=0;Ut<_e;Ut++)nt=We[0|Ut*J.scaleX*re],ci[tt++]=nt;break;case 2:for(J=this.components[0],se=this.components[1],Qt=0;Qt<fe;Qt++)for(We=J.lines[0|Qt*J.scaleY*ae],Ge=se.lines[0|Qt*se.scaleY*ae],Ut=0;Ut<_e;Ut++)nt=We[0|Ut*J.scaleX*re],ci[tt++]=nt,nt=Ge[0|Ut*se.scaleX*re],ci[tt++]=nt;break;case 3:for(Li=!0,this.adobe&&this.adobe.transformCode?Li=!0:typeof this.opts.colorTransform<"u"&&(Li=!!this.opts.colorTransform),J=this.components[0],se=this.components[1],Me=this.components[2],Qt=0;Qt<fe;Qt++)for(We=J.lines[0|Qt*J.scaleY*ae],Ge=se.lines[0|Qt*se.scaleY*ae],qt=Me.lines[0|Qt*Me.scaleY*ae],Ut=0;Ut<_e;Ut++)Li?(nt=We[0|Ut*J.scaleX*re],Mt=Ge[0|Ut*se.scaleX*re],ht=qt[0|Ut*Me.scaleX*re],Bt=j(nt+1.402*(ht-128)),_t=j(nt-.3441363*(Mt-128)-.71413636*(ht-128)),si=j(nt+1.772*(Mt-128))):(Bt=We[0|Ut*J.scaleX*re],_t=Ge[0|Ut*se.scaleX*re],si=qt[0|Ut*Me.scaleX*re]),ci[tt++]=Bt,ci[tt++]=_t,ci[tt++]=si;break;case 4:if(!this.adobe)throw new Error("Unsupported color mode (4 components)");for(Li=!1,this.adobe&&this.adobe.transformCode?Li=!0:typeof this.opts.colorTransform<"u"&&(Li=!!this.opts.colorTransform),J=this.components[0],se=this.components[1],Me=this.components[2],Ie=this.components[3],Qt=0;Qt<fe;Qt++)for(We=J.lines[0|Qt*J.scaleY*ae],Ge=se.lines[0|Qt*se.scaleY*ae],qt=Me.lines[0|Qt*Me.scaleY*ae],ti=Ie.lines[0|Qt*Ie.scaleY*ae],Ut=0;Ut<_e;Ut++)Li?(nt=We[0|Ut*J.scaleX*re],Mt=Ge[0|Ut*se.scaleX*re],ht=qt[0|Ut*Me.scaleX*re],xt=ti[0|Ut*Ie.scaleX*re],It=255-j(nt+1.402*(ht-128)),Et=255-j(nt-.3441363*(Mt-128)-.71413636*(ht-128)),yt=255-j(nt+1.772*(Mt-128))):(It=We[0|Ut*J.scaleX*re],Et=Ge[0|Ut*se.scaleX*re],yt=qt[0|Ut*Me.scaleX*re],xt=ti[0|Ut*Ie.scaleX*re]),ci[tt++]=255-It,ci[tt++]=255-Et,ci[tt++]=255-yt,ci[tt++]=255-xt;break;default:throw new Error("Unsupported color mode")}return ci},copyToImageData:function(_e,fe){var re=_e.width,ae=_e.height,J=_e.data,se=this.getData(re,ae),Me=0,Ie=0,We,Ge,qt,ti,Ut,Qt,tt,nt,Mt;switch(this.components.length){case 1:for(Ge=0;Ge<ae;Ge++)for(We=0;We<re;We++)qt=se[Me++],J[Ie++]=qt,J[Ie++]=qt,J[Ie++]=qt,fe&&(J[Ie++]=255);break;case 3:for(Ge=0;Ge<ae;Ge++)for(We=0;We<re;We++)tt=se[Me++],nt=se[Me++],Mt=se[Me++],J[Ie++]=tt,J[Ie++]=nt,J[Ie++]=Mt,fe&&(J[Ie++]=255);break;case 4:for(Ge=0;Ge<ae;Ge++)for(We=0;We<re;We++)Ut=se[Me++],Qt=se[Me++],qt=se[Me++],ti=se[Me++],tt=255-j(Ut*(1-ti/255)+ti),nt=255-j(Qt*(1-ti/255)+ti),Mt=255-j(qt*(1-ti/255)+ti),J[Ie++]=tt,J[Ie++]=nt,J[Ie++]=Mt,fe&&(J[Ie++]=255);break;default:throw new Error("Unsupported color mode")}}};var te=0,H=0;function Z(W=0){var _e=te+W;if(_e>H){var fe=Math.ceil((_e-H)/1024/1024);throw new Error(`maxMemoryUsageInMB limit exceeded by at least ${fe}MB`)}te=_e}return k.resetMaxMemoryUsage=function(W){te=0,H=W},k.getBytesAllocated=function(){return te},k.requestMemoryAllocation=Z,k}();e.exports=t;function t(o,s={}){var d={colorTransform:void 0,useTArray:!1,formatAsRGBA:!0,tolerantDecoding:!0,maxResolutionInMP:100,maxMemoryUsageInMB:512},g={...d,...s},a=new Uint8Array(o),b=new r;b.opts=g,r.resetMaxMemoryUsage(g.maxMemoryUsageInMB*1024*1024),b.parse(a);var _=g.formatAsRGBA?4:3,T=b.width*b.height*_;try{r.requestMemoryAllocation(T);var C={width:b.width,height:b.height,exifBuffer:b.exifBuffer,data:g.useTArray?new Uint8Array(T):Buffer.alloc(T)};b.comments.length>0&&(C.comments=b.comments)}catch(D){throw D instanceof RangeError?new Error("Could not allocate enough memory for the image. Required: "+T):D instanceof ReferenceError&&D.message==="Buffer is not defined"?new Error("Buffer is not globally defined in this environment. Consider setting useTArray to true"):D}return b.copyToImageData(C,g.formatAsRGBA),C}})(decoder);var decoderExports=decoder.exports,encode$1=encoderExports,decode$4=decoderExports,jpegJs={encode:encode$1,decode:decode$4};let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=new Uint8Array(256);for(let e=0;e<chars.length;e++)lookup[chars.charCodeAt(e)]=e;function encode(e){let r,t=e.length,o="";for(r=0;r<t;r+=3)o+=chars[e[r]>>2],o+=chars[(e[r]&3)<<4|e[r+1]>>4],o+=chars[(e[r+1]&15)<<2|e[r+2]>>6],o+=chars[e[r+2]&63];return t%3===2?o=`${o.substring(0,o.length-1)}=`:t%3===1&&(o=`${o.substring(0,o.length-2)}==`),o}function decode$3(e){let r=e.length*.75,t=e.length,o=0,s,d,g,a;e[e.length-1]==="="&&(r--,e[e.length-2]==="="&&r--);const b=new Uint8Array(r);for(let _=0;_<t;_+=4)s=lookup[e.charCodeAt(_)],d=lookup[e.charCodeAt(_+1)],g=lookup[e.charCodeAt(_+2)],a=lookup[e.charCodeAt(_+3)],b[o++]=s<<2|d>>4,b[o++]=(d&15)<<4|g>>2,b[o++]=(g&3)<<6|a&63;return b}function toBase64URL(e,r){const t=encode(e);return`data:${r};base64,${t}`}const ImageData=self.ImageData,DOMImage=self.Image;function createCanvas(e,r){let t=self.document.createElement("canvas");return t.width=e,t.height=r,t}function fetchBinary(e,{withCredentials:r=!1}={}){return new Promise(function(t,o){let s=new self.XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.withCredentials=r,s.onload=function(d){this.status!==200?o(d):t(this.response)},s.onerror=o,s.send()})}function createWriteStream(){throw new Error("createWriteStream does not exist in the browser")}function writeFile(){throw new Error("writeFile does not exist in the browser")}function getType(e){return e.includes("/")||(e=`image/${e}`),e}function encodeJpeg(e,r={}){const t={width:e.width,height:e.height,data:e.getRGBAData()};return jpegJs.encode(t,r.quality).data}function encodePng(e,r){const t={width:e.width,height:e.height,channels:e.channels,depth:e.bitDepth,data:e.data};return(t.depth===1||t.depth===32)&&(t.depth=8,t.channels=4,t.data=e.getRGBAData()),encodePng$1(t,r)}const exportMethods={save(e,r={}){const{useCanvas:t=!1,encoder:o=void 0}=r;let{format:s}=r;if(!s){const d=/\.(?<format>[a-zA-Z]+)$/.exec(e);d&&(s=d.groups.format.toLowerCase())}if(!s)throw new Error("file format not provided");return new Promise((d,g)=>{let a,b;switch(s.toLowerCase()){case"png":{t?a=this.getCanvas().pngStream():b=encodePng(this,o);break}case"jpg":case"jpeg":t?a=this.getCanvas().jpegStream():b=encodeJpeg(this,o);break;case"bmp":b=encode$2(this,o);break;default:throw new RangeError(`invalid output format: ${s}`)}if(a){let _=createWriteStream();_.on("finish",d),_.on("error",g),a.pipe(_)}else b&&writeFile()})},toDataURL(e="image/png",r={}){typeof e=="object"&&(r=e,e="image/png");const{useCanvas:t=!1,encoder:o=void 0}=r;e=getType(e);function s(d,g){const a=d(g,o);return toBase64URL(a,e)}return e==="image/bmp"?s(encode$2,this):e==="image/png"&&!t?s(encodePng,this):e==="image/jpeg"&&!t?s(encodeJpeg,this):this.getCanvas().toDataURL(e)},toBuffer(e={}){const{format:r="png",encoder:t=void 0}=e;switch(r.toLowerCase()){case"png":return encodePng(this,t);case"jpeg":case"jpg":return encodeJpeg(this,t);case"bmp":return encode$2(this,t);default:throw new RangeError(`invalid output format: ${r}`)}},toBase64(e="image/png",r={}){if(r.async)return this.toDataURL(e,r).then(function(t){return t.substring(t.indexOf(",")+1)});{const t=this.toDataURL(e,r);return t.substring(t.indexOf(",")+1)}},toBlob(e="image/png",r=.8){return canvasToBlob(this.getCanvas(),e,r)},getCanvas(){const e=new ImageData(this.getRGBAData({clamped:!0}),this.width,this.height);let r=createCanvas(this.width,this.height);return r.getContext("2d").putImageData(e,0,0),r}};function setExportMethods(e){for(const r in exportMethods)e.prototype[r]=exportMethods[r]}var hasOwn$1={exports:{}};const name="has-own",version$1="1.0.1",description="A safer .hasOwnProperty() - hasOwn(name, obj)",main="index.js",scripts={test:"make test"},author="Aaron Heckmann <aaron.heckmann+github@gmail.com>",license="MIT",repository={type:"git",url:"git://github.com/aheckmann/has-own.git"},homepage="https://github.com/aheckmann/has-own/",devDependencies={mocha:"^6.2.2"},require$$0$3={name,version:version$1,description,main,scripts,author,license,repository,homepage,devDependencies};(function(e,r){var t=Object.prototype.hasOwnProperty;e.exports=r=function(s,d){return t.call(d,s)},r.version=require$$0$3.version})(hasOwn$1,hasOwn$1.exports);var hasOwnExports=hasOwn$1.exports;const hasOwn=getDefaultExportFromCjs(hasOwnExports);let computedPropertyDescriptor$1={configurable:!0,enumerable:!1,get:void 0};function extendMethod(e,r,t={}){let{inPlace:o=!1,returnThis:s=!0,partialArgs:d=[]}=t;return o?Image.prototype[e]=function(...g){this.computed=null;let a=r.apply(this,[...d,...g]);return s?this:a}:Image.prototype[e]=function(...g){return r.apply(this,[...d,...g])},Image}function extendProperty(e,r,t={}){let{partialArgs:o=[]}=t;return computedPropertyDescriptor$1.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(e,this.computed))return this.computed[e];let s=r.apply(this,o);return this.computed[e]=s,s},Object.defineProperty(Image.prototype,e,computedPropertyDescriptor$1),Image}const GREY$1="GREY",RGB$1="RGB",HSL="HSL",HSV="HSV",CMYK$1="CMYK",ColorModel=Object.freeze(Object.defineProperty({__proto__:null,CMYK:CMYK$1,GREY:GREY$1,HSL,HSV,RGB:RGB$1},Symbol.toStringTag,{value:"Module"}));function getRGBAData(e={}){const{clamped:r}=e;this.checkProcessable("getRGBAData",{components:[1,3],bitDepth:[1,8,16,32]});const t=this.width*this.height*4;let o=r?new Uint8ClampedArray(t):new Uint8Array(t);return this.bitDepth===1?fillDataFromBinary(this,o):this.bitDepth===32?(this.checkProcessable("getRGBAData",{alpha:0}),this.components===1?fillDataFromGrey32(this,o):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB32(this,o))):this.components===1?fillDataFromGrey(this,o):this.components===3&&(this.checkProcessable("getRGBAData",{colorModel:[RGB$1]}),fillDataFromRGB(this,o)),this.alpha===1?(this.checkProcessable("getRGBAData",{bitDepth:[8,16]}),copyAlpha(this,o)):fillAlpha(this,o),o}function fillDataFromBinary(e,r){for(let t=0;t<e.size;t++){const o=e.getBit(t);r[t*4]=o*255,r[t*4+1]=o*255,r[t*4+2]=o*255}}function fillDataFromGrey32(e,r){const t=e.min[0],s=e.max[0]-t;for(let d=0;d<e.size;d++){const g=Math.floor(255*(e.data[d]-t)/s);r[d*4]=g,r[d*4+1]=g,r[d*4+2]=g}}function fillDataFromRGB32(e,r){const t=Math.min(...e.min),s=Math.max(...e.max)-t;for(let d=0;d<e.size;d++){const g=Math.floor(255*(e.data[d*3]-t)/s),a=Math.floor(255*(e.data[d*3+1]-t)/s),b=Math.floor(255*(e.data[d*3+2]-t)/s);r[d*4]=g,r[d*4+1]=a,r[d*4+2]=b}}function fillDataFromGrey(e,r){for(let t=0;t<e.size;t++)r[t*4]=e.data[t*e.channels]>>>e.bitDepth-8,r[t*4+1]=e.data[t*e.channels]>>>e.bitDepth-8,r[t*4+2]=e.data[t*e.channels]>>>e.bitDepth-8}function fillDataFromRGB(e,r){for(let t=0;t<e.size;t++)r[t*4]=e.data[t*e.channels]>>>e.bitDepth-8,r[t*4+1]=e.data[t*e.channels+1]>>>e.bitDepth-8,r[t*4+2]=e.data[t*e.channels+2]>>>e.bitDepth-8}function copyAlpha(e,r){for(let t=0;t<e.size;t++)r[t*4+3]=e.data[t*e.channels+e.components]>>e.bitDepth-8}function fillAlpha(e,r){for(let t=0;t<e.size;t++)r[t*4+3]=255}const BINARY="BINARY",GREY="GREY",GREYA="GREYA",RGB="RGB",RGBA="RGBA",CMYK="CMYK",CMYKA="CMYKA",kinds={};kinds[BINARY]={components:1,alpha:0,bitDepth:1,colorModel:GREY$1};kinds[GREYA]={components:1,alpha:1,bitDepth:8,colorModel:GREY$1};kinds[GREY]={components:1,alpha:0,bitDepth:8,colorModel:GREY$1};kinds[RGBA]={components:3,alpha:1,bitDepth:8,colorModel:RGB$1};kinds[RGB]={components:3,alpha:0,bitDepth:8,colorModel:RGB$1};kinds[CMYK]={components:4,alpha:0,bitDepth:8,colorModel:CMYK$1};kinds[CMYKA]={components:4,alpha:1,bitDepth:8,colorModel:CMYK$1};function getKind(e){const r=kinds[e];if(!r)throw new RangeError(`invalid image kind: ${e}`);return r}const validBitDepth=[1,8,16,32];function verifyKindDefinition(e){const{components:r,alpha:t,bitDepth:o,colorModel:s}=e;if(!Number.isInteger(r)||r<=0)throw new RangeError(`invalid components: ${r}. Must be a positive integer`);if(t!==0&&t!==1&&typeof t!="boolean")throw new TypeError(`invalid alpha: ${t}: must be a boolean, 0 or 1`);if(!validBitDepth.includes(o))throw new RangeError(`invalid bitDepth: ${o}. Must be one of ${validBitDepth.join(", ")}`);if(!ColorModel[s])throw new RangeError(`invalid colorModel: ${s}. Must be one of ${Object.keys(ColorModel).join(", ")}`)}function getTheoreticalPixelArraySize(e,r,t){let o=r*e;return t===1&&(o=Math.ceil(o/8)),o}function createPixelArray(e,r,t,o,s,d){const g=o*e;let a;switch(s){case 1:a=new Uint8Array(Math.ceil(g/8));break;case 8:a=new Uint8Array(g);break;case 16:a=new Uint16Array(g);break;case 32:a=new Float32Array(g);break;default:throw new Error(`Cannot create pixel array for bit depth ${s}`)}if(t)for(let b=r;b<a.length;b+=o)a[b]=d;return a}const defaultByteLength=1024*8,charArray=[];let IOBuffer$2=class{constructor(r,t){t=t||{},r===void 0&&(r=defaultByteLength),typeof r=="number"&&(r=new ArrayBuffer(r));let o=r.byteLength;const s=t.offset?t.offset>>>0:0;r.buffer&&(o=r.byteLength-s,r.byteLength!==r.buffer.byteLength?r=r.buffer.slice(r.byteOffset+s,r.byteOffset+r.byteLength):s?r=r.buffer.slice(s):r=r.buffer),this.buffer=r,this.length=o,this.byteLength=o,this.byteOffset=0,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer),this._increment=o||defaultByteLength,this._mark=0}available(r){return r===void 0&&(r=1),this.offset+r<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){this.littleEndian=!0}isBigEndian(){return!this.littleEndian}setBigEndian(){this.littleEndian=!1}skip(r){r===void 0&&(r=1),this.offset+=r}seek(r){this.offset=r}mark(){this._mark=this.offset}reset(){this.offset=this._mark}rewind(){this.offset=0}ensureAvailable(r){if(r===void 0&&(r=1),!this.available(r)){const t=this._increment+this._increment;this._increment=t;const o=this.length+t,s=new Uint8Array(o);s.set(new Uint8Array(this.buffer)),this.buffer=s.buffer,this.length=o,this._data=new DataView(this.buffer)}}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(r){r===void 0&&(r=1);for(var t=new Uint8Array(r),o=0;o<r;o++)t[o]=this.readByte();return t}readInt16(){var r=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,r}readUint16(){var r=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,r}readInt32(){var r=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,r}readUint32(){var r=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,r}readFloat32(){var r=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,r}readFloat64(){var r=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,r}readChar(){return String.fromCharCode(this.readInt8())}readChars(r){r===void 0&&(r=1),charArray.length=r;for(var t=0;t<r;t++)charArray[t]=this.readChar();return charArray.join("")}writeBoolean(r){this.writeUint8(r?255:0)}writeInt8(r){this.ensureAvailable(1),this._data.setInt8(this.offset++,r)}writeUint8(r){this.ensureAvailable(1),this._data.setUint8(this.offset++,r)}writeByte(r){this.writeUint8(r)}writeBytes(r){this.ensureAvailable(r.length);for(var t=0;t<r.length;t++)this._data.setUint8(this.offset++,r[t])}writeInt16(r){this.ensureAvailable(2),this._data.setInt16(this.offset,r,this.littleEndian),this.offset+=2}writeUint16(r){this.ensureAvailable(2),this._data.setUint16(this.offset,r,this.littleEndian),this.offset+=2}writeInt32(r){this.ensureAvailable(4),this._data.setInt32(this.offset,r,this.littleEndian),this.offset+=4}writeUint32(r){this.ensureAvailable(4),this._data.setUint32(this.offset,r,this.littleEndian),this.offset+=4}writeFloat32(r){this.ensureAvailable(4),this._data.setFloat32(this.offset,r,this.littleEndian),this.offset+=4}writeFloat64(r){this.ensureAvailable(8),this._data.setFloat64(this.offset,r,this.littleEndian),this.offset+=8}writeChar(r){this.writeUint8(r.charCodeAt(0))}writeChars(r){for(var t=0;t<r.length;t++)this.writeUint8(r.charCodeAt(t))}toArray(){return new Uint8Array(this.buffer,0,this.offset)}};var IOBuffer_1=IOBuffer$2,src$4={};const tagsById$5={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName$5={};for(var i$2 in tagsById$5)tagsByName$5[tagsById$5[i$2]]=i$2;var standard$1={tagsById:tagsById$5,tagsByName:tagsByName$5};const tagsById$4={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$4={};for(var i$1 in tagsById$4)tagsByName$4[tagsById$4[i$1]]=i$1;var exif$1={tagsById:tagsById$4,tagsByName:tagsByName$4};const tagsById$3={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$3={};for(var i in tagsById$3)tagsByName$3[tagsById$3[i]]=i;var gps$1={tagsById:tagsById$3,tagsByName:tagsByName$3};const tags$1={standard:standard$1,exif:exif$1,gps:gps$1};let IFD$2=class{constructor(r){if(!r)throw new Error("missing kind");this.data=null,this.fields=new Map,this.kind=r,this._map=null}get(r){if(typeof r=="number")return this.fields.get(r);if(typeof r=="string")return this.fields.get(tags$1[this.kind].tagsByName[r]);throw new Error("expected a number or string")}get map(){if(!this._map){this._map={};const t=tags$1[this.kind].tagsById;for(var r of this.fields.keys())t[r]&&(this._map[t[r]]=this.fields.get(r))}return this._map}};var ifd=IFD$2;const Ifd=ifd,dateTimeRegex$1=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;let TiffIfd$1=class extends Ifd{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){var r=new Date,t=dateTimeRegex$1.exec(this.dateTime);return r.setFullYear(t[1],t[2]-1,t[3]),r.setHours(t[4],t[5],t[6]),r}get newSubfileType(){return this.get(254)}get imageWidth(){return this.get(256)}get imageLength(){return this.get(257)}get bitsPerSample(){return this.get(258)}get compression(){return this.get(259)||1}get type(){return this.get(262)}get fillOrder(){return this.get(266)||1}get documentName(){return this.get(269)}get imageDescription(){return this.get(270)}get stripOffsets(){return alwaysArray$1(this.get(273))}get orientation(){return this.get(274)}get samplesPerPixel(){return this.get(277)}get rowsPerStrip(){return this.get(278)}get stripByteCounts(){return alwaysArray$1(this.get(279))}get minSampleValue(){return this.get(280)||0}get maxSampleValue(){return this.get(281)||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get(282)}get yResolution(){return this.get(283)}get planarConfiguration(){return this.get(284)||1}get resolutionUnit(){return this.get(296)||2}get dateTime(){return this.get(306)}get predictor(){return this.get(317)||1}get sampleFormat(){return this.get(339)||1}get sMinSampleValue(){return this.get(340)||this.minSampleValue}get sMaxSampleValue(){return this.get(341)||this.maxSampleValue}};function alwaysArray$1(e){return typeof e=="number"?[e]:e}var tiffIfd=TiffIfd$1,ifdValue={},types$1=new Map([[1,[1,readByte$1]],[2,[1,readASCII$1]],[3,[2,readShort$1]],[4,[4,readLong$1]],[5,[8,readRational$1]],[6,[1,readSByte$1]],[7,[1,readByte$1]],[8,[2,readSShort$1]],[9,[4,readSLong$1]],[10,[8,readSRational$1]],[11,[4,readFloat$1]],[12,[8,readDouble$1]]]);ifdValue.getByteLength=function(e,r){return types$1.get(e)[0]*r};ifdValue.readData=function(e,r,t){return types$1.get(r)[1](e,t)};function readByte$1(e,r){if(r===1)return e.readUint8();for(var t=new Uint8Array(r),o=0;o<r;o++)t[o]=e.readUint8();return t}function readASCII$1(e,r){for(var t=[],o="",s=0;s<r;s++){var d=String.fromCharCode(e.readUint8());d==="\0"?(t.push(o),o=""):o+=d}return t.length===1?t[0]:t}function readShort$1(e,r){if(r===1)return e.readUint16();for(var t=new Uint16Array(r),o=0;o<r;o++)t[o]=e.readUint16();return t}function readLong$1(e,r){if(r===1)return e.readUint32();for(var t=new Uint32Array(r),o=0;o<r;o++)t[o]=e.readUint32();return t}function readRational$1(e,r){if(r===1)return e.readUint32()/e.readUint32();for(var t=new Array(r),o=0;o<r;o++)t[o]=e.readUint32()/e.readUint32();return t}function readSByte$1(e,r){if(r===1)return e.readInt8();for(var t=new Int8Array(r),o=0;o<r;o++)t[o]=e.readInt8();return t}function readSShort$1(e,r){if(r===1)return e.readInt16();for(var t=new Int16Array(r),o=0;o<r;o++)t[o]=e.readInt16();return t}function readSLong$1(e,r){if(r===1)return e.readInt32();for(var t=new Int32Array(r),o=0;o<r;o++)t[o]=e.readInt32();return t}function readSRational$1(e,r){if(r===1)return e.readInt32()/e.readInt32();for(var t=new Array(r),o=0;o<r;o++)t[o]=e.readInt32()/e.readInt32();return t}function readFloat$1(e,r){if(r===1)return e.readFloat32();for(var t=new Float32Array(r),o=0;o<r;o++)t[o]=e.readFloat32();return t}function readDouble$1(e,r){if(r===1)return e.readFloat64();for(var t=new Float64Array(r),o=0;o<r;o++)t[o]=e.readFloat64();return t}const IOBuffer$1=IOBuffer_1,IFD$1=ifd,TiffIFD=tiffIfd,IFDValue=ifdValue,defaultOptions$d={ignoreImageData:!1,onlyFirst:!1};let TIFFDecoder$2=class extends IOBuffer$1{constructor(r,t){super(r,t),this._nextIFD=0}decode(r){r=Object.assign({},defaultOptions$d,r);const t=[];for(this.decodeHeader();this._nextIFD;)if(t.push(this.decodeIFD(r)),r.onlyFirst)return t[0];return t}decodeHeader(){let r=this.readUint16();if(r===18761)this.setLittleEndian();else if(r===19789)this.setBigEndian();else throw new Error("invalid byte order: 0x"+r.toString(16));if(r=this.readUint16(),r!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(r){this.seek(this._nextIFD);var t;r.kind?t=new IFD$1(r.kind):t=new TiffIFD;const o=this.readUint16();for(var s=0;s<o;s++)this.decodeIFDEntry(t);return r.ignoreImageData||this.decodeImageData(t),this._nextIFD=this.readUint32(),t}decodeIFDEntry(r){const t=this.offset,o=this.readUint16(),s=this.readUint16(),d=this.readUint32();if(s<1||s>12){this.skip(4);return}IFDValue.getByteLength(s,d)>4&&this.seek(this.readUint32());const a=IFDValue.readData(this,s,d);if(r.fields.set(o,a),o===34665||o===34853){let b=this.offset,_;o===34665?_="exif":o===34853&&(_="gps"),this._nextIFD=a,r[_]=this.decodeIFD({kind:_,ignoreImageData:!0}),this.offset=b}this.seek(t),this.skip(12)}decodeImageData(r){const t=r.orientation;switch(t&&t!==1&&unsupported$1("orientation",t),r.type){case 1:case 2:this.readStripData(r);break;default:unsupported$1("image type",r.type);break}}readStripData(r){const t=r.width,o=r.height,s=validateBitDepth(r.bitsPerSample),d=r.sampleFormat;let g=t*o;const a=getDataArray$1(g,1,s,d),b=r.compression,T=r.rowsPerStrip*t,C=r.stripOffsets,D=r.stripByteCounts;for(var k=0,O=0;O<C.length;O++){var U=this.getStripData(b,C[O],D[O]),G=g>T?T:g;g-=G,s===8?k=fill8bit$1(a,U,k,G):s===16?k=fill16bit$1(a,U,k,G,this.isLittleEndian()):s===32&&d===3?k=fillFloat32$1(a,U,k,G,this.isLittleEndian()):unsupported$1("bitDepth",s)}r.data=a}getStripData(r,t,o){switch(r){case 1:return new DataView(this.buffer,t,o);case 2:case 32773:return unsupported$1("Compression",r);default:throw new Error("invalid compression: "+r)}}};var tiffDecoder=TIFFDecoder$2;function getDataArray$1(e,r,t,o){return t===8?new Uint8Array(e*r):t===16?new Uint16Array(e*r):t===32&&o===3?new Float32Array(e*r):unsupported$1("bit depth / sample format",t+" / "+o)}function fill8bit$1(e,r,t,o){for(var s=0;s<o;s++)e[t++]=r.getUint8(s);return t}function fill16bit$1(e,r,t,o,s){for(var d=0;d<o*2;d+=2)e[t++]=r.getUint16(d,s);return t}function fillFloat32$1(e,r,t,o,s){for(var d=0;d<o*4;d+=4)e[t++]=r.getFloat32(d,s);return t}function unsupported$1(e,r){throw new Error("Unsupported "+e+": "+r)}function validateBitDepth(e){if(e.length){const t=e;e=t[0];for(var r=0;r<t.length;r++)t[r]!==e&&unsupported$1("bit depth",t)}return e}const TIFFDecoder$1=tiffDecoder;var decode$2=function(r,t){return new TIFFDecoder$1(r,t).decode(t)};src$4.decode=decode$2;const IOBuffer=IOBuffer_1,tiff=src$4;function decode$1(e){const r=new IOBuffer(e),t={};if(r.setBigEndian(),r.readUint16()!==65496)throw new Error("SOI marker not found. Not a valid JPEG file");if(r.readUint16()===65505){r.readUint16();const d=r.readBytes(6);if(d[0]===69&&d[1]===120&&d[2]===105&&d[3]===102&&d[4]===0&&d[5]===0){const g=tiff.decode(r,{onlyFirst:!0,ignoreImageData:!0,offset:r.offset});t.exif=g}}return t}var decode_1=decode$1,decode=decode_1,imageType$2={exports:{}},fileType$1={exports:{}};(function(module){const toBytes=e=>[...e].map(r=>r.charCodeAt(0)),xpiZipFilename=toBytes("META-INF/mozilla.rsa"),oxmlContentTypes=toBytes("[Content_Types].xml"),oxmlRels=toBytes("_rels/.rels");function readUInt64LE(e,r=0){let t=e[r],o=1,s=0;for(;++s<8;)o*=256,t+=e[r+s]*o;return t}const fileType=e=>{if(!(e instanceof Uint8Array||e instanceof ArrayBuffer||Buffer.isBuffer(e)))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`Buffer\` or \`ArrayBuffer\`, got \`${typeof e}\``);const r=e instanceof Uint8Array?e:new Uint8Array(e);if(!(r&&r.length>1))return null;const t=(s,d)=>{d=Object.assign({offset:0},d);for(let g=0;g<s.length;g++)if(d.mask){if(s[g]!==(d.mask[g]&r[g+d.offset]))return!1}else if(s[g]!==r[g+d.offset])return!1;return!0},o=(s,d)=>t(toBytes(s),d);if(t([255,216,255]))return{ext:"jpg",mime:"image/jpeg"};if(t([137,80,78,71,13,10,26,10]))return{ext:"png",mime:"image/png"};if(t([71,73,70]))return{ext:"gif",mime:"image/gif"};if(t([87,69,66,80],{offset:8}))return{ext:"webp",mime:"image/webp"};if(t([70,76,73,70]))return{ext:"flif",mime:"image/flif"};if((t([73,73,42,0])||t([77,77,0,42]))&&t([67,82],{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(t([73,73,42,0])||t([77,77,0,42]))return{ext:"tif",mime:"image/tiff"};if(t([66,77]))return{ext:"bmp",mime:"image/bmp"};if(t([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(t([56,66,80,83]))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(t([80,75,3,4])){if(t([109,105,109,101,116,121,112,101,97,112,112,108,105,99,97,116,105,111,110,47,101,112,117,98,43,122,105,112],{offset:30}))return{ext:"epub",mime:"application/epub+zip"};if(t(xpiZipFilename,{offset:30}))return{ext:"xpi",mime:"application/x-xpinstall"};if(o("mimetypeapplication/vnd.oasis.opendocument.text",{offset:30}))return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};if(o("mimetypeapplication/vnd.oasis.opendocument.spreadsheet",{offset:30}))return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};if(o("mimetypeapplication/vnd.oasis.opendocument.presentation",{offset:30}))return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};const s=(b,_=0)=>b.findIndex((T,C,D)=>C>=_&&D[C]===80&&D[C+1]===75&&D[C+2]===3&&D[C+3]===4);let d=0,g=!1,a=null;do{const b=d+30;if(g||(g=t(oxmlContentTypes,{offset:b})||t(oxmlRels,{offset:b})),a||(o("word/",{offset:b})?a={ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}:o("ppt/",{offset:b})?a={ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}:o("xl/",{offset:b})&&(a={ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),g&&a)return a;d=s(r,b)}while(d>=0);if(a)return a}if(t([80,75])&&(r[2]===3||r[2]===5||r[2]===7)&&(r[3]===4||r[3]===6||r[3]===8))return{ext:"zip",mime:"application/zip"};if(t([117,115,116,97,114],{offset:257}))return{ext:"tar",mime:"application/x-tar"};if(t([82,97,114,33,26,7])&&(r[6]===0||r[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(t([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(t([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(t([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(t([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(t([51,103,112,53])||t([0,0,0])&&t([102,116,121,112],{offset:4})&&(t([109,112,52,49],{offset:8})||t([109,112,52,50],{offset:8})||t([105,115,111,109],{offset:8})||t([105,115,111,50],{offset:8})||t([109,109,112,52],{offset:8})||t([77,52,86],{offset:8})||t([100,97,115,104],{offset:8})))return{ext:"mp4",mime:"video/mp4"};if(t([77,84,104,100]))return{ext:"mid",mime:"audio/midi"};if(t([26,69,223,163])){const s=r.subarray(4,4100),d=s.findIndex((g,a,b)=>b[a]===66&&b[a+1]===130);if(d!==-1){const g=d+3,a=b=>[...b].every((_,T)=>s[g+T]===_.charCodeAt(0));if(a("matroska"))return{ext:"mkv",mime:"video/x-matroska"};if(a("webm"))return{ext:"webm",mime:"video/webm"}}}if(t([0,0,0,20,102,116,121,112,113,116,32,32])||t([102,114,101,101],{offset:4})||t([102,116,121,112,113,116,32,32],{offset:4})||t([109,100,97,116],{offset:4})||t([109,111,111,118],{offset:4})||t([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(t([82,73,70,70])){if(t([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(t([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/vnd.wave"};if(t([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(t([48,38,178,117,142,102,207,17,166,217])){let s=30;do{const d=readUInt64LE(r,s+16);if(t([145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101],{offset:s})){if(t([64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43],{offset:s+24}))return{ext:"wma",mime:"audio/x-ms-wma"};if(t([192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43],{offset:s+24}))return{ext:"wmv",mime:"video/x-ms-asf"};break}s+=d}while(s+24<=r.length);return{ext:"asf",mime:"application/vnd.ms-asf"}}if(t([0,0,1,186])||t([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(t([102,116,121,112,51,103],{offset:4}))return{ext:"3gp",mime:"video/3gpp"};for(let s=0;s<2&&s<r.length-16;s++){if(t([73,68,51],{offset:s})||t([255,226],{offset:s,mask:[255,226]}))return{ext:"mp3",mime:"audio/mpeg"};if(t([255,228],{offset:s,mask:[255,228]}))return{ext:"mp2",mime:"audio/mpeg"};if(t([255,248],{offset:s,mask:[255,252]}))return{ext:"mp2",mime:"audio/mpeg"};if(t([255,240],{offset:s,mask:[255,252]}))return{ext:"mp4",mime:"audio/mpeg"}}if(t([102,116,121,112,77,52,65],{offset:4}))return{ext:"m4a",mime:"audio/mp4"};if(t([79,112,117,115,72,101,97,100],{offset:28}))return{ext:"opus",mime:"audio/opus"};if(t([79,103,103,83]))return t([128,116,104,101,111,114,97],{offset:28})?{ext:"ogv",mime:"video/ogg"}:t([1,118,105,100,101,111,0],{offset:28})?{ext:"ogm",mime:"video/ogg"}:t([127,70,76,65,67],{offset:28})?{ext:"oga",mime:"audio/ogg"}:t([83,112,101,101,120,32,32],{offset:28})?{ext:"spx",mime:"audio/ogg"}:t([1,118,111,114,98,105,115],{offset:28})?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"};if(t([102,76,97,67]))return{ext:"flac",mime:"audio/x-flac"};if(t([77,65,67,32]))return{ext:"ape",mime:"audio/ape"};if(t([119,118,112,107]))return{ext:"wv",mime:"audio/wavpack"};if(t([35,33,65,77,82,10]))return{ext:"amr",mime:"audio/amr"};if(t([37,80,68,70]))return{ext:"pdf",mime:"application/pdf"};if(t([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if((r[0]===67||r[0]===70)&&t([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(t([123,92,114,116,102]))return{ext:"rtf",mime:"application/rtf"};if(t([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(t([119,79,70,70])&&(t([0,1,0,0],{offset:4})||t([79,84,84,79],{offset:4})))return{ext:"woff",mime:"font/woff"};if(t([119,79,70,50])&&(t([0,1,0,0],{offset:4})||t([79,84,84,79],{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(t([76,80],{offset:34})&&(t([0,0,1],{offset:8})||t([1,0,2],{offset:8})||t([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(t([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(t([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(t([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(t([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(t([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(t([37,33]))return{ext:"ps",mime:"application/postscript"};if(t([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(t([83,81,76,105]))return{ext:"sqlite",mime:"application/x-sqlite3"};if(t([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(t([67,114,50,52]))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(t([77,83,67,70])||t([73,83,99,40]))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(t([33,60,97,114,99,104,62,10,100,101,98,105,97,110,45,98,105,110,97,114,121]))return{ext:"deb",mime:"application/x-deb"};if(t([33,60,97,114,99,104,62]))return{ext:"ar",mime:"application/x-unix-archive"};if(t([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(t([31,160])||t([31,157]))return{ext:"Z",mime:"application/x-compress"};if(t([76,90,73,80]))return{ext:"lz",mime:"application/x-lzip"};if(t([208,207,17,224,161,177,26,225]))return{ext:"msi",mime:"application/x-msi"};if(t([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(t([71],{offset:4})&&(t([71],{offset:192})||t([71],{offset:196})))return{ext:"mts",mime:"video/mp2t"};if(t([66,76,69,78,68,69,82]))return{ext:"blend",mime:"application/x-blender"};if(t([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(t([0,0,0,12,106,80,32,32,13,10,135,10])){if(t([106,112,50,32],{offset:20}))return{ext:"jp2",mime:"image/jp2"};if(t([106,112,120,32],{offset:20}))return{ext:"jpx",mime:"image/jpx"};if(t([106,112,109,32],{offset:20}))return{ext:"jpm",mime:"image/jpm"};if(t([109,106,112,50],{offset:20}))return{ext:"mj2",mime:"image/mj2"}}if(t([70,79,82,77]))return{ext:"aif",mime:"audio/aiff"};if(o("<?xml "))return{ext:"xml",mime:"application/xml"};if(t([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(t([102,116,121,112],{offset:4})){if(t([109,105,102,49],{offset:8}))return{ext:"heic",mime:"image/heif"};if(t([109,115,102,49],{offset:8}))return{ext:"heic",mime:"image/heif-sequence"};if(t([104,101,105,99],{offset:8})||t([104,101,105,120],{offset:8}))return{ext:"heic",mime:"image/heic"};if(t([104,101,118,99],{offset:8})||t([104,101,118,120],{offset:8}))return{ext:"heic",mime:"image/heic-sequence"}}return t([171,75,84,88,32,49,49,187,13,10,26,10])?{ext:"ktx",mime:"image/ktx"}:t([68,73,67,77],{offset:128})?{ext:"dcm",mime:"application/dicom"}:t([77,80,43])?{ext:"mpc",mime:"audio/x-musepack"}:t([77,80,67,75])?{ext:"mpc",mime:"audio/x-musepack"}:t([66,69,71,73,78,58])?{ext:"ics",mime:"text/calendar"}:t([103,108,84,70,2,0,0,0])?{ext:"glb",mime:"model/gltf-binary"}:t([212,195,178,161])||t([161,178,195,212])?{ext:"pcap",mime:"application/vnd.tcpdump.pcap"}:null};module.exports=fileType,module.exports.default=fileType,Object.defineProperty(fileType,"minimumBytes",{value:4100}),module.exports.stream=readableStream=>new Promise((resolve,reject)=>{const stream=eval("require")("stream");readableStream.once("readable",()=>{const e=new stream.PassThrough,r=readableStream.read(module.exports.minimumBytes)||readableStream.read();try{e.fileType=fileType(r)}catch(t){reject(t)}readableStream.unshift(r),stream.pipeline?resolve(stream.pipeline(readableStream,e,()=>{})):resolve(readableStream.pipe(e))})})})(fileType$1);var fileTypeExports=fileType$1.exports;const fileType=fileTypeExports,imageExts=new Set(["jpg","png","gif","webp","flif","cr2","tif","bmp","jxr","psd","ico","bpg","jp2","jpm","jpx","heic","cur","dcm"]),imageType=e=>{const r=fileType(e);return imageExts.has(r&&r.ext)?r:null};imageType$2.exports=imageType;imageType$2.exports.default=imageType;Object.defineProperty(imageType,"minimumBytes",{value:fileType.minimumBytes});var imageTypeExports=imageType$2.exports;const imageType$1=getDefaultExportFromCjs(imageTypeExports);function guessStripByteCounts(e){if(e.compression!==1)throw new Error("missing mandatory StripByteCounts field in compressed image");const r=e.rowsPerStrip*e.width*e.samplesPerPixel*(e.bitsPerSample/8);return new Array(e.stripOffsets.length).fill(r)}function applyHorizontalDifferencing8Bit(e,r,t){let o=0;for(;o<e.length;){for(let s=t;s<r*t;s+=t)for(let d=0;d<t;d++)e[o+s+d]=e[o+s+d]+e[o+s-(t-d)]&255;o+=r*t}}function applyHorizontalDifferencing16Bit(e,r,t){let o=0;for(;o<e.length;){for(let s=t;s<r*t;s+=t)for(let d=0;d<t;d++)e[o+s+d]=e[o+s+d]+e[o+s-(t-d)]&65535;o+=r*t}}const tagsById$2={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$2={};for(let e in tagsById$2)tagsByName$2[tagsById$2[e]]=Number(e);const exif=Object.freeze(Object.defineProperty({__proto__:null,tagsById:tagsById$2,tagsByName:tagsByName$2},Symbol.toStringTag,{value:"Module"})),tagsById$1={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$1={};for(let e in tagsById$1)tagsByName$1[tagsById$1[e]]=Number(e);const gps=Object.freeze(Object.defineProperty({__proto__:null,tagsById:tagsById$1,tagsByName:tagsByName$1},Symbol.toStringTag,{value:"Module"})),tagsById={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName={};for(let e in tagsById)tagsByName[tagsById[e]]=Number(e);const standard=Object.freeze(Object.defineProperty({__proto__:null,tagsById,tagsByName},Symbol.toStringTag,{value:"Module"})),tags={standard,exif,gps};class IFD{constructor(r){if(!r)throw new Error("missing kind");this.data=new Uint8Array,this.fields=new Map,this.kind=r,this._hasMap=!1,this._map={}}get(r){if(typeof r=="number")return this.fields.get(r);if(typeof r=="string")return this.fields.get(tags[this.kind].tagsByName[r]);throw new Error("expected a number or string")}get map(){if(!this._hasMap){const r=tags[this.kind].tagsById;for(let t of this.fields.keys())r[t]&&(this._map[r[t]]=this.fields.get(t));this._hasMap=!0}return this._map}}let types=new Map([[1,[1,readByte]],[2,[1,readASCII]],[3,[2,readShort]],[4,[4,readLong]],[5,[8,readRational]],[6,[1,readSByte]],[7,[1,readByte]],[8,[2,readSShort]],[9,[4,readSLong]],[10,[8,readSRational]],[11,[4,readFloat]],[12,[8,readDouble]]]);function getByteLength(e,r){const t=types.get(e);if(!t)throw new Error(`type not found: ${e}`);return t[0]*r}function readData(e,r,t){const o=types.get(r);if(!o)throw new Error(`type not found: ${r}`);return o[1](e,t)}function readByte(e,r){if(r===1)return e.readUint8();let t=new Uint8Array(r);for(let o=0;o<r;o++)t[o]=e.readUint8();return t}function readASCII(e,r){let t=[],o="";for(let s=0;s<r;s++){let d=String.fromCharCode(e.readUint8());d==="\0"?(t.push(o),o=""):o+=d}return t.length===1?t[0]:t}function readShort(e,r){if(r===1)return e.readUint16();let t=new Uint16Array(r);for(let o=0;o<r;o++)t[o]=e.readUint16();return t}function readLong(e,r){if(r===1)return e.readUint32();let t=new Uint32Array(r);for(let o=0;o<r;o++)t[o]=e.readUint32();return t}function readRational(e,r){if(r===1)return e.readUint32()/e.readUint32();let t=new Array(r);for(let o=0;o<r;o++)t[o]=e.readUint32()/e.readUint32();return t}function readSByte(e,r){if(r===1)return e.readInt8();let t=new Int8Array(r);for(let o=0;o<r;o++)t[o]=e.readInt8();return t}function readSShort(e,r){if(r===1)return e.readInt16();let t=new Int16Array(r);for(let o=0;o<r;o++)t[o]=e.readInt16();return t}function readSLong(e,r){if(r===1)return e.readInt32();let t=new Int32Array(r);for(let o=0;o<r;o++)t[o]=e.readInt32();return t}function readSRational(e,r){if(r===1)return e.readInt32()/e.readInt32();let t=new Array(r);for(let o=0;o<r;o++)t[o]=e.readInt32()/e.readInt32();return t}function readFloat(e,r){if(r===1)return e.readFloat32();let t=new Float32Array(r);for(let o=0;o<r;o++)t[o]=e.readFloat32();return t}function readDouble(e,r){if(r===1)return e.readFloat64();let t=new Float64Array(r);for(let o=0;o<r;o++)t[o]=e.readFloat64();return t}const CLEAR_CODE=256,EOI_CODE=257,TABLE_START=258,MIN_BIT_LENGTH=9;let stringTable=[];function initializeStringTable(){if(stringTable.length===0){for(let r=0;r<256;r++)stringTable.push([r]);const e=[];for(let r=256;r<4096;r++)stringTable.push(e)}}const andTable=[511,1023,2047,4095],bitJumps=[0,0,0,0,0,0,0,0,0,511,1023,2047,4095];class LzwDecoder{constructor(r){this.nextData=0,this.nextBits=0,this.bytePointer=0,this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH,this.stripArray=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),this.outData=new IOBuffer$4(r.byteLength),this.initializeTable()}decode(){let r=0,t=0;for(;(r=this.getNextCode())!==EOI_CODE;)if(r===CLEAR_CODE){if(this.initializeTable(),r=this.getNextCode(),r===EOI_CODE)break;this.writeString(this.stringFromCode(r)),t=r}else if(this.isInTable(r))this.writeString(this.stringFromCode(r)),this.addStringToTable(this.stringFromCode(t).concat(this.stringFromCode(r)[0])),t=r;else{const s=this.stringFromCode(t).concat(this.stringFromCode(t)[0]);this.writeString(s),this.addStringToTable(s),t=r}const o=this.outData.toArray();return new DataView(o.buffer,o.byteOffset,o.byteLength)}initializeTable(){initializeStringTable(),this.tableLength=TABLE_START,this.currentBitLength=MIN_BIT_LENGTH}writeString(r){this.outData.writeBytes(r)}stringFromCode(r){return stringTable[r]}isInTable(r){return r<this.tableLength}addStringToTable(r){if(stringTable[this.tableLength++]=r,stringTable.length>4096)throw stringTable=[],new Error("LZW decoding error. Please open an issue at https://github.com/image-js/tiff/issues/new/choose (include a test image).");this.tableLength===bitJumps[this.currentBitLength]&&this.currentBitLength++}getNextCode(){this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8,this.nextBits<this.currentBitLength&&(this.nextData=this.nextData<<8|this.stripArray[this.bytePointer++]&255,this.nextBits+=8);const r=this.nextData>>this.nextBits-this.currentBitLength&andTable[this.currentBitLength-9];return this.nextBits-=this.currentBitLength,this.bytePointer>this.stripArray.length?257:r}}function decompressLzw(e){return new LzwDecoder(e).decode()}const dateTimeRegex=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd extends IFD{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){let r=new Date,t=dateTimeRegex.exec(this.dateTime);if(t===null)throw new Error(`invalid dateTime: ${this.dateTime}`);return r.setFullYear(Number(t[1]),Number(t[2])-1,Number(t[3])),r.setHours(Number(t[4]),Number(t[5]),Number(t[6])),r}get newSubfileType(){return this.get("NewSubfileType")}get imageWidth(){return this.get("ImageWidth")}get imageLength(){return this.get("ImageLength")}get bitsPerSample(){const r=this.get("BitsPerSample");return r&&typeof r!="number"?r[0]:r}get alpha(){const r=this.extraSamples;return r?r[0]!==0:!1}get associatedAlpha(){const r=this.extraSamples;return r?r[0]===1:!1}get extraSamples(){return alwaysArray(this.get("ExtraSamples"))}get compression(){return this.get("Compression")||1}get type(){return this.get("PhotometricInterpretation")}get fillOrder(){return this.get("FillOrder")||1}get documentName(){return this.get("DocumentName")}get imageDescription(){return this.get("ImageDescription")}get stripOffsets(){return alwaysArray(this.get("StripOffsets"))}get orientation(){return this.get("Orientation")}get samplesPerPixel(){return this.get("SamplesPerPixel")||1}get rowsPerStrip(){return this.get("RowsPerStrip")}get stripByteCounts(){return alwaysArray(this.get("StripByteCounts"))}get minSampleValue(){return this.get("MinSampleValue")||0}get maxSampleValue(){return this.get("MaxSampleValue")||Math.pow(2,this.bitsPerSample)-1}get xResolution(){return this.get("XResolution")}get yResolution(){return this.get("YResolution")}get planarConfiguration(){return this.get("PlanarConfiguration")||1}get resolutionUnit(){return this.get("ResolutionUnit")||2}get dateTime(){return this.get("DateTime")}get predictor(){return this.get("Predictor")||1}get sampleFormat(){return this.get("SampleFormat")||1}get sMinSampleValue(){return this.get("SMinSampleValue")||this.minSampleValue}get sMaxSampleValue(){return this.get("SMaxSampleValue")||this.maxSampleValue}get palette(){const r=2**this.bitsPerSample,t=this.get("ColorMap");if(!t)return;if(t.length!==3*r)throw new Error(`ColorMap size must be ${r}`);const o=[];for(let s=0;s<r;s++)o.push([t[s],t[s+r],t[s+2*r]]);return o}}function alwaysArray(e){return typeof e=="number"?[e]:e}/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const Z_FIXED$1=4,Z_BINARY=0,Z_TEXT=1,Z_UNKNOWN$1=2;function zero$1(e){let r=e.length;for(;--r>=0;)e[r]=0}const STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,MIN_MATCH$1=3,MAX_MATCH$1=258,LENGTH_CODES$1=29,LITERALS$1=256,L_CODES$1=LITERALS$1+1+LENGTH_CODES$1,D_CODES$1=30,BL_CODES$1=19,HEAP_SIZE$1=2*L_CODES$1+1,MAX_BITS$1=15,Buf_size=16,MAX_BL_BITS=7,END_BLOCK=256,REP_3_6=16,REPZ_3_10=17,REPZ_11_138=18,extra_lbits=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),extra_dbits=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),extra_blbits=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),bl_order=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),DIST_CODE_LEN=512,static_ltree=new Array((L_CODES$1+2)*2);zero$1(static_ltree);const static_dtree=new Array(D_CODES$1*2);zero$1(static_dtree);const _dist_code=new Array(DIST_CODE_LEN);zero$1(_dist_code);const _length_code=new Array(MAX_MATCH$1-MIN_MATCH$1+1);zero$1(_length_code);const base_length=new Array(LENGTH_CODES$1);zero$1(base_length);const base_dist=new Array(D_CODES$1);zero$1(base_dist);function StaticTreeDesc(e,r,t,o,s){this.static_tree=e,this.extra_bits=r,this.extra_base=t,this.elems=o,this.max_length=s,this.has_stree=e&&e.length}let static_l_desc,static_d_desc,static_bl_desc;function TreeDesc(e,r){this.dyn_tree=e,this.max_code=0,this.stat_desc=r}const d_code=e=>e<256?_dist_code[e]:_dist_code[256+(e>>>7)],put_short=(e,r)=>{e.pending_buf[e.pending++]=r&255,e.pending_buf[e.pending++]=r>>>8&255},send_bits=(e,r,t)=>{e.bi_valid>Buf_size-t?(e.bi_buf|=r<<e.bi_valid&65535,put_short(e,e.bi_buf),e.bi_buf=r>>Buf_size-e.bi_valid,e.bi_valid+=t-Buf_size):(e.bi_buf|=r<<e.bi_valid&65535,e.bi_valid+=t)},send_code=(e,r,t)=>{send_bits(e,t[r*2],t[r*2+1])},bi_reverse=(e,r)=>{let t=0;do t|=e&1,e>>>=1,t<<=1;while(--r>0);return t>>>1},bi_flush=e=>{e.bi_valid===16?(put_short(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=e.bi_buf&255,e.bi_buf>>=8,e.bi_valid-=8)},gen_bitlen=(e,r)=>{const t=r.dyn_tree,o=r.max_code,s=r.stat_desc.static_tree,d=r.stat_desc.has_stree,g=r.stat_desc.extra_bits,a=r.stat_desc.extra_base,b=r.stat_desc.max_length;let _,T,C,D,k,O,U=0;for(D=0;D<=MAX_BITS$1;D++)e.bl_count[D]=0;for(t[e.heap[e.heap_max]*2+1]=0,_=e.heap_max+1;_<HEAP_SIZE$1;_++)T=e.heap[_],D=t[t[T*2+1]*2+1]+1,D>b&&(D=b,U++),t[T*2+1]=D,!(T>o)&&(e.bl_count[D]++,k=0,T>=a&&(k=g[T-a]),O=t[T*2],e.opt_len+=O*(D+k),d&&(e.static_len+=O*(s[T*2+1]+k)));if(U!==0){do{for(D=b-1;e.bl_count[D]===0;)D--;e.bl_count[D]--,e.bl_count[D+1]+=2,e.bl_count[b]--,U-=2}while(U>0);for(D=b;D!==0;D--)for(T=e.bl_count[D];T!==0;)C=e.heap[--_],!(C>o)&&(t[C*2+1]!==D&&(e.opt_len+=(D-t[C*2+1])*t[C*2],t[C*2+1]=D),T--)}},gen_codes=(e,r,t)=>{const o=new Array(MAX_BITS$1+1);let s=0,d,g;for(d=1;d<=MAX_BITS$1;d++)s=s+t[d-1]<<1,o[d]=s;for(g=0;g<=r;g++){let a=e[g*2+1];a!==0&&(e[g*2]=bi_reverse(o[a]++,a))}},tr_static_init=()=>{let e,r,t,o,s;const d=new Array(MAX_BITS$1+1);for(t=0,o=0;o<LENGTH_CODES$1-1;o++)for(base_length[o]=t,e=0;e<1<<extra_lbits[o];e++)_length_code[t++]=o;for(_length_code[t-1]=o,s=0,o=0;o<16;o++)for(base_dist[o]=s,e=0;e<1<<extra_dbits[o];e++)_dist_code[s++]=o;for(s>>=7;o<D_CODES$1;o++)for(base_dist[o]=s<<7,e=0;e<1<<extra_dbits[o]-7;e++)_dist_code[256+s++]=o;for(r=0;r<=MAX_BITS$1;r++)d[r]=0;for(e=0;e<=143;)static_ltree[e*2+1]=8,e++,d[8]++;for(;e<=255;)static_ltree[e*2+1]=9,e++,d[9]++;for(;e<=279;)static_ltree[e*2+1]=7,e++,d[7]++;for(;e<=287;)static_ltree[e*2+1]=8,e++,d[8]++;for(gen_codes(static_ltree,L_CODES$1+1,d),e=0;e<D_CODES$1;e++)static_dtree[e*2+1]=5,static_dtree[e*2]=bi_reverse(e,5);static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS$1+1,L_CODES$1,MAX_BITS$1),static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES$1,MAX_BITS$1),static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES$1,MAX_BL_BITS)},init_block=e=>{let r;for(r=0;r<L_CODES$1;r++)e.dyn_ltree[r*2]=0;for(r=0;r<D_CODES$1;r++)e.dyn_dtree[r*2]=0;for(r=0;r<BL_CODES$1;r++)e.bl_tree[r*2]=0;e.dyn_ltree[END_BLOCK*2]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},bi_windup=e=>{e.bi_valid>8?put_short(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},smaller=(e,r,t,o)=>{const s=r*2,d=t*2;return e[s]<e[d]||e[s]===e[d]&&o[r]<=o[t]},pqdownheap=(e,r,t)=>{const o=e.heap[t];let s=t<<1;for(;s<=e.heap_len&&(s<e.heap_len&&smaller(r,e.heap[s+1],e.heap[s],e.depth)&&s++,!smaller(r,o,e.heap[s],e.depth));)e.heap[t]=e.heap[s],t=s,s<<=1;e.heap[t]=o},compress_block=(e,r,t)=>{let o,s,d=0,g,a;if(e.sym_next!==0)do o=e.pending_buf[e.sym_buf+d++]&255,o+=(e.pending_buf[e.sym_buf+d++]&255)<<8,s=e.pending_buf[e.sym_buf+d++],o===0?send_code(e,s,r):(g=_length_code[s],send_code(e,g+LITERALS$1+1,r),a=extra_lbits[g],a!==0&&(s-=base_length[g],send_bits(e,s,a)),o--,g=d_code(o),send_code(e,g,t),a=extra_dbits[g],a!==0&&(o-=base_dist[g],send_bits(e,o,a)));while(d<e.sym_next);send_code(e,END_BLOCK,r)},build_tree=(e,r)=>{const t=r.dyn_tree,o=r.stat_desc.static_tree,s=r.stat_desc.has_stree,d=r.stat_desc.elems;let g,a,b=-1,_;for(e.heap_len=0,e.heap_max=HEAP_SIZE$1,g=0;g<d;g++)t[g*2]!==0?(e.heap[++e.heap_len]=b=g,e.depth[g]=0):t[g*2+1]=0;for(;e.heap_len<2;)_=e.heap[++e.heap_len]=b<2?++b:0,t[_*2]=1,e.depth[_]=0,e.opt_len--,s&&(e.static_len-=o[_*2+1]);for(r.max_code=b,g=e.heap_len>>1;g>=1;g--)pqdownheap(e,t,g);_=d;do g=e.heap[1],e.heap[1]=e.heap[e.heap_len--],pqdownheap(e,t,1),a=e.heap[1],e.heap[--e.heap_max]=g,e.heap[--e.heap_max]=a,t[_*2]=t[g*2]+t[a*2],e.depth[_]=(e.depth[g]>=e.depth[a]?e.depth[g]:e.depth[a])+1,t[g*2+1]=t[a*2+1]=_,e.heap[1]=_++,pqdownheap(e,t,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],gen_bitlen(e,r),gen_codes(t,b,e.bl_count)},scan_tree=(e,r,t)=>{let o,s=-1,d,g=r[0*2+1],a=0,b=7,_=4;for(g===0&&(b=138,_=3),r[(t+1)*2+1]=65535,o=0;o<=t;o++)d=g,g=r[(o+1)*2+1],!(++a<b&&d===g)&&(a<_?e.bl_tree[d*2]+=a:d!==0?(d!==s&&e.bl_tree[d*2]++,e.bl_tree[REP_3_6*2]++):a<=10?e.bl_tree[REPZ_3_10*2]++:e.bl_tree[REPZ_11_138*2]++,a=0,s=d,g===0?(b=138,_=3):d===g?(b=6,_=3):(b=7,_=4))},send_tree=(e,r,t)=>{let o,s=-1,d,g=r[0*2+1],a=0,b=7,_=4;for(g===0&&(b=138,_=3),o=0;o<=t;o++)if(d=g,g=r[(o+1)*2+1],!(++a<b&&d===g)){if(a<_)do send_code(e,d,e.bl_tree);while(--a!==0);else d!==0?(d!==s&&(send_code(e,d,e.bl_tree),a--),send_code(e,REP_3_6,e.bl_tree),send_bits(e,a-3,2)):a<=10?(send_code(e,REPZ_3_10,e.bl_tree),send_bits(e,a-3,3)):(send_code(e,REPZ_11_138,e.bl_tree),send_bits(e,a-11,7));a=0,s=d,g===0?(b=138,_=3):d===g?(b=6,_=3):(b=7,_=4)}},build_bl_tree=e=>{let r;for(scan_tree(e,e.dyn_ltree,e.l_desc.max_code),scan_tree(e,e.dyn_dtree,e.d_desc.max_code),build_tree(e,e.bl_desc),r=BL_CODES$1-1;r>=3&&e.bl_tree[bl_order[r]*2+1]===0;r--);return e.opt_len+=3*(r+1)+5+5+4,r},send_all_trees=(e,r,t,o)=>{let s;for(send_bits(e,r-257,5),send_bits(e,t-1,5),send_bits(e,o-4,4),s=0;s<o;s++)send_bits(e,e.bl_tree[bl_order[s]*2+1],3);send_tree(e,e.dyn_ltree,r-1),send_tree(e,e.dyn_dtree,t-1)},detect_data_type=e=>{let r=4093624447,t;for(t=0;t<=31;t++,r>>>=1)if(r&1&&e.dyn_ltree[t*2]!==0)return Z_BINARY;if(e.dyn_ltree[9*2]!==0||e.dyn_ltree[10*2]!==0||e.dyn_ltree[13*2]!==0)return Z_TEXT;for(t=32;t<LITERALS$1;t++)if(e.dyn_ltree[t*2]!==0)return Z_TEXT;return Z_BINARY};let static_init_done=!1;const _tr_init$1=e=>{static_init_done||(tr_static_init(),static_init_done=!0),e.l_desc=new TreeDesc(e.dyn_ltree,static_l_desc),e.d_desc=new TreeDesc(e.dyn_dtree,static_d_desc),e.bl_desc=new TreeDesc(e.bl_tree,static_bl_desc),e.bi_buf=0,e.bi_valid=0,init_block(e)},_tr_stored_block$1=(e,r,t,o)=>{send_bits(e,(STORED_BLOCK<<1)+(o?1:0),3),bi_windup(e),put_short(e,t),put_short(e,~t),t&&e.pending_buf.set(e.window.subarray(r,r+t),e.pending),e.pending+=t},_tr_align$1=e=>{send_bits(e,STATIC_TREES<<1,3),send_code(e,END_BLOCK,static_ltree),bi_flush(e)},_tr_flush_block$1=(e,r,t,o)=>{let s,d,g=0;e.level>0?(e.strm.data_type===Z_UNKNOWN$1&&(e.strm.data_type=detect_data_type(e)),build_tree(e,e.l_desc),build_tree(e,e.d_desc),g=build_bl_tree(e),s=e.opt_len+3+7>>>3,d=e.static_len+3+7>>>3,d<=s&&(s=d)):s=d=t+5,t+4<=s&&r!==-1?_tr_stored_block$1(e,r,t,o):e.strategy===Z_FIXED$1||d===s?(send_bits(e,(STATIC_TREES<<1)+(o?1:0),3),compress_block(e,static_ltree,static_dtree)):(send_bits(e,(DYN_TREES<<1)+(o?1:0),3),send_all_trees(e,e.l_desc.max_code+1,e.d_desc.max_code+1,g+1),compress_block(e,e.dyn_ltree,e.dyn_dtree)),init_block(e),o&&bi_windup(e)},_tr_tally$1=(e,r,t)=>(e.pending_buf[e.sym_buf+e.sym_next++]=r,e.pending_buf[e.sym_buf+e.sym_next++]=r>>8,e.pending_buf[e.sym_buf+e.sym_next++]=t,r===0?e.dyn_ltree[t*2]++:(e.matches++,r--,e.dyn_ltree[(_length_code[t]+LITERALS$1+1)*2]++,e.dyn_dtree[d_code(r)*2]++),e.sym_next===e.sym_end);var _tr_init_1=_tr_init$1,_tr_stored_block_1=_tr_stored_block$1,_tr_flush_block_1=_tr_flush_block$1,_tr_tally_1=_tr_tally$1,_tr_align_1=_tr_align$1,trees={_tr_init:_tr_init_1,_tr_stored_block:_tr_stored_block_1,_tr_flush_block:_tr_flush_block_1,_tr_tally:_tr_tally_1,_tr_align:_tr_align_1};const adler32=(e,r,t,o)=>{let s=e&65535|0,d=e>>>16&65535|0,g=0;for(;t!==0;){g=t>2e3?2e3:t,t-=g;do s=s+r[o++]|0,d=d+s|0;while(--g);s%=65521,d%=65521}return s|d<<16|0};var adler32_1=adler32;const makeTable=()=>{let e,r=[];for(var t=0;t<256;t++){e=t;for(var o=0;o<8;o++)e=e&1?3988292384^e>>>1:e>>>1;r[t]=e}return r},crcTable=new Uint32Array(makeTable()),crc32=(e,r,t,o)=>{const s=crcTable,d=o+t;e^=-1;for(let g=o;g<d;g++)e=e>>>8^s[(e^r[g])&255];return e^-1};var crc32_1=crc32,messages={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},constants$2$1={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init,_tr_stored_block,_tr_flush_block,_tr_tally,_tr_align}=trees,{Z_NO_FLUSH:Z_NO_FLUSH$2,Z_PARTIAL_FLUSH,Z_FULL_FLUSH:Z_FULL_FLUSH$1,Z_FINISH:Z_FINISH$3,Z_BLOCK:Z_BLOCK$1,Z_OK:Z_OK$3,Z_STREAM_END:Z_STREAM_END$3,Z_STREAM_ERROR:Z_STREAM_ERROR$2,Z_DATA_ERROR:Z_DATA_ERROR$2,Z_BUF_ERROR:Z_BUF_ERROR$1,Z_DEFAULT_COMPRESSION:Z_DEFAULT_COMPRESSION$1,Z_FILTERED,Z_HUFFMAN_ONLY,Z_RLE,Z_FIXED,Z_DEFAULT_STRATEGY:Z_DEFAULT_STRATEGY$1,Z_UNKNOWN,Z_DEFLATED:Z_DEFLATED$2}=constants$2$1,MAX_MEM_LEVEL=9,MAX_WBITS$1=15,DEF_MEM_LEVEL=8,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,MIN_MATCH=3,MAX_MATCH=258,MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1,PRESET_DICT=32,INIT_STATE=42,GZIP_STATE=57,EXTRA_STATE=69,NAME_STATE=73,COMMENT_STATE=91,HCRC_STATE=103,BUSY_STATE=113,FINISH_STATE=666,BS_NEED_MORE=1,BS_BLOCK_DONE=2,BS_FINISH_STARTED=3,BS_FINISH_DONE=4,OS_CODE=3,err=(e,r)=>(e.msg=messages[r],r),rank=e=>e*2-(e>4?9:0),zero=e=>{let r=e.length;for(;--r>=0;)e[r]=0},slide_hash=e=>{let r,t,o,s=e.w_size;r=e.hash_size,o=r;do t=e.head[--o],e.head[o]=t>=s?t-s:0;while(--r);r=s,o=r;do t=e.prev[--o],e.prev[o]=t>=s?t-s:0;while(--r)};let HASH_ZLIB=(e,r,t)=>(r<<e.hash_shift^t)&e.hash_mask,HASH=HASH_ZLIB;const flush_pending=e=>{const r=e.state;let t=r.pending;t>e.avail_out&&(t=e.avail_out),t!==0&&(e.output.set(r.pending_buf.subarray(r.pending_out,r.pending_out+t),e.next_out),e.next_out+=t,r.pending_out+=t,e.total_out+=t,e.avail_out-=t,r.pending-=t,r.pending===0&&(r.pending_out=0))},flush_block_only=(e,r)=>{_tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,r),e.block_start=e.strstart,flush_pending(e.strm)},put_byte=(e,r)=>{e.pending_buf[e.pending++]=r},putShortMSB=(e,r)=>{e.pending_buf[e.pending++]=r>>>8&255,e.pending_buf[e.pending++]=r&255},read_buf=(e,r,t,o)=>{let s=e.avail_in;return s>o&&(s=o),s===0?0:(e.avail_in-=s,r.set(e.input.subarray(e.next_in,e.next_in+s),t),e.state.wrap===1?e.adler=adler32_1(e.adler,r,s,t):e.state.wrap===2&&(e.adler=crc32_1(e.adler,r,s,t)),e.next_in+=s,e.total_in+=s,s)},longest_match=(e,r)=>{let t=e.max_chain_length,o=e.strstart,s,d,g=e.prev_length,a=e.nice_match;const b=e.strstart>e.w_size-MIN_LOOKAHEAD?e.strstart-(e.w_size-MIN_LOOKAHEAD):0,_=e.window,T=e.w_mask,C=e.prev,D=e.strstart+MAX_MATCH;let k=_[o+g-1],O=_[o+g];e.prev_length>=e.good_match&&(t>>=2),a>e.lookahead&&(a=e.lookahead);do if(s=r,!(_[s+g]!==O||_[s+g-1]!==k||_[s]!==_[o]||_[++s]!==_[o+1])){o+=2,s++;do;while(_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&_[++o]===_[++s]&&o<D);if(d=MAX_MATCH-(D-o),o=D-MAX_MATCH,d>g){if(e.match_start=r,g=d,d>=a)break;k=_[o+g-1],O=_[o+g]}}while((r=C[r&T])>b&&--t!==0);return g<=e.lookahead?g:e.lookahead},fill_window=e=>{const r=e.w_size;let t,o,s;do{if(o=e.window_size-e.lookahead-e.strstart,e.strstart>=r+(r-MIN_LOOKAHEAD)&&(e.window.set(e.window.subarray(r,r+r-o),0),e.match_start-=r,e.strstart-=r,e.block_start-=r,e.insert>e.strstart&&(e.insert=e.strstart),slide_hash(e),o+=r),e.strm.avail_in===0)break;if(t=read_buf(e.strm,e.window,e.strstart+e.lookahead,o),e.lookahead+=t,e.lookahead+e.insert>=MIN_MATCH)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=HASH(e,e.ins_h,e.window[s+1]);e.insert&&(e.ins_h=HASH(e,e.ins_h,e.window[s+MIN_MATCH-1]),e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<MIN_MATCH)););}while(e.lookahead<MIN_LOOKAHEAD&&e.strm.avail_in!==0)},deflate_stored=(e,r)=>{let t=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o,s,d,g=0,a=e.strm.avail_in;do{if(o=65535,d=e.bi_valid+42>>3,e.strm.avail_out<d||(d=e.strm.avail_out-d,s=e.strstart-e.block_start,o>s+e.strm.avail_in&&(o=s+e.strm.avail_in),o>d&&(o=d),o<t&&(o===0&&r!==Z_FINISH$3||r===Z_NO_FLUSH$2||o!==s+e.strm.avail_in)))break;g=r===Z_FINISH$3&&o===s+e.strm.avail_in?1:0,_tr_stored_block(e,0,0,g),e.pending_buf[e.pending-4]=o,e.pending_buf[e.pending-3]=o>>8,e.pending_buf[e.pending-2]=~o,e.pending_buf[e.pending-1]=~o>>8,flush_pending(e.strm),s&&(s>o&&(s=o),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+s),e.strm.next_out),e.strm.next_out+=s,e.strm.avail_out-=s,e.strm.total_out+=s,e.block_start+=s,o-=s),o&&(read_buf(e.strm,e.strm.output,e.strm.next_out,o),e.strm.next_out+=o,e.strm.avail_out-=o,e.strm.total_out+=o)}while(g===0);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),g?BS_FINISH_DONE:r!==Z_NO_FLUSH$2&&r!==Z_FINISH$3&&e.strm.avail_in===0&&e.strstart===e.block_start?BS_BLOCK_DONE:(d=e.window_size-e.strstart,e.strm.avail_in>d&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,d+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),d>e.strm.avail_in&&(d=e.strm.avail_in),d&&(read_buf(e.strm,e.window,e.strstart,d),e.strstart+=d,e.insert+=d>e.w_size-e.insert?e.w_size-e.insert:d),e.high_water<e.strstart&&(e.high_water=e.strstart),d=e.bi_valid+42>>3,d=e.pending_buf_size-d>65535?65535:e.pending_buf_size-d,t=d>e.w_size?e.w_size:d,s=e.strstart-e.block_start,(s>=t||(s||r===Z_FINISH$3)&&r!==Z_NO_FLUSH$2&&e.strm.avail_in===0&&s<=d)&&(o=s>d?d:s,g=r===Z_FINISH$3&&e.strm.avail_in===0&&o===s?1:0,_tr_stored_block(e,e.block_start,o,g),e.block_start+=o,flush_pending(e.strm)),g?BS_FINISH_STARTED:BS_NEED_MORE)},deflate_fast=(e,r)=>{let t,o;for(;;){if(e.lookahead<MIN_LOOKAHEAD){if(fill_window(e),e.lookahead<MIN_LOOKAHEAD&&r===Z_NO_FLUSH$2)return BS_NEED_MORE;if(e.lookahead===0)break}if(t=0,e.lookahead>=MIN_MATCH&&(e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+MIN_MATCH-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),t!==0&&e.strstart-t<=e.w_size-MIN_LOOKAHEAD&&(e.match_length=longest_match(e,t)),e.match_length>=MIN_MATCH)if(o=_tr_tally(e,e.strstart-e.match_start,e.match_length-MIN_MATCH),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=MIN_MATCH){e.match_length--;do e.strstart++,e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+MIN_MATCH-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!==0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+1]);else o=_tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(o&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}return e.insert=e.strstart<MIN_MATCH-1?e.strstart:MIN_MATCH-1,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):e.sym_next&&(flush_block_only(e,!1),e.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_slow=(e,r)=>{let t,o,s;for(;;){if(e.lookahead<MIN_LOOKAHEAD){if(fill_window(e),e.lookahead<MIN_LOOKAHEAD&&r===Z_NO_FLUSH$2)return BS_NEED_MORE;if(e.lookahead===0)break}if(t=0,e.lookahead>=MIN_MATCH&&(e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+MIN_MATCH-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=MIN_MATCH-1,t!==0&&e.prev_length<e.max_lazy_match&&e.strstart-t<=e.w_size-MIN_LOOKAHEAD&&(e.match_length=longest_match(e,t),e.match_length<=5&&(e.strategy===Z_FILTERED||e.match_length===MIN_MATCH&&e.strstart-e.match_start>4096)&&(e.match_length=MIN_MATCH-1)),e.prev_length>=MIN_MATCH&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-MIN_MATCH,o=_tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-MIN_MATCH),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=s&&(e.ins_h=HASH(e,e.ins_h,e.window[e.strstart+MIN_MATCH-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!==0);if(e.match_available=0,e.match_length=MIN_MATCH-1,e.strstart++,o&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}else if(e.match_available){if(o=_tr_tally(e,0,e.window[e.strstart-1]),o&&flush_block_only(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return BS_NEED_MORE}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(o=_tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<MIN_MATCH-1?e.strstart:MIN_MATCH-1,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):e.sym_next&&(flush_block_only(e,!1),e.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_rle=(e,r)=>{let t,o,s,d;const g=e.window;for(;;){if(e.lookahead<=MAX_MATCH){if(fill_window(e),e.lookahead<=MAX_MATCH&&r===Z_NO_FLUSH$2)return BS_NEED_MORE;if(e.lookahead===0)break}if(e.match_length=0,e.lookahead>=MIN_MATCH&&e.strstart>0&&(s=e.strstart-1,o=g[s],o===g[++s]&&o===g[++s]&&o===g[++s])){d=e.strstart+MAX_MATCH;do;while(o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&o===g[++s]&&s<d);e.match_length=MAX_MATCH-(d-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=MIN_MATCH?(t=_tr_tally(e,1,e.match_length-MIN_MATCH),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(t=_tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),t&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}return e.insert=0,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):e.sym_next&&(flush_block_only(e,!1),e.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE},deflate_huff=(e,r)=>{let t;for(;;){if(e.lookahead===0&&(fill_window(e),e.lookahead===0)){if(r===Z_NO_FLUSH$2)return BS_NEED_MORE;break}if(e.match_length=0,t=_tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,t&&(flush_block_only(e,!1),e.strm.avail_out===0))return BS_NEED_MORE}return e.insert=0,r===Z_FINISH$3?(flush_block_only(e,!0),e.strm.avail_out===0?BS_FINISH_STARTED:BS_FINISH_DONE):e.sym_next&&(flush_block_only(e,!1),e.strm.avail_out===0)?BS_NEED_MORE:BS_BLOCK_DONE};function Config(e,r,t,o,s){this.good_length=e,this.max_lazy=r,this.nice_length=t,this.max_chain=o,this.func=s}const configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],lm_init=e=>{e.window_size=2*e.w_size,zero(e.head),e.max_lazy_match=configuration_table[e.level].max_lazy,e.good_match=configuration_table[e.level].good_length,e.nice_match=configuration_table[e.level].nice_length,e.max_chain_length=configuration_table[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=MIN_MATCH-1,e.match_available=0,e.ins_h=0};function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Z_DEFLATED$2,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(HEAP_SIZE*2),this.dyn_dtree=new Uint16Array((2*D_CODES+1)*2),this.bl_tree=new Uint16Array((2*BL_CODES+1)*2),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(MAX_BITS+1),this.heap=new Uint16Array(2*L_CODES+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*L_CODES+1),zero(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const deflateStateCheck=e=>{if(!e)return 1;const r=e.state;return!r||r.strm!==e||r.status!==INIT_STATE&&r.status!==GZIP_STATE&&r.status!==EXTRA_STATE&&r.status!==NAME_STATE&&r.status!==COMMENT_STATE&&r.status!==HCRC_STATE&&r.status!==BUSY_STATE&&r.status!==FINISH_STATE?1:0},deflateResetKeep=e=>{if(deflateStateCheck(e))return err(e,Z_STREAM_ERROR$2);e.total_in=e.total_out=0,e.data_type=Z_UNKNOWN;const r=e.state;return r.pending=0,r.pending_out=0,r.wrap<0&&(r.wrap=-r.wrap),r.status=r.wrap===2?GZIP_STATE:r.wrap?INIT_STATE:BUSY_STATE,e.adler=r.wrap===2?0:1,r.last_flush=-2,_tr_init(r),Z_OK$3},deflateReset=e=>{const r=deflateResetKeep(e);return r===Z_OK$3&&lm_init(e.state),r},deflateSetHeader=(e,r)=>deflateStateCheck(e)||e.state.wrap!==2?Z_STREAM_ERROR$2:(e.state.gzhead=r,Z_OK$3),deflateInit2=(e,r,t,o,s,d)=>{if(!e)return Z_STREAM_ERROR$2;let g=1;if(r===Z_DEFAULT_COMPRESSION$1&&(r=6),o<0?(g=0,o=-o):o>15&&(g=2,o-=16),s<1||s>MAX_MEM_LEVEL||t!==Z_DEFLATED$2||o<8||o>15||r<0||r>9||d<0||d>Z_FIXED||o===8&&g!==1)return err(e,Z_STREAM_ERROR$2);o===8&&(o=9);const a=new DeflateState;return e.state=a,a.strm=e,a.status=INIT_STATE,a.wrap=g,a.gzhead=null,a.w_bits=o,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+MIN_MATCH-1)/MIN_MATCH),a.window=new Uint8Array(a.w_size*2),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=a.lit_bufsize*4,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=(a.lit_bufsize-1)*3,a.level=r,a.strategy=d,a.method=t,deflateReset(e)},deflateInit=(e,r)=>deflateInit2(e,r,Z_DEFLATED$2,MAX_WBITS$1,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY$1),deflate$2=(e,r)=>{if(deflateStateCheck(e)||r>Z_BLOCK$1||r<0)return e?err(e,Z_STREAM_ERROR$2):Z_STREAM_ERROR$2;const t=e.state;if(!e.output||e.avail_in!==0&&!e.input||t.status===FINISH_STATE&&r!==Z_FINISH$3)return err(e,e.avail_out===0?Z_BUF_ERROR$1:Z_STREAM_ERROR$2);const o=t.last_flush;if(t.last_flush=r,t.pending!==0){if(flush_pending(e),e.avail_out===0)return t.last_flush=-1,Z_OK$3}else if(e.avail_in===0&&rank(r)<=rank(o)&&r!==Z_FINISH$3)return err(e,Z_BUF_ERROR$1);if(t.status===FINISH_STATE&&e.avail_in!==0)return err(e,Z_BUF_ERROR$1);if(t.status===INIT_STATE&&t.wrap===0&&(t.status=BUSY_STATE),t.status===INIT_STATE){let s=Z_DEFLATED$2+(t.w_bits-8<<4)<<8,d=-1;if(t.strategy>=Z_HUFFMAN_ONLY||t.level<2?d=0:t.level<6?d=1:t.level===6?d=2:d=3,s|=d<<6,t.strstart!==0&&(s|=PRESET_DICT),s+=31-s%31,putShortMSB(t,s),t.strstart!==0&&(putShortMSB(t,e.adler>>>16),putShortMSB(t,e.adler&65535)),e.adler=1,t.status=BUSY_STATE,flush_pending(e),t.pending!==0)return t.last_flush=-1,Z_OK$3}if(t.status===GZIP_STATE){if(e.adler=0,put_byte(t,31),put_byte(t,139),put_byte(t,8),t.gzhead)put_byte(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),put_byte(t,t.gzhead.time&255),put_byte(t,t.gzhead.time>>8&255),put_byte(t,t.gzhead.time>>16&255),put_byte(t,t.gzhead.time>>24&255),put_byte(t,t.level===9?2:t.strategy>=Z_HUFFMAN_ONLY||t.level<2?4:0),put_byte(t,t.gzhead.os&255),t.gzhead.extra&&t.gzhead.extra.length&&(put_byte(t,t.gzhead.extra.length&255),put_byte(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(e.adler=crc32_1(e.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=EXTRA_STATE;else if(put_byte(t,0),put_byte(t,0),put_byte(t,0),put_byte(t,0),put_byte(t,0),put_byte(t,t.level===9?2:t.strategy>=Z_HUFFMAN_ONLY||t.level<2?4:0),put_byte(t,OS_CODE),t.status=BUSY_STATE,flush_pending(e),t.pending!==0)return t.last_flush=-1,Z_OK$3}if(t.status===EXTRA_STATE){if(t.gzhead.extra){let s=t.pending,d=(t.gzhead.extra.length&65535)-t.gzindex;for(;t.pending+d>t.pending_buf_size;){let a=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+a),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1(e.adler,t.pending_buf,t.pending-s,s)),t.gzindex+=a,flush_pending(e),t.pending!==0)return t.last_flush=-1,Z_OK$3;s=0,d-=a}let g=new Uint8Array(t.gzhead.extra);t.pending_buf.set(g.subarray(t.gzindex,t.gzindex+d),t.pending),t.pending+=d,t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1(e.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=NAME_STATE}if(t.status===NAME_STATE){if(t.gzhead.name){let s=t.pending,d;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1(e.adler,t.pending_buf,t.pending-s,s)),flush_pending(e),t.pending!==0)return t.last_flush=-1,Z_OK$3;s=0}t.gzindex<t.gzhead.name.length?d=t.gzhead.name.charCodeAt(t.gzindex++)&255:d=0,put_byte(t,d)}while(d!==0);t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1(e.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=COMMENT_STATE}if(t.status===COMMENT_STATE){if(t.gzhead.comment){let s=t.pending,d;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1(e.adler,t.pending_buf,t.pending-s,s)),flush_pending(e),t.pending!==0)return t.last_flush=-1,Z_OK$3;s=0}t.gzindex<t.gzhead.comment.length?d=t.gzhead.comment.charCodeAt(t.gzindex++)&255:d=0,put_byte(t,d)}while(d!==0);t.gzhead.hcrc&&t.pending>s&&(e.adler=crc32_1(e.adler,t.pending_buf,t.pending-s,s))}t.status=HCRC_STATE}if(t.status===HCRC_STATE){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(flush_pending(e),t.pending!==0))return t.last_flush=-1,Z_OK$3;put_byte(t,e.adler&255),put_byte(t,e.adler>>8&255),e.adler=0}if(t.status=BUSY_STATE,flush_pending(e),t.pending!==0)return t.last_flush=-1,Z_OK$3}if(e.avail_in!==0||t.lookahead!==0||r!==Z_NO_FLUSH$2&&t.status!==FINISH_STATE){let s=t.level===0?deflate_stored(t,r):t.strategy===Z_HUFFMAN_ONLY?deflate_huff(t,r):t.strategy===Z_RLE?deflate_rle(t,r):configuration_table[t.level].func(t,r);if((s===BS_FINISH_STARTED||s===BS_FINISH_DONE)&&(t.status=FINISH_STATE),s===BS_NEED_MORE||s===BS_FINISH_STARTED)return e.avail_out===0&&(t.last_flush=-1),Z_OK$3;if(s===BS_BLOCK_DONE&&(r===Z_PARTIAL_FLUSH?_tr_align(t):r!==Z_BLOCK$1&&(_tr_stored_block(t,0,0,!1),r===Z_FULL_FLUSH$1&&(zero(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),flush_pending(e),e.avail_out===0))return t.last_flush=-1,Z_OK$3}return r!==Z_FINISH$3?Z_OK$3:t.wrap<=0?Z_STREAM_END$3:(t.wrap===2?(put_byte(t,e.adler&255),put_byte(t,e.adler>>8&255),put_byte(t,e.adler>>16&255),put_byte(t,e.adler>>24&255),put_byte(t,e.total_in&255),put_byte(t,e.total_in>>8&255),put_byte(t,e.total_in>>16&255),put_byte(t,e.total_in>>24&255)):(putShortMSB(t,e.adler>>>16),putShortMSB(t,e.adler&65535)),flush_pending(e),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?Z_OK$3:Z_STREAM_END$3)},deflateEnd=e=>{if(deflateStateCheck(e))return Z_STREAM_ERROR$2;const r=e.state.status;return e.state=null,r===BUSY_STATE?err(e,Z_DATA_ERROR$2):Z_OK$3},deflateSetDictionary=(e,r)=>{let t=r.length;if(deflateStateCheck(e))return Z_STREAM_ERROR$2;const o=e.state,s=o.wrap;if(s===2||s===1&&o.status!==INIT_STATE||o.lookahead)return Z_STREAM_ERROR$2;if(s===1&&(e.adler=adler32_1(e.adler,r,t,0)),o.wrap=0,t>=o.w_size){s===0&&(zero(o.head),o.strstart=0,o.block_start=0,o.insert=0);let b=new Uint8Array(o.w_size);b.set(r.subarray(t-o.w_size,t),0),r=b,t=o.w_size}const d=e.avail_in,g=e.next_in,a=e.input;for(e.avail_in=t,e.next_in=0,e.input=r,fill_window(o);o.lookahead>=MIN_MATCH;){let b=o.strstart,_=o.lookahead-(MIN_MATCH-1);do o.ins_h=HASH(o,o.ins_h,o.window[b+MIN_MATCH-1]),o.prev[b&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=b,b++;while(--_);o.strstart=b,o.lookahead=MIN_MATCH-1,fill_window(o)}return o.strstart+=o.lookahead,o.block_start=o.strstart,o.insert=o.lookahead,o.lookahead=0,o.match_length=o.prev_length=MIN_MATCH-1,o.match_available=0,e.next_in=g,e.input=a,e.avail_in=d,o.wrap=s,Z_OK$3};var deflateInit_1=deflateInit,deflateInit2_1=deflateInit2,deflateReset_1=deflateReset,deflateResetKeep_1=deflateResetKeep,deflateSetHeader_1=deflateSetHeader,deflate_2$1=deflate$2,deflateEnd_1=deflateEnd,deflateSetDictionary_1=deflateSetDictionary,deflateInfo="pako deflate (from Nodeca project)",deflate_1$2={deflateInit:deflateInit_1,deflateInit2:deflateInit2_1,deflateReset:deflateReset_1,deflateResetKeep:deflateResetKeep_1,deflateSetHeader:deflateSetHeader_1,deflate:deflate_2$1,deflateEnd:deflateEnd_1,deflateSetDictionary:deflateSetDictionary_1,deflateInfo};const _has=(e,r)=>Object.prototype.hasOwnProperty.call(e,r);var assign=function(e){const r=Array.prototype.slice.call(arguments,1);for(;r.length;){const t=r.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const o in t)_has(t,o)&&(e[o]=t[o])}}return e},flattenChunks=e=>{let r=0;for(let o=0,s=e.length;o<s;o++)r+=e[o].length;const t=new Uint8Array(r);for(let o=0,s=0,d=e.length;o<d;o++){let g=e[o];t.set(g,s),s+=g.length}return t},common={assign,flattenChunks};let STR_APPLY_UIA_OK=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){STR_APPLY_UIA_OK=!1}const _utf8len=new Uint8Array(256);for(let e=0;e<256;e++)_utf8len[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let r,t,o,s,d,g=e.length,a=0;for(s=0;s<g;s++)t=e.charCodeAt(s),(t&64512)===55296&&s+1<g&&(o=e.charCodeAt(s+1),(o&64512)===56320&&(t=65536+(t-55296<<10)+(o-56320),s++)),a+=t<128?1:t<2048?2:t<65536?3:4;for(r=new Uint8Array(a),d=0,s=0;d<a;s++)t=e.charCodeAt(s),(t&64512)===55296&&s+1<g&&(o=e.charCodeAt(s+1),(o&64512)===56320&&(t=65536+(t-55296<<10)+(o-56320),s++)),t<128?r[d++]=t:t<2048?(r[d++]=192|t>>>6,r[d++]=128|t&63):t<65536?(r[d++]=224|t>>>12,r[d++]=128|t>>>6&63,r[d++]=128|t&63):(r[d++]=240|t>>>18,r[d++]=128|t>>>12&63,r[d++]=128|t>>>6&63,r[d++]=128|t&63);return r};const buf2binstring=(e,r)=>{if(r<65534&&e.subarray&&STR_APPLY_UIA_OK)return String.fromCharCode.apply(null,e.length===r?e:e.subarray(0,r));let t="";for(let o=0;o<r;o++)t+=String.fromCharCode(e[o]);return t};var buf2string=(e,r)=>{const t=r||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,r));let o,s;const d=new Array(t*2);for(s=0,o=0;o<t;){let g=e[o++];if(g<128){d[s++]=g;continue}let a=_utf8len[g];if(a>4){d[s++]=65533,o+=a-1;continue}for(g&=a===2?31:a===3?15:7;a>1&&o<t;)g=g<<6|e[o++]&63,a--;if(a>1){d[s++]=65533;continue}g<65536?d[s++]=g:(g-=65536,d[s++]=55296|g>>10&1023,d[s++]=56320|g&1023)}return buf2binstring(d,s)},utf8border=(e,r)=>{r=r||e.length,r>e.length&&(r=e.length);let t=r-1;for(;t>=0&&(e[t]&192)===128;)t--;return t<0||t===0?r:t+_utf8len[e[t]]>r?t:r},strings={string2buf,buf2string,utf8border};function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var zstream=ZStream;const toString$1$1=Object.prototype.toString,{Z_NO_FLUSH:Z_NO_FLUSH$1,Z_SYNC_FLUSH,Z_FULL_FLUSH,Z_FINISH:Z_FINISH$2,Z_OK:Z_OK$2,Z_STREAM_END:Z_STREAM_END$2,Z_DEFAULT_COMPRESSION,Z_DEFAULT_STRATEGY,Z_DEFLATED:Z_DEFLATED$1}=constants$2$1;function Deflate$1(e){this.options=common.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED$1,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY},e||{});let r=this.options;r.raw&&r.windowBits>0?r.windowBits=-r.windowBits:r.gzip&&r.windowBits>0&&r.windowBits<16&&(r.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let t=deflate_1$2.deflateInit2(this.strm,r.level,r.method,r.windowBits,r.memLevel,r.strategy);if(t!==Z_OK$2)throw new Error(messages[t]);if(r.header&&deflate_1$2.deflateSetHeader(this.strm,r.header),r.dictionary){let o;if(typeof r.dictionary=="string"?o=strings.string2buf(r.dictionary):toString$1$1.call(r.dictionary)==="[object ArrayBuffer]"?o=new Uint8Array(r.dictionary):o=r.dictionary,t=deflate_1$2.deflateSetDictionary(this.strm,o),t!==Z_OK$2)throw new Error(messages[t]);this._dict_set=!0}}Deflate$1.prototype.push=function(e,r){const t=this.strm,o=this.options.chunkSize;let s,d;if(this.ended)return!1;for(r===~~r?d=r:d=r===!0?Z_FINISH$2:Z_NO_FLUSH$1,typeof e=="string"?t.input=strings.string2buf(e):toString$1$1.call(e)==="[object ArrayBuffer]"?t.input=new Uint8Array(e):t.input=e,t.next_in=0,t.avail_in=t.input.length;;){if(t.avail_out===0&&(t.output=new Uint8Array(o),t.next_out=0,t.avail_out=o),(d===Z_SYNC_FLUSH||d===Z_FULL_FLUSH)&&t.avail_out<=6){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(s=deflate_1$2.deflate(t,d),s===Z_STREAM_END$2)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),s=deflate_1$2.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===Z_OK$2;if(t.avail_out===0){this.onData(t.output);continue}if(d>0&&t.next_out>0){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(t.avail_in===0)break}return!0};Deflate$1.prototype.onData=function(e){this.chunks.push(e)};Deflate$1.prototype.onEnd=function(e){e===Z_OK$2&&(this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};const BAD$1=16209,TYPE$1=16191;var inffast=function e(r,t){let o,s,d,g,a,b,_,T,C,D,k,O,U,G,j,te,H,Z,W,_e,fe,re,ae,J;const se=r.state;o=r.next_in,ae=r.input,s=o+(r.avail_in-5),d=r.next_out,J=r.output,g=d-(t-r.avail_out),a=d+(r.avail_out-257),b=se.dmax,_=se.wsize,T=se.whave,C=se.wnext,D=se.window,k=se.hold,O=se.bits,U=se.lencode,G=se.distcode,j=(1<<se.lenbits)-1,te=(1<<se.distbits)-1;e:do{O<15&&(k+=ae[o++]<<O,O+=8,k+=ae[o++]<<O,O+=8),H=U[k&j];t:for(;;){if(Z=H>>>24,k>>>=Z,O-=Z,Z=H>>>16&255,Z===0)J[d++]=H&65535;else if(Z&16){W=H&65535,Z&=15,Z&&(O<Z&&(k+=ae[o++]<<O,O+=8),W+=k&(1<<Z)-1,k>>>=Z,O-=Z),O<15&&(k+=ae[o++]<<O,O+=8,k+=ae[o++]<<O,O+=8),H=G[k&te];i:for(;;){if(Z=H>>>24,k>>>=Z,O-=Z,Z=H>>>16&255,Z&16){if(_e=H&65535,Z&=15,O<Z&&(k+=ae[o++]<<O,O+=8,O<Z&&(k+=ae[o++]<<O,O+=8)),_e+=k&(1<<Z)-1,_e>b){r.msg="invalid distance too far back",se.mode=BAD$1;break e}if(k>>>=Z,O-=Z,Z=d-g,_e>Z){if(Z=_e-Z,Z>T&&se.sane){r.msg="invalid distance too far back",se.mode=BAD$1;break e}if(fe=0,re=D,C===0){if(fe+=_-Z,Z<W){W-=Z;do J[d++]=D[fe++];while(--Z);fe=d-_e,re=J}}else if(C<Z){if(fe+=_+C-Z,Z-=C,Z<W){W-=Z;do J[d++]=D[fe++];while(--Z);if(fe=0,C<W){Z=C,W-=Z;do J[d++]=D[fe++];while(--Z);fe=d-_e,re=J}}}else if(fe+=C-Z,Z<W){W-=Z;do J[d++]=D[fe++];while(--Z);fe=d-_e,re=J}for(;W>2;)J[d++]=re[fe++],J[d++]=re[fe++],J[d++]=re[fe++],W-=3;W&&(J[d++]=re[fe++],W>1&&(J[d++]=re[fe++]))}else{fe=d-_e;do J[d++]=J[fe++],J[d++]=J[fe++],J[d++]=J[fe++],W-=3;while(W>2);W&&(J[d++]=J[fe++],W>1&&(J[d++]=J[fe++]))}}else if(Z&64){r.msg="invalid distance code",se.mode=BAD$1;break e}else{H=G[(H&65535)+(k&(1<<Z)-1)];continue i}break}}else if(Z&64)if(Z&32){se.mode=TYPE$1;break e}else{r.msg="invalid literal/length code",se.mode=BAD$1;break e}else{H=U[(H&65535)+(k&(1<<Z)-1)];continue t}break}}while(o<s&&d<a);W=O>>3,o-=W,O-=W<<3,k&=(1<<O)-1,r.next_in=o,r.next_out=d,r.avail_in=o<s?5+(s-o):5-(o-s),r.avail_out=d<a?257+(a-d):257-(d-a),se.hold=k,se.bits=O};const MAXBITS=15,ENOUGH_LENS$1=852,ENOUGH_DISTS$1=592,CODES$1=0,LENS$1=1,DISTS$1=2,lbase=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),lext=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),dbase=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),dext=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),inflate_table=(e,r,t,o,s,d,g,a)=>{const b=a.bits;let _=0,T=0,C=0,D=0,k=0,O=0,U=0,G=0,j=0,te=0,H,Z,W,_e,fe,re=null,ae;const J=new Uint16Array(MAXBITS+1),se=new Uint16Array(MAXBITS+1);let Me=null,Ie,We,Ge;for(_=0;_<=MAXBITS;_++)J[_]=0;for(T=0;T<o;T++)J[r[t+T]]++;for(k=b,D=MAXBITS;D>=1&&J[D]===0;D--);if(k>D&&(k=D),D===0)return s[d++]=1<<24|64<<16|0,s[d++]=1<<24|64<<16|0,a.bits=1,0;for(C=1;C<D&&J[C]===0;C++);for(k<C&&(k=C),G=1,_=1;_<=MAXBITS;_++)if(G<<=1,G-=J[_],G<0)return-1;if(G>0&&(e===CODES$1||D!==1))return-1;for(se[1]=0,_=1;_<MAXBITS;_++)se[_+1]=se[_]+J[_];for(T=0;T<o;T++)r[t+T]!==0&&(g[se[r[t+T]]++]=T);if(e===CODES$1?(re=Me=g,ae=20):e===LENS$1?(re=lbase,Me=lext,ae=257):(re=dbase,Me=dext,ae=0),te=0,T=0,_=C,fe=d,O=k,U=0,W=-1,j=1<<k,_e=j-1,e===LENS$1&&j>ENOUGH_LENS$1||e===DISTS$1&&j>ENOUGH_DISTS$1)return 1;for(;;){Ie=_-U,g[T]+1<ae?(We=0,Ge=g[T]):g[T]>=ae?(We=Me[g[T]-ae],Ge=re[g[T]-ae]):(We=32+64,Ge=0),H=1<<_-U,Z=1<<O,C=Z;do Z-=H,s[fe+(te>>U)+Z]=Ie<<24|We<<16|Ge|0;while(Z!==0);for(H=1<<_-1;te&H;)H>>=1;if(H!==0?(te&=H-1,te+=H):te=0,T++,--J[_]===0){if(_===D)break;_=r[t+g[T]]}if(_>k&&(te&_e)!==W){for(U===0&&(U=k),fe+=C,O=_-U,G=1<<O;O+U<D&&(G-=J[O+U],!(G<=0));)O++,G<<=1;if(j+=1<<O,e===LENS$1&&j>ENOUGH_LENS$1||e===DISTS$1&&j>ENOUGH_DISTS$1)return 1;W=te&_e,s[W]=k<<24|O<<16|fe-d|0}}return te!==0&&(s[fe+te]=_-U<<24|64<<16|0),a.bits=k,0};var inftrees=inflate_table;const CODES=0,LENS=1,DISTS=2,{Z_FINISH:Z_FINISH$1,Z_BLOCK,Z_TREES,Z_OK:Z_OK$1,Z_STREAM_END:Z_STREAM_END$1,Z_NEED_DICT:Z_NEED_DICT$1,Z_STREAM_ERROR:Z_STREAM_ERROR$1,Z_DATA_ERROR:Z_DATA_ERROR$1,Z_MEM_ERROR:Z_MEM_ERROR$1,Z_BUF_ERROR,Z_DEFLATED}=constants$2$1,HEAD=16180,FLAGS=16181,TIME=16182,OS=16183,EXLEN=16184,EXTRA=16185,NAME=16186,COMMENT=16187,HCRC=16188,DICTID=16189,DICT=16190,TYPE=16191,TYPEDO=16192,STORED=16193,COPY_=16194,COPY=16195,TABLE=16196,LENLENS=16197,CODELENS=16198,LEN_=16199,LEN=16200,LENEXT=16201,DIST=16202,DISTEXT=16203,MATCH=16204,LIT=16205,CHECK=16206,LENGTH=16207,DONE=16208,BAD=16209,MEM=16210,SYNC=16211,ENOUGH_LENS=852,ENOUGH_DISTS=592,MAX_WBITS=15,DEF_WBITS=MAX_WBITS,zswap32=e=>(e>>>24&255)+(e>>>8&65280)+((e&65280)<<8)+((e&255)<<24);function InflateState(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const inflateStateCheck=e=>{if(!e)return 1;const r=e.state;return!r||r.strm!==e||r.mode<HEAD||r.mode>SYNC?1:0},inflateResetKeep=e=>{if(inflateStateCheck(e))return Z_STREAM_ERROR$1;const r=e.state;return e.total_in=e.total_out=r.total=0,e.msg="",r.wrap&&(e.adler=r.wrap&1),r.mode=HEAD,r.last=0,r.havedict=0,r.flags=-1,r.dmax=32768,r.head=null,r.hold=0,r.bits=0,r.lencode=r.lendyn=new Int32Array(ENOUGH_LENS),r.distcode=r.distdyn=new Int32Array(ENOUGH_DISTS),r.sane=1,r.back=-1,Z_OK$1},inflateReset=e=>{if(inflateStateCheck(e))return Z_STREAM_ERROR$1;const r=e.state;return r.wsize=0,r.whave=0,r.wnext=0,inflateResetKeep(e)},inflateReset2=(e,r)=>{let t;if(inflateStateCheck(e))return Z_STREAM_ERROR$1;const o=e.state;return r<0?(t=0,r=-r):(t=(r>>4)+5,r<48&&(r&=15)),r&&(r<8||r>15)?Z_STREAM_ERROR$1:(o.window!==null&&o.wbits!==r&&(o.window=null),o.wrap=t,o.wbits=r,inflateReset(e))},inflateInit2=(e,r)=>{if(!e)return Z_STREAM_ERROR$1;const t=new InflateState;e.state=t,t.strm=e,t.window=null,t.mode=HEAD;const o=inflateReset2(e,r);return o!==Z_OK$1&&(e.state=null),o},inflateInit=e=>inflateInit2(e,DEF_WBITS);let virgin=!0,lenfix,distfix;const fixedtables=e=>{if(virgin){lenfix=new Int32Array(512),distfix=new Int32Array(32);let r=0;for(;r<144;)e.lens[r++]=8;for(;r<256;)e.lens[r++]=9;for(;r<280;)e.lens[r++]=7;for(;r<288;)e.lens[r++]=8;for(inftrees(LENS,e.lens,0,288,lenfix,0,e.work,{bits:9}),r=0;r<32;)e.lens[r++]=5;inftrees(DISTS,e.lens,0,32,distfix,0,e.work,{bits:5}),virgin=!1}e.lencode=lenfix,e.lenbits=9,e.distcode=distfix,e.distbits=5},updatewindow=(e,r,t,o)=>{let s;const d=e.state;return d.window===null&&(d.wsize=1<<d.wbits,d.wnext=0,d.whave=0,d.window=new Uint8Array(d.wsize)),o>=d.wsize?(d.window.set(r.subarray(t-d.wsize,t),0),d.wnext=0,d.whave=d.wsize):(s=d.wsize-d.wnext,s>o&&(s=o),d.window.set(r.subarray(t-o,t-o+s),d.wnext),o-=s,o?(d.window.set(r.subarray(t-o,t),0),d.wnext=o,d.whave=d.wsize):(d.wnext+=s,d.wnext===d.wsize&&(d.wnext=0),d.whave<d.wsize&&(d.whave+=s))),0},inflate$2=(e,r)=>{let t,o,s,d,g,a,b,_,T,C,D,k,O,U,G=0,j,te,H,Z,W,_e,fe,re;const ae=new Uint8Array(4);let J,se;const Me=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(inflateStateCheck(e)||!e.output||!e.input&&e.avail_in!==0)return Z_STREAM_ERROR$1;t=e.state,t.mode===TYPE&&(t.mode=TYPEDO),g=e.next_out,s=e.output,b=e.avail_out,d=e.next_in,o=e.input,a=e.avail_in,_=t.hold,T=t.bits,C=a,D=b,re=Z_OK$1;e:for(;;)switch(t.mode){case HEAD:if(t.wrap===0){t.mode=TYPEDO;break}for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.wrap&2&&_===35615){t.wbits===0&&(t.wbits=15),t.check=0,ae[0]=_&255,ae[1]=_>>>8&255,t.check=crc32_1(t.check,ae,2,0),_=0,T=0,t.mode=FLAGS;break}if(t.head&&(t.head.done=!1),!(t.wrap&1)||(((_&255)<<8)+(_>>8))%31){e.msg="incorrect header check",t.mode=BAD;break}if((_&15)!==Z_DEFLATED){e.msg="unknown compression method",t.mode=BAD;break}if(_>>>=4,T-=4,fe=(_&15)+8,t.wbits===0&&(t.wbits=fe),fe>15||fe>t.wbits){e.msg="invalid window size",t.mode=BAD;break}t.dmax=1<<t.wbits,t.flags=0,e.adler=t.check=1,t.mode=_&512?DICTID:TYPE,_=0,T=0;break;case FLAGS:for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.flags=_,(t.flags&255)!==Z_DEFLATED){e.msg="unknown compression method",t.mode=BAD;break}if(t.flags&57344){e.msg="unknown header flags set",t.mode=BAD;break}t.head&&(t.head.text=_>>8&1),t.flags&512&&t.wrap&4&&(ae[0]=_&255,ae[1]=_>>>8&255,t.check=crc32_1(t.check,ae,2,0)),_=0,T=0,t.mode=TIME;case TIME:for(;T<32;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.head&&(t.head.time=_),t.flags&512&&t.wrap&4&&(ae[0]=_&255,ae[1]=_>>>8&255,ae[2]=_>>>16&255,ae[3]=_>>>24&255,t.check=crc32_1(t.check,ae,4,0)),_=0,T=0,t.mode=OS;case OS:for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.head&&(t.head.xflags=_&255,t.head.os=_>>8),t.flags&512&&t.wrap&4&&(ae[0]=_&255,ae[1]=_>>>8&255,t.check=crc32_1(t.check,ae,2,0)),_=0,T=0,t.mode=EXLEN;case EXLEN:if(t.flags&1024){for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.length=_,t.head&&(t.head.extra_len=_),t.flags&512&&t.wrap&4&&(ae[0]=_&255,ae[1]=_>>>8&255,t.check=crc32_1(t.check,ae,2,0)),_=0,T=0}else t.head&&(t.head.extra=null);t.mode=EXTRA;case EXTRA:if(t.flags&1024&&(k=t.length,k>a&&(k=a),k&&(t.head&&(fe=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(o.subarray(d,d+k),fe)),t.flags&512&&t.wrap&4&&(t.check=crc32_1(t.check,o,k,d)),a-=k,d+=k,t.length-=k),t.length))break e;t.length=0,t.mode=NAME;case NAME:if(t.flags&2048){if(a===0)break e;k=0;do fe=o[d+k++],t.head&&fe&&t.length<65536&&(t.head.name+=String.fromCharCode(fe));while(fe&&k<a);if(t.flags&512&&t.wrap&4&&(t.check=crc32_1(t.check,o,k,d)),a-=k,d+=k,fe)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=COMMENT;case COMMENT:if(t.flags&4096){if(a===0)break e;k=0;do fe=o[d+k++],t.head&&fe&&t.length<65536&&(t.head.comment+=String.fromCharCode(fe));while(fe&&k<a);if(t.flags&512&&t.wrap&4&&(t.check=crc32_1(t.check,o,k,d)),a-=k,d+=k,fe)break e}else t.head&&(t.head.comment=null);t.mode=HCRC;case HCRC:if(t.flags&512){for(;T<16;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.wrap&4&&_!==(t.check&65535)){e.msg="header crc mismatch",t.mode=BAD;break}_=0,T=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),e.adler=t.check=0,t.mode=TYPE;break;case DICTID:for(;T<32;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}e.adler=t.check=zswap32(_),_=0,T=0,t.mode=DICT;case DICT:if(t.havedict===0)return e.next_out=g,e.avail_out=b,e.next_in=d,e.avail_in=a,t.hold=_,t.bits=T,Z_NEED_DICT$1;e.adler=t.check=1,t.mode=TYPE;case TYPE:if(r===Z_BLOCK||r===Z_TREES)break e;case TYPEDO:if(t.last){_>>>=T&7,T-=T&7,t.mode=CHECK;break}for(;T<3;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}switch(t.last=_&1,_>>>=1,T-=1,_&3){case 0:t.mode=STORED;break;case 1:if(fixedtables(t),t.mode=LEN_,r===Z_TREES){_>>>=2,T-=2;break e}break;case 2:t.mode=TABLE;break;case 3:e.msg="invalid block type",t.mode=BAD}_>>>=2,T-=2;break;case STORED:for(_>>>=T&7,T-=T&7;T<32;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if((_&65535)!==(_>>>16^65535)){e.msg="invalid stored block lengths",t.mode=BAD;break}if(t.length=_&65535,_=0,T=0,t.mode=COPY_,r===Z_TREES)break e;case COPY_:t.mode=COPY;case COPY:if(k=t.length,k){if(k>a&&(k=a),k>b&&(k=b),k===0)break e;s.set(o.subarray(d,d+k),g),a-=k,d+=k,b-=k,g+=k,t.length-=k;break}t.mode=TYPE;break;case TABLE:for(;T<14;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.nlen=(_&31)+257,_>>>=5,T-=5,t.ndist=(_&31)+1,_>>>=5,T-=5,t.ncode=(_&15)+4,_>>>=4,T-=4,t.nlen>286||t.ndist>30){e.msg="too many length or distance symbols",t.mode=BAD;break}t.have=0,t.mode=LENLENS;case LENLENS:for(;t.have<t.ncode;){for(;T<3;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.lens[Me[t.have++]]=_&7,_>>>=3,T-=3}for(;t.have<19;)t.lens[Me[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,J={bits:t.lenbits},re=inftrees(CODES,t.lens,0,19,t.lencode,0,t.work,J),t.lenbits=J.bits,re){e.msg="invalid code lengths set",t.mode=BAD;break}t.have=0,t.mode=CODELENS;case CODELENS:for(;t.have<t.nlen+t.ndist;){for(;G=t.lencode[_&(1<<t.lenbits)-1],j=G>>>24,te=G>>>16&255,H=G&65535,!(j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(H<16)_>>>=j,T-=j,t.lens[t.have++]=H;else{if(H===16){for(se=j+2;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(_>>>=j,T-=j,t.have===0){e.msg="invalid bit length repeat",t.mode=BAD;break}fe=t.lens[t.have-1],k=3+(_&3),_>>>=2,T-=2}else if(H===17){for(se=j+3;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}_>>>=j,T-=j,fe=0,k=3+(_&7),_>>>=3,T-=3}else{for(se=j+7;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}_>>>=j,T-=j,fe=0,k=11+(_&127),_>>>=7,T-=7}if(t.have+k>t.nlen+t.ndist){e.msg="invalid bit length repeat",t.mode=BAD;break}for(;k--;)t.lens[t.have++]=fe}}if(t.mode===BAD)break;if(t.lens[256]===0){e.msg="invalid code -- missing end-of-block",t.mode=BAD;break}if(t.lenbits=9,J={bits:t.lenbits},re=inftrees(LENS,t.lens,0,t.nlen,t.lencode,0,t.work,J),t.lenbits=J.bits,re){e.msg="invalid literal/lengths set",t.mode=BAD;break}if(t.distbits=6,t.distcode=t.distdyn,J={bits:t.distbits},re=inftrees(DISTS,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,J),t.distbits=J.bits,re){e.msg="invalid distances set",t.mode=BAD;break}if(t.mode=LEN_,r===Z_TREES)break e;case LEN_:t.mode=LEN;case LEN:if(a>=6&&b>=258){e.next_out=g,e.avail_out=b,e.next_in=d,e.avail_in=a,t.hold=_,t.bits=T,inffast(e,D),g=e.next_out,s=e.output,b=e.avail_out,d=e.next_in,o=e.input,a=e.avail_in,_=t.hold,T=t.bits,t.mode===TYPE&&(t.back=-1);break}for(t.back=0;G=t.lencode[_&(1<<t.lenbits)-1],j=G>>>24,te=G>>>16&255,H=G&65535,!(j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(te&&!(te&240)){for(Z=j,W=te,_e=H;G=t.lencode[_e+((_&(1<<Z+W)-1)>>Z)],j=G>>>24,te=G>>>16&255,H=G&65535,!(Z+j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}_>>>=Z,T-=Z,t.back+=Z}if(_>>>=j,T-=j,t.back+=j,t.length=H,te===0){t.mode=LIT;break}if(te&32){t.back=-1,t.mode=TYPE;break}if(te&64){e.msg="invalid literal/length code",t.mode=BAD;break}t.extra=te&15,t.mode=LENEXT;case LENEXT:if(t.extra){for(se=t.extra;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.length+=_&(1<<t.extra)-1,_>>>=t.extra,T-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=DIST;case DIST:for(;G=t.distcode[_&(1<<t.distbits)-1],j=G>>>24,te=G>>>16&255,H=G&65535,!(j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(!(te&240)){for(Z=j,W=te,_e=H;G=t.distcode[_e+((_&(1<<Z+W)-1)>>Z)],j=G>>>24,te=G>>>16&255,H=G&65535,!(Z+j<=T);){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}_>>>=Z,T-=Z,t.back+=Z}if(_>>>=j,T-=j,t.back+=j,te&64){e.msg="invalid distance code",t.mode=BAD;break}t.offset=H,t.extra=te&15,t.mode=DISTEXT;case DISTEXT:if(t.extra){for(se=t.extra;T<se;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}t.offset+=_&(1<<t.extra)-1,_>>>=t.extra,T-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){e.msg="invalid distance too far back",t.mode=BAD;break}t.mode=MATCH;case MATCH:if(b===0)break e;if(k=D-b,t.offset>k){if(k=t.offset-k,k>t.whave&&t.sane){e.msg="invalid distance too far back",t.mode=BAD;break}k>t.wnext?(k-=t.wnext,O=t.wsize-k):O=t.wnext-k,k>t.length&&(k=t.length),U=t.window}else U=s,O=g-t.offset,k=t.length;k>b&&(k=b),b-=k,t.length-=k;do s[g++]=U[O++];while(--k);t.length===0&&(t.mode=LEN);break;case LIT:if(b===0)break e;s[g++]=t.length,b--,t.mode=LEN;break;case CHECK:if(t.wrap){for(;T<32;){if(a===0)break e;a--,_|=o[d++]<<T,T+=8}if(D-=b,e.total_out+=D,t.total+=D,t.wrap&4&&D&&(e.adler=t.check=t.flags?crc32_1(t.check,s,D,g-D):adler32_1(t.check,s,D,g-D)),D=b,t.wrap&4&&(t.flags?_:zswap32(_))!==t.check){e.msg="incorrect data check",t.mode=BAD;break}_=0,T=0}t.mode=LENGTH;case LENGTH:if(t.wrap&&t.flags){for(;T<32;){if(a===0)break e;a--,_+=o[d++]<<T,T+=8}if(t.wrap&4&&_!==(t.total&4294967295)){e.msg="incorrect length check",t.mode=BAD;break}_=0,T=0}t.mode=DONE;case DONE:re=Z_STREAM_END$1;break e;case BAD:re=Z_DATA_ERROR$1;break e;case MEM:return Z_MEM_ERROR$1;case SYNC:default:return Z_STREAM_ERROR$1}return e.next_out=g,e.avail_out=b,e.next_in=d,e.avail_in=a,t.hold=_,t.bits=T,(t.wsize||D!==e.avail_out&&t.mode<BAD&&(t.mode<CHECK||r!==Z_FINISH$1))&&updatewindow(e,e.output,e.next_out,D-e.avail_out),C-=e.avail_in,D-=e.avail_out,e.total_in+=C,e.total_out+=D,t.total+=D,t.wrap&4&&D&&(e.adler=t.check=t.flags?crc32_1(t.check,s,D,e.next_out-D):adler32_1(t.check,s,D,e.next_out-D)),e.data_type=t.bits+(t.last?64:0)+(t.mode===TYPE?128:0)+(t.mode===LEN_||t.mode===COPY_?256:0),(C===0&&D===0||r===Z_FINISH$1)&&re===Z_OK$1&&(re=Z_BUF_ERROR),re},inflateEnd=e=>{if(inflateStateCheck(e))return Z_STREAM_ERROR$1;let r=e.state;return r.window&&(r.window=null),e.state=null,Z_OK$1},inflateGetHeader=(e,r)=>{if(inflateStateCheck(e))return Z_STREAM_ERROR$1;const t=e.state;return t.wrap&2?(t.head=r,r.done=!1,Z_OK$1):Z_STREAM_ERROR$1},inflateSetDictionary=(e,r)=>{const t=r.length;let o,s,d;return inflateStateCheck(e)||(o=e.state,o.wrap!==0&&o.mode!==DICT)?Z_STREAM_ERROR$1:o.mode===DICT&&(s=1,s=adler32_1(s,r,t,0),s!==o.check)?Z_DATA_ERROR$1:(d=updatewindow(e,r,t,t),d?(o.mode=MEM,Z_MEM_ERROR$1):(o.havedict=1,Z_OK$1))};var inflateReset_1=inflateReset,inflateReset2_1=inflateReset2,inflateResetKeep_1=inflateResetKeep,inflateInit_1=inflateInit,inflateInit2_1=inflateInit2,inflate_2$1=inflate$2,inflateEnd_1=inflateEnd,inflateGetHeader_1=inflateGetHeader,inflateSetDictionary_1=inflateSetDictionary,inflateInfo="pako inflate (from Nodeca project)",inflate_1$2={inflateReset:inflateReset_1,inflateReset2:inflateReset2_1,inflateResetKeep:inflateResetKeep_1,inflateInit:inflateInit_1,inflateInit2:inflateInit2_1,inflate:inflate_2$1,inflateEnd:inflateEnd_1,inflateGetHeader:inflateGetHeader_1,inflateSetDictionary:inflateSetDictionary_1,inflateInfo};function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var gzheader=GZheader;const toString$3=Object.prototype.toString,{Z_NO_FLUSH,Z_FINISH,Z_OK,Z_STREAM_END,Z_NEED_DICT,Z_STREAM_ERROR,Z_DATA_ERROR,Z_MEM_ERROR}=constants$2$1;function Inflate$1(e){this.options=common.assign({chunkSize:1024*64,windowBits:15,to:""},e||{});const r=this.options;r.raw&&r.windowBits>=0&&r.windowBits<16&&(r.windowBits=-r.windowBits,r.windowBits===0&&(r.windowBits=-15)),r.windowBits>=0&&r.windowBits<16&&!(e&&e.windowBits)&&(r.windowBits+=32),r.windowBits>15&&r.windowBits<48&&(r.windowBits&15||(r.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;let t=inflate_1$2.inflateInit2(this.strm,r.windowBits);if(t!==Z_OK)throw new Error(messages[t]);if(this.header=new gzheader,inflate_1$2.inflateGetHeader(this.strm,this.header),r.dictionary&&(typeof r.dictionary=="string"?r.dictionary=strings.string2buf(r.dictionary):toString$3.call(r.dictionary)==="[object ArrayBuffer]"&&(r.dictionary=new Uint8Array(r.dictionary)),r.raw&&(t=inflate_1$2.inflateSetDictionary(this.strm,r.dictionary),t!==Z_OK)))throw new Error(messages[t])}Inflate$1.prototype.push=function(e,r){const t=this.strm,o=this.options.chunkSize,s=this.options.dictionary;let d,g,a;if(this.ended)return!1;for(r===~~r?g=r:g=r===!0?Z_FINISH:Z_NO_FLUSH,toString$3.call(e)==="[object ArrayBuffer]"?t.input=new Uint8Array(e):t.input=e,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(o),t.next_out=0,t.avail_out=o),d=inflate_1$2.inflate(t,g),d===Z_NEED_DICT&&s&&(d=inflate_1$2.inflateSetDictionary(t,s),d===Z_OK?d=inflate_1$2.inflate(t,g):d===Z_DATA_ERROR&&(d=Z_NEED_DICT));t.avail_in>0&&d===Z_STREAM_END&&t.state.wrap>0&&e[t.next_in]!==0;)inflate_1$2.inflateReset(t),d=inflate_1$2.inflate(t,g);switch(d){case Z_STREAM_ERROR:case Z_DATA_ERROR:case Z_NEED_DICT:case Z_MEM_ERROR:return this.onEnd(d),this.ended=!0,!1}if(a=t.avail_out,t.next_out&&(t.avail_out===0||d===Z_STREAM_END))if(this.options.to==="string"){let b=strings.utf8border(t.output,t.next_out),_=t.next_out-b,T=strings.buf2string(t.output,b);t.next_out=_,t.avail_out=o-_,_&&t.output.set(t.output.subarray(b,b+_),0),this.onData(T)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(d===Z_OK&&a===0)){if(d===Z_STREAM_END)return d=inflate_1$2.inflateEnd(this.strm),this.onEnd(d),this.ended=!0,!0;if(t.avail_in===0)break}}return!0};Inflate$1.prototype.onData=function(e){this.chunks.push(e)};Inflate$1.prototype.onEnd=function(e){e===Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function inflate$1(e,r){const t=new Inflate$1(r);if(t.push(e),t.err)throw t.msg||messages[t.err];return t.result}function inflateRaw$1(e,r){return r=r||{},r.raw=!0,inflate$1(e,r)}var Inflate_1$1=Inflate$1,inflate_2=inflate$1,inflateRaw_1$1=inflateRaw$1,ungzip$1=inflate$1,constants$a=constants$2$1,inflate_1$1={Inflate:Inflate_1$1,inflate:inflate_2,inflateRaw:inflateRaw_1$1,ungzip:ungzip$1,constants:constants$a};const{Inflate,inflate,inflateRaw,ungzip}=inflate_1$1;var inflate_1=inflate;function decompressZlib(e){const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),t=inflate_1(r);return new DataView(t.buffer,t.byteOffset,t.byteLength)}const defaultOptions$c={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder extends IOBuffer$4{constructor(r){super(r),this._nextIFD=0}get isMultiPage(){let r=0;for(this.decodeHeader();this._nextIFD;)if(r++,this.decodeIFD({ignoreImageData:!0},!0),r===2)return!0;if(r===1)return!1;throw unsupported("ifdCount",r)}get pageCount(){let r=0;for(this.decodeHeader();this._nextIFD;)r++,this.decodeIFD({ignoreImageData:!0},!0);if(r>0)return r;throw unsupported("ifdCount",r)}decode(r={}){r=Object.assign({},defaultOptions$c,r);const t=[];for(this.decodeHeader();this._nextIFD;)if(t.push(this.decodeIFD(r,!0)),r.onlyFirst)return[t[0]];return t}decodeHeader(){const r=this.readUint16();if(r===18761)this.setLittleEndian();else if(r===19789)this.setBigEndian();else throw new Error(`invalid byte order: 0x${r.toString(16)}`);if(this.readUint16()!==42)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(r,t){this.seek(this._nextIFD);let o;if(t)o=new TiffIfd;else{if(!r.kind)throw new Error("kind is missing");o=new IFD(r.kind)}const s=this.readUint16();for(let d=0;d<s;d++)this.decodeIFDEntry(o);if(!r.ignoreImageData){if(!(o instanceof TiffIfd))throw new Error("must be a tiff ifd");this.decodeImageData(o)}return this._nextIFD=this.readUint32(),o}decodeIFDEntry(r){const t=this.offset,o=this.readUint16(),s=this.readUint16(),d=this.readUint32();if(s<1||s>12){this.skip(4);return}getByteLength(s,d)>4&&this.seek(this.readUint32());const a=readData(this,s,d);if(r.fields.set(o,a),o===34665||o===34853){let b=this.offset,_="exif";o===34665?_="exif":o===34853&&(_="gps"),this._nextIFD=a,r[_]=this.decodeIFD({kind:_,ignoreImageData:!0},!1),this.offset=b}this.seek(t),this.skip(12)}decodeImageData(r){const t=r.orientation;if(t&&t!==1)throw unsupported("orientation",t);switch(r.type){case 0:case 1:case 2:case 3:this.readStripData(r);break;default:throw unsupported("image type",r.type)}if(this.applyPredictor(r),this.convertAlpha(r),r.type===0){const o=r.bitsPerSample,s=Math.pow(2,o)-1;for(let d=0;d<r.data.length;d++)r.data[d]=s-r.data[d]}}readStripData(r){const t=r.width,o=r.height,s=r.bitsPerSample,d=r.sampleFormat,g=t*o*r.samplesPerPixel,a=getDataArray(g,s,d),_=r.rowsPerStrip*t*r.samplesPerPixel,T=r.stripOffsets,C=r.stripByteCounts||guessStripByteCounts(r);let D=g,k=0;for(let O=0;O<T.length;O++){let U=new DataView(this.buffer,this.byteOffset+T[O],C[O]),G=D>_?_:D;D-=G;let j=U;switch(r.compression){case 1:break;case 5:{j=decompressLzw(U);break}case 8:{j=decompressZlib(U);break}case 2:throw unsupported("Compression","CCITT Group 3");case 32773:throw unsupported("Compression","PackBits");default:throw unsupported("Compression",r.compression)}k=this.fillUncompressed(s,d,a,j,k,G)}r.data=a}fillUncompressed(r,t,o,s,d,g){if(r===8)return fill8bit(o,s,d,g);if(r===16)return fill16bit(o,s,d,g,this.isLittleEndian());if(r===32&&t===3)return fillFloat32(o,s,d,g,this.isLittleEndian());throw unsupported("bitDepth",r)}applyPredictor(r){const t=r.bitsPerSample;switch(r.predictor){case 1:break;case 2:{if(t===8)applyHorizontalDifferencing8Bit(r.data,r.width,r.components);else if(t===16)applyHorizontalDifferencing16Bit(r.data,r.width,r.components);else throw new Error(`Horizontal differencing is only supported for images with a bit depth of ${t}`);break}default:throw new Error(`invalid predictor: ${r.predictor}`)}}convertAlpha(r){if(r.alpha&&r.associatedAlpha){const{data:t,components:o,maxSampleValue:s}=r;for(let d=0;d<t.length;d+=o){const g=t[d+o-1];for(let a=0;a<o-1;a++)t[d+a]=Math.round(t[d+a]*s/g)}}}}function getDataArray(e,r,t){if(r===8)return new Uint8Array(e);if(r===16)return new Uint16Array(e);if(r===32&&t===3)return new Float32Array(e);throw unsupported("bit depth / sample format",`${r} / ${t}`)}function fill8bit(e,r,t,o){for(let s=0;s<o;s++)e[t++]=r.getUint8(s);return t}function fill16bit(e,r,t,o,s){for(let d=0;d<o*2;d+=2)e[t++]=r.getUint16(d,s);return t}function fillFloat32(e,r,t,o,s){for(let d=0;d<o*4;d+=4)e[t++]=r.getFloat32(d,s);return t}function unsupported(e,r){return new Error(`Unsupported ${e}: ${r}`)}function decodeTIFF(e,r){return new TIFFDecoder(e).decode(r)}function matchAndCrop(e={}){let{algorithm:r="matchToPrevious",ignoreBorder:t=[0,0]}=e;this.checkProcessable("matchAndCrop",{bitDepth:[8,16]});let o=r==="matchToPrevious",s=this[0],d=[];d[0]={position:[0,0],image:this[0]};let g=[0,0];for(let D=1;D<this.length;D++){let k=s.getBestMatch(this[D],{border:t});d[D]={position:[k[0]+g[0],k[1]+g[1]],image:this[D]},o&&(g[0]+=k[0],g[1]+=k[1],s=this[D])}let a=0,b=0,_=0,T=0;for(let D=0;D<d.length;D++){let k=d[D];k.position[0]>a&&(a=k.position[0]),k.position[0]<b&&(b=k.position[0]),k.position[1]>_&&(_=k.position[1]),k.position[1]<T&&(T=k.position[1])}b=0-b,T=0-T;for(let D=0;D<d.length;D++){let k=d[D];k.crop=k.image.crop({x:a-k.position[0],y:_-k.position[1],width:s.width-b-a,height:s.height-T-_})}let C=[];for(let D=0;D<d.length;D++)C[D]=d[D].crop;return new Stack(C)}function min$2(){this.checkProcessable("min",{bitDepth:[8,16]});let e=this[0].min;for(let r=1;r<this.length;r++)for(let t=0;t<e.length;t++)e[t]=Math.min(e[t],this[r].min[t]);return e}function max$2(){this.checkProcessable("min",{bitDepth:[8,16]});let e=this[0].max;for(let r=1;r<this.length;r++)for(let t=0;t<e.length;t++)e[t]=Math.max(e[t],this[r].max[t]);return e}function median$2(e){let r=e.reduce((g,a)=>g+a);if(r===0)throw new Error("unreachable");let t=0,o=0,s=r/2,d;for(;;){if(e[t]>0){if(d!==void 0)return(d+t)/2;if(o+=e[t],o>s)return t;o===s&&(d=t)}t++}}function mean$2(e){let r=0,t=0;for(let o=0;o<e.length;o++)r+=e[o],t+=e[o]*o;return r===0?0:t/r}function median$1(){this.checkProcessable("median",{bitDepth:[8,16]});let e=this.getHistograms({maxSlots:this[0].maxValue+1}),r=new Array(e.length);for(let t=0;t<e.length;t++){let o=e[t];r[t]=median$2(o)}return r}function histogram(e){this.checkProcessable("min",{bitDepth:[8,16]});let r=this[0].getHistogram(e);for(let t=1;t<this.length;t++){let o=this[t].getHistogram(e);for(let s=0;s<r.length;s++)r[s]+=o[s]}return r}function histograms(e){this.checkProcessable("min",{bitDepth:[8,16]});let r=this[0].getHistograms(e),t=r[0].length;for(let o=1;o<this.length;o++){let s=this[o].getHistograms(e);for(let d=0;d<r.length;d++)for(let g=0;g<t;g++)r[d][g]+=s[d][g]}return r}function averageImage(){this.checkProcessable("averageImage",{bitDepth:[8,16]});let e=new Uint32Array(this[0].data.length);for(let o=0;o<this.length;o++){let s=this[o];for(let d=0;d<this[0].data.length;d++)e[d]+=s.data[d]}let r=Image.createFrom(this[0]),t=r.data;for(let o=0;o<this[0].data.length;o++)t[o]=e[o]/this.length;return r}function maxImage(){this.checkProcessable("max",{bitDepth:[8,16]});let e=Image.createFrom(this[0]);e.data.fill(0);for(const r of this)for(let t=0;t<e.data.length;t++)e.data[t]=Math.max(r.data[t],e.data[t]);return e}function minImage(){this.checkProcessable("max",{bitDepth:[8,16]});let e=Image.createFrom(this[0]);e.data.fill(e.maxValue);for(const r of this)for(let t=0;t<e.data.length;t++)e.data[t]=Math.min(r.data[t],e.data[t]);return e}function extend$5(e){e.extendMethod("matchAndCrop",matchAndCrop),e.extendMethod("getMin",min$2),e.extendMethod("getMax",max$2),e.extendMethod("getMedian",median$1),e.extendMethod("getHistogram",histogram),e.extendMethod("getHistograms",histograms),e.extendMethod("getAverage",averageImage),e.extendMethod("getAverageImage",averageImage),e.extendMethod("getMaxImage",maxImage),e.extendMethod("getMinImage",minImage)}let computedPropertyDescriptor={configurable:!0,enumerable:!1,get:void 0};class Stack extends Array{constructor(r){if(Array.isArray(r)){super(r.length);for(let t=0;t<r.length;t++)this[t]=r[t]}else typeof r=="number"?super(r):super();this.computed=null}static load(r){return Promise.all(r.map(Image.load)).then(t=>new Stack(t))}static extendMethod(r,t,o={}){let{inPlace:s=!1,returnThis:d=!0,partialArgs:g=[]}=o;return s?Stack.prototype[r]=function(...a){this.computed=null;let b=t.apply(this,[...g,...a]);return d?this:b}:Stack.prototype[r]=function(...a){return t.apply(this,[...g,...a])},Stack}static extendProperty(r,t,o={}){let{partialArgs:s=[]}=o;return computedPropertyDescriptor.get=function(){if(this.computed===null)this.computed={};else if(hasOwn(r,this.computed))return this.computed[r];let d=t.apply(this,s);return this.computed[r]=d,d},Object.defineProperty(Stack.prototype,r,computedPropertyDescriptor),Stack}checkProcessable(r,t={}){if(typeof r!="string")throw new TypeError("checkProcessable requires as first parameter the processName (a string)");if(this.size===0)throw new TypeError(`The process: ${r} can not be applied on an empty stack`);this[0].checkProcessable(r,t);for(let o=1;o<this.length;o++){if((t.sameSize===void 0||t.sameSize)&&this[0].width!==this[o].width)throw new TypeError(`The process: ${r} can not be applied if width is not identical in all images`);if((t.sameSize===void 0||t.sameSize)&&this[0].height!==this[o].height)throw new TypeError(`The process: ${r} can not be applied if height is not identical in all images`);if((t.sameAlpha===void 0||t.sameAlpha)&&this[0].alpha!==this[o].alpha)throw new TypeError(`The process: ${r} can not be applied if alpha is not identical in all images`);if((t.sameBitDepth===void 0||t.sameBitDepth)&&this[0].bitDepth!==this[o].bitDepth)throw new TypeError(`The process: ${r} can not be applied if bitDepth is not identical in all images`);if((t.sameColorModel===void 0||t.sameColorModel)&&this[0].colorModel!==this[o].colorModel)throw new TypeError(`The process: ${r} can not be applied if colorModel is not identical in all images`);if((t.sameNumberChannels===void 0||t.sameNumberChannels)&&this[0].channels!==this[o].channels)throw new TypeError(`The process: ${r} can not be applied if channels is not identical in all images`)}}}Array[Symbol.species]||(Stack.prototype.map=function(e,r){if(typeof e!="function")throw new TypeError(`${e} is not a function`);let t=new Stack(this.length);for(let o=0;o<this.length;o++)t[o]=e.call(r,this[o],o,this);return t});extend$5(Stack);const isDataURL=/^data:[a-z]+\/(?:[a-z]+);base64,/;function load(e,r){if(typeof e=="string")return loadURL(e,r);if(e instanceof ArrayBuffer)return Promise.resolve(loadBinary(new Uint8Array(e),void 0,r&&r.ignorePalette));if(e.buffer)return Promise.resolve(loadBinary(e,void 0,r&&r.ignorePalette));throw new Error('argument to "load" must be a string or buffer.')}function loadBinary(e,r,t){const o=imageType$1(e);if(o)switch(o.mime){case"image/png":return loadPNG(e);case"image/jpeg":return loadJPEG(e);case"image/tiff":return loadTIFF(e,t);default:return loadGeneric(s(o.mime))}return loadGeneric(s("application/octet-stream"));function s(d){return r||toBase64URL(e,d)}}function loadURL(e,r){const t=e.slice(0,64).match(isDataURL);let o;return t!==null?o=Promise.resolve(decode$3(e.slice(t[0].length))):o=fetchBinary(e,r),o.then(s=>{const d=new Uint8Array(s);return loadBinary(d,t?e:void 0,r&&r.ignorePalette)})}function loadPNG(e){const r=decodePng(e);let t=r.channels,o,s=0;return t===2||t===4?(o=t-1,s=1):o=t,r.palette?loadPNGFromPalette(r):new Image(r.width,r.height,r.data,{components:o,alpha:s,bitDepth:r.depth})}function loadPNGFromPalette(e){const r=e.width*e.height,t=e.palette[0].length,o=new Uint8Array(r*t),s=8/e.depth,d=e.depth<8?s:1,g=parseInt("1".repeat(e.depth),2),a=t===4;let b=0;for(let _=0;_<r;_++){const T=Math.floor(_/d);let C=e.data[T];e.depth<8&&(C=C>>>e.depth*(s-1-_%s)&g);const D=e.palette[C];o[b++]=D[0],o[b++]=D[1],o[b++]=D[2],a&&(o[b++]=D[3])}return new Image(e.width,e.height,o,{components:3,alpha:a,bitDepth:8})}function loadJPEG(e){const r=decode(e);let t;r.exif&&(t=getMetadata(r.exif));const o=jpegJs.decode(e,{useTArray:!0,maxMemoryUsageInMB:1024});let s=new Image(o.width,o.height,o.data,{meta:t});if(t&&t.tiff.tags.Orientation){const d=t.tiff.tags.Orientation;d>2&&(s=s.rotate({3:180,4:180,5:90,6:90,7:270,8:270}[d])),[2,4,5,7].includes(d)&&(s=s.flipX())}return s}function loadTIFF(e,r){let t=decodeTIFF(e);return t.length===1?getImageFromIFD(t[0],r):new Stack(t.map(function(o){return getImageFromIFD(o,r)}))}function getMetadata(e){const r={tiff:{fields:e.fields,tags:e.map}};return e.exif&&(r.exif=e.exif),e.gps&&(r.gps=e.gps),r}function getImageFromIFD(e,r){if(!r&&e.type===3){const t=new Uint16Array(3*e.width*e.height),o=e.palette;let s=0;for(let d=0;d<e.data.length;d++){const g=e.data[d],a=o[g];t[s++]=a[0],t[s++]=a[1],t[s++]=a[2]}return new Image(e.width,e.height,t,{components:3,alpha:e.alpha,colorModel:RGB$1,bitDepth:16,meta:getMetadata(e)})}else return new Image(e.width,e.height,e.data,{components:e.type===2?3:1,alpha:e.alpha,colorModel:e.type===2?RGB$1:GREY$1,bitDepth:e.bitsPerSample.length?e.bitsPerSample[0]:e.bitsPerSample,meta:getMetadata(e)})}function loadGeneric(e,r){return r=r||{},new Promise(function(t,o){let s=new DOMImage;s.onload=function(){let d=s.width,g=s.height,b=createCanvas(d,g).getContext("2d");b.drawImage(s,0,0,d,g);let _=b.getImageData(0,0,d,g).data;t(new Image(d,g,_,r))},s.onerror=function(){o(new Error(`Could not load ${e}`))},s.src=e})}const valueMethods={getValueXY(e,r,t){return this.data[(r*this.width+e)*this.channels+t]},setValueXY(e,r,t,o){return this.data[(r*this.width+e)*this.channels+t]=o,this.computed=null,this},getValue(e,r){return this.data[e*this.channels+r]},setValue(e,r,t){return this.data[e*this.channels+r]=t,this.computed=null,this},getPixelXY(e,r){return this.getPixel(r*this.width+e)},setPixelXY(e,r,t){return this.setPixel(r*this.width+e,t)},getPixel(e){const r=new Array(this.channels),t=e*this.channels;for(let o=0;o<this.channels;o++)r[o]=this.data[t+o];return r},setPixel(e,r){const t=e*this.channels;for(let o=0;o<r.length;o++)this.data[t+o]=r[o];return this.computed=null,this}};function setValueMethods(e){for(const r in valueMethods)e.prototype[r]=valueMethods[r]}function getImageParameters(e){return{width:e.width,height:e.height,components:e.components,alpha:e.alpha,colorModel:e.colorModel,bitDepth:e.bitDepth}}function getOutputImage(e,r,t,o={}){const{out:s}=r;if(s===void 0)return o.copy?e.clone():Image.createFrom(e,t);{if(!Image.isImage(s))throw new TypeError("out must be an Image object");const d=Object.assign(getImageParameters(e),t);for(const g in d)if(s[g]!==d[g])throw new RangeError(`cannot use out. Its ${g} must be "${d[g]}" (found "${s[g]}")`);return s}}function getOutputImageOrInPlace(e,r,t){if(r.inPlace!==void 0&&typeof r.inPlace!="boolean")throw new TypeError("inPlace option must be a boolean");if(r.inPlace){if(r.out!==void 0)throw new TypeError("out option must not be set if inPlace option is true");return e}return getOutputImage(e,r,null,t)}function abs(e={}){this.checkProcessable("abs",{bitDepth:[32]});const r=getOutputImageOrInPlace(this,e);return absolute(this,r),r}function absolute(e,r){for(let t=0;t<e.data.length;t++)r.data[t]=Math.abs(e.data[t])}function copyAlphaChannel(e,r){if(e.alpha===1&&r.alpha===1)for(let t=0;t<e.size;t++)r.data[t*r.channels+r.components]=e.data[t*e.channels+e.components]}function invert(e={}){this.checkProcessable("invert",{bitDepth:[1,8,16]});const r=getOutputImageOrInPlace(this,e);return this.bitDepth===1?invertBinary(this,r):(invertColor(this,r),this!==r&&copyAlphaChannel(this,r)),r}function invertBinary(e,r){for(let t=0;t<e.data.length;t++)r.data[t]=~e.data[t]}function invertColor(e,r){for(let t=0;t<e.data.length;t+=e.channels)for(let o=0;o<e.components;o++)r.data[t+o]=e.maxValue-e.data[t+o]}function flipX(){this.checkProcessable("flipX",{bitDepth:[8,16]});for(let e=0;e<this.height;e++){let r=e*this.width*this.channels;for(let t=0;t<Math.floor(this.width/2);t++){let o=t*this.channels+r,s=(this.width-t-1)*this.channels+r;for(let d=0;d<this.channels;d++){let g=this.data[o+d];this.data[o+d]=this.data[s+d],this.data[s+d]=g}}}return this}function flipY(){this.checkProcessable("flipY",{bitDepth:[8,16]});for(let e=0;e<Math.floor(this.height/2);e++)for(let r=0;r<this.width;r++){let t=r*this.channels+e*this.width*this.channels,o=r*this.channels+(this.height-1-e)*this.channels*this.width;for(let s=0;s<this.channels;s++){let d=this.data[t+s];this.data[t+s]=this.data[o+s],this.data[o+s]=d}}return this}function blurFilter(e={}){const{radius:r=1}=e;if(r<1)throw new Error("radius must be greater than 1");const t=2*r+1,o=new Array(t);for(let s=0;s<t;s++){o[s]=new Array(t);for(let d=0;d<t;d++)o[s][d]=1/(t*t)}return this.convolution(o)}var medianQuickselect_min={exports:{}};(function(e){(function(){function r(s){for(var d=0,g=s.length-1,a=void 0,b=void 0,_=void 0,T=o(d,g);;){if(g<=d)return s[T];if(g==d+1)return s[d]>s[g]&&t(s,d,g),s[T];for(a=o(d,g),s[a]>s[g]&&t(s,a,g),s[d]>s[g]&&t(s,d,g),s[a]>s[d]&&t(s,a,d),t(s,a,d+1),b=d+1,_=g;;){do b++;while(s[d]>s[b]);do _--;while(s[_]>s[d]);if(_<b)break;t(s,b,_)}t(s,d,_),_<=T&&(d=b),_>=T&&(g=_-1)}}var t=function(d,g,a){var b;return b=[d[a],d[g]],d[g]=b[0],d[a]=b[1],b},o=function(d,g){return~~((d+g)/2)};e.exports?e.exports=r:window.median=r})()})(medianQuickselect_min);var medianQuickselect_minExports=medianQuickselect_min.exports;const quickSelectMedian=getDefaultExportFromCjs(medianQuickselect_minExports);function validateArrayOfChannels(e,r={}){let{channels:t,allowAlpha:o,defaultAlpha:s}=r;return typeof o!="boolean"&&(o=!0),typeof t>"u"?allChannels(e,s):validateChannels(e,t,o)}function allChannels(e,r){let t=r?e.channels:e.components,o=new Array(t);for(let s=0;s<t;s++)o[s]=s;return o}function validateChannels(e,r,t){Array.isArray(r)||(r=[r]);for(let o=0;o<r.length;o++)r[o]=validateChannel(e,r[o],t);return r}function validateChannel(e,r,t=!0){if(r===void 0)throw new RangeError(`validateChannel : the channel has to be >=0 and <${e.channels}`);if(typeof r=="string"){switch(e.colorModel){case GREY$1:break;case RGB$1:if("rgb".includes(r))switch(r){case"r":r=0;break;case"g":r=1;break;case"b":r=2;break}break;case HSL:if("hsl".includes(r))switch(r){case"h":r=0;break;case"s":r=1;break;case"l":r=2;break}break;case HSV:if("hsv".includes(r))switch(r){case"h":r=0;break;case"s":r=1;break;case"v":r=2;break}break;case CMYK$1:if("cmyk".includes(r))switch(r){case"c":r=0;break;case"m":r=1;break;case"y":r=2;break;case"k":r=3;break}break;default:throw new Error(`Unexpected color model: ${e.colorModel}`)}if(r==="a"){if(!e.alpha)throw new Error("validateChannel : the image does not contain alpha channel");r=e.components}if(typeof r=="string")throw new Error(`validateChannel : undefined channel: ${r}`)}if(r>=e.channels)throw new RangeError(`validateChannel : the channel has to be >=0 and <${e.channels}`);if(!t&&r>=e.components)throw new RangeError("validateChannel : alpha channel may not be selected");return r}function medianFilter(e={}){let{radius:r=1,border:t="copy",channels:o}=e;if(this.checkProcessable("medianFilter",{bitDepth:[8,16]}),r<1)throw new Error("radius must be greater than 0");o=validateArrayOfChannels(this,o);let s=r,d=r,g=Image.createFrom(this),a=(s*2+1)*(d*2+1),b=new Array(a);for(let _=0;_<o.length;_++){let T=o[_];for(let C=d;C<this.height-d;C++)for(let D=s;D<this.width-s;D++){let k=0;for(let U=-d;U<=d;U++)for(let G=-s;G<=s;G++){let j=((C+U)*this.width+D+G)*this.channels+T;b[k++]=this.data[j]}let O=(C*this.width+D)*this.channels+T;g.data[O]=quickSelectMedian(b)}}if(this.alpha&&!o.includes(this.channels))for(let _=this.components;_<this.data.length;_=_+this.channels)g.data[_]=this.data[_];return g.setBorder({size:[s,d],algorithm:t}),g}function gaussianFilter(e={}){let{radius:r=1,sigma:t,channels:o,border:s="copy"}=e;this.checkProcessable("gaussian",{bitDepth:[8,16]});const d=getKernel(r,t);return this.convolution([d,d],{border:s,channels:o,algorithm:"separable"})}function getKernel(e,r){const t=e*2+1,o=new Array(t),s=r||((t-1)*.5-1)*.3+.8,d=-.5/(s*s);let g=0;for(let a=0;a<t;a++){const b=a-e,_=Math.exp(d*b*b);o[a]=_,g+=_}for(let a=0;a<t;a++)o[a]/=g;return o}const SOBEL_X=[[-1,0,1],[-2,0,2],[-1,0,1]],SOBEL_Y=[[-1,-2,-1],[0,0,0],[1,2,1]],SCHARR_X=[[3,0,-3],[10,0,-10],[3,0,-3]],SCHARR_Y=[[3,10,3],[0,0,0],[-3,-10,-3]];var src$3={},fftlib={};(function(e){(function(){var r;r=e;var t={release:"0.3.0",date:"2013-03"};r.toString=function(){return"version "+t.release+", released "+t.date};for(var o=0,s=null,d=null,g={init:function(_){if(_!==0&&!(_&_-1))o=_,g._initArray(),g._makeBitReversalTable(),g._makeCosSinTable();else throw new Error("init: radix-2 required")},fft1d:function(_,T){g.fft(_,T,1)},ifft1d:function(_,T){var C=1/o;g.fft(_,T,-1);for(var D=0;D<o;D++)_[D]*=C,T[D]*=C},bt1d:function(_,T){g.fft(_,T,-1)},fft2d:function(_,T){for(var C=[],D=[],k=0,O=0;O<o;O++){k=O*o;for(var U=0;U<o;U++)C[U]=_[U+k],D[U]=T[U+k];g.fft1d(C,D);for(var G=0;G<o;G++)_[G+k]=C[G],T[G+k]=D[G]}for(var j=0;j<o;j++){for(var te=0;te<o;te++)k=j+te*o,C[te]=_[k],D[te]=T[k];g.fft1d(C,D);for(var H=0;H<o;H++)k=j+H*o,_[k]=C[H],T[k]=D[H]}},ifft2d:function(_,T){for(var C=[],D=[],k=0,O=0;O<o;O++){k=O*o;for(var U=0;U<o;U++)C[U]=_[U+k],D[U]=T[U+k];g.ifft1d(C,D);for(var G=0;G<o;G++)_[G+k]=C[G],T[G+k]=D[G]}for(var j=0;j<o;j++){for(var te=0;te<o;te++)k=j+te*o,C[te]=_[k],D[te]=T[k];g.ifft1d(C,D);for(var H=0;H<o;H++)k=j+H*o,_[k]=C[H],T[k]=D[H]}},fft:function(_,T,C){for(var D,k,O,U,G,j,te,H,Z,W=o>>2,_e=0;_e<o;_e++)U=s[_e],_e<U&&(G=_[_e],_[_e]=_[U],_[U]=G,G=T[_e],T[_e]=T[U],T[U]=G);for(var fe=1;fe<o;fe<<=1){k=0,D=o/(fe<<1);for(var re=0;re<fe;re++){j=d[k+W],te=C*d[k];for(var ae=re;ae<o;ae+=fe<<1)O=ae+fe,H=j*_[O]+te*T[O],Z=j*T[O]-te*_[O],_[O]=_[ae]-H,_[ae]+=H,T[O]=T[ae]-Z,T[ae]+=Z;k+=D}}},_initArray:function(){typeof Uint32Array<"u"?s=new Uint32Array(o):s=[],typeof Float64Array<"u"?d=new Float64Array(o*1.25):d=[]},_paddingZero:function(){},_makeBitReversalTable:function(){var _=0,T=0,C=0;for(s[0]=0;++_<o;){for(C=o>>1;C<=T;)T-=C,C>>=1;T+=C,s[_]=T}},_makeCosSinTable:function(){var _=o>>1,T=o>>2,C=o>>3,D=_+T,k=Math.sin(Math.PI/o),O=2*k*k,U=Math.sqrt(O*(2-O)),G=d[T]=1,j=d[0]=0;k=2*O;for(var te=1;te<C;te++)G-=O,O+=k*G,j+=U,U-=k*j,d[te]=j,d[T-te]=G;C!==0&&(d[C]=Math.sqrt(.5));for(var H=0;H<T;H++)d[_-H]=d[H];for(var Z=0;Z<D;Z++)d[Z+_]=-d[Z]}},a=["init","fft1d","ifft1d","fft2d","ifft2d"],b=0;b<a.length;b++)r[a[b]]=g[a[b]];return r.bt=g.bt1d,r.fft=g.fft1d,r.ifft=g.ifft1d,r}).call(commonjsGlobal)})(fftlib);var FFT$1=fftlib,FFTUtils$1={DEBUG:!1,ifft2DArray:function(e,r,t){var o=new Array(r*t),s=r/2,d=(t-1)*2;FFT$1.init(s);for(var g={re:new Array(s),im:new Array(s)},a=0;a<t;a++){for(var b=s-1;b>=0;b--)g.re[b]=e[b*2*t+a],g.im[b]=e[(b*2+1)*t+a];FFT$1.bt(g.re,g.im);for(var b=s-1;b>=0;b--)o[b*2*t+a]=g.re[b],o[(b*2+1)*t+a]=g.im[b]}var _=new Array(s*d);FFT$1.init(d);for(var T={re:new Array(d),im:new Array(d)},C=d*s,b=0;b<r;b+=2){T.re[0]=o[b*t],T.im[0]=o[(b+1)*t];for(var a=1;a<t;a++)T.re[a]=o[b*t+a],T.im[a]=o[(b+1)*t+a],T.re[d-a]=o[b*t+a],T.im[d-a]=-o[(b+1)*t+a];FFT$1.bt(T.re,T.im);for(var D=b/2*d,a=d-1;a>=0;a--)_[D+a]=T.re[a]/C}return _},fft2DArray:function(e,r,t,o){Object.assign({},{inplace:!0});var s=t/2+1,d=r*2,g=new Array(d*s);FFT$1.init(t);for(var a={re:new Array(t),im:new Array(t)},b={re:new Array(t),im:new Array(t)},_={re:new Array(t),im:new Array(t)},T,C,D,k,O,U=0;U<r/2;U++){T=U*2*t,a.re=e.slice(T,T+t),T=(U*2+1)*t,a.im=e.slice(T,T+t),FFT$1.fft1d(a.re,a.im),this.reconstructTwoRealFFT(a,b,_),C=U*4*s,D=(U*4+1)*s,k=(U*4+2)*s,O=(U*4+3)*s;for(var G=s-1;G>=0;G--)g[C+G]=b.re[G],g[D+G]=b.im[G],g[k+G]=_.re[G],g[O+G]=_.im[G]}b=null,_=null;var j=new Array(d*s);FFT$1.init(r);for(var te={re:new Array(r),im:new Array(r)},H=s-1;H>=0;H--){for(var U=r-1;U>=0;U--)te.re[U]=g[U*2*s+H],te.im[U]=g[(U*2+1)*s+H],isNaN(te.re[U])&&(te.re[U]=0),isNaN(te.im[U])&&(te.im[U]=0);FFT$1.fft1d(te.re,te.im);for(var U=r-1;U>=0;U--)j[U*2*s+H]=te.re[U],j[(U*2+1)*s+H]=te.im[U]}return j},reconstructTwoRealFFT:function(e,r,t){var o=e.re.length;r.re[0]=e.re[0],r.im[0]=0,t.re[0]=e.im[0],t.im[0]=0;for(var s,d,g,a,b,_=o/2;_>0;_--)b=o-_,s=.5*(e.re[_]-e.re[b]),d=.5*(e.re[_]+e.re[b]),g=.5*(e.im[_]-e.im[b]),a=.5*(e.im[_]+e.im[b]),r.re[_]=d,r.im[_]=g,r.re[b]=d,r.im[b]=-g,t.re[_]=a,t.im[_]=-s,t.re[b]=a,t.im[b]=s},convolute2DI:function(e,r,t,o){for(var s,d,g=0;g<t/2;g++)for(var a=0;a<o;a++)s=e[g*2*o+a]*r[g*2*o+a]-e[(g*2+1)*o+a]*r[(g*2+1)*o+a],d=e[g*2*o+a]*r[(g*2+1)*o+a]+e[(g*2+1)*o+a]*r[g*2*o+a],e[g*2*o+a]=s,e[(g*2+1)*o+a]=d},convolute:function(e,r,t,o,s){for(var d=new Array(o*t),g=0;g<t*o;g++)d[g]=e[g];d=this.fft2DArray(d,t,o);for(var a=r.length,b=r[0].length,_=new Array(o*t),g=0;g<o*t;g++)_[g]=0;for(var T,C,D=Math.floor((a-1)/2),k=Math.floor((b-1)/2),O=0;O<a;O++){T=(O-D+t)%t;for(var U=0;U<b;U++)C=(U-k+o)%o,_[T*o+C]=r[O][U]}_=this.fft2DArray(_,t,o);var G=t*2,j=o/2+1;return this.convolute2DI(d,_,G,j),this.ifft2DArray(d,G,j)},toRadix2:function(e,r,t){var o,s,d,g,a=t,b=r;if(!(t!==0&&!(t&t-1))){for(a=0;t>>++a;);a=1<<a}if(!(r!==0&&!(r&r-1))){for(b=0;r>>++b;);b=1<<b}if(b==r&&a==t)return{data:e,rows:r,cols:t};var _=new Array(b*a),T=Math.floor((b-r)/2)-r,C=Math.floor((a-t)/2)-t;for(o=0;o<b;o++)for(d=o*a,g=(o-T)%r*t,s=0;s<a;s++)_[d+s]=e[g+(s-C)%t];return{data:_,rows:b,cols:a}},crop:function(e,r,t,o,s,d){if(r==o&&t==s)return e;Object.assign({},d);var g=new Array(s*o),a=Math.floor((r-o)/2),b=Math.floor((t-s)/2),_,T,C,D;for(C=0;C<o;C++)for(_=C*s,T=(C+a)*t,D=0;D<s;D++)g[_+D]=e[T+(D+b)];return g}},FFTUtils_1=FFTUtils$1;src$3.FFTUtils=FFTUtils_1;src$3.FFT=fftlib;var FFTUtils=src$3.FFTUtils;function convolutionFFT(e,r,t){var o=matrix2Array(e),s=o.data,d=Object.assign({normalize:!1,divisor:1,rows:o.rows,cols:o.cols},t),g,a;if(d.rows&&d.cols)g=d.rows,a=d.cols;else throw new Error("Invalid number of rows or columns "+g+" "+a);var b=d.divisor,_,T,C=r.length,D=r[0].length;if(d.normalize)for(b=0,_=0;_<C;_++)for(T=0;T<D;T++)b+=r[_][T];if(b===0)throw new RangeError("convolution: The divisor is equal to zero");var k=FFTUtils.toRadix2(s,g,a),O=FFTUtils.convolute(k.data,r,k.rows,k.cols);if(O=FFTUtils.crop(O,k.rows,k.cols,g,a),b!=0&&b!=1)for(_=0;_<O.length;_++)O[_]/=b;return O}function convolutionDirect(e,r,t){var o=matrix2Array(e),s=o.data,d=Object.assign({normalize:!1,divisor:1,rows:o.rows,cols:o.cols},t),g,a;if(d.rows&&d.cols)g=d.rows,a=d.cols;else throw new Error("Invalid number of rows or columns "+g+" "+a);var b=d.divisor,_=r.length,T=r[0].length,C,D,k,O,U,G,j,te,H;if(d.normalize)for(b=0,C=0;C<_;C++)for(D=0;D<T;D++)b+=r[C][D];if(b===0)throw new RangeError("convolution: The divisor is equal to zero");var Z=new Array(g*a),W=Math.floor(_/2),_e=Math.floor(T/2);for(O=0;O<g;O++)for(k=0;k<a;k++){for(G=0,D=0;D<_;D++)for(C=0;C<T;C++)j=r[_-D-1][T-C-1],te=(O+D-W+g)%g,H=(k+C-_e+a)%a,U=te*a+H,G+=s[U]*j;U=O*a+k,Z[U]=G/b}return Z}function LoG(e,r,t){var o=1e3;t&&t.factor&&(o=t.factor);var s=new Array(r),d,g,a,b;o*=-1;var _=(r-1)/2,T=2*e*e;for(d=0;d<r;d++)for(s[d]=new Array(r),b=(d-_)*(d-_),g=0;g<r;g++)a=-((g-_)*(g-_)+b)/T,s[d][g]=Math.round(o*(1+a)*Math.exp(a));return s}function matrix2Array(e){var r=e,t,o;if(typeof e[0]!="number"){t=e.length,o=e[0].length,r=new Array(t*o);for(var s=0;s<t;s++)for(var d=0;d<o;d++)r[s*o+d]=e[s][d]}else{var g=Math.sqrt(e.length);Number.isInteger(g)&&(t=g,o=g)}return{data:r,rows:t,cols:o}}var src$2={fft:convolutionFFT,direct:convolutionDirect,kernelFactory:{LoG},matrix2Array},_isFinite=Number.isFinite||function(e){return!(typeof e!="number"||e!==e||e===1/0||e===-1/0)},isFinite$1=_isFinite,isInteger=Number.isInteger||function(e){return typeof e=="number"&&isFinite$1(e)&&Math.floor(e)===e};const isInteger$1=getDefaultExportFromCjs(isInteger);function validateKernel(e){let r,t;if(Array.isArray(e))if(Array.isArray(e[0])){if(!(e.length&1)||!(e[0].length&1))throw new RangeError("validateKernel: Kernel rows and columns should be odd numbers");r=Math.floor(e.length/2),t=Math.floor(e[0].length/2)}else{let o=Math.sqrt(e.length);if(isInteger$1(o))t=r=Math.floor(Math.sqrt(e.length)/2);else throw new RangeError("validateKernel: Kernel array should be a square");let s=new Array(o);for(let d=0;d<o;d++){s[d]=new Array(o);for(let g=0;g<o;g++)s[d][g]=e[d*o+g]}e=s}else throw new Error(`validateKernel: Invalid Kernel: ${e}`);return{kernel:e,kWidth:t,kHeight:r}}function clamp(e,r){return Math.round(Math.min(Math.max(e,0),r.maxValue))}function directConvolution(e,r,t){if(t===void 0){const d=e.length+r.length-1;t=new Array(d)}fill(t);for(var o=0;o<e.length;o++)for(var s=0;s<r.length;s++)t[o+s]+=e[o]*r[s];return t}function fill(e){for(var r=0;r<e.length;r++)e[r]=0}function FFT(e){if(this.size=e|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=e<<1;for(var r=new Array(this.size*2),t=0;t<r.length;t+=2){const b=Math.PI*t/this.size;r[t]=Math.cos(b),r[t+1]=-Math.sin(b)}this.table=r;for(var o=0,s=1;this.size>s;s<<=1)o++;this._width=o%2===0?o-1:o,this._bitrev=new Array(1<<this._width);for(var d=0;d<this._bitrev.length;d++){this._bitrev[d]=0;for(var g=0;g<this._width;g+=2){var a=this._width-g-2;this._bitrev[d]|=(d>>>g&3)<<a}}this._out=null,this._data=null,this._inv=0}FFT.prototype.fromComplexArray=function e(r,t){for(var o=t||new Array(r.length>>>1),s=0;s<r.length;s+=2)o[s>>>1]=r[s];return o};FFT.prototype.createComplexArray=function e(){const r=new Array(this._csize);for(var t=0;t<r.length;t++)r[t]=0;return r};FFT.prototype.toComplexArray=function e(r,t){for(var o=t||this.createComplexArray(),s=0;s<o.length;s+=2)o[s]=r[s>>>1],o[s+1]=0;return o};FFT.prototype.completeSpectrum=function e(r){for(var t=this._csize,o=t>>>1,s=2;s<o;s+=2)r[t-s]=r[s],r[t-s+1]=-r[s+1]};FFT.prototype.transform=function e(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};FFT.prototype.realTransform=function e(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};FFT.prototype.inverseTransform=function e(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=1,this._transform4();for(var o=0;o<r.length;o++)r[o]/=this.size;this._out=null,this._data=null};FFT.prototype._transform4=function e(){var r=this._out,t=this._csize,o=this._width,s=1<<o,d=t/s<<1,g,a,b=this._bitrev;if(d===4)for(g=0,a=0;g<t;g+=d,a++){const U=b[a];this._singleTransform2(g,U,s)}else for(g=0,a=0;g<t;g+=d,a++){const U=b[a];this._singleTransform4(g,U,s)}var _=this._inv?-1:1,T=this.table;for(s>>=2;s>=2;s>>=2){d=t/s<<1;var C=d>>>2;for(g=0;g<t;g+=d)for(var D=g+C,k=g,O=0;k<D;k+=2,O+=s){const U=k,G=U+C,j=G+C,te=j+C,H=r[U],Z=r[U+1],W=r[G],_e=r[G+1],fe=r[j],re=r[j+1],ae=r[te],J=r[te+1],se=H,Me=Z,Ie=T[O],We=_*T[O+1],Ge=W*Ie-_e*We,qt=W*We+_e*Ie,ti=T[2*O],Ut=_*T[2*O+1],Qt=fe*ti-re*Ut,tt=fe*Ut+re*ti,nt=T[3*O],Mt=_*T[3*O+1],ht=ae*nt-J*Mt,xt=ae*Mt+J*nt,It=se+Qt,Et=Me+tt,yt=se-Qt,Bt=Me-tt,_t=Ge+ht,si=qt+xt,Li=_*(Ge-ht),vi=_*(qt-xt),ci=It+_t,mt=Et+si,$t=It-_t,Mi=Et-si,Di=yt+vi,Ci=Bt-Li,dt=yt-vi,ei=Bt+Li;r[U]=ci,r[U+1]=mt,r[G]=Di,r[G+1]=Ci,r[j]=$t,r[j+1]=Mi,r[te]=dt,r[te+1]=ei}}};FFT.prototype._singleTransform2=function e(r,t,o){const s=this._out,d=this._data,g=d[t],a=d[t+1],b=d[t+o],_=d[t+o+1],T=g+b,C=a+_,D=g-b,k=a-_;s[r]=T,s[r+1]=C,s[r+2]=D,s[r+3]=k};FFT.prototype._singleTransform4=function e(r,t,o){const s=this._out,d=this._data,g=this._inv?-1:1,a=o*2,b=o*3,_=d[t],T=d[t+1],C=d[t+o],D=d[t+o+1],k=d[t+a],O=d[t+a+1],U=d[t+b],G=d[t+b+1],j=_+k,te=T+O,H=_-k,Z=T-O,W=C+U,_e=D+G,fe=g*(C-U),re=g*(D-G),ae=j+W,J=te+_e,se=H+re,Me=Z-fe,Ie=j-W,We=te-_e,Ge=H-re,qt=Z+fe;s[r]=ae,s[r+1]=J,s[r+2]=se,s[r+3]=Me,s[r+4]=Ie,s[r+5]=We,s[r+6]=Ge,s[r+7]=qt};FFT.prototype._realTransform4=function e(){var r=this._out,t=this._csize,o=this._width,s=1<<o,d=t/s<<1,g,a,b=this._bitrev;if(d===4)for(g=0,a=0;g<t;g+=d,a++){const zi=b[a];this._singleRealTransform2(g,zi>>>1,s>>>1)}else for(g=0,a=0;g<t;g+=d,a++){const zi=b[a];this._singleRealTransform4(g,zi>>>1,s>>>1)}var _=this._inv?-1:1,T=this.table;for(s>>=2;s>=2;s>>=2){d=t/s<<1;var C=d>>>1,D=C>>>1,k=D>>>1;for(g=0;g<t;g+=d)for(var O=0,U=0;O<=k;O+=2,U+=s){var G=g+O,j=G+D,te=j+D,H=te+D,Z=r[G],W=r[G+1],_e=r[j],fe=r[j+1],re=r[te],ae=r[te+1],J=r[H],se=r[H+1],Me=Z,Ie=W,We=T[U],Ge=_*T[U+1],qt=_e*We-fe*Ge,ti=_e*Ge+fe*We,Ut=T[2*U],Qt=_*T[2*U+1],tt=re*Ut-ae*Qt,nt=re*Qt+ae*Ut,Mt=T[3*U],ht=_*T[3*U+1],xt=J*Mt-se*ht,It=J*ht+se*Mt,Et=Me+tt,yt=Ie+nt,Bt=Me-tt,_t=Ie-nt,si=qt+xt,Li=ti+It,vi=_*(qt-xt),ci=_*(ti-It),mt=Et+si,$t=yt+Li,Mi=Bt+ci,Di=_t-vi;if(r[G]=mt,r[G+1]=$t,r[j]=Mi,r[j+1]=Di,O===0){var Ci=Et-si,dt=yt-Li;r[te]=Ci,r[te+1]=dt;continue}if(O!==k){var ei=Bt,ct=-_t,Ct=Et,Be=-yt,Xt=-_*ci,ni=-_*vi,Vt=-_*Li,Nt=-_*si,mi=ei+Xt,ii=ct+ni,Ii=Ct+Nt,$i=Be-Vt,Ri=g+D-O,Ni=g+C-O;r[Ri]=mi,r[Ri+1]=ii,r[Ni]=Ii,r[Ni+1]=$i}}}};FFT.prototype._singleRealTransform2=function e(r,t,o){const s=this._out,d=this._data,g=d[t],a=d[t+o],b=g+a,_=g-a;s[r]=b,s[r+1]=0,s[r+2]=_,s[r+3]=0};FFT.prototype._singleRealTransform4=function e(r,t,o){const s=this._out,d=this._data,g=this._inv?-1:1,a=o*2,b=o*3,_=d[t],T=d[t+o],C=d[t+a],D=d[t+b],k=_+C,O=_-C,U=T+D,G=g*(T-D),j=k+U,te=O,H=-G,Z=k-U,W=O,_e=G;s[r]=j,s[r+1]=0,s[r+2]=te,s[r+3]=H,s[r+4]=Z,s[r+5]=0,s[r+6]=W,s[r+7]=_e};function convolutionSeparable(e,r,t,o){const s=new Array(e.length);let d,g,a,b;b=r[1],a=(b.length-1)/2,g=new Array(t+b.length-1),d=new Array(t);for(let _=0;_<o;_++){for(let T=0;T<t;T++)d[T]=e[_*t+T];directConvolution(d,b,g);for(let T=0;T<t;T++)s[_*t+T]=g[a+T]}b=r[0],a=(b.length-1)/2,g=new Array(o+b.length-1),d=new Array(o);for(let _=0;_<t;_++){for(let T=0;T<o;T++)d[T]=s[T*t+_];directConvolution(d,b,g);for(let T=0;T<o;T++)s[T*t+_]=g[a+T]}return s}const toString$2=Object.prototype.toString;function isAnyArray(e){return toString$2.call(e).endsWith("Array]")}function max$1(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(e))throw new TypeError("input must be an array");if(e.length===0)throw new TypeError("input must not be empty");var t=r.fromIndex,o=t===void 0?0:t,s=r.toIndex,d=s===void 0?e.length:s;if(o<0||o>=e.length||!Number.isInteger(o))throw new Error("fromIndex must be a positive integer smaller than length");if(d<=o||d>e.length||!Number.isInteger(d))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var g=e[o],a=o+1;a<d;a++)e[a]>g&&(g=e[a]);return g}function min$1(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!isAnyArray(e))throw new TypeError("input must be an array");if(e.length===0)throw new TypeError("input must not be empty");var t=r.fromIndex,o=t===void 0?0:t,s=r.toIndex,d=s===void 0?e.length:s;if(o<0||o>=e.length||!Number.isInteger(o))throw new Error("fromIndex must be a positive integer smaller than length");if(d<=o||d>e.length||!Number.isInteger(d))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var g=e[o],a=o+1;a<d;a++)e[a]<g&&(g=e[a]);return g}function rescale(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(isAnyArray(e)){if(e.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var t;if(r.output!==void 0){if(!isAnyArray(r.output))throw new TypeError("output option must be an array if specified");t=r.output}else t=new Array(e.length);var o=min$1(e),s=max$1(e);if(o===s)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var d=r.min,g=d===void 0?r.autoMinMax?o:0:d,a=r.max,b=a===void 0?r.autoMinMax?s:1:a;if(g>=b)throw new RangeError("min option must be smaller than max option");for(var _=(b-g)/(s-o),T=0;T<e.length;T++)t[T]=(e[T]-o)*_+g;return t}const indent=" ".repeat(2),indentData=" ".repeat(4);function inspectMatrix(){return inspectMatrixWithOptions(this)}function inspectMatrixWithOptions(e,r={}){const{maxRows:t=15,maxColumns:o=10,maxNumSize:s=8,padMinus:d="auto"}=r;return`${e.constructor.name} {
${indent}[
${indentData}${inspectData(e,t,o,s,d)}
${indent}]
${indent}rows: ${e.rows}
${indent}columns: ${e.columns}
}`}function inspectData(e,r,t,o,s){const{rows:d,columns:g}=e,a=Math.min(d,r),b=Math.min(g,t),_=[];if(s==="auto"){s=!1;e:for(let T=0;T<a;T++)for(let C=0;C<b;C++)if(e.get(T,C)<0){s=!0;break e}}for(let T=0;T<a;T++){let C=[];for(let D=0;D<b;D++)C.push(formatNumber(e.get(T,D),o,s));_.push(`${C.join(" ")}`)}return b!==g&&(_[_.length-1]+=` ... ${g-t} more columns`),a!==d&&_.push(`... ${d-r} more rows`),_.join(`
${indentData}`)}function formatNumber(e,r,t){return(e>=0&&t?` ${formatNumber2(e,r-1)}`:formatNumber2(e,r)).padEnd(r)}function formatNumber2(e,r){let t=e.toString();if(t.length<=r)return t;let o=e.toFixed(r);if(o.length>r&&(o=e.toFixed(Math.max(0,r-(o.length-r)))),o.length<=r&&!o.startsWith("0.000")&&!o.startsWith("-0.000"))return o;let s=e.toExponential(r);return s.length>r&&(s=e.toExponential(Math.max(0,r-(s.length-r)))),s.slice(0)}function installMathOperations(e,r){e.prototype.add=function(o){return typeof o=="number"?this.addS(o):this.addM(o)},e.prototype.addS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)+o);return this},e.prototype.addM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)+o.get(s,d));return this},e.add=function(o,s){return new r(o).add(s)},e.prototype.sub=function(o){return typeof o=="number"?this.subS(o):this.subM(o)},e.prototype.subS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)-o);return this},e.prototype.subM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)-o.get(s,d));return this},e.sub=function(o,s){return new r(o).sub(s)},e.prototype.subtract=e.prototype.sub,e.prototype.subtractS=e.prototype.subS,e.prototype.subtractM=e.prototype.subM,e.subtract=e.sub,e.prototype.mul=function(o){return typeof o=="number"?this.mulS(o):this.mulM(o)},e.prototype.mulS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)*o);return this},e.prototype.mulM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)*o.get(s,d));return this},e.mul=function(o,s){return new r(o).mul(s)},e.prototype.multiply=e.prototype.mul,e.prototype.multiplyS=e.prototype.mulS,e.prototype.multiplyM=e.prototype.mulM,e.multiply=e.mul,e.prototype.div=function(o){return typeof o=="number"?this.divS(o):this.divM(o)},e.prototype.divS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)/o);return this},e.prototype.divM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)/o.get(s,d));return this},e.div=function(o,s){return new r(o).div(s)},e.prototype.divide=e.prototype.div,e.prototype.divideS=e.prototype.divS,e.prototype.divideM=e.prototype.divM,e.divide=e.div,e.prototype.mod=function(o){return typeof o=="number"?this.modS(o):this.modM(o)},e.prototype.modS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)%o);return this},e.prototype.modM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)%o.get(s,d));return this},e.mod=function(o,s){return new r(o).mod(s)},e.prototype.modulus=e.prototype.mod,e.prototype.modulusS=e.prototype.modS,e.prototype.modulusM=e.prototype.modM,e.modulus=e.mod,e.prototype.and=function(o){return typeof o=="number"?this.andS(o):this.andM(o)},e.prototype.andS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)&o);return this},e.prototype.andM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)&o.get(s,d));return this},e.and=function(o,s){return new r(o).and(s)},e.prototype.or=function(o){return typeof o=="number"?this.orS(o):this.orM(o)},e.prototype.orS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)|o);return this},e.prototype.orM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)|o.get(s,d));return this},e.or=function(o,s){return new r(o).or(s)},e.prototype.xor=function(o){return typeof o=="number"?this.xorS(o):this.xorM(o)},e.prototype.xorS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)^o);return this},e.prototype.xorM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)^o.get(s,d));return this},e.xor=function(o,s){return new r(o).xor(s)},e.prototype.leftShift=function(o){return typeof o=="number"?this.leftShiftS(o):this.leftShiftM(o)},e.prototype.leftShiftS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)<<o);return this},e.prototype.leftShiftM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)<<o.get(s,d));return this},e.leftShift=function(o,s){return new r(o).leftShift(s)},e.prototype.signPropagatingRightShift=function(o){return typeof o=="number"?this.signPropagatingRightShiftS(o):this.signPropagatingRightShiftM(o)},e.prototype.signPropagatingRightShiftS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)>>o);return this},e.prototype.signPropagatingRightShiftM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)>>o.get(s,d));return this},e.signPropagatingRightShift=function(o,s){return new r(o).signPropagatingRightShift(s)},e.prototype.rightShift=function(o){return typeof o=="number"?this.rightShiftS(o):this.rightShiftM(o)},e.prototype.rightShiftS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)>>>o);return this},e.prototype.rightShiftM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,this.get(s,d)>>>o.get(s,d));return this},e.rightShift=function(o,s){return new r(o).rightShift(s)},e.prototype.zeroFillRightShift=e.prototype.rightShift,e.prototype.zeroFillRightShiftS=e.prototype.rightShiftS,e.prototype.zeroFillRightShiftM=e.prototype.rightShiftM,e.zeroFillRightShift=e.rightShift,e.prototype.not=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,~this.get(o,s));return this},e.not=function(o){return new r(o).not()},e.prototype.abs=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.abs(this.get(o,s)));return this},e.abs=function(o){return new r(o).abs()},e.prototype.acos=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.acos(this.get(o,s)));return this},e.acos=function(o){return new r(o).acos()},e.prototype.acosh=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.acosh(this.get(o,s)));return this},e.acosh=function(o){return new r(o).acosh()},e.prototype.asin=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.asin(this.get(o,s)));return this},e.asin=function(o){return new r(o).asin()},e.prototype.asinh=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.asinh(this.get(o,s)));return this},e.asinh=function(o){return new r(o).asinh()},e.prototype.atan=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.atan(this.get(o,s)));return this},e.atan=function(o){return new r(o).atan()},e.prototype.atanh=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.atanh(this.get(o,s)));return this},e.atanh=function(o){return new r(o).atanh()},e.prototype.cbrt=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.cbrt(this.get(o,s)));return this},e.cbrt=function(o){return new r(o).cbrt()},e.prototype.ceil=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.ceil(this.get(o,s)));return this},e.ceil=function(o){return new r(o).ceil()},e.prototype.clz32=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.clz32(this.get(o,s)));return this},e.clz32=function(o){return new r(o).clz32()},e.prototype.cos=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.cos(this.get(o,s)));return this},e.cos=function(o){return new r(o).cos()},e.prototype.cosh=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.cosh(this.get(o,s)));return this},e.cosh=function(o){return new r(o).cosh()},e.prototype.exp=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.exp(this.get(o,s)));return this},e.exp=function(o){return new r(o).exp()},e.prototype.expm1=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.expm1(this.get(o,s)));return this},e.expm1=function(o){return new r(o).expm1()},e.prototype.floor=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.floor(this.get(o,s)));return this},e.floor=function(o){return new r(o).floor()},e.prototype.fround=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.fround(this.get(o,s)));return this},e.fround=function(o){return new r(o).fround()},e.prototype.log=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.log(this.get(o,s)));return this},e.log=function(o){return new r(o).log()},e.prototype.log1p=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.log1p(this.get(o,s)));return this},e.log1p=function(o){return new r(o).log1p()},e.prototype.log10=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.log10(this.get(o,s)));return this},e.log10=function(o){return new r(o).log10()},e.prototype.log2=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.log2(this.get(o,s)));return this},e.log2=function(o){return new r(o).log2()},e.prototype.round=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.round(this.get(o,s)));return this},e.round=function(o){return new r(o).round()},e.prototype.sign=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.sign(this.get(o,s)));return this},e.sign=function(o){return new r(o).sign()},e.prototype.sin=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.sin(this.get(o,s)));return this},e.sin=function(o){return new r(o).sin()},e.prototype.sinh=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.sinh(this.get(o,s)));return this},e.sinh=function(o){return new r(o).sinh()},e.prototype.sqrt=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.sqrt(this.get(o,s)));return this},e.sqrt=function(o){return new r(o).sqrt()},e.prototype.tan=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.tan(this.get(o,s)));return this},e.tan=function(o){return new r(o).tan()},e.prototype.tanh=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.tanh(this.get(o,s)));return this},e.tanh=function(o){return new r(o).tanh()},e.prototype.trunc=function(){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.set(o,s,Math.trunc(this.get(o,s)));return this},e.trunc=function(o){return new r(o).trunc()},e.pow=function(o,s){return new r(o).pow(s)},e.prototype.pow=function(o){return typeof o=="number"?this.powS(o):this.powM(o)},e.prototype.powS=function(o){for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,Math.pow(this.get(s,d),o));return this},e.prototype.powM=function(o){if(o=r.checkMatrix(o),this.rows!==o.rows||this.columns!==o.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let d=0;d<this.columns;d++)this.set(s,d,Math.pow(this.get(s,d),o.get(s,d)));return this}}function checkRowIndex(e,r,t){let o=t?e.rows:e.rows-1;if(r<0||r>o)throw new RangeError("Row index out of range")}function checkColumnIndex(e,r,t){let o=t?e.columns:e.columns-1;if(r<0||r>o)throw new RangeError("Column index out of range")}function checkRowVector(e,r){if(r.to1DArray&&(r=r.to1DArray()),r.length!==e.columns)throw new RangeError("vector size must be the same as the number of columns");return r}function checkColumnVector(e,r){if(r.to1DArray&&(r=r.to1DArray()),r.length!==e.rows)throw new RangeError("vector size must be the same as the number of rows");return r}function checkRowIndices(e,r){if(!isAnyArray(r))throw new TypeError("row indices must be an array");for(let t=0;t<r.length;t++)if(r[t]<0||r[t]>=e.rows)throw new RangeError("row indices are out of range")}function checkColumnIndices(e,r){if(!isAnyArray(r))throw new TypeError("column indices must be an array");for(let t=0;t<r.length;t++)if(r[t]<0||r[t]>=e.columns)throw new RangeError("column indices are out of range")}function checkRange(e,r,t,o,s){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(checkNumber("startRow",r),checkNumber("endRow",t),checkNumber("startColumn",o),checkNumber("endColumn",s),r>t||o>s||r<0||r>=e.rows||t<0||t>=e.rows||o<0||o>=e.columns||s<0||s>=e.columns)throw new RangeError("Submatrix indices are out of range")}function newArray$2(e,r=0){let t=[];for(let o=0;o<e;o++)t.push(r);return t}function checkNumber(e,r){if(typeof r!="number")throw new TypeError(`${e} must be a number`)}function checkNonEmpty(e){if(e.isEmpty())throw new Error("Empty matrix has no elements to index")}function sumByRow(e){let r=newArray$2(e.rows);for(let t=0;t<e.rows;++t)for(let o=0;o<e.columns;++o)r[t]+=e.get(t,o);return r}function sumByColumn(e){let r=newArray$2(e.columns);for(let t=0;t<e.rows;++t)for(let o=0;o<e.columns;++o)r[o]+=e.get(t,o);return r}function sumAll(e){let r=0;for(let t=0;t<e.rows;t++)for(let o=0;o<e.columns;o++)r+=e.get(t,o);return r}function productByRow(e){let r=newArray$2(e.rows,1);for(let t=0;t<e.rows;++t)for(let o=0;o<e.columns;++o)r[t]*=e.get(t,o);return r}function productByColumn(e){let r=newArray$2(e.columns,1);for(let t=0;t<e.rows;++t)for(let o=0;o<e.columns;++o)r[o]*=e.get(t,o);return r}function productAll(e){let r=1;for(let t=0;t<e.rows;t++)for(let o=0;o<e.columns;o++)r*=e.get(t,o);return r}function varianceByRow(e,r,t){const o=e.rows,s=e.columns,d=[];for(let g=0;g<o;g++){let a=0,b=0,_=0;for(let T=0;T<s;T++)_=e.get(g,T)-t[g],a+=_,b+=_*_;r?d.push((b-a*a/s)/(s-1)):d.push((b-a*a/s)/s)}return d}function varianceByColumn(e,r,t){const o=e.rows,s=e.columns,d=[];for(let g=0;g<s;g++){let a=0,b=0,_=0;for(let T=0;T<o;T++)_=e.get(T,g)-t[g],a+=_,b+=_*_;r?d.push((b-a*a/o)/(o-1)):d.push((b-a*a/o)/o)}return d}function varianceAll(e,r,t){const o=e.rows,s=e.columns,d=o*s;let g=0,a=0,b=0;for(let _=0;_<o;_++)for(let T=0;T<s;T++)b=e.get(_,T)-t,g+=b,a+=b*b;return r?(a-g*g/d)/(d-1):(a-g*g/d)/d}function centerByRow(e,r){for(let t=0;t<e.rows;t++)for(let o=0;o<e.columns;o++)e.set(t,o,e.get(t,o)-r[t])}function centerByColumn(e,r){for(let t=0;t<e.rows;t++)for(let o=0;o<e.columns;o++)e.set(t,o,e.get(t,o)-r[o])}function centerAll(e,r){for(let t=0;t<e.rows;t++)for(let o=0;o<e.columns;o++)e.set(t,o,e.get(t,o)-r)}function getScaleByRow(e){const r=[];for(let t=0;t<e.rows;t++){let o=0;for(let s=0;s<e.columns;s++)o+=Math.pow(e.get(t,s),2)/(e.columns-1);r.push(Math.sqrt(o))}return r}function scaleByRow(e,r){for(let t=0;t<e.rows;t++)for(let o=0;o<e.columns;o++)e.set(t,o,e.get(t,o)/r[t])}function getScaleByColumn(e){const r=[];for(let t=0;t<e.columns;t++){let o=0;for(let s=0;s<e.rows;s++)o+=Math.pow(e.get(s,t),2)/(e.rows-1);r.push(Math.sqrt(o))}return r}function scaleByColumn(e,r){for(let t=0;t<e.rows;t++)for(let o=0;o<e.columns;o++)e.set(t,o,e.get(t,o)/r[o])}function getScaleAll(e){const r=e.size-1;let t=0;for(let o=0;o<e.columns;o++)for(let s=0;s<e.rows;s++)t+=Math.pow(e.get(s,o),2)/r;return Math.sqrt(t)}function scaleAll(e,r){for(let t=0;t<e.rows;t++)for(let o=0;o<e.columns;o++)e.set(t,o,e.get(t,o)/r)}class AbstractMatrix{static from1DArray(r,t,o){if(r*t!==o.length)throw new RangeError("data length does not match given dimensions");let d=new Matrix$2(r,t);for(let g=0;g<r;g++)for(let a=0;a<t;a++)d.set(g,a,o[g*t+a]);return d}static rowVector(r){let t=new Matrix$2(1,r.length);for(let o=0;o<r.length;o++)t.set(0,o,r[o]);return t}static columnVector(r){let t=new Matrix$2(r.length,1);for(let o=0;o<r.length;o++)t.set(o,0,r[o]);return t}static zeros(r,t){return new Matrix$2(r,t)}static ones(r,t){return new Matrix$2(r,t).fill(1)}static rand(r,t,o={}){if(typeof o!="object")throw new TypeError("options must be an object");const{random:s=Math.random}=o;let d=new Matrix$2(r,t);for(let g=0;g<r;g++)for(let a=0;a<t;a++)d.set(g,a,s());return d}static randInt(r,t,o={}){if(typeof o!="object")throw new TypeError("options must be an object");const{min:s=0,max:d=1e3,random:g=Math.random}=o;if(!Number.isInteger(s))throw new TypeError("min must be an integer");if(!Number.isInteger(d))throw new TypeError("max must be an integer");if(s>=d)throw new RangeError("min must be smaller than max");let a=d-s,b=new Matrix$2(r,t);for(let _=0;_<r;_++)for(let T=0;T<t;T++){let C=s+Math.round(g()*a);b.set(_,T,C)}return b}static eye(r,t,o){t===void 0&&(t=r),o===void 0&&(o=1);let s=Math.min(r,t),d=this.zeros(r,t);for(let g=0;g<s;g++)d.set(g,g,o);return d}static diag(r,t,o){let s=r.length;t===void 0&&(t=s),o===void 0&&(o=t);let d=Math.min(s,t,o),g=this.zeros(t,o);for(let a=0;a<d;a++)g.set(a,a,r[a]);return g}static min(r,t){r=this.checkMatrix(r),t=this.checkMatrix(t);let o=r.rows,s=r.columns,d=new Matrix$2(o,s);for(let g=0;g<o;g++)for(let a=0;a<s;a++)d.set(g,a,Math.min(r.get(g,a),t.get(g,a)));return d}static max(r,t){r=this.checkMatrix(r),t=this.checkMatrix(t);let o=r.rows,s=r.columns,d=new this(o,s);for(let g=0;g<o;g++)for(let a=0;a<s;a++)d.set(g,a,Math.max(r.get(g,a),t.get(g,a)));return d}static checkMatrix(r){return AbstractMatrix.isMatrix(r)?r:new Matrix$2(r)}static isMatrix(r){return r!=null&&r.klass==="Matrix"}get size(){return this.rows*this.columns}apply(r){if(typeof r!="function")throw new TypeError("callback must be a function");for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)r.call(this,t,o);return this}to1DArray(){let r=[];for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)r.push(this.get(t,o));return r}to2DArray(){let r=[];for(let t=0;t<this.rows;t++){r.push([]);for(let o=0;o<this.columns;o++)r[t].push(this.get(t,o))}return r}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let r=0;r<this.rows;r++)for(let t=0;t<=r;t++)if(this.get(r,t)!==this.get(t,r))return!1;return!0}return!1}isEchelonForm(){let r=0,t=0,o=-1,s=!0,d=!1;for(;r<this.rows&&s;){for(t=0,d=!1;t<this.columns&&d===!1;)this.get(r,t)===0?t++:this.get(r,t)===1&&t>o?(d=!0,o=t):(s=!1,d=!0);r++}return s}isReducedEchelonForm(){let r=0,t=0,o=-1,s=!0,d=!1;for(;r<this.rows&&s;){for(t=0,d=!1;t<this.columns&&d===!1;)this.get(r,t)===0?t++:this.get(r,t)===1&&t>o?(d=!0,o=t):(s=!1,d=!0);for(let g=t+1;g<this.rows;g++)this.get(r,g)!==0&&(s=!1);r++}return s}echelonForm(){let r=this.clone(),t=0,o=0;for(;t<r.rows&&o<r.columns;){let s=t;for(let d=t;d<r.rows;d++)r.get(d,o)>r.get(s,o)&&(s=d);if(r.get(s,o)===0)o++;else{r.swapRows(t,s);let d=r.get(t,o);for(let g=o;g<r.columns;g++)r.set(t,g,r.get(t,g)/d);for(let g=t+1;g<r.rows;g++){let a=r.get(g,o)/r.get(t,o);r.set(g,o,0);for(let b=o+1;b<r.columns;b++)r.set(g,b,r.get(g,b)-r.get(t,b)*a)}t++,o++}}return r}reducedEchelonForm(){let r=this.echelonForm(),t=r.columns,o=r.rows,s=o-1;for(;s>=0;)if(r.maxRow(s)===0)s--;else{let d=0,g=!1;for(;d<o&&g===!1;)r.get(s,d)===1?g=!0:d++;for(let a=0;a<s;a++){let b=r.get(a,d);for(let _=d;_<t;_++){let T=r.get(a,_)-b*r.get(s,_);r.set(a,_,T)}}s--}return r}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{rows:t=1,columns:o=1}=r;if(!Number.isInteger(t)||t<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(o)||o<=0)throw new TypeError("columns must be a positive integer");let s=new Matrix$2(this.rows*t,this.columns*o);for(let d=0;d<t;d++)for(let g=0;g<o;g++)s.setSubMatrix(this,this.rows*d,this.columns*g);return s}fill(r){for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,r);return this}neg(){return this.mulS(-1)}getRow(r){checkRowIndex(this,r);let t=[];for(let o=0;o<this.columns;o++)t.push(this.get(r,o));return t}getRowVector(r){return Matrix$2.rowVector(this.getRow(r))}setRow(r,t){checkRowIndex(this,r),t=checkRowVector(this,t);for(let o=0;o<this.columns;o++)this.set(r,o,t[o]);return this}swapRows(r,t){checkRowIndex(this,r),checkRowIndex(this,t);for(let o=0;o<this.columns;o++){let s=this.get(r,o);this.set(r,o,this.get(t,o)),this.set(t,o,s)}return this}getColumn(r){checkColumnIndex(this,r);let t=[];for(let o=0;o<this.rows;o++)t.push(this.get(o,r));return t}getColumnVector(r){return Matrix$2.columnVector(this.getColumn(r))}setColumn(r,t){checkColumnIndex(this,r),t=checkColumnVector(this,t);for(let o=0;o<this.rows;o++)this.set(o,r,t[o]);return this}swapColumns(r,t){checkColumnIndex(this,r),checkColumnIndex(this,t);for(let o=0;o<this.rows;o++){let s=this.get(o,r);this.set(o,r,this.get(o,t)),this.set(o,t,s)}return this}addRowVector(r){r=checkRowVector(this,r);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,this.get(t,o)+r[o]);return this}subRowVector(r){r=checkRowVector(this,r);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,this.get(t,o)-r[o]);return this}mulRowVector(r){r=checkRowVector(this,r);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,this.get(t,o)*r[o]);return this}divRowVector(r){r=checkRowVector(this,r);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,this.get(t,o)/r[o]);return this}addColumnVector(r){r=checkColumnVector(this,r);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,this.get(t,o)+r[t]);return this}subColumnVector(r){r=checkColumnVector(this,r);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,this.get(t,o)-r[t]);return this}mulColumnVector(r){r=checkColumnVector(this,r);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,this.get(t,o)*r[t]);return this}divColumnVector(r){r=checkColumnVector(this,r);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)this.set(t,o,this.get(t,o)/r[t]);return this}mulRow(r,t){checkRowIndex(this,r);for(let o=0;o<this.columns;o++)this.set(r,o,this.get(r,o)*t);return this}mulColumn(r,t){checkColumnIndex(this,r);for(let o=0;o<this.rows;o++)this.set(o,r,this.get(o,r)*t);return this}max(r){if(this.isEmpty())return NaN;switch(r){case"row":{const t=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.get(o,s)>t[o]&&(t[o]=this.get(o,s));return t}case"column":{const t=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.get(o,s)>t[s]&&(t[s]=this.get(o,s));return t}case void 0:{let t=this.get(0,0);for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.get(o,s)>t&&(t=this.get(o,s));return t}default:throw new Error(`invalid option: ${r}`)}}maxIndex(){checkNonEmpty(this);let r=this.get(0,0),t=[0,0];for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.get(o,s)>r&&(r=this.get(o,s),t[0]=o,t[1]=s);return t}min(r){if(this.isEmpty())return NaN;switch(r){case"row":{const t=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.get(o,s)<t[o]&&(t[o]=this.get(o,s));return t}case"column":{const t=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.get(o,s)<t[s]&&(t[s]=this.get(o,s));return t}case void 0:{let t=this.get(0,0);for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.get(o,s)<t&&(t=this.get(o,s));return t}default:throw new Error(`invalid option: ${r}`)}}minIndex(){checkNonEmpty(this);let r=this.get(0,0),t=[0,0];for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.get(o,s)<r&&(r=this.get(o,s),t[0]=o,t[1]=s);return t}maxRow(r){if(checkRowIndex(this,r),this.isEmpty())return NaN;let t=this.get(r,0);for(let o=1;o<this.columns;o++)this.get(r,o)>t&&(t=this.get(r,o));return t}maxRowIndex(r){checkRowIndex(this,r),checkNonEmpty(this);let t=this.get(r,0),o=[r,0];for(let s=1;s<this.columns;s++)this.get(r,s)>t&&(t=this.get(r,s),o[1]=s);return o}minRow(r){if(checkRowIndex(this,r),this.isEmpty())return NaN;let t=this.get(r,0);for(let o=1;o<this.columns;o++)this.get(r,o)<t&&(t=this.get(r,o));return t}minRowIndex(r){checkRowIndex(this,r),checkNonEmpty(this);let t=this.get(r,0),o=[r,0];for(let s=1;s<this.columns;s++)this.get(r,s)<t&&(t=this.get(r,s),o[1]=s);return o}maxColumn(r){if(checkColumnIndex(this,r),this.isEmpty())return NaN;let t=this.get(0,r);for(let o=1;o<this.rows;o++)this.get(o,r)>t&&(t=this.get(o,r));return t}maxColumnIndex(r){checkColumnIndex(this,r),checkNonEmpty(this);let t=this.get(0,r),o=[0,r];for(let s=1;s<this.rows;s++)this.get(s,r)>t&&(t=this.get(s,r),o[0]=s);return o}minColumn(r){if(checkColumnIndex(this,r),this.isEmpty())return NaN;let t=this.get(0,r);for(let o=1;o<this.rows;o++)this.get(o,r)<t&&(t=this.get(o,r));return t}minColumnIndex(r){checkColumnIndex(this,r),checkNonEmpty(this);let t=this.get(0,r),o=[0,r];for(let s=1;s<this.rows;s++)this.get(s,r)<t&&(t=this.get(s,r),o[0]=s);return o}diag(){let r=Math.min(this.rows,this.columns),t=[];for(let o=0;o<r;o++)t.push(this.get(o,o));return t}norm(r="frobenius"){let t=0;if(r==="max")return this.max();if(r==="frobenius"){for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)t=t+this.get(o,s)*this.get(o,s);return Math.sqrt(t)}else throw new RangeError(`unknown norm type: ${r}`)}cumulativeSum(){let r=0;for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)r+=this.get(t,o),this.set(t,o,r);return this}dot(r){AbstractMatrix.isMatrix(r)&&(r=r.to1DArray());let t=this.to1DArray();if(t.length!==r.length)throw new RangeError("vectors do not have the same size");let o=0;for(let s=0;s<t.length;s++)o+=t[s]*r[s];return o}mmul(r){r=Matrix$2.checkMatrix(r);let t=this.rows,o=this.columns,s=r.columns,d=new Matrix$2(t,s),g=new Float64Array(o);for(let a=0;a<s;a++){for(let b=0;b<o;b++)g[b]=r.get(b,a);for(let b=0;b<t;b++){let _=0;for(let T=0;T<o;T++)_+=this.get(b,T)*g[T];d.set(b,a,_)}}return d}strassen2x2(r){r=Matrix$2.checkMatrix(r);let t=new Matrix$2(2,2);const o=this.get(0,0),s=r.get(0,0),d=this.get(0,1),g=r.get(0,1),a=this.get(1,0),b=r.get(1,0),_=this.get(1,1),T=r.get(1,1),C=(o+_)*(s+T),D=(a+_)*s,k=o*(g-T),O=_*(b-s),U=(o+d)*T,G=(a-o)*(s+g),j=(d-_)*(b+T),te=C+O-U+j,H=k+U,Z=D+O,W=C-D+k+G;return t.set(0,0,te),t.set(0,1,H),t.set(1,0,Z),t.set(1,1,W),t}strassen3x3(r){r=Matrix$2.checkMatrix(r);let t=new Matrix$2(3,3);const o=this.get(0,0),s=this.get(0,1),d=this.get(0,2),g=this.get(1,0),a=this.get(1,1),b=this.get(1,2),_=this.get(2,0),T=this.get(2,1),C=this.get(2,2),D=r.get(0,0),k=r.get(0,1),O=r.get(0,2),U=r.get(1,0),G=r.get(1,1),j=r.get(1,2),te=r.get(2,0),H=r.get(2,1),Z=r.get(2,2),W=(o+s+d-g-a-T-C)*G,_e=(o-g)*(-k+G),fe=a*(-D+k+U-G-j-te+Z),re=(-o+g+a)*(D-k+G),ae=(g+a)*(-D+k),J=o*D,se=(-o+_+T)*(D-O+j),Me=(-o+_)*(O-j),Ie=(_+T)*(-D+O),We=(o+s+d-a-b-_-T)*j,Ge=T*(-D+O+U-G-j-te+H),qt=(-d+T+C)*(G+te-H),ti=(d-C)*(G-H),Ut=d*te,Qt=(T+C)*(-te+H),tt=(-d+a+b)*(j+te-Z),nt=(d-b)*(j-Z),Mt=(a+b)*(-te+Z),ht=s*U,xt=b*H,It=g*O,Et=_*k,yt=C*Z,Bt=J+Ut+ht,_t=W+re+ae+J+qt+Ut+Qt,si=J+se+Ie+We+Ut+tt+Mt,Li=_e+fe+re+J+Ut+tt+nt,vi=_e+re+ae+J+xt,ci=Ut+tt+nt+Mt+It,mt=J+se+Me+Ge+qt+ti+Ut,$t=qt+ti+Ut+Qt+Et,Mi=J+se+Me+Ie+yt;return t.set(0,0,Bt),t.set(0,1,_t),t.set(0,2,si),t.set(1,0,Li),t.set(1,1,vi),t.set(1,2,ci),t.set(2,0,mt),t.set(2,1,$t),t.set(2,2,Mi),t}mmulStrassen(r){r=Matrix$2.checkMatrix(r);let t=this.clone(),o=t.rows,s=t.columns,d=r.rows,g=r.columns;s!==d&&console.warn(`Multiplying ${o} x ${s} and ${d} x ${g} matrix: dimensions do not match.`);function a(C,D,k){let O=C.rows,U=C.columns;if(O===D&&U===k)return C;{let G=AbstractMatrix.zeros(D,k);return G=G.setSubMatrix(C,0,0),G}}let b=Math.max(o,d),_=Math.max(s,g);t=a(t,b,_),r=a(r,b,_);function T(C,D,k,O){if(k<=512||O<=512)return C.mmul(D);k%2===1&&O%2===1?(C=a(C,k+1,O+1),D=a(D,k+1,O+1)):k%2===1?(C=a(C,k+1,O),D=a(D,k+1,O)):O%2===1&&(C=a(C,k,O+1),D=a(D,k,O+1));let U=parseInt(C.rows/2,10),G=parseInt(C.columns/2,10),j=C.subMatrix(0,U-1,0,G-1),te=D.subMatrix(0,U-1,0,G-1),H=C.subMatrix(0,U-1,G,C.columns-1),Z=D.subMatrix(0,U-1,G,D.columns-1),W=C.subMatrix(U,C.rows-1,0,G-1),_e=D.subMatrix(U,D.rows-1,0,G-1),fe=C.subMatrix(U,C.rows-1,G,C.columns-1),re=D.subMatrix(U,D.rows-1,G,D.columns-1),ae=T(AbstractMatrix.add(j,fe),AbstractMatrix.add(te,re),U,G),J=T(AbstractMatrix.add(W,fe),te,U,G),se=T(j,AbstractMatrix.sub(Z,re),U,G),Me=T(fe,AbstractMatrix.sub(_e,te),U,G),Ie=T(AbstractMatrix.add(j,H),re,U,G),We=T(AbstractMatrix.sub(W,j),AbstractMatrix.add(te,Z),U,G),Ge=T(AbstractMatrix.sub(H,fe),AbstractMatrix.add(_e,re),U,G),qt=AbstractMatrix.add(ae,Me);qt.sub(Ie),qt.add(Ge);let ti=AbstractMatrix.add(se,Ie),Ut=AbstractMatrix.add(J,Me),Qt=AbstractMatrix.sub(ae,J);Qt.add(se),Qt.add(We);let tt=AbstractMatrix.zeros(2*qt.rows,2*qt.columns);return tt=tt.setSubMatrix(qt,0,0),tt=tt.setSubMatrix(ti,qt.rows,0),tt=tt.setSubMatrix(Ut,0,qt.columns),tt=tt.setSubMatrix(Qt,qt.rows,qt.columns),tt.subMatrix(0,k-1,0,O-1)}return T(t,r,b,_)}scaleRows(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{min:t=0,max:o=1}=r;if(!Number.isFinite(t))throw new TypeError("min must be a number");if(!Number.isFinite(o))throw new TypeError("max must be a number");if(t>=o)throw new RangeError("min must be smaller than max");let s=new Matrix$2(this.rows,this.columns);for(let d=0;d<this.rows;d++){const g=this.getRow(d);g.length>0&&rescale(g,{min:t,max:o,output:g}),s.setRow(d,g)}return s}scaleColumns(r={}){if(typeof r!="object")throw new TypeError("options must be an object");const{min:t=0,max:o=1}=r;if(!Number.isFinite(t))throw new TypeError("min must be a number");if(!Number.isFinite(o))throw new TypeError("max must be a number");if(t>=o)throw new RangeError("min must be smaller than max");let s=new Matrix$2(this.rows,this.columns);for(let d=0;d<this.columns;d++){const g=this.getColumn(d);g.length&&rescale(g,{min:t,max:o,output:g}),s.setColumn(d,g)}return s}flipRows(){const r=Math.ceil(this.columns/2);for(let t=0;t<this.rows;t++)for(let o=0;o<r;o++){let s=this.get(t,o),d=this.get(t,this.columns-1-o);this.set(t,o,d),this.set(t,this.columns-1-o,s)}return this}flipColumns(){const r=Math.ceil(this.rows/2);for(let t=0;t<this.columns;t++)for(let o=0;o<r;o++){let s=this.get(o,t),d=this.get(this.rows-1-o,t);this.set(o,t,d),this.set(this.rows-1-o,t,s)}return this}kroneckerProduct(r){r=Matrix$2.checkMatrix(r);let t=this.rows,o=this.columns,s=r.rows,d=r.columns,g=new Matrix$2(t*s,o*d);for(let a=0;a<t;a++)for(let b=0;b<o;b++)for(let _=0;_<s;_++)for(let T=0;T<d;T++)g.set(s*a+_,d*b+T,this.get(a,b)*r.get(_,T));return g}kroneckerSum(r){if(r=Matrix$2.checkMatrix(r),!this.isSquare()||!r.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let t=this.rows,o=r.rows,s=this.kroneckerProduct(Matrix$2.eye(o,o)),d=Matrix$2.eye(t,t).kroneckerProduct(r);return s.add(d)}transpose(){let r=new Matrix$2(this.columns,this.rows);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)r.set(o,t,this.get(t,o));return r}sortRows(r=compareNumbers){for(let t=0;t<this.rows;t++)this.setRow(t,this.getRow(t).sort(r));return this}sortColumns(r=compareNumbers){for(let t=0;t<this.columns;t++)this.setColumn(t,this.getColumn(t).sort(r));return this}subMatrix(r,t,o,s){checkRange(this,r,t,o,s);let d=new Matrix$2(t-r+1,s-o+1);for(let g=r;g<=t;g++)for(let a=o;a<=s;a++)d.set(g-r,a-o,this.get(g,a));return d}subMatrixRow(r,t,o){if(t===void 0&&(t=0),o===void 0&&(o=this.columns-1),t>o||t<0||t>=this.columns||o<0||o>=this.columns)throw new RangeError("Argument out of range");let s=new Matrix$2(r.length,o-t+1);for(let d=0;d<r.length;d++)for(let g=t;g<=o;g++){if(r[d]<0||r[d]>=this.rows)throw new RangeError(`Row index out of range: ${r[d]}`);s.set(d,g-t,this.get(r[d],g))}return s}subMatrixColumn(r,t,o){if(t===void 0&&(t=0),o===void 0&&(o=this.rows-1),t>o||t<0||t>=this.rows||o<0||o>=this.rows)throw new RangeError("Argument out of range");let s=new Matrix$2(o-t+1,r.length);for(let d=0;d<r.length;d++)for(let g=t;g<=o;g++){if(r[d]<0||r[d]>=this.columns)throw new RangeError(`Column index out of range: ${r[d]}`);s.set(g-t,d,this.get(g,r[d]))}return s}setSubMatrix(r,t,o){if(r=Matrix$2.checkMatrix(r),r.isEmpty())return this;let s=t+r.rows-1,d=o+r.columns-1;checkRange(this,t,s,o,d);for(let g=0;g<r.rows;g++)for(let a=0;a<r.columns;a++)this.set(t+g,o+a,r.get(g,a));return this}selection(r,t){checkRowIndices(this,r),checkColumnIndices(this,t);let o=new Matrix$2(r.length,t.length);for(let s=0;s<r.length;s++){let d=r[s];for(let g=0;g<t.length;g++){let a=t[g];o.set(s,g,this.get(d,a))}}return o}trace(){let r=Math.min(this.rows,this.columns),t=0;for(let o=0;o<r;o++)t+=this.get(o,o);return t}clone(){let r=new Matrix$2(this.rows,this.columns);for(let t=0;t<this.rows;t++)for(let o=0;o<this.columns;o++)r.set(t,o,this.get(t,o));return r}sum(r){switch(r){case"row":return sumByRow(this);case"column":return sumByColumn(this);case void 0:return sumAll(this);default:throw new Error(`invalid option: ${r}`)}}product(r){switch(r){case"row":return productByRow(this);case"column":return productByColumn(this);case void 0:return productAll(this);default:throw new Error(`invalid option: ${r}`)}}mean(r){const t=this.sum(r);switch(r){case"row":{for(let o=0;o<this.rows;o++)t[o]/=this.columns;return t}case"column":{for(let o=0;o<this.columns;o++)t[o]/=this.rows;return t}case void 0:return t/this.size;default:throw new Error(`invalid option: ${r}`)}}variance(r,t={}){if(typeof r=="object"&&(t=r,r=void 0),typeof t!="object")throw new TypeError("options must be an object");const{unbiased:o=!0,mean:s=this.mean(r)}=t;if(typeof o!="boolean")throw new TypeError("unbiased must be a boolean");switch(r){case"row":{if(!isAnyArray(s))throw new TypeError("mean must be an array");return varianceByRow(this,o,s)}case"column":{if(!isAnyArray(s))throw new TypeError("mean must be an array");return varianceByColumn(this,o,s)}case void 0:{if(typeof s!="number")throw new TypeError("mean must be a number");return varianceAll(this,o,s)}default:throw new Error(`invalid option: ${r}`)}}standardDeviation(r,t){typeof r=="object"&&(t=r,r=void 0);const o=this.variance(r,t);if(r===void 0)return Math.sqrt(o);for(let s=0;s<o.length;s++)o[s]=Math.sqrt(o[s]);return o}center(r,t={}){if(typeof r=="object"&&(t=r,r=void 0),typeof t!="object")throw new TypeError("options must be an object");const{center:o=this.mean(r)}=t;switch(r){case"row":{if(!isAnyArray(o))throw new TypeError("center must be an array");return centerByRow(this,o),this}case"column":{if(!isAnyArray(o))throw new TypeError("center must be an array");return centerByColumn(this,o),this}case void 0:{if(typeof o!="number")throw new TypeError("center must be a number");return centerAll(this,o),this}default:throw new Error(`invalid option: ${r}`)}}scale(r,t={}){if(typeof r=="object"&&(t=r,r=void 0),typeof t!="object")throw new TypeError("options must be an object");let o=t.scale;switch(r){case"row":{if(o===void 0)o=getScaleByRow(this);else if(!isAnyArray(o))throw new TypeError("scale must be an array");return scaleByRow(this,o),this}case"column":{if(o===void 0)o=getScaleByColumn(this);else if(!isAnyArray(o))throw new TypeError("scale must be an array");return scaleByColumn(this,o),this}case void 0:{if(o===void 0)o=getScaleAll(this);else if(typeof o!="number")throw new TypeError("scale must be a number");return scaleAll(this,o),this}default:throw new Error(`invalid option: ${r}`)}}toString(r){return inspectMatrixWithOptions(this,r)}}AbstractMatrix.prototype.klass="Matrix";typeof Symbol<"u"&&(AbstractMatrix.prototype[Symbol.for("nodejs.util.inspect.custom")]=inspectMatrix);function compareNumbers(e,r){return e-r}function isArrayOfNumbers(e){return e.every(r=>typeof r=="number")}AbstractMatrix.random=AbstractMatrix.rand;AbstractMatrix.randomInt=AbstractMatrix.randInt;AbstractMatrix.diagonal=AbstractMatrix.diag;AbstractMatrix.prototype.diagonal=AbstractMatrix.prototype.diag;AbstractMatrix.identity=AbstractMatrix.eye;AbstractMatrix.prototype.negate=AbstractMatrix.prototype.neg;AbstractMatrix.prototype.tensorProduct=AbstractMatrix.prototype.kroneckerProduct;let Matrix$2=class Fp extends AbstractMatrix{constructor(r,t){if(super(),Fp.isMatrix(r))return r.clone();if(Number.isInteger(r)&&r>=0)if(this.data=[],Number.isInteger(t)&&t>=0)for(let o=0;o<r;o++)this.data.push(new Float64Array(t));else throw new TypeError("nColumns must be a positive integer");else if(isAnyArray(r)){const o=r;if(r=o.length,t=r?o[0].length:0,typeof t!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let s=0;s<r;s++){if(o[s].length!==t)throw new RangeError("Inconsistent array dimensions");if(!isArrayOfNumbers(o[s]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(o[s]))}}else throw new TypeError("First argument must be a positive number or an array");this.rows=r,this.columns=t}set(r,t,o){return this.data[r][t]=o,this}get(r,t){return this.data[r][t]}removeRow(r){return checkRowIndex(this,r),this.data.splice(r,1),this.rows-=1,this}addRow(r,t){return t===void 0&&(t=r,r=this.rows),checkRowIndex(this,r,!0),t=Float64Array.from(checkRowVector(this,t)),this.data.splice(r,0,t),this.rows+=1,this}removeColumn(r){checkColumnIndex(this,r);for(let t=0;t<this.rows;t++){const o=new Float64Array(this.columns-1);for(let s=0;s<r;s++)o[s]=this.data[t][s];for(let s=r+1;s<this.columns;s++)o[s-1]=this.data[t][s];this.data[t]=o}return this.columns-=1,this}addColumn(r,t){typeof t>"u"&&(t=r,r=this.columns),checkColumnIndex(this,r,!0),t=checkColumnVector(this,t);for(let o=0;o<this.rows;o++){const s=new Float64Array(this.columns+1);let d=0;for(;d<r;d++)s[d]=this.data[o][d];for(s[d++]=t[o];d<this.columns+1;d++)s[d]=this.data[o][d-1];this.data[o]=s}return this.columns+=1,this}};installMathOperations(AbstractMatrix,Matrix$2);class BaseView extends AbstractMatrix{constructor(r,t,o){super(),this.matrix=r,this.rows=t,this.columns=o}}class MatrixColumnView extends BaseView{constructor(r,t){checkColumnIndex(r,t),super(r,r.rows,1),this.column=t}set(r,t,o){return this.matrix.set(r,this.column,o),this}get(r){return this.matrix.get(r,this.column)}}class MatrixColumnSelectionView extends BaseView{constructor(r,t){checkColumnIndices(r,t),super(r,r.rows,t.length),this.columnIndices=t}set(r,t,o){return this.matrix.set(r,this.columnIndices[t],o),this}get(r,t){return this.matrix.get(r,this.columnIndices[t])}}class MatrixFlipColumnView extends BaseView{constructor(r){super(r,r.rows,r.columns)}set(r,t,o){return this.matrix.set(r,this.columns-t-1,o),this}get(r,t){return this.matrix.get(r,this.columns-t-1)}}class MatrixFlipRowView extends BaseView{constructor(r){super(r,r.rows,r.columns)}set(r,t,o){return this.matrix.set(this.rows-r-1,t,o),this}get(r,t){return this.matrix.get(this.rows-r-1,t)}}class MatrixRowView extends BaseView{constructor(r,t){checkRowIndex(r,t),super(r,1,r.columns),this.row=t}set(r,t,o){return this.matrix.set(this.row,t,o),this}get(r,t){return this.matrix.get(this.row,t)}}class MatrixRowSelectionView extends BaseView{constructor(r,t){checkRowIndices(r,t),super(r,t.length,r.columns),this.rowIndices=t}set(r,t,o){return this.matrix.set(this.rowIndices[r],t,o),this}get(r,t){return this.matrix.get(this.rowIndices[r],t)}}class MatrixSelectionView extends BaseView{constructor(r,t,o){checkRowIndices(r,t),checkColumnIndices(r,o),super(r,t.length,o.length),this.rowIndices=t,this.columnIndices=o}set(r,t,o){return this.matrix.set(this.rowIndices[r],this.columnIndices[t],o),this}get(r,t){return this.matrix.get(this.rowIndices[r],this.columnIndices[t])}}class MatrixSubView extends BaseView{constructor(r,t,o,s,d){checkRange(r,t,o,s,d),super(r,o-t+1,d-s+1),this.startRow=t,this.startColumn=s}set(r,t,o){return this.matrix.set(this.startRow+r,this.startColumn+t,o),this}get(r,t){return this.matrix.get(this.startRow+r,this.startColumn+t)}}let MatrixTransposeView$1=class extends BaseView{constructor(r){super(r,r.columns,r.rows)}set(r,t,o){return this.matrix.set(t,r,o),this}get(r,t){return this.matrix.get(t,r)}};class WrapperMatrix1D extends AbstractMatrix{constructor(r,t={}){const{rows:o=1}=t;if(r.length%o!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=o,this.columns=r.length/o,this.data=r}set(r,t,o){let s=this._calculateIndex(r,t);return this.data[s]=o,this}get(r,t){let o=this._calculateIndex(r,t);return this.data[o]}_calculateIndex(r,t){return r*this.columns+t}}class WrapperMatrix2D extends AbstractMatrix{constructor(r){super(),this.data=r,this.rows=r.length,this.columns=r[0].length}set(r,t,o){return this.data[r][t]=o,this}get(r,t){return this.data[r][t]}}function wrap(e,r){if(isAnyArray(e))return e[0]&&isAnyArray(e[0])?new WrapperMatrix2D(e):new WrapperMatrix1D(e,r);throw new Error("the argument is not an array")}class LuDecomposition{constructor(r){r=WrapperMatrix2D.checkMatrix(r);let t=r.clone(),o=t.rows,s=t.columns,d=new Float64Array(o),g=1,a,b,_,T,C,D,k,O,U;for(a=0;a<o;a++)d[a]=a;for(O=new Float64Array(o),b=0;b<s;b++){for(a=0;a<o;a++)O[a]=t.get(a,b);for(a=0;a<o;a++){for(U=Math.min(a,b),C=0,_=0;_<U;_++)C+=t.get(a,_)*O[_];O[a]-=C,t.set(a,b,O[a])}for(T=b,a=b+1;a<o;a++)Math.abs(O[a])>Math.abs(O[T])&&(T=a);if(T!==b){for(_=0;_<s;_++)D=t.get(T,_),t.set(T,_,t.get(b,_)),t.set(b,_,D);k=d[T],d[T]=d[b],d[b]=k,g=-g}if(b<o&&t.get(b,b)!==0)for(a=b+1;a<o;a++)t.set(a,b,t.get(a,b)/t.get(b,b))}this.LU=t,this.pivotVector=d,this.pivotSign=g}isSingular(){let r=this.LU,t=r.columns;for(let o=0;o<t;o++)if(r.get(o,o)===0)return!0;return!1}solve(r){r=Matrix$2.checkMatrix(r);let t=this.LU;if(t.rows!==r.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let s=r.columns,d=r.subMatrixRow(this.pivotVector,0,s-1),g=t.columns,a,b,_;for(_=0;_<g;_++)for(a=_+1;a<g;a++)for(b=0;b<s;b++)d.set(a,b,d.get(a,b)-d.get(_,b)*t.get(a,_));for(_=g-1;_>=0;_--){for(b=0;b<s;b++)d.set(_,b,d.get(_,b)/t.get(_,_));for(a=0;a<_;a++)for(b=0;b<s;b++)d.set(a,b,d.get(a,b)-d.get(_,b)*t.get(a,_))}return d}get determinant(){let r=this.LU;if(!r.isSquare())throw new Error("Matrix must be square");let t=this.pivotSign,o=r.columns;for(let s=0;s<o;s++)t*=r.get(s,s);return t}get lowerTriangularMatrix(){let r=this.LU,t=r.rows,o=r.columns,s=new Matrix$2(t,o);for(let d=0;d<t;d++)for(let g=0;g<o;g++)d>g?s.set(d,g,r.get(d,g)):d===g?s.set(d,g,1):s.set(d,g,0);return s}get upperTriangularMatrix(){let r=this.LU,t=r.rows,o=r.columns,s=new Matrix$2(t,o);for(let d=0;d<t;d++)for(let g=0;g<o;g++)d<=g?s.set(d,g,r.get(d,g)):s.set(d,g,0);return s}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function hypotenuse$1(e,r){let t=0;return Math.abs(e)>Math.abs(r)?(t=r/e,Math.abs(e)*Math.sqrt(1+t*t)):r!==0?(t=e/r,Math.abs(r)*Math.sqrt(1+t*t)):0}class QrDecomposition{constructor(r){r=WrapperMatrix2D.checkMatrix(r);let t=r.clone(),o=r.rows,s=r.columns,d=new Float64Array(s),g,a,b,_;for(b=0;b<s;b++){let T=0;for(g=b;g<o;g++)T=hypotenuse$1(T,t.get(g,b));if(T!==0){for(t.get(b,b)<0&&(T=-T),g=b;g<o;g++)t.set(g,b,t.get(g,b)/T);for(t.set(b,b,t.get(b,b)+1),a=b+1;a<s;a++){for(_=0,g=b;g<o;g++)_+=t.get(g,b)*t.get(g,a);for(_=-_/t.get(b,b),g=b;g<o;g++)t.set(g,a,t.get(g,a)+_*t.get(g,b))}}d[b]=-T}this.QR=t,this.Rdiag=d}solve(r){r=Matrix$2.checkMatrix(r);let t=this.QR,o=t.rows;if(r.rows!==o)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let s=r.columns,d=r.clone(),g=t.columns,a,b,_,T;for(_=0;_<g;_++)for(b=0;b<s;b++){for(T=0,a=_;a<o;a++)T+=t.get(a,_)*d.get(a,b);for(T=-T/t.get(_,_),a=_;a<o;a++)d.set(a,b,d.get(a,b)+T*t.get(a,_))}for(_=g-1;_>=0;_--){for(b=0;b<s;b++)d.set(_,b,d.get(_,b)/this.Rdiag[_]);for(a=0;a<_;a++)for(b=0;b<s;b++)d.set(a,b,d.get(a,b)-d.get(_,b)*t.get(a,_))}return d.subMatrix(0,g-1,0,s-1)}isFullRank(){let r=this.QR.columns;for(let t=0;t<r;t++)if(this.Rdiag[t]===0)return!1;return!0}get upperTriangularMatrix(){let r=this.QR,t=r.columns,o=new Matrix$2(t,t),s,d;for(s=0;s<t;s++)for(d=0;d<t;d++)s<d?o.set(s,d,r.get(s,d)):s===d?o.set(s,d,this.Rdiag[s]):o.set(s,d,0);return o}get orthogonalMatrix(){let r=this.QR,t=r.rows,o=r.columns,s=new Matrix$2(t,o),d,g,a,b;for(a=o-1;a>=0;a--){for(d=0;d<t;d++)s.set(d,a,0);for(s.set(a,a,1),g=a;g<o;g++)if(r.get(a,a)!==0){for(b=0,d=a;d<t;d++)b+=r.get(d,a)*s.get(d,g);for(b=-b/r.get(a,a),d=a;d<t;d++)s.set(d,g,s.get(d,g)+b*r.get(d,a))}}return s}}class SingularValueDecomposition{constructor(r,t={}){if(r=WrapperMatrix2D.checkMatrix(r),r.isEmpty())throw new Error("Matrix must be non-empty");let o=r.rows,s=r.columns;const{computeLeftSingularVectors:d=!0,computeRightSingularVectors:g=!0,autoTranspose:a=!1}=t;let b=!!d,_=!!g,T=!1,C;if(o<s)if(!a)C=r.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{C=r.transpose(),o=C.rows,s=C.columns,T=!0;let J=b;b=_,_=J}else C=r.clone();let D=Math.min(o,s),k=Math.min(o+1,s),O=new Float64Array(k),U=new Matrix$2(o,D),G=new Matrix$2(s,s),j=new Float64Array(s),te=new Float64Array(o),H=new Float64Array(k);for(let J=0;J<k;J++)H[J]=J;let Z=Math.min(o-1,s),W=Math.max(0,Math.min(s-2,o)),_e=Math.max(Z,W);for(let J=0;J<_e;J++){if(J<Z){O[J]=0;for(let se=J;se<o;se++)O[J]=hypotenuse$1(O[J],C.get(se,J));if(O[J]!==0){C.get(J,J)<0&&(O[J]=-O[J]);for(let se=J;se<o;se++)C.set(se,J,C.get(se,J)/O[J]);C.set(J,J,C.get(J,J)+1)}O[J]=-O[J]}for(let se=J+1;se<s;se++){if(J<Z&&O[J]!==0){let Me=0;for(let Ie=J;Ie<o;Ie++)Me+=C.get(Ie,J)*C.get(Ie,se);Me=-Me/C.get(J,J);for(let Ie=J;Ie<o;Ie++)C.set(Ie,se,C.get(Ie,se)+Me*C.get(Ie,J))}j[se]=C.get(J,se)}if(b&&J<Z)for(let se=J;se<o;se++)U.set(se,J,C.get(se,J));if(J<W){j[J]=0;for(let se=J+1;se<s;se++)j[J]=hypotenuse$1(j[J],j[se]);if(j[J]!==0){j[J+1]<0&&(j[J]=0-j[J]);for(let se=J+1;se<s;se++)j[se]/=j[J];j[J+1]+=1}if(j[J]=-j[J],J+1<o&&j[J]!==0){for(let se=J+1;se<o;se++)te[se]=0;for(let se=J+1;se<o;se++)for(let Me=J+1;Me<s;Me++)te[se]+=j[Me]*C.get(se,Me);for(let se=J+1;se<s;se++){let Me=-j[se]/j[J+1];for(let Ie=J+1;Ie<o;Ie++)C.set(Ie,se,C.get(Ie,se)+Me*te[Ie])}}if(_)for(let se=J+1;se<s;se++)G.set(se,J,j[se])}}let fe=Math.min(s,o+1);if(Z<s&&(O[Z]=C.get(Z,Z)),o<fe&&(O[fe-1]=0),W+1<fe&&(j[W]=C.get(W,fe-1)),j[fe-1]=0,b){for(let J=Z;J<D;J++){for(let se=0;se<o;se++)U.set(se,J,0);U.set(J,J,1)}for(let J=Z-1;J>=0;J--)if(O[J]!==0){for(let se=J+1;se<D;se++){let Me=0;for(let Ie=J;Ie<o;Ie++)Me+=U.get(Ie,J)*U.get(Ie,se);Me=-Me/U.get(J,J);for(let Ie=J;Ie<o;Ie++)U.set(Ie,se,U.get(Ie,se)+Me*U.get(Ie,J))}for(let se=J;se<o;se++)U.set(se,J,-U.get(se,J));U.set(J,J,1+U.get(J,J));for(let se=0;se<J-1;se++)U.set(se,J,0)}else{for(let se=0;se<o;se++)U.set(se,J,0);U.set(J,J,1)}}if(_)for(let J=s-1;J>=0;J--){if(J<W&&j[J]!==0)for(let se=J+1;se<s;se++){let Me=0;for(let Ie=J+1;Ie<s;Ie++)Me+=G.get(Ie,J)*G.get(Ie,se);Me=-Me/G.get(J+1,J);for(let Ie=J+1;Ie<s;Ie++)G.set(Ie,se,G.get(Ie,se)+Me*G.get(Ie,J))}for(let se=0;se<s;se++)G.set(se,J,0);G.set(J,J,1)}let re=fe-1,ae=Number.EPSILON;for(;fe>0;){let J,se;for(J=fe-2;J>=-1&&J!==-1;J--){const Me=Number.MIN_VALUE+ae*Math.abs(O[J]+Math.abs(O[J+1]));if(Math.abs(j[J])<=Me||Number.isNaN(j[J])){j[J]=0;break}}if(J===fe-2)se=4;else{let Me;for(Me=fe-1;Me>=J&&Me!==J;Me--){let Ie=(Me!==fe?Math.abs(j[Me]):0)+(Me!==J+1?Math.abs(j[Me-1]):0);if(Math.abs(O[Me])<=ae*Ie){O[Me]=0;break}}Me===J?se=3:Me===fe-1?se=1:(se=2,J=Me)}switch(J++,se){case 1:{let Me=j[fe-2];j[fe-2]=0;for(let Ie=fe-2;Ie>=J;Ie--){let We=hypotenuse$1(O[Ie],Me),Ge=O[Ie]/We,qt=Me/We;if(O[Ie]=We,Ie!==J&&(Me=-qt*j[Ie-1],j[Ie-1]=Ge*j[Ie-1]),_)for(let ti=0;ti<s;ti++)We=Ge*G.get(ti,Ie)+qt*G.get(ti,fe-1),G.set(ti,fe-1,-qt*G.get(ti,Ie)+Ge*G.get(ti,fe-1)),G.set(ti,Ie,We)}break}case 2:{let Me=j[J-1];j[J-1]=0;for(let Ie=J;Ie<fe;Ie++){let We=hypotenuse$1(O[Ie],Me),Ge=O[Ie]/We,qt=Me/We;if(O[Ie]=We,Me=-qt*j[Ie],j[Ie]=Ge*j[Ie],b)for(let ti=0;ti<o;ti++)We=Ge*U.get(ti,Ie)+qt*U.get(ti,J-1),U.set(ti,J-1,-qt*U.get(ti,Ie)+Ge*U.get(ti,J-1)),U.set(ti,Ie,We)}break}case 3:{const Me=Math.max(Math.abs(O[fe-1]),Math.abs(O[fe-2]),Math.abs(j[fe-2]),Math.abs(O[J]),Math.abs(j[J])),Ie=O[fe-1]/Me,We=O[fe-2]/Me,Ge=j[fe-2]/Me,qt=O[J]/Me,ti=j[J]/Me,Ut=((We+Ie)*(We-Ie)+Ge*Ge)/2,Qt=Ie*Ge*(Ie*Ge);let tt=0;(Ut!==0||Qt!==0)&&(Ut<0?tt=0-Math.sqrt(Ut*Ut+Qt):tt=Math.sqrt(Ut*Ut+Qt),tt=Qt/(Ut+tt));let nt=(qt+Ie)*(qt-Ie)+tt,Mt=qt*ti;for(let ht=J;ht<fe-1;ht++){let xt=hypotenuse$1(nt,Mt);xt===0&&(xt=Number.MIN_VALUE);let It=nt/xt,Et=Mt/xt;if(ht!==J&&(j[ht-1]=xt),nt=It*O[ht]+Et*j[ht],j[ht]=It*j[ht]-Et*O[ht],Mt=Et*O[ht+1],O[ht+1]=It*O[ht+1],_)for(let yt=0;yt<s;yt++)xt=It*G.get(yt,ht)+Et*G.get(yt,ht+1),G.set(yt,ht+1,-Et*G.get(yt,ht)+It*G.get(yt,ht+1)),G.set(yt,ht,xt);if(xt=hypotenuse$1(nt,Mt),xt===0&&(xt=Number.MIN_VALUE),It=nt/xt,Et=Mt/xt,O[ht]=xt,nt=It*j[ht]+Et*O[ht+1],O[ht+1]=-Et*j[ht]+It*O[ht+1],Mt=Et*j[ht+1],j[ht+1]=It*j[ht+1],b&&ht<o-1)for(let yt=0;yt<o;yt++)xt=It*U.get(yt,ht)+Et*U.get(yt,ht+1),U.set(yt,ht+1,-Et*U.get(yt,ht)+It*U.get(yt,ht+1)),U.set(yt,ht,xt)}j[fe-2]=nt;break}case 4:{if(O[J]<=0&&(O[J]=O[J]<0?-O[J]:0,_))for(let Me=0;Me<=re;Me++)G.set(Me,J,-G.get(Me,J));for(;J<re&&!(O[J]>=O[J+1]);){let Me=O[J];if(O[J]=O[J+1],O[J+1]=Me,_&&J<s-1)for(let Ie=0;Ie<s;Ie++)Me=G.get(Ie,J+1),G.set(Ie,J+1,G.get(Ie,J)),G.set(Ie,J,Me);if(b&&J<o-1)for(let Ie=0;Ie<o;Ie++)Me=U.get(Ie,J+1),U.set(Ie,J+1,U.get(Ie,J)),U.set(Ie,J,Me);J++}fe--;break}}}if(T){let J=G;G=U,U=J}this.m=o,this.n=s,this.s=O,this.U=U,this.V=G}solve(r){let t=r,o=this.threshold,s=this.s.length,d=Matrix$2.zeros(s,s);for(let D=0;D<s;D++)Math.abs(this.s[D])<=o?d.set(D,D,0):d.set(D,D,1/this.s[D]);let g=this.U,a=this.rightSingularVectors,b=a.mmul(d),_=a.rows,T=g.rows,C=Matrix$2.zeros(_,T);for(let D=0;D<_;D++)for(let k=0;k<T;k++){let O=0;for(let U=0;U<s;U++)O+=b.get(D,U)*g.get(k,U);C.set(D,k,O)}return C.mmul(t)}solveForDiagonal(r){return this.solve(Matrix$2.diag(r))}inverse(){let r=this.V,t=this.threshold,o=r.rows,s=r.columns,d=new Matrix$2(o,this.s.length);for(let T=0;T<o;T++)for(let C=0;C<s;C++)Math.abs(this.s[C])>t&&d.set(T,C,r.get(T,C)/this.s[C]);let g=this.U,a=g.rows,b=g.columns,_=new Matrix$2(o,a);for(let T=0;T<o;T++)for(let C=0;C<a;C++){let D=0;for(let k=0;k<b;k++)D+=d.get(T,k)*g.get(C,k);_.set(T,C,D)}return _}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let r=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,t=0,o=this.s;for(let s=0,d=o.length;s<d;s++)o[s]>r&&t++;return t}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return Matrix$2.diag(this.s)}}function inverse(e,r=!1){return e=WrapperMatrix2D.checkMatrix(e),r?new SingularValueDecomposition(e).inverse():solve(e,Matrix$2.eye(e.rows))}function solve(e,r,t=!1){return e=WrapperMatrix2D.checkMatrix(e),r=WrapperMatrix2D.checkMatrix(r),t?new SingularValueDecomposition(e).solve(r):e.isSquare()?new LuDecomposition(e).solve(r):new QrDecomposition(e).solve(r)}function determinant(e){if(e=Matrix$2.checkMatrix(e),e.isSquare()){if(e.columns===0)return 1;let r,t,o,s;if(e.columns===2)return r=e.get(0,0),t=e.get(0,1),o=e.get(1,0),s=e.get(1,1),r*s-t*o;if(e.columns===3){let d,g,a;return d=new MatrixSelectionView(e,[1,2],[1,2]),g=new MatrixSelectionView(e,[1,2],[0,2]),a=new MatrixSelectionView(e,[1,2],[0,1]),r=e.get(0,0),t=e.get(0,1),o=e.get(0,2),r*determinant(d)-t*determinant(g)+o*determinant(a)}else return new LuDecomposition(e).determinant}else throw Error("determinant can only be calculated for a square matrix")}function xrange(e,r){let t=[];for(let o=0;o<e;o++)o!==r&&t.push(o);return t}function dependenciesOneRow(e,r,t,o=1e-9,s=1e-9){if(e>s)return new Array(r.rows+1).fill(0);{let d=r.addRow(t,[0]);for(let g=0;g<d.rows;g++)Math.abs(d.get(g,0))<o&&d.set(g,0,0);return d.to1DArray()}}function linearDependencies(e,r={}){const{thresholdValue:t=1e-9,thresholdError:o=1e-9}=r;e=Matrix$2.checkMatrix(e);let s=e.rows,d=new Matrix$2(s,s);for(let g=0;g<s;g++){let a=Matrix$2.columnVector(e.getRow(g)),b=e.subMatrixRow(xrange(s,g)).transpose(),T=new SingularValueDecomposition(b).solve(a),C=Matrix$2.sub(a,b.mmul(T)).abs().max();d.setRow(g,dependenciesOneRow(C,T,g,t,o))}return d}function pseudoInverse(e,r=Number.EPSILON){if(e=Matrix$2.checkMatrix(e),e.isEmpty())return e.transpose();let t=new SingularValueDecomposition(e,{autoTranspose:!0}),o=t.leftSingularVectors,s=t.rightSingularVectors,d=t.diagonal;for(let g=0;g<d.length;g++)Math.abs(d[g])>r?d[g]=1/d[g]:d[g]=0;return s.mmul(Matrix$2.diag(d).mmul(o.transpose()))}function covariance(e,r=e,t={}){e=new Matrix$2(e);let o=!1;if(typeof r=="object"&&!Matrix$2.isMatrix(r)&&!isAnyArray(r)?(t=r,r=e,o=!0):r=new Matrix$2(r),e.rows!==r.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:s=!0}=t;s&&(e=e.center("column"),o||(r=r.center("column")));const d=e.transpose().mmul(r);for(let g=0;g<d.rows;g++)for(let a=0;a<d.columns;a++)d.set(g,a,d.get(g,a)*(1/(e.rows-1)));return d}function correlation(e,r=e,t={}){e=new Matrix$2(e);let o=!1;if(typeof r=="object"&&!Matrix$2.isMatrix(r)&&!isAnyArray(r)?(t=r,r=e,o=!0):r=new Matrix$2(r),e.rows!==r.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:s=!0,scale:d=!0}=t;s&&(e.center("column"),o||r.center("column")),d&&(e.scale("column"),o||r.scale("column"));const g=e.standardDeviation("column",{unbiased:!0}),a=o?g:r.standardDeviation("column",{unbiased:!0}),b=e.transpose().mmul(r);for(let _=0;_<b.rows;_++)for(let T=0;T<b.columns;T++)b.set(_,T,b.get(_,T)*(1/(g[_]*a[T]))*(1/(e.rows-1)));return b}class EigenvalueDecomposition{constructor(r,t={}){const{assumeSymmetric:o=!1}=t;if(r=WrapperMatrix2D.checkMatrix(r),!r.isSquare())throw new Error("Matrix is not a square matrix");if(r.isEmpty())throw new Error("Matrix must be non-empty");let s=r.columns,d=new Matrix$2(s,s),g=new Float64Array(s),a=new Float64Array(s),b=r,_,T,C=!1;if(o?C=!0:C=r.isSymmetric(),C){for(_=0;_<s;_++)for(T=0;T<s;T++)d.set(_,T,b.get(_,T));tred2(s,a,g,d),tql2(s,a,g,d)}else{let D=new Matrix$2(s,s),k=new Float64Array(s);for(T=0;T<s;T++)for(_=0;_<s;_++)D.set(_,T,b.get(_,T));orthes(s,D,k,d),hqr2(s,a,g,d,D)}this.n=s,this.e=a,this.d=g,this.V=d}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let r=this.n,t=this.e,o=this.d,s=new Matrix$2(r,r),d,g;for(d=0;d<r;d++){for(g=0;g<r;g++)s.set(d,g,0);s.set(d,d,o[d]),t[d]>0?s.set(d,d+1,t[d]):t[d]<0&&s.set(d,d-1,t[d])}return s}}function tred2(e,r,t,o){let s,d,g,a,b,_,T,C;for(b=0;b<e;b++)t[b]=o.get(e-1,b);for(a=e-1;a>0;a--){for(C=0,g=0,_=0;_<a;_++)C=C+Math.abs(t[_]);if(C===0)for(r[a]=t[a-1],b=0;b<a;b++)t[b]=o.get(a-1,b),o.set(a,b,0),o.set(b,a,0);else{for(_=0;_<a;_++)t[_]/=C,g+=t[_]*t[_];for(s=t[a-1],d=Math.sqrt(g),s>0&&(d=-d),r[a]=C*d,g=g-s*d,t[a-1]=s-d,b=0;b<a;b++)r[b]=0;for(b=0;b<a;b++){for(s=t[b],o.set(b,a,s),d=r[b]+o.get(b,b)*s,_=b+1;_<=a-1;_++)d+=o.get(_,b)*t[_],r[_]+=o.get(_,b)*s;r[b]=d}for(s=0,b=0;b<a;b++)r[b]/=g,s+=r[b]*t[b];for(T=s/(g+g),b=0;b<a;b++)r[b]-=T*t[b];for(b=0;b<a;b++){for(s=t[b],d=r[b],_=b;_<=a-1;_++)o.set(_,b,o.get(_,b)-(s*r[_]+d*t[_]));t[b]=o.get(a-1,b),o.set(a,b,0)}}t[a]=g}for(a=0;a<e-1;a++){if(o.set(e-1,a,o.get(a,a)),o.set(a,a,1),g=t[a+1],g!==0){for(_=0;_<=a;_++)t[_]=o.get(_,a+1)/g;for(b=0;b<=a;b++){for(d=0,_=0;_<=a;_++)d+=o.get(_,a+1)*o.get(_,b);for(_=0;_<=a;_++)o.set(_,b,o.get(_,b)-d*t[_])}}for(_=0;_<=a;_++)o.set(_,a+1,0)}for(b=0;b<e;b++)t[b]=o.get(e-1,b),o.set(e-1,b,0);o.set(e-1,e-1,1),r[0]=0}function tql2(e,r,t,o){let s,d,g,a,b,_,T,C,D,k,O,U,G,j,te,H;for(g=1;g<e;g++)r[g-1]=r[g];r[e-1]=0;let Z=0,W=0,_e=Number.EPSILON;for(_=0;_<e;_++){for(W=Math.max(W,Math.abs(t[_])+Math.abs(r[_])),T=_;T<e&&!(Math.abs(r[T])<=_e*W);)T++;if(T>_)do{for(s=t[_],C=(t[_+1]-s)/(2*r[_]),D=hypotenuse$1(C,1),C<0&&(D=-D),t[_]=r[_]/(C+D),t[_+1]=r[_]*(C+D),k=t[_+1],d=s-t[_],g=_+2;g<e;g++)t[g]-=d;for(Z=Z+d,C=t[T],O=1,U=O,G=O,j=r[_+1],te=0,H=0,g=T-1;g>=_;g--)for(G=U,U=O,H=te,s=O*r[g],d=O*C,D=hypotenuse$1(C,r[g]),r[g+1]=te*D,te=r[g]/D,O=C/D,C=O*t[g]-te*s,t[g+1]=d+te*(O*s+te*t[g]),b=0;b<e;b++)d=o.get(b,g+1),o.set(b,g+1,te*o.get(b,g)+O*d),o.set(b,g,O*o.get(b,g)-te*d);C=-te*H*G*j*r[_]/k,r[_]=te*C,t[_]=O*C}while(Math.abs(r[_])>_e*W);t[_]=t[_]+Z,r[_]=0}for(g=0;g<e-1;g++){for(b=g,C=t[g],a=g+1;a<e;a++)t[a]<C&&(b=a,C=t[a]);if(b!==g)for(t[b]=t[g],t[g]=C,a=0;a<e;a++)C=o.get(a,g),o.set(a,g,o.get(a,b)),o.set(a,b,C)}}function orthes(e,r,t,o){let s=0,d=e-1,g,a,b,_,T,C,D;for(C=s+1;C<=d-1;C++){for(D=0,_=C;_<=d;_++)D=D+Math.abs(r.get(_,C-1));if(D!==0){for(b=0,_=d;_>=C;_--)t[_]=r.get(_,C-1)/D,b+=t[_]*t[_];for(a=Math.sqrt(b),t[C]>0&&(a=-a),b=b-t[C]*a,t[C]=t[C]-a,T=C;T<e;T++){for(g=0,_=d;_>=C;_--)g+=t[_]*r.get(_,T);for(g=g/b,_=C;_<=d;_++)r.set(_,T,r.get(_,T)-g*t[_])}for(_=0;_<=d;_++){for(g=0,T=d;T>=C;T--)g+=t[T]*r.get(_,T);for(g=g/b,T=C;T<=d;T++)r.set(_,T,r.get(_,T)-g*t[T])}t[C]=D*t[C],r.set(C,C-1,D*a)}}for(_=0;_<e;_++)for(T=0;T<e;T++)o.set(_,T,_===T?1:0);for(C=d-1;C>=s+1;C--)if(r.get(C,C-1)!==0){for(_=C+1;_<=d;_++)t[_]=r.get(_,C-1);for(T=C;T<=d;T++){for(a=0,_=C;_<=d;_++)a+=t[_]*o.get(_,T);for(a=a/t[C]/r.get(C,C-1),_=C;_<=d;_++)o.set(_,T,o.get(_,T)+a*t[_])}}}function hqr2(e,r,t,o,s){let d=e-1,g=0,a=e-1,b=Number.EPSILON,_=0,T=0,C=0,D=0,k=0,O=0,U=0,G=0,j,te,H,Z,W,_e,fe,re,ae,J,se,Me,Ie,We,Ge;for(j=0;j<e;j++)for((j<g||j>a)&&(t[j]=s.get(j,j),r[j]=0),te=Math.max(j-1,0);te<e;te++)T=T+Math.abs(s.get(j,te));for(;d>=g;){for(Z=d;Z>g&&(O=Math.abs(s.get(Z-1,Z-1))+Math.abs(s.get(Z,Z)),O===0&&(O=T),!(Math.abs(s.get(Z,Z-1))<b*O));)Z--;if(Z===d)s.set(d,d,s.get(d,d)+_),t[d]=s.get(d,d),r[d]=0,d--,G=0;else if(Z===d-1){if(fe=s.get(d,d-1)*s.get(d-1,d),C=(s.get(d-1,d-1)-s.get(d,d))/2,D=C*C+fe,U=Math.sqrt(Math.abs(D)),s.set(d,d,s.get(d,d)+_),s.set(d-1,d-1,s.get(d-1,d-1)+_),re=s.get(d,d),D>=0){for(U=C>=0?C+U:C-U,t[d-1]=re+U,t[d]=t[d-1],U!==0&&(t[d]=re-fe/U),r[d-1]=0,r[d]=0,re=s.get(d,d-1),O=Math.abs(re)+Math.abs(U),C=re/O,D=U/O,k=Math.sqrt(C*C+D*D),C=C/k,D=D/k,te=d-1;te<e;te++)U=s.get(d-1,te),s.set(d-1,te,D*U+C*s.get(d,te)),s.set(d,te,D*s.get(d,te)-C*U);for(j=0;j<=d;j++)U=s.get(j,d-1),s.set(j,d-1,D*U+C*s.get(j,d)),s.set(j,d,D*s.get(j,d)-C*U);for(j=g;j<=a;j++)U=o.get(j,d-1),o.set(j,d-1,D*U+C*o.get(j,d)),o.set(j,d,D*o.get(j,d)-C*U)}else t[d-1]=re+C,t[d]=re+C,r[d-1]=U,r[d]=-U;d=d-2,G=0}else{if(re=s.get(d,d),ae=0,fe=0,Z<d&&(ae=s.get(d-1,d-1),fe=s.get(d,d-1)*s.get(d-1,d)),G===10){for(_+=re,j=g;j<=d;j++)s.set(j,j,s.get(j,j)-re);O=Math.abs(s.get(d,d-1))+Math.abs(s.get(d-1,d-2)),re=ae=.75*O,fe=-.4375*O*O}if(G===30&&(O=(ae-re)/2,O=O*O+fe,O>0)){for(O=Math.sqrt(O),ae<re&&(O=-O),O=re-fe/((ae-re)/2+O),j=g;j<=d;j++)s.set(j,j,s.get(j,j)-O);_+=O,re=ae=fe=.964}for(G=G+1,W=d-2;W>=Z&&(U=s.get(W,W),k=re-U,O=ae-U,C=(k*O-fe)/s.get(W+1,W)+s.get(W,W+1),D=s.get(W+1,W+1)-U-k-O,k=s.get(W+2,W+1),O=Math.abs(C)+Math.abs(D)+Math.abs(k),C=C/O,D=D/O,k=k/O,!(W===Z||Math.abs(s.get(W,W-1))*(Math.abs(D)+Math.abs(k))<b*(Math.abs(C)*(Math.abs(s.get(W-1,W-1))+Math.abs(U)+Math.abs(s.get(W+1,W+1))))));)W--;for(j=W+2;j<=d;j++)s.set(j,j-2,0),j>W+2&&s.set(j,j-3,0);for(H=W;H<=d-1&&(We=H!==d-1,H!==W&&(C=s.get(H,H-1),D=s.get(H+1,H-1),k=We?s.get(H+2,H-1):0,re=Math.abs(C)+Math.abs(D)+Math.abs(k),re!==0&&(C=C/re,D=D/re,k=k/re)),re!==0);H++)if(O=Math.sqrt(C*C+D*D+k*k),C<0&&(O=-O),O!==0){for(H!==W?s.set(H,H-1,-O*re):Z!==W&&s.set(H,H-1,-s.get(H,H-1)),C=C+O,re=C/O,ae=D/O,U=k/O,D=D/C,k=k/C,te=H;te<e;te++)C=s.get(H,te)+D*s.get(H+1,te),We&&(C=C+k*s.get(H+2,te),s.set(H+2,te,s.get(H+2,te)-C*U)),s.set(H,te,s.get(H,te)-C*re),s.set(H+1,te,s.get(H+1,te)-C*ae);for(j=0;j<=Math.min(d,H+3);j++)C=re*s.get(j,H)+ae*s.get(j,H+1),We&&(C=C+U*s.get(j,H+2),s.set(j,H+2,s.get(j,H+2)-C*k)),s.set(j,H,s.get(j,H)-C),s.set(j,H+1,s.get(j,H+1)-C*D);for(j=g;j<=a;j++)C=re*o.get(j,H)+ae*o.get(j,H+1),We&&(C=C+U*o.get(j,H+2),o.set(j,H+2,o.get(j,H+2)-C*k)),o.set(j,H,o.get(j,H)-C),o.set(j,H+1,o.get(j,H+1)-C*D)}}}if(T!==0){for(d=e-1;d>=0;d--)if(C=t[d],D=r[d],D===0)for(Z=d,s.set(d,d,1),j=d-1;j>=0;j--){for(fe=s.get(j,j)-C,k=0,te=Z;te<=d;te++)k=k+s.get(j,te)*s.get(te,d);if(r[j]<0)U=fe,O=k;else if(Z=j,r[j]===0?s.set(j,d,fe!==0?-k/fe:-k/(b*T)):(re=s.get(j,j+1),ae=s.get(j+1,j),D=(t[j]-C)*(t[j]-C)+r[j]*r[j],_e=(re*O-U*k)/D,s.set(j,d,_e),s.set(j+1,d,Math.abs(re)>Math.abs(U)?(-k-fe*_e)/re:(-O-ae*_e)/U)),_e=Math.abs(s.get(j,d)),b*_e*_e>1)for(te=j;te<=d;te++)s.set(te,d,s.get(te,d)/_e)}else if(D<0)for(Z=d-1,Math.abs(s.get(d,d-1))>Math.abs(s.get(d-1,d))?(s.set(d-1,d-1,D/s.get(d,d-1)),s.set(d-1,d,-(s.get(d,d)-C)/s.get(d,d-1))):(Ge=cdiv(0,-s.get(d-1,d),s.get(d-1,d-1)-C,D),s.set(d-1,d-1,Ge[0]),s.set(d-1,d,Ge[1])),s.set(d,d-1,0),s.set(d,d,1),j=d-2;j>=0;j--){for(J=0,se=0,te=Z;te<=d;te++)J=J+s.get(j,te)*s.get(te,d-1),se=se+s.get(j,te)*s.get(te,d);if(fe=s.get(j,j)-C,r[j]<0)U=fe,k=J,O=se;else if(Z=j,r[j]===0?(Ge=cdiv(-J,-se,fe,D),s.set(j,d-1,Ge[0]),s.set(j,d,Ge[1])):(re=s.get(j,j+1),ae=s.get(j+1,j),Me=(t[j]-C)*(t[j]-C)+r[j]*r[j]-D*D,Ie=(t[j]-C)*2*D,Me===0&&Ie===0&&(Me=b*T*(Math.abs(fe)+Math.abs(D)+Math.abs(re)+Math.abs(ae)+Math.abs(U))),Ge=cdiv(re*k-U*J+D*se,re*O-U*se-D*J,Me,Ie),s.set(j,d-1,Ge[0]),s.set(j,d,Ge[1]),Math.abs(re)>Math.abs(U)+Math.abs(D)?(s.set(j+1,d-1,(-J-fe*s.get(j,d-1)+D*s.get(j,d))/re),s.set(j+1,d,(-se-fe*s.get(j,d)-D*s.get(j,d-1))/re)):(Ge=cdiv(-k-ae*s.get(j,d-1),-O-ae*s.get(j,d),U,D),s.set(j+1,d-1,Ge[0]),s.set(j+1,d,Ge[1]))),_e=Math.max(Math.abs(s.get(j,d-1)),Math.abs(s.get(j,d))),b*_e*_e>1)for(te=j;te<=d;te++)s.set(te,d-1,s.get(te,d-1)/_e),s.set(te,d,s.get(te,d)/_e)}for(j=0;j<e;j++)if(j<g||j>a)for(te=j;te<e;te++)o.set(j,te,s.get(j,te));for(te=e-1;te>=g;te--)for(j=g;j<=a;j++){for(U=0,H=g;H<=Math.min(te,a);H++)U=U+o.get(j,H)*s.get(H,te);o.set(j,te,U)}}}function cdiv(e,r,t,o){let s,d;return Math.abs(t)>Math.abs(o)?(s=o/t,d=t+s*o,[(e+s*r)/d,(r-s*e)/d]):(s=t/o,d=o+s*t,[(s*e+r)/d,(s*r-e)/d])}class CholeskyDecomposition{constructor(r){if(r=WrapperMatrix2D.checkMatrix(r),!r.isSymmetric())throw new Error("Matrix is not symmetric");let t=r,o=t.rows,s=new Matrix$2(o,o),d=!0,g,a,b;for(a=0;a<o;a++){let _=0;for(b=0;b<a;b++){let T=0;for(g=0;g<b;g++)T+=s.get(b,g)*s.get(a,g);T=(t.get(a,b)-T)/s.get(b,b),s.set(a,b,T),_=_+T*T}for(_=t.get(a,a)-_,d&=_>0,s.set(a,a,Math.sqrt(Math.max(_,0))),b=a+1;b<o;b++)s.set(a,b,0)}this.L=s,this.positiveDefinite=!!d}isPositiveDefinite(){return this.positiveDefinite}solve(r){r=WrapperMatrix2D.checkMatrix(r);let t=this.L,o=t.rows;if(r.rows!==o)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let s=r.columns,d=r.clone(),g,a,b;for(b=0;b<o;b++)for(a=0;a<s;a++){for(g=0;g<b;g++)d.set(b,a,d.get(b,a)-d.get(g,a)*t.get(b,g));d.set(b,a,d.get(b,a)/t.get(b,b))}for(b=o-1;b>=0;b--)for(a=0;a<s;a++){for(g=b+1;g<o;g++)d.set(b,a,d.get(b,a)-d.get(g,a)*t.get(g,b));d.set(b,a,d.get(b,a)/t.get(b,b))}return d}get lowerTriangularMatrix(){return this.L}}class nipals{constructor(r,t={}){r=WrapperMatrix2D.checkMatrix(r);let{Y:o}=t;const{scaleScores:s=!1,maxIterations:d=1e3,terminationCriteria:g=1e-10}=t;let a;if(o){if(isAnyArray(o)&&typeof o[0]=="number"?o=Matrix$2.columnVector(o):o=WrapperMatrix2D.checkMatrix(o),o.rows!==r.rows)throw new Error("Y should have the same number of rows as X");a=o.getColumnVector(0)}else a=r.getColumnVector(0);let b=1,_,T,C,D;for(let k=0;k<d&&b>g;k++)C=r.transpose().mmul(a).div(a.transpose().mmul(a).get(0,0)),C=C.div(C.norm()),_=r.mmul(C).div(C.transpose().mmul(C).get(0,0)),k>0&&(b=_.clone().sub(D).pow(2).sum()),D=_.clone(),o?(T=o.transpose().mmul(_).div(_.transpose().mmul(_).get(0,0)),T=T.div(T.norm()),a=o.mmul(T).div(T.transpose().mmul(T).get(0,0))):a=_;if(o){let k=r.transpose().mmul(_).div(_.transpose().mmul(_).get(0,0));k=k.div(k.norm());let O=r.clone().sub(_.clone().mmul(k.transpose())),U=a.transpose().mmul(_).div(_.transpose().mmul(_).get(0,0)),G=o.clone().sub(_.clone().mulS(U.get(0,0)).mmul(T.transpose()));this.t=_,this.p=k.transpose(),this.w=C.transpose(),this.q=T,this.u=a,this.s=_.transpose().mmul(_),this.xResidual=O,this.yResidual=G,this.betas=U}else this.w=C.transpose(),this.s=_.transpose().mmul(_).sqrt(),s?this.t=_.clone().div(this.s.get(0,0)):this.t=_,this.xResidual=r.sub(_.mmul(C.transpose()))}}const src$1=Object.freeze(Object.defineProperty({__proto__:null,AbstractMatrix,CHO:CholeskyDecomposition,CholeskyDecomposition,EVD:EigenvalueDecomposition,EigenvalueDecomposition,LU:LuDecomposition,LuDecomposition,Matrix:Matrix$2,MatrixColumnSelectionView,MatrixColumnView,MatrixFlipColumnView,MatrixFlipRowView,MatrixRowSelectionView,MatrixRowView,MatrixSelectionView,MatrixSubView,MatrixTransposeView:MatrixTransposeView$1,NIPALS:nipals,Nipals:nipals,QR:QrDecomposition,QrDecomposition,SVD:SingularValueDecomposition,SingularValueDecomposition,WrapperMatrix1D,WrapperMatrix2D,correlation,covariance,default:Matrix$2,determinant,inverse,linearDependencies,pseudoInverse,solve,wrap},Symbol.toStringTag,{value:"Module"}));function getSeparatedKernel(e){const r=new SingularValueDecomposition(e,{autoTranspose:!0});if(r.rank!==1)return null;const t=Math.sqrt(r.s[0]),o=r.U.to2DArray().map(d=>d[0]*t),s=r.V.to2DArray().map(d=>d[0]*t);return[o,s]}function convolution(e,r={}){let{channels:t,bitDepth:o,normalize:s=!1,divisor:d=1,border:g="copy",algorithm:a="auto"}=r,b={};o&&(b.bitDepth=o);let _=Image.createFrom(this,b);if(t=validateArrayOfChannels(this,t),a!=="separable")({kernel:e}=validateKernel(e));else if(!Array.isArray(e)||e.length!==2)throw new RangeError("separable convolution requires two arrays of numbers to represent the kernel");if(a==="auto"){let Z=getSeparatedKernel(e);Z!==null?(a="separable",e=Z):(e.length>9||e[0].length>9)&&this.width<=4096&&this.height<=4096?a="fft":a="direct"}let T,C;a==="separable"?(T=Math.floor(e[0].length/2),C=Math.floor(e[1].length/2)):(T=Math.floor(e.length/2),C=Math.floor(e[0].length/2));let D=_.isClamped,k=new Array(this.height*this.width),O,U,G,j,te,H;for(j=0;j<t.length;j++){for(te=t[j],G=0;G<this.height;G++)for(U=0;U<this.width;U++)O=G*this.width+U,k[O]=this.data[O*this.channels+te];if(a==="direct")H=src$2.direct(k,e,{rows:this.height,cols:this.width,normalize:s,divisor:d});else if(a==="separable"){if(H=convolutionSeparable(k,e,this.width,this.height),s){d=0;for(let Z=0;Z<e[0].length;Z++)for(let W=0;W<e[1].length;W++)d+=e[0][Z]*e[1][W]}if(d!==1)for(let Z=0;Z<H.length;Z++)H[Z]/=d}else H=src$2.fft(k,e,{rows:this.height,cols:this.width,normalize:s,divisor:d});for(G=0;G<this.height;G++)for(U=0;U<this.width;U++)O=G*this.width+U,D?_.data[O*this.channels+te]=clamp(H[O],_):_.data[O*this.channels+te]=H[O]}if(this.alpha&&!t.includes(this.channels))for(U=this.components;U<this.data.length;U=U+this.channels)_.data[U]=this.data[U];return g!=="periodic"&&_.setBorder({size:[C,T],algorithm:g}),_}function gradientFilter(e={}){let{direction:r="xy",border:t="copy",kernelX:o,kernelY:s,channels:d,bitDepth:g=this.bitDepth}=e;switch(this.checkProcessable("gradientFilter",{bitDepth:[8,16]}),r){case"x":if(!o)throw new Error("kernelX option is missing");return convolution.call(this,o,{channels:d,border:t,bitDepth:g});case"y":if(!s)throw new Error("kernelY option is missing");return convolution.call(this,s,{channels:d,border:t,bitDepth:g});case"xy":{if(!o)throw new Error("kernelX option is missing");if(!s)throw new Error("kernelY option is missing");const a=convolution.call(this,o,{channels:d,border:t,bitDepth:32}),b=convolution.call(this,s,{channels:d,border:t,bitDepth:32});return a.hypotenuse(b,{bitDepth:g,channels:d})}default:throw new Error(`Unknown parameter direction: ${r}`)}}function sobelFilter(e){return gradientFilter.call(this,Object.assign({},e,{kernelX:SOBEL_X,kernelY:SOBEL_Y}))}function scharrFilter(e){return gradientFilter.call(this,Object.assign({},e,{kernelX:SCHARR_X,kernelY:SCHARR_Y}))}var newArray_1=newArray;function newArray(e,r){e=e||0;for(var t=new Array(e),o=0;o<e;o++)t[o]=r;return t}const newArray$1=getDefaultExportFromCjs(newArray_1);function level(e={}){let{algorithm:r="range",channels:t,min:o=this.min,max:s=this.max}=e;switch(this.checkProcessable("level",{bitDepth:[8,16,32]}),t=validateArrayOfChannels(this,{channels:t}),t.length!==this.channel&&(Array.isArray(o)&&o.length===this.channels&&(o=o.filter((d,g)=>t.includes(g))),Array.isArray(s)&&s.length===this.channels&&(s=s.filter((d,g)=>t.includes(g)))),r){case"range":o<0&&(o=0),s>this.maxValue&&(s=this.maxValue),Array.isArray(o)||(o=newArray$1(t.length,o)),Array.isArray(s)||(s=newArray$1(t.length,s)),processImage(this,o,s,t);break;default:throw new Error(`level: algorithm not implement: ${r}`)}return this}function processImage(e,r,t,o){let s=1e-5,d=new Array(o.length);for(let g=0;g<o.length;g++)r[g]===0&&t[g]===e.maxValue||t[g]===r[g]?d[g]=0:d[g]=(e.maxValue+1-s)/(t[g]-r[g]),r[g]+=(.5-s/2)/d[g];for(let g=0;g<o.length;g++){let a=o[g];if(d[g]!==0)for(let b=0;b<e.data.length;b+=e.channels)e.data[b+a]=Math.min(Math.max(0,(e.data[b+a]-r[g])*d[g]+.5|0),e.maxValue)}}var toString$1=Object.prototype.toString,isArrayType=function e(r){return toString$1.call(r).substr(-6,5)==="Array"};const isArray=getDefaultExportFromCjs(isArrayType);function checkNumberArray(e){if(isNaN(e)){if(e instanceof Image)return e.data;if(!isArray(e))throw new Error("checkNumberArray: the value should be either a number, array or Image");return e}else{if(e<=0)throw new Error("checkNumberArray: the value must be greater than 0");return e}}function add(e,r={}){let{channels:t}=r;if(this.checkProcessable("add",{bitDepth:[8,16]}),t=validateArrayOfChannels(this,{channels:t}),e=checkNumberArray(e),isNaN(e)){if(this.data.length!==e.length)throw new Error("add: the data size is different");for(let o=0;o<t.length;o++){let s=t[o];for(let d=0;d<this.data.length;d+=this.channels)this.data[d+s]=Math.max(0,Math.min(this.maxValue,this.data[d+s]+e[d+s]>>0))}}else for(let o=0;o<t.length;o++){let s=t[o];for(let d=0;d<this.data.length;d+=this.channels)this.data[d+s]=Math.min(this.maxValue,this.data[d+s]+e>>0)}return this}function subtract(e,r={}){let{channels:t}=r;if(this.checkProcessable("subtract",{bitDepth:[8,16]}),t=validateArrayOfChannels(this,{channels:t}),e=checkNumberArray(e),isNaN(e)){if(this.data.length!==e.length)throw new Error("subtract: the data size is different");for(let o=0;o<t.length;o++){let s=t[o];for(let d=0;d<this.data.length;d+=this.channels)this.data[d+s]=Math.max(0,Math.min(this.maxValue,this.data[d+s]-e[d+s]>>0))}}else for(let o=0;o<t.length;o++){let s=t[o];for(let d=0;d<this.data.length;d+=this.channels)this.data[d+s]=Math.max(0,this.data[d+s]-e>>0)}return this}function subtractImage(e,r={}){let{channels:t,absolute:o=!1}=r;if(this.checkProcessable("subtractImage",{bitDepth:[8,16]}),this.width!==e.width||this.height!==e.height)throw new Error("subtractImage: both images must have the same size");if(this.alpha!==e.alpha||this.bitDepth!==e.bitDepth)throw new Error("subtractImage: both images must have the same alpha and bitDepth");if(this.channels!==e.channels)throw new Error("subtractImage: both images must have the same number of channels");let s=this.clone();t=validateArrayOfChannels(this,{channels:t});for(let d=0;d<t.length;d++){let g=t[d];for(let a=g;a<this.data.length;a+=this.channels){let b=this.data[a]-e.data[a];o?s.data[a]=Math.abs(b):s.data[a]=Math.max(b,0)}}return s}function hypotenuse(e,r={}){let{bitDepth:t=this.bitDepth,channels:o}=r;if(this.checkProcessable("hypotenuse",{bitDepth:[8,16,32]}),this.width!==e.width||this.height!==e.height)throw new Error("hypotenuse: both images must have the same size");if(this.alpha!==e.alpha||this.bitDepth!==e.bitDepth)throw new Error("hypotenuse: both images must have the same alpha and bitDepth");if(this.channels!==e.channels)throw new Error("hypotenuse: both images must have the same number of channels");let s=Image.createFrom(this,{bitDepth:t});o=validateArrayOfChannels(this,{channels:o});let d=s.isClamped;for(let g=0;g<o.length;g++){let a=o[g];for(let b=a;b<this.data.length;b+=this.channels){let _=Math.hypot(this.data[b],e.data[b]);d?s.data[b]=Math.min(Math.max(Math.round(_),0),s.maxValue):s.data[b]=_}}return s}function multiply(e,r={}){let{channels:t}=r;if(this.checkProcessable("multiply",{bitDepth:[8,16]}),e<=0)throw new Error("multiply: the value must be greater than 0");if(t=validateArrayOfChannels(this,{channels:t}),e=checkNumberArray(e),isNaN(e)){if(this.data.length!==e.length)throw new Error("multiply: the data size is different");for(let o=0;o<t.length;o++){let s=t[o];for(let d=0;d<this.data.length;d+=this.channels)this.data[d+s]=Math.max(0,Math.min(this.maxValue,this.data[d+s]*e[d+s]>>0))}}else for(let o=0;o<t.length;o++){let s=t[o];for(let d=0;d<this.data.length;d+=this.channels)this.data[d+s]=Math.min(this.maxValue,this.data[d+s]*e>>0)}return this}function divide(e,r={}){let{channels:t}=r;if(this.checkProcessable("divide",{bitDepth:[8,16]}),t=validateArrayOfChannels(this,{channels:t}),e=checkNumberArray(e),isNaN(e)){if(this.data.length!==e.length)throw new Error("divide: the: the data size is different");for(let o=0;o<t.length;o++){let s=t[o];for(let d=0;d<this.data.length;d+=this.channels)this.data[d+s]=Math.max(0,Math.min(this.maxValue,this.data[d+s]/e[d+s]>>0))}}else for(let o=0;o<t.length;o++){let s=t[o];for(let d=0;d<this.data.length;d+=this.channels)this.data[d+s]=Math.min(this.maxValue,this.data[d+s]/e>>0)}return this}class BaseRegression{constructor(){if(new.target===BaseRegression)throw new Error("BaseRegression must be subclassed")}predict(r){if(typeof r=="number")return this._predict(r);if(isAnyArray(r)){const t=[];for(let o=0;o<r.length;o++)t.push(this._predict(r[o]));return t}else throw new TypeError("x must be a number or array")}_predict(){throw new Error("_predict must be implemented")}train(){}toString(){return""}toLaTeX(){return""}score(r,t){if(!isAnyArray(r)||!isAnyArray(t)||r.length!==t.length)throw new Error("x and y must be arrays of the same length");const o=r.length,s=new Array(o);for(let k=0;k<o;k++)s[k]=this._predict(r[k]);let d=0,g=0,a=0,b=0,_=0,T=0,C=0;for(let k=0;k<o;k++)d+=s[k],g+=t[k],_+=s[k]*s[k],T+=t[k]*t[k],C+=s[k]*t[k],t[k]!==0&&(a+=(t[k]-s[k])*(t[k]-s[k])/t[k]),b+=(t[k]-s[k])*(t[k]-s[k]);const D=(o*C-d*g)/Math.sqrt((o*_-d*d)*(o*T-g*g));return{r:D,r2:D*D,chi2:a,rmsd:Math.sqrt(b/o)}}}const require$$0$2=getAugmentedNamespace(src$1);function squaredEuclidean$4(e,r){let t=0;for(let o=0;o<e.length;o++)t+=(e[o]-r[o])*(e[o]-r[o]);return t}function euclidean$2(e,r){return Math.sqrt(squaredEuclidean$4(e,r))}const euclidean$3=Object.freeze(Object.defineProperty({__proto__:null,euclidean:euclidean$2,squaredEuclidean:squaredEuclidean$4},Symbol.toStringTag,{value:"Module"})),require$$0$1=getAugmentedNamespace(euclidean$3),{squaredEuclidean:squaredEuclidean$3}=require$$0$1,defaultOptions$b={sigma:1};let GaussianKernel$1=class{constructor(r){r=Object.assign({},defaultOptions$b,r),this.sigma=r.sigma,this.divisor=2*r.sigma*r.sigma}compute(r,t){const o=squaredEuclidean$3(r,t);return Math.exp(-o/this.divisor)}};var gaussianKernel=GaussianKernel$1;const defaultOptions$a={degree:1,constant:1,scale:1};let PolynomialKernel$1=class{constructor(r){r=Object.assign({},defaultOptions$a,r),this.degree=r.degree,this.constant=r.constant,this.scale=r.scale}compute(r,t){for(var o=0,s=0;s<r.length;s++)o+=r[s]*t[s];return Math.pow(this.scale*o+this.constant,this.degree)}};var polynomialKernel=PolynomialKernel$1;const defaultOptions$9={alpha:.01,constant:-Math.E};let SigmoidKernel$1=class{constructor(r){r=Object.assign({},defaultOptions$9,r),this.alpha=r.alpha,this.constant=r.constant}compute(r,t){for(var o=0,s=0;s<r.length;s++)o+=r[s]*t[s];return Math.tanh(this.alpha*o+this.constant)}};var sigmoidKernel=SigmoidKernel$1;const defaultOptions$8={sigma:1,degree:1};let ANOVAKernel$1=class{constructor(r){r=Object.assign({},defaultOptions$8,r),this.sigma=r.sigma,this.degree=r.degree}compute(r,t){for(var o=0,s=Math.min(r.length,t.length),d=1;d<=s;++d)o+=Math.pow(Math.exp(-this.sigma*Math.pow(Math.pow(r[d-1],d)-Math.pow(t[d-1],d),2)),this.degree);return o}};var anovaKernel=ANOVAKernel$1;const{squaredEuclidean:squaredEuclidean$2}=require$$0$1,defaultOptions$7={sigma:1};let CauchyKernel$1=class{constructor(r){r=Object.assign({},defaultOptions$7,r),this.sigma=r.sigma}compute(r,t){return 1/(1+squaredEuclidean$2(r,t)/(this.sigma*this.sigma))}};var cauchyKernel=CauchyKernel$1;const{euclidean:euclidean$1}=require$$0$1,defaultOptions$6={sigma:1};let ExponentialKernel$1=class{constructor(r){r=Object.assign({},defaultOptions$6,r),this.sigma=r.sigma,this.divisor=2*r.sigma*r.sigma}compute(r,t){const o=euclidean$1(r,t);return Math.exp(-o/this.divisor)}};var exponentialKernel=ExponentialKernel$1;class HistogramIntersectionKernel{compute(r,t){for(var o=Math.min(r.length,t.length),s=0,d=0;d<o;++d)s+=Math.min(r[d],t[d]);return s}}var histogramIntersectionKernel=HistogramIntersectionKernel;const{euclidean}=require$$0$1,defaultOptions$5={sigma:1};let LaplacianKernel$1=class{constructor(r){r=Object.assign({},defaultOptions$5,r),this.sigma=r.sigma}compute(r,t){const o=euclidean(r,t);return Math.exp(-o/this.sigma)}};var laplacianKernel=LaplacianKernel$1;const{squaredEuclidean:squaredEuclidean$1}=require$$0$1,defaultOptions$4={constant:1};let MultiquadraticKernel$1=class{constructor(r){r=Object.assign({},defaultOptions$4,r),this.constant=r.constant}compute(r,t){return Math.sqrt(squaredEuclidean$1(r,t)+this.constant*this.constant)}};var multiquadraticKernel=MultiquadraticKernel$1;const{squaredEuclidean}=require$$0$1,defaultOptions$3={constant:1};class RationalQuadraticKernel{constructor(r){r=Object.assign({},defaultOptions$3,r),this.constant=r.constant}compute(r,t){const o=squaredEuclidean(r,t);return 1-o/(o+this.constant)}}var rationalQuadraticKernel=RationalQuadraticKernel;const{Matrix:Matrix$1,MatrixTransposeView}=require$$0$2,GaussianKernel=gaussianKernel,PolynomialKernel=polynomialKernel,SigmoidKernel=sigmoidKernel,ANOVAKernel=anovaKernel,CauchyKernel=cauchyKernel,ExponentialKernel=exponentialKernel,HistogramKernel=histogramIntersectionKernel,LaplacianKernel=laplacianKernel,MultiquadraticKernel=multiquadraticKernel,RationalKernel=rationalQuadraticKernel,kernelType={gaussian:GaussianKernel,rbf:GaussianKernel,polynomial:PolynomialKernel,poly:PolynomialKernel,anova:ANOVAKernel,cauchy:CauchyKernel,exponential:ExponentialKernel,histogram:HistogramKernel,min:HistogramKernel,laplacian:LaplacianKernel,multiquadratic:MultiquadraticKernel,rational:RationalKernel,sigmoid:SigmoidKernel,mlp:SigmoidKernel};class Kernel{constructor(r,t){if(this.kernelType=r,r!=="linear")if(typeof r=="string"){r=r.toLowerCase();var o=kernelType[r];if(o)this.kernelFunction=new o(t);else throw new Error(`unsupported kernel type: ${r}`)}else if(typeof r=="object"&&typeof r.compute=="function")this.kernelFunction=r;else throw new TypeError("first argument must be a valid kernel type or instance")}compute(r,t){if(r=Matrix$1.checkMatrix(r),t===void 0?t=r:t=Matrix$1.checkMatrix(t),this.kernelType==="linear")return r.mmul(new MatrixTransposeView(t));const o=new Matrix$1(r.rows,t.rows);if(r===t)for(let s=0;s<r.rows;s++)for(let d=s;d<r.rows;d++){const g=this.kernelFunction.compute(r.getRow(s),r.getRow(d));o.set(s,d,g),o.set(d,s,g)}else for(let s=0;s<r.rows;s++)for(let d=0;d<t.rows;d++)o.set(s,d,this.kernelFunction.compute(r.getRow(s),t.getRow(d)));return o}}var kernel=Kernel;const Kernel$1=getDefaultExportFromCjs(kernel),defaultOptions$2={lambda:.1,kernelType:"gaussian",kernelOptions:{},computeCoefficient:!1};class KernelRidgeRegression extends BaseRegression{constructor(r,t,o){if(super(),r===!0)this.alpha=t.alpha,this.inputs=t.inputs,this.kernelType=t.kernelType,this.kernelOptions=t.kernelOptions,this.kernel=new Kernel$1(t.kernelType,t.kernelOptions);else{r=Matrix$2.checkMatrix(r),o=Object.assign({},defaultOptions$2,o);const s=new Kernel$1(o.kernelType,o.kernelOptions),d=s.compute(r),g=r.rows;d.add(Matrix$2.eye(g,g).mul(o.lambda)),this.alpha=solve(d,t),this.inputs=r,this.kernelType=o.kernelType,this.kernelOptions=o.kernelOptions,this.kernel=s}}_predict(r){return this.kernel.compute([r],this.inputs).mmul(this.alpha).getRow(0)}toJSON(){return{name:"kernelRidgeRegression",alpha:this.alpha,inputs:this.inputs,kernelType:this.kernelType,kernelOptions:this.kernelOptions}}static load(r){if(r.name!=="kernelRidgeRegression")throw new TypeError("not a KRR model");return new KernelRidgeRegression(!0,r)}}function background$1(e,r,t){const o=new KernelRidgeRegression(e,r,t),s=new Array(this.size);for(let a=0;a<this.width;a++)for(let b=0;b<this.height;b++)s[b*this.width+a]=[a,b];const d=o.predict(s),g=Image.createFrom(this);for(let a=0;a<this.size;a++)g.data[a]=Math.min(this.maxValue,Math.max(0,d[a][0]));return g}function dilate(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:t=1}=e;if(this.checkProcessable("dilate",{bitDepth:[1,8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("dilate: The number of rows and columns of the kernel must be odd");let o=!0;e:for(const d of r)for(const g of d)if(g!==1){o=!1;break e}let s=this;for(let d=0;d<t;d++)if(this.bitDepth===1)if(o){const g=s.clone();s=dilateOnceBinaryOnlyOnes(s,g,r.length,r[0].length)}else{const g=Image.createFrom(s);s=dilateOnceBinary(s,g,r)}else if(o){const g=Image.createFrom(s);s=dilateOnceGreyOnlyOnes(s,g,r.length,r[0].length)}else{const g=Image.createFrom(s);s=dilateOnceGrey(s,g,r)}return s}function dilateOnceGrey(e,r,t){const o=t.length,s=t[0].length;let d=(o-1)/2,g=(s-1)/2;for(let a=0;a<e.height;a++)for(let b=0;b<e.width;b++){let _=0;for(let T=0;T<s;T++)for(let C=0;C<o;C++){if(t[C][T]!==1)continue;let D=C-d+b,k=T-g+a;if(D<0||k<0||D>=e.width||k>=e.height)continue;const O=e.getValueXY(D,k,0);O>_&&(_=O)}r.setValueXY(b,a,0,_)}return r}function dilateOnceGreyOnlyOnes(e,r,t,o){const s=(t-1)/2,d=(o-1)/2,g=[];for(let a=0;a<e.width;a++)g.push(0);for(let a=0;a<e.height;a++){for(let b=0;b<e.width;b++){let _=0;for(let T=Math.max(0,a-d);T<Math.min(e.height,a+d+1);T++){const C=e.getValueXY(b,T,0);C>_&&(_=C)}g[b]=_}for(let b=0;b<e.width;b++){let _=0;for(let T=Math.max(0,b-s);T<Math.min(e.width,b+s+1);T++)g[T]>_&&(_=g[T]);r.setValueXY(b,a,0,_)}}return r}function dilateOnceBinary(e,r,t){const o=t.length,s=t[0].length;let d=(o-1)/2,g=(s-1)/2;for(let a=0;a<e.height;a++)for(let b=0;b<e.width;b++){let _=0;e:for(let T=0;T<s;T++)for(let C=0;C<o;C++){if(t[C][T]!==1)continue;let D=C-d+b,k=T-g+a;if(k<0||D<0||D>=e.width||k>=e.height)continue;if(e.getBitXY(D,k)===1){_=1;break e}}_===1&&r.setBitXY(b,a)}return r}function dilateOnceBinaryOnlyOnes(e,r,t,o){const s=(t-1)/2,d=(o-1)/2,g=[];for(let a=0;a<e.width;a++)g.push(1);for(let a=0;a<e.height;a++){for(let b=0;b<e.width;b++){g[b]=0;for(let _=Math.max(0,a-d);_<Math.min(e.height,a+d+1);_++)if(e.getBitXY(b,_)===1){g[b]=1;break}}for(let b=0;b<e.width;b++)if(r.getBitXY(b,a)!==1){for(let _=Math.max(0,b-s);_<Math.min(e.width,b+s+1);_++)if(g[_]===1){r.setBitXY(b,a);break}}}return r}function erode(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:t=1}=e;if(this.checkProcessable("erode",{bitDepth:[1,8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("erode: The number of rows and columns of the kernel must be odd");let o=!0;e:for(const d of r)for(const g of d)if(g!==1){o=!1;break e}let s=this;for(let d=0;d<t;d++)if(this.bitDepth===1)if(o){const g=s.clone();s=erodeOnceBinaryOnlyOnes(s,g,r.length,r[0].length)}else{const g=Image.createFrom(s);s=erodeOnceBinary(s,g,r)}else if(o){const g=Image.createFrom(s);s=erodeOnceGreyOnlyOnes(s,g,r.length,r[0].length)}else{const g=Image.createFrom(s);s=erodeOnceGrey(s,g,r)}return s}function erodeOnceGrey(e,r,t){const o=t.length,s=t[0].length;let d=(o-1)/2,g=(s-1)/2;for(let a=0;a<e.height;a++)for(let b=0;b<e.width;b++){let _=e.maxValue;for(let T=0;T<s;T++)for(let C=0;C<o;C++){if(t[C][T]!==1)continue;let D=C-d+b,k=T-g+a;if(D<0||k<0||D>=e.width||k>=e.height)continue;const O=e.getValueXY(D,k,0);O<_&&(_=O)}r.setValueXY(b,a,0,_)}return r}function erodeOnceGreyOnlyOnes(e,r,t,o){const s=(t-1)/2,d=(o-1)/2,g=[];for(let a=0;a<e.width;a++)g.push(0);for(let a=0;a<e.height;a++){for(let b=0;b<e.width;b++){let _=e.maxValue;for(let T=Math.max(0,a-d);T<Math.min(e.height,a+d+1);T++){const C=e.getValueXY(b,T,0);C<_&&(_=C)}g[b]=_}for(let b=0;b<e.width;b++){let _=e.maxValue;for(let T=Math.max(0,b-s);T<Math.min(e.width,b+s+1);T++)g[T]<_&&(_=g[T]);r.setValueXY(b,a,0,_)}}return r}function erodeOnceBinary(e,r,t){const o=t.length,s=t[0].length;let d=(o-1)/2,g=(s-1)/2;for(let a=0;a<e.height;a++)for(let b=0;b<e.width;b++){let _=1;e:for(let T=0;T<s;T++)for(let C=0;C<o;C++){if(t[C][T]!==1)continue;let D=C-d+b,k=T-g+a;if(k<0||D<0||D>=e.width||k>=e.height)continue;if(e.getBitXY(D,k)===0){_=0;break e}}_===1&&r.setBitXY(b,a)}return r}function erodeOnceBinaryOnlyOnes(e,r,t,o){const s=(t-1)/2,d=(o-1)/2,g=[];for(let a=0;a<e.width;a++)g.push(0);for(let a=0;a<e.height;a++){for(let b=0;b<e.width;b++){g[b]=1;for(let _=Math.max(0,a-d);_<Math.min(e.height,a+d+1);_++)if(e.getBitXY(b,_)===0){g[b]=0;break}}for(let b=0;b<e.width;b++)if(r.getBitXY(b,a)!==0){for(let _=Math.max(0,b-s);_<Math.min(e.width,b+s+1);_++)if(g[_]===0){r.clearBitXY(b,a);break}}}return r}function open(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:t=1}=e;if(this.checkProcessable("open",{bitDepth:[8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("open: The number of rows and columns of the kernel must be odd");let o=this;for(let s=0;s<t;s++)o=o.erode({kernel:r}),o=o.dilate({kernel:r});return o}function close(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:t=1}=e;if(this.checkProcessable("close",{bitDepth:[1,8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("close: The number of rows and columns of the kernel must be odd");let o=this;for(let s=0;s<t;s++)o=o.dilate({kernel:r}).erode({kernel:r});return o}function topHat(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:t=1}=e;if(this.checkProcessable("topHat",{bitDepth:[8,16],components:1,alpha:0}),r.length%2===0||r[0].length%2===0)throw new TypeError("topHat: The number of rows and columns of the kernel must be odd");let o=this;for(let s=0;s<t;s++)o=o.open({kernel:r}).subtractImage(o,{absolute:!0});return o}function blackHat(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:t=1}=e;if(this.checkProcessable("blackHat",{bitDepth:[8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("blackHat: The number of rows and columns of the kernel must be odd");let o=this;for(let s=0;s<t;s++)o=o.close({kernel:r}).subtractImage(o,{absolute:!0});return o}function morphologicalGradient(e={}){let{kernel:r=[[1,1,1],[1,1,1],[1,1,1]],iterations:t=1}=e;if(this.checkProcessable("morphologicalGradient",{bitDepth:[8,16],components:1,alpha:0}),r.columns%2===0||r.rows%2===0)throw new TypeError("morphologicalGradient: The number of rows and columns of the kernel must be odd");let o=this;for(let s=0;s<t;s++){let d=o.dilate({kernel:r}),g=o.erode({kernel:r});o=d.subtractImage(g,{absolute:!0})}return o}function order4Points(e){let r=0,t=0,o=0,s=0,d=e[0][0],g=0;for(let _=1;_<e.length;_++)e[_][0]<d&&(d=e[_][0],g=_);let a=e[(g+1)%e.length][0],b=(g+1)%e.length;for(let _=1;_<e.length;_++)e[_][0]<a&&_!==g&&(a=e[_][0],b=_);return e[b][1]<e[g][1]?(r=e[b],s=e[g],g!==(b+1)%4?(t=e[(b+1)%4],o=e[(b+2)%4]):(t=e[(b+2)%4],o=e[(b+3)%4])):(s=e[b],r=e[g],b!==(g+1)%4?(t=e[(g+1)%4],o=e[(g+2)%4]):(t=e[(g+2)%4],o=e[(g+3)%4])),[r,t,o,s]}function distance2Points(e,r){return Math.sqrt(Math.pow(e[0]-r[0],2)+Math.pow(e[1]-r[1],2))}function crossVect(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]}function dotVect(e,r){return e[0]*r[0]+e[1]*r[1]+e[2]*r[2]}function computeWidthAndHeigth(e,r,t,o,s,d){let g=Math.max(distance2Points(e,r),distance2Points(o,t)),a=Math.max(distance2Points(e,o),distance2Points(r,t)),b=0,_=0,T=Math.ceil(s/2),C=Math.ceil(d/2),D=g/a,k=[e[0],e[1],1],O=[r[0],r[1],1],U=[o[0],o[1],1],G=[t[0],t[1],1],j=dotVect(crossVect(k,G),U)/dotVect(crossVect(O,G),U),te=dotVect(crossVect(k,G),O)/dotVect(crossVect(U,G),O),H=[j*O[0]-k[0],j*O[1]-k[1],j*O[2]-k[2]],Z=[te*U[0]-k[0],te*U[1]-k[1],te*U[2]-k[2]],W=H[0],_e=H[1],fe=H[2],re=Z[0],ae=Z[1],J=Z[2],se=1/(fe*J)*(W*re-(W*J+fe*re)*T+fe*J*T*T+(_e*ae-(_e*J+fe*ae)*C+fe*J*C*C));se>=0?se=Math.sqrt(se):se=Math.sqrt(-se);let Me=new Matrix$2([[se,0,T],[0,se,C],[0,0,1]]),Ie=Me.transpose(),We=inverse(Ie),Ge=inverse(Me),qt=Matrix$2.rowVector(H),ti=Matrix$2.rowVector(Z),Ut=Math.sqrt(dotVect(qt.mmul(We).mmul(Ge).to1DArray(),H)/dotVect(ti.mmul(We).mmul(Ge).to1DArray(),Z));return Ut===0||D===0?(b=Math.ceil(g),_=Math.ceil(a)):Ut<D?(b=Math.ceil(g),_=Math.ceil(b/Ut)):(_=Math.ceil(a),b=Math.ceil(Ut*_)),[b,_]}function projectionPoint(e,r,t,o,s,d,g,a,b,_,T,C){let[D,k]=[(t*e+o*r+s)/(b*e+_*r+1),(d*e+g*r+a)/(b*e+_*r+1)];return T.getValueXY(Math.floor(D),Math.floor(k),C)}function warpingFourPoints(e,r={}){let{calculateRatio:t=!0}=r;if(e.length!==4)throw new Error(`The array pts must have four elements, which are the four corners. Currently, pts have ${e.length} elements`);let[o,s,d,g]=e,a=[o,s,d,g],[b,_,T,C]=order4Points(a),D,k;t?[D,k]=computeWidthAndHeigth(b,_,T,C,this.width,this.height):(D=Math.ceil(Math.max(distance2Points(b,_),distance2Points(C,T))),k=Math.ceil(Math.max(distance2Points(b,C),distance2Points(_,T))));let O=Image.createFrom(this,{width:D,height:k}),[U,G]=b,[j,te]=_,[H,Z]=T,[W,_e]=C,[fe,re]=[0,0],[ae,J]=[0,D-1],[se,Me]=[k-1,D-1],[Ie,We]=[k-1,0],Ge=new Matrix$2([[fe,re,1,0,0,0,-fe*U,-re*U],[ae,J,1,0,0,0,-ae*j,-J*j],[se,Me,1,0,0,0,-se*H,-re*H],[Ie,We,1,0,0,0,-Ie*W,-We*W],[0,0,0,fe,re,1,-fe*G,-re*G],[0,0,0,ae,J,1,-ae*te,-J*te],[0,0,0,se,Me,1,-se*Z,-Me*Z],[0,0,0,Ie,We,1,-Ie*_e,-We*_e]]),qt=Matrix$2.columnVector([U,j,H,W,G,te,Z,_e]),Ut=new SingularValueDecomposition(Ge).solve(qt),[Qt,tt,nt,Mt,ht,xt,It,Et]=Ut.to1DArray(),yt=new Matrix$2(k,D);for(let Bt=0;Bt<this.channels;Bt++){for(let _t=0;_t<k;_t++)for(let si=0;si<D;si++)yt.set(_t,si,projectionPoint(_t,si,Qt,tt,nt,Mt,ht,xt,It,Et,this,Bt));O.setMatrix(yt,{channel:Bt})}return O}function crop(e={}){let{x:r=0,y:t=0,width:o=this.width-r,height:s=this.height-t}=e;if(this.checkProcessable("crop",{bitDepth:[1,8,16]}),r=Math.round(r),t=Math.round(t),o=Math.round(o),s=Math.round(s),r>this.width-1||t>this.height-1)throw new RangeError(`crop: origin (x:${r}, y:${t}) out of range (${this.width-1}; ${this.height-1})`);if(o<=0||s<=0)throw new RangeError(`crop: width and height (width:${o}; height:${s}) must be positive numbers`);if(r<0||t<0)throw new RangeError(`crop: x and y (x:${r}, y:${t}) must be positive numbers`);if(o>this.width-r||s>this.height-t)throw new RangeError(`crop: (x: ${r}, y:${t}, width:${o}, height:${s}) size is out of range`);let d=this;if(this.bitDepth===1){const g=new Image(o,s,{kind:"BINARY",parent:this});d=cropBinary(this,g,r,t,o,s)}else{const g=Image.createFrom(this,{width:o,height:s,position:[r,t]});d=cropDefault(this,g,r,t,o,s)}return d}function cropDefault(e,r,t,o,s,d){let g=s*e.channels,a=o+d,b=0,_=t*e.channels;for(let T=o;T<a;T++){let C=T*e.width*e.channels+_,D=C+g;for(;C<D;C++)r.data[b++]=e.data[C]}return r}function cropBinary(e,r,t,o,s,d){let g=s*e.channels,a=o+d,b=0,_=t*e.channels;for(let T=o;T<a;T++){let C=T*e.width*e.channels+_,D=C+g;for(;C<D;C++)e.getBit(C)&&r.setBit(b),++b}return r}function cropAlpha(e={}){this.checkProcessable("cropAlpha",{alpha:1});const{threshold:r=this.maxValue}=e;let t=findLeft(this,r,this.components);if(t===-1)throw new Error("Could not find new dimensions. Threshold may be too high.");let o=findTop(this,r,this.components,t),s=findBottom(this,r,this.components,t),d=findRight(this,r,this.components,t,o,s);return this.crop({x:t,y:o,width:d-t+1,height:s-o+1})}function findLeft(e,r,t){for(let o=0;o<e.width;o++)for(let s=0;s<e.height;s++)if(e.getValueXY(o,s,t)>=r)return o;return-1}function findTop(e,r,t,o){for(let s=0;s<e.height;s++)for(let d=o;d<e.width;d++)if(e.getValueXY(d,s,t)>=r)return s;return-1}function findBottom(e,r,t,o){for(let s=e.height-1;s>=0;s--)for(let d=o;d<e.width;d++)if(e.getValueXY(d,s,t)>=r)return s;return-1}function findRight(e,r,t,o,s,d){for(let g=e.width-1;g>=o;g--)for(let a=s;a<=d;a++)if(e.getValueXY(g,a,t)>=r)return g;return-1}function getFactor(e){if(typeof e=="string"){const r=e[e.length-1];e=parseFloat(e),r==="%"&&(e/=100)}return e}function getThreshold$1(e,r){if(!r)throw Error("getThreshold : the maxValue should be specified");if(typeof e=="string"){if(e[e.length-1]!=="%")throw Error("getThreshold : if the value is a string it must finish by %");return parseFloat(e)/100*r}else{if(typeof e=="number")return e<1?e*r:e;throw Error("getThreshold : the value is not valid")}}function factorDimensions(e,r,t){e=getFactor(e);let o=Math.round(e*r),s=Math.round(e*t);return o<=0&&(o=1),s<=0&&(s=1),{width:o,height:s}}function checkRow(e,r){if(r<0||r>=e.height)throw new RangeError(`row must be included between 0 and ${e.height-1}. Current value: ${r}`)}function checkColumn(e,r){if(r<0||r>=e.width)throw new RangeError(`column must be included between 0 and ${e.width-1}. Current value: ${r}`)}function checkChannel(e,r){if(r<0||r>=e.channels)throw new RangeError(`channel must be included between 0 and ${e.channels-1}. Current value: ${r}`)}const validInterpolations={nearestneighbor:"nearestNeighbor",nearestneighbour:"nearestNeighbor",bilinear:"bilinear"};function checkInterpolation(e){if(typeof e!="string")throw new TypeError("interpolation must be a string");if(e=e.toLowerCase(),!validInterpolations[e])throw new RangeError(`invalid interpolation algorithm: ${e}`);return validInterpolations[e]}function nearestNeighbor(e,r,t){const o=this.width/r,s=this.height/t;if(this.bitDepth>1)for(let d=0;d<r;d++){const g=Math.floor((d+.5)*o);for(let a=0;a<t;a++){const b=Math.floor((a+.5)*s);for(let _=0;_<this.channels;_++)e.setValueXY(d,a,_,this.getValueXY(g,b,_))}}else for(let d=0;d<r;d++){const g=Math.floor((d+.5)*o);for(let a=0;a<t;a++){const b=Math.floor((a+.5)*s);this.getBitXY(g,b)&&e.setBitXY(d,a)}}}function resize(e={}){const{factor:r=1,interpolation:t=validInterpolations.nearestneighbor,preserveAspectRatio:o=!0}=e,s=checkInterpolation(t);let d=e.width,g=e.height;if(d||(g&&o?d=Math.round(g*(this.width/this.height)):d=this.width),g||(o?g=Math.round(d*(this.height/this.width)):g=this.height),{width:d,height:g}=factorDimensions(r,d,g),d===this.width&&g===this.height){const T=this.clone();return T.position=[0,0],T}let a=Math.round((this.width-d)/2),b=Math.round((this.height-g)/2);const _=Image.createFrom(this,{width:d,height:g,position:[a,b]});switch(s){case validInterpolations.nearestneighbor:nearestNeighbor.call(this,_,d,g);break;default:throw new Error(`unsupported resize interpolation: ${s}`)}return _}function hsv(){this.checkProcessable("hsv",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let e=Image.createFrom(this,{colorModel:HSV}),r=0,t=this.data;for(let o=0;o<t.length;o+=this.channels){let s=t[o],d=t[o+1],g=t[o+2],a=Math.min(s,d,g),b=Math.max(s,d,g),_=b-a,T=0,C=b===0?0:_/b,D=b;if(b!==a){switch(b){case s:T=(d-g)/_+(d<g?6:0);break;case d:T=(g-s)/_+2;break;case g:T=(s-d)/_+4;break;default:throw new Error("unreachable")}T/=6}e.data[r++]=T*this.maxValue,e.data[r++]=C*this.maxValue,e.data[r++]=D,this.alpha&&(e.data[r++]=t[o+3])}return e}function hsl$1(){this.checkProcessable("hsl",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let e=Image.createFrom(this,{colorModel:HSL}),r=Math.floor(this.maxValue/2),t=0,o=this.data;for(let s=0;s<o.length;s+=this.channels){let d=o[s],g=o[s+1],a=o[s+2],b=Math.max(d,g,a),_=Math.min(d,g,a),T=0,C=0,D=(b+_)/2;if(b!==_){let k=b-_;switch(C=D>r?k/(2-b-_):k/(b+_),b){case d:T=(g-a)/k+(g<a?6:0);break;case g:T=(a-d)/k+2;break;case a:T=(d-g)/k+4;break;default:throw new Error("unreachable")}T/=6}e.data[t++]=T*this.maxValue,e.data[t++]=C*this.maxValue,e.data[t++]=D,this.alpha&&(e.data[t++]=o[s+3])}return e}function cmyk(){this.checkProcessable("cmyk",{bitDepth:[8,16],alpha:[0,1],colorModel:[RGB$1]});let e=Image.createFrom(this,{components:4,colorModel:CMYK$1}),r=0,t=this.data;for(let o=0;o<t.length;o+=this.channels){let s=t[o],d=t[o+1],g=t[o+2],a=Math.min(this.maxValue-s,this.maxValue-d,this.maxValue-g),b=(this.maxValue-s-a)/(1-a/this.maxValue),_=(this.maxValue-d-a)/(1-a/this.maxValue),T=(this.maxValue-g-a)/(1-a/this.maxValue);e.data[r++]=Math.round(b),e.data[r++]=Math.round(_),e.data[r++]=Math.round(T),e.data[r++]=Math.round(a),this.alpha&&(e.data[r++]=t[o+3])}return e}function rgba8(){return new Image(this.width,this.height,this.getRGBAData(),{kind:"RGBA",parent:this})}const methods$1={luma709(e,r,t){return e*6966+r*23436+t*2366>>15},luma601(e,r,t){return e*9798+r*19235+t*3735>>15},maximum(e,r,t){return Math.max(e,r,t)},minimum(e,r,t){return Math.min(e,r,t)},average(e,r,t){return(e+r+t)/3>>0},minmax(e,r,t){return(Math.max(e,r,t)+Math.min(e,r,t))/2},red(e){return e},green(e,r){return r},blue(e,r,t){return t},cyan(e,r,t,o){let s=methods$1.black(e,r,t,o);return(o.maxValue-e-s)/(1-s/o.maxValue)>>0},magenta(e,r,t,o){let s=methods$1.black(e,r,t,o);return(o.maxValue-r-s)/(1-s/o.maxValue)>>0},yellow(e,r,t,o){let s=methods$1.black(e,r,t,o);return(o.maxValue-t-s)/(1-s/o.maxValue)>>0},black(e,r,t,o){return Math.min(o.maxValue-e,o.maxValue-r,o.maxValue-t)},hue(e,r,t,o){let s=methods$1.min(e,r,t),d=methods$1.max(e,r,t);if(d===s)return 0;let g=0,a=d-s;switch(d){case e:g=(r-t)/a+(r<t?6:0);break;case r:g=(t-e)/a+2;break;case t:g=(e-r)/a+4;break;default:throw new Error("unreachable")}return g/6*o.maxValue>>0},saturation(e,r,t,o){let s=methods$1.min(e,r,t),d=methods$1.max(e,r,t),g=d-s;return d===0?0:g/d*o.maxValue},lightness(e,r,t){let o=methods$1.min(e,r,t);return(methods$1.max(e,r,t)+o)/2}};Object.defineProperty(methods$1,"luminosity",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"luminance",{enumerable:!1,value:methods$1.lightness});Object.defineProperty(methods$1,"min",{enumerable:!1,value:methods$1.minimum});Object.defineProperty(methods$1,"max",{enumerable:!1,value:methods$1.maximum});Object.defineProperty(methods$1,"brightness",{enumerable:!1,value:methods$1.maximum});Object.keys(methods$1).forEach(e=>{});function grey(e={}){let{algorithm:r="luma709",keepAlpha:t=!1,mergeAlpha:o=!0}=e;if(typeof r!="string"&&typeof r!="function")throw new TypeError("algorithm must be a string or a function");this.checkProcessable("grey",{bitDepth:[8,16],alpha:[0,1]}),this.components===1&&(r="red"),t&=this.alpha,o&=this.alpha,t&&(o=!1);let s=getOutputImage(this,e,{components:1,alpha:t,colorModel:GREY$1}),d;if(typeof r=="function")d=r;else if(d=methods$1[r.toLowerCase()],!d)throw new Error(`unsupported grey algorithm: ${r}`);let g=0;for(let a=0;a<this.data.length;a+=this.channels)o?s.data[g++]=clamp(d(this.data[a],this.data[a+1],this.data[a+2],this)*this.data[a+this.components]/this.maxValue,this):(s.data[g++]=clamp(d(this.data[a],this.data[a+1],this.data[a+2],this),this),s.alpha&&(s.data[g++]=this.data[a+this.components]));return s}function huang(e){let r=0;for(let T=0;T<e.length;T++)if(e[T]!==0){r=T;break}let t=e.length-1;for(let T=e.length-1;T>=r;T--)if(e[T]!==0){t=T;break}let o=1/(t-r),s=new Array(e.length),d=0,g=0;for(let T=r;T<e.length;T++)d+=T*e[T],g+=e[T],s[T]=d/g;let a=new Array(e.length);d=g=0;for(let T=t;T>0;T--)d+=T*e[T],g+=e[T],a[T-1]=d/g;let b=-1,_=Number.MAX_VALUE;for(let T=0;T<e.length;T++){let C=0,D;for(let k=0;k<=T;k++)D=1/(1+o*Math.abs(k-s[T])),D<1e-6||D>.999999||(C+=e[k]*(-D*Math.log(D)-(1-D)*Math.log(1-D)));for(let k=T+1;k<e.length;k++)D=1/(1+o*Math.abs(k-a[T])),D<1e-6||D>.999999||(C+=e[k]*(-D*Math.log(D)-(1-D)*Math.log(1-D)));C<_&&(_=C,b=T)}return b}function intermodes(e){let r=e.slice(),t=0;for(;!bimodalTest$1(r);){let s=0,d=0,g=r[0];for(let a=0;a<e.length-1;a++)s=d,d=g,g=r[a+1],r[a]=(s+d+g)/3;if(r[e.length-1]=(d+g)/3,t++,t>1e4)throw new Error("Intermodes Threshold not found after 10000 iterations")}let o=0;for(let s=1;s<e.length-1;s++)r[s-1]<r[s]&&r[s+1]<r[s]&&(o+=s);return Math.floor(o/2)}function bimodalTest$1(e){let r=!1,t=0;for(let o=1;o<e.length-1;o++)if(e[o-1]<e[o]&&e[o+1]<e[o]&&(t++,t>2))return!1;return t===2&&(r=!0),r}function isodata(e){let r,t,o,s,d=0;for(let g=1;g<e.length;g++)if(e[g]>0){d=g+1;break}for(;;){r=0,o=0;for(let g=0;g<d;g++)o=o+e[g],r=r+e[g]*g;s=0,t=0;for(let g=d+1;g<e.length;g++)t+=e[g],s+=e[g]*g;if(o>0&&t>0&&(r/=o,s/=t,d===Math.round((r+s)/2)))break;if(d++,d>e.length-2)throw new Error("Threshold not found")}return d}function li(e,r){let t,o,s,d,g,a,b,_,T,C,D,k;D=.5,C=0;for(let O=0;O<e.length;O++)C+=O*e[O];C/=r,b=C;do{a=b,t=a+.5|0,o=0,d=0;for(let O=0;O<=t;O++)o+=O*e[O],d+=e[O];_=d===0?0:o/d,s=0,g=0;for(let O=t+1;O<e.length;O++)s+=O*e[O],g+=e[O];T=g===0?0:s/g,k=(_-T)/(Math.log(_)-Math.log(T)),k<-Number.EPSILON?b=k-.5|0:b=k+.5|0}while(Math.abs(b-a)>D);return t}function maxEntropy(e,r){let t=new Array(e.length);for(let D=0;D<e.length;D++)t[D]=e[D]/r;let o=new Array(e.length),s=new Array(e.length);o[0]=t[0],s[0]=1-o[0];for(let D=1;D<e.length;D++)o[D]=o[D-1]+t[D],s[D]=1-o[D];let d=0;for(let D=0;D<e.length;D++)if(Math.abs(o[D])>=Number.EPSILON){d=D;break}let g=e.length-1;for(let D=e.length-1;D>=d;D--)if(Math.abs(s[D])>=Number.EPSILON){g=D;break}let a=-1,b,_=Number.MIN_VALUE,T,C;for(let D=d;D<=g;D++){T=0;for(let k=0;k<=D;k++)e[k]!==0&&(T-=t[k]/o[D]*Math.log(t[k]/o[D]));C=0;for(let k=D+1;k<e.length;k++)e[k]!==0&&(C-=t[k]/s[D]*Math.log(t[k]/s[D]));b=T+C,_<b&&(_=b,a=D)}return a}function mean$1(e,r){let t=0;for(let o=0;o<e.length;o++)t+=o*e[o];return Math.floor(t/r)}function minError(e,r){let t,o=-2,s,d,g,a,b,_,T,C,D,k,O,U=0;for(let G=0;G<e.length;G++)U+=G*e[G];for(U/=r,t=U;t!==o;){let G=sumA(e,t),j=sumA(e,e.length-1),te=sumB(e,t),H=sumB(e,e.length-1),Z=sumC(e,t),W=sumC(e,e.length-1);if(s=te/G,d=(H-te)/(j-G),g=G/j,a=(j-G)/j,b=Z/G-s*s,_=(W-Z)/(j-G)-d*d,T=1/b-1/_,C=s/b-d/_,D=s*s/b-d*d/_+Math.log10(b*(a*a)/(_*(g*g))),k=C*C-T*D,k<0)return t;o=t,O=(C+Math.sqrt(k))/T,isNaN(O)?t=o:t=Math.floor(O)}return t}function sumA(e,r){let t=0;for(let o=0;o<=r;o++)t+=e[o];return t}function sumB(e,r){let t=0;for(let o=0;o<=r;o++)t+=o*e[o];return t}function sumC(e,r){let t=0;for(let o=0;o<=r;o++)t+=o*o*e[o];return t}function minimum(e){if(e.length<2)return 0;let r=0,t=-1,o=-1,s=new Array(e.length);for(let d=0;d<e.length;d++)s[d]=e[d],e[d]>0&&(o=d);for(;!bimodalTest(s);)if(s=smoothed(s),r++,r>1e4)return t;return t=minimumBetweenPeeks(s,o),t}function smoothed(e){let r=new Array(e.length);for(let t=1;t<e.length-1;t++)r[t]=(e[t-1]+e[t]+e[t+1])/3;return r[0]=(e[0]+e[1])/3,r[e.length-1]=(e[e.length-2]+e[e.length-1])/3,r}function minimumBetweenPeeks(e,r){let t;for(let o=1;o<r;o++)if(e[o-1]>e[o]&&e[o+1]>=e[o]){t=o;break}return t}function bimodalTest(e){let r=e.length,t=!1,o=0;for(let s=1;s<r-1;s++)if(e[s-1]<e[s]&&e[s+1]<e[s]&&(o++,o>2))return!1;return o===2&&(t=!0),t}function moments(e,r){let t=1,o=0,s=0,d=0,g=0,a,b,_,T,C,D,k=-1,O=e.length,U=new Array(O);for(let G=0;G<O;G++)U[G]=e[G]/r;for(let G=0;G<O;G++)o+=G*U[G],s+=G*G*U[G],d+=G*G*G*U[G];b=t*s-o*o,_=(-s*s+o*d)/b,T=(t*-d+s*o)/b,C=.5*(-T-Math.sqrt(T*T-4*_)),D=.5*(-T+Math.sqrt(T*T-4*_)),a=(D-o)/(D-C);for(let G=0;G<O;G++)if(g+=U[G],g>a){k=G;break}return k}function otsu(e,r){let t=0,o=0,s=0,d=0,g=0;for(let a=0;a<e.length;a++)g+=a*e[a];for(let a=0;a<e.length;a++){o=o+e[a];const b=r-o;if(o===0||b===0)continue;t=t+a*e[a];const _=(g-t)/b,T=o*b*(t/o-_)*(t/o-_);T>=s&&(d=a,s=T)}return d}function percentile(e){let r=-1,t=.5,o=new Array(e.length),s=partialSum(e,e.length-1),d=1;for(let g=0;g<e.length;g++)o[g]=Math.abs(partialSum(e,g)/s-t),o[g]<d&&(d=o[g],r=g);return r}function partialSum(e,r){let t=0;for(let o=0;o<=r;o++)t+=e[o];return t}function renyiEntropy(e,r){let t,o,s,d=new Array(e.length),g=new Array(e.length),a=new Array(e.length),b=0,_=0,T=0,C=0,D=0,k=0,U=1/(1-.5),j=1/(1-2);for(let W=0;W<e.length;W++)d[W]=e[W]/r;g[0]=d[0],a[0]=1-g[0];for(let W=1;W<e.length;W++)g[W]=g[W-1]+d[W],a[W]=1-g[W];o=0;for(let W=0;W<e.length;W++)if(Math.abs(g[W])>=Number.EPSILON){o=W;break}s=e.length-1;for(let W=e.length-1;W>=o;W--)if(Math.abs(a[W])>=Number.EPSILON){s=W;break}for(let W=o;W<=s;W++){let _e=0,fe=0,re=0;for(let Ge=0;Ge<=W;Ge++)e[Ge]!==0&&(_e-=d[Ge]/g[W]*Math.log(d[Ge]/g[W])),fe+=Math.sqrt(d[Ge]/g[W]),re+=d[Ge]*d[Ge]/(g[W]*g[W]);let ae=0,J=0,se=0;for(let Ge=W+1;Ge<e.length;Ge++)e[Ge]!==0&&(ae-=d[Ge]/a[W]*Math.log(d[Ge]/a[W])),J+=Math.sqrt(d[Ge]/a[W]),se+=d[Ge]*d[Ge]/(a[W]*a[W]);let Me=_e+ae,Ie=U*(fe*J>0?Math.log(fe*J):0),We=j*(re*se>0?Math.log(re*se):0);Me>C&&(C=Me,b=W),Ie>D&&(D=Ie,_=W),We>k&&(k=We,T=W)}let te=[b,_,T];te.sort((W,_e)=>W-_e);let H;Math.abs(te[0]-te[1])<=5?Math.abs(te[1]-te[2])<=5?H=[1,2,1]:H=[0,1,3]:Math.abs(te[1]-te[2])<=5?H=[3,1,0]:H=[1,2,1];let Z=g[te[2]]-g[te[0]];return t=Math.round(te[0]*(g[te[0]]+.25*Z*H[0])+.25*te[1]*Z*H[1]+te[2]*(a[te[2]]+.25*Z*H[2])),t}function shanbhag(e,r){let t=new Array(e.length);for(let k=0;k<e.length;k++)t[k]=e[k]/r;let o=new Array(e.length),s=new Array(e.length);o[0]=t[0],s[0]=1-o[0];for(let k=1;k<e.length;k++)o[k]=o[k-1]+t[k],s[k]=1-o[k];let d=0;for(let k=0;k<e.length;k++)if(Math.abs(o[k])>=Number.EPSILON){d=k;break}let g=e.length-1;for(let k=e.length-1;k>=d;k--)if(Math.abs(s[k])>=Number.EPSILON){g=k;break}let a=-1,b=Number.MAX_VALUE,_,T,C,D;for(let k=d;k<=g;k++){C=0,_=.5/o[k];for(let O=1;O<=k;O++)C-=t[O]*Math.log(1-_*o[O-1]);C*=_,D=0,_=.5/s[k];for(let O=k+1;O<e.length;O++)D-=t[O]*Math.log(1-_*s[O]);D*=_,T=Math.abs(C-D),T<b&&(b=T,a=k)}return a}function triangle$1(e){let r=0,t=0,o=0,s=0;for(let C=0;C<e.length;C++)if(e[C]>0){r=C;break}r>0&&r--;for(let C=e.length-1;C>0;C--)if(e[C]>0){s=C;break}s<e.length-1&&s++;for(let C=0;C<e.length;C++)e[C]>t&&(o=C,t=e[C]);let d=!1;if(o-r<s-o){d=!0;let C=0,D=e.length-1;for(;C<D;){let k=e[C];e[C]=e[D],e[D]=k,C++,D--}r=e.length-1-s,o=e.length-1-o}if(r===o)return r;let g,a,b;g=e[o],a=r-o,b=Math.sqrt(g*g+a*a),g/=b,a/=b,b=g*r+a*e[r];let _=r,T=0;for(let C=r+1;C<=o;C++){let D=g*C+a*e[C]-b;D>T&&(_=C,T=D)}if(_--,d){let C=0,D=e.length-1;for(;C<D;){let k=e[C];e[C]=e[D],e[D]=k,C++,D--}return e.length-1-_}else return _}function yen(e,r){let t=new Array(e.length);for(let _=0;_<e.length;_++)t[_]=e[_]/r;let o=new Array(e.length);o[0]=t[0];for(let _=1;_<e.length;_++)o[_]=o[_-1]+t[_];let s=new Array(e.length);s[0]=t[0]*t[0];for(let _=1;_<e.length;_++)s[_]=s[_-1]+t[_]*t[_];let d=new Array(e.length);d[e.length-1]=0;for(let _=e.length-2;_>=0;_--)d[_]=d[_+1]+t[_+1]*t[_+1];let g=-1,a=Number.MIN_VALUE,b;for(let _=0;_<e.length;_++)b=-1*(s[_]*d[_]>0?Math.log(s[_]*d[_]):0)+2*(o[_]*(1-o[_])>0?Math.log(o[_]*(1-o[_])):0),b>a&&(a=b,g=_);return g}const methods={huang,intermodes,isodata,li,maxentropy:maxEntropy,mean:mean$1,minerror:minError,minimum,moments,otsu,percentile,renyientropy:renyiEntropy,shanbhag,triangle:triangle$1,yen},names={};Object.keys(methods).forEach(e=>{names[e]=e});function getThreshold(e={}){let{algorithm:r=names.otsu}=e;this.checkProcessable("getThreshold",{components:1,bitDepth:[8,16]});let t=methods[r.toLowerCase()];if(t){let o=this.getHistogram();return t(o,this.size)}else throw new Error(`unknown thresholding algorithm: ${r}`)}const THRESHOLD="threshold";function mask(e={}){let{algorithm:r=THRESHOLD,threshold:t=.5,useAlpha:o=!0,invert:s=!1}=e;this.checkProcessable("mask",{components:1,bitDepth:[8,16]}),r===THRESHOLD?t=getThreshold$1(t,this.maxValue):t=getThreshold.call(this,e);let d=new Image(this.width,this.height,{kind:"BINARY",parent:this}),g=0;if(this.alpha&&o)for(let a=0;a<this.data.length;a+=this.channels){let b=this.data[a]+(this.maxValue-this.data[a])*(this.maxValue-this.data[a+1])/this.maxValue;(s&&b<=t||!s&&b>=t)&&d.setBit(g),g++}else for(let a=0;a<this.data.length;a+=this.channels)(s&&this.data[a]<=t||!s&&this.data[a]>=t)&&d.setBit(g),g++;return d}function copyImage(e,r,t,o){let s=e.width,d=e.height,g=r.width,a=e.channels;for(let b=0;b<s;b++)for(let _=0;_<d;_++)for(let T=0;T<a;T++){let C=(_*s+b)*a+T,D=((o+_)*g+t+b)*a+T;r.data[D]=e.data[C]}}function pad(e={}){let{size:r=0,algorithm:t="copy",color:o}=e;if(this.checkProcessable("pad",{bitDepth:[8,16]}),t==="set"){if(o.length!==this.channels)throw new Error(`pad: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let b=0;b<o.length;b++)o[b]===0&&(o[b]=.001)}else o=newArray$1(this.channels,null);Array.isArray(r)||(r=[r,r]);let s=this.width+r[0]*2,d=this.height+r[1]*2,g=this.channels,a=Image.createFrom(this,{width:s,height:d});copyImage(this,a,r[0],r[1]);for(let b=r[0];b<s-r[0];b++)for(let _=0;_<g;_++){let T=o[_]||a.data[(r[1]*s+b)*g+_];for(let C=0;C<r[1];C++)a.data[(C*s+b)*g+_]=T;T=o[_]||a.data[((d-r[1]-1)*s+b)*g+_];for(let C=d-r[1];C<d;C++)a.data[(C*s+b)*g+_]=T}for(let b=0;b<d;b++)for(let _=0;_<g;_++){let T=o[_]||a.data[(b*s+r[0])*g+_];for(let C=0;C<r[0];C++)a.data[(b*s+C)*g+_]=T;T=o[_]||a.data[(b*s+s-r[0]-1)*g+_];for(let C=s-r[0];C<s;C++)a.data[(b*s+C)*g+_]=T}return a}function colorDepth(e=8){if(this.checkProcessable("colorDepth",{bitDepth:[1,8,16]}),![8,16].includes(e))throw Error("You need to specify the new colorDepth as 8 or 16");if(this.bitDepth===e)return this.clone();let r=Image.createFrom(this,{bitDepth:e});switch(e){case 8:if(this.bitDepth===1)for(let t=0;t<this.size;t++)this.getBit(t)&&(r.data[t]=255);else for(let t=0;t<this.data.length;t++)r.data[t]=this.data[t]>>8;break;case 16:if(this.bitDepth===1)for(let t=0;t<this.size;t++)this.getBit(t)&&(r.data[t]=65535);else for(let t=0;t<this.data.length;t++)r.data[t]=this.data[t]<<8|this.data[t];break;default:throw new Error("colorDepth conversion unexpected case")}return r}function rotateFree(e,r={}){const{interpolation:t=validInterpolations.nearestneighbor,width:o=this.width,height:s=this.height}=r;if(typeof e!="number")throw new TypeError("degrees must be a number");const d=checkInterpolation(t),g=e*Math.PI/180,a=Math.floor(Math.abs(o*Math.cos(g))+Math.abs(s*Math.sin(g))),b=Math.floor(Math.abs(s*Math.cos(g))+Math.abs(o*Math.sin(g))),_=Math.cos(-g),T=Math.sin(-g);let C=a/2,D=b/2;a%2===0?(C=C-.5,b%2===0?D=D-.5:D=Math.floor(D)):(C=Math.floor(C),b%2===0?D=D-.5:D=Math.floor(D));const k=Math.floor(o/2-C),O=Math.floor(s/2-D);if(this.bitDepth===1){const U=new Image(a,b,{kind:"BINARY",parent:this});switch(d){case validInterpolations.nearestneighbor:return rotateBinaryNearestNeighbor(this,U,k,O,C,D,_,T);case validInterpolations.bilinear:return rotateBinaryBilinear(this,U,k,O,C,D,_,T);default:throw new Error(`unsupported rotate interpolation: ${d}`)}}else{const U=Image.createFrom(this,{width:a,height:b});switch(d){case validInterpolations.nearestneighbor:return rotateNearestNeighbor(this,U,k,O,C,D,_,T);case validInterpolations.bilinear:return rotateBilinear(this,U,k,O,C,D,_,T);default:throw new Error(`unsupported rotate interpolation: ${d}`)}}}function rotateNearestNeighbor(e,r,t,o,s,d,g,a){for(let b=0;b<r.width;b+=1)for(let _=0;_<r.height;_+=1)for(let T=0;T<e.channels;T++){let C=Math.round((b-s)*g-(_-d)*a+s)+t,D=Math.round((_-d)*g+(b-s)*a+d)+o;C<0||C>=e.width||D<0||D>=e.height?e.alpha===1&&T===e.channels-1?r.setValueXY(b,_,T,0):r.setValueXY(b,_,T,e.maxValue):r.setValueXY(b,_,T,e.getValueXY(C,D,T))}return r}function rotateBinaryNearestNeighbor(e,r,t,o,s,d,g,a){for(let b=0;b<r.width;b+=1)for(let _=0;_<r.height;_+=1){let T=Math.round((b-s)*g-(_-d)*a+s)+t,C=Math.round((_-d)*g+(b-s)*a+d)+o;(T<0||T>=e.width||C<0||C>=e.height||e.getBitXY(T,C))&&r.setBitXY(b,_)}return r}function rotateBilinear(e,r,t,o,s,d,g,a){let b=e.width*e.channels;for(let _=0;_<r.height;_++)for(let T=0;T<r.width;T++){let C=(T-s)*g-(_-d)*a+s+t,D=(_-d)*g+(T-s)*a+d+o,k=C|0,O=D|0,U=C-k,G=D-O;for(let j=0;j<e.channels;j++)if(C<0||C>=e.width||D<0||D>=e.height)e.alpha===1&&j===e.channels-1?r.setValueXY(T,_,j,0):r.setValueXY(T,_,j,e.maxValue);else{let te=(O*e.width+k)*e.channels+j,H=e.data[te],Z=e.data[te+e.channels],W=e.data[te+b],_e=e.data[te+b+e.channels],fe=H+U*(Z-H)+G*(W-H)+U*G*(H-Z-W+_e)|0;r.setValueXY(T,_,j,fe)}}return r}function rotateBinaryBilinear(e,r,t,o,s,d,g,a){let b=e.width;for(let _=0;_<r.height;_++)for(let T=0;T<r.width;T++){let C=(T-s)*g-(_-d)*a+s+t,D=(_-d)*g+(T-s)*a+d+o,k=C|0,O=D|0,U=C-k,G=D-O;if(C<0||C>=e.width||D<0||D>=e.height)r.setBitXY(T,_);else{let j=O*e.width+k,te=e.getBit(j),H=e.getBit(j+1),Z=e.getBit(j+b),W=e.getBit(j+1+b);(te|U&H-te|G&Z-te|U&G&te-H-Z+W)>0&&r.setBitXY(T,_)}}return r}function rotate$1(e,r){if(this.checkProcessable("rotate",{bitDepth:[1,8,16]}),typeof e!="number")throw new TypeError("angle must be a number");switch(e<0&&(e=Math.ceil(-e/360)*360+e),e%360){case 0:return this.clone();case 90:return rotateRight.call(this);case 180:return rotate180.call(this);case 270:return rotateLeft.call(this);default:return rotateFree.call(this,e,r)}}function rotateLeft(){if(this.bitDepth===1){const e=new Image(this.height,this.width,{kind:"BINARY",parent:this}),r=e.height-1;for(let t=0;t<this.height;t++)for(let o=0;o<this.width;o++)this.getBitXY(o,t)&&e.setBitXY(t,r-o);return e}else{const e=Image.createFrom(this,{width:this.height,height:this.width}),r=e.height-1;for(let t=0;t<this.height;t++)for(let o=0;o<this.width;o++)for(let s=0;s<this.channels;s++)e.setValueXY(t,r-o,s,this.getValueXY(o,t,s));return e}}function rotateRight(){if(this.bitDepth===1){const e=new Image(this.height,this.width,{kind:"BINARY",parent:this}),r=e.width-1;for(let t=0;t<this.height;t++)for(let o=0;o<this.width;o++)this.getBitXY(o,t)&&e.setBitXY(r-t,o);return e}else{const e=Image.createFrom(this,{width:this.height,height:this.width}),r=e.width-1;for(let t=0;t<this.height;t++)for(let o=0;o<this.width;o++)for(let s=0;s<this.channels;s++)e.setValueXY(r-t,o,s,this.getValueXY(o,t,s));return e}}function rotate180(){if(this.bitDepth===1){const e=new Image(this.width,this.height,{kind:"BINARY",parent:this}),r=e.width-1,t=e.height-1;for(let o=0;o<this.height;o++)for(let s=0;s<this.width;s++)this.getBitXY(s,o)&&e.setBitXY(r-s,t-o);return e}else{const e=Image.createFrom(this),r=e.width-1,t=e.height-1;for(let o=0;o<this.height;o++)for(let s=0;s<this.width;s++)for(let d=0;d<this.channels;d++)e.setValueXY(r-s,t-o,d,this.getValueXY(s,o,d));return e}}function insert(e,r={}){const t=getImageParameters(e);this.checkProcessable("insert",t);let{x:o=0,y:s=0}=r;const d=getOutputImageOrInPlace(this,r,{copy:!0}),g=Math.min(d.height,s+e.height),a=Math.min(d.width,o+e.width);if(d.bitDepth===1)for(let b=s;b<g;b++)for(let _=o;_<a;_++)e.getBitXY(_-o,b-s)?d.setBitXY(_,b):d.clearBitXY(_,b);else for(let b=s;b<g;b++)for(let _=o;_<a;_++)d.setPixelXY(_,b,e.getPixelXY(_-o,b-s));return d}function setBorder(e={}){let{size:r=0,algorithm:t="copy",color:o}=e;if(this.checkProcessable("setBorder",{bitDepth:[8,16,32,64]}),t==="set"){if(o.length!==this.channels)throw new Error(`setBorder: the color array must have the same length as the number of channels. Here: ${this.channels}`);for(let a=0;a<o.length;a++)o[a]===0&&(o[a]=.001)}else o=newArray$1(this.channels,null);Array.isArray(r)||(r=[r,r]);let s=r[0],d=r[1],g=this.channels;for(let a=s;a<this.width-s;a++)for(let b=0;b<g;b++){let _=o[b]||this.data[(a+this.width*d)*g+b];for(let T=0;T<d;T++)this.data[(T*this.width+a)*g+b]=_;_=o[b]||this.data[(a+this.width*(this.height-d-1))*g+b];for(let T=this.height-d;T<this.height;T++)this.data[(T*this.width+a)*g+b]=_}for(let a=0;a<this.height;a++)for(let b=0;b<g;b++){let _=o[b]||this.data[(a*this.width+s)*g+b];for(let T=0;T<s;T++)this.data[(a*this.width+T)*g+b]=_;_=o[b]||this.data[(a*this.width+this.width-s-1)*g+b];for(let T=this.width-s;T<this.width;T++)this.data[(a*this.width+T)*g+b]=_}return this}function split(e={}){let{preserveAlpha:r=!0}=e;if(this.checkProcessable("split",{bitDepth:[8,16]}),this.components===1)return new Stack([this.clone()]);let t=new Stack,o=this.data;if(this.alpha&&r)for(let s=0;s<this.components;s++){let d=Image.createFrom(this,{components:1,alpha:!0,colorModel:GREY$1}),g=0;for(let a=0;a<o.length;a+=this.channels)d.data[g++]=o[a+s],d.data[g++]=o[a+this.components];t.push(d)}else for(let s=0;s<this.channels;s++){let d=Image.createFrom(this,{components:1,alpha:!1,colorModel:GREY$1}),g=0;for(let a=0;a<o.length;a+=this.channels)d.data[g++]=o[a+s];t.push(d)}return t}function getChannel(e,r={}){let{keepAlpha:t=!1,mergeAlpha:o=!1}=r;t&=this.alpha,o&=this.alpha,this.checkProcessable("getChannel",{bitDepth:[8,16]}),e=validateChannel(this,e);let s=Image.createFrom(this,{components:1,alpha:t,colorModel:GREY$1}),d=0;for(let g=0;g<this.data.length;g+=this.channels)o?s.data[d++]=this.data[g+e]*this.data[g+this.components]/this.maxValue:(s.data[d++]=this.data[g+e],t&&(s.data[d++]=this.data[g+this.components]));return s}function combineChannels(e=defaultCombineMethod,r={}){let{mergeAlpha:t=!1,keepAlpha:o=!1}=r;t&=this.alpha,o&=this.alpha,this.checkProcessable("combineChannels",{bitDepth:[8,16]});let s=Image.createFrom(this,{components:1,alpha:o,colorModel:GREY$1}),d=0;for(let g=0;g<this.size;g++){let a=e(this.getPixel(g));t?s.data[d++]=a*this.data[g*this.channels+this.components]/this.maxValue:(s.data[d++]=a,o&&(s.data[d++]=this.data[g*this.channels+this.components]))}return s}function defaultCombineMethod(e){return(e[0]+e[1]+e[2])/3}function setChannel(e,r){if(this.checkProcessable("setChannel",{bitDepth:[8,16]}),r.checkProcessable("setChannel (image parameter check)",{bitDepth:[this.bitDepth],alpha:[0],components:[1]}),r.width!==this.width||r.height!==this.height)throw new Error("Images must have exactly the same width and height");e=validateChannel(this,e);let t=e;for(let o=0;o<r.data.length;o++)this.data[t]=r.data[o],t+=this.channels;return this}function getSimilarity(e,r={}){let{shift:t=[0,0],average:o,channels:s,defaultAlpha:d,normalize:g,border:a=[0,0]}=r;if(this.checkProcessable("getSimilarity",{bitDepth:[8,16]}),Array.isArray(a)||(a=[a,a]),s=validateArrayOfChannels(this,{channels:s,defaultAlpha:d}),this.bitDepth!==e.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==e.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==e.colorModel)throw new Error("Both images must have the same colorModel");typeof o>"u"&&(o=!0);let b=Math.max(a[0],-t[0]),_=Math.min(this.width-a[0],this.width-t[0]),T=Math.max(a[1],-t[1]),C=Math.min(this.height-a[1],this.height-t[1]),D=newArray$1(s.length,0);for(let k=0;k<s.length;k++){let O=s[k],U=g?this.sum[O]:Math.max(this.sum[O],e.sum[O]),G=g?e.sum[O]:Math.max(this.sum[O],e.sum[O]);if(U!==0&&G!==0)for(let j=b;j<_;j++)for(let te=T;te<C;te++){let H=j*this.multiplierX+te*this.multiplierY+O,Z=H+t[0]*this.multiplierX+t[1]*this.multiplierY;D[k]+=Math.min(this.data[H]/U,e.data[Z]/G)}}return o?D.reduce((k,O)=>k+O)/D.length:D}function getPixelsGrid(e={}){let{sampling:r=[10,10],painted:t=!1,mask:o}=e;this.checkProcessable("getPixelsGrid",{bitDepth:[8,16],channels:1}),Array.isArray(r)||(r=[r,r]);const s=r[0],d=r[1],g=[],a=[],b=this.width/s,_=this.height/d;let T=Math.floor(b/2);for(let D=0;D<s;D++){let k=Math.floor(_/2);for(let O=0;O<d;O++){let U=Math.round(T),G=Math.round(k);(!o||o.getBitXY(U,G))&&(g.push([U,G]),a.push(this.getPixelXY(U,G))),k+=_}T+=b}const C={xyS:g,zS:a};return t&&(C.painted=this.rgba8().paintPoints(g)),C}function Matrix(e,r,t){const o=new Array(e);for(let s=0;s<e;s++)o[s]=new Array(r);if(t)for(let s=0;s<e;s++)for(let d=0;d<r;d++)o[s][d]=t;return o.width=e,o.height=r,Object.setPrototypeOf(o,Matrix.prototype),o}Matrix.prototype.localMin=function(e,r){let t=this[e][r],o=[e,r];for(let s=Math.max(0,e-1);s<Math.min(this.length,e+2);s++)for(let d=Math.max(0,r-1);d<Math.min(this[0].length,r+2);d++)this[s][d]<t&&(t=this[s][d],o=[s,d]);return{position:o,value:t}};Matrix.prototype.localMax=function(e,r){let t=this[e][r],o=[e,r];for(let s=Math.max(0,e-1);s<Math.min(this.length,e+2);s++)for(let d=Math.max(0,r-1);d<Math.min(this[0].length,r+2);d++)this[s][d]>t&&(t=this[s][d],o=[s,d]);return{position:o,value:t}};Matrix.prototype.localSearch=function(e,r,t){let o=[];for(let s=Math.max(0,e-1);s<Math.min(this.length,e+2);s++)for(let d=Math.max(0,r-1);d<Math.min(this[0].length,r+2);d++)this[s][d]===t&&o.push([s,d]);return o};function getBestMatch(e,r={}){let{border:t}=r;if(this.checkProcessable("getChannel",{bitDepth:[8,16]}),this.bitDepth!==e.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==e.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==e.colorModel)throw new Error("Both images must have the same colorModel");let o=new Matrix(e.width,e.height,-1/0),s=Math.floor(e.width/2),d=Math.floor(e.height/2),g=s,a=d,b=!1;for(;!b;){let _=o.localSearch(s,d,-1/0);for(let C=0;C<_.length;C++){let D=_[C],k=this.getSimilarity(e,{border:t,shift:[g-D[0],a-D[1]]});o[D[0]][D[1]]=k}let T=o.localMax(s,d);T.position[0]!==s||T.position[1]!==d?(s=T.position[0],d=T.position[1]):b=!0}return[s-g,d-a]}function getRow(e,r=0){this.checkProcessable("getRow",{bitDepth:[8,16]}),checkRow(this,e),checkChannel(this,r);let t=new Array(this.width),o=0,s=e*this.width*this.channels+r,d=s+this.width*this.channels;for(let g=s;g<d;g+=this.channels)t[o++]=this.data[g];return t}function getColumn(e,r=0){this.checkProcessable("getColumn",{bitDepth:[8,16]}),checkColumn(this,e),checkChannel(this,r);let t=new Array(this.height),o=0,s=this.width*this.channels;for(let d=r+e*this.channels;d<this.data.length;d+=s)t[o++]=this.data[d];return t}function getMatrix(e={}){let{channel:r}=e;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),r===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");r=0}let t=new Matrix$2(this.height,this.width);for(let o=0;o<this.height;o++)for(let s=0;s<this.width;s++)t.set(o,s,this.getValueXY(s,o,r));return t}function setMatrix(e,r={}){e=new Matrix$2(e);let{channel:t}=r;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),t===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");t=0}if(this.width!==e.columns||this.height!==e.rows)throw new RangeError("The size of the matrix must be equal to the size of the image");for(let o=0;o<this.height;o++)for(let s=0;s<this.width;s++)this.setValueXY(s,o,t,e.get(o,s))}function getPixelsArray(){this.checkProcessable("getPixelsArray",{bitDepth:[8,16,32]});let e=new Array(this.size),r=0;for(let t=0;t<this.data.length;t+=this.channels){let o=new Array(this.components);for(let s=0;s<this.components;s++)o[s]=this.data[t+s];e[r++]=o}return e}function getIntersection(e){let r=this,t=r.getClosestCommonParent(e),o=r.getRelativePosition(t,{defaultFurther:!0}),s=getRelativePositionForAllPixels(r,o),d=e.getRelativePosition(t,{defaultFurther:!0}),g=getRelativePositionForAllPixels(e,d),a=getCommonSurface(s,g),b={whitePixelsMask1:[],whitePixelsMask2:[],commonWhitePixels:[]};for(let _=0;_<a.length;_++){let T=a[_],C=[T[0]-o[0],T[1]-o[1]],D=[T[0]-d[0],T[1]-d[1]],k=r.getBitXY(C[0],C[1]),O=e.getBitXY(D[0],D[1]);k===1&&O===1&&b.commonWhitePixels.push(T)}for(let _=0;_<s.length;_++){let T,C;_!==0&&(T=Math.floor(_/r.width),C=_%r.width),r.getBitXY(T,C)===1&&b.whitePixelsMask1.push(s[_])}for(let _=0;_<g.length;_++){let T=0,C=0;_!==0&&(T=Math.floor(_/e.width),C=_%e.width),e.getBitXY(T,C)===1&&b.whitePixelsMask2.push(g[_])}return b}function getRelativePositionForAllPixels(e,r){let t=[];for(let o=0;o<e.height;o++)for(let s=0;s<e.width;s++){let d=[o,s];t.push([d[0]+r[0],d[1]+r[1]])}return t}function getCommonSurface(e,r){let t=0,o=0,s=[];for(;t<e.length&&o<r.length;)e[t][0]===r[o][0]&&e[t][1]===r[o][1]?(s.push(e[t]),t++,o++):e[t][0]<r[o][0]||e[t][0]===r[o][0]&&e[t][1]<r[o][1]?t++:o++;return s}function getClosestCommonParent(e){let r=getDepth(this),t=getDepth(e),o;if(r>=t?o=getFurthestParent(this,r):o=getFurthestParent(e,t),r===0||t===0)return o;let s=this,d=e;for(;r!==t;)if(r>t){if(s=s.parent,s===null)return o;r=r-1}else{if(d=d.parent,d===null)return o;t=t-1}for(;s!==d&&s!==null&&d!==null;)if(s=s.parent,d=d.parent,s===null||d===null)return o;return s!==d?o:s}function getDepth(e){let r=0,t=e;for(;t.parent!=null;)t=t.parent,r++;return r}function getFurthestParent(e,r){let t=e;for(;r>0;)t=t.parent,r=r-1;return t}const defaultOptions$1={lowThreshold:10,highThreshold:30,gaussianBlur:1.1},Gx=[[-1,0,1],[-2,0,2],[-1,0,1]],Gy=[[-1,-2,-1],[0,0,0],[1,2,1]],convOptions={bitDepth:32,mode:"periodic"};function cannyEdgeDetector(e,r){e.checkProcessable("Canny edge detector",{bitDepth:8,channels:1,components:1}),r=Object.assign({},defaultOptions$1,r);const t=e.width,o=e.height,s=e.maxValue,d={sigma:r.gaussianBlur,radius:3},g=e.gaussianFilter(d),a=g.convolution(Gy,convOptions),b=g.convolution(Gx,convOptions),_=b.hypotenuse(a),T=e.constructor,C=new T(t,o,{kind:"GREY",bitDepth:32}),D=new T(t,o,{kind:"GREY",bitDepth:32}),k=new T(t,o,{kind:"GREY"});for(var O=1;O<t-1;O++)for(var U=1;U<o-1;U++){var G=(Math.round(Math.atan2(b.getValueXY(O,U,0),a.getValueXY(O,U,0))*(5/Math.PI))+5)%5;G===0&&(_.getValueXY(O,U,0)<=_.getValueXY(O,U-1,0)||_.getValueXY(O,U,0)<=_.getValueXY(O,U+1,0))||G===1&&(_.getValueXY(O,U,0)<=_.getValueXY(O-1,U+1,0)||_.getValueXY(O,U,0)<=_.getValueXY(O+1,U-1,0))||G===2&&(_.getValueXY(O,U,0)<=_.getValueXY(O-1,U,0)||_.getValueXY(O,U,0)<=_.getValueXY(O+1,U,0))||G===3&&(_.getValueXY(O,U,0)<=_.getValueXY(O-1,U-1,0)||_.getValueXY(O,U,0)<=_.getValueXY(O+1,U+1,0))||C.setValueXY(O,U,0,_.getValueXY(O,U,0))}for(O=0;O<t*o;++O){var j=C.data[O],te=0;j>r.highThreshold&&(te++,k.data[O]=s),j>r.lowThreshold&&te++,D.data[O]=te}var H=[];for(O=1;O<t-1;++O)for(U=1;U<o-1;++U)if(D.getValueXY(O,U,0)===1){e:for(var Z=O-1;Z<O+2;++Z)for(var W=U-1;W<U+2;++W)if(D.getValueXY(Z,W,0)===2){H.push([O,U]),k.setValueXY(O,U,0,s);break e}}for(;H.length>0;){var _e=[];for(O=0;O<H.length;++O)for(U=-1;U<2;++U)for(Z=-1;Z<2;++Z)if(!(U===0&&Z===0)){var fe=H[O][0]+U,re=H[O][1]+Z;D.getValueXY(fe,re,0)===1&&k.getValueXY(fe,re,0)===0&&(_e.push([fe,re]),k.setValueXY(fe,re,0,s))}H=_e}return k}function cannyEdge(e){return cannyEdgeDetector(this,e)}function extract(e,r={}){let{position:t}=r;if(this.checkProcessable("extract",{bitDepth:[1,8,16]}),!t&&(t=e.getRelativePosition(this),!t))throw new Error("extract : can not extract an image because the relative position can not be determined, try to specify manually the position as an array of 2 elements [x,y].");if(this.bitDepth>1){let o=Image.createFrom(this,{width:e.width,height:e.height,alpha:1,position:t,parent:this});for(let s=0;s<e.width;s++)for(let d=0;d<e.height;d++){for(let g=0;g<this.channels;g++){let a=this.getValueXY(s+t[0],d+t[1],g);o.setValueXY(s,d,g,a)}e.getBitXY(s,d)||o.setValueXY(s,d,this.components,0)}return o}else{let o=Image.createFrom(this,{width:e.width,height:e.height,position:t,parent:this});for(let s=0;s<e.height;s++)for(let d=0;d<e.width;d++)e.getBitXY(d,s)&&this.getBitXY(d+t[0],s+t[1])&&o.setBitXY(d,s);return o}}var fastList={exports:{}};(function(e,r){(function(){function t(s,d,g){this.next=g,g&&(g.prev=this),this.prev=d,d&&(d.next=this),this.data=s}function o(){if(!(this instanceof o))return new o;this._head=null,this._tail=null,this.length=0}o.prototype={push:function(s){this._tail=new t(s,this._tail,null),this._head||(this._head=this._tail),this.length++},pop:function(){if(this.length!==0){var s=this._tail;return this._tail=s.prev,s.prev&&(s.prev=this._tail.next=null),this.length--,this.length===1?this._head=this._tail:this.length===0&&(this._head=this._tail=null),s.data}},unshift:function(s){this._head=new t(s,null,this._head),this._tail||(this._tail=this._head),this.length++},shift:function(){if(this.length!==0){var s=this._head;return this._head=s.next,s.next&&(s.next=this._head.prev=null),this.length--,this.length===1?this._tail=this._head:this.length===0&&(this._head=this._tail=null),s.data}},item:function(s){s<0&&(s=this.length+s);for(var d=this._head;s-- >0&&d;)d=d.next;return d?d.data:void 0},slice:function(s,d){if(s||(s=0),d||(d=this.length),d<0&&(d=this.length+d),s<0&&(s=this.length+s),d===s)return[];if(d<s)throw new Error("invalid offset: "+s+","+d+" (length="+this.length+")");for(var g=d-s,a=new Array(g),b=0,_=this._head;s-- >0&&_;)_=_.next;for(;b<g&&_;)a[b++]=_.data,_=_.next;return a},drop:function(){o.call(this)},forEach:function(s,d){for(var g=this._head,a=0,b=this.length;a<b&&g;)s.call(d||this,g.data,a,this),g=g.next,a++},map:function(s,d){var g=new o;return this.forEach(function(a,b,_){g.push(s.call(d||_,a,b,_))}),g},filter:function(s,d){var g=new o;return this.forEach(function(a,b,_){s.call(d||_,a,b,_)&&g.push(a)}),g},reduce:function(s,d,g){var a=0,b=this._head,_=this.length;for(d||(a=1,d=b&&b.data,b=b&&b.next);a<_&&b;)d=s.call(g||this,d,b.data,this),a++,b=b.next;return d}},e.exports=o})()})(fastList);var fastListExports=fastList.exports;const LinkedList=getDefaultExportFromCjs(fastListExports);function floodFill(e={}){const{x:r=0,y:t=0,inPlace:o=!0}=e,s=o?this:Image.createFrom(this);if(this.checkProcessable("floodFill",{bitDepth:1}),this.getBitXY(r,t))return s;const g=new LinkedList;for(g.push(new Node(r,t));g.length>0;){const a=g.shift();s.setBitXY(a.x,a.y);for(let b=a.x+1;b<this.width&&(!s.getBitXY(b,a.y)&&!this.getBitXY(b,a.y));b++)s.setBitXY(b,a.y),a.y+1<this.height&&!this.getBitXY(b,a.y+1)&&g.push(new Node(b,a.y+1)),a.y-1>=0&&!this.getBitXY(b,a.y-1)&&g.push(new Node(b,a.y-1));for(let b=a.x-1;b>=0&&(!s.getBitXY(b,a.y)&&!this.getBitXY(b,a.y));b++)s.setBitXY(b,a.y),a.y+1<this.height&&!this.getBitXY(b,a.y+1)&&g.push(new Node(b,a.y+1)),a.y-1>=0&&!this.getBitXY(b,a.y-1)&&g.push(new Node(b,a.y-1))}return s}function Node(e,r){this.x=e,this.y=r}function _extends(){return _extends=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},_extends.apply(this,arguments)}function hsv2rgb(e,r,t){r=r/100,t=t/100;var o=[],s=t*r,d=e/60,g=s*(1-Math.abs(d%2-1)),a=t-s;return d>=0&&d<1?o=[s,g,0]:d>=1&&d<2?o=[g,s,0]:d>=2&&d<3?o=[0,s,g]:e>=3&&d<4?o=[0,g,s]:e>=4&&d<5?o=[g,0,s]:e>=5&&d<=6?o=[s,0,g]:o=[0,0,0],{r:Math.round(255*(o[0]+a)),g:Math.round(255*(o[1]+a)),b:Math.round(255*(o[2]+a))}}function hsl2hsv(e,r,t){return r*=(t<50?t:100-t)/100,{h:e,s:2*r/(t+r)*100,v:t+r}}function hsl2rgb$1(e,r,t){var o=hsl2hsv(e,r,t);return hsv2rgb(o.h,o.s,o.v)}var colors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]};function parse(e){return named(e)||hex3(e)||hex6(e)||rgb(e)||rgba$1(e)||hsl(e)||hsla(e)}function named(e){var r=colors[e.toLowerCase()];if(r)return{r:r[0],g:r[1],b:r[2],a:100}}function rgb(e){var r=e.match(/rgb\(([^)]+)\)/);if(r){var t=r[1].split(/ *, */).map(Number);return{r:t[0],g:t[1],b:t[2],a:100}}}function rgba$1(e){var r=e.match(/rgba\(([^)]+)\)/);if(r){var t=r[1].split(/ *, */).map(Number);return{r:t[0],g:t[1],b:t[2],a:t[3]*100}}}function hex6(e){if(e[0]==="#"&&e.length===7)return{r:parseInt(e.slice(1,3),16),g:parseInt(e.slice(3,5),16),b:parseInt(e.slice(5,7),16),a:100}}function hex3(e){if(e[0]==="#"&&e.length===4)return{r:parseInt(e[1]+e[1],16),g:parseInt(e[2]+e[2],16),b:parseInt(e[3]+e[3],16),a:100}}function hsl(e){var r=e.match(/hsl\(([^)]+)\)/);if(r){var t=r[1].split(/ *, */),o=parseInt(t[0],10),s=parseInt(t[1],10),d=parseInt(t[2],10),g=hsl2rgb$1(o,s,d);return _extends({},g,{a:100})}}function hsla(e){var r=e.match(/hsla\(([^)]+)\)/);if(r){var t=r[1].split(/ *, */),o=parseInt(t[0],10),s=parseInt(t[1],10),d=parseInt(t[2],10),g=parseInt(parseFloat(t[3])*100,10),a=hsl2rgb$1(o,s,d);return _extends({},a,{a:g})}}function css2array(e){let r=parse(e);return[r.r,r.g,r.b,Math.round(r.a*255/100)]}function hue2rgb(e,r,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?e+(r-e)*6*t:t<1/2?r:t<2/3?e+(r-e)*(2/3-t)*6:e}function hsl2rgb(e,r,t){let o,s,d,g,a,b;return r/=100,t/=100,r===0?g=a=b=t*255:(t<=.5?s=t*(r+1):s=t+r-t*r,o=t*2-s,d=e/360,g=hue2rgb(o,s,d+1/3),a=hue2rgb(o,s,d),b=hue2rgb(o,s,d-1/3)),{r:g,g:a,b}}function getDistinctColors(e){let r=new Array(e),t=0;for(let o=0;o<360;o+=360/e){t++;let s=hsl2rgb(o,100,30+t%4*15);r[t-1]=[Math.round(s.r*255),Math.round(s.g*255),Math.round(s.b*255)]}return r}function getRandomColor(){return[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)]}function getColors(e){let{color:r,colors:t,randomColors:o,numberColors:s=50}=e;if(r&&!Array.isArray(r)&&(r=css2array(r)),r)return[r];if(t)return t=t.map(function(d){return Array.isArray(d)?d:css2array(d)}),t;if(o){t=new Array(s);for(let d=0;d<s;d++)t[d]=getRandomColor()}return getDistinctColors(s)}function paintLabels(e,r,t={}){let{color:o="blue",colors:s,font:d="12px Helvetica",rotate:g=0}=t;if(this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1}),!Array.isArray(e))throw Error("paintLabels: labels must be an array");if(!Array.isArray(r))throw Error("paintLabels: positions must be an array");if(o&&!Array.isArray(o)&&(o=css2array(o)),s?s=s.map(function(_){return Array.isArray(_)?_:css2array(_)}):s=[o],e.length!==r.length)throw Error("paintLabels: positions and labels must be arrays from the same size");Array.isArray(d)||(d=[d]),Array.isArray(g)||(g=[g]);let b=this.getCanvas().getContext("2d");for(let _=0;_<e.length;_++){b.save();let T=s[_%s.length];b.fillStyle=`rgba(${T[0]},${T[1]},${T[2]},${T[3]/this.maxValue})`,b.font=d[_%d.length];let C=r[_];b.translate(C[0],C[1]),b.rotate(g[_%g.length]/180*Math.PI),b.fillText(e[_],0,0),b.restore()}return this.data=Uint8Array.from(b.getImageData(0,0,this.width,this.height).data),this}function paintMasks(e,r={}){let{alpha:t=255,labels:o=[],labelsPosition:s=[],labelColor:d="blue",labelFont:g="12px Helvetica"}=r;this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:RGB$1});let a=getColors(Object.assign({},r,{numberColors:e.length}));Array.isArray(e)||(e=[e]);for(let b=0;b<e.length;b++){let _=e[b],T=a[b%a.length];for(let C=0;C<_.width;C++)for(let D=0;D<_.height;D++)if(_.getBitXY(C,D))for(let k=0;k<Math.min(this.components,T.length);k++)if(t===255)this.setValueXY(C+_.position[0],D+_.position[1],k,T[k]);else{let O=this.getValueXY(C+_.position[0],D+_.position[1],k);O=Math.round((O*(255-t)+T[k]*t)/255),this.setValueXY(C+_.position[0],D+_.position[1],k,O)}}if(Array.isArray(o)&&o.length>0){let _=this.getCanvas().getContext("2d");_.fillStyle=d,_.font=g;for(let T=0;T<Math.min(e.length,o.length);T++){let C=s[T]?s[T]:e[T].position;_.fillText(o[T],C[0],C[1])}this.data=Uint8Array.from(_.getImageData(0,0,this.width,this.height).data)}return this}function zerosMatrix(e,r){let t=new Array(e);for(let o=0;o<e;o++)t[o]=new Array(r).fill(0);return t}const cross=[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],smallCross=[[0,1,0],[1,1,1],[0,1,0]];class Shape{constructor(r={}){let{kind:t="cross",shape:o,size:s,width:d,height:g,filled:a=!0}=r;if(s&&(d=s,g=s),o)switch(o.toLowerCase()){case"square":case"rectangle":this.matrix=rectangle(d,g,{filled:a});break;case"circle":case"ellipse":this.matrix=ellipse(d,g,{filled:a});break;case"triangle":this.matrix=triangle(d,g,{filled:a});break;default:throw new Error(`Shape: unexpected shape: ${o}`)}else if(t)switch(t.toLowerCase()){case"cross":this.matrix=cross;break;case"smallcross":this.matrix=smallCross;break;default:throw new Error(`Shape: unexpected kind: ${t}`)}else throw new Error("Shape: expected a kind or a shape option");this.height=this.matrix.length,this.width=this.matrix[0].length,this.halfHeight=this.height/2>>0,this.halfWidth=this.width/2>>0}getPoints(){let r=this.matrix,t=[];for(let o=0;o<r.length;o++)for(let s=0;s<r[0].length;s++)r[o][s]&&t.push([s-this.halfWidth,o-this.halfHeight]);return t}getMask(){let r=new Image(this.width,this.height,{kind:BINARY});for(let t=0;t<this.matrix.length;t++)for(let o=0;o<this.matrix[0].length;o++)this.matrix[t][o]&&r.setBitXY(o,t);return r}}function rectangle(e,r,t){const o=zerosMatrix(r,e);if(t.filled)for(let s=0;s<r;s++)for(let d=0;d<e;d++)o[s][d]=1;else{for(let s of[0,r-1])for(let d=0;d<e;d++)o[s][d]=1;for(let s=0;s<r;s++)for(let d of[0,e-1])o[s][d]=1}return o}function ellipse(e,r,t){const o=zerosMatrix(r,e);let s=1-r%2,d=1-e%2,g=Math.floor((e-1)/2),a=Math.floor((r-1)/2),b=g*g,_=a*a;if(t.filled)for(let T=0;T<=a;T++){let C=Math.floor(Math.sqrt(b-b*T*T/_));for(let D=g-C;D<=g;D++)o[a-T][D]=1,o[a+T+s][D]=1,o[a-T][e-D-1]=1,o[a+T+s][e-D-1]=1}else{for(let T=0;T<=a;T++){let C=Math.floor(Math.sqrt(b-b*T*T/_)),D=g-C;o[a-T][D]=1,o[a+T+s][D]=1,o[a-T][e-D-1]=1,o[a+T+s][e-D-1]=1}for(let T=0;T<=g;T++){let C=Math.floor(Math.sqrt(_-_*T*T/b)),D=a-C;o[D][g-T]=1,o[D][g+T+d]=1,o[r-D-1][g-T]=1,o[r-D-1][g+T+d]=1}}return o}function triangle(e,r,t){if(!t.filled)throw new Error("Non filled triangle is not implemented");const o=zerosMatrix(r,e);for(let s=0;s<r;s++){let d=Math.floor((1-s/r)*e/2);for(let g=d;g<e-d;g++)o[s][g]=1}return o}function paintPoints(e,r={}){let{shape:t}=r;this.checkProcessable("paintPoints",{bitDepth:[8,16]});let o=getColors(Object.assign({},r,{numberColors:e.length})),s=new Shape(t).getPoints(),d=Math.min(this.channels,o[0].length);for(let g=0;g<e.length;g++){let a=o[g%o.length],b=e[g][0],_=e[g][1];for(let T=0;T<s.length;T++){let C=s[T][0],D=s[T][1];if(b+C>=0&&_+D>=0&&b+C<this.width&&_+D<this.height){let k=(b+C+(_+D)*this.width)*this.channels;for(let O=0;O<d;O++)this.data[k+O]=a[O]}}}return this}function paintPolyline(e,r={}){let{color:t=[this.maxValue,0,0],closed:o=!1}=r;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]});let s=Math.min(this.channels,t.length);for(let d=0;d<e.length-1+o;d++){let g=e[d],a=e[(d+1)%e.length],b=a[0]-g[0],_=a[1]-g[1],T=Math.max(Math.abs(b),Math.abs(_)),C=b/T,D=_/T,k=g[0],O=g[1];for(let U=0;U<=T;U++){let G=Math.round(k),j=Math.round(O);if(G>=0&&j>=0&&G<this.width&&j<this.height)if(this.bitDepth===1)this.setBitXY(G,j);else{let te=(G+j*this.width)*this.channels;for(let H=0;H<s;H++)this.data[te+H]=t[H]}k=k+C,O=O+D}}return this}function paintPolylines(e,r={}){let t=Object.assign({},r);this.checkProcessable("paintPolylines",{bitDepth:[8,16]});let o=getColors(Object.assign({},r,{numberColors:e.length}));for(let s=0;s<e.length;s++)t.color=o[s%o.length],this.paintPolyline(e[s],t);return this}function paintPolygon(e,r={}){let{color:t=[this.maxValue,0,0],filled:o=!1}=r;this.checkProcessable("paintPoints",{bitDepth:[1,8,16]}),r.closed=!0;let s=deleteDouble(e);if(o===!1)return this.paintPolyline(e,r);{let d=Array(this.height);for(let g=0;g<this.height;g++){d[g]=[];for(let a=0;a<this.width;a++)d[g].push(0)}for(let g=0;g<s.length;g++){const a=lineBetweenTwoPoints(s[g],s[(g+1)%s.length]);for(let b=0;b<this.height;b++)for(let _=0;_<this.width;_++)isAtTheRightOfTheLine(_,b,a,this.height)&&(d[b][_]=d[b][_]===0?1:0)}for(let g=0;g<this.height;g++)for(let a=0;a<this.width;a++)if(d[g][a]===1)if(this.bitDepth===1)this.setBitXY(a,g);else{let b=Math.min(this.channels,t.length),_=(a+g*this.width)*this.channels;for(let T=0;T<b;T++)this.data[_+T]=t[T]}return this.paintPolyline(e,r)}}function deleteDouble(e){let r=[];for(let t=0;t<e.length;t++)if(!(e[t][0]===e[(t+1)%e.length][0]&&e[t][1]===e[(t+1)%e.length][1])){if(e[t][0]===e[(t-1+e.length)%e.length][0]&&e[t][1]===e[(t-1+e.length)%e.length][1])continue;if(e[(t+1)%e.length][0]===e[(t-1+e.length)%e.length][0]&&e[(t-1+e.length)%e.length][1]===e[(t+1)%e.length][1])continue;r.push(e[t])}return r}function lineBetweenTwoPoints(e,r){if(e[0]===r[0])return{a:0,b:e[0],vertical:!0};{const t=(r[1]-e[1])/(r[0]-e[0]),o=e[1]-t*e[0];return{a:t,b:o,vertical:!1}}}function isAtTheRightOfTheLine(e,r,t,o){if(t.vertical===!0)return t.b<=e;if(t.a===0)return!1;{const s=(r-t.b)/t.a;return s<e&&s>=0&&s<=o}}function paintPolygons(e,r={}){let t=Object.assign({},r);this.checkProcessable("paintPolygons",{bitDepth:[8,16]});let o=getColors(Object.assign({},r,{numberColors:e.length}));for(let s=0;s<e.length;s++)t.color=o[s%o.length],this.paintPolygon(e[s],t);return this}function getHistogram(e={}){let{maxSlots:r=256,channel:t,useAlpha:o=!0}=e;if(this.checkProcessable("getHistogram",{bitDepth:[1,8,16]}),t===void 0){if(this.components>1)throw new RangeError("You need to define the channel for an image that contains more than one channel");t=0}return getChannelHistogram.call(this,t,{useAlpha:o,maxSlots:r})}function getHistograms(e={}){const{maxSlots:r=256,useAlpha:t=!0}=e;this.checkProcessable("getHistograms",{bitDepth:[8,16]});let o=new Array(t?this.components:this.channels);for(let s=0;s<o.length;s++)o[s]=getChannelHistogram.call(this,s,{useAlpha:t,maxSlots:r});return o}function getChannelHistogram(e,r){let{useAlpha:t,maxSlots:o}=r;if(this.bitDepth===1){let b=[0,0];for(let _=0;_<this.height;_++)for(let T=0;T<this.width;T++){let C=this.getBitXY(_,T);C===0?b[0]+=1:C===1&&(b[1]+=1)}return b}let s=Math.log2(o);if(!isInteger$1(s))throw new RangeError("maxSlots must be a power of 2, for example: 64, 256, 1024");let d=0;this.bitDepth>s&&(d=this.bitDepth-s);let g=this.data,a=newArray$1(Math.pow(2,Math.min(this.bitDepth,s)),0);if(t&&this.alpha){let b=this.channels-e-1;for(let _=e;_<g.length;_+=this.channels)a[g[_]>>d]+=g[_+b]/this.maxValue}else for(let b=e;b<g.length;b+=this.channels)a[g[b]>>d]++;return a}function getColorHistogram(e={}){let{useAlpha:r=!0,nbSlots:t=512}=e;this.checkProcessable("getColorHistogram",{bitDepth:[8,16],components:[3]});let o=Math.log(t)/Math.log(8);if(o!==Math.floor(o))throw new RangeError("nbSlots must be a power of 8. Usually 8, 64, 512 or 4096");let s=this.bitDepth-o,d=this.data,g=newArray$1(Math.pow(8,o),0),a=Math.pow(2,o*2),b=Math.pow(2,o);for(let _=0;_<d.length;_+=this.channels){let T=(d[_]>>s)*a+(d[_+1]>>s)*b+(d[_+2]>>s);r&&this.alpha?g[T]+=d[_+this.channels-1]/this.maxValue:g[T]++}return g}function min(){this.checkProcessable("min",{bitDepth:[8,16,32]});let e=newArray$1(this.channels,1/0);for(let r=0;r<this.data.length;r+=this.channels)for(let t=0;t<this.channels;t++)this.data[r+t]<e[t]&&(e[t]=this.data[r+t]);return e}function max(){this.checkProcessable("max",{bitDepth:[8,16,32]});let e=newArray$1(this.channels,-1/0);for(let r=0;r<this.data.length;r+=this.channels)for(let t=0;t<this.channels;t++)this.data[r+t]>e[t]&&(e[t]=this.data[r+t]);return e}function sum(){this.checkProcessable("sum",{bitDepth:[8,16]});let e=newArray$1(this.channels,0);for(let r=0;r<this.data.length;r+=this.channels)for(let t=0;t<this.channels;t++)e[t]+=this.data[r+t];return e}function getMoment(e=0,r=0){this.checkProcessable("getMoment",{bitDepth:[1]});let t=0;for(let o=0;o<this.width;o++)for(let s=0;s<this.height;s++)this.getBitXY(o,s)===1&&(t+=o**e*s**r);return t}function localMaxima(e={}){let{mask:r,region:t=3,removeClosePoints:o=0,invert:s=!1,maxEquals:d=2}=e,g=this;this.checkProcessable("localMaxima",{bitDepth:[8,16],components:1}),t*=4;let a=s?0:1,b=[1,0,-1,0,1,1,-1,-1,2,0,-2,0,2,2,-2,-2],_=[0,1,0,-1,1,-1,1,-1,0,2,0,-2,2,-2,2,-2],T=t<=8?1:2,C=[];for(let D=T;D<g.height-T;D++)for(let k=T;k<g.width-T;k++){if(r&&r.getBitXY(k,D)!==a)continue;let O=0,U=0,G=g.data[k+D*g.width];for(let j=0;j<t;j++)s?g.data[k+b[j]+(D+_[j])*g.width]>G&&O++:g.data[k+b[j]+(D+_[j])*g.width]<G&&O++,g.data[k+b[j]+(D+_[j])*g.width]===G&&U++;O+U===t&&U<=d&&C.push([k,D])}if(o>0)for(let D=0;D<C.length;D++)for(let k=D+1;k<C.length;k++)Math.sqrt(Math.pow(C[D][0]-C[k][0],2)+Math.pow(C[D][1]-C[k][1],2))<o&&(C[D][0]=C[D][0]+C[k][0]>>1,C[D][1]=C[D][1]+C[k][1]>>1,C.splice(k,1),k--);return C}function mean(){let e=this.getHistograms({maxSlots:this.maxValue+1}),r=new Array(e.length);for(let t=0;t<e.length;t++){let o=e[t];r[t]=mean$2(o)}return r}function median(){let e=this.getHistograms({maxSlots:this.maxValue+1}),r=new Array(e.length);for(let t=0;t<e.length;t++){let o=e[t];r[t]=median$2(o)}return r}function points(){this.checkProcessable("points",{bitDepth:[1]});const e=[];for(let r=0;r<this.width;r++)for(let t=0;t<this.height;t++)this.getBitXY(r,t)===1&&e.push([r,t]);return e}function extendedPoints(){this.checkProcessable("extendedPoints",{bitDepth:[1]});const e=[];for(let r=0;r<this.height;r++)for(let t=0;t<this.width;t++)if(this.getBitXY(t,r)===1)for(e.push([t,r]),this.getBitXY(t+1,r)!==1?(e.push([t+1,r]),e.push([t+1,r+1]),this.getBitXY(t,r+1)!==1&&e.push([t,r+1])):this.getBitXY(t,r+1)!==1&&(e.push([t,r+1]),e.push([t+1,r+1]));t<this.width-2&&this.getBitXY(t+1,r)===1&&this.getBitXY(t+2,r)===1;)t++;return e}function getRelativePosition(e,r={}){if(this===e)return[0,0];let t=[0,0],o=this;for(;o;){if(o===e)return t;o.position&&(t[0]+=o.position[0],t[1]+=o.position[1]),o=o.parent}return r.defaultFurther?t:!1}function countAlphaPixels(e={}){let{alpha:r=1}=e;this.checkProcessable("countAlphaPixels",{bitDepth:[8,16],alpha:1});let t=0;if(r!==void 0){for(let o=this.components;o<this.data.length;o+=this.channels)this.data[o]===r&&t++;return t}else return this.size}function monotoneChainConvexHull$1(e,r={}){const{sorted:t}=r;t||(e=e.slice().sort(byXThenY));const o=e.length,s=new Array(o*2);let d=0;for(let a=0;a<o;a++){const b=e[a];for(;d>=2&&cw(s[d-2],s[d-1],b)<=0;)d--;s[d++]=b}const g=d+1;for(let a=o-2;a>=0;a--){const b=e[a];for(;d>=g&&cw(s[d-2],s[d-1],b)<=0;)d--;s[d++]=b}return s.slice(0,d-1)}function cw(e,r,t){return(r[1]-e[1])*(t[0]-e[0])-(r[0]-e[0])*(t[1]-e[1])}function byXThenY(e,r){return e[0]===r[0]?e[1]-r[1]:e[0]-r[0]}function monotoneChainConvexHull(){return monotoneChainConvexHull$1(this.extendedPoints,{sorted:!1})}function round(e){for(let r=0;r<e.length;r++)e[r][0]=Math.round(e[r][0]),e[r][1]=Math.round(e[r][1]);return e}function difference(e,r){return[e[0]-r[0],e[1]-r[1]]}function normalize(e){let r=Math.sqrt(e[0]**2+e[1]**2);return[e[0]/r,e[1]/r]}function rotate(e,r,t){t===void 0&&(t=new Array(r.length));let o=Math.cos(e),s=Math.sin(e);for(let d=0;d<t.length;++d)t[d]=[o*r[d][0]-s*r[d][1],s*r[d][0]+o*r[d][1]];return t}function perimeter(e){let r=0;for(let t=0;t<e.length;t++){let o=e[t][0],s=e[t][1],d=e[t===e.length-1?0:t+1][0],g=e[t===e.length-1?0:t+1][1];r+=Math.sqrt((d-o)**2+(g-s)**2)}return r}function surface(e){let r=0;for(let t=0;t<e.length;t++){let o=e[t][0],s=e[t===e.length-1?0:t+1][1],d=e[t===e.length-1?0:t+1][0],g=e[t][1];r+=o*s*.5,r-=d*g*.5}return Math.abs(r)}function minMax(e){let r=1/0,t=1/0,o=-1/0,s=-1/0;for(let d=0;d<e.length;d++)e[d][0]<r&&(r=e[d][0]),e[d][0]>o&&(o=e[d][0]),e[d][1]<t&&(t=e[d][1]),e[d][1]>s&&(s=e[d][1]);return[[r,t],[o,s]]}function moveToZeroZero(e,r){r===void 0&&(r=new Array(e.length).fill(0).map(()=>[]));let t=minMax(e),o=t[0][0],s=t[0][1];for(let d=0;d<e.length;d++)r[d][0]=e[d][0]-o,r[d][1]=e[d][1]-s;return r}function minimalBoundingRectangle(e={}){const{originalPoints:r=monotoneChainConvexHull.call(this)}=e;if(r.length===0)return[];if(r.length===1)return[r[0],r[0],r[0],r[0]];const t=new Array(r.length);let o=1/0,s=0,d;for(let g=0;g<t.length;g++){let a=getAngle$1(r[g],r[(g+1)%t.length]);rotate(-a,r,t);let b=t[g][0],_=t[g][1],T=t[(g+1)%t.length][0],C=t[(g+1)%t.length][1],D=!0,k=0,O=0,U=0;for(let H=0;H<t.length;H++){let Z=t[H][0],W=t[H][1],_e=(Z-b)/(T-b);D===!0?(D=!1,k=_e,O=_e):(_e<k&&(k=_e),_e>O&&(O=_e));let fe=(-(T-b)*W+T*_-C*b)/(T-b);Math.abs(fe)>Math.abs(U)&&(U=fe)}let G=[b+k*(T-b),_],j=[b+O*(T-b),_],te=Math.abs(U*(k-O)*(T-b));te<o&&(s=a,o=te,d=[G,j,[j[0],j[1]-U],[G[0],G[1]-U]])}return rotate(s,d,d),d}function getAngle$1(e,r){let t=difference(r,e),o=normalize(t),s=Math.acos(o[0]);return o[1]<0?-s:s}function extend$4(e){let r={inPlace:!0};e.extendMethod("invert",invert),e.extendMethod("abs",abs),e.extendMethod("level",level,r),e.extendMethod("add",add,r),e.extendMethod("subtract",subtract,r),e.extendMethod("subtractImage",subtractImage),e.extendMethod("multiply",multiply,r),e.extendMethod("divide",divide,r),e.extendMethod("hypotenuse",hypotenuse),e.extendMethod("background",background$1),e.extendMethod("flipX",flipX),e.extendMethod("flipY",flipY),e.extendMethod("blurFilter",blurFilter),e.extendMethod("medianFilter",medianFilter),e.extendMethod("gaussianFilter",gaussianFilter),e.extendMethod("sobelFilter",sobelFilter),e.extendMethod("gradientFilter",gradientFilter),e.extendMethod("scharrFilter",scharrFilter),e.extendMethod("dilate",dilate),e.extendMethod("erode",erode),e.extendMethod("open",open),e.extendMethod("close",close),e.extendMethod("topHat",topHat),e.extendMethod("blackHat",blackHat),e.extendMethod("morphologicalGradient",morphologicalGradient),e.extendMethod("warpingFourPoints",warpingFourPoints),e.extendMethod("crop",crop),e.extendMethod("cropAlpha",cropAlpha),e.extendMethod("resize",resize).extendMethod("scale",resize),e.extendMethod("hsv",hsv),e.extendMethod("hsl",hsl$1),e.extendMethod("cmyk",cmyk),e.extendMethod("rgba8",rgba8),e.extendMethod("grey",grey).extendMethod("gray",grey),e.extendMethod("mask",mask),e.extendMethod("pad",pad),e.extendMethod("colorDepth",colorDepth),e.extendMethod("setBorder",setBorder,r),e.extendMethod("rotate",rotate$1),e.extendMethod("rotateLeft",rotateLeft),e.extendMethod("rotateRight",rotateRight),e.extendMethod("insert",insert),e.extendMethod("getRow",getRow),e.extendMethod("getColumn",getColumn),e.extendMethod("getMatrix",getMatrix),e.extendMethod("setMatrix",setMatrix),e.extendMethod("getPixelsArray",getPixelsArray),e.extendMethod("getIntersection",getIntersection),e.extendMethod("getClosestCommonParent",getClosestCommonParent),e.extendMethod("getThreshold",getThreshold),e.extendMethod("split",split),e.extendMethod("getChannel",getChannel),e.extendMethod("combineChannels",combineChannels),e.extendMethod("setChannel",setChannel),e.extendMethod("getSimilarity",getSimilarity),e.extendMethod("getPixelsGrid",getPixelsGrid),e.extendMethod("getBestMatch",getBestMatch),e.extendMethod("cannyEdge",cannyEdge),e.extendMethod("convolution",convolution),e.extendMethod("extract",extract),e.extendMethod("floodFill",floodFill),e.extendMethod("paintLabels",paintLabels,r),e.extendMethod("paintMasks",paintMasks,r),e.extendMethod("paintPoints",paintPoints,r),e.extendMethod("paintPolyline",paintPolyline,r),e.extendMethod("paintPolylines",paintPolylines,r),e.extendMethod("paintPolygon",paintPolygon,r),e.extendMethod("paintPolygons",paintPolygons,r),e.extendMethod("countAlphaPixels",countAlphaPixels),e.extendMethod("monotoneChainConvexHull",monotoneChainConvexHull),e.extendMethod("minimalBoundingRectangle",minimalBoundingRectangle),e.extendMethod("getHistogram",getHistogram).extendProperty("histogram",getHistogram),e.extendMethod("getHistograms",getHistograms).extendProperty("histograms",getHistograms),e.extendMethod("getColorHistogram",getColorHistogram).extendProperty("colorHistogram",getColorHistogram),e.extendMethod("getMin",min).extendProperty("min",min),e.extendMethod("getMax",max).extendProperty("max",max),e.extendMethod("getSum",sum).extendProperty("sum",sum),e.extendMethod("getMoment",getMoment).extendProperty("moment",getMoment),e.extendMethod("getLocalMaxima",localMaxima),e.extendMethod("getMedian",median).extendProperty("median",median),e.extendMethod("getMean",mean).extendProperty("mean",mean),e.extendMethod("getPoints",points).extendProperty("points",points),e.extendMethod("getExtendedPoints",extendedPoints).extendProperty("extendedPoints",extendedPoints),e.extendMethod("getRelativePosition",getRelativePosition)}var quantities={exports:{}};(function(e,r){(function(t,o){e.exports=o()})(commonjsGlobal,function(){function t(he){return typeof he=="string"||he instanceof String}var o=Number.isFinite||window.isFinite;function s(he){return o(he)}function d(he){return he}function g(he){var Oe={};return he.filter(function(He){return Oe.hasOwnProperty(He)?!1:Oe[He]=!0})}function a(he,Oe){if(Oe.length!==he.length)return!1;for(var He=0;He<he.length;He++)if(Oe[He].compareArray&&!Oe[He].compareArray(he[He])||Oe[He]!==he[He])return!1;return!0}function b(he,Oe){Object.keys(Oe).forEach(function(He){he[He]=Oe[He]})}function _(){for(var he=1,Oe=0,He=0;He<arguments.length;He++){var Tt=arguments[He];Oe=Oe+D(Tt),he*=Tt}return Oe!==0?C(he,Oe):he}function T(he,Oe){if(Oe===0)throw new Error("Divide by zero");var He=Math.pow(10,D(Oe)),Tt=He/(He*Oe);return _(he,Tt)}function C(he,Oe){return Math.round(he*Math.pow(10,Oe))/Math.pow(10,Oe)}function D(he){if(!isFinite(he))return 0;for(var Oe=0;he%1!==0;)he*=10,Oe++;return Oe}function k(){var he;if(!this)return he=Object.create(k.prototype),k.apply(he,arguments),he;he=Error.apply(this,arguments),this.name="QtyError",this.message=he.message,this.stack=he.stack}k.prototype=Object.create(Error.prototype,{constructor:{value:k}});function O(he,Oe){throw new k("Incompatible units: "+he+" and "+Oe)}var U={"<googol>":[["googol"],1e100,"prefix"],"<kibi>":[["Ki","Kibi","kibi"],Math.pow(2,10),"prefix"],"<mebi>":[["Mi","Mebi","mebi"],Math.pow(2,20),"prefix"],"<gibi>":[["Gi","Gibi","gibi"],Math.pow(2,30),"prefix"],"<tebi>":[["Ti","Tebi","tebi"],Math.pow(2,40),"prefix"],"<pebi>":[["Pi","Pebi","pebi"],Math.pow(2,50),"prefix"],"<exi>":[["Ei","Exi","exi"],Math.pow(2,60),"prefix"],"<zebi>":[["Zi","Zebi","zebi"],Math.pow(2,70),"prefix"],"<yebi>":[["Yi","Yebi","yebi"],Math.pow(2,80),"prefix"],"<yotta>":[["Y","Yotta","yotta"],1e24,"prefix"],"<zetta>":[["Z","Zetta","zetta"],1e21,"prefix"],"<exa>":[["E","Exa","exa"],1e18,"prefix"],"<peta>":[["P","Peta","peta"],1e15,"prefix"],"<tera>":[["T","Tera","tera"],1e12,"prefix"],"<giga>":[["G","Giga","giga"],1e9,"prefix"],"<mega>":[["M","Mega","mega"],1e6,"prefix"],"<kilo>":[["k","kilo"],1e3,"prefix"],"<hecto>":[["h","Hecto","hecto"],100,"prefix"],"<deca>":[["da","Deca","deca","deka"],10,"prefix"],"<deci>":[["d","Deci","deci"],.1,"prefix"],"<centi>":[["c","Centi","centi"],.01,"prefix"],"<milli>":[["m","Milli","milli"],.001,"prefix"],"<micro>":[["u","μ","µ","Micro","mc","micro"],1e-6,"prefix"],"<nano>":[["n","Nano","nano"],1e-9,"prefix"],"<pico>":[["p","Pico","pico"],1e-12,"prefix"],"<femto>":[["f","Femto","femto"],1e-15,"prefix"],"<atto>":[["a","Atto","atto"],1e-18,"prefix"],"<zepto>":[["z","Zepto","zepto"],1e-21,"prefix"],"<yocto>":[["y","Yocto","yocto"],1e-24,"prefix"],"<1>":[["1","<1>"],1,""],"<meter>":[["m","meter","meters","metre","metres"],1,"length",["<meter>"]],"<inch>":[["in","inch","inches",'"'],.0254,"length",["<meter>"]],"<foot>":[["ft","foot","feet","'"],.3048,"length",["<meter>"]],"<yard>":[["yd","yard","yards"],.9144,"length",["<meter>"]],"<mile>":[["mi","mile","miles"],1609.344,"length",["<meter>"]],"<naut-mile>":[["nmi","naut-mile"],1852,"length",["<meter>"]],"<league>":[["league","leagues"],4828,"length",["<meter>"]],"<furlong>":[["furlong","furlongs"],201.2,"length",["<meter>"]],"<rod>":[["rd","rod","rods"],5.029,"length",["<meter>"]],"<mil>":[["mil","mils"],254e-7,"length",["<meter>"]],"<angstrom>":[["ang","angstrom","angstroms"],1e-10,"length",["<meter>"]],"<fathom>":[["fathom","fathoms"],1.829,"length",["<meter>"]],"<pica>":[["pica","picas"],.00423333333,"length",["<meter>"]],"<point>":[["pt","point","points"],.000352777778,"length",["<meter>"]],"<redshift>":[["z","red-shift","redshift"],1302773e20,"length",["<meter>"]],"<AU>":[["AU","astronomical-unit"],1495979e5,"length",["<meter>"]],"<light-second>":[["ls","light-second"],299792500,"length",["<meter>"]],"<light-minute>":[["lmin","light-minute"],1798755e4,"length",["<meter>"]],"<light-year>":[["ly","light-year"],9460528e9,"length",["<meter>"]],"<parsec>":[["pc","parsec","parsecs"],3085678e10,"length",["<meter>"]],"<datamile>":[["DM","datamile"],1828.8,"length",["<meter>"]],"<kilogram>":[["kg","kilogram","kilograms"],1,"mass",["<kilogram>"]],"<AMU>":[["u","AMU","amu"],1660538921e-36,"mass",["<kilogram>"]],"<dalton>":[["Da","Dalton","Daltons","dalton","daltons"],1660538921e-36,"mass",["<kilogram>"]],"<slug>":[["slug","slugs"],14.5939029,"mass",["<kilogram>"]],"<short-ton>":[["tn","ton","short-ton"],907.18474,"mass",["<kilogram>"]],"<metric-ton>":[["tonne","metric-ton"],1e3,"mass",["<kilogram>"]],"<carat>":[["ct","carat","carats"],2e-4,"mass",["<kilogram>"]],"<pound>":[["lbs","lb","pound","pounds","#"],.45359237,"mass",["<kilogram>"]],"<ounce>":[["oz","ounce","ounces"],.0283495231,"mass",["<kilogram>"]],"<gram>":[["g","gram","grams","gramme","grammes"],.001,"mass",["<kilogram>"]],"<grain>":[["grain","grains","gr"],6479891e-11,"mass",["<kilogram>"]],"<dram>":[["dram","drams","dr"],.0017718452,"mass",["<kilogram>"]],"<stone>":[["stone","stones","st"],6.35029318,"mass",["<kilogram>"]],"<hectare>":[["hectare"],1e4,"area",["<meter>","<meter>"]],"<acre>":[["acre","acres"],4046.85642,"area",["<meter>","<meter>"]],"<sqft>":[["sqft"],1,"area",["<foot>","<foot>"]],"<liter>":[["l","L","liter","liters","litre","litres"],.001,"volume",["<meter>","<meter>","<meter>"]],"<gallon>":[["gal","gallon","gallons"],.0037854118,"volume",["<meter>","<meter>","<meter>"]],"<gallon-imp>":[["galimp","gallon-imp","gallons-imp"],.00454609,"volume",["<meter>","<meter>","<meter>"]],"<quart>":[["qt","quart","quarts"],.00094635295,"volume",["<meter>","<meter>","<meter>"]],"<pint>":[["pt","pint","pints"],.000473176475,"volume",["<meter>","<meter>","<meter>"]],"<pint-imp>":[["ptimp","pint-imp","pints-imp"],.00056826125,"volume",["<meter>","<meter>","<meter>"]],"<cup>":[["cu","cup","cups"],.000236588238,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce>":[["floz","fluid-ounce","fluid-ounces"],295735297e-13,"volume",["<meter>","<meter>","<meter>"]],"<fluid-ounce-imp>":[["flozimp","floz-imp","fluid-ounce-imp","fluid-ounces-imp"],284130625e-13,"volume",["<meter>","<meter>","<meter>"]],"<tablespoon>":[["tb","tbsp","tbs","tablespoon","tablespoons"],147867648e-13,"volume",["<meter>","<meter>","<meter>"]],"<teaspoon>":[["tsp","teaspoon","teaspoons"],492892161e-14,"volume",["<meter>","<meter>","<meter>"]],"<bushel>":[["bu","bsh","bushel","bushels"],.035239072,"volume",["<meter>","<meter>","<meter>"]],"<oilbarrel>":[["bbl","oilbarrel","oilbarrels","oil-barrel","oil-barrels"],.158987294928,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel>":[["bl","bl-us","beerbarrel","beerbarrels","beer-barrel","beer-barrels"],.1173477658,"volume",["<meter>","<meter>","<meter>"]],"<beerbarrel-imp>":[["blimp","bl-imp","beerbarrel-imp","beerbarrels-imp","beer-barrel-imp","beer-barrels-imp"],.16365924,"volume",["<meter>","<meter>","<meter>"]],"<kph>":[["kph"],.277777778,"speed",["<meter>"],["<second>"]],"<mph>":[["mph"],.44704,"speed",["<meter>"],["<second>"]],"<knot>":[["kt","kn","kts","knot","knots"],.514444444,"speed",["<meter>"],["<second>"]],"<fps>":[["fps"],.3048,"speed",["<meter>"],["<second>"]],"<gee>":[["gee"],9.80665,"acceleration",["<meter>"],["<second>","<second>"]],"<Gal>":[["Gal"],.01,"acceleration",["<meter>"],["<second>","<second>"]],"<kelvin>":[["degK","kelvin"],1,"temperature",["<kelvin>"]],"<celsius>":[["degC","celsius","celsius","centigrade"],1,"temperature",["<kelvin>"]],"<fahrenheit>":[["degF","fahrenheit"],5/9,"temperature",["<kelvin>"]],"<rankine>":[["degR","rankine"],5/9,"temperature",["<kelvin>"]],"<temp-K>":[["tempK","temp-K"],1,"temperature",["<temp-K>"]],"<temp-C>":[["tempC","temp-C"],1,"temperature",["<temp-K>"]],"<temp-F>":[["tempF","temp-F"],5/9,"temperature",["<temp-K>"]],"<temp-R>":[["tempR","temp-R"],5/9,"temperature",["<temp-K>"]],"<second>":[["s","sec","secs","second","seconds"],1,"time",["<second>"]],"<minute>":[["min","mins","minute","minutes"],60,"time",["<second>"]],"<hour>":[["h","hr","hrs","hour","hours"],3600,"time",["<second>"]],"<day>":[["d","day","days"],3600*24,"time",["<second>"]],"<week>":[["wk","week","weeks"],7*3600*24,"time",["<second>"]],"<fortnight>":[["fortnight","fortnights"],1209600,"time",["<second>"]],"<year>":[["y","yr","year","years","annum"],31556926,"time",["<second>"]],"<decade>":[["decade","decades"],315569260,"time",["<second>"]],"<century>":[["century","centuries"],3155692600,"time",["<second>"]],"<pascal>":[["Pa","pascal","Pascal"],1,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<bar>":[["bar","bars"],1e5,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<mmHg>":[["mmHg"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inHg>":[["inHg"],3386.3881472,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<torr>":[["torr"],133.322368,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<atm>":[["atm","ATM","atmosphere","atmospheres"],101325,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<psi>":[["psi"],6894.76,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<cmh2o>":[["cmH2O","cmh2o"],98.0638,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<inh2o>":[["inH2O","inh2o"],249.082052,"pressure",["<kilogram>"],["<meter>","<second>","<second>"]],"<poise>":[["P","poise"],.1,"viscosity",["<kilogram>"],["<meter>","<second>"]],"<stokes>":[["St","stokes"],1e-4,"viscosity",["<meter>","<meter>"],["<second>"]],"<mole>":[["mol","mole"],1,"substance",["<mole>"]],"<molar>":[["M","molar"],1e3,"concentration",["<mole>"],["<meter>","<meter>","<meter>"]],"<wtpercent>":[["wt%","wtpercent"],10,"concentration",["<kilogram>"],["<meter>","<meter>","<meter>"]],"<katal>":[["kat","katal","Katal"],1,"activity",["<mole>"],["<second>"]],"<unit>":[["U","enzUnit","unit"],16667e-19,"activity",["<mole>"],["<second>"]],"<farad>":[["F","farad","Farad"],1,"capacitance",["<second>","<second>","<second>","<second>","<ampere>","<ampere>"],["<meter>","<meter>","<kilogram>"]],"<coulomb>":[["C","coulomb","Coulomb"],1,"charge",["<ampere>","<second>"]],"<Ah>":[["Ah"],3600,"charge",["<ampere>","<second>"]],"<ampere>":[["A","Ampere","ampere","amp","amps"],1,"current",["<ampere>"]],"<siemens>":[["S","Siemens","siemens"],1,"conductance",["<second>","<second>","<second>","<ampere>","<ampere>"],["<kilogram>","<meter>","<meter>"]],"<henry>":[["H","Henry","henry"],1,"inductance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>","<ampere>"]],"<volt>":[["V","Volt","volt","volts"],1,"potential",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>"]],"<ohm>":[["Ohm","ohm","Ω","Ω"],1,"resistance",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<second>","<ampere>","<ampere>"]],"<weber>":[["Wb","weber","webers"],1,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<tesla>":[["T","tesla","teslas"],1,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<gauss>":[["G","gauss"],1e-4,"magnetism",["<kilogram>"],["<second>","<second>","<ampere>"]],"<maxwell>":[["Mx","maxwell","maxwells"],1e-8,"magnetism",["<meter>","<meter>","<kilogram>"],["<second>","<second>","<ampere>"]],"<oersted>":[["Oe","oersted","oersteds"],250/Math.PI,"magnetism",["<ampere>"],["<meter>"]],"<joule>":[["J","joule","Joule","joules"],1,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<erg>":[["erg","ergs"],1e-7,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<btu>":[["BTU","btu","BTUs"],1055.056,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<calorie>":[["cal","calorie","calories"],4.184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Calorie>":[["Cal","Calorie","Calories"],4184,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<therm-US>":[["th","therm","therms","Therm","therm-US"],105480400,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<Wh>":[["Wh"],3600,"energy",["<meter>","<meter>","<kilogram>"],["<second>","<second>"]],"<newton>":[["N","Newton","newton"],1,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<dyne>":[["dyn","dyne"],1e-5,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<pound-force>":[["lbf","pound-force"],4.448222,"force",["<kilogram>","<meter>"],["<second>","<second>"]],"<hertz>":[["Hz","hertz","Hertz"],1,"frequency",["<1>"],["<second>"]],"<radian>":[["rad","radian","radians"],1,"angle",["<radian>"]],"<degree>":[["deg","degree","degrees"],Math.PI/180,"angle",["<radian>"]],"<gradian>":[["gon","grad","gradian","grads"],Math.PI/200,"angle",["<radian>"]],"<steradian>":[["sr","steradian","steradians"],1,"solid_angle",["<steradian>"]],"<rotation>":[["rotation"],2*Math.PI,"angle",["<radian>"]],"<rpm>":[["rpm"],2*Math.PI/60,"angular_velocity",["<radian>"],["<second>"]],"<byte>":[["B","byte","bytes"],1,"information",["<byte>"]],"<bit>":[["b","bit","bits"],.125,"information",["<byte>"]],"<Bps>":[["Bps"],1,"information_rate",["<byte>"],["<second>"]],"<bps>":[["bps"],.125,"information_rate",["<byte>"],["<second>"]],"<dollar>":[["USD","dollar"],1,"currency",["<dollar>"]],"<cents>":[["cents"],.01,"currency",["<dollar>"]],"<candela>":[["cd","candela"],1,"luminosity",["<candela>"]],"<lumen>":[["lm","lumen"],1,"luminous_power",["<candela>","<steradian>"]],"<lux>":[["lux"],1,"illuminance",["<candela>","<steradian>"],["<meter>","<meter>"]],"<watt>":[["W","watt","watts"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere>":[["VA","volt-ampere"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<volt-ampere-reactive>":[["var","Var","VAr","VAR","volt-ampere-reactive"],1,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<horsepower>":[["hp","horsepower"],745.699872,"power",["<kilogram>","<meter>","<meter>"],["<second>","<second>","<second>"]],"<gray>":[["Gy","gray","grays"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<roentgen>":[["R","roentgen"],.00933,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<sievert>":[["Sv","sievert","sieverts"],1,"radiation",["<meter>","<meter>"],["<second>","<second>"]],"<becquerel>":[["Bq","becquerel","becquerels"],1,"radiation",["<1>"],["<second>"]],"<curie>":[["Ci","curie","curies"],37e9,"radiation",["<1>"],["<second>"]],"<cpm>":[["cpm"],1/60,"rate",["<count>"],["<second>"]],"<dpm>":[["dpm"],1/60,"rate",["<count>"],["<second>"]],"<bpm>":[["bpm"],1/60,"rate",["<count>"],["<second>"]],"<dot>":[["dot","dots"],1,"resolution",["<each>"]],"<pixel>":[["pixel","px"],1,"resolution",["<each>"]],"<ppi>":[["ppi"],1,"resolution",["<pixel>"],["<inch>"]],"<dpi>":[["dpi"],1,"typography",["<dot>"],["<inch>"]],"<cell>":[["cells","cell"],1,"counting",["<each>"]],"<each>":[["each"],1,"counting",["<each>"]],"<count>":[["count"],1,"counting",["<each>"]],"<base-pair>":[["bp","base-pair"],1,"counting",["<each>"]],"<nucleotide>":[["nt","nucleotide"],1,"counting",["<each>"]],"<molecule>":[["molecule","molecules"],1,"counting",["<1>"]],"<dozen>":[["doz","dz","dozen"],12,"prefix_only",["<each>"]],"<percent>":[["%","percent"],.01,"prefix_only",["<1>"]],"<ppm>":[["ppm"],1e-6,"prefix_only",["<1>"]],"<ppt>":[["ppt"],1e-9,"prefix_only",["<1>"]],"<gross>":[["gr","gross"],144,"prefix_only",["<dozen>","<dozen>"]],"<decibel>":[["dB","decibel","decibels"],1,"logarithmic",["<decibel>"]]},G=["<meter>","<kilogram>","<second>","<mole>","<ampere>","<radian>","<kelvin>","<temp-K>","<byte>","<dollar>","<candela>","<each>","<steradian>","<decibel>"],j="<1>",te=[j];function H(he,Oe){var He=Oe[1],Tt=Oe[3]||[],le=Oe[4]||[];if(!s(He))throw new k(he+": Invalid unit definition. 'scalar' must be a number");Tt.forEach(function(Q){if(U[Q]===void 0)throw new k(he+": Invalid unit definition. Unit "+Q+" in 'numerator' is not recognized")}),le.forEach(function(Q){if(U[Q]===void 0)throw new k(he+": Invalid unit definition. Unit "+Q+" in 'denominator' is not recognized")})}var Z={},W={},_e={},fe={},re={};for(var ae in U)if(U.hasOwnProperty(ae)){var J=U[ae];if(J[2]==="prefix"){Z[ae]=J[1];for(var se=0;se<J[0].length;se++)W[J[0][se]]=ae}else{H(ae,J),_e[ae]={scalar:J[1],numerator:J[3],denominator:J[4]};for(var Me=0;Me<J[0].length;Me++)fe[J[0][Me]]=ae}re[ae]=J[0][0]}function Ie(he){var Oe,He=[],Tt=Object.keys(U);if(typeof he>"u")for(Oe=0;Oe<Tt.length;Oe++)["","prefix"].indexOf(U[Tt[Oe]][2])===-1&&He.push(Tt[Oe].substr(1,Tt[Oe].length-2));else{if(this.getKinds().indexOf(he)===-1)throw new k("Kind not recognized");for(Oe=0;Oe<Tt.length;Oe++)U[Tt[Oe]][2]===he&&He.push(Tt[Oe].substr(1,Tt[Oe].length-2))}return He.sort(function(le,Q){return le.toLowerCase()<Q.toLowerCase()?-1:le.toLowerCase()>Q.toLowerCase()?1:0})}function We(he){if(!fe[he])throw new k("Unit not recognized");return U[fe[he]][0]}var Ge=["length","time","temperature","mass","current","substance","luminosity","currency","information","angle"];function qt(){if(this.signature)return this.signature;for(var he=ti.call(this),Oe=0;Oe<he.length;Oe++)he[Oe]*=Math.pow(20,Oe);return he.reduce(function(He,Tt){return He+Tt},0)}function ti(){if(!this.isBase())return ti.call(this.toBase());for(var he=new Array(Ge.length),Oe=0;Oe<he.length;Oe++)he[Oe]=0;for(var He,Tt,le=0;le<this.numerator.length;le++)(He=U[this.numerator[le]])&&(Tt=Ge.indexOf(He[2]),Tt>=0&&(he[Tt]=he[Tt]+1));for(var Q=0;Q<this.denominator.length;Q++)(He=U[this.denominator[Q]])&&(Tt=Ge.indexOf(He[2]),Tt>=0&&(he[Tt]=he[Tt]-1));return he}var Ut="[+-]",Qt="\\d+",tt=Ut+"?"+Qt,nt="\\."+Qt,Mt="(?:"+Qt+"(?:"+nt+")?)|(?:"+nt+")",ht="[Ee]"+tt,xt="(?:"+Mt+")(?:"+ht+")?",It=Ut+"?\\s*"+xt,Et="("+It+")?\\s*([^/]*)(?:/(.+))?",yt=new RegExp("^"+Et+"$"),Bt="\\^|\\*{2}",_t="[01234]",si=new RegExp("([^ \\*\\d]+?)(?:"+Bt+")?(-?"+_t+"(?![a-zA-Z]))"),Li=new RegExp("([^ \\*\\d]+?)(?:"+Bt+")?("+_t+"(?![a-zA-Z]))");function vi(he){t(he)||(he=he.toString()),he=he.trim();var Oe=yt.exec(he);if(!Oe)throw new k(he+": Quantity not recognized");var He=Oe[1];He?(He=He.replace(/\s/g,""),this.scalar=parseFloat(He)):this.scalar=1;for(var Tt=Oe[2],le=Oe[3],Q,ne,me;Oe=si.exec(Tt);){if(Q=parseFloat(Oe[2]),isNaN(Q))throw new k("Unit exponent is not a number");if(Q===0&&!Di.test(Oe[1]))throw new k("Unit not recognized");ne=Oe[1]+" ",me="";for(var we=0;we<Math.abs(Q);we++)me+=ne;Q>=0?Tt=Tt.replace(Oe[0],me):(le=le?le+me:me,Tt=Tt.replace(Oe[0],""))}for(;Oe=Li.exec(le);){if(Q=parseFloat(Oe[2]),isNaN(Q))throw new k("Unit exponent is not a number");if(Q===0&&!Di.test(Oe[1]))throw new k("Unit not recognized");ne=Oe[1]+" ",me="";for(var Pe=0;Pe<Q;Pe++)me+=ne;le=le.replace(Oe[0],me)}Tt&&(this.numerator=ei(Tt.trim())),le&&(this.denominator=ei(le.trim()))}var ci=Object.keys(W).sort(function(he,Oe){return Oe.length-he.length}).join("|"),mt=Object.keys(fe).sort(function(he,Oe){return Oe.length-he.length}).join("|"),$t="\\b|$",Mi="("+ci+")??("+mt+")(?:"+$t+")",Di=new RegExp("^\\s*("+Mi+"[\\s\\*]*)+$"),Ci=new RegExp(Mi,"g"),dt={};function ei(he){var Oe=dt[he];if(Oe)return Oe;var He,Tt=[];if(!Di.test(he))throw new k("Unit not recognized");for(;He=Ci.exec(he);)Tt.push(He.slice(1));return Tt=Tt.map(function(le){return W[le[0]]?[W[le[0]],fe[le[1]]]:[fe[le[1]]]}),Tt=Tt.reduce(function(le,Q){return le.concat(Q)},[]),Tt=Tt.filter(function(le){return le}),dt[he]=Tt,Tt}function ct(he){if(!t(he))throw new k("Argument should be a string");try{return this(he)}catch{return null}}function Ct(he){return he instanceof Be}function Be(he,Oe){if(Xt.apply(null,arguments),!Ct(this))return new Be(he,Oe);if(this.scalar=null,this.baseScalar=null,this.signature=null,this._conversionCache={},this.numerator=te,this.denominator=te,ni(he)?(this.scalar=he.scalar,this.numerator=he.numerator&&he.numerator.length!==0?he.numerator:te,this.denominator=he.denominator&&he.denominator.length!==0?he.denominator:te):Oe?(vi.call(this,Oe),this.scalar=he):vi.call(this,he),this.denominator.join("*").indexOf("temp")>=0)throw new k("Cannot divide with temperatures");if(this.numerator.join("*").indexOf("temp")>=0){if(this.numerator.length>1)throw new k("Cannot multiply by temperatures");if(!a(this.denominator,te))throw new k("Cannot divide with temperatures")}if(this.initValue=he,Vt.call(this),this.isTemperature()&&this.baseScalar<0)throw new k("Temperatures must not be less than absolute zero")}Be.prototype={constructor:Be};function Xt(he,Oe){if(Oe){if(!(s(he)&&t(Oe)))throw new k("Only number accepted as initialization value when units are explicitly provided")}else if(!(t(he)||s(he)||Ct(he)||ni(he)))throw new k("Only string, number or quantity accepted as single initialization value")}function ni(he){return he&&typeof he=="object"&&he.hasOwnProperty("scalar")}function Vt(){if(this.baseScalar)return this.baseScalar;if(this.isBase())this.baseScalar=this.scalar,this.signature=qt.call(this);else{var he=this.toBase();this.baseScalar=he.scalar,this.signature=he.signature}}var Nt={"-312078":"elastance","-312058":"resistance","-312038":"inductance","-152058":"potential","-152040":"magnetism","-152038":"magnetism","-7997":"specific_volume","-79":"snap","-59":"jolt","-39":"acceleration","-38":"radiation","-20":"frequency","-19":"speed","-18":"viscosity","-17":"volumetric_flow","-1":"wavenumber",0:"unitless",1:"length",2:"area",3:"volume",20:"time",400:"temperature",7941:"yank",7942:"power",7959:"pressure",7961:"force",7962:"energy",7979:"viscosity",7981:"momentum",7982:"angular_momentum",7997:"density",7998:"area_density",8e3:"mass",152020:"radiation_exposure",159999:"magnetism",16e4:"current",160020:"charge",312058:"conductance",312078:"capacitance",3199980:"activity",3199997:"molar_concentration",32e5:"substance",63999998:"illuminance",64e6:"luminous_power",128e7:"currency","25599999980":"information_rate","25600000000":"information","511999999980":"angular_velocity","512000000000":"angle"};function mi(){return g(Object.keys(Nt).map(function(he){return Nt[he]}))}Be.prototype.kind=function(){return Nt[this.signature.toString()]},b(Be.prototype,{isDegrees:function(){return(this.signature===null||this.signature===400)&&this.numerator.length===1&&a(this.denominator,te)&&(this.numerator[0].match(/<temp-[CFRK]>/)||this.numerator[0].match(/<(kelvin|celsius|rankine|fahrenheit)>/))},isTemperature:function(){return this.isDegrees()&&this.numerator[0].match(/<temp-[CFRK]>/)}});function ii(he,Oe){var He=he.units(),Tt=Oe.to(He),le=Be(Ri(He));return Be({scalar:he.scalar-Tt.scalar,numerator:le.numerator,denominator:le.denominator})}function Ii(he,Oe){var He=Oe.to(Ri(he.units()));return Be({scalar:he.scalar-He.scalar,numerator:he.numerator,denominator:he.denominator})}function $i(he,Oe){var He=Oe.to(Ri(he.units()));return Be({scalar:he.scalar+He.scalar,numerator:he.numerator,denominator:he.denominator})}function Ri(he){if(he==="tempK")return"degK";if(he==="tempC")return"degC";if(he==="tempF")return"degF";if(he==="tempR")return"degR";throw new k("Unknown type for temp conversion from: "+he)}function Ni(he,Oe){var He=zi(he),Tt=Oe.units(),le;if(Tt==="degK")le=He.scalar;else if(Tt==="degC")le=He.scalar;else if(Tt==="degF")le=He.scalar*9/5;else if(Tt==="degR")le=He.scalar*9/5;else throw new k("Unknown type for degree conversion to: "+Tt);return Be({scalar:le,numerator:Oe.numerator,denominator:Oe.denominator})}function zi(he){var Oe=he.units(),He;if(Oe.match(/(deg)[CFRK]/))He=he.baseScalar;else if(Oe==="tempK")He=he.scalar;else if(Oe==="tempC")He=he.scalar;else if(Oe==="tempF")He=he.scalar*5/9;else if(Oe==="tempR")He=he.scalar*5/9;else throw new k("Unknown type for temp conversion from: "+Oe);return Be({scalar:He,numerator:["<kelvin>"],denominator:te})}function Ki(he,Oe){var He=Oe.units(),Tt;if(He==="tempK")Tt=he.baseScalar;else if(He==="tempC")Tt=he.baseScalar-273.15;else if(He==="tempF")Tt=he.baseScalar*9/5-459.67;else if(He==="tempR")Tt=he.baseScalar*9/5;else throw new k("Unknown type for temp conversion to: "+He);return Be({scalar:Tt,numerator:Oe.numerator,denominator:Oe.denominator})}function _r(he){var Oe=he.units(),He;if(Oe.match(/(deg)[CFRK]/))He=he.baseScalar;else if(Oe==="tempK")He=he.scalar;else if(Oe==="tempC")He=he.scalar+273.15;else if(Oe==="tempF")He=(he.scalar+459.67)*5/9;else if(Oe==="tempR")He=he.scalar*5/9;else throw new k("Unknown type for temp conversion from: "+Oe);return Be({scalar:He,numerator:["<temp-K>"],denominator:te})}b(Be.prototype,{to:function(he){var Oe,He;if(he==null)return this;if(!t(he))return this.to(he.units());if(Oe=this._conversionCache[he],Oe)return Oe;if(He=Be(he),He.units()===this.units())return this;if(!this.isCompatible(He))this.isInverse(He)?He=this.inverse().to(he):O(this.units(),He.units());else if(He.isTemperature())He=Ki(this,He);else if(He.isDegrees())He=Ni(this,He);else{var Tt=T(this.baseScalar,He.baseScalar);He=Be({scalar:Tt,numerator:He.numerator,denominator:He.denominator})}return this._conversionCache[he]=He,He},toBase:function(){if(this.isBase())return this;if(this.isTemperature())return _r(this);var he=ur[this.units()];return he||(he=Ur(this.numerator,this.denominator),ur[this.units()]=he),he.mul(this.scalar)},toFloat:function(){if(this.isUnitless())return this.scalar;throw new k("Can't convert to Float unless unitless.  Use Unit#scalar")},toPrec:function(he){if(t(he)&&(he=Be(he)),s(he)&&(he=Be(he+" "+this.units())),this.isUnitless()?he.isUnitless()||O(this.units(),he.units()):he=he.to(this.units()),he.scalar===0)throw new k("Divide by zero");var Oe=_(Math.round(this.scalar/he.scalar),he.scalar);return Be(Oe+this.units())}});function cr(he,Oe){var He=Be(he),Tt=Be(Oe);if(He.eq(Tt))return d;var le;return He.isTemperature()?le=function(Q){return He.mul(Q).to(Tt).scalar}:le=function(Q){return Q*He.baseScalar/Tt.baseScalar},function(ne){var me,we,Pe;if(Array.isArray(ne)){for(we=ne.length,Pe=[],me=0;me<we;me++)Pe.push(le(ne[me]));return Pe}else return le(ne)}}var ur={};function Ur(he,Oe){for(var He=[],Tt=[],le=1,Q,ne=0;ne<he.length;ne++)Q=he[ne],Z[Q]?le=_(le,Z[Q]):_e[Q]&&(le*=_e[Q].scalar,_e[Q].numerator&&He.push(_e[Q].numerator),_e[Q].denominator&&Tt.push(_e[Q].denominator));for(var me=0;me<Oe.length;me++)Q=Oe[me],Z[Q]?le/=Z[Q]:_e[Q]&&(le/=_e[Q].scalar,_e[Q].numerator&&Tt.push(_e[Q].numerator),_e[Q].denominator&&He.push(_e[Q].denominator));return He=He.reduce(function(we,Pe){return we.concat(Pe)},[]),Tt=Tt.reduce(function(we,Pe){return we.concat(Pe)},[]),Be({scalar:le,numerator:He,denominator:Tt})}Be.parse=ct,Be.getUnits=Ie,Be.getAliases=We,Be.mulSafe=_,Be.divSafe=T,Be.getKinds=mi,Be.swiftConverter=cr,Be.Error=k,b(Be.prototype,{add:function(he){if(t(he)&&(he=Be(he)),this.isCompatible(he)||O(this.units(),he.units()),this.isTemperature()&&he.isTemperature())throw new k("Cannot add two temperatures");return this.isTemperature()?$i(this,he):he.isTemperature()?$i(he,this):Be({scalar:this.scalar+he.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},sub:function(he){if(t(he)&&(he=Be(he)),this.isCompatible(he)||O(this.units(),he.units()),this.isTemperature()&&he.isTemperature())return ii(this,he);if(this.isTemperature())return Ii(this,he);if(he.isTemperature())throw new k("Cannot subtract a temperature from a differential degree unit");return Be({scalar:this.scalar-he.to(this).scalar,numerator:this.numerator,denominator:this.denominator})},mul:function(he){if(s(he))return Be({scalar:_(this.scalar,he),numerator:this.numerator,denominator:this.denominator});if(t(he)&&(he=Be(he)),(this.isTemperature()||he.isTemperature())&&!(this.isUnitless()||he.isUnitless()))throw new k("Cannot multiply by temperatures");var Oe=this,He=he;Oe.isCompatible(He)&&Oe.signature!==400&&(He=He.to(Oe));var Tt=nn(Oe.numerator,Oe.denominator,He.numerator,He.denominator);return Be({scalar:_(Oe.scalar,He.scalar,Tt[2]),numerator:Tt[0],denominator:Tt[1]})},div:function(he){if(s(he)){if(he===0)throw new k("Divide by zero");return Be({scalar:this.scalar/he,numerator:this.numerator,denominator:this.denominator})}else t(he)&&(he=Be(he));if(he.scalar===0)throw new k("Divide by zero");if(he.isTemperature())throw new k("Cannot divide with temperatures");if(this.isTemperature()&&!he.isUnitless())throw new k("Cannot divide with temperatures");var Oe=this,He=he;Oe.isCompatible(He)&&Oe.signature!==400&&(He=He.to(Oe));var Tt=nn(Oe.numerator,Oe.denominator,He.denominator,He.numerator);return Be({scalar:_(Oe.scalar,Tt[2])/He.scalar,numerator:Tt[0],denominator:Tt[1]})},inverse:function(){if(this.isTemperature())throw new k("Cannot divide with temperatures");if(this.scalar===0)throw new k("Divide by zero");return Be({scalar:1/this.scalar,numerator:this.denominator,denominator:this.numerator})}});function nn(he,Oe,He,Tt){function le(Xe){return Xe!==j}he=he.filter(le),He=He.filter(le),Oe=Oe.filter(le),Tt=Tt.filter(le);var Q={};function ne(Xe,bt){for(var Ht,Pt,Ai,xi=0;xi<Xe.length;xi++)if(Z[Xe[xi]]?(Ht=Xe[xi+1],Pt=Xe[xi],Ai=Z[Pt],xi++):(Ht=Xe[xi],Pt=null,Ai=1),Ht&&Ht!==j)if(Q[Ht]){Q[Ht][0]+=bt;var Ei=Q[Ht][2]?Z[Q[Ht][2]]:1;Q[Ht][bt===1?3:4]*=T(Ai,Ei)}else Q[Ht]=[bt,Ht,Pt,1,1]}ne(he,1),ne(Oe,-1),ne(He,1),ne(Tt,-1);var me=[],we=[],Pe=1;for(var Ye in Q)if(Q.hasOwnProperty(Ye)){var Ue=Q[Ye],Ne;if(Ue[0]>0)for(Ne=0;Ne<Ue[0];Ne++)me.push(Ue[2]===null?Ue[1]:[Ue[2],Ue[1]]);else if(Ue[0]<0)for(Ne=0;Ne<-Ue[0];Ne++)we.push(Ue[2]===null?Ue[1]:[Ue[2],Ue[1]]);Pe*=T(Ue[3],Ue[4])}return me.length===0&&(me=te),we.length===0&&(we=te),me=me.reduce(function(Xe,bt){return Xe.concat(bt)},[]),we=we.reduce(function(Xe,bt){return Xe.concat(bt)},[]),[me,we,Pe]}b(Be.prototype,{eq:function(he){return this.compareTo(he)===0},lt:function(he){return this.compareTo(he)===-1},lte:function(he){return this.eq(he)||this.lt(he)},gt:function(he){return this.compareTo(he)===1},gte:function(he){return this.eq(he)||this.gt(he)},compareTo:function(he){if(t(he))return this.compareTo(Be(he));if(this.isCompatible(he)||O(this.units(),he.units()),this.baseScalar<he.baseScalar)return-1;if(this.baseScalar===he.baseScalar)return 0;if(this.baseScalar>he.baseScalar)return 1},same:function(he){return this.scalar===he.scalar&&this.units()===he.units()}}),b(Be.prototype,{isUnitless:function(){return[this.numerator,this.denominator].every(function(he){return a(he,te)})},isCompatible:function(he){return t(he)?this.isCompatible(Be(he)):Ct(he)&&he.signature!==void 0?this.signature===he.signature:!1},isInverse:function(he){return this.inverse().isCompatible(he)},isBase:function(){return this._isBase!==void 0?this._isBase:this.isDegrees()&&this.numerator[0].match(/<(kelvin|temp-K)>/)?(this._isBase=!0,this._isBase):(this.numerator.concat(this.denominator).forEach(function(he){he!==j&&G.indexOf(he)===-1&&(this._isBase=!1)},this),this._isBase===!1?this._isBase:(this._isBase=!0,this._isBase))}});function Er(){}Er.prototype.get=function(he){return arguments.length>1&&(he=Array.apply(null,arguments)),he.reduce(function(Oe,He,Tt){if(Oe){var le=Oe[He];return Tt===he.length-1?le?le.data:void 0:le}},this)},Er.prototype.set=function(he,Oe){return arguments.length>2&&(he=Array.prototype.slice.call(arguments,0,-1),Oe=arguments[arguments.length-1]),he.reduce(function(He,Tt,le){var Q=He[Tt];return Q===void 0&&(Q=He[Tt]={}),le===he.length-1?(Q.data=Oe,Oe):Q},this)};function Kr(he,Oe){return(he+" "+Oe).trim()}Be.formatter=Kr,b(Be.prototype,{units:function(){if(this._units!==void 0)return this._units;var he=a(this.numerator,te),Oe=a(this.denominator,te);if(he&&Oe)return this._units="",this._units;var He=an(this.numerator),Tt=an(this.denominator);return this._units=He+(Oe?"":"/"+Tt),this._units},toString:function(he,Oe){var He;if(s(he))He=this.units(),Oe=he;else if(t(he))He=he;else if(Ct(he))return this.toPrec(he).toString(Oe);var Tt=this.to(He),le=Oe!==void 0?C(Tt.scalar,Oe):Tt.scalar;return Tt=(le+" "+Tt.units()).trim(),Tt},format:function(he,Oe){arguments.length===1&&typeof he=="function"&&(Oe=he,he=void 0),Oe=Oe||Be.formatter;var He=this.to(he);return Oe.call(this,He.scalar,He.units())}});var on=new Er;function an(he){var Oe=on.get(he);if(Oe)return Oe;var He=a(he,te);return He?Oe="1":Oe=_i(vt(he)).join("*"),on.set(he,Oe),Oe}function vt(he){for(var Oe=[],He,Tt,le=0;le<he.length;le++)He=he[le],Tt=he[le+1],Z[He]?(Oe.push(re[He]+re[Tt]),le++):Oe.push(re[He]);return Oe}function _i(he){var Oe=he.reduce(function(He,Tt){var le=He[Tt];return le||He.push(le=He[Tt]=[Tt,0]),le[1]++,He},[]);return Oe.map(function(He){return He[0]+(He[1]>1?He[1]:"")})}return Be.version="1.7.6",Be})})(quantities);var quantitiesExports=quantities.exports;const Qty=getDefaultExportFromCjs(quantitiesExports);function deepValue(e,r=""){let t=r.split(".");for(let o of t){if(e[o]===void 0)return;e=e[o]}return e}var orientation={exports:{}},twoProduct_1=twoProduct$1,SPLITTER=+(Math.pow(2,27)+1);function twoProduct$1(e,r,t){var o=e*r,s=SPLITTER*e,d=s-e,g=s-d,a=e-g,b=SPLITTER*r,_=b-r,T=b-_,C=r-T,D=o-g*T,k=D-a*T,O=k-g*C,U=a*C-O;return t?(t[0]=U,t[1]=o,t):[U,o]}var robustSum=linearExpansionSum;function scalarScalar$1(e,r){var t=e+r,o=t-e,s=t-o,d=r-o,g=e-s,a=g+d;return a?[a,t]:[t]}function linearExpansionSum(e,r){var t=e.length|0,o=r.length|0;if(t===1&&o===1)return scalarScalar$1(e[0],r[0]);var s=t+o,d=new Array(s),g=0,a=0,b=0,_=Math.abs,T=e[a],C=_(T),D=r[b],k=_(D),O,U;C<k?(U=T,a+=1,a<t&&(T=e[a],C=_(T))):(U=D,b+=1,b<o&&(D=r[b],k=_(D))),a<t&&C<k||b>=o?(O=T,a+=1,a<t&&(T=e[a],C=_(T))):(O=D,b+=1,b<o&&(D=r[b],k=_(D)));for(var G=O+U,j=G-O,te=U-j,H=te,Z=G,W,_e,fe,re,ae;a<t&&b<o;)C<k?(O=T,a+=1,a<t&&(T=e[a],C=_(T))):(O=D,b+=1,b<o&&(D=r[b],k=_(D))),U=H,G=O+U,j=G-O,te=U-j,te&&(d[g++]=te),W=Z+G,_e=W-Z,fe=W-_e,re=G-_e,ae=Z-fe,H=ae+re,Z=W;for(;a<t;)O=T,U=H,G=O+U,j=G-O,te=U-j,te&&(d[g++]=te),W=Z+G,_e=W-Z,fe=W-_e,re=G-_e,ae=Z-fe,H=ae+re,Z=W,a+=1,a<t&&(T=e[a]);for(;b<o;)O=D,U=H,G=O+U,j=G-O,te=U-j,te&&(d[g++]=te),W=Z+G,_e=W-Z,fe=W-_e,re=G-_e,ae=Z-fe,H=ae+re,Z=W,b+=1,b<o&&(D=r[b]);return H&&(d[g++]=H),Z&&(d[g++]=Z),g||(d[g++]=0),d.length=g,d}var twoSum$1=fastTwoSum;function fastTwoSum(e,r,t){var o=e+r,s=o-e,d=o-s,g=r-s,a=e-d;return t?(t[0]=a+g,t[1]=o,t):[a+g,o]}var twoProduct=twoProduct_1,twoSum=twoSum$1,robustScale=scaleLinearExpansion;function scaleLinearExpansion(e,r){var t=e.length;if(t===1){var o=twoProduct(e[0],r);return o[0]?o:[o[1]]}var s=new Array(2*t),d=[.1,.1],g=[.1,.1],a=0;twoProduct(e[0],r,d),d[0]&&(s[a++]=d[0]);for(var b=1;b<t;++b){twoProduct(e[b],r,g);var _=d[1];twoSum(_,g[0],d),d[0]&&(s[a++]=d[0]);var T=g[1],C=d[1],D=T+C,k=D-T,O=C-k;d[1]=D,O&&(s[a++]=O)}return d[1]&&(s[a++]=d[1]),a===0&&(s[a++]=0),s.length=a,s}var robustDiff=robustSubtract;function scalarScalar(e,r){var t=e+r,o=t-e,s=t-o,d=r-o,g=e-s,a=g+d;return a?[a,t]:[t]}function robustSubtract(e,r){var t=e.length|0,o=r.length|0;if(t===1&&o===1)return scalarScalar(e[0],-r[0]);var s=t+o,d=new Array(s),g=0,a=0,b=0,_=Math.abs,T=e[a],C=_(T),D=-r[b],k=_(D),O,U;C<k?(U=T,a+=1,a<t&&(T=e[a],C=_(T))):(U=D,b+=1,b<o&&(D=-r[b],k=_(D))),a<t&&C<k||b>=o?(O=T,a+=1,a<t&&(T=e[a],C=_(T))):(O=D,b+=1,b<o&&(D=-r[b],k=_(D)));for(var G=O+U,j=G-O,te=U-j,H=te,Z=G,W,_e,fe,re,ae;a<t&&b<o;)C<k?(O=T,a+=1,a<t&&(T=e[a],C=_(T))):(O=D,b+=1,b<o&&(D=-r[b],k=_(D))),U=H,G=O+U,j=G-O,te=U-j,te&&(d[g++]=te),W=Z+G,_e=W-Z,fe=W-_e,re=G-_e,ae=Z-fe,H=ae+re,Z=W;for(;a<t;)O=T,U=H,G=O+U,j=G-O,te=U-j,te&&(d[g++]=te),W=Z+G,_e=W-Z,fe=W-_e,re=G-_e,ae=Z-fe,H=ae+re,Z=W,a+=1,a<t&&(T=e[a]);for(;b<o;)O=D,U=H,G=O+U,j=G-O,te=U-j,te&&(d[g++]=te),W=Z+G,_e=W-Z,fe=W-_e,re=G-_e,ae=Z-fe,H=ae+re,Z=W,b+=1,b<o&&(D=-r[b]);return H&&(d[g++]=H),Z&&(d[g++]=Z),g||(d[g++]=0),d.length=g,d}(function(e){var r=twoProduct_1,t=robustSum,o=robustScale,s=robustDiff,d=5,g=11102230246251565e-32,a=(3+16*g)*g,b=(7+56*g)*g;function _(H,Z,W,_e){return function(re,ae,J){var se=H(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),H(Z(re[1],ae[0]),Z(-ae[1],re[0]))),Me=H(Z(re[1],J[0]),Z(-J[1],re[0])),Ie=_e(se,Me);return Ie[Ie.length-1]}}function T(H,Z,W,_e){return function(re,ae,J,se){var Me=H(H(W(H(Z(J[1],se[0]),Z(-se[1],J[0])),ae[2]),H(W(H(Z(ae[1],se[0]),Z(-se[1],ae[0])),-J[2]),W(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),se[2]))),H(W(H(Z(ae[1],se[0]),Z(-se[1],ae[0])),re[2]),H(W(H(Z(re[1],se[0]),Z(-se[1],re[0])),-ae[2]),W(H(Z(re[1],ae[0]),Z(-ae[1],re[0])),se[2])))),Ie=H(H(W(H(Z(J[1],se[0]),Z(-se[1],J[0])),re[2]),H(W(H(Z(re[1],se[0]),Z(-se[1],re[0])),-J[2]),W(H(Z(re[1],J[0]),Z(-J[1],re[0])),se[2]))),H(W(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),re[2]),H(W(H(Z(re[1],J[0]),Z(-J[1],re[0])),-ae[2]),W(H(Z(re[1],ae[0]),Z(-ae[1],re[0])),J[2])))),We=_e(Me,Ie);return We[We.length-1]}}function C(H,Z,W,_e){return function(re,ae,J,se,Me){var Ie=H(H(H(W(H(W(H(Z(se[1],Me[0]),Z(-Me[1],se[0])),J[2]),H(W(H(Z(J[1],Me[0]),Z(-Me[1],J[0])),-se[2]),W(H(Z(J[1],se[0]),Z(-se[1],J[0])),Me[2]))),ae[3]),H(W(H(W(H(Z(se[1],Me[0]),Z(-Me[1],se[0])),ae[2]),H(W(H(Z(ae[1],Me[0]),Z(-Me[1],ae[0])),-se[2]),W(H(Z(ae[1],se[0]),Z(-se[1],ae[0])),Me[2]))),-J[3]),W(H(W(H(Z(J[1],Me[0]),Z(-Me[1],J[0])),ae[2]),H(W(H(Z(ae[1],Me[0]),Z(-Me[1],ae[0])),-J[2]),W(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),Me[2]))),se[3]))),H(W(H(W(H(Z(J[1],se[0]),Z(-se[1],J[0])),ae[2]),H(W(H(Z(ae[1],se[0]),Z(-se[1],ae[0])),-J[2]),W(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),se[2]))),-Me[3]),H(W(H(W(H(Z(se[1],Me[0]),Z(-Me[1],se[0])),ae[2]),H(W(H(Z(ae[1],Me[0]),Z(-Me[1],ae[0])),-se[2]),W(H(Z(ae[1],se[0]),Z(-se[1],ae[0])),Me[2]))),re[3]),W(H(W(H(Z(se[1],Me[0]),Z(-Me[1],se[0])),re[2]),H(W(H(Z(re[1],Me[0]),Z(-Me[1],re[0])),-se[2]),W(H(Z(re[1],se[0]),Z(-se[1],re[0])),Me[2]))),-ae[3])))),H(H(W(H(W(H(Z(ae[1],Me[0]),Z(-Me[1],ae[0])),re[2]),H(W(H(Z(re[1],Me[0]),Z(-Me[1],re[0])),-ae[2]),W(H(Z(re[1],ae[0]),Z(-ae[1],re[0])),Me[2]))),se[3]),H(W(H(W(H(Z(ae[1],se[0]),Z(-se[1],ae[0])),re[2]),H(W(H(Z(re[1],se[0]),Z(-se[1],re[0])),-ae[2]),W(H(Z(re[1],ae[0]),Z(-ae[1],re[0])),se[2]))),-Me[3]),W(H(W(H(Z(J[1],se[0]),Z(-se[1],J[0])),ae[2]),H(W(H(Z(ae[1],se[0]),Z(-se[1],ae[0])),-J[2]),W(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),se[2]))),re[3]))),H(W(H(W(H(Z(J[1],se[0]),Z(-se[1],J[0])),re[2]),H(W(H(Z(re[1],se[0]),Z(-se[1],re[0])),-J[2]),W(H(Z(re[1],J[0]),Z(-J[1],re[0])),se[2]))),-ae[3]),H(W(H(W(H(Z(ae[1],se[0]),Z(-se[1],ae[0])),re[2]),H(W(H(Z(re[1],se[0]),Z(-se[1],re[0])),-ae[2]),W(H(Z(re[1],ae[0]),Z(-ae[1],re[0])),se[2]))),J[3]),W(H(W(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),re[2]),H(W(H(Z(re[1],J[0]),Z(-J[1],re[0])),-ae[2]),W(H(Z(re[1],ae[0]),Z(-ae[1],re[0])),J[2]))),-se[3]))))),We=H(H(H(W(H(W(H(Z(se[1],Me[0]),Z(-Me[1],se[0])),J[2]),H(W(H(Z(J[1],Me[0]),Z(-Me[1],J[0])),-se[2]),W(H(Z(J[1],se[0]),Z(-se[1],J[0])),Me[2]))),re[3]),W(H(W(H(Z(se[1],Me[0]),Z(-Me[1],se[0])),re[2]),H(W(H(Z(re[1],Me[0]),Z(-Me[1],re[0])),-se[2]),W(H(Z(re[1],se[0]),Z(-se[1],re[0])),Me[2]))),-J[3])),H(W(H(W(H(Z(J[1],Me[0]),Z(-Me[1],J[0])),re[2]),H(W(H(Z(re[1],Me[0]),Z(-Me[1],re[0])),-J[2]),W(H(Z(re[1],J[0]),Z(-J[1],re[0])),Me[2]))),se[3]),W(H(W(H(Z(J[1],se[0]),Z(-se[1],J[0])),re[2]),H(W(H(Z(re[1],se[0]),Z(-se[1],re[0])),-J[2]),W(H(Z(re[1],J[0]),Z(-J[1],re[0])),se[2]))),-Me[3]))),H(H(W(H(W(H(Z(J[1],Me[0]),Z(-Me[1],J[0])),ae[2]),H(W(H(Z(ae[1],Me[0]),Z(-Me[1],ae[0])),-J[2]),W(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),Me[2]))),re[3]),W(H(W(H(Z(J[1],Me[0]),Z(-Me[1],J[0])),re[2]),H(W(H(Z(re[1],Me[0]),Z(-Me[1],re[0])),-J[2]),W(H(Z(re[1],J[0]),Z(-J[1],re[0])),Me[2]))),-ae[3])),H(W(H(W(H(Z(ae[1],Me[0]),Z(-Me[1],ae[0])),re[2]),H(W(H(Z(re[1],Me[0]),Z(-Me[1],re[0])),-ae[2]),W(H(Z(re[1],ae[0]),Z(-ae[1],re[0])),Me[2]))),J[3]),W(H(W(H(Z(ae[1],J[0]),Z(-J[1],ae[0])),re[2]),H(W(H(Z(re[1],J[0]),Z(-J[1],re[0])),-ae[2]),W(H(Z(re[1],ae[0]),Z(-ae[1],re[0])),J[2]))),-Me[3])))),Ge=_e(Ie,We);return Ge[Ge.length-1]}}function D(H){var Z=H===3?_:H===4?T:C;return Z(t,r,o,s)}var k=D(3),O=D(4),U=[function(){return 0},function(){return 0},function(Z,W){return W[0]-Z[0]},function(Z,W,_e){var fe=(Z[1]-_e[1])*(W[0]-_e[0]),re=(Z[0]-_e[0])*(W[1]-_e[1]),ae=fe-re,J;if(fe>0){if(re<=0)return ae;J=fe+re}else if(fe<0){if(re>=0)return ae;J=-(fe+re)}else return ae;var se=a*J;return ae>=se||ae<=-se?ae:k(Z,W,_e)},function(Z,W,_e,fe){var re=Z[0]-fe[0],ae=W[0]-fe[0],J=_e[0]-fe[0],se=Z[1]-fe[1],Me=W[1]-fe[1],Ie=_e[1]-fe[1],We=Z[2]-fe[2],Ge=W[2]-fe[2],qt=_e[2]-fe[2],ti=ae*Ie,Ut=J*Me,Qt=J*se,tt=re*Ie,nt=re*Me,Mt=ae*se,ht=We*(ti-Ut)+Ge*(Qt-tt)+qt*(nt-Mt),xt=(Math.abs(ti)+Math.abs(Ut))*Math.abs(We)+(Math.abs(Qt)+Math.abs(tt))*Math.abs(Ge)+(Math.abs(nt)+Math.abs(Mt))*Math.abs(qt),It=b*xt;return ht>It||-ht>It?ht:O(Z,W,_e,fe)}];function G(H){var Z=U[H.length];return Z||(Z=U[H.length]=D(H.length)),Z.apply(void 0,H)}function j(H,Z,W,_e,fe,re,ae){return function(se,Me,Ie,We,Ge){switch(arguments.length){case 0:case 1:return 0;case 2:return _e(se,Me);case 3:return fe(se,Me,Ie);case 4:return re(se,Me,Ie,We);case 5:return ae(se,Me,Ie,We,Ge)}for(var qt=new Array(arguments.length),ti=0;ti<arguments.length;++ti)qt[ti]=arguments[ti];return H(qt)}}function te(){for(;U.length<=d;)U.push(D(U.length));e.exports=j.apply(void 0,[G].concat(U));for(var H=0;H<=d;++H)e.exports[H]=U[H]}te()})(orientation);var orientationExports=orientation.exports,robustPnp=robustPointInPolygon,orient=orientationExports;function robustPointInPolygon(e,r){for(var t=r[0],o=r[1],s=e.length,d=1,g=s,a=0,b=s-1;a<g;b=a++){var _=e[a],T=e[b],C=_[1],D=T[1];if(D<C){if(D<o&&o<C){var k=orient(_,T,r);if(k===0)return 0;d^=0<k|0}else if(o===C){var O=e[(a+1)%s],U=O[1];if(C<U){var k=orient(_,T,r);if(k===0)return 0;d^=0<k|0}}}else if(C<D){if(C<o&&o<D){var k=orient(_,T,r);if(k===0)return 0;d^=k<0|0}else if(o===C){var O=e[(a+1)%s],U=O[1];if(U<C){var k=orient(_,T,r);if(k===0)return 0;d^=k<0|0}}}else if(o===C){var G=Math.min(_[0],T[0]),j=Math.max(_[0],T[0]);if(a===0){for(;b>0;){var te=(b+s-1)%s,H=e[te];if(H[1]!==o)break;var Z=H[0];G=Math.min(G,Z),j=Math.max(j,Z),b=te}if(b===0)return G<=t&&t<=j?0:1;g=b+1}for(var W=e[(b+s-1)%s][1];a+1<g;){var H=e[a+1];if(H[1]!==o)break;var Z=H[0];G=Math.min(G,Z),j=Math.max(j,Z),a+=1}if(G<=t&&t<=j)return 0;var _e=e[(a+1)%s][1];t<G&&W<o!=_e<o&&(d^=1)}}return 2*d-1}const robustPointInPolygon$1=getDefaultExportFromCjs(robustPnp);function feretDiameters(e={}){const{originalPoints:r=monotoneChainConvexHull.call(this)}=e;if(r.length===0)return{min:0,max:0,minLine:[],maxLine:[],aspectRatio:1};if(r.length===1)return{min:1,max:1,minLine:[r[0],r[0]],maxLine:[r[0],r[0]],aspectRatio:1};const t=new Array(r.length);let o=1/0,s=0,d=[];for(let _=0;_<r.length;_++){let T=getAngle(r[_],r[(_+1)%r.length]);rotate(-T,r,t);let C=0,D=[];for(let k=0;k<r.length;k++){let O=Math.abs(t[_][1]-t[k][1]);O>C&&(C=O,D=[],D.push([t[k][0],t[_][1]],[t[k][0],t[k][1]]))}C<o&&(o=C,s=T,d=D)}rotate(s,d,d);let g=0,a=[],b=0;for(let _=0;_<r.length-1;_++)for(let T=_+1;T<r.length;T++){let C=(r[_][0]-r[T][0])**2+(r[_][1]-r[T][1])**2;C>b&&(b=C,g=Math.sqrt(C),a=[r[_],r[T]])}return{min:o,minLine:d,max:g,maxLine:a,aspectRatio:o/g}}function getAngle(e,r){let t=difference(r,e),o=normalize(t),s=Math.acos(o[0]);return o[1]<0?-s:s}class Roi{constructor(r,t){this.map=r,this.id=t,this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.meanX=0,this.meanY=0,this.surface=0,this.computed={}}getMask(r={}){const{scale:t=1,kind:o=""}=r;let s;switch(o){case"contour":s=this.contourMask;break;case"box":s=this.boxMask;break;case"filled":s=this.filledMask;break;case"center":s=this.centerMask;break;case"mbr":s=this.mbrFilledMask;break;case"hull":s=this.convexHullFilledMask;break;case"hullContour":s=this.convexHullMask;break;case"mbrContour":s=this.mbrMask;break;case"feret":s=this.feretMask;break;default:s=this.mask}return t<1&&(s=s.resize({factor:t}),s.parent=this.mask.parent,s.position[0]+=this.minX,s.position[1]+=this.minY),s}get mean(){throw new Error("Roi mean not implemented yet")}get center(){return this.computed.center||(this.computed.center=[this.width/2>>0,this.height/2>>0]),this.computed.center}get ratio(){return this.width/this.height}get width(){return this.maxX-this.minX+1}get height(){return this.maxY-this.minY+1}_computExternalIDs(){let r=this.borderIDs,t=this.borderLengths;this.computed.externalIDs=[],this.computed.externalLengths=[];let o=this.internalIDs;for(let s=0;s<r.length;s++)o.includes(r[s])||(this.computed.externalIDs.push(r[s]),this.computed.externalLengths.push(t[s]))}get externalIDs(){return this.computed.externalIDs?this.computed.externalIDs:(this._computExternalIDs(),this.computed.externalIDs)}get externalLengths(){return this.computed.externalLengths?this.computed.externalLengths:(this._computExternalIDs(),this.computed.externalLengths)}_computeBorderIDs(){let r=getBorders(this);this.computed.borderIDs=r.ids,this.computed.borderLengths=r.lengths}get borderIDs(){return this.computed.borderIDs?this.computed.borderIDs:(this._computeBorderIDs(),this.computed.borderIDs)}get borderLengths(){return this.computed.borderLengths?this.computed.borderLengths:(this._computeBorderIDs(),this.computed.borderLengths)}get boxIDs(){return this.computed.boxIDs||(this.computed.boxIDs=getBoxIDs(this)),this.computed.boxIDs}get internalIDs(){return this.computed.internalIDs||(this.computed.internalIDs=getInternalIDs(this)),this.computed.internalIDs}get box(){return this.computed.box||(this.computed.box=getBox(this)),this.computed.box}get external(){return this.computed.external||(this.computed.external=getExternal(this)),this.computed.external}get holesInfo(){return this.computed.holesInfo||(this.computed.holesInfo=getHolesInfo(this)),this.computed.holesInfo}get border(){return this.computed.border||(this.computed.border=getBorder(this)),this.computed.border}get contourMask(){if(!this.computed.contourMask){let r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++)this.map.data[t+this.minX+(o+this.minY)*this.map.width]===this.id&&(t>0&&t<this.width-1&&o>0&&o<this.height-1?(this.map.data[t-1+this.minX+(o+this.minY)*this.map.width]!==this.id||this.map.data[t+1+this.minX+(o+this.minY)*this.map.width]!==this.id||this.map.data[t+this.minX+(o-1+this.minY)*this.map.width]!==this.id||this.map.data[t+this.minX+(o+1+this.minY)*this.map.width]!==this.id)&&r.setBitXY(t,o):r.setBitXY(t,o));this.computed.contourMask=r}return this.computed.contourMask}get boxMask(){if(!this.computed.boxMask){let r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let t=0;t<this.width;t++)r.setBitXY(t,0),r.setBitXY(t,this.height-1);for(let t=0;t<this.height;t++)r.setBitXY(0,t),r.setBitXY(this.width-1,t);this.computed.boxMask=r}return this.computed.boxMask}get mask(){if(!this.computed.mask){let r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++)this.map.data[t+this.minX+(o+this.minY)*this.map.width]===this.id&&r.setBitXY(t,o);this.computed.mask=r}return this.computed.mask}get filledMask(){if(!this.computed.filledMask){let r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){let s=t+this.minX+(o+this.minY)*this.map.width;this.internalIDs.includes(this.map.data[s])&&r.setBitXY(t,o)}this.computed.filledMask=r}return this.computed.filledMask}get centerMask(){if(!this.computed.centerMask){let r=new Shape({kind:"smallCross"}).getMask();r.parent=this.map.parent,r.position=[this.minX+this.center[0]-1,this.minY+this.center[1]-1],this.computed.centerMask=r}return this.computed.centerMask}get convexHull(){if(!this.computed.convexHull){const r=[];for(let o=0;o<this.width;o++)for(let s=0;s<this.height;s++)this.map.data[o+this.minX+(s+this.minY)*this.map.width]===this.id&&(o>0&&o<this.width-1&&s>0&&s<this.height-1?(this.map.data[o-1+this.minX+(s+this.minY)*this.map.width]!==this.id||this.map.data[o+1+this.minX+(s+this.minY)*this.map.width]!==this.id||this.map.data[o+this.minX+(s-1+this.minY)*this.map.width]!==this.id||this.map.data[o+this.minX+(s+1+this.minY)*this.map.width]!==this.id)&&(r.push([o,s]),r.push([o+1,s]),r.push([o,s+1]),r.push([o+1,s+1])):(r.push([o,s]),r.push([o+1,s]),r.push([o,s+1]),r.push([o+1,s+1])));const t=monotoneChainConvexHull$1(r);this.computed.convexHull={polyline:t,surface:surface(t),perimeter:perimeter(t)}}return this.computed.convexHull}get convexHullMask(){if(!this.computed.convexHullMask){const r=this.convexHull,t=new Image(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});t.paintPolyline(r.polyline,{closed:!0}),this.computed.convexHullMask=t}return this.computed.convexHullMask}get convexHullFilledMask(){if(!this.computed.convexHullFilledMask){const r=this.convexHull,t=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});for(let o=0;o<this.width;o++)for(let s=0;s<this.height;s++)robustPointInPolygon$1(r.polyline,[o,s])!==1&&t.setBitXY(o,s);this.computed.convexHullFilledMask=t}return this.computed.convexHullFilledMask}get mbr(){if(!this.computed.mbr){let r=minimalBoundingRectangle({originalPoints:this.convexHull.polyline});if(r.length===0)this.computed.mbr={width:0,height:0,surface:0,perimeter:0,rectangle:r};else{let t=r[0],o=r[1],s=r[2],d=Math.sqrt((t[0]-o[0])**2+(t[1]-o[1])**2),g=Math.sqrt((s[0]-o[0])**2+(s[1]-o[1])**2);this.computed.mbr={width:d,height:g,elongation:1-d/g,aspectRatio:d/g,surface:d*g,perimeter:(d+g)*2,rectangle:r}}}return this.computed.mbr}get fillRatio(){return this.surface/(this.surface+this.holesInfo.surface)}get feretDiameters(){return this.computed.feretDiameters||(this.computed.feretDiameters=feretDiameters({originalPoints:this.convexHull.polyline})),this.computed.feretDiameters}get eqpc(){return this.computed.eqpc||(this.computed.eqpc=2*Math.sqrt(this.surface/Math.PI)),this.computed.eqpc}get perimeterInfo(){return this.computed.perimeterInfo||(this.computed.perimeterInfo=getPerimeterInfo(this)),this.computed.perimeterInfo}get perimeter(){let r=this.perimeterInfo,t=2-Math.sqrt(2);return r.one+r.two*2+r.three*3+r.four*4-t*(r.two+r.three*2+r.four)}get ped(){return this.computed.ped||(this.computed.ped=this.perimeter/Math.PI),this.computed.ped}get feretMask(){if(!this.computed.feretMask){const r=new Image(this.width+1,this.height+1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent});r.paintPolyline(this.feretDiameters.minLine),r.paintPolyline(this.feretDiameters.maxLine),this.computed.feretMask=r}return this.computed.feretMask}get mbrMask(){if(!this.computed.mbrMask){let r=round(this.mbr.rectangle);if(r.length>0){const t=minMax(r),o=new Image(t[1][0]-t[0][0]+1,t[1][1]-t[0][1]+1,{kind:BINARY,position:[this.minX+t[0][0],this.minY+t[0][1]],parent:this.map.parent});r=moveToZeroZero(r),o.paintPolyline(r,{closed:!0}),this.computed.mbrMask=o}else this.computed.mbrMask=new Image(1,1,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent})}return this.computed.mbrMask}get mbrFilledMask(){if(!this.computed.mbrFilledMask){const r=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),t=this.mask.minimalBoundingRectangle();for(let o=0;o<this.width;o++)for(let s=0;s<this.height;s++)robustPointInPolygon$1(t,[o,s])!==1&&r.setBitXY(o,s);this.computed.mbrFilledMask=r}return this.computed.mbrFilledMask}get points(){if(!this.computed.points){let r=[];for(let t=0;t<this.height;t++)for(let o=0;o<this.width;o++){let s=(t+this.minY)*this.map.width+o+this.minX;this.map.data[s]===this.id&&r.push([o,t])}this.computed.points=r}return this.computed.points}get maxLengthPoints(){if(!this.computed.maxLengthPoints){let r=0,t;const o=this.points;for(let s=0;s<o.length;s++)for(let d=s+1;d<o.length;d++){let g=Math.pow(o[s][0]-o[d][0],2)+Math.pow(o[s][1]-o[d][1],2);g>=r&&(r=g,t=[o[s],o[d]])}this.computed.maxLengthPoints=t}return this.computed.maxLengthPoints}get maxLength(){if(!this.computed.maxLength){let r=Math.sqrt(Math.pow(this.maxLengthPoints[0][0]-this.maxLengthPoints[1][0],2)+Math.pow(this.maxLengthPoints[0][1]-this.maxLengthPoints[1][1],2));this.computed.maxLength=r}return this.computed.maxLength}get roundness(){return 4*this.surface/(Math.PI*this.feretDiameters.max**2)}get sphericity(){return 2*Math.sqrt(this.surface*Math.PI)/this.perimeter}get solidity(){return this.surface/this.convexHull.surface}get angle(){if(!this.computed.angle){let r=this.maxLengthPoints,t=-Math.atan2(r[0][1]-r[1][1],r[0][0]-r[1][0])*180/Math.PI;this.computed.angle=t}return this.computed.angle}toJSON(){return{id:this.id,minX:this.minX,maxX:this.maxX,minY:this.minY,maxY:this.maxY,meanX:this.meanX,meanY:this.meanY,height:this.height,width:this.width,surface:this.surface,mbrWidth:this.mbr.width,mbrHeight:this.mbr.height,mbrSurface:this.mbr.surface,eqpc:this.eqpc,ped:this.ped,feretDiameterMin:this.feretDiameters.min,feretDiameterMax:this.feretDiameters.max,aspectRatio:this.feretDiameters.aspectRatio,fillRatio:this.fillRatio,sphericity:this.sphericity,roundness:this.roundness,solidity:this.solidity,perimeter:this.perimeter}}}function getBorders(e){let r=e.map,t=r.data,o=new Set,s=new Map,d=new Set,g=[1,0,-1,0],a=[0,1,0,-1];for(let T=e.minX;T<=e.maxX;T++)for(let C=e.minY;C<=e.maxY;C++){let D=T+C*r.width;if(t[D]===e.id)for(let k=0;k<4;k++){let O=T+g[k],U=C+a[k];if(O>=0&&U>=0&&O<r.width&&U<r.height){let G=O+U*r.width;if(t[G]!==e.id&&!d.has(G)){d.add(G),o.add(t[G]);let j=s.get(t[G]);j?s.set(t[G],++j):s.set(t[G],1)}}}}let b=Array.from(o),_=b.map(function(T){return s.get(T)});return{ids:b,lengths:_}}function getBoxIDs(e){let r=new Set,t=e.map,o=t.data;for(let s of[0,e.height-1])for(let d=0;d<e.width;d++){let g=(s+e.minY)*t.width+d+e.minX;if(d-e.minX>0&&o[g]===e.id&&o[g-1]!==e.id){let a=o[g-1];r.add(a)}if(t.width-d-e.minX>1&&o[g]===e.id&&o[g+1]!==e.id){let a=o[g+1];r.add(a)}}for(let s of[0,e.width-1])for(let d=0;d<e.height;d++){let g=(d+e.minY)*t.width+s+e.minX;if(d-e.minY>0&&o[g]===e.id&&o[g-t.width]!==e.id){let a=o[g-t.width];r.add(a)}if(t.height-d-e.minY>1&&o[g]===e.id&&o[g+t.width]!==e.id){let a=o[g+t.width];r.add(a)}}return Array.from(r)}function getBox(e){let r=0,t=e.map,o=t.data,s=[0];e.height>1&&(s[1]=e.height-1);for(let g of s)for(let a=1;a<e.width-1;a++){let b=(g+e.minY)*t.width+a+e.minX;o[b]===e.id&&r++}let d=[0];e.width>1&&(d[1]=e.width-1);for(let g of d)for(let a=0;a<e.height;a++){let b=(a+e.minY)*t.width+g+e.minX;o[b]===e.id&&r++}return r}function getBorder(e){let r=0,t=e.map,o=t.data;for(let s=1;s<e.width-1;s++)for(let d=1;d<e.height-1;d++){let g=(d+e.minY)*t.width+s+e.minX;o[g]===e.id&&(o[g-1]!==e.id||o[g+1]!==e.id||o[g-t.width]!==e.id||o[g+t.width]!==e.id)&&r++}return r+e.box}function getPerimeterInfo(e){let r=e.map,t=r.data,o=0,s=0,d=0,g=0;for(let a=0;a<e.width;a++)for(let b=0;b<e.height;b++){let _=(b+e.minY)*r.width+a+e.minX;if(t[_]===e.id){let T=0;switch((a===0||e.externalIDs.includes(t[_-1]))&&T++,(a===e.width-1||e.externalIDs.includes(t[_+1]))&&T++,(b===0||e.externalIDs.includes(t[_-r.width]))&&T++,(b===e.height-1||e.externalIDs.includes(t[_+r.width]))&&T++,T){case 1:o++;break;case 2:s++;break;case 3:d++;break;case 4:g++;break}}}return{one:o,two:s,three:d,four:g}}function getExternal(e){let r=0,t=e.map,o=t.data;for(let s=1;s<e.width-1;s++)for(let d=1;d<e.height-1;d++){let g=(d+e.minY)*t.width+s+e.minX;o[g]===e.id&&(e.externalIDs.includes(o[g-1])||e.externalIDs.includes(o[g+1])||e.externalIDs.includes(o[g-t.width])||e.externalIDs.includes(o[g+t.width]))&&r++}return r+e.box}function getHolesInfo(e){let r=0,t=e.map.width,o=e.map.data;for(let s=1;s<e.width-1;s++)for(let d=1;d<e.height-1;d++){let g=(d+e.minY)*t+s+e.minX;e.internalIDs.includes(o[g])&&o[g]!==e.id&&r++}return{number:e.internalIDs.length-1,surface:r}}function getInternalIDs(e){let r=[e.id],t=e.map,o=t.data;if(e.height>2)for(let d=0;d<e.width;d++){let g=e.minY*t.width+d+e.minX;if(r.includes(o[g])){let a=o[g+t.width];!r.includes(a)&&!e.boxIDs.includes(a)&&r.push(a)}}let s=new Array(4);for(let d=1;d<e.width-1;d++)for(let g=1;g<e.height-1;g++){let a=(g+e.minY)*t.width+d+e.minX;if(r.includes(o[a])){s[0]=o[a-1],s[1]=o[a+1],s[2]=o[a-t.width],s[3]=o[a+t.width];for(let b=0;b<4;b++){let _=s[b];!r.includes(_)&&!e.boxIDs.includes(_)&&r.push(_)}}}return r}class RoiLayer{constructor(r,t){this.roiMap=r,this.options=t,this.roi=this.createRoi()}createRoi(){let r=this.roiMap.data,t={};this.roiMap.positive=0,this.roiMap.negative=0;for(let a=0;a<r.length;a++)r[a]&&!t[r[a]]&&(t[r[a]]=!0,r[a]>0?this.roiMap.positive++:this.roiMap.negative++);let o={};for(let a in t)o[a]=new Roi(this.roiMap,a*1);let s=this.roiMap.width,d=this.roiMap.height;for(let a=0;a<d;a++)for(let b=0;b<s;b++){let _=a*s+b;if(r[_]!==0){const T=r[_],C=o[T];b<C.minX&&(C.minX=b),b>C.maxX&&(C.maxX=b),a<C.minY&&(C.minY=a),a>C.maxY&&(C.maxY=a),C.meanX+=b,C.meanY+=a,C.surface++}}let g=[];for(let a in t)o[a].meanX/=o[a].surface,o[a].meanY/=o[a].surface,g.push(o[a]);return g}}function commonBorderLength(e){let r=e.data,t=[1,0,-1,0],o=[0,1,0,-1],s=e.minMax,d=-s.min,g=s.max+d,a=[];for(let _=0;_<=g;_++)a.push(Object.create(null));for(let _=0;_<e.width;_++)for(let T=0;T<e.height;T++){let C=_+T*e.width,D=r[C];if(D!==0){let k=Object.create(null),O=!1;for(let U=0;U<4;U++){let G=_+t[U],j=T+o[U];if(G>=0&&j>=0&&G<e.width&&j<e.height){let te=r[G+j*e.width];D!==te&&(O=!0,te!==0&&k[te]===void 0&&(k[te]=!0,a[te+d][D]?a[te+d][D]++:a[te+d][D]=1))}else O=!0}O&&(a[D+d][D]?a[D+d][D]++:a[D+d][D]=1)}}let b={};for(let _=0;_<a.length;_++)Object.keys(a[_]).length>0&&(b[_-d]=a[_]);return b}function mergeRoi(e={}){const{algorithm:r="commonBorderLength",minCommonBorderLength:t=5,maxCommonBorderLength:o=100,minCommonBorderRatio:s=.3,maxCommonBorderRatio:d=1}=e;let g=function(G,j,te){return G[te]>=t&&G[te]<=o};typeof r=="function"&&(g=r),r.toLowerCase()==="commonborderratio"&&(g=function(G,j,te){let H=Math.min(G[te]/G[j],1);return H>=s&&H<=d});const a=this,b=a.commonBorderLength;let _={},T={};for(let G of Object.keys(b)){let j=b[G],te=Object.keys(j);for(let H of te)if(H!==G&&g(j,G,H)){let Z=H;T[H]&&(Z=T[H]);let W=G;if(T[G]&&(W=T[G]),Number(Z)!==W){let _e=Math.min(Z,W),fe=Math.max(Z,W);if(_[_e]||(_[_e]={}),_[_e][fe]=!0,T[fe]=_e,_[fe]){for(let re of Object.keys(_[fe]))_[_e][re]=!0,T[re]=_e;delete _[fe]}}}}let C=a.minMax,D=-C.min,k=C.max+D,O=new Array(k+1).fill(0);for(let G of Object.keys(T))O[Number(G)+D]=T[G];let U=a.data;for(let G=0;G<U.length;G++){let j=U[G];if(j!==0){let te=O[j+D];te!==0&&(U[G]=te)}}return a.computed={},a}class RoiMap{constructor(r,t){this.parent=r,this.width=r.width,this.height=r.height,this.data=t,this.negative=0,this.positive=0}get total(){return this.negative+this.positive}get minMax(){let r=Number.MAX_SAFE_INTEGER,t=Number.MIN_SAFE_INTEGER;for(let o=0;o<this.data.length;o++)this.data[o]<r&&(r=this.data[o]),this.data[o]>t&&(t=this.data[o]);return{min:r,max:t}}get commonBorderLength(){return commonBorderLength(this)}mergeRoi(r={}){return mergeRoi.call(this,r)}mergeRois(r){const t=r[0],o=r.slice(1);for(let s=0;s<this.data.length;s++)o.includes(this.data[s])&&(this.data[s]=t)}rowsInfo(){let r=new Array(this.height),t=0;for(let o=0;o<this.data.length;o+=this.width){let s={row:t,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};r[t++]=s;let d={},g={},a=[],b=this.data[o],_=0;for(let T=o;T<o+this.width;T++){let C=this.data[T];b!==C&&(b=C,a.push(_),_=0),_++,C>0?(s.positivePixel++,d[C]||(d[C]=!0)):C<0?(s.negativePixel++,g[C]||(g[C]=!0)):s.zeroPixel++}a.push(_),s.medianChange=a.sort((T,C)=>T-C)[Math.floor(a.length/2)],s.positiveRoiIDs=Object.keys(d),s.negativeRoiIDs=Object.keys(g),s.positiveRoi=s.positiveRoiIDs.length,s.negativeRoi=s.negativeRoiIDs.length}return r}colsInfo(){let r=new Array(this.width),t=0;for(let o=0;o<this.width;o++){let s={col:t,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0};r[t++]=s;let d={},g={},a=[],b=this.data[o],_=0;for(let T=o;T<o+this.data.length;T+=this.width){let C=this.data[T];b!==C&&(b=C,a.push(_),_=0),_++,C>0?(s.positivePixel++,d[C]||(d[C]=!0)):C<0?(s.negativePixel++,g[C]||(g[C]=!0)):s.zeroPixel++}a.push(_),s.medianChange=a.sort((T,C)=>T-C)[Math.floor(a.length/2)],s.positiveRoiIDs=Object.keys(d),s.negativeRoiIDs=Object.keys(g),s.positiveRoi=s.positiveRoiIDs.length,s.negativeRoi=s.negativeRoiIDs.length}return r}}function fromMask(e,r={}){const{allowCorners:t=!1}=r,o=65535;let s=new Int16Array(e.size),d=0,g=0,a=new Uint16Array(o+1),b=new Uint16Array(o+1);for(let T=0;T<e.width;T++)for(let C=0;C<e.height;C++)s[C*e.width+T]===0&&_(T,C);function _(T,C){let D=0,k=0,O=e.getBitXY(T,C),U=O?++d:--g;if(d>32767||g<-32768)throw new Error("Too many regions of interest");for(a[0]=T,b[0]=C;D<=k;){let G=a[D&o],j=b[D&o];if(s[j*e.width+G]=U,G>0&&s[j*e.width+G-1]===0&&e.getBitXY(G-1,j)===O&&(k++,a[k&o]=G-1,b[k&o]=j,s[j*e.width+G-1]=-32768),j>0&&s[(j-1)*e.width+G]===0&&e.getBitXY(G,j-1)===O&&(k++,a[k&o]=G,b[k&o]=j-1,s[(j-1)*e.width+G]=-32768),G<e.width-1&&s[j*e.width+G+1]===0&&e.getBitXY(G+1,j)===O&&(k++,a[k&o]=G+1,b[k&o]=j,s[j*e.width+G+1]=-32768),j<e.height-1&&s[(j+1)*e.width+G]===0&&e.getBitXY(G,j+1)===O&&(k++,a[k&o]=G,b[k&o]=j+1,s[(j+1)*e.width+G]=-32768),t&&(G>0&&j>0&&s[(j-1)*e.width+G-1]===0&&e.getBitXY(G-1,j-1)===O&&(k++,a[k&o]=G-1,b[k&o]=j-1,s[(j-1)*e.width+G-1]=-32768),G<e.width-1&&j>0&&s[(j-1)*e.width+G+1]===0&&e.getBitXY(G+1,j-1)===O&&(k++,a[k&o]=G+1,b[k&o]=j-1,s[(j-1)*e.width+G+1]=-32768),G>0&&j<e.height-1&&s[(j+1)*e.width+G-1]===0&&e.getBitXY(G-1,j+1)===O&&(k++,a[k&o]=G-1,b[k&o]=j+1,s[(j+1)*e.width+G-1]=-32768),G<e.width-1&&j<e.height-1&&s[(j+1)*e.width+G+1]===0&&e.getBitXY(G+1,j+1)===O&&(k++,a[k&o]=G+1,b[k&o]=j+1,s[(j+1)*e.width+G+1]=-32768)),D++,k-D>o)throw new Error("analyseMask can not finish, the array to manage internal data is not big enough.You could improve mask by changing MAX_ARRAY")}}return new RoiMap(e,s)}class DisjointSet{constructor(){this.nodes=new Map}add(r){var t=this.nodes.get(r);return t||(t=new DisjointSetNode(r),this.nodes.set(r,t)),t}union(r,t){const o=this.find(r),s=this.find(t);o!==s&&(o.rank<s.rank?o.parent=s:o.rank>s.rank?s.parent=o:(s.parent=o,o.rank++))}find(r){for(var t=r;t.parent!==null;)t=t.parent;for(var o=r;o.parent!==null;){var s=o;o=o.parent,s.parent=t}return t}connected(r,t){return this.find(r)===this.find(t)}}var DisjointSet_1=DisjointSet;function DisjointSetNode(e){this.value=e,this.parent=null,this.rank=0}const DisjointSet$1=getDefaultExportFromCjs(DisjointSet_1),direction4X=[-1,0],direction4Y=[0,-1],neighbours4=[null,null],direction8X=[-1,-1,0,1],direction8Y=[0,-1,-1,-1],neighbours8=[null,null,null,null];function fromMaskConnectedComponentLabelingAlgorithm(e,r={}){const{allowCorners:t=!1}=r;let o=4;t&&(o=8);let s,d,g;if(o===8)s=direction8X,d=direction8Y,g=neighbours8;else if(o===4)s=direction4X,d=direction4Y,g=neighbours4;else throw new RangeError(`unsupported neighbours count: ${o}`);const a=e.size,b=e.width,_=e.height,T=new Array(a),C=new Uint32Array(a),D=new DisjointSet$1;let k=1;for(let O=0;O<_;O++)for(let U=0;U<b;U++){const G=U+O*b;if(e.getBit(G)){let j=null;for(let te=0;te<g.length;te++){const H=U+s[te],Z=O+d[te];if(H>=0&&Z>=0&&H<b&&Z<_){const W=H+Z*b;let _e=T[W];_e?(g[te]=_e,(!j||g[te].value<j.value)&&(j=g[te])):g[te]=null}}if(!j)T[G]=D.add(k++);else{T[G]=j;for(let te=0;te<g.length;te++)g[te]&&g[te]!==j&&D.union(j,g[te])}}}for(let O=0;O<_;O++)for(let U=0;U<b;U++){const G=U+O*b;e.getBit(G)&&(C[G]=D.find(T[G]).value)}return new RoiMap(e,C)}function fromMaxima(e={}){let{allowCorner:r=!0,onlyTop:t=!1,invert:o=!1}=e,s=this;s.checkProcessable("fromMaxima",{components:[1]});const d=1,g=2;let a=0,b=0,_=new Int16Array(s.size),T=new Int8Array(s.size),C=new Float32Array(s.size),D=1048575,k=new Uint16Array(D+1),O=new Uint16Array(D+1),U=0,G=0,j=new Uint16Array(D+1),te=new Uint16Array(D+1),H=0,Z=0;for(W(s);U<G;){let re=k[U&D],ae=O[U&D];fe(re,ae,g),U++}return new RoiMap(s,_);function W({maxima:re=!0}){for(let ae=1;ae<s.height-1;ae++)for(let J=1;J<s.width-1;J++){let se=J+ae*s.width;if(T[se]===0){let Me=re?s.data[se]:-s.data[J+ae*s.width];if(s.data[ae*s.width+J-1]>Me||s.data[ae*s.width+J+1]>Me||s.data[(ae-1)*s.width+J]>Me||s.data[(ae+1)*s.width+J]>Me||r&&(s.data[(ae-1)*s.width+J-1]>Me||s.data[(ae-1)*s.width+J+1]>Me||s.data[(ae+1)*s.width+J-1]>Me||s.data[(ae+1)*s.width+J+1]>Me))continue;_[se]=re?++a:--b,_e(J,ae)||(re?--a:++b)}}}function _e(re,ae){let J=G;H=0,Z=1,j[0]=re,te[0]=ae;let se=!0;for(;H<Z;){let Me=j[H&D],Ie=te[H&D];se&=fe(Me,Ie,d),H++}if(!se){for(let Me=0;Me<Z;Me++){let Ie=j[Me&D],Ge=te[Me&D]*s.width+Ie;_[Ge]=0}G=J}return se}function fe(re,ae,J){let se=_[ae*s.width+re],Me=s.data[ae*s.width+re];for(let Ie=ae-1;Ie<=ae+1;Ie++)for(let We=re-1;We<=re+1;We++){let Ge=Ie*s.width+We;if(T[Ge]===0)switch(T[Ge]=1,C[Ge]=s.data[Ge]-Me,J){case d:if(C[Ge]===0){if(We===0||Ie===0||We===s.width-1||Ie===s.height-1)return!1;_[Ge]=se,j[Z&D]=We,te[Z&D]=Ie,Z++}else{if(C[Ge]>0)return!1;t||(_[Ge]=se,k[G&D]=We,O[G&D]=Ie,G++)}break;case g:C[Ge]<=0&&(_[Ge]=se,k[G&D]=We,O[G&D]=Ie,G++);break;default:throw new Error("unreachable")}}return!0}}function fromPoints(e,r={}){let t=new Shape(r),o=new Int16Array(this.size),s=0,d=t.getPoints();for(let g=0;g<e.length;g++){s++;let a=e[g][0],b=e[g][1];for(let _=0;_<d.length;_++){let T=d[_][0],C=d[_][1];a+T>=0&&b+C>=0&&a+T<this.width&&b+C<this.height&&(o[a+T+(b+C)*this.width]=s)}}return new RoiMap(this,o)}function commonjsRequire(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var priorityQueue={exports:{}};(function(e,r){(function(t){e.exports=t()})(function(){return function t(o,s,d){function g(_,T){if(!s[_]){if(!o[_]){var C=typeof commonjsRequire=="function"&&commonjsRequire;if(!T&&C)return C(_,!0);if(a)return a(_,!0);var D=new Error("Cannot find module '"+_+"'");throw D.code="MODULE_NOT_FOUND",D}var k=s[_]={exports:{}};o[_][0].call(k.exports,function(O){var U=o[_][1][O];return g(U||O)},k,k.exports,t,o,s,d)}return s[_].exports}for(var a=typeof commonjsRequire=="function"&&commonjsRequire,b=0;b<d.length;b++)g(d[b]);return g}({1:[function(t,o,s){var d,g,a,b,_,T=function(D,k){for(var O in k)C.call(k,O)&&(D[O]=k[O]);function U(){this.constructor=D}return U.prototype=k.prototype,D.prototype=new U,D.__super__=k.prototype,D},C={}.hasOwnProperty;d=t("./PriorityQueue/AbstractPriorityQueue"),g=t("./PriorityQueue/ArrayStrategy"),b=t("./PriorityQueue/BinaryHeapStrategy"),a=t("./PriorityQueue/BHeapStrategy"),_=function(D){T(k,D);function k(O){O||(O={}),O.strategy||(O.strategy=b),O.comparator||(O.comparator=function(U,G){return(U||0)-(G||0)}),k.__super__.constructor.call(this,O)}return k}(d),_.ArrayStrategy=g,_.BinaryHeapStrategy=b,_.BHeapStrategy=a,o.exports=_},{"./PriorityQueue/AbstractPriorityQueue":2,"./PriorityQueue/ArrayStrategy":3,"./PriorityQueue/BHeapStrategy":4,"./PriorityQueue/BinaryHeapStrategy":5}],2:[function(t,o,s){o.exports=function(){function d(g){var a;if(g?.strategy==null)throw"Must pass options.strategy, a strategy";if(g?.comparator==null)throw"Must pass options.comparator, a comparator";this.priv=new g.strategy(g),this.length=(g!=null&&(a=g.initialValues)!=null?a.length:void 0)||0}return d.prototype.queue=function(g){this.length++,this.priv.queue(g)},d.prototype.dequeue=function(g){if(!this.length)throw"Empty queue";return this.length--,this.priv.dequeue()},d.prototype.peek=function(g){if(!this.length)throw"Empty queue";return this.priv.peek()},d.prototype.clear=function(){return this.length=0,this.priv.clear()},d}()},{}],3:[function(t,o,s){var d;d=function(g,a,b){var _,T,C;for(T=0,_=g.length;T<_;)C=T+_>>>1,b(g[C],a)>=0?T=C+1:_=C;return T},o.exports=function(){function g(a){var b;this.options=a,this.comparator=this.options.comparator,this.data=((b=this.options.initialValues)!=null?b.slice(0):void 0)||[],this.data.sort(this.comparator).reverse()}return g.prototype.queue=function(a){var b;b=d(this.data,a,this.comparator),this.data.splice(b,0,a)},g.prototype.dequeue=function(){return this.data.pop()},g.prototype.peek=function(){return this.data[this.data.length-1]},g.prototype.clear=function(){this.data.length=0},g}()},{}],4:[function(t,o,s){o.exports=function(){function d(g){var a,b,_,T,C,D,k,O;for(this.comparator=g?.comparator||function(U,G){return U-G},this.pageSize=g?.pageSize||512,this.length=0,k=0;1<<k<this.pageSize;)k+=1;if(1<<k!==this.pageSize)throw"pageSize must be a power of two";for(this._shift=k,this._emptyMemoryPageTemplate=a=[],b=0,C=this.pageSize;0<=C?b<C:b>C;0<=C?++b:--b)a.push(null);if(this._memory=[],this._mask=this.pageSize-1,g.initialValues)for(D=g.initialValues,_=0,T=D.length;_<T;_++)O=D[_],this.queue(O)}return d.prototype.queue=function(g){this.length+=1,this._write(this.length,g),this._bubbleUp(this.length,g)},d.prototype.dequeue=function(){var g,a;return g=this._read(1),a=this._read(this.length),this.length-=1,this.length>0&&(this._write(1,a),this._bubbleDown(1,a)),g},d.prototype.peek=function(){return this._read(1)},d.prototype.clear=function(){this.length=0,this._memory.length=0},d.prototype._write=function(g,a){var b;for(b=g>>this._shift;b>=this._memory.length;)this._memory.push(this._emptyMemoryPageTemplate.slice(0));return this._memory[b][g&this._mask]=a},d.prototype._read=function(g){return this._memory[g>>this._shift][g&this._mask]},d.prototype._bubbleUp=function(g,a){var b,_,T,C;for(b=this.comparator;g>1&&(_=g&this._mask,g<this.pageSize||_>3?T=g&~this._mask|_>>1:_<2?(T=g-this.pageSize>>this._shift,T+=T&~(this._mask>>1),T|=this.pageSize>>1):T=g-2,C=this._read(T),!(b(C,a)<0));)this._write(T,a),this._write(g,C),g=T},d.prototype._bubbleDown=function(g,a){var b,_,T,C,D;for(D=this.comparator;g<this.length;)if(g>this._mask&&!(g&this._mask-1)?b=_=g+2:g&this.pageSize>>1?(b=(g&~this._mask)>>1,b|=g&this._mask>>1,b=b+1<<this._shift,_=b+1):(b=g+(g&this._mask),_=b+1),b!==_&&_<=this.length)if(T=this._read(b),C=this._read(_),D(T,a)<0&&D(T,C)<=0)this._write(b,a),this._write(g,T),g=b;else if(D(C,a)<0)this._write(_,a),this._write(g,C),g=_;else break;else if(b<=this.length)if(T=this._read(b),D(T,a)<0)this._write(b,a),this._write(g,T),g=b;else break;else break},d}()},{}],5:[function(t,o,s){o.exports=function(){function d(g){var a;this.comparator=g?.comparator||function(b,_){return b-_},this.length=0,this.data=((a=g.initialValues)!=null?a.slice(0):void 0)||[],this._heapify()}return d.prototype._heapify=function(){var g,a,b;if(this.data.length>0)for(g=a=1,b=this.data.length;1<=b?a<b:a>b;g=1<=b?++a:--a)this._bubbleUp(g)},d.prototype.queue=function(g){this.data.push(g),this._bubbleUp(this.data.length-1)},d.prototype.dequeue=function(){var g,a;return a=this.data[0],g=this.data.pop(),this.data.length>0&&(this.data[0]=g,this._bubbleDown(0)),a},d.prototype.peek=function(){return this.data[0]},d.prototype.clear=function(){this.length=0,this.data.length=0},d.prototype._bubbleUp=function(g){for(var a,b;g>0&&(a=g-1>>>1,this.comparator(this.data[g],this.data[a])<0);)b=this.data[a],this.data[a]=this.data[g],this.data[g]=b,g=a},d.prototype._bubbleDown=function(g){var a,b,_,T,C;for(a=this.data.length-1;b=(g<<1)+1,T=b+1,_=g,b<=a&&this.comparator(this.data[b],this.data[_])<0&&(_=b),T<=a&&this.comparator(this.data[T],this.data[_])<0&&(_=T),_!==g;)C=this.data[_],this.data[_]=this.data[g],this.data[g]=C,g=_},d}()},{}]},{},[1])(1)})})(priorityQueue);var priorityQueueExports=priorityQueue.exports;const PriorityQueue=getDefaultExportFromCjs(priorityQueueExports),dxs=[1,0,-1,0,1,1,-1,-1],dys=[0,1,0,-1,1,-1,1,-1];function fromWaterShed(e={}){let{points:r,mask:t,image:o,fillMaxValue:s=this.maxValue,invert:d=!1}=e,g=o||this;g.checkProcessable("fromWaterShed",{bitDepth:[8,16],components:1}),d=!d,r||(r=g.getLocalMaxima({invert:d,mask:t}));let a=d?0:1,b=new Int16Array(g.size),_=g.width,T=g.height,C=new PriorityQueue({comparator:(D,k)=>D[2]-k[2],strategy:PriorityQueue.BinaryHeapStrategy});for(let D=0;D<r.length;D++){let k=r[D][0]+r[D][1]*_;b[k]=D+1;let O=g.data[k];(d&&O<=s||!d&&O>=s)&&C.queue([r[D][0],r[D][1],O])}for(;C.length>0;){let D=C.dequeue(),k=D[0]+D[1]*_;for(let O=0;O<4;O++){let U=D[0]+dxs[O],G=D[1]+dys[O];if(U>=0&&G>=0&&U<_&&G<T){let j=U+G*_;if(!t||t.getBit(j)===a){let te=g.data[j];(d&&te<=s||!d&&te>=s)&&b[j]===0&&(b[j]=b[k],C.queue([D[0]+dxs[O],D[1]+dys[O],te]))}}}}return new RoiMap(g,b)}class RoiManager{constructor(r,t={}){this._image=r,this._options=t,this._options.label||(this._options.label="default"),this._layers={},this._painted=null}fromMaxima(r={}){let t=Object.assign({},this._options,r),o=fromMaxima.call(this._image,r);this._layers[t.label]=new RoiLayer(o,t)}fromPoints(r,t={}){let o=Object.assign({},this._options,t),s=fromPoints.call(this._image,r,t);return this._layers[o.label]=new RoiLayer(s,o),this}putMap(r,t={}){let o=new RoiMap(this._image,r),s=Object.assign({},this._options,t);return this._layers[s.label]=new RoiLayer(o,s),this}fromWaterShed(r={}){let t=Object.assign({},this._options,r),o=fromWaterShed.call(this._image,r);this._layers[t.label]=new RoiLayer(o,t)}fromMask(r,t={}){let o=Object.assign({},this._options,t),s=fromMask.call(this._image,r,t);return this._layers[o.label]=new RoiLayer(s,o),this}fromMaskConnectedComponentLabelingAlgorithm(r,t={}){let o=Object.assign({},this._options,t),s=fromMaskConnectedComponentLabelingAlgorithm.call(this._image,r,t);return this._layers[o.label]=new RoiLayer(s,o),this}getMap(r={}){let t=Object.assign({},this._options,r);return this._assertLayerWithLabel(t.label),this._layers[t.label].roiMap}rowsInfo(r={}){return this.getMap(r).rowsInfo()}colsInfo(r={}){return this.getMap(r).rowsInfo()}getRoiIds(r={}){let t=this.getRois(r);if(t){let o=new Array(t.length);for(let s=0;s<t.length;s++)o[s]=t[s].id;return o}throw new Error("ROIs not found")}getRois(r={}){let{label:t=this._options.label,positive:o=!0,negative:s=!0,minSurface:d=0,maxSurface:g=Number.POSITIVE_INFINITY,minWidth:a=0,maxWidth:b=Number.POSITIVE_INFINITY,minHeight:_=0,maxHeight:T=Number.POSITIVE_INFINITY,minRatio:C=0,maxRatio:D=Number.POSITIVE_INFINITY}=r;if(!this._layers[t])throw new Error(`this Roi layer (${t}) does not exist`);const k=this._layers[t].roi,O=[];for(const U of k)(U.id<0&&s||U.id>0&&o)&&U.surface>=d&&U.surface<=g&&U.width>=a&&U.width<=b&&U.height>=_&&U.height<=T&&U.ratio>=C&&U.ratio<=D&&O.push(U);return O}getRoi(r,t={}){const{label:o=this._options.label}=t;if(!this._layers[o])throw new Error(`this Roi layer (${o}) does not exist`);const s=this._layers[o].roi.find(d=>d.id===r);if(!s)throw new Error(`found no Roi with id ${r}`);return s}getMasks(r={}){let t=this.getRois(r),o=new Array(t.length);for(let s=0;s<t.length;s++)o[s]=t[s].getMask(r);return o}getAnalysisMasks(r={}){const{analysisProperty:t}=r;let o=`${t}Mask`,s=this.getRois(r);return s.length===0||!s[0][o]?[]:s.map(d=>d[o])}getData(r={}){let t=Object.assign({},this._options,r);return this._assertLayerWithLabel(t.label),this._layers[t.label].roiMap.data}paint(r={}){let{labelProperty:t,analysisProperty:o}=r;this._painted||(this._painted=this._image.rgba8());let s=this.getMasks(r);if(t){const d=this.getRois(r);r.labels=d.map(_=>deepValue(_,t));const g=Math.max(...r.labels);let a=!1,b=!1;if(t.includes("surface")?a=!0:/(?:perimeter|min|max|external|width|height|length)/.test(t)&&(b=!0),isFinite(g)){let _="";if(r.unit!=="pixel"&&r.pixelSize&&(b||a)){_=a?`${r.unit}^2`:r.unit;let T=a?"m^2":"m",C=a?r.pixelSize**2:r.pixelSize;const D=Qty.swiftConverter(T,_);r.labels=r.labels.map(k=>D(C*k))}g>50?r.labels=r.labels.map(T=>Math.round(T)+_):g>10?r.labels=r.labels.map(T=>T.toFixed(1)+_):r.labels=r.labels.map(T=>T.toFixed(2)+_)}r.labelsPosition=d.map(_=>[_.meanX,_.meanY])}if(this._painted.paintMasks(s,r),o){let d=this.getAnalysisMasks(r);this._painted.paintMasks(d,{color:r.analysisColor,alpha:r.analysisAlpha})}return this._painted}getMask(r={}){let t=new Image(this._image.width,this._image.height,{kind:"BINARY"}),o=this.getMasks(r);for(let s=0;s<o.length;s++){let d=o[s];for(let g=0;g<d.width;g++)for(let a=0;a<d.height;a++)d.getBitXY(g,a)&&t.setBitXY(g+d.position[0],a+d.position[1])}return t}resetPainted(r={}){const{image:t}=r;t?this._painted=this.image.rgba8():this._painted=this._image.rgba8()}mergeRoi(r={}){const t=this.getMap(r);return t.mergeRoi(r),this.putMap(t.data,r),this}mergeRois(r,t={}){if(!Array.isArray(r)||r.some(s=>!Number.isInteger(s)))throw new Error("Roi ids must be an array of integers");if(r.length<2)throw new Error("Roi ids must have at least two elements");if(new Set(r).size!==r.length)throw new Error("Roi ids must be all different");r.forEach(s=>this.getRoi(s));const o=this.getMap(t);return o.mergeRois(r),this.putMap(o.data,t),this}findCorrespondingRoi(r,t={}){let o=this.getRois(t),s=[];for(let d=0;d<o.length;d++){let g=o[d],a=g.minX,b=g.minY,_=g.points,T=Math.sign(g.id),C=correspondingRoisInformation(a,b,_,r,T);s.push(C)}return s}_assertLayerWithLabel(r){if(!this._layers[r])throw new Error(`no layer with label ${r}`)}}function correspondingRoisInformation(e,r,t,o,s){let d={id:[],surface:[],roiSurfaceCovered:[],same:0,opposite:0,total:0};for(let g=0;g<t.length;g++){let a=t[g],b=a[0],_=a[1],T=b+e+(_+r)*o.width,C=o.data[T];(C>0||C<0)&&(d.id.includes(C)?d.surface[d.id.indexOf(C)]+=1:(d.id.push(C),d.surface.push(1)))}for(let g=0;g<d.id.length;g++)Math.sign(d.id[g])===s?d.same+=d.surface[g]:d.opposite+=d.surface[g],d.roiSurfaceCovered[g]=d.surface[g]/t.length;return d.total=d.opposite+d.same,d}const objectToString$1=Object.prototype.toString;class Image{constructor(r,t,o,s){if(arguments.length===1?(s=r,{width:r,height:t,data:o}=s):o&&!o.length&&(s=o,{data:o}=s),r===void 0&&(r=1),t===void 0&&(t=1),s===void 0&&(s={}),typeof s!="object"||s===null)throw new TypeError("options must be an object");if(!Number.isInteger(r)||r<=0)throw new RangeError("width must be a positive integer");if(!Number.isInteger(t)||t<=0)throw new RangeError("height must be a positive integer");const{kind:d=RGBA}=s;if(typeof d!="string")throw new TypeError("kind must be a string");const g=getKind(d),a=Object.assign({},s);for(const U in g)a[U]===void 0&&(a[U]=g[U]);verifyKindDefinition(a);const{components:b,bitDepth:_,colorModel:T}=a,C=a.alpha+0,D=r*t,k=b+C,O=_===32?Number.MAX_VALUE:2**_-1;if(o===void 0)o=createPixelArray(D,b,C,k,_,O);else{const U=getTheoreticalPixelArraySize(D,k,_);if(o.length!==U)throw new RangeError(`incorrect data size: ${o.length}. Should be ${U}`)}this.width=r,this.height=t,this.data=o,this.size=D,this.components=b,this.alpha=C,this.bitDepth=_,this.maxValue=O,this.colorModel=T,this.channels=k,this.meta=s.meta||{},Object.defineProperty(this,"parent",{enumerable:!1,writable:!0,configurable:!0,value:s.parent||null}),this.position=s.position||[0,0],this.computed=null,this.sizes=[this.width,this.height],this.multiplierX=this.channels,this.multiplierY=this.channels*this.width,this.isClamped=this.bitDepth<32,this.borderSizes=[0,0]}get[Symbol.toStringTag](){return"IJSImage"}static isImage(r){return objectToString$1.call(r)==="[object IJSImage]"}static fromCanvas(r){const o=r.getContext("2d").getImageData(0,0,r.width,r.height);return new Image(o.width,o.height,o.data)}static createFrom(r,t){const o=getImageParameters(r);return Object.assign(o,{parent:r,position:[0,0]},t),new Image(o)}getRoiManager(r){return new RoiManager(this,r)}clone(){const r=this.data.slice();return new Image(this.width,this.height,r,this)}apply(r){for(let t=0;t<this.height;t++)for(let o=0;o<this.width;o++){let s=(t*this.width+o)*this.channels;r.call(this,s)}}}setValueMethods(Image);setBitMethods(Image);setExportMethods(Image);Image.prototype.checkProcessable=checkProcessable;Image.prototype.getRGBAData=getRGBAData;Image.load=load;Image.extendMethod=extendMethod;Image.extendProperty=extendProperty;extend$4(Image);var workerTemplate$1={},worker$1=function(){self.window=self;function e(){this._listeners={}}e.prototype.on=function(t,o){if(this._listeners[t])throw new RangeError("there is already a listener for "+t);if(typeof o!="function")throw new TypeError("callback argument must be a function");this._listeners[t]=o},e.prototype._send=function(t,o,s){s===void 0?s=[]:Array.isArray(s)||(s=[s]),self.postMessage({id:t,data:o},s)},e.prototype._trigger=function(t,o){if(!this._listeners[t])throw new Error("event "+t+" is not defined");this._listeners[t].apply(null,o)};var r=new e;self.onmessage=function(t){switch(t.data.action){case"exec":t.data.args.unshift(function(o,s){r._send(t.data.id,o,s)}),r._trigger(t.data.event,t.data.args);break;case"ping":r._send(t.data.id,"pong");break;default:throw new Error("unexpected action: "+t.data.action)}}},workerStr=worker$1.toString().split('"CODE";');workerTemplate$1.newWorkerURL=function e(r,t){var o=new Blob(["(",workerStr[0],"importScripts.apply(self, "+JSON.stringify(t)+`);
`,"(",r,")();",workerStr[1],")();"],{type:"application/javascript"});return URL.createObjectURL(o)};var workerTemplate=workerTemplate$1,CORES=navigator.hardwareConcurrency||1;function WorkerManager(e,r){if(typeof e!="string"&&typeof e!="function")throw new TypeError("func argument must be a function");if(r===void 0&&(r={}),typeof r!="object"||r===null)throw new TypeError("options argument must be an object");this._workerCode=e.toString(),r.maxWorkers===void 0||r.maxWorkers==="auto"?this._numWorkers=Math.min(CORES-1,1):r.maxWorkers>0?this._numWorkers=Math.min(r.maxWorkers,CORES):this._numWorkers=CORES,this._workers=new Map,this._timeout=r.timeout||0,this._terminateOnError=!!r.terminateOnError;var t=r.deps;typeof t=="string"&&(t=[t]),Array.isArray(t)||(t=void 0),this._id=0,this._terminated=!1,this._working=0,this._waiting=[],this._init(t)}WorkerManager.prototype._init=function(e){for(var r=workerTemplate.newWorkerURL(this._workerCode,e),t=0;t<this._numWorkers;t++){var o=new Worker(r);o.onmessage=this._onmessage.bind(this,o),o.onerror=this._onerror.bind(this,o),o.running=!1,o.id=t,this._workers.set(o,null)}URL.revokeObjectURL(r)};WorkerManager.prototype._onerror=function(e,r){if(!this._terminated){this._working--,e.running=!1;var t=this._workers.get(e);t&&t[1](r.message),this._workers.set(e,null),this._terminateOnError?this.terminate():this._exec()}};WorkerManager.prototype._onmessage=function(e,r){if(!this._terminated){this._working--,e.running=!1;var t=this._workers.get(e);t&&t[0](r.data.data),this._workers.set(e,null),this._exec()}};WorkerManager.prototype._exec=function(){for(var e of this._workers.keys()){if(this._working===this._numWorkers||this._waiting.length===0)return;if(!e.running)for(var r=0;r<this._waiting.length;r++){var t=this._waiting[r];if(!(typeof t[4]=="number"&&t[4]!==e.id)){this._waiting.splice(r,1),e.postMessage({action:"exec",event:t[0],args:t[1]},t[2]),e.running=!0,e.time=Date.now(),this._workers.set(e,t[3]),this._working++;break}}}};WorkerManager.prototype.terminate=function(){if(!this._terminated){for(var e of this._workers)e[0].terminate(),e[1]&&e[1][1](new Error("Terminated"));this._workers.clear(),this._waiting=[],this._working=0,this._terminated=!0}};WorkerManager.prototype.postAll=function(e,r){if(this._terminated)throw new Error("Cannot post (terminated)");var t=[];for(var o of this._workers.keys())t.push(this.post(e,r,[],o.id));return Promise.all(t)};WorkerManager.prototype.post=function(e,r,t,o){r===void 0&&(r=[]),t===void 0&&(t=[]),Array.isArray(r)||(r=[r]),Array.isArray(t)||(t=[t]);var s=this;return new Promise(function(d,g){if(s._terminated)throw new Error("Cannot post (terminated)");s._waiting.push([e,r,t,[d,g],o]),s._exec()})};var src=WorkerManager;const WorkerManager$1=getDefaultExportFromCjs(src),defaultOptions={regression:{kernelType:"polynomial",kernelOptions:{degree:2,constant:1}},threshold:.02,roi:{minSurface:100,positive:!1},sampling:20,include:[]};function run(e,r,t){r=Object.assign({},defaultOptions,r);const o=this.manager;return Array.isArray(e)?Promise.all(e.map(function(s){const d=runOnce(o,s,r);return typeof t=="function"&&d.then(t),d})):runOnce(o,e,r)}function runOnce(e,r,t){return e.post("data",[r,t]).then(function(o){for(let s in o)o[s]=new Image(o[s]);return o})}function work(){worker.on("data",function(e,r,t){r=new IJS(r);const o={},s=[],d=r.grey(),g=d.sobelFilter();k("sobel",g);const a=g.level().mask({threshold:t.threshold});k("mask",a);const b=g.getRoiManager();b.fromMask(a);const _=b.getMask(t.roi);k("realMask",_);const T=d.getPixelsGrid({sampling:t.sampling,mask:_}),C=r.getBackground(T.xyS,T.zS,t.regression);k("background",C);const D=r.subtract(C);o.result=D,s.push(D.data.buffer),e(o,s);function k(O,U){t.include.includes(O)&&(o[O]=U,s.push(U.data.buffer))}})}const background={run,work};function extend$3(e){e.extendMethod("background",background)}let Worker$1=class Np{constructor(){this._url=null,this._deps=[null]}checkUrl(){if(this._url===null)throw new Error("image worker must be initialized with an URL")}get url(){return this._url}set url(r){if(typeof r!="string")throw new TypeError("worker URL must be a string");this._url=r,this._deps[0]=r}static extendMethod(r,t){let o,s,d={};function g(...a){return o||(this.checkUrl(),s=this.url,o=new WorkerManager$1(t.work,{deps:s}),d.manager=o),t.run.call(d,...a)}g.reset=function(){o&&(o.terminate(),o=new WorkerManager$1(t.work,{deps:s}),d.manager=o)},Np.prototype[r]=g}};extend$3(Worker$1);function getTileInfo(e,r,t,o,s,d,g){let a={},b;t===!1&&(b=tilebelt$1.pointToTile(e,r,d),o=b[0],s=b[1]);let _=40075016686e-3*Math.abs(Math.cos(r))/Math.pow(2,d),T=_/512;a.z=d,a.x=o,a.y=s,a.pointLng=e,a.pointLat=r,a.tileWidthInMeters=_,a.metersPerPixel=T,a.mapboxTileName=a.z+"-"+a.x+"-"+a.y,a.tile=[a.x,a.y,a.z],t===!1?a.bbox=tilebelt$1.tileToBBOX(a.tile):a.bbox=g,a.polygon_bb=getTileGeoJsonBB(a.bbox),a.area_bb=getAreaBB(a.bbox);const C=new mapboxgl.LngLatBounds(a.bbox);a.bboxCT=C.getCenter(),a.bboxSW=C.getSouthWest(),a.bboxNE=C.getNorthEast(),a.bboxNW=C.getNorthWest(),a.bboxSE=C.getSouthEast(),a.bboxW=C.getWest().toFixed(5),a.bboxS=C.getSouth().toFixed(5),a.bboxE=C.getEast().toFixed(5),a.bboxN=C.getNorth().toFixed(5),a.topLeft=a.bboxNW,a.bottomLeft=a.bboxSW,a.topRight=a.bboxNE,a.bottomRight=a.bboxSE,a.center=a.bboxCT;const D=point([a.bboxNE.lng,a.bboxNE.lat]),k=point([a.bboxSW.lng,a.bboxNE.lat]),O=point([a.bboxNE.lng,a.bboxSW.lat]),U=point([a.bboxSW.lng,a.bboxSW.lat]),G=midpoint(D,O),j=midpoint(k,U);return a.distance=distance(G,j,"kilometers").toFixed(2),a.maxPngValue=65535,a.rgbFileName="terrain-rgb-"+a.mapboxTileName+".png",a.thirtyTwoFileName="thirtytwo-"+a.mapboxTileName+".png",a.tileInfoFileName="tile-info-"+a.mapboxTileName+".json",a.geoJsonFileName="geojson-"+a.mapboxTileName+".json",a}function getAreaBB(e){let r=bboxPolygon(e);return area(r)}function getTileGeoJsonBB(e){let r=bboxPolygon(e);return{type:"Feature",geometry:{type:r.geometry.type,coordinates:r.geometry.coordinates}}}function getFeaturesFromBB(e,r,t){r.swPt=e.project(r.bboxSW),r.nePt=e.project(r.bboxNE),r.nwPt=e.project(r.bboxNW),r.sePt=e.project(r.bboxSE);let o=e.queryRenderedFeatures([r.swPt,r.nePt]);return t===!0&&(o=getUniqueFeatures(o)),o}function getUniqueFeatures(e){const r=new Set,t=[];for(const o of e){const s=o.properties.name,d=o.geometry.type;let g=s+"-"+d;r.has(g)||(r.add(g),t.push(o))}return t}async function loadImageFromArray(e){try{return await Image.load(e)}catch(r){console.log(r)}}function getHeightFromRgb(e,r,t){return-1e4+(e*256*256+r*256+t)*.1}function getHeightArray(e){let r=[],t=e.getPixelsArray();for(const o of t){let s=o[0],d=o[1],g=o[2],a=getHeightFromRgb(s,d,g);a=parseFloat(a),r.push(a)}return r}async function downloadTerrainRgb(e){return await(await fetch(e)).arrayBuffer()}async function unrealRemoteControl(e,r){let t,o={},s="";const d={method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};try{t=await fetch(r,d)}catch(g){s=g}return o.response=t,o.error=s,o}async function getMapboxTerrainRgb(e){let r,t;return r=await downloadTerrainRgb(e),t=await loadImageFromArray(r),idbKeyval.set("rgbImageArrayBuffer",r),t}function convertImage(e,r,t,o,s){return new Image(e,r,t,{kind:s,bitDepth:o})}function createHeightMapImage(e,r,t){let o={},s=getHeightArray(e);idbKeyval.set("decodedHeightArray",s);let d=convertImage(e.width,e.height,s,r,t);return o.minElevation=d.min[0],o.maxElevation=d.max[0],o.image=d,o.decodedHeightArray=s,o}const mapUtils={getTileInfo,getFeaturesFromBB,getMapboxTerrainRgb,createHeightMapImage,loadImageFromArray,unrealRemoteControl,downloadTerrainRgb,convertImage,getTileGeoJsonBB};function mitt(e){return{all:e=e||new Map,on:function(r,t){var o=e.get(r);o?o.push(t):e.set(r,[t])},off:function(r,t){var o=e.get(r);o&&(t?o.splice(o.indexOf(t)>>>0,1):e.set(r,[]))},emit:function(r,t){var o=e.get(r);o&&o.slice().map(function(s){s(t)}),(o=e.get("*"))&&o.slice().map(function(s){s(r,t)})}}}const emitter=mitt();var immutable=extend$2,hasOwnProperty=Object.prototype.hasOwnProperty;function extend$2(){for(var e={},r=0;r<arguments.length;r++){var t=arguments[r];for(var o in t)hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}var fuzzy$1={exports:{}};(function(e,r){(function(){var t={};e.exports=t,t.simpleFilter=function(o,s){return s.filter(function(d){return t.test(o,d)})},t.test=function(o,s){return t.match(o,s)!==null},t.match=function(o,s,d){d=d||{};var g=0,a=[],b=s.length,_=0,T=0,C=d.pre||"",D=d.post||"",k=d.caseSensitive&&s||s.toLowerCase(),O;o=d.caseSensitive&&o||o.toLowerCase();for(var U=0;U<b;U++)O=s[U],k[U]===o[g]?(O=C+O+D,g+=1,T+=1+T):T=0,_+=T,a[a.length]=O;return g===o.length?(_=k===o?1/0:_,{rendered:a.join(""),score:_}):null},t.filter=function(o,s,d){return!s||s.length===0?[]:typeof o!="string"?s:(d=d||{},s.reduce(function(g,a,b,_){var T=a;d.extract&&(T=d.extract(a));var C=t.match(o,T,d);return C!=null&&(g[g.length]={string:C.rendered,score:C.score,index:b,original:a}),g},[]).sort(function(g,a){var b=a.score-g.score;return b||g.index-a.index}))}})()})(fuzzy$1);var fuzzyExports=fuzzy$1.exports,List$1=function(e){return this.component=e,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,e.el.parentNode.insertBefore(this.wrapper,e.el.nextSibling),this};List$1.prototype.show=function(){this.element.style.display="block"};List$1.prototype.hide=function(){this.element.style.display="none"};List$1.prototype.add=function(e){this.items.push(e)};List$1.prototype.clear=function(){this.items=[],this.active=0};List$1.prototype.isEmpty=function(){return!this.items.length};List$1.prototype.isVisible=function(){return this.element.style.display==="block"};List$1.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var e=0;e<this.items.length;e++)this.drawItem(this.items[e],this.active===e);this.show()};List$1.prototype.drawItem=function(e,r){var t=document.createElement("li"),o=document.createElement("a");r&&(t.className+=" active"),o.innerHTML=e.string,t.appendChild(o),this.element.appendChild(t),t.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),t.addEventListener("mouseup",function(){this.handleMouseUp.call(this,e)}.bind(this))};List$1.prototype.handleMouseUp=function(e){this.selectingListItem=!1,this.component.value(e.original),this.clear(),this.draw()};List$1.prototype.move=function(e){this.active=e,this.draw()};List$1.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};List$1.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};List$1.prototype.drawError=function(e){var r=document.createElement("li");r.innerHTML=e,this.element.appendChild(r),this.show()};var list=List$1,extend$1=immutable,fuzzy=fuzzyExports,List=list,Suggestions$1=function(e,r,t){return t=t||{},this.options=extend$1({minLength:2,limit:5,filter:!0,hideOnBlur:!0},t),this.el=e,this.data=r||[],this.list=new List(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",function(o){this.handleKeyUp(o.keyCode)}.bind(this),!1),this.el.addEventListener("keydown",function(o){this.handleKeyDown(o)}.bind(this)),this.el.addEventListener("focus",function(){this.handleFocus()}.bind(this)),this.el.addEventListener("blur",function(){this.handleBlur()}.bind(this)),this.el.addEventListener("paste",function(o){this.handlePaste(o)}.bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};Suggestions$1.prototype.handleKeyUp=function(e){e===40||e===38||e===27||e===13||e===9||this.handleInputChange(this.el.value)};Suggestions$1.prototype.handleKeyDown=function(e){switch(e.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&e.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};Suggestions$1.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};Suggestions$1.prototype.handlePaste=function(e){if(e.clipboardData)this.handleInputChange(e.clipboardData.getData("Text"));else{var r=this;setTimeout(function(){r.handleInputChange(e.target.value)},100)}};Suggestions$1.prototype.handleInputChange=function(e){if(this.query=this.normalize(e),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates(function(r){for(var t=0;t<r.length&&(this.list.add(r[t]),t!==this.options.limit-1);t++);this.list.draw()}.bind(this))};Suggestions$1.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};Suggestions$1.prototype.update=function(e){this.data=e,this.handleKeyUp()};Suggestions$1.prototype.clear=function(){this.data=[],this.list.clear()};Suggestions$1.prototype.normalize=function(e){return e=e.toLowerCase(),e};Suggestions$1.prototype.match=function(e,r){return e.indexOf(r)>-1};Suggestions$1.prototype.value=function(e){if(this.selected=e,this.el.value=this.getItemValue(e),document.createEvent){var r=document.createEvent("HTMLEvents");r.initEvent("change",!0,!1),this.el.dispatchEvent(r)}else this.el.fireEvent("onchange")};Suggestions$1.prototype.getCandidates=function(e){var r={pre:"<strong>",post:"</strong>",extract:function(o){return this.getItemValue(o)}.bind(this)},t;this.options.filter?(t=fuzzy.filter(this.query,this.data,r),t=t.map(function(o){return{original:o.original,string:this.render(o.original,o.string)}}.bind(this))):t=this.data.map(function(o){var s=this.render(o);return{original:o,string:s}}.bind(this)),e(t)};Suggestions$1.prototype.getItemValue=function(e){return e};Suggestions$1.prototype.render=function(e,r){if(r)return r;for(var t=e.original?this.getItemValue(e.original):this.getItemValue(e),o=this.normalize(t),s=o.lastIndexOf(this.query);s>-1;){var d=s+this.query.length;t=t.slice(0,s)+"<strong>"+t.slice(s,d)+"</strong>"+t.slice(d),s=o.slice(0,s).lastIndexOf(this.query)}return t};Suggestions$1.prototype.renderError=function(e){this.list.drawError(e)};var suggestions$1=Suggestions$1,Suggestions=suggestions$1,suggestions=Suggestions;typeof window<"u"&&(window.Suggestions=Suggestions);var FUNC_ERROR_TEXT="Expected a function",NAN=0/0,symbolTag="[object Symbol]",reTrim=/^\s+|\s+$/g,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsOctal=/^0o[0-7]+$/i,freeParseInt=parseInt,freeGlobal=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf=typeof self=="object"&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),objectProto=Object.prototype,objectToString=objectProto.toString,nativeMax=Math.max,nativeMin=Math.min,now=function(){return root.Date.now()};function debounce$1(e,r,t){var o,s,d,g,a,b,_=0,T=!1,C=!1,D=!0;if(typeof e!="function")throw new TypeError(FUNC_ERROR_TEXT);r=toNumber(r)||0,isObject(t)&&(T=!!t.leading,C="maxWait"in t,d=C?nativeMax(toNumber(t.maxWait)||0,r):d,D="trailing"in t?!!t.trailing:D);function k(_e){var fe=o,re=s;return o=s=void 0,_=_e,g=e.apply(re,fe),g}function O(_e){return _=_e,a=setTimeout(j,r),T?k(_e):g}function U(_e){var fe=_e-b,re=_e-_,ae=r-fe;return C?nativeMin(ae,d-re):ae}function G(_e){var fe=_e-b,re=_e-_;return b===void 0||fe>=r||fe<0||C&&re>=d}function j(){var _e=now();if(G(_e))return te(_e);a=setTimeout(j,U(_e))}function te(_e){return a=void 0,D&&o?k(_e):(o=s=void 0,g)}function H(){a!==void 0&&clearTimeout(a),_=0,o=b=s=a=void 0}function Z(){return a===void 0?g:te(now())}function W(){var _e=now(),fe=G(_e);if(o=arguments,s=this,b=_e,fe){if(a===void 0)return O(b);if(C)return a=setTimeout(j,r),k(b)}return a===void 0&&(a=setTimeout(j,r)),g}return W.cancel=H,W.flush=Z,W}function isObject(e){var r=typeof e;return!!e&&(r=="object"||r=="function")}function isObjectLike(e){return!!e&&typeof e=="object"}function isSymbol(e){return typeof e=="symbol"||isObjectLike(e)&&objectToString.call(e)==symbolTag}function toNumber(e){if(typeof e=="number")return e;if(isSymbol(e))return NAN;if(isObject(e)){var r=typeof e.valueOf=="function"?e.valueOf():e;e=isObject(r)?r+"":r}if(typeof e!="string")return e===0?e:+e;e=e.replace(reTrim,"");var t=reIsBinary.test(e);return t||reIsOctal.test(e)?freeParseInt(e.slice(2),t?2:8):reIsBadHex.test(e)?NAN:+e}var lodash_debounce=debounce$1,events$1={exports:{}},R=typeof Reflect=="object"?Reflect:null,ReflectApply=R&&typeof R.apply=="function"?R.apply:function e(r,t,o){return Function.prototype.apply.call(r,t,o)},ReflectOwnKeys;R&&typeof R.ownKeys=="function"?ReflectOwnKeys=R.ownKeys:Object.getOwnPropertySymbols?ReflectOwnKeys=function(r){return Object.getOwnPropertyNames(r).concat(Object.getOwnPropertySymbols(r))}:ReflectOwnKeys=function(r){return Object.getOwnPropertyNames(r)};function ProcessEmitWarning(e){console&&console.warn&&console.warn(e)}var NumberIsNaN=Number.isNaN||function e(r){return r!==r};function EventEmitter$3(){EventEmitter$3.init.call(this)}events$1.exports=EventEmitter$3;events$1.exports.once=once;EventEmitter$3.EventEmitter=EventEmitter$3;EventEmitter$3.prototype._events=void 0;EventEmitter$3.prototype._eventsCount=0;EventEmitter$3.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(EventEmitter$3,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(e){if(typeof e!="number"||e<0||NumberIsNaN(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");defaultMaxListeners=e}});EventEmitter$3.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};EventEmitter$3.prototype.setMaxListeners=function e(r){if(typeof r!="number"||r<0||NumberIsNaN(r))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+r+".");return this._maxListeners=r,this};function _getMaxListeners(e){return e._maxListeners===void 0?EventEmitter$3.defaultMaxListeners:e._maxListeners}EventEmitter$3.prototype.getMaxListeners=function e(){return _getMaxListeners(this)};EventEmitter$3.prototype.emit=function e(r){for(var t=[],o=1;o<arguments.length;o++)t.push(arguments[o]);var s=r==="error",d=this._events;if(d!==void 0)s=s&&d.error===void 0;else if(!s)return!1;if(s){var g;if(t.length>0&&(g=t[0]),g instanceof Error)throw g;var a=new Error("Unhandled error."+(g?" ("+g.message+")":""));throw a.context=g,a}var b=d[r];if(b===void 0)return!1;if(typeof b=="function")ReflectApply(b,this,t);else for(var _=b.length,T=arrayClone(b,_),o=0;o<_;++o)ReflectApply(T[o],this,t);return!0};function _addListener(e,r,t,o){var s,d,g;if(checkListener(t),d=e._events,d===void 0?(d=e._events=Object.create(null),e._eventsCount=0):(d.newListener!==void 0&&(e.emit("newListener",r,t.listener?t.listener:t),d=e._events),g=d[r]),g===void 0)g=d[r]=t,++e._eventsCount;else if(typeof g=="function"?g=d[r]=o?[t,g]:[g,t]:o?g.unshift(t):g.push(t),s=_getMaxListeners(e),s>0&&g.length>s&&!g.warned){g.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+g.length+" "+String(r)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=r,a.count=g.length,ProcessEmitWarning(a)}return e}EventEmitter$3.prototype.addListener=function e(r,t){return _addListener(this,r,t,!1)};EventEmitter$3.prototype.on=EventEmitter$3.prototype.addListener;EventEmitter$3.prototype.prependListener=function e(r,t){return _addListener(this,r,t,!0)};function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(e,r,t){var o={fired:!1,wrapFn:void 0,target:e,type:r,listener:t},s=onceWrapper.bind(o);return s.listener=t,o.wrapFn=s,s}EventEmitter$3.prototype.once=function e(r,t){return checkListener(t),this.on(r,_onceWrap(this,r,t)),this};EventEmitter$3.prototype.prependOnceListener=function e(r,t){return checkListener(t),this.prependListener(r,_onceWrap(this,r,t)),this};EventEmitter$3.prototype.removeListener=function e(r,t){var o,s,d,g,a;if(checkListener(t),s=this._events,s===void 0)return this;if(o=s[r],o===void 0)return this;if(o===t||o.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[r],s.removeListener&&this.emit("removeListener",r,o.listener||t));else if(typeof o!="function"){for(d=-1,g=o.length-1;g>=0;g--)if(o[g]===t||o[g].listener===t){a=o[g].listener,d=g;break}if(d<0)return this;d===0?o.shift():spliceOne(o,d),o.length===1&&(s[r]=o[0]),s.removeListener!==void 0&&this.emit("removeListener",r,a||t)}return this};EventEmitter$3.prototype.off=EventEmitter$3.prototype.removeListener;EventEmitter$3.prototype.removeAllListeners=function e(r){var t,o,s;if(o=this._events,o===void 0)return this;if(o.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):o[r]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete o[r]),this;if(arguments.length===0){var d=Object.keys(o),g;for(s=0;s<d.length;++s)g=d[s],g!=="removeListener"&&this.removeAllListeners(g);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=o[r],typeof t=="function")this.removeListener(r,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(r,t[s]);return this};function _listeners(e,r,t){var o=e._events;if(o===void 0)return[];var s=o[r];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?unwrapListeners(s):arrayClone(s,s.length)}EventEmitter$3.prototype.listeners=function e(r){return _listeners(this,r,!0)};EventEmitter$3.prototype.rawListeners=function e(r){return _listeners(this,r,!1)};EventEmitter$3.listenerCount=function(e,r){return typeof e.listenerCount=="function"?e.listenerCount(r):listenerCount.call(e,r)};EventEmitter$3.prototype.listenerCount=listenerCount;function listenerCount(e){var r=this._events;if(r!==void 0){var t=r[e];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}EventEmitter$3.prototype.eventNames=function e(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(e,r){for(var t=new Array(r),o=0;o<r;++o)t[o]=e[o];return t}function spliceOne(e,r){for(;r+1<e.length;r++)e[r]=e[r+1];e.pop()}function unwrapListeners(e){for(var r=new Array(e.length),t=0;t<r.length;++t)r[t]=e[t].listener||e[t];return r}function once(e,r){return new Promise(function(t,o){function s(g){e.removeListener(r,d),o(g)}function d(){typeof e.removeListener=="function"&&e.removeListener("error",s),t([].slice.call(arguments))}eventTargetAgnosticAddListener(e,r,d,{once:!0}),r!=="error"&&addErrorHandlerIfEventEmitter(e,s,{once:!0})})}function addErrorHandlerIfEventEmitter(e,r,t){typeof e.on=="function"&&eventTargetAgnosticAddListener(e,"error",r,t)}function eventTargetAgnosticAddListener(e,r,t,o){if(typeof e.on=="function")o.once?e.once(r,t):e.on(r,t);else if(typeof e.addEventListener=="function")e.addEventListener(r,function s(d){o.once&&e.removeEventListener(r,s),t(d)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}var eventsExports=events$1.exports,exceptions$1={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}};function parseParam$1(e){var r=e.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return r?{key:r[1],value:r[2]}:null}function parseLink$1(e){var r=e.match(/<?([^>]*)>(.*)/);if(!r)return null;var t=r[1],o=r[2].split(";"),s=null,d=o.reduce(function(g,a){var b=parseParam$1(a);return b?b.key==="rel"?(s||(s=b.value),g):(g[b.key]=b.value,g):g},{});return s?{url:t,rel:s,params:d}:null}function parseLinkHeader$3(e){return e?e.split(/,\s*</).reduce(function(r,t){var o=parseLink$1(t);if(!o)return r;var s=o.rel.split(/\s+/);return s.forEach(function(d){r[d]||(r[d]={url:o.url,params:o.params})}),r},{}):{}}var parseLinkHeader_1$1=parseLinkHeader$3,parseLinkHeader$2=parseLinkHeader_1$1;function MapiResponse$3(e,r){this.request=e,this.headers=r.headers,this.rawBody=r.body,this.statusCode=r.statusCode;try{this.body=JSON.parse(r.body||"{}")}catch{this.body=r.body}this.links=parseLinkHeader$2(this.headers.link)}MapiResponse$3.prototype.hasNextPage=function e(){return!!this.links.next};MapiResponse$3.prototype.nextPage=function e(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};var mapiResponse$1=MapiResponse$3,constants$9={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"},constants$8=constants$9;function MapiError$3(e){var r=e.type||constants$8.ERROR_HTTP,t;if(e.body)try{t=JSON.parse(e.body)}catch{t=e.body}else t=null;var o=e.message||null;o||(typeof t=="string"?o=t:t&&typeof t.message=="string"?o=t.message:r===constants$8.ERROR_REQUEST_ABORTED&&(o="Request aborted")),this.message=o,this.type=r,this.statusCode=e.statusCode||null,this.request=e.request,this.body=t}var mapiError$1=MapiError$3;function parseSingleHeader$1(e){var r=e.indexOf(":"),t=e.substring(0,r).trim().toLowerCase(),o=e.substring(r+1).trim();return{name:t,value:o}}function parseHeaders$3(e){var r={};return e&&e.trim().split(/[\r|\n]+/).forEach(function(t){var o=parseSingleHeader$1(t);r[o.name]=o.value}),r}var parseHeaders_1$1=parseHeaders$3,MapiResponse$2=mapiResponse$1,MapiError$2=mapiError$1,constants$7=constants$9,parseHeaders$2=parseHeaders_1$1,requestsUnderway$1={};function browserAbort$1(e){var r=requestsUnderway$1[e.id];r&&(r.abort(),delete requestsUnderway$1[e.id])}function createResponse$1(e,r){return new MapiResponse$2(e,{body:r.response,headers:parseHeaders$2(r.getAllResponseHeaders()),statusCode:r.status})}function normalizeBrowserProgressEvent$1(e){var r=e.total,t=e.loaded,o=100*t/r;return{total:r,transferred:t,percent:o}}function sendRequestXhr$1(e,r){return new Promise(function(t,o){r.onprogress=function(g){e.emitter.emit(constants$7.EVENT_PROGRESS_DOWNLOAD,normalizeBrowserProgressEvent$1(g))};var s=e.file;s&&(r.upload.onprogress=function(g){e.emitter.emit(constants$7.EVENT_PROGRESS_UPLOAD,normalizeBrowserProgressEvent$1(g))}),r.onerror=function(g){o(g)},r.onabort=function(){var g=new MapiError$2({request:e,type:constants$7.ERROR_REQUEST_ABORTED});o(g)},r.onload=function(){if(delete requestsUnderway$1[e.id],r.status<200||r.status>=400){var g=new MapiError$2({request:e,body:r.response,statusCode:r.status});o(g);return}t(r)};var d=e.body;typeof d=="string"?r.send(d):d?r.send(JSON.stringify(d)):s?r.send(s):r.send(),requestsUnderway$1[e.id]=r}).then(function(t){return createResponse$1(e,t)})}function createRequestXhr$1(e,r){var t=e.url(r),o=new window.XMLHttpRequest;return o.open(e.method,t),Object.keys(e.headers).forEach(function(s){o.setRequestHeader(s,e.headers[s])}),o}function browserSend$1(e){return Promise.resolve().then(function(){var r=createRequestXhr$1(e,e.client.accessToken);return sendRequestXhr$1(e,r)})}var browserLayer$1={browserAbort:browserAbort$1,sendRequestXhr:sendRequestXhr$1,browserSend:browserSend$1,createRequestXhr:createRequestXhr$1},base64$1={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */base64$1.exports;(function(e,r){(function(t){var o=r,s=e&&e.exports==o&&e,d=typeof commonjsGlobal=="object"&&commonjsGlobal;(d.global===d||d.window===d)&&(t=d);var g=function(O){this.message=O};g.prototype=new Error,g.prototype.name="InvalidCharacterError";var a=function(O){throw new g(O)},b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",_=/[\t\n\f\r ]/g,T=function(O){O=String(O).replace(_,"");var U=O.length;U%4==0&&(O=O.replace(/==?$/,""),U=O.length),(U%4==1||/[^+a-zA-Z0-9/]/.test(O))&&a("Invalid character: the string to be decoded is not correctly encoded.");for(var G=0,j,te,H="",Z=-1;++Z<U;)te=b.indexOf(O.charAt(Z)),j=G%4?j*64+te:te,G++%4&&(H+=String.fromCharCode(255&j>>(-2*G&6)));return H},C=function(O){O=String(O),/[^\0-\xFF]/.test(O)&&a("The string to be encoded contains characters outside of the Latin1 range.");for(var U=O.length%3,G="",j=-1,te,H,Z,W,_e=O.length-U;++j<_e;)te=O.charCodeAt(j)<<16,H=O.charCodeAt(++j)<<8,Z=O.charCodeAt(++j),W=te+H+Z,G+=b.charAt(W>>18&63)+b.charAt(W>>12&63)+b.charAt(W>>6&63)+b.charAt(W&63);return U==2?(te=O.charCodeAt(j)<<8,H=O.charCodeAt(++j),W=te+H,G+=b.charAt(W>>10)+b.charAt(W>>4&63)+b.charAt(W<<2&63)+"="):U==1&&(W=O.charCodeAt(j),G+=b.charAt(W>>2)+b.charAt(W<<4&63)+"=="),G},D={encode:C,decode:T,version:"0.1.0"};if(o&&!o.nodeType)if(s)s.exports=D;else for(var k in D)D.hasOwnProperty(k)&&(o[k]=D[k]);else t.base64=D})(commonjsGlobal)})(base64$1,base64$1.exports);var base64Exports=base64$1.exports,base64=base64Exports,tokenCache={};function parseToken$4(e){if(tokenCache[e])return tokenCache[e];var r=e.split("."),t=r[0],o=r[1];if(!o)throw new Error("Invalid token");var s=parsePaylod(o),d={usage:t,user:s.u};return has(s,"a")&&(d.authorization=s.a),has(s,"exp")&&(d.expires=s.exp*1e3),has(s,"iat")&&(d.created=s.iat*1e3),has(s,"scopes")&&(d.scopes=s.scopes),has(s,"client")&&(d.client=s.client),has(s,"ll")&&(d.lastLogin=s.ll),has(s,"iu")&&(d.impersonator=s.iu),tokenCache[e]=d,d}function parsePaylod(e){try{return JSON.parse(base64.decode(e))}catch{throw new Error("Invalid token")}}function has(e,r){return Object.prototype.hasOwnProperty.call(e,r)}var parseMapboxToken=parseToken$4,eventemitter3={exports:{}};(function(e){var r=Object.prototype.hasOwnProperty,t="~";function o(){}Object.create&&(o.prototype=Object.create(null),new o().__proto__||(t=!1));function s(b,_,T){this.fn=b,this.context=_,this.once=T||!1}function d(b,_,T,C,D){if(typeof T!="function")throw new TypeError("The listener must be a function");var k=new s(T,C||b,D),O=t?t+_:_;return b._events[O]?b._events[O].fn?b._events[O]=[b._events[O],k]:b._events[O].push(k):(b._events[O]=k,b._eventsCount++),b}function g(b,_){--b._eventsCount===0?b._events=new o:delete b._events[_]}function a(){this._events=new o,this._eventsCount=0}a.prototype.eventNames=function(){var _=[],T,C;if(this._eventsCount===0)return _;for(C in T=this._events)r.call(T,C)&&_.push(t?C.slice(1):C);return Object.getOwnPropertySymbols?_.concat(Object.getOwnPropertySymbols(T)):_},a.prototype.listeners=function(_){var T=t?t+_:_,C=this._events[T];if(!C)return[];if(C.fn)return[C.fn];for(var D=0,k=C.length,O=new Array(k);D<k;D++)O[D]=C[D].fn;return O},a.prototype.listenerCount=function(_){var T=t?t+_:_,C=this._events[T];return C?C.fn?1:C.length:0},a.prototype.emit=function(_,T,C,D,k,O){var U=t?t+_:_;if(!this._events[U])return!1;var G=this._events[U],j=arguments.length,te,H;if(G.fn){switch(G.once&&this.removeListener(_,G.fn,void 0,!0),j){case 1:return G.fn.call(G.context),!0;case 2:return G.fn.call(G.context,T),!0;case 3:return G.fn.call(G.context,T,C),!0;case 4:return G.fn.call(G.context,T,C,D),!0;case 5:return G.fn.call(G.context,T,C,D,k),!0;case 6:return G.fn.call(G.context,T,C,D,k,O),!0}for(H=1,te=new Array(j-1);H<j;H++)te[H-1]=arguments[H];G.fn.apply(G.context,te)}else{var Z=G.length,W;for(H=0;H<Z;H++)switch(G[H].once&&this.removeListener(_,G[H].fn,void 0,!0),j){case 1:G[H].fn.call(G[H].context);break;case 2:G[H].fn.call(G[H].context,T);break;case 3:G[H].fn.call(G[H].context,T,C);break;case 4:G[H].fn.call(G[H].context,T,C,D);break;default:if(!te)for(W=1,te=new Array(j-1);W<j;W++)te[W-1]=arguments[W];G[H].fn.apply(G[H].context,te)}}return!0},a.prototype.on=function(_,T,C){return d(this,_,T,C,!1)},a.prototype.once=function(_,T,C){return d(this,_,T,C,!0)},a.prototype.removeListener=function(_,T,C,D){var k=t?t+_:_;if(!this._events[k])return this;if(!T)return g(this,k),this;var O=this._events[k];if(O.fn)O.fn===T&&(!D||O.once)&&(!C||O.context===C)&&g(this,k);else{for(var U=0,G=[],j=O.length;U<j;U++)(O[U].fn!==T||D&&!O[U].once||C&&O[U].context!==C)&&G.push(O[U]);G.length?this._events[k]=G.length===1?G[0]:G:g(this,k)}return this},a.prototype.removeAllListeners=function(_){var T;return _?(T=t?t+_:_,this._events[T]&&g(this,T)):(this._events=new o,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,e.exports=a})(eventemitter3);var eventemitter3Exports=eventemitter3.exports;function encodeArray$1(e){return e.map(encodeURIComponent).join(",")}function encodeValue$1(e){return Array.isArray(e)?encodeArray$1(e):encodeURIComponent(String(e))}function appendQueryParam$1(e,r,t){if(t===!1||t===null)return e;var o=/\?/.test(e)?"&":"?",s=encodeURIComponent(r);return t!==void 0&&t!==""&&t!==!0&&(s+="="+encodeValue$1(t)),""+e+o+s}function appendQueryObject$1(e,r){if(!r)return e;var t=e;return Object.keys(r).forEach(function(o){var s=r[o];s!==void 0&&(Array.isArray(s)&&(s=s.filter(function(d){return d!=null}).join(",")),t=appendQueryParam$1(t,o,s))}),t}function prependOrigin$1(e,r){if(!r||e.slice(0,4)==="http")return e;var t=e[0]==="/"?"":"/";return""+r.replace(/\/$/,"")+t+e}function interpolateRouteParams$1(e,r){return r?e.replace(/\/:([a-zA-Z0-9]+)/g,function(t,o){var s=r[o];if(s===void 0)throw new Error("Unspecified route parameter "+o);var d=encodeValue$1(s);return"/"+d}):e}var urlUtils$3={appendQueryObject:appendQueryObject$1,appendQueryParam:appendQueryParam$1,prependOrigin:prependOrigin$1,interpolateRouteParams:interpolateRouteParams$1},parseToken$3=parseMapboxToken,xtend$6=immutable,EventEmitter$2=eventemitter3Exports,urlUtils$2=urlUtils$3,constants$6=constants$9,requestId$1=1;function MapiRequest$3(e,r){if(!e)throw new Error("MapiRequest requires a client");if(!r||!r.path||!r.method)throw new Error("MapiRequest requires an options object with path and method properties");var t={};r.body&&(t["content-type"]="application/json");var o=xtend$6(t,r.headers),s=Object.keys(o).reduce(function(d,g){return d[g.toLowerCase()]=o[g],d},{});this.id=requestId$1++,this._options=r,this.emitter=new EventEmitter$2,this.client=e,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=r.path,this.method=r.method,this.origin=r.origin||e.origin,this.query=r.query||{},this.params=r.params||{},this.body=r.body||null,this.file=r.file||null,this.encoding=r.encoding||"utf8",this.sendFileAs=r.sendFileAs||null,this.headers=s}MapiRequest$3.prototype.url=function e(r){var t=urlUtils$2.prependOrigin(this.path,this.origin);t=urlUtils$2.appendQueryObject(t,this.query);var o=this.params,s=r??this.client.accessToken;if(s){t=urlUtils$2.appendQueryParam(t,"access_token",s);var d=parseToken$3(s).user;o=xtend$6({ownerId:d},o)}return t=urlUtils$2.interpolateRouteParams(t,o),t};MapiRequest$3.prototype.send=function e(){var r=this;if(r.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return r.sent=!0,r.client.sendRequest(r).then(function(t){return r.response=t,r.emitter.emit(constants$6.EVENT_RESPONSE,t),t},function(t){throw r.error=t,r.emitter.emit(constants$6.EVENT_ERROR,t),t})};MapiRequest$3.prototype.abort=function e(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};MapiRequest$3.prototype.eachPage=function e(r){var t=this;function o(g){function a(){delete t._nextPageRequest;var b=g.nextPage();b&&(t._nextPageRequest=b,d(b))}r(null,g,a)}function s(g){r(g,null,function(){})}function d(g){g.send().then(o,s)}d(this)};MapiRequest$3.prototype.clone=function e(){return this._extend()};MapiRequest$3.prototype._extend=function e(r){var t=xtend$6(this._options,r);return new MapiRequest$3(this.client,t)};var mapiRequest$1=MapiRequest$3,parseToken$2=parseMapboxToken,MapiRequest$2=mapiRequest$1,constants$5=constants$9;function MapiClient$5(e){if(!e||!e.accessToken)throw new Error("Cannot create a client without an access token");parseToken$2(e.accessToken),this.accessToken=e.accessToken,this.origin=e.origin||constants$5.API_ORIGIN}MapiClient$5.prototype.createRequest=function e(r){return new MapiRequest$2(this,r)};var mapiClient$1=MapiClient$5,browser$1=browserLayer$1,MapiClient$4=mapiClient$1;function BrowserClient$1(e){MapiClient$4.call(this,e)}BrowserClient$1.prototype=Object.create(MapiClient$4.prototype);BrowserClient$1.prototype.constructor=BrowserClient$1;BrowserClient$1.prototype.sendRequest=browser$1.browserSend;BrowserClient$1.prototype.abortRequest=browser$1.browserAbort;function createBrowserClient$1(e){return new BrowserClient$1(e)}var browserClient$1=createBrowserClient$1,client=browserClient$1,mapboxSdk=client,toString=Object.prototype.toString,isPlainObj=function(e){var r;return toString.call(e)==="[object Object]"&&(r=Object.getPrototypeOf(e),r===null||r===Object.getPrototypeOf({}))},isPlainObject=isPlainObj,xtend$5=immutable,DEFAULT_ERROR_PATH="value",NEWLINE_INDENT=`
  `,v$4={};v$4.assert=function(e,r){return r=r||{},function(t){var o=validate(e,t);if(o){var s=processMessage(o,r);throw r.apiName&&(s=r.apiName+": "+s),new Error(s)}}};v$4.shape=function e(r){var t=objectEntries(r);return function(s){var d=validate(v$4.plainObject,s);if(d)return d;for(var g,a,b=[],_=0;_<t.length;_++)g=t[_].key,a=t[_].value,d=validate(a,s[g]),d&&b.push([g].concat(d));return b.length<2?b[0]:function(T){b=b.map(function(k){var O=k[0],U=processMessage(k,T).split(`
`).join(NEWLINE_INDENT);return"- "+O+": "+U});var C=T.path.join("."),D=C===DEFAULT_ERROR_PATH?"":" of "+C;return"The following properties"+D+" have invalid values:"+NEWLINE_INDENT+b.join(NEWLINE_INDENT)}}};v$4.strictShape=function e(r){var t=v$4.shape(r);return function(s){var d=t(s);if(d)return d;var g=Object.keys(s).reduce(function(a,b){return r[b]===void 0&&a.push(b),a},[]);if(g.length!==0)return function(){return"The following keys are invalid: "+g.join(", ")}}};v$4.arrayOf=function e(r){return createArrayValidator(r)};v$4.tuple=function e(){var r=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return createArrayValidator(r)};function createArrayValidator(e){var r=Array.isArray(e),t=function(o){return r?e[o]:e};return function(s){var d=validate(v$4.plainArray,s);if(d)return d;if(r&&s.length!==e.length)return"an array with "+e.length+" items";for(var g=0;g<s.length;g++)if(d=validate(t(g),s[g]),d)return[g].concat(d)}}v$4.required=function e(r){function t(o){return o==null?function(s){return formatErrorMessage(s,isArrayCulprit(s.path)?"cannot be undefined/null.":"is required.")}:r.apply(this,arguments)}return t.__required=!0,t};v$4.oneOfType=function e(){var r=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(o){var s=r.map(function(d){return validate(d,o)}).filter(Boolean);if(s.length===r.length)return s.every(function(d){return d.length===1&&typeof d[0]=="string"})?orList(s.map(function(d){return d[0]})):s.reduce(function(d,g){return g.length>d.length?g:d})}};v$4.equal=function e(r){return function(o){if(o!==r)return JSON.stringify(r)}};v$4.oneOf=function e(){var r=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),t=r.map(function(o){return v$4.equal(o)});return v$4.oneOfType.apply(this,t)};v$4.range=function e(r){var t=r[0],o=r[1];return function(d){var g=validate(v$4.number,d);if(g||d<t||d>o)return"number between "+t+" & "+o+" (inclusive)"}};v$4.any=function e(){};v$4.boolean=function e(r){if(typeof r!="boolean")return"boolean"};v$4.number=function e(r){if(typeof r!="number")return"number"};v$4.plainArray=function e(r){if(!Array.isArray(r))return"array"};v$4.plainObject=function e(r){if(!isPlainObject(r))return"object"};v$4.string=function e(r){if(typeof r!="string")return"string"};v$4.func=function e(r){if(typeof r!="function")return"function"};function validate(e,r){if(!(r==null&&!e.hasOwnProperty("__required"))){var t=e(r);if(t)return Array.isArray(t)?t:[t]}}function processMessage(e,r){var t=e.length,o=e[t-1],s=e.slice(0,t-1);return s.length===0&&(s=[DEFAULT_ERROR_PATH]),r=xtend$5(r,{path:s}),typeof o=="function"?o(r):formatErrorMessage(r,prettifyResult(o))}function orList(e){return e.length<2?e[0]:e.length===2?e.join(" or "):e.slice(0,-1).join(", ")+", or "+e.slice(-1)}function prettifyResult(e){return"must be "+addArticle(e)+"."}function addArticle(e){return/^an? /.test(e)?e:/^[aeiou]/i.test(e)?"an "+e:/^[a-z]/i.test(e)?"a "+e:e}function formatErrorMessage(e,r){var t=isArrayCulprit(e.path),o=e.path.join(".")+" "+r,s=t?"Item at position ":"";return s+o}function isArrayCulprit(e){return typeof e[e.length-1]=="number"||typeof e[0]=="number"}function objectEntries(e){return Object.keys(e||{}).map(function(r){return{key:r,value:e[r]}})}v$4.validate=validate;v$4.processMessage=processMessage;var lib$1=v$4,xtend$4=immutable,v$3=lib$1;function file$1(e){if(typeof window<"u")return e instanceof commonjsGlobal.Blob||e instanceof commonjsGlobal.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof e=="string"||e.pipe!==void 0))return"Filename or Readable stream"}function assertShape$1(e,r){return v$3.assert(v$3.strictShape(e),r)}function date$1(e){var r="date";if(typeof e=="boolean")return r;try{var t=new Date(e);if(t.getTime&&isNaN(t.getTime()))return r}catch{return r}}function coordinates$1(e){return v$3.tuple(v$3.number,v$3.number)(e)}var validator$1=xtend$4(v$3,{file:file$1,date:date$1,coordinates:coordinates$1,assertShape:assertShape$1});function pick$3(e,r){var t=function(o,s){return r.indexOf(o)!==-1&&s!==void 0};return typeof r=="function"&&(t=r),Object.keys(e).filter(function(o){return t(o,e[o])}).reduce(function(o,s){return o[s]=e[s],o},{})}var pick_1$1=pick$3;function objectMap$3(e,r){return Object.keys(e).reduce(function(t,o){return t[o]=r(o,e[o]),t},{})}var objectMap_1$1=objectMap$3,objectMap$2=objectMap_1$1;function stringifyBoolean$1(e){return objectMap$2(e,function(r,t){return typeof t=="boolean"?JSON.stringify(t):t})}var stringifyBooleans$3=stringifyBoolean$1,MapiClient$3=mapiClient$1,createClient$1=browserClient$1;function createServiceFactory$3(e){return function(r){var t;MapiClient$3.prototype.isPrototypeOf(r)?t=r:t=createClient$1(r);var o=Object.create(e);return o.client=t,o}}var createServiceFactory_1$1=createServiceFactory$3,xtend$3=immutable,v$2=validator$1,pick$2=pick_1$1,stringifyBooleans$2=stringifyBooleans$3,createServiceFactory$2=createServiceFactory_1$1,Geocoding$1={},featureTypes$1=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Geocoding$1.forwardGeocode=function(e){v$2.assertShape({query:v$2.required(v$2.string),mode:v$2.oneOf("mapbox.places","mapbox.places-permanent"),countries:v$2.arrayOf(v$2.string),proximity:v$2.oneOf(v$2.coordinates,"ip"),types:v$2.arrayOf(v$2.oneOf(featureTypes$1)),autocomplete:v$2.boolean,bbox:v$2.arrayOf(v$2.number),limit:v$2.number,language:v$2.arrayOf(v$2.string),routing:v$2.boolean,fuzzyMatch:v$2.boolean,worldview:v$2.string})(e),e.mode=e.mode||"mapbox.places";var r=stringifyBooleans$2(xtend$3({country:e.countries},pick$2(e,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick$2(e,["mode","query"]),query:r})};Geocoding$1.reverseGeocode=function(e){v$2.assertShape({query:v$2.required(v$2.coordinates),mode:v$2.oneOf("mapbox.places","mapbox.places-permanent"),countries:v$2.arrayOf(v$2.string),types:v$2.arrayOf(v$2.oneOf(featureTypes$1)),bbox:v$2.arrayOf(v$2.number),limit:v$2.number,language:v$2.arrayOf(v$2.string),reverseMode:v$2.oneOf("distance","score"),routing:v$2.boolean,worldview:v$2.string})(e),e.mode=e.mode||"mapbox.places";var r=stringifyBooleans$2(xtend$3({country:e.countries},pick$2(e,["country","types","bbox","limit","language","reverseMode","routing","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick$2(e,["mode","query"]),query:r})};var geocoding$1=createServiceFactory$2(Geocoding$1);let urlAlphabet="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",random=e=>crypto.getRandomValues(new Uint8Array(e)),customRandom=(e,r,t)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,s=-~(1.6*o*r/e.length);return(d=r)=>{let g="";for(;;){let a=t(s),b=s;for(;b--;)if(g+=e[a[b]&o]||"",g.length===d)return g}}},customAlphabet=(e,r=21)=>customRandom(e,r,random),nanoid$1=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((r,t)=>(t&=63,t<36?r+=t.toString(36):t<62?r+=(t-26).toString(36).toUpperCase():t>62?r+="-":r+="_",r),"");const index_browser=Object.freeze(Object.defineProperty({__proto__:null,customAlphabet,customRandom,nanoid:nanoid$1,random,urlAlphabet},Symbol.toStringTag,{value:"Module"})),require$$0=getAugmentedNamespace(index_browser);var nanoid=require$$0.nanoid;function MapboxEventManager$1(e){this.origin=e.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=e.accessToken,this.version="0.2.0",this.sessionID=this.generateSessionID(),this.userAgent=this.getUserAgent(),this.options=e,this.send=this.send.bind(this),this.countries=e.countries?e.countries.split(","):null,this.types=e.types?e.types.split(","):null,this.bbox=e.bbox?e.bbox:null,this.language=e.language?e.language.split(","):null,this.limit=e.limit?+e.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(e),this.eventQueue=new Array,this.flushInterval=e.flushInterval||1e3,this.maxQueueSize=e.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}MapboxEventManager$1.prototype={select:function(e,r){var t=this.getSelectedIndex(e,r),o=this.getEventPayload("search.select",r);if(o.resultIndex=t,o.resultPlaceName=e.place_name,o.resultId=e.id,!(t===this.lastSentIndex&&o.queryString===this.lastSentInput||t==-1)&&(this.lastSentIndex=t,this.lastSentInput=o.queryString,!!o.queryString))return this.push(o)},start:function(e){var r=this.getEventPayload("search.start",e);if(r.queryString)return this.push(r)},keyevent:function(e,r){if(e.key&&!(e.metaKey||[9,27,37,39,13,38,40].indexOf(e.keyCode)!==-1)){var t=this.getEventPayload("search.keystroke",r);if(t.lastAction=e.key,!!t.queryString)return this.push(t)}},send:function(e,r){if(!this.enableEventLogging)return r?r():void 0;var t=this.getRequestOptions(e);this.request(t,function(o){if(o)return this.handleError(o,r);if(r)return r()}.bind(this))},getRequestOptions:function(e){Array.isArray(e)||(e=[e]);var r={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};return r},getEventPayload:function(e,r){var t;r.options.proximity?typeof r.options.proximity=="object"?t=[r.options.proximity.longitude,r.options.proximity.latitude]:r.options.proximity==="ip"?t=[999,999]:t=r.options.proximity:t=null;var o=r._map?r._map.getZoom():void 0,s={event:e,created:+new Date,sessionIdentifier:this.sessionID,country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:r.options.autocomplete,fuzzyMatch:r.options.fuzzyMatch,proximity:t,limit:r.options.limit,routing:r.options.routing,worldview:r.options.worldview,mapZoom:o,keyboardLocale:this.locale};return e==="search.select"?s.queryString=r.inputString:e!="search.select"&&r._inputEl?s.queryString=r._inputEl.value:s.queryString=r.inputString,s},request:function(e,r){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(this.readyState==4)return this.status==204?r(null):r(this.statusText)},t.open(e.method,e.host+"/"+e.path,!0);for(var o in e.headers){var s=e.headers[o];t.setRequestHeader(o,s)}t.send(e.body)},handleError:function(e,r){if(r)return r(e)},generateSessionID:function(){return nanoid()},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(e,r){if(r._typeahead){var t=r._typeahead.data,o=e.id,s=t.map(function(g){return g.id}),d=s.indexOf(o);return d}},shouldEnableLogging:function(e){return!(e.enableEventLogging===!1||e.origin&&e.origin!=="https://api.mapbox.com"||e.localGeocoder||e.filter)},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(e,r){this.eventQueue.push(e),(this.eventQueue.length>=this.maxQueueSize||r)&&this.flush()},remove:function(){this.flush()}};var events=MapboxEventManager$1,placeholder={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"לחפש",ja:"サーチ",lv:"Meklēt",pt:"Procurar",sr:"Претрага",zh:"搜索",cs:"Vyhledávání",hu:"Keresés",ka:"ძიება",nb:"Søke",sk:"Vyhľadávanie",th:"ค้นหา",fi:"Hae",is:"Leita",ko:"수색",pl:"Szukaj",sl:"Iskanje",fa:"جستجو",ru:"Поиск"},localization$1={placeholder},subtag$1={exports:{}};(function(e){(function(r,t,o){e.exports?e.exports=o():r[t]=o()})(commonjsGlobal,"subtag",function(){var r="",t=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function o(b){return b.match(t)||[]}function s(b){return o(b).filter(function(_,T){return _&&T})}function d(b){return b=o(b),{language:b[1]||r,extlang:b[2]||r,script:b[3]||r,region:b[4]||r}}function g(b,_,T){Object.defineProperty(b,_,{value:T,enumerable:!0})}function a(b,_,T){function C(D){return o(D)[b]||r}g(C,"pattern",_),g(d,T,C)}return a(1,/^[a-zA-Z]{2,3}$/,"language"),a(2,/^[a-zA-Z]{3}$/,"extlang"),a(3,/^[a-zA-Z]{4}$/,"script"),a(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),g(d,"split",s),d})})(subtag$1);var subtagExports=subtag$1.exports;function Geolocation$1(){}Geolocation$1.prototype={isSupport:function(){return!!window.navigator.geolocation},getCurrentPosition:function(){const e={enableHighAccuracy:!0};return new Promise(function(r,t){window.navigator.geolocation.getCurrentPosition(r,t,e)})}};var geolocation=Geolocation$1;function transformFeatureToGeolocationText(e,r){const t=getAddressInfo(e),o=["address","street","place","country"];var s;if(typeof r=="function")return r(t);const d=o.indexOf(r);return d===-1?s=o:s=o.slice(d),s.reduce(function(g,a){return t[a]?(g!==""&&(g=g+", "),g+t[a]):g},"")}function getAddressInfo(e){const r=e.address||"",t=e.text||"",o=e.place_name||"",d={address:o.split(",")[0],houseNumber:r,street:t,placeName:o};return e.context.forEach(function(g){const a=g.id.split(".")[0];d[a]=g.text}),d}const REVERSE_GEOCODE_COORD_RGX=/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/;var utils$1={transformFeatureToGeolocationText,getAddressInfo,REVERSE_GEOCODE_COORD_RGX},Typeahead=suggestions,debounce=lodash_debounce,extend=immutable,EventEmitter$1=eventsExports.EventEmitter,exceptions=exceptions$1,MapboxClient=mapboxSdk,mbxGeocoder=geocoding$1,MapboxEventManager=events,localization=localization$1,subtag=subtagExports,Geolocation=geolocation,utils=utils$1;const GEOCODE_REQUEST_TYPE={FORWARD:0,LOCAL:1,REVERSE:2};function getFooterNode(){var e=document.createElement("div");return e.className="mapboxgl-ctrl-geocoder--powered-by",e.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',e}function MapboxGeocoder(e){this._eventEmitter=new EventEmitter$1,this.options=extend({},this.options,e),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new Geolocation}MapboxGeocoder.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",getItemValue:function(e){return e.place_name},render:function(e){var r=e.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+r[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+r.splice(1,r.length).join(",")+"</div></div>"}},addTo:function(e){function r(t,o){if(!document.body.contains(o))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const s=t.onAdd();o.appendChild(s)}if(e._controlContainer)e.addControl(this);else if(e instanceof HTMLElement)r(this,e);else if(typeof e=="string"){const t=document.querySelectorAll(e);if(t.length===0)throw new Error("Element ",e,"not found.");if(t.length>1)throw new Error("Geocoder can only be added to a single html element");r(this,t[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(e){if(e&&typeof e!="string"&&(this._map=e),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new MapboxEventManager(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this);var r=this.container=document.createElement("div");r.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var t=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",debounce(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",function(_){this.eventManager.keyevent(_,this)}.bind(this));var o=document.createElement("div");o.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var s=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(s),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),o.appendChild(this._clearEl),o.appendChild(this._loadingEl),r.appendChild(t),r.appendChild(this._inputEl),r.appendChild(o),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var d=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(d),o.appendChild(this._geolocateEl),this._showGeolocateButton()}var g=this._typeahead=new Typeahead(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit});this.setRenderFunction(this.options.render),g.getItemValue=this.options.getItemValue;var a=g.list.draw,b=this._footerNode=getFooterNode();return g.list.draw=function(){a.call(this),b.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),b.addEventListener("mouseup",function(){this.selectingListItem=!1}.bind(this)),this.element.appendChild(b)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),r},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then(function(e){this._hideLoadingIcon();const r={geometry:{type:"Point",coordinates:[e.coords.longitude,e.coords.latitude]}};this._handleMarker(r),this._fly(r),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(r),this._showClearButton(),this.fresh=!1;const t={limit:1,language:[this.options.language],query:r.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){const o=r.geometry.coordinates[0]+","+r.geometry.coordinates[1];this._setInputValue(o),this._eventEmitter.emit("result",{result:r})}else this.geocoderService.reverseGeocode(t).send().then(function(o){const s=o.body.features[0];if(s){const d=utils.transformFeatureToGeolocationText(s,this.options.addressAccuracy);this._setInputValue(d),s.user_coordinates=r.geometry.coordinates,this._eventEmitter.emit("result",{result:s})}else this._eventEmitter.emit("result",{result:{user_coordinates:r.geometry.coordinates}})}.bind(this))}.bind(this)).catch(function(e){e.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}.bind(this))},createIcon:function(e,r){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+e),t.setAttribute("viewBox","0 0 18 18"),t.setAttribute("xml:space","preserve"),t.setAttribute("width",18),t.setAttribute("height",18),t.innerHTML=r,t},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(e){this._inputEl.value=e,setTimeout(function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}.bind(this),1)},_onPaste:function(e){var r=(e.clipboardData||window.clipboardData).getData("text");r.length>=this.options.minLength&&this._geocode(r)},_onKeyDown:function(e){var r=27,t=9;if(e.keyCode===r&&this.options.clearAndBlurOnEsc)return this._clear(e),this._inputEl.blur();var o=e.target&&e.target.shadowRoot?e.target.shadowRoot.activeElement:e.target,s=o?o.value:"";if(!s)return this.fresh=!0,e.keyCode!==t&&this.clear(e),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(e.metaKey||[t,r,37,39,13,38,40].indexOf(e.keyCode)!==-1)&&o.value.length>=this.options.minLength&&this._geocode(o.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(e){this.options.clearOnBlur&&this._clearOnBlur(e),this.options.collapsed&&this._collapse()},_onChange:function(){var e=this._typeahead.selected;e&&JSON.stringify(e)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(e),this.options.marker&&this._mapboxgl&&this._handleMarker(e),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(e),this._eventEmitter.emit("result",{result:e}),this.eventManager.select(e,this))},_fly:function(e){var r;if(e.properties&&exceptions[e.properties.short_code])r=extend({},this.options.flyTo),this._map&&this._map.fitBounds(exceptions[e.properties.short_code].bbox,r);else if(e.bbox){var t=e.bbox;r=extend({},this.options.flyTo),this._map&&this._map.fitBounds([[t[0],t[1]],[t[2],t[3]]],r)}else{var o={zoom:this.options.zoom};r=extend({},o,this.options.flyTo),e.center?r.center=e.center:e.geometry&&e.geometry.type&&e.geometry.type==="Point"&&e.geometry.coordinates&&(r.center=e.geometry.coordinates),this._map&&this._map.flyTo(r)}},_requestType:function(e,r){var t;return e.localGeocoderOnly?t=GEOCODE_REQUEST_TYPE.LOCAL:e.reverseGeocode&&utils.REVERSE_GEOCODE_COORD_RGX.test(r)?t=GEOCODE_REQUEST_TYPE.REVERSE:t=GEOCODE_REQUEST_TYPE.FORWARD,t},_setupConfig:function(e,r){const t=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],o=/[\s,]+/;var s=this,d=t.reduce(function(a,b){if(s.options[b]===void 0||s.options[b]===null)return a;["countries","types","language"].indexOf(b)>-1?a[b]=s.options[b].split(o):a[b]=s.options[b];const _=typeof s.options[b].longitude=="number"&&typeof s.options[b].latitude=="number";if(b==="proximity"&&_){const T=s.options[b].longitude,C=s.options[b].latitude;a[b]=[T,C]}return a},{});switch(e){case GEOCODE_REQUEST_TYPE.REVERSE:{var g=r.split(o).map(function(a){return parseFloat(a,10)});s.options.flipCoordinates||g.reverse(),d.types&&d.types[0],d=extend(d,{query:g,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(a){a in d&&delete d[a]})}break;case GEOCODE_REQUEST_TYPE.FORWARD:{const a=r.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(a)&&(r=r.replace(/,/g," ")),d=extend(d,{query:r})}break}return d},_geocode:function(e){this.inputString=e,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:e});const r=this._requestType(this.options,e),t=this._setupConfig(r,e);var o;switch(r){case GEOCODE_REQUEST_TYPE.LOCAL:o=Promise.resolve();break;case GEOCODE_REQUEST_TYPE.FORWARD:o=this.geocoderService.forwardGeocode(t).send();break;case GEOCODE_REQUEST_TYPE.REVERSE:o=this.geocoderService.reverseGeocode(t).send();break}var s=this.options.localGeocoder?this.options.localGeocoder(e)||[]:[],d=[],g=null;return o.catch(function(a){g=a}.bind(this)).then(function(a){this._hideLoadingIcon();var b={};return a?a.statusCode=="200"&&(b=a.body,b.request=a.request,b.headers=a.headers):b={type:"FeatureCollection",features:[]},b.config=t,this.fresh&&(this.eventManager.start(this),this.fresh=!1),b.features=b.features?s.concat(b.features):s,this.options.externalGeocoder?(d=this.options.externalGeocoder(e,b.features)||Promise.resolve([]),d.then(function(_){return b.features=b.features?_.concat(b.features):_,b},function(){return b})):b}.bind(this)).then(function(a){if(g)throw g;this.options.filter&&a.features.length&&(a.features=a.features.filter(this.options.filter)),a.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",a),this._typeahead.update(a.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",a))}.bind(this)).catch(function(a){this._hideLoadingIcon(),this._hideAttribution(),s.length&&this.options.localGeocoder||d.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(s)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:s}),this._eventEmitter.emit("error",{error:a})}.bind(this)),o},_clear:function(e){e&&e.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(e){this._clear(e),this._inputEl.focus()},_clearOnBlur:function(e){var r=this;e.relatedTarget&&r._clear(e)},_onQueryResult:function(e){var r=e.body;if(r.features.length){var t=r.features[0];this._typeahead.selected=t,this._inputEl.value=t.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var e=this._map.getCenter().wrap();this.setProximity({longitude:e.lng,latitude:e.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(e){return this._geocode(e).then(this._onQueryResult),this},_renderError:function(){var e="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(e)},_renderLocationError:function(){var e="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(e)},_renderNoResults:function(){var e="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(e)},_renderUserDeniedGeolocationError:function(){var e="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(e)},_renderMessage:function(e){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(e)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var e=this.options.language.split(",")[0],r=subtag.language(e),t=localization.placeholder[r];if(t)return t}return"Search"},setInput:function(e){return this._inputEl.value=e,this._typeahead.selected=null,this._typeahead.clear(),e.length>=this.options.minLength&&this._geocode(e),this},setProximity:function(e,r=!0){return this.options.proximity=e,r&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(e){return e&&typeof e=="function"&&(this._typeahead.render=e),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(e){var r=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=e||this.options.language||r,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(e){return this.options.zoom=e,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(e){return this.options.flyTo=e,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(e){return this.placeholder=e||this._getPlaceholderText(),this._inputEl.placeholder=this.placeholder,this._inputEl.setAttribute("aria-label",this.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(e){return this.options.bbox=e,this},getCountries:function(){return this.options.countries},setCountries:function(e){return this.options.countries=e,this},getTypes:function(){return this.options.types},setTypes:function(e){return this.options.types=e,this},getMinLength:function(){return this.options.minLength},setMinLength:function(e){return this.options.minLength=e,this._typeahead&&(this._typeahead.options.minLength=e),this},getLimit:function(){return this.options.limit},setLimit:function(e){return this.options.limit=e,this._typeahead&&(this._typeahead.options.limit=e),this},getFilter:function(){return this.options.filter},setFilter:function(e){return this.options.filter=e,this},setOrigin:function(e){return this.options.origin=e,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(e){return this.options.accessToken=e,this.geocoderService=mbxGeocoder(MapboxClient({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(e){return this.options.autocomplete=e,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(e){return this.options.fuzzyMatch=e,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(e){return this.options.routing=e,this},getRouting:function(){return this.options.routing},setWorldview:function(e){return this.options.worldview=e,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(e){if(this._map){this._removeMarker();var r={color:"#4668F2"},t=extend({},r,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(t),e.center?this.mapMarker.setLngLat(e.center).addTo(this._map):e.geometry&&e.geometry.type&&e.geometry.type==="Point"&&e.geometry.coordinates&&this.mapMarker.setLngLat(e.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(e,r){return this._eventEmitter.on(e,r),this},off:function(e,r){return this._eventEmitter.removeListener(e,r),this.eventManager.remove(),this}};var lib=MapboxGeocoder;const MapboxGeocoder$1=getDefaultExportFromCjs(lib);var xtend$2=immutable,v$1=lib$1;function file(e){if(typeof window<"u")return e instanceof commonjsGlobal.Blob||e instanceof commonjsGlobal.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof e=="string"||e.pipe!==void 0))return"Filename or Readable stream"}function assertShape(e,r){return v$1.assert(v$1.strictShape(e),r)}function date(e){var r="date";if(typeof e=="boolean")return r;try{var t=new Date(e);if(t.getTime&&isNaN(t.getTime()))return r}catch{return r}}function coordinates(e){return v$1.tuple(v$1.number,v$1.number)(e)}var validator=xtend$2(v$1,{file,date,coordinates,assertShape});function pick$1(e,r){var t=function(o,s){return r.indexOf(o)!==-1&&s!==void 0};return typeof r=="function"&&(t=r),Object.keys(e).filter(function(o){return t(o,e[o])}).reduce(function(o,s){return o[s]=e[s],o},{})}var pick_1=pick$1;function objectMap$1(e,r){return Object.keys(e).reduce(function(t,o){return t[o]=r(o,e[o]),t},{})}var objectMap_1=objectMap$1,objectMap=objectMap_1;function stringifyBoolean(e){return objectMap(e,function(r,t){return typeof t=="boolean"?JSON.stringify(t):t})}var stringifyBooleans$1=stringifyBoolean;function encodeArray(e){return e.map(encodeURIComponent).join(",")}function encodeValue(e){return Array.isArray(e)?encodeArray(e):encodeURIComponent(String(e))}function appendQueryParam(e,r,t){if(t===!1||t===null)return e;var o=/\?/.test(e)?"&":"?",s=encodeURIComponent(r);return t!==void 0&&t!==""&&t!==!0&&(s+="="+encodeValue(t)),""+e+o+s}function appendQueryObject(e,r){if(!r)return e;var t=e;return Object.keys(r).forEach(function(o){var s=r[o];s!==void 0&&(Array.isArray(s)&&(s=s.filter(function(d){return d!=null}).join(",")),t=appendQueryParam(t,o,s))}),t}function prependOrigin(e,r){if(!r||e.slice(0,4)==="http")return e;var t=e[0]==="/"?"":"/";return""+r.replace(/\/$/,"")+t+e}function interpolateRouteParams(e,r){return r?e.replace(/\/:([a-zA-Z0-9]+)/g,function(t,o){var s=r[o];if(s===void 0)throw new Error("Unspecified route parameter "+o);var d=encodeValue(s);return"/"+d}):e}var urlUtils$1={appendQueryObject,appendQueryParam,prependOrigin,interpolateRouteParams},constants$4={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"},parseToken$1=parseMapboxToken,xtend$1=immutable,EventEmitter=eventemitter3Exports,urlUtils=urlUtils$1,constants$3=constants$4,requestId=1;function MapiRequest$1(e,r){if(!e)throw new Error("MapiRequest requires a client");if(!r||!r.path||!r.method)throw new Error("MapiRequest requires an options object with path and method properties");var t={};r.body&&(t["content-type"]="application/json");var o=xtend$1(t,r.headers),s=Object.keys(o).reduce(function(d,g){return d[g.toLowerCase()]=o[g],d},{});this.id=requestId++,this._options=r,this.emitter=new EventEmitter,this.client=e,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=r.path,this.method=r.method,this.origin=r.origin||e.origin,this.query=r.query||{},this.params=r.params||{},this.body=r.body||null,this.file=r.file||null,this.encoding=r.encoding||"utf8",this.sendFileAs=r.sendFileAs||null,this.headers=s}MapiRequest$1.prototype.url=function e(r){var t=urlUtils.prependOrigin(this.path,this.origin);t=urlUtils.appendQueryObject(t,this.query);var o=this.params,s=r??this.client.accessToken;if(s){t=urlUtils.appendQueryParam(t,"access_token",s);var d=parseToken$1(s).user;o=xtend$1({ownerId:d},o)}return t=urlUtils.interpolateRouteParams(t,o),t};MapiRequest$1.prototype.send=function e(){var r=this;if(r.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return r.sent=!0,r.client.sendRequest(r).then(function(t){return r.response=t,r.emitter.emit(constants$3.EVENT_RESPONSE,t),t},function(t){throw r.error=t,r.emitter.emit(constants$3.EVENT_ERROR,t),t})};MapiRequest$1.prototype.abort=function e(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};MapiRequest$1.prototype.eachPage=function e(r){var t=this;function o(g){function a(){delete t._nextPageRequest;var b=g.nextPage();b&&(t._nextPageRequest=b,d(b))}r(null,g,a)}function s(g){r(g,null,function(){})}function d(g){g.send().then(o,s)}d(this)};MapiRequest$1.prototype.clone=function e(){return this._extend()};MapiRequest$1.prototype._extend=function e(r){var t=xtend$1(this._options,r);return new MapiRequest$1(this.client,t)};var mapiRequest=MapiRequest$1,parseToken=parseMapboxToken,MapiRequest=mapiRequest,constants$2=constants$4;function MapiClient$2(e){if(!e||!e.accessToken)throw new Error("Cannot create a client without an access token");parseToken(e.accessToken),this.accessToken=e.accessToken,this.origin=e.origin||constants$2.API_ORIGIN}MapiClient$2.prototype.createRequest=function e(r){return new MapiRequest(this,r)};var mapiClient=MapiClient$2;function parseParam(e){var r=e.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return r?{key:r[1],value:r[2]}:null}function parseLink(e){var r=e.match(/<?([^>]*)>(.*)/);if(!r)return null;var t=r[1],o=r[2].split(";"),s=null,d=o.reduce(function(g,a){var b=parseParam(a);return b?b.key==="rel"?(s||(s=b.value),g):(g[b.key]=b.value,g):g},{});return s?{url:t,rel:s,params:d}:null}function parseLinkHeader$1(e){return e?e.split(/,\s*</).reduce(function(r,t){var o=parseLink(t);if(!o)return r;var s=o.rel.split(/\s+/);return s.forEach(function(d){r[d]||(r[d]={url:o.url,params:o.params})}),r},{}):{}}var parseLinkHeader_1=parseLinkHeader$1,parseLinkHeader=parseLinkHeader_1;function MapiResponse$1(e,r){this.request=e,this.headers=r.headers,this.rawBody=r.body,this.statusCode=r.statusCode;try{this.body=JSON.parse(r.body||"{}")}catch{this.body=r.body}this.links=parseLinkHeader(this.headers.link)}MapiResponse$1.prototype.hasNextPage=function e(){return!!this.links.next};MapiResponse$1.prototype.nextPage=function e(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};var mapiResponse=MapiResponse$1,constants$1=constants$4;function MapiError$1(e){var r=e.type||constants$1.ERROR_HTTP,t;if(e.body)try{t=JSON.parse(e.body)}catch{t=e.body}else t=null;var o=e.message||null;o||(typeof t=="string"?o=t:t&&typeof t.message=="string"?o=t.message:r===constants$1.ERROR_REQUEST_ABORTED&&(o="Request aborted")),this.message=o,this.type=r,this.statusCode=e.statusCode||null,this.request=e.request,this.body=t}var mapiError=MapiError$1;function parseSingleHeader(e){var r=e.indexOf(":"),t=e.substring(0,r).trim().toLowerCase(),o=e.substring(r+1).trim();return{name:t,value:o}}function parseHeaders$1(e){var r={};return e&&e.trim().split(/[\r|\n]+/).forEach(function(t){var o=parseSingleHeader(t);r[o.name]=o.value}),r}var parseHeaders_1=parseHeaders$1,MapiResponse=mapiResponse,MapiError=mapiError,constants=constants$4,parseHeaders=parseHeaders_1,requestsUnderway={};function browserAbort(e){var r=requestsUnderway[e.id];r&&(r.abort(),delete requestsUnderway[e.id])}function createResponse(e,r){return new MapiResponse(e,{body:r.response,headers:parseHeaders(r.getAllResponseHeaders()),statusCode:r.status})}function normalizeBrowserProgressEvent(e){var r=e.total,t=e.loaded,o=100*t/r;return{total:r,transferred:t,percent:o}}function sendRequestXhr(e,r){return new Promise(function(t,o){r.onprogress=function(g){e.emitter.emit(constants.EVENT_PROGRESS_DOWNLOAD,normalizeBrowserProgressEvent(g))};var s=e.file;s&&(r.upload.onprogress=function(g){e.emitter.emit(constants.EVENT_PROGRESS_UPLOAD,normalizeBrowserProgressEvent(g))}),r.onerror=function(g){o(g)},r.onabort=function(){var g=new MapiError({request:e,type:constants.ERROR_REQUEST_ABORTED});o(g)},r.onload=function(){if(delete requestsUnderway[e.id],r.status<200||r.status>=400){var g=new MapiError({request:e,body:r.response,statusCode:r.status});o(g);return}t(r)};var d=e.body;typeof d=="string"?r.send(d):d?r.send(JSON.stringify(d)):s?r.send(s):r.send(),requestsUnderway[e.id]=r}).then(function(t){return createResponse(e,t)})}function createRequestXhr(e,r){var t=e.url(r),o=new window.XMLHttpRequest;return o.open(e.method,t),Object.keys(e.headers).forEach(function(s){o.setRequestHeader(s,e.headers[s])}),o}function browserSend(e){return Promise.resolve().then(function(){var r=createRequestXhr(e,e.client.accessToken);return sendRequestXhr(e,r)})}var browserLayer={browserAbort,sendRequestXhr,browserSend,createRequestXhr},browser=browserLayer,MapiClient$1=mapiClient;function BrowserClient(e){MapiClient$1.call(this,e)}BrowserClient.prototype=Object.create(MapiClient$1.prototype);BrowserClient.prototype.constructor=BrowserClient;BrowserClient.prototype.sendRequest=browser.browserSend;BrowserClient.prototype.abortRequest=browser.browserAbort;function createBrowserClient(e){return new BrowserClient(e)}var browserClient=createBrowserClient,MapiClient=mapiClient,createClient=browserClient;function createServiceFactory$1(e){return function(r){var t;MapiClient.prototype.isPrototypeOf(r)?t=r:t=createClient(r);var o=Object.create(e);return o.client=t,o}}var createServiceFactory_1=createServiceFactory$1,xtend=immutable,v=validator,pick=pick_1,stringifyBooleans=stringifyBooleans$1,createServiceFactory=createServiceFactory_1,Geocoding={},featureTypes=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Geocoding.forwardGeocode=function(e){v.assertShape({query:v.required(v.string),mode:v.oneOf("mapbox.places","mapbox.places-permanent"),countries:v.arrayOf(v.string),proximity:v.oneOf(v.coordinates,"ip"),types:v.arrayOf(v.oneOf(featureTypes)),autocomplete:v.boolean,bbox:v.arrayOf(v.number),limit:v.number,language:v.arrayOf(v.string),routing:v.boolean,fuzzyMatch:v.boolean,worldview:v.string})(e),e.mode=e.mode||"mapbox.places";var r=stringifyBooleans(xtend({country:e.countries},pick(e,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(e,["mode","query"]),query:r})};Geocoding.reverseGeocode=function(e){v.assertShape({query:v.required(v.coordinates),mode:v.oneOf("mapbox.places","mapbox.places-permanent"),countries:v.arrayOf(v.string),types:v.arrayOf(v.oneOf(featureTypes)),bbox:v.arrayOf(v.number),limit:v.number,language:v.arrayOf(v.string),reverseMode:v.oneOf("distance","score"),routing:v.boolean,worldview:v.string})(e),e.mode=e.mode||"mapbox.places";var r=stringifyBooleans(xtend({country:e.countries},pick(e,["country","types","bbox","limit","language","reverseMode","routing","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:pick(e,["mode","query"]),query:r})};var geocoding=createServiceFactory(Geocoding);const mbxGeocoding=getDefaultExportFromCjs(geocoding);var mapboxGlDraw$1={exports:{}};(function(e,r){(function(t,o){e.exports=o()})(commonjsGlobal,function(){var t=function($,V){var ue={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},ke={on:function(je,Ze,Wt){if(ue[je]===void 0)throw new Error("Invalid event type: "+je);ue[je].push({selector:Ze,fn:Wt})},render:function(je){V.store.featureChanged(je)}},Ve=function(je,Ze){for(var Wt=ue[je],Kt=Wt.length;Kt--;){var bi=Wt[Kt];if(bi.selector(Ze)){bi.fn.call(ke,Ze)||V.store.render(),V.ui.updateMapClasses();break}}};return $.start.call(ke),{render:$.render,stop:function(){$.stop&&$.stop()},trash:function(){$.trash&&($.trash(),V.store.render())},combineFeatures:function(){$.combineFeatures&&$.combineFeatures()},uncombineFeatures:function(){$.uncombineFeatures&&$.uncombineFeatures()},drag:function(je){Ve("drag",je)},click:function(je){Ve("click",je)},mousemove:function(je){Ve("mousemove",je)},mousedown:function(je){Ve("mousedown",je)},mouseup:function(je){Ve("mouseup",je)},mouseout:function(je){Ve("mouseout",je)},keydown:function(je){Ve("keydown",je)},keyup:function(je){Ve("keyup",je)},touchstart:function(je){Ve("touchstart",je)},touchmove:function(je){Ve("touchmove",je)},touchend:function(je){Ve("touchend",je)},tap:function(je){Ve("tap",je)}}};function o($){if($.__esModule)return $;var V=$.default;if(typeof V=="function"){var ue=function ke(){if(this instanceof ke){var Ve=[null];Ve.push.apply(Ve,arguments);var je=Function.bind.apply(V,Ve);return new je}return V.apply(this,arguments)};ue.prototype=V.prototype}else ue={};return Object.defineProperty(ue,"__esModule",{value:!0}),Object.keys($).forEach(function(ke){var Ve=Object.getOwnPropertyDescriptor($,ke);Object.defineProperty(ue,ke,Ve.get?Ve:{enumerable:!0,get:function(){return $[ke]}})}),ue}var s={},d={RADIUS:6378137,FLATTENING:1/298.257223563,POLAR_RADIUS:63567523142e-4},g=d;function a($){var V=0;if($&&$.length>0){V+=Math.abs(b($[0]));for(var ue=1;ue<$.length;ue++)V-=Math.abs(b($[ue]))}return V}function b($){var V,ue,ke,Ve,je,Ze,Wt=0,Kt=$.length;if(Kt>2){for(Ze=0;Ze<Kt;Ze++)Ze===Kt-2?(ke=Kt-2,Ve=Kt-1,je=0):Ze===Kt-1?(ke=Kt-1,Ve=0,je=1):(ke=Ze,Ve=Ze+1,je=Ze+2),V=$[ke],ue=$[Ve],Wt+=(_($[je][0])-_(V[0]))*Math.sin(_(ue[1]));Wt=Wt*g.RADIUS*g.RADIUS/2}return Wt}function _($){return $*Math.PI/180}s.geometry=function $(V){var ue,ke=0;switch(V.type){case"Polygon":return a(V.coordinates);case"MultiPolygon":for(ue=0;ue<V.coordinates.length;ue++)ke+=a(V.coordinates[ue]);return ke;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(ue=0;ue<V.geometries.length;ue++)ke+=$(V.geometries[ue]);return ke}},s.ring=b;var T={CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},C={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},D={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},k={POLYGON:"polygon",LINE:"line_string",POINT:"point"},O={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},U={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select",STATIC:"static"},G={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},j={MOVE:"move",CHANGE_COORDINATES:"change_coordinates"},te={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},H={ACTIVE:"true",INACTIVE:"false"},Z=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],W=-85,_e=Object.freeze({__proto__:null,classes:T,sources:C,cursors:D,types:k,geojsonTypes:O,modes:U,events:G,updateActions:j,meta:te,activeStates:H,interactions:Z,LAT_MIN:-90,LAT_RENDERED_MIN:W,LAT_MAX:90,LAT_RENDERED_MAX:85,LNG_MIN:-270,LNG_MAX:270}),fe={Point:0,LineString:1,MultiLineString:1,Polygon:2};function re($,V){var ue=fe[$.geometry.type]-fe[V.geometry.type];return ue===0&&$.geometry.type===O.POLYGON?$.area-V.area:ue}function ae($){return $.map(function(V){return V.geometry.type===O.POLYGON&&(V.area=s.geometry({type:O.FEATURE,property:{},geometry:V.geometry})),V}).sort(re).map(function(V){return delete V.area,V})}function J($,V){return V===void 0&&(V=0),[[$.point.x-V,$.point.y-V],[$.point.x+V,$.point.y+V]]}function se($){if(this._items={},this._nums={},this._length=$?$.length:0,$)for(var V=0,ue=$.length;V<ue;V++)this.add($[V]),$[V]!==void 0&&(typeof $[V]=="string"?this._items[$[V]]=V:this._nums[$[V]]=V)}se.prototype.add=function($){return this.has($)||(this._length++,typeof $=="string"?this._items[$]=this._length:this._nums[$]=this._length),this},se.prototype.delete=function($){return this.has($)===!1||(this._length--,delete this._items[$],delete this._nums[$]),this},se.prototype.has=function($){return(typeof $=="string"||typeof $=="number")&&(this._items[$]!==void 0||this._nums[$]!==void 0)},se.prototype.values=function(){var $=this,V=[];return Object.keys(this._items).forEach(function(ue){V.push({k:ue,v:$._items[ue]})}),Object.keys(this._nums).forEach(function(ue){V.push({k:JSON.parse(ue),v:$._nums[ue]})}),V.sort(function(ue,ke){return ue.v-ke.v}).map(function(ue){return ue.k})},se.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};var Me=[te.FEATURE,te.MIDPOINT,te.VERTEX],Ie={click:function($,V,ue){return We($,V,ue,ue.options.clickBuffer)},touch:function($,V,ue){return We($,V,ue,ue.options.touchBuffer)}};function We($,V,ue,ke){if(ue.map===null)return[];var Ve=$?J($,ke):V,je={};ue.options.styles&&(je.layers=ue.options.styles.map(function(bi){return bi.id}));var Ze=ue.map.queryRenderedFeatures(Ve,je).filter(function(bi){return Me.indexOf(bi.properties.meta)!==-1}),Wt=new se,Kt=[];return Ze.forEach(function(bi){var di=bi.properties.id;Wt.has(di)||(Wt.add(di),Kt.push(bi))}),ae(Kt)}function Ge($,V){var ue=Ie.click($,null,V),ke={mouse:D.NONE};return ue[0]&&(ke.mouse=ue[0].properties.active===H.ACTIVE?D.MOVE:D.POINTER,ke.feature=ue[0].properties.meta),V.events.currentModeName().indexOf("draw")!==-1&&(ke.mouse=D.ADD),V.ui.queueMapClasses(ke),V.ui.updateMapClasses(),ue[0]}function qt($,V){var ue=$.x-V.x,ke=$.y-V.y;return Math.sqrt(ue*ue+ke*ke)}function ti($,V,ue){ue===void 0&&(ue={});var ke=ue.fineTolerance!=null?ue.fineTolerance:4,Ve=ue.grossTolerance!=null?ue.grossTolerance:12,je=ue.interval!=null?ue.interval:500;$.point=$.point||V.point,$.time=$.time||V.time;var Ze=qt($.point,V.point);return Ze<ke||Ze<Ve&&V.time-$.time<je}function Ut($,V,ue){ue===void 0&&(ue={});var ke=ue.tolerance!=null?ue.tolerance:25,Ve=ue.interval!=null?ue.interval:250;return $.point=$.point||V.point,$.time=$.time||V.time,qt($.point,V.point)<ke&&V.time-$.time<Ve}var Qt={},tt={get exports(){return Qt},set exports($){Qt=$}}.exports=function($,V){if(V||(V=16),$===void 0&&($=128),$<=0)return"0";for(var ue=Math.log(Math.pow(2,$))/Math.log(V),ke=2;ue===1/0;ke*=2)ue=Math.log(Math.pow(2,$/ke))/Math.log(V)*ke;var Ve=ue-Math.floor(ue),je="";for(ke=0;ke<Math.floor(ue);ke++)je=Math.floor(Math.random()*V).toString(V)+je;if(Ve){var Ze=Math.pow(V,Ve);je=Math.floor(Math.random()*Ze).toString(V)+je}var Wt=parseInt(je,V);return Wt!==1/0&&Wt>=Math.pow(2,$)?tt($,V):je};tt.rack=function($,V,ue){var ke=function(je){var Ze=0;do{if(Ze++>10){if(!ue)throw new Error("too many ID collisions, use more bits");$+=ue}var Wt=tt($,V)}while(Object.hasOwnProperty.call(Ve,Wt));return Ve[Wt]=je,Wt},Ve=ke.hats={};return ke.get=function(je){return ke.hats[je]},ke.set=function(je,Ze){return ke.hats[je]=Ze,ke},ke.bits=$||128,ke.base=V||16,ke};var nt=function($,V){this.ctx=$,this.properties=V.properties||{},this.coordinates=V.geometry.coordinates,this.id=V.id||Qt(),this.type=V.geometry.type};nt.prototype.changed=function(){this.ctx.store.featureChanged(this.id)},nt.prototype.incomingCoords=function($){this.setCoordinates($)},nt.prototype.setCoordinates=function($){this.coordinates=$,this.changed()},nt.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))},nt.prototype.setProperty=function($,V){this.properties[$]=V},nt.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:O.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))},nt.prototype.internal=function($){var V={id:this.id,meta:te.FEATURE,"meta:type":this.type,active:H.INACTIVE,mode:$};if(this.ctx.options.userProperties)for(var ue in this.properties)V["user_"+ue]=this.properties[ue];return{type:O.FEATURE,properties:V,geometry:{coordinates:this.getCoordinates(),type:this.type}}};var Mt=function($,V){nt.call(this,$,V)};(Mt.prototype=Object.create(nt.prototype)).isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"},Mt.prototype.updateCoordinate=function($,V,ue){this.coordinates=arguments.length===3?[V,ue]:[$,V],this.changed()},Mt.prototype.getCoordinate=function(){return this.getCoordinates()};var ht=function($,V){nt.call(this,$,V)};(ht.prototype=Object.create(nt.prototype)).isValid=function(){return this.coordinates.length>1},ht.prototype.addCoordinate=function($,V,ue){this.changed();var ke=parseInt($,10);this.coordinates.splice(ke,0,[V,ue])},ht.prototype.getCoordinate=function($){var V=parseInt($,10);return JSON.parse(JSON.stringify(this.coordinates[V]))},ht.prototype.removeCoordinate=function($){this.changed(),this.coordinates.splice(parseInt($,10),1)},ht.prototype.updateCoordinate=function($,V,ue){var ke=parseInt($,10);this.coordinates[ke]=[V,ue],this.changed()};var xt=function($,V){nt.call(this,$,V),this.coordinates=this.coordinates.map(function(ue){return ue.slice(0,-1)})};(xt.prototype=Object.create(nt.prototype)).isValid=function(){return this.coordinates.length!==0&&this.coordinates.every(function($){return $.length>2})},xt.prototype.incomingCoords=function($){this.coordinates=$.map(function(V){return V.slice(0,-1)}),this.changed()},xt.prototype.setCoordinates=function($){this.coordinates=$,this.changed()},xt.prototype.addCoordinate=function($,V,ue){this.changed();var ke=$.split(".").map(function(Ve){return parseInt(Ve,10)});this.coordinates[ke[0]].splice(ke[1],0,[V,ue])},xt.prototype.removeCoordinate=function($){this.changed();var V=$.split(".").map(function(ke){return parseInt(ke,10)}),ue=this.coordinates[V[0]];ue&&(ue.splice(V[1],1),ue.length<3&&this.coordinates.splice(V[0],1))},xt.prototype.getCoordinate=function($){var V=$.split(".").map(function(ke){return parseInt(ke,10)}),ue=this.coordinates[V[0]];return JSON.parse(JSON.stringify(ue[V[1]]))},xt.prototype.getCoordinates=function(){return this.coordinates.map(function($){return $.concat([$[0]])})},xt.prototype.updateCoordinate=function($,V,ue){this.changed();var ke=$.split("."),Ve=parseInt(ke[0],10),je=parseInt(ke[1],10);this.coordinates[Ve]===void 0&&(this.coordinates[Ve]=[]),this.coordinates[Ve][je]=[V,ue]};var It={MultiPoint:Mt,MultiLineString:ht,MultiPolygon:xt},Et=function($,V,ue,ke,Ve){var je=ue.split("."),Ze=parseInt(je[0],10),Wt=je[1]?je.slice(1).join("."):null;return $[Ze][V](Wt,ke,Ve)},yt=function($,V){if(nt.call(this,$,V),delete this.coordinates,this.model=It[V.geometry.type],this.model===void 0)throw new TypeError(V.geometry.type+" is not a valid type");this.features=this._coordinatesToFeatures(V.geometry.coordinates)};function Bt($){this.map=$.map,this.drawConfig=JSON.parse(JSON.stringify($.options||{})),this._ctx=$}(yt.prototype=Object.create(nt.prototype))._coordinatesToFeatures=function($){var V=this,ue=this.model.bind(this);return $.map(function(ke){return new ue(V.ctx,{id:Qt(),type:O.FEATURE,properties:{},geometry:{coordinates:ke,type:V.type.replace("Multi","")}})})},yt.prototype.isValid=function(){return this.features.every(function($){return $.isValid()})},yt.prototype.setCoordinates=function($){this.features=this._coordinatesToFeatures($),this.changed()},yt.prototype.getCoordinate=function($){return Et(this.features,"getCoordinate",$)},yt.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(function($){return $.type===O.POLYGON?$.getCoordinates():$.coordinates})))},yt.prototype.updateCoordinate=function($,V,ue){Et(this.features,"updateCoordinate",$,V,ue),this.changed()},yt.prototype.addCoordinate=function($,V,ue){Et(this.features,"addCoordinate",$,V,ue),this.changed()},yt.prototype.removeCoordinate=function($){Et(this.features,"removeCoordinate",$),this.changed()},yt.prototype.getFeatures=function(){return this.features},Bt.prototype.setSelected=function($){return this._ctx.store.setSelected($)},Bt.prototype.setSelectedCoordinates=function($){var V=this;this._ctx.store.setSelectedCoordinates($),$.reduce(function(ue,ke){return ue[ke.feature_id]===void 0&&(ue[ke.feature_id]=!0,V._ctx.store.get(ke.feature_id).changed()),ue},{})},Bt.prototype.getSelected=function(){return this._ctx.store.getSelected()},Bt.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()},Bt.prototype.isSelected=function($){return this._ctx.store.isSelected($)},Bt.prototype.getFeature=function($){return this._ctx.store.get($)},Bt.prototype.select=function($){return this._ctx.store.select($)},Bt.prototype.deselect=function($){return this._ctx.store.deselect($)},Bt.prototype.deleteFeature=function($,V){return V===void 0&&(V={}),this._ctx.store.delete($,V)},Bt.prototype.addFeature=function($){return this._ctx.store.add($)},Bt.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()},Bt.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()},Bt.prototype.setActionableState=function($){$===void 0&&($={});var V={trash:$.trash||!1,combineFeatures:$.combineFeatures||!1,uncombineFeatures:$.uncombineFeatures||!1};return this._ctx.events.actionable(V)},Bt.prototype.changeMode=function($,V,ue){return V===void 0&&(V={}),ue===void 0&&(ue={}),this._ctx.events.changeMode($,V,ue)},Bt.prototype.updateUIClasses=function($){return this._ctx.ui.queueMapClasses($)},Bt.prototype.activateUIButton=function($){return this._ctx.ui.setActiveButton($)},Bt.prototype.featuresAt=function($,V,ue){if(ue===void 0&&(ue="click"),ue!=="click"&&ue!=="touch")throw new Error("invalid buffer type");return Ie[ue]($,V,this._ctx)},Bt.prototype.newFeature=function($){var V=$.geometry.type;return V===O.POINT?new Mt(this._ctx,$):V===O.LINE_STRING?new ht(this._ctx,$):V===O.POLYGON?new xt(this._ctx,$):new yt(this._ctx,$)},Bt.prototype.isInstanceOf=function($,V){if($===O.POINT)return V instanceof Mt;if($===O.LINE_STRING)return V instanceof ht;if($===O.POLYGON)return V instanceof xt;if($==="MultiFeature")return V instanceof yt;throw new Error("Unknown feature class: "+$)},Bt.prototype.doRender=function($){return this._ctx.store.featureChanged($)},Bt.prototype.onSetup=function(){},Bt.prototype.onDrag=function(){},Bt.prototype.onClick=function(){},Bt.prototype.onMouseMove=function(){},Bt.prototype.onMouseDown=function(){},Bt.prototype.onMouseUp=function(){},Bt.prototype.onMouseOut=function(){},Bt.prototype.onKeyUp=function(){},Bt.prototype.onKeyDown=function(){},Bt.prototype.onTouchStart=function(){},Bt.prototype.onTouchMove=function(){},Bt.prototype.onTouchEnd=function(){},Bt.prototype.onTap=function(){},Bt.prototype.onStop=function(){},Bt.prototype.onTrash=function(){},Bt.prototype.onCombineFeature=function(){},Bt.prototype.onUncombineFeature=function(){},Bt.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};var _t={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},si=Object.keys(_t);function Li($){var V=Object.keys($);return function(ue,ke){ke===void 0&&(ke={});var Ve={},je=V.reduce(function(Ze,Wt){return Ze[Wt]=$[Wt],Ze},new Bt(ue));return{start:function(){var Ze=this;Ve=je.onSetup(ke),si.forEach(function(Wt){var Kt,bi=_t[Wt],di=function(){return!1};$[bi]&&(di=function(){return!0}),Ze.on(Wt,di,(Kt=bi,function(hi){return je[Kt](Ve,hi)}))})},stop:function(){je.onStop(Ve)},trash:function(){je.onTrash(Ve)},combineFeatures:function(){je.onCombineFeatures(Ve)},uncombineFeatures:function(){je.onUncombineFeatures(Ve)},render:function(Ze,Wt){je.toDisplayFeatures(Ve,Ze,Wt)}}}}function vi($){return[].concat($).filter(function(V){return V!==void 0})}function ci(){var $=this;if(!($.ctx.map&&$.ctx.map.getSource(C.HOT)!==void 0))return Kt();var V=$.ctx.events.currentModeName();$.ctx.ui.queueMapClasses({mode:V});var ue=[],ke=[];$.isDirty?ke=$.getAllIds():(ue=$.getChangedIds().filter(function(bi){return $.get(bi)!==void 0}),ke=$.sources.hot.filter(function(bi){return bi.properties.id&&ue.indexOf(bi.properties.id)===-1&&$.get(bi.properties.id)!==void 0}).map(function(bi){return bi.properties.id})),$.sources.hot=[];var Ve=$.sources.cold.length;$.sources.cold=$.isDirty?[]:$.sources.cold.filter(function(bi){var di=bi.properties.id||bi.properties.parent;return ue.indexOf(di)===-1});var je=Ve!==$.sources.cold.length||ke.length>0;function Ze(bi,di){var hi=$.get(bi).internal(V);$.ctx.events.currentModeRender(hi,function(Hi){$.sources[di].push(Hi)})}if(ue.forEach(function(bi){return Ze(bi,"hot")}),ke.forEach(function(bi){return Ze(bi,"cold")}),je&&$.ctx.map.getSource(C.COLD).setData({type:O.FEATURE_COLLECTION,features:$.sources.cold}),$.ctx.map.getSource(C.HOT).setData({type:O.FEATURE_COLLECTION,features:$.sources.hot}),$._emitSelectionChange&&($.ctx.map.fire(G.SELECTION_CHANGE,{features:$.getSelected().map(function(bi){return bi.toGeoJSON()}),points:$.getSelectedCoordinates().map(function(bi){return{type:O.FEATURE,properties:{},geometry:{type:O.POINT,coordinates:bi.coordinates}}})}),$._emitSelectionChange=!1),$._deletedFeaturesToEmit.length){var Wt=$._deletedFeaturesToEmit.map(function(bi){return bi.toGeoJSON()});$._deletedFeaturesToEmit=[],$.ctx.map.fire(G.DELETE,{features:Wt})}function Kt(){$.isDirty=!1,$.clearChangedIds()}Kt(),$.ctx.map.fire(G.RENDER,{})}function mt($){var V,ue=this;this._features={},this._featureIds=new se,this._selectedFeatureIds=new se,this._selectedCoordinates=[],this._changedFeatureIds=new se,this._deletedFeaturesToEmit=[],this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=$,this.sources={hot:[],cold:[]},this.render=function(){V||(V=requestAnimationFrame(function(){V=null,ci.call(ue)}))},this.isDirty=!1}function $t($,V){var ue=$._selectedCoordinates.filter(function(ke){return $._selectedFeatureIds.has(ke.feature_id)});$._selectedCoordinates.length===ue.length||V.silent||($._emitSelectionChange=!0),$._selectedCoordinates=ue}mt.prototype.createRenderBatch=function(){var $=this,V=this.render,ue=0;return this.render=function(){ue++},function(){$.render=V,ue>0&&$.render()}},mt.prototype.setDirty=function(){return this.isDirty=!0,this},mt.prototype.featureChanged=function($){return this._changedFeatureIds.add($),this},mt.prototype.getChangedIds=function(){return this._changedFeatureIds.values()},mt.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this},mt.prototype.getAllIds=function(){return this._featureIds.values()},mt.prototype.add=function($){return this.featureChanged($.id),this._features[$.id]=$,this._featureIds.add($.id),this},mt.prototype.delete=function($,V){var ue=this;return V===void 0&&(V={}),vi($).forEach(function(ke){ue._featureIds.has(ke)&&(ue._featureIds.delete(ke),ue._selectedFeatureIds.delete(ke),V.silent||ue._deletedFeaturesToEmit.indexOf(ue._features[ke])===-1&&ue._deletedFeaturesToEmit.push(ue._features[ke]),delete ue._features[ke],ue.isDirty=!0)}),$t(this,V),this},mt.prototype.get=function($){return this._features[$]},mt.prototype.getAll=function(){var $=this;return Object.keys(this._features).map(function(V){return $._features[V]})},mt.prototype.select=function($,V){var ue=this;return V===void 0&&(V={}),vi($).forEach(function(ke){ue._selectedFeatureIds.has(ke)||(ue._selectedFeatureIds.add(ke),ue._changedFeatureIds.add(ke),V.silent||(ue._emitSelectionChange=!0))}),this},mt.prototype.deselect=function($,V){var ue=this;return V===void 0&&(V={}),vi($).forEach(function(ke){ue._selectedFeatureIds.has(ke)&&(ue._selectedFeatureIds.delete(ke),ue._changedFeatureIds.add(ke),V.silent||(ue._emitSelectionChange=!0))}),$t(this,V),this},mt.prototype.clearSelected=function($){return $===void 0&&($={}),this.deselect(this._selectedFeatureIds.values(),{silent:$.silent}),this},mt.prototype.setSelected=function($,V){var ue=this;return V===void 0&&(V={}),$=vi($),this.deselect(this._selectedFeatureIds.values().filter(function(ke){return $.indexOf(ke)===-1}),{silent:V.silent}),this.select($.filter(function(ke){return!ue._selectedFeatureIds.has(ke)}),{silent:V.silent}),this},mt.prototype.setSelectedCoordinates=function($){return this._selectedCoordinates=$,this._emitSelectionChange=!0,this},mt.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this},mt.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()},mt.prototype.getSelected=function(){var $=this;return this._selectedFeatureIds.values().map(function(V){return $.get(V)})},mt.prototype.getSelectedCoordinates=function(){var $=this;return this._selectedCoordinates.map(function(V){return{coordinates:$.get(V.feature_id).getCoordinate(V.coord_path)}})},mt.prototype.isSelected=function($){return this._selectedFeatureIds.has($)},mt.prototype.setFeatureProperty=function($,V,ue){this.get($).setProperty(V,ue),this.featureChanged($)},mt.prototype.storeMapConfig=function(){var $=this;Z.forEach(function(V){$.ctx.map[V]&&($._mapInitialConfig[V]=$.ctx.map[V].isEnabled())})},mt.prototype.restoreMapConfig=function(){var $=this;Object.keys(this._mapInitialConfig).forEach(function(V){$._mapInitialConfig[V]?$.ctx.map[V].enable():$.ctx.map[V].disable()})},mt.prototype.getInitialConfigValue=function($){return this._mapInitialConfig[$]===void 0||this._mapInitialConfig[$]};var Mi=function(){for(var $=arguments,V={},ue=0;ue<arguments.length;ue++){var ke=$[ue];for(var Ve in ke)Di.call(ke,Ve)&&(V[Ve]=ke[Ve])}return V},Di=Object.prototype.hasOwnProperty,Ci=["mode","feature","mouse"];function dt($){var V=null,ue=null,ke={onRemove:function(){return $.map.off("load",ke.connect),clearInterval(ue),ke.removeLayers(),$.store.restoreMapConfig(),$.ui.removeButtons(),$.events.removeEventListeners(),$.ui.clearMapClasses(),$.map=null,$.container=null,$.store=null,V&&V.parentNode&&V.parentNode.removeChild(V),V=null,this},connect:function(){$.map.off("load",ke.connect),clearInterval(ue),ke.addLayers(),$.store.storeMapConfig(),$.events.addEventListeners()},onAdd:function(Ve){var je=Ve.fire;return Ve.fire=function(Ze,Wt){var Kt=arguments;return je.length===1&&arguments.length!==1&&(Kt=[Mi({},{type:Ze},Wt)]),je.apply(Ve,Kt)},$.map=Ve,$.events=function(Ze){var Wt=Object.keys(Ze.options.modes).reduce(function(Ot,wi){return Ot[wi]=Li(Ze.options.modes[wi]),Ot},{}),Kt={},bi={},di={},hi=null,Hi=null;di.drag=function(Ot,wi){wi({point:Ot.point,time:new Date().getTime()})?(Ze.ui.queueMapClasses({mouse:D.DRAG}),Hi.drag(Ot)):Ot.originalEvent.stopPropagation()},di.mousedrag=function(Ot){di.drag(Ot,function(wi){return!ti(Kt,wi)})},di.touchdrag=function(Ot){di.drag(Ot,function(wi){return!Ut(bi,wi)})},di.mousemove=function(Ot){if((Ot.originalEvent.buttons!==void 0?Ot.originalEvent.buttons:Ot.originalEvent.which)===1)return di.mousedrag(Ot);var wi=Ge(Ot,Ze);Ot.featureTarget=wi,Hi.mousemove(Ot)},di.mousedown=function(Ot){Kt={time:new Date().getTime(),point:Ot.point};var wi=Ge(Ot,Ze);Ot.featureTarget=wi,Hi.mousedown(Ot)},di.mouseup=function(Ot){var wi=Ge(Ot,Ze);Ot.featureTarget=wi,ti(Kt,{point:Ot.point,time:new Date().getTime()})?Hi.click(Ot):Hi.mouseup(Ot)},di.mouseout=function(Ot){Hi.mouseout(Ot)},di.touchstart=function(Ot){if(Ot.originalEvent.preventDefault(),Ze.options.touchEnabled){bi={time:new Date().getTime(),point:Ot.point};var wi=Ie.touch(Ot,null,Ze)[0];Ot.featureTarget=wi,Hi.touchstart(Ot)}},di.touchmove=function(Ot){if(Ot.originalEvent.preventDefault(),Ze.options.touchEnabled)return Hi.touchmove(Ot),di.touchdrag(Ot)},di.touchend=function(Ot){if(Ot.originalEvent.preventDefault(),Ze.options.touchEnabled){var wi=Ie.touch(Ot,null,Ze)[0];Ot.featureTarget=wi,Ut(bi,{time:new Date().getTime(),point:Ot.point})?Hi.tap(Ot):Hi.touchend(Ot)}};var Ir=function(Ot){return!(Ot===8||Ot===46||Ot>=48&&Ot<=57)};function Xi(Ot,wi,Yi){Yi===void 0&&(Yi={}),Hi.stop();var Zr=Wt[Ot];if(Zr===void 0)throw new Error(Ot+" is not valid");hi=Ot;var Vr=Zr(Ze,wi);Hi=t(Vr,Ze),Yi.silent||Ze.map.fire(G.MODE_CHANGE,{mode:Ot}),Ze.store.setDirty(),Ze.store.render()}di.keydown=function(Ot){(Ot.srcElement||Ot.target).classList[0]==="mapboxgl-canvas"&&(Ot.keyCode!==8&&Ot.keyCode!==46||!Ze.options.controls.trash?Ir(Ot.keyCode)?Hi.keydown(Ot):Ot.keyCode===49&&Ze.options.controls.point?Xi(U.DRAW_POINT):Ot.keyCode===50&&Ze.options.controls.line_string?Xi(U.DRAW_LINE_STRING):Ot.keyCode===51&&Ze.options.controls.polygon&&Xi(U.DRAW_POLYGON):(Ot.preventDefault(),Hi.trash()))},di.keyup=function(Ot){Ir(Ot.keyCode)&&Hi.keyup(Ot)},di.zoomend=function(){Ze.store.changeZoom()},di.data=function(Ot){if(Ot.dataType==="style"){var wi=Ze.setup,Yi=Ze.map,Zr=Ze.options,Vr=Ze.store;Zr.styles.some(function(mn){return Yi.getLayer(mn.id)})||(wi.addLayers(),Vr.setDirty(),Vr.render())}};var zr={trash:!1,combineFeatures:!1,uncombineFeatures:!1};return{start:function(){hi=Ze.options.defaultMode,Hi=t(Wt[hi](Ze),Ze)},changeMode:Xi,actionable:function(Ot){var wi=!1;Object.keys(Ot).forEach(function(Yi){if(zr[Yi]===void 0)throw new Error("Invalid action type");zr[Yi]!==Ot[Yi]&&(wi=!0),zr[Yi]=Ot[Yi]}),wi&&Ze.map.fire(G.ACTIONABLE,{actions:zr})},currentModeName:function(){return hi},currentModeRender:function(Ot,wi){return Hi.render(Ot,wi)},fire:function(Ot,wi){di[Ot]&&di[Ot](wi)},addEventListeners:function(){Ze.map.on("mousemove",di.mousemove),Ze.map.on("mousedown",di.mousedown),Ze.map.on("mouseup",di.mouseup),Ze.map.on("data",di.data),Ze.map.on("touchmove",di.touchmove),Ze.map.on("touchstart",di.touchstart),Ze.map.on("touchend",di.touchend),Ze.container.addEventListener("mouseout",di.mouseout),Ze.options.keybindings&&(Ze.container.addEventListener("keydown",di.keydown),Ze.container.addEventListener("keyup",di.keyup))},removeEventListeners:function(){Ze.map.off("mousemove",di.mousemove),Ze.map.off("mousedown",di.mousedown),Ze.map.off("mouseup",di.mouseup),Ze.map.off("data",di.data),Ze.map.off("touchmove",di.touchmove),Ze.map.off("touchstart",di.touchstart),Ze.map.off("touchend",di.touchend),Ze.container.removeEventListener("mouseout",di.mouseout),Ze.options.keybindings&&(Ze.container.removeEventListener("keydown",di.keydown),Ze.container.removeEventListener("keyup",di.keyup))},trash:function(Ot){Hi.trash(Ot)},combineFeatures:function(){Hi.combineFeatures()},uncombineFeatures:function(){Hi.uncombineFeatures()},getMode:function(){return hi}}}($),$.ui=function(Ze){var Wt={},Kt=null,bi={mode:null,feature:null,mouse:null},di={mode:null,feature:null,mouse:null};function hi(Ot){di=Mi(di,Ot)}function Hi(){var Ot,wi;if(Ze.container){var Yi=[],Zr=[];Ci.forEach(function(Vr){di[Vr]!==bi[Vr]&&(Yi.push(Vr+"-"+bi[Vr]),di[Vr]!==null&&Zr.push(Vr+"-"+di[Vr]))}),Yi.length>0&&(Ot=Ze.container.classList).remove.apply(Ot,Yi),Zr.length>0&&(wi=Ze.container.classList).add.apply(wi,Zr),bi=Mi(bi,di)}}function Ir(Ot,wi){wi===void 0&&(wi={});var Yi=document.createElement("button");return Yi.className=T.CONTROL_BUTTON+" "+wi.className,Yi.setAttribute("title",wi.title),wi.container.appendChild(Yi),Yi.addEventListener("click",function(Zr){if(Zr.preventDefault(),Zr.stopPropagation(),Zr.target===Kt)return Xi(),void wi.onDeactivate();zr(Ot),wi.onActivate()},!0),Yi}function Xi(){Kt&&(Kt.classList.remove(T.ACTIVE_BUTTON),Kt=null)}function zr(Ot){Xi();var wi=Wt[Ot];wi&&wi&&Ot!=="trash"&&(wi.classList.add(T.ACTIVE_BUTTON),Kt=wi)}return{setActiveButton:zr,queueMapClasses:hi,updateMapClasses:Hi,clearMapClasses:function(){hi({mode:null,feature:null,mouse:null}),Hi()},addButtons:function(){var Ot=Ze.options.controls,wi=document.createElement("div");return wi.className=T.CONTROL_GROUP+" "+T.CONTROL_BASE,Ot&&(Ot[k.LINE]&&(Wt[k.LINE]=Ir(k.LINE,{container:wi,className:T.CONTROL_BUTTON_LINE,title:"LineString tool "+(Ze.options.keybindings?"(l)":""),onActivate:function(){return Ze.events.changeMode(U.DRAW_LINE_STRING)},onDeactivate:function(){return Ze.events.trash()}})),Ot[k.POLYGON]&&(Wt[k.POLYGON]=Ir(k.POLYGON,{container:wi,className:T.CONTROL_BUTTON_POLYGON,title:"Polygon tool "+(Ze.options.keybindings?"(p)":""),onActivate:function(){return Ze.events.changeMode(U.DRAW_POLYGON)},onDeactivate:function(){return Ze.events.trash()}})),Ot[k.POINT]&&(Wt[k.POINT]=Ir(k.POINT,{container:wi,className:T.CONTROL_BUTTON_POINT,title:"Marker tool "+(Ze.options.keybindings?"(m)":""),onActivate:function(){return Ze.events.changeMode(U.DRAW_POINT)},onDeactivate:function(){return Ze.events.trash()}})),Ot.trash&&(Wt.trash=Ir("trash",{container:wi,className:T.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:function(){Ze.events.trash()}})),Ot.combine_features&&(Wt.combine_features=Ir("combineFeatures",{container:wi,className:T.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:function(){Ze.events.combineFeatures()}})),Ot.uncombine_features&&(Wt.uncombine_features=Ir("uncombineFeatures",{container:wi,className:T.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:function(){Ze.events.uncombineFeatures()}}))),wi},removeButtons:function(){Object.keys(Wt).forEach(function(Ot){var wi=Wt[Ot];wi.parentNode&&wi.parentNode.removeChild(wi),delete Wt[Ot]})}}}($),$.container=Ve.getContainer(),$.store=new mt($),V=$.ui.addButtons(),$.options.boxSelect&&(Ve.boxZoom.disable(),Ve.dragPan.disable(),Ve.dragPan.enable()),Ve.loaded()?ke.connect():(Ve.on("load",ke.connect),ue=setInterval(function(){Ve.loaded()&&ke.connect()},16)),$.events.start(),V},addLayers:function(){$.map.addSource(C.COLD,{data:{type:O.FEATURE_COLLECTION,features:[]},type:"geojson"}),$.map.addSource(C.HOT,{data:{type:O.FEATURE_COLLECTION,features:[]},type:"geojson"}),$.options.styles.forEach(function(Ve){$.map.addLayer(Ve)}),$.store.setDirty(!0),$.store.render()},removeLayers:function(){$.options.styles.forEach(function(Ve){$.map.getLayer(Ve.id)&&$.map.removeLayer(Ve.id)}),$.map.getSource(C.COLD)&&$.map.removeSource(C.COLD),$.map.getSource(C.HOT)&&$.map.removeSource(C.HOT)}};return $.setup=ke,ke}var ei=[{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#3bb2d0","fill-outline-color":"#3bb2d0","fill-opacity":.1}},{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","active","true"],["==","$type","Polygon"]],paint:{"fill-color":"#fbb03b","fill-outline-color":"#fbb03b","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","active","true"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-stroke-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#fff"}},{id:"gl-draw-polygon-and-line-vertex-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-point-point-stroke-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-opacity":1,"circle-color":"#fff"}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#3bb2d0"}},{id:"gl-draw-point-stroke-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["!=","meta","midpoint"]],paint:{"circle-radius":7,"circle-color":"#fff"}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":5,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","mode","static"],["==","$type","Polygon"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","mode","static"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","mode","static"],["==","$type","LineString"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-point-static",type:"circle",filter:["all",["==","mode","static"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"#404040"}}];function ct($){return function(V){var ue=V.featureTarget;return!!ue&&!!ue.properties&&ue.properties.meta===$}}function Ct($){return!!$.originalEvent&&!!$.originalEvent.shiftKey&&$.originalEvent.button===0}function Be($){return!!$.featureTarget&&!!$.featureTarget.properties&&$.featureTarget.properties.active===H.ACTIVE&&$.featureTarget.properties.meta===te.FEATURE}function Xt($){return!!$.featureTarget&&!!$.featureTarget.properties&&$.featureTarget.properties.active===H.INACTIVE&&$.featureTarget.properties.meta===te.FEATURE}function ni($){return $.featureTarget===void 0}function Vt($){return!!$.featureTarget&&!!$.featureTarget.properties&&$.featureTarget.properties.meta===te.FEATURE}function Nt($){var V=$.featureTarget;return!!V&&!!V.properties&&V.properties.meta===te.VERTEX}function mi($){return!!$.originalEvent&&$.originalEvent.shiftKey===!0}function ii($){return $.keyCode===27}function Ii($){return $.keyCode===13}var $i=Object.freeze({__proto__:null,isOfMetaType:ct,isShiftMousedown:Ct,isActiveFeature:Be,isInactiveFeature:Xt,noTarget:ni,isFeature:Vt,isVertex:Nt,isShiftDown:mi,isEscapeKey:ii,isEnterKey:Ii,isTrue:function(){return!0}}),Ri=Ni;function Ni($,V){this.x=$,this.y=V}function zi($,V){var ue=V.getBoundingClientRect();return new Ri($.clientX-ue.left-(V.clientLeft||0),$.clientY-ue.top-(V.clientTop||0))}function Ki($,V,ue,ke){return{type:O.FEATURE,properties:{meta:te.VERTEX,parent:$,coord_path:ue,active:ke?H.ACTIVE:H.INACTIVE},geometry:{type:O.POINT,coordinates:V}}}function _r($,V,ue){var ke=V.geometry.coordinates,Ve=ue.geometry.coordinates;if(ke[1]>85||ke[1]<W||Ve[1]>85||Ve[1]<W)return null;var je={lng:(ke[0]+Ve[0])/2,lat:(ke[1]+Ve[1])/2};return{type:O.FEATURE,properties:{meta:te.MIDPOINT,parent:$,lng:je.lng,lat:je.lat,coord_path:ue.properties.coord_path},geometry:{type:O.POINT,coordinates:[je.lng,je.lat]}}}function cr($,V,ue){V===void 0&&(V={}),ue===void 0&&(ue=null);var ke,Ve=$.geometry,je=Ve.type,Ze=Ve.coordinates,Wt=$.properties&&$.properties.id,Kt=[];function bi(hi,Hi){var Ir="",Xi=null;hi.forEach(function(zr,Ot){var wi=Hi!=null?Hi+"."+Ot:String(Ot),Yi=Ki(Wt,zr,wi,di(wi));if(V.midpoints&&Xi){var Zr=_r(Wt,Xi,Yi);Zr&&Kt.push(Zr)}Xi=Yi;var Vr=JSON.stringify(zr);Ir!==Vr&&Kt.push(Yi),Ot===0&&(Ir=Vr)})}function di(hi){return!!V.selectedPaths&&V.selectedPaths.indexOf(hi)!==-1}return je===O.POINT?Kt.push(Ki(Wt,Ze,ue,di(ue))):je===O.POLYGON?Ze.forEach(function(hi,Hi){bi(hi,ue!==null?ue+"."+Hi:String(Hi))}):je===O.LINE_STRING?bi(Ze,ue):je.indexOf(O.MULTI_PREFIX)===0&&(ke=je.replace(O.MULTI_PREFIX,""),Ze.forEach(function(hi,Hi){var Ir={type:O.FEATURE,properties:$.properties,geometry:{type:ke,coordinates:hi}};Kt=Kt.concat(cr(Ir,V,Hi))})),Kt}Ni.prototype={clone:function(){return new Ni(this.x,this.y)},add:function($){return this.clone()._add($)},sub:function($){return this.clone()._sub($)},multByPoint:function($){return this.clone()._multByPoint($)},divByPoint:function($){return this.clone()._divByPoint($)},mult:function($){return this.clone()._mult($)},div:function($){return this.clone()._div($)},rotate:function($){return this.clone()._rotate($)},rotateAround:function($,V){return this.clone()._rotateAround($,V)},matMult:function($){return this.clone()._matMult($)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function($){return this.x===$.x&&this.y===$.y},dist:function($){return Math.sqrt(this.distSqr($))},distSqr:function($){var V=$.x-this.x,ue=$.y-this.y;return V*V+ue*ue},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function($){return Math.atan2(this.y-$.y,this.x-$.x)},angleWith:function($){return this.angleWithSep($.x,$.y)},angleWithSep:function($,V){return Math.atan2(this.x*V-this.y*$,this.x*$+this.y*V)},_matMult:function($){var V=$[0]*this.x+$[1]*this.y,ue=$[2]*this.x+$[3]*this.y;return this.x=V,this.y=ue,this},_add:function($){return this.x+=$.x,this.y+=$.y,this},_sub:function($){return this.x-=$.x,this.y-=$.y,this},_mult:function($){return this.x*=$,this.y*=$,this},_div:function($){return this.x/=$,this.y/=$,this},_multByPoint:function($){return this.x*=$.x,this.y*=$.y,this},_divByPoint:function($){return this.x/=$.x,this.y/=$.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var $=this.y;return this.y=this.x,this.x=-$,this},_rotate:function($){var V=Math.cos($),ue=Math.sin($),ke=V*this.x-ue*this.y,Ve=ue*this.x+V*this.y;return this.x=ke,this.y=Ve,this},_rotateAround:function($,V){var ue=Math.cos($),ke=Math.sin($),Ve=V.x+ue*(this.x-V.x)-ke*(this.y-V.y),je=V.y+ke*(this.x-V.x)+ue*(this.y-V.y);return this.x=Ve,this.y=je,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Ni.convert=function($){return $ instanceof Ni?$:Array.isArray($)?new Ni($[0],$[1]):$};var ur={enable:function($){setTimeout(function(){$.map&&$.map.doubleClickZoom&&$._ctx&&$._ctx.store&&$._ctx.store.getInitialConfigValue&&$._ctx.store.getInitialConfigValue("doubleClickZoom")&&$.map.doubleClickZoom.enable()},0)},disable:function($){setTimeout(function(){$.map&&$.map.doubleClickZoom&&$.map.doubleClickZoom.disable()},0)}},Ur={},nn={get exports(){return Ur},set exports($){Ur=$}},Er=function($){if(!$||!$.type)return null;var V=Kr[$.type];if(!V)return null;if(V==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:$}]};if(V==="feature")return{type:"FeatureCollection",features:[$]};if(V==="featurecollection")return $},Kr={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"},on=Object.freeze({__proto__:null,default:function $(V){switch(V&&V.type||null){case"FeatureCollection":return V.features=V.features.reduce(function(ue,ke){return ue.concat($(ke))},[]),V;case"Feature":return V.geometry?$(V.geometry).map(function(ue){var ke={type:"Feature",properties:JSON.parse(JSON.stringify(V.properties)),geometry:ue};return V.id!==void 0&&(ke.id=V.id),ke}):[V];case"MultiPoint":return V.coordinates.map(function(ue){return{type:"Point",coordinates:ue}});case"MultiPolygon":return V.coordinates.map(function(ue){return{type:"Polygon",coordinates:ue}});case"MultiLineString":return V.coordinates.map(function(ue){return{type:"LineString",coordinates:ue}});case"GeometryCollection":return V.geometries.map($).reduce(function(ue,ke){return ue.concat(ke)},[]);case"Point":case"Polygon":case"LineString":return[V]}}}),an=Er,vt=o(on),_i=function($){return function V(ue){return Array.isArray(ue)&&ue.length&&typeof ue[0]=="number"?[ue]:ue.reduce(function(ke,Ve){return Array.isArray(Ve)&&Array.isArray(Ve[0])?ke.concat(V(Ve)):(ke.push(Ve),ke)},[])}($)};vt instanceof Function||(vt=vt.default);var he={},Oe={get exports(){return he},set exports($){he=$}}.exports=function($){return new He($)};function He($){this.value=$}function Tt($,V,ue){var ke=[],Ve=[],je=!0;return function Ze(Wt){var Kt=ue?le(Wt):Wt,bi={},di=!0,hi={node:Kt,node_:Wt,path:[].concat(ke),parent:Ve[Ve.length-1],parents:Ve,key:ke.slice(-1)[0],isRoot:ke.length===0,level:ke.length,circular:null,update:function(Xi,zr){hi.isRoot||(hi.parent.node[hi.key]=Xi),hi.node=Xi,zr&&(di=!1)},delete:function(Xi){delete hi.parent.node[hi.key],Xi&&(di=!1)},remove:function(Xi){me(hi.parent.node)?hi.parent.node.splice(hi.key,1):delete hi.parent.node[hi.key],Xi&&(di=!1)},keys:null,before:function(Xi){bi.before=Xi},after:function(Xi){bi.after=Xi},pre:function(Xi){bi.pre=Xi},post:function(Xi){bi.post=Xi},stop:function(){je=!1},block:function(){di=!1}};if(!je)return hi;function Hi(){if(typeof hi.node=="object"&&hi.node!==null){hi.keys&&hi.node_===hi.node||(hi.keys=Q(hi.node)),hi.isLeaf=hi.keys.length==0;for(var Xi=0;Xi<Ve.length;Xi++)if(Ve[Xi].node_===Wt){hi.circular=Ve[Xi];break}}else hi.isLeaf=!0,hi.keys=null;hi.notLeaf=!hi.isLeaf,hi.notRoot=!hi.isRoot}Hi();var Ir=V.call(hi,hi.node);return Ir!==void 0&&hi.update&&hi.update(Ir),bi.before&&bi.before.call(hi,hi.node),di&&(typeof hi.node!="object"||hi.node===null||hi.circular||(Ve.push(hi),Hi(),we(hi.keys,function(Xi,zr){ke.push(Xi),bi.pre&&bi.pre.call(hi,hi.node[Xi],Xi);var Ot=Ze(hi.node[Xi]);ue&&Pe.call(hi.node,Xi)&&(hi.node[Xi]=Ot.node),Ot.isLast=zr==hi.keys.length-1,Ot.isFirst=zr==0,bi.post&&bi.post.call(hi,Ot),ke.pop()}),Ve.pop()),bi.after&&bi.after.call(hi,hi.node)),hi}($).node}function le($){if(typeof $=="object"&&$!==null){var V;if(me($))V=[];else if(ne($)==="[object Date]")V=new Date($.getTime?$.getTime():$);else if(function(Ve){return ne(Ve)==="[object RegExp]"}($))V=new RegExp($);else if(function(Ve){return ne(Ve)==="[object Error]"}($))V={message:$.message};else if(function(Ve){return ne(Ve)==="[object Boolean]"}($))V=new Boolean($);else if(function(Ve){return ne(Ve)==="[object Number]"}($))V=new Number($);else if(function(Ve){return ne(Ve)==="[object String]"}($))V=new String($);else if(Object.create&&Object.getPrototypeOf)V=Object.create(Object.getPrototypeOf($));else if($.constructor===Object)V={};else{var ue=$.constructor&&$.constructor.prototype||$.__proto__||{},ke=function(){};ke.prototype=ue,V=new ke}return we(Q($),function(Ve){V[Ve]=$[Ve]}),V}return $}He.prototype.get=function($){for(var V=this.value,ue=0;ue<$.length;ue++){var ke=$[ue];if(!V||!Pe.call(V,ke)){V=void 0;break}V=V[ke]}return V},He.prototype.has=function($){for(var V=this.value,ue=0;ue<$.length;ue++){var ke=$[ue];if(!V||!Pe.call(V,ke))return!1;V=V[ke]}return!0},He.prototype.set=function($,V){for(var ue=this.value,ke=0;ke<$.length-1;ke++){var Ve=$[ke];Pe.call(ue,Ve)||(ue[Ve]={}),ue=ue[Ve]}return ue[$[ke]]=V,V},He.prototype.map=function($){return Tt(this.value,$,!0)},He.prototype.forEach=function($){return this.value=Tt(this.value,$,!1),this.value},He.prototype.reduce=function($,V){var ue=arguments.length===1,ke=ue?this.value:V;return this.forEach(function(Ve){this.isRoot&&ue||(ke=$.call(this,ke,Ve))}),ke},He.prototype.paths=function(){var $=[];return this.forEach(function(V){$.push(this.path)}),$},He.prototype.nodes=function(){var $=[];return this.forEach(function(V){$.push(this.node)}),$},He.prototype.clone=function(){var $=[],V=[];return function ue(ke){for(var Ve=0;Ve<$.length;Ve++)if($[Ve]===ke)return V[Ve];if(typeof ke=="object"&&ke!==null){var je=le(ke);return $.push(ke),V.push(je),we(Q(ke),function(Ze){je[Ze]=ue(ke[Ze])}),$.pop(),V.pop(),je}return ke}(this.value)};var Q=Object.keys||function($){var V=[];for(var ue in $)V.push(ue);return V};function ne($){return Object.prototype.toString.call($)}var me=Array.isArray||function($){return Object.prototype.toString.call($)==="[object Array]"},we=function($,V){if($.forEach)return $.forEach(V);for(var ue=0;ue<$.length;ue++)V($[ue],ue,$)};we(Q(He.prototype),function($){Oe[$]=function(V){var ue=[].slice.call(arguments,1),ke=new He(V);return ke[$].apply(ke,ue)}});var Pe=Object.hasOwnProperty||function($,V){return V in $},Ye=Ue;function Ue($){if(!(this instanceof Ue))return new Ue($);this._bbox=$||[1/0,1/0,-1/0,-1/0],this._valid=!!$}Ue.prototype.include=function($){return this._valid=!0,this._bbox[0]=Math.min(this._bbox[0],$[0]),this._bbox[1]=Math.min(this._bbox[1],$[1]),this._bbox[2]=Math.max(this._bbox[2],$[0]),this._bbox[3]=Math.max(this._bbox[3],$[1]),this},Ue.prototype.equals=function($){var V;return V=$ instanceof Ue?$.bbox():$,this._bbox[0]==V[0]&&this._bbox[1]==V[1]&&this._bbox[2]==V[2]&&this._bbox[3]==V[3]},Ue.prototype.center=function($){return this._valid?[(this._bbox[0]+this._bbox[2])/2,(this._bbox[1]+this._bbox[3])/2]:null},Ue.prototype.union=function($){var V;return this._valid=!0,V=$ instanceof Ue?$.bbox():$,this._bbox[0]=Math.min(this._bbox[0],V[0]),this._bbox[1]=Math.min(this._bbox[1],V[1]),this._bbox[2]=Math.max(this._bbox[2],V[2]),this._bbox[3]=Math.max(this._bbox[3],V[3]),this},Ue.prototype.bbox=function(){return this._valid?this._bbox:null},Ue.prototype.contains=function($){if(!$)return this._fastContains();if(!this._valid)return null;var V=$[0],ue=$[1];return this._bbox[0]<=V&&this._bbox[1]<=ue&&this._bbox[2]>=V&&this._bbox[3]>=ue},Ue.prototype.intersect=function($){return this._valid?(V=$ instanceof Ue?$.bbox():$,!(this._bbox[0]>V[2]||this._bbox[2]<V[0]||this._bbox[3]<V[1]||this._bbox[1]>V[3])):null;var V},Ue.prototype._fastContains=function(){if(!this._valid)return new Function("return null;");var $="return "+this._bbox[0]+"<= ll[0] &&"+this._bbox[1]+"<= ll[1] &&"+this._bbox[2]+">= ll[0] &&"+this._bbox[3]+">= ll[1]";return new Function("ll",$)},Ue.prototype.polygon=function(){return this._valid?{type:"Polygon",coordinates:[[[this._bbox[0],this._bbox[1]],[this._bbox[2],this._bbox[1]],[this._bbox[2],this._bbox[3]],[this._bbox[0],this._bbox[3]],[this._bbox[0],this._bbox[1]]]]}:null};var Ne=function($){if(!$)return[];var V=vt(an($)),ue=[];return V.features.forEach(function(ke){ke.geometry&&(ue=ue.concat(_i(ke.geometry.coordinates)))}),ue},Xe=he,bt=Ye,Ht={features:["FeatureCollection"],coordinates:["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],geometry:["Feature"],geometries:["GeometryCollection"]},Pt=Object.keys(Ht);function Ai($){for(var V=bt(),ue=Ne($),ke=0;ke<ue.length;ke++)V.include(ue[ke]);return V}nn.exports=function($){return Ai($).bbox()},Ur.polygon=function($){return Ai($).polygon()},Ur.bboxify=function($){return Xe($).map(function(V){V&&Pt.some(function(ue){return!!V[ue]&&Ht[ue].indexOf(V.type)!==-1})&&(V.bbox=Ai(V).bbox(),this.update(V))})};var xi=-90;function Ei($,V){var ue=xi,ke=90,Ve=xi,je=90,Ze=270,Wt=-270;$.forEach(function(bi){var di=Ur(bi),hi=di[1],Hi=di[3],Ir=di[0],Xi=di[2];hi>ue&&(ue=hi),Hi<ke&&(ke=Hi),Hi>Ve&&(Ve=Hi),hi<je&&(je=hi),Ir<Ze&&(Ze=Ir),Xi>Wt&&(Wt=Xi)});var Kt=V;return ue+Kt.lat>85&&(Kt.lat=85-ue),Ve+Kt.lat>90&&(Kt.lat=90-Ve),ke+Kt.lat<-85&&(Kt.lat=-85-ke),je+Kt.lat<xi&&(Kt.lat=xi-je),Ze+Kt.lng<=-270&&(Kt.lng+=360*Math.ceil(Math.abs(Kt.lng)/360)),Wt+Kt.lng>=270&&(Kt.lng-=360*Math.ceil(Math.abs(Kt.lng)/360)),Kt}function Fi($,V){var ue=Ei($.map(function(ke){return ke.toGeoJSON()}),V);$.forEach(function(ke){var Ve,je=ke.getCoordinates(),Ze=function(Kt){var bi={lng:Kt[0]+ue.lng,lat:Kt[1]+ue.lat};return[bi.lng,bi.lat]},Wt=function(Kt){return Kt.map(function(bi){return Ze(bi)})};ke.type===O.POINT?Ve=Ze(je):ke.type===O.LINE_STRING||ke.type===O.MULTI_POINT?Ve=je.map(Ze):ke.type===O.POLYGON||ke.type===O.MULTI_LINE_STRING?Ve=je.map(Wt):ke.type===O.MULTI_POLYGON&&(Ve=je.map(function(Kt){return Kt.map(function(bi){return Wt(bi)})})),ke.incomingCoords(Ve)})}var Ce={onSetup:function($){var V=this,ue={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initiallySelectedFeatureIds:$.featureIds||[]};return this.setSelected(ue.initiallySelectedFeatureIds.filter(function(ke){return V.getFeature(ke)!==void 0})),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),ue},fireUpdate:function(){this.map.fire(G.UPDATE,{action:j.MOVE,features:this.getSelected().map(function($){return $.toGeoJSON()})})},fireActionable:function(){var $=this,V=this.getSelected(),ue=V.filter(function(Wt){return $.isInstanceOf("MultiFeature",Wt)}),ke=!1;if(V.length>1){ke=!0;var Ve=V[0].type.replace("Multi","");V.forEach(function(Wt){Wt.type.replace("Multi","")!==Ve&&(ke=!1)})}var je=ue.length>0,Ze=V.length>0;this.setActionableState({combineFeatures:ke,uncombineFeatures:je,trash:Ze})},getUniqueIds:function($){return $.length?$.map(function(V){return V.properties.id}).filter(function(V){return V!==void 0}).reduce(function(V,ue){return V.add(ue),V},new se).values():[]},stopExtendedInteractions:function($){$.boxSelectElement&&($.boxSelectElement.parentNode&&$.boxSelectElement.parentNode.removeChild($.boxSelectElement),$.boxSelectElement=null),this.map.dragPan.enable(),$.boxSelecting=!1,$.canBoxSelect=!1,$.dragMoving=!1,$.canDragMove=!1},onStop:function(){ur.enable(this)},onMouseMove:function($){return this.stopExtendedInteractions($),!0},onMouseOut:function($){return!$.dragMoving||this.fireUpdate()}};Ce.onTap=Ce.onClick=function($,V){return ni(V)?this.clickAnywhere($,V):ct(te.VERTEX)(V)?this.clickOnVertex($,V):Vt(V)?this.clickOnFeature($,V):void 0},Ce.clickAnywhere=function($){var V=this,ue=this.getSelectedIds();ue.length&&(this.clearSelectedFeatures(),ue.forEach(function(ke){return V.doRender(ke)})),ur.enable(this),this.stopExtendedInteractions($)},Ce.clickOnVertex=function($,V){this.changeMode(U.DIRECT_SELECT,{featureId:V.featureTarget.properties.parent,coordPath:V.featureTarget.properties.coord_path,startPos:V.lngLat}),this.updateUIClasses({mouse:D.MOVE})},Ce.startOnActiveFeature=function($,V){this.stopExtendedInteractions($),this.map.dragPan.disable(),this.doRender(V.featureTarget.properties.id),$.canDragMove=!0,$.dragMoveLocation=V.lngLat},Ce.clickOnFeature=function($,V){var ue=this;ur.disable(this),this.stopExtendedInteractions($);var ke=mi(V),Ve=this.getSelectedIds(),je=V.featureTarget.properties.id,Ze=this.isSelected(je);if(!ke&&Ze&&this.getFeature(je).type!==O.POINT)return this.changeMode(U.DIRECT_SELECT,{featureId:je});Ze&&ke?(this.deselect(je),this.updateUIClasses({mouse:D.POINTER}),Ve.length===1&&ur.enable(this)):!Ze&&ke?(this.select(je),this.updateUIClasses({mouse:D.MOVE})):Ze||ke||(Ve.forEach(function(Wt){return ue.doRender(Wt)}),this.setSelected(je),this.updateUIClasses({mouse:D.MOVE})),this.doRender(je)},Ce.onMouseDown=function($,V){return Be(V)?this.startOnActiveFeature($,V):this.drawConfig.boxSelect&&Ct(V)?this.startBoxSelect($,V):void 0},Ce.startBoxSelect=function($,V){this.stopExtendedInteractions($),this.map.dragPan.disable(),$.boxSelectStartLocation=zi(V.originalEvent,this.map.getContainer()),$.canBoxSelect=!0},Ce.onTouchStart=function($,V){if(Be(V))return this.startOnActiveFeature($,V)},Ce.onDrag=function($,V){return $.canDragMove?this.dragMove($,V):this.drawConfig.boxSelect&&$.canBoxSelect?this.whileBoxSelect($,V):void 0},Ce.whileBoxSelect=function($,V){$.boxSelecting=!0,this.updateUIClasses({mouse:D.ADD}),$.boxSelectElement||($.boxSelectElement=document.createElement("div"),$.boxSelectElement.classList.add(T.BOX_SELECT),this.map.getContainer().appendChild($.boxSelectElement));var ue=zi(V.originalEvent,this.map.getContainer()),ke=Math.min($.boxSelectStartLocation.x,ue.x),Ve=Math.max($.boxSelectStartLocation.x,ue.x),je=Math.min($.boxSelectStartLocation.y,ue.y),Ze=Math.max($.boxSelectStartLocation.y,ue.y),Wt="translate("+ke+"px, "+je+"px)";$.boxSelectElement.style.transform=Wt,$.boxSelectElement.style.WebkitTransform=Wt,$.boxSelectElement.style.width=Ve-ke+"px",$.boxSelectElement.style.height=Ze-je+"px"},Ce.dragMove=function($,V){$.dragMoving=!0,V.originalEvent.stopPropagation();var ue={lng:V.lngLat.lng-$.dragMoveLocation.lng,lat:V.lngLat.lat-$.dragMoveLocation.lat};Fi(this.getSelected(),ue),$.dragMoveLocation=V.lngLat},Ce.onTouchEnd=Ce.onMouseUp=function($,V){var ue=this;if($.dragMoving)this.fireUpdate();else if($.boxSelecting){var ke=[$.boxSelectStartLocation,zi(V.originalEvent,this.map.getContainer())],Ve=this.featuresAt(null,ke,"click"),je=this.getUniqueIds(Ve).filter(function(Ze){return!ue.isSelected(Ze)});je.length&&(this.select(je),je.forEach(function(Ze){return ue.doRender(Ze)}),this.updateUIClasses({mouse:D.MOVE}))}this.stopExtendedInteractions($)},Ce.toDisplayFeatures=function($,V,ue){V.properties.active=this.isSelected(V.properties.id)?H.ACTIVE:H.INACTIVE,ue(V),this.fireActionable(),V.properties.active===H.ACTIVE&&V.geometry.type!==O.POINT&&cr(V).forEach(ue)},Ce.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()},Ce.onCombineFeatures=function(){var $=this.getSelected();if(!($.length===0||$.length<2)){for(var V=[],ue=[],ke=$[0].type.replace("Multi",""),Ve=0;Ve<$.length;Ve++){var je=$[Ve];if(je.type.replace("Multi","")!==ke)return;je.type.includes("Multi")?je.getCoordinates().forEach(function(Wt){V.push(Wt)}):V.push(je.getCoordinates()),ue.push(je.toGeoJSON())}if(ue.length>1){var Ze=this.newFeature({type:O.FEATURE,properties:ue[0].properties,geometry:{type:"Multi"+ke,coordinates:V}});this.addFeature(Ze),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([Ze.id]),this.map.fire(G.COMBINE_FEATURES,{createdFeatures:[Ze.toGeoJSON()],deletedFeatures:ue})}this.fireActionable()}},Ce.onUncombineFeatures=function(){var $=this,V=this.getSelected();if(V.length!==0){for(var ue=[],ke=[],Ve=function(Ze){var Wt=V[Ze];$.isInstanceOf("MultiFeature",Wt)&&(Wt.getFeatures().forEach(function(Kt){$.addFeature(Kt),Kt.properties=Wt.properties,ue.push(Kt.toGeoJSON()),$.select([Kt.id])}),$.deleteFeature(Wt.id,{silent:!0}),ke.push(Wt.toGeoJSON()))},je=0;je<V.length;je++)Ve(je);ue.length>1&&this.map.fire(G.UNCOMBINE_FEATURES,{createdFeatures:ue,deletedFeatures:ke}),this.fireActionable()}};var Yt=ct(te.VERTEX),At=ct(te.MIDPOINT),ui={fireUpdate:function(){this.map.fire(G.UPDATE,{action:j.CHANGE_COORDINATES,features:this.getSelected().map(function($){return $.toGeoJSON()})})},fireActionable:function($){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:$.selectedCoordPaths.length>0})},startDragging:function($,V){this.map.dragPan.disable(),$.canDragMove=!0,$.dragMoveLocation=V.lngLat},stopDragging:function($){this.map.dragPan.enable(),$.dragMoving=!1,$.canDragMove=!1,$.dragMoveLocation=null},onVertex:function($,V){this.startDragging($,V);var ue=V.featureTarget.properties,ke=$.selectedCoordPaths.indexOf(ue.coord_path);mi(V)||ke!==-1?mi(V)&&ke===-1&&$.selectedCoordPaths.push(ue.coord_path):$.selectedCoordPaths=[ue.coord_path];var Ve=this.pathsToCoordinates($.featureId,$.selectedCoordPaths);this.setSelectedCoordinates(Ve)},onMidpoint:function($,V){this.startDragging($,V);var ue=V.featureTarget.properties;$.feature.addCoordinate(ue.coord_path,ue.lng,ue.lat),this.fireUpdate(),$.selectedCoordPaths=[ue.coord_path]},pathsToCoordinates:function($,V){return V.map(function(ue){return{feature_id:$,coord_path:ue}})},onFeature:function($,V){$.selectedCoordPaths.length===0?this.startDragging($,V):this.stopDragging($)},dragFeature:function($,V,ue){Fi(this.getSelected(),ue),$.dragMoveLocation=V.lngLat},dragVertex:function($,V,ue){for(var ke=$.selectedCoordPaths.map(function(Wt){return $.feature.getCoordinate(Wt)}),Ve=Ei(ke.map(function(Wt){return{type:O.FEATURE,properties:{},geometry:{type:O.POINT,coordinates:Wt}}}),ue),je=0;je<ke.length;je++){var Ze=ke[je];$.feature.updateCoordinate($.selectedCoordPaths[je],Ze[0]+Ve.lng,Ze[1]+Ve.lat)}},clickNoTarget:function(){this.changeMode(U.SIMPLE_SELECT)},clickInactive:function(){this.changeMode(U.SIMPLE_SELECT)},clickActiveFeature:function($){$.selectedCoordPaths=[],this.clearSelectedCoordinates(),$.feature.changed()},onSetup:function($){var V=$.featureId,ue=this.getFeature(V);if(!ue)throw new Error("You must provide a featureId to enter direct_select mode");if(ue.type===O.POINT)throw new TypeError("direct_select mode doesn't handle point features");var ke={featureId:V,feature:ue,dragMoveLocation:$.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:$.coordPath?[$.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(V,ke.selectedCoordPaths)),this.setSelected(V),ur.disable(this),this.setActionableState({trash:!0}),ke},onStop:function(){ur.enable(this),this.clearSelectedCoordinates()},toDisplayFeatures:function($,V,ue){$.featureId===V.properties.id?(V.properties.active=H.ACTIVE,ue(V),cr(V,{map:this.map,midpoints:!0,selectedPaths:$.selectedCoordPaths}).forEach(ue)):(V.properties.active=H.INACTIVE,ue(V)),this.fireActionable($)},onTrash:function($){$.selectedCoordPaths.sort(function(V,ue){return ue.localeCompare(V,"en",{numeric:!0})}).forEach(function(V){return $.feature.removeCoordinate(V)}),this.fireUpdate(),$.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable($),$.feature.isValid()===!1&&(this.deleteFeature([$.featureId]),this.changeMode(U.SIMPLE_SELECT,{}))},onMouseMove:function($,V){var ue=Be(V),ke=Yt(V),Ve=$.selectedCoordPaths.length===0;return ue&&Ve||ke&&!Ve?this.updateUIClasses({mouse:D.MOVE}):this.updateUIClasses({mouse:D.NONE}),this.stopDragging($),!0},onMouseOut:function($){return $.dragMoving&&this.fireUpdate(),!0}};ui.onTouchStart=ui.onMouseDown=function($,V){return Yt(V)?this.onVertex($,V):Be(V)?this.onFeature($,V):At(V)?this.onMidpoint($,V):void 0},ui.onDrag=function($,V){if($.canDragMove===!0){$.dragMoving=!0,V.originalEvent.stopPropagation();var ue={lng:V.lngLat.lng-$.dragMoveLocation.lng,lat:V.lngLat.lat-$.dragMoveLocation.lat};$.selectedCoordPaths.length>0?this.dragVertex($,V,ue):this.dragFeature($,V,ue),$.dragMoveLocation=V.lngLat}},ui.onClick=function($,V){return ni(V)?this.clickNoTarget($,V):Be(V)?this.clickActiveFeature($,V):Xt(V)?this.clickInactive($,V):void this.stopDragging($)},ui.onTap=function($,V){return ni(V)?this.clickNoTarget($,V):Be(V)?this.clickActiveFeature($,V):Xt(V)?this.clickInactive($,V):void 0},ui.onTouchEnd=ui.onMouseUp=function($){$.dragMoving&&this.fireUpdate(),this.stopDragging($)};var Bi={};function rr($,V){return!!$.lngLat&&$.lngLat.lng===V[0]&&$.lngLat.lat===V[1]}Bi.onSetup=function(){var $=this.newFeature({type:O.FEATURE,properties:{},geometry:{type:O.POINT,coordinates:[]}});return this.addFeature($),this.clearSelectedFeatures(),this.updateUIClasses({mouse:D.ADD}),this.activateUIButton(k.POINT),this.setActionableState({trash:!0}),{point:$}},Bi.stopDrawingAndRemove=function($){this.deleteFeature([$.point.id],{silent:!0}),this.changeMode(U.SIMPLE_SELECT)},Bi.onTap=Bi.onClick=function($,V){this.updateUIClasses({mouse:D.MOVE}),$.point.updateCoordinate("",V.lngLat.lng,V.lngLat.lat),this.map.fire(G.CREATE,{features:[$.point.toGeoJSON()]}),this.changeMode(U.SIMPLE_SELECT,{featureIds:[$.point.id]})},Bi.onStop=function($){this.activateUIButton(),$.point.getCoordinate().length||this.deleteFeature([$.point.id],{silent:!0})},Bi.toDisplayFeatures=function($,V,ue){var ke=V.properties.id===$.point.id;if(V.properties.active=ke?H.ACTIVE:H.INACTIVE,!ke)return ue(V)},Bi.onTrash=Bi.stopDrawingAndRemove,Bi.onKeyUp=function($,V){if(ii(V)||Ii(V))return this.stopDrawingAndRemove($,V)};var dr={onSetup:function(){var $=this.newFeature({type:O.FEATURE,properties:{},geometry:{type:O.POLYGON,coordinates:[[]]}});return this.addFeature($),this.clearSelectedFeatures(),ur.disable(this),this.updateUIClasses({mouse:D.ADD}),this.activateUIButton(k.POLYGON),this.setActionableState({trash:!0}),{polygon:$,currentVertexPosition:0}},clickAnywhere:function($,V){if($.currentVertexPosition>0&&rr(V,$.polygon.coordinates[0][$.currentVertexPosition-1]))return this.changeMode(U.SIMPLE_SELECT,{featureIds:[$.polygon.id]});this.updateUIClasses({mouse:D.ADD}),$.polygon.updateCoordinate("0."+$.currentVertexPosition,V.lngLat.lng,V.lngLat.lat),$.currentVertexPosition++,$.polygon.updateCoordinate("0."+$.currentVertexPosition,V.lngLat.lng,V.lngLat.lat)},clickOnVertex:function($){return this.changeMode(U.SIMPLE_SELECT,{featureIds:[$.polygon.id]})},onMouseMove:function($,V){$.polygon.updateCoordinate("0."+$.currentVertexPosition,V.lngLat.lng,V.lngLat.lat),Nt(V)&&this.updateUIClasses({mouse:D.POINTER})}};dr.onTap=dr.onClick=function($,V){return Nt(V)?this.clickOnVertex($,V):this.clickAnywhere($,V)},dr.onKeyUp=function($,V){ii(V)?(this.deleteFeature([$.polygon.id],{silent:!0}),this.changeMode(U.SIMPLE_SELECT)):Ii(V)&&this.changeMode(U.SIMPLE_SELECT,{featureIds:[$.polygon.id]})},dr.onStop=function($){this.updateUIClasses({mouse:D.NONE}),ur.enable(this),this.activateUIButton(),this.getFeature($.polygon.id)!==void 0&&($.polygon.removeCoordinate("0."+$.currentVertexPosition),$.polygon.isValid()?this.map.fire(G.CREATE,{features:[$.polygon.toGeoJSON()]}):(this.deleteFeature([$.polygon.id],{silent:!0}),this.changeMode(U.SIMPLE_SELECT,{},{silent:!0})))},dr.toDisplayFeatures=function($,V,ue){var ke=V.properties.id===$.polygon.id;if(V.properties.active=ke?H.ACTIVE:H.INACTIVE,!ke)return ue(V);if(V.geometry.coordinates.length!==0){var Ve=V.geometry.coordinates[0].length;if(!(Ve<3)){if(V.properties.meta=te.FEATURE,ue(Ki($.polygon.id,V.geometry.coordinates[0][0],"0.0",!1)),Ve>3){var je=V.geometry.coordinates[0].length-3;ue(Ki($.polygon.id,V.geometry.coordinates[0][je],"0."+je,!1))}if(Ve<=4){var Ze=[[V.geometry.coordinates[0][0][0],V.geometry.coordinates[0][0][1]],[V.geometry.coordinates[0][1][0],V.geometry.coordinates[0][1][1]]];if(ue({type:O.FEATURE,properties:V.properties,geometry:{coordinates:Ze,type:O.LINE_STRING}}),Ve===3)return}return ue(V)}}},dr.onTrash=function($){this.deleteFeature([$.polygon.id],{silent:!0}),this.changeMode(U.SIMPLE_SELECT)};var ot={onSetup:function($){var V,ue,ke=($=$||{}).featureId,Ve="forward";if(ke){if(!(V=this.getFeature(ke)))throw new Error("Could not find a feature with the provided featureId");var je=$.from;if(je&&je.type==="Feature"&&je.geometry&&je.geometry.type==="Point"&&(je=je.geometry),je&&je.type==="Point"&&je.coordinates&&je.coordinates.length===2&&(je=je.coordinates),!je||!Array.isArray(je))throw new Error("Please use the `from` property to indicate which point to continue the line from");var Ze=V.coordinates.length-1;if(V.coordinates[Ze][0]===je[0]&&V.coordinates[Ze][1]===je[1])ue=Ze+1,V.addCoordinate.apply(V,[ue].concat(V.coordinates[Ze]));else{if(V.coordinates[0][0]!==je[0]||V.coordinates[0][1]!==je[1])throw new Error("`from` should match the point at either the start or the end of the provided LineString");Ve="backwards",ue=0,V.addCoordinate.apply(V,[ue].concat(V.coordinates[0]))}}else V=this.newFeature({type:O.FEATURE,properties:{},geometry:{type:O.LINE_STRING,coordinates:[]}}),ue=0,this.addFeature(V);return this.clearSelectedFeatures(),ur.disable(this),this.updateUIClasses({mouse:D.ADD}),this.activateUIButton(k.LINE),this.setActionableState({trash:!0}),{line:V,currentVertexPosition:ue,direction:Ve}},clickAnywhere:function($,V){if($.currentVertexPosition>0&&rr(V,$.line.coordinates[$.currentVertexPosition-1])||$.direction==="backwards"&&rr(V,$.line.coordinates[$.currentVertexPosition+1]))return this.changeMode(U.SIMPLE_SELECT,{featureIds:[$.line.id]});this.updateUIClasses({mouse:D.ADD}),$.line.updateCoordinate($.currentVertexPosition,V.lngLat.lng,V.lngLat.lat),$.direction==="forward"?($.currentVertexPosition++,$.line.updateCoordinate($.currentVertexPosition,V.lngLat.lng,V.lngLat.lat)):$.line.addCoordinate(0,V.lngLat.lng,V.lngLat.lat)},clickOnVertex:function($){return this.changeMode(U.SIMPLE_SELECT,{featureIds:[$.line.id]})},onMouseMove:function($,V){$.line.updateCoordinate($.currentVertexPosition,V.lngLat.lng,V.lngLat.lat),Nt(V)&&this.updateUIClasses({mouse:D.POINTER})}};ot.onTap=ot.onClick=function($,V){if(Nt(V))return this.clickOnVertex($,V);this.clickAnywhere($,V)},ot.onKeyUp=function($,V){Ii(V)?this.changeMode(U.SIMPLE_SELECT,{featureIds:[$.line.id]}):ii(V)&&(this.deleteFeature([$.line.id],{silent:!0}),this.changeMode(U.SIMPLE_SELECT))},ot.onStop=function($){ur.enable(this),this.activateUIButton(),this.getFeature($.line.id)!==void 0&&($.line.removeCoordinate(""+$.currentVertexPosition),$.line.isValid()?this.map.fire(G.CREATE,{features:[$.line.toGeoJSON()]}):(this.deleteFeature([$.line.id],{silent:!0}),this.changeMode(U.SIMPLE_SELECT,{},{silent:!0})))},ot.onTrash=function($){this.deleteFeature([$.line.id],{silent:!0}),this.changeMode(U.SIMPLE_SELECT)},ot.toDisplayFeatures=function($,V,ue){var ke=V.properties.id===$.line.id;if(V.properties.active=ke?H.ACTIVE:H.INACTIVE,!ke)return ue(V);V.geometry.coordinates.length<2||(V.properties.meta=te.FEATURE,ue(Ki($.line.id,V.geometry.coordinates[$.direction==="forward"?V.geometry.coordinates.length-2:1],""+($.direction==="forward"?V.geometry.coordinates.length-2:1),!1)),ue(V))};var Sn={simple_select:Ce,direct_select:ui,draw_point:Bi,draw_polygon:dr,draw_line_string:ot},Gr={defaultMode:U.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:ei,modes:Sn,controls:{},userProperties:!1},xo={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},cl={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function Zn($,V){return $.map(function(ue){return ue.source?ue:Mi(ue,{id:ue.id+"."+V,source:V==="hot"?C.HOT:C.COLD})})}var lo={};(function($,V){var ue="__lodash_hash_undefined__",ke=9007199254740991,Ve="[object Arguments]",je="[object Array]",Ze="[object Boolean]",Wt="[object Date]",Kt="[object Error]",bi="[object Function]",di="[object Map]",hi="[object Number]",Hi="[object Object]",Ir="[object Promise]",Xi="[object RegExp]",zr="[object Set]",Ot="[object String]",wi="[object Symbol]",Yi="[object WeakMap]",Zr="[object ArrayBuffer]",Vr="[object DataView]",mn=/^\[object .+?Constructor\]$/,yn=/^(?:0|[1-9]\d*)$/,Lr={};Lr["[object Float32Array]"]=Lr["[object Float64Array]"]=Lr["[object Int8Array]"]=Lr["[object Int16Array]"]=Lr["[object Int32Array]"]=Lr["[object Uint8Array]"]=Lr["[object Uint8ClampedArray]"]=Lr["[object Uint16Array]"]=Lr["[object Uint32Array]"]=!0,Lr[Ve]=Lr[je]=Lr[Zr]=Lr[Ze]=Lr[Vr]=Lr[Wt]=Lr[Kt]=Lr[bi]=Lr[di]=Lr[hi]=Lr[Hi]=Lr[Xi]=Lr[zr]=Lr[Ot]=Lr[Yi]=!1;var wa=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,Qr=typeof self=="object"&&self&&self.Object===Object&&self,Bn=wa||Qr||Function("return this")(),Ya=V&&!V.nodeType&&V,Jo=Ya&&$&&!$.nodeType&&$,hn=Jo&&Jo.exports===Ya,ea=hn&&wa.process,Ro=function(){try{return ea&&ea.binding&&ea.binding("util")}catch{}}(),Qn=Ro&&Ro.isTypedArray;function Ea(Qe,St){for(var fi=-1,ji=Qe==null?0:Qe.length;++fi<ji;)if(St(Qe[fi],fi,Qe))return!0;return!1}function Wa(Qe){var St=-1,fi=Array(Qe.size);return Qe.forEach(function(ji,kr){fi[++St]=[kr,ji]}),fi}function Yl(Qe){var St=-1,fi=Array(Qe.size);return Qe.forEach(function(ji){fi[++St]=ji}),fi}var Ka,Po,Cs,Ta=Array.prototype,ta=Function.prototype,Hn=Object.prototype,ia=Bn["__core-js_shared__"],co=ta.toString,Hr=Hn.hasOwnProperty,ra=(Ka=/[^.]+$/.exec(ia&&ia.keys&&ia.keys.IE_PROTO||""))?"Symbol(src)_1."+Ka:"",Is=Hn.toString,hl=RegExp("^"+co.call(Hr).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Sa=hn?Bn.Buffer:void 0,Ma=Bn.Symbol,Qa=Bn.Uint8Array,Ja=Hn.propertyIsEnumerable,na=Ta.splice,bo=Ma?Ma.toStringTag:void 0,Aa=Object.getOwnPropertySymbols,es=Sa?Sa.isBuffer:void 0,ks=(Po=Object.keys,Cs=Object,function(Qe){return Po(Cs(Qe))}),uo=zo(Bn,"DataView"),hr=zo(Bn,"Map"),Lo=zo(Bn,"Promise"),Ca=zo(Bn,"Set"),$o=zo(Bn,"WeakMap"),ho=zo(Object,"create"),ts=Yn(uo),is=Yn(hr),Ds=Yn(Lo),rs=Yn(Ca),Rs=Yn($o),fo=Ma?Ma.prototype:void 0,po=fo?fo.valueOf:void 0;function Jn(Qe){var St=-1,fi=Qe==null?0:Qe.length;for(this.clear();++St<fi;){var ji=Qe[St];this.set(ji[0],ji[1])}}function Xn(Qe){var St=-1,fi=Qe==null?0:Qe.length;for(this.clear();++St<fi;){var ji=Qe[St];this.set(ji[0],ji[1])}}function Qi(Qe){var St=-1,fi=Qe==null?0:Qe.length;for(this.clear();++St<fi;){var ji=Qe[St];this.set(ji[0],ji[1])}}function wo(Qe){var St=-1,fi=Qe==null?0:Qe.length;for(this.__data__=new Qi;++St<fi;)this.add(Qe[St])}function mo(Qe){var St=this.__data__=new Xn(Qe);this.size=St.size}function dl(Qe,St){var fi=aa(Qe),ji=!fi&&Da(Qe),kr=!fi&&!ji&&Nn(Qe),fr=!fi&&!ji&&!kr&&Pa(Qe),jr=fi||ji||kr||fr,Jr=jr?function(Xr,Wn){for(var Mn=-1,vn=Array(Xr);++Mn<Xr;)vn[Mn]=Wn(Mn);return vn}(Qe.length,String):[],fn=Jr.length;for(var en in Qe)!St&&!Hr.call(Qe,en)||jr&&(en=="length"||kr&&(en=="offset"||en=="parent")||fr&&(en=="buffer"||en=="byteLength"||en=="byteOffset")||ka(en,fn))||Jr.push(en);return Jr}function oa(Qe,St){for(var fi=Qe.length;fi--;)if(Ls(Qe[fi][0],St))return fi;return-1}function Bo(Qe){return Qe==null?Qe===void 0?"[object Undefined]":"[object Null]":bo&&bo in Object(Qe)?function(St){var fi=Hr.call(St,bo),ji=St[bo];try{St[bo]=void 0;var kr=!0}catch{}var fr=Is.call(St);return kr&&(fi?St[bo]=ji:delete St[bo]),fr}(Qe):function(St){return Is.call(St)}(Qe)}function ns(Qe){return Fo(Qe)&&Bo(Qe)==Ve}function Ps(Qe,St,fi,ji,kr){return Qe===St||(Qe==null||St==null||!Fo(Qe)&&!Fo(St)?Qe!=Qe&&St!=St:function(fr,jr,Jr,fn,en,Xr){var Wn=aa(fr),Mn=aa(jr),vn=Wn?je:Eo(fr),eo=Mn?je:Eo(jr),No=(vn=vn==Ve?Hi:vn)==Hi,La=(eo=eo==Ve?Hi:eo)==Hi,To=vn==eo;if(To&&Nn(fr)){if(!Nn(jr))return!1;Wn=!0,No=!1}if(To&&!No)return Xr||(Xr=new mo),Wn||Pa(fr)?as(fr,jr,Jr,fn,en,Xr):function(Mr,xr,sa,xn,So,gn,An){switch(sa){case Vr:if(Mr.byteLength!=xr.byteLength||Mr.byteOffset!=xr.byteOffset)return!1;Mr=Mr.buffer,xr=xr.buffer;case Zr:return!(Mr.byteLength!=xr.byteLength||!gn(new Qa(Mr),new Qa(xr)));case Ze:case Wt:case hi:return Ls(+Mr,+xr);case Kt:return Mr.name==xr.name&&Mr.message==xr.message;case Xi:case Ot:return Mr==xr+"";case di:var On=Wa;case zr:var zn=1&xn;if(On||(On=Yl),Mr.size!=xr.size&&!zn)return!1;var Uo=An.get(Mr);if(Uo)return Uo==xr;xn|=2,An.set(Mr,xr);var Ji=as(On(Mr),On(xr),xn,So,gn,An);return An.delete(Mr),Ji;case wi:if(po)return po.call(Mr)==po.call(xr)}return!1}(fr,jr,vn,Jr,fn,en,Xr);if(!(1&Jr)){var $a=No&&Hr.call(fr,"__wrapped__"),ls=La&&Hr.call(jr,"__wrapped__");if($a||ls){var Bs=$a?fr.value():fr,pl=ls?jr.value():jr;return Xr||(Xr=new mo),en(Bs,pl,Jr,fn,Xr)}}return To?(Xr||(Xr=new mo),function(Mr,xr,sa,xn,So,gn){var An=1&sa,On=Ia(Mr),zn=On.length,Uo=Ia(xr).length;if(zn!=Uo&&!An)return!1;for(var Ji=zn;Ji--;){var to=On[Ji];if(!(An?to in xr:Hr.call(xr,to)))return!1}var ml=gn.get(Mr);if(ml&&gn.get(xr))return ml==xr;var la=!0;gn.set(Mr,xr),gn.set(xr,Mr);for(var Vo=An;++Ji<zn;){var ca=Mr[to=On[Ji]],Ba=xr[to];if(xn)var Oa=An?xn(Ba,ca,to,xr,Mr,gn):xn(ca,Ba,to,Mr,xr,gn);if(!(Oa===void 0?ca===Ba||So(ca,Ba,sa,xn,gn):Oa)){la=!1;break}Vo||(Vo=to=="constructor")}if(la&&!Vo){var za=Mr.constructor,jo=xr.constructor;za==jo||!("constructor"in Mr)||!("constructor"in xr)||typeof za=="function"&&za instanceof za&&typeof jo=="function"&&jo instanceof jo||(la=!1)}return gn.delete(Mr),gn.delete(xr),la}(fr,jr,Jr,fn,en,Xr)):!1}(Qe,St,fi,ji,Ps,kr))}function Wl(Qe){return!(!Ra(Qe)||function(St){return!!ra&&ra in St}(Qe))&&(ss(Qe)?hl:mn).test(Yn(Qe))}function os(Qe){if(fi=(St=Qe)&&St.constructor,ji=typeof fi=="function"&&fi.prototype||Hn,St!==ji)return ks(Qe);var St,fi,ji,kr=[];for(var fr in Object(Qe))Hr.call(Qe,fr)&&fr!="constructor"&&kr.push(fr);return kr}function as(Qe,St,fi,ji,kr,fr){var jr=1&fi,Jr=Qe.length,fn=St.length;if(Jr!=fn&&!(jr&&fn>Jr))return!1;var en=fr.get(Qe);if(en&&fr.get(St))return en==St;var Xr=-1,Wn=!0,Mn=2&fi?new wo:void 0;for(fr.set(Qe,St),fr.set(St,Qe);++Xr<Jr;){var vn=Qe[Xr],eo=St[Xr];if(ji)var No=jr?ji(eo,vn,Xr,St,Qe,fr):ji(vn,eo,Xr,Qe,St,fr);if(No!==void 0){if(No)continue;Wn=!1;break}if(Mn){if(!Ea(St,function(La,To){if($a=To,!Mn.has($a)&&(vn===La||kr(vn,La,fi,ji,fr)))return Mn.push(To);var $a})){Wn=!1;break}}else if(vn!==eo&&!kr(vn,eo,fi,ji,fr)){Wn=!1;break}}return fr.delete(Qe),fr.delete(St),Wn}function Ia(Qe){return function(St,fi,ji){var kr=fi(St);return aa(St)?kr:function(fr,jr){for(var Jr=-1,fn=jr.length,en=fr.length;++Jr<fn;)fr[en+Jr]=jr[Jr];return fr}(kr,ji(St))}(Qe,Kl,fl)}function Oo(Qe,St){var fi,ji,kr=Qe.__data__;return((ji=typeof(fi=St))=="string"||ji=="number"||ji=="symbol"||ji=="boolean"?fi!=="__proto__":fi===null)?kr[typeof St=="string"?"string":"hash"]:kr.map}function zo(Qe,St){var fi=function(ji,kr){return ji?.[kr]}(Qe,St);return Wl(fi)?fi:void 0}Jn.prototype.clear=function(){this.__data__=ho?ho(null):{},this.size=0},Jn.prototype.delete=function(Qe){var St=this.has(Qe)&&delete this.__data__[Qe];return this.size-=St?1:0,St},Jn.prototype.get=function(Qe){var St=this.__data__;if(ho){var fi=St[Qe];return fi===ue?void 0:fi}return Hr.call(St,Qe)?St[Qe]:void 0},Jn.prototype.has=function(Qe){var St=this.__data__;return ho?St[Qe]!==void 0:Hr.call(St,Qe)},Jn.prototype.set=function(Qe,St){var fi=this.__data__;return this.size+=this.has(Qe)?0:1,fi[Qe]=ho&&St===void 0?ue:St,this},Xn.prototype.clear=function(){this.__data__=[],this.size=0},Xn.prototype.delete=function(Qe){var St=this.__data__,fi=oa(St,Qe);return!(fi<0)&&(fi==St.length-1?St.pop():na.call(St,fi,1),--this.size,!0)},Xn.prototype.get=function(Qe){var St=this.__data__,fi=oa(St,Qe);return fi<0?void 0:St[fi][1]},Xn.prototype.has=function(Qe){return oa(this.__data__,Qe)>-1},Xn.prototype.set=function(Qe,St){var fi=this.__data__,ji=oa(fi,Qe);return ji<0?(++this.size,fi.push([Qe,St])):fi[ji][1]=St,this},Qi.prototype.clear=function(){this.size=0,this.__data__={hash:new Jn,map:new(hr||Xn),string:new Jn}},Qi.prototype.delete=function(Qe){var St=Oo(this,Qe).delete(Qe);return this.size-=St?1:0,St},Qi.prototype.get=function(Qe){return Oo(this,Qe).get(Qe)},Qi.prototype.has=function(Qe){return Oo(this,Qe).has(Qe)},Qi.prototype.set=function(Qe,St){var fi=Oo(this,Qe),ji=fi.size;return fi.set(Qe,St),this.size+=fi.size==ji?0:1,this},wo.prototype.add=wo.prototype.push=function(Qe){return this.__data__.set(Qe,ue),this},wo.prototype.has=function(Qe){return this.__data__.has(Qe)},mo.prototype.clear=function(){this.__data__=new Xn,this.size=0},mo.prototype.delete=function(Qe){var St=this.__data__,fi=St.delete(Qe);return this.size=St.size,fi},mo.prototype.get=function(Qe){return this.__data__.get(Qe)},mo.prototype.has=function(Qe){return this.__data__.has(Qe)},mo.prototype.set=function(Qe,St){var fi=this.__data__;if(fi instanceof Xn){var ji=fi.__data__;if(!hr||ji.length<199)return ji.push([Qe,St]),this.size=++fi.size,this;fi=this.__data__=new Qi(ji)}return fi.set(Qe,St),this.size=fi.size,this};var fl=Aa?function(Qe){return Qe==null?[]:(Qe=Object(Qe),function(St,fi){for(var ji=-1,kr=St==null?0:St.length,fr=0,jr=[];++ji<kr;){var Jr=St[ji];fi(Jr,ji,St)&&(jr[fr++]=Jr)}return jr}(Aa(Qe),function(St){return Ja.call(Qe,St)}))}:function(){return[]},Eo=Bo;function ka(Qe,St){return!!(St=St??ke)&&(typeof Qe=="number"||yn.test(Qe))&&Qe>-1&&Qe%1==0&&Qe<St}function Yn(Qe){if(Qe!=null){try{return co.call(Qe)}catch{}try{return Qe+""}catch{}}return""}function Ls(Qe,St){return Qe===St||Qe!=Qe&&St!=St}(uo&&Eo(new uo(new ArrayBuffer(1)))!=Vr||hr&&Eo(new hr)!=di||Lo&&Eo(Lo.resolve())!=Ir||Ca&&Eo(new Ca)!=zr||$o&&Eo(new $o)!=Yi)&&(Eo=function(Qe){var St=Bo(Qe),fi=St==Hi?Qe.constructor:void 0,ji=fi?Yn(fi):"";if(ji)switch(ji){case ts:return Vr;case is:return di;case Ds:return Ir;case rs:return zr;case Rs:return Yi}return St});var Da=ns(function(){return arguments}())?ns:function(Qe){return Fo(Qe)&&Hr.call(Qe,"callee")&&!Ja.call(Qe,"callee")},aa=Array.isArray,Nn=es||function(){return!1};function ss(Qe){if(!Ra(Qe))return!1;var St=Bo(Qe);return St==bi||St=="[object GeneratorFunction]"||St=="[object AsyncFunction]"||St=="[object Proxy]"}function $s(Qe){return typeof Qe=="number"&&Qe>-1&&Qe%1==0&&Qe<=ke}function Ra(Qe){var St=typeof Qe;return Qe!=null&&(St=="object"||St=="function")}function Fo(Qe){return Qe!=null&&typeof Qe=="object"}var Pa=Qn?function(Qe){return function(St){return Qe(St)}}(Qn):function(Qe){return Fo(Qe)&&$s(Qe.length)&&!!Lr[Bo(Qe)]};function Kl(Qe){return(St=Qe)!=null&&$s(St.length)&&!ss(St)?dl(Qe):os(Qe);var St}$.exports=function(Qe,St){return Ps(Qe,St)}})({get exports(){return lo},set exports($){lo=$}},lo);var ul=lo;function Do($,V){return $.length===V.length&&JSON.stringify($.map(function(ue){return ue}).sort())===JSON.stringify(V.map(function(ue){return ue}).sort())}var ri={Polygon:xt,LineString:ht,Point:Mt,MultiPolygon:yt,MultiLineString:yt,MultiPoint:yt},nr=Object.freeze({__proto__:null,CommonSelectors:$i,constrainFeatureMovement:Ei,createMidPoint:_r,createSupplementaryPoints:cr,createVertex:Ki,doubleClickZoom:ur,euclideanDistance:qt,featuresAt:Ie,getFeatureAtAndSetCursors:Ge,isClick:ti,isEventAtCoordinates:rr,isTap:Ut,mapEventToBoundingBox:J,ModeHandler:t,moveFeatures:Fi,sortFeatures:ae,stringSetsAreEqual:Do,StringSet:se,theme:ei,toDenseArray:vi}),tr=function($,V){var ue={options:$=function(Ve){Ve===void 0&&(Ve={});var je=Mi(Ve);return Ve.controls||(je.controls={}),Ve.displayControlsDefault===!1?je.controls=Mi(cl,Ve.controls):je.controls=Mi(xo,Ve.controls),(je=Mi(Gr,je)).styles=Zn(je.styles,"cold").concat(Zn(je.styles,"hot")),je}($)};V=function(Ve,je){return je.modes=U,je.getFeatureIdsAt=function(Ze){return Ie.click({point:Ze},null,Ve).map(function(Wt){return Wt.properties.id})},je.getSelectedIds=function(){return Ve.store.getSelectedIds()},je.getSelected=function(){return{type:O.FEATURE_COLLECTION,features:Ve.store.getSelectedIds().map(function(Ze){return Ve.store.get(Ze)}).map(function(Ze){return Ze.toGeoJSON()})}},je.getSelectedPoints=function(){return{type:O.FEATURE_COLLECTION,features:Ve.store.getSelectedCoordinates().map(function(Ze){return{type:O.FEATURE,properties:{},geometry:{type:O.POINT,coordinates:Ze.coordinates}}})}},je.set=function(Ze){if(Ze.type===void 0||Ze.type!==O.FEATURE_COLLECTION||!Array.isArray(Ze.features))throw new Error("Invalid FeatureCollection");var Wt=Ve.store.createRenderBatch(),Kt=Ve.store.getAllIds().slice(),bi=je.add(Ze),di=new se(bi);return(Kt=Kt.filter(function(hi){return!di.has(hi)})).length&&je.delete(Kt),Wt(),bi},je.add=function(Ze){var Wt=JSON.parse(JSON.stringify(Er(Ze))).features.map(function(Kt){if(Kt.id=Kt.id||Qt(),Kt.geometry===null)throw new Error("Invalid geometry: null");if(Ve.store.get(Kt.id)===void 0||Ve.store.get(Kt.id).type!==Kt.geometry.type){var bi=ri[Kt.geometry.type];if(bi===void 0)throw new Error("Invalid geometry type: "+Kt.geometry.type+".");var di=new bi(Ve,Kt);Ve.store.add(di)}else{var hi=Ve.store.get(Kt.id);hi.properties=Kt.properties,ul(hi.getCoordinates(),Kt.geometry.coordinates)||hi.incomingCoords(Kt.geometry.coordinates)}return Kt.id});return Ve.store.render(),Wt},je.get=function(Ze){var Wt=Ve.store.get(Ze);if(Wt)return Wt.toGeoJSON()},je.getAll=function(){return{type:O.FEATURE_COLLECTION,features:Ve.store.getAll().map(function(Ze){return Ze.toGeoJSON()})}},je.delete=function(Ze){return Ve.store.delete(Ze,{silent:!0}),je.getMode()!==U.DIRECT_SELECT||Ve.store.getSelectedIds().length?Ve.store.render():Ve.events.changeMode(U.SIMPLE_SELECT,void 0,{silent:!0}),je},je.deleteAll=function(){return Ve.store.delete(Ve.store.getAllIds(),{silent:!0}),je.getMode()===U.DIRECT_SELECT?Ve.events.changeMode(U.SIMPLE_SELECT,void 0,{silent:!0}):Ve.store.render(),je},je.changeMode=function(Ze,Wt){return Wt===void 0&&(Wt={}),Ze===U.SIMPLE_SELECT&&je.getMode()===U.SIMPLE_SELECT?(Do(Wt.featureIds||[],Ve.store.getSelectedIds())||(Ve.store.setSelected(Wt.featureIds,{silent:!0}),Ve.store.render()),je):(Ze===U.DIRECT_SELECT&&je.getMode()===U.DIRECT_SELECT&&Wt.featureId===Ve.store.getSelectedIds()[0]||Ve.events.changeMode(Ze,Wt,{silent:!0}),je)},je.getMode=function(){return Ve.events.getMode()},je.trash=function(){return Ve.events.trash({silent:!0}),je},je.combineFeatures=function(){return Ve.events.combineFeatures({silent:!0}),je},je.uncombineFeatures=function(){return Ve.events.uncombineFeatures({silent:!0}),je},je.setFeatureProperty=function(Ze,Wt,Kt){return Ve.store.setFeatureProperty(Ze,Wt,Kt),je},je}(ue,V),ue.api=V;var ke=dt(ue);return V.onAdd=ke.onAdd,V.onRemove=ke.onRemove,V.types=k,V.options=$,V};function $n($){tr($,this)}return $n.modes=Sn,$n.constants=_e,$n.lib=nr,$n})})(mapboxGlDraw$1);var mapboxGlDrawExports=mapboxGlDraw$1.exports;const MapboxDraw=getDefaultExportFromCjs(mapboxGlDrawExports),mapboxGlDraw="";var DrawAssistedRectangle$1={};Object.defineProperty(DrawAssistedRectangle$1,"__esModule",{value:!0});var doubleClickZoom={enable:function e(r){setTimeout(function(){!r.map||!r.map.doubleClickZoom||!r._ctx||!r._ctx.store||!r._ctx.store.getInitialConfigValue||r._ctx.store.getInitialConfigValue("doubleClickZoom")&&r.map.doubleClickZoom.enable()},0)},disable:function e(r){setTimeout(function(){!r.map||!r.map.doubleClickZoom||r.map.doubleClickZoom.disable()},0)}},DrawAssistedRectangle={onSetup:function e(r){var t=this.newFeature({type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[]]}});return this.addFeature(t),this.clearSelectedFeatures(),doubleClickZoom.disable(this),this.updateUIClasses({mouse:"add"}),this.setActionableState({trash:!0}),{rectangle:t,currentVertexPosition:0}},onTap:function e(r,t){this.onClick(r,t)},onClick:function e(r,t){if(r.currentVertexPosition===2){var o=this.calculatepXY3(r,t,!1);return o&&r.rectangle.updateCoordinate("0."+(r.currentVertexPosition+1),o[0],o[1]),this.updateUIClasses({mouse:"pointer"}),this.changeMode("simple_select",{featuresId:r.rectangle.id})}else r.rectangle.updateCoordinate("0."+r.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),r.currentVertexPosition++,r.rectangle.updateCoordinate("0."+r.currentVertexPosition,t.lngLat.lng,t.lngLat.lat)},onMouseMove:function e(r,t){if(r.rectangle.updateCoordinate("0."+r.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),r.currentVertexPosition&&r.currentVertexPosition>0&&this.calculateOrientedAnglePolygon(r),r.currentVertexPosition===2){var o=this.calculatepXY3(r,t,!0);o&&r.rectangle.updateCoordinate("0."+(r.currentVertexPosition+1),o[0],o[1])}},deegrees2meters:function e(r){var t=r[0]*2003750834e-2/180,o=Math.log(Math.tan((90+r[1])*Math.PI/360))/(Math.PI/180);return o=o*2003750834e-2/180,[t,o]},meters2degress:function e(r){var t=r[0]*180/2003750834e-2,o=Math.atan(Math.exp(r[1]*Math.PI/2003750834e-2))*360/Math.PI-90;return[t,o]},calculateOrientedAnglePolygon:function e(r){var t=r.rectangle.getCoordinate("0.0"),o=this.deegrees2meters(t),s=r.rectangle.getCoordinate("0.1"),d=this.deegrees2meters(s),g=Math.atan2(d[1]-o[1],d[0]-o[0])*180/Math.PI,a=-1*(g+90),b=a<0?a+360:a;r.angle=parseFloat(b.toFixed(2))},calculatepXY3:function e(r,t,o){var s=r.rectangle.getCoordinate("0.0"),d=this.deegrees2meters(s),g=r.rectangle.getCoordinate("0.1"),a=this.deegrees2meters(g),b=this.deegrees2meters([t.lngLat.lng,t.lngLat.lat]),_=this.deegrees2meters([t.lngLat.lng,t.lngLat.lat]);if(d[0]===a[0])b=[_[0],a[1]];else if(d[1]===a[1])b=[a[0],_[1]];else{var T=(a[1]-d[1])/(a[0]-d[0]),C=-1/T;Math.abs(C)<1?b[1]=C*(_[0]-a[0])+a[1]:b[0]=a[0]+(b[1]-a[1])/C}var D=[a[0]-d[0],a[1]-d[1]],k=[b[0]-D[0],b[1]-D[1]],O=this.meters2degress(b),U=this.meters2degress(k);return r.rectangle.updateCoordinate("0.2",O[0],O[1]),r.rectangle.updateCoordinate("0.3",U[0],U[1]),U},onKeyUp:function e(r,t){if(t.keyCode===27)return this.changeMode("simple_select")},onStop:function e(r){doubleClickZoom.enable(this),this.updateUIClasses({mouse:"none"}),this.activateUIButton(),this.getFeature(r.rectangle.id)!==void 0&&(r.rectangle.removeCoordinate("0.4"),r.rectangle.isValid()?this.map.fire("draw.create",{features:[r.rectangle.toGeoJSON()]}):(this.deleteFeature([r.rectangle.id],{silent:!0}),this.changeMode("simple_select",{},{silent:!0})))},toDisplayFeatures:function e(r,t,o){var s=t.properties.id===r.rectangle.id;if(t.properties.active=s?"true":"false",t.properties.angle=r.angle,t.angle=r.angle,!s)return o(t);var d=t.geometry.coordinates[0].length;if(d<3){var g=t.geometry.coordinates[0][0],a={type:"Feature",properties:t.properties,angle:r.angle,geometry:{coordinates:t.geometry.coordinates[0][0],type:"Point"}};g&&o(a);return}if(d>=3&&d<=4){var b=[[t.geometry.coordinates[0][0][0],t.geometry.coordinates[0][0][1]],[t.geometry.coordinates[0][1][0],t.geometry.coordinates[0][1][1]]];if(o({type:"Feature",properties:t.properties,angle:r.angle,geometry:{coordinates:b,type:"LineString"}}),d===3)return}return o(t)},onTrash:function e(r){this.deleteFeature([r.rectangle.id],{silent:!0}),this.changeMode("simple_select")}},_default=DrawAssistedRectangle$1.default=DrawAssistedRectangle;class MapboxGLButtonControl{constructor({className:r="",title:t="",eventHandler:o=evtHndlr}){this._className=r,this._title=t,this._eventHandler=o}onAdd(r){return this._btn=document.createElement("button"),this._btn.className="mapboxgl-ctrl-icon "+this._className,this._btn.type="button",this._btn.title=this._title,this._btn.onclick=this._eventHandler,this._container=document.createElement("div"),this._container.className="mapboxgl-ctrl-group mapboxgl-ctrl",this._container.appendChild(this._btn),this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}}const styles="";var tilesInBbox={};function lonToX(e,r){var t=Math.pow(2,r),o=Math.floor((e+180)/360*t);return o}function latToY(e,r){var t=e*Math.PI/180,o=Math.pow(2,r),s=Math.floor((1-Math.log(Math.tan(t)+1/Math.cos(t))/Math.PI)/2*o);return s}tilesInBbox.tilesInBbox=function(e,r){for(var t=[],o=lonToX(e.left,r),s=lonToX(e.right,r),d=latToY(e.top,r),g=latToY(e.bottom,r),a=o;a<=s;){for(var b=d;b<=g;)t.push({x:a,y:b,z:r}),b++;a++}return t};function useQuasar(){return inject(quasarKey)}const mapboxMapViewer_vue_vue_type_style_index_0_lang="";let draw,geocoder;const STYLES_DRAW=[{id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#FF0000","line-width":2}},{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#FF0000","fill-outline-color":"#D20C0C","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#D20C0C","line-width":2}},{id:"gl-draw-polygon-and-line-vertex-halo-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#FFF"}},{id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#D20C0C"}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","$type","LineString"],["==","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#FF0000","line-width":3}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","$type","Polygon"],["==","mode","static"]],paint:{"fill-color":"#ee0508","fill-opacity":.8}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","$type","Polygon"],["==","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#c40b0b","line-width":2}}],_sfc_main$4={name:"mapbox-map-viewer",setup(){const e=useQuasar();return{alert:ref(!1),alertMsg:ref(""),tileInfoString:ref(""),dirHandle:ref(""),qt:e,style_url:ref(""),zoom:ref(""),access_token:ref(""),rasterFromStyle:ref(!1),mapbox_raster_png_dem:ref(""),mapbox_api_url:ref(""),drawmode:ref("simple_select"),mapbox_rgb_image_url:ref(""),map:ref(""),features:ref([]),threedview:ref(!1),layers:ref(["hillshading","bounding_box","undersea-features-lines","undersea-features-points","undersea-features-points-label","10m-bathymetry-81bsvj"]),layer_type:[{label:"Hillshade",value:"hillshading"},{label:"Bounding Box",value:"bounding_box"},{label:"Undersea Lines",value:"undersea-features-lines"},{label:"Undersea Points",value:"undersea-features-points"},{label:"Undersea Labels",value:"undersea-features-points-label"},{label:"Depth",value:"10m-bathymetry-81bsvj"},{label:"Satellite",value:"satellite"},{label:"3D",value:"3d"}]}},mounted(){},methods:{async changeLayers(e){for(const r of this.layer_type)e.includes(r.value)?r.value!=="3d"?this.map.setLayoutProperty(r.value,"visibility","visible"):this.map.setTerrain({source:"mapbox-3d",exaggeration:1.5}):r.value!=="3d"?this.map.setLayoutProperty(r.value,"visibility","none"):this.map.setTerrain(null)},changeDrawMode(e){let r=document.getElementsByClassName("mapbox-gl-draw_polygon")[0],t=document.getElementsByClassName("mapbox-gl-draw_line")[0],o=e.target;o.title==="Select single tile"?(t.style.backgroundColor="white",r.style.backgroundColor="green",draw.deleteAll(),draw.changeMode("simple_select"),this.drawmode="simple_select"):o.title==="Draw Rectangle to select multiple tiles"&&(t.style.backgroundColor="green",r.style.backgroundColor="white",draw.deleteAll(),draw.changeMode("draw_assisted_rectangle"),this.drawmode="draw_assisted_rectangle",this.map.setPaintProperty("bounding_box","fill-opacity",0)),console.log(this.drawmode)},loadMapSourcesLayers(e){this.rasterFromStyle===!1&&(e.addSource("mapbox_terrain_dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1"}),e.addSource("satellite",{type:"raster",url:"mapbox://mapbox.satellite",tileSize:512}),e.addLayer({id:"satellite",source:"satellite",type:"raster",layout:{visibility:"none"}}),e.addLayer({id:"hillshading",source:"mapbox_terrain_dem",type:"hillshade"}),e.addSource("bounding_box_source",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,1],[1,1],[1,0],[0,0]]]}}}),e.addLayer({id:"bounding_box",type:"fill",source:"bounding_box_source",paint:{"fill-color":"#008888","fill-opacity":0}}),e.addSource("bathymetry",{type:"vector",url:"mapbox://mapbox-public.bathymetry"}),e.addLayer({id:"undersea-features-lines",type:"line",source:"bathymetry","source-layer":"undersea-features-lines",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ff69b4","line-width":2}}),e.addLayer({id:"undersea-features-points",type:"circle",source:"bathymetry","source-layer":"undersea-features-points",paint:{"circle-radius":4,"circle-color":"#01fe01"}}),e.addLayer({id:"undersea-features-points-label",type:"symbol",source:"bathymetry","source-layer":"undersea-features-points",layout:{"text-field":"{name}","text-anchor":"top-left","text-size":12}}),e.addSource("10m-bathymetry-81bsvj",{type:"vector",url:"mapbox://mapbox.9tm8dx88"}),e.addSource("mapbox-3d",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:15}),e.addLayer({id:"10m-bathymetry-81bsvj",type:"fill",source:"10m-bathymetry-81bsvj","source-layer":"10m-bathymetry-81bsvj",layout:{},paint:{"fill-outline-color":"hsla(337, 82%, 62%, 0)","fill-color":["interpolate",["cubic-bezier",0,.5,1,.5],["get","DEPTH"],200,"#78bced",9e3,"#15659f"]}},"land-structure-polygon"))},coordinateFeature(e,r){return{center:[e,r],geometry:{type:"Point",coordinates:[e,r]},place_name:"Lat: "+r+" Lng: "+e,place_type:["coordinate"],properties:{},type:"Feature"}},resizeMap(){this.map.resize()},async geoCodeReverse(e){mbxGeocoding({accessToken:mapboxgl.accessToken}).reverseGeocode({query:[e.pointLng,e.pointLat]}).send().then(function(t){if(t&&t.body&&t.body.features){e.address=t.body.features[0].place_name;let o=t.body.features[0].context;for(let s of o){let d=s.id;switch(d.substring(0,d.indexOf("."))){case"neighborhood":e.neighborhood=s.text;break;case"postcode":e.postcode=s.text;break;case"locality":e.locality=s.text;break;case"place":e.place=s.text;break;case"district":e.district=s.text;break;case"region":e.region=s.text;break;case"country":e.country=s.text;break}}}})},updateBBox(e){let r=e.features[0].geometry.coordinates[0],t,o,s,d;t=r[3][0],o=r[3][1],s=r[1][0],d=r[1][1];let g=[t,o,s,d],a=mapUtils.getTileInfo(0,0,!0,0,0,0,g);idbKeyval.set("tile_info",a)},async loadMapboxMap(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.mapbox_api_url=await idbKeyval.get("mapbox_api_url"),this.dirHandle=await idbKeyval.get("dirHandle"),this.style_url=await idbKeyval.get("style_url"),this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem");let e=this;if(!mapboxgl.supported())this.alertMsg="Your browser does not support Mapbox GL",this.alert=!0;else{let a=function(b){return b*(2-b)},r=new mapboxgl.Map({container:"map",trackResize:!0,style:e.style_url,center:[-121.7598,46.876],zoom:9,maxZoom:14,doubleClickZoom:!0,antialias:!0,boxZoom:!0,failIfMajorPerformanceCaveat:!0});this.map=r,this.map.doubleClickZoom.disable();const t=function(b){const _=b.match(/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i);if(!_)return null;const T=Number(_[1]),C=Number(_[2]),D=[];return(T<-90||T>90)&&D.push(e.coordinateFeature(T,C)),(C<-90||C>90)&&D.push(e.coordinateFeature(C,T)),D.length===0&&(D.push(e.coordinateFeature(T,C)),D.push(e.coordinateFeature(C,T))),D};geocoder=new MapboxGeocoder$1({accessToken:this.access_token,mapboxgl,localGeocoder:t,zoom:10,placeholder:"Try: Lng , Lat or Name",reverseGeocode:!0}),r.addControl(geocoder),r.addControl(new mapboxgl.FullscreenControl({})),r.addControl(new mapboxgl.NavigationControl),draw=new MapboxDraw({modes:{...MapboxDraw.modes,draw_assisted_rectangle:_default},displayControlsDefault:!1,controls:{},userProperties:!0,styles:STYLES_DRAW}),r.addControl(draw);const o=new MapboxGLButtonControl({className:"mapbox-gl-draw_polygon",title:"Select single tile",eventHandler:e.changeDrawMode});r.addControl(o);const s=new MapboxGLButtonControl({className:"mapbox-gl-draw_line",title:"Draw Rectangle to select multiple tiles",eventHandler:e.changeDrawMode});r.addControl(s);const d=100,g=25;r.on("wheel",()=>{e.zoom=Math.floor(r.getZoom())}),r.on("load",function(){let b=document.getElementsByClassName("mapbox-gl-draw_polygon")[0];b.style.backgroundColor="green",draw.changeMode("simple_select"),this.drawmode="simple_select",e.loadMapSourcesLayers(r),r.getCanvas().focus(),r.getCanvas().addEventListener("keydown",_=>{_.preventDefault(),_.which===87?r.panBy([0,-d],{easing:a}):_.which===83?r.panBy([0,d],{easing:a}):_.which===65?r.easeTo({bearing:r.getBearing()-g,easing:a}):_.which===68&&r.easeTo({bearing:r.getBearing()+g,easing:a})},!0)}),r.on("error",b=>{console.error(b)}),r.on("draw.create",function(b){console.log("draw mode create "+b.type),e.updateBBox(b)}),r.on("draw.update",function(b){console.log("draw mode update "+b.type),e.updateBBox(b)}),r.on("draw.selectionchange",function(b){console.log("draw mode selectionchange "+b.type)}),r.on("draw.delete",function(b){console.log("draw mode delete "+b.type)}),r.on("draw.modechange",b=>{console.log("draw mode CHANGE "+b.mode)}),r.on("click",async function(b){if(e.drawmode==="simple_select"){let _=b.lngLat.lng,T=b.lngLat.lat,C=Math.floor(r.getZoom()),D=mapUtils.getTileInfo(_,T,!1,0,0,C);idbKeyval.set("tile_info",D),e.tileInfoString="Slippy Tile Info String: "+D.x+","+D.y+","+D.z+" Bounding Box sides in KM: "+D.distance,r.getSource("bounding_box_source").setData(D.polygon_bb),r.setPaintProperty("bounding_box","fill-opacity",.45)}}),r.on("dblclick",async function(b){let _=await idbKeyval.get("dirHandle");if(await fileUtils.verifyPermission(_,!0)===!1){console.error(`User did not grant permission to '${_.name}'`);return}let T=await idbKeyval.get("tile_info");if(e.tileInfoString="Slippy Tile Info String: "+T.x+","+T.y+","+T.z+" Bounding Box sides in KM: "+T.distance,e.drawmode==="simple_select"){e.mapbox_rgb_image_url=e.mapbox_api_url+e.mapbox_raster_png_dem+`/${T.z}/${T.x}/${T.y}@2x.pngraw?access_token=`+e.access_token;let C=await mapUtils.getMapboxTerrainRgb(e.mapbox_rgb_image_url),D=await C.toBuffer();await idbKeyval.set("rgb_image_buffer",D),await fileUtils.writeFileToDisk(_,T.rgbFileName,D);let k=mapUtils.createHeightMapImage(C,32,"GREY");if(await fileUtils.fileExists(_,T.thirtyTwoFileName)===!1){let U=await k.image.toBuffer();await fileUtils.writeFileToDisk(_,T.thirtyTwoFileName,U)}emitter.emit("updatePreviewImage",{dir_handle:_,tile_info:T,preview_image_info:k,map:r})}else if(e.drawmode==="draw_assisted_rectangle"){let C=await idbKeyval.get("exportOptionsModel"),D=await idbKeyval.get("backendServer"),k=await idbKeyval.get("saveStitchingFiles"),O=await idbKeyval.get("mapbox_raster_style_endpoint")||"https://api.mapbox.com/styles/v1",U=await idbKeyval.get("mapbox_raster_style_url")||"",G=Math.floor(r.getZoom()),j=!0;e.qt.loading.show();try{const te=await fetch(D,{method:"GET"})}catch(te){console.log(te),j=!1,e.qt.loading.hide()}if(j===!0){let te={left:T.bbox[0],bottom:T.bbox[1],right:T.bbox[2],top:T.bbox[3]},H=tilesInBbox.tilesInBbox(te,G),Z=[],W=[],_e=[];for(let re of H){let ae={};T=mapUtils.getTileInfo(0,0,!0,re.x,re.y,re.z,T.bbox),e.tileInfoString="Slippy Tile Info String: "+T.x+","+T.y+","+T.z+" Bounding Box sides in KM: "+T.distance,e.mapbox_rgb_image_url=e.mapbox_api_url+e.mapbox_raster_png_dem+`/${T.z}/${T.x}/${T.y}@2x.pngraw?access_token=`+e.access_token;let se=await(await mapUtils.getMapboxTerrainRgb(e.mapbox_rgb_image_url)).toBuffer();k===!0&&await fileUtils.writeFileToDisk(_,T.rgbFileName,se);let Me=se.toString();if(ae.x=T.x,ae.y=T.y,ae.buffer=Me,Z.push(ae),C.includes("raster_style")){let Ie=O+"/"+U+`/tiles/512/${T.z}/${T.x}/${T.y}@2x?access_token=`+e.access_token,Ge=await(await mapUtils.getMapboxTerrainRgb(Ie)).toBuffer();ae={};let qt=Ge.toString();ae.x=T.x,ae.y=T.y,ae.buffer=qt,W.push(ae)}if(C.includes("satellite")){let We=await idbKeyval.get("mapbox_satellite_endpoint")+`/${T.z}/${T.x}/${T.y}@2x?access_token=`+e.access_token,qt=await(await mapUtils.getMapboxTerrainRgb(We)).toBuffer();ae={};let ti=qt.toString();ae.x=T.x,ae.y=T.y,ae.buffer=ti,_e.push(ae)}}idbKeyval.set("tile_info",T);let fe=JSON.stringify(Z);try{let ae=await(await fetch(D,{method:"POST",body:fe,headers:{"Content-Type":"application/json"}})).arrayBuffer();if(await idbKeyval.set("rgb_image_buffer",ae),await fileUtils.writeFileToDisk(_,T.rgbFileName,ae),C.includes("raster_style")){let Ie=JSON.stringify(W),Ge=await(await fetch(D,{method:"POST",body:Ie,headers:{"Content-Type":"application/json"}})).arrayBuffer();await idbKeyval.set("splat_image_buffer",Ge),await fileUtils.writeFileToDisk(_,"splat_"+T.rgbFileName,Ge)}if(C.includes("satellite")){let Ie=JSON.stringify(_e),Ge=await(await fetch(D,{method:"POST",body:Ie,headers:{"Content-Type":"application/json"}})).arrayBuffer();await idbKeyval.set("sat_image_buffer",Ge),await fileUtils.writeFileToDisk(_,"sat_"+T.rgbFileName,Ge)}let J=await mapUtils.loadImageFromArray(ae),se=mapUtils.createHeightMapImage(J,32,"GREY");if(await fileUtils.fileExists(_,T.thirtyTwoFileName)===!1){let Ie=await se.image.toBuffer();await fileUtils.writeFileToDisk(_,T.thirtyTwoFileName,Ie)}emitter.emit("updatePreviewImage",{dir_handle:_,tile_info:T,preview_image_info:se,map:r})}catch(re){console.log(re),e.alertMsg=re,e.alert=!0,e.qt.loading.hide()}e.qt.loading.hide()}else e.alertMsg="Cannot connect to backend server for stitching tiles.",e.alert=!0,e.qt.loading.hide()}})}}}},_hoisted_1$4={id:"map"},_hoisted_2$3=createBaseVNode("pre",{id:"features"},null,-1),_hoisted_3$3={class:"row no-wrap q-pa-md"},_hoisted_4$3={class:"column"},_hoisted_5$3=createBaseVNode("u",null,[createBaseVNode("b",null,"Enable Layers")],-1),_hoisted_6$3=createBaseVNode("div",{class:"text-h6"},"Alert",-1);function _sfc_render$4(e,r,t,o,s,d){return openBlock(),createElementBlock(Fragment,null,[createBaseVNode("div",_hoisted_1$4,[_hoisted_2$3,createVNode(QToolbar,{id:"mb-tbar",class:"bg-primary text-white q-pa-none q-ma-none"},{default:withCtx(()=>[createVNode(QBtn,{color:"info",label:"Map Settings"},{default:withCtx(()=>[createVNode(QMenu,null,{default:withCtx(()=>[createBaseVNode("div",_hoisted_3$3,[createBaseVNode("div",_hoisted_4$3,[_hoisted_5$3,createVNode(QOptionGroup,{dense:"",color:"green","checked-icon":"check","unchecked-icon":"clear",options:o.layer_type,type:"toggle",modelValue:o.layers,"onUpdate:modelValue":[r[0]||(r[0]=g=>o.layers=g),d.changeLayers]},null,8,["options","modelValue","onUpdate:modelValue"])])])]),_:1})]),_:1}),createTextVNode("       "+toDisplayString(" Zoom: "+this.zoom+" "+this.tileInfoString),1)]),_:1})]),createVNode(QDialog,{modelValue:o.alert,"onUpdate:modelValue":r[1]||(r[1]=g=>o.alert=g)},{default:withCtx(()=>[createVNode(QCard,null,{default:withCtx(()=>[createVNode(QCardSection,null,{default:withCtx(()=>[_hoisted_6$3]),_:1}),createVNode(QCardSection,{class:"q-pt-none"},{default:withCtx(()=>[createTextVNode(toDisplayString(o.alertMsg),1)]),_:1}),createVNode(QCardActions,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(QBtn,{flat:"",label:"OK",color:"primary"},null,512),[[ClosePopup]])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}const MapboxMapViewer=_export_sfc(_sfc_main$4,[["render",_sfc_render$4]]),wieghtmapViewer_vue_vue_type_style_index_0_scoped_a7c2d78d_lang="";let mapweight=null;const _sfc_main$3={name:"weightmap-viewer",setup(){return{qt:useQuasar(),access_token:ref("")}},methods:{async loadMapboxWeightMap(){let e=await idbKeyval.get("tile_info");if(e.hasOwnProperty("bbox")){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken;let t="mapbox://styles/"+(await idbKeyval.get("mapbox_raster_style_url")||"");mapweight===null&&(mapweight=new mapboxgl.Map({container:"mapweight",style:t})),mapweight.on("load",()=>{this.loadMapSourcesLayers(mapweight),mapweight.getSource("bounding_box_source").setData(e.polygon_bb),mapweight.setPaintProperty("bounding_box","fill-opacity",.45),mapweight.fitBounds(e.bbox)}),mapweight.getSource("bounding_box_source").setData(e.polygon_bb),mapweight.setPaintProperty("bounding_box","fill-opacity",.45),mapweight.fitBounds(e.bbox)}},loadMapSourcesLayers(e){mapweight.addSource("bounding_box_source",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,1],[1,1],[1,0],[0,0]]]}}}),mapweight.addLayer({id:"bounding_box",type:"fill",source:"bounding_box_source",paint:{"fill-color":"#008888","fill-opacity":0}})}}},_hoisted_1$3={id:"mapweight"};function _sfc_render$3(e,r,t,o,s,d){return openBlock(),createElementBlock("div",_hoisted_1$3)}const WeightmapViewer=_export_sfc(_sfc_main$3,[["render",_sfc_render$3],["__scopeId","data-v-a7c2d78d"]]),useRatioProps={ratio:[String,Number]};function useRatio(e,r){return computed(()=>{const t=Number(e.ratio||(r!==void 0?r.value:void 0));return isNaN(t)!==!0&&t>0?{paddingBottom:`${100/t}%`}:null})}const defaultRatio=16/9,QImg=createComponent({name:"QImg",props:{...useRatioProps,src:String,srcset:String,sizes:String,alt:String,crossorigin:String,decoding:String,referrerpolicy:String,draggable:Boolean,loading:{type:String,default:"lazy"},fetchpriority:{type:String,default:"auto"},width:String,height:String,initialRatio:{type:[Number,String],default:defaultRatio},placeholderSrc:String,fit:{type:String,default:"cover"},position:{type:String,default:"50% 50%"},imgClass:String,imgStyle:Object,noSpinner:Boolean,noNativeMenu:Boolean,noTransition:Boolean,spinnerColor:String,spinnerSize:String},emits:["load","error"],setup(e,{slots:r,emit:t}){const o=ref(e.initialRatio),s=useRatio(e,o);let d=null,g=!1;const a=[ref(null),ref(G())],b=ref(0),_=ref(!1),T=ref(!1),C=computed(()=>`q-img q-img--${e.noNativeMenu===!0?"no-":""}menu`),D=computed(()=>({width:e.width,height:e.height})),k=computed(()=>`q-img__image ${e.imgClass!==void 0?e.imgClass+" ":""}q-img__image--with${e.noTransition===!0?"out":""}-transition`),O=computed(()=>({...e.imgStyle,objectFit:e.fit,objectPosition:e.position}));watch(()=>U(),j);function U(){return e.src||e.srcset||e.sizes?{src:e.src,srcset:e.srcset,sizes:e.sizes}:null}function G(){return e.placeholderSrc!==void 0?{src:e.placeholderSrc}:null}function j(re){d!==null&&(clearTimeout(d),d=null),T.value=!1,re===null?(_.value=!1,a[b.value^1].value=G()):_.value=!0,a[b.value].value=re}function te({target:re}){g!==!0&&(d!==null&&(clearTimeout(d),d=null),o.value=re.naturalHeight===0?.5:re.naturalWidth/re.naturalHeight,H(re,1))}function H(re,ae){g===!0||ae===1e3||(re.complete===!0?Z(re):d=setTimeout(()=>{d=null,H(re,ae+1)},50))}function Z(re){g!==!0&&(b.value=b.value^1,a[b.value].value=null,_.value=!1,T.value=!1,t("load",re.currentSrc||re.src))}function W(re){d!==null&&(clearTimeout(d),d=null),_.value=!1,T.value=!0,a[b.value].value=null,a[b.value^1].value=G(),t("error",re)}function _e(re){const ae=a[re].value,J={key:"img_"+re,class:k.value,style:O.value,crossorigin:e.crossorigin,decoding:e.decoding,referrerpolicy:e.referrerpolicy,height:e.height,width:e.width,loading:e.loading,fetchpriority:e.fetchpriority,"aria-hidden":"true",draggable:e.draggable,...ae};return b.value===re?(J.class+=" q-img__image--waiting",Object.assign(J,{onLoad:te,onError:W})):J.class+=" q-img__image--loaded",h("div",{class:"q-img__container absolute-full",key:"img"+re},h("img",J))}function fe(){return _.value!==!0?h("div",{key:"content",class:"q-img__content absolute-full q-anchor--skip"},hSlot(r[T.value===!0?"error":"default"])):h("div",{key:"loading",class:"q-img__loading absolute-full flex flex-center"},r.loading!==void 0?r.loading():e.noSpinner===!0?void 0:[h(QSpinner,{color:e.spinnerColor,size:e.spinnerSize})])}return j(U()),onBeforeUnmount(()=>{g=!0,d!==null&&(clearTimeout(d),d=null)}),()=>{const re=[];return s.value!==null&&re.push(h("div",{key:"filler",style:s.value})),T.value!==!0&&(a[0].value!==null&&re.push(_e(0)),a[1].value!==null&&re.push(_e(1))),re.push(h(Transition,{name:"q-transition--fade"},fe)),h("div",{class:C.value,style:D.value,role:"img","aria-label":e.alt},re)}}});let Gdal,ZrangeSeaLevel=32767;const _sfc_main$2={name:"SideNav",setup(){const e=useQuasar();return{alert:ref(!1),isAlphaBrush:ref(!1),blurRadius:ref(0),blurRadiusWeightmap:ref(10),gridSize:ref(2),access_token:ref(""),isDisabled:ref(!1),isDownload:ref(!0),isWorldPartition:ref(!1),isLandscape:ref(!0),isExportOptions:ref(!0),isBlurRadius:ref(!0),isSendToUnreal:ref(!0),unrealLandscape:ref({label:505,value:505}),landscapeSize:[{label:"8129x8129",value:8129},{label:"6097x6097",value:6097},{label:"4033x4033",value:4033},{label:"3025x3025",value:3025},{label:"2017x2017",value:2017},{label:"1513x1513",value:1513},{label:"1009x1009",value:1009},{label:"512x512 -- Native Resolution",value:512},{label:"505x505",value:505}],url:ref(""),tile_info:ref(""),save_fileName:ref(""),dirHandle:ref(""),preview_image_info:ref(""),rgb_image:ref(""),img_min:ref(""),img_max:ref(""),map:null,data:null,bbinfoalert:ref(!1),exportType:ref({label:"Unreal Heightmap",value:"Unreal Heightmap"}),landscapeName:ref(""),alphaBrushName:ref(""),alphaBrushHeight:ref(505),alphaBrushWidth:ref(505),unrealMapPath:ref(""),qt:e,exportOptionsModel:ref(["zrange","combine_features"]),alertMsg:ref(""),exportOptions:[{label:"Zrange-sea level=0",value:"zrange"},{label:"Flip X",value:"flipx"},{label:"Flip y",value:"flipy"},{label:"Download Satellite",value:"satellite"},{label:"Download Geojson Features",value:"features"},{label:"Combine Unique Features",value:"combine_features"},{label:"Create Weightmap (Splatmap) Files",value:"raster_style"}],exportTyprOptions:[{label:"Unreal Heightmap",value:"Unreal Heightmap"},{label:"Unreal Terrain Magic Plugin -- EarthLandscape Clip",value:"Unreal Terrain Magic Plugin -- EarthLandscape Clip"},{label:"Unreal Terrain Magic Plugin -- HeightmapLandscape Clip",value:"Unreal Terrain Magic Plugin -- HeightmapLandscape Clip"},{label:"Unreal Stamp Brush Plugin",value:"Unreal Stamp Brush Plugin"},{label:"Unreal Landmass Effect Brush Plugin",value:"Unreal Landmass Effect Brush Plugin",cannotSelect:!1},{label:"None",value:"none"},{label:"Geojson Only",value:"geojson_only"}]}},async mounted(){Gdal=await initGdalJs({path:"https://cdn.jsdelivr.net/npm/gdal3.js@2.4.0/dist/package",useWorker:!1}),emitter.on("updatePreviewImage",e=>{this.data=e,this.updatePreviewImage()})},methods:{showNotify(e,r,t,o,s){this.qt.notify({message:e,color:r,position:t,icon:o,textColor:s})},copyTileInfoString(){this.tile_info?navigator.permissions.query({name:"clipboard-write"}).then(e=>{if(e.state==="granted"||e.state==="prompt"){let r=this.tile_info.x+","+this.tile_info.y+","+this.tile_info.z;navigator.clipboard.writeText(r).then(()=>{this.showNotify("Tile info string copied   "+r,"info","top","announcement","white")},()=>{})}}):(this.alertMsg="Please double click on your chosen selection first.",this.alert=!0)},copyExtents(){this.tile_info?navigator.permissions.query({name:"clipboard-write"}).then(e=>{if(e.state==="granted"||e.state==="prompt"){let r=this.tile_info.bboxW+","+this.tile_info.bboxS+","+this.tile_info.bboxE+","+this.tile_info.bboxN;navigator.clipboard.writeText(r).then(()=>{this.showNotify("Bounding box coordinates copied   "+r,"info","top","announcement","white")},()=>{})}}):(this.alertMsg="Please double click on your chosen selection first.",this.alert=!0)},landscapeSizeChange(){this.tile_info.resolution=this.unrealLandscape.value,this.adjustedZscale()},adjustedZscale(){let e=this.getUnrealZScale(this.preview_image_info.maxElevation,this.preview_image_info.minElevation),r=this.getUnrealXYScale();return this.tile_info.xyscale=r.toFixed(3),this.exportOptionsModel.includes("zrange")?(this.tile_info.startZRange=ZrangeSeaLevel,this.tile_info.zscale=e.toFixed(3)):(this.tile_info.startZRange=0,this.tile_info.zscale=e.toFixed(3)),this.tile_info.zscale},exportOptionsModelChange(e){this.exportOptionsModel=e,this.tile_info.resolution=this.unrealLandscape.value,this.adjustedZscale();let r=toRaw(this.exportOptionsModel);idbKeyval.set("exportOptionsModel",r)},exportType_Change(e){this.exportType.label==="Unreal Heightmap"||this.exportType.label==="None"||this.exportType.label==="Unreal Terrain Magic Plugin -- HeightmapLandscape Clip"?(this.isDownload=!0,this.isSendToUnreal=!0,this.isAlphaBrush=!1,this.isLandscape=!0,this.isExportOptions=!0,this.isBlurRadius=!0):this.exportType.label==="Unreal Stamp Brush Plugin"||this.exportType.label==="Unreal Landmass Effect Brush Plugin"?(this.isDownload=!1,this.isSendToUnreal=!0,this.isAlphaBrush=!0,this.isLandscape=!1,this.isExportOptions=!1,this.isBlurRadius=!0):this.exportType.label==="Geojson Only"?(this.isDownload=!0,this.isSendToUnreal=!1,this.isAlphaBrush=!1,this.isLandscape=!1,this.isExportOptions=!1,this.isBlurRadius=!1):this.exportType.label==="Unreal Terrain Magic Plugin -- EarthLandscape Clip"&&(this.isDownload=!1,this.isSendToUnreal=!0,this.isAlphaBrush=!1,this.isLandscape=!1,this.isExportOptions=!1,this.isBlurRadius=!1)},showBBInfo(){this.tile_info?this.bbinfoalert=!0:(this.bbinfoalert=!1,this.alertMsg="Please double click on your chosen selection first.",this.alert=!0)},updateStats(){this.preview_image_info.maxElevation!==""?(this.tile_info.MaxElevation=this.preview_image_info.maxElevation,this.tile_info.MinElevation=this.preview_image_info.minElevation,this.tile_info.minmax=this.tile_info.MinElevation.toFixed(3)+" / "+this.tile_info.MaxElevation.toFixed(3),this.tile_info.elevation_range=(this.tile_info.MaxElevation-this.tile_info.MinElevation).toFixed(3),this.tile_info.zscale=this.adjustedZscale()):this.tile_info.minmax=""},getUnrealZScale(e,r){let t,o;return this.exportOptionsModel.includes("zrange")?t=e*100:(r<0&&(r=0),t=(e-r)*100),o=t*.001953125,o},getUnrealXYScale(){return this.tile_info.distance*1e3/this.unrealLandscape.value*100},async updatePreviewImage(){this.preview_image_info=await this.data.preview_image_info,this.tile_info=this.data.tile_info,this.map=this.data.map;let e=await this.preview_image_info.image.toBlob();const r=URL.createObjectURL(e);this.url=r,this.updateStats(this.tile_info)},async saveImage(e,r,t){let o=await idbKeyval.get("dirHandle"),s=new Blob([e],{type:"image/"+t});await fileUtils.writeFileToDisk(o,r,s)},async processGdal(e,r,t,o,s){let d=new Blob([new Uint8Array(e)],{type:"image/"+o});const g=new File([d],r),b=(await Gdal.open(g)).datasets[0],_=await Gdal.gdal_translate(b,t),T=await Gdal.getFileBytes(_);s==="createHeightmap"&&await this.saveImage(T,r,o),Gdal.close(b)},async sendToUnreal(){let e="http://localhost:30010/",r="remote/object/call",t={},o,s,d,g="Mapbox_BP",a,b,_,T;if(this.tile_info)if(t={objectPath:"/Script/UnrealEd.Default__EditorActorSubsystem",functionName:"GetAllLevelActors"},o=await mapUtils.unrealRemoteControl(t,e+r),o.error)o.error.message==="Failed to fetch"?this.alertMsg="Cannot connect to Unreal server. Please make sure your project is open and Mapbox_BP is in the scene.  Also make sure you launched the Map using the Select Map button as this starts the Unreal Web Server":this.alertMsg=o.error.message,this.alert=!0;else{let C=await o.response.json();for(let D of C.ReturnValue)if(s=D.includes(g),s===!0){d=D;break}else d=null;if(d){this.exportType.label!=="Unreal Terrain Magic Plugin -- EarthLandscape Clip"?await this.createSixteenHeightMap():this.tile_info.resolution="505",this.exportType.label==="Unreal Stamp Brush Plugin"&&(a="/Game/Brushes/CustomBrushes/",b="/Game/Brushes/PEAKS/Peak_10_brush.Peak_10_brush",_="Textures/",T="HeightMap"),this.exportType.label==="Unreal Landmass Effect Brush Plugin"&&(a="/Game/Editor/Landscape/LandmassEffectBrush/CustomBrushes/",b="/Game/Editor/Landscape/LandmassEffectBrush/Effects/Variants/Map/HeightMapEffect.HeightMapEffect",_="Textures/",T="Heightmap (Greyscale / White is High)"),this.unrealMapPath=await idbKeyval.get("mappath"),this.tile_info.landscapeName=this.landscapeName;let D=this.tile_info.x+","+this.tile_info.y+","+this.tile_info.z,k;this.isWorldPartition===!0?k=this.gridSize:k=0,t={objectPath:d,functionName:"GenerateMapboxLandscape",parameters:{LandscapeName:this.tile_info.landscapeName,LandscapeSize:this.tile_info.resolution.toString(),TileHeightmapFileName:this.tile_info.sixteenFileName,TileGeojsonFileName:this.tile_info.geoJsonFileName,TileInfoFileName:this.tile_info.tileInfoFileName,MapMiddleLngX:this.tile_info.center.lng,MapMiddleLatY:this.tile_info.center.lat,MapBtmRLng:this.tile_info.bottomRight.lng,MapBtmLLng:this.tile_info.bottomLeft.lng,MapTopLLat:this.tile_info.topLeft.lat,MapBtmLLat:this.tile_info.bottomLeft.lat,RunFunction:this.exportType.label,SlippyMapTileString:D.trim(),HeightMapTexturesPath:"/Game/ImportedHeightMaps/",AlphaBrushName:this.tile_info.alphaBrushFileName,AlphaBrushDestinationPath:a,AlphaBrushTemplatePath:b,AlphaBrushTexturesPath:_,HeightmapProperty:T,WorldPartitionGridSize:k.toString()}},o=await mapUtils.unrealRemoteControl(t,e+r),o.error?(console.log(o.error),this.alertMsg=o.error.message,this.alert=!0):console.log(await o.response.json())}else this.alertMsg="Could not find Mapbox_BP in scene",this.alert=!0}else this.alertMsg="Please double click on your chosen selection first",this.alert=!0;this.qt.loading.hide()},async unrealTileFeatures(e){let r=mapUtils.getFeaturesFromBB(this.map,this.tile_info,e),t=JSON.stringify(r),o=JSON.stringify(this.tile_info);await fileUtils.writeFileToDisk(this.dirHandle,this.tile_info.geoJsonFileName,t),await fileUtils.writeFileToDisk(this.dirHandle,this.tile_info.tileInfoFileName,o)},async createSixteenHeightMap(){if(this.tile_info){let e,r;this.tile_info.resolution=this.unrealLandscape.value,mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken,this.tile_info.geoJsonFileName="geojson-"+this.tile_info.mapboxTileName+".json",this.tile_info.tileInfoFileName="tile-info-"+this.tile_info.mapboxTileName+".json",this.tile_info.sixteenFileName="sixteen-"+this.tile_info.mapboxTileName+"-LandscapeSize-"+this.tile_info.resolution+".png";let t=await idbKeyval.get("mapbox_satellite_endpoint");if(this.tile_info.mapbox_satellite_image_url=t+`/${this.tile_info.z}/${this.tile_info.x}/${this.tile_info.y}@2x?access_token=`+this.access_token,this.tile_info.satelliteFileName="satellite-"+this.tile_info.mapboxTileName+"-LandscapeSize-"+this.tile_info.resolution+".jpg",this.qt.loading.show(),this.dirHandle=await idbKeyval.get("dirHandle"),await fileUtils.verifyPermission(this.dirHandle,!0)===!1){console.error(`User did not grant permission to '${this.dirHandle.name}'`);return}if(fileUtils.fileExists(this.dirHandle,this.tile_info.thirtytwoFile)){let s=await idbKeyval.get("rgb_image_buffer"),d=await mapUtils.loadImageFromArray(s),g=mapUtils.createHeightMapImage(d,16,"GREY"),a=g.image;if(this.exportOptionsModel.includes("flipy")&&(a=await a.flipY()),this.exportOptionsModel.includes("flipx")&&(a=await a.flipX()),this.blurRadius>=1&&(a=a.blurFilter({radius:this.blurRadius})),r=await a.toBuffer(),this.img_min=parseInt(g.minElevation).toString(),this.img_max=parseInt(g.maxElevation).toString(),this.tile_info.resampleSize=this.unrealLandscape.value.toString(),this.tile_info.resizeMethod="lanczos",this.tile_info.exportTypeLabel=this.exportType.label,this.tile_info.alphaBrushFileName="alphabrush-"+this.tile_info.mapboxTileName+"-height-"+this.alphaBrushHeight+"-width-"+this.alphaBrushWidth,this.exportOptionsModel.includes("features")){let b=!1;this.exportOptionsModel.includes("combine_features")&&(b=!0),await this.unrealTileFeatures(b)}switch(this.tile_info.exportTypeLabel){case"Unreal Terrain Magic Plugin -- HeightmapLandscape Clip":if(e=["-ot","UInt16","-of","PNG","-scale",this.img_min,this.img_max,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod.toString()],await this.processGdal(r,this.tile_info.sixteenFileName,e,"png","createHeightmap"),this.exportOptionsModel.includes("satellite")){e=["-of","JPEG","-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod];let b=await mapUtils.downloadTerrainRgb(this.tile_info.mapbox_satellite_image_url);await this.processGdal(b,this.tile_info.satelliteFileName,e,"jpg","createHeightmap")}this.qt.loading.hide();break;case"Unreal Heightmap":if(this.tile_info.resampleSize!==512){if(e=["-ot","UInt16","-of","PNG","-scale",this.img_min,this.img_max,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod.toString()],await this.processGdal(r,this.tile_info.sixteenFileName,e,"png","createHeightmap"),this.exportOptionsModel.includes("satellite")){e=["-of","JPEG","-outsize",this.tile_info.resampleSize,this.tile_info.resampleSize,"-r",this.tile_info.resizeMethod];let b=await mapUtils.downloadTerrainRgb(this.tile_info.mapbox_satellite_image_url);await this.processGdal(b,this.tile_info.satelliteFileName,e,"jpg","createHeightmap")}if(this.exportOptionsModel.includes("raster_style")){let b=await idbKeyval.get("mapbox_raster_style_endpoint")||"https://api.mapbox.com/styles/v1",_=await idbKeyval.get("mapbox_raster_style_url")||"",T=b+"/"+_+`/tiles/512/${this.tile_info.z}/${this.tile_info.x}/${this.tile_info.y}@2x?access_token=`+this.access_token,C=await mapUtils.downloadTerrainRgb(T),D=await mapUtils.loadImageFromArray(C);await this.saveImage(C,"splat_"+this.tile_info.sixteenFileName,"png");let k=D.getPixelsArray(),O=[0,0,0],U=[255,255,255],G=[],j=await idbKeyval.get("weightmap_data");for(let te of j){G=JSON.stringify(te.color.split(",").map(Number));for(let W=0;W<k.length;W++)JSON.stringify(k[W])===G?D.setPixel(W,U):D.setPixel(W,O);let Z=await D.resize({width:this.tile_info.resampleSize,height:this.tile_info.resampleSize}).gaussianFilter({radius:this.blurRadiusWeightmap}).toBuffer();await this.saveImage(Z,"splat_"+te.name+"_"+this.tile_info.sixteenFileName,"png")}}}else if(await this.saveImage(r,this.tile_info.sixteenFileName,"png"),this.exportOptionsModel.includes("satellite")){let b=await mapUtils.downloadTerrainRgb(this.tile_info.mapbox_satellite_image_url);await this.saveImage(b,this.tile_info.satelliteFileName,"png")}this.qt.loading.hide();break;case"Geojson Only":await this.unrealTileFeatures(!0),this.qt.loading.hide();break;case"Unreal Stamp Brush Plugin":this.alphaBrushName.length>0&&(this.tile_info.alphaBrushFileName=this.alphaBrushName),e=["-ot","UInt16","-of","PNG","-scale",this.img_min,this.img_max,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.alphaBrushHeight.toString(),this.alphaBrushWidth.toString(),"-r",this.tile_info.resizeMethod],await this.processGdal(r,this.tile_info.alphaBrushFileName+".png",e,"png","createHeightmap"),this.qt.loading.hide();break;case"Unreal Landmass Effect Brush Plugin":this.alphaBrushName.length>0&&(this.tile_info.alphaBrushFileName=this.alphaBrushName),e=["-ot","UInt16","-of","PNG","-scale",this.img_min,this.img_max,this.tile_info.startZRange.toString(),this.tile_info.maxPngValue.toString(),"-outsize",this.alphaBrushHeight.toString(),this.alphaBrushWidth.toString(),"-r",this.tile_info.resizeMethod],await this.processGdal(r,this.tile_info.alphaBrushFileName+".png",e,"png","createHeightmap"),this.qt.loading.hide();break;case"None":await fileUtils.writeFileToDisk(this.dirHandle,this.tile_info.sixteenFileName,a.toBuffer()),this.qt.loading.hide();break}}else this.alertMsg="Please double click on your chosen selection first.",this.alert=!0}else this.alertMsg="Please double click on your chosen selection first.",this.alert=!0}}},_hoisted_1$2=createBaseVNode("div",{id:"previewTitle",class:"text-h6 bg-primary text-white"},"Preview Image",-1),_hoisted_2$2={class:"row justify-start q-pa-none q-mb-md"},_hoisted_3$2={style:{width:"100%"}},_hoisted_4$2={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_5$2={class:"text-weight-bold q-pt-sm self-center full-width no-outline",tabindex:"0"},_hoisted_6$2=createBaseVNode("b",null,[createBaseVNode("u",null,"Export Type:")],-1),_hoisted_7$2=createBaseVNode("b",null,[createBaseVNode("u",null,"Export Options:")],-1),_hoisted_8$2=createBaseVNode("div",{class:"text-h6"},[createBaseVNode("u",null,"Coordinates for Unreal LandscapeGen Plugin")],-1),_hoisted_9$2=createBaseVNode("div",{class:"text-h6"},"Zoom:",-1),_hoisted_10$1=createBaseVNode("div",{class:"text-h6"},"Mouse Point Lat/Lng:",-1),_hoisted_11$1=createBaseVNode("div",{class:"text-h6"},[createBaseVNode("u",null,"Bounding Box Corners Lat/Lng:")],-1),_hoisted_12$1=createBaseVNode("div",{class:"text-h6"},"Top Left:",-1),_hoisted_13$1=createBaseVNode("div",{class:"text-h6"},"Bottom Left:",-1),_hoisted_14=createBaseVNode("div",{class:"text-h6"},"Top Right:",-1),_hoisted_15=createBaseVNode("div",{class:"text-h6"},"Bottom Right:",-1),_hoisted_16=createBaseVNode("div",{class:"text-h6"},"Lng/Lat Max/Min:",-1),_hoisted_17=createBaseVNode("div",{class:"text-h6"},"Alert",-1);function _sfc_render$2(e,r,t,o,s,d){return openBlock(),createElementBlock(Fragment,null,[_hoisted_1$2,createVNode(QImg,{src:o.url,height:"150px"},null,8,["src"]),createBaseVNode("div",_hoisted_2$2,[createBaseVNode("div",_hoisted_3$2,[createVNode(QField,{dense:"",class:"text-weight-bolder q-pt-none q-mt-xs",label:"Min/Max Elevation","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_4$2,toDisplayString(this.tile_info.minmax),1)]),_:1}),createVNode(QField,{class:"q-pt-none q-mt-xs",dense:"",label:"Unreal X,Y and Z-Scale",hint:"Input into Unreal Landscape Z scale","stack-label":""},{control:withCtx(()=>[createBaseVNode("div",_hoisted_5$2,toDisplayString(this.tile_info.xyscale)+", "+toDisplayString(this.tile_info.xyscale)+", "+toDisplayString(this.tile_info.zscale),1)]),_:1}),createVNode(QItemLabel,{dense:"",class:"q-pt-none q-mt-xs"},{default:withCtx(()=>[_hoisted_6$2]),_:1}),createVNode(QSelect,{class:"q-mt-none q-pt-none","bg-color":"blue-2",outlined:"",filled:"",dense:"",modelValue:o.exportType,"onUpdate:modelValue":[r[0]||(r[0]=g=>o.exportType=g),d.exportType_Change],options:o.exportTyprOptions,"option-disable":"cannotSelect"},null,8,["modelValue","options","option-disable","onUpdate:modelValue"]),withDirectives(createVNode(QItemLabel,{dense:"",class:"q-pt-none q-mt-xs"},{default:withCtx(()=>[_hoisted_7$2]),_:1},512),[[vShow,o.isExportOptions]]),withDirectives(createVNode(QOptionGroup,{class:"q-mt-none q-pt-none",dense:"",inline:"",options:o.exportOptions,"onUpdate:modelValue":[d.exportOptionsModelChange,r[1]||(r[1]=g=>o.exportOptionsModel=g)],type:"checkbox",modelValue:o.exportOptionsModel},null,8,["options","onUpdate:modelValue","modelValue"]),[[vShow,o.isExportOptions]]),withDirectives(createVNode(QSelect,{dense:"",class:"q-pt-none q-mt-xs",label:"Landscape Size","transition-show":"scale","transition-hide":"scale",hint:"Unreal Recommended Sizes",outlined:"",modelValue:o.unrealLandscape,"onUpdate:modelValue":[r[2]||(r[2]=g=>o.unrealLandscape=g),d.landscapeSizeChange],options:o.landscapeSize},null,8,["modelValue","options","onUpdate:modelValue"]),[[vShow,o.isLandscape]]),withDirectives(createVNode(QField,{dense:"",class:"q-pt-none q-mt-xs"},{default:withCtx(()=>[createVNode(QCheckbox,{modelValue:o.isWorldPartition,"onUpdate:modelValue":r[3]||(r[3]=g=>o.isWorldPartition=g),label:"Enable World Partition"},null,8,["modelValue"])]),_:1},512),[[vShow,o.isLandscape]]),withDirectives(createVNode(QField,{dense:"",class:"q-pt-none q-mt-xs",label:"World Partition Grid Size"},{default:withCtx(()=>[createVNode(QInput,{dense:"",class:"q-pt-none q-mt-xs",modelValue:o.gridSize,"onUpdate:modelValue":r[4]||(r[4]=g=>o.gridSize=g)},null,8,["modelValue"])]),_:1},512),[[vShow,o.isLandscape]]),withDirectives(createVNode(QField,{dense:"",class:"q-pt-none q-mt-xs",label:"Brush Size"},{default:withCtx(()=>[createVNode(QInput,{dense:"",class:"q-pt-none q-mt-xs",filled:"",modelValue:o.alphaBrushHeight,"onUpdate:modelValue":r[5]||(r[5]=g=>o.alphaBrushHeight=g),label:"Height"},null,8,["modelValue"]),createVNode(QInput,{dense:"",class:"q-pt-none q-mt-xs",filled:"",modelValue:o.alphaBrushWidth,"onUpdate:modelValue":r[6]||(r[6]=g=>o.alphaBrushWidth=g),label:"Width"},null,8,["modelValue"]),createVNode(QInput,{ref:"alphaBrushNameRef",dense:"",modelValue:o.alphaBrushName,"onUpdate:modelValue":r[7]||(r[7]=g=>o.alphaBrushName=g),label:"Brush Name"},null,8,["modelValue"])]),_:1},512),[[vShow,o.isAlphaBrush]]),withDirectives(createVNode(QField,{dense:"",class:"q-pt-none q-mt-xs",label:"Landscape Name (Optional)",hint:"Enter Unique Landscape Name"},{default:withCtx(()=>[createVNode(QInput,{dense:"",modelValue:o.landscapeName,"onUpdate:modelValue":r[8]||(r[8]=g=>o.landscapeName=g)},null,8,["modelValue"])]),_:1},512),[[vShow,o.isLandscape]]),withDirectives(createVNode(QField,{dense:"",class:"q-pt-none q-mt-xs",label:"Blur Radius"},{default:withCtx(()=>[createVNode(QInput,{dense:"",class:"q-pt-none q-mt-xs",modelValue:o.blurRadius,"onUpdate:modelValue":r[9]||(r[9]=g=>o.blurRadius=g)},null,8,["modelValue"])]),_:1},512),[[vShow,o.isBlurRadius]]),withDirectives(createVNode(QField,{dense:"",class:"q-pt-none q-mt-xs",label:"Weightmap Blur Radius"},{default:withCtx(()=>[createVNode(QInput,{dense:"",class:"q-pt-none q-mt-xs",modelValue:o.blurRadiusWeightmap,"onUpdate:modelValue":r[10]||(r[10]=g=>o.blurRadiusWeightmap=g)},null,8,["modelValue"])]),_:1},512),[[vShow,o.isBlurRadius]])])]),withDirectives(createVNode(QBtn,{onClick:d.createSixteenHeightMap,ref:"btnDownload",dense:"",color:"primary","no-caps":"",label:"Download HeightMap"},null,8,["onClick"]),[[vShow,o.isDownload]]),withDirectives(createVNode(QBtn,{onClick:d.sendToUnreal,disabled:o.isDisabled,dense:"",color:"green",class:"q-ml-xs","no-caps":"",label:"Send To Unreal"},null,8,["onClick","disabled"]),[[vShow,o.isSendToUnreal]]),createVNode(QBtn,{onClick:d.copyExtents,disabled:o.isDisabled,dense:"",color:"purple",class:"q-ml-xs","no-caps":"",label:"Copy Bounds for Blender Osm"},null,8,["onClick","disabled"]),createVNode(QBtn,{onClick:d.copyTileInfoString,disabled:o.isDisabled,dense:"",color:"cyan",class:"q-ml-xs","no-caps":"",label:"Copy Slippy Tile Info String"},null,8,["onClick","disabled"]),createVNode(QBtn,{onClick:d.showBBInfo,dense:"",color:"orange","no-caps":"",label:"Show Bounding Box Info"},null,8,["onClick"]),createVNode(QDialog,{modelValue:o.bbinfoalert,"onUpdate:modelValue":r[11]||(r[11]=g=>o.bbinfoalert=g)},{default:withCtx(()=>[createVNode(QCard,null,{default:withCtx(()=>[createVNode(QCardSection,null,{default:withCtx(()=>[_hoisted_8$2]),_:1}),createVNode(QCardSection,{class:"q-pt-none"},{default:withCtx(()=>[_hoisted_9$2,createTextVNode(" "+toDisplayString(o.tile_info.z)+" ",1),_hoisted_10$1,createTextVNode(" Lat: "+toDisplayString(o.tile_info.pointLat)+" Lng: "+toDisplayString(o.tile_info.pointLng)+" ",1),_hoisted_11$1,_hoisted_12$1,createTextVNode(" Lat: "+toDisplayString(o.tile_info.topLeft.lat)+" Lng: "+toDisplayString(o.tile_info.topLeft.lng)+" ",1),_hoisted_13$1,createTextVNode(" Lat: "+toDisplayString(o.tile_info.bottomLeft.lat)+" Lng: "+toDisplayString(o.tile_info.bottomLeft.lng)+" ",1),_hoisted_14,createTextVNode(" Lat: "+toDisplayString(o.tile_info.topRight.lat)+" Lng: "+toDisplayString(o.tile_info.topRight.lng)+" ",1),_hoisted_15,createTextVNode(" Lat: "+toDisplayString(o.tile_info.bottomRight.lat)+" Lng: "+toDisplayString(o.tile_info.bottomRight.lng)+" ",1),_hoisted_16,createTextVNode(" Lng/Lat-Min: "+toDisplayString(o.tile_info.bboxW)+" , "+toDisplayString(o.tile_info.bboxS)+" Lng/Lat-Max: "+toDisplayString(o.tile_info.bboxE)+" , "+toDisplayString(o.tile_info.bboxN),1)]),_:1}),createVNode(QCardActions,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(QBtn,{flat:"",label:"OK",color:"primary"},null,512),[[ClosePopup]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),createVNode(QDialog,{modelValue:o.alert,"onUpdate:modelValue":r[12]||(r[12]=g=>o.alert=g)},{default:withCtx(()=>[createVNode(QCard,null,{default:withCtx(()=>[createVNode(QCardSection,null,{default:withCtx(()=>[_hoisted_17]),_:1}),createVNode(QCardSection,{class:"q-pt-none"},{default:withCtx(()=>[createTextVNode(toDisplayString(o.alertMsg),1)]),_:1}),createVNode(QCardActions,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(QBtn,{flat:"",label:"OK",color:"primary"},null,512),[[ClosePopup]])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}const SideNav=_export_sfc(_sfc_main$2,[["render",_sfc_render$2]]),version="2.6.5",_sfc_main$1={setup(){return{appVersion:ref(version)}},emits:["ok","hide"],methods:{show(){this.$refs.dialog.show()},hide(){this.$refs.dialog.hide()},onDialogHide(){this.$emit("hide")},onOKClick(){this.$emit("ok"),this.hide()},onCancelClick(){this.hide()}}},_hoisted_1$1=createBaseVNode("div",null,[createBaseVNode("b",null,"Help")],-1),_hoisted_2$1=createBaseVNode("br",null,null,-1),_hoisted_3$1=createBaseVNode("div",{class:"q-mt-sm"},[createBaseVNode("b",null,"Settings Page:")],-1),_hoisted_4$1=createBaseVNode("ol",null,[createBaseVNode("li",null,[createTextVNode(" You need to create a free Mapbox account and enter your mapbox access token. Goto "),createBaseVNode("a",{href:"https://www.mapbox.com",target:"_blank"},"Mapbox"),createTextVNode(" then goto your account page. There you can copy your access token. ")]),createBaseVNode("li",null," Select a download folder. This is a folder on your local pc where your heightmap files will be saved. ")],-1),_hoisted_5$1=createBaseVNode("div",{class:"q-mt-sm"},[createBaseVNode("b",null,"Map Page:")],-1),_hoisted_6$1=createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Map Settings"),createTextVNode(" -- Enable different layers for viewing. This does not affect downloaded data ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Search Bar"),createTextVNode(" -- Enter the name of a location or Longitude Latitude seperated by a comma. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Top Bar"),createTextVNode(" -- Area in KM show the area of the blue bounding box in Kilometers. Slippy Tile Info String is a standard format identification for downloading map tiles. Format is X,Y,Z Z = zoom level. ")])],-1),_hoisted_7$1=createBaseVNode("div",{class:""},[createBaseVNode("b",null,"Map Navigation:")],-1),_hoisted_8$1=createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Select a Draw mode"),createTextVNode(" -- Select a draw mode from the control on the right of the map. "),createBaseVNode("br"),createBaseVNode("u",null,[createBaseVNode("img",{src:"/single_tile.png",alt:"Single select"}),createTextVNode(" Single tile select")]),createTextVNode(" -- Select a single tile (default mode) "),createBaseVNode("br"),createBaseVNode("u",null,[createBaseVNode("img",{src:"/multiple_tile.png",alt:"Multiple select"}),createTextVNode(" Draw rectangle to select multiple tiles")]),createTextVNode(" -- Note you need to run the backend server for tile stitching See Tile stitching video at the bottom for use. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Left Mouse Click"),createTextVNode(" -- Selects a location on the map indicated by a blue bounding box. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Double Left Mouse Click"),createTextVNode(" -- Download the tile preview and tile information. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Left Mouse Hold"),createTextVNode(" -- Drag the mouse around to move the map. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Left Mouse Hold"),createTextVNode(" -- Drag the mouse around to move the map. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Right Mouse Hold"),createTextVNode(" -- Tilt and Rotate the map. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Scroll Wheel"),createTextVNode(" -- Zoom in and out. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Arrow Keys"),createTextVNode(" -- Move around the map. ")])],-1),_hoisted_9$1=createBaseVNode("div",{class:"q-mb-md"},[createBaseVNode("b",null,"Left Side Bar:")],-1),_hoisted_10=createBaseVNode("div",{class:"q-ml-md"},[createBaseVNode("div",null,[createBaseVNode("u",null,"Export Type:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Heightmap"),createTextVNode(" -- Generates a 16-bit png heightmap file. Can be used in other applications besides Unreal. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Terrain Magic Plugin -- EarthLandscape Clip"),createTextVNode(" -- Sends tile info string x,y and zoom to Terrain Magic. You will need to install the custom version of Terrain Magic from this link "),createBaseVNode("a",{href:"https://github.com/delebash/unreal-terrain-magic/releases",target:"_blank"},"Custom Version Of Terrain Magic"),createTextVNode(". Terrain magic has it's own map to import heightmaps for Unreal but I just added it to mine for ease of use. This just makes it a one click solution instead of copy and paste. If you like Terrain Magic please purchase it from the marketplace link in description. Original source for non-commercial "),createBaseVNode("a",{href:"https://github.com/GDi4K/unreal-terrain-magic",target:"_blank"},"Terrain Magic")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Terrain Magic Plugin -- HeightmapLandscape Clip"),createTextVNode(" -- Downloads heightmap from this app and loads it into Terrain Magic. You will need to install the custom version of Terrain Magic from this link "),createBaseVNode("a",{href:"https://github.com/delebash/unreal-terrain-magic/releases",target:"_blank"},"Custom Version Of Terrain Magic"),createTextVNode(". Terrain magic has it's own map to import heightmaps for Unreal but I just added to mine for ease of use. This just makes it a one click solution instead of copy and paste. If you like Terrain Magic please purchase it from the marketplace link in description. Original source for non-commercial "),createBaseVNode("a",{href:"https://github.com/GDi4K/unreal-terrain-magic",target:"_blank"},"Terrain Magic")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Stamp Brush Plugin"),createTextVNode(" -- You need to install paid plugin "),createBaseVNode("a",{href:"https://www.unrealengine.com/marketplace/en-US/product/landscape-stamping-tool-100-custom-brushes?sessionInvalidated=true"},"Landscape Stamping Tool - 100+ Custom Brushes"),createTextVNode(". This automates the creation of new stamps from selected map location. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Unreal Landmass Effect Brush Plugin"),createTextVNode(" -- Open source plugin for creating non-destructive landmass stamps and other features. Download the source from here "),createBaseVNode("a",{href:"https://github.com/AWeinb/SimplerLandmassBlueprints"},"SimplerLandmassBlueprints"),createTextVNode(". From the Content folder copy the whole Editor folder to your Content directory. Each time you click Send To Unreal it will import the texture to a sub folder CustomBrushes > Textures. For now it only imports the texture you have to manually add the texture to the brush according to the github instructions. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"None"),createTextVNode(" -- Generate 16-bit png heightmap but do not do any other transformations to the image. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Geojson Only"),createTextVNode(" -- Do not download a heightmap png file. Just download a Geojson file. ")])])]),createBaseVNode("div",null,[createBaseVNode("u",null,"Export Options:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Zrange-sea level="),createTextVNode(" -- By checking this the imported heightmap will keep the landscape height near 100 Unreal Units. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"FlipX/FlipY"),createTextVNode(" -- Flips the sides of the heightmap image in the X or Y direction. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Download Satellite"),createTextVNode(" -- Downloads a Satellite Image of the selected area. This can be used as on overlay in UE. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Download Geojson Features"),createTextVNode(" -- Downloads the features of the selected area in geojson format. Search Mapbox for geosjon. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Combine Unique Features"),createTextVNode(" -- Removes overlapping features when downloading geojson ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Create Weightmap (Splatmap) Files"),createTextVNode(" -- You can now create weightmap files for use in Unreal for texturing your landscape. Setup and Use instructions https://www.youtube.com/watch?v=j_4pZ5EneVc&t=6s ")])])])],-1),_hoisted_11=createBaseVNode("div",null,[createBaseVNode("u",null,"Landscape:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Landscape Size"),createTextVNode(" -- Resamples the size of the image to recommended Unreal Landscape sizes. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Enable World Partition"),createTextVNode(" -- If you have a World Partition project and want a World Partition landscape with proxies, enable this.. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"World Partition Grid Size"),createTextVNode(" -- Grid size setting. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Landscape Name"),createTextVNode(" -- Name of the landscape to be imported. (Optional ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Blur Radius"),createTextVNode(" -- Adds a gaussian blur to the heightmap png. This can help smooth out your imported landscape if it has some sharp edges. The greater the number the greater the blur. 0 = no blur. ")])])],-1),_hoisted_12=createBaseVNode("div",null,[createBaseVNode("u",null,"Buttons:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("u",null,"Download Heightmap"),createTextVNode(" -- Downloads the heightmap png to the folder location on the settings page. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Send To Unreal"),createTextVNode(" -- Automatically imports heightmap or stamp into your Unreal project. Required -- Mapbox_BP has to be installed in to your unreal project and configured. You can download the free plugin here "),createBaseVNode("a",{href:"https://github.com/delebash/UnrealMapboxBridgePlugin"},"Unreal Mapbox Bridge Plugin"),createTextVNode(". ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Copy Bounds for Blender OSM"),createTextVNode(" -- A plugin for blend that downloads real world map info into blender. It has it's own map but you can use this one as well since it has a search by name feature. Download "),createBaseVNode("a",{href:"https://github.com/vvoovv/blender-osm"},"Blender OSM"),createTextVNode(". ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Copy Slippy Tile Info String"),createTextVNode(" -- This format is used in many other GIS applications to download map tile information. This is just a convenience function. This is also the same string Terrain Magic expects. ")]),createBaseVNode("li",null,[createBaseVNode("u",null,"Show Bounding Box Info"),createTextVNode(" -- General info such as Long/Lat info for bounding box. ")])])],-1),_hoisted_13=createBaseVNode("div",null,[createBaseVNode("u",null,"Videos:"),createBaseVNode("ul",null,[createBaseVNode("li",null,[createBaseVNode("a",{href:"https://www.youtube.com/playlist?list=PLFCVXzupw1r_7ExUSGDxHGHU-gPRxOGeZ"},"Unreal Mapbox Bridge Tutorial Playlist")])])],-1);function _sfc_render$1(e,r,t,o,s,d){return openBlock(),createBlock(QDialog,{class:"dialog-plugin",ref:"dialog",onHide:d.onDialogHide},{default:withCtx(()=>[createVNode(QCard,{style:{width:"900px","max-width":"80vw",height:"700px"}},{default:withCtx(()=>[createVNode(QCardSection,null,{default:withCtx(()=>[_hoisted_1$1,_hoisted_2$1,createVNode(QSeparator),_hoisted_3$1,_hoisted_4$1,_hoisted_5$1,_hoisted_6$1,_hoisted_7$1,_hoisted_8$1,_hoisted_9$1,_hoisted_10,_hoisted_11,_hoisted_12,_hoisted_13,createVNode(QCardActions,{class:"absolute-top",align:"right"},{default:withCtx(()=>[createTextVNode(" App Version "+toDisplayString(o.appVersion)+"  ",1),createVNode(QBtn,{color:"primary",label:"Close",onClick:d.onOKClick},null,8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["onHide"])}const Help=_export_sfc(_sfc_main$1,[["render",_sfc_render$1]]),columns=[{name:"name",align:"left",label:"Name",field:"name",sortable:!0},{name:"color",align:"left",label:"Color",field:"color",sortable:!0}];let rows=[{name:"Forest",color:"201, 28, 19"},{name:"Water",color:"78, 143, 207"},{name:"Scrub",color:"143, 253, 139"},{name:"Trees",color:"34, 106, 32"},{name:"Rock",color:"101, 100, 93"},{name:"Sand",color:"243, 234, 129"},{name:"Grass",color:"33, 225, 29"},{name:"Glacier",color:"255, 255, 255"},{name:"Landcover",color:"0, 0, 0"},{name:"Hillshade",color:"242, 110, 220"}];const _sfc_main={setup(){const e=useQuasar(),r=ref([]),t=ref(!1);return{selected:r,columns,rows:ref(rows),loading:t,pagination:ref({rowsPerPage:0}),getSelectedString(){return r.value.length===0?"":`${r.value.length} record${r.value.length>1?"s":""} selected of ${rows.length}`},showDialog(){e.dialog({component:Help,componentProps:{text:""}}).onOk(()=>{}).onCancel(()=>{}).onDismiss(()=>{})},data_path:"",selectedTab:ref("map"),alert:ref(!1),alertMsg:ref(""),backendServer:ref(""),saveStitchingFiles:ref(!1),dirHandle:ref(""),dirName:ref(""),style_url:ref(""),access_token:ref(""),mapbox_api_url:ref(""),mapbox_raster_style_endpoint:ref(""),mapbox_raster_style_url:ref(""),mapbox_raster_png_dem:ref(""),mapbox_satellite_endpoint:ref(""),isPwd:ref(!0),drawerLeft:ref(!1),createFolder:ref(!1)}},mounted:async function(){this.checkFileApiSupport(),await this.loadUserData(),this.isRequiredSettings()===!0&&await this.loadMap()},methods:{addRow(){let e={name:"Color",color:"0, 0, 0"};this.rows.push(e)},removeRow(){if(this.selected.length>0){let e=this.rows.filter(r=>!this.selected.includes(r));this.rows=JSON.parse(JSON.stringify(e)),this.saveRow()}else this.alertMsg="Select row(s) to delete.",this.alert=!0},saveRow(){if(isProxy(this.rows)){let e=toRaw(this.rows);idbKeyval.set("weightmap_data",e)}else idbKeyval.set("weightmap_data",this.rows)},checkFileApiSupport(){fileUtils.checkFileApiSupport()===!1&&(this.alertMsg="This browser does not support File System Access API.  Try Edge or Chrome.",this.alert=!0)},resizeMap(){this.$refs.mapBoxViewer.resizeMap()},changeDrawer(){this.drawerLeft=!this.drawerLeft},async loadMap(){this.selectedTab="map",await this.$nextTick(()=>{this.$refs.mapBoxViewer.loadMapboxMap()})},async loadWeightMap(){await this.$nextTick(()=>{this.$refs.weightmapViewerRef.loadMapboxWeightMap()})},isRequiredSettings(){return this.access_token&&this.style_url&&this.dirName?!0:(this.redirectToSettings(),!1)},redirectToSettings(){this.selectedTab="settings",Notify.create({color:"negative",textColor:"white",icon:"report_problem",message:"Please fill out the required fields!",position:"top"})},async openDirectory(){let e;try{e=await fileUtils.getDirHandle()}catch(r){if(r.name==="AbortError")return;console.error("An error occured trying to open the file.",r)}e&&(idbKeyval.set("dirHandle",e),this.dirName=e.name)},saveUserSettings(){if(idbKeyval.set("access_token",this.access_token),idbKeyval.set("style_url",this.style_url),idbKeyval.set("mapbox_api_url",this.mapbox_api_url),idbKeyval.set("mapbox_satellite_endpoint",this.mapbox_satellite_endpoint),idbKeyval.set("mapbox_raster_png_dem",this.mapbox_raster_png_dem),idbKeyval.set("create_folder",this.createFolder),idbKeyval.set("backendServer",this.backendServer),idbKeyval.set("saveStitchingFiles",this.saveStitchingFiles),idbKeyval.set("mapbox_raster_style_endpoint",this.mapbox_raster_style_endpoint),idbKeyval.set("mapbox_raster_style_url",this.mapbox_raster_style_url),isProxy(this.rows)){let e=toRaw(this.rows);idbKeyval.set("weightmap_data",e)}else idbKeyval.set("weightmap_data",this.rows);this.isRequiredSettings()===!0&&this.loadMap()},async loadUserData(){mapboxgl.accessToken=await idbKeyval.get("access_token"),this.access_token=mapboxgl.accessToken||"",this.style_url=await idbKeyval.get("style_url")||"mapbox://styles/mapbox/streets-v11",this.mapbox_api_url=await idbKeyval.get("mapbox_api_url")||"https://api.mapbox.com/v4/",this.mapbox_satellite_endpoint=await idbKeyval.get("mapbox_satellite_endpoint")||"https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles",this.mapbox_raster_png_dem=await idbKeyval.get("mapbox_raster_png_dem")||"mapbox.mapbox-terrain-dem-v1",this.mapbox_raster_style_endpoint=await idbKeyval.get("mapbox_raster_style_endpoint")||"https://api.mapbox.com/styles/v1",this.mapbox_raster_style_url=await idbKeyval.get("mapbox_raster_style_url")||"";let e=await idbKeyval.get("dirHandle")||"";this.createFolder=await idbKeyval.get("create_folder")||"",this.saveStitchingFiles=await idbKeyval.get("saveStitchingFiles")||!1,this.backendServer=await idbKeyval.get("backendServer")||"http://localhost:3000/backend";let r=await idbKeyval.get("weightmap_data")||[];r.length===0?(idbKeyval.set("weightmap_data",rows),this.rows=rows):this.rows=r,this.dirHandle=e,this.dirName=e.name}},components:{MapboxMapViewer,WeightmapViewer,SideNav,Help}},_hoisted_1={class:"row q-pa-xs full-height"},_hoisted_2=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/access-token/",target:"_blank"},"Mapbox access token docs",-1),_hoisted_3=createBaseVNode("a",{href:"https://docs.mapbox.com/help/glossary/style-url/",target:"_blank"},"Mapbox style url docs",-1),_hoisted_4=createBaseVNode("a",{href:"https://api.mapbox.com/styles/v1/delebash/clfzz7dot000001qilz330eyt.html?title=copy&access_token=pk.eyJ1IjoiZGVsZWJhc2giLCJhIjoiY2t1YWxkODF0MGh2NjJxcXA4czBpdXlmdyJ9.D_ngzR7j4vU1CILtpNLg4Q&zoomwheel=true&fresh=true#8.76/35.8732/5.8202/0/7"},"Copy Mapbox Weightmap Style",-1),_hoisted_5={class:"q-pa-none row items-start"},_hoisted_6={class:"col q-pa-none"},_hoisted_7=createBaseVNode("br",null,null,-1),_hoisted_8={class:"q-pa-md"},_hoisted_9=createBaseVNode("div",{class:"text-h6"},"Alert",-1);function _sfc_render(e,r,t,o,s,d){const g=resolveComponent("side-nav"),a=resolveComponent("mapbox-map-viewer"),b=resolveComponent("weightmap-viewer");return openBlock(),createBlock(QLayout,{view:"lHr lpr lfr"},{default:withCtx(()=>[createVNode(QHeader,{dense:"",elevated:"",class:"bg-primary text-white","height-hint":"98"}),createVNode(QDrawer,{dense:"","show-if-above":"",modelValue:o.drawerLeft,"onUpdate:modelValue":r[0]||(r[0]=_=>o.drawerLeft=_),side:"left",onHide:d.resizeMap,class:"no-margin no-padding"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1,[createVNode(QCard,{class:"col q-pl-xs"},{default:withCtx(()=>[createVNode(g)]),_:1})])]),_:1},8,["modelValue","onHide"]),createVNode(QPageContainer,null,{default:withCtx(()=>[createVNode(QPage,{class:"row no-margin q-pa-sm"},{default:withCtx(()=>[createVNode(QCard,{class:"col"},{default:withCtx(()=>[createVNode(QTabs,{dense:"",modelValue:o.selectedTab,"onUpdate:modelValue":r[3]||(r[3]=_=>o.selectedTab=_),class:"text-grey","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},{default:withCtx(()=>[createVNode(QBtn,{dense:"",flat:"",onClick:d.changeDrawer,round:"",icon:"menu"},null,8,["onClick"]),createVNode(QTab,{dense:"",name:"map",label:"Map"}),createVNode(QTab,{dense:"",name:"weightmap",onClick:r[1]||(r[1]=_=>d.loadWeightMap()),label:"Weight Map"}),createVNode(QTab,{dense:"",name:"settings",label:"Settings"}),createVNode(QBtn,{style:{background:"#FF0080",color:"white"},label:"Help",class:"q-mr-lg",onClick:o.showDialog},null,8,["onClick"]),createVNode(QBtn,{dense:"",flat:"",round:"",onClick:r[2]||(r[2]=_=>e.$q.dark.toggle()),icon:e.$q.dark.isActive?"nights_stay":"wb_sunny"},null,8,["icon"])]),_:1},8,["modelValue"]),createVNode(QSeparator),createVNode(QTabPanels,{class:"q-pa-none q-ma-none","keep-alive":"",modelValue:o.selectedTab,"onUpdate:modelValue":r[19]||(r[19]=_=>o.selectedTab=_),animated:""},{default:withCtx(()=>[createVNode(QTabPanel,{name:"map",class:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",style:{width:"100%",height:"calc(100vh - 65px)"}},{default:withCtx(()=>[createVNode(a,{class:"col",ref:"mapBoxViewer"},null,512)]),_:1}),createVNode(QTabPanel,{name:"weightmap",class:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",style:{width:"100%",height:"calc(100vh - 65px)"}},{default:withCtx(()=>[createVNode(b,{class:"col",ref:"weightmapViewerRef"},null,512)]),_:1}),createVNode(QTabPanel,{lass:"row q-pl-xs q-pt-xs q-pb-none q-ma-none",name:"settings"},{default:withCtx(()=>[createTextVNode(" See: "),_hoisted_2,createVNode(QInput,{dense:"",modelValue:o.access_token,"onUpdate:modelValue":r[5]||(r[5]=_=>o.access_token=_),label:"Mapbox Access Token *",filled:"",type:o.isPwd?"password":"text","lazy-rules":"",hint:"You will need your own access token created from your Mapbox accounts page. The Mapbox free plan is a great choice.",rules:[_=>_&&_.length>0||"Please type something"]},{append:withCtx(()=>[createVNode(QIcon,{dense:"",name:o.isPwd?"visibility_off":"visibility",class:"cursor-pointer",onClick:r[4]||(r[4]=_=>o.isPwd=!o.isPwd)},null,8,["name"])]),_:1},8,["modelValue","type","rules"]),createTextVNode(" See: "),_hoisted_3,createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:o.style_url,"onUpdate:modelValue":r[6]||(r[6]=_=>o.style_url=_),label:"Enter your Mapbox style url *",filled:"","lazy-rules":"",hint:"You can use the default style or you can create your own custom style in Mapbox Studio.",rules:[_=>_&&_.length>0||"Please type something"],type:o.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:o.mapbox_api_url,"onUpdate:modelValue":r[7]||(r[7]=_=>o.mapbox_api_url=_),label:"Mapbox base api url *",filled:"","lazy-rules":"",hint:"",rules:[_=>_&&_.length>0||"Please type something"],type:o.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:o.mapbox_raster_png_dem,"onUpdate:modelValue":r[8]||(r[8]=_=>o.mapbox_raster_png_dem=_),label:"Mapbox Raster Dem Endpoint *",filled:"","lazy-rules":"",hint:"",rules:[_=>_&&_.length>0||"Please type something"],type:o.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:o.mapbox_satellite_endpoint,"onUpdate:modelValue":r[9]||(r[9]=_=>o.mapbox_satellite_endpoint=_),label:"Mapbox Satellite Endpoint *",filled:"","lazy-rules":"",hint:"",rules:[_=>_&&_.length>0||"Please type something"],type:o.isPwd?"":"text"},null,8,["modelValue","rules","type"]),createTextVNode(" Click "),_hoisted_4,createTextVNode(" to copy this style to your mapbox account and then paste your new style address in text box below in the format name/style id example: delebash/clfzz7dot000001qilz330eyt "),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:o.mapbox_raster_style_url,"onUpdate:modelValue":r[10]||(r[10]=_=>o.mapbox_raster_style_url=_),label:"Mapbox Weight Map Style",filled:"","lazy-rules":"",hint:""},null,8,["modelValue"]),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:o.mapbox_raster_style_endpoint,"onUpdate:modelValue":r[11]||(r[11]=_=>o.mapbox_raster_style_endpoint=_),label:"Mapbox Raster From Style Endpoint",filled:"","lazy-rules":"",hint:""},null,8,["modelValue"]),createVNode(QInput,{dense:"",class:"q-pb-lg",modelValue:o.backendServer,"onUpdate:modelValue":r[12]||(r[12]=_=>o.backendServer=_),label:"Backend Server for Tile Stitching",filled:"","lazy-rules":"",hint:""},null,8,["modelValue"]),createVNode(QCheckbox,{modelValue:o.saveStitchingFiles,"onUpdate:modelValue":r[13]||(r[13]=_=>o.saveStitchingFiles=_),label:"Save Temp Stitching files to disk"},null,8,["modelValue"]),createBaseVNode("div",_hoisted_5,[createBaseVNode("div",_hoisted_6,[createVNode(QInput,{dense:"",class:"q-pb-none",modelValue:o.dirName,"onUpdate:modelValue":r[14]||(r[14]=_=>o.dirName=_),label:"Enter download directory path *",filled:"","lazy-rules":"",rules:[_=>_&&_.length>0||"Please type something"],type:o.isPwd?"":"text"},null,8,["modelValue","rules","type"])]),createVNode(QBtn,{class:"q-pb-none",dense:"",onClick:r[15]||(r[15]=_=>d.openDirectory()),color:"secondary",label:"Select download folder"})]),_hoisted_7,createBaseVNode("div",_hoisted_8,[createVNode(QTable,{flat:"",bordered:"",title:"Weightmap colors",rows:o.rows,columns:o.columns,"row-key":"name","selected-rows-label":o.getSelectedString,selection:"multiple",selected:o.selected,"onUpdate:selected":r[16]||(r[16]=_=>o.selected=_),"virtual-scroll":"",pagination:o.pagination,"onUpdate:pagination":r[17]||(r[17]=_=>o.pagination=_),"rows-per-page-options":[0],loading:o.loading},{top:withCtx(()=>[createVNode(QBtn,{color:"primary",disable:o.loading,label:"Add new color",onClick:d.addRow},null,8,["disable","onClick"]),createVNode(QBtn,{class:"q-ml-sm",color:"primary",disable:o.loading,label:"Delete selected rows",onClick:d.removeRow},null,8,["disable","onClick"])]),body:withCtx(_=>[createVNode(QTr,{props:_},{default:withCtx(()=>[createVNode(QTd,null,{default:withCtx(()=>[createVNode(QCheckbox,{dense:"",modelValue:_.selected,"onUpdate:modelValue":T=>_.selected=T},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),createVNode(QTd,{key:"name",props:_},{default:withCtx(()=>[createTextVNode(toDisplayString(_.row.name)+" ",1),createVNode(QPopupEdit,{modelValue:_.row.name,"onUpdate:modelValue":T=>_.row.name=T,title:"Name",onSave:d.saveRow},{default:withCtx(T=>[createVNode(QInput,{modelValue:T.value,"onUpdate:modelValue":C=>T.value=C,dense:"",autofocus:"",counter:"",onKeyup:withKeys(T.set,["enter"])},null,8,["modelValue","onUpdate:modelValue","onKeyup"])]),_:2},1032,["modelValue","onUpdate:modelValue","onSave"])]),_:2},1032,["props"]),createVNode(QTd,{key:"color",props:_},{default:withCtx(()=>[createTextVNode(toDisplayString(_.row.color)+" ",1),createVNode(QPopupEdit,{modelValue:_.row.color,"onUpdate:modelValue":T=>_.row.color=T,title:"r,g,b",onSave:d.saveRow},{default:withCtx(T=>[createVNode(QInput,{modelValue:T.value,"onUpdate:modelValue":C=>T.value=C,dense:"",autofocus:"",counter:"",onKeyup:withKeys(T.set,["enter"])},null,8,["modelValue","onUpdate:modelValue","onKeyup"])]),_:2},1032,["modelValue","onUpdate:modelValue","onSave"])]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","selected-rows-label","selected","pagination","loading"])]),createVNode(QBtn,{class:"q-pt-none",dense:"",onClick:r[18]||(r[18]=_=>d.saveUserSettings()),color:"secondary",label:"Save settings"})]),_:1})]),_:1},8,["modelValue"])]),_:1}),createVNode(QDialog,{modelValue:o.alert,"onUpdate:modelValue":r[20]||(r[20]=_=>o.alert=_)},{default:withCtx(()=>[createVNode(QCard,null,{default:withCtx(()=>[createVNode(QCardSection,null,{default:withCtx(()=>[_hoisted_9]),_:1}),createVNode(QCardSection,{class:"q-pt-none"},{default:withCtx(()=>[createTextVNode(toDisplayString(o.alertMsg),1)]),_:1}),createVNode(QCardActions,{align:"right"},{default:withCtx(()=>[withDirectives(createVNode(QBtn,{flat:"",label:"OK",color:"primary"},null,512),[[ClosePopup]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})}const MainLayout=_export_sfc(_sfc_main,[["render",_sfc_render]]);export{MainLayout as default};
